<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚¨áÔ∏è üéæ üç• Implementation of MVP based on ApplicationController and IoC in a WinForms application üë©üèæ‚Äç‚úàÔ∏è üéá üíÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon! 
 
 In this article, I will talk about how I implemented the MVP pattern in my Windows Forms application and describe practical situat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementation of MVP based on ApplicationController and IoC in a WinForms application</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502358/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I will talk about how I implemented the MVP pattern in my Windows Forms application and describe practical situations and features of using IoC and ApplicationController. </font><font style="vertical-align: inherit;">Switching from codebehind to MVP allowed me:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">improve readability due to better code separation (SRP) - separate BL from View;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to develop a methodology for further expanding the functionality of the application;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get rid of singleton, which I used to work with application settings.</font></font></li>
</ul><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About app</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An app to help manage VC groups. </font><font style="vertical-align: inherit;">Allows you to fill a group with pending posts. </font><font style="vertical-align: inherit;">The main functionality at the moment is loading pending posts into the VK group with pictures or videos, hashtags, polls, geo-location and the ability to configure the publication time and the number of posts by day. </font><font style="vertical-align: inherit;">At the moment, the application has one form.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the growth of its functionality, a lot of codebehind accumulated, which began to confuse the fact that the form became very loaded and contained everything in itself. </font><font style="vertical-align: inherit;">When planning the further development of the project, I could not imagine what could be continued further in the same spirit, and now the moment came when the main task was not refining the functional, but refactoring. </font><font style="vertical-align: inherit;">And I began to look for a solution that would help optimize and split the code and generally improve the application architecture so that it would be more pleasant to work with it. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring Solution</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution was to implement the MVP pattern. </font><font style="vertical-align: inherit;">As a basis, I took the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP Implementation Features for Windows Forms</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article parses an extended example of a simple application with 3 forms: 2 main and 1st modal. </font><font style="vertical-align: inherit;">The article discusses a very advanced approach:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in addition to ApplicationController and IoC, Adapter is also used there, which allows using different IoCs;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 types of forms: with parameters, without parameters and modal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIP principle is widely applied.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my project, I use only one form without arguments, abandoned the adapter (following the YAGNI principle), since IoC Lightinject is enough for me and to a lesser extent use DIP to simplify the project.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP implementation</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP (Model-View-Presenter)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a design pattern designed for the convenience of separating business logic from the way it is displayed. </font><font style="vertical-align: inherit;">You can read more about the theory in the article above. </font><font style="vertical-align: inherit;">I will describe the components in my implementation:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a data structure transferred between View and Presenter and contains data both for display and for execution of logic. </font><font style="vertical-align: inherit;">In my case, the model is Settings. </font><font style="vertical-align: inherit;">When the project starts, Settings are loaded into MainFormView, and when loading starts, MainFormView checks and passes Settigns to Presenter, so that Presenter runs the logic on its side.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a form in which data is displayed to the user. </font><font style="vertical-align: inherit;">In my case, this is data from the Settings model, and View also provides events so that Presenter associates View with BL.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MainFormView implements a common IView interface common to all View</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IView</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>(<span class="hljs-params"></span>)</span>;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
as well as a private IMainFormView interface specific to this View only. </font><font style="vertical-align: inherit;">At the beginning, I thought about abandoning it, but if you associate Presenter directly with the form, then when working with such a View, the whole set of methods specific to Form will be available, which is not convenient.</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IMainFormView</span>: <span class="hljs-title">IView</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">LoadSettings</span>(<span class="hljs-params">Settings settings</span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateSettings</span>(<span class="hljs-params">Settings settings</span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ShowMessage</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">LoadGroups</span>(<span class="hljs-params">List&lt;Group&gt; groups</span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">EnableVKUploadGroupBox</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Check</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-keyword">event</span> Action Login;<font></font>
<font></font>
        <span class="hljs-keyword">new</span> <span class="hljs-keyword">event</span> Action Close;<font></font>
<font></font>
        <span class="hljs-keyword">event</span> Action VKUpload;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another MVP innovation is that the Show method has been replaced in the form and ApplicationContext is passed to the form through the constructor, so that when switching from form to form and closing, the main form is reassigned. </font></font><br>
<br>
<pre><code class="cs hljs">        <span class="hljs-keyword">protected</span> ApplicationContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainForm</span>(<span class="hljs-params">ApplicationContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            InitializeComponent();<font></font>
<font></font>
            dateTimePickerBeginDate.Format = DateTimePickerFormat.Custom;<font></font>
            dateTimePickerBeginDate.CustomFormat = <span class="hljs-string">"MM/dd/yyyy hh:mm:ss"</span>;<font></font>
<font></font>
            buttonAuth.Click += (sender, args) =&gt; Invoke(Login);<font></font>
            <span class="hljs-keyword">this</span>.FormClosing += (sender, args) =&gt; Invoke(Close);<font></font>
            buttonLoad.Click += (sender, args) =&gt; Invoke(VKUpload);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> new <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _context.MainForm = <span class="hljs-keyword">this</span>;<font></font>
            Application.Run(_context);<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presenter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a class that encapsulates View, Services, and business logic (BL), with the help of which it organizes the interaction between View and Services. BL is mainly implemented in View event handlers. Unlike the previously used CodeBehind, in MVP event handlers executing BL are displayed in Presenter, and for simplicity, events in View are displayed in the form of Action without arguments. Handlers receive all the necessary data for execution through the model obtained from the form through the public method. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presenter contains the Run method, which is called by the ApplicationController and which launches the form:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPresenter</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span>;<font></font>
    }<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ApplicationController</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a single point of control and execution of the entire application. </font><font style="vertical-align: inherit;">Encapsulates all the logic in itself: IoC, Presenters, View, Services. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Management is via the Run method, which calls the corresponding Presenter. </font><font style="vertical-align: inherit;">All Presenters are connected to each other through the ApplicationController, which the Presenter receives in the constructor. </font><font style="vertical-align: inherit;">Thus, the Presenter can call another Presenter by calling the Run method, which internally calls the IoC Container to get the desired Presenter and start it.</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationController</span><font></font>
    {<font></font>
        ServiceContainer _container;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ApplicationController</span>(<span class="hljs-params">ServiceContainer serviceContainer</span>)</span><font></font>
        {<font></font>
            _container = serviceContainer;<font></font>
            _container.RegisterInstance&lt;ApplicationController&gt;(<span class="hljs-keyword">this</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> Run&lt;TPresenter&gt;() <span class="hljs-keyword">where</span> TPresenter:<span class="hljs-keyword">class</span>, <span class="hljs-title">IPresenter</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> presenter = _container.GetInstance&lt;TPresenter&gt;();<font></font>
            presenter.Run();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IoC container</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an aggregator of all the "dependencies" used in the application logic. </font><font style="vertical-align: inherit;">It contains:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View constructors</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constructors Presenters</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service instances</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application context</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ApplicationController</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All dependencies are added to the container during startup, this can be seen in the Program.cs file:</font></font><br>
<br>
<pre><code class="cs hljs">         <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            Application.EnableVisualStyles();<font></font>
            Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal">false</span>);<font></font>
<font></font>
            <span class="hljs-keyword">ulong</span> appid = <span class="hljs-keyword">ulong</span>.Parse(ConfigurationManager.AppSettings[<span class="hljs-string">"AppIdForTest"</span>]);<font></font>
            VKGroupHelperWorker vk = <span class="hljs-keyword">new</span> VKGroupHelperWorker(appid);<font></font>
<font></font>
<font></font>
            ServiceContainer container = <span class="hljs-keyword">new</span> ServiceContainer();<font></font>
            container.RegisterInstance&lt;VKGroupHelperWorker&gt;(vk);<font></font>
            container.RegisterInstance&lt;Settings&gt;(Globals.Settings);<font></font>
            container.RegisterInstance&lt;ApplicationContext&gt;(Context);<font></font>
            container.Register&lt;IMainFormView,MainForm&gt;();<font></font>
            container.Register&lt;MainFormPresenter&gt;();<font></font>
<font></font>
            ApplicationController controller = <span class="hljs-keyword">new</span> ApplicationController(container);<font></font>
            controller.Run&lt;MainFormPresenter&gt;();<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For IoC, I used the Lightinject component, which must be installed through NPM before use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the container can contain both object constructors and the objects themselves, as is done with Settings and VKGroupHelperWorker (VK API client), forming the set of all application resources used. </font><font style="vertical-align: inherit;">A useful feature of the container is that all these embedded resources, classes can be obtained through the constructor arguments. </font><font style="vertical-align: inherit;">For example, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ApplicationController, IMainFormView, VKGroupHelperWorker - previously implemented dependencies, which can be either object constructors or instances. </font><font style="vertical-align: inherit;">If an instance has been implemented, then all generated objects will work with the same instance, which allows you to get rid of the singleton pattern if it was used.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainFormPresenter</span>(<span class="hljs-params">ApplicationController applicationController, IMainFormView mainForm, Settings settings, VKGroupHelperWorker vk</span>)</span><font></font>
        {<font></font>
            _view = mainForm;<font></font>
            _settings = settings;<font></font>
            _vk = vk;<font></font>
<font></font>
            _view.Login += () =&gt; Login();<font></font>
            _view.Close += () =&gt; Close();<font></font>
            _view.VKUpload += () =&gt; VKUpload();<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementation of MVP allowed me to:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partially get rid of Singleton, which I used to work with application settings;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separate BL from View, thereby improving code separation (SRP)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to develop an approach to further expand the application without cluttering the View.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More information about what has been done can be found in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the project repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502336/index.html">Weekend reading: sounds we miss, how to escape from the crisis, and what to read about audio gadgets</a></li>
<li><a href="../en502338/index.html">New challenges for managers in remote work</a></li>
<li><a href="../en502350/index.html">Reverse engineering the sound amplifier of a popular portable console - discussing the main findings</a></li>
<li><a href="../en502352/index.html">The digest of interesting materials for the mobile developer # 344 (May 12 - 17)</a></li>
<li><a href="../en502354/index.html">IaaS providers are fighting for the European market - discussing the situation and industry events</a></li>
<li><a href="../en502360/index.html">Grizzly Discharges or Super Drill</a></li>
<li><a href="../en502362/index.html">Learning Event Tracing for Windows: Theory and Practice</a></li>
<li><a href="../en502366/index.html">Compare the work of open source Python - libraries for the recognition of named entities</a></li>
<li><a href="../en502368/index.html">We pump the treadmill</a></li>
<li><a href="../en502370/index.html">Putting the game "Snake" on the breadboard. Part 1: state machines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>