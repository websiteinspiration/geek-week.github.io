<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖüèø üßìüèø üë©‚Äçüîß Bombeamos Ikea: c√≥mo convertir m√∫sica ligera en Big Brother üëéüèΩ üëåüèø üç≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introducci√≥n
 Ikea es una tienda curiosa. Incluso si entr√≥ con la intenci√≥n de comprar una cosa espec√≠fica y no distraerse con el resto de la basura, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bombeamos Ikea: c√≥mo convertir m√∫sica ligera en Big Brother</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495180/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/g-/1c/b3/g-1cb35ov13g0bc7demuvnxiqla.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ikea es una tienda curiosa. Incluso si entr√≥ con la intenci√≥n de comprar una cosa espec√≠fica y no distraerse con el resto de la basura, entonces saldr√° comprando tres veces m√°s de lo necesario. Para nosotros, los hackers, este efecto es especialmente evidente en el departamento de Ikea con cables de alimentaci√≥n o bater√≠as. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para m√≠, el √∫ltimo caso de tal locura ocurri√≥ en los Pa√≠ses Bajos. Estaba en un viaje planeado, planeando pasar solo unas pocas semanas en el pa√≠s. Sin embargo, esto fue a principios de 2020 y el desastre con COVID-19 ... tuve que permanecer lejos de mi laboratorio mucho m√°s tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y cuando vi la l√≠nea de productos electr√≥nicos de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frekevens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en Ikea </font><font style="vertical-align: inherit;">, no pude evitarlo y lo compr√© todo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que no saben: la l√≠nea Ikea Frekvens deber√≠a convertirse en un an√°logo moderno del equipo de alta fidelidad de la vieja escuela m√°s el equipo de m√∫sica de luz hexagonal, que parece estar en los hogares de la mitad de los adolescentes de los 90. En este caso, la l√≠nea de dispositivos conectados entre s√≠ consiste en un altavoz Bluetooth para salida de sonido y un proyector LED (complementado por varias boquillas) que parpadean al ritmo de la m√∫sica, as√≠ como una pantalla de cubo LED que puede mostrar animaciones que tambi√©n se mueven a la m√∫sica. Ikea se jacta de que esta l√≠nea se desarroll√≥ en conjunto con Teenage Engineering, conocida por su serie Pocket Operator de sintetizadores port√°tiles de "juguete".</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4d/8b4/e60/f4d8b4e60e7812b5b979850a18d3926c.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se muestra en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el video promocional de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ikea, la compra finalizada de docenas de dispositivos deber√≠a verse como un insoportable carnaval parpadeante, que a mi adolescente de 15 a√±os no le importar√≠a organizar en su habitaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estaba particularmente interesado en la pantalla LED de cubo: es un dispositivo integrado de alta calidad que funciona en la red el√©ctrica. En el panel frontal hay una matriz de 16 filas y 16 columnas de LED blancos muy brillantes, es decir, un total de 256 LED. Las animaciones integradas en el dispositivo eran bastante simples, pero me llevaron a la idea de que el hierro puede controlar cada LED de forma individual. Sin embargo, debido a esto, la caja peque√±a era bastante cara: mi bolsillo estaba vac√≠o por unos 40 euros. Por esta cantidad, obtienes una caja con LED y un cable de alimentaci√≥n. Dado que se supone que debe comprar este producto junto con otros productos Frekvens, tambi√©n recibir√° elementos de conexi√≥n adicionales: un cable de alimentaci√≥n de extensi√≥n para el suministro de energ√≠a de extremo a extremo de la red a otras cajas,as√≠ como un conjunto de tornillos y almohadillas de pl√°stico con los que puede sujetar mec√°nicamente la carcasa entre s√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tan pronto como llegu√© a casa, conect√© el dispositivo y ... para ser honesto, me decepcion√≥ un poco lo que hicieron con la plancha. </font><font style="vertical-align: inherit;">El dispositivo ten√≠a varias animaciones que pod√≠an seleccionarse presionando un bot√≥n en la parte posterior de la carcasa; </font><font style="vertical-align: inherit;">se instala un peque√±o micr√≥fono en la carcasa; cada vez que reconoce el ruido, cambia el marco de la animaci√≥n. </font><font style="vertical-align: inherit;">Las animaciones no son muy interesantes: consisten en solo cuatro o cinco cuadros, y los cuadros en s√≠ son solo en blanco y negro, sin sombras de gris. </font><font style="vertical-align: inherit;">Si tienes curiosidad, grab√© un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corto </font><font style="vertical-align: inherit;">con todas las animaciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, esto no me conven√≠a. </font><font style="vertical-align: inherit;">Pirateemos el dispositivo: veamos qu√© lo hace funcionar y si es posible hacer que su comportamiento sea un poco m√°s interesante.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autopsia</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desmontar Frekvens, un destornillador para una ranura en forma de cruz y, posiblemente, un cuchillo ser√°n suficientes. </font><font style="vertical-align: inherit;">Tambi√©n necesitar√° una parte s√≥lida de perseverancia, porque el dispositivo no es f√°cil de entender: el dise√±o es complicado y algunos elementos est√°n llenos de silicona, probablemente para eliminar las vibraciones y simplificar la fabricaci√≥n.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71d/6e9/925/71d6e9925d31cbce7d1da4cf492948de.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El desmontaje del caso Frekvens comienza desde atr√°s. </font><font style="vertical-align: inherit;">La carcasa tiene orificios para tornillos en todos los lados, a excepci√≥n del frente; </font><font style="vertical-align: inherit;">Gracias al juego de tornillos y cubiertas del kit del dispositivo, se puede conectar a otros dispositivos Frekvens. </font><font style="vertical-align: inherit;">Sin embargo, los agujeros traseros para los tornillos son un poco m√°s profundos y debajo de ellos hay tornillos que aseguran la carcasa.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebf/2c5/8e2/ebf2c58e270c942b8e360a744f0ff6ea.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de quitar la tapa posterior, vemos que todos los orificios de los tornillos tienen insertos met√°licos roscados en los que se pueden atornillar los tornillos. </font><font style="vertical-align: inherit;">¬°Guauu! </font><font style="vertical-align: inherit;">Esto deber√≠a proporcionar a los agujeros un margen de seguridad suficiente. </font><font style="vertical-align: inherit;">Es posible que esto complique en gran medida la producci√≥n o el desmontaje; </font><font style="vertical-align: inherit;">esto √∫ltimo se complica por el hecho de que primero necesitamos cortar las gotas de compuesto de silicona endurecido.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ca/78c/bf2/4ca78cbf2e1f533658a361fd998a933a.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los insertos est√°n realmente sujetos con otros insertos de pl√°stico; </font><font style="vertical-align: inherit;">necesitan ser removidos primero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No tengo otras fotos del proceso de desmontaje, pero despu√©s de esta etapa ver√° cuatro tornillos que deben desenroscarse, y luego el proceso contin√∫a como antes. </font><font style="vertical-align: inherit;">Comprenda qu√© pieza de pl√°stico mantiene unido todo lo dem√°s, corte el compuesto de silicona, retire los sujetadores de pl√°stico. </font><font style="vertical-align: inherit;">Contin√∫e hasta que pueda sacar la placa de circuito.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e40/8c0/346/e408c0346ddbea872aa6100a7c37c303.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√°: el reverso de la placa de circuito. Result√≥ que est√° ensamblado a partir de dos placas de circuito impreso: la blanca tiene dos lados: en la parte posterior est√°n todos los controladores de LED (y otra placa est√° unida a ella), y en la parte frontal est√°n los LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La placa de circuito blanca est√° dise√±ada bastante bien: en lugar de una matriz de LED, hay 16 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">controladores de</font></a><font style="vertical-align: inherit;"> LED </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCT2024</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajando desde una corriente continua. Estos controladores LED tienen 16 canales, es decir, cada LED se controla directamente. Los controladores de LED solo pueden encender o apagar completamente los LED; los controladores en s√≠ no tienen soporte nativo en escala de grises. De hecho, realizan el cambio de registro utilizando salidas controladas por corriente, y todos cambian secuencialmente; La interfaz de conexi√≥n de PCB verde consta de su bus de sincronizaci√≥n y datos, una l√≠nea de habilitaci√≥n instant√°nea, una l√≠nea de habilitaci√≥n de salida, tierra y alimentaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este tablero verde est√° el peque√±o cerebro del dispositivo: un microcontrolador, cuyo art√≠culo no se puede encontrar en Google, y un amplificador operacional para el micr√≥fono. </font><font style="vertical-align: inherit;">Curiosamente, hay indicios de que el dispositivo deber√≠a tener m√°s funciones: hay un lugar para, presumiblemente, I2C EEPROM 24Cxx y una sugerencia de que en el proyecto original hab√≠a un receptor IR en el panel frontal. </font><font style="vertical-align: inherit;">¬øQuiz√°s se supon√≠a que el dispositivo vendr√≠a con un control remoto que le permite crear sus propios patrones? </font><font style="vertical-align: inherit;">Esto puede explicar que las animaciones existentes se vean tan aburridas.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/40f/a7a/1d9/40fa7a1d95a60af223eb12a5f5db7ba6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la parte frontal de la pizarra est√°n todos los LED. </font><font style="vertical-align: inherit;">Tambi√©n se suelda un peque√±o micr√≥fono plano. </font><font style="vertical-align: inherit;">Al principio pens√© que estaba soldado al tablero verde y sobresale por el agujero en el tablero blanco, pero de hecho es plano.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bb/613/620/2bb6136207e5ce1cf78895a6827a8dfd.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los dem√°s componentes electr√≥nicos se encuentran en la parte posterior del tablero. </font><font style="vertical-align: inherit;">No es suficiente all√≠: solo una fuente de alimentaci√≥n bajo la marca Ikea, emitiendo 4 V. Debajo de la fuente de alimentaci√≥n hay una peque√±a placa de circuito impreso en la que hay dos interruptores t√°ctiles para los botones en la parte posterior de la caja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, si queremos "optimizar" el dise√±o, entonces tenemos una debilidad obvia: es mejor reemplazar una peque√±a tarjeta verde con un procesador con algo m√°s potente.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modificamos hierro</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pens√© que podr√≠a ser posible reemplazar el equipo con una ESP-Cam. Esta es una placa muy barata (m√°s o menos 10 euros) con un chip ESP32 WiFi / BT, varios megabytes de PSRAM y un m√≥dulo de c√°mara. No estoy muy interesado en la m√∫sica ligera, quer√≠a que el dispositivo respondiera a algo visual. Como ya hab√≠a un agujero en la parte frontal del receptor, pens√© que podr√≠a usarlo debajo de la c√°mara. Tambi√©n tendr√© que hacer un agujero en la pizarra donde se encuentra el micr√≥fono; Afortunadamente, adem√°s de estas pistas de micr√≥fono ahora in√∫tiles, esto destruir√° solo una pista del LED. Perfor√© un agujero y restaur√© la pista. Temporalmente volviendo a colocar la placa en su lugar y encendiendo el cubo, me asegur√© de que todos los LED sigan funcionando.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ed1/c45/456/ed1c454569bc1fa6734a8c16bdfed1ae.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora ten√≠a una placa con un agujero perforado, y solo pod√≠a conectar y conectar mec√°nicamente la ESP-Cam. Los dise√±adores indicaron amablemente el prop√≥sito de todas las almohadillas en la serigraf√≠a del tablero verde, por lo que casi no tuve que adivinar nada. Como la fuente de alimentaci√≥n suministra solo 4 V, la conect√© directamente a la entrada de 3,3 V del chip ESP-CAM. Ten√≠a que hacer esto, porque cuando lo conect√© al pin Vin 5V, el chip no quer√≠a comenzar ... Lo m√°s probable es que el regulador LDO tenga una ca√≠da de voltaje ligeramente alta. Volviendo atr√°s, ahora creo que vali√≥ la pena intentar conectar el diodo en serie con una fuente de 4 V para obtener 3.3-3.4 V, pero mi soluci√≥n funcion√≥; ESP32 es bastante modesto.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/021/93d/abe/02193dabe8880ceeea91807ec0a16d2f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soldando todos los conectores, tuve que lidiar con la mec√°nica de todos modos. </font><font style="vertical-align: inherit;">Fue un proyecto "r√°pido y sucio", y ya hab√≠a soldado los conectores ESP-Cam antes, as√≠ que para alinear la c√°mara con el orificio, podr√≠a hacerlo con varias juntas y mucho ep√≥xico.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/f14/364/e62f143645504bfd1636cab8fdb3cdf8.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de esta operaci√≥n, el √∫ltimo problema persist√≠a: los LED junto a la c√°mara brillaban en su ventana de marco, causando todo tipo de artefactos extra√±os. </font><font style="vertical-align: inherit;">En primer lugar, para eliminarlos, cort√© un peque√±o bisel de una cinta de aluminio para proteger la c√°mara de la luz directa.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/1a8/1bb/fa71a81bb0a3131132885840f8186e85.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo paso fue la aplicaci√≥n de pintura acr√≠lica. </font><font style="vertical-align: inherit;">Este es un inserto de pl√°stico en el que se encuentran todos los difusores, a trav√©s del cual brillan los LED. </font><font style="vertical-align: inherit;">Ya agrand√© el orificio que ten√≠a para el micr√≥fono para crear una ventana de marco m√°s amplio para la c√°mara, pero esto condujo a otro problema: el orificio era demasiado notable y demasiada luz difusa cay√≥ sobre la c√°mara. </font><font style="vertical-align: inherit;">Una mancha de pintura acr√≠lica negra funcion√≥ bastante bien en ambos temas; </font><font style="vertical-align: inherit;">la c√°mara a√∫n recib√≠a mucha luz de los LED, pero ahora no la inundaba por completo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, el trasplante de cerebro est√° completo y el cuerpo est√° listo para el ensamblaje. </font><font style="vertical-align: inherit;">Puedes iniciar el software.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Software</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasemos al software. En primer lugar, necesitamos controlar los controladores LED. Esto no es dif√≠cil: las se√±ales del controlador son casi directamente consistentes con la interfaz perif√©rica SPI del chip ESP32: la almohadilla CLK en la placa se conecta a la interfaz CLK perif√©rica SPI, la almohadilla DA en la placa se conecta al MOSI de la se√±al SPI. Esto le permitir√° sincronizar 256 bits con una cadena de controladores LED: cada bit sincronizado controla el encendido o apagado del LED correspondiente. Adem√°s, hay una entrada LAK. Si la se√±al es baja, entonces el LED conserva su valor anterior, independientemente de lo que se transfiri√≥ a los registros de desplazamiento; Si la se√±al es alta, todos ellos cambian simult√°neamente a los valores que est√°n actualmente en el registro de desplazamiento. Finalmente, hay una entrada EN que enciende o apaga todos los LED;No lo conect√© a GPIO y siempre enciendo los LED mediante programaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, ahora puedo encender y apagar LED individuales, obteniendo una pantalla en blanco y negro. Sin embargo, necesito algo m√°s. Con suficiente potencia inform√°tica, la pantalla tambi√©n debe ser capaz de mostrar tonos de gris; para esto, solo necesita encender / apagar los LED m√°s r√°pido de lo que el ojo ve. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar esto con un solo LED, generalmente uso PWM, pero en el caso de 256 LED, esto ocupar√° una parte significativa de la potencia del procesador ESP32. Entonces, en cambio, decid√≠ usar la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modulaci√≥n de C√≥digo Binario</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tambi√©n llamada Modulaci√≥n de √°ngulo de bit). Esta es una t√©cnica que le permite obtener tonos de gris con menos potencia de CPU. Ya lo he usado con √©xito en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otros proyectos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as√≠ que estaba seguro de que funcionar√≠a.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e99/009/265/e990092656bfd3db2032718f55e7e086.jpg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y funcion√≥. Tambi√©n agregu√© una tabla de b√∫squeda para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertir la claridad CIE a PWM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque el ojo responde esencialmente al brillo de los LED de forma no lineal; La tabla de b√∫squeda soluciona este problema. Al final, logr√© lograr una cantidad suficiente de tonos de gris y escala lineal del brillo √≥ptico de acuerdo con el valor de p√≠xel establecido por m√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No fue dif√≠cil implementar el proyecto de la c√°mara: hay un componente ESP-IDF que se puede agregar al proyecto; √©l se encargar√° de configurar la c√°mara e intercambiar datos con ella, solo necesita especificar los par√°metros que necesita y luego solicitar el mapa de bits que ve la c√°mara. Lo √∫nico que no pude usar en la configuraci√≥n est√°ndar fue que la alineaci√≥n autom√°tica y la exposici√≥n autom√°tica estaban activadas de manera predeterminada, y esto interfiri√≥ bastante con mi forma de controlar los LED: dependiendo de qu√© parte de la secuencia de Modulaci√≥n del C√≥digo Binario se cre√≥ la imagen, la c√°mara aument√≥ o disminuy√≥ la alineaci√≥n y la exposici√≥n al azar. Solucion√© el problema cambiando la c√°mara a alineaci√≥n manual y velocidad de obturaci√≥n; El c√≥digo mismo examina la imagen y determina si estos par√°metros necesitan compensaci√≥n.Gracias a dicho procesamiento manual, tambi√©n logr√© excluir p√≠xeles que miraban directamente a los LED para eliminarlos por completo de la ecuaci√≥n. Esto tambi√©n ayud√≥ mucho a obtener una imagen estable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tengo una c√°mara y un lienzo de 16x16 en tonos de gris. ¬øQu√© debo hacer con ellos? Tengo una idea: en el momento de las primeras computadoras Macintosh, hab√≠a una extensi√≥n popular que solo agregaba un par de ojos de dibujos animados a la barra de men√∫. Estos ojos simplemente siguieron el cursor. (Todav√≠a existe una variaci√≥n de este tema para Linux / Unix llamada "xeyes"). ¬øQu√© sucede si trato de repetirlo en la vida real?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6d1/c9e/0a1/6d1c9e0a114c84f246c051c4358cdcc7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para empezar, necesitaba algunas im√°genes de los ojos. No pens√© que podr√≠a dibujar algo que valiera la pena, as√≠ que decid√≠ usar mis propios ojos como im√°genes b√°sicas; Miro un video corto en el que miro y parpadeo en todas las direcciones. Vale la pena considerar que, debido a la situaci√≥n actual, ten√≠a muy pocas herramientas profesionales: me recuesto en el piso para maximizar la iluminaci√≥n que cae de las l√°mparas fluorescentes del techo y obtener una imagen legible; Todo el video fue filmado en el tel√©fono inteligente que tengo en mis manos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como los datos iniciales eran bastante descuidados, tuve que trabajar duro en el postprocesamiento. Comenc√© cortando un fragmento que estaba aproximadamente alrededor de mi ojo derecho. Luego convert√≠ cada fotograma del video en una imagen y elimin√© todas las im√°genes redundantes; al final tuve una buena selecci√≥n de im√°genes m√≠as mirando en diferentes direcciones, as√≠ como algunos cuadros con un parpadeo. Sin embargo, como utilic√© un tel√©fono m√≥vil para grabar, el video sali√≥ un poco tembloroso y las im√°genes se saltaron. Para solucionar esto, pas√© un conjunto de im√°genes a trav√©s del programa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hugin Image Glue.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que generalmente se usa para panoramas e im√°genes HDR; a la salida, obtuve im√°genes idealmente centradas en esta parte de mi cara. Ahora solo pod√≠a marcar en qu√© direcci√≥n miraba y si parpadeaba. Hice esto al convertir primero todas las im√°genes a tonos de gris y luego subirlas a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gimp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En cada imagen, utilic√© un punto rojo para indicar la ubicaci√≥n del centro de la pupila, m√°s un punto rojo en la esquina izquierda o derecha para indicar si parpadeo, y si parpadeo, entonces mi ojo est√° medio abierto o cerrado.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb6/112/a73/bb6112a73c7b9fbdb619afaff1b971c9.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de marcar cada imagen de esta manera, se hizo muy simple escribir un gui√≥n para obtener la ubicaci√≥n del alumno, as√≠ como el estado del parpadeo. El script tambi√©n escal√≥ las im√°genes a 16x16 y las guard√≥ como datos binarios sin procesar, listos para ser escritos en el firmware del m√≥dulo ESP-CAM. Al final, obtuve un conjunto de im√°genes y un √≠ndice de d√≥nde est√° la pupila y en qu√© estado parpadea el ojo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ESP-Cam tiene un componente de biblioteca de c√°mara bastante f√°cil de usar para la ESP-IDF, por lo que obtener im√°genes fue f√°cil. Configur√© capturar im√°genes de 120x160 en tonos de gris, porque son m√°s f√°ciles de procesar, y no necesitaba mucha resoluci√≥n, porque el resultado final deber√≠a mostrarse en una pantalla de 16x16. Sin embargo, todav√≠a ten√≠a un problema de hardware: la c√°mara todav√≠a estaba demasiado cerca de los LED.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb1/d78/621/cb1d786213e7450791968f0e7da4d6c3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, trat√© de resolverlo calibrando: cuando el dispositivo se inicia, toma dos fotos: una con un LED cerca de la lente de la c√°mara y otra solo con un LED ubicado lejos de la c√°mara. Restando una imagen de otra, puede comprender qu√© p√≠xeles se ven afectados por los LED. Estos p√≠xeles se almacenan en la m√°scara; Los p√≠xeles marcados en la m√°scara se ignoran posteriormente. La imagen de arriba muestra dos disparos y una m√°scara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con una imagen m√°s limpia, podr√≠a pasar al reconocimiento de movimiento. Lo implement√© obteniendo un cuadro de la c√°mara y restando el cuadro anterior. Luego pude calcular la cantidad de movimiento sumando todos los p√≠xeles resultantes. Adem√°s, fue posible calcular la ubicaci√≥n de la concentraci√≥n de movimiento tomando el promedio de las coordenadas de todos los p√≠xeles ponderados por la diferencia de cuadros en este p√≠xel. Al final, la magia de filtrado se realiza para que el dispositivo no se vea sacudido como un Jack Russell Terrier con TDAH: para atraer su atenci√≥n, los objetos deben moverse de manera m√°s uniforme o lo suficientemente lejos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hab√≠a un problema: cuando estaba muy oscuro, el algoritmo de reconocimiento de movimiento a veces funcionaba en el reflejo de los LED en objetos brillantes en la habitaci√≥n: si el ojo parpadeaba, preste atenci√≥n a su propio reflejo. </font><font style="vertical-align: inherit;">Esto no es exactamente lo que quer√≠a, as√≠ que evit√© este problema al hacer que el algoritmo de reconocimiento de movimiento fuera "ciego" al cambiar la imagen en los LED; </font><font style="vertical-align: inherit;">As√≠ que detuve este comportamiento. </font><font style="vertical-align: inherit;">Adem√°s, tambi√©n es un poco m√°s realista: cuando parpadeas, no puedes ver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El firmware tiene varios modos de depuraci√≥n que demuestran todo el proceso. </font><font style="vertical-align: inherit;">Aqu√≠ hay un breve video que ilustra esto:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bR-CpMdz02I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que ahora tengo un dispositivo que me sigue ... no es realmente √∫til, estoy de acuerdo. </font><font style="vertical-align: inherit;">Pero fue interesante para m√≠ crearlo, y si alguna vez encuentro algo m√°s √∫til que pueda implementarse en una pantalla LED de 16x16, entonces puedo hacerlo, porque ya tengo un c√≥digo de control. </font><font style="vertical-align: inherit;">Hablando de c√≥digo: puedes descargar libremente mi resultado en bruto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desde aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Espero que lo hayas disfrutado y cu√≠date.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UCPUPO21Cwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495168/index.html">Una forma alternativa del operador ternario de Python</a></li>
<li><a href="../es495170/index.html">Lo que suena desaparece temporalmente de nuestras vidas y cuyo retorno no vale la pena esperar: una discusi√≥n</a></li>
<li><a href="../es495174/index.html">Profesional independiente</a></li>
<li><a href="../es495176/index.html">Arreglando la serializaci√≥n de objetos en Kotlin de una vez por todas</a></li>
<li><a href="../es495178/index.html">Es hora de sitios gratuitos</a></li>
<li><a href="../es495184/index.html">Las dificultades de la sustituci√≥n de importaciones: una herramienta para las corporaciones estatales se elimina del registro de software nacional</a></li>
<li><a href="../es495188/index.html">Dificultades en la ense√±anza de lenguas extranjeras (tambi√©n recomendar√≠a a los estudiantes)</a></li>
<li><a href="../es495192/index.html">El script de lanzamiento perfecto del servidor de Minecraft</a></li>
<li><a href="../es495194/index.html">Placa de audio m√≠nima STM-32</a></li>
<li><a href="../es495196/index.html">Si el IB tuviera un "Premio Darwin", o 7 historias sobre estupidez, basura, credulidad y sus consecuencias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>