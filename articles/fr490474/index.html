<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüè´ üêΩ üîå STM32 Partie 1: Les bases üîì üë©üèø üñïüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous ne pouvez pas faire confiance au code que vous n'avez pas √©crit compl√®tement vous-m√™me. - Ken ThompsonPeut-√™tre ma citation pr√©f√©r√©e. C'est elle ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Partie 1: Les bases</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490474/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous ne pouvez pas faire confiance au code que vous n'avez pas √©crit compl√®tement vous-m√™me. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ken Thompson</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peut-√™tre ma citation pr√©f√©r√©e. C'est elle qui est devenue la raison pour laquelle j'ai d√©cid√© de plonger dans les profondeurs du terrier du lapin. J'ai commenc√© mon voyage dans le monde de la programmation tout r√©cemment, seulement environ un mois s'est √©coul√© et j'ai d√©cid√© d'√©crire des articles pour consolider le mat√©riel. Tout a commenc√© par une t√¢che simple, synchroniser les lampes de votre studio photo en utilisant Arduina. Le probl√®me a √©t√© r√©solu, mais je ne suis plus entr√© dans le studio photo, il n'y a pas de temps. A partir de ce moment, j'ai d√©cid√© de m'engager √† fond dans la programmation des microcontr√¥leurs. Arduin, bien que s√©duisant par sa simplicit√©, je n'ai pas aim√© la plateforme. Le choix s'est port√© sur la soci√©t√© ST et leurs produits populaires. √Ä ce moment-l√†, je n'avais toujours aucune id√©e de la diff√©rence, mais en tant que consommateur typique, j'ai compar√© la vitesse du ¬´processeur¬ª et la quantit√© de m√©moire, je me suis achet√© une carte impressionnante avec un √©cran STM32F746NG - Discovery.Je vais manquer les moments de d√©sespoir et aller droit au but.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immerg√© dans l'image d'un programmeur, j'ai beaucoup lu, √©tudi√©, exp√©riment√©. </font><font style="vertical-align: inherit;">Et comme je l'ai d√©j√† d√©crit ci-dessus, je voulais bien √©tudier, c'est tout. </font><font style="vertical-align: inherit;">Et pour cela, je me suis fix√© un objectif, pas des solutions toutes faites, seulement la mienne. </font><font style="vertical-align: inherit;">Et si tout a fonctionn√© pour moi, vous r√©ussirez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste de tout ce dont vous avez besoin:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine virtuelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16+ ou autre</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilateur de </font><b><font style="vertical-align: inherit;">bras</font></b><font style="vertical-align: inherit;"> - t√©l√©chargement sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads</font></font></a> </li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©bogueur et programmeur </font><b><font style="vertical-align: inherit;">openocd</font></b><font style="vertical-align: inherit;"> - vous ne pourrez pas t√©l√©charger √† partir du lien, nous collectons √† partir des sources, l'instruction est jointe</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/openocd/code openocd</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âditeur de texte √† votre go√ªt</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tout est install√© et assembl√©, nous pouvons passer au premier projet! </font><font style="vertical-align: inherit;">Et non, ce n'est m√™me pas une ampoule clignotante. </font><font style="vertical-align: inherit;">Pour commencer, nous devons nous plonger dans le processus d'initialisation du micropuits lui-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce dont nous avons besoin:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linker.ld</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init.c</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par le dernier paragraphe Init.c. </font><font style="vertical-align: inherit;">Tout d'abord, notre mk devrait charger l'adresse "pointeur de pile" est un pointeur vers l'adresse m√©moire qui est utilis√©e pour les instructions PUSH et POP. </font><font style="vertical-align: inherit;">Je vous recommande fortement d'√©tudier attentivement ces deux instructions, car je n'expliquerai pas en d√©tail toutes les instructions. </font><font style="vertical-align: inherit;">Comment impl√©menter cela, voir ci-dessous.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant cet exemple. </font><font style="vertical-align: inherit;">Extern signifie que le symbole est externe, et nous avons d√©clar√© ce symbole dans le fichier Linker.ld, nous y reviendrons un peu plus tard.</font></font><br>
<br>
<pre><code class="cpp hljs"> __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ici, nous utilisons un attribut qui indique au compilateur de placer le tableau dans la section isr_vector et que m√™me si nous ne l'utilisons pas dans le code, il doit toujours √™tre inclus dans le programme. Et son premier √©l√©ment sera ce m√™me pointeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant pourquoi ce tableau est et avec quoi il sera mang√©. Contrairement √† un processeur conventionnel, l'architecture micron sur le bras commence √† s'ex√©cuter quand ce n'est pas √† partir de l'adresse z√©ro, mais √† partir de l'adresse point√©e par le pointeur dans ce tableau, tout est compliqu√©. De plus, le premier pointeur de ce tableau pointe toujours vers le d√©but de la pile, mais le second pointe d√©j√† vers le d√©but de notre code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous donner un exemple. il est indiqu√© que la pile commence par 0x20010000 et que le code du programme est 0x0800008. alors le tableau peut √™tre √©crit comme</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {
    <span class="hljs-number">0x20010000</span>,
    <span class="hljs-number">0x08000008</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est-√†-dire que le contr√¥leur initialise d'abord la pile, puis consid√®re l'adresse de la premi√®re instruction et la charge dans le registre de compteur de programme. Maintenant, la chose la plus importante, selon le mod√®le, ces chiffres peuvent √™tre diff√©rents, mais avec l'exemple de stm32f7, je peux dire en toute confiance que ce tableau doit √™tre en m√©moire √† l'adresse 0x08000000. C'est √† partir de cette adresse que mk commencera son travail apr√®s avoir allum√© ou r√©initialis√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous allons arr√™ter et faire attention √† la fa√ßon de mettre ce tableau dans la section dont nous avons besoin. Cela se fait par "ld" ou linker. Ce programme rassemble l'ensemble de notre programme ensemble et le script Linker.ld est utilis√© pour cela. Je donne un exemple et l'analyserai davantage.</font></font><br>
<br>
<pre><code class="plaintext hljs">MEMORY{<font></font>
	ROM_AXIM (rx) : ORIGIN = 0x08000000, LENGTH = 1M<font></font>
	RAM_DTCM (rwx): ORIGIN = 0x20000000, LENGTH = 64K<font></font>
}<font></font>
<font></font>
_estack = LENGTH(RAM_DTCM) + ORIGIN(RAM_DTCM);<font></font>
<font></font>
SECTIONS{<font></font>
	.isr_vector : {<font></font>
	KEEP(*(.isr_vector))<font></font>
	} &gt;ROM_AXIM&lt;/code&gt;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qui se passe ici. MEMORY d√©finit des sections de m√©moire et SECTIONS d√©finit des sections. nous voyons ici notre _empilement et le fait qu'il est √©gal √† la somme du d√©but de la m√©moire et de sa longueur, c'est-√†-dire la fin de notre m√©moire. La section .isr_vector dans laquelle nous mettons notre tableau est √©galement d√©finie. </font></font><code>&gt;ROM_AXIM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† la fin de notre section signifie que cette section doit √™tre plac√©e dans la section m√©moire qui commence par 0x08000000 comme requis par nos microns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons le r√©seau l√† o√π c'est n√©cessaire maintenant nous avons besoin d'une sorte d'instruction pour que notre micron fonctionne. Voici l'init.c augment√©:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai mentionn√© pr√©c√©demment, la deuxi√®me adresse doit √™tre un pointeur vers la premi√®re fonction ou instruction. </font><font style="vertical-align: inherit;">Et encore une fois, les attributs, mais tout est simple, la fonction ne renvoie aucune valeur et suit n'importe quel ABI √† l'entr√©e, c'est-√†-dire nu ¬´nu¬ª. </font><font style="vertical-align: inherit;">Dans de telles fonctions, l'assembleur habituel est pouss√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est maintenant temps de compiler notre code et de voir ce qui se cache sous le capot. </font><font style="vertical-align: inherit;">Nous ne toucherons pas au Makefile pour l'instant.</font></font><br>
<br>
<pre><code class="bash hljs">arm-none-eabi-gcc -c init.c -o init.o -mthumb</code></pre><br>
<pre><code class="bash hljs">arm-none-eabi-gcc -TLinker.ld -o prog.elf init.o -Wl,--gc-sections -nostartfiles -nodefaultlibs -nostdlib</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ici, nous voyons beaucoup d'incompr√©hensible. </font><font style="vertical-align: inherit;">en ordre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-mthumb compile pour armv7, qui utilise uniquement les instructions du pouce </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TLinker.ld sp√©cifiez le script de l'√©diteur de liens. </font><font style="vertical-align: inherit;">par d√©faut, il compile pour √™tre ex√©cut√© dans l'environnement Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Wl, - gc-sections -nostartfiles -nodefaultlibs -nostdlib supprime toutes les biblioth√®ques standard, les fichiers d'initialisation de l'environnement C et toutes les autres biblioth√®ques auxiliaires telles que les math√©matiques.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, cela n'a aucun sens de charger cela en microns. </font><font style="vertical-align: inherit;">Mais il y a un sens √† voir et √† √©tudier le binaire.</font></font><br>
<br>
<pre><code class="bash hljs">objcopy -O ihex prog.elf prog.bin</code></pre><br>
<pre><code class="bash hljs">hexdump prog.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis nous verrons la conclusion. </font><font style="vertical-align: inherit;">¬´00000000: 00 01 00 02 09 00 00 08¬ª qui symbolisera notre succ√®s. </font><font style="vertical-align: inherit;">Ceci est mon premier article et je n'ai pas √©t√© en mesure de r√©v√©ler enti√®rement tout le mat√©riel et l'essence, donc dans le prochain, je d√©crirai les m√©canismes plus en d√©tail et nous, amis, nous pourrons passer √† un programme qui ne clignotera pas, mais configurera l'horloge du processeur et des bus.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490462/index.html">Monopole des services et neutralit√© du Net - les baies seront en avance</a></li>
<li><a href="../fr490464/index.html">√Ä propos d'une tentative infructueuse de droit d'auteur brutal ou de 68 milliards de titres qui ne changeront rien</a></li>
<li><a href="../fr490466/index.html">Feuille de route des disciplines math√©matiques pour l'apprentissage automatique, partie 2 (probabilit√©s)</a></li>
<li><a href="../fr490470/index.html">OWASP Moscou 2020/1</a></li>
<li><a href="../fr490472/index.html">Comme j'ai √©crit une crypto-monnaie semi-d√©centralis√©e en PHP. (Partie 1 - Collecte des biblioth√®ques)</a></li>
<li><a href="../fr490476/index.html">Capteur sans fil pour l'ouverture et la fermeture avec des fonctionnalit√©s avanc√©es</a></li>
<li><a href="../fr490478/index.html">Station de soudage DIY DIY v2</a></li>
<li><a href="../fr490480/index.html">O Tiling-wm en 2 mots</a></li>
<li><a href="../fr490484/index.html">G√©rer les capteurs de maison intelligente avec l'Assistant Google</a></li>
<li><a href="../fr490490/index.html">Week-end de lecture: 10 documents sur les effets du son sur la sant√© - de ¬´l'hygi√®ne du bruit¬ª au bon sommeil et au GTD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>