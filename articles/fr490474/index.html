<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🏫 🐽 🔌 STM32 Partie 1: Les bases 🔓 👩🏿 🖕🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous ne pouvez pas faire confiance au code que vous n'avez pas écrit complètement vous-même. - Ken ThompsonPeut-être ma citation préférée. C'est elle ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Partie 1: Les bases</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490474/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous ne pouvez pas faire confiance au code que vous n'avez pas écrit complètement vous-même. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ken Thompson</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peut-être ma citation préférée. C'est elle qui est devenue la raison pour laquelle j'ai décidé de plonger dans les profondeurs du terrier du lapin. J'ai commencé mon voyage dans le monde de la programmation tout récemment, seulement environ un mois s'est écoulé et j'ai décidé d'écrire des articles pour consolider le matériel. Tout a commencé par une tâche simple, synchroniser les lampes de votre studio photo en utilisant Arduina. Le problème a été résolu, mais je ne suis plus entré dans le studio photo, il n'y a pas de temps. A partir de ce moment, j'ai décidé de m'engager à fond dans la programmation des microcontrôleurs. Arduin, bien que séduisant par sa simplicité, je n'ai pas aimé la plateforme. Le choix s'est porté sur la société ST et leurs produits populaires. À ce moment-là, je n'avais toujours aucune idée de la différence, mais en tant que consommateur typique, j'ai comparé la vitesse du «processeur» et la quantité de mémoire, je me suis acheté une carte impressionnante avec un écran STM32F746NG - Discovery.Je vais manquer les moments de désespoir et aller droit au but.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immergé dans l'image d'un programmeur, j'ai beaucoup lu, étudié, expérimenté. </font><font style="vertical-align: inherit;">Et comme je l'ai déjà décrit ci-dessus, je voulais bien étudier, c'est tout. </font><font style="vertical-align: inherit;">Et pour cela, je me suis fixé un objectif, pas des solutions toutes faites, seulement la mienne. </font><font style="vertical-align: inherit;">Et si tout a fonctionné pour moi, vous réussirez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste de tout ce dont vous avez besoin:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine virtuelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16+ ou autre</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilateur de </font><b><font style="vertical-align: inherit;">bras</font></b><font style="vertical-align: inherit;"> - téléchargement sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads</font></font></a> </li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">débogueur et programmeur </font><b><font style="vertical-align: inherit;">openocd</font></b><font style="vertical-align: inherit;"> - vous ne pourrez pas télécharger à partir du lien, nous collectons à partir des sources, l'instruction est jointe</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/openocd/code openocd</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éditeur de texte à votre goût</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tout est installé et assemblé, nous pouvons passer au premier projet! </font><font style="vertical-align: inherit;">Et non, ce n'est même pas une ampoule clignotante. </font><font style="vertical-align: inherit;">Pour commencer, nous devons nous plonger dans le processus d'initialisation du micropuits lui-même. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce dont nous avons besoin:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linker.ld</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init.c</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par le dernier paragraphe Init.c. </font><font style="vertical-align: inherit;">Tout d'abord, notre mk devrait charger l'adresse "pointeur de pile" est un pointeur vers l'adresse mémoire qui est utilisée pour les instructions PUSH et POP. </font><font style="vertical-align: inherit;">Je vous recommande fortement d'étudier attentivement ces deux instructions, car je n'expliquerai pas en détail toutes les instructions. </font><font style="vertical-align: inherit;">Comment implémenter cela, voir ci-dessous.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant cet exemple. </font><font style="vertical-align: inherit;">Extern signifie que le symbole est externe, et nous avons déclaré ce symbole dans le fichier Linker.ld, nous y reviendrons un peu plus tard.</font></font><br>
<br>
<pre><code class="cpp hljs"> __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ici, nous utilisons un attribut qui indique au compilateur de placer le tableau dans la section isr_vector et que même si nous ne l'utilisons pas dans le code, il doit toujours être inclus dans le programme. Et son premier élément sera ce même pointeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant pourquoi ce tableau est et avec quoi il sera mangé. Contrairement à un processeur conventionnel, l'architecture micron sur le bras commence à s'exécuter quand ce n'est pas à partir de l'adresse zéro, mais à partir de l'adresse pointée par le pointeur dans ce tableau, tout est compliqué. De plus, le premier pointeur de ce tableau pointe toujours vers le début de la pile, mais le second pointe déjà vers le début de notre code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous donner un exemple. il est indiqué que la pile commence par 0x20010000 et que le code du programme est 0x0800008. alors le tableau peut être écrit comme</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {
    <span class="hljs-number">0x20010000</span>,
    <span class="hljs-number">0x08000008</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est-à-dire que le contrôleur initialise d'abord la pile, puis considère l'adresse de la première instruction et la charge dans le registre de compteur de programme. Maintenant, la chose la plus importante, selon le modèle, ces chiffres peuvent être différents, mais avec l'exemple de stm32f7, je peux dire en toute confiance que ce tableau doit être en mémoire à l'adresse 0x08000000. C'est à partir de cette adresse que mk commencera son travail après avoir allumé ou réinitialisé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous allons arrêter et faire attention à la façon de mettre ce tableau dans la section dont nous avons besoin. Cela se fait par "ld" ou linker. Ce programme rassemble l'ensemble de notre programme ensemble et le script Linker.ld est utilisé pour cela. Je donne un exemple et l'analyserai davantage.</font></font><br>
<br>
<pre><code class="plaintext hljs">MEMORY{<font></font>
	ROM_AXIM (rx) : ORIGIN = 0x08000000, LENGTH = 1M<font></font>
	RAM_DTCM (rwx): ORIGIN = 0x20000000, LENGTH = 64K<font></font>
}<font></font>
<font></font>
_estack = LENGTH(RAM_DTCM) + ORIGIN(RAM_DTCM);<font></font>
<font></font>
SECTIONS{<font></font>
	.isr_vector : {<font></font>
	KEEP(*(.isr_vector))<font></font>
	} &gt;ROM_AXIM&lt;/code&gt;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qui se passe ici. MEMORY définit des sections de mémoire et SECTIONS définit des sections. nous voyons ici notre _empilement et le fait qu'il est égal à la somme du début de la mémoire et de sa longueur, c'est-à-dire la fin de notre mémoire. La section .isr_vector dans laquelle nous mettons notre tableau est également définie. </font></font><code>&gt;ROM_AXIM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à la fin de notre section signifie que cette section doit être placée dans la section mémoire qui commence par 0x08000000 comme requis par nos microns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons le réseau là où c'est nécessaire maintenant nous avons besoin d'une sorte d'instruction pour que notre micron fonctionne. Voici l'init.c augmenté:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai mentionné précédemment, la deuxième adresse doit être un pointeur vers la première fonction ou instruction. </font><font style="vertical-align: inherit;">Et encore une fois, les attributs, mais tout est simple, la fonction ne renvoie aucune valeur et suit n'importe quel ABI à l'entrée, c'est-à-dire nu «nu». </font><font style="vertical-align: inherit;">Dans de telles fonctions, l'assembleur habituel est poussé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est maintenant temps de compiler notre code et de voir ce qui se cache sous le capot. </font><font style="vertical-align: inherit;">Nous ne toucherons pas au Makefile pour l'instant.</font></font><br>
<br>
<pre><code class="bash hljs">arm-none-eabi-gcc -c init.c -o init.o -mthumb</code></pre><br>
<pre><code class="bash hljs">arm-none-eabi-gcc -TLinker.ld -o prog.elf init.o -Wl,--gc-sections -nostartfiles -nodefaultlibs -nostdlib</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ici, nous voyons beaucoup d'incompréhensible. </font><font style="vertical-align: inherit;">en ordre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-mthumb compile pour armv7, qui utilise uniquement les instructions du pouce </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TLinker.ld spécifiez le script de l'éditeur de liens. </font><font style="vertical-align: inherit;">par défaut, il compile pour être exécuté dans l'environnement Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Wl, - gc-sections -nostartfiles -nodefaultlibs -nostdlib supprime toutes les bibliothèques standard, les fichiers d'initialisation de l'environnement C et toutes les autres bibliothèques auxiliaires telles que les mathématiques.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, cela n'a aucun sens de charger cela en microns. </font><font style="vertical-align: inherit;">Mais il y a un sens à voir et à étudier le binaire.</font></font><br>
<br>
<pre><code class="bash hljs">objcopy -O ihex prog.elf prog.bin</code></pre><br>
<pre><code class="bash hljs">hexdump prog.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis nous verrons la conclusion. </font><font style="vertical-align: inherit;">«00000000: 00 01 00 02 09 00 00 08» qui symbolisera notre succès. </font><font style="vertical-align: inherit;">Ceci est mon premier article et je n'ai pas été en mesure de révéler entièrement tout le matériel et l'essence, donc dans le prochain, je décrirai les mécanismes plus en détail et nous, amis, nous pourrons passer à un programme qui ne clignotera pas, mais configurera l'horloge du processeur et des bus.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490462/index.html">Monopole des services et neutralité du Net - les baies seront en avance</a></li>
<li><a href="../fr490464/index.html">À propos d'une tentative infructueuse de droit d'auteur brutal ou de 68 milliards de titres qui ne changeront rien</a></li>
<li><a href="../fr490466/index.html">Feuille de route des disciplines mathématiques pour l'apprentissage automatique, partie 2 (probabilités)</a></li>
<li><a href="../fr490470/index.html">OWASP Moscou 2020/1</a></li>
<li><a href="../fr490472/index.html">Comme j'ai écrit une crypto-monnaie semi-décentralisée en PHP. (Partie 1 - Collecte des bibliothèques)</a></li>
<li><a href="../fr490476/index.html">Capteur sans fil pour l'ouverture et la fermeture avec des fonctionnalités avancées</a></li>
<li><a href="../fr490478/index.html">Station de soudage DIY DIY v2</a></li>
<li><a href="../fr490480/index.html">O Tiling-wm en 2 mots</a></li>
<li><a href="../fr490484/index.html">Gérer les capteurs de maison intelligente avec l'Assistant Google</a></li>
<li><a href="../fr490490/index.html">Week-end de lecture: 10 documents sur les effets du son sur la santé - de «l'hygiène du bruit» au bon sommeil et au GTD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>