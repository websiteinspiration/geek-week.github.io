<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📓 👩🏿‍🔬 🐴 DEVOXX UK. Kubernetes in der Produktion: Blau / Grün-Bereitstellung, automatische Skalierung und Bereitstellungsautomatisierung. Teil 2 ❄️ 🎨 🤑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes ist ein großartiges Tool zum Ausführen von Docker-Containern in einer Cluster-Produktionsumgebung. Es gibt jedoch Aufgaben, die Kubernetes ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DEVOXX UK. Kubernetes in der Produktion: Blau / Grün-Bereitstellung, automatische Skalierung und Bereitstellungsautomatisierung. Teil 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504672/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes ist ein großartiges Tool zum Ausführen von Docker-Containern in einer Cluster-Produktionsumgebung. Es gibt jedoch Aufgaben, die Kubernetes nicht lösen kann. Bei häufigen Bereitstellungen in einer Produktionsumgebung benötigen wir eine vollautomatische Blue / Green-Bereitstellung, um Ausfallzeiten in diesem Prozess zu vermeiden, für die auch externe HTTP-Anforderungen und SSL-Uploads erforderlich sind. Dies erfordert die Integration mit einem Load Balancer wie ha-proxy. Eine weitere Aufgabe ist die halbautomatische Skalierung des Kubernetes-Clusters selbst bei der Arbeit in der Cloud, beispielsweise die teilweise Reduzierung der Cluster-Skalierung bei Nacht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obwohl Kubernetes diese Funktionen nicht standardmäßig bietet, bietet es eine API, mit der solche Probleme gelöst werden können. Kubernetes Cluster-Tools für die automatisierte Bereitstellung und Skalierung von Blau / Grün wurden im Rahmen des Open-Source-Projekts Cloud RTI entwickelt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Video-Transkript wird beschrieben, wie Sie Kubernetes zusammen mit anderen Open Source-Komponenten konfigurieren, um eine produktionsbereite Umgebung zu erhalten, die Code aus dem Commit für die Festschreibung von Git Commits ohne Ausfallzeiten in der Produktion akzeptiert.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/4y/jm/cy4yjm9zwmpfpvtfwhwfigavpkw.jpeg"><a name="habracut"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEVOXX UK. Kubernetes in der Produktion: Blau / Grün-Bereitstellung, automatische Skalierung und Bereitstellungsautomatisierung. Teil 1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nachdem Sie von außen auf Ihre Anwendungen zugegriffen haben, können Sie mit der vollständigen Konfiguration der Automatisierung beginnen, dh sie auf die Stufe bringen, auf der Sie das Git-Commit ausführen und sicherstellen können, dass dieses Git-Commit in der Produktion endet. Natürlich möchten wir bei der Implementierung dieser Schritte und bei der Implementierung der Bereitstellung keine Ausfallzeiten haben. Jede Automatisierung in Kubernetes beginnt also mit einer API.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5q/w4/ng/5qw4ngl2hrnecjzk4sfvhhepx_k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes ist kein Tool, das produktiv „out of the box“ eingesetzt werden kann. Natürlich können Sie dies tun, Kubectl verwenden und so weiter, aber dennoch ist die API das Interessanteste und Nützlichste an dieser Plattform. Mit der API als Funktionsumfang können Sie auf fast alles zugreifen, was Sie in Kubernetes tun möchten. Kubectl selbst verwendet auch die REST-API.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist REST, sodass Sie alle Sprachen und Tools verwenden können, um mit dieser API zu arbeiten. Benutzerbibliotheken erleichtern Ihnen jedoch das Leben erheblich. Mein Team hat zwei solcher Bibliotheken geschrieben: eine für Java / OSGi und eine für Go. Die zweite wird nicht oft verwendet, aber auf jeden Fall stehen Ihnen diese nützlichen Dinge zur Verfügung. Sie sind ein teilweise lizenziertes Open-Source-Projekt. Es gibt viele solcher Bibliotheken für verschiedene Sprachen, sodass Sie die am besten geeignete auswählen können.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/bj/ey/ejbjeyepppr2tet3aupem789num.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie mit der Automatisierung der Bereitstellung beginnen, müssen Sie sicherstellen, dass für diesen Prozess keine Ausfallzeiten auftreten. Zum Beispiel führt unser Team die Produktionsbereitstellung mitten am Tag durch, wenn die Mitarbeiter ihre Anwendungen optimal nutzen. Daher ist es sehr wichtig, Verzögerungen in diesem Prozess zu vermeiden. Um Ausfallzeiten zu vermeiden, werden zwei Methoden verwendet: Blau / Grün-Bereitstellung oder fortlaufendes Update. Im letzteren Fall werden 5 Replikate der Anwendung nacheinander aktualisiert. Diese Methode funktioniert hervorragend, funktioniert jedoch nicht, wenn Sie während des Bereitstellungsprozesses verschiedene Versionen der Anwendung gleichzeitig ausführen. In diesem Fall können Sie die Benutzeroberfläche aktualisieren, während das Backend mit der alten Version funktioniert und die Anwendung nicht mehr funktioniert.Unter dem Gesichtspunkt der Programmierung ist es daher ziemlich schwierig, unter solchen Bedingungen zu arbeiten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist einer der Gründe, warum wir die blau / grüne Bereitstellung bevorzugen, um die Bereitstellung unserer Anwendungen zu automatisieren. Bei dieser Methode müssen Sie sicherstellen, dass zu einem bestimmten Zeitpunkt nur eine Version der Anwendung aktiv ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der blau / grüne Bereitstellungsmechanismus ist wie folgt. Wir erhalten Datenverkehr für unsere Anwendungen über ha-proxy, wodurch die Ausführung von Anwendungsreplikaten derselben Version geleitet wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine neue Bereitstellung ausgeführt wird, verwenden wir Deployer, der mit neuen Komponenten bereitgestellt wird, und stellen die neue Version bereit. Das Bereitstellen einer neuen Version einer Anwendung bedeutet, dass ein neuer Satz von Replikaten "aufsteigt". Danach werden diese Replikate der neuen Version in einem separaten, neuen Pod gestartet. Ha-proxy weiß jedoch nichts über sie und hat ihnen bisher keine Arbeitslast gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher ist es zunächst erforderlich, den Zustand neuer Versionen von Health Cheeking zu überprüfen, um sicherzustellen, dass die Replikate bereit sind, die Last zu bedienen.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dx/qk/vd/dxqkvdwkbon86_g0l0plg-dqezu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Bereitstellungskomponenten müssen irgendeine Form von Health Cheek unterstützen. Dies kann eine sehr einfache HTTP-Prüfung mit einem Anruf sein, wenn Sie einen Code mit dem Status 200 erhalten, oder eine eingehendere Prüfung, bei der Sie die Verbindung von Replikaten mit der Datenbank und anderen Diensten, die Stabilität der Verbindungen der dynamischen Umgebung, ob alles startet und ordnungsgemäß funktioniert, überprüfen. Dieser Vorgang kann sehr kompliziert sein. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/9t/o4/lr9to4uiafxnxpjfbuyzd3ubtgo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem das System überprüft hat, ob alle aktualisierten Replikate betriebsbereit sind, aktualisiert Deployer die Konfiguration und übergibt die korrekte Konfiguration, wodurch ha-proxy neu konfiguriert wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/q1/s7/kwq1s7fkzffaby-ajt6jyrg2vra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erst danach wird der Datenverkehr mit Repliken der neuen Version nach unten geleitet, und die alte Version verschwindet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/q5/c6/waq5c6mmixf0j3twtrhetjjdvx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Mechanismus ist kein Merkmal von Kubernetes. Das blau / grüne Bereitstellungskonzept gibt es schon seit geraumer Zeit und es wurde immer ein Load Balancer verwendet. Zunächst leiten Sie den gesamten Datenverkehr auf die alte Version der Anwendung und übertragen ihn nach dem Upgrade vollständig auf die neue Version. Dieses Prinzip wird nicht nur in Kubernetes angewendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werde ich Ihnen eine neue Bereitstellungskomponente vorstellen - Deployer, die eine Integritätsprüfung durchführt, Proxys neu konfiguriert usw. Dies ist ein Konzept, das nicht für die Außenwelt gilt und innerhalb von Kubernetes existiert. Ich werde zeigen, wie Sie mit Open-Source-Tools Ihr eigenes Deployer-Konzept erstellen können.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als erstes erstellt Deployer einen RC-Replikationscontroller mithilfe der Kubernetes-API. Diese API erstellt Pods und Services für die weitere Bereitstellung, dh sie erstellt einen völlig neuen Cluster für unsere Anwendungen. Sobald der RC überprüft, ob die Replikate gestartet wurden, überprüft er ihre Integritätsprüfung. Zu diesem Zweck verwendet Deployer den Befehl GET / health. Es startet die entsprechenden Überprüfungskomponenten und überprüft alle Elemente, die den Betrieb des Clusters sicherstellen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/lr/8u/kmlr8uloqusoeejhd-7dquyzu7q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alle Pods ihren "Zustand" gemeldet haben, erstellt Deployer ein neues Konfigurationselement - den verteilten Speicher usw., der in Kubernetes verwendet wird, einschließlich zum Speichern der Load Balancer-Konfiguration. Wir schreiben Daten in etcd und ein kleines Tool, confd, überwacht etcd auf neue Daten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn er Änderungen an der Erstkonfiguration feststellt, generiert er eine neue Einstellungsdatei und übergibt sie an ha-proxy. In diesem Fall wird ha-proxy neu gestartet, ohne dass Verbindungen verloren gehen, und die Last wird mit neuen Diensten behoben, die die neue Version unserer Anwendungen bereitstellen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h2/1k/os/h21kosweevmblkultqa8kspeuri.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen, gibt es trotz der Fülle an Komponenten nichts Kompliziertes. </font><font style="vertical-align: inherit;">Sie müssen nur mehr auf die API und etcd achten. </font><font style="vertical-align: inherit;">Ich möchte Ihnen etwas über den Open-Source-Deployer erzählen, den wir selbst verwenden - dies ist Amdatu Kubernetes Deployer. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ir/oj/vt/irojvt6tjy6vgckfsizgnycysdm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist ein Kubernetes Deployment Orchestration-Tool mit den folgenden Funktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blau / Grün-Bereitstellung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichten eines externen Load Balancers;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment Descriptor Management</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tatsächliches Bereitstellungsmanagement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integritätsprüfungen während der Bereitstellung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung von Umgebungsvariablen in Pods.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Deployer wurde über der Kubernetes-API erstellt und bietet eine REST-API zum Verwalten von Deskriptoren und Bereitstellungen sowie eine Websocket-API für Stream-Protokolle während der Bereitstellung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Load Balancer-Konfigurationsdaten werden in etcd abgelegt, sodass Sie ha-proxy nicht mit "out of the box" -Unterstützung verwenden können. Es ist jedoch einfach, Ihre eigene Balancer-Konfigurationsdatei zu verwenden. Amdatu Deployer ist wie Kubernetes selbst in Go geschrieben und von Apache lizenziert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor ich diese Version des Deployers verwendet habe, habe ich den folgenden Deployment-Deskriptor verwendet, der die benötigten Parameter angibt.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/fr/ht/_pfrhtrtusrz0ua6480jo3acqvo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einer der wichtigen Parameter dieses Codes ist die Aktivierung des Flags "useHealthCheck". Wir müssen angeben, dass während des Bereitstellungsprozesses eine Integritätsprüfung erforderlich ist. Diese Option kann deaktiviert werden, wenn für die Bereitstellung Container von Drittanbietern verwendet werden, die nicht überprüft werden müssen. Dieser Deskriptor gibt auch die Anzahl der Replikate und die Frontend-URL an, die ha-proxy benötigt. Am Ende befindet sich das Spezifikationsflag für den Podspec-Pod, der Kubernetes aufruft, um Informationen zur Portkonfiguration, zum Image usw. zu erhalten. Dies ist ein ziemlich einfacher Deskriptor im JSON-Format.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres Tool, das Teil des Amdatu Open Source-Projekts ist, ist Deploymentctl. Es verfügt über eine Benutzeroberfläche zur Konfiguration der Bereitstellung, speichert den Bereitstellungsverlauf und enthält Webhooks für Rückrufe durch Benutzer und Entwickler von Drittanbietern. Sie können die Benutzeroberfläche nicht verwenden, da Amdatu Deployer selbst eine REST-API ist. Diese Schnittstelle erleichtert Ihnen jedoch die Bereitstellung ohne API. Deploymentctl wurde in OSGi / Vertx mit Angular 2 geschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werde ich das Obige auf dem Bildschirm anhand einer vorgefertigten Aufzeichnung demonstrieren, damit Sie nicht warten müssen. Wir werden eine einfache Anwendung auf Go bereitstellen. Keine Sorge, wenn Sie Go noch nicht kennengelernt haben, ist dies eine sehr einfache Anwendung. Sie sollten also alles verstehen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/rq/ih/adrqihjjsirswywycn8zcm_ypsy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier erstellen wir einen HTTP-Server, der nur auf / health reagiert, sodass diese Anwendung nur die Integritätsprüfung und sonst nichts überprüft. Wenn die Prüfung bestanden ist, wird die unten gezeigte JSON-Struktur aufgerufen. Es enthält die Version der Anwendung, die vom Bereitsteller bereitgestellt wird, die Meldung, die oben in der Datei angezeigt wird, und den booleschen logischen Datentyp - unabhängig davon, ob unsere Anwendung funktioniert oder nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mit der letzten Zeile ein wenig geschummelt, weil ich einen festen booleschen Wert oben in die Datei eingefügt habe, was mir in Zukunft helfen wird, selbst eine "ungesunde" Anwendung bereitzustellen. Wir werden uns später darum kümmern.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also lasst uns anfangen. Zuerst überprüfen wir mit dem Befehl ~ kubectl get pods, ob Pods ausgeführt werden. Wenn die Frontend-URL keine Antwort gibt, stellen wir sicher, dass derzeit keine Bereitstellungen ausgeführt werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/vs/kx/qavskxpsjbdy93vis6wd4xp6tas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Nächstes sehen Sie auf dem Bildschirm die von mir erwähnte Deploymentctl-Oberfläche, in der die Bereitstellungsparameter festgelegt sind: Namespace, Anwendungsname, Bereitstellungsversion, Anzahl der Replikate, Frontend-URL, Containername, Image, Ressourcenlimits, Portnummer zur Überprüfung der Integritätsprüfung usw. . Ressourcenlimits sind sehr wichtig, da Sie so die maximal mögliche Menge an "Eisen" verwenden können. Hier können Sie auch das Bereitstellungsprotokoll des Bereitstellungsprotokolls anzeigen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/fk/wb/g_fkwbqrgrbuaii4xmoqhmds3lu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie den Befehl ~ kubectl get pods jetzt wiederholen, können Sie sehen, dass das System 20 Sekunden lang „einfriert“, währenddessen die Neukonfiguration des ha-Proxys erfolgt. Danach beginnt es unter und unser Replikat wird im Bereitstellungsprotokoll angezeigt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/eb/kb/vmebkbw-zpzs2yjjex70jyiz2gg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe eine Wartezeit von 20 Sekunden aus dem Video herausgeschnitten, und jetzt sehen Sie auf dem Bildschirm, dass die erste Version der Anwendung bereitgestellt wird. All dies wurde nur mit Hilfe der Benutzeroberfläche durchgeführt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/nw/dq/btnwdq4bpxvs3xloqvdfo01nwla.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir jetzt die zweite Version. Dazu ändere ich die Meldung der Anwendung mit "Hallo, Kubernetes!" Bei „Hallo, Deployer!“ erstellt das System dieses Image und platziert es in der Docker-Registrierung. Anschließend klicken Sie einfach erneut auf die Schaltfläche „Deploy“ im Deploymentctl-Fenster. In diesem Fall wird das Bereitstellungsprotokoll automatisch auf dieselbe Weise gestartet wie bei der Bereitstellung der ersten Version der Anwendung.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/fb/hx/7ffbhx4jbq_bwxyxskyfbhqg0cy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Befehl ~ kubectl get pods zeigt an, dass derzeit 2 Versionen der Anwendung ausgeführt werden. Das Front-End zeigt jedoch an, dass noch Version 1 ausgeführt wird. Der </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/xz/xg/guxzxgf4t6g8xxruexeuptcebze.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Load Balancer wartet, bis die Integritätsprüfung ausgeführt wird, und leitet den Datenverkehr dann zur neuen Version um. Nach 20 Sekunden wechseln wir zu Curl und stellen fest, dass wir jetzt Version 2 der Anwendung bereitgestellt haben und die erste entfernt wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cq/jp/0k/cqjp0kwmkhlufezt-hzs-80fezq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war die Bereitstellung einer "gesunden" - gesunden - Anwendung. Mal sehen, was passiert, wenn ich für die neue Version der Anwendung den Wert des Parameters "Healthy" von "true" in "false" ändere. Das heißt, ich werde versuchen, eine fehlerhafte Anwendung bereitzustellen, die die Integritätsprüfung nicht bestanden hat. Dies kann passieren, wenn in der Entwicklungsphase einige Konfigurationsfehler in der Anwendung gemacht wurden und diese in dieser Form in Produktion ging.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen können, durchläuft die Bereitstellung alle oben genannten Schritte, und ~ kubectl get pods zeigt an, dass beide Pods ausgeführt werden. Im Gegensatz zur vorherigen Bereitstellung zeigt das Protokoll jedoch den Status des Zeitlimits an. Das heißt, aufgrund der Tatsache, dass die Integritätsprüfung nicht bestanden wurde, kann die neue Version der Anwendung nicht bereitgestellt werden. Als Ergebnis sehen Sie, dass das System wieder die alte Version der Anwendung verwendet hat und die neue Version einfach gelöscht wurde.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/iv/qz/kqivqzsf3ghxznqksadtfobhzfm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Gute daran ist, dass selbst wenn eine große Anzahl von Anforderungen gleichzeitig in die Anwendung eingehen, diese während der Implementierung des Bereitstellungsverfahrens keine Ausfallzeiten bemerken. Wenn Sie diese Anwendung mit dem Gatling-Framework testen, das die maximal mögliche Anzahl von Anforderungen sendet, wird keine dieser Anforderungen gelöscht. Dies bedeutet, dass unsere Benutzer nicht einmal Versionsaktualisierungen in Echtzeit bemerken. Wenn dies fehlschlägt, wird die Arbeit an der alten Version fortgesetzt. Wenn dies erfolgreich ist, wechseln Benutzer zur neuen Version.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt nur eine Sache, die zu einem Fehler führen kann: Wenn die Integritätsprüfung erfolgreich war und die Anwendung abstürzte, sobald sie die Arbeitslast erhalten hat, tritt der Zusammenbruch erst nach Abschluss der Bereitstellung auf. In diesem Fall müssen Sie manuell auf die alte Version zurücksetzen. Wir haben uns also angesehen, wie man Kubernetes mit seinen Open-Source-Tools verwendet. Der Bereitstellungsprozess wird viel einfacher, wenn Sie diese Tools in die Pipelines zum Erstellen / Bereitstellen von Pipelines einbetten / bereitstellen. Gleichzeitig können Sie zum Starten der Bereitstellung sowohl die Benutzeroberfläche verwenden als auch diesen Prozess vollständig automatisieren, indem Sie beispielsweise Commit to Master anwenden.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/4w/s6/xp4ws6tpk0katzykjamtvd1tuz8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Build Server Build Server erstellt ein Docker-Image, fügt es in den Docker Hub oder eine andere von Ihnen verwendete Registrierung ein. Der Docker-Hub unterstützt Webhook, sodass wir die Remote-Bereitstellung über Deployer wie oben gezeigt starten können. Auf diese Weise können Sie die Bereitstellung der Anwendung in der potenziellen Produktion vollständig automatisieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fahren wir mit dem nächsten Thema fort - der Skalierung des Kubernetes-Clusters. Beachten Sie, dass der Befehl kubectl ein Skalierungsbefehl ist. Mit Hilfe eines anderen können Sie die Anzahl der Replikate in unserem Cluster problemlos erhöhen. In der Praxis möchten wir jedoch normalerweise die Anzahl der Knoten erhöhen, nicht die Anzahl der Knoten.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/za/t9/ghzat9sqpdai1jdgg3wabhrfeka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig müssen Sie möglicherweise während der Arbeitszeit die Anzahl der ausgeführten Instanzen der Anwendung erhöhen und nachts, um die Kosten für Amazon-Dienste zu senken, verringern. Dies bedeutet nicht, dass nur die Anzahl der Pods für die Skalierung ausreicht, denn selbst wenn einer der Knoten nicht ausgelastet ist, müssen Sie Amazon dafür bezahlen. Das heißt, zusammen mit der Skalierung der Herde müssen Sie die Anzahl der verwendeten Maschinen skalieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies kann schwierig sein, da Kubernetes unabhängig davon, ob wir Amazon oder einen anderen Cloud-Dienst verwenden, nichts über die Anzahl der verwendeten Computer weiß. Es fehlt ein Tool, mit dem Sie das System auf Knotenebene skalieren können.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h8/6d/js/h86djs8fjx9qwpqos9lwpoknxno.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir müssen uns also um die Knoten und die Pods kümmern. Wir können den Start neuer Knoten mithilfe der AWS-API und der Skalierungsgruppencomputer einfach skalieren, um die Anzahl der Kubernetes-Arbeitsknoten zu konfigurieren. Sie können auch Cloud-Init oder ein ähnliches Skript verwenden, um Knoten in einem Kubernetes-Cluster zu registrieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der neue Computer startet in der Scaling-Gruppe, initiiert sich als Knoten, registriert sich in der Registrierung des Assistenten und beginnt mit der Arbeit. Danach können Sie die Anzahl der Replikate erhöhen, die auf den resultierenden Knoten verwendet werden sollen. Das Reduzieren des Maßstabs erfordert mehr Aufwand, da Sie sicherstellen müssen, dass ein solcher Schritt nicht zur Zerstörung bereits laufender Anwendungen führt, nachdem "unnötige" Maschinen ausgeschaltet wurden. Um dieses Szenario zu verhindern, müssen Sie die Knoten in den Status "nicht planbar" versetzen. Dies bedeutet, dass der Standardplaner beim Planen von DaemonSet-Pods diese Knoten ignoriert. Der Scheduler löscht nichts von diesen Servern, startet dort aber auch keine neuen Container. Der nächste Schritt besteht darin, den Abflussknoten zu verschieben, dh die Arbeitsherde von dieser auf eine andere Maschine oder andere Knoten zu übertragen, die über eine ausreichende Kapazität dafür verfügen.Nachdem Sie überprüft haben, dass sich auf diesen Knoten keine Container mehr befinden, können Sie sie aus Kubernetes entfernen. Danach hören sie für Kubernetes einfach auf zu existieren. Als Nächstes müssen Sie die AWS-API verwenden, um unnötige Knoten oder Computer zu deaktivieren.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können Amdatu Scalerd verwenden, ein weiteres Open-Source-Skalierungswerkzeug, das der AWS-API ähnelt. Es bietet eine CLI zum Hinzufügen oder Entfernen von Knoten in einem Cluster. Die interessante Funktion ist die Möglichkeit, den Scheduler mithilfe der folgenden JSON-Datei zu konfigurieren. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/0b/8z/e1/0b8ze13eeahulvu7j2cbuu2m8fe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der angezeigte Code halbiert die Kapazität des Clusters nachts. Es wird als Anzahl der verfügbaren Replikate und als gewünschte Kapazität des Amazon-Clusters konfiguriert. Durch die Verwendung dieses Schedulers wird die Anzahl der Knoten nachts automatisch reduziert und morgens erhöht, wodurch die Kosten für die Verwendung von Knoten eines Cloud-Dienstes wie Amazon gespart werden. Diese Funktion ist nicht in Kubernetes integriert. Mit Scalerd können Sie diese Plattform jedoch nach Ihren Wünschen skalieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte Ihre Aufmerksamkeit auf die Tatsache lenken, dass mir viele Leute sagen: "Das ist alles gut, aber was ist mit meiner Datenbank, die sich normalerweise in einem statischen Zustand befindet?" Wie kann ich so etwas in einer dynamischen Umgebung wie Kubernetes ausführen? Meiner Meinung nach sollten Sie dies nicht tun, sollten nicht versuchen, den Betrieb des Data Warehouse in Kubernetes zu organisieren. Technisch ist dies möglich, und es gibt Handbücher im Internet zu diesem Thema, aber es wird Ihr Leben ernsthaft verkomplizieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja, das Konzept des persistenten Speichers existiert in Kubernetes, und Sie können versuchen, Data Warehouses wie Mongo oder MySQL auszuführen, aber dies ist eine ziemlich zeitaufwändige Aufgabe. Dies liegt an der Tatsache, dass Data Warehouses die Interaktion mit einer dynamischen Umgebung nicht vollständig unterstützen. Die meisten Datenbanken erfordern eine erhebliche Optimierung, einschließlich der manuellen Konfiguration des Clusters. Sie mögen keine automatische Skalierung und ähnliche Dinge. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erschweren Sie daher nicht Ihr Leben, wenn Sie versuchen, ein Data Warehouse in Kubernetes zu starten. Organisieren Sie ihre Arbeit auf traditionelle Weise mit vertrauten Diensten und geben Sie Kubernetes die Möglichkeit, sie zu nutzen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/ae/w4/jtaew4lftz8i845qgy8pa6bculm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende des Themas möchte ich Ihnen die Cloud RTI-Plattform vorstellen, die auf Kubernetes basiert und an der mein Team arbeitet. Es bietet zentralisierte Protokollierung, Überwachung von Anwendungen und Clustern sowie viele andere nützliche Funktionen, die für Sie nützlich sind. Es verwendet verschiedene Open-Source-Tools wie Grafana, um die Überwachung anzuzeigen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oo/uj/mz/ooujmzx3ukdhlcqyxxwqszgelts.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ec/cd/5j/eccd5j4rch3uhdrqey516jdxnva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde die Frage aufgeworfen, warum der ha-proxy Load Balancer mit Kubernetes verwendet wird. Gute Frage, denn derzeit gibt es zwei Stufen des Lastausgleichs. Kubernetes-Dienste befinden sich weiterhin auf virtuellen IP-Adressen. Sie können sie nicht für externe Host-Ports verwenden, da sich die Adresse ändert, wenn Amazon seinen Cloud-Host neu startet. Aus diesem Grund stellen wir Ha-Proxy-Dienste vor Dienste, um eine statischere Struktur für eine nahtlose Verkehrsinteraktion mit Kubernetes zu schaffen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine weitere gute Frage ist, wie ich das Datenbankschema während der blau / grünen Bereitstellung ändern kann. </font><font style="vertical-align: inherit;">Tatsache ist, dass das Ändern des Datenbankschemas unabhängig von der Verwendung von Kubernetes eine komplexe Aufgabe ist. </font><font style="vertical-align: inherit;">Sie müssen die Kompatibilität des alten und des neuen Schemas sicherstellen. Anschließend können Sie die Datenbank aktualisieren und anschließend die Anwendungen selbst aktualisieren. </font><font style="vertical-align: inherit;">Sie können die Datenbank im laufenden Betrieb austauschen und anschließend die Anwendungen aktualisieren. </font><font style="vertical-align: inherit;">Ich kenne Leute, die einen völlig neuen Datenbankcluster mit einem neuen Schema heruntergeladen haben. Dies ist eine Option, wenn Sie eine schemenlose Datenbank wie Mongo haben, aber auf jeden Fall ist dies keine leichte Aufgabe. </font><font style="vertical-align: inherit;">Wenn Sie keine Fragen mehr haben, vielen Dank für Ihre Aufmerksamkeit!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-Ci4vd4rh4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Werbung :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank für Ihren Aufenthalt bei uns. Gefällt dir unser Artikel? Möchten Sie weitere interessante Materialien sehen? Unterstützen Sie uns, indem Sie eine Bestellung </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">aufgeben</font></a><font style="vertical-align: inherit;"> oder Ihren Freunden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud-basiertes VPS für Entwickler ab 4,99 US-Dollar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> empfehlen </font><font style="vertical-align: inherit;">, ein </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einzigartiges Analogon von Einstiegsservern, das von uns für Sie erfunden wurde: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die ganze Wahrheit über VPS (KVM) E5-2697 v3 (6 Kerne) 10 GB DDR4 480 GB SSD 1 Gbit / s ab 19 $ oder wie teilt man den Server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Optionen sind mit RAID1 und RAID10, bis zu 24 Kernen und bis zu 40 GB DDR4 verfügbar). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2-mal günstiger im Equinix Tier IV-Rechenzentrum in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nur wir haben </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2,6 GHz 14C 64 GB DDR4 4 x 960 GB SSD 1 Gbit / s 100 TV von 199 US-Dollar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in den Niederlanden!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2,2 GHz 6C 128 GB DDR3 2x960 GB SSD 1 Gbit / s 100 TB - ab 99 US-Dollar! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lesen Sie mehr über</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> den Aufbau eines Infrastrukturgebäudes. </font><font style="vertical-align: inherit;">Klasse C mit Dell R730xd E5-2650 v4-Servern für 9.000 Euro für einen Cent?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504660/index.html">Prinzessin Frosch 2.0 alias Pelophylax ridibundus</a></li>
<li><a href="../de504662/index.html">Musik zeichnen: Sargtanz in Pure Data</a></li>
<li><a href="../de504664/index.html">Intelligentes Hinzufügen von Musikgruppen zu Google Sheets über VK API, Tampermonkey und Telegram Bot</a></li>
<li><a href="../de504668/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 346 (vom 25. bis 31. Mai)</a></li>
<li><a href="../de504670/index.html">Einheitliches Staatsexamen in Informatik oder Leiden</a></li>
<li><a href="../de504674/index.html">Basis für ein großes modulares SPA auf Laravel + Vue + ElementUI mit CRUD-Generator</a></li>
<li><a href="../de504676/index.html">Fügen Sie Ihrem Spiel eine Prise Zufälligkeit hinzu</a></li>
<li><a href="../de504678/index.html">ITMO Research_ Podcast: Wie man die Synchronisation von AR-Inhalten mit der Show auf der Skala des gesamten Stadions angeht</a></li>
<li><a href="../de504680/index.html">Übersicht über die NLP-Bibliothek von SpaL</a></li>
<li><a href="../de504682/index.html">Nostalgie Post: j2me, Schwerkraft trotzt, 64kb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>