<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥨 🐎 👷🏻 zipアーカイブはどのように見え、それで何ができるか。パート3-実用的なアプリケーション 👐🏾 🙆🏽 ✖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="記事の続きzipアーカイブの外観とそれで何ができるか。パート2-データ記述子と圧縮。
 
 読者各位、私は再びPHPでの型破りなプログラミングの移管を歓迎します。それらを理解するために、私はzipファイルに関する前の2つの記事を読むことをお勧めします：zipファイルの方法とそれで何ができるか、zip...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>zipアーカイブはどのように見え、それで何ができるか。パート3-実用的なアプリケーション</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484520/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事の続き</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zipアーカイブの外観とそれで何ができるか。パート2-データ記述子と圧縮</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
読者各位、私は再びPHPでの型破りなプログラミングの移管を歓迎します。それらを理解するために、私はzipファイルに関する前の2つの記事を読むことをお勧めします：zipファイルの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法とそれ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何ができるか、zipファイルとは何で何ができるか。パート2-データ記述子と圧縮</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
以前に、PHPコードのみを使用し、ライブラリや拡張機能（標準</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を含む</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を使用しないでアーカイブを作成する方法について説明し</font><font style="vertical-align: inherit;">、いくつかの使用シナリオについても触れました。今日は、これらのシナリオの1つの例を挙げましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像をリモートサーバーのアーカイブに保存し、必要に応じて、アーカイブをダウンロードまたは解凍せずにユーザーに特定の画像を表示しますが、サーバーから取得した特定の画像のデータのみを受信し、それ以上は受信しません（ヘッダーのオーバーヘッドはキャンセルされませんでした） 、 それでも）。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">料理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のペットプロジェクトの1つに、大量の画像をダウンロードしてアーカイブに保存するために使用する簡単なスクリプトがあります。</font><font style="vertical-align: inherit;">スクリプトは、jsonでSTDINに入るリンクのリストを受け入れ、STDOUTにアーカイブ自体を提供し、jsonにSTDERRの配列構造を与えます（もちろん、これは少々やり過ぎであり、ネイティブPHPを使用してアーカイブを作成する必要はありません。これにより適切なツールを使用して、構造を読んでください-私は将来この点を強調するように努めますが、この段階では、それは私には思えます、それはより明白になります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスクリプトは、いくつかの変更を加えて、以下に引用しています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip.php</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
$buffer = <span class="hljs-string">''</span>;
<span class="hljs-keyword">while</span> (!feof(STDIN)) {<font></font>
    $buffer .= fread(STDIN, <span class="hljs-number">4096</span>);<font></font>
}<font></font>
<font></font>
$photos = json_decode($buffer, <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
<font></font>
$skeleton = [<span class="hljs-string">'files'</span> =&gt; []];<font></font>
$written = <span class="hljs-number">0</span>;<font></font>
    <font></font>
[$written, $skeleton] = writeZip($written, $skeleton, $photos);<font></font>
<font></font>
$CDFH_Offset = $written;<font></font>
<font></font>
<span class="hljs-keyword">foreach</span> ($skeleton[<span class="hljs-string">'files'</span>] <span class="hljs-keyword">as</span> $index =&gt; $info) {<font></font>
    $written += fwrite(STDOUT, $info[<span class="hljs-string">'CDFH'</span>]);<font></font>
    $skeleton[<span class="hljs-string">'files'</span>][$index][<span class="hljs-string">'CDFH'</span>] = base64_encode($info[<span class="hljs-string">'CDFH'</span>]);<font></font>
}<font></font>
<font></font>
$skeleton[<span class="hljs-string">'EOCD'</span>] = pack(<span class="hljs-string">'LSSSSLLS'</span>, <span class="hljs-number">0x06054b50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, $records = count($skeleton[<span class="hljs-string">'files'</span>]), $records, $written - $CDFH_Offset, $CDFH_Offset, <span class="hljs-number">0</span>); <font></font>
$written += fwrite(STDOUT, $skeleton[<span class="hljs-string">'EOCD'</span>]);<font></font>
$skeleton[<span class="hljs-string">'EOCD'</span>] = base64_encode($skeleton[<span class="hljs-string">'EOCD'</span>]);<font></font>
<font></font>
fwrite(STDERR, json_encode($skeleton));<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeZip</span>(<span class="hljs-params">$written, $skeleton, $files</span>)
</span>{    <font></font>
    $c = curl_init();<font></font>
    <font></font>
    curl_setopt_array($c, [<font></font>
        CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-number">1</span>,<font></font>
        CURLOPT_TIMEOUT        =&gt; <span class="hljs-number">50</span>,<font></font>
        CURLOPT_FOLLOWLOCATION =&gt; <span class="hljs-literal">true</span>,<font></font>
    ]);<font></font>
<font></font>
    <span class="hljs-keyword">foreach</span> ($files <span class="hljs-keyword">as</span> $index =&gt; $url) {<font></font>
        $fileName = $index . <span class="hljs-string">'.jpg'</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; <span class="hljs-number">1</span>; $i++ ) {
            <span class="hljs-keyword">try</span> {            <font></font>
                curl_setopt($c, CURLOPT_URL, $url);<font></font>
                <font></font>
                [$content, $code, $contentLength] = [<font></font>
                    curl_exec($c), <font></font>
                    (<span class="hljs-keyword">int</span>) curl_getinfo($c, CURLINFO_HTTP_CODE), <font></font>
                    (<span class="hljs-keyword">int</span>) curl_getinfo($c, CURLINFO_CONTENT_LENGTH_DOWNLOAD)<font></font>
                ];<font></font>
                <font></font>
                <span class="hljs-keyword">if</span> ($code !== <span class="hljs-number">200</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">"[{$index}] "</span> . <span class="hljs-string">'Photo download error ('</span> . $code . <span class="hljs-string">'): '</span> . curl_error($c));<font></font>
                }<font></font>
                    <font></font>
                <span class="hljs-keyword">if</span> (strlen($content) !== $contentLength) {<font></font>
                    var_dump(strlen($content), $contentLength);<font></font>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">"[{$index}] "</span> . <span class="hljs-string">'Different content-length'</span>);<font></font>
                }<font></font>
                <font></font>
                <span class="hljs-keyword">if</span> ((<span class="hljs-literal">false</span> === $imageSize = @getimagesizefromstring($content)) || $imageSize[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">1</span> || $imageSize[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">"[{$index}] "</span> . <span class="hljs-string">'Broken image'</span>);<font></font>
                }            <font></font>
                [$width, $height] = $imageSize;<font></font>
                $t = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $t) {}<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> ($t !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Error: '</span> . $index . <span class="hljs-string">' &gt; '</span> . $url, <span class="hljs-number">0</span>, $t);<font></font>
        }<font></font>
        <font></font>
        $fileInfo = [<font></font>
            <span class="hljs-string">'versionToExtract'</span>      =&gt; <span class="hljs-number">10</span>,
            <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-number">0</span>,
            <span class="hljs-string">'compressionMethod'</span>     =&gt; <span class="hljs-number">0</span>,
            <span class="hljs-string">'modificationTime'</span>      =&gt; <span class="hljs-number">28021</span>,
            <span class="hljs-string">'modificationDate'</span>      =&gt; <span class="hljs-number">20072</span>,
            <span class="hljs-string">'crc32'</span>                 =&gt; hexdec(hash(<span class="hljs-string">'crc32b'</span>, $content)),
            <span class="hljs-string">'compressedSize'</span>        =&gt; $size = strlen($content),
            <span class="hljs-string">'uncompressedSize'</span>      =&gt; $size,
            <span class="hljs-string">'filenameLength'</span>        =&gt; strlen($fileName),
            <span class="hljs-string">'extraFieldLength'</span>      =&gt; <span class="hljs-number">0</span>,<font></font>
        ];<font></font>
        <font></font>
        $LFH_Offset = $written;<font></font>
        <font></font>
        $skeleton[<span class="hljs-string">'files'</span>][$index] = [
            <span class="hljs-string">'LFH'</span>  =&gt; pack(<span class="hljs-string">'LSSSSSLLLSSa*'</span>, <span class="hljs-number">0x04034b50</span>, ...array_values($fileInfo + [<span class="hljs-string">'filename'</span> =&gt; $fileName])),
            <span class="hljs-string">'CDFH'</span> =&gt; pack(<span class="hljs-string">'LSSSSSSLLLSSSSSLLa*'</span>, <span class="hljs-number">0x02014b50</span>, <span class="hljs-number">798</span>, ...array_values($fileInfo + [
                <span class="hljs-string">'fileCommentLength'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'diskNumber'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'internalFileAttributes'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'externalFileAttributes'</span> =&gt; <span class="hljs-number">2176057344</span>,
                <span class="hljs-string">'localFileHeaderOffset'</span> =&gt; $LFH_Offset,
                <span class="hljs-string">'filename'</span> =&gt; $fileName,<font></font>
            ])),<font></font>
            <span class="hljs-string">'width'</span> =&gt; $width,
            <span class="hljs-string">'height'</span> =&gt; $height,<font></font>
        ];<font></font>
        <font></font>
        $written += fwrite(STDOUT, $skeleton[<span class="hljs-string">'files'</span>][$index][<span class="hljs-string">'LFH'</span>]);<font></font>
        $written += fwrite(STDOUT, $content);<font></font>
        $skeleton[<span class="hljs-string">'files'</span>][$index][<span class="hljs-string">'LFH'</span>] = base64_encode($skeleton[<span class="hljs-string">'files'</span>][$index][<span class="hljs-string">'LFH'</span>]);<font></font>
    }<font></font>
    <font></font>
    curl_close($c);<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> [$written, $skeleton];<font></font>
}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこかに保存して、zip.phpを呼び出して実行してみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はすでに18メガバイト〜についての絵があるので、私は、それを使用することをお勧めし、リンクの既製のリストを持っている、と20メガバイト（少し後、私はその理由を教えてくれます）を超えないように、我々は、総アーカイブのサイズを必要とする- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gist.githubusercontent.comを/userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json次の</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ように実行して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">みましょう</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">$ curl -s \<font></font>
    https://gist.githubusercontent.com/userqq/d0ca3aba6b6762c9ce5bc3ace92a9f9e/raw/70f446eb98f1ba6838ad3c19c3346cba371fd263/photos.json \<font></font>
    | php zip.php \<font></font>
    2&gt; structure.json \<font></font>
    1&gt; photos.zip</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理が完了すると</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">出力で</font><i><font style="vertical-align: inherit;">photos.zipという</font></i><font style="vertical-align: inherit;"> 2つのファイルが得られるはずです。</font><font style="vertical-align: inherit;">次のコマンドで確認することをお勧めし</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">$ unzip -tq photos.zip</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structure.json。ここでは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、jsonを、データ自体を除くすべてのLFHおよびCDFH構造、およびEOCDを除いて、アーカイブにあるすべてのbase64で格納します。アーカイブとは別にEOCDの実用的なアプリケーションはまだありませんが、ファイルの先頭に対するLFHオフセットの位置とデータ長はCDFHで示されています。したがって、LFHの長さがわかれば、データの開始位置と終了位置を確実に知ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ファイルをリモートサーバーにアップロードする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、私は電報ボットを使用します-これが最も簡単です。そのため、20MBの制限に合わせることが非常に重要でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
@BotFatherにボットを登録します。まだボットがない場合は、ボットへの歓迎の言葉を書き、https：//api.telegram.org/bot {{TOKEN►►/ getUpdatesでメッセージを探し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、message.from.id =プロパティを分離する場所から、チャットボットのIDです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の手順で取得したアーカイブをあなたで埋めます：</font></font><br>
<br>
<pre><code class="bash hljs">$ curl -F document=@<span class="hljs-string">"photos.zip"</span> <span class="hljs-string">"https://api.telegram.org/bot{{TOKEN}}/sendDocument?chat_id={{CHAT ID}}"</span> &gt; stored.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、すでに2つのjsonファイル、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structure.json</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stored.jsonが作成されました</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すべてがうまくいけば、stored.jsonファイルには、okフィールドがtrueであるjsonと、必要なresult.document.file_idが含まれます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトタイプ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての準備が整ったので、ビジネスに取り掛かりましょう。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
define(<span class="hljs-string">'TOKEN'</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">//   </span><font></font>
<font></font>
$structure = json_decode(file_get_contents(<span class="hljs-string">'structure.json'</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
$stored = json_decode(file_get_contents(<span class="hljs-string">'stored.json'</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
<font></font>
$selectedFile = $structure[<span class="hljs-string">'files'</span>][array_rand($structure[<span class="hljs-string">'files'</span>])];<font></font>
$LFH = base64_decode($selectedFile[<span class="hljs-string">'LFH'</span>]);<font></font>
$CDFH = base64_decode($selectedFile[<span class="hljs-string">'CDFH'</span>]);<font></font>
<font></font>
$fileLength = unpack(<span class="hljs-string">'Llen'</span>, substr($CDFH, <span class="hljs-number">24</span>, <span class="hljs-number">4</span>))[<span class="hljs-string">'len'</span>];<font></font>
$fileStart = unpack(<span class="hljs-string">'Lpos'</span>, substr($CDFH, <span class="hljs-number">42</span>, <span class="hljs-number">4</span>))[<span class="hljs-string">'pos'</span>] + strlen($LFH);<font></font>
$fileEnd = $fileStart + $fileLength;<font></font>
<font></font>
$response = json_decode(file_get_contents(<span class="hljs-string">'https://api.telegram.org/bot'</span> . TOKEN  . <span class="hljs-string">'/getFile?'</span> . http_build_query([
    <span class="hljs-string">'file_id'</span> =&gt; $stored[<span class="hljs-string">'result'</span>][<span class="hljs-string">'document'</span>][<span class="hljs-string">'file_id'</span>]<font></font>
])), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
<font></font>
header(<span class="hljs-string">'Content-Type: image/jpeg'</span>);<font></font>
readfile(<span class="hljs-string">'https://api.telegram.org/file/bot'</span> . TOKEN . <span class="hljs-string">'/'</span> . $response[<span class="hljs-string">'result'</span>][<span class="hljs-string">'file_path'</span>], <span class="hljs-literal">false</span>, stream_context_create([
    <span class="hljs-string">'http'</span> =&gt; [<span class="hljs-string">'header'</span>  =&gt; <span class="hljs-string">"Range: bytes={$fileStart}-{$fileEnd}"</span>]<font></font>
]));<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスクリプトでは、アーカイブにあるリストからランダムファイルを選択し、LFH開始位置を見つけ、それにLFHの長さを追加して、アーカイブ内の特定のファイルのデータの開始位置を取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにファイル長を加えると、データの最後の位置がわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル自体のアドレスを取得するために残ります（これはテレグラムの特定のケースです）。その後、ヘッダーを</font></font><code>Range: bytes=&lt;-&gt;-&lt;-&gt;</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用してリクエストを行います（サーバーがRangeリクエストをサポートしている</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">その結果、指定されたスクリプトにアクセスすると、アーカイブからランダムイメージのコンテンツが表示されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いいえ、まあ、それは深刻ではありません...</font></font></h3><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言うまでもなく</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、電報はリンクが少なくとも1時間</font><i><font style="vertical-align: inherit;">存続</font></i><font style="vertical-align: inherit;">することを保証するため、</font><i><font style="vertical-align: inherit;">getFile</font></i><font style="vertical-align: inherit;"> 
への要求</font><font style="vertical-align: inherit;">はキャッシュ</font><font style="vertical-align: inherit;">に</font><i><font style="vertical-align: inherit;">入れられる</font></i><font style="vertical-align: inherit;">べきです。</font><font style="vertical-align: inherit;">一般に、この例はそれが機能することを示すためにのみ役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう少し頑張ってみましょう-すべてをamphpで実行します。</font><font style="vertical-align: inherit;">結局のところ、人々はnode.jsの運用環境で静力学を配布していますが、何が私たちを止めているのでしょう（もちろん、常識は別として）</font><font style="vertical-align: inherit;">ここにも非同期があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのパッケージが必要です。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amphp / http-server-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明らかに、ファイルを配布するサーバー</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amphp / artax-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシュ内のファイルへの直接リンクを更新するだけでなく、データを取得するhttpクライアント。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amphp / parallel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はマルチスレッドなどのためのライブラリです。</font><font style="vertical-align: inherit;">しかし、恐れる必要はありません。それからSharedMemoryParcelが必要なだけで、im-memoryキャッシュとして機能します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な依存関係を配置します。</font></font><br>
<br>
<pre><code class="bash hljs">$ composer require amphp/http-server amphp/artax amphp/parallel</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてこれを書いてください </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本</font></font></b><div class="spoiler_text"><pre><code class="php hljs">
<span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
define(<span class="hljs-string">'TOKEN'</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Artax</span>\<span class="hljs-title">DefaultClient</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Artax</span>\<span class="hljs-title">Request</span> <span class="hljs-title">as</span> <span class="hljs-title">ArtaxRequest</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">RequestHandler</span>\<span class="hljs-title">CallableRequestHandler</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Server</span> <span class="hljs-title">as</span> <span class="hljs-title">HttpServer</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Status</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Parallel</span>\<span class="hljs-title">Sync</span>\<span class="hljs-title">SharedMemoryParcel</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Socket</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Psr</span>\<span class="hljs-title">Log</span>\<span class="hljs-title">NullLogger</span>;<font></font>
<font></font>
<span class="hljs-keyword">require</span> <span class="hljs-string">'vendor/autoload.php'</span>;<font></font>
<font></font>
Amp\Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<font></font>
    $structure = json_decode(file_get_contents(<span class="hljs-string">'structure.json'</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
    $stored = json_decode(file_get_contents(<span class="hljs-string">'stored.json'</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
    <font></font>
    $parcel = SharedMemoryParcel::create($id = bin2hex(random_bytes(<span class="hljs-number">10</span>)), []);<font></font>
    $client = <span class="hljs-keyword">new</span> DefaultClient();<font></font>
    <font></font>
    $handler = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Request $request</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$parcel, $client, $structure, $stored</span>) </span>{<font></font>
        $cached = <span class="hljs-keyword">yield</span> $parcel-&gt;synchronized(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">array</span> $value</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$client, $stored</span>) </span>{
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($value[<span class="hljs-string">'file_path'</span>]) || $value[<span class="hljs-string">'expires'</span>] &lt;= time()) {<font></font>
                $response = <span class="hljs-keyword">yield</span> $client-&gt;request(<span class="hljs-string">'https://api.telegram.org/bot'</span> . TOKEN  . <span class="hljs-string">'/getFile?'</span> . http_build_query([
                    <span class="hljs-string">'file_id'</span> =&gt; $stored[<span class="hljs-string">'result'</span>][<span class="hljs-string">'document'</span>][<span class="hljs-string">'file_id'</span>]<font></font>
                ]));<font></font>
                $json = json_decode(<span class="hljs-keyword">yield</span> $response-&gt;getBody(), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
                <font></font>
                $value = [<span class="hljs-string">'file_path'</span> =&gt; $json[<span class="hljs-string">'result'</span>][<span class="hljs-string">'file_path'</span>], <span class="hljs-string">'expires'</span> =&gt; time() + <span class="hljs-number">55</span> * <span class="hljs-number">60</span>];<font></font>
            }<font></font>
            <font></font>
            <span class="hljs-keyword">return</span> $value;<font></font>
        });<font></font>
        <font></font>
        $selectedFile = $structure[<span class="hljs-string">'files'</span>][array_rand($structure[<span class="hljs-string">'files'</span>])];<font></font>
        $LFH = base64_decode($selectedFile[<span class="hljs-string">'LFH'</span>]);<font></font>
        $CDFH = base64_decode($selectedFile[<span class="hljs-string">'CDFH'</span>]);<font></font>
<font></font>
        $fileLength = unpack(<span class="hljs-string">'Llen'</span>, substr($CDFH, <span class="hljs-number">24</span>, <span class="hljs-number">4</span>))[<span class="hljs-string">'len'</span>];<font></font>
        $fileStart = unpack(<span class="hljs-string">'Lpos'</span>, substr($CDFH, <span class="hljs-number">42</span>, <span class="hljs-number">4</span>))[<span class="hljs-string">'pos'</span>] + strlen($LFH);<font></font>
        $fileEnd = $fileStart + $fileLength;<font></font>
        <font></font>
        $request = (<span class="hljs-keyword">new</span> ArtaxRequest(<span class="hljs-string">'https://api.telegram.org/file/bot'</span> . TOKEN . <span class="hljs-string">'/'</span> . $cached[<span class="hljs-string">'file_path'</span>]))<font></font>
            -&gt;withHeader(<span class="hljs-string">'Range'</span>, <span class="hljs-string">"bytes={$fileStart}-{$fileEnd}"</span>);<font></font>
        $response = <span class="hljs-keyword">yield</span> $client-&gt;request($request);<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (!in_array($response-&gt;getStatus(), [<span class="hljs-number">200</span>, <span class="hljs-number">206</span>])) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response(Status::SERVICE_UNAVAILABLE, [<span class="hljs-string">'content-type'</span> =&gt; <span class="hljs-string">'text/plain'</span>], <span class="hljs-string">"Service Unavailable."</span>);<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response(Status::OK, [<span class="hljs-string">'content-type'</span> =&gt; <span class="hljs-string">'image/jpeg'</span>], $response-&gt;getBody());<font></font>
    };<font></font>
    <font></font>
    $server = <span class="hljs-keyword">new</span> HttpServer([Socket\listen(<span class="hljs-string">"0.0.0.0:10051"</span>)], <span class="hljs-keyword">new</span> CallableRequestHandler($handler), <span class="hljs-keyword">new</span> NullLogger);
    <span class="hljs-keyword">yield</span> $server-&gt;start();<font></font>
<font></font>
    Amp\Loop::onSignal(SIGINT, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> $watcherId</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$server</span>) </span>{<font></font>
        Amp\Loop::cancel($watcherId);<font></font>
        <span class="hljs-keyword">yield</span> $server-&gt;stop();<font></font>
    });<font></font>
});<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果として得られるもの：ドキュメントへのリンクを55分間保存するキャッシュができました。これにより、キャッシュの期限が切れたときに大量のリクエストを受け取った場合に、リンクを数回続けてリクエストしないことが保証されます。まあ、これはすべて、PHP-FPM（または、禁じられているPHP-CGI）を使用したreadfileよりも明らかに簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、amphpインスタンスプールを上げることができます-SharedMemoryParcelは、その名前で、キャッシュがプロセス/スレッド間を行き来することを示唆しています。まあ、または、この設計の信頼性について健全な懸念がある場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proxy_passとnginxを使用してください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、このアイデアは新しいものとはほど遠いものであり、ひどい年でもDownloadMasterを使用すると、アーカイブ全体をダウンロードせずにZipアーカイブから特定のファイルをダウンロードできるため、構造を個別に保存する必要はありませんが、いくつかのリクエストを節約できます。</font><font style="vertical-align: inherit;">たとえば、その場でユーザーにファイルをプロキシしたい場合、それはリクエストの速度に大きく影響します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜこれが便利なのでしょうか？</font><font style="vertical-align: inherit;">たとえば、数千万の小さなファイルがあり、それらをデータベースに直接保存したくない場合、inodeを保存するために、それらをアーカイブに保存して、単一のファイルを受け取るバイアスを知ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、リモートでファイルを保存する場合。</font><font style="vertical-align: inherit;">もちろん、20 mbの電報では移動できませんが、他の方法があります。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484504/index.html">10ドル未満で空気イオナイザーを作る</a></li>
<li><a href="../ja484506/index.html">私は写真家であり、自分自身を作業ツールにします</a></li>
<li><a href="../ja484512/index.html">TOP 25の最大のICO：現在の問題は何ですか？</a></li>
<li><a href="../ja484514/index.html">Reactアプリケーションのユニバーサルルーティング</a></li>
<li><a href="../ja484518/index.html">PHPを使用してDVRIP経由でカメラからビデオを取得します</a></li>
<li><a href="../ja484522/index.html">DEFCON会議27.警察をハッキングする。パート2</a></li>
<li><a href="../ja484526/index.html">Androidで実行するSDL2プロジェクトの準備</a></li>
<li><a href="../ja484528/index.html">趣味のプロジェクトをk8sに転送した方法</a></li>
<li><a href="../ja484530/index.html">プラズマ処理/高分子材料の変更のためのCNCマシン</a></li>
<li><a href="../ja484532/index.html">グレイコードの幾何学的意味について</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>