<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß ü§πüèº üõÄüèª Testing on prod: Canary Deployment üóª ‚ú°Ô∏è ü§üüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The canary is a small bird that constantly sings. These birds are sensitive to methane and carbon monoxide. Even from a small concentration of excess ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Testing on prod: Canary Deployment</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/493026/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The canary is a small bird that constantly sings. These birds are sensitive to methane and carbon monoxide. Even from a small concentration of excess gases in the air, they lose consciousness or die. Gold miners and miners took birds for prey: while the canaries sing, you can work, if you shut up, there is gas in the mine and it's time to leave. Miners sacrificed a small bird to get out of the mines alive.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/az/jp/raazjpla5rbhpd-u0nvti84mezg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar practice has found itself in IT. </font><font style="vertical-align: inherit;">For example, in the standard task of deploying a new version of a service or application to production with testing before that. </font><font style="vertical-align: inherit;">The test environment can be too expensive, automated tests do not cover everything that we would like, and it‚Äôs risky to test and sacrifice quality. </font><font style="vertical-align: inherit;">Just in such cases, the Canary Deployment approach helps, when a bit of real production traffic is launched on a new version. </font><font style="vertical-align: inherit;">The approach helps to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">safely</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> test the new version </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for production,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sacrificing small things for a big purpose. </font><font style="vertical-align: inherit;">In more detail, how the approach works, what is useful and how to implement it, will tell </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andrey Markelov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andrey_V_Markelov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), using an example of implementation at Infobip.</font></font><a name="habracut"></a><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andrey Markelov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a leading software engineer at Infobip, has been developing Java applications in finance and telecommunications for 11 years. </font><font style="vertical-align: inherit;">He develops Open Source products, actively participates in the Atlassian Community and writes plugins for Atlassian products. </font><font style="vertical-align: inherit;">Evangelist Prometheus, Docker, and Redis.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/GWH13lIvy0U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About Infobip</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a global telecommunications platform that allows banks, retailers, online stores and transport companies to send messages to their customers using SMS, push, letters and voice messages. </font><font style="vertical-align: inherit;">In such a business, stability and reliability are important so that customers receive messages on time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infobip IT Infrastructure in numbers:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15 data centers around the world;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">500 unique services in operation;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2500 instances of services, which is much more than teams;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.5 TB of monthly traffic;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.5 billion phone numbers;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The business is growing, and with it the number of releases. </font><font style="vertical-align: inherit;">We carry out </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">60 releases a day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because customers want more features and capabilities. </font><font style="vertical-align: inherit;">But this is difficult - there are many services, but few teams. </font><font style="vertical-align: inherit;">You have to quickly write code that should work in production without errors.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Releases</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A typical release with us goes like this. For example, there are services A, B, C, D and E, each of them is developed by a separate team. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ph/ek/kz/phekkz24s6lsqj50yok6rohuf9y.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At some point, service team A decides to deploy a new version, but service teams B, C, D, and E are unaware of this. There are two options for how service team A arrives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Will carry out an </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incremental release:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> first it will replace one version, and then the second. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/se/8y/8o/se8y8oghwzgmmu-j8vhlgzw_izo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is a second option: the team </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will find additional capacities and machines</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , deploy a new version, and then switch the router, and the version will start working on production.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gl/et/pa/gletpaydxiokxgkbtbnc7rgbadg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In any case, there will almost always be problems after the deployment, even if the version is tested. You can test it with your hands, it can be automated, you can not test it - problems will arise in any case. The easiest and most correct way to solve them is to roll back to the working version. Only then can you deal with the damage, with the causes and correct them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So what do we want? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We don‚Äôt need problems. If customers find them faster than us, it will hit our reputation. Therefore, we must </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">find problems faster than customers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . By being proactive, we minimize damage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, we want to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accelerate the deployment</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that this happens quickly, easily, by itself and without stress from the team. </font><font style="vertical-align: inherit;">Engineers, DevOps engineers and programmers must be protected - the release of the new version is stressful. </font><font style="vertical-align: inherit;">A team is not a consumable; we strive to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rationally use human resources</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment Issues</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client traffic is unpredictable</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is impossible to predict when client traffic will be minimal. We don‚Äôt know where and when clients will start their campaigns - maybe tonight in India, and tomorrow in Hong Kong. Given the large time difference, a deployment even at 2 a.m. does not guarantee that customers will not suffer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provider issues</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Messengers and providers are our partners. Sometimes they have crashes that cause errors during the deployment of new versions. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Distributed teams</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The teams that develop the client side and the backend are in different time zones. Because of this, they often cannot agree among themselves. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data centers cannot be repeated on stage</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">There are 200 racks in one data center - to repeat this in the sandbox will not even work out approximately. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Downtimes are </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not allowed! </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have an acceptable level of accessibility (Error Budget) when we work 99.99% of the time, for example, and the remaining percentages are ‚Äúthe right to make mistakes‚Äù. </font><font style="vertical-align: inherit;">It is impossible to achieve 100% reliability, but it is important to constantly monitor downtime and downtime.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classic solutions</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write code without bugs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When I was a young developer, managers approached me with a request to release without bugs, but this is not always possible. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write tests</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tests work, but sometimes it‚Äôs not at all what the business wants. Making money is not a test task. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test on stage</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Over the 3.5 years of my work at Infobip, I have never seen a stage state at least partially coincide with production. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/lm/iq/wjlmiqi77nfuagxirzj4qiq9h1m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We even tried to develop this idea: first we had a stage, then pre-production, and then pre-production pre-production. But this did not help either - they did not even coincide in terms of power. With stage we can guarantee basic functionality, but we don‚Äôt know how it will work under loads. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The release is made by the developer.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is good practice: even if someone changes the name of a comment, it immediately adds it to production. </font><font style="vertical-align: inherit;">This helps to develop responsibility and not to forget about the changes made. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are additional difficulties too. </font><font style="vertical-align: inherit;">For a developer, this is stressful - spend a lot of time to manually check everything. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agreed Releases</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This option usually offers management: "Let's agree that you will test and add new versions every day." </font><font style="vertical-align: inherit;">This does not work: there is always a team that waits for everyone else or vice versa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Smoke tests</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another way to solve our deployment problems. </font><font style="vertical-align: inherit;">Let's see how smoke tests work in the previous example, when team A wants to deploy a new version. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, the team deploys one instance to production. </font><font style="vertical-align: inherit;">Messages to the instance from mocks </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simulate real traffic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so that it matches normal daily traffic. </font><font style="vertical-align: inherit;">If all is well, the team switches the new version to user traffic. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/65/ao/rc/65aorck9dehe9k4rnnobtkx2igo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second option is to deploy </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with additional iron. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The team tests it for production, then switches it, and everything works. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/me/p8/sg/mep8sg0uhoxucwncmhafs_dnusq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disadvantages of smoke tests:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests cannot be trusted. </font><font style="vertical-align: inherit;">Where to get the same traffic as for production? </font><font style="vertical-align: inherit;">You can use yesterday or a week ago, but it does not always coincide with the current one.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It‚Äôs hard to maintain. </font><font style="vertical-align: inherit;">You will have to support test accounts, constantly reset them before each deployment, when active records are sent to the repository. </font><font style="vertical-align: inherit;">This is harder than writing a test in your sandbox.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only bonus here is that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can check the performance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canary releases</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the flaws of smoke tests, we started using canary releases. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A practice similar to the way miners used canaries to indicate gas levels found themselves in IT. </font><font style="vertical-align: inherit;">We are launching a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit of real production traffic to the new version</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , while trying to meet the Service Level Agreement (SLA). </font><font style="vertical-align: inherit;">SLA is our ‚Äúright to make mistakes‚Äù, which we can use once a year (or for some other period of time). </font><font style="vertical-align: inherit;">If all goes well, add more traffic. </font><font style="vertical-align: inherit;">If not, we will return the previous versions.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/x6/tx/pxx6txbpj7kz9cl0dm_wukdinn8.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation and nuances</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How did we implement canary releases? For example, a group of customers sends messages through our service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/wn/wy/njwnwymczf3defl0hsyypt9cdpo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The deployment goes like this: remove one node from under the balancer (1), change the version (2) and separately start up some traffic (3). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zj/rd/n2/zjrdn2pl3drnezhtzdcjkx25_m4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, everyone in the group will be happy, even if one user is not happy. If all is well - change all versions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/k6/bk/ssk6bkoadknkyzmus0qplv2z1qk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will show schematically how it looks for microservices in most cases. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is Service Discovery and two more services: S1N1 and S2. The first service (S1N1) notifies Service Discovery when it starts, and Service Discovery remembers it. The second service with two nodes (S2N1 and S2N2) also notifies Service Discovery at startup.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/k-/pj/auk-pj30bzjjhw4twmckibrvvxm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second service for the first works as a server. </font><font style="vertical-align: inherit;">The first one requests information about its servers from Service Discovery, and when it receives it, it searches for and checks them (‚Äúhealth check‚Äù). </font><font style="vertical-align: inherit;">When he checks, he will send them messages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When someone wants to deploy a new version of the second service, he tells Service Discovery that the second node will be a canary node: less traffic will be sent to it, because it will be deployed now. </font><font style="vertical-align: inherit;">We remove the canary node from under the balancer and the first service does not send traffic to it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/8a/ut/p08autr3lnwhbsdl8bma7h5hhee.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We change the version and Service Discovery knows that the second node is now canary - you can give it less load (5%). </font><font style="vertical-align: inherit;">If all is well, change the version, return the load and work on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement all this, we need:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">balancing;</font></font></strong></li>
<li><strong></strong>,    ,    ,      ;</li>
<li><strong> </strong>,  ,        ;</li>
<li><strong></strong> ‚Äî    (deployment pipeline).</li>
</ul><br>
<img src="https://habrastorage.org/webt/wp/a2/cs/wpa2csn_tnm_2qaxt2kx4kzthd4.png"><br>
<br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the first thing we should think about. </font><font style="vertical-align: inherit;">There are two balancing strategies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simplest option is when </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one node is always canary</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This node always gets less traffic and we start deploying from it. </font><font style="vertical-align: inherit;">In case of problems, we will compare her work to the deployment and during it. </font><font style="vertical-align: inherit;">For example, if there are 2 times more errors, then the damage has increased 2 times. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Canary node is set during the deployment process</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">When the deployment ends and we remove the status of the canary node from it, the traffic balance will be restored. </font><font style="vertical-align: inherit;">With fewer cars, we get an honest distribution.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoring</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cornerstone of canary releases. </font><font style="vertical-align: inherit;">We must understand exactly why we are doing this and what metrics we want to collect. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examples of metrics that we collect from our services.</font></font><br>
<br>
<ul>
<li><strong> </strong>,    .    ,     .  ,   .</li>
<li><strong>  </strong> (latency).    ,      .</li>
<li><strong> </strong> (throughput).</li>
<li><strong>    </strong>.</li>
<li><strong><strong>  95%  .</strong></strong></li>
<li><strong>-: </strong>         .         ,  ,   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examples of metrics in most popular monitoring systems. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Counter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is some increasing value, for example, the number of errors. It‚Äôs easy to interpolate this metric and study the chart: yesterday there were 2 errors, and today 500, then something went wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The number of errors per minute or per second is the most important indicator that can be calculated using Counter. These data give a clear idea of ‚Äã‚Äãthe system's operation at a distance. Let's look at an example of a graph of the number of errors per second for two versions of a production system. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qt/a5/dy/qta5dyzzu_zimkl0h3zja1qqk3u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were few errors in the first version; audit may not have worked. In the second version, everything is much worse. We can say for sure that there are problems, so we must roll back this version. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gauge.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metrics are similar to Counter, but we record values ‚Äã‚Äãthat can either increase or decrease. </font><font style="vertical-align: inherit;">For example, query execution time or queue size. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The graph shows an example of response time (latency). </font><font style="vertical-align: inherit;">The graph shows that the versions are similar, you can work with them. </font><font style="vertical-align: inherit;">But if you look closely, it is noticeable how the quantity changes. </font><font style="vertical-align: inherit;">If the execution time of requests increases when users are added, then it is immediately clear that there are problems - this was not the case before. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zc/q-/4p/zcq-4pu10dhl1v3lbqay8ymr4s8.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the most important indicators for business is percentiles. </font><font style="vertical-align: inherit;">The metric shows that in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">95% of cases,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> our system works the way we want. </font><font style="vertical-align: inherit;">We can accept it if there is a problem somewhere, because we understand the general tendency of how good or bad everything is.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tools</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ELK Stack</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can implement canary using Elasticsearch - we write errors into it when events occur. </font><font style="vertical-align: inherit;">Simply call the API, you can get errors at any time, and compare it with previous segments: </font></font><code>GET /applg/_cunt?q=level:errr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He showed himself well in Infobip. </font><font style="vertical-align: inherit;">It allows you to implement multidimensional metrics because labels are used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can use </font></font><code>level</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>instance</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, to combine them in a single system. </font><font style="vertical-align: inherit;">Using </font></font><code>offset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it, you can see, for example, the value of a week ago with just one command </font></font><code>GET /api/v1/query?query={query}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where </font></font><code>{query}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">rate(logback_appender_total{ <font></font>
    level=<span class="hljs-string">"error"</span>,  <font></font>
    instance=~<span class="hljs-string">"<span class="hljs-variable">$instance</span>"</span> 
}[5m] offset <span class="hljs-variable">$offset_value</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version Analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several versioning strategies. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See metrics of only canary nodes. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the simplest options: deployed a new version and study only the work. </font><font style="vertical-align: inherit;">But if the engineer at this time begins to study the logs, constantly nervously reloading the pages, then this solution is no different from the rest. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A canary node is compared to any other node</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is a comparison with other instances that run on full traffic. </font><font style="vertical-align: inherit;">For example, if with small traffic things are worse, or not better than on real instances, then something is wrong. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A canary node is compared to itself in the past. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The nodes allocated for canary can be compared with historical data. </font><font style="vertical-align: inherit;">For example, if a week ago everything was fine, then we can focus on this data in order to understand the current situation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We want to free engineers from manual comparisons, so it‚Äôs important to implement automation. </font><font style="vertical-align: inherit;">The deployment pipeline process usually looks like this:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we start;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remove the node from under the balancer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set the canary node;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turn on the balancer already with a limited amount of traffic;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compare.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/v_/ei/ae/v_eiaekt8vkmytoyc1g4lymhroq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, we implement an </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">automatic comparison</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">How it can look and why it is better than checking after the deployment, we will consider the example from Jenkins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the pipeline to Groovy.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-keyword">while</span> (System.currentTimeMillis() &lt; endCanaryTs) {<font></font>
    def isOk = compare(srv, canary, time, base, offset, metrics)<font></font>
    <span class="hljs-keyword">if</span> (isOk) {<font></font>
        sleep DEFAULT SLEEP<font></font>
    }   <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Canary failed, need to revert"</span>  
        <span class="hljs-built_in">return</span> <span class="hljs-literal">false</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here in the cycle we set that we will compare the new node for an hour. If the canary process has not finished the process yet, we call the function. She reports that all is well or not: </font></font><code>def isOk = compare(srv, canary, time, base, offset, metrics)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If all is well - </font></font><code>sleep DEFAULT SLEEP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for example, for a second, and continue. If not, we exit - the deployment failed. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description of the metric.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's see how a function might look </font></font><code>compare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the example of DSL.</font></font><br>
<br>
<pre><code class="bash hljs">metric(
    <span class="hljs-string">'errorCounts'</span>,
    <span class="hljs-string">'rate(errorCounts{node=~"$canaryInst"}[5m] offset $offset)'</span>,<font></font>
    {   baseValue, canaryValue -&gt;<font></font>
        <span class="hljs-keyword">if</span> (canaryValue &gt; baseValue * 1.3) <span class="hljs-built_in">return</span> <span class="hljs-literal">false</span> 
        <span class="hljs-built_in">return</span> <span class="hljs-literal">true</span><font></font>
    }<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we compare the number of errors and want to know the number of errors per second in the last 5 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have two values: base and canary nodes. The value of the canary node is the current one. Basic - </font></font><code>baseValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the value of any other non-canary node. We compare the values ‚Äã‚Äãwith each other according to the formula, which we set based on our experience and observations. If the value is </font></font><code>canaryValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bad, then the deployment failed, and we roll back. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is all this necessary? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Man cannot check hundreds and thousands of metrics</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especially to do it quickly. </font><font style="vertical-align: inherit;">An automatic comparison helps check all metrics and quickly alerts you to problems. </font><font style="vertical-align: inherit;">The notification time is critical: if something happened in the last 2 seconds, then the damage will not be as big as if it happened 15 minutes ago. </font><font style="vertical-align: inherit;">Until someone notices a problem, writes support, and we can lose customers to roll back support. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the process went well and everything is fine, we will deploy all other nodes automatically. </font><font style="vertical-align: inherit;">Engineers are not doing anything at this time. </font><font style="vertical-align: inherit;">Only when they run canary do they decide which metrics to take, how long to do the comparison, which strategy to use. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/en/8w/ym/en8wymdyqy-zm4vqx53zitfin7y.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there are problems, we automatically roll back the canary node, work on previous versions and fix the errors that we found. </font><font style="vertical-align: inherit;">By metrics they are easy to find and see the damage from the new version.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obstacles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement this, of course, is not easy. </font><font style="vertical-align: inherit;">First of all, we need a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">common monitoring system</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Engineers have their own metrics, support and analysts have different ones, and business has third. </font><font style="vertical-align: inherit;">A common system is a common language spoken by business and development. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary to check in practice the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stability of metrics. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verification helps to understand </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what is the minimum set of metrics needed to ensure quality</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to achieve this? </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use canary service not at the time of deployment</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We add a certain service on the old version, which at any moment of time will be able to take any allocated node, reduce traffic without deployment. </font><font style="vertical-align: inherit;">After we compare: we study errors and look for that line when we achieve quality.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y3/8_/uz/y38_uzwtlikvs2wui8kvsnmqno8.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What benefit have we got from canary releases</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minimized the percentage of damage from bugs.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most deployment errors occur due to inconsistency in some data or priority. Such errors have become much smaller, because we can solve the problem in the first seconds. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized the work of teams.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beginners have a ‚Äúright to make a mistake‚Äù: they can deploy to production without fear of mistakes, an additional initiative appears, an incentive to work. If they break something, then it will not be critical, and the wrong person will not be fired. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automated deployment</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is no longer a manual process, as before, but a real automated one. But it takes longer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highlighted important metrics</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The whole company, starting from business and engineers, understands what is really important in our product, which metrics, for example, the outflow and influx of users. We control the process: we test metrics, introduce new ones, see how the old ones work to build a system that will make money more productive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have many cool practices and systems that help us. Despite this, we strive to be professionals and do our job efficiently, regardless of whether we have a system that will help us or not.</font></font><br>
<br>
<blockquote>    ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   TechLead Conf</a>.            ,     , ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   </a>.<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">TechLead Conf</a>  8  9  .      ,              ,      ‚Äî  ,   .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493012/index.html">Air, relays, cable out the window: how not to run into a monopolist provider in a business center</a></li>
<li><a href="../en493014/index.html">Interview with Vyacheslav Utochkin, Director of Game Development Educational Programs at the Higher School of Economics, Higher School of Economics, Higher School of Economics; 20 Questions about Game Dev</a></li>
<li><a href="../en493016/index.html">The heading "Read articles for you." January - February 2020</a></li>
<li><a href="../en493018/index.html">The developer appreciated the complexity of modern browsers</a></li>
<li><a href="../en493024/index.html">DUMP 2020 in Yekaterinburg is postponed to November 20, 2020</a></li>
<li><a href="../en493032/index.html">5. Check Point Maestro Frequently Asked Questions (FAQ)</a></li>
<li><a href="../en493034/index.html">COVID-19: predicting the number of patients with coronavirus</a></li>
<li><a href="../en493036/index.html">I twist and twist, I want to confuse: manipulations with two-layer graphene</a></li>
<li><a href="../en493038/index.html">About corporate culture for distributed teams and not only</a></li>
<li><a href="../en493040/index.html">Scrollbar that failed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>