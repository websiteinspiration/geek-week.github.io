<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📷 🕎 👵🏻 Google Cloud缺少DNS Cloud支持故事 👩🏼‍🎤 👩‍👧‍👧 🔑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="来自Google Blog编辑器：您是否想知道Google Cloud技术解决方案（TSE）工程师如何处理您的技术支持电话？ TSE技术支持工程师的职责是检测并解决用户发现的问题的根源。其中一些问题非常简单，但是有时您会遇到上诉，需要立即引起数位工程师的注意。在本文中，TSE的一名员工将向我们介绍他...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Google Cloud缺少DNS Cloud支持故事</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自Google Blog编辑器：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您是否想知道Google Cloud技术解决方案（TSE）工程师如何处理您的技术支持电话？ TSE技术支持工程师的职责是检测并解决用户发现的问题的根源。其中一些问题非常简单，但是有时您会遇到上诉，需要立即引起数位工程师的注意。在本文中，TSE的一名员工将向我们介绍他最近的实践中的一个非常棘手的问题- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">丢失DNS数据包的情况</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在这个故事的过程中，我们将看到工程师如何设法解决这种情况，以及他们在消除错误的过程中学到了什么新知识。我们希望这个故事不仅可以告诉您一个根深蒂固的错误，还可以帮助您理解提交支持Google Cloud的请求时发生的过程。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
故障排除是一门科学，也是一门艺术。一切始于建立有关系统非标准行为原因的假设，然后再测试其强度。但是，在提出假设之前，我们必须清楚地识别并准确地提出问题。如果这个问题听起来太含糊，那么您必须适当地分析所有内容；这是故障排除的“艺术”。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Google Cloud的上下文中，由于Google Cloud努力保证其用户的隐私，因此此类过程有时会很复杂。</font><font style="vertical-align: inherit;">因此，TSE工程师无权编辑系统，也无法像用户一样广泛地查看配置。</font><font style="vertical-align: inherit;">因此，为了检验我们的任何假设，我们（工程师）无法快速修改系统。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一些用户认为，我们将像汽车服务中的机制一样对所有问题进行修复，并仅向我们发送虚拟机的ID，而实际上，该过程以对话格式进行：收集信息，生成和确认（或驳斥）假设，并最终解决问题是建立在与客户的沟通上的。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正在考虑的问题</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今天，我们的故事结局不错。</font><font style="vertical-align: inherit;">成功解决提出的案例的原因之一是对该问题的非常详细和准确的描述。</font><font style="vertical-align: inherit;">在下面，您可以看到第一张票证的副本（已编辑，以便隐藏机密信息）：</font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此消息为我们提供了许多有用的信息：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定的虚拟机</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指出了问题-DNS无法正常工作</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指出问题在何处显现-VM和容器</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指出了用户识别问题所采取的步骤。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该呼吁被注册为“ P1：关键影响-生产中无法使用的服务”，这意味着根据“跟随太阳”计划对情况进行24/7的持续监控（该链接可以更详细地了解</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户呼叫</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">优先级</font></a><font style="vertical-align: inherit;">），并由一个技术支持团队进行传输在每个时区移动 </font><font style="vertical-align: inherit;">实际上，当问题到达我们在苏黎世的团队时，她设法绕过了地球。</font><font style="vertical-align: inherit;">此时，用户已采取措施以减少后果，但是，由于仍未找到主要原因，因此他担心重复出现这种情况。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到苏黎世机票时，我们已经掌握了以下信息：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容 </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容 </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论 </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该命令编译的</font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcap文件</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有了这些数据，我们就可以开始“调查”和故障排除阶段了。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们的第一步</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们检查了元数据服务器的日志和状态，并确保其正常运行。</font><font style="vertical-align: inherit;">元数据服务器以IP地址169.254.169.254进行响应，并负责控制域名。</font><font style="vertical-align: inherit;">我们还仔细检查了防火墙是否可以在VM上正常工作，并且不会阻止数据包。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个奇怪的问题：nmap测试驳斥了我们有关UDP数据包丢失的主要假设，因此我们在精神上推论出了更多选择和检查方法：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据包是否有选择地消失？</font><font style="vertical-align: inherit;">=&gt;检查iptables规则</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否太小</font><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">=&gt;检查输出</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题仅影响UDP数据包还是TCP？</font><font style="vertical-align: inherit;">=&gt;开走</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否返回生成的挖掘数据包？</font><font style="vertical-align: inherit;">=&gt;开走</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns是否正常工作？</font><font style="vertical-align: inherit;">=&gt;开车离开</font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以验证双向数据包传输</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，我们决定给用户打电话以进行实时故障排除。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在通话过程中，我们设法验证了几件事：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">经过多次检查，我们从原因列表中排除了iptables规则。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们检查网络接口和路由表，并仔细检查MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们发现</font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（TCP）正常运行，但</font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（UDP）无效</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经</font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行，而它的工作原理</font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们发现，被返回的UDP数据包</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们跑</font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，看看如何正确地掏电话</font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但是，二是超时中断</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，这种转变即将结束，我们被迫将问题转移到下一个时区。但是，这种呼吁引起了我们团队的兴趣，一位同事建议使用scrapy的Python模块创建源DNS数据包。</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该片段创建DNS数据包，并将请求发送到元数据服务器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用户运行该代码，返回DNS响应，然后应用程序将其接收，这将在网络级别确认是否存在问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在下一次“环游世界”之后，上诉将返回给我们的团队，我将其完全翻译成我自己，相信如果上诉不再从一个地方到另一个地方转圈，将会为用户带来更多便利。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，用户请同意提供系统映像的快照。这真是个好消息：自己测试系统的能力大大加快了故障排除的速度，因为您不再需要让用户运行命令，向我发送结果并对其进行分析，我就可以自己做一切！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同事们开始有点羡慕我。</font><font style="vertical-align: inherit;">午餐时，我们讨论了上诉，但是没人知道发生了什么。</font><font style="vertical-align: inherit;">幸运的是，用户本人已经采取了缓解措施，因此并不着急，因此我们有时间来解决问题。</font><font style="vertical-align: inherit;">并且由于我们具有图像，因此我们可以进行任何我们感兴趣的测试。</font><font style="vertical-align: inherit;">精细！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回去一步</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在系统工程师的面试中，最受欢迎的问题之一是：“当您ping </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.google.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时会发生什么</font><font style="vertical-align: inherit;">？” </font><font style="vertical-align: inherit;">问题是豪华的，因为需要从外壳到用户空间，再到系统核心，再到网络都描述候选人。</font><font style="vertical-align: inherit;">我微笑：有时候面试问题在现实生活中也很有用…… </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我决定将eychar问题应用于当前问题。</font><font style="vertical-align: inherit;">粗略地说，当您尝试确定DNS名称时，会发生以下情况：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应用程序调用系统库，例如libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns检查系统配置，它应该使用哪个DNS服务器（在该图中为169.254.169.254，元数据服务器）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns使用系统调用来创建UDP套接字（SOKET_DGRAM）并在两个方向上通过DNS请求发送UDP数据包</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用sysctl接口，您可以配置内核级UDP堆栈</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内核与硬件交互以通过网络接口通过网络传输数据包</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统管理程序在数据包与元数据服务器联系时将其捕获并传递给元数据服务器</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元数据服务器通过其巫术确定DNS名称，并以相同的方式返回答案</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我提醒您我们已经设法考虑了哪些假设：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设：库损坏</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试1：在系统中运行strace，检查dig是否导致正确的系统调用</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：正确的系统调用被调用</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试2：通过反复检查来确定是否可以绕过系统库确定名称</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：我们可以</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试3：在libdns软件包和md5sum库文件上运行rpm –V</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：库代码与工作操作系统中的代码完全相同</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试4：在没有这种行为的情况下，将用户的根系统的映像挂载到VM上，运行chroot，查看DNS是否工作</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：DNS正常工作</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据测试得出的结论：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题不在库中</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设：DNS设置错误</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试1：运行dig后，检查tcpdump并查看DNS数据包是否正确发送和返回</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：数据包正确传输</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试2：重新检查服务器，</font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：一切正确</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于测试的结论：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题不在DNS配置</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设中：内核损坏</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试：安装新内核，验证签名，重新启动</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：类似行为</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于测试的结论：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内核未损坏</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设：用户网络（或虚拟机管理程序的网络接口）的行为不正确</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试1：检查防火墙设置</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：防火墙在主机和GCP上都传递DNS数据包</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试2：拦截流量并跟踪DNS查询的传输和返回的正确性</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：tcpdump确认主机已收到返回数据包</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于测试的结论：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题不在网络中</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设：元数据服务器不起作用</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试1：检查元数据服务器日志中是否存在异常</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：日志中没有异常</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试2：通过绕过元数据服务器 </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：即使不使用元数据服务器，也会违反权限</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于测试的结论：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题不在元数据服务器中</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">底线：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们测试了除</font><b><font style="vertical-align: inherit;">运行时设置</font></b><font style="vertical-align: inherit;">以外的所有子系统</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">深入内核运行时设置</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要配置内核运行时，可以使用命令行选项（grub）或sysctl接口。</font><font style="vertical-align: inherit;">我看了一下，</font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只想到，我发现了一些自定义设置。</font><font style="vertical-align: inherit;">感觉好像我已经抓住了某些东西，我取消了所有非网络或非tcp设置，而保留了山脉设置</font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">然后我转到了VM拥有主机权限的地方，并开始一个又一个地应用虚拟机损坏的虚拟机设置，直到遇到犯罪为止：</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个破坏DNS的配置！我找到了犯罪手段。但是为什么会这样呢？我仍然需要动力。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设置DNS数据包缓冲区的基本大小通过进行</font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。典型值在200KiB范围内变化，但是，如果服务器收到大量DNS数据包，则可以增加缓冲区的大小。例如，如果在新程序包到达时缓冲区已满，则由于应用程序处理速度不够快，您将开始丢失数据包。我们的客户端正确地增加了缓冲区大小，因为他担心数据丢失，因为他使用该应用程序通过DNS数据包收集度量。他设置的值是最大可能的值：2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1（如果您设置2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则内核将返回“ INVALID ARGUMENT”）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
突然，我意识到了为什么nmap和scapy可以正常工作：他们使用了原始套接字！原始套接字与常规套接字不同：它们绕过iptables工作，并且没有缓冲！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，为什么“缓冲区太大”会引起问题？它显然不能按预期工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此时，我可以在多个内核和多个发行版上重现该问题。该问题已在3.x内核中显现出来，现在也已在5.x内核中显现出来。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
确实，在启动时</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS已停止工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我开始通过一种简单的二进制搜索算法搜索工作值，发现系统可以使用2147481343，但是这个数字对我来说毫无意义。我邀请客户尝试使用此号码，他回答说该系统可与google.com一起使用，但在其他域上仍然出现错误，因此我继续进行调查。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我安装了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是我之前应该使用的工具：它显示了软件包在内核中的确切位置。该职能有罪</font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我下载了内核源代码，并添加了一些</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来跟踪软件包的具体位置。我很快找到了合适的条件</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后只是盯着他看了一会儿，因为那时所有的一切最终都融为一体：2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1，一个毫无意义的数字，一个闲置的域……这是一段代码</font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意：</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 具有类型int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 类型为u16（无符号十六位整数），并存储数据包大小</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是int类型，并存储缓冲区的大小，根据定义，该缓冲区的大小等于 </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当</font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接近2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31时</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，对数据包大小求和可能会导致</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数溢出</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">并且由于它是一个int值，因此它的值变为负数，因此当该条件为false时该条件变为true（有关更多信息，请</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参阅参考资料</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可通过以下简单方法纠正错误：将强制转换为</font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我应用了补丁程序并重新启动了系统，然后DNS重新开始工作。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">胜利的味道</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将调查结果转发给客户端，并发送了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内核补丁。</font><font style="vertical-align: inherit;">我很满意：每个难题都融为一体，我可以准确地解释为什么我们观察到我们观察到的东西，最重要的是，我们能够通过共同努力找到解决问题的方法！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值得一提的是，事实证明这种情况很少见，而且幸运的是，这种复杂的电话很少从我们的用户那里收到。</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503096/index.html">管理者为什么要工人回收？</a></li>
<li><a href="../zh-CN503100/index.html">互联网负责人</a></li>
<li><a href="../zh-CN503106/index.html">非标准发现文摘：掠食性植物的家谱，推特上的真菌和鸟粪中的笑气</a></li>
<li><a href="../zh-CN503108/index.html">彩虹的八种颜色：关于数学的颜色</a></li>
<li><a href="../zh-CN503110/index.html">数字化流行：冠状病毒与CoViper</a></li>
<li><a href="../zh-CN503118/index.html">David Yang-关于非侵入性，危机和焦土</a></li>
<li><a href="../zh-CN503126/index.html">Likbez有关VPS：如果您是Win用户，如何配置远程桌面</a></li>
<li><a href="../zh-CN503128/index.html">如何将ColorPicker嵌入JavaScript甘特图中以更改任务的颜色</a></li>
<li><a href="../zh-CN503132/index.html">带有Apache Arrow的Python高速Apache Parquet</a></li>
<li><a href="../zh-CN503134/index.html">管理=团队+产品。我们揭示了今年的公式：DUMP 2020对人和人最有用</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>