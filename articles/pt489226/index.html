<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåå üåâ üë®üèæ‚Äçüé§ M√©todos para otimizar consultas LINQ em C # .NET üêâ üç¶ üíé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdu√ß√£o
 No presente artigo , discutimos algumas t√©cnicas de otimiza√ß√£o LINQ consultas . 
 Aqui est√£o mais algumas abordagens de otimiza√ß√£o de c√≥di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>M√©todos para otimizar consultas LINQ em C # .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489226/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presente artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , discutimos algumas t√©cnicas de otimiza√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQ consultas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√£o mais algumas abordagens de otimiza√ß√£o de c√≥digo relacionadas a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabe-se que o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Consulta Integrada √† Linguagem) √© uma linguagem simples e conveniente para consultar uma fonte de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQ to SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma tecnologia de acesso a dados em um DBMS. Essa √© uma ferramenta poderosa para trabalhar com dados, onde as consultas s√£o constru√≠das por meio de uma linguagem declarativa, que ser√£o convertidas em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas SQL pela</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plataforma e enviadas ao servidor de banco de dados para execu√ß√£o. No nosso caso, por DBMS queremos dizer o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><b><font style="vertical-align: inherit;">s√£o</font></b><font style="vertical-align: inherit;"> convertidas em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gravadas de maneira ideal </font><font style="vertical-align: inherit;">que um DBA experiente poderia escrever com todas as nuances da otimiza√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conex√µes ideais ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e filtragem de resultados ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ONDE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muitas nuances no uso de compostos e condi√ß√µes de grupo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muitas varia√ß√µes na substitui√ß√£o das condi√ß√µes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXISTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOT IN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , &lt;&gt; por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXISTS</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cache intermedi√°rio de resultados por meio de tabelas tempor√°rias, CTE, vari√°veis ‚Äã‚Äãde tabela</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando uma cl√°usula ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OPTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) com instru√ß√µes e dicas de tabela </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WITH</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (...)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o uso de visualiza√ß√µes indexadas, como um dos meios para se livrar de leituras redundantes de dados em amostras</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os principais gargalos de desempenho das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resultantes </font><font style="vertical-align: inherit;">ao compilar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consolida√ß√£o de todo o mecanismo de sele√ß√£o de dados em uma solicita√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duplica√ß√£o de blocos de c√≥digo id√™nticos, o que leva a v√°rias leituras extras de dados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grupos de condi√ß√µes multicomponentes (l√≥gicas "e" e "ou") - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , combinando-se em condi√ß√µes dif√≠ceis, levam ao fato de que o otimizador, com √≠ndices n√£o clusterizados adequados, pelos campos necess√°rios, eventualmente come√ßa a varrer pelo √≠ndice de cluster ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INDEX SCAN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) por grupo de condi√ß√µes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o aninhamento profundo de subconsultas torna muito problem√°tico analisar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instru√ß√µes SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e analisar planos de consulta de desenvolvedores e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBAs</font></font></b></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todos de otimiza√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora passamos diretamente para os m√©todos de otimiza√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Indexa√ß√£o adicional</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â melhor considerar filtros nas principais tabelas de amostragem, pois muitas vezes toda a consulta √© criada em torno de uma ou duas tabelas principais (aplicativos-pessoas-opera√ß√µes) e com um conjunto de condi√ß√µes padr√£o (IsClosed, Canceled, Enabled, Status). √â importante que as amostras identificadas criem os √≠ndices correspondentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa solu√ß√£o faz sentido ao escolher um desses campos que limita significativamente o conjunto retornado √† consulta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, temos 500.000 aplicativos. No entanto, existem apenas 2.000 entradas ativas. Em seguida, um √≠ndice selecionado corretamente nos salvar√° do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INDEX SCAN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em uma tabela grande e permitir√° selecionar rapidamente os dados por meio de um √≠ndice n√£o clusterizado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A falta de √≠ndices tamb√©m pode ser detectada atrav√©s de prompts para analisar planos de consulta ou coletar estat√≠sticas para visualiza√ß√µes do sistema</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_db_missing_index_groups</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_db_missing_index_group_stats</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_db_missing_index_details</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os dados de exibi√ß√£o cont√™m informa√ß√µes sobre √≠ndices ausentes, com exce√ß√£o dos √≠ndices espaciais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, √≠ndices e cache geralmente s√£o m√©todos para lidar com os efeitos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mal gravadas </font><font style="vertical-align: inherit;">e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a dura pr√°tica da vida mostra para os neg√≥cios, muitas vezes √© importante implementar os recursos de neg√≥cios at√© uma certa data. E, portanto, muitas vezes consultas pesadas s√£o colocadas em segundo plano com o cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© parcialmente justificado, pois o usu√°rio nem sempre precisa dos dados mais recentes e ocorre um n√≠vel aceit√°vel de resposta da interface do usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa abordagem permite solucionar as necessidades dos neg√≥cios, mas reduz a efici√™ncia do sistema de informa√ß√µes, simplesmente atrasando a solu√ß√£o dos problemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m √© importante lembrar que, no processo de pesquisa necess√°rio para adicionar novos √≠ndices, as propostas de </font><font style="vertical-align: inherit;">otimiza√ß√£o </font><font style="vertical-align: inherit;">do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podem estar incorretas, inclusive nas seguintes condi√ß√µes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se j√° existirem √≠ndices com um conjunto semelhante de campos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se os campos na tabela n√£o puderem ser indexados devido a restri√ß√µes de indexa√ß√£o (mais sobre isso √© descrito </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Mesclando atributos em um novo atributo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, alguns campos da mesma tabela pelos quais ocorre um grupo de condi√ß√µes podem ser substitu√≠dos pela introdu√ß√£o de um novo campo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© especialmente verdadeiro para os campos de estado, que por tipo s√£o geralmente bit a bit ou n√∫mero inteiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemplo: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IsClosed = 0 AND Canceled = 0 AND Enabled = 0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© substitu√≠do por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Status = 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, voc√™ insere o atributo inteiro Status, que √© fornecido preenchendo esses status na tabela. </font><font style="vertical-align: inherit;">O pr√≥ximo passo √© indexar esse novo atributo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© uma solu√ß√£o fundamental para o problema de desempenho, porque estamos solicitando dados sem c√°lculos desnecess√°rios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) Materializa√ß√£o da submiss√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o podem usar diretamente tabelas tempor√°rias, CTEs e vari√°veis ‚Äã‚Äãde tabela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, h√° outra maneira de otimizar para este caso - s√£o as visualiza√ß√µes indexadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um grupo de condi√ß√µes (do exemplo acima) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IsClosed = 0 AND Canceled = 0 AND Enabled = 0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou um conjunto de outras condi√ß√µes semelhantes) se torna uma boa op√ß√£o para us√°-las em uma exibi√ß√£o indexada, armazenando em cache uma pequena fatia de dados de um conjunto grande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas h√° v√°rias limita√ß√µes ao materializar uma exibi√ß√£o:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando subconsultas, as cl√°usulas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXISTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devem ser substitu√≠das usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></b></li>
<li><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">N√£o</font></b><font style="vertical-align: inherit;"> √© </font><b><font style="vertical-align: inherit;">poss√≠vel</font></b><font style="vertical-align: inherit;"> usar as </font><b><font style="vertical-align: inherit;">cl√°usulas </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION ALL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXCEPTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INTERSECT</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ n√£o pode usar dicas de tabela e cl√°usulas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OPTION</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sem capacidade de trabalhar com ciclos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© imposs√≠vel exibir dados em uma visualiza√ß√£o de tabelas diferentes</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante lembrar que os benef√≠cios reais do uso de uma exibi√ß√£o indexada podem ser obtidos apenas pela indexa√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, ao invocar uma visualiza√ß√£o, esses √≠ndices n√£o podem ser usados ‚Äã‚Äãe, para us√°-los explicitamente, voc√™ deve especificar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WITH (NOEXPAND)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como </font><font style="vertical-align: inherit;">√© imposs√≠vel definir dicas de tabela </font><font style="vertical-align: inherit;">em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , voc√™ deve fazer outra representa√ß√£o - um "inv√≥lucro" do seguinte formato:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> _ <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> MAT_VIEW <span class="hljs-keyword">WITH</span> (NOEXPAND);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4) Usando fun√ß√µes de tabela</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grandes blocos de subconsulta ou blocos que usam representa√ß√µes com uma estrutura complexa formam a consulta final com uma estrutura de execu√ß√£o muito complexa e n√£o ideal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Principais benef√≠cios do uso de fun√ß√µes de tabela em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A capacidade, como no caso de visualiza√ß√µes, de usar e especificar como um objeto, mas voc√™ pode passar um conjunto de par√¢metros de entrada: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FROM FUNCTION (@ param1, @ param2 ...)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
no final, pode obter uma amostragem de dados flex√≠vel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao usar uma fun√ß√£o de tabela, n√£o existem restri√ß√µes t√£o fortes como no caso das visualiza√ß√µes indexadas descritas acima:</font></font><br>
<br>
<ol>
<li> :<br>
 <b>LINQ</b>             .<br>
     .<br>
        ,          </li>
<li>  ,     , :<br>
<br>
<ul>
<li>    (   )</li>
<li>     </li>
<li> <b>UNION</b>  <b>EXISTS</b></li>
</ul></li>
</ol><br>
</li>
<li> <b>OPTION</b>  ,       <b>OPTION(MAXDOP N)</b>,    . :<br>
<br>
<ul>
<li>      <b>OPTION (RECOMPILE)</b></li>
<li>         ,    <b>OPTION (FORCE ORDER)</b></li>
</ul><br>
   <b>OPTION</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>.<br>
</li>
<li>      :<br>
        (     ),         .<br>
,  ,     <b>WHERE</b>    <b>(a, b, c)</b>.<br>
<br>
       <b>a = 0 and b = 0</b>.<br>
<br>
,    <b>c</b>  .<br>
<br>
  <b>a = 0 and b = 0</b>          ,    <b></b>      .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, a fun√ß√£o de tabela pode ser uma op√ß√£o melhor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, a fun√ß√£o de tabela √© mais previs√≠vel e constante no tempo de execu√ß√£o.</font></font><br>
</li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos considerar um exemplo de implementa√ß√£o usando o exemplo do banco de dados de perguntas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° uma consulta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELECT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que combina v√°rias tabelas e usa uma visualiza√ß√£o (OperativeQuestions), que verifica por email a afilia√ß√£o (via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXISTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) de "Consultas ativas" ([OperativeQuestions]):</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o n¬∫ 1</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">(@p__linq__0 nvarchar(4000))<span class="hljs-keyword">SELECT</span>
<span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> [C1],<font></font>
[Extent1].[<span class="hljs-keyword">Id</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Id</span>],<font></font>
[Join2].[Object_Id] <span class="hljs-keyword">AS</span> [Object_Id],<font></font>
[Join2].[ObjectType_Id] <span class="hljs-keyword">AS</span> [ObjectType_Id],<font></font>
[Join2].[<span class="hljs-keyword">Name</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Name</span>],<font></font>
[Join2].[ExternalId] <span class="hljs-keyword">AS</span> [ExternalId]
<span class="hljs-keyword">FROM</span> [dbo].[Questions] <span class="hljs-keyword">AS</span> [Extent1]
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<span class="hljs-keyword">SELECT</span> [Extent2].[Object_Id] <span class="hljs-keyword">AS</span> [Object_Id],<font></font>
[Extent2].[Question_Id] <span class="hljs-keyword">AS</span> [Question_Id], [Extent3].[ExternalId] <span class="hljs-keyword">AS</span> [ExternalId],<font></font>
[Extent3].[ObjectType_Id] <span class="hljs-keyword">AS</span> [ObjectType_Id], [Extent4].[<span class="hljs-keyword">Name</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Name</span>]
<span class="hljs-keyword">FROM</span> [dbo].[ObjectQuestions] <span class="hljs-keyword">AS</span> [Extent2]
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> [dbo].[Objects] <span class="hljs-keyword">AS</span> [Extent3] <span class="hljs-keyword">ON</span> [Extent2].[Object_Id] = [Extent3].[<span class="hljs-keyword">Id</span>]
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> [dbo].[ObjectTypes] <span class="hljs-keyword">AS</span> [Extent4] 
<span class="hljs-keyword">ON</span> [Extent3].[ObjectType_Id] = [Extent4].[<span class="hljs-keyword">Id</span>] ) <span class="hljs-keyword">AS</span> [Join2] 
<span class="hljs-keyword">ON</span> [Extent1].[<span class="hljs-keyword">Id</span>] = [Join2].[Question_Id]
<span class="hljs-keyword">WHERE</span> ([Extent1].[AnswerId] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (<span class="hljs-number">0</span> = [Extent1].[<span class="hljs-keyword">Exp</span>]) <span class="hljs-keyword">AND</span> ( <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span>
<span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> [C1]
<span class="hljs-keyword">FROM</span> [dbo].[OperativeQuestions] <span class="hljs-keyword">AS</span> [Extent5]
<span class="hljs-keyword">WHERE</span> (([Extent5].[Email] = @p__linq__0) <span class="hljs-keyword">OR</span> (([Extent5].[Email] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) 
<span class="hljs-keyword">AND</span> (@p__linq__0 <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>))) <span class="hljs-keyword">AND</span> ([Extent5].[<span class="hljs-keyword">Id</span>] = [Extent1].[<span class="hljs-keyword">Id</span>])<font></font>
));<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A visualiza√ß√£o possui uma estrutura bastante complicada: possui jun√ß√µes de subconsulta e o uso da classifica√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISTINCT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que geralmente √© uma opera√ß√£o que consome muitos recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma sele√ß√£o de cerca de dez mil registros de OperativeQuestions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O principal problema dessa consulta √© que, para registros de uma consulta externa, √© realizada uma subconsulta interna na visualiza√ß√£o [OperativeQuestions], que deve limitar a amostra de sa√≠da (via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXISTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) a centenas de registros </font><font style="vertical-align: inherit;">para [Email] = @ p__linq__0 </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E pode parecer que a subconsulta calcule os registros uma vez por [Email] = @ p__linq__0 e, em seguida, essas duas centenas de registros dever√£o ser conectadas pelas Id Id Questions, e a consulta ser√° r√°pida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, todas as tabelas s√£o conectadas em s√©rie: as perguntas de identifica√ß√£o e a identifica√ß√£o de OperativeQuestions s√£o verificadas quanto √† conformidade e o email √© filtrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, a solicita√ß√£o funciona com todas as dezenas de milhares de registros OperativeQuestions e voc√™ s√≥ precisa de dados de interesse no Email. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OperativeQuestions exibir texto:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o n¬∫ 2</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"> 
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> [dbo].[OperativeQuestions]
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> Q.Id, USR.email <span class="hljs-keyword">AS</span> Email
<span class="hljs-keyword">FROM</span>            [dbo].Questions <span class="hljs-keyword">AS</span> Q <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span>
                         [dbo].ProcessUserAccesses <span class="hljs-keyword">AS</span> BPU <span class="hljs-keyword">ON</span> BPU.ProcessId = CQ.Process_Id 
<span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">APPLY</span>
                     (<span class="hljs-keyword">SELECT</span>   <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> HasNoObjects
                      <span class="hljs-keyword">WHERE</span>   <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>
                                    (<span class="hljs-keyword">SELECT</span>   <span class="hljs-number">1</span>
                                     <span class="hljs-keyword">FROM</span>     [dbo].ObjectUserAccesses <span class="hljs-keyword">AS</span> BOU
                                     <span class="hljs-keyword">WHERE</span>   BOU.ProcessUserAccessId = BPU.[<span class="hljs-keyword">Id</span>] <span class="hljs-keyword">AND</span> BOU.[<span class="hljs-keyword">To</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>)<font></font>
) <span class="hljs-keyword">AS</span> BO <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span>
                         [dbo].Users <span class="hljs-keyword">AS</span> USR <span class="hljs-keyword">ON</span> USR.Id = BPU.UserId
<span class="hljs-keyword">WHERE</span>        CQ.[<span class="hljs-keyword">Exp</span>] = <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> CQ.AnswerId <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> BPU.[<span class="hljs-keyword">To</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> 
<span class="hljs-keyword">AND</span> (BO.HasNoObjects = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span>
              <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span>   <span class="hljs-number">1</span>
                           <span class="hljs-keyword">FROM</span>   [dbo].ObjectUserAccesses <span class="hljs-keyword">AS</span> BOU <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span>
                                      [dbo].ObjectQuestions <span class="hljs-keyword">AS</span> QBO 
                                                  <span class="hljs-keyword">ON</span> QBO.[Object_Id] =BOU.ObjectId
                               <span class="hljs-keyword">WHERE</span>  BOU.ProcessUserAccessId = BPU.Id 
                               <span class="hljs-keyword">AND</span> BOU.[<span class="hljs-keyword">To</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> QBO.Question_Id = CQ.Id));
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Representa√ß√£o de mapeamento original no DbContext (EF Core 2)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">public class QuestionsDbContext : DbContext<font></font>
{<font></font>
    //...<font></font>
    public DbQuery&lt;OperativeQuestion&gt; OperativeQuestions { get; set; }<font></font>
    //...<font></font>
    protected override void OnModelCreating(ModelBuilder modelBuilder)<font></font>
    {<font></font>
        modelBuilder.Query&lt;OperativeQuestion&gt;().ToView("OperativeQuestions");<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulta LINQ original</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">var businessObjectsData = await context<font></font>
    .OperativeQuestions<font></font>
    .Where(x =&gt; x.Email == Email)<font></font>
    .Include(x =&gt; x.Question)<font></font>
    .Select(x =&gt; x.Question)<font></font>
    .SelectMany(x =&gt; x.ObjectQuestions,<font></font>
                (x, bo) =&gt; new<font></font>
                {<font></font>
                    Id = x.Id,<font></font>
                    ObjectId = bo.Object.Id,<font></font>
                    ObjectTypeId = bo.Object.ObjectType.Id,<font></font>
                    ObjectTypeName = bo.Object.ObjectType.Name,<font></font>
                    ObjectExternalId = bo.Object.ExternalId<font></font>
                })<font></font>
    .ToListAsync();<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso em particular, uma solu√ß√£o para esse problema √© considerada sem altera√ß√µes na infraestrutura, sem a introdu√ß√£o de uma tabela separada com resultados prontos ("Consultas ativas"), para a qual seria necess√°rio um mecanismo para preencher seus dados e mant√™-los atualizados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora essa seja uma boa solu√ß√£o, h√° outra op√ß√£o para otimizar essa tarefa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo principal √© armazenar em cache as entradas por [Email] = @ p__linq__0 na visualiza√ß√£o OperativeQuestions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entramos na fun√ß√£o de tabela [dbo]. [OperativeQuestionsUserMail] no banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enviando email como par√¢metro de entrada, retornamos a tabela de valores:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o n¬∫ 3</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> [dbo].[OperativeQuestionsUserMail]<font></font>
(<font></font>
    @Email  <span class="hljs-keyword">nvarchar</span>(<span class="hljs-number">4000</span>)<font></font>
)<font></font>
<span class="hljs-keyword">RETURNS</span>
@tbl <span class="hljs-keyword">TABLE</span><font></font>
(<font></font>
    [<span class="hljs-keyword">Id</span>]           uniqueidentifier,<font></font>
    [Email]      <span class="hljs-keyword">nvarchar</span>(<span class="hljs-number">4000</span>)<font></font>
)<font></font>
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> @tbl ([<span class="hljs-keyword">Id</span>], [Email])
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">Id</span>, @Email
        <span class="hljs-keyword">FROM</span> [OperativeQuestions]  <span class="hljs-keyword">AS</span> [x] <span class="hljs-keyword">WHERE</span> [x].[Email] = @Email;<font></font>
     <font></font>
    RETURN;<font></font>
<span class="hljs-keyword">END</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso retorna uma tabela de valores com uma estrutura de dados predefinida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que as consultas para OperativeQuestionsUserMail sejam ideais, tenham planos de consulta ideais, √© necess√°ria uma estrutura rigorosa, e n√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RETURNS TABLE AS RETURN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, a Solicita√ß√£o 1 desejada √© convertida na Solicita√ß√£o 4:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o n¬∫ 4</font></font></b><div class="spoiler_text"><pre><code class="sql hljs">(@p__linq__0 nvarchar(4000))<span class="hljs-keyword">SELECT</span>
<span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> [C1],<font></font>
[Extent1].[<span class="hljs-keyword">Id</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Id</span>],<font></font>
[Join2].[Object_Id] <span class="hljs-keyword">AS</span> [Object_Id],<font></font>
[Join2].[ObjectType_Id] <span class="hljs-keyword">AS</span> [ObjectType_Id],<font></font>
[Join2].[<span class="hljs-keyword">Name</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Name</span>],<font></font>
[Join2].[ExternalId] <span class="hljs-keyword">AS</span> [ExternalId]
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">Id</span>, Email <span class="hljs-keyword">FROM</span> [dbo].[OperativeQuestionsUserMail] (@p__linq__0)<font></font>
) <span class="hljs-keyword">AS</span> [Extent0]
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> [dbo].[Questions] <span class="hljs-keyword">AS</span> [Extent1] <span class="hljs-keyword">ON</span>([Extent0].Id=[Extent1].Id)
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<span class="hljs-keyword">SELECT</span> [Extent2].[Object_Id] <span class="hljs-keyword">AS</span> [Object_Id], [Extent2].[Question_Id] <span class="hljs-keyword">AS</span> [Question_Id], [Extent3].[ExternalId] <span class="hljs-keyword">AS</span> [ExternalId], [Extent3].[ObjectType_Id] <span class="hljs-keyword">AS</span> [ObjectType_Id], [Extent4].[<span class="hljs-keyword">Name</span>] <span class="hljs-keyword">AS</span> [<span class="hljs-keyword">Name</span>]
<span class="hljs-keyword">FROM</span> [dbo].[ObjectQuestions] <span class="hljs-keyword">AS</span> [Extent2]
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> [dbo].[Objects] <span class="hljs-keyword">AS</span> [Extent3] <span class="hljs-keyword">ON</span> [Extent2].[Object_Id] = [Extent3].[<span class="hljs-keyword">Id</span>]
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> [dbo].[ObjectTypes] <span class="hljs-keyword">AS</span> [Extent4] 
<span class="hljs-keyword">ON</span> [Extent3].[ObjectType_Id] = [Extent4].[<span class="hljs-keyword">Id</span>] ) <span class="hljs-keyword">AS</span> [Join2] 
<span class="hljs-keyword">ON</span> [Extent1].[<span class="hljs-keyword">Id</span>] = [Join2].[Question_Id]
<span class="hljs-keyword">WHERE</span> ([Extent1].[AnswerId] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span> (<span class="hljs-number">0</span> = [Extent1].[<span class="hljs-keyword">Exp</span>]);
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapeando vis√µes e fun√ß√µes no DbContext (EF Core 2)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">public class QuestionsDbContext : DbContext<font></font>
{<font></font>
    //...<font></font>
    public DbQuery&lt;OperativeQuestion&gt; OperativeQuestions { get; set; }<font></font>
    //...<font></font>
    protected override void OnModelCreating(ModelBuilder modelBuilder)<font></font>
    {<font></font>
        modelBuilder.Query&lt;OperativeQuestion&gt;().ToView("OperativeQuestions");<font></font>
    }<font></font>
}<font></font>
 <font></font>
public static class FromSqlQueries<font></font>
{<font></font>
    public static IQueryable&lt;OperativeQuestion&gt; GetByUserEmail(this DbQuery&lt;OperativeQuestion&gt; source, string Email)<font></font>
        =&gt; source.FromSql($"SELECT Id, Email FROM [dbo].[OperativeQuestionsUserMail] ({Email})");<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulta LINQ final</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">var businessObjectsData = await context<font></font>
    .OperativeQuestions<font></font>
    .GetByUserEmail(Email)<font></font>
    .Include(x =&gt; x.Question)<font></font>
    .Select(x =&gt; x.Question)<font></font>
    .SelectMany(x =&gt; x.ObjectQuestions,<font></font>
                (x, bo) =&gt; new<font></font>
                {<font></font>
                    Id = x.Id,<font></font>
                    ObjectId = bo.Object.Id,<font></font>
                    ObjectTypeId = bo.Object.ObjectType.Id,<font></font>
                    ObjectTypeName = bo.Object.ObjectType.Name,<font></font>
                    ObjectExternalId = bo.Object.ExternalId<font></font>
                })<font></font>
    .ToListAsync();<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ordem do tempo de execu√ß√£o diminuiu de 200-800 ms, para 2-20 ms. Etc., ou seja, dez vezes mais r√°pido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se levarmos mais em m√©dia, em vez de 350 ms, temos 8 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das vantagens √≥bvias, tamb√©m obtemos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redu√ß√£o geral na carga de leitura,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probabilidade de bloqueio significativamente reduzida</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redu√ß√£o do tempo m√©dio de bloqueio para valores aceit√°veis</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A otimiza√ß√£o e o ajuste fino de chamadas para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">banco de dados MS SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por meio do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um problema que pode ser resolvido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste trabalho, cuidado e consist√™ncia s√£o muito importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No in√≠cio do processo:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© necess√°rio verificar os dados com os quais a consulta funciona (valores, tipos de dados selecionados)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indexar corretamente esses dados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifique a corre√ß√£o das condi√ß√µes de conex√£o entre as tabelas</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na pr√≥xima itera√ß√£o, a otimiza√ß√£o revela:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a base da solicita√ß√£o e o filtro principal da solicita√ß√£o s√£o definidos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repetindo blocos de consulta semelhantes e condi√ß√µes de interse√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no SSMS ou outra GUI do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a pr√≥pria </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulta SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© otimizada </font><font style="vertical-align: inherit;">(aloca√ß√£o de um reposit√≥rio de dados intermedi√°rio, criando a consulta resultante usando esse reposit√≥rio (pode haver v√°rios))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No √∫ltimo est√°gio, tendo como base a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulta SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resultante </font><font style="vertical-align: inherit;">, a estrutura da </font><b><font style="vertical-align: inherit;">consulta LINQ</font></b><font style="vertical-align: inherit;"> √© reconstru√≠da</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulta LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resultante </font><font style="vertical-align: inherit;">deve se tornar id√™ntica em estrutura √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulta SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideal identificada </font><font style="vertical-align: inherit;">do par√°grafo 3.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agradecimentos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muito obrigado aos colegas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jobgemws</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alex_ozr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortis</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por ajudar com este artigo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489206/index.html">Hist√≥rias de travamento com Patroni ou Como eliminar um cluster do PostgreSQL</a></li>
<li><a href="../pt489210/index.html">Teste de desempenho de c√≥digo do Linux com exemplos</a></li>
<li><a href="../pt489212/index.html">1C-Bitrix impede o cancelamento da inscri√ß√£o no boletim informativo pelo requisito de enviar seus dados pessoais</a></li>
<li><a href="../pt489214/index.html">Abordagem moderna para testar a localiza√ß√£o no iOS</a></li>
<li><a href="../pt489218/index.html">√â ing√™nuo. Super: c√≥digo e arquitetura de um jogo simples</a></li>
<li><a href="../pt489228/index.html">Bot de fala no banco - o pior UX de todos os tempos</a></li>
<li><a href="../pt489230/index.html">O que √© desempenho de aplicativos da web?</a></li>
<li><a href="../pt489232/index.html">De volta ao futuro dos telefones m√≥veis II</a></li>
<li><a href="../pt489234/index.html">Como passar com √™xito em qualquer teste (mau conselho)</a></li>
<li><a href="../pt489236/index.html">Primavera: procurando contexto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>