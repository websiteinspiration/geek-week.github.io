<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‰ğŸ¿ ğŸ’‘ ğŸ‘¨ğŸ¿â€ğŸ’» PostgreSQLãƒ¬ã‚·ãƒ”ï¼šDocker Swarmã§ã®è‡ªå‹•â€‹â€‹ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã¨è‡ªå‹•å†çµåˆ ğŸ› ğŸ‘¨ğŸ½â€ğŸ’¼ ğŸ‘³ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ç¾¤ã‚Œã«è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãŠã‚ˆã³è‡ªå‹•å†çµåˆã‚’æº–å‚™ã™ã‚‹ãŸã‚ã«ã€æˆ‘ã€…ã¯å¿…è¦ãªãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã€postgresã®ã€repmgrã€pgbouncerã€å€¤Runitã¨glusterã‚’ã€‚å®Œæˆã—ãŸç”»åƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
 
 ã¾ãšã€2ã¤ã®ãƒ›ã‚¹ãƒˆï¼ˆé‰„ã‚ˆã‚Šå„ªã‚Œã¦ã„ã‚‹ï¼‰ã®docker...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLãƒ¬ã‚·ãƒ”ï¼šDocker Swarmã§ã®è‡ªå‹•â€‹â€‹ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã¨è‡ªå‹•å†çµåˆ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498132/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ç¾¤ã‚Œã«è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãŠã‚ˆã³è‡ªå‹•å†çµåˆã‚’æº–å‚™ã™ã‚‹ãŸã‚ã«ã€æˆ‘ã€…ã¯å¿…è¦ãª</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresã®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repmgr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€¤Runit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glusterã‚’</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæˆã—ãŸç”»åƒã‚’</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ã</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ã¾ã™</font></a><font style="vertical-align: inherit;">ã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãšã€2ã¤ã®ãƒ›ã‚¹ãƒˆï¼ˆé‰„ã‚ˆã‚Šå„ªã‚Œã¦ã„ã‚‹ï¼‰ã®docker1ã¨docker2ã§ã€ä¸¡æ–¹ãŒãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ãªã‚‹ã‚ˆã†ã«docker swarmã‚’ç·¨æˆã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãŸã€ä¸¡æ–¹ã®ãƒ›ã‚¹ãƒˆã«åˆ†æ•£ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ glusterfsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€æ¬¡ã®ã‚ˆã†ã«fstabã§ä¸¡æ–¹ã®ãƒ›ã‚¹ãƒˆã«ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">localhost:/gfs /mnt/gfs glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ä¸¡æ–¹ã®ãƒ›ã‚¹ãƒˆã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ </font></font><br>
<br>
<pre><code class="bash hljs">docker volume create repmgr</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ </font></font><br>
<br>
<pre><code class="bash hljs">docker network create --attachable --driver overlay docker</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€Dockerãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’åé›†ã—ã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">FROM alpine<font></font>
RUN <span class="hljs-built_in">set</span> -ex \<font></font>
    &amp;&amp; apk add --no-cache --repository http://dl-cdn.alpinelinux.org/alpine/edge/testing --virtual .locales-rundeps \<font></font>
        musl-locales \ <span class="hljs-comment">#   (   ,      )</span><font></font>
    &amp;&amp; apk add --no-cache --virtual .postgresql-rundeps \<font></font>
        openssh-client \ <span class="hljs-comment">#  ssh- (   ,      )</span>
        openssh-server \ <span class="hljs-comment">#  ssh- (   ,    switchover)</span>
        pgbouncer \ <span class="hljs-comment">#  </span>
        postgresql \ <span class="hljs-comment">#  </span>
        postgresql-contrib \ <span class="hljs-comment">#     (   ,      )</span>
        repmgr \ <span class="hljs-comment">#  repmgr</span>
        repmgr-daemon \ <span class="hljs-comment">#    </span>
        rsync \ <span class="hljs-comment">#   (   ,      )</span>
        runit \ <span class="hljs-comment">#   </span>
        shadow \ <span class="hljs-comment">#   </span>
        tzdata \ <span class="hljs-comment">#   (   ,      )</span>
    &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-keyword">done</span>
ADD bin /usr/<span class="hljs-built_in">local</span>/bin <span class="hljs-comment">#  </span>
ADD service /etc/service <span class="hljs-comment">#    </span>
CMD [ <span class="hljs-string">"runsvdir"</span>, <span class="hljs-string">"/etc/service"</span> ] <span class="hljs-comment">#   </span>
ENTRYPOINT [ <span class="hljs-string">"docker_entrypoint.sh"</span> ] <span class="hljs-comment">#   </span><font></font>
ENV HOME=/var/lib/postgresql<font></font>
ENV GROUP=postgres \<font></font>
    PGDATA=<span class="hljs-string">"<span class="hljs-variable">${HOME}</span>/pg_data"</span> \<font></font>
    USER=postgres<font></font>
VOLUME <span class="hljs-string">"<span class="hljs-variable">${HOME}</span>"</span>
WORKDIR <span class="hljs-string">"<span class="hljs-variable">${HOME}</span>"</span>
RUN <span class="hljs-built_in">set</span> -ex \<font></font>
    &amp;&amp; sed -i -e <span class="hljs-string">'s|#PasswordAuthentication yes|PasswordAuthentication no|g'</span> /etc/ssh/sshd_config \ <span class="hljs-comment">#    </span>
    &amp;&amp; sed -i -e <span class="hljs-string">'s|#   StrictHostKeyChecking ask|   StrictHostKeyChecking no|g'</span> /etc/ssh/ssh_config \ <span class="hljs-comment">#    </span>
    &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"   UserKnownHostsFile=/dev/null"</span> &gt;&gt;/etc/ssh/ssh_config \ <span class="hljs-comment">#      </span>
    &amp;&amp; sed -i -e <span class="hljs-string">'s|postgres:!:|postgres::|g'</span> /etc/shadow \ <span class="hljs-comment">#    </span>
    &amp;&amp; chmod -R 0755 /etc/service /usr/<span class="hljs-built_in">local</span>/bin \<font></font>
    &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-keyword">done</span></code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€å„ãƒ›ã‚¹ãƒˆã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ </font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service1.sh</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">docker service create \<font></font>
    --constraint node.hostname==docker1 \ <span class="hljs-comment">#     </span>
    --env GROUP_ID=<span class="hljs-string">"<span class="hljs-subst">$(id -g)</span>"</span> \ <span class="hljs-comment">#    (       )</span>
    --env LANG=ru_RU.UTF-8 \ <span class="hljs-comment">#   (   ,      )</span>
    --env TZ=Asia/Yekaterinburg \ <span class="hljs-comment">#   (   ,      )</span>
    --env USER_ID=<span class="hljs-string">"<span class="hljs-subst">$(id -u)</span>"</span> \ <span class="hljs-comment">#    (       )</span>
    --hostname tasks.repmgr1 \ <span class="hljs-comment">#  </span>
    --mount <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=/etc/certs,destination=/etc/certs,<span class="hljs-built_in">readonly</span> \ <span class="hljs-comment">#     (   ,      )</span>
    --mount <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=/mnt/gfs/repmgr,destination=/var/lib/postgresql/gfs \ <span class="hljs-comment">#    </span>
    --mount <span class="hljs-built_in">type</span>=volume,<span class="hljs-built_in">source</span>=repmgr,destination=/var/lib/postgresql \ <span class="hljs-comment">#  </span>
    --name repmgr1 \ <span class="hljs-comment">#   </span>
    --network name=docker \ <span class="hljs-comment">#  </span>
    --publish target=5432,published=5432,mode=host \ <span class="hljs-comment">#   </span>
    --publish target=5433,published=5433,mode=host \ <span class="hljs-comment">#   </span>
    --replicas-max-per-node 1 \ <span class="hljs-comment">#      </span>
    rekgrpth/repmgr <span class="hljs-comment">#   </span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2ç•ªç›®ã®ãƒ›ã‚¹ãƒˆã§2ç•ªç›®ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚å®Ÿè¡Œã—ã¾ã™ã€‚docker1ã®ä»£ã‚ã‚Šã«docker2ã‚’æ›¸ãè¾¼ã¿ã€repmgr1ã®ä»£ã‚ã‚Šã«repmgr2ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ³ãƒ™ã‚¢ã®ãƒ›ã‚¹ãƒˆåã‚’è§£æ±ºã™ã‚‹ã‚ˆã†ã«ãƒ‰ãƒƒã‚«ãƒ¼ã«æ•™ãˆã‚‹å ´åˆ</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,         <pre><code class="bash hljs">docker service create \<font></font>
    --env GROUP_ID=<span class="hljs-string">"<span class="hljs-subst">$(id -g)</span>"</span> \ <span class="hljs-comment">#    (       )</span>
    --env LANG=ru_RU.UTF-8 \ <span class="hljs-comment">#   (   ,      )</span>
    --env TZ=Asia/Yekaterinburg \ <span class="hljs-comment">#   (   ,      )</span>
    --env USER_ID=<span class="hljs-string">"<span class="hljs-subst">$(id -u)</span>"</span> \ <span class="hljs-comment">#    (       )</span>
    --hostname repmgr-{{.Node.Hostname}} \ <span class="hljs-comment">#  </span>
    --mode global \ <span class="hljs-comment">#       </span>
    --mount <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=/etc/certs,destination=/etc/certs,<span class="hljs-built_in">readonly</span> \ <span class="hljs-comment">#     (   ,      )</span>
    --mount <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=/mnt/gfs/repmgr,destination=/var/lib/postgresql/gfs \ <span class="hljs-comment">#    </span>
    --mount <span class="hljs-built_in">type</span>=volume,<span class="hljs-built_in">source</span>=repmgr,destination=/var/lib/postgresql \ <span class="hljs-comment">#  </span>
    --name repmgr \ <span class="hljs-comment">#   </span>
    --network name=docker \ <span class="hljs-comment">#  </span>
    --publish target=5432,published=5432,mode=host \ <span class="hljs-comment">#   </span>
    --publish target=5433,published=5433,mode=host \ <span class="hljs-comment">#   </span>
    rekgrpth/repmgr <span class="hljs-comment">#   </span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã ã‹ã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠã¸ã®å…¥ã‚Šå£ </font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/docker_entrypoint.sh</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1
<span class="hljs-built_in">set</span> -ex
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> ] &amp;&amp; [ -n <span class="hljs-string">"<span class="hljs-variable">$GROUP_ID</span>"</span> ] &amp;&amp; [ <span class="hljs-string">"<span class="hljs-variable">$GROUP_ID</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(id -g <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span>)</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">#          , </span>
    groupmod --gid <span class="hljs-string">"<span class="hljs-variable">$GROUP_ID</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> <span class="hljs-comment">#   </span>
    chgrp <span class="hljs-string">"<span class="hljs-variable">$GROUP_ID</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$HOME</span>"</span> <span class="hljs-comment">#      </span>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> ] &amp;&amp; [ -n <span class="hljs-string">"<span class="hljs-variable">$USER_ID</span>"</span> ] &amp;&amp; [ <span class="hljs-string">"<span class="hljs-variable">$USER_ID</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(id -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>)</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">#          , </span>
    usermod --uid <span class="hljs-string">"<span class="hljs-variable">$USER_ID</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> <span class="hljs-comment">#   </span>
    chown <span class="hljs-string">"<span class="hljs-variable">$USER_ID</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$HOME</span>"</span> <span class="hljs-comment">#      </span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exec</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> <span class="hljs-comment">#   </span></code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã¯ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ </font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1ï¼‰/ etc / service / ssh</font></font></b>
                        <div class="spoiler_text">    ,    switchover.   <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/ssh/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
ssh-keygen -A <span class="hljs-comment">#   </span>
<span class="hljs-built_in">exec</span> /usr/sbin/sshd -D -e <span class="hljs-comment">#  ssh-</span>
</code></pre><br>
</div>
                    </div><br>
,       (   ,       ) <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/ssh/log/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1
<span class="hljs-built_in">exec</span> sed <span class="hljs-string">'s|^|ssh: |'</span>
</code></pre><br>
</div>
                    </div><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2ï¼‰/ etc / service / postgres</font></font></b>
                        <div class="spoiler_text">  <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
install -d -m 0750 -o <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> -g <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>"</span> <span class="hljs-comment">#    </span>
install -d -m 1775 -o <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> -g <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /run/postgresql /var/<span class="hljs-built_in">log</span>/postgresql <span class="hljs-comment">#     </span>
rm -f /run/postgresql/postgres.run <span class="hljs-comment">#   </span>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chmod 755 supervise<font></font>
chown <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> supervise/ok supervise/control supervise/status <span class="hljs-comment">#    </span>
rm -f <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/postmaster.pid"</span> <span class="hljs-comment">#  pid</span>
primary=<span class="hljs-string">"<span class="hljs-subst">$(test -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> &amp;&amp; cat <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span>)</span>"</span> <span class="hljs-comment">#    </span>
<span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> || <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-subst">$(hostname)</span>"</span> &gt;<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> <span class="hljs-comment">#    ,   -  </span>
primary=<span class="hljs-string">"<span class="hljs-subst">$(test -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> &amp;&amp; cat <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span>)</span>"</span> <span class="hljs-comment">#    </span>
<span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> <span class="hljs-comment"># ,    </span>
chown <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> <span class="hljs-comment">#  </span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(hostname)</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">#     , </span>
    <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/base"</span> || /etc/service/postgres/standby <span class="hljs-comment">#     -  </span>
    <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/standby.signal"</span> || /etc/service/postgres/rejoin <span class="hljs-comment">#      ,      </span>
<span class="hljs-keyword">else</span> <span class="hljs-comment">#  (  - )</span>
    <span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/base"</span> || /etc/service/postgres/primary <span class="hljs-comment">#     -  </span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">test</span> -d <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/base"</span> <span class="hljs-comment"># ,     </span>
<span class="hljs-built_in">exec</span> chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> -L /run/postgresql/postgres.run postmaster <span class="hljs-comment">#  </span>
</code></pre><br>
</div>
                    </div><br>
,       (   ,       ) <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/log/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1
<span class="hljs-built_in">exec</span> sed <span class="hljs-string">'s|^|postgres: |'</span>
</code></pre><br>
</div>
                    </div><br>
      <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/standby</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/repmgr/conf <span class="hljs-comment">#    repmgr</span>
primary=<span class="hljs-string">"<span class="hljs-subst">$(test -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> &amp;&amp; cat <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span>)</span>"</span> <span class="hljs-comment">#    </span>
<span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> <span class="hljs-comment"># ,   </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> repmgr standby <span class="hljs-built_in">clone</span> --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose --fast-checkpoint --dbname=<span class="hljs-string">"host=<span class="hljs-variable">$primary</span> user=repmgr dbname=repmgr connect_timeout=2"</span> <span class="hljs-comment">#    </span>
</code></pre><br>
</div>
                    </div><br>
      <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/rejoin</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
primary=<span class="hljs-string">"<span class="hljs-subst">$(test -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> &amp;&amp; cat <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span>)</span>"</span> <span class="hljs-comment">#    </span>
<span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> <span class="hljs-comment"># ,   </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> pg_ctl --options=<span class="hljs-string">"-c listen_addresses=''"</span> --<span class="hljs-built_in">wait</span> start <span class="hljs-comment">#    (   pg_rewind)</span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> pg_ctl --<span class="hljs-built_in">wait</span> --mode=fast stop <span class="hljs-comment">#   (   pg_rewind)</span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> repmgr node rejoin --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose --force-rewind --no-wait --dbname=<span class="hljs-string">"host=<span class="hljs-variable">$primary</span> user=repmgr dbname=repmgr connect_timeout=2"</span> || mv -f <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${PGDATA}</span>_<span class="hljs-subst">$(date <span class="hljs-string">"+%F %T"</span>)</span>"</span> <span class="hljs-comment">#      (   -       )</span>
</code></pre><br>
</div>
                    </div><br>
     <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/primary</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
/etc/service/postgres/init <span class="hljs-comment">#  </span>
/etc/service/repmgr/init <span class="hljs-comment">#  repmgr</span>
</code></pre><br>
</div>
                    </div><br>
   <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/init</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex
<span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>"</span> &amp;&amp; chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> initdb <span class="hljs-comment">#  </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/postgres/conf <span class="hljs-comment">#   </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/postgres/hba <span class="hljs-comment">#   </span>
</code></pre><br>
</div>
                    </div><br>
    <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/conf</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
cat &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/postgresql.conf"</span> &lt;&lt;EOF<font></font>
<font></font>
archive_command = <span class="hljs-string">'/bin/true'</span> <span class="hljs-comment">#  </span>
archive_mode = on <span class="hljs-comment">#  - </span>
datestyle = <span class="hljs-string">'iso, dmy'</span> <span class="hljs-comment">#   </span>
listen_addresses = <span class="hljs-string">'*'</span> <span class="hljs-comment">#  </span>
max_logical_replication_workers = 0 <span class="hljs-comment">#   </span>
max_sync_workers_per_subscription = 0 <span class="hljs-comment">#   </span>
ssl_ca_file = <span class="hljs-string">'/etc/certs/ca.pem'</span> <span class="hljs-comment">#   </span>
ssl_cert_file = <span class="hljs-string">'/etc/certs/cert.pem'</span> <span class="hljs-comment">#  </span>
ssl_key_file = <span class="hljs-string">'/etc/certs/key.pem'</span> <span class="hljs-comment">#   </span>
ssl = on <span class="hljs-comment">#  ssl</span><font></font>
EOF<font></font>
</code></pre><br>
</div>
                    </div><br>
    <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/postgres/hba</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex
<span class="hljs-built_in">echo</span> &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/pg_hba.conf"</span>
ip -o -f inet addr show | awk <span class="hljs-string">'/scope global/ {print $4}'</span> | sed -E <span class="hljs-string">'s|.\d+/|.0/|'</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> -r net; <span class="hljs-keyword">do</span> <span class="hljs-comment">#    </span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"host all all <span class="hljs-variable">$net</span> trust"</span> <span class="hljs-comment">#   </span>
<span class="hljs-keyword">done</span> &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/pg_hba.conf"</span>
</code></pre><br>
</div>
                    </div><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3ï¼‰/ etc / service / repmgr</font></font></b>
                        <div class="spoiler_text">   <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
install -d -m 1775 -o <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> -g <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /run/postgresql <span class="hljs-comment">#   </span>
rm -f /run/postgresql/repmgr.run <span class="hljs-comment">#   </span>
<span class="hljs-built_in">test</span> -f /run/postgresql/postgres.run || <span class="hljs-built_in">exit</span> $? <span class="hljs-comment"># ,    </span>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chmod 755 supervise<font></font>
chown <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> supervise/ok supervise/control supervise/status <span class="hljs-comment">#    </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> pg_ctl status <span class="hljs-comment"># ,   </span>
primary=<span class="hljs-string">"<span class="hljs-subst">$(test -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span> &amp;&amp; cat <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/gfs/primary"</span>)</span>"</span> <span class="hljs-comment">#    </span>
<span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> <span class="hljs-comment"># ,   </span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$primary</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(hostname)</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">#     , </span>
    <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> || /etc/service/repmgr/standby <span class="hljs-comment">#    ,   </span>
    chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> repmgr standby register --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose --force <span class="hljs-comment">#     </span>
<span class="hljs-keyword">else</span> <span class="hljs-comment">#  (  - )</span>
    <span class="hljs-built_in">test</span> -f <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> || /etc/service/repmgr/primary <span class="hljs-comment">#    ,   </span>
    <span class="hljs-built_in">test</span> ! -f <span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/standby.signal"</span> || /etc/service/repmgr/promote <span class="hljs-comment">#       ,     </span>
    chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> repmgr primary register --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose --force <span class="hljs-comment">#    </span>
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exec</span> chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> -L /run/postgresql/repmgr.run repmgrd --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose --daemonize=<span class="hljs-literal">false</span> <span class="hljs-comment">#   repmgr</span>
</code></pre><br>
</div>
                    </div><br>
,       (   ,       ) <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/log/run</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1
<span class="hljs-built_in">exec</span> sed <span class="hljs-string">'s|^|repmgr: |'</span>
</code></pre><br>
</div>
                    </div><br>
     <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/standby</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/repmgr/conf <span class="hljs-comment">#  </span>
</code></pre><br>
</div>
                    </div><br>
    <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/primary</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> createuser --superuser repmgr <span class="hljs-comment">#  </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> createdb repmgr --owner=repmgr <span class="hljs-comment">#  </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/repmgr/conf <span class="hljs-comment">#  </span>
</code></pre><br>
</div>
                    </div><br>
      <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/promote</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> repmgr standby promote --config-file=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> --verbose <span class="hljs-comment">#     </span>
</code></pre><br>
</div>
                    </div><br>
   <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/conf</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
cat &gt;<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/repmgr.conf"</span> &lt;&lt;EOF<font></font>
conninfo=<span class="hljs-string">'host=$(hostname) user=repmgr dbname=repmgr connect_timeout=2'</span> <span class="hljs-comment">#      </span>
data_directory=<span class="hljs-string">'$(echo -n "$PGDATA")'</span> <span class="hljs-comment">#    </span>
event_notification_command=<span class="hljs-string">'/etc/service/repmgr/event "%n" "%e" "%s" "%t" "%d"'</span> <span class="hljs-comment">#   </span>
failover=<span class="hljs-string">'automatic'</span> <span class="hljs-comment">#   failover</span>
failover_validation_command=<span class="hljs-string">'/etc/service/repmgr/valid "%n" "%a"'</span> <span class="hljs-comment">#   </span>
follow_command=<span class="hljs-string">'repmgr standby follow --config-file="$(echo -n "$HOME")/repmgr.conf" --wait --upstream-node-id=%n'</span> <span class="hljs-comment">#   </span>
node_id=$(hostname | grep -oE <span class="hljs-string">'\d+'</span>) <span class="hljs-comment">#   </span>
node_name=<span class="hljs-string">'$(hostname)'</span> <span class="hljs-comment">#   </span>
promote_command=<span class="hljs-string">'repmgr standby promote --config-file="$(echo -n "$HOME")/repmgr.conf"'</span> <span class="hljs-comment">#   </span>
repmgrd_service_start_command=<span class="hljs-string">'sv start repmgr'</span> <span class="hljs-comment">#    </span>
repmgrd_service_stop_command=<span class="hljs-string">'sv force-stop repmgr'</span> <span class="hljs-comment">#    </span>
service_promote_command=<span class="hljs-string">'pg_ctl --wait promote'</span> <span class="hljs-comment">#    </span>
service_reload_command=<span class="hljs-string">'sv reload postgres'</span> <span class="hljs-comment">#     </span>
service_restart_command=<span class="hljs-string">'sv force-restart postgres'</span> <span class="hljs-comment">#    </span>
service_start_command=<span class="hljs-string">'sv start postgres'</span> <span class="hljs-comment">#    </span>
service_stop_command=<span class="hljs-string">'sv force-stop postgres'</span> <span class="hljs-comment">#    </span>
ssh_options=<span class="hljs-string">'-q -o ConnectTimeout=10'</span> <span class="hljs-comment">#   ssl</span>
standby_disconnect_on_failover=<span class="hljs-literal">true</span> <span class="hljs-comment">#   failover</span>
use_replication_slots=<span class="hljs-literal">true</span> <span class="hljs-comment">#   </span><font></font>
EOF<font></font>
</code></pre><br>
</div>
                    </div><br>
 repmgr  <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/init</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex<font></font>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> /etc/service/repmgr/hba <span class="hljs-comment">#    </span>
chpst -u <span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span>:<span class="hljs-string">"<span class="hljs-variable">$GROUP</span>"</span> cat &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/postgresql.conf"</span> &lt;&lt;EOF <span class="hljs-comment">#    </span><font></font>
<font></font>
hot_standby = on <span class="hljs-comment">#   </span>
max_replication_slots = 10 <span class="hljs-comment">#     </span>
max_wal_senders = 10 <span class="hljs-comment">#    </span>
shared_preload_libraries = <span class="hljs-string">'repmgr'</span> <span class="hljs-comment">#  repmgr</span>
wal_level = <span class="hljs-string">'hot_standby'</span> <span class="hljs-comment">#    </span>
wal_log_hints = on <span class="hljs-comment">#    pg_rewind</span><font></font>
EOF<font></font>
</code></pre><br>
</div>
                    </div><br>
     <br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">/etc/service/repmgr/hba</b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">exec</span> 2&gt;&amp;1<font></font>
realpath <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>
<span class="hljs-built_in">set</span> -ex
<span class="hljs-built_in">echo</span> &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/pg_hba.conf"</span>
ip -o -f inet addr show | awk <span class="hljs-string">'/scope global/ {print $4}'</span> | sed -E <span class="hljs-string">'s|.\d+/|.0/|'</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> -r net; <span class="hljs-keyword">do</span> <span class="hljs-comment">#    </span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"host replication repmgr <span class="hljs-variable">$net</span> trust"</span> <span class="hljs-comment">#    repmgr</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"host repmgr repmgr <span class="hljs-variable">$net</span> trust"</span> <span class="hljs-comment">#  repmgr  repmgr</span>
<span class="hljs-keyword">done</span> &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/pg_hba.conf"</span>
cat &gt;&gt;<span class="hljs-string">"<span class="hljs-variable">$PGDATA</span>/pg_hba.conf"</span> &lt;&lt;EOF<font></font>
<font></font>
<span class="hljs-built_in">local</span> replication repmgr trust <span class="hljs-comment">#    repmgr</span>
host replication repmgr 127.0.0.1/32 trust <span class="hljs-comment">#    repmgr</span>
host replication repmgr ::1/128 trust <span class="hljs-comment">#    repmgr</span><font></font>
<font></font>
<span class="hljs-built_in">local</span> repmgr repmgr trust <span class="hljs-comment">#  repmgr  repmgr</span>
host repmgr repmgr 127.0.0.1/32 trust <span class="hljs-comment">#  repmgr  repmgr</span>
host repmgr repmgr ::1/128 trust <span class="hljs-comment">#  repmgr  repmgr</span><font></font>
EOF<font></font>
</code></pre><br>
</div>
                    </div><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja498122/index.html">è£½å“ã¨ã‚ãªãŸã®äººç”Ÿã‚’å°ç„¡ã—ã«ã—ãªã„ã‚ˆã†ã«ãƒªãƒ¢ãƒ¼ãƒˆã‚µã‚¤ãƒˆã§ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja498124/index.html">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã®é›»å ±ï¼šãƒ„ãƒ¼ãƒ«ã¨è½ã¨ã—ç©´</a></li>
<li><a href="../ja498126/index.html">ã‚¢ãƒã‚¾ãƒ³ãŒäººã€…ã«è³¼å…¥ã—ã¦ã‚‚ã‚‰ã†æ–¹æ³•...</a></li>
<li><a href="../ja498128/index.html">å•é¡Œï¼ƒ36ï¼šITãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°-ä¸»è¦ä¼æ¥­ã®ç¾åœ¨ã®å•é¡Œã¨èª²é¡Œ</a></li>
<li><a href="../ja498130/index.html">Kubernetesã‚’ä½¿ç”¨ã—ã¦Golangã®TODO APIã‚’ä½œæˆã™ã‚‹</a></li>
<li><a href="../ja498134/index.html">symfony 5ãƒãƒ³ãƒ‰ãƒ«ã§ã‚³ãƒ¼ãƒ‰ã‚’å†åˆ©ç”¨ã™ã‚‹æ–¹æ³•ï¼Ÿãƒ‘ãƒ¼ãƒˆ1.æœ€å°ãƒãƒ³ãƒ‰ãƒ«</a></li>
<li><a href="../ja498136/index.html">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœªæ¥ã¨ç¾åœ¨ã«ã¤ã„ã¦ã®ãƒãƒªãƒ¼ãƒŠã‚°ãƒ«ãƒˆãƒã¨ã®ä¼šè©±ã€‚DUMP 2020ä¸»å‚¬è€…ã¯ã„ãã¤ã‹ã®é‡è¦ãªè³ªå•ã‚’ã—ã¾ã™ã€‚</a></li>
<li><a href="../ja498138/index.html">å­¦éƒ¨ç ”ç©¶å¾Œã®ç”Ÿæ´»ï¼šé«˜ç­‰æ•™è‚²ã¨ä»•äº‹ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã«æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹ã‚’ã©ã®ã‚ˆã†ã«æ±ºå®šã—ãŸã‹</a></li>
<li><a href="../ja498140/index.html">ã“ã‚Œã‚’è¤‡è£½ã—ã¾ã™ã€‚ã‚¦ã‚§ãƒ“ãƒŠãƒ¼Apache IgniteãŠã‚ˆã³GridGain</a></li>
<li><a href="../ja498144/index.html">ã¯ã˜ã‚ã¦ã®BERTï¼šã‚¤ãƒ©ã‚¹ãƒˆä»˜ãã‚¬ã‚¤ãƒ‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>