<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõï üë©üèæ‚Äçü§ù‚Äçüë©üèº üíÉüèæ An√°lise on-line na arquitetura de microsservi√ßos: ajude e sugira o Postgres FDW e o Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂–∏Ã∂—Ç e o ‚õèÔ∏è üë©‚Äçüë©‚Äçüë¶ ‚õ≥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A arquitetura de microsservi√ßos, como tudo neste mundo, tem seus pr√≥s e contras. Alguns processos tornam-se mais f√°ceis, outros mais complicados. E po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>An√°lise on-line na arquitetura de microsservi√ßos: ajude e sugira o Postgres FDW e o Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂–∏Ã∂—Ç e o</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A arquitetura de microsservi√ßos, como tudo neste mundo, tem seus pr√≥s e contras. Alguns processos tornam-se mais f√°ceis, outros mais complicados. E por uma quest√£o de velocidade da mudan√ßa e melhor escalabilidade, sacrif√≠cios devem ser feitos. Um deles √© a complica√ß√£o da an√°lise. Se em um mon√≥lito todas as an√°lises operacionais podem ser reduzidas a consultas SQL para uma r√©plica anal√≠tica, em uma arquitetura multisservi√ßo, cada servi√ßo tem sua pr√≥pria base e parece que uma consulta n√£o pode ser dispensada (ou pode ser dispensada?). Para aqueles que est√£o interessados ‚Äã‚Äãem como resolvemos o problema da an√°lise operacional em nossa empresa e em como aprendemos a conviver com essa solu√ß√£o - bem-vindo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu nome √© Pavel Sivash. No DomKlik, trabalho em uma equipe respons√°vel pela manuten√ß√£o do data warehouse anal√≠tico. Convencionalmente, nossas atividades podem ser atribu√≠das √† data da engenharia, mas, de fato, a gama de tarefas √© muito maior. Existem padr√µes ETL / ELT para engenharia de datas, suporte e adapta√ß√£o de ferramentas para an√°lise de dados e desenvolvimento de suas pr√≥prias ferramentas. Em particular, para relat√≥rios operacionais, decidimos "fingir" que possu√≠mos um mon√≥lito e fornecer aos analistas uma base na qual eles ter√£o todos os dados necess√°rios.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, consideramos op√ß√µes diferentes. Foi poss√≠vel construir um reposit√≥rio completo - at√© tentamos, mas para ser sincero, falhamos em fazer amigos mudan√ßas frequentes na l√≥gica com um processo bastante lento de construir um reposit√≥rio e fazer altera√ß√µes (se algu√©m conseguiu, escreva nos coment√°rios como). Poder√≠amos dizer aos analistas: ‚ÄúPessoal, aprendem python e seguem dicas anal√≠ticas‚Äù, mas esse √© um requisito adicional para o recrutamento de funcion√°rios, e parecia que isso deveria ser evitado, se poss√≠vel. Decidimos tentar usar a tecnologia FDW (Foreign Data Wrapper): na verdade, esse √© o dblink padr√£o, que est√° no padr√£o SQL, mas com sua interface muito mais conveniente. Com base nisso, tomamos uma decis√£o, que acabou se estabelecendo, paramos nela. Seus detalhes s√£o objeto de um artigo separado, ou talvez n√£o de um,porque quero falar muito: da sincroniza√ß√£o de esquemas de banco de dados ao controle de acesso e anonimiza√ß√£o de dados pessoais. Voc√™ tamb√©m precisa fazer uma reserva de que essa solu√ß√£o n√£o substitui bancos de dados e reposit√≥rios anal√≠ticos reais, pois resolve apenas um problema espec√≠fico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De n√≠vel superior, √© assim:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe um banco de dados PostgreSQL, no qual os usu√°rios podem armazenar seus dados de trabalho e, mais importante, as r√©plicas anal√≠ticas de todos os servi√ßos s√£o conectadas a esse banco de dados atrav√©s do FDW. </font><font style="vertical-align: inherit;">Isso torna poss√≠vel escrever uma consulta em v√°rios bancos de dados, n√£o importa o que seja: PostgreSQL, MySQL, MongoDB ou qualquer outra coisa (arquivo, API, se de repente n√£o houver um inv√≥lucro adequado, voc√™ poder√° escrever seu pr√≥prio). </font><font style="vertical-align: inherit;">Bem, tudo parece ser super! </font><font style="vertical-align: inherit;">N√≥s discordamos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tudo terminasse com tanta rapidez e simplicidade, provavelmente n√£o haveria artigo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante entender claramente como o postgres lida com solicita√ß√µes para servidores remotos. </font><font style="vertical-align: inherit;">Isso parece l√≥gico, mas muitas vezes eles n√£o prestam aten√ß√£o a isso: o postgres divide a solicita√ß√£o em partes que s√£o executadas em servidores remotos de forma independente, coleta esses dados e os c√°lculos finais s√£o executados por si s√≥, portanto a velocidade da solicita√ß√£o depende muito de como ela √© escrita. </font><font style="vertical-align: inherit;">Tamb√©m deve ser observado: quando os dados v√™m de um servidor remoto, eles n√£o t√™m mais √≠ndices, n√£o h√° nada que possa ajudar o agendador; portanto, somente n√≥s podemos ajudar e sugerir. </font><font style="vertical-align: inherit;">E eu gostaria de falar mais sobre isso.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pedido simples e plano com ele</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mostrar como o postgres executa uma consulta em uma tabela de 6 milh√µes de linhas em um servidor remoto, vejamos um plano simples.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O uso da instru√ß√£o VERBOSE permite visualizar a solicita√ß√£o que ser√° enviada ao servidor remoto e os resultados que receberemos para processamento adicional (linha RemoteSQL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos um pouco mais al√©m e adicione v√°rios filtros √† nossa consulta: um pelo </font><font style="vertical-align: inherit;">campo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">booleano</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um pelo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carimbo de data / hora</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no intervalo e um pelo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que est√° o momento em que voc√™ precisa prestar aten√ß√£o ao escrever consultas. </font><font style="vertical-align: inherit;">Os filtros n√£o foram transferidos para o servidor remoto, o que significa que, para execut√°-lo, o postgres estende todas as 6 milh√µes de linhas, s√≥ ent√£o para filtrar localmente (linha de filtro) e executar a agrega√ß√£o. </font><font style="vertical-align: inherit;">A chave do sucesso √© escrever uma solicita√ß√£o para que os filtros sejam transferidos para a m√°quina remota e recebamos e agregamos apenas as linhas necess√°rias.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© alguma merda booleana</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com campos booleanos, tudo √© simples. </font><font style="vertical-align: inherit;">Na solicita√ß√£o original, o problema ocorreu devido √† instru√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se o substituirmos por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , obteremos o seguinte resultado:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, o filtro voou para um servidor remoto e o tempo de execu√ß√£o foi reduzido de 27 para 19 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale ressaltar que o operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> difere do operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">pois ele pode trabalhar com o valor nulo. </font><font style="vertical-align: inherit;">Isso significa que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no filtro deixar√° Falso e Nulo, enquanto </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deixar√° apenas Falso. </font><font style="vertical-align: inherit;">Portanto, ao substituir o </font><font style="vertical-align: inherit;">operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is not</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , duas condi√ß√µes com o operador OR devem ser passadas para o filtro, por exemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE (col! = True) OR (col √© nulo)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com booleano resolvido, siga em frente. </font><font style="vertical-align: inherit;">Enquanto isso, retorne o filtro pelo valor booleano √† sua forma original, para considerar independentemente o efeito de outras altera√ß√µes.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamptz? </font><font style="vertical-align: inherit;">hz</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, √© necess√°rio experimentar como escrever uma consulta que envolva servidores remotos e s√≥ ent√£o procurar uma explica√ß√£o de por que isso est√° acontecendo. Muito pouca informa√ß√£o sobre isso pode ser encontrada na Internet. Portanto, em experimentos, descobrimos que o filtro em uma data fixa voa para o servidor remoto com um estrondo, mas quando queremos definir a data dinamicamente, por exemplo, now () ou CURRENT_DATE, isso n√£o acontece. Em nosso exemplo, adicionamos um filtro para que a coluna created_at contenha dados exatamente de um m√™s no passado (BETWEEN CURRENT_DATE - INTERVAL '7 month' AND CURRENT_DATE - INTERVAL '6 month'). O que fizemos neste caso?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solicitamos que o planejador calculasse a data na subconsulta com anteced√™ncia e passasse a vari√°vel pronta para o filtro. </font><font style="vertical-align: inherit;">E essa dica nos deu um excelente resultado, a consulta ficou quase 6 vezes mais r√°pida! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Novamente, √© importante ter cuidado aqui: o tipo de dados na subconsulta deve ser o mesmo que o campo para o qual estamos filtrando; caso contr√°rio, o planejador decidir√° isso, j√° que os tipos s√£o diferentes e voc√™ deve primeiro obter todos os dados e filtr√°-los localmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retorne o filtro por data ao seu valor original.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Freddy vs. </font><font style="vertical-align: inherit;">Jsonb</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, os campos e datas booleanos j√° aceleraram nossa consulta, mas havia mais um tipo de dados. </font><font style="vertical-align: inherit;">A batalha pela filtragem, francamente, ainda n√£o acabou, embora haja sucessos. </font><font style="vertical-align: inherit;">Ent√£o, aqui est√° como conseguimos passar o </font><font style="vertical-align: inherit;">campo </font><font style="vertical-align: inherit;">filter by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o servidor remoto.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de filtrar operadores, voc√™ deve usar o operador de ter um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em outro. </font><font style="vertical-align: inherit;">7 segundos em vez dos 29 iniciais. At√© agora, esta √© a √∫nica op√ß√£o bem-sucedida de transferir filtros via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um servidor remoto, mas √© importante levar em considera√ß√£o uma limita√ß√£o: usamos a vers√£o do banco de dados 9.6, no entanto, planejamos concluir os testes mais recentes e passar para a vers√£o 12 at√© o final de abril. </font><font style="vertical-align: inherit;">Como atualizar, escreva como isso foi afetado, porque h√° muitas mudan√ßas para as quais h√° muitas esperan√ßas: json_path, novo comportamento do CTE, push down (existente na vers√£o 10). </font><font style="vertical-align: inherit;">Eu gostaria de experimentar em breve.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acabe com ele</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificamos como cada altera√ß√£o afeta a velocidade da solicita√ß√£o individualmente. </font><font style="vertical-align: inherit;">Agora vamos ver o que acontece quando todos os tr√™s filtros s√£o gravados corretamente.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, a solicita√ß√£o parece mais complicada, √© uma placa for√ßada, mas a velocidade de execu√ß√£o √© de 2 segundos, o que √© 10 vezes mais r√°pido! </font><font style="vertical-align: inherit;">E estamos falando de uma consulta simples em um conjunto de dados relativamente pequeno. </font><font style="vertical-align: inherit;">Em solicita√ß√µes reais, recebemos um crescimento de v√°rias centenas de vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir: se voc√™ usa o PostgreSQL com FDW, sempre verifique se todos os filtros foram enviados para o servidor remoto e voc√™ ficar√° feliz ... Pelo menos at√© chegar √†s jun√ß√µes entre tabelas de diferentes servidores. </font><font style="vertical-align: inherit;">Mas esta √© a hist√≥ria de outro artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado pela aten√ß√£o! </font><font style="vertical-align: inherit;">Ficarei feliz em ouvir perguntas, coment√°rios e hist√≥rias sobre sua experi√™ncia nos coment√°rios.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498002/index.html">Guia de bolso para o Z3</a></li>
<li><a href="../pt498004/index.html">Esta√ß√£o de trabalho em um cont√™iner de docker</a></li>
<li><a href="../pt498006/index.html">Escolhendo um advogado de patentes</a></li>
<li><a href="../pt498012/index.html">Mikrotik RouterOS no Docker com Qemu</a></li>
<li><a href="../pt498014/index.html">PyDERASN: como adicionei o suporte a big data</a></li>
<li><a href="../pt498020/index.html">Cerca de um indicador aplic√°vel √† avalia√ß√£o visual de fun√ß√µes que crescem rapidamente</a></li>
<li><a href="../pt498022/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 341 (de 13 a 19 de abril)</a></li>
<li><a href="../pt498024/index.html">Construindo cidades com um clique do mouse com Houdini e Python</a></li>
<li><a href="../pt498026/index.html">FOSS News No. 12 - revis√£o de not√≠cias gratuitas e de c√≥digo aberto de 13 a 19 de abril de 2020</a></li>
<li><a href="../pt498028/index.html">Simula√ß√£o pand√™mica de Python COVID-19</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>