<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏽 👨🏽‍🎓 👩🏼‍🤝‍👨🏾 werf-KubernetesのCI / CD用ツール（レビューとビデオレポート） 😳 🧔🏻 🧗🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="5月27日、RIT ++ 2019フェスティバルの一部として開催されたDevOpsConf 2019カンファレンスのメインホールで、継続的デリバリーセクションの一部として、「werfはKubernetesのCI / CDのツールです」というレポートが作成されました。Kubernetesにデプロイする...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>werf-KubernetesのCI / CD用ツール（レビューとビデオレポート）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/460351/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5月27日、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RIT ++ 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フェスティバルの一部として開催されたDevOpsConf 2019カンファレンスのメインホールで、</font><font style="vertical-align: inherit;">継続的デリバリーセクションの一部として、「werfはKubernetesのCI / CDのツールです」というレポートが作成されました。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesにデプロイするときに誰もが直面</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font><b><font style="vertical-align: inherit;">問題と課題、および</font></b><font style="vertical-align: inherit;">すぐには気付かない可能性があるニュアンスについて説明します。可能なソリューションを分析し、これが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open Sourceツールでどのように実装されているかを示します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのパフォーマンス以来、私たちのユーティリティ（以前はdappと呼ばれていました）は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、GitHub</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font><b><font style="vertical-align: inherit;">1000スター</font></b><font style="vertical-align: inherit;">という歴史的な制限を克服しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lh/k9/x1/lhk9x1wf3gzo6bk1lsjosnvjg1g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、私たち</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;">はレポートでビデオ</font></b></a><font style="vertical-align: inherit;">を提示します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（〜47分、記事よりもはるかに有益）およびテキスト形式での主な抜粋。</font><font style="vertical-align: inherit;">行こう！</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesでのコード配信</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
話はもはやwerfについてではなく、KubernetesのCI / CDについてであり、私たちのソフトウェアはDockerコンテナーにパッケージ化されていることを意味し</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年のレポートで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これについて話しまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、K8を使用して本番環境で起動します</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（これについて- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017年</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes配信はどのように見えますか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードとそれを構築するための手順を含むGitリポジトリがあります。</font><font style="vertical-align: inherit;">アプリケーションはDockerイメージにコンパイルされ、Dockerレジストリに公開されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じリポジトリに、アプリケーションをデプロイして実行する方法に関する説明があります。</font><font style="vertical-align: inherit;">デプロイの段階で、これらの指示はKubernetesに送信されます。Kubernetesはレジストリから目的のイメージを受け取り、それを起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに、通常はテストがあります。</font><font style="vertical-align: inherit;">それらのいくつかは、イメージを公開するときに実行できます。</font><font style="vertical-align: inherit;">（同じ手順で）アプリケーションのコピーを（別のK8s名前空間または別のクラスターに）デプロイして、そこでテストを実行することもできます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 最後に、Git（またはボタンのクリック）からイベントを受け取り、ビルド、パブリッシュ、デプロイ、テストのすべての示されたステージを呼び出すCIシステムが必要です。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/vd/jh/ks/vdjhksq3874swybast6v7oerqe4.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここにいくつかの重要な注意事項があります：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不変のインフラストラクチャ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不変のインフラ</font><i><font style="vertical-align: inherit;">ストラクチャ）</font></i><font style="vertical-align: inherit;">、つまりすべての段階（ステージング、プロダクションなど）で使用されるアプリケーションのイメージ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があるので、1つ必要</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はこれについて、そして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で例を挙げてもっと話し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font></font></i></li>
<li>        <i>(IaC)</i>,  ,         <b>   </b>. <i>   — .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.</i></li>
<li>   <i>(delivery)</i>    :  , ,  <i>( release)</i>   —  .       ,   , <b></b> ,      production,         production .   ,     <b>   </b> <i>(run)</i>,    ,     ,     production (   ).</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のKubernetesで示した配信方式に戻りましょう。それは私たちだけでなく、文字通りこの問題に対処したすべての人によって発明されました。</font><font style="vertical-align: inherit;">本質的に、このパターンは現在GitOpsと呼ばれています</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（この用語の詳細とその背後にあるアイデアは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">スキームの段階を見てみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルド段階</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰もがDockerfilesを記述して実行する方法を知っている場合、2019年にDockerイメージのアセンブリについて伝えることができるよう</font></font><code>docker build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。ここで、私が注目したいニュアンスを示します。</font></font><br>
<br>
<ol>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像の重みが</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要なので</font><font style="vertical-align: inherit;">、画像に本当に必要なアプリケーションだけを残すには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチステージ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">します。</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイヤー数は</font></font></b><font style="vertical-align: inherit;"></font><code>RUN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、意味的</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">-コマンド</font><font style="vertical-align: inherit;">のチェーンを組み合わせることにより最小限に抑える必要が</font><font style="vertical-align: inherit;">あります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、これは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題に追加されます。これは</font><font style="vertical-align: inherit;">、アセンブリがクラッシュしたときに、問題の原因となったチェーンから必要なコマンドを見つける必要があるためです。</font></font></li>
<li> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更をすばやく展開して結果を確認するため、</font><b><font style="vertical-align: inherit;">ビルド速度は</font></b><font style="vertical-align: inherit;">重要です。</font><font style="vertical-align: inherit;">たとえば、アプリケーションのビルドごとに言語ライブラリの依存関係を再構築したくありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの場合、1つのGitリポジトリから</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くのイメージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要です</font><font style="vertical-align: inherit;">。これらの</font><b><font style="vertical-align: inherit;">イメージ</font></b><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、一連のDockerfiles（または単一ファイルの名前付きステージ）と、順次アセンブリを含むBashスクリプトによって解決できます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは誰もが直面している氷山の一角にすぎませんでした。</font><font style="vertical-align: inherit;">しかし、他の問題があり、特に：</font></font><br>
<br>
<ol>
<li>       - <b></b> (,     apt'   ).</li>
<li>   <b>Ansible</b>  ,    shell'.</li>
<li>   <b>  Docker</b> (    ,       ,     Kubernetes,     ?).</li>
<li> <b> </b>,    -:    Dockerfile (  multi-stage),    ,  Dockerfile'.</li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散型アセンブリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：「一時的な」ポッドで何かを収集したいので、</font><font style="vertical-align: inherit;">キャッシュが消えます。つまり、別の場所に保存する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に、私は欲望</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頂点を</font><b><font style="vertical-align: inherit;">autoguy</font></b><font style="vertical-align: inherit;">と呼び</font><font style="vertical-align: inherit;">ました。リポジトリに移動し、チームを入力して既製のイメージを取得し、正しい方法と正しい方法を理解して組み立てることが理想的です。</font><font style="vertical-align: inherit;">ただし、個人的には、この方法ですべてのニュアンスを予測できるかどうかはわかりません。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてここにプロジェクトがあります：</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moby / buildkit-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらすべての問題を解決しようとしているDocker Inc（現在のバージョンのDockerにすでに統合されている）の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ビルダー</font></a><font style="vertical-align: inherit;">。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kaniko</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -DockerなしでビルドできるGoogleのコレクター。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buildpacks.io-自動</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マジックを実行するためのCNCFの試み、特に、レイヤーのリベースを使用した興味深いソリューション。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buildah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本物のツール/ imgの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ような他のユーティリティの束</font><font style="vertical-align: inherit;">...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...そして、GitHubに星がいくつあるかを確認します。</font><font style="vertical-align: inherit;">つまり、一方で</font></font><code>docker build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は何かがあり、何かを行うことができますが、実際には</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題は完全には解決されていません。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、それぞれが問題の一部を解決する代替コレクターの並行開発によって証明されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">造園</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、私たちは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf </font></font></a> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（以前</font><font style="vertical-align: inherit;">はdappと</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼ば</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れていました）-Flant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のオープンソースユーティリティに着きました。</font><font style="vertical-align: inherit;">それはすべて、約5年前にDockerfileのアセンブリを最適化するBashスクリプトで始まり、最後の3年間は、独自のGitリポジトリを備えた1つのプロジェクトのフレームワーク内で完全に開発されました</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（最初はRubyで、次に</font><font style="vertical-align: inherit;">Goに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き直さ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、同時に名前が変更されました）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">werfで解決されたビルドの問題は何ですか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/--/1-/ca/--1-cakzswwfhrcrgnees6cvf-a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
青色の網掛けの問題はすでに実装されており、並列アセンブリは同じホスト内で行われており、黄色のハイライトされた質問は夏の終わりまでに完了する予定です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリでの公開の段階（公開）</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入力された...- </font></font><code>docker push</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリに画像をアップロードする際に難しいことは何ですか？次に、「画像を配置するためのタグは何か」という質問が発生します。これは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（または別のGit戦略）とKubernetesがあり、Kubernetesで起こっていることがGitで行われていることに従うようにすることを業界が約束しているために発生します。 Gitは唯一の真の情報源です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これについて何がそれほど複雑なのですか？</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再現性を確保する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：本質的に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不変</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">あるGitでのコミットから</font><font style="vertical-align: inherit;">、同じに保つ必要があるDockerイメージまで。</font><b><font style="vertical-align: inherit;">起源</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font><b><font style="vertical-align: inherit;">特定する</font></b><font style="vertical-align: inherit;">ことも重要です</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜなら、Kubernetesで起動されたアプリケーションがどのコミットから構築されたのかを理解したいからです（それから、diffなどを実行できます）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タグ付け戦略</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ目は単純な</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gitタグ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。としてタグ付けされた画像のレジストリがあります</font></font><code>1.0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Kubernetesにはステージとプロダクションがあり、このイメージがポンプされます。 Gitでは、コミットを行い、ある時点でタグを付け</font></font><code>2.0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。リポジトリからの指示に従ってそれを収集し、タグを付けてレジストリに入れます</font></font><code>2.0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。私たちはステージで展開し、すべてが順調であれば、本番環境で展開します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/ub/u4/4fubu4r-0obh9gkzs4_kftnlqxs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの問題は、最初にタグを設定し、それから初めてテストしてロールアウトすることです。どうして？まず、これは単に非論理的です。テストしていないソフトウェアのバージョンを提供します（チェックするためにタグを付ける必要があるため、他の方法では実行できません）。次に、この方法はGitflowと互換性がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のオプションは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">git commit + tag</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。マスターブランチにタグがあります</font></font><code>1.0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;レジストリで彼のために-本番にデプロイされたイメージ。さらに、Kubernetesクラスターにはプレビューループとステージングループがあります。次にGitflowをフォローします。開発のメインブランチ（</font></font><code>develop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）で新しい機能を作成します。その結果、コミットが識別子とともに表示され</font></font><code>#c1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これを収集し、この識別子（</font></font><code>#c1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を使用してレジストリに公開します</font><font style="vertical-align: inherit;">。同じ識別子でプレビューをロールアウトします。コミット</font></font><code>#c2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">やで</font><font style="vertical-align: inherit;">も同じことを</font><font style="vertical-align: inherit;">し</font></font><code>#c3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
十分な機能があることに気づいたとき、私たちはすべてを安定させ始めます。 Gitで</font></font><code>release_1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><code>#c3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fromに</font><font style="vertical-align: inherit;">基づいて</font></font><code>develop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">ブランチを作成します</font><font style="vertical-align: inherit;">。このリリースを収集する必要はありません。これは前のステップで行われました。したがって、ステージングに展開できます。バグを修正します</font></font><code>#c4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージングにも同様に展開します。同時に、で開発が進んで</font></font><code>develop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おり、定期的に変更が加えられてい</font></font><code>release_1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。ある時点で、コミットが収集され、ステージングにデフレートされます（これで満足</font></font><code>#c25</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font></font><code>release_1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、masterで</font><font style="vertical-align: inherit;">リリースブランチ（</font><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">（早送りで）マージし</font><font style="vertical-align: inherit;">ます。このコミットに新しいバージョン（</font></font><code>1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">タグを付け</font><font style="vertical-align: inherit;">ます。ただし、このイメージは既にレジストリに組み込まれているため、再度収集しないようにするために、2つ目のタグを既存のイメージに追加します（現在、レジストリに</font></font><code>#c25</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">タグがあります</font></font><code>1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。その後、本番環境に展開します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのイメージ（</font></font><code>#c25</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が</font><font style="vertical-align: inherit;">ステージング</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">収縮し</font><font style="vertical-align: inherit;">、別の</font><font style="vertical-align: inherit;">イメージ（</font><font style="vertical-align: inherit;">）が本番</font></font><code>1.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ソート</font><font style="vertical-align: inherit;">さ</font><font style="vertical-align: inherit;">れるという欠点がありますが、</font><font style="vertical-align: inherit;">「物理的に」レジストリからの同じイメージであることはわかっています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/pq/iu/mbpqiumzomvrouhp8llx5aishza.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本当のマイナスは、merge commit'ovのサポートがないことです。早送りする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたはさらに進んでトリックを行うことができます...単純なDockerfileの例を考えてみましょう：</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM ruby:2.3 as assets<font></font>
RUN mkdir -p /app<font></font>
WORKDIR /app<font></font>
COPY . ./<font></font>
RUN gem install bundler &amp;&amp; bundle install<font></font>
RUN bundle exec rake assets:precompile<font></font>
CMD bundle exec puma -C config/puma.rb<font></font>
<font></font>
FROM nginx:alpine<font></font>
COPY --from=assets /app/public /usr/share/nginx/www/public</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この原則に従ってファイルからファイルを作成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">識別子からのSHA256 </font><font style="vertical-align: inherit;">は、その内容のチェックサムである</font><font style="vertical-align: inherit;">イメージ（</font></font><code>ruby:2.3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>nginx:alpine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">ました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのコマンド（</font></font><code>RUN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>CMD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 追加されたファイルのSHA256。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...そのようなファイルからチェックサム（ここでもSHA256）を取得します。</font><font style="vertical-align: inherit;">これは、</font><font style="vertical-align: inherit;">Dockerイメージのコンテンツを定義するすべて</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">署名です</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/w2/ju/zpw2jup54xa66mit1bt9u7amwlk.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームに戻りましょう。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コミットの代わりに、そのような署名を使用します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">画像に署名を付けます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pr/d3/wf/prd3wfn6ctkod9ddqqmgtqnr1ew.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、たとえば、リリースからマスターへの変更をマージする必要がある場合、実際のマージコミットを作成できます。これは、識別子は異なりますが、署名は同じです。</font><font style="vertical-align: inherit;">同じ識別子を使用して、本番環境にも画像を展開します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不利な点は、どの種類のコミットが本番環境に送り出されたかを判別することができないことです。チェックサムは一方向でのみ機能します。</font><font style="vertical-align: inherit;">この問題は、メタデータを含む追加のレイヤーによって解決されます-後で詳しく説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werfでのタグ付け</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werfでは、さらに進んで、同じマシンに格納されていないキャッシュを使用して分散アセンブリを作成する準備をしています。つまり、2つのタイプのDockerイメージがあり、それらを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イメージ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">呼びます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werf Gitリポジトリには、ビルドのさまざまな段階（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beforeInstall</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">install</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beforeSetup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">setup）</font></i><font style="vertical-align: inherit;">を説明する特定のビルド手順が格納されてい</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）最初のステップのチェックサムとして定義された署名付きの最初のステージのイメージを収集します。次に、ソースコードを追加します。新しいステージイメージのチェックサムを検討します...これらの操作はすべてのステージで繰り返され、その結果、一連のステージイメージが取得されます。次に、その起源に関するメタデータを含む最終的な画像を作成します。そして、この画像にさまざまな方法でタグを付けます（詳細は後述）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4a/uw/am/4auwamdra7bm0xtvht35kpbstye.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、アプリケーションコードのみが変更された新しいコミットを表示させます。何が起こるか？コードを変更するためのパッチが作成され、新しいステージイメージが準備されます。その署名は、古いステージイメージと新しいパッチのチェックサムとして定義されます。この画像から、新しい最終的な画像が形成されます。他の段階の変更でも同様の動作が発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ステージイメージは分散配布可能なキャッシュであり、ステージイメージはすでにそこから作成されたイメージイメージをDockerレジストリにロードします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sc/8j/me/sc8jme4f1jfqbrbwt1anf2-rja8.gif"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリのクリーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、削除されたタグの後にぶら下がったままのレイヤーを削除することではありません。これは、Dockerレジストリ自体の標準機能です。</font><font style="vertical-align: inherit;">これは、多くのDockerタグが蓄積されている状況であり、一部のタグは不要になり、スペースを占有します（またはその代金を支払う）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニング戦略は何ですか？</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何も</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">きれいに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でき</font><b><font style="vertical-align: inherit;">ません</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">タグの巨大なボールを解明するよりも、余分なスペースに少しお金を払うほうが本当に簡単な場合があります。</font><font style="vertical-align: inherit;">しかし、これはある時点までしか機能しません。</font></font></li>
<li> <b> </b>.          CI-,    .   production  ,      — ,     .    immutable infrastructure.</li>
<li> <b>Blue-green</b>.  registry   —    .    ,    :       registry,   ?</li>
<li> <b> </b>.     1 ?    ,     …</li>
<li> <b></b> ,    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの本当に実行可能なオプションがあります：クリーンアップしないか、手動で青緑+を組み合わせます。</font><font style="vertical-align: inherit;">後者の場合は、次のことを話します。レジストリをクリーンアップするタイミングがわかったときに、新しいレジストリを作成して、たとえば1か月間すべての新しいイメージを追加します。</font><font style="vertical-align: inherit;">1か月後、Kubernetesのどのポッドがまだ古いレジストリを使用しているかを確認し、それらも新しいレジストリに転送します。</font><b><font style="vertical-align: inherit;">どこへ</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
行ったの</font><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">収集：</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gitヘッド：すべてのタグ、すべてのブランチ-Gitでテストされるすべてのものを想定して、画像に必要です（そうでなければ、Git自体で削除する必要があります）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 現在Kubernetesにダウンロードされているすべてのポッド。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 古いReplicaSets（最近ポンプアウトされたもの）、およびHelmリリースをスキャンして最新のイメージをそこに選択することも計画しています。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...そして、このセットからホワイトリストを作成します-削除しない画像のリスト。</font><font style="vertical-align: inherit;">他のすべてをクリーンアップした後、孤立したステージ画像を見つけて削除します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配備段階（配備）</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">堅牢な宣言性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デプロイメントで注意したい最初のポイントは、宣言的に宣言された更新済みのリソース構成をロールアウトすることです。</font><font style="vertical-align: inherit;">Kubernetesリソースを説明する元のYAMLドキュメントは、クラスターで実際に機能する結果と常に大きく異なります。</font><font style="vertical-align: inherit;">Kubernetesが構成に追加されるため：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 識別子</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> サービス情報;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 多くのデフォルト値。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 現在のステータスのセクション。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> アドミッションWebhookの一部として行われた変更。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> さまざまなコントローラー（およびスケジューラー）の作業の結果。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、新しいリソース構成（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">が表示さ</font><font style="vertical-align: inherit;">れた場合、現在の「ライブ」構成（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">live</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">取得して上書きすることはできません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを行うには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を最後に適用された（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に適用された</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">構成</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">比較し</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">結果のパッチ</font><font style="vertical-align: inherit;">を</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">liveに</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">適用</font></i><font style="vertical-align: inherit;">する必要が</font><font style="vertical-align: inherit;">あり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">双方向マージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれ</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">たとえば、Helmで使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また</font><font style="vertical-align: inherit;">、以下の点で異なる</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3方向マージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に適用されたもの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ものを</font><font style="vertical-align: inherit;">比較する</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">、削除されたものがわかります。</font></font></li>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">liveを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比較する</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">、何が追加または変更されたかがわかります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約されたパッチを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">liveに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適用します</font><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Helmを使用して1000以上のアプリケーションをデプロイするため、実際には双方向のマージを使用しています。</font><font style="vertical-align: inherit;">ただし、Helmの正常な動作に役立つパッチを使用して解決した問題がいくつかあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際の展開状況</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のイベントの後、CIシステムはKubernetesの新しい構成を生成し、</font><font style="vertical-align: inherit;">Helmまたはを使用してクラスター</font><font style="vertical-align: inherit;">に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適用する</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ために</font><font style="vertical-align: inherit;">それを送信し</font><i><font style="vertical-align: inherit;">ます</font></i></font><code>kubectl apply</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次に、すでに説明したNウェイマージが行われ、Kubernetes APIがCIシステムを承認し、CIシステムがそのユーザーに応答します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/vh/-u/skvh-uifcwg6_d5mgxhehh39q9i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、大きな問題があります。結局のところ、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションが成功しても、展開が成功するわけではありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。適用する変更をKubernetesが理解した場合、それを適用します-結果がどうなるかはまだわかりません。たとえば、フロントエンドでのポッドの更新と再起動は成功する可能性がありますが、バックエンドでは成功せず、実行中のアプリケーションイメージの異なるバージョンを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを正しく行うために、このスキームでは追加のリンクが発生します。これは、Kubernetes APIからステータス情報を受信し、実際の状態をさらに分析するために送信する特別なトラッカーです。</font><font style="vertical-align: inherit;">この問題を解決し、werfに組み込まれ</font><font style="vertical-align: inherit;">ているGo- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubedog</font></font></b></a> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発表を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">参照</font></a><font style="vertical-align: inherit;">）に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オープンソースライブラリを作成しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このトラッカーのwerfレベルでの動作は、DeploymentまたはStatefulSetに配置された注釈を使用して構成されます。</font><font style="vertical-align: inherit;">主な注釈-- </font></font><code>fail-mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は次の意味を理解します：</font></font><br>
<br>
<ul>
<li> <code>IgnoreAndContinueDeployProcess</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -このコンポーネントのロールアウトの問題を無視して、展開を続行します。</font></font></li>
<li> <code>FailWholeDeployProcessImmediately</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -このコンポーネントのエラーにより、デプロイメントプロセスが停止します。</font></font></li>
<li> <code>HopeUntilEndOfDeployProcess</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -このコンポーネントが展開の終わりまでに機能することを願っています。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、リソースと注釈値のこのような組み合わせ</font></font><code>fail-mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/qf/ot/jaqfotxaxoxwznieu2lvnnyhih0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初めてデプロイするとき、データベース（MongoDB）はまだ準備ができていない可能性があります-デプロイメントはクラッシュします。</font><font style="vertical-align: inherit;">しかし、それが開始する瞬間まで待つことができ、デプロイメントは引き続き成功します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werfのkubedogにはさらに2つの注釈があります。</font></font><br>
<br>
<ul>
<li> <code>failures-allowed-per-replica</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -レプリカごとに許可されるドロップの数。</font></font></li>
<li> <code>show-logs-until</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-werfがロールアウトされるすべてのポッドからのログを（stdoutで）表示するまでの時間を調整します。</font><font style="vertical-align: inherit;">デフォルトでは、それ</font></font><code>PodIsReady</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（トラフィックが来るポッドを開始したとき、我々はほとんど必要ないというメッセージを無視する）だけでなく、値を許可</font></font><code>ControllerIsReady</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して</font></font><code>EndOfDeploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">展開から他に何が必要ですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに説明した2つの点に加えて、次のことを行います。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を表示</font><b><font style="vertical-align: inherit;">する</font></b><font style="vertical-align: inherit;"> -必要なだけで、すべてではありません。</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進行状況を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追跡し</font><font style="vertical-align: inherit;">ます。ジョブが数分間「サイレント」でハングした場合、そこで何が起こっているのかを理解することが重要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題が</font><font style="vertical-align: inherit;">発生した場合に</font><font style="vertical-align: inherit;">備えて</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動ロールバック</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">実行します</font></b><font style="vertical-align: inherit;">（したがって、デプロイメントの実際のステータスを知ることが重要です）。</font><font style="vertical-align: inherit;">ロールアウトはアトミックである必要があります。最後まで進むか、すべてが以前の状態に戻ります。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
会社として、私たちが説明したすべてのニュアンスをさまざまな配信段階（ビルド、パブリッシュ、デプロイ）で実装するには、CIシステムと</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティで</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">十分</font></a><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論の代わりに：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/1y/tc/ja1ytcqobpkbw5rtf78ykb4clnm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
werfを使用して、DevOpsエンジニアの多数の問題を解決する上で大きな進歩を遂げました。より広いコミュニティが少なくとも実際にこのユーティリティを試してみれば幸せです。</font><font style="vertical-align: inherit;">一緒に良い結果を出すのは簡単です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビデオとスライド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンスのビデオ（約47分）：</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/cK3ackGUTLw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レポートの提示：</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブログに関する他のKubernetesレポート：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesで自動スケーリングおよびリソース管理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドミトリーStolyarov;「ストライク」で2019年4月27日）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesの拡張と補完</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Andrey Polov; 2019年4月8日、Saint HighLoad ++）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースとKubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドミトリーStolyarov; HighLoad ++の2018年11月8日）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視とKubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドミトリーStolyarov; RootConfで2018年5月28日）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KubernetesとGitLabとベストCI / CDの実践</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドミトリーStolyarov; HighLoad ++で2017年11月7日）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Kubernetes   </a>» <i>( ; 6  2017  RootConf)</i>.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460341/index.html">ASOの継続：傾向、評価、および少しのフィードバック</a></li>
<li><a href="../ja460343/index.html">ゲーム開発が私の人生の一部になった物語</a></li>
<li><a href="../ja460345/index.html">Symfony 4にSonata Adminをインストールして設定する</a></li>
<li><a href="../ja460347/index.html">Sophos UEMによるモバイルデバイス管理など</a></li>
<li><a href="../ja460349/index.html">Check Point Falconアクセラレーションカード-トラフィック処理の高速化</a></li>
<li><a href="../ja460353/index.html">ガラスのニューラルネットワーク。電力を必要とせず、数字を認識します</a></li>
<li><a href="../ja460355/index.html">溺死を救うことは私たちのビジネスです：チームの意欲低下に対処する方法</a></li>
<li><a href="../ja460359/index.html">ヤングゲームデザイナー2コース：数学を使わずに進行とダイナミクスのバランスを取る</a></li>
<li><a href="../ja460361/index.html">医療情報システムのサイバーセキュリティに関する素晴らしいFAQ</a></li>
<li><a href="../ja460363/index.html">アプローチに欠けている7つの要素12 Factor App</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>