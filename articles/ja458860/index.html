<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏮️ 🤰🏾 👞 PostgreSQLを最適化するためのLinuxカーネルパラメータの調整 🛴 ▶️ 🙉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQLの最適なパフォーマンスは、正しく定義されたオペレーティングシステムパラメータに依存します。OSカーネルパラメータの調整が不十分な場合、データベースサーバーのパフォーマンスが低下する可能性があります。したがって、これらのパラメーターは、データベースサーバーとそのワークロードに従って...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLを最適化するためのLinuxカーネルパラメータの調整</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458860/"><img width="30%" align="left" src="https://habrastorage.org/webt/dy/qf/mh/dyqfmhq5wntmbisfsdahfiwc_-y.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLの最適なパフォーマンスは、正しく定義されたオペレーティングシステムパラメータに依存します。</font><font style="vertical-align: inherit;">OSカーネルパラメータの調整が不十分な場合、データベースサーバーのパフォーマンスが低下する可能性があります。</font><font style="vertical-align: inherit;">したがって、これらのパラメーターは、データベースサーバーとそのワークロードに従って構成する必要があります。</font><font style="vertical-align: inherit;">この投稿では、データベースサーバーのパフォーマンスに影響を与える可能性のあるいくつかの重要なLinuxカーネルパラメーターとその調整方法について説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHMMAX / SHMALL</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHMMAX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Linuxプロセスが割り当てることができる単一の共有メモリセグメントの最大サイズを決定するために使用されるカーネルパラメータ</font><b><font style="vertical-align: inherit;">です</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">バージョン9.2より前のPostgreSQLでは、SHMMAX構成が必要なSystem V（SysV）を使用していました。</font><font style="vertical-align: inherit;">9.2以降、PostgreSQLはPOSIX共有メモリに切り替わりました。</font><font style="vertical-align: inherit;">したがって、必要なSystem V共有メモリのバイト数が少なく</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なり、バージョン9.3以前は、SHMMAXが最も重要なカーネルパラメータでした。</font><font style="vertical-align: inherit;">SHMMAX値はバイト単位で指定されます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHMALL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、共有メモリのシステム全体のページサイズ</font><font style="vertical-align: inherit;">を決定するために使用される別のカーネルパラメータ</font><font style="vertical-align: inherit;">です。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipcs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを使用して、現在のSHMMAX、SHMALL、またはSHMMINの</font><i><font style="vertical-align: inherit;">値を表示します</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHM *詳細-Linux</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">$ ipcs -lm<font></font>
<font></font>
------ Shared Memory Limits --------<font></font>
max number of segments = 4096<font></font>
max seg size (kbytes) = 1073741824<font></font>
max total shared memory (kbytes) = 17179869184<font></font>
min seg size (bytes) = 1</code></pre><br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHM *詳細-MacOS X</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">$ ipcs -M<font></font>
IPC status from  as of Thu Aug 16 22:20:35 PKT 2018<font></font>
shminfo:<font></font>
	shmmax: 16777216	(max shared memory segment size)<font></font>
	shmmin:       1	(min shared memory segment size)<font></font>
	shmmni:      32	(max number of shared memory identifiers)<font></font>
	shmseg:       8	(max shared memory segments per process)<font></font>
	shmall:    1024	(max amount of shared memory <span class="hljs-keyword">in</span> pages)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System V IPC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">共有メモリを割り当てます。</font><font style="vertical-align: inherit;">このパラメータは、最も重要なカーネルパラメータの1つです。</font><font style="vertical-align: inherit;">次のエラーメッセージが表示される場合は常に、古いバージョンのPostgreSQLがあり、SHMMAX値が非常に低いことを意味します。</font><font style="vertical-align: inherit;">ユーザーは、使用する共有メモリに応じて値を調整および増加することが予想されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考えられる誤設定エラー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SHMMAXが正しく構成されていない場合、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initdb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを使用してPostgreSQLクラスターを初期化しようとするとエラーが発生することがあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initdb障害</font></font></b></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
同様に、</font><i><font style="vertical-align: inherit;">pg_ctl</font></i><font style="vertical-align: inherit;">コマンドを使用してPostgreSQLサーバーを起動すると、エラーが発生する場合があります</font><font style="vertical-align: inherit;">。</font><sup><b><font style="vertical-align: inherit;">pg_ctlの失敗</font></b></sup></font><br>
<code>DETAIL: Failed system call was shmget(key=1, size=2072576, 03600). <br>
<br>
HINT: This error usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter.&nbsp; <br>
You can either reduce the request size or reconfigure the kernel with larger SHMMAX. To reduce the request size (currently 2072576 bytes), <br>
reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections. <br>
<br>
If the request size is already small, it's possible that it is less than your kernel's SHMMIN parameter,<br>
in which case raising the request size or reconfiguring SHMMIN is called for. <br>
<br>
The PostgreSQL documentation contains more information about shared memory configuration. child process exited with exit code 1</code><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"></font></b></sup><br>
<code>DETAIL: Failed system call was shmget(key=5432001, size=14385152, 03600).<br>
<br>
HINT: This error usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter.<br>
<br>
You can either reduce the request size or reconfigure the kernel with larger SHMMAX.; To reduce the request size (currently 14385152 bytes), reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections.<br>
<br>
If the request size is already small, it's possible that it is less than your kernel's SHMMIN parameter, <br>
in which case raising the request size or reconfiguring SHMMIN is called for.<br>
<br>
The PostgreSQL documentation contains more information about shared memory configuration.</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定義の違いを理解する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LinuxとMacOS Xでは、SHMMAX / SHMALLパラメータの定義が少し異なります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux：kernel.shmmax、kernel.shmall</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOS X：kern.sysv.shmmax、kern.sysv.shmall</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sysctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コマンド</font><font style="vertical-align: inherit;">を使用して、一時的に値を変更できます。</font><font style="vertical-align: inherit;">定数値を設定するには、/ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc/sysctl.confに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリを追加し</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">詳細は以下の通りです。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOS Xでカーネル設定を変更する</font></font></b></sup><br>
<br>
<pre><code class="plaintext hljs"># Get the value of SHMMAX<font></font>
sudo sysctl kern.sysv.shmmax<font></font>
kern.sysv.shmmax: 4096<font></font>
<font></font>
# Get the value of SHMALL<font></font>
sudo sysctl kern.sysv.shmall <font></font>
kern.sysv.shmall: 4096<font></font>
<font></font>
# Set the value of SHMMAX<font></font>
sudo sysctl -w kern.sysv.shmmax=16777216<font></font>
kern.sysv.shmmax: 4096 -&gt; 16777216<font></font>
<font></font>
# Set the value of SHMALL <font></font>
sudo sysctl -w kern.sysv.shmall=16777216<font></font>
kern.sysv.shmall: 4096 -&gt; 16777216</code></pre><br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxカーネルパラメータの変更</font></font></b></sup><br>
<br>
<pre><code class="plaintext hljs"># Get the value of SHMMAX<font></font>
sudo sysctl kernel.shmmax<font></font>
kernel.shmmax: 4096<font></font>
<font></font>
# Get the value of SHMALL<font></font>
sudo sysctl kernel.shmall<font></font>
kernel.shmall: 4096<font></font>
<font></font>
# Set the value of SHMMAX<font></font>
sudo sysctl -w kernel.shmmax=16777216<font></font>
kernel.shmmax: 4096 -&gt; 16777216<font></font>
<font></font>
# Set the value of SHMALL <font></font>
sudo sysctl -w kernel.shmall=16777216<font></font>
kernel.shmall: 4096 -&gt; 16777216</code></pre><br>
<sub><b> </b>:    ,     <font color="blue">/etc/sysctl.conf</font></sub><br>
<br>
<h2>  (Huge Pages)</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linuxのデフォルトは4Kページ、BSDは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スーパーページ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Windows </font><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラージページを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">ます。ページは、プロセスに割り当てられたRAMの一部です。メモリ要件に応じて、プロセスは複数のページを持つことができます。プロセスに必要なメモリが多いほど、割り当てられるページも多くなります。 OSは、プロセスのページ割り当てテーブルをサポートしています。ページサイズが小さいほど、テーブルが大きくなり、このページテーブルでページを見つけるのに時間がかかります。したがって、大きなページを使用すると、オーバーヘッドを抑えながら大量のメモリを使用できます。ページビューの数が減り、ページエラーが減り、大きなバッファを介した読み取り/書き込み操作が速くなります。その結果、パフォーマンスが向上します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLはLinuxで大きなページのみをサポートします。</font><font style="vertical-align: inherit;">デフォルトでは、Linuxは4 KBのメモリページを使用するため、メモリ操作が多すぎる場合は、より大きなページをインストールする必要があります。</font><font style="vertical-align: inherit;">2 MBから最大1 GBの大きなページを使用すると、パフォーマンスが向上します。</font><font style="vertical-align: inherit;">起動時に大きなページサイズを設定できます。</font><font style="vertical-align: inherit;">コマンド</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cat / proc / meminfo |を</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用して、大きなページのパラメーターとLinuxコンピューターでのパラメーターの使用を簡単に確認できます</font><i><font style="vertical-align: inherit;">。</font></i><i><font style="vertical-align: inherit;">grep -i huge</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラージページに関する情報の取得（Linuxのみ）</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">Note: This is only <span class="hljs-keyword">for</span> Linux, <span class="hljs-keyword">for</span> other OS this operation is ignored$ cat /proc/meminfo | grep -i huge<font></font>
AnonHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
ShmemHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
HugePages_Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
HugePages_Free:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
HugePages_Rsvd:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
HugePages_Surp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
Hugepagesize:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2048 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、ラージページサイズが2048（2 MB）に設定されていますが、ラージページの総数は0です。これは、ラージページが無効になっていることを意味します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなページの数を決定するためのスクリプト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この簡単なスクリプトは、必要な数の大きなページを返します。</font><font style="vertical-align: inherit;">PostgreSQLの実行中にLinuxサーバーでスクリプトを実行します。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ PGDATA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境変数に</font><font style="vertical-align: inherit;">PostgreSQLデータディレクトリが設定さ</font><font style="vertical-align: inherit;">れていることを確認します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なラージページの数を取得する</font></font></b></sup><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
pid=`head -1 <span class="hljs-variable">$PGDATA</span>/postmaster.pid`
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Pid:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-variable">$pid</span>"</span>
peak=`grep ^VmPeak /proc/<span class="hljs-variable">$pid</span>/status | awk <span class="hljs-string">'{ print $2 }'</span>`
<span class="hljs-built_in">echo</span> <span class="hljs-string">"VmPeak:&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-variable">$peak</span> kB"</span>
hps=`grep ^Hugepagesize /proc/meminfo | awk <span class="hljs-string">'{ print $2 }'</span>`
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Hugepagesize:&nbsp;&nbsp; <span class="hljs-variable">$hps</span> kB"</span><font></font>
hp=$((peak/hps))<font></font>
<span class="hljs-built_in">echo</span> Set Huge Pages:&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-variable">$hp</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプト出力は次のとおりです。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプト出力</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">Pid:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12737<font></font>
VmPeak:&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;180932 kB<font></font>
Hugepagesize:&nbsp;&nbsp; 2048 kB<font></font>
Set Huge Pages: 88</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラージページの推奨値は88なので、88に設定する必要があります。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラージページのインストール</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">sysctl -w vm.nr_hugepages=88</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで大きなページを確認すると、大きなページが使用されていないことがわかります（HugePages_Free = HugePages_Total）。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなページに関する情報（Linuxのみ）</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">$ cat /proc/meminfo | grep -i huge<font></font>
AnonHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
ShmemHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
HugePages_Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 88<font></font>
HugePages_Free:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 88<font></font>
HugePages_Rsvd:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
HugePages_Surp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
Hugepagesize:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2048 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
huge_pagesを$ PGDATA / postgresql.confに「on」に設定して、サーバーを再起動します。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、大きなページに関する情報（Linuxのみ）</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">$ cat /proc/meminfo | grep -i huge<font></font>
AnonHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
ShmemHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
HugePages_Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 88<font></font>
HugePages_Free:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 81<font></font>
HugePages_Rsvd:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;64<font></font>
HugePages_Surp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
Hugepagesize:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2048 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、使用されている大きなページがほとんどないことがわかります。</font><font style="vertical-align: inherit;">次に、データベースにデータを追加してみましょう。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなページをリサイクルするためのいくつかのデータベース操作</font></font></b></sup><br>
<br>
<pre><code class="sql hljs">postgres=<span class="hljs-comment"># CREATE TABLE foo(a INTEGER);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span>
postgres=<span class="hljs-comment"># INSERT INTO foo VALUES(generate_Series(1,10000000));</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-number">0</span> <span class="hljs-number">10000000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前よりも大きなページを使用しているかどうかを確認します。</font></font><br>
<br>
<sup><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラージページに関する情報（Linuxのみ）</font></font></b></sup><br>
<br>
<pre><code class="bash hljs">$ cat /proc/meminfo | grep -i huge<font></font>
AnonHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
ShmemHugePages:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 kB<font></font>
HugePages_Total:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 88<font></font>
HugePages_Free:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18<font></font>
HugePages_Rsvd:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<font></font>
HugePages_Surp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<font></font>
Hugepagesize:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2048 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、大きなページのほとんどが使用中であることがわかります。</font></font><br>
<br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：ここで使用されるHugePagesの概算値は非常に低く、食品環境のマシンでは通常の値ではありません。</font><font style="vertical-align: inherit;">システムに必要なページ数を評価し、負荷とリソースに応じて適切に設定してください。</font></font></sub><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.swappiness</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.swappiness</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、データベースのパフォーマンスに影響を与える可能性がある別のカーネルパラメータです。このパラメーターは、Linuxでのswappiness動作（メモリーとのページのスワップ）を制御するために使用されます。値の範囲は0〜100です。これは、アンロードまたはアンロードされるメモリの量を決定します。ゼロは交換を無効にすることを意味し、100は積極的な交換を意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低い値を設定することで、良いパフォーマンスを得ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいカーネルで値を0に設定すると、OOMキラー（Linuxメモリクリーンアッププロセス）がプロセスを強制終了する可能性があります。</font><font style="vertical-align: inherit;">したがって、スワッピングを最小限にしたい場合は、値を安全に1に設定できます。</font><font style="vertical-align: inherit;">Linuxのデフォルト値は60です。値が大きいほど、MMU（メモリ管理ユニット）はRAMよりも多くのページングスペースを使用します。値が小さいほど、より多くのデータ/コードをメモリに保存します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低い値は、PostgreSQLのパフォーマンスを向上させるための良い策です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.overcommit_memory / vm.overcommit_ratio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションはメモリを受け取り、不要になったときにメモリを解放します。</font><font style="vertical-align: inherit;">ただし、場合によっては、アプリケーションが取得するメモリが多すぎて解放されません。</font><font style="vertical-align: inherit;">これにより、OOMキラーが発生する可能性があります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.overcommit_memory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータの可能な値と、</font><font style="vertical-align: inherit;">それぞれの説明を</font><b><font style="vertical-align: inherit;">次に示し</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒューリスティックオーバーコミット（デフォルト）; </font><font style="vertical-align: inherit;">コアベースのヒューリスティック</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> とにかくオーバーコミットを許可する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> やり過ぎないでください。オーバーコミット率を超えないでください。</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンク：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;"> : </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//www.kernel.org/doc/Documentation/vm/overcommit-accounting vm.overcommit_ratio-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーバーロードに使用できるRAMの割合。</font><font style="vertical-align: inherit;">2 GBのRAMを搭載したシステムの値が50％の場合、最大3 GBのRAMを割り当てることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vm.overcommit_memoryの値を2にすると、PostgreSQLのパフォーマンスが向上します。この値は、OOMキラープロセスによって強制終了される重大なリスクなしに、サーバープロセスによるRAM使用を最大化します。アプリケーションは再起動することができますが、浪費内に限られます。これにより、OOMキラーがプロセスを強制終了するリスクが軽減されます。したがって、値2を指定すると、デフォルト値の0よりもパフォーマンスが向上します。ただし、許容範囲外のメモリが過負荷にならないようにすることで、信頼性を向上させることができます。これにより、プロセスがOOMキラーによって強制終了されるリスクがなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非ページングシステムでは、vm.overcommit_memoryが2に等しい問題がある可能性があり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます。https：</font></a><font style="vertical-align: inherit;"> //www.postgresql.org/docs/current/static/kernel-resources.html#LINUX-MEMORY-OVERCOMMIT</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_background_ratio / vm.dirty_background_bytes</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_background_ratio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ディスクに書き込む必要のあるダーティページで満たされたメモリの割合です。</font><font style="vertical-align: inherit;">バックグラウンドでディスクにリセットします。</font><font style="vertical-align: inherit;">このパラメーターの値の範囲は0〜100です。</font><font style="vertical-align: inherit;">ただし、5未満の値は非効率的であり、一部のカーネルはそれをサポートしていません。</font><font style="vertical-align: inherit;">ほとんどのLinuxシステムでは、10がデフォルト値です。</font><font style="vertical-align: inherit;">集中的な記録操作のパフォーマンスを低いレートで改善できます。これは、Linuxがダーティページをバックグラウンドでダンプすることを意味します。</font><font style="vertical-align: inherit;">ディスクの速度に応じて、</font><b><font style="vertical-align: inherit;">vm.dirty_background_bytes</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の値を設定する必要が</font><font style="vertical-align: inherit;">あります。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの2つのパラメーターはどちらもハードウェアに依存しているため、「適切な」値はありません。</font><font style="vertical-align: inherit;">ただし、vm.dirty_background_ratioを5に設定し、ディスク速度の25％でvm.dirty_background_bytesを設定すると、ほとんどの場合、パフォーマンスが約25％に向上します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_ratio / dirty_bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_background_ratio / dirty_background_bytes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と同じ</font><font style="vertical-align: inherit;">ですが、リセットが作業セッションで実行され、アプリケーションがブロックされる点が</font><b><font style="vertical-align: inherit;">異なり</font></b><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">したがって、vm.dirty_ratioはvm.dirty_background_ratioより高くする必要があり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これにより、アプリケーションのブロックをできるだけ回避するために、バックグラウンドプロセスがより早く開始されます。</font><font style="vertical-align: inherit;">ディスクI / O負荷に応じて、これら2つの比率の差を調整できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のパラメータを設定して生産性を向上させることはできますが、改善は最小限であり、あまりメリットがありません。</font><font style="vertical-align: inherit;">すべてのパラメータがすべてのタイプのアプリケーションに適用されるわけではないことを覚えておく必要があります。</font><font style="vertical-align: inherit;">一部のアプリケーションは、一部の設定を構成するとより適切に機能し、一部のアプリケーションは機能しません。</font><font style="vertical-align: inherit;">予想されるワークロードに対するこれらのパラメーターの構成とアプリケーションのタイプの適切なバランスを見つける必要があります。また、構成する際には、OSの動作を考慮する必要があります。</font><font style="vertical-align: inherit;">カーネルパラメータの設定は、データベースパラメータの調整ほど簡単ではありません。ここで推奨することは困難です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458846/index.html">Unityを使用して別のプラットフォーマーを開発する方法。別のチュートリアル</a></li>
<li><a href="../ja458848/index.html">Rust 1.36.0リリース：将来の特性、割り当ての安定化、MaybeUninit <T></a></li>
<li><a href="../ja458850/index.html">安く効率的に英語を学びましょう。パート2</a></li>
<li><a href="../ja458854/index.html">MotionLayout：アニメーションの方が優れ、コードが少ない</a></li>
<li><a href="../ja458856/index.html">安くて高価な単4電池</a></li>
<li><a href="../ja458864/index.html">TamTamのボット開発者コンテスト</a></li>
<li><a href="../ja458866/index.html">World of Tanks Blitzでのチームバランサーの仕組み</a></li>
<li><a href="../ja458868/index.html">ビッグデータのノイズ。エントロピー分析</a></li>
<li><a href="../ja458874/index.html">ASOチェックリスト：テキストの最適化</a></li>
<li><a href="../ja458876/index.html">フライデーミニCTF</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>