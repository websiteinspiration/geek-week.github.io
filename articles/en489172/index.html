<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüíº ü¶Ç üî£ We fasten ActiveDirectory authorization to Kubernetes with Keycloak üìô üöä üé¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was written in order to expand an existing one , but talks about the features of the bundle with Microsoft ActiveDirectory, as well as co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We fasten ActiveDirectory authorization to Kubernetes with Keycloak</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489172/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article was written in order to expand an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existing one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but talks about the features of the bundle with Microsoft ActiveDirectory, as well as complements it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will tell you how to install and configure:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an open source project. </font><font style="vertical-align: inherit;">Which provides a single entry point for applications. </font><font style="vertical-align: inherit;">It works with many protocols, including the LDAP and OpenID that interest us.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloak gatekeeper</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - reverse proxy application that allows you to integrate authorization through Keycloak.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gangway</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the application that generates a config for kubectl with which you can log in and connect to the Kubernetes API via OpenID</font></font></li>
</ul><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How rights work in Kubernetes.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can manage user / group rights using RBAC, a lot of articles have already been created about this, I will not dwell on this in detail. </font><font style="vertical-align: inherit;">The problem is that you can use RBAC to restrict user rights, but Kubernetes doesn't know anything about users. </font><font style="vertical-align: inherit;">It turns out that you need a user delivery mechanism in Kubernetes. </font><font style="vertical-align: inherit;">To do this, we will add an OpenID provider to Kuberntes, which will say that such a user really exists, and Kubernetes itself will give rights to it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You will need a Kubernetes cluster or minikube</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Active Directory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domains: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 keycloak.example.org </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 kubernetes-dashboard.example.org </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 gangway.example.org</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certificate for domains or self-signed certificate</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not dwell on how to create a self-signed certificate, you need to create 2 certificates, this is the root (Certificate Authority) and wildcard client for the * .example.org domain </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you receive / write the certificates, the client must be added to Kubernetes, for this create a secret for it:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl create secret tls tls-keycloak --cert=example.org.crt --key=example.org.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next we will use it for our Ingress controller</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install Keycloak</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided that the easiest way to use ready-made solutions for this, namely helm chart-s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the repository and update it:</font></font><br>
<br>
<pre><code class="bash hljs">helm repo add codecentric https://codecentric.github.io/helm-charts<font></font>
helm repo update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the keycloak.yml file with the following contents:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keycloak.yml</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">keycloak:<font></font>
  #  <font></font>
  username: "test_admin"<font></font>
  #    <font></font>
  password: "admin"<font></font>
  #         Keycloak    web .   <font></font>
       ,   .<font></font>
  extraArgs: "-Dkeycloak.profile.feature.script=enabled -Dkeycloak.profile.feature.upload_scripts=enabled" <font></font>
  #  ingress,           secrets<font></font>
  ingress:<font></font>
    enabled: true <font></font>
    path: /<font></font>
    annotations:<font></font>
      kubernetes.io/ingress.class: nginx<font></font>
      ingress.kubernetes.io/affinity: cookie<font></font>
    hosts:<font></font>
      - keycloak.example.org<font></font>
    tls:<font></font>
    - hosts:<font></font>
        - keycloak.example.org<font></font>
      secretName: tls-keycloak<font></font>
  # Keycloak      ,      Postgresql   Kuberntes,      !<font></font>
  persistence:<font></font>
    deployPostgres: true<font></font>
    dbVendor: postgres<font></font>
<font></font>
postgresql:<font></font>
  postgresUser: keycloak<font></font>
  postgresPassword: ""<font></font>
  postgresDatabase: keycloak<font></font>
  persistence:<font></font>
    enabled: true</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Federation setup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, go to the web interface </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keycloak.example.org</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the left corner, click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add realm</font></font></b><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Key</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Value</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubernetes</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display name</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disable verification of user email confirmation: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client scopes -&gt; Email -&gt; Mappers -&gt; Email verified (Delete) We</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
configure the federation for importing users from ActiveDirectory, I will leave screenshots below, I think it will be more clear. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User federation -&gt; Add provider ... -&gt; ldap</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Federation setup</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/dp/zh/n4/dpzhn4bo-kp4nlnkcnrcnxj73wm.png"><br>
<img src="https://habrastorage.org/webt/sm/s0/9v/sms09vw42zqqfkgdjsyonifzgn0.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If all is well, then after clicking the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronize all users</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button, </font><font style="vertical-align: inherit;">you will receive a message about the successful import of users. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we need to map our groups </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User federation -&gt; ldap_localhost -&gt; Mappers -&gt; Create</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapper Creation</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/ym/8s/g4ym8ss4xfzj4g2ju8xfgfj-vty.png"><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client setup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary to create a client, in terms of Keycloak is an application that will be authorized by him. </font><font style="vertical-align: inherit;">I will highlight the important points in the screenshot in red. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clients -&gt; Create</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client setup</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/gx/ky/xn/gxkyxnglb556uxb98cfowt2yhjo.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a scoupe for groups: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client Scopes -&gt; Create</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Making scoupe</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/a_/t8/4n/a_t84n571muypzgo6q2vwxicfli.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And configure mapper for them: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client Scopes -&gt; groups -&gt; Mappers -&gt; Create</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapper</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/qm/iy/m7/qmiym7hpnqdwi4hafjli0oput0c.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the mapping of our groups to Default Client Scopes: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clients -&gt; kubernetes -&gt; Client Scopes -&gt; Default Client Scopes</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">groups</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Available Client Scopes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add selected</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We get a secret (and write it to the thread) that we will use for authorization in Keycloak: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clients -&gt; kubernetes -&gt; Credentials -&gt; Secret</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This </font><b><font style="vertical-align: inherit;">is the end of</font></b><font style="vertical-align: inherit;"> the setup, but I got an error when after a successful authorization I got an error 403. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fix: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client Scopes -&gt; roles -&gt; Mappers -&gt; Create</font></font></b><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapper</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/ud/pt/6i/udpt6icu8dqk4til9qjtpcf0fci.png"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script code</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment">// add current client-id to token audience</span><font></font>
token.addAudience(token.getIssuedFor());<font></font>
<font></font>
<span class="hljs-comment">// return token issuer as dummy result assigned to iss again</span><font></font>
token.getIssuer();<font></font>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We need to indicate where our root certificate from the site lies, and where the OIDC provider is located. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, edit the file /etc/kubernetes/manifests/kube-apiserver.yaml</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kube-apiserver.yaml</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><font></font>
...<font></font>
spec:<font></font>
  containers:<font></font>
  - <span class="hljs-built_in">command</span>:<font></font>
    - kube-apiserver<font></font>
...<font></font>
    - --oidc-ca-file=/var/lib/minikube/certs/My_Root.crt<font></font>
    - --oidc-client-id=kubernetes<font></font>
    - --oidc-groups-claim=groups<font></font>
    - --oidc-issuer-url=https://keycloak.example.org/auth/realms/kubernetes<font></font>
    - --oidc-username-claim=email<font></font>
...<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update kubeadm config in the cluster:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubeadm config</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">kubectl edit -n kube-system configmaps kubeadm-config</code></pre><br>
<pre><code class="bash hljs"><font></font>
...<font></font>
data:<font></font>
  ClusterConfiguration: |<font></font>
    apiServer:<font></font>
      extraArgs:<font></font>
        oidc-ca-file: /var/lib/minikube/certs/My_Root.crt<font></font>
        oidc-client-id: kubernetes<font></font>
        oidc-groups-claim: groups<font></font>
        oidc-issuer-url: https://keycloak.example.org/auth/realms/kubernetes<font></font>
        oidc-username-claim: email<font></font>
...<font></font>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure auth-proxy</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can use keycloak gatekeeper to protect your web application. </font><font style="vertical-align: inherit;">In addition to the fact that this reverse proxy will authorize the user before showing the page, so it will also transmit information about you in the headers to the final application. </font><font style="vertical-align: inherit;">Thus, if your application supports OpenID, then the user immediately logs in. </font><font style="vertical-align: inherit;">Let's look at the example of Kubernetes Dashboard</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install Kubernetes Dashboard</font></font></h3><br>
<pre><code class="bash hljs"><font></font>
helm install stable/kubernetes-dashboard --name dashboard -f values_dashboard.yaml<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">values_dashboard.yaml</font></font></b><div class="spoiler_text"><pre><code class="bash hljs">enableInsecureLogin: <span class="hljs-literal">true</span><font></font>
service:<font></font>
  externalPort: 80<font></font>
rbac:<font></font>
  clusterAdminRole: <span class="hljs-literal">true</span>
  create: <span class="hljs-literal">true</span><font></font>
serviceAccount:<font></font>
  create: <span class="hljs-literal">true</span>
  name: <span class="hljs-string">'dashboard-test'</span>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting permissions:</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a ClusterRoleBinding that will give cluster admin rights (standard ClusterRole cluster-admin) for users in the DataOPS group.</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
kubectl apply -f rbac.yaml<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rbac.yaml</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><font></font>
apiVersion: rbac.authorization.k8s.io/v1<font></font>
kind: ClusterRoleBinding<font></font>
metadata:<font></font>
  name: dataops_group<font></font>
roleRef:<font></font>
  apiGroup: rbac.authorization.k8s.io<font></font>
  kind: ClusterRole<font></font>
  name: cluster-admin<font></font>
subjects:<font></font>
- apiGroup: rbac.authorization.k8s.io<font></font>
  kind: Group<font></font>
  name: DataOPS<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install keycloak gatekeeper:</font></font></h3><br>
<pre><code class="bash hljs"><font></font>
helm repo add gabibbo97 https://gabibbo97.github.io/charts/<font></font>
helm repo update<font></font>
helm install gabibbo97/keycloak-gatekeeper --version 2.1.0 --name keycloak-gatekeeper -f values_proxy.yaml<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">values_proxy.yaml</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><font></font>
<font></font>
<span class="hljs-comment">#  ingress</span><font></font>
ingress:<font></font>
  enabled: <span class="hljs-literal">true</span><font></font>
  annotations:<font></font>
    kubernetes.io/ingress.class: nginx<font></font>
  path: /<font></font>
  hosts:<font></font>
    - kubernetes-dashboard.example.org<font></font>
  tls:<font></font>
   - secretName: tls-keycloak<font></font>
     hosts:<font></font>
       - kubernetes-dashboard.example.org<font></font>
<font></font>
<span class="hljs-comment">#       OIDC </span>
discoveryURL: <span class="hljs-string">"https://keycloak.example.org/auth/realms/kubernetes"</span>
<span class="hljs-comment">#       Keycloak</span>
ClientID: <span class="hljs-string">"kubernetes"</span>
<span class="hljs-comment"># Secret    </span>
ClientSecret: <span class="hljs-string">"c6ec03b8-d0b8-4cb6-97a0-03becba1d727"</span>
<span class="hljs-comment">#      .  &lt;SCHEMA&gt;://&lt;SERVICE_NAME&gt;.&gt;&lt;NAMESAPCE&gt;.&lt;CLUSTER_NAME&gt;</span>
upstreamURL: <span class="hljs-string">"http://dashboard-kubernetes-dashboard.default.svc.cluster.local"</span>
<span class="hljs-comment">#   ,    </span>
skipOpenidProviderTlsVerify: <span class="hljs-literal">true</span>
<span class="hljs-comment">#   ,    path     DataOPS</span><font></font>
rules:<font></font>
  - <span class="hljs-string">"uri=/*|groups=DataOPS"</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, when you try to go to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubernetes-dashboard.example.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you will be redirected to Keycloak and, if authorization is successful, we will already be logged into Dashboard.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gangway installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For convenience, you can add gangway which will generate a config file for kubectl, with which we will already get into Kubernetes under our user.</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
helm install --name gangway stable/gangway -f values_gangway.yaml<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">values_gangway.yaml</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><font></font>
gangway:<font></font>
  <span class="hljs-comment">#   </span>
  clusterName: <span class="hljs-string">"my-k8s"</span>
  <span class="hljs-comment">#    OIDC </span>
  authorizeURL: <span class="hljs-string">"https://keycloak.example.org/auth/realms/kubernetes/protocol/openid-connect/auth"</span>
  tokenURL: <span class="hljs-string">"https://keycloak.example.org/auth/realms/kubernetes/protocol/openid-connect/token"</span>
  audience: <span class="hljs-string">"https://keycloak.example.org/auth/realms/kubernetes/protocol/openid-connect/userinfo"</span>
  <span class="hljs-comment">#     groups   </span>
  scopes: [<span class="hljs-string">"openid"</span>, <span class="hljs-string">"profile"</span>, <span class="hljs-string">"email"</span>, <span class="hljs-string">"offline_access"</span>]<font></font>
  redirectURL: <span class="hljs-string">"https://gangway.example.org/callback"</span>
  <span class="hljs-comment">#  </span>
  clientID: <span class="hljs-string">"kubernetes"</span>
  <span class="hljs-comment"># </span>
  clientSecret: <span class="hljs-string">"c6ec03b8-d0b8-4cb6-97a0-03becba1d727"</span>
  <span class="hljs-comment">#    ,       &lt;b&gt;Frist name&lt;/b&gt; &lt;b&gt;Second name&lt;/b&gt;,   "sub"  </span>
  usernameClaim: <span class="hljs-string">"sub"</span>
  <span class="hljs-comment">#    IP  API </span>
  apiServerURL: <span class="hljs-string">"https://192.168.99.111:8443"</span><font></font>
<font></font>
<span class="hljs-comment">#  Ingress</span><font></font>
ingress:<font></font>
  enabled: <span class="hljs-literal">true</span><font></font>
  annotations:<font></font>
    kubernetes.io/ingress.class: nginx<font></font>
    nginx.ingress.kubernetes.io/proxy-buffer-size: <span class="hljs-string">"64k"</span><font></font>
  path: /<font></font>
  hosts:<font></font>
  - gangway.example.org<font></font>
  tls:<font></font>
  - secretName: tls-keycloak<font></font>
    hosts:<font></font>
      - gangway.example.org<font></font>
<font></font>
<span class="hljs-comment">#    ,  (  )  .</span><font></font>
trustedCACert: |-<font></font>
 -----BEGIN CERTIFICATE-----<font></font>
 MIIDVzCCAj+gAwIBAgIBATANBgkqhkiG9w0BAQsFADA1MQswCQYDVQQGEwJVUzEQMA4GA1UEChMHRGF0YU9QUzEUMBIGA1UEAxMLbXkgcm9vdCBrZXkwHhcNMjAwMjE0MDkxODAwWhcNMzAwMjE0MDkxODAwWjA1MQswCQYDVQQGEwJVUzEQMA4GA1UEChMHRGF0YU9QUzEUMBIGA1UEAxMLbXkgcm9vdCBrZXkwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDyP749PqqIRwNSqaK6qr0Zsi03G4PTCUlgaYTPZuMrwUVPK8xX2dWWs9MPRMOdXpgr8aSTZnVfmelIlVz4D7o2vK5rfmAe9GPcK0WbwKwXyhFU0flS9sU/g46ogHFrk03SZxQAeJhMLfEmAJm8LF5HghtGDs3t4uwGsB95o+lqPLiBvxRB8ZS3jSpYpvPgXAuZWKdZUQ3UUZf0X3hGLp7uIcIwJ7i4MduOGaQEO4cePeEJy9aDAO6qV78YmHbyh9kaW+1DL/Sgq8NmTgHGV6UOnAPKHTnMKXl6KkyUz8uLBGIdVhPxrlzG1EzXresJbJenSZ+FZqm3oLqZbw54Yp5hAgMBAAGjcjBwMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFHISTOU/6BQqqnOZj+1xJfxpjiG0MAsGA1UdDwQEAwIBBjARBglghkgBhvhCAQEEBAMCAAcwHgYJYIZIAYb4QgENBBEWD3hjYSBjZXJ0aWZpY2F0ZTANBgkqhkiG9w0BAQsFAAOCAQEAj7HC8ObibwOLT4ZYmISJZwub9lcE0AZ5cWkPW39j/syhdbbqjK/6jy2D3WUEbR+s1Vson5Ov7JhN5In2yfZ/ByDvBnoj7CP8Q/ZMjTJgwN7j0rgmEb3CTZvnDPAz8Ijw3FP0cjxfoZ1Z0V2F44Ry7gtLJWr06+MztXVyto3aIz1/XbMQnXYlzc3c3B5yUQIy44Ce5aLRVsAjmXNqVRmDJ2QPNLicvrhnUJsO0zFWI+zZ2hc4Ge1RotCrjfOc9hQY63jZJ17myCZ6QCD7yzMzAob4vrgmkD4q7tpGrhPY/gDcE+lUNhC7DO3l0oPy2wsnT2TEn87eyWmDiTFG9zWDew==<font></font>
 -----END CERTIFICATE-----<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks something like this. </font><font style="vertical-align: inherit;">Allows you to immediately download the config file and create it using a set of commands:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/st/ti/8bsttivjxe0rfrdak52ldrwiuum.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489158/index.html">Sber.DS - a platform that allows you to create and implement models even without code</a></li>
<li><a href="../en489160/index.html">Results of a study on job postings for a digital product designer. Part One - Results and Statistics</a></li>
<li><a href="../en489162/index.html">Manager will hand over</a></li>
<li><a href="../en489164/index.html">Kubernetes cluster upgrade without downtime</a></li>
<li><a href="../en489166/index.html">About the operation of a PC using the example of Windows 10 and the keyboard of Part 2</a></li>
<li><a href="../en489174/index.html">Single Responsibility Principle (SRP) with Laravel</a></li>
<li><a href="../en489178/index.html">GSMout - receive SMS and calls ‚Äúat home‚Äù</a></li>
<li><a href="../en489182/index.html">varchar (max) -varchar (max) and in production</a></li>
<li><a href="../en489188/index.html">Logging in a microservice .Net environment in practice</a></li>
<li><a href="../en489190/index.html">RedHat study: open source displaces proprietary software from the enterprise segment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>