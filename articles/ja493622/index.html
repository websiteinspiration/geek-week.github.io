<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛄️ 🎙️ 💆🏿 AngularにRetrowaveを書き込む 👃🏼 📶 👏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web Audio APIは古くから存在しており、それに関する記事は多数あります。したがって、API自体についてはあまり触れません。正しく紹介すれば、Web AudioとAngularが親友になる可能性があることをお伝えします。そうしよう！
 


 

 Web Audio API , , . ,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>AngularにRetrowaveを書き込む</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/493622/"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web Audio API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は古くから存在しており、それに関する記事は多数あります。</font><font style="vertical-align: inherit;">したがって、API自体についてはあまり触れません。</font><font style="vertical-align: inherit;">正しく紹介すれば、Web AudioとAngularが親友になる可能性があることをお伝えします。</font><font style="vertical-align: inherit;">そうしよう！</font></font></p><br>
<p><img src="https://habrastorage.org/webt/bq/x7/il/bqx7ilzxekzevs6su8jexxi87n8.png"></p><a name="habracut"></a><br>
<p>  Web Audio API     ,     ,       .     ,  ,  .          .      - :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> AudioContext();
<span class="hljs-keyword">const</span> gainNode = context.createGain();</code></pre><br>
<p>         ,  ,    .        Web Audio API  Angular.</p><br>
<h2 id="direktivy"></h2><br>
<p> Angular  —  ,           .    ,      ,  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> AudioContext();
<span class="hljs-keyword">const</span> gainNode = <span class="hljs-keyword">new</span> GainNode(context);
<span class="hljs-keyword">const</span> delayNode = <span class="hljs-keyword">new</span> DelayNode(context);
<span class="hljs-keyword">const</span> audioSource = <span class="hljs-keyword">new</span> MediaElementAudioSourceNode(context, {
   <span class="hljs-attr">mediaElement</span>: audioElement.nativeElement,<font></font>
});<font></font>
<font></font>
gainNode.gain.value = <span class="hljs-number">0.5</span>;<font></font>
delayNode.delayTime.value = <span class="hljs-number">0.2</span>;<font></font>
<font></font>
audioSource.connect(gainNode);<font></font>
audioSource.connect(context.destination);<font></font>
gainNode.connect(delayNode);<font></font>
delayNode.connect(gainNode);<font></font>
delayNode.connect(context.destination);</code></pre><br>
<p> ,   —  .   ,  ,      connect.     HTML audio  ,    ,       .      . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>AudioContext</code></a>    Dependency Injection.</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>GainNode</code></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>DelayNode</code></a>     —      .     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>AudioParam</code></a>.     .</p><br>
<pre><code class="javascript hljs">@Directive({
   <span class="hljs-attr">selector</span>: <span class="hljs-string">'[waGainNode]'</span>,
   <span class="hljs-attr">inputs</span>: [
     <span class="hljs-string">'channelCount'</span>,
     <span class="hljs-string">'channelCountMode'</span>,
     <span class="hljs-string">'channelInterpretation'</span><font></font>
   ],<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioGain</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GainNode</span> </span>{<font></font>
   @Input(<span class="hljs-string">'gain'</span>)
   <span class="hljs-keyword">set</span> <span class="hljs-title">gainSetter</span>(<span class="hljs-params">value: number</span>) {
       <span class="hljs-keyword">this</span>.gain.value = value;<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">constructor</span>(@Inject(AUDIO_CONTEXT) context: AudioContext) {
       <span class="hljs-keyword">super</span>(context);<font></font>
   }<font></font>
}</code></pre><br>
<p>,       : <code>channelCount</code>, <code>channelCountMode</code>  <code>channelInterpretation</code>.  <code>inputs</code>   <code>@Directive</code>      —        . <code>DelayNode</code>     .        <code>AUDIO_NODE</code>,      :</p><br>
<pre><code class="javascript hljs">@Directive({
   <span class="hljs-attr">selector</span>: <span class="hljs-string">'[waGainNode]'</span>,
   <span class="hljs-attr">inputs</span>: [
     <span class="hljs-string">'channelCount'</span>,
     <span class="hljs-string">'channelCountMode'</span>,
     <span class="hljs-string">'channelInterpretation'</span><font></font>
   ],<font></font>
   <span class="hljs-attr">exportAs</span>: <span class="hljs-string">'AudioNode'</span>,
   <span class="hljs-attr">providers</span>: [{
     <span class="hljs-attr">provide</span>: AUDIO_NODE,
     <span class="hljs-attr">useExisting</span>: forwardRef(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> WebAudioGain),<font></font>
   }],<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioGain</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GainNode</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnDestroy</span> </span>{<font></font>
   @Input(<span class="hljs-string">'gain'</span>)
   <span class="hljs-keyword">set</span> <span class="hljs-title">gainSetter</span>(<span class="hljs-params">value: number</span>) {
       <span class="hljs-keyword">this</span>.gain.value = value;<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">constructor</span>(<font></font>
     @Inject(AUDIO_CONTEXT) context: BaseAudioContext,<font></font>
     @SkipSelf() @Inject(AUDIO_NODE) node: AudioNode | null,<font></font>
   ) {<font></font>
       <span class="hljs-keyword">super</span>(context);<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (node) {<font></font>
           node.connect(<span class="hljs-keyword">this</span>);<font></font>
       }<font></font>
   }<font></font>
<font></font>
   ngOnDestroy() {<font></font>
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
   }<font></font>
}</code></pre><br>
<p>   DI      .       <code>exportAs</code> —      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">template reference variables</a>.       :</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waGainNode</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waDelayNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></code></pre><br>
<p>        <code>waAudioDestination</code>:</p><br>
<pre><code class="javascript hljs">@Directive({
   <span class="hljs-attr">selector</span>: <span class="hljs-string">'[waAudioDestinationNode]'</span>,
   <span class="hljs-attr">exportAs</span>: <span class="hljs-string">'AudioNode'</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioDestination</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GainNode</span> 
   <span class="hljs-title">implements</span> <span class="hljs-title">OnDestroy</span> </span>{
   <span class="hljs-keyword">constructor</span>(<font></font>
       @Inject(AUDIO_CONTEXT) context: AudioContext,<font></font>
       @Inject(AUDIO_NODE) node: AudioNode | null,<font></font>
   ) {<font></font>
       <span class="hljs-keyword">super</span>(context);
       <span class="hljs-keyword">this</span>.connect(context.destination);<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (node) {<font></font>
           node.connect(<span class="hljs-keyword">this</span>);<font></font>
       }<font></font>
   }<font></font>
<font></font>
   ngOnDestroy() {<font></font>
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
   }<font></font>
}</code></pre><br>
<p>  ,      ,    Dependency Injection.    .       ,    :</p><br>
<pre><code class="javascript hljs">@Directive({
   <span class="hljs-attr">selector</span>: <span class="hljs-string">'[waOutput]'</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioOutput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GainNode</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnDestroy</span> </span>{<font></font>
   @Input()<font></font>
   <span class="hljs-keyword">set</span> <span class="hljs-title">waOutput</span>(<span class="hljs-params">destination: AudioNode | undefined</span>) {
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (destination) {
           <span class="hljs-keyword">this</span>.connect(destination);<font></font>
       }<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">constructor</span>(<font></font>
       @Inject(AUDIO_CONTEXT) context: AudioContext,<font></font>
       @Inject(AUDIO_NODE) node: AudioNode | null,<font></font>
   ) {<font></font>
       <span class="hljs-keyword">super</span>(context);<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (node) {<font></font>
           node.connect(<span class="hljs-keyword">this</span>);<font></font>
       }<font></font>
   }<font></font>
<font></font>
   ngOnDestroy() {<font></font>
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
   }<font></font>
}</code></pre><br>
<p>     <code>GainNode</code>,      .     <code>ngOnDestroy</code>.    ,     ,    <code>this</code>   .</p><br>
<h2 id="istochniki"></h2><br>
<p>      .  -,      .      <code>audio</code> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>MediaElementAudioSourceNode</code></a>:</p><br>
<pre><code class="javascript hljs">@Directive({
   <span class="hljs-attr">selector</span>: <span class="hljs-string">'audio[waMediaElementAudioSourceNode]'</span>,
   <span class="hljs-attr">exportAs</span>: <span class="hljs-string">'AudioNode'</span>,
   <span class="hljs-attr">providers</span>: [<font></font>
       {<font></font>
           <span class="hljs-attr">provide</span>: AUDIO_NODE,
           <span class="hljs-attr">useExisting</span>: forwardRef(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> WebAudioMediaSource),<font></font>
       },<font></font>
   ],<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioMediaSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MediaElementAudioSourceNode</span>
   <span class="hljs-title">implements</span> <span class="hljs-title">OnDestroy</span> </span>{
   <span class="hljs-keyword">constructor</span>(<font></font>
       @Inject(AUDIO_CONTEXT) context: AudioContext,<font></font>
       @Inject(ElementRef) {nativeElement}: ElementRef&lt;HTMLMediaElement&gt;,<font></font>
   ) {<font></font>
       <span class="hljs-keyword">super</span>(context, {<span class="hljs-attr">mediaElement</span>: nativeElement});<font></font>
   }<font></font>
<font></font>
   ngOnDestroy() {<font></font>
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
   }<font></font>
}</code></pre><br>
<p>      :</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/demo.wav"</span> <span class="hljs-attr">waMediaElementAudioSourceNode</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> #<span class="hljs-attr">node</span>=<span class="hljs-string">"AudioNode"</span> <span class="hljs-attr">waDelayNode</span> [<span class="hljs-attr">delayTime</span>]=<span class="hljs-string">"0.2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waGainNode</span> [<span class="hljs-attr">gain</span>]=<span class="hljs-string">"0.5"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> [<span class="hljs-attr">waOutput</span>]=<span class="hljs-string">"node"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span></code></pre><br>
<p> Web Audio API   ,       .  -      .        HTML          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>AudioBufferSourceNode</code></a>.   —        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">`AudioBuffer</a>.             <code>AudioBuffer</code>:</p><br>
<pre><code class="javascript hljs">@Injectable({
   <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AudioBufferService</span> </span>{<font></font>
   private readonly cache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;string, AudioBuffer&gt;();<font></font>
<font></font>
   <span class="hljs-keyword">constructor</span>(<font></font>
      @Inject(AUDIO_CONTEXT) private readonly context: AudioContext<font></font>
   ) {}<font></font>
<font></font>
   fetch(url: string): <span class="hljs-built_in">Promise</span>&lt;AudioBuffer&gt; {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;AudioBuffer&gt;<span class="hljs-function">(<span class="hljs-params">(resolve, reject</span>) =&gt;</span> {
           <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(url)) {<font></font>
               resolve(<span class="hljs-keyword">this</span>.cache.get(url));<font></font>
<font></font>
               <span class="hljs-keyword">return</span>;<font></font>
           }<font></font>
<font></font>
           <span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
<font></font>
           request.open(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);<font></font>
           request.responseType = <span class="hljs-string">'arraybuffer'</span>;<font></font>
           request.onerror = reject;<font></font>
           request.onabort = reject;<font></font>
           request.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
               <span class="hljs-keyword">this</span>.context.decodeAudioData(<font></font>
                   request.response,<font></font>
                   buffer =&gt; {<font></font>
                       <span class="hljs-keyword">this</span>.cache.set(url, buffer);<font></font>
                       resolve(buffer);<font></font>
                   },<font></font>
                   reject,<font></font>
               );<font></font>
           };<font></font>
           request.send();<font></font>
       });<font></font>
   }<font></font>
}</code></pre><br>
<p>     <code>AudioBufferSourceNode</code>,      <code>AudioBuffer</code>,    :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioBufferSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AudioBufferSourceNode</span> 
   <span class="hljs-title">implements</span> <span class="hljs-title">OnDestroy</span> </span>{<font></font>
   @Input(<span class="hljs-string">'buffer'</span>)
   <span class="hljs-keyword">set</span> <span class="hljs-title">bufferSetter</span>(<span class="hljs-params">source: AudioBuffer | null | string</span>) {
       <span class="hljs-keyword">this</span>.buffer$.next(source);<font></font>
   }<font></font>
<font></font>
   readonly buffer$ = <span class="hljs-keyword">new</span> Subject&lt;AudioBuffer | <span class="hljs-literal">null</span> | string&gt;();<font></font>
<font></font>
   <span class="hljs-keyword">constructor</span>(<font></font>
       @Inject(AudioBufferService) service: AudioBufferService,<font></font>
       @Inject(AUDIO_CONTEXT) context: AudioContext,<font></font>
       @Attribute('autoplay') autoplay: string | null,<font></font>
   ) {<font></font>
       <span class="hljs-keyword">super</span>(context);<font></font>
<font></font>
       <span class="hljs-keyword">this</span>.buffer$<font></font>
           .pipe(<font></font>
               switchMap(<span class="hljs-function"><span class="hljs-params">source</span> =&gt;</span>
                   <span class="hljs-keyword">typeof</span> source === <span class="hljs-string">'string'</span><font></font>
                       ? service.fetch(source)<font></font>
                       : <span class="hljs-keyword">of</span>(source),<font></font>
               ),<font></font>
           )<font></font>
           .subscribe(<span class="hljs-function"><span class="hljs-params">buffer</span> =&gt;</span> {
               <span class="hljs-keyword">this</span>.buffer = buffer;<font></font>
           });<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (autoplay !== <span class="hljs-literal">null</span>) {
           <span class="hljs-keyword">this</span>.start();<font></font>
       }<font></font>
   }<font></font>
<font></font>
   ngOnDestroy() {<font></font>
       <span class="hljs-keyword">this</span>.buffer$.complete();<font></font>
<font></font>
       <span class="hljs-keyword">try</span> {
           <span class="hljs-keyword">this</span>.stop();<font></font>
       } <span class="hljs-keyword">catch</span> (_) {}<font></font>
<font></font>
       <span class="hljs-keyword">this</span>.disconnect();<font></font>
   }<font></font>
}</code></pre><br>
<p>,       <code>autoplay</code>     <code>audio</code>,       .</p><br>
<h2 id="audioparam">AudioParam</h2><br>
<p>      — <code>AudioParam</code>.  <code>GainNode</code>   .       .     .     — ,          .     ,       <code>AudioParam</code>   .     :</p><br>
<pre><code class="javascript hljs">@Input(<span class="hljs-string">'gain'</span>)<font></font>
@audioParam(<span class="hljs-string">'gain'</span>)<font></font>
gainParam?: AudioParamInput;</code></pre><br>
<p>      :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> type AudioParamDecorator&lt;K extends string&gt; = (<font></font>
   target: AudioNodeWithParams&lt;K&gt;,<font></font>
   propertyKey: string,<font></font>
) =&gt; <span class="hljs-keyword">void</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">audioParam</span>&lt;<span class="hljs-title">K</span> <span class="hljs-title">extends</span> <span class="hljs-title">string</span>&gt;(<span class="hljs-params">
   param: K,
</span>): <span class="hljs-title">AudioParamDecorator</span>&lt;<span class="hljs-title">K</span>&gt; </span>{
   <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target, propertyKey</span>) =&gt;</span> {
       <span class="hljs-built_in">Object</span>.defineProperty(target, propertyKey, {<font></font>
           set(<font></font>
               <span class="hljs-keyword">this</span>: AudioNode &amp; Record&lt;K, AudioParam&gt;,<font></font>
               value: AudioParamInput,<font></font>
           ) {<font></font>
               processAudioParam(<font></font>
                   <span class="hljs-keyword">this</span>[param],<font></font>
                   value,<font></font>
                   <span class="hljs-keyword">this</span>.context.currentTime,<font></font>
               );<font></font>
           },<font></font>
       });<font></font>
   };<font></font>
}</code></pre><br>
<p>          .       <code>AudioParamInput</code>?        :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> type AudioParamAutomation = Readonly&lt;{
   <span class="hljs-attr">value</span>: number;<font></font>
   duration: number;<font></font>
   mode: <span class="hljs-string">'instant'</span> | <span class="hljs-string">'linear'</span> | <span class="hljs-string">'exponential'</span>;<font></font>
}&gt;;</code></pre><br>
<p> <code>processAudioParam</code>       API.   ,       .    0   ,      1  , —   : <code>{value: 1, duration: 1, mode: ‘linear’}</code>.          .</p><br>
<p>    ,      <code>duration</code>,   .        .       .  ,        ,   :</p><br>
<pre><code class="javascript hljs">@Pipe({
   <span class="hljs-attr">name</span>: <span class="hljs-string">'waAudioParam'</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebAudioParamPipe</span> <span class="hljs-title">implements</span> <span class="hljs-title">PipeTransform</span> </span>{<font></font>
   transform(<font></font>
       value: number,<font></font>
       <span class="hljs-attr">duration</span>: number,
       <span class="hljs-attr">mode</span>: AudioParamAutomationMode = <span class="hljs-string">'exponential'</span>,<font></font>
   ): AudioParamAutomation {<font></font>
       <span class="hljs-keyword">return</span> {<font></font>
           value,<font></font>
           duration,<font></font>
           mode,<font></font>
       };<font></font>
   }<font></font>
}</code></pre><br>
<p>   <code>AudioParam</code>      .     1,   LFO — Low Frequency Oscillator.      .         —     .           <code>waOutput</code>,    .    <code>exportAs</code> :</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waOscillatorNode</span> <span class="hljs-attr">frequency</span>=<span class="hljs-string">"0.2"</span> <span class="hljs-attr">autoplay</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waGainNode</span> <span class="hljs-attr">gain</span>=<span class="hljs-string">"3000"</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> [<span class="hljs-attr">waOutput</span>]=<span class="hljs-string">"filter.frequency"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waOscillatorNode</span> <span class="hljs-attr">autoplay</span> [<span class="hljs-attr">frequency</span>]=<span class="hljs-string">"note"</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
       #<span class="hljs-attr">filter</span>=<span class="hljs-string">"AudioNode"</span>
       <span class="hljs-attr">waBiquadFilterNode</span>
       <span class="hljs-attr">type</span>=<span class="hljs-string">"bandpass"</span>
       <span class="hljs-attr">frequency</span>=<span class="hljs-string">"4000"</span>
   &gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></code></pre><br>
<h2 id="vremya-retroveyva"> </h2><br>
<p>Web Audio API     :            ,    .        :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://stackblitz.com/edit/angular-web-audio</a></p><br>
<p>   —  -.          DI:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TICK = <span class="hljs-keyword">new</span> InjectionToken&lt;Observable&lt;number&gt;&gt;(<span class="hljs-string">'Ticks'</span>, {
   <span class="hljs-attr">factory</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> interval(<span class="hljs-number">250</span>, animationFrameScheduler)<font></font>
      .pipe(share()),<font></font>
});</code></pre><br>
<p>     4 .    <code>beat</code>    :</p><br>
<pre><code class="javascript hljs">kick$ = <span class="hljs-keyword">this</span>.tick$.pipe(map(<span class="hljs-function"><span class="hljs-params">tick</span> =&gt;</span> tick % <span class="hljs-number">4</span> &lt; <span class="hljs-number">2</span>));</code></pre><br>
<p>   <code>true</code>     <code>false</code>    .        :</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
   *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"kick$ | async; else snare"</span>
   <span class="hljs-attr">waAudioBufferSourceNode</span>
   <span class="hljs-attr">autoplay</span>
   <span class="hljs-attr">buffer</span>=<span class="hljs-string">"kick.wav"</span>
&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ng-template</span> #<span class="hljs-attr">snare</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
     <span class="hljs-attr">waAudioBufferSourceNode</span>
     <span class="hljs-attr">autoplay</span>
     <span class="hljs-attr">buffer</span>=<span class="hljs-string">"snare.wav"</span>
  &gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-template</span>&gt;</span></code></pre><br>
<p>  .       ,  69 —   .            .   :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> LEAD = [
   <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">68</span>,
   <span class="hljs-number">68</span>, <span class="hljs-number">68</span>, <span class="hljs-number">68</span>, <span class="hljs-number">68</span>, <span class="hljs-number">75</span>, <span class="hljs-number">79</span>, <span class="hljs-number">80</span>, <span class="hljs-number">87</span>,
   <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>,
   <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">87</span>, <span class="hljs-number">84</span>, <span class="hljs-number">80</span>, <span class="hljs-number">79</span>, <span class="hljs-number">75</span>,
   <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>,
   <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">79</span>, <span class="hljs-number">75</span>, <span class="hljs-number">72</span>, <span class="hljs-number">70</span>,
   <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">70</span>, <span class="hljs-number">68</span>,
   <span class="hljs-number">72</span>, <span class="hljs-number">75</span>, <span class="hljs-number">79</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>, <span class="hljs-number">79</span>, <span class="hljs-number">79</span>, <span class="hljs-number">75</span>,<font></font>
];</code></pre><br>
<p>          :</p><br>
<pre><code class="javascript hljs">notes$ = <span class="hljs-keyword">this</span>.tick$.pipe(map(<span class="hljs-function"><span class="hljs-params">note</span> =&gt;</span> toFrequency(LEAD[note % <span class="hljs-number">64</span>])));</code></pre><br>
<p>      .       —      ADSR-. ADSR  attack, decay, sustain, release,      :</p><br>
<p><img src="https://habrastorage.org/webt/bk/1i/49/bk1i49nn7x4rniv_xmwn8a8zhgg.png"></p><br>
<p> ,       .    :</p><br>
<pre><code class="javascript hljs">@Pipe({
   <span class="hljs-attr">name</span>: <span class="hljs-string">'adsr'</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdsrPipe</span> <span class="hljs-title">implements</span> <span class="hljs-title">PipeTransform</span> </span>{<font></font>
   transform(<font></font>
       value: number,<font></font>
       <span class="hljs-attr">attack</span>: number,
       <span class="hljs-attr">decay</span>: number,
       <span class="hljs-attr">sustain</span>: number,
       <span class="hljs-attr">release</span>: number,<font></font>
   ): AudioParamInput {<font></font>
       <span class="hljs-keyword">return</span> [<font></font>
           {<font></font>
               <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
               <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span>,
               <span class="hljs-attr">mode</span>: <span class="hljs-string">'instant'</span>,<font></font>
           },<font></font>
           {<font></font>
               value,<font></font>
               <span class="hljs-attr">duration</span>: attack,
               <span class="hljs-attr">mode</span>: <span class="hljs-string">'linear'</span>,<font></font>
           },<font></font>
           {<font></font>
               <span class="hljs-attr">value</span>: sustain,
               <span class="hljs-attr">duration</span>: decay,
               <span class="hljs-attr">mode</span>: <span class="hljs-string">'linear'</span>,<font></font>
           },<font></font>
           {<font></font>
               <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
               <span class="hljs-attr">duration</span>: release,
               <span class="hljs-attr">mode</span>: <span class="hljs-string">'linear'</span>,<font></font>
           },<font></font>
       ];<font></font>
   }<font></font>
}</code></pre><br>
<p>        :</p><br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"notes$ | async as note"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> 
    <span class="hljs-attr">waOscillatorNode</span> 
    <span class="hljs-attr">detune</span>=<span class="hljs-string">"5"</span> 
    <span class="hljs-attr">autoplay</span> 
    [<span class="hljs-attr">frequency</span>]=<span class="hljs-string">"note"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> 
      <span class="hljs-attr">waGainNode</span>
      [<span class="hljs-attr">gain</span>]=<span class="hljs-string">"0.1 | adsr : 0 : 0.1 : 0.02 : 0.5"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
    <span class="hljs-attr">waOscillatorNode</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"sawtooth"</span>
    <span class="hljs-attr">autoplay</span>
    [<span class="hljs-attr">frequency</span>]=<span class="hljs-string">"note"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
      <span class="hljs-attr">waGainNode</span>
      [<span class="hljs-attr">gain</span>]=<span class="hljs-string">"0.1 | adsr : 0 : 0.1 : 0.02 : 0.5"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span>
        #<span class="hljs-attr">feedback</span>=<span class="hljs-string">"AudioNode"</span>
        <span class="hljs-attr">waGainNode</span>
        <span class="hljs-attr">gain</span>=<span class="hljs-string">"0.7"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waDelayNode</span> <span class="hljs-attr">delayTime</span>=<span class="hljs-string">"0.3"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> [<span class="hljs-attr">waOutput</span>]=<span class="hljs-string">"feedback"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waConvolverNode</span> <span class="hljs-attr">buffer</span>=<span class="hljs-string">"response.m4a"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">waAudioDestinationNode</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></code></pre><br>
<p>   ?     .  —   ADSR-.            ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>ConvolverNode</code></a>.         .  <code>ConvolverNode</code>         ,      .       .     ,     LFO       <code>waAudioParam</code>.</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>    ,   .     Web Audio API    Angular —        open-source- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">@ng-web-apis/audio</a>.</p><br>
<blockquote>   Web Audio API  canvas       ,    —  SVG.</blockquote><p>   Web APIs for Angular,   —      API     Angular.   , , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Payment Request API</a>         MIDI- —    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja493610/index.html">DispmanX APIを使用してRaspberry Piでビデオレイヤーをプログラミングする</a></li>
<li><a href="../ja493614/index.html">Keras、TensorFlow、Deep Learningを使用してX線でCOVID-19を検出</a></li>
<li><a href="../ja493616/index.html">箱のような写真-中には何がありますか？Yandexでのレポート</a></li>
<li><a href="../ja493618/index.html">（ない）TwitterのOSINTは明らか</a></li>
<li><a href="../ja493620/index.html">ロジスティック曲線。流行はいつ終わりますか？</a></li>
<li><a href="../ja493626/index.html">Selenoid-何百もの並列UIテストを簡単かつ高速に。パベル・セニン</a></li>
<li><a href="../ja493630/index.html">リモートでの作業のためにWindows 10からUSBポートを転送する</a></li>
<li><a href="../ja493632/index.html">準備なしのリモート作業。簡単な紹介</a></li>
<li><a href="../ja493634/index.html">熊手の中を歩く。Arduino</a></li>
<li><a href="../ja493636/index.html">MVP、1500ルーブルの着陸と広告</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>