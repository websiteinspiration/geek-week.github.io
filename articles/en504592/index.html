<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ü§±üèª üë®üèæ‚Äçüè´ PuppetConf 2016. Kubernetes for system administrators. Part 3 üë∏üèª üìû üîÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PuppetConf 2016. Kubernetes for system administrators. Part 1 of 
 PuppetConf 2016. Kubernetes for system administrators. Part 2
 
 We take the Lobste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PuppetConf 2016. Kubernetes for system administrators. Part 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504592/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PuppetConf 2016. Kubernetes for system administrators. Part 1 of </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PuppetConf 2016. Kubernetes for system administrators. Part 2</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We take the Lobsters application and create a new image with new requirements. First, enter the deployment command $ kubectl apply ‚Äìf deployments / lobsters.yaml and send the application to the cluster, which should perform rolling update update for each of the available application instances in accordance with the update policy. First, the system makes sure that each instance is operational, and then destroys them in the next set of containers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xg/bl/xe/xgblxesodan5f7msgrj_d3qc0x4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see how it worked. To do this, we reload the site, and now the lack of white spots will make our marketer happy.</font></font><a name="habracut"></a><br>
<br>
<img src="https://habrastorage.org/webt/0y/tu/r3/0ytur3i7hpga4pd8blgqpltetpk.jpeg"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a system administrator, you can say: "There are no HTTPS here, such sites are easy to hack, it‚Äôs dangerous!" How can this problem be solved? I think in its solution Kubernetes can act as a framework that allows the system administrator to implement a creative approach to work. It would be nice if I could declaratively say: "I want to get Let's Encrypt certificate for this site, but I do not want to redeploy this container." I want to do this within my capabilities, without resorting to the application development team for help. Kubernetes allows this, as it supports custom extensions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I talked about kubectl, pods, deployments, services, but we also have custom types - custom resource types that can be obtained from Puppet. At Puppet, we can define new types, so that we can use this system for our work. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see how it looks in Kubernetes. First of all, we need an extension for certificates, this is how it looks. Here we have our own hightower.com namespace, in which the certified object is located. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rr/ma/5r/rrma5rckamyozcp6nnmpbtgyl7c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create a new extension in Kubernetes using the command $ kubectl create ‚Äìf extensions / certificate.yaml, and the storage is automatically created in the backend and this state is managed.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f6/ea/d2/f6ead2a5oznwql3lmm4x1vfdroq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The appearance of this new object requires me to use a new tool that tracks changes and takes action on the certificate object. That is, this tool in the background should interact with Let's Encrypt and get a valid certificate. For this I use secret - I will show very quickly how this is done. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we need a new sub, and I will show what the difference is compared to the previous code. I am adding nginx to an existing container, so we don‚Äôt need to contact the development team. We continue to use HTTPS by simply placing the container at the very top of the existing hearth.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g7/03/86/g70386ln3tvhoqjmebrbvryzpzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This container accepts HTTPS traffic and needs a configuration file to interact with the backend. I also need some certificates that nginx downloads from the file system, so environment variables don't work here. I did not write nginx, so I can not get him to do this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_a/cl/2i/_acl2isasvxctjkvufkrugqnk8k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So I just add this container right inside the hearth and turn to two secrets. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yc/iv/eq/yciveqwa-pq7_cck1gf60hfjqn8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first and most important secret is the TLS certificate, which should come from Let's Encrypt. I am not going to report Let's Encrypt to my application, I am reporting it to my system. I want to control this abstraction. So now I have to create a config file for nginx. This is the main configuration file that looks like this.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Port 443 is specified here and SSL is enabled, which looks for these 2 files in the file system, captures traffic and sends it to the local host 127.0.0.1{000. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-2/kd/5y/-2kd5yagcajoerql82qqk13j7x8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is exactly what my application listens to. Now I will create configmap - the nginx configuration map using the following command. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/o7/cw/9co7cwksmacc2wupjily8lafopw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, using the $ kubectl get configmaps command, I place the configmap ‚Äúnginx‚Äù on the system with the same name as the disk. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xd/ra/gj/xdragjavd0y5qozvclnjhgarhoo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to create a secret, I remind you again - I want everything to be automated, and I do not want to interfere in the process of obtaining certificates. To do this, I am deploying a tool called ‚Äúkube-cert-manager‚Äù, and here is the result.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/al/nf/2qalnfsodexfhlnz6wrmdczbhuk.jpeg"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are trying to get a valid Let's Encrypt certificate, which my browser will trust, and insert it into the backend as secret. Therefore, for my hearth there will be no difference in the fact that we have supplemented its contents. If you remember, all this is done by creating a custom type in Puppet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps this is a bad idea, but now I will try to start the controller, which will work in the background. We do not compile, we do not create providers, this daemon just works in the background and watches the changes. As soon as the certificate object appears, it receives it with Let's Encrypt and inserts it into the system in real time without any delay. So, I use the following command.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a4/99/zo/a499zou6q5d0mmb-dudvreekhyg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This thing also has storage, so we can save everything we need. It takes a few seconds for the kube-cert-manager certification manager to start working. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p4/6i/gc/p46igctf-yljcjod5tgweyo9pnq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next thing we need to do is create a certificate object. This is what I define myself, this is my own scheme. I am creating a new thing that Kubernetes has not met up to this point, which says that I can get a certificate for the lobsters.com domain.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/yl/kd/hqylkdbzfn7vdps0b5drmv8jbpm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is an email address and other information that is necessary for Let's Encrypt to give me a valid certificate. Let's Encrypt will send me an exchange token to see if I really own this domain and I will need to apply this token to my DNS in Google Cloud. If the check passes, they will give me a real certificate, which I will insert into my file system. Let's see how this works by entering the $ kubectl get pods command. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pb/6u/za/pb6uzapiyin51rbygpmlorvu3pw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the certificate manager is still working. Let's see the detailed information about this process using the $ kubectl describe pods kube-cert-manager command, inserting the container name from the first line of code.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wg/ly/xe/wglyxeqwjbcurcrse2hshtjw_ji.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You see that the work is being done on schedule. At the moment, the server is creating a volume that, after checking and formatting, will be mounted on this server. While this process is ongoing, we can go further and finish our work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I enter the kubectl create ‚Äìf certificates / lobsters.yaml command and get the following result. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z5/hp/gp/z5hpgphmdzfu4rtwj1dq0bntpwg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, I use a command that allows you to view the logs of several containers. I will highlight the one that relates to my object. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sz/wx/ef/szwxef5zwbj9zy-r4simoyc8nji.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now a DNS record is being created inside my cloud-based DNS server. If I refresh the page shown here, I will see a new exchange token with the extension .txt.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n_/z4/rf/n_z4rfe1bpsde1qtie1km2dwxhs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, I received the token from Let's Encrypt and now I verify that this DNS record has been distributed to all authorized servers before I tell Let's Encrypt to check this text entry in my domain. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/ma/pr/mbmaprqr4ddkxyuytws68cgj-u8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If this works, they will send me a valid certificate back. Real-time DNS demonstration is a bad idea. Yeah, we finally get the certificate. Let's Encrypt noticed that the certificate disappeared from Kubernetes, and inserted it there. This is great, because now I already have a certificate request interface for everything that runs in Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure everything is working correctly, I enter the $ kubectl get secrets command and we see one secret for lobsters.hightowerlabs.com.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b7/ff/j1/b7ffj1jembzr8j1htlpxkrxkcoa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I use the command $ kubectl delete secrets lobsters.hightowerlabs.com, because it is a declarative system, we do not delete the certificate object, but get rid of the secret associated with it located inside Kubernetes. As a result, we must make sure that when this element is deleted, the system will return the Let's Encrypt certificate itself. This is very similar to what we do in Puppet, only here it happens online.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After making sure that everything works, we are redeploying our nginx application called ‚Äúlobsters-secure‚Äù, which will ensure the security of the new domain. His image is similar to the previous version, but the difference is that we put nginx here. Nginx picks up the secrets link, then Kubernetes inserts it into the file system, as a result of which I get a valid certificate for a specific domain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, I enter the command $ kubectl apply ‚Äìf deployments / lobsters-secure.yaml using the same name, so this command overwrites the existing state. Next, the $ kubectl get pods command is used, which shows that rolling rolling update is happening here now, as our definitions have changed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the update is completed, it is clear that the new definition is used for this application. </font><font style="vertical-align: inherit;">I want to make sure the certificate is valid for our DNS name, for which I enter the command $ kubectl get svc and copy the IP address of the lobsters site. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/tv/i4/bftvi4mtuaqz29b5eelp25eqets.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By going to the Google Cloud tab, you can see that this address matches the address corresponding to the domain name lobsters.hightowerlabs.com. </font><font style="vertical-align: inherit;">Now, if you type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lobsters.hightowerlabs.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the address bar of your browser </font><font style="vertical-align: inherit;">, you can see that we have a valid certificate. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/se/z5/zxsez5z5vhqg3e3cxkuqzs7jc84.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you, that‚Äôs all I wanted to say in the Kubernetes for System Admins report.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HlAXp0-M6SY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504576/index.html">How home audio developed - from song nights to the first mechanical players</a></li>
<li><a href="../en504578/index.html">How Americans Become Millionaires: FIRE Principles</a></li>
<li><a href="../en504582/index.html">HackTheBox. Walkthrough Resolute. Password spraying. From DnsAdmin to SYSTEM</a></li>
<li><a href="../en504586/index.html">ES2020 innovations that I really like</a></li>
<li><a href="../en504590/index.html">Pure PHP architecture. How to measure and control it?</a></li>
<li><a href="../en504598/index.html">Database of primes up to one hundred billion on the knee</a></li>
<li><a href="../en504600/index.html">What awaits the airline after the crisis: Warren Buffett's opinion</a></li>
<li><a href="../en504602/index.html">Telemetr√≠a ‚Üí voltage free metrics</a></li>
<li><a href="../en504604/index.html">What is happening in the video services market today?</a></li>
<li><a href="../en504612/index.html">You May Not Need Svelte To Reduce Your JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>