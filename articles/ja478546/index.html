<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎳 👩 👭 WebSocket 開発と運用の経験。クライアントを変更します 👨🏽‍🔬 👩🏼‍🍳 😎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私はこのプロトコルに関心のあるすべての人を歓迎します。そして、事前に私の過度の感情的なメモをお詫びします。 （必要に応じて）急遽この主題に従事しましたが、長い間続いていました。この点で、この技術を設計および使用する一定の慣行が蓄積され、形成されました。ここでは、サービス実装オプションについて説明しま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebSocket 開発と運用の経験。クライアントを変更します</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478546/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はこのプロトコルに関心のあるすべての人を歓迎します。そして、事前に私の過度の感情的なメモをお詫びします。 （必要に応じて）急遽この主題に従事しましたが、長い間続いていました。この点で、この技術を設計および使用する一定の慣行が蓄積され、形成されました。ここでは、サービス実装オプションについて説明し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。それ以来、たくさんの水が流れてきました。基本的な原則は同じですが、アプリケーション自体のコードは自然に変更されています。一部の場所では、致命的でないエラーが見つかり、修正されました。どこかで、プログラムフローの制御、開いている接続のリストなどが最適化されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ご存知のように、サーバー側に加えて、クライアント側があります。</font><font style="vertical-align: inherit;">そして、ここで私はもっと徹底的に立ち止まって、私が直面しなければならなかったものと影響を受け得るものについて説明したいと思います。</font><font style="vertical-align: inherit;">もちろん、JavaScriptを使用する場合、すべての準備ができて閉じているため、特に「はしゃぐ」ことはできませんが、Javaでクライアントについて何かを伝えることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どんなに優れたプログラマであっても、開発してユニークなものを発明し、自分の詩をデバッグすることは常に困難です。</font><font style="vertical-align: inherit;">したがって、私は一度、すでに準備ができているものを見つけたいという誘惑に屈して、すぐに私のプロジェクトでそれを使用できるようにしました。</font><font style="vertical-align: inherit;">完成したモジュールの選択基準は単純でした。</font><font style="vertical-align: inherit;">最小限のオーバーヘッドでJavaで完全に機能するコードを取得したかったのです。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選ばれたものとして、私はApacheライブラリーを使用してモジュールに落ち着きました。</font><font style="vertical-align: inherit;">特に、これら：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apache-mime4j-core-0.7.2.jar;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">httpclient-4.2.1.jar;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">httpcore-4.2.1.jar;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">httpmime-4.2.1.jar。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらの使用について何が言えますか？</font><font style="vertical-align: inherit;">Apacheソフトウェアは、その信頼性、高度さ、最適性で常に有名です。</font><font style="vertical-align: inherit;">Androidのクライアントは正常に動作しました。</font><font style="vertical-align: inherit;">完成した* .apkファイルのサイズはそれほど大きくありませんでした。</font><font style="vertical-align: inherit;">これらの図書館の仕事について特別な不満はありませんでした。</font><font style="vertical-align: inherit;">しかし、人生は常に私たちよりも賢いです。</font><font style="vertical-align: inherit;">そして、時間（そしてこの期間は約4〜5年です）は独自の調整を行います。</font><font style="vertical-align: inherit;">アプリケーションは、Android 4.2-4.4のバージョンがあったときに作成されました。</font><font style="vertical-align: inherit;">そして今年、すでにバージョン10のデバイスが本格化している新しいソリューションの必要性が生じました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発は当時Eclipse for Windows 7で行われていました。AndroidSDKを必要なレベルに更新すると、128 GBの小さなSSDハードドライブがいっぱいになりました。 Android Studioに切り替える必要がありました。さらに、基本オペレーティングシステムを変更する必要がありました。 Ubuntuをインストールしてみましたが（バージョン番号を覚えていません）、この環境ですでにStudioを使用しています。しかし、再び、失敗、Andriod Studioは頑固にインストールしたくありませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理由-すでに忘れられています。結局、友人の助言に基づいて、彼は最新バージョンのLinux-Mintをインストールしました。そして、見たところ、ツールキットは何の不満もなく横になりました。次に、実際に何が起こったのか、正確にこれらのすべての詳細が説明されたため、つまりテストを作成するルーチンが説明されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、このチアゴモチンで何が期待されましたか？公式サイトからApacheが上記のライブラリの最新バージョンをコピーしたという事実から始めましょう。それらをプロジェクトに追加しました...そしてコンパイルエラーが発生しました。時間の経過、クラスインターフェイスの変更。したがって、私は（新しいライブラリを研究する時間が足りなかったため）古いバージョンに戻す必要がありました。しかし... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでも、簡単な方法を探しているわけではありません。なぜこれらのライブラリが完全に必要なのでしょうか？これらのパッケージのテキストは次のとおりです。それらから必要なクラスのみを取得してプルするとどうなりますか？さらに、Webソケットを操作するためのモジュールのテキストを検討すると、これらのライブラリーからは2つのクラスしか表示されませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで私は新しいプロジェクトを作成し、必要なクラスを追加し始めました。そして結局、コンパイルを成功させるには、32のクラスを引き出す必要があることがわかりました。それでも、はい、プロジェクトは成功しました。すべてが呼吸していた。 Webソケットサービスへの接続に成功しました。そして、すべてがうまくいくでしょうが、私には理解できない次のイベントに気づきました。接続を閉じるときに、接続を担当するモジュールが例外を</font><font style="vertical-align: inherit;">
 スローしました</font><font style="vertical-align: inherit;">：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
java.io.EOFException </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 at java.io.DataInputStream.readByte（DataInputStream.java:77）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at com.example.wsci.HybiParser.start（HybiParser.java:112）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 at com.example.wsci.WebSocketClient $ 1.run（WebSocketClient.java:144）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 at java.lang.Thread.run（Thread.java:818）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は途方に暮れていた。以下は混乱した。サーバーへの接続は成功しました。パッケージは正常に行き来しました。しかし、なぜクロージャが例外をスローしたのでしょうか？さらに、サーバーではすべてが標準でした。明らかに、テキストのどこかに、クライアントは閉鎖に影響を与えるいくつかの些細なことをしました。さらに、テキストはそのような特徴を示しました。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">文書の7.1.1項に</font></a><font style="vertical-align: inherit;">よると</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側でのクローズは、close（）メソッドを呼び出すだけでなく、オペレーションコード8（クローズオペレーション）でパケットを形成して送信することでも構成されます。この場合、サーバーはクロージャパケットを送信し、その後クライアントは接続を閉じます。しかし、私たちのケースでは、そのような一連の呼び出しは観察されませんでした。これは単にclose関数を呼び出しただけです。一般的に、何か考えるべきことがありました。そして、このモジュールのテキストをパケットパーサーで調べて研究すればするほど、それが気に入らなくなるほど、プロトコルのビジョンで書き直したいという欲求が高まりました。結局、この「労働偉業」を実行することが決定されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのモジュールで「市民抗議」を引き起こしたものと実際に合わなかったものは何ですか？まず、サーバーとの直接接続のモジュールとパケットパーサーの間の相互作用の構成。接続モジュールがサーバーと対話し、パーサーを生成し、それへのリンクをパラメーターとして渡したことがわかりました。その結果、パーサーには、今後のネットワークイベントに関する決定を行う権限が委任されました。この点で、疑問が生じましたが、それは良いことなのでしょうか？パーサーモジュールがそれぞれのミッションを実行し、その作業の結果を返すのが良いのではないでしょうか。しかし、イベントの制御決定は、パーサーを生成したオブジェクトによって実行されますか？この場合、オブジェクト間の相互作用の厳密な階層が決定されます。 （もちろん、ここではどちらが良いかについて議論することができます-階層またはネットワーク、しかし、そのトピックから離れます。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを書き直したいと思った2番目のことは、パーサーの構造でした。このオブジェクト（クラス）は、2つの主要な機能を実行する必要があります。つまり、サーバーに送信するデータパケットを形成し、サーバーから受信したパケットを解析します。つまり、概して、これら2つの機能が合わなかったのです。そしてこれで。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークイベントが発生し、パケットが到着したとします。この場合、HybiParserは何をしましたか？このオブジェクトは、ソケットの入力ストリームから最初の2バイトをバイト単位で読み取り、その後のアクション（データサイズやマスクの解析など）を決定しました。その結果、これはソケットの入力ストリームからのいくつかの読み取り操作で実装されました。さらに、ステージを読み取ることで解析が複雑になり、さらにアルゴリズムが複雑になりました。そして再び疑問が生じた、それは正しい、なぜそのような困難なのか？特に着信データのサイズを判別できるので、パケットを1つの操作と見なした方がよいのではないですか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第3。</font><font style="vertical-align: inherit;">パーサーの作業のもう1つの論争の的である側面は、「永遠の」パケット受け入れサイクルです。</font><font style="vertical-align: inherit;">サイクルは別のプログラムストリームで実行されます。</font><font style="vertical-align: inherit;">ある時点で、ソケットが閉じます。</font><font style="vertical-align: inherit;">次は、通常の例外処理です。</font><font style="vertical-align: inherit;">または何をすべきか？</font><font style="vertical-align: inherit;">いいえ、私は例外のメカニズムに反対しているわけではありませんが、この状況とそれに対する反応を事前に予測しておくとよいでしょう。</font><font style="vertical-align: inherit;">たとえば、同期メカニズムをソリューションとして提案することが可能でした。その間、サイクルの定期的な完了、したがってプログラムストリームが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてのニュアンスの評価の結果、必要なモジュールの設計に関する次の要件が決定されました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールはサードパーティのライブラリから独立している必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールはシンプルで他のプロジェクトに統合しやすいものでなければなりません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールは、将来の機能拡張に備える必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、以前の既製のソリューションに対する過度の批判のせいにならないように、これに加えて、既製の非批判的な機能の一部を新しい実装に安全に転送できます。</font><font style="vertical-align: inherit;">それがすべてです。CPSUのXXII議会で彼らが言ったように、「私たちの目標は明確であり、タスクが定義されています。</font><font style="vertical-align: inherit;">仕事に、同志！</font><font style="vertical-align: inherit;">共産主義の新たな勝利のために！」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、読者に負担をかけないように、貴重な時間を奪わないように、私の提案を簡単に説明し、要点のみに焦点を当てます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、提案された実装には4つのモジュールのみが含まれます（Apacheライブラリの上記の要件に従って、またはそれらの個々のクラスはプロジェクトに含まれていませんでした）。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSocketプロトコル07グローバル定数モジュール。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘルパー例外クラス。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webソケットクライアント。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSocketプロトコルレベル07のパケットを解析するためのモジュール。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の2つのモジュールでは、実装は簡単です。考慮すべきことは何もありません。</font><font style="vertical-align: inherit;">クライアントモジュールは、サーバーへの接続を制御します。次の点について詳しく説明します。</font><font style="vertical-align: inherit;">接続オープン関数には、サーバーからのヘッダーのループがあります。</font><font style="vertical-align: inherit;">ここでは、Sec-WebSocket-Acceptキーの解析が実際に実装されています。この場合、解析はApacheライブラリを使用せずに実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、パケットループ制御機能に注意してください。</font><font style="vertical-align: inherit;">実装は同期オブジェクトを介して簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に考慮すべき点は、ループの機能です。サイクルは「永遠」ではなく、同期オブジェクトをチェックする条件に従って終了します。サイクルでは、到着したパケットが1回の操作で読み取られます。パッケージは、対応するオブジェクトによって解析のために解析されます。次に、今後のネットワークイベントの管理決定が行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明を完了するために、接続を安全に終了する機能に注目します。これは次のように行われます。接続終了パケットがサーバーに送信され、Runnableクラスの変数が生成されます。この変数はキュープロセッサに配置され、postDelayed関数を介して実行されます。そのパラメーターの1つはミリ秒単位の操作の遅延です。 Runnable変数のrun関数には、プログラムストリームが終了し、サーバーへの接続が閉じられたときの一連の呼び出しが含まれています。終了応答パケットが早く到着した場合、処理リストのこの位置は削除されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebSocketパケットの分析を実装するクラスには、注意が必要な2つのメソッドが含まれています。それ自体を解析することと、関連するパラメーターに従って送信するパケットを形成することです。</font><font style="vertical-align: inherit;">解析時には、受信したパケットのすべてのフラグとデータがクラス変数publicに格納されます。</font><font style="vertical-align: inherit;">なぜ公開するのですか？</font><font style="vertical-align: inherit;">はい、簡単にするために、追加のget / set関数を作成しないようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、実際には、親愛なる読者。</font><font style="vertical-align: inherit;">Android Studio用プロジェクトのアーカイブが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添付されてい</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">私はあなたのプロジェクトでこれらのテキストを使用することを主張しません。</font><font style="vertical-align: inherit;">建設的な批判は受け入れられます。</font><font style="vertical-align: inherit;">できるだけ質問に答えてください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478536/index.html">KurentoによるWebRTC：テストと実装の経験</a></li>
<li><a href="../ja478538/index.html">パスポートの有効性を確認する方法</a></li>
<li><a href="../ja478540/index.html">第10回フォーラム「Positive Hack Days 10：Getting Started」が始まります</a></li>
<li><a href="../ja478542/index.html">figmaGen：iOSアプリのスタイルオートメーション</a></li>
<li><a href="../ja478544/index.html">Vue Storefront：Magento 2からディレクトリをインポート</a></li>
<li><a href="../ja478550/index.html">時計の管理方法は？第2回プログラミングチャンピオンシップのフロントエンドトラックの分析</a></li>
<li><a href="../ja478552/index.html">2番目のアプレット、Processing 3で閉じ、透明なボタン</a></li>
<li><a href="../ja478554/index.html">ウェビナー「SRE-誇大宣伝か未来か？」12月12日11:00</a></li>
<li><a href="../ja478560/index.html">無料のインスタントメッセンジャーは匿名ですか？</a></li>
<li><a href="../ja478564/index.html">TsIANがテラバイトのログをどのように手入れしたか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>