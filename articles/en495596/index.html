<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤ üë®üèº‚ÄçüöÄ üö¥üèæ Remote work in the office. RDP, Port Knocking, Mikrotik: simple and safe üßúüèº üëèüèº üë©üèæ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In connection with the pandemic of the covid-19 virus and universal quarantine in many countries, the only way out of many companies to continue worki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Remote work in the office. RDP, Port Knocking, Mikrotik: simple and safe</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495596/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In connection with the pandemic of the covid-19 virus and universal quarantine in many countries, the only way out of many companies to continue working is remote access to jobs via the Internet. There are many relatively safe methods for remote work - but given the scale of the problem, you need a simple method for any user to remotely connect to the office and without the need for additional settings, explanations, tedious consultations and long instructions. This method is the favorite of many admins RDP (Remote Desktop Protocol). Connecting directly to the workplace via RDP ideally solves our problem, except for one big fly in the ointment - keeping the RDP port open for the Internet is very unsafe. Therefore, below I propose a simple but reliable method of protection.</font></font><img src="https://habrastorage.org/webt/yv/o3/ut/yvo3utx5cj_wwte6jja-pe6swfw.jpeg" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Since I often come across small organizations where Mikrotik devices are used as Internet access, it will be shown below how to implement this on Mikrotik, but the Port Knocking protection method is easily implemented on other higher-class devices with the same settings for the input router and firewall </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Briefly about Port Knocking</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . An ideal external protection for a network connected to the Internet is when all resources and ports are closed externally by a firewall. And although a router with such a configured firewall does not react in any way to packets coming from outside, it listens for them. Therefore, you can configure the router so that when you receive a certain (code) sequence of network packets on different ports, it (the router) for IP from where the packets came from opens access to certain resources (ports, protocols, etc.).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now to the point. </font><font style="vertical-align: inherit;">I will not do a detailed description of the firewall settings on Mikrotik - the Internet is full of high-quality sources for this. </font><font style="vertical-align: inherit;">Ideally, a firewall blocks all incoming packets, but</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=accept chain=input comment="established and related accept" connection-state=established,related</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allows incoming traffic from established (related) connections. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now configure Port Knocking on Mikrotik:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
move [/ip firewall filter find comment=RemoteRules] 1<font></font>
/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now more: the </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
first two rules</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
prohibit incoming packets from IP addresses that are blacklisted when scanning ports; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The third rule:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adds ip to the list of hosts that made the correct first knock on the desired port (19000); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following four rules:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
create trap ports for those who want to scan your ports, and when such attempts are detected, put their ip on the black list for 60 minutes, during which the first two rules will prevent such hosts from knocking on the correct ports; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following rule:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puts ip in the list of allowed for 1 minute (enough to establish a connection), since the second correct knock is made to the desired port (16000); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next command:</font></font><br>
<br>
<pre><code class="plaintext hljs">move [/ip firewall filter find comment=RemoteRules] 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
moves our rules up the firewall processing chain, since most likely we will already have different prohibition rules configured that will prevent our newly created ones from working. The very first rule in Mikrotik starts from zero, but on my device zero was occupied by the built-in rule and it was impossible to move - I moved to 1. Therefore, we look at our settings - where you can move and specify the desired number. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following setting:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp_to_33" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
forwards randomly selected port 33890 to a regular RDP port 3389 and ip of the computer or terminal server we need. </font><font style="vertical-align: inherit;">We create such rules for all necessary internal resources, preferably exposing non-standard (and different) external ports. </font><font style="vertical-align: inherit;">Naturally, the ip of internal resources must be either static or secured to a DHCP server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now our Mikrotik is configured and we need a simple procedure for the user to connect to our internal RDP. </font><font style="vertical-align: inherit;">Since we have mainly Windows users, we create a simple bat file and call it StartRDP.bat:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.htm<font></font>
1.rdp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
accordingly 1.htm contains the following code:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:19000/1.jpg"</span>&gt;</span><font></font>
       RDP<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:16000/2.jpg"</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 it contains two links to imaginary pictures that are located at the address my_router.sn.mynetname.net - we take this address from the DDNS system of Mikrotik by pre-enabling this in our Mikrotik: go to the IP-&gt; Cloud menu - check the DDNS Enabled checkbox, click Apply and copy the dns name of our router. But this is only necessary when the external ip of the router is dynamic or a configuration with several Internet providers is used.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The port in the first link: 19000 corresponds to the first port on which you need to knock, in the second, respectively, the second. Between the links there is a short instruction that shows what to do if suddenly our connection is disconnected due to short network problems - we refresh the page, the RDP port opens for us again for 1 minute and our session is restored. Also, the text between the img tags forms a micro delay for the browser, which reduces the likelihood of the first package being delivered to the second port (16000) - so far there have been no such cases in two weeks of use (30 people). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next is the 1.rdp file, which we can configure one for all or separately for each user (I did so - it‚Äôs easier to spend an additional 15 minutes than several hours to consult those who could not figure it out)</font></font><br>
<br>
<pre><code class="plaintext hljs">screen mode id:i:2<font></font>
use multimon:i:1<font></font>
.....<font></font>
connection type:i:6<font></font>
networkautodetect:i:0<font></font>
.....<font></font>
disable wallpaper:i:1<font></font>
.....<font></font>
full address:s:my_router.sn.mynetname.net:33890<font></font>
.....<font></font>
username:s:myuserlogin<font></font>
domain:s:mydomain</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
of the interesting settings here use multimon: i: 1 - this includes the use of multiple monitors - some need it, but they‚Äôll not think of turning it on themselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
connection type: i: 6 and networkautodetect: i: 0 - since the majority of the Internet is higher than 10 Mbps, then turn on connection type 6 (local network 10 Mbps and higher) and disable networkautodetect, because if it is (auto) by default, then it‚Äôs even rare network delay automatically permanently sets an underestimated speed for our session, which can create noticeable delays in work, especially in graphics programs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
disable wallpaper: i: 1 - disable the desktop image </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
username: s: myuserlogin - specify the username, since a significant part of our users do not know their username</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
domain: s: mydomain - specify the domain or computer name </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if we want to simplify the task of creating a connection procedure, we can also use PowerShell - StartRDP.ps1</font></font><br>
<br>
<pre><code class="plaintext hljs">Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 19000<font></font>
Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 16000<font></font>
mstsc /v:my_router.sn.mynetname.net:33890</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also a little about the RDP client in Windows: MS has come a long way to optimizing the protocol and its server and client side, has implemented many useful features - such as working with hardware 3D, optimizing the screen resolution for your monitor, multi-screen, and more. But of course, everything is implemented in backward compatibility mode and if the client is Windows 7 and the remote PC is Windows 10, then RDP will work using the protocol version 7.0. But the benefit is that you can upgrade RDP versions to more recent versions - for example, you can upgrade the protocol version from 7.0 (Windows 7) to 8.1. Therefore, for the convenience of clients, it is necessary to maximize the version of the server side, as well as throw off links to upgrade to new versions of RDP protocol clients.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we have a simple and relatively safe technology for remote connection to a working PC or terminal server. </font><font style="vertical-align: inherit;">But for a more secure connection, our Port Knocking method can be complicated for attacks by several orders of magnitude, by adding ports for checking - you can add 3,4,5,6 ... the same logic and in this case a direct intrusion into your network will be almost impossible . </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File blanks for creating a remote connection to RDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495576/index.html">Self-propelled platform on the esp8266 MK with micropython</a></li>
<li><a href="../en495580/index.html">Cucumber JVM - Not Just BDD</a></li>
<li><a href="../en495588/index.html">Creating roguelike in Unity from scratch: dungeon generator</a></li>
<li><a href="../en495592/index.html">How to use dictionaries (and not only)</a></li>
<li><a href="../en495594/index.html">Start making money on software: creating mini-digital-business</a></li>
<li><a href="../en495602/index.html">Starting with Core Data! Difficult in simple words [Part 2]</a></li>
<li><a href="../en495604/index.html">Temporary localization on Symfony 4 + Twig</a></li>
<li><a href="../en495606/index.html">"Social monitoring." Score 1: 0 in our favor</a></li>
<li><a href="../en495608/index.html">[Infographic] Visualization of pandemics in the history of mankind</a></li>
<li><a href="../en495610/index.html">Why the future is not for Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>