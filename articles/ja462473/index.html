<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ğŸ¾ ğŸ¤²ğŸ¼ ğŸ¤™ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ1ãƒ™ã‚¢ãƒ¡ã‚¿ãƒ«ã¸ã®Kubernetes HAã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆDebianï¼‰ ğŸ†™ ğŸ¥€ ğŸ¤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habrã®èª­è€…ã®çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼
 

ã“ã®ãƒ‘ãƒ–ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Kubernetesã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ãŸæœ¬æ ¼çš„ãªã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹ä¸€é€£ã®è¨˜äº‹ã‚’é–‹å§‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ“ä½œã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã®æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚
 Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ1ãƒ™ã‚¢ãƒ¡ã‚¿ãƒ«ã¸ã®Kubernetes HAã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆDebianï¼‰</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462473/"><p><img src="https://habrastorage.org/webt/aq/dx/l3/aqdxl3a5akxfl3rh9b7bzc_kqji.jpeg"></p><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habrã®èª­è€…ã®çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ãƒ‘ãƒ–ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Kubernetesã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ãŸæœ¬æ ¼çš„ãªã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹ä¸€é€£ã®è¨˜äº‹ã‚’é–‹å§‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ“ä½œã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã®æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã ã‘ã§ãªãã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«ã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã€ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚¯ãƒ©ã‚¹ã‚¿ã«è¿½åŠ ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚‚èª¬æ˜ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚</font></font></p><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã¯ã€å°‘ãªãã¨ã‚‚4ã¤ã®è¨˜äº‹ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ™ã‚¢ã‚¢ã‚¤ãƒ­ãƒ³ã«ãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã€æ¨™æº–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã€ä¸Šã‚Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2ç•ªç›®ã®è¨˜äº‹ã§ã¯ã€Cephãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã¨ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§RBDãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ä½¿ç”¨ã‚’é–‹å§‹ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»–ã®ç¨®é¡ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã«ã¤ã„ã¦ã‚‚å°‘ã—è§¦ã‚Œã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€ä½œæˆã•ã‚ŒãŸCEPHã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦S3ãƒ•ã‚©ãƒ¼ãƒ«ãƒˆãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3ç•ªç›®ã®è¨˜äº‹ã§ã¯ã€ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼MySqlã‚’Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€ã¤ã¾ã‚ŠKubernetesä¸Šã®Percona XtraDBã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’kubernetesã«è»¢é€ã™ã‚‹ã“ã¨ã‚’æ±ºå®šã—ãŸã¨ãã«ç™ºç”Ÿã—ãŸã™ã¹ã¦ã®å•é¡Œã«ã¤ã„ã¦ã‚‚èª¬æ˜ã—ã¾ã™ã€‚</font></font></li>
<li>         ,     ,       ceph. ,   ingress              Let's Encrypt.  â€”        .     RBAC      .      Helm   .<br>
     ,  â€”   !<a name="habracut"></a></li>
</ol><br>
<h2>:</h2><br>
<p>    ?   ,  ,        Kubernetes.       ,       .   â€”   ,             Kubernetes. ,  -       .</p><br>
<h4>         :</h4><br>
<ul>
<li> ,    kubernetes,  : pod, deployment, service, ingress  . </li>
<li>CNI (Container Networking Interface)    ,   callico   ,   .</li>
<li>  docker .</li>
<li> CI\CD. (  ,    )</li>
<li>helm;      ,           .</li>
</ul><br>
<h4>    :</h4><br>
<ul>
<li>    Kubernetes.    kubeadm.               ,    ETCD,    kube admina.       Ingress        worknodes  api .<br>
 ,     kubernetes    , , kubespray    rancher. , -     . ,  ,         .</li>
<li> CEPH     CEPH,       ceph   Kubernetes .</li>
<li>local-storages,    kubernetes,       hostpath  .</li>
<li>kubernetes    Percona XtraDB Cluster   ,                .          percona.</li>
</ul><br>
<h2>:</h2><br>
<ol>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">C ,  ,    </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> HA  kubernetes</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     before you begin</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  create-config.sh</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Kubelet, Kubectl, Kubeadm  docker </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ETCD ( ) </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   kubernetes</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> CNI Callico</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     kubernetes</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> worker   </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> haproxy  worker   HA</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Ingress </a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Web UI (Dashboard)</a></li>
</ol><br>
<a name="vm"></a><br>
<h2>   </h2><br>
<p>            Debian 9 stretch c  4.19.0-0.bpo.5-amd64.     Proxmox VE.</p><br>
<h4>    :</h4><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><b>Name</b></th>
<th><b>IP </b></th>
<th><b>Comment</b></th>
<th><b>CPU</b></th>
<th><b>MEM</b></th>
<th><b>DISK1</b></th>
<th><b>DISK2</b></th>
</tr>
<tr>
<td>master01</td>
<td>10.73.71.25</td>
<td>master node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>---</td>
</tr>
<tr>
<td>master02</td>
<td>10.73.71.26</td>
<td>master node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>---</td>
</tr>
<tr>
<td>master03</td>
<td>10.73.71.27</td>
<td>master node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>---</td>
</tr>
<tr>
<td>worknode01</td>
<td>10.73.75.241</td>
<td>work node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>SSD</td>
</tr>
<tr>
<td>worknode02</td>
<td>10.73.75.242</td>
<td>work node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>SSD</td>
</tr>
<tr>
<td>worknode03</td>
<td>10.73.75.243</td>
<td>work node </td>
<td>4vcpu</td>
<td>4Gb</td>
<td>HDD</td>
<td>SSD</td>
</tr>
</tbody></table></div><br>
<p> ,         ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,          4.   ,     ,      CNI Callico<br>
Ceph        .<br>
        ,     ,         .       .</p><br>
<h2>   </h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><b>Name</b></th>
<th><b>Version</b></th>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.15.1</td>
</tr>
<tr>
<td>Docker</td>
<td>19.3.1</td>
</tr>
</tbody></table></div><br>
<p>Kubeadm,    1.14,   API  v1alpha3     API  v1beta1,      ,         v1beta1.<br>
,  ,       kubernetes .       ,  ""       ""  .<br>
      ,         .    -  root,    .<br>
  ,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">github</a><br>
, .</p><br>
<a name="ha-image"></a><br>
<h2> HA  kubernetes</h2><br>
<p><img src="https://habrastorage.org/webt/ch/mx/pg/chmxpgzdyk0bvxwx7-6lawqfmvo.jpeg"><br>
  HA .     ,  ,         ,     .<br>
,       master    worker .   master  kubernetes     etcd (   )    kubernetes;    â€” kubeapi.<br>
  etcd master     kubernetes.         ingress     (   )<br>
 worker     kubelet,    api  kubernetes  haproxy     worker .    api   kubelet     127.0.0.1:6443,  haproxy  roundrobin      master ,      master .      HA,         master , worker           master .</p><br>
<a name="begin"></a><br>
<h2>  </h2><br>
<p>        ,     :</p><br>
<pre><code class="plaintext hljs">apt-get update &amp;&amp; apt-get install -y curl apt-transport-https git</code></pre><br>
<p> master      </p><br>
<pre><code class="plaintext hljs">sudo -i<font></font>
git clone https://github.com/rjeka/kubernetes-ceph-percona.git</code></pre><br>
<p>,  ip      ,     API  kubernetes</p><br>
<pre><code class="plaintext hljs">hostname &amp;&amp; hostname -i<font></font>
master01<font></font>
10.73.71.25</code></pre><br>
<p>    master .</p><br>
<p>  SWAP,  kubeadm   </p><br>
<pre><code class="plaintext hljs">[ERROR Swap]: running with swap on is not supported. Please disable swap</code></pre><br>
<p>   </p><br>
<pre><code class="plaintext hljs">swapoff -a</code></pre><br>
<p>     /etc/fstab</p><br>
<a name="create-config"></a><br>
<h2>  create-config.sh</h2><br>
<p>   ,     kubernetes,     create-config.sh.       8 .  IP   hostname  .    etcd tocken,    .           .</p><br>
<pre><code class="plaintext hljs">#!/bin/bash<font></font>
<font></font>
#######################################<font></font>
# all masters settings below must be same<font></font>
#######################################<font></font>
<font></font>
# master01 ip address<font></font>
export K8SHA_IP1=10.73.71.25 <font></font>
<font></font>
# master02 ip address<font></font>
export K8SHA_IP2=10.73.71.26<font></font>
<font></font>
# master03 ip address<font></font>
export K8SHA_IP3=10.73.71.27<font></font>
<font></font>
# master01 hostname<font></font>
export K8SHA_HOSTNAME1=master01<font></font>
<font></font>
# master02 hostname<font></font>
export K8SHA_HOSTNAME2=master02<font></font>
<font></font>
# master03 hostname<font></font>
export K8SHA_HOSTNAME3=master03<font></font>
<font></font>
#etcd tocken:<font></font>
export ETCD_TOKEN=9489bf67bdfe1b3ae077d6fd9e7efefd<font></font>
<font></font>
#etcd version<font></font>
export ETCD_VERSION="v3.3.10"<font></font>
</code></pre><br>
<a name="kernel"></a><br>
<h2>  </h2><br>
<p>   ,        back ,         . ,      ,    ,        kubernetes.  ,  .<br>
       docker,      linux  4.18.        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>.          kubernetes c :</p><br>
<pre><code class="plaintext hljs">waiting for eth0 to become free. Usage count = 1</code></pre><br>
<p>        4.9 </p><br>
<pre><code class="bash hljs">uname -a<font></font>
Linux master01 4.9.0-7-amd64 <span class="hljs-comment">#1 SMP Debian 4.9.110-3+deb9u2 (2018-08-13) x86_64 GNU/Linux</span></code></pre><br>
<p>    kubernetes <br>
 â„–1<br>
 back ports  source list</p><br>
<pre><code class="plaintext hljs">echo deb http://ftp.debian.org/debian stretch-backports main &gt; /etc/apt/sources.list<font></font>
apt-get update<font></font>
apt-cache policy linux-compiler-gcc-6-x86</code></pre><br>
<p> â„–2<br>
 </p><br>
<pre><code class="plaintext hljs">apt install -y -t stretch-backports linux-image-amd64 linux-headers-amd64</code></pre><br>
<p> â„–3<br>
</p><br>
<pre><code class="plaintext hljs">reboot</code></pre><br>
<p>   </p><br>
<pre><code class="plaintext hljs">uname -a<font></font>
Linux master01 4.19.0-0.bpo.5-amd64 #1 SMP Debian 4.19.37-4~bpo9+1 (2019-06-19) x86_64 GNU/Linux<font></font>
</code></pre><br>
<a name="kubelet"></a><br>
<h2>    Kubelet, Kubectl, Kubeadm  docker</h2><br>
<h4> Kubelet, Kubectl, Kubeadm</h4><br>
<p>    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> kubernetes </a></p><br>
<pre><code class="plaintext hljs">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl<font></font>
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -<font></font>
cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list<font></font>
deb https://apt.kubernetes.io/ kubernetes-xenial main<font></font>
EOF<font></font>
apt-get update<font></font>
apt-get install -y kubelet kubeadm kubectl<font></font>
apt-mark hold kubelet kubeadm kubectl</code></pre><br>
<h4> Docker</h4><br>
<p> docker  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  <br>
</a></p><br>
<pre><code class="plaintext hljs">apt-get remove docker docker-engine docker.io containerd runc<font></font>
apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common</code></pre><br>
<pre><code class="plaintext hljs">curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -<font></font>
apt-key fingerprint 0EBFCD88</code></pre><br>
<pre><code class="plaintext hljs">add-apt-repository \<font></font>
   "deb [arch=amd64] https://download.docker.com/linux/debian \<font></font>
   $(lsb_release -cs) \<font></font>
   stable"</code></pre><br>
<pre><code class="plaintext hljs">apt-get update<font></font>
apt-get install docker-ce docker-ce-cli containerd.io</code></pre><br>
<div class="spoiler"><b class="spoiler_title">   Kubelet, Kubectl, Kubeadm  docker c  ansible</b><div class="spoiler_text"><pre><code class="plaintext hljs">git clone https://github.com/rjeka/kubernetes-ceph-percona.git<font></font>
cd kubernetes-ceph-percona/playbooks<font></font>
vim masters.ini </code></pre><br>
<p>  masters  ip .<br>
  workers  ip  .</p><br>
<pre><code class="plaintext hljs"># sudo c <font></font>
ansible-playbook -i hosts.ini kubelet.yaml -K<font></font>
ansible-playbook -i hosts.ini docker.yaml -K<font></font>
# sudo  <font></font>
ansible-playbook -i hosts.ini kubelet.yaml<font></font>
ansible-playbook -i hosts.ini docker.yaml</code></pre></div></div><br>
<p>         docker,     CRI.    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,        .</p><br>
<a name="etcd"></a><br>
<h2>  ETCD</h2><br>
<p>     ,   : etcd â€”     Â«-Â» c   . etcd   GO    kubernetes ,       .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> kubernetes</a>.<br>
etcd    .     ,  ,    docker ,      .   ,      kubeadm (    ).        .<br>
   etcd   master   ,  ,  systemd,      .   etcd  TLS,    TLS     etcd <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> kubernetes </a><br>
   github   ansible-playbook   etcd    systemd.</p><br>
<h4> â„–1<br>
 ,   systemd</h4><br>
<p>  : (        )<br>
 â„–1<br>
     etcd:</p><br>
<pre><code class="plaintext hljs">mkdir archives<font></font>
cd archives<font></font>
export etcdVersion=v3.3.10<font></font>
wget https://github.com/coreos/etcd/releases/download/$etcdVersion/etcd-$etcdVersion-linux-amd64.tar.gz<font></font>
tar -xvf etcd-$etcdVersion-linux-amd64.tar.gz -C /usr/local/bin/ --strip-components=1</code></pre><br>
<p> â„–2<br>
    ETCD</p><br>
<pre><code class="plaintext hljs">cd ..<font></font>
./create-config.sh etcd</code></pre><br>
<p>     etcd,       etcd.           etcd.<br>
   ,      .    -       . </p><br>
<p> â„–3<br>
 etcd     </p><br>
<pre><code class="plaintext hljs">systemctl start etcd</code></pre><br>
<p>  </p><br>
<pre><code class="plaintext hljs">systemctl status etcd<font></font>
â— etcd.service - etcd<font></font>
   Loaded: loaded (/etc/systemd/system/etcd.service; disabled; vendor preset: enabled)<font></font>
   Active: active (running) since Sun 2019-07-07 02:34:28 MSK; 4min 46s ago<font></font>
     Docs: https://github.com/coreos/etcd<font></font>
 Main PID: 7471 (etcd)<font></font>
    Tasks: 14 (limit: 4915)<font></font>
   CGroup: /system.slice/etcd.service<font></font>
           â””â”€7471 /usr/local/bin/etcd --name master01 --data-dir /var/lib/etcd --listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 --advertise-client-urls http://10.73.71.25:2379,http://10.73.71.<font></font>
<font></font>
Jul 07 02:34:28 master01 etcd[7471]: b11e73358a31b109 [logterm: 1, index: 3, vote: 0] cast MsgVote for f67dd9aaa8a44ab9 [logterm: 2, index: 5] at term 554<font></font>
Jul 07 02:34:28 master01 etcd[7471]: raft.node: b11e73358a31b109 elected leader f67dd9aaa8a44ab9 at term 554<font></font>
Jul 07 02:34:28 master01 etcd[7471]: published {Name:master01 ClientURLs:[http://10.73.71.25:2379 http://10.73.71.25:4001]} to cluster d0979b2e7159c1e6<font></font>
Jul 07 02:34:28 master01 etcd[7471]: ready to serve client requests<font></font>
Jul 07 02:34:28 master01 etcd[7471]: serving insecure client requests on [::]:4001, this is strongly discouraged!<font></font>
Jul 07 02:34:28 master01 systemd[1]: Started etcd.<font></font>
Jul 07 02:34:28 master01 etcd[7471]: ready to serve client requests<font></font>
Jul 07 02:34:28 master01 etcd[7471]: serving insecure client requests on [::]:2379, this is strongly discouraged!<font></font>
Jul 07 02:34:28 master01 etcd[7471]: set the initial cluster version to 3.3<font></font>
Jul 07 02:34:28 master01 etcd[7471]: enabled capabilities for version 3.3<font></font>
lines 1-19</code></pre><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">etcdctl cluster-health<font></font>
member 61db137992290fc is healthy: got healthy result from http://10.73.71.27:2379<font></font>
member b11e73358a31b109 is healthy: got healthy result from http://10.73.71.25:2379<font></font>
member f67dd9aaa8a44ab9 is healthy: got healthy result from http://10.73.71.26:2379<font></font>
cluster is healthy<font></font>
<font></font>
etcdctl member list<font></font>
61db137992290fc: name=master03 peerURLs=http://10.73.71.27:2380 clientURLs=http://10.73.71.27:2379,http://10.73.71.27:4001 isLeader=false<font></font>
b11e73358a31b109: name=master01 peerURLs=http://10.73.71.25:2380 clientURLs=http://10.73.71.25:2379,http://10.73.71.25:4001 isLeader=false<font></font>
f67dd9aaa8a44ab9: name=master02 peerURLs=http://10.73.71.26:2380 clientURLs=http://10.73.71.26:2379,http://10.73.71.26:4001 isLeader=true</code></pre><br>
<div class="spoiler"><b class="spoiler_title"> etcd  c  ansible,   systemd</b><div class="spoiler_text"><p> github      ,      .      ssh       .</p><br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/rjeka/kubernetes-ceph-percona.git
<span class="hljs-built_in">cd</span> kubernetes-ceph-percona/playbooks<font></font>
vim masters.ini </code></pre><br>
<p>  masters  ip .<br>
etcd_version â€”  etcd.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> etcd  github</a>.       v3.3.13   v3.3.10.<br>
etcdToken â€”    ,   .<br>
  </p><br>
<pre><code class="bash hljs"><span class="hljs-comment"># sudo c </span><font></font>
ansible-playbook -i hosts.ini -l masters etcd.yaml -K<font></font>
BECOME password: &lt;sudo &gt;<font></font>
<span class="hljs-comment"># sudo </span>
ansible-playbook -i hosts.ini -l masters etcd.yaml</code></pre></div></div><br>
<p>    etcd  ,    . </p><br>
<div class="spoiler"><b class="spoiler_title"> etcd  c  docker-compose,   </b><div class="spoiler_text"><p>        .<br>
 github    </p><br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/rjeka/kubernetes-ceph-percona.git
<span class="hljs-built_in">cd</span> kubernetes-ceph-percona</code></pre><br>
<p>etcd_version â€”  etcd.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> etcd  github</a>.       v3.3.13   v3.3.10.<br>
etcdToken â€”    ,   .</p><br>
<p> docker-compose</p><br>
<pre><code class="plaintext hljs">apt-get install -y docker-compose</code></pre><br>
<p> </p><br>
<pre><code class="plaintext hljs">./create-config.sh docker</code></pre><br>
<p>   etcd  </p><br>
<pre><code class="plaintext hljs">docker-compose --file etcd-docker/docker-compose.yaml up -d</code></pre><br>
<p>   </p><br>
<pre><code class="plaintext hljs">docker ps</code></pre><br>
<p>   etcd</p><br>
<pre><code class="plaintext hljs">root@master01:~/kubernetes-ceph-percona# docker exec -ti etcd etcdctl cluster-health<font></font>
member 61db137992290fc is healthy: got healthy result from http://10.73.71.27:2379<font></font>
member b11e73358a31b109 is healthy: got healthy result from http://10.73.71.25:2379<font></font>
member f67dd9aaa8a44ab9 is healthy: got healthy result from http://10.73.71.26:2379<font></font>
<font></font>
cluster is healthy<font></font>
root@master01:~/kubernetes-ceph-percona# docker exec -ti etcd etcdctl member list<font></font>
61db137992290fc: name=etcd3 peerURLs=http://10.73.71.27:2380 clientURLs=http://10.73.71.27:2379,http://10.73.71.27:4001 isLeader=false<font></font>
b11e73358a31b109: name=etcd1 peerURLs=http://10.73.71.25:2380 clientURLs=http://10.73.71.25:2379,http://10.73.71.25:4001 isLeader=true<font></font>
f67dd9aaa8a44ab9: name=etcd2 peerURLs=http://10.73.71.26:2380 clientURLs=http://10.73.71.26:2379,http://10.73.71.26:4001 isLeader=false</code></pre><br>
<p>       </p><br>
<pre><code class="plaintext hljs">docker logs etcd</code></pre></div></div><br>
<a name="master-one"></a><br>
<h2>   kubernetes</h2><br>
<p>       kubeadmin </p><br>
<pre><code class="plaintext hljs">./create-config.sh kubeadm</code></pre><br>
<div class="spoiler"><b class="spoiler_title">   kubeadm</b><div class="spoiler_text"><pre><code class="plaintext hljs">apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: InitConfiguration<font></font>
localAPIEndpoint:<font></font>
  advertiseAddress: 10.73.71.25 #    API-<font></font>
---<font></font>
apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: ClusterConfiguration<font></font>
kubernetesVersion: stable #     <font></font>
apiServer: #    kubeadm  <font></font>
  certSANs:<font></font>
  - 127.0.0.1<font></font>
  - 10.73.71.25<font></font>
  - 10.73.71.26<font></font>
  - 10.73.71.27<font></font>
controlPlaneEndpoint: 10.73.71.25 #    <font></font>
etcd: #  etc<font></font>
  external:<font></font>
    endpoints:<font></font>
    - http://10.73.71.25:2379 <font></font>
    - http://10.73.71.26:2379<font></font>
    - http://10.73.71.27:2379<font></font>
networking:<font></font>
  podSubnet: 192.168.0.0/16 #   ,   CNI  .</code></pre><br>
<p>   CNI   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> kubernetes</a><br>
   .             . ,     2 ,     certSANs  .<br>
      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> API kubeadm</a>.</p></div></div><br>
<p>  </p><br>
<pre><code class="plaintext hljs">kubeadm init  --config=kubeadmin/kubeadm-init.yaml</code></pre><br>
<p> kubeadm   ,        :</p><br>
<pre><code class="plaintext hljs">You can now join any number of control-plane nodes by copying certificate authorities<font></font>
and service account keys on each node and then running the following as root:<font></font>
<font></font>
  kubeadm join 10.73.71.25:6443 --token ivwoap.259retezqf34amx8 \<font></font>
    --discovery-token-ca-cert-hash sha256:b5c93e32457c8e6478782ff62e8ef77acf72738dda59cd603cdf4821abe12ca3 \<font></font>
    --control-plane<font></font>
<font></font>
Then you can join any number of worker nodes by running the following on each as root:<font></font>
<font></font>
kubeadm join 10.73.71.25:6443 --token ivwoap.259retezqf34amx8 \<font></font>
    --discovery-token-ca-cert-hash sha256:b5c93e32457c8e6478782ff62e8ef77acf72738dda59cd603cdf4821abe12ca3</code></pre><br>
<a name="callica"></a><br>
<h2> CNI Calico</h2><br>
<p>   ,      .   calico,    .<br>
      kubelet.     master01<br>
   - root</p><br>
<pre><code class="plaintext hljs">export KUBECONFIG=/etc/kubernetes/admin.conf</code></pre><br>
<p> -  </p><br>
<pre><code class="plaintext hljs">mkdir -p $HOME/.kube<font></font>
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
sudo chown $(id -u):$(id -g) $HOME/.kube/config</code></pre><br>
<p>           .     /etc/kubernetes/admin.conf         $HOME/.kube/config</p><br>
<p> CNI <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  kubernetes<br>
</a></p><br>
<pre><code class="plaintext hljs">kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br>
<p>,     </p><br>
<pre><code class="plaintext hljs">watch -n1 kubectl get pods -A<font></font>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE<font></font>
kube-system   calico-kube-controllers-59f54d6bbc-psr2z   1/1     Running   0          96s<font></font>
kube-system   calico-node-hm49z                          1/1     Running   0          96s<font></font>
kube-system   coredns-5c98db65d4-svcx9                   1/1     Running   0          77m<font></font>
kube-system   coredns-5c98db65d4-zdlb8                   1/1     Running   0          77m<font></font>
kube-system   kube-apiserver-master01                    1/1     Running   0          76m<font></font>
kube-system   kube-controller-manager-master01           1/1     Running   0          77m<font></font>
kube-system   kube-proxy-nkdqn                           1/1     Running   0          77m<font></font>
kube-system   kube-scheduler-master01                    1/1     Running   0          77m</code></pre><br>
<a name="mastes-other"></a><br>
<h2>     kubernetes</h2><br>
<p> ,   master02  master03,   master01  ,   kubeadm   .     scp<br>
 master01</p><br>
<pre><code class="plaintext hljs">export master02=10.73.71.26<font></font>
export master03=10.73.71.27<font></font>
scp -r /etc/kubernetes/pki $master02:/etc/kubernetes/ <font></font>
scp -r /etc/kubernetes/pki $master03:/etc/kubernetes/</code></pre><br>
<p> master02  master03<br>
   kubeadm</p><br>
<pre><code class="plaintext hljs">./create-config.sh kubeadm</code></pre><br>
<p>    master02  master03</p><br>
<pre><code class="plaintext hljs">kubeadm init  --config=kubeadmin/kubeadm-init.yaml</code></pre><br>
<div class="spoiler"><b class="spoiler_title">     !!!!</b><div class="spoiler_text"><p>    kubernetes v1.13.5  calico v3.3.       .<br>
       stable (      v1.15.1 kubernetes   3.8 callico)    ,      CNI</p><br>
<pre><code class="plaintext hljs">root@master01:~/kubernetes-ceph-percona# kubectl get pods  -A -w<font></font>
NAMESPACE     NAME                                       READY   STATUS              RESTARTS   AGE<font></font>
kube-system   calico-kube-controllers-658558ddf8-t6gfs   0/1     ContainerCreating   0          11s<font></font>
kube-system   calico-node-7td8g                          1/1     Running             0          11s<font></font>
kube-system   calico-node-dthg5                          0/1     CrashLoopBackOff    1          11s<font></font>
kube-system   calico-node-tvhkq                          0/1     CrashLoopBackOff    1          11s</code></pre><br>
<p>  calico daemon set,   ,      <br>
 githab  issue    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://github.com/projectcalico/calico/issues/2720</a><br>
  daemon set calico-node    env  IP_AUTODETECTION_METHOD</p><br>
<pre><code class="plaintext hljs">kubectl edit -n kube-system ds calico-node</code></pre><br>
<p>  IP_AUTODETECTION_METHOD    ,    ;     ens19</p><br>
<pre><code class="plaintext hljs">- name: IP_AUTODETECTION_METHOD<font></font>
  value: ens19</code></pre><br>
<p><img src="https://habrastorage.org/webt/xe/pq/7h/xepq7hbpjwhgowfk0hkc6-ryw8a.png"><br>
,       </p><br>
<pre><code class="plaintext hljs"># kubectl get nodes<font></font>
NAME       STATUS   ROLES    AGE   VERSION<font></font>
master01   Ready    master   28m   v1.15.1<font></font>
master02   Ready    master   26m   v1.15.1<font></font>
master03   Ready    master   18m   v1.15.1</code></pre><br>
<p>   calica</p><br>
<pre><code class="plaintext hljs"># kubectl get pods -A -o wide | grep calico<font></font>
kube-system   calico-kube-controllers-59f54d6bbc-5lxgn   1/1     Running   0          27m<font></font>
kube-system   calico-node-fngpz                          1/1     Running   1          24m<font></font>
kube-system   calico-node-gk7rh                          1/1     Running   0          8m55s<font></font>
kube-system   calico-node-w4xtt                          1/1     Running   0          25m</code></pre></div></div><br>
<a name="worknodes"></a><br>
<h2> worker   </h2><br>
<p>      ,     master .  master  â€”  ,    api, scheduler     kubernetes.  ,      ,     worker .<br>
    ,       master .      . </p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><p> ,      master ,       </p><br>
<pre><code class="plaintext hljs">kubectl taint nodes --all node-role.kubernetes.io/master-</code></pre></div></div><br>
<p>  worker  kubelet, kubeadm, kubectl     master </p><br>
<div class="spoiler"><b class="spoiler_title"> kubelet, kubeadm, kubectl  </b><div class="spoiler_text"><pre><code class="plaintext hljs">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl<font></font>
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -<font></font>
cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list<font></font>
deb https://apt.kubernetes.io/ kubernetes-xenial main<font></font>
EOF<font></font>
apt-get update<font></font>
apt-get install -y kubelet kubeadm kubectl<font></font>
apt-mark hold kubelet kubeadm kubectl</code></pre><br>
<h4> Docker</h4><br>
<p> docker  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  <br>
</a></p><br>
<pre><code class="plaintext hljs">apt-get remove docker docker-engine docker.io containerd runc<font></font>
apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common</code></pre><br>
<pre><code class="plaintext hljs">curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -<font></font>
apt-key fingerprint 0EBFCD88</code></pre><br>
<pre><code class="plaintext hljs">add-apt-repository \<font></font>
   "deb [arch=amd64] https://download.docker.com/linux/debian \<font></font>
   $(lsb_release -cs) \<font></font>
   stable"</code></pre><br>
<pre><code class="plaintext hljs">apt-get update<font></font>
apt-get install docker-ce docker-ce-cli containerd.io</code></pre><br>
<div class="spoiler"><b class="spoiler_title">   Kubelet, Kubectl, Kubeadm  docker c  ansible</b><div class="spoiler_text"><pre><code class="plaintext hljs">git clone https://github.com/rjeka/kubernetes-ceph-percona.git<font></font>
cd kubernetes-ceph-percona/playbooks<font></font>
vim masters.ini </code></pre><br>
<p>  masters  ip .<br>
  workers  ip  .</p><br>
<pre><code class="plaintext hljs"># sudo c <font></font>
ansible-playbook -i hosts.ini kubelet.yaml -K<font></font>
ansible-playbook -i hosts.ini docker.yaml -K<font></font>
# sudo  <font></font>
ansible-playbook -i hosts.ini kubelet.yaml<font></font>
ansible-playbook -i hosts.ini docker.yaml</code></pre></div></div></div></div><br>
<p>      ,    kubeadm    .<br>
    . </p><br>
<pre><code class="plaintext hljs">kubeadm join 10.73.71.25:6443 --token ivwoap.259retezqf34amx8 \<font></font>
    --discovery-token-ca-cert-hash sha256:b5c93e32457c8e6478782ff62e8ef77acf72738dda59cd603cdf4821abe12ca3</code></pre><br>
<p>      worker .<br>
    ,    </p><br>
<pre><code class="plaintext hljs">kubeadm token create --print-join-command --ttl=0</code></pre><br>
<p> ,  kubeadm ,          </p><br>
<pre><code class="plaintext hljs">This node has joined the cluster:<font></font>
* Certificate signing request was sent to apiserver and a response was received.<font></font>
* The Kubelet was informed of the new secure connection details.<font></font>
<font></font>
Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</code></pre><br>
<p>    </p><br>
<pre><code class="plaintext hljs">root@master01:~# kubectl get nodes<font></font>
NAME         STATUS   ROLES    AGE     VERSION<font></font>
master01     Ready    master   10d     v1.15.1<font></font>
master02     Ready    master   10d     v1.15.1<font></font>
master03     Ready    master   10d     v1.15.1<font></font>
worknode01   Ready    &lt;none&gt;   5m44s   v1.15.1<font></font>
worknode02   Ready    &lt;none&gt;   59s     v1.15.1<font></font>
worknode03   Ready    &lt;none&gt;   51s     v1.15.1</code></pre><br>
<a name="haproxy"></a><br>
<h2> haproxy  worknodes</h2><br>
<p>       master    worker .<br>
  ,    worker    HA .<br>
     kubelet,   ,   worker      master   . </p><br>
<pre><code class="plaintext hljs">root@worknode01:~# cat /etc/kubernetes/kubelet.conf | grep server:<font></font>
    server: https://10.73.71.27:6443</code></pre><br>
<p>    master03.   ,    master03, worker     API  .      HA,       Load Balancer (Haproxy),   round robin      master ,    kubelet  worker       127.0.0.1:6443<br>
   HAProxy   worker .<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">    </a></p><br>
<pre><code class="plaintext hljs">curl https://haproxy.debian.net/bernat.debian.org.gpg | \<font></font>
      apt-key add -<font></font>
echo deb http://haproxy.debian.net stretch-backports-2.0 main | \<font></font>
      tee /etc/apt/sources.list.d/haproxy.list<font></font>
apt-get update<font></font>
apt-get install haproxy=2.0.\*</code></pre><br>
<p> ,  HAproxy,       .<br>
  worker      ,   </p><br>
<pre><code class="plaintext hljs">git clone https://github.com/rjeka/kubernetes-ceph-percona.git<font></font>
cd kubernetes-ceph-percona/</code></pre><br>
<p>      haproxy</p><br>
<pre><code class="plaintext hljs">./create-config.sh haproxy</code></pre><br>
<p>    haproxy.<br>
,  haproxy    6443.</p><br>
<pre><code class="plaintext hljs">root@worknode01:~/kubernetes-ceph-percona# netstat -alpn | grep 6443<font></font>
tcp        0      0 127.0.0.1:6443          0.0.0.0:*               LISTEN      30675/haproxy<font></font>
tcp        0      0 10.73.75.241:6443       0.0.0.0:*               LISTEN      30675/haproxy</code></pre><br>
<p>    kubelet,     localhost  master .      server   /etc/kubernetes/kubelet.conf  /etc/kubernetes/bootstrap-kubelet.conf   worker .</p><br>
<pre><code class="plaintext hljs">vim  /etc/kubernetes/kubelet.conf<font></font>
vim /etc/kubernetes/bootstrap-kubelet.conf</code></pre><br>
<p> server     :</p><br>
<pre><code class="plaintext hljs">server: https://127.0.0.1:6443</code></pre><br>
<p>      kubelet  docker </p><br>
<pre><code class="plaintext hljs">systemctl restart kubelet &amp;&amp; systemctl restart docker</code></pre><br>
<p>,     </p><br>
<pre><code class="plaintext hljs">kubectl get nodes<font></font>
NAME         STATUS   ROLES    AGE     VERSION<font></font>
master01     Ready    master   29m     v1.15.1<font></font>
master02     Ready    master   27m     v1.15.1<font></font>
master03     Ready    master   26m     v1.15.1<font></font>
worknode01   Ready    &lt;none&gt;   25m     v1.15.1<font></font>
worknode02   Ready    &lt;none&gt;   3m15s   v1.15.1<font></font>
worknode03   Ready    &lt;none&gt;   3m16s   v1.15.1</code></pre><br>
<p>       ,    HA.      kubelet   master   ,     .</p><br>
<pre><code class="plaintext hljs">systemctl stop kubelet &amp;&amp; systemctl stop docker</code></pre><br>
<p>   master </p><br>
<pre><code class="plaintext hljs">root@master02:~# kubectl get nodes<font></font>
NAME         STATUS     ROLES    AGE   VERSION<font></font>
master01     NotReady   master   15h   v1.15.1<font></font>
master02     Ready      master   15h   v1.15.1<font></font>
master03     Ready      master   15h   v1.15.1<font></font>
worknode01   Ready      &lt;none&gt;   15h   v1.15.1<font></font>
worknode02   Ready      &lt;none&gt;   15h   v1.15.1<font></font>
worknode03   Ready      &lt;none&gt;   15h   v1.15.1</code></pre><br>
<p>   ,  ,     .<br>
     kubernetes   master </p><br>
<pre><code class="plaintext hljs">systemctl start kubelet &amp;&amp; systemctl start docker</code></pre><br>
<a name="ingress"></a><br>
<h2> Ingress </h2><br>
<p>Ingress  â€”   Kubernetes, c          .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> Kuberbnetes</a>. Ingress     ,     Nginx.       .   ,    Ingress   Nginx    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a></p><br>
<p>  ,      master01.<br>
  </p><br>
<pre><code class="plaintext hljs">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</code></pre><br>
<p>  â€” ,     <br>
   </p><br>
<pre><code class="plaintext hljs">./create-config.sh ingress</code></pre><br>
<p>      </p><br>
<pre><code class="plaintext hljs">kubectl apply -f ingress/service-nodeport.yaml</code></pre><br>
<p>,   Ingress         </p><br>
<pre><code class="plaintext hljs"># kubectl get svc -n ingress-nginx<font></font>
NAME            TYPE       CLUSTER-IP    EXTERNAL-IP                           PORT(S)                      AGE<font></font>
ingress-nginx   NodePort   10.99.35.95   10.73.71.25,10.73.71.26,10.73.71.27   80:31669/TCP,443:31604/TCP   10m</code></pre><br>
<pre><code class="plaintext hljs"> kubectl describe svc -n ingress-nginx ingress-nginx<font></font>
Name:                     ingress-nginx<font></font>
Namespace:                ingress-nginx<font></font>
Labels:                   app.kubernetes.io/name=ingress-nginx<font></font>
                          app.kubernetes.io/part-of=ingress-nginx<font></font>
Annotations:              kubectl.kubernetes.io/last-applied-configuration:<font></font>
                            {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"app.kubernetes.io/name":"ingress-nginx","app.kubernetes.io/par...<font></font>
Selector:                 app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx<font></font>
Type:                     NodePort<font></font>
IP:                       10.99.35.95<font></font>
External IPs:             10.73.71.25,10.73.71.26,10.73.71.27<font></font>
Port:                     http  80/TCP<font></font>
TargetPort:               80/TCP<font></font>
NodePort:                 http  31669/TCP<font></font>
Endpoints:                192.168.142.129:80<font></font>
Port:                     https  443/TCP<font></font>
TargetPort:               443/TCP<font></font>
NodePort:                 https  31604/TCP<font></font>
Endpoints:                192.168.142.129:443<font></font>
Session Affinity:         None<font></font>
External Traffic Policy:  Cluster<font></font>
Events:                   &lt;none&gt;</code></pre><br>
<a name="dashboard"></a><br>
<h2> Web UI (Dashboard)</h2><br>
<p> Kubernetes   Web UI,            .       dashboard        .<br>
     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> kubernetes</a><br>
.    , 2.0    .</p><br>
<pre><code class="plaintext hljs"># <font></font>
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml<font></font>
# 2.0<font></font>
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta1/aio/deploy/recommended.yaml</code></pre><br>
<p> ,       ,     </p><br>
<pre><code class="plaintext hljs">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/.</code></pre><br>
<p>  ,    ,          kubectl proxy.       .    service  ,    dashboard          30443.        , ,  ingress. ,       .<br>
      </p><br>
<pre><code class="plaintext hljs">kubectl apply -f dashboard/service-nodeport.yaml</code></pre><br>
<p>  admin   token      </p><br>
<pre><code class="plaintext hljs">kubectl apply -f dashboard/rbac.yaml<font></font>
kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')</code></pre><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://10.73.71.25:30443</a><br>
<img src="https://habrastorage.org/webt/p7/zu/8q/p7zu8qv47mwdsmdydtvyo7gs_y4.png"><br>
  dashboard<br>
<img src="https://habrastorage.org/webt/h2/ks/jq/h2ksjq_7egqatf4ulnl0zkwqvqk.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠã‚ã§ã¨ã†ï¼</font><font style="vertical-align: inherit;">ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é”ã—ãŸå ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãŒã§ãã¦ã„ã‚‹kubernetesã®HAã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesã¯ã€ã•ã¾ã–ã¾ãªã‚¢ãƒ‰ã‚ªãƒ³ãŒå¿…è¦ãªãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒãƒƒã‚¯ãƒœãƒ¼ãƒ³ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã‚‰ã®ã„ãã¤ã‹ã«ã¤ã„ã¦ã¯ã€ä»Šå¾Œã®å‡ºç‰ˆç‰©ã§ãŠè©±ã—ã™ã‚‹äºˆå®šã§ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚³ãƒ¡ãƒ³ãƒˆã€GitHubã€ã¾ãŸã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¿ƒã‹ã‚‰ã€ã‚¨ãƒ•ã‚²ãƒ‹ãƒ¼ãƒ»ãƒ­ãƒ‡ã‚£ã‚ªãƒãƒ•</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462459/index.html">CC2531ã‚’ä½¿ç”¨ã—ã¦Homebridgeã«ZigBeeãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ ã™ã‚‹</a></li>
<li><a href="../ja462461/index.html">GOES-17è¡çªèª¿æŸ»çµæœ</a></li>
<li><a href="../ja462465/index.html">Appleã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ãƒ¼ã‚¹ã®ä½¿ç”¨</a></li>
<li><a href="../ja462469/index.html">ã€Œã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã€ã‚¿ã‚¹ã‚¯ã®ãŸã‚ã®Rã§ã®ä¸¦è¡Œã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«é–¢ã™ã‚‹ã„ãã¤ã‹ã®è€ƒæ…®äº‹é …</a></li>
<li><a href="../ja462471/index.html">pwnable.kr 16ã§ã‚¸ãƒ§ãƒ–ã‚’è§£æ±ºã™ã‚‹-uafã€‚è§£æ”¾å¾Œã®è„†å¼±æ€§ã‚’ä½¿ç”¨</a></li>
<li><a href="../ja462475/index.html">ĞĞ»ĞµĞºÑĞµĞ¹ Ğ¡Ğ°Ğ²Ğ²Ğ°Ñ‚ĞµĞµĞ²: ĞšĞ°Ğº Ğ±Ğ¾Ñ€Ğ¾Ñ‚ÑŒÑÑ Ñ ĞºĞ¾Ñ€Ñ€ÑƒĞ¿Ñ†Ğ¸ĞµĞ¹ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ¸ (ĞĞ¾Ğ±ĞµĞ»ĞµĞ²ÑĞºĞ°Ñ Ğ¿Ñ€ĞµĞ¼Ğ¸Ñ Ğ¿Ğ¾ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞµ Ğ·Ğ° 2016 Ğ³Ğ¾Ğ´)</a></li>
<li><a href="../ja462477/index.html">ç§‘å­¦è€…ã¯AIã‚’æ–°ã—ã„ç‰¹è¨±ã®ä½œæˆè€…ã§ã‚ã‚‹ã¨ä¸»å¼µã—ã€ç‰¹è¨±æ³•ã‚’å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™</a></li>
<li><a href="../ja462479/index.html">Steam Windowsã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ­ãƒ¼ã‚«ãƒ«æ¨©é™ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0day</a></li>
<li><a href="../ja462481/index.html">ã‚¿ã‚¤ãƒ—ã‚·ã‚¹ãƒ†ãƒ FAQ</a></li>
<li><a href="../ja462483/index.html">é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ï¼šåŠ´åƒç”Ÿç”£æ€§ã‚’æ®ºã™é¢¨å¤‰ã‚ã‚ŠãªãŠã‚‚ã¡ã‚ƒã€‚ãƒ‘ãƒ¼ãƒˆ1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>