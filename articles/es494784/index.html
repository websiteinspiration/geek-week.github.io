<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåñ üîÆ üë®üèø‚Äçüíª DBLog: un marco com√∫n para la captura de datos modificados üêú üöÆ üåó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Hola a todos! Le ofrecemos leer la traducci√≥n del art√≠culo, que preparamos especialmente para los estudiantes del curso "Arquitecto de alta carga" .
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBLog: un marco com√∫n para la captura de datos modificados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/494784/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Hola a todos! </font><font style="vertical-align: inherit;">Le ofrecemos leer la traducci√≥n del art√≠culo, que preparamos especialmente para los estudiantes del curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Arquitecto de alta carga"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/0l/li/m7/0llim77k9jjhhp94nyd5qozgmxw.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El seguimiento de los cambios de datos (Change Data Capture, CDC) le permite recibir en tiempo real los cambios confirmados en la base de datos y distribuirlos a varios consumidores [1] [2]. Los CDC se est√°n volviendo cada vez m√°s populares cuando se requiere la sincronizaci√≥n entre el almacenamiento heterog√©neo de datos (por ejemplo, MySQL y ElasticSearch) y es una alternativa a los m√©todos tradicionales como la escritura dual y las transacciones distribuidas [3] [4].</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fuente del CDC, en bases de datos como MySQL y PostgreSQL, es el registro de transacciones (registro de transacciones). Pero dado que los registros de transacciones generalmente se truncan, es posible que no contengan todo el historial de cambios. Por lo tanto, para obtener el estado completo de la fuente, necesitamos volcados. Examinamos varios proyectos de CDC de c√≥digo abierto, a menudo utilizando las mismas bibliotecas, API de bases de datos y protocolos, y encontramos una serie de limitaciones en ellos que no cumpl√≠an con nuestros requisitos. Por ejemplo, detener el procesamiento de eventos de registro hasta la finalizaci√≥n del volcado (instant√°nea de datos completa), la imposibilidad de iniciar el volcado de volcado bajo demanda o implementaci√≥n, afectando el tr√°fico de escritura debido al uso de bloqueos de tabla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto nos llev√≥ a desarrollar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBLog.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un enfoque unificado para procesar registros y volcados. </font><font style="vertical-align: inherit;">Para admitirlo, se deben implementar varias funciones en el DBMS, que ya est√°n en MySQL, PostgreSQL, MariaDB y otras bases de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunas de las caracter√≠sticas de DBLog:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los eventos de registro se procesan en el orden en que ocurren.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los volcados se pueden realizar en cualquier momento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para todas las tablas, para una tabla o para claves primarias espec√≠ficas de una tabla.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El procesamiento de registros se alterna con el procesamiento de volcado, dividiendo el volcado en bloques. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, el procesamiento de registros puede tener lugar en paralelo con el procesamiento de volcado. </font><font style="vertical-align: inherit;">Si el proceso finaliza, se puede reanudar despu√©s del √∫ltimo bloque completado sin tener que comenzar de nuevo. </font><font style="vertical-align: inherit;">Tambi√©n le permite ajustar el rendimiento al crear un volcado y, si es necesario, pausar su creaci√≥n.</font></font></li>
<li><b>   </b>,          .</li>
<li><b>   </b>: ,     API.</li>
<li><b>     </b>.    ,           .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, discutimos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traducci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), una plataforma para enriquecimiento y sincronizaci√≥n de datos. El objetivo de Delta es sincronizar varios almacenes de datos, donde uno de ellos es primario (por ejemplo, MySQL) y los otros derivados (por ejemplo, ElasticSearch). Uno de los requisitos clave de desarrollo fue un bajo retraso en la propagaci√≥n de los cambios desde el origen a los destinatarios, as√≠ como una alta disponibilidad del flujo de eventos. Estas condiciones se aplican independientemente de si un equipo usa todos los almacenes de datos o si un equipo posee los datos y el otro los consume. En un art√≠culo sobre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traducci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), tambi√©n describimos casos de uso que van m√°s all√° de la sincronizaci√≥n de datos, como el procesamiento de eventos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para sincronizar datos y procesar eventos, adem√°s de poder realizar un seguimiento de los cambios en tiempo real, debemos cumplir los siguientes requisitos:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obteniendo el estado completo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Las tiendas derivadas (como ElasticSearch) deber√≠an almacenar en √∫ltima instancia el estado completo de la fuente. </font><font style="vertical-align: inherit;">Implementamos esto a trav√©s de volcados de la base de datos original.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comience la recuperaci√≥n del estado en cualquier momento. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En lugar de considerar el volcado como una operaci√≥n √∫nica para la inicializaci√≥n primaria, podemos hacerlo en cualquier momento: para todas las tablas, para una tabla o para claves primarias espec√≠ficas. </font><font style="vertical-align: inherit;">Esto es muy importante para la recuperaci√≥n de los consumidores en casos de p√©rdida de datos o corrupci√≥n.</font></font></li>
<li><b>    - </b>.          . ,        (,    ).              - .  ,  -        .</li>
<li><b>    </b>.                          .     API,     , ,  .        ,          ,  ,  .</li>
<li><b>   </b>.     Netflix   ,   Kafka, SQS, Kinesis,     Netflix,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Keystone</a>.   ,           (,    ),      (,    ).           .        API.</li>
<li><b>   </b>.  Netflix  ,    (MySQL, PostgreSQL)  AWS RDS.        .</li>
</ul><br>
<br>
<h3> </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinamos varias soluciones de c√≥digo abierto existentes, que incluyen: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maxwell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpinalTap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Yelp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL Streamer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debezium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En t√©rminos de recopilaci√≥n de datos, todos funcionan de manera similar, utilizando un registro de transacciones. </font><font style="vertical-align: inherit;">Por ejemplo, usando el protocolo de replicaci√≥n binlog en MySQL o las ranuras de replicaci√≥n en PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero cuando procesan volcados, tienen al menos una de las siguientes limitaciones:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deje de procesar eventos de registro mientras crea un volcado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como resultado, si el volcado es grande, el procesamiento de eventos de registro se detiene durante un per√≠odo prolongado. </font><font style="vertical-align: inherit;">Esto ser√° un problema si los consumidores conf√≠an en peque√±os retrasos en la propagaci√≥n de los cambios.</font></font></li>
<li><b>     </b>.                .                (,   ElasticSearch)        .</li>
<li><b>      </b>.         .                    [5].          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">   </a>,         .         . ,  PostgreSQL RDS        .</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando funciones espec√≠ficas de la base de datos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Descubrimos que algunas soluciones usan caracter√≠sticas de base de datos adicionales que no est√°n presentes en todos los sistemas. </font><font style="vertical-align: inherit;">Por ejemplo, usando el motor de agujeros negros en MySQL u obteniendo una instant√°nea consistente de los volcados a trav√©s de ranuras de replicaci√≥n en PostgreSQL. </font><font style="vertical-align: inherit;">Esto limita la reutilizaci√≥n de c√≥digo entre diferentes bases de datos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, decidimos adoptar un enfoque diferente para trabajar con vertederos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alternar eventos de registro y volcado para que puedan ejecutarse juntos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iniciar un volcado en cualquier momento;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No use cerraduras de mesa</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No use caracter√≠sticas espec√≠ficas de la base de datos.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marco DBLog</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog es un marco de Java para recibir volcados y cambios en tiempo real. Los volcados se realizan en partes para que se alternen con eventos en tiempo real y no retrasen su procesamiento durante un largo per√≠odo. Los volcados se pueden realizar en cualquier momento a trav√©s de la API. Esto permite a los consumidores obtener el estado completo de la base de datos en la etapa de inicializaci√≥n o posterior para la recuperaci√≥n ante desastres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al dise√±ar el marco, pensamos en minimizar el impacto en la base de datos. Los volcados se pueden pausar y reanudar seg√∫n sea necesario. Esto funciona tanto para la recuperaci√≥n de fallos como para detenerse si la base de datos se ha convertido en un cuello de botella. Tampoco bloqueamos las tablas para no afectar las operaciones de escritura.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog le permite grabar eventos en varias formas, incluso en otra base de datos o mediante la API. </font><font style="vertical-align: inherit;">Para almacenar el estado asociado con el procesamiento de registros y volcados, as√≠ como para seleccionar el nodo maestro, utilizamos Zookeeper. </font><font style="vertical-align: inherit;">Al crear DBLog, implementamos la capacidad de conectar varios complementos, lo que le permite cambiar la implementaci√≥n a su gusto (por ejemplo, reemplazar Zookeeper por otra cosa). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, consideramos con m√°s detalle el procesamiento de registros y volcados.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registros</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El marco requiere que la base de datos registre eventos para cada fila cambiada en tiempo real, mientras mantiene el orden de los commits. Se supone que la fuente de estos eventos es el registro de transacciones. La base de datos los env√≠a a trav√©s de un transporte que DBLog puede usar. Para este transporte utilizamos el t√©rmino "registro de cambios". Un evento puede ser de los siguientes tipos: crear, crear, actualizar o eliminar. Para cada evento, se debe proporcionar la siguiente informaci√≥n: el n√∫mero de secuencia en el registro (n√∫mero de secuencia de registro), el estado de la columna durante la operaci√≥n y el esquema que se aplic√≥ en el momento en que se realiz√≥ la operaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada cambio se serializa en el formato de evento DBLog y se env√≠a al escritor para su posterior transferencia a la salida. </font><font style="vertical-align: inherit;">Enviar eventos al escritor es una operaci√≥n sin bloqueo, porque el escritor se ejecuta en un hilo separado y acumula eventos en el b√∫fer interno. </font><font style="vertical-align: inherit;">Los eventos almacenados en el b√∫fer se env√≠an en el orden en que se recibieron. </font><font style="vertical-align: inherit;">El marco le permite conectar un formateador personalizado para serializar eventos en un formato arbitrario. </font><font style="vertical-align: inherit;">La salida es una interfaz simple que le permite conectarse a cualquier destinatario, como una secuencia, un almac√©n de datos o incluso una API.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deshecho</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los volcados son necesarios porque los registros de transacciones tienen un tiempo de almacenamiento limitado, lo que evita que se utilicen para restaurar el conjunto de datos original completo. Los volcados se crean en bloques (fragmento) para que puedan alternar con eventos de registro, lo que les permite ser procesados ‚Äã‚Äãsimult√°neamente. Para cada l√≠nea seleccionada del bloque, se genera un evento y se serializa en el mismo formato que el evento de registro. Por lo tanto, el consumidor no necesita preocuparse de que un evento provenga del registro o el volcado. Tanto los eventos de registro como los eventos de volcado se env√≠an a la salida a trav√©s del mismo escritor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los volcados se pueden programar en cualquier momento a trav√©s de la API para todas las tablas, una tabla o para claves primarias espec√≠ficas de la tabla. Un volcado de la tabla se realiza mediante bloques de un tama√±o determinado. Tambi√©n puede configurar una demora en el procesamiento de nuevos bloques, permitiendo que solo se registren eventos en este momento. El tama√±o del bloque y el retraso le permiten equilibrar el procesamiento de eventos de registro y volcado. Ambas configuraciones se pueden cambiar en tiempo de ejecuci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los bloques (fragmento) se seleccionan ordenando la tabla en orden ascendente de la clave primaria y seleccionando las filas donde la clave primaria es mayor que la √∫ltima clave primaria del bloque anterior. La base de datos es necesaria para ejecutar esta consulta de manera eficiente, lo que generalmente es aplicable a los sistemas que implementan un escaneo de rango en un rango de claves primarias.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/io/cc/kaioccujfq6yx3mcch7btisn-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 1. Desglose de la tabla con 4 columnas c1-c4 y c1 como clave principal (pk). La clave principal de un tipo entero, tama√±o de bloque 3. El bloque 2 se selecciona con la condici√≥n c1&gt; 4. Los</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
bloques deben tomarse de manera que no retrasen el procesamiento de los eventos de registro durante un per√≠odo prolongado y guarden el historial de cambios para que la fila seleccionada con el valor anterior no pueda sobrescribir el m√°s nuevo. evento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para poder seleccionar bloques secuencialmente, en el registro de cambios creamos "marcas de agua" reconocibles. </font><font style="vertical-align: inherit;">Las marcas de agua se implementan a trav√©s de una tabla en la base de datos de origen. </font><font style="vertical-align: inherit;">Esta tabla se almacena en un espacio de nombres especial para que no haya conflictos con las tablas de la aplicaci√≥n. </font><font style="vertical-align: inherit;">Solo se almacena una l√≠nea con un valor UUID. </font><font style="vertical-align: inherit;">Se crea una marca de agua cuando este valor cambia a un UUID espec√≠fico. </font><font style="vertical-align: inherit;">La actualizaci√≥n de la l√≠nea conduce a un evento de cambio, que finalmente recibimos a trav√©s del registro de cambios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los vertederos con marca de agua se crean de la siguiente manera:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suspendemos temporalmente el procesamiento de eventos de registro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Genere una marca de agua "baja" actualizando la tabla de marcas de agua.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenzamos SELECT para el siguiente bloque y guardamos en la memoria el resultado indexado por la clave primaria.</font></font></li>
<li> ‚Äú‚Äù (high)  ,    .</li>
<li>    .         .</li>
<li>              ,     .</li>
<li>     ,     ,         .</li>
<li>   ,     1.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se supone que SELECT devuelve un estado que representa un cambio comprometido hasta un punto de la historia. O, equivalente a lo siguiente: SELECT se ejecuta en una determinada posici√≥n del registro de cambios, teniendo en cuenta los cambios hasta este punto. Las bases de datos generalmente no proporcionan informaci√≥n sobre el tiempo de ejecuci√≥n de un SELECT (con la excepci√≥n de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea principal de nuestro enfoque es que en el registro de cambios definimos una ventana que garantiza la preservaci√≥n de la posici√≥n SELECT en el bloque. La ventana se abre escribiendo la marca de agua inferior, despu√©s de lo cual se ejecuta SELECT, y la ventana se cierra escribiendo la marca de agua superior. Dado que se desconoce la posici√≥n exacta de SELECT, se eliminan todas las filas seleccionadas que entran en conflicto con los eventos de registro en esta ventana. Esto asegura que no hay reescritura del historial en el registro de cambios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que esto funcione, SELECT debe leer el estado de la tabla desde el momento de la marca de agua inferior o posterior (est√° permitido incluir los cambios que se hicieron despu√©s de la marca de agua inferior y antes de leer). En general, se requiere </font><b><font style="vertical-align: inherit;">SELECT</font></b><font style="vertical-align: inherit;"> para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ver los cambios realizados antes de que se ejecute.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lo llamamos "lecturas no obsoletas". Adem√°s, dado que la marca de agua superior se escribe despu√©s, se garantiza que SELECT se ejecutar√° antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las figuras 2a y 2b ilustran el algoritmo de selecci√≥n de bloque. Como ejemplo, damos una tabla con claves primarias de k1 a k6. Cada entrada en el registro de cambios representa un evento de creaci√≥n, actualizaci√≥n o eliminaci√≥n para la clave primaria. La Figura 2a muestra la generaci√≥n de marca de agua y la selecci√≥n de bloque (pasos 1 a 4). La actualizaci√≥n de la tabla de marca de agua en los pasos 2 y 4 crea dos eventos de cambio (magenta), que finalmente se reciben a trav√©s del registro. En la Figura 2b, nos enfocamos en las l√≠neas del bloque actual que se eliminan del conjunto de resultados con las claves principales que aparecen entre las marcas de agua (pasos 5 a 7).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/3w/ej/8w3wej0evpfqtnpdkbozswm58yu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2a - Algoritmo de marca de agua para la selecci√≥n de bloques (pasos 1‚Äì4). </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/sg/i5/9s/sgi59s3d8zgf-f2eusi2itklqyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2b - Algoritmo de marca de agua para seleccionar bloques (pasos 5‚Äì7).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que entre las marcas de agua inferior y superior puede aparecer una gran cantidad de eventos en el registro si una o m√°s transacciones realizaron muchos cambios de l√≠nea. </font><font style="vertical-align: inherit;">Por esta raz√≥n, hacemos una suspensi√≥n a corto plazo del procesamiento del registro en las etapas 2‚Äì4 para no perder las marcas de agua. </font><font style="vertical-align: inherit;">Por lo tanto, el procesamiento de eventos de registro se puede reanudar evento por evento, lo que en √∫ltima instancia le permite detectar marcas de agua sin la necesidad de almacenar en cach√© los eventos de registro del registro. </font><font style="vertical-align: inherit;">El procesamiento de registros se suspende solo por un corto tiempo, ya que se espera que los pasos 2 a 4 sean r√°pidos: la actualizaci√≥n de las marcas de agua es una operaci√≥n de escritura √∫nica, y SELECT se realiza con una restricci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tan pronto como se recibe la marca de agua superior en el paso 7, las l√≠neas no conflictivas del bloque se transmiten a la salida en el orden en que se recibieron. </font><font style="vertical-align: inherit;">Esta es una operaci√≥n sin bloqueo, porque el escritor se ejecuta en un hilo separado, lo que le permite reanudar r√°pidamente el procesamiento del registro despu√©s del paso 7. Despu√©s de eso, el procesamiento del registro contin√∫a para los eventos que ocurren despu√©s de la marca de agua superior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La figura 2c muestra el orden de grabaci√≥n para todo el bloque utilizando el mismo ejemplo que en las figuras 2a y 2b. </font><font style="vertical-align: inherit;">Los eventos en el registro que aparecen antes de la marca de agua superior se registran primero. </font><font style="vertical-align: inherit;">Luego, las l√≠neas restantes del resultado del bloque (magenta). </font><font style="vertical-align: inherit;">Y finalmente, se registran los eventos que ocurren despu√©s de la marca de agua superior. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4y/er/et/4yeretd8vbgtxvbp7sm9ppdxe7m.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2c - El orden de grabaci√≥n de la salida. </font><font style="vertical-align: inherit;">Tira de alternancia con volcado.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de datos compatibles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar DBLog, la base de datos debe proporcionar un registro de cambios como un historial lineal de cambios confirmados con lecturas no obsoletas. Sistemas como MySQL, PostgreSQL, MariaDB, etc. cumplen estas condiciones, por lo que el marco puede utilizarse de la misma manera con estas bases de datos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasta ahora, hemos agregado soporte para MySQL y PostgreSQL. Cada base de datos usa sus propias bibliotecas para recibir eventos de registro, ya que cada uno de ellos usa un protocolo propietario. Para MySQL, utilizamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shyiko / mysql-binlog-connector</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que implementa el protocolo de replicaci√≥n binlog. Para PostgreSQL, hay ranuras de replicaci√≥n con el complemento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal2json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Los cambios se aceptan a trav√©s del protocolo de replicaci√≥n de transmisi√≥n, implementado por el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlador jdbc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL </font><font style="vertical-align: inherit;">La definici√≥n de esquema para cada cambio capturado es diferente en MySQL y PostgreSQL. </font><font style="vertical-align: inherit;">En PostgreSQL, wal2json contiene nombres, tipos de columna y valores. </font><font style="vertical-align: inherit;">Para MySQL, los cambios de esquema deben rastrearse como eventos binlog. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El procesamiento de volcado se realiz√≥ utilizando SQL y JDBC, que requieren solo la implementaci√≥n de la selecci√≥n de bloques y la actualizaci√≥n de la marca de agua. </font><font style="vertical-align: inherit;">Para MySQL y PostgreSQL, se usa el mismo c√≥digo, que se puede usar para otras bases de datos similares. </font><font style="vertical-align: inherit;">El procesamiento de volcado en s√≠ no depende de SQL o JDBC y le permite usar bases de datos que cumplan con los requisitos de DBLog, incluso si usan est√°ndares diferentes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/wg/nz/wuwgnzkxmagsrtt2_qnyp_yfiy8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 3 - Arquitectura DBLog de alto nivel.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alta disponibilidad</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog utiliza una arquitectura activa-pasiva de nodo √∫nico. </font><font style="vertical-align: inherit;">Una instancia es activa (l√≠der), mientras que las otras son pasivas (en espera). </font><font style="vertical-align: inherit;">Para seleccionar el host, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se utiliza una concesi√≥n para el nodo maestro, que debe actualizarse peri√≥dicamente para seguir siendo el maestro. </font><font style="vertical-align: inherit;">En caso de terminaci√≥n de la renovaci√≥n del arrendamiento, las funciones del l√≠der se transfieren a otro nodo. </font><font style="vertical-align: inherit;">Actualmente, implementamos una copia para cada AZ (zona de disponibilidad, generalmente tenemos 3 AZ), por lo que si una AZ cae, entonces la copia en otra AZ puede continuar proces√°ndose con un tiempo de inactividad total m√≠nimo. </font><font style="vertical-align: inherit;">Las instancias de respaldo se pueden ubicar en diferentes regiones, aunque se recomienda que trabaje en la misma regi√≥n que el host de la base de datos para proporcionar baja latencia para capturar cambios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso en producci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog es la base de los conectores MySQL y PostgreSQL utilizados en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Desde 2018, Delta se ha utilizado en producci√≥n para sincronizar almacenes de datos y procesamiento de eventos en aplicaciones de estudio de Netflix. </font><font style="vertical-align: inherit;">Los conectores Delta usan su serializador de eventos. </font><font style="vertical-align: inherit;">Las transmisiones espec√≠ficas de Netflix como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keystone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se utilizan como salida </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5g/3j/fo/5g3jfo6pe8l-mpsqrngh6ylvtyc.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 4 - Conector Delta. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de Delta, DBLog tambi√©n se usa en Netflix para crear conectores para otras plataformas de movimiento de datos que tienen sus propios formatos de datos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√©date con nosotros</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog tiene caracter√≠sticas adicionales que no est√°n cubiertas en este art√≠culo, como:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Posibilidad de obtener esquemas de tabla sin usar bloqueos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integraci√≥n con el esquema de almacenamiento. </font><font style="vertical-align: inherit;">Para cada evento, el esquema se almacena en el almacenamiento, cuyo enlace se indica en la carga √∫til del evento.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo de escritura monot√≥nica. </font><font style="vertical-align: inherit;">Asegurarse de que despu√©s de guardar el estado de una fila en particular, su estado pasado no se pueda sobrescribir. </font><font style="vertical-align: inherit;">Por lo tanto, los consumidores reciben cambios de estado solo en la direcci√≥n hacia adelante, sin avanzar y retroceder en el tiempo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Planeamos abrir el c√≥digo fuente DBLog en 2020 e incluir documentaci√≥n adicional en √©l.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expresiones de gratitud</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queremos agradecer a las siguientes personas por contribuir al desarrollo de DBLog: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Snyder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raghuram Onti Srinivasan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tharanga Gamaethige</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yun Wang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[1] Das, Shirshanka y col. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"¬°Todos a bordo del Databus!: La plataforma escalable de captura de datos de cambios consistentes de Linkedin". </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tercer Simposio de ACM sobre Cloud Computing. </font><font style="vertical-align: inherit;">ACM, 2012 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[2] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Acerca de Change Data Capture (SQL Server)"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , documentos de Microsoft SQL, 2019 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[3] Kleppmann, Martin, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Uso de registros para construir una infraestructura de datos s√≥lida (o: por qu√© las escrituras dobles son una mala idea)"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Confluent, 2015 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[4] Kleppmann, Martin, Alastair R. Beresford, Boerge Svingen. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Procesamiento de eventos en l√≠nea". </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comunicaciones de ACM 62.5 (2019): 43‚Äì49 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[5] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://debezium.io/documentation/reference/0.10/connectors/mysql.html#snapshots </font></font><br>
</a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenga m√°s informaci√≥n sobre el curso.</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es494766/index.html">Tendencias de la tecnolog√≠a de comunicaciones en el futuro cercano</a></li>
<li><a href="../es494772/index.html">C√≥mo se est√° desarrollando la lucha contra las llamadas rob√≥ticas en los EE. UU. - sobre las medidas de los pol√≠ticos y las compa√±√≠as de telecomunicaciones</a></li>
<li><a href="../es494776/index.html">Antipatterns PostgreSQL: c√°lculo de condiciones en SQL</a></li>
<li><a href="../es494780/index.html">Revelaciones y temores de un empleado de Amazon en la era del coronavirus</a></li>
<li><a href="../es494782/index.html">Clasifique im√°genes en Android con TensorFlow Lite y Azure Custom Vision</a></li>
<li><a href="../es494786/index.html">Soporte RTOS tipo MitM en GDB</a></li>
<li><a href="../es494788/index.html">C√≥mo funciona el correo electr√≥nico</a></li>
<li><a href="../es494792/index.html">Yandex.Routing: c√≥mo nos sumergimos en la log√≠stica y decidimos cambiar el futuro</a></li>
<li><a href="../es494794/index.html">Tenemos brazos largos</a></li>
<li><a href="../es494798/index.html">Snowden: la pandemia terminar√°, pero la vigilancia de la poblaci√≥n continuar√°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>