<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏺️ 🧕🏾 🏨 単一のプログラムでの不明なプロセッサリバースエンジニアリング 🕞 ⛅️ 👨‍👨‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR：まったく未知のCPUアーキテクチャ用に作成されたプログラムを、CPUに関するドキュメントなし（エミュレーターなし、ISAなし、すべてなし）で、わずか10時間でリバースエンジニアリングしました。記事から、それがどのように行われたかがわかります... 
 
 先週末、CMU PPPチームと...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>単一のプログラムでの不明なプロセッサリバースエンジニアリング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468849/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/1z/aq/mf1zaqnw0lte41iurmzthf-qjbk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TL; DR：まったく未知のCPUアーキテクチャ用に作成されたプログラムを、CPUに関するドキュメントなし（エミュレーターなし、ISAなし、すべてなし）で、わずか10時間でリバースエンジニアリングしました。記事から、それがどのように行われたかがわかります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先週末、CMU PPPチームと私はDragon Sector Teaser CTF 2019チームに参加して、厳しい締め切りの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHI 2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から離れました</font><font style="vertical-align: inherit;">。 Dragon Sectorは、興味深い</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTFの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史を持つ尊敬されるポーランドのチーム</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。そのため、私は彼らが何を持っているのかと思っていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Micromega uM-FPU浮動小数点コプロセッサのバイトコードのリバースエンジニアリングを含む「ummmfpu」を解決したので、私はCPUアドベンチャーの問題を解決するためのコンテストに参加することにしました。タスクを完了したのは私たちだけでした）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPUアドベンチャータスクの説明は次のとおりです。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">60代の祖父はコンピューターの開発に携わっていました。</font><font style="vertical-align: inherit;">彼の屋根裏部屋で物事を整理していると、奇妙な車を見つけました。</font><font style="vertical-align: inherit;">マシンの横には、「ドラゴンアドベンチャーゲーム」とマークされたパンチカードのスタックがありました。</font><font style="vertical-align: inherit;">しばらくして、私はそれを最新の機器に接続することができましたが、ゲームが複雑すぎて、不正行為なしでは最後までたどり着けません。</font><font style="vertical-align: inherit;">手伝って頂けますか？</font><font style="vertical-align: inherit;">マシンで使用されているパンチカードの転写を同封しています。</font><font style="vertical-align: inherit;">マシンには4つの汎用レジスター、1 kibibyteのデータメモリー、32 kibibyteのコマンドメモリーがあると言われています。</font><font style="vertical-align: inherit;">ゲームをプレイするには、次のようにサーバーに接続します。</font></font><code>socat tcp4-connect:cpuadventure.hackable.software:1234 fd:0,rawer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒント：マシンのプロセッサは固有のものであり、その情報をグーグルで検索しないでください。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">game.bin</font></font></a></blockquote><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーに接続すると、次の情報を受け取りました。</font></font><br>
<br>
<blockquote><code>THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS.<br>
<br>
SELECT AN OPTION:<br>
<br>
- GO (N)ORTH<br>
- GO (E)AST<br>
- (T)ALK TO VALIS<br>
- (D)RINK<br>
- SHOW (I)NVENTORY<br>
<br>
YOUR CHOICE: </code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいね。</font><font style="vertical-align: inherit;">これは昔ながらのアドベンチャーゲームです。</font><font style="vertical-align: inherit;">少し遊んだ後、私たちは彼を喜ばせれば、敵と戦ってこのヴァリスのキャラクターから旗を手に入れることができることに気づきました：</font></font><br>
<br>
<blockquote><code>YOUR CHOICE: T<br>
<br>
YOU ENTER THE TAVERN AND APPROACH VALIS.<br>
<br>
- HEY, I WAS WONDERING IF YOU COULD HELP ME FIND THE FLAG?<br>
- THE FLAG? MAYBE, BUT FIRST, I NEED A REDBULL.<br>
- I... I DON'T HAVE A REDBULL.<br>
- WELL THEN, MAKE YOURSELF USEFUL AND FIND ONE.<br>
<br>
THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS.<br>
<br>
SELECT AN OPTION:<br>
<br>
- GO (N)ORTH<br>
- GO (E)AST<br>
- (T)ALK TO VALIS<br>
- (D)RINK<br>
- SHOW (I)NVENTORY<br>
<br>
YOUR CHOICE: </code></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のステップ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームを長時間プレイしなかったので、ファイルをリバースエンジニアリングするほうが重要である可能性が高いことに気付きました</font></font><code>game.bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">バイナリ値が表示されることを期待して、16進エディタで開きました。</font><font style="vertical-align: inherit;">これを見たときの驚きを想像してみてください。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">110011111101000000111100110010001110000011001101000000000000110010011101010000001101001111100001111111001100111000000011 ...</font></font></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これ</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は文字通り</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリファイルです。ASCII文字1と0のみを含むテキストファイルです。これは、プロセッサのマシンコードである可能性が高いことを知っていますが、4つのレジスタ、1 kbyteのデータメモリ、32命令メモリのキビバイト、それについて</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は何も</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">知られていない</font><font style="vertical-align: inherit;">。したがって、最初の深刻なタスクは、このバイナリファイルのユニットサイズを決定することです（たとえば、8ビットの次元を持っているか、あるいは、いくつかの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古代のアーキテクチャの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように、12ビットまたは18ビットの次元を持っているかもしれませ</font><font style="vertical-align: inherit;">ん）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不明なファイルのサイズを調べるために、私は古いトリックを使いました-行の折り返しの長さが揃うまでテキストボックスのサイズを変更しました。</font><font style="vertical-align: inherit;">この方法は、複数のXOR暗号化テキスト、不明な（非圧縮）ファイル形式、不明なCPUからのコードなどに適しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b0/264/13d/7b026413d2a0beb1ad79904ab78ffb15.gif"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストウィンドウのサイズを変更する</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
このクイックチェックから、このファイルのユニットサイズは約20（アラインされたウィンドウの幅）の約数であることがわかりました。</font><font style="vertical-align: inherit;">正確なサイズを見つけるために、長い繰り返し行を探すスクリプトをすばやく書きました（コードにステレオタイプ化されたシーケンスが繰り返されていると想定しています）。</font><font style="vertical-align: inherit;">最長の繰り返し行は、43625と44510にある次の425ビットブロックです。</font></font><br>
<br>
<pre>10000011111110000001010100011111110100000101100010111000001001000101000100001000100001010001011000101000000001111111111100010000011110010100100001010100111100000110000010100000101000101000011110001111001101111001010100001010000111110100001010000110010011011110011111000000111011101000000001100000110000111101011010111011000100100010100000111000100011100011000000000101010101100010111000001010000001101010010000000011000001100</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返し間の距離は885であるため、次元は5ビット、つまり </font><font style="vertical-align: inherit;">不明なCPUには5ビットの「バイト」が必要です。</font><font style="vertical-align: inherit;">進捗！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5ビットのパンチカードエンコーディングを検索</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、バウドットコードを使用</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">した古いエンコーディング</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">すぐに解決しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">実際、オンラインデコーダーを使用していくつかのフラグメントをデコードすると、読み取り可能なテキストが得られました。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">⇩AG⇧⇧⇧⇧⇧⇩⇩⇩⇩⇩⇩⇩⇩⇩⇩⇩⇩⇩⇩THE⇩⇩THE⇩␀THE⇩THE⇩THE⇩␀IS⇩A⇩B </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced with LSB Baudot ITA 1 425ビットコード</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Bodoコードを使用してファイル全体をデコードしようとしましたが、最初の約2万ビットでゴミが出て、その後完全に読み取り可能なテキストができました。これにより、ファイルの最初の部分は「コード」セクションに属し、その後に定数行を含む「データ」セクションが続くことが明らかになりました。マシンはおそらくI / OにBodoコードを使用しているため、定数行をBodoエンコーディングでメモリに格納すると仮定しました。コードセグメントを読みやすくするために、16進エンコードと同様にbase-32エンコードを使用してエンコードすることにしましたが、0-9a-vのアルファベットで拡張しました。これは、base-32でエンコードされた最初の部分と2番目の部分がBodoによってデコードされた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">game.bin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルです（完全なファイルはこちらに掲載されています：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">game.b32</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<blockquote><code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf1sf24p5f3r9c11qad0f0sf1df26p5f39c21qad0f05f1ff26p5f39c41qad0f08f1df26p5f39c81qad0f0hf1ef26p5f3r1c00qaq15c20qcl0f01f1of27p5f3p3g3psf35c10qal0f02f1nf27p5f3p3g3psf3rf0hf1nf27p5f3f05f16f27p5f3rf84f95101311fl0f510f84907qa40b518447qa40b514f84f95k9m0k9m0k9m0907qa40b511447qa40b512ruougf10f20g0i9g0i910931b320u2u1u0ro9f0o9f0ojh0o9f0o9f0o9f0olj0o9f0o9f0o9f0o9f0o9f0o9f0o9f0o9k1onp0o9f0o9f0o9f0o9f0onf0ot82odi0o9f0o9f0o9f0o9f0o9f0o9f0o9f0olg0o9f0f0gf1df24p5f3r9c11qa835548755<br>
[...]<br>
93e9n59ka8fo87r85g8ui8ml8ed87b9h89u291u82333333333456789abcdb01234567892)%c3BOTTLE OF SOPLICA PIGWOWAENEMY HEALTH: <br>
<br>
YOU ATTACK <br>
<br>
YOU APPROACH REDFORD.<br>
<br>
<br>
<br>
YOU ENTER THE TAVERN AND APPROACH VALIS.<br>
[...]</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単にするために、以下では5ビット単位を「バイト」と呼びます。</font><font style="vertical-align: inherit;">チーム内でお互いに他の名前を付けました-私はそれらをキブルと呼び、ザックはハックと呼びました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不明なプロセッサアーキテクチャのリバースエンジニアリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、難しい部分に取り掛かります-完全に未知のユニークなCPUアーキテクチャで実行される4000バイトのコードをリバースエンジニアリングします。コードからは、これが</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可変長の</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一連の命令で</font><font style="vertical-align: inherit;">あることは</font><font style="vertical-align: inherit;">十分に明らか</font><font style="vertical-align: inherit;">です。その中に目立つ安定した繰り返しパターンを見つけることは不可能だからです。私はこれに数時間を費やしましたが、後にチームメンバーのZachary Wade（@ zwad3）が私を助け始めました。まず、重複するコードを探し始め、少数の命令を頻繁に使用することを提案しました。コードを、分析に便利な短い繰り返しシーケンスに分割し始めました。厳密なプロセスでしたが、実際は主に次のような曖昧なアルゴリズムが使われていました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはコードを調べ、何かが非常に頻繁に繰り返されるかどうかを探します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検索と置換の手順を実行して、この繰り返しの横に新しい行を挿入します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果の分割線間の類似点/相違点を調べます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このプロセスを約1時間繰り返します...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、私が発見したパターンの1つは「0f0.f」で、「。」</font><font style="vertical-align: inherit;">不明な文字を示します。</font><font style="vertical-align: inherit;">私はこのパターンの文字列を壊し、次のものを得ました：</font></font><br>
<br>
<blockquote><code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf<br>
1sf24p5f3r9c11qad0f0sf<br>
1df26p5f39c21qad0f05f<br>
1ff26p5f39c41qad0f08f<br>
1df26p5f39c81qad0f0hf<br>
1ef26p5f3r1c00qaq15c20qcl0f01f<br>
1of27p5f3p3g3psf35c10qal0f02f</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常に役立ちます！</font><font style="vertical-align: inherit;">2行目と3行目から、「... p5f3r9c ...」と「... p5f39c ...」があり、「r」はシングルバイトのオペコード、つまり「... 5f3」は1つのオペコードの終わりであり、「 9c ..」は別の始まりです。</font><font style="vertical-align: inherit;">最後の2行に「p5f3r1c ...」が表示されます。これは、「1c ..」が別のオペコードであり、「p3 ...」も別のオペコードであることを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様のブロックの類似点と相違点を使用して類似の方法で命令を繰り返し分割し続け、ありそうな命令を見つけました。</font><font style="vertical-align: inherit;">結局、私はこのようなものを得ました：</font></font><br>
<br>
<blockquote><code>pv83<br>
pi70<br>
pk00<br>
p7a0<br>
qfgv<br>
pjg3<br>
f0k<br>
f13<br>
f28<br>
p5f3<br>
pv10<br>
pk40<br>
pn60<br>
f0s<br>
f1s<br>
f24<br>
p5f3<br>
r<br>
9c11<br>
qad0<br>
f0s<br>
f1d<br>
f26<br>
p5f3<br>
9c21<br>
qad0<br>
f05<br>
f1f</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「p」と「q」は3バイトのオペランドを持つ命令であり、「f0」、「f1」、「f2」は1つのオペランドを持つ命令であり、「9c」は2つのオペランドを持つ命令であると想定しました。</font><font style="vertical-align: inherit;">しかし、私はこれらの指示のそれぞれが何であるかを知りませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、私が強調したすべての「p」命令のカタログに目を向けたところ、現時点で「p」を含む最も頻繁な命令は「p5f3」であることがわかりました。また、発生箇所を見ると、常に「f0」「f1」「f2」という命令が先行していることがわかりました。すべてのオペランド「f0」、「f1」、「f2」を見ると、オペランドf2は常に4〜8の範囲にあることに気付きました。 CPUには、15ビットを必要とするアドレッシング用の32 kbのプログラムメモリがあることを思い出して、「f0」、「f1」、および「f2」がf2を上位バイトとしていくつかのアドレスにロードしたと想定しました。これらのアドレスのいくつかを一緒に接続すると、すべてがデータセクションの定数行の先頭を正確に指していることがわかりました。機能を見つけた</font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！その直後に、「p5f3」は実際には回線または呼び出しを印刷するためのある種の命令であることがわかりました。 3バイトのオペランドを考慮に入れると、おそらく「呼び出し」です。ここでも、「p」命令を見ると、オペランドの3バイトがアドレスを</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直接順序（リトルエンディアン）</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で示していること、つまり、オペランドの最後のバイトがアドレスの最上位バイトであることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは大きな進歩でした！最初の指示を確認しました。他の場所で「f0」と「f1」が使用されているのを見て、それらはアドレスをロードしないと想定しましたが、4つのレジスタの1つ（たとえば、f0はレジスタ0をロードします）と、直接アドレス指定の5ビット定数を使用します。これは、p5f3では論理的です— 3f5関数（「print_string」）の3つのレジスタ引数をロードします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「印刷」イディオム（f0x、f1x、f2x、p5f3）を認識する逆アセンブラーの作成を開始し、逆アセンブルされたコードに印刷された行を置き換えました。プログラムの行数が多いため、逆アセンブルされたコードはすぐに非常に読みやすくなり、ファンクションブロックの場所を見つけるのが簡単になりました（完全な逆アセンブルされたコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<blockquote><code>0: call 38v<br>
4: call 7i<br>
8: call k<br>
c: call a7<br>
g: q vgf<br>
<br>
k: call 3gj<br>
o: print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00'<br>
15: call 1v<br>
19: call 4k<br>
1d: call 6n<br>
1h: print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00'<br>
1u: ret<br>
<br>
1v: unk 9<br>
20: unk c<br>
21: unk 1<br>
22: unk 1<br>
23: q 0da<br>
27: print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00'<br>
2k: unk 9<br>
2l: unk c<br>
2m: unk 2<br>
2n: unk 1<br>
2o: q 0da<br>
2s: print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00'<br>
39: unk 9<br>
3a: unk c<br>
3b: unk 4<br>
3c: unk 1<br>
3d: q 0da<br>
3h: print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00'<br>
3u: unk 9<br>
3v: unk c<br>
40: unk 8<br>
41: unk 1<br>
42: q 0da<br>
46: print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00'<br>
4j: ret</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この小さなコードから、いくつかの側面を理解することができました。「q0」命令は、条件付き分岐（関数1vで不要な方向の印刷をスキップするために使用されるため）と、命令「9c11」、「9c21」、「9c41」、「9c41」を示す必要があります。 9c81「ある種のAND命令を示す必要があります。これらのセットビットをチェックして、これらの方向が許可されているかどうかを確認します（これは、これらの命令で「1」、「2」、「4」、「8」を使用することで明確に示されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の2時間で、Zachary Wade（@ zwad3）と私はさまざまな指示を整理し、彼らが何をしていたかについての仮定を立て、洗練させました。</font><font style="vertical-align: inherit;">多くの読みやすい印刷ステートメントがあると、私たちの仕事がずっと簡単になりました。</font><font style="vertical-align: inherit;">私たちは、自分のペースで手順を検討し、調査結果を共有できるように、私たち一人一人が独自に逆アセンブラーを作成することにしました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードリバースエンジニアリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数時間後、私は解体に大きな進歩を遂げました。ユーザーのインベントリで機能するコード（より具体的には、「drink」関数とそれに関連付けられた各ハンドラー）を調べたところ、メモリの保存と読み込みの指示が見つかりました（CPUに1 kibibyteのデータメモリがあることを忘れないでください）。次に、一部の算術/論理（ALU）命令がメモリオペランドをとることがわかりました（たとえば、「9c41」は「データアドレス1の値と値4のANDを実行する」を意味します）。これにより、データメモリ内の変数を再作成することができました。たとえば、[0]にNPC識別子が現在の場所に格納され、[6,7]にプレーヤーの現在のヘルスが格納されます（[6]の下位5ビット、[7]の最も古い5ビット]）。この時点で、リバースエンジニアリングの指示から、逆アセンブルされたコードに注釈を付け、プログラム自体をリバースエンジニアリングすることに移りました。以下は、5ビット値の面白い表記です。</font></font><br>
<br>
<blockquote><code>_start:<br>
 call init<br>
<br>
L4:<br>
 call check_moves<br>
 call print_menu<br>
 call handle_command<br>
 br 4<br>
<br>
print_menu:<br>
 call print_itemname<br>
 print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00'<br>
 call print_moves<br>
 call print_npcmenu<br>
 call print_itemmenu<br>
 print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00'<br>
 ret<br>
<br>
print_moves:<br>
 and 0y1, [1]<br>
 brz 2k<br>
 print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00'<br>
2k: and 0y2, [1]<br>
 brz 39<br>
 print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00'<br>
39: and 0y4, [1]<br>
 brz 3u<br>
 print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00'<br>
3u: and 0y8, [1]<br>
 brz 4j<br>
 print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00'<br>
4j: ret<br>
<br>
print_npcmenu:<br>
 add 0y0, [0]<br>
 brz 6m<br>
 sub 0y2, [0]<br>
 br&lt;c&gt; 5p<br>
 print 7o1 # '\x0e- (\x0fT\x0e)\x0fALK TO \x00'<br>
 call print_npcname<br>
 call print_crlf<br>
5p: sub 0y1, [0]<br>
 brz 6m<br>
 print 7n2 # '\x0e- (\x0fF\x0e)\x0fIGHT \x00'<br>
 call print_npcname<br>
 call print_crlf<br>
6m: ret<br>
<br>
print_itemmenu:<br>
 print 7nh # '\x0e- (\x0fD\x0e)\x0fRINK\r\n\x00'<br>
 print 765 # '\x0e- \x0fSHOW \x0e(\x0fI\x0e)\x0fNVENTORY\r\n\x00'<br>
 ret</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、「qa」がゼロでの条件付き分岐（branch-on-zero、brz）であることがわかりましたが、「qc」が何であるかを理解できませんでした（上記のように示されています）。 br &lt;c&gt;）。しかし、それはプログラムの論理を理解し始めるには十分でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、このゲームでは、プレイヤーはNPC（ドラゴン、レッドブル、人間）がランダムに配置された8×8マップ上を移動できます。 NPCと戦うことができます（対応するメニュー項目がないにもかかわらず、Valisでさえ）。戦闘中に、敵を攻撃してランダムな量のダメージやミスを引き起こし、その後、敵がプレイヤーを攻撃して、ランダムな量のダメージやミスを引き起こします。シールドロックを選択することもできます。これにより、敵はダメージを与えずにシールドを見逃すか、ヒットします。最後に、体力を1000に上げることでチートできますが、この場合、非表示変数（「チート」、アドレス10）は1に設定されます。プレイヤーが敵を倒した場合、オブジェクトは通常、アルコールのボトル（明らかに、このゲームは子供向けではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレーヤーがフラグを受け取る必要のあるメインのNPCヴァリスには、プレーヤーにいくつかのアイテムを要求するステートマシンがあります-レッドブルの飲み物の束（レッドブルの敵を倒したときに明らかに得られる）、さまざまな混合ドリンク（たとえば、ジンとトニック）-それらを入手するには、青いドラゴンと灰色のドラゴンを倒してから、それらからドロップされたオブジェクトを混合する必要があります）、そしてパワーストリップは、ゲーム内の別のNPCの人（レッドフォード）を倒すか、彼を助けた場合に取得できます。この長い一連のリクエストをすべて満たすと、フラグが表示されますが</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数「チート」が1に等しくない場合。つまり、私たちのタスクはチートなしでゲームに勝つことです。</font><font style="vertical-align: inherit;">私たちは、すべての敵と同様に、100 HPから始めているため、通常のパッセージでは、すべての敵を倒すことは不可能です（約20人の敵を倒すために必要なすべての物を得るために）。</font><font style="vertical-align: inherit;">敵が常に見逃すことができるように、どういうわけかRNGを変更する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
乱数は、ある種のPRNG（アドレス37a）に似た関数によって生成されますが、他の場所では使用されていない一意の命令を使用するため、リバースエンジニアリングすることはできません。</font><font style="vertical-align: inherit;">ただし、メモリ内の3つのアドレス（[11]、[12]、および[13]）から状態ベクトルをロードすることに気付きました。つまり、完全な状態は15ビットしかかかりません。</font><font style="vertical-align: inherit;">これは、RNGが短期間でなければならないことを意味します-長さは2 ^ 15 = 32768以下です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RNGの実装を逆転させようとしたが（失敗した）、Jay Bosamia（@ jay_f0xtr0t）とMatthew Savage（@thebluepichu）がエクスプロイトを実装しました。 「シールド」コマンドを100,000回続けて送信するだけで、RNGからのビット出力に対応する一連の敵の「ヒット」と「ミス」を取得できました。このシーケンスが32767の周期で繰り返されることを確認しました。これのおかげで、主なエクスプロイトを組み立てることができました。最初に遭遇した敵との戦いで、シールドを40回閉じてヒットとミスのシーケンスを再現し、このシーケンスを大きな周期的シーケンスで探して見つけました。いつシールドするか、いつ攻撃するかで、敵は常に見逃します。次に、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">マーダーホボ</font></a><font style="vertical-align: inherit;">モードでマップ全体を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移動しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全員を殺し、彼らの戦利品を集めることによって。</font><font style="vertical-align: inherit;">最後に、私たちはヴァリスに戻り、受け取った旗を丁寧に求めました：</font></font><br>
<br>
<blockquote><code>DrgnS{m4kin9-v4lis-happy-w1th-n4t1ve-b4ud0t-cpu}</code></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ふ!！</font><font style="vertical-align: inherit;">確かに、本当の冒険。</font><font style="vertical-align: inherit;">バイナリ文字列とプロセッサドキュメントの完全な欠如から、2つのほぼ完全な逆アセンブラとクリーンな逆アセンブルされたコードが10時間未満で作成されたとは、まだ完全には信じられません！</font><font style="vertical-align: inherit;">すべてのコードがGitHubにアップロードされます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の逆アセンブラー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zacharyの逆アセンブラー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生の逆アセンブルされたコード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注釈付きの逆アセンブルされたコード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mattのエクスプロイトクライアント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468837/index.html">技術面接の方法：初心者向けの行動計画</a></li>
<li><a href="../ja468841/index.html">Kotlin Multiplatformライブラリの継続的デリバリー</a></li>
<li><a href="../ja468843/index.html">CRMシステムを実装することを恐れていますか？あなたのビジネスは病気かもしれません</a></li>
<li><a href="../ja468845/index.html">都市の生理学、または体の部分の短いコース</a></li>
<li><a href="../ja468847/index.html">他の国での公共調達：法律にフレームワークが必要な理由</a></li>
<li><a href="../ja468851/index.html">React Nativeでのアニメーションの実装</a></li>
<li><a href="../ja468853/index.html">レガシープロジェクトにおけるSRPの1つの成功したアプリケーションのストーリー</a></li>
<li><a href="../ja468859/index.html">「ポンピング用ルーター」：インターネットプロバイダー向けのTP-Link機器チューニング </a></li>
<li><a href="../ja468863/index.html">内部移動：ループ変数をクロージャーでラップする</a></li>
<li><a href="../ja468873/index.html">かつて利便性を破った私鉄</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>