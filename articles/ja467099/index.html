<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¶ âœğŸ¿ ğŸ“» å°ã•ãªã‚‚ã®ã®ãŸã‚ã®ãƒãƒ” ğŸ‘„ ğŸ˜µ ğŸ£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hapi.jsã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã“ã®æŠ•ç¨¿ã«ã¯ã€ãƒ›ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆã«å¿…è¦ãªã™ã¹ã¦ã®ã‚‚ã®ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æ®‹å¿µãªãŒã‚‰ã€ä½œè€…ã¯ä½œå®¶ã§ã¯ãªã„ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ãŒå¤šãã€å˜èªã‚‚ã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚
 

- MVP
- é‡ç”Ÿã§ ORMç¶šç·¨ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¿½åŠ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æŒ¿å…¥ã™ã‚‹ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å°ã•ãªã‚‚ã®ã®ãŸã‚ã®ãƒãƒ”</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467099/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hapi.jsã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®æŠ•ç¨¿ã«ã¯ã€ãƒ›ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆã«å¿…è¦ãªã™ã¹ã¦ã®ã‚‚ã®ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ®‹å¿µãªãŒã‚‰ã€ä½œè€…ã¯ä½œå®¶ã§ã¯ãªã„ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ãŒå¤šãã€å˜èªã‚‚ã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚</font></font></p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡ç”Ÿã§</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ORMç¶šç·¨</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¿½åŠ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æŒ¿å…¥ã™ã‚‹</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¨ãƒ©ãƒ¼å‡¦ç†</font></font></a></li>
</ul><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger / OpenAPI</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆ</font></font></a></li>
</ul><br>
<a name="habracut"></a><br>
<a name="link_mvp"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVP</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾å­˜é–¢ä¿‚ã‚’ãŸãã•ã‚“å…¥ã‚Œã¾ã™ï¼š</font></font></p><br>
<pre><code class="bash hljs">npm i @hapi/hapi @hapi/boom filepaths hapi-boom-decorators</code></pre><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ hapi-å®Ÿéš›ã«ã¯ç§ãŸã¡ã®ã‚µãƒ¼ãƒãƒ¼</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ boom-æ¨™æº–çš„ãªå›ç­”ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hapi-boom-decorators-ãƒ˜ãƒ«ãƒ‘ãƒ¼ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ãƒ–ãƒ¼ãƒ </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filepaths-ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’å†å¸°çš„ã«èª­ã¿å–ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ§‹é€ ã¨ä¸€é€£ã®é–‹å§‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</font></font></p><br>
<br>
<img src="https://habrastorage.org/webt/eh/ic/bk/ehicbksl-1lcrvoenxe6rq9u-zw.png"><br>
<br>
<p> ./src/routes/    , 1  â€” 1 :</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// ./src/routes/home.js</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// content-type            </span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">result</span>: <span class="hljs-string">'ok'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello World!'</span><font></font>
  };<font></font>
}<font></font>
<font></font>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>, <span class="hljs-comment">// </span>
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// </span>
  <span class="hljs-attr">options</span>: { 
    <span class="hljs-attr">handler</span>: response <span class="hljs-comment">// ,  ,  hapi &gt; 17   </span><font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p>./src/server.js â€” ,   .</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// ./src/server.js</span>
<span class="hljs-meta">'use strict'</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> Hapi = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@hapi/hapi'</span>);
<span class="hljs-keyword">const</span> filepaths = <span class="hljs-built_in">require</span>(<span class="hljs-string">'filepaths'</span>);
<span class="hljs-keyword">const</span> hapiBoomDecorators = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hapi-boom-decorators'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> Hapi.Server(config.server);<font></font>
<font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">await</span> server.register([<font></font>
    hapiBoomDecorators<font></font>
  ]);<font></font>
<font></font>
  <span class="hljs-comment">//      ./src/routes/</span>
  <span class="hljs-keyword">let</span> routes = filepaths.getSync(__dirname + <span class="hljs-string">'/routes/'</span>);
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> route <span class="hljs-keyword">of</span> routes)<font></font>
    server.route( <span class="hljs-built_in">require</span>(route) );<font></font>
  <font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> server.start();
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Server running at: <span class="hljs-subst">${server.info.uri}</span>`</span>);<font></font>
  } <span class="hljs-keyword">catch</span>(err) { <span class="hljs-comment">//    ,  </span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(err));<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">return</span> server;<font></font>
}<font></font>
<font></font>
<span class="hljs-built_in">module</span>.exports = createServer; 
</code></pre><br>
<p> ./server.js ,   â€”   createServer()</p><br>
<pre><code class="javascript hljs"><span class="hljs-meta">#!/usr/bin/env node</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> createServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./src/server'</span>);<font></font>
<font></font>
createServer();<font></font>
</code></pre><br>
<p></p><br>
<pre><code class="bash hljs"><font></font>
node server.js<font></font>
</code></pre><br>
<p> :</p><br>
<pre><code class="bash hljs"><font></font>
curl http://127.0.0.1:3030/<font></font>
{<span class="hljs-string">"result"</span>:<span class="hljs-string">"ok"</span>,<span class="hljs-string">"message"</span>:<span class="hljs-string">"Hello World!"</span>}<font></font>
<font></font>
curl http://127.0.0.1:3030/<span class="hljs-built_in">test</span>
{<span class="hljs-string">"statusCode"</span>:404,<span class="hljs-string">"error"</span>:<span class="hljs-string">"Not Found"</span>,<span class="hljs-string">"message"</span>:<span class="hljs-string">"Not Found"</span>}
</code></pre><br>
<a name="link_inthewild"></a><br>
<h2>In the wild</h2><br>
<p>   ,  ,   , , ,      .</p><br>
<a name="link_sequelize"></a><br>
<h3> sequelize</h3><br>
<p>ORM sequelize    :</p><br>
<pre><code class="javascript hljs">...<font></font>
const Sequelize = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sequelize'</span>);<font></font>
...<font></font>
await server.register([<font></font>
...<font></font>
    {<font></font>
      <span class="hljs-attr">plugin</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'hapi-sequelizejs'</span>),
      <span class="hljs-attr">options</span>: [<font></font>
        {<font></font>
          <span class="hljs-attr">name</span>: config.db.database, <span class="hljs-comment">// identifier</span>
          <span class="hljs-attr">models</span>: [__dirname + <span class="hljs-string">'/models/*.js'</span>], <span class="hljs-comment">//   </span>
          <span class="hljs-comment">//ignoredModels: [__dirname + '/server/models/**/*.js'], //  -    </span>
          <span class="hljs-attr">sequelize</span>: <span class="hljs-keyword">new</span> Sequelize(config.db), <span class="hljs-comment">// </span>
          <span class="hljs-attr">sync</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// default false</span>
          <span class="hljs-attr">forceSync</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// force sync (drops tables) - default false</span><font></font>
        },<font></font>
      ]<font></font>
    }<font></font>
...<font></font>
  ]);<font></font>
</code></pre><br>
<p>       :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response</span>(<span class="hljs-params">request</span>) </span>{
  <span class="hljs-keyword">const</span> model = request.getModel(<span class="hljs-string">'_'</span>, <span class="hljs-string">'_'</span>);<font></font>
}<font></font>
</code></pre><br>
<a name="link_inject"></a><br>
<h3>    </h3><br>
<p>   Â«onRequestÂ»,     request    :</p><br>
<pre><code class="javascript hljs">...<font></font>
const Logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/Logger'</span>);<font></font>
...<font></font>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params">logLVL=config.logLVL</span>) </span>{<font></font>
  ...<font></font>
  const logger = <span class="hljs-keyword">new</span> Logger(logLVL, <span class="hljs-string">'my-hapi-app'</span>);<font></font>
  ...<font></font>
  server.ext({<font></font>
    <span class="hljs-attr">type</span>: <span class="hljs-string">'onRequest'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, h</span>) </span>{<font></font>
      request.server.config = <span class="hljs-built_in">Object</span>.assign({}, config);<font></font>
      request.server.logger = logger;<font></font>
      <span class="hljs-keyword">return</span> h.continue;<font></font>
    }<font></font>
  });<font></font>
  ...<font></font>
}</code></pre><br>
<br>
<p>        , ,  ,    -    :</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// ./src/routes/home.js</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response</span>(<span class="hljs-params">request</span>) </span>{
  <span class="hljs-comment">// </span>
  request.server.logger.error(<span class="hljs-string">'request error'</span>, <span class="hljs-string">'something went wrong'</span>);<font></font>
  <font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-built_in">console</span>.log(request.server.config);<font></font>
  <font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> messages = request.getModel(request.server.config.db.database, <span class="hljs-string">'_'</span>);<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">result</span>: <span class="hljs-string">'ok'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello World!'</span><font></font>
  };<font></font>
}<font></font>
<font></font>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>, <span class="hljs-comment">// </span>
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// </span>
  <span class="hljs-attr">options</span>: { 
    <span class="hljs-attr">handler</span>: response <span class="hljs-comment">// ,  ,  hapi &gt; 17   </span><font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p> ,          ,                .</p><br>
<a name="link_auth"></a><br>
<h3></h3><br>
<p>  hapi    .</p><br>
<pre><code class="javascript hljs">...<font></font>
const AuthBearer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hapi-auth-bearer-token'</span>);<font></font>
...<font></font>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params">logLVL=config.logLVL</span>) </span>{<font></font>
  ...<font></font>
  await server.register([<font></font>
    AuthBearer,<font></font>
    ...<font></font>
  ]);<font></font>
  <font></font>
  server.auth.strategy(<span class="hljs-string">'token'</span>, <span class="hljs-string">'bearer-access-token'</span>, {<span class="hljs-comment">// 'token' -   , </span>
    <span class="hljs-attr">allowQueryToken</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">unauthorized</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//  ,  validate  isValid=false</span>
      <span class="hljs-keyword">throw</span> Boom.unauthorized();<font></font>
    },<font></font>
    <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, token</span>) </span>{
      <span class="hljs-keyword">if</span>( token == <span class="hljs-string">'asd'</span> ) {
        <span class="hljs-keyword">return</span> { <span class="hljs-comment">//   </span>
          <span class="hljs-attr">isValid</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">credentials</span>: {}<font></font>
        };<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-comment">//  </span>
          <span class="hljs-attr">isValid</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">credentials</span>: {}<font></font>
        };<font></font>
      }<font></font>
    }<font></font>
  });<font></font>
  <font></font>
  server.auth.default(<span class="hljs-string">'token'</span>); <span class="hljs-comment">//   </span><font></font>
  ...<font></font>
}<font></font>
</code></pre><br>
<p>         :</p><br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
  <span class="hljs-attr">auth</span>: <span class="hljs-string">'token'</span>, <span class="hljs-comment">//  false,    </span>
  <span class="hljs-attr">options</span>: { 
    <span class="hljs-attr">handler</span>: response <font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p>    :</p><br>
<pre><code class="javascript hljs">auth: {
  <span class="hljs-attr">strategies</span>: [<span class="hljs-string">'token1'</span>, <span class="hljs-string">'token2'</span>, <span class="hljs-string">'something_else'</span>]<font></font>
},<font></font>
</code></pre><br>
<a name="link_errorhandle"></a><br>
<h3> </h3><br>
<p> , boom     ,         .</p><br>
<pre><code class="javascript hljs">server.ext(<span class="hljs-string">'onPreResponse'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, h</span>) </span>{
  <span class="hljs-comment">//      Boom,    </span>
  <span class="hljs-keyword">if</span> ( !request.response.isBoom ) {
    <span class="hljs-keyword">return</span> h.continue;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">//  -    </span>
  <span class="hljs-keyword">let</span> responseObj = {
    <span class="hljs-attr">message</span>: request.response.output.statusCode === <span class="hljs-number">401</span> ? <span class="hljs-string">'AuthError'</span> : <span class="hljs-string">'ServerError'</span>,
    <span class="hljs-attr">status</span>: request.response.message<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">//    </span>
  logger.error(<span class="hljs-string">'code: '</span> + request.response.output.statusCode, request.response.message);<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> h.response(responseObj).code(request.response.output.statusCode);<font></font>
});<font></font>
</code></pre><br>
<a name="link_schemes"></a><br>
<h2> </h2><br>
<p> ,    .         .      ,    swagger  .</p><br>
<p>     joi.      :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> Joi = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@hapi/joi'</span>);
<span class="hljs-keyword">const</span> Boom = <span class="hljs-built_in">require</span>(<span class="hljs-string">'boom'</span>);<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response</span>(<span class="hljs-params">request</span>) </span>{<font></font>
  <font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">const</span> accessTokens = request.getModel(request.server.config.db.database, <span class="hljs-string">'access_tokens'</span>);
  <span class="hljs-keyword">const</span> users = request.getModel(request.server.config.db.database, <span class="hljs-string">'users'</span>);<font></font>
  <font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">let</span> userRecord = <span class="hljs-keyword">await</span> users.findOne({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">email</span>: request.query.login } });<font></font>
<font></font>
  <span class="hljs-comment">//   ,    </span>
  <span class="hljs-keyword">if</span> ( !userRecord ) {
    <span class="hljs-keyword">throw</span> Boom.unauthorized();<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// ,   </span>
  <span class="hljs-keyword">if</span> ( !userRecord.verifyPassword(request.query.password) ) {
    <span class="hljs-keyword">throw</span> Boom.unauthorized();<span class="hljs-comment">//  ,    ,   </span><font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// ,   </span>
  <span class="hljs-keyword">let</span> token = <span class="hljs-keyword">await</span> accessTokens.createAccessToken(userRecord);<font></font>
  <font></font>
  <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">total</span>: <span class="hljs-number">1</span><font></font>
    },<font></font>
    <span class="hljs-attr">data</span>: [ token.dataValues ]<font></font>
  };<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   ,     </span>
<span class="hljs-keyword">const</span> tokenScheme = Joi.object({
  <span class="hljs-attr">id</span>: Joi.number().integer().example(<span class="hljs-number">1</span>),
  <span class="hljs-attr">user_id</span>: Joi.number().integer().example(<span class="hljs-number">2</span>),
  <span class="hljs-attr">expires_at</span>: Joi.date().example(<span class="hljs-string">'2019-02-16T15:38:48.243Z'</span>),
  <span class="hljs-attr">token</span>: Joi.string().example(<span class="hljs-string">'4443655c28b42a4349809accb3f5bc71'</span>),
  <span class="hljs-attr">updatedAt</span>: Joi.date().example(<span class="hljs-string">'2019-02-16T15:38:48.243Z'</span>),
  <span class="hljs-attr">createdAt</span>: Joi.date().example(<span class="hljs-string">'2019-02-16T15:38:48.243Z'</span>)<font></font>
});<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">const</span> responseScheme = Joi.object({
  <span class="hljs-attr">meta</span>: Joi.object({
    <span class="hljs-attr">total</span>: Joi.number().integer().example(<span class="hljs-number">3</span>)<font></font>
  }),<font></font>
  <span class="hljs-attr">data</span>: Joi.array().items(tokenScheme)<font></font>
});<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">const</span> requestScheme =Joi.object({
  <span class="hljs-attr">login</span>: Joi.string().email().required().example(<span class="hljs-string">'pupkin@gmail.com'</span>),
  <span class="hljs-attr">password</span>: Joi.string().required().example(<span class="hljs-string">'12345'</span>)<font></font>
});<font></font>
<font></font>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/auth'</span>,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">handler</span>: response,
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">query</span>: requestScheme<font></font>
    },<font></font>
    <span class="hljs-attr">response</span>: { <span class="hljs-attr">schema</span>: responseScheme }<font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p>:</p><br>
<pre><code class="bash hljs">
curl -X GET <span class="hljs-string">"http://localhost:3030/auth?login=pupkin@gmail.com&amp;password=12345"</span>
</code></pre><br>
<br>
<img src="https://habrastorage.org/webt/rt/qh/ta/rtqhtahka6wz7937bkfictdgy_0.png"><br>
<br>
<p>   ,  :</p><br>
<pre><code class="bash hljs">
curl -X GET <span class="hljs-string">"http://localhost:3030/auth?login=pupkin&amp;password=12345"</span>
</code></pre><br>
<br>
<img src="https://habrastorage.org/webt/za/w2/4l/zaw24l9f3si71uxkfqutwzj5uas.png"><br>
<br>
<p>     ,   ,   500 .</p><br>
<p> ,       1   ,     , ..  â€”  .    : Â«sampleÂ»</p><br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/auth'</span>,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">handler</span>: response,
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">query</span>: requestScheme<font></font>
    },<font></font>
    <span class="hljs-attr">response</span>: { <span class="hljs-attr">sample</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">schema</span>: responseScheme }<font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p>    50%     .</p><br>
<p>      ,          .</p><br>
<a name="link_swagger"></a><br>
<h2>Swagger/OpenAPI</h2><br>
<p>    :</p><br>
<pre><code class="bash hljs"><font></font>
npm i hapi-swagger @hapi/inert @hapi/vision<font></font>
</code></pre><br>
<p>   server.js</p><br>
<pre><code class="javascript hljs">...<font></font>
const Inert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@hapi/inert'</span>);
<span class="hljs-keyword">const</span> Vision = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@hapi/vision'</span>);
<span class="hljs-keyword">const</span> HapiSwagger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hapi-swagger'</span>);
<span class="hljs-keyword">const</span> Package = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package'</span>);<font></font>
...<font></font>
const swaggerOptions = {<font></font>
  <span class="hljs-attr">info</span>: {
    <span class="hljs-attr">title</span>: Package.name + <span class="hljs-string">' API Documentation'</span>,
    <span class="hljs-attr">description</span>: Package.description<font></font>
  },<font></font>
  <span class="hljs-attr">jsonPath</span>: <span class="hljs-string">'/documentation.json'</span>,
  <span class="hljs-attr">documentationPath</span>: <span class="hljs-string">'/documentation'</span>,
  <span class="hljs-attr">schemes</span>: [<span class="hljs-string">'https'</span>, <span class="hljs-string">'http'</span>],
  <span class="hljs-attr">host</span>: config.swaggerHost,
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span><font></font>
};<font></font>
...<font></font>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params">logLVL=config.logLVL</span>) </span>{<font></font>
  ...<font></font>
  await server.register([<font></font>
    ...<font></font>
    Inert,<font></font>
    Vision,<font></font>
    {<font></font>
      <span class="hljs-attr">plugin</span>: HapiSwagger,
      <span class="hljs-attr">options</span>: swaggerOptions<font></font>
    },<font></font>
    ...<font></font>
  ]);<font></font>
  ...<font></font>
});<font></font>
</code></pre><br>
<p>       Â«apiÂ»:</p><br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/auth'</span>,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">handler</span>: response,
    <span class="hljs-attr">tags</span>: [ <span class="hljs-string">'api'</span> ], <span class="hljs-comment">//    swagger'    </span>
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">query</span>: requestScheme<font></font>
    },<font></font>
    <span class="hljs-attr">response</span>: { <span class="hljs-attr">sample</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">schema</span>: responseScheme }<font></font>
  }<font></font>
};<font></font>
</code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:3030/documentation</a>   -  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">http://localhost:3030/documentation.json</a> .json .</p><br>
<br>
<img src="https://habrastorage.org/webt/tp/ht/b3/tphtb36liamqxbzsvlgxglbmle4.png"><br>
<a name="link_autotest"></a><br>
<h2> </h2><br>
<p>       ,  seed ,  ,    , ,   ,         .</p><br>
<p>,  GET:/auth   login  password,     ,     :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> requestScheme =Joi.object({
  <span class="hljs-attr">login</span>: Joi.string().email().required().example(<span class="hljs-string">'pupkin@gmail.com'</span>),
  <span class="hljs-attr">password</span>: Joi.string().required().example(<span class="hljs-string">'12345'</span>)<font></font>
});<font></font>
</code></pre><br>
<p>    HTTP-200-OK,   ,   .</p><br>
<p> ,     ,   :</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// ./test/autogenerate.js</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);
<span class="hljs-keyword">const</span> rp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request-promise'</span>);
<span class="hljs-keyword">const</span> filepaths = <span class="hljs-built_in">require</span>(<span class="hljs-string">'filepaths'</span>);
<span class="hljs-keyword">const</span> rsync = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sync-request'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./../config'</span>);
<span class="hljs-keyword">const</span> createServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../src/server'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> API_URL = <span class="hljs-string">'http://0.0.0.0:3030'</span>;
<span class="hljs-keyword">const</span> AUTH_USER = { <span class="hljs-attr">login</span>: <span class="hljs-string">'pupkin@gmail.com'</span>, <span class="hljs-attr">pass</span>: <span class="hljs-string">'12345'</span> };<font></font>
<font></font>
<span class="hljs-keyword">const</span> customExamples = {
  <span class="hljs-string">'string'</span>: <span class="hljs-string">'abc'</span>,
  <span class="hljs-string">'number'</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">'boolean'</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">'any'</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-string">'date'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> allowedStatusCodes = {
  <span class="hljs-number">200</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-number">404</span>: <span class="hljs-literal">true</span><font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getExampleValue</span>(<span class="hljs-params">joiObj</span>) </span>{
  <span class="hljs-keyword">if</span>( joiObj == <span class="hljs-literal">null</span> ) <span class="hljs-comment">// if joi is null</span>
    <span class="hljs-keyword">return</span> joiObj;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span>(joiObj) != <span class="hljs-string">'object'</span> ) <span class="hljs-comment">//If it's not joi object</span>
    <span class="hljs-keyword">return</span> joiObj;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span>(joiObj._examples) == <span class="hljs-string">'undefined'</span> )
    <span class="hljs-keyword">return</span> customExamples[ joiObj._type ];<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( joiObj._examples.length &lt;= <span class="hljs-number">0</span> )
    <span class="hljs-keyword">return</span> customExamples[ joiObj._type ];<font></font>
<font></font>
  <span class="hljs-keyword">return</span> joiObj._examples[ <span class="hljs-number">0</span> ].value;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateJOIObject</span>(<span class="hljs-params">schema</span>) </span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( schema._type == <span class="hljs-string">'object'</span> )
    <span class="hljs-keyword">return</span> generateJOIObject(schema._inner.children);<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( schema._type == <span class="hljs-string">'string'</span> )
    <span class="hljs-keyword">return</span> getExampleValue(schema);<font></font>
<font></font>
  <span class="hljs-keyword">let</span> result = {};
  <span class="hljs-keyword">let</span> _schema;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( <span class="hljs-built_in">Array</span>.isArray(schema) ) {<font></font>
    _schema = {};<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> schema) {<font></font>
      _schema[ item.key ] = item.schema;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _schema = schema;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> fieldName <span class="hljs-keyword">in</span> _schema) {<font></font>
<font></font>
    <span class="hljs-keyword">if</span>( _schema[ fieldName ]._type == <span class="hljs-string">'array'</span> ) {<font></font>
      result[ fieldName ] = [ generateJOIObject(_schema[ fieldName ]._inner.items[ <span class="hljs-number">0</span> ]) ];<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span>( <span class="hljs-built_in">Array</span>.isArray(_schema[ fieldName ]) ) {<font></font>
        result[ fieldName ] = getExampleValue(_schema[ fieldName ][ <span class="hljs-number">0</span> ]);<font></font>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _schema[ fieldName ]._type == <span class="hljs-string">'object'</span> ) {<font></font>
        result[ fieldName ] = generateJOIObject(_schema[ fieldName ]._inner);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        result[ fieldName ] = getExampleValue(_schema[ fieldName ]);<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> result<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateQuiryParams</span>(<span class="hljs-params">queryObject</span>) </span>{
  <span class="hljs-keyword">let</span> queryArray = [];
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> name <span class="hljs-keyword">in</span> queryObject)<font></font>
    queryArray.push(<span class="hljs-string">`<span class="hljs-subst">${name}</span>=<span class="hljs-subst">${queryObject[name]}</span>`</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> queryArray.join(<span class="hljs-string">'&amp;'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generatePath</span>(<span class="hljs-params">basicPath, paramsScheme</span>) </span>{
  <span class="hljs-keyword">let</span> result = basicPath;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( !paramsScheme )
    <span class="hljs-keyword">return</span> result;<font></font>
<font></font>
  <span class="hljs-keyword">let</span> replaces = generateJOIObject(paramsScheme);<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> replaces)<font></font>
    result = result.replace(<span class="hljs-string">`{<span class="hljs-subst">${key}</span>}`</span>, replaces[ key ]);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genAuthHeaders</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> result = {};<font></font>
<font></font>
  <span class="hljs-keyword">let</span> respToken = rsync(<span class="hljs-string">'GET'</span>, API_URL + <span class="hljs-string">`/auth?login=<span class="hljs-subst">${AUTH_USER.login}</span>&amp;password=<span class="hljs-subst">${AUTH_USER.pass}</span>`</span>);
  <span class="hljs-keyword">let</span> respTokenBody = <span class="hljs-built_in">JSON</span>.parse(respToken.getBody(<span class="hljs-string">'utf8'</span>));<font></font>
  <font></font>
  result[ <span class="hljs-string">'token'</span> ] = {
    <span class="hljs-attr">Authorization</span>: <span class="hljs-string">'Bearer '</span> + respTokenBody.data[ <span class="hljs-number">0</span> ].token<font></font>
  };<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateRequest</span>(<span class="hljs-params">route, authKeys</span>) </span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( !route.options.validate ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">let</span> options = {
    <span class="hljs-attr">method</span>: route.method,
    <span class="hljs-attr">url</span>: API_URL + generatePath(route.path, route.options.validate.params) + <span class="hljs-string">'?'</span> + generateQuiryParams( generateJOIObject(route.options.validate.query || {}) ),
    <span class="hljs-attr">headers</span>: authKeys[ route.options.auth ]  ? authKeys[ route.options.auth ] : {},
    <span class="hljs-attr">body</span>: generateJOIObject(route.options.validate.payload || {}),
    <span class="hljs-attr">json</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">15000</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> options;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">let</span> authKeys = genAuthHeaders();
<span class="hljs-keyword">let</span> testSec = [ <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'GET'</span>, <span class="hljs-string">'DELETE'</span> ];
<span class="hljs-keyword">let</span> routeList = [];<font></font>
<font></font>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> route <span class="hljs-keyword">of</span> filepaths.getSync(__dirname + <span class="hljs-string">'/../src/routes/'</span>))<font></font>
  routeList.push(<span class="hljs-built_in">require</span>(route));<font></font>
<font></font>
describe(<span class="hljs-string">'Autogenerate Hapi Routes TEST'</span>, <span class="hljs-keyword">async</span> () =&gt; {<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> metod <span class="hljs-keyword">of</span> testSec)
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> testRoute <span class="hljs-keyword">of</span> routeList) {
    <span class="hljs-keyword">if</span>( testRoute.method != metod ) {
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
<font></font>
    it(<span class="hljs-string">`TESTING: <span class="hljs-subst">${testRoute.method}</span> <span class="hljs-subst">${testRoute.path}</span>`</span>,  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">let</span> options = generateRequest(testRoute, authKeys);<font></font>
<font></font>
      <span class="hljs-keyword">if</span>( !options )
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
<font></font>
      <span class="hljs-keyword">let</span> statusCode = <span class="hljs-number">0</span>;<font></font>
<font></font>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> rp( options );<font></font>
        statusCode = <span class="hljs-number">200</span>;<font></font>
      } <span class="hljs-keyword">catch</span>(err) {<font></font>
        statusCode = err.statusCode;<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">if</span>( !allowedStatusCodes[ statusCode ] ) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'*** TEST STACK FOR:'</span>, <span class="hljs-string">`<span class="hljs-subst">${testRoute.method}</span> <span class="hljs-subst">${testRoute.path}</span>`</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'options:'</span>, options);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'StatusCode:'</span>, statusCode);<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">return</span> assert.ok(allowedStatusCodes[ statusCode ]);<font></font>
    });<font></font>
<font></font>
  }<font></font>
<font></font>
});<font></font>
</code></pre><br>
<p>   :</p><br>
<pre><code class="bash hljs"><font></font>
npm i request-promise mocha sync-request<font></font>
</code></pre><br>
<p>  package.json</p><br>
<pre><code class="json hljs">...
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"mocha"</span>,
    <span class="hljs-attr">"dbinit"</span>: <span class="hljs-string">"node ./scripts/dbInit.js"</span><font></font>
  },<font></font>
...<font></font>
</code></pre><br>
<p>:</p><br>
<pre><code class="bash hljs">
npm <span class="hljs-built_in">test</span>
</code></pre><br>
<img src="https://habrastorage.org/webt/8a/do/jg/8adojgir1rzh5gj1jysb1aqnvza.png"><br>
<br>
<p>   -  ,     :</p><br>
<br>
<img src="https://habrastorage.org/webt/py/jz/1i/pyjz1ithtglj9o-bnsa6b9esoqg.png"><br>
<br>
<p>  ,         ,   .    ,  ,  .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467089/index.html">ãƒ‘ãƒƒãƒã‚’é©ç”¨ã—ãŸExim-å†åº¦ãƒ‘ãƒƒãƒã‚’é©ç”¨ã—ã¾ã™ã€‚1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§Exim 4.92ã®æ–°ã—ã„ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ</a></li>
<li><a href="../ja467091/index.html">Angularé–‹ç™ºè€…ã®è¦³ç‚¹ã‹ã‚‰ã®Svelteã®ç°¡å˜ãªç´¹ä»‹</a></li>
<li><a href="../ja467093/index.html">Straceã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¹ãƒ‘ã‚¤</a></li>
<li><a href="../ja467095/index.html">æ€ã£ãŸã‚ˆã‚Šç°¡å˜ã§ã™ã€‚äºŒå</a></li>
<li><a href="../ja467097/index.html">ãƒ¬ãƒ«ãƒ ã§ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ç”¨</a></li>
<li><a href="../ja467101/index.html">çŠ¬ã®åŒ‚ã„ã§ãƒ­ãƒœãƒƒãƒˆã‚’ä½œã‚ã†ï¼</a></li>
<li><a href="../ja467105/index.html">Dockerãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®PodmanãŠã‚ˆã³Buildah</a></li>
<li><a href="../ja467107/index.html">GitLab CI / CDã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja467109/index.html">QAãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ã‚’æ•´ç†ã™ã‚‹æ–¹æ³•ã€‚1ã¤ã®å®Ÿç”¨çš„ãªæ–¹æ³•</a></li>
<li><a href="../ja467111/index.html">ãŠä½¿ã„ã®æºå¸¯é›»è©±ã«ã‹ã‹ã‚‹æ™‚é–“ã‚’æ¸›ã‚‰ã™æ–¹æ³•ã«é–¢ã™ã‚‹æŠœæœ¬çš„ãªãƒ’ãƒ³ãƒˆ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>