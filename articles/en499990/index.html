<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😻 🛥️ 👩🏼‍🏭 Geocoding How to bind 250 thousand addresses to coordinates in 10 minutes? 👨‍👨‍👧 🚉 🍋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 In this article, I would like to share my experience in solving a small problem with a large number of addresses. If you have ever wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Geocoding How to bind 250 thousand addresses to coordinates in 10 minutes?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499990/"><img src="https://habrastorage.org/webt/6b/g3/oo/6bg3ooc_jcrhty63bg_33x8inta.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I would like to share my experience in solving a small problem with a large number of addresses. </font><font style="vertical-align: inherit;">If you have ever worked with the geocoding API or used online tools, then I think you share my pain of waiting for the result for several hours, or even more. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is not about complex optimization algorithms, but about using a packet geocoding service that takes a list of addresses as input and returns a file with the results. </font><font style="vertical-align: inherit;">This can reduce processing time from a few hours to minutes.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First things first:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batch Geocoding</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choosing a Packet Geocoder Provider</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Service Guide</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Batch Class Description</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Results Analysis</font></font></h3></a></li>
</ul><br>
<a name="history"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task arrived - “Bind to the coordinates of 24 thousand addresses.” </font><font style="vertical-align: inherit;">Only two solutions to the problem occurred:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web application for geocoding, which was used at the university;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write a script based on the REST API of the geocoder.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first case, it turned out that the web application crashes after processing thousands of addresses. Distributing a dataset between colleagues is an idea that was immediately abandoned. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, you need to use the REST API of the geocoder to write your own script, with the results saved (this is not a completely legal way and you need to read the terms of use of the service). A new problem arises - it’s one thing when we use address search in the application and immediately get the result, but when the task is to process more than ten thousand addresses with preservation, the work of the script is greatly delayed. You can wait an hour or two, but a million addresses will have to geocode “immense time”, so you need to look for another solution and it is!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Large providers of geolocation services, in addition to the usual geocoding service, offer a packet geocoder (Batch Geocoder), just in order to process a large number of addresses in one request.</font></font><br>
<br>
<a name="batch"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batch Geocoding</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The name of the service speaks for itself - we have a package (for example, a csv file with a list of addresses in the form of a table), which we upload to the server, and it does all the work for us. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The process looks like this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparing the dataset so that the service accepts it without errors;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting the parameters of the result of the work (selection of columns, separator ...);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upload a file to the cloud;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for processing to complete;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download the finished file.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to cloud computing power, what is done with a self-written script in 1 hour is completed in 1 minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to choose the company with the most loyal terms of use of the packet geocoder. </font><font style="vertical-align: inherit;">Firstly, not everyone has such a service, others allow you to test the service with a serious limitation. </font><font style="vertical-align: inherit;">Also, if you have very large volumes, you need to pay attention to the cost of additional transactions, in case the limit of the free package is exceeded.</font></font><br>
<br>
<a name="provider"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choosing a Batch Geocoding Service Provider</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the global market for geolocation services, the leading positions are occupied by: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Maps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MapBox</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TomTom </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, you should not forget about Yandex Technologies, which has a fairly strong position in Russia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I took the following parameters as a basis for choosing a provider:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of requests to the geocoding service per month is free;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limit on the number of transactions per day;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Availability of batch geocoding service;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ability to use a packet geocoder in a free plan. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each company has its own monetization model. </font><font style="vertical-align: inherit;">Depending on the project, one or another model can play into the hands or vice versa be a significant limitation.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google maps</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get started with Google geo services, the first thing you need to do is add credit card information to your account. A monthly limit of 200 virtual dollars, then comes the payment of additional transactions from the linked card. Within this limit, you can use various services, but each transaction is considered differently. For example, one thousand geocoding requests will cost $ 5, but the route building service is twice as expensive. More details can be found on the site, we are only interested in the geocoding service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If $ 200 per month, then it’s easy to calculate the free number of transactions - 40,000 (geocoding service). </font><font style="vertical-align: inherit;">There is no packet geocoder among services. </font><font style="vertical-align: inherit;">This means that you have to write your own script and the result will be about 1 address per second, which is six hours for 24 thousand addresses. </font><font style="vertical-align: inherit;">To speed up the process, you can try running the script on the Google Cloud APIs platform, but I decided to look for alternative solutions. </font><font style="vertical-align: inherit;">There are no restrictions on the number of transactions per day, so all forty thousand can be spent at a time.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the past, Nokia Maps, and in the even deeper past, Navteq, provides 250,000 transactions every month for free. Similarly to Google Maps, this number applies to all services and each is considered differently. When using the free package, you do not need to attach a bank card. If you exceed the limit, then for each additional thousand transactions you need to pay $ 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to have a packet geocoder as a separate service, which is included in the free plan. Transactions in it are taken into account according to the same model as in the usual one, that is, each address in the file, the packet geocoder will perceive in one transaction.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the title of the article, it is clear that I used the HERE batch geocoder, since you can spend all transactions on the geocoder and perform 250,000 geocoding operations per month. </font><font style="vertical-align: inherit;">But this is not the only option, so we look at what other companies have.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapbox</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using the MapBox geocoder, 100 thousand transactions per month are available. </font><font style="vertical-align: inherit;">The company adheres to the same monetization model with payment for additional transactions. </font><font style="vertical-align: inherit;">Only there is an interesting option for “wholesalers” - the more transactions you have, the less they cost (of course there is a price reduction limit). </font><font style="vertical-align: inherit;">For example, from 100 thousand to 500 thousand, an additional thousand requests will cost $ 0.75, from 500 thousand to 1 million - $ 0.60, etc., more can be found on the website. </font><font style="vertical-align: inherit;">Unfortunately, batch geocoder is only available in a paid account.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomtom</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The platform makes it possible to carry out 2500 transactions per day, approximately 75,000 per month. </font><font style="vertical-align: inherit;">During testing and development, the daily limit does not look very attractive compared to competitors, but the payment for additional transactions is the most flexible. </font><font style="vertical-align: inherit;">There are 8 payment options for an extra thousand requests and the price is reduced from $ 0.5 to $ 0.42. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Among the services there is a batch geocoder with the ability to process up to 10 thousand addresses per request (however, the daily limit must be taken into account).</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A model with a daily transaction limit for Yandex, but more loyal 25 thousand requests. </font><font style="vertical-align: inherit;">If you multiply this number by the number of days in a month, you get an impressive figure of 750 thousand. </font><font style="vertical-align: inherit;">The site presents prices for an additional thousand transactions in rubles ranging from 120 rubles. </font><font style="vertical-align: inherit;">up to 11 rubles </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packet geocoder as a service is not presented, so to achieve some kind of optimization will fail.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very tempting free plan with 1 million transactions per month. </font><font style="vertical-align: inherit;">The company also charges 50 credits to each account (approximate equivalent of $ 5). </font><font style="vertical-align: inherit;">It is worth noting that this is the most loyal plan for the use of geolocation services. </font><font style="vertical-align: inherit;">There is also a batch geocoding service, but you can use it only if you have a corporate account on the ArcGIS Online platform.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to choose in the end?</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way is to make a choice by compiling a small table: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/xy/b1/kgxyb1kmzemqxqicwajfi7hggva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, my choice fell on HERE since it is the best option for solving my problem. </font><font style="vertical-align: inherit;">Of course, I did far from complete analysis, ideally you need to run your dataset through all geocoders to assess quality. </font><font style="vertical-align: inherit;">Plus, if you have several million addresses, you should think about a paid package and then you need to take into account the cost of add. </font><font style="vertical-align: inherit;">transactions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The purpose of the article is not to compare companies, but to solve the problem of optimizing the geocoding of a large volume of addresses. </font><font style="vertical-align: inherit;">I just showed my thoughts when choosing a service provider.</font></font><br>
<br>
<a name="guide"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Service Guide</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to create an account on the portal for developers and generate a REST API KEY in the project section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can work with the platform. </font><font style="vertical-align: inherit;">I will describe only part of the functionality that the HERE packet geocoder has: data loading, status checking, saving results. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, let's start by importing the necessary libraries:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, if no errors have occurred, create a class:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"your_api_key"</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, during initialization, the class must pass its own key for the REST API. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SERVICE_URL variable is the base URL for working with the batch geocoding service. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in jobId the identifier of the current work of the geocoder will be stored. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An important point is the correct data structure upon request. </font><font style="vertical-align: inherit;">The file must contain two required columns: recId and searchText. </font><font style="vertical-align: inherit;">Otherwise, the service will return a response with information about the download error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is an example dataset:</font></font><br>
<br>
<pre><code class="plaintext hljs">   recId; searchText<font></font>
   1; -, . , 6<font></font>
   2; ,  1,  -., 72<font></font>
   3; 425 W Randolph St Chicago IL 60606<font></font>
   4; , DJ106 20-30, Sibiu 557260<font></font>
   5; 200 S Mathilda Ave Sunnyvale CA 94086<font></font>
  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Function for uploading a file to the cloud:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is quite simple, open a file with a list of addresses for reading, form a dictionary of GET request parameters. </font><font style="vertical-align: inherit;">Some parameters are worth explaining:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Action”: “run” - start of address processing;</font></font></li>
<li>“politicalView”: “RUS” –    .         (    );</li>
<li>“gen”: 9 –   (   );</li>
<li>“maxresults”: 1 –          ;</li>
<li>“header”: true –        ;</li>
<li>“indelim”: “;” –   ,  ;</li>
<li>“outdelim”: “;” –    ;</li>
<li>“outcols”: “” –  ,      ;</li>
<li>“outcombined”: true –                .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, just send a request using the requests library and display statistics. </font><font style="vertical-align: inherit;">Of course, you need to close the file at the end of the function. </font><font style="vertical-align: inherit;">The __stats function parses the response of the server, which contains the Id of the running work, and also displays general information about the operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to check the status of the work. </font><font style="vertical-align: inherit;">The request is formed in a similar way, only it is necessary to transfer the operation Id. </font><font style="vertical-align: inherit;">The action parameter must contain the value “status”. </font><font style="vertical-align: inherit;">The __stats function displays complete statistics to the console to estimate the geocoder shutdown time.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most important functions is to save the result. </font><font style="vertical-align: inherit;">For convenience, it is better to immediately unzip the file that comes from the server. </font><font style="vertical-align: inherit;">The request to save the file is identical to checking the status, just add / result at the end.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final function for parsing the response of the service. </font><font style="vertical-align: inherit;">Also her task is to save the identifier of the current geocoding task:</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To test it, just run the Python interpreter in the script folder. </font><font style="vertical-align: inherit;">The Batch class is in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geocoder.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; from geocoder import Batch<font></font>
&gt;&gt;&gt; service = Batch(apikey="   REST API")<font></font>
&gt;&gt;&gt; service.start("big_data_addresses.csv", indelim=";", outdelim=";")<font></font>
<font></font>
requestid: "  Id "<font></font>
status: accepted<font></font>
totalcount: 0<font></font>
validcount: 0<font></font>
invalidcount: 0<font></font>
processedcount: 0<font></font>
pendingcount: 0<font></font>
successcount: 0<font></font>
errorcount: 0<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great job started. </font><font style="vertical-align: inherit;">Check the status:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.status()<font></font>
<font></font>
requestid: "  Id "<font></font>
status: completed<font></font>
jobstarted: 2020-04-27T10:09:58.000Z<font></font>
jobfinished: 2020-04-27T10:17:18.000Z<font></font>
totalcount: 249999<font></font>
validcount: 249999<font></font>
invalidcount: 0<font></font>
processedcount: 249999<font></font>
pendingcount: 0<font></font>
successcount: 249978<font></font>
errorcount: 21<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the processing of the dataset is complete. </font><font style="vertical-align: inherit;">In just seven minutes, it was possible to procode the 250 thousand addresses (excluding errors - errorcount). </font><font style="vertical-align: inherit;">It remains to save the results:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.result()<font></font>
Requesting result data ...<font></font>
File saved successfully<font></font>
</code></pre><br>
<a name="code"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Batch Class Description</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think that it doesn’t hurt to add the script completely:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"   REST API "</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
        <font></font>
            <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
    <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
        <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
    <font></font>
<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br>
<a name="result"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Results Analysis</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, I went from slowly working online applications to batch geocoding services. </font><font style="vertical-align: inherit;">The choice of a geo-service provider depends entirely on the tasks that confront you. </font><font style="vertical-align: inherit;">I regularly receive requests for processing a large number of addresses and the approach described in the article helped to significantly reduce the time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope that this article will be useful and of course I am open to comments and additions!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499974/index.html">3D games on Instagram Javascript, or sausage flight path</a></li>
<li><a href="../en499978/index.html">Translation of Andrew Un's book, Passion for Machine Learning, Chapters 36 and 37</a></li>
<li><a href="../en499982/index.html">Beginner Tester Plan: From “Enter IT” to “I Am an Engineer!”</a></li>
<li><a href="../en499986/index.html">And again about embedded: looking for bugs in the Embox project</a></li>
<li><a href="../en499988/index.html">Sugar and COVID-19</a></li>
<li><a href="../en499992/index.html">Design technologies for the implementation of billing systems for corporate clients (part 2)</a></li>
<li><a href="../en499994/index.html">When coronavirus will end</a></li>
<li><a href="../en500000/index.html">To Radio Day. Communication - the nerves of war</a></li>
<li><a href="../en500002/index.html">IT specialists vs salesmen: and the world cracked in half</a></li>
<li><a href="../en500008/index.html">Meet upscalers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>