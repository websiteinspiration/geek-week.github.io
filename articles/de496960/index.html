<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🚀 🖐️ 👼🏿 Beschleunigen von Diagrammen mit OffscreenCanvas 🚃 👩🏻 🗃️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Rendern von Diagrammen kann den Browser ernsthaft beeinträchtigen. Insbesondere, wenn es darum geht, eine Vielzahl von Elementen auszugeben, die D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Beschleunigen von Diagrammen mit OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Rendern von Diagrammen kann den Browser ernsthaft beeinträchtigen. </font><font style="vertical-align: inherit;">Insbesondere, wenn es darum geht, eine Vielzahl von Elementen auszugeben, die Diagramme in der Schnittstelle einer komplexen Anwendung darstellen. </font><font style="vertical-align: inherit;">Sie können versuchen, die Situation mithilfe der Benutzeroberfläche zu verbessern </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, deren </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterstützung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allmählich zunimmt. </font><font style="vertical-align: inherit;">Mithilfe eines Web-Workers können die Aufgaben zum Erstellen eines in einem sichtbaren Element angezeigten Bilds verschoben werden </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Der Artikel, dessen Übersetzung wir heute veröffentlichen, ist der Verwendung der Schnittstelle gewidmet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hier werden wir darüber sprechen, warum diese Schnittstelle möglicherweise benötigt wird, was wirklich von ihrer Verwendung erwartet werden kann und welche Schwierigkeiten bei der Arbeit damit auftreten können.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum auf OffscreenCanvas achten?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der beim Rendern des Diagramms beteiligte Code kann selbst eine ausreichend hohe Rechenkomplexität aufweisen. An </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vielen Stellen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> finden Sie detaillierte Geschichten zum Anzeigen einer reibungslosen Animation und zur Gewährleistung einer bequemen Benutzerinteraktion mit der Seite. Es ist erforderlich, dass das Rendern eines Frames innerhalb von etwa 10 ms passt, sodass Sie 60 Frames pro Sekunde erreichen können. Wenn die zur Ausgabe eines Frames erforderlichen Berechnungen länger als 10 ms dauern, führt dies zu spürbaren „Verlangsamungen“ der Seite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Anzeige von Diagrammen wird die Situation jedoch durch Folgendes verschärft:</font></font><br>
<br>
<ul>
<li>        —   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( —   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Probleme sind ideale Kandidaten für einen klassischen Optimierungsansatz namens Teilen und Erobern. In diesem Fall geht es um die Verteilung der Rechenlast auf mehrere Threads. Vor dem Erscheinen der Schnittstelle musste jedoch der </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gesamte Rendering-Code im Hauptthread ausgeführt werden. Nur so kann dieser Code die benötigten APIs verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus technischer Sicht könnten "schwere" Berechnungen früher an einen Web-Worker-Thread ausgegeben werden. Da die für das Rendern verantwortlichen Aufrufe jedoch vom Hauptstrom aus erfolgen mussten, mussten komplexe Nachrichtenaustauschschemata zwischen dem Arbeitsstrom und dem Hauptstrom im Diagrammausgabecode verwendet werden. Darüber hinaus ergab dieser Ansatz oft nur einen geringen Leistungsgewinn. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spezifikation</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gibt uns einen Mechanismus zum Übertragen der Oberflächensteuerung zur Anzeige von Elementgrafiken </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem Webworker. </font><font style="vertical-align: inherit;">Diese Spezifikation wird derzeit von Chrome- und Edge-Browsern unterstützt (nachdem Edge auf Chromium migriert wurde). </font><font style="vertical-align: inherit;">Es wird erwartet, dass der Support in Firefox </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">innerhalb von sechs Monaten erfolgt. </font><font style="vertical-align: inherit;">Wenn wir über Safari sprechen, ist noch nicht bekannt, ob die Unterstützung dieser Technologie in diesem Browser geplant ist.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrammausgabe mit OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Beispiel für ein Diagramm mit 100.000 mehrfarbigen Punkten</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Um die potenziellen Vor- und Nachteile besser einschätzen zu können</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sehen wir uns ein Beispiel für die Ausgabe des in der vorherigen Abbildung gezeigten „schweren“ Diagramms an.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst fragen wir </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das Element </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit der neuen Methode ab </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dann rufen wir die Methode </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf und senden dazu eine Nachricht an den Worker, die einen Link zu enthält </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es ist sehr wichtig, dass Sie hier als zweites Argument verwenden </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Auf diese Weise können Sie den Eigentümer dieses Objektarbeiters festlegen, sodass er ihn alleine verwalten kann </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Anbetracht der Tatsache, dass die Größen </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ursprünglich von den Attributen </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und dem </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Element </font><font style="vertical-align: inherit;">geerbt wurden </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, liegt es in unserer Verantwortung, diese Werte auf dem neuesten Stand zu halten, wenn die Größe des Elements geändert wird </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hier nutzen wir das Ereignis </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, das uns in Übereinstimmung mit die Möglichkeit gibt, </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dem Arbeiter Informationen über die neuen Dimensionen des Elements zu übermitteln </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Beispiel zu vereinfachen, verwenden wir Komponenten aus der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">. Dies ist eine Reihe von Hilfskomponenten, die entweder d3-Komponenten aggregieren oder deren Funktionalität ergänzen. Sie </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können ohne d3fc-Komponenten arbeiten. Alles, was besprochen wird, kann ausschließlich mit Standard-JavaScript-Funktionen durchgeführt werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie nun zum Code aus der Datei </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In diesem Beispiel verwenden wir WebGL, um die Renderleistung wirklich zu steigern.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir eine Nachricht mit einer Eigenschaft erhalten </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, gehen wir davon aus, dass die Nachricht vom Hauptthread stammt. Als nächstes erhalten wir den </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontext </font><font style="vertical-align: inherit;">aus dem Element </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und übergeben ihn an die Komponente </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dann rufen wir die Komponente auf </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und übergeben ihr die Daten ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), die wir damit rendern möchten (im Folgenden wird erläutert, woher die entsprechenden Variablen </font><font style="vertical-align: inherit;">stammen </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus überprüfen wir die Eigenschaften </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die in der Nachricht enthalten waren, und verwenden sie, um die Abmessungen </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzeigebereich von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL festzulegen. Der Link </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird nicht direkt verwendet. Tatsache ist, dass die Nachricht entweder eine Eigenschaft </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder Eigenschaften </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und enthält </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der verbleibende Worker-Code ist für das Einrichten des Renderings der Ausgabe verantwortlich. </font><font style="vertical-align: inherit;">Hier gibt es nichts Besonderes. Wenn Ihnen all dies bekannt ist, können Sie sofort mit dem nächsten Abschnitt fortfahren, in dem wir die Leistung besprechen.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst erstellen wir einen Datensatz, der die Koordinaten von Punkten enthält, die zufällig um den Ursprung x / y verteilt sind, und passen die Skalierung an. </font><font style="vertical-align: inherit;">Wir geben mit der Methode keinen Bereich von x- und y-Werten an </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, da die WebGL-Reihen </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in den normalisierten Koordinaten des Geräts </font><font style="vertical-align: inherit;">in voller Größe des Elements angezeigt </font><font style="vertical-align: inherit;">werden.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes richten wir eine Reihe von Punkten mit </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und ein </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Anschließend konfigurieren wir die geeigneten Zugriffsmöglichkeiten, mit denen Sie Daten lesen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus definieren wir eine eigene Gleichstellungsprüfungsfunktion, mit der sichergestellt werden soll, dass die Komponente nicht </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bei jedem Rendering GPUs </font><font style="vertical-align: inherit;">überträgt </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir müssen dies explizit ausdrücken, denn selbst wenn wir wissen, dass wir diese Daten nicht ändern werden, kann die Komponente nichts davon wissen, ohne eine ressourcenintensive „schmutzige“ Prüfung durchzuführen.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Code können Sie das Diagramm einfärben. </font><font style="vertical-align: inherit;">Wir verwenden den Index des Punkts im Datensatz, um die entsprechende Farbe auszuwählen </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, konvertieren ihn dann in das gewünschte Format und verwenden ihn zum Dekorieren des Ausgabepunkts.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem die Punkte gefärbt sind, müssen Sie nur noch das Diagramm animieren. Aus diesem Grund benötigen wir einen konstanten Methodenaufruf </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dies führt außerdem zu einer gewissen Belastung des Systems. Wir simulieren die Vergrößerung und Verkleinerung des Diagrammmaßstabs, indem wir </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Eigenschaften </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jeden Frame </font><font style="vertical-align: inherit;">ändern </font><font style="vertical-align: inherit;">. Hier werden zeitabhängige Werte angewendet und berechnet, damit sich der Maßstab des Diagramms reibungslos ändert. Außerdem ändern wir den Nachrichtenkopf so, dass eine Methode aufgerufen wird, um den Renderzyklus zu starten </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und dass wir nicht direkt aufrufen müssen </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit dieses Beispiel funktioniert, müssen nur die erforderlichen Bibliotheken in den Worker importiert werden. </font><font style="vertical-align: inherit;">Wir verwenden dies </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und um die Tools zum Erstellen von Projekten nicht zu verwenden, verwenden wir eine Liste manuell erstellter Abhängigkeiten. </font><font style="vertical-align: inherit;">Leider können wir nicht einfach die vollständigen d3 / d3fc-Builds herunterladen, da sie vom DOM abhängen und das, was sie benötigen, im Worker nicht verfügbar ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ Den vollständigen Code für dieses Beispiel finden Sie auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OffscreenCanvas und Leistung</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Animation in unserem Projekt funktioniert dank des Einsatzes </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eines Arbeiters. Auf diese Weise kann der Worker Seiten rendern, auch wenn der Hauptthread mit anderen Dingen beschäftigt ist. Wenn Sie sich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im vorherigen Abschnitt beschriebene Projektseite </font><font style="vertical-align: inherit;">ansehen </font><font style="vertical-align: inherit;">und auf die Schaltfläche klicken </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, können Sie darauf achten, dass die Aktualisierung der Zeitstempelinformationen gestoppt wird, wenn das Meldungsfeld angezeigt wird. Der Haupt-Thread ist blockiert, aber die Diagrammanimation wird nicht gestoppt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projektfenster</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir könnten ein Rendering organisieren, das durch den Empfang von Nachrichten vom Hauptstrom initiiert wird. Solche Ereignisse können beispielsweise gesendet werden, wenn ein Benutzer mit einem Diagramm interagiert oder wenn frische Daten über das Netzwerk empfangen werden. Bei diesem Ansatz wird das Rendern jedoch gestoppt, wenn der Hauptthread mit etwas beschäftigt ist und keine Nachrichten im Worker empfangen werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das kontinuierliche Rendern des Diagramms unter Bedingungen, unter denen nichts passiert, ist eine großartige Möglichkeit, den Benutzer mit einem summenden Lüfter und einer schwachen Batterie zu ärgern. Infolgedessen stellt sich heraus, dass in der realen Welt die Entscheidung über die Aufteilung der Verantwortlichkeiten zwischen dem Hauptthread und dem Arbeitsthread davon abhängt, ob der Arbeiter etwas Nützliches leisten kann, wenn er keine Nachrichten über eine Änderung der Situation vom Hauptthread erhält.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir über die Übertragung von Nachrichten zwischen Threads sprechen, sollte beachtet werden, dass wir hier einen sehr einfachen Ansatz angewendet haben. Ehrlich gesagt müssen wir nur sehr wenige Nachrichten zwischen Threads übertragen, daher würde ich unseren Ansatz eher als Folge von Pragmatismus und nicht als Faulheit bezeichnen. Wenn wir jedoch über reale Anwendungen sprechen, kann festgestellt werden, dass das Nachrichtenübertragungsschema zwischen den Flüssen komplizierter wird, wenn die Interaktion des Benutzers mit dem Diagramm und die Aktualisierung der visualisierten Daten davon abhängen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können die Standard- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">MessageChannel-</font></a><font style="vertical-align: inherit;"> Schnittstelle verwenden, um separate Nachrichtenkanäle zwischen dem Hauptthread und dem </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Arbeitsthread</font></a><font style="vertical-align: inherit;"> zu erstellen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Jeder dieser Kanäle kann für eine bestimmte Kategorie von Nachrichten verwendet werden, was die Verarbeitung von Nachrichten erleichtert. Als Alternative zu Standardmechanismen können Bibliotheken von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drittanbietern</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wie </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Comlink</font></a><font style="vertical-align: inherit;"> fungieren </font><font style="vertical-align: inherit;">. Diese Bibliothek verbirgt Details auf niedriger Ebene hinter einer Schnittstelle auf hoher Ebene unter Verwendung von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxy-Objekten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres interessantes Merkmal unseres Beispiels, das im Nachhinein deutlich sichtbar wird, ist die Tatsache, dass es die Tatsache berücksichtigt, dass GPU-Ressourcen wie andere Systemressourcen alles andere als endlos sind. Durch die Übersetzung des Renderns in einen Worker kann der Haupt-Thread andere Probleme lösen. Der Browser muss jedoch die GPU verwenden, um das DOM und die mit den Mitteln generierten Daten zu rendern </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Worker alle GPU-Ressourcen verbraucht, treten im Hauptanwendungsfenster Leistungsprobleme auf, unabhängig davon, wo das Rendern ausgeführt wird. Achten Sie darauf, wie die Geschwindigkeit der Aktualisierung des Zeitstempels im Beispiel mit zunehmender Anzahl der angezeigten Punkte abnimmt. Wenn Sie über eine leistungsstarke Grafikkarte verfügen, müssen Sie möglicherweise die Anzahl der auf die Seite übertragenen Punkte in der Abfragezeichenfolge erhöhen. Dazu können Sie einen Wert verwenden, der den Maximalwert von 100000 überschreitet, der über einen der Links auf der Beispielseite angegeben wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sollte beachtet werden, dass wir hier die geheime Welt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">der Kontextattribute</font></a><font style="vertical-align: inherit;"> nicht erforscht haben</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eine solche Studie könnte uns helfen, die Produktivität der Lösung zu steigern. </font><font style="vertical-align: inherit;">Ich habe dies jedoch nicht getan, da diese Attribute nur wenig unterstützt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir über das Rendern mit sprechen </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sieht das Attribut hier am interessantesten aus </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn es unterstützt wird und einige Einschränkungen berücksichtigt werden, können Sie die Synchronisation zwischen der Ereignisschleife und der im Worker ausgeführten Rendering-Schleife aufheben. </font><font style="vertical-align: inherit;">Dies minimiert die Verzögerung beim Aktualisieren des Bildes. </font><font style="vertical-align: inherit;">Details dazu finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassung</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Benutzeroberfläche </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bietet Entwicklern die Möglichkeit, die Leistung beim Rendern von Diagrammen zu verbessern. Die Verwendung erfordert jedoch einen durchdachten Ansatz. </font><font style="vertical-align: inherit;">Bei der Verwendung müssen Sie Folgendes berücksichtigen:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier ist ein</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beispielcode und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist seine Arbeitsversion. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liebe Leser! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haben Sie OffscreenCanvas verwendet, um die Anzeige von Grafiken auf Webseiten zu beschleunigen?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496950/index.html">Design ist Design, nicht die Schönheit von Bildern.</a></li>
<li><a href="../de496952/index.html">Qualcomm QCC3020 - der Aufstieg der chinesischen TWS-Kopfhörer</a></li>
<li><a href="../de496954/index.html">Entwicklung bei Wargaming - Treffen mit Maxim Baryshnikov, Leiter der Plattform (Teil I)</a></li>
<li><a href="../de496956/index.html">Warum wurden asynchrone Webserver angezeigt?</a></li>
<li><a href="../de496958/index.html">Interessante CSS-Funde im neuen Facebook-Design</a></li>
<li><a href="../de496962/index.html">Wie räume ich einen überlasteten Server auf?</a></li>
<li><a href="../de496964/index.html">IBM wöchentliche Seminare - April 2020</a></li>
<li><a href="../de496966/index.html">CSS LCH Farben</a></li>
<li><a href="../de496968/index.html">4 Aktionen, die für den Anführer während COVID-19 unverzeihlich sind</a></li>
<li><a href="../de496972/index.html">Trends zur Lebensmittelsicherheit 2020. Kostenlose Online-Mitap 21. April</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>