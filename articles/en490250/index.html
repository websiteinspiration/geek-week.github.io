<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÜüèΩ üòº üÜï Horror Set.removeAll ü•§ ‚ôÇÔ∏è üî¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are used to the fact that the standard collections in the JDK are made quite well and behave intuitively. But is it really so? Yesterday Roman Eliz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Horror Set.removeAll</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/490250/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are used to the fact that the standard collections in the JDK are made quite well and behave intuitively. </font><font style="vertical-align: inherit;">But is it really so? </font><font style="vertical-align: inherit;">Yesterday Roman Elizarov</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elizarov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">posted </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on Twitter the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> news about a new interesting jamb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hold on tight: </font></font><code>Set.removeAll(list)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in certain cases it can work for O (N¬≤). </font><font style="vertical-align: inherit;">How so?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/ba/mg/otbamgebw5vwvdqyoy5e9e8ni-o.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Roman discovered a problem when he debugged a piece of code that, for an amazing reason, worked too slowly. He launched it in the built-in profiler in IntelliJ IDEA and instantly saw on the flame graph that he was wasting all the time inside the method </font></font><code>AbstractSet.removeAll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on a call </font></font><code>list.contains</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(link to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exact place in the code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand what is happening, consider a slightly different example. Earlier, Jon Skeet wrote a post </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúThere's a hole in my abstraction, dear Liza, dear Liza"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in which he considers the following interesting case.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say we have a HashSet from which we are going to delete something. </font><font style="vertical-align: inherit;">Suppose we remove elements from another collection B from one collection A. It often happens that many elements from B simply do not exist in A. We will analyze a special case when A and B do not intersect at all - that is, nothing needs to be done. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will write a simple program in which the sizes of our collections are set from the command line. </font><font style="vertical-align: inherit;">So that these sets do not exactly intersect, one of them will be filled with only positive numbers, and the other with only negative numbers. </font><font style="vertical-align: inherit;">Then we remove from the first collection all the elements of the second and measure the elapsed time using</font></font><code>System.currentTimeMillis()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is not the best way in the world to calculate the time interval, but it makes it possible to copy-paste the code directly from Habr to Idea and saves us from having to set up a new Maven project for JMH.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
       <span class="hljs-keyword">int</span> sourceSize = Integer.parseInt(args[<span class="hljs-number">0</span>]);
       <span class="hljs-keyword">int</span> removalsSize = Integer.parseInt(args[<span class="hljs-number">1</span>]);<font></font>
<font></font>
       Set&lt;Integer&gt; source = <span class="hljs-keyword">new</span> HashSet&lt;Integer&gt;();<font></font>
       Collection&lt;Integer&gt; removals = <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;();<font></font>
<font></font>
       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sourceSize; i++) {<font></font>
           source.add(i);<font></font>
       }<font></font>
       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= removalsSize; i++) {<font></font>
           removals.add(-i);<font></font>
       }<font></font>
<font></font>
       <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<font></font>
       source.removeAll(removals); <font></font>
       <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<font></font>
       System.out.println(<span class="hljs-string">"Time taken: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Very simple code that can be written without regaining consciousness. </font><font style="vertical-align: inherit;">Now let's run it with different parameters. </font><font style="vertical-align: inherit;">First, try a set of 100 elements from which you need to throw 100:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ java Test 100 100<font></font>
Time taken: 1ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, everything is fast enough, but what happens if you increase the numbers?</font></font><br>
<br>
<pre><code class="plaintext hljs">java Test 1000000 300000<font></font>
Time taken: 38ms<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$java Test 300000 300000<font></font>
Time taken: 178131ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do you like this: now we wait three minutes. </font><font style="vertical-align: inherit;">It seems intuitively that the processing time of a smaller collection (300,000 items in the second case) should be less than when processing a larger collection (a million items in the first case). </font><font style="vertical-align: inherit;">Immediately the opposite is true. </font><font style="vertical-align: inherit;">Life wasn‚Äôt preparing for this, right? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the secret of focus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, it is described in clear text </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the corresponding JavaDoc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation code determines whether it is less: set or collection. </font><font style="vertical-align: inherit;">This is done using the method </font></font><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on each of them. </font><font style="vertical-align: inherit;">If there are fewer elements in set, then iteration is performed on the set, and at each iteration it is checked whether the current element is in the collection. </font><font style="vertical-align: inherit;">If yes, then the element is removed from the set using the </font></font><code>remove</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iterator </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If it turns out that the collection is smaller in the number of elements, then it will be necessary to bypass the collection already, removing from the set all such elements using the method </font></font><code>remove</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from set.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In practice, this means that when called </font></font><code>source.removeAll(removals)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the collection is </font></font><code>removals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smaller than </font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the method is called </font></font><code>remove</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>HashSet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and it is pretty fast;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the collection is </font></font><code>removals</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">larger or equal in size than </font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then a method is called </font></font><code>removals.contains</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that works very slowly for </font></font><code>ArrayList</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In JDK 8, something like this is responsible for this piece of code:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">removeAll</span><span class="hljs-params">(Collection&lt;?&gt; c)</span> </span>{<font></font>
    Objects.requireNonNull(c);<font></font>
    <span class="hljs-keyword">boolean</span> modified = <span class="hljs-keyword">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (size() &gt; c.size()) {
        <span class="hljs-keyword">for</span> (Iterator&lt;?&gt; i = c.iterator(); i.hasNext(); )<font></font>
            modified |= remove(i.next());<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (Iterator&lt;?&gt; i = iterator(); i.hasNext(); ) {
            <span class="hljs-keyword">if</span> (c.contains(i.next())) {<font></font>
                i.remove();<font></font>
                modified = <span class="hljs-keyword">true</span>;<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> modified;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that the JDK has chosen a rather poor way to cope with the task, but since it is already described in JavaDoc, there is no turning back. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Or is there? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
People rushed to Roman Yelizarov‚Äôs tweet, and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zheka Kozlov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> found a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corresponding bug</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> posted on JDK 15 with the performer, Stuart Marx. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And after this, Stuart Marx himself burst into the thread and confirmed that he was really dealing with this problem:</font></font><br>
<br>
<div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1232810950211670016"></twitter-widget>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So there is light at the end of the tunnel. </font><font style="vertical-align: inherit;">If you upgrade to the latest versions of Java, of course.</font></font><br>
<br>
<h2><font color="#D93740"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conclusions from this story are as follows: there is a problem worth knowing about. </font><font style="vertical-align: inherit;">The problem is already being repaired, but repaired only for happy users of fresh Java, and you should not really hope for it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, when you try to store a lot of data in collections in Java, you may experience various unintuitive problems that you need to be prepared for.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, kids, today we learned something new! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a continuation of the banquet, I recommend that you look at some reports by Roman Elizarov, who helped to bring this bug to light. </font><font style="vertical-align: inherit;">Of course, these reports have nothing to do with the bug itself, but there are a bunch of different tin plates:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´  Kotlin¬ª</a> (JPoint 2018)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´Kotlin:     ( 1)¬ª</a> (JUG 2017)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´Kotlin:     ( 2)¬ª</a> (JUG 2017)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´  ‚Äî   ¬ª</a> (JPoint 2016)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´    !¬ª</a> (JPoint 2016)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´ GC    CPU?¬ª</a> (Joker 2014)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´    Java Memory Model¬ª (JPoint 2014)</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´    Java-¬ª</a> (Joker 2013)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´      Java¬ª</a> (JUG 2013)</li>
</ul><br>
<blockquote>       JPoint,      ,    2020   .    ,  ,    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  </a>.</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490232/index.html">Load Balancing with AWS ELB</a></li>
<li><a href="../en490242/index.html">GSM Location service of SIM800x modules and its work with Yandex.Locator API</a></li>
<li><a href="../en490244/index.html">Python code optimization with ctypes</a></li>
<li><a href="../en490246/index.html">Kremlin Towers in Hydra's Embrace: Hydra 2020 Parallel and Distributed Computing Conference</a></li>
<li><a href="../en490248/index.html">Webinar ‚ÄúWinnum CNC: monitoring that works‚Äù</a></li>
<li><a href="../en490252/index.html">Modern solutions for building information security systems - network packet brokers (Network Packet Broker)</a></li>
<li><a href="../en490254/index.html">Fuzzy math. Basics of fuzzy sets</a></li>
<li><a href="../en490260/index.html">New storage technologies: is there a breakthrough in 2020?</a></li>
<li><a href="../en490262/index.html">3D Printing: Quick Tips for Moving from a CAD Model to a Printed Object</a></li>
<li><a href="../en490264/index.html">Organization of autotests on the example of a mobile application for EDMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>