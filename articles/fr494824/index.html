<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎓 👩🏻‍🔧 👩🏼‍🚀 Comment le système de contenu des pages Turbo est organisé: schémas, faits et un peu d'histoire 👩🏼‍✈️ ♏️ 🎪</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selon TelecomDaily , près de 30% des utilisateurs d'Internet mobile en Russie rencontrent quotidiennement des problèmes de téléchargement de sites. Ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment le système de contenu des pages Turbo est organisé: schémas, faits et un peu d'histoire</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494824/"><img src="https://habrastorage.org/webt/hq/a5/mv/hqa5mvtylx0m3ns_yixifxt1qw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelecomDaily</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , près de 30% des utilisateurs d'Internet mobile en Russie rencontrent quotidiennement des problèmes de téléchargement de sites. Cependant, la raison peut être non seulement d'une couverture inégale, mais aussi d'un trop grand "poids" de la page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne pouvons pas influencer la qualité de la connexion, mais pour aider les webmasters à simplifier le contenu du site, rendez-le plus facile - pourquoi pas? Ainsi, la technologie des pages Turbo est apparue dans Yandex: notre système de contenu est passé tout ce qui est nécessaire pour le placement, et il convertit ces données en matériaux faciles et rapides. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment fonctionne cette magie? Quel est le chemin d'accès aux données avant de devenir une page Turbo complète? Je m'appelle Stas Makeev, je dirige le développement de la technologie Turbo pages. Maintenant, je vais essayer de tout expliquer.</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais d'abord, c'est un peu un résumé pour que vous ne vous perdiez pas quand je commence à fouiller dans les détails.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un avantage clé du système Turbo pages est la conversion rapide des données du formulaire original au formulaire final: les matériaux des sites d'actualités sont les plus demandés dans les premières minutes après leur publication, et les cartes de marchandises des magasins en ligne doivent être mises à jour rapidement et correspondre toujours à l'état actuel de disponibilité. Le deuxième paramètre important est la fiabilité: le système de contenu doit être aussi stable que possible, être capable de survivre à la panne de serveurs individuels ou même de centres de données entiers. Et, bien sûr, il était important d'éviter une charge excessive sur les hôtes de nos partenaires connectés aux pages Turbo. Autrement dit, lors de la conception du service, il était nécessaire de trouver en quelque sorte un équilibre entre la vitesse de traitement des données et l'augmentation du nombre de demandes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les propriétaires de sites ont plusieurs façons de se connecter au système:</font></font><br>
<br>
<ul>
<li>  . : YML —  -, RSS –   ;</li>
<li>   API:          (    );</li>
<li> : -       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le système de contenu stocke les résultats de son travail dans un stockage spécial de type "valeur-clé" (stockage-valeur-clé ou stockage KV), où la clé est l'URL du site d'origine et la valeur stocke le contenu de la page Turbo. </font><font style="vertical-align: inherit;">Dès que les données tombent dans ce stockage KV, la page Turbo suivante devient immédiatement disponible pour les utilisateurs de recherche, et dans les services Yandex, le document correspondant a une icône spéciale avec une fusée. </font><font style="vertical-align: inherit;">De plus, pour accélérer le travail, nous mettons en cache des photos et des vidéos dans nos CDN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un schéma de travail général très simplifié ressemble à ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/mq/u5/aomqu5polx3u8fse71spyit1eam.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment tout a commencé</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La toute première version du système de contenu a été arrangée très simplement: toutes les quelques minutes, selon le calendrier, le même programme a été lancé sur le serveur cloud interne de Yandex. </font><font style="vertical-align: inherit;">Il consistait en plusieurs étapes, chaque exécution suivante après que les données précédentes étaient prêtes pour tous les flux que nous connaissons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La liste des flux RSS a été téléchargée, l'analyseur de documents a été lancé;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une liste d'images a été extraite des résultats de l'analyseur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les images non mises en cache étaient encore chargées dans le CDN;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les documents traités ont été versés dans le référentiel KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel système fonctionnait parfaitement lorsque le système traitait plusieurs milliers de flux RSS plutôt légers d'agences de presse (au total - informations sur un peu moins de 100 000 documents). Mais avec l'augmentation du nombre de flux, un problème a été rapidement découvert: chaque étape prenait de plus en plus de temps, il y avait un délai entre l'apparition d'un nouveau document dans la source d'origine et son affichage en mode Turbo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons réussi à garder la situation sous contrôle à l'aide de diverses astuces: tout d'abord, nous avons distingué la première étape (téléchargement de flux RSS + un analyseur de documents) dans un processus distinct. Autrement dit, alors que l'un traitait des images pour l'itération précédente, l'autre processus téléchargeait déjà des flux pour la suivante. Après un certain temps, il est devenu clair: sous cette forme, le système est très difficile à mettre à l'échelle. Nous avons besoin de quelque chose de fondamentalement nouveau.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement RSS, API et YML dans le nouveau système de contenu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principal problème de l'ancien système de contenu était que toutes les données étaient traitées en une seule pièce: il n'y avait pas de transition vers l'étape suivante jusqu'à ce que chaque document passe le précédent. </font><font style="vertical-align: inherit;">Pour se débarrasser de cela, il a été décidé de construire un certain pipeline: laisser les flux et les documents individuels être traités de manière aussi indépendante que possible. </font><font style="vertical-align: inherit;">Toutes les étapes ont été séparées en cubes de service distincts - au niveau supérieur, le schéma s'est avéré comme ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g6/lp/xd/g6lpxdauqtwxm9alh-mrgyf_wro.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le premier cube télécharge les flux RSS et les transmet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le second - prend les flux un par un, analyse le contenu. </font><font style="vertical-align: inherit;">A la sortie - documents séparés;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le troisième - prend les documents un par un, traite les photos et les vidéos, enregistre tout dans le stockage KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mêmes flux peuvent être enregistrés non seulement dans Turbo, mais aussi sur nos autres services - dans les News ou sur le Marché, par exemple. Si chacun d'eux télécharge des données par lui-même, la charge sur le serveur des webmasters sera plusieurs fois supérieure à celle autorisée. Comment ça? Téléchargez le flux une fois, puis distribuez le contenu à tous les services aux consommateurs - Yandex.Robot le fait. Nous utilisons ses services pour télécharger du contenu: nous prenons de Yandex.Webmaster une liste des flux RSS et YML enregistrés dans Turbo, la transférons à Robot et souscrivons aux résultats du téléchargement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les données reçues, démarrez l'analyseur. Au cas où, permettez-moi de vous le rappeler: un flux RSS n'est qu'un fichier au format «.XML», accessible par une URL statique sur l'hôte du partenaire. Ce fichier contient des informations sur toutes les mises à jour du site - quels documents sont nouveaux, qui sont modifiés. Seules les informations les plus récentes des dernières heures seraient dans des flux idéaux: pas plus de 100 documents par plusieurs centaines de kilo-octets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Morsures de la réalité: parfois, les fichiers sont dans le flux pendant très longtemps et ne changent jamais. Comment éviter le retraitement dans de tels cas? Nous calculons le hachage de chaque document, le stockons dans la base de données et ne faisons rien jusqu'à ce que le hachage change.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le traitement des flux et des API YML du point de vue du système de contenu n'est pratiquement pas différent de l'interaction avec RSS: pour YML, nous démarrons un autre analyseur et les données transmises via l'API sont obtenues directement auprès de Yandex.Webmaster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/hh/gz/rehhgz4wtfo8nqylaexh74z5dga.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement d'image et vidéo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le document reçu à la sortie de l'analyseur est presque prêt à être écrit dans le stockage KV. </font><font style="vertical-align: inherit;">La seule chose qui reste à faire avant l'envoi est de traiter les images et les vidéos: cachez dans le CDN et remplacez les liens dans le document. </font><font style="vertical-align: inherit;">Là encore, nous nous tournons vers le robot pour obtenir de l'aide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous vérifions chaque image et vidéo: sont-elles dans le CDN? </font><font style="vertical-align: inherit;">Si tout est déjà mis en cache, remplacez les liens et envoyez le document mis à jour au référentiel KV. </font><font style="vertical-align: inherit;">Autrement:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous envoyons la liste des URL manquantes au Robot pour la planification et le téléchargement;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le document lui-même est en stockage temporaire, donc après un certain temps, essayez de le vérifier à nouveau.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre cube à ce moment reçoit les résultats du téléchargement, télécharge les données sur le CDN et met à jour la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un tel schéma, un autre problème important lié à la planification peut être résolu: le robot comprend à quelle vitesse il est possible de télécharger des données à partir de différents hôtes, et ne permet pas les surcharges. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2n/g4/oz/2ng4oz6c5ocn3jjbld4armtcewk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chemin typique suivi par un nouveau document:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le document apparaît dans le flux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le robot télécharge le flux;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'analyseur découvre un nouveau document et l'envoie plus loin;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous vérifions que les images du document ne sont pas mentionnées dans la base de données, commandons le téléchargement, le document est envoyé en stockage temporaire (Delay). </font><font style="vertical-align: inherit;">Pendant que le document est là, le Robot télécharge les images, elles sont mises en cache dans le CDN et les liens apparaissent dans la base de données;</font></font></li>
<li>       ,    CDN,      KV-. </li>
<li> :    ,       Delay.</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une autre façon de se connecter aux pages Turbo, pour lesquelles le webmaster n'a rien à faire - Autoparser. </font><font style="vertical-align: inherit;">Il crée des pages Turbo basées sur les données sources du site de contenu. </font><font style="vertical-align: inherit;">Vous pouvez vous connecter, voir des exemples de pages finies, configurer des annonces et des analyses dans Yandex.Webmaster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La principale difficulté rencontrée par l'AutoParser est de reconnaître par le balisage HTML quelles informations de base doivent être utilisées lors de la création d'une page Turbo. </font><font style="vertical-align: inherit;">Pour ce faire, nous avons plusieurs processus hors ligne qui essaient de comprendre exactement comment analyser un hôte spécifique. </font><font style="vertical-align: inherit;">Je me concentrerai sur deux principaux:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La première</font></font></b>     RSS-    HTML-  .  —    ,       RSS- (    ),   .   ,    .        CatBoost  ,   ,      .     ,          , , .  ,          .  ,     ,  ,        HTML     . ?  :     .  –    ,    .</li>
<li><b></b>   :            ..  ,    ,   ,          ,   —  .       —   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, un obstacle plus fréquent - de nombreux sites bloquent la possibilité de télécharger des images par des robots dans robots.txt. Malheureusement, il est impossible de contourner ce problème et l'Autoparser n'est pas disponible pour ces pages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, le schéma complet du système de contenu ressemble à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ll/jx/-a/lljx-adtt8ykngcnfnutykobxr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le système s'est avéré être bien évolutif: maintenant une quantité importante de ressources est utilisée pour entretenir la base de données, l'autoparser et d'autres composants du système (seul le cube responsable de l'analyse RSS, YML et API utilise plus de 300 processeurs noyaux), et en cas de charge accrue, il ne sera pas trop difficile de connecter des capacités supplémentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci d'avoir lu jusqu'au bout! J'espère, après ce matériel, dans le travail des pages Turbo, vous obtiendrez plus de logique et moins de magie (au fait, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- encore plus de détails sur les pages Turbo). </font><font style="vertical-align: inherit;">Si quelque chose est encore incompréhensible, écrivez dans les commentaires - nous sommes en contact.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494808/index.html">Analyste de produit: que fait-il, combien gagne-t-il, quels avantages apporte l'entreprise</a></li>
<li><a href="../fr494810/index.html">Introduction à la 3D: principes de base de Three.js</a></li>
<li><a href="../fr494814/index.html">Slurm est-il utile?</a></li>
<li><a href="../fr494818/index.html">Comment choisir un terminal de trading pour travailler sur la bourse</a></li>
<li><a href="../fr494820/index.html">Comment les spécifications de l'alimentation ATX12VO d'Intel changeront l'avenir</a></li>
<li><a href="../fr494826/index.html">Être «nouveau» ou ne pas l'être ...</a></li>
<li><a href="../fr494830/index.html">ViennaNET: un ensemble de bibliothèques pour le backend</a></li>
<li><a href="../fr494838/index.html">Modems GSM / 3G / 4G dans des systèmes embarqués utilisant le modem Quectel EC21 LTE et Yocto Project comme exemple</a></li>
<li><a href="../fr494848/index.html">15 femmes qui ont fait une grande contribution à l'astronomie</a></li>
<li><a href="../fr494850/index.html">Configurer Microsoft Windows Server 2016/2019 pour fournir des services DHCP pour VXLAN (DFA)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>