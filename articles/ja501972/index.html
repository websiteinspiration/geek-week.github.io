<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔽 ❄️ 👨🏽‍🎤 IcedID-氷が銀行口座を焼くとき 🏀 💇🏾 ☔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="バイラルアナリストがIcedID / BokBotについて聞いたとき、どのような3つの考えがありましたか？もちろん、Webインジェクション、プロキシサーバー、クイックバージョンアップデートについては。場合によっては非常に高速であるため、アナリストが調査開始時に関連していたバージョンを調査している間に...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IcedID-氷が銀行口座を焼くとき</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/501972/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ji/xb/qo/jixbqo6g11uw5kngngbg8esabms.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バイラルアナリストがIcedID / BokBotについて聞いたとき、どのような3つの考えがありましたか？もちろん、Webインジェクション、プロキシサーバー、クイックバージョンアップデートについては。場合によっては非常に高速であるため、アナリストが調査開始時に関連していたバージョンを調査している間に、新しいバージョンが出てきます。このリストに追加された機能は何ですか？ステガノグラフィーローダー。しかし、新しいバージョンでは、メインのIcedIDモジュールだけでなく、その構成ファイルも非表示になっていると彼らが言ったらどうでしょうか？面白い？次に、それを理解しましょう。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Group-IBマルウェア分析スペシャリスト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である</font><b><font style="vertical-align: inherit;">Ivan Pisarev</font></b><font style="vertical-align: inherit;">氏は、この悪名高いバンキング型トロイの木馬の新バージョンが用意されていると述べています。</font></font><a name="habracut"></a><br>
<br>
<div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/p8/tz/_f/p8tz_fqxuwg0hgsbva_fmord3m0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは、2017年11月にIBM X-Forceの研究者によって最初に説明されたIcedIDについて話し始めました。その時点ですでに、アプリケーションには豊富な機能セット（プロキシサーバー、Webインジェクション、大きなRATアーセナル、VNCモジュールなど）があり、積極的に補充され続けています。</font><font style="vertical-align: inherit;">このバンカー</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も公開しまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">が、それ以来、トロイの木馬はステガノグラフィを使用してファイルシステムとネットワークトラフィックの構成データを隠すなど、新しいチップを入手しています。これについては、この記事で詳しく説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが定期的にトロイの木馬の設定データから抽出するボットの目標から判断すると、彼の興味はそれほど変わっていません。彼はアメリカの銀行のクライアントに最も興味を持っています。</font><font style="vertical-align: inherit;">しかし、興味深い点が1つあります。電気通信（AT＆T）およびモバイル通信（T-Mobile）に携わる企業が目標のリストに含まれています。</font><font style="vertical-align: inherit;">以下は、トロイの木馬が攻撃するターゲットの部分的なリストです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazon.com</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBay</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アメリカンエクスプレス</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AT＆T</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tモバイル</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アメリカ銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャピタルワン</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追跡</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウェルズ・ファーゴ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JPモルガン</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロイズ銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verizon Wireless</font></font></li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まだ</font></font></b>
                        <div class="spoiler_text"><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cibc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメリカ（comerica.com）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デル</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発見する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドル銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エリー銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eトレード</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フロストバンク</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハリファックス英国</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンコック銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンティントン銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M＆T銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センテニアルバンク</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PNC</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RBC</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャールズ・シュワブ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サントラスト銀行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">滑膜</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニオンバンク（unionbank.com）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">米国銀行</font></font></li>
</ul></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、最も興味深い-トロイの木馬の研究に移りましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拡大</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このトロイの木馬は世界中の情報のないコミュニティによって非常に積極的に監視されていることは注目に値します。そのため、Twitterに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#IcedIDタグ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">#BokBotタグ</font></b><font style="vertical-align: inherit;">を使用して検索</font><font style="vertical-align: inherit;">すると、最後の銀行ニュースレターがいつどのように送信されたかに関する膨大な数のレコードが見つかります。</font><font style="vertical-align: inherit;">おそらく、デバイスへの感染という点で最近トロイの木馬で起こった最も興味深いことは、以前のバージョンと同様に、古いバージョンが内部に隠された画像をロードするブートローダーの新しいステージの出現です-第2ステージのブートローダー。</font><font style="vertical-align: inherit;">新しいブートローダーはすでに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">説明されて</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">いる</font></a><font style="vertical-align: inherit;">ため、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a><font style="vertical-align: inherit;">では繰り返さず、感染スキームの説明を単純化します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪意のあるドキュメントが被害者のデバイスに侵入します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントが読み込まれ、ローダーの最初のステージが開始されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のステージローダーはCnCから画像をダウンロードし、そこから2番目のステージローダーを抽出して保存し、起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2段階のローダーは、同様にCnC（アドレスは異なる場合があります）から画像をダウンロードし、メインのIcedIDモジュールを取得して起動します。</font><font style="vertical-align: inherit;">この部分については、後で詳しく説明します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">質問はもう残っていないと思いますので、第2段階に移りましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンローダー/ローダー-第2段階のブートローダー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このブートローダーの主なタスクは、メインモジュールを取得して実行することです。 2番目のステージは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">または</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">として表すことができます</font><font style="vertical-align: inherit;">が、2つのバージョンの間に機能的な違いはありません。したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルの</font><font style="vertical-align: inherit;">例を使用して、メインモジュールの取得と起動を見てみましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローダーはエクスポートされた関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DllRegisterServer（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を含むDLLファイルであり</font><font style="vertical-align: inherit;">、完了のフラグが立てられるまで1秒間</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sleep（）に</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">循環</font></b><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">ます。後で見るように、新しいバージョンのブートローダーは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regsvr32.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスのコンテキストで起動され、</font><font style="vertical-align: inherit;">このエクスポートされた関数は正しく実行するために必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての楽しみは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DllEntryPoint（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数で発生します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ローダー自体は、次のアクションを実行するかなり小さなアプリケーションです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedIDカーネルを含むイメージファイルにアクセスします。</font><font style="vertical-align: inherit;">当然、感染したマシンで初めて起動したときには、そのようなイメージはないので、先に進んでください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CnCアドレスにアクセスし（リストは暗号化された形式でブートローダーの本体に保存されます）、負荷を受け取ります。</font><font style="vertical-align: inherit;">クエリは次のように</font></font><br>
<img align="left" src="https://habrastorage.org/webt/cr/_x/-o/cr_x-ojtdfdgpckvu6jfc7-hbuw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なります。値を簡単に説明します。</font></font><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハードコードされた値。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BE0F1DE5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もハードコードされた値であり、その後IcedIDカーネルに渡されます。</font><font style="vertical-align: inherit;">次に、これをブートローダー識別子と呼びます。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0272A7E4-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイムスタンプ。</font></font></li>
<li><b>00000000000040000010</b> —    +    . ,      ,      ,     IcedID .</li>
</ul> <br>
    ,   shell-  .<br>
</li>
<li>  (     ).<br>
</li>
<li>   (   ,     ).     , shell-   IcedID.        (    8,    )  shell-     .<br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェルコードは、</font><font style="vertical-align: inherit;">一時停止モードで関数を使用し</font><font style="vertical-align: inherit;">て</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchost.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスを開始します</font><font style="vertical-align: inherit;">（調査された一部のサンプルでは、​​プロセスは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msiexec.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などで異なり</font><font style="vertical-align: inherit;">ます）。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtAllocateVirtualMemory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwWriteVirtualMemory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtProtectVirtualMemory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtQueueApcThread</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自身を新しいプロセスに挿入して起動します。</font><font style="vertical-align: inherit;">ここではすべてが明確で、詳細にペイントする必要はないと思います。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchost.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のコンテキスト内のシェルコード</font><font style="vertical-align: inherit;">はIcedIDコアをデプロイし、制御をそれに転送します。</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複雑そうです。</font><font style="vertical-align: inherit;">それでは描きましょう：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/bf/s-/robfs-29ldiaa6ngcsw4akfcwy0.jpeg"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedIDデバイスの感染スキーム</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
が明確になることを願っています。</font><font style="vertical-align: inherit;">次に、最も興味深い-トロイの木馬の説明に移ります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedIDコア</font></font><br>
</h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起動前の準備</font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トロイの木馬の動作の説明を始める前に、トロイの木馬が文字列、変数、ファイル、その他のデータを格納する形式を教えておく価値があります。</font><font style="vertical-align: inherit;">これで記事が読みやすくなると思います。</font><font style="vertical-align: inherit;">読者がこの部分に興味がない場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起動後すぐに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のセクション</font><b><font style="vertical-align: inherit;">に</font></b><font style="vertical-align: inherit;">進むことをお勧めし</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは始めましょう。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BotIdの生成</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、この変数はファイル名、ミューテックス、レジストリキーなどを生成するためのほとんどすべてのアルゴリズムで使用されるため、BotIdはトロイの木馬を生成します。</font><font style="vertical-align: inherit;">古いバージョンとは異なり、新しいバージョンのIcedIdは、よく知られている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fnv32</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュアルゴリズムを使用して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">BotId</font></a><font style="vertical-align: inherit;">を生成し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">BotIdは、ユーザーのSIDの文字列表現からのハッシュ値です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライン生成</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のバージョンとは異なり、新しいバージョンでは、カウンターの内部状態を備えた古典的なランダム関数C ++を使用します。</font><font style="vertical-align: inherit;">つまり、同じラインを生成するには、同じ値でカウンターを初期化するだけで十分です。</font><font style="vertical-align: inherit;">最初から最初まで同じ文字列（たとえば、ディレクトリ名、構成ファイル、レジストリキーなど）を生成するために、IcedIDは初期化値としてBotIdを使用します。</font><font style="vertical-align: inherit;">文字列の再利用が計画されていない場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdtsc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令の結果が初期化値として使用されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">文字列を生成するアルゴリズムを詳細に検討することはそれほど興味深いことではないと思います。</font><font style="vertical-align: inherit;">重要なポイントを強調します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成された文字列は、GUIDの形式または「クラシック」形式のいずれかになります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「クラシック」ラインを生成するために使用されます：</font></font><br>
<ul>
<li> : <b>aeiou</b>  <b>bcdfghjklmnpqrstvwxyz</b>,          ( ,      ,      —   ).</li>
<li>        <b>abcedfikmnopsutw</b>,        ,     ,    .   ,      .</li>
<li>         : 1, 2, 3, 4, 32, 64.</li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感染したユーザーの名前を使用して、ディレクトリパスを生成できます。</font><font style="vertical-align: inherit;">同時に、1つではなく2つサブディレクトリを作成して、IcedIDの観点から興味深いファイルを保存できます。</font></font></li>
</ol><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列の暗号化</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IcedIdの操作に重要な文字列（ログ行、関数パラメーター行など）は、カスタムアルゴリズムで暗号化されます。</font><font style="vertical-align: inherit;">次のPythonスクリプトを使用すると、非常に簡単に解読できます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_string</span>(<span class="hljs-params">ciphertext</span>):</span>
	current_key = struct.unpack(<span class="hljs-string">'I'</span>, ciphertext[:<span class="hljs-number">4</span>])[<span class="hljs-number">0</span>]<font></font>
	length = (struct.unpack(<span class="hljs-string">'H'</span>, ciphertext[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>])[<span class="hljs-number">0</span>] ^ current_key) &amp; <span class="hljs-number">0xFFFF</span>
	ciphertext = ciphertext[<span class="hljs-number">6</span>:]<font></font>
	plaintext = <span class="hljs-string">''</span><font></font>
    <font></font>
	<span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(length):<font></font>
    		current_key = (index + ((current_key &lt;&lt; <span class="hljs-number">25</span>) | (current_key &gt;&gt; <span class="hljs-number">7</span>))) &amp; <span class="hljs-number">0xFFFFFFFF</span>
    		plaintext = <span class="hljs-string">'{}{}'</span>.format(plaintext, chr((current_key ^ ord(ciphertext[index])) &amp; <span class="hljs-number">0xFF</span>))<font></font>
    <font></font>
	<span class="hljs-keyword">return</span> plaintext</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シフトの値は、トロイの木馬のバージョンによって異なる場合があることに注意することが重要です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックサムの計算</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアルゴリズムは、構成データの整合性を検証するため、およびSSLピニングを実装するために使用されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sq/g0/hx/sqg0hx6ojkafycdgyvgkqr28yzq.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバル変数の保存</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部の変数は、最初から最後まで値を保存する必要があり、トロイの木馬によってレジストリに保存されます。</font><font style="vertical-align: inherit;">各変数は文字列値（変数の名前）に対応しています。</font><font style="vertical-align: inherit;">このような変数の読み取りは、4つの段階で行われます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数の代わりにカスタムハッシュ値が考慮されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sp/rz/o7/sprzo7fwm9kawquzdcnsbdfa9b8.png"></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinApiを使用して、MD5値が変数とそのハッシュ値に代わって計算されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/p6/ao/6a/p6ao6ap553mxzfw_ieytkcsri2i.png"></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリ内の変数へのパスが生成されます：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HKEY_CURRENT_USER \ Software \ Classes \ CLSID \ {％GUID％}</font></font><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ここで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">％GUID％</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はGUID形式の上記のMD5値であり、その値を読み取ります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のアルゴリズムを使用して復号化されます：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/9b/vk/bi9bvkdtkmvrzduobgposbnsgna.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">customRandom</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">custom_random</span>(<span class="hljs-params">seed</span>):</span>
	<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):<font></font>
    		seed = ror(seed)<font></font>
	seed ^= <span class="hljs-number">0x9257</span>
	<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>):<font></font>
    		seed = rol(seed)<font></font>
	seed = (seed + <span class="hljs-number">0x29B6</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><font></font>
	seed = ror(seed)<font></font>
	seed = (seed + <span class="hljs-number">0xF411</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span><font></font>
	seed = rol(seed)<font></font>
	seed = (seed - <span class="hljs-number">0x8668</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span>
	seed = seed ^ <span class="hljs-number">0xFFFFFFFF</span>
	seed = (seed - <span class="hljs-number">0x8260</span>) &amp; <span class="hljs-number">0xFFFFFFFF</span>
	<span class="hljs-keyword">return</span> seed</code></pre> </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読んだ場合</font><font style="vertical-align: inherit;">、変更点がほとんどないことに気づいたでしょう。</font><font style="vertical-align: inherit;">実際には、ボット変数は逆の順序で保存されます。最初に暗号化、次に記録します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、調査中に次の変数が見つかりました。</font></font><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#lf-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログフィルター</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#ke-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エッジを殺す</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#dr-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">署名付きのURLリスト</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#dm</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -URLリスト、署名なし</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要な注意：配布管理システムのコマンドで、グローバル変数の値を追加/削除できます。</font><font style="vertical-align: inherit;">これは、CnCサーバーのリストが更新される方法です。</font><font style="vertical-align: inherit;">CnCと言えば。</font><font style="vertical-align: inherit;">グローバル変数（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#dr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">読み取って復号化した後</font><font style="vertical-align: inherit;">も、トロイの木馬は署名を検証します。</font><font style="vertical-align: inherit;">そしてはい、トロイの木馬には組み込みの公開鍵があります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_v/q5/li/_vq5linsuxjdch3op4t-bw8pfi8.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成データの保存</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IcedIDは、構成データを個別の暗号化ファイルに保存します。</font><font style="vertical-align: inherit;">ファイル名の生成と、それらが保存されるディレクトリについては、上記で説明しています。</font><font style="vertical-align: inherit;">新しいバージョンのトロイの木馬の主な特徴は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.png</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font><font style="vertical-align: inherit;">内の設定の保存です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">はい、はい。これで、ステガノグラフィーの助けを借りてメインモジュールが非表示になるだけでなく、構成ファイルも非表示になります。</font><font style="vertical-align: inherit;">画像のペイロードストレージ形式を詳しく見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各画像には、そのような構造のオブジェクトが含まれています。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">StegData</span>
{</span>
	<span class="hljs-keyword">int</span> ciphertextLen;
	<span class="hljs-keyword">int</span> magic;
	<span class="hljs-keyword">int</span> plaintextChecksum;<font></font>
	byte keyLen;<font></font>
	<span class="hljs-keyword">char</span>[keyLen] key;
	<span class="hljs-keyword">char</span>[ciphertextLen];<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてここに例があります：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/o2/cq/ou/o2cqouko6n7cwjgfy6jt_v-isoa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗号化アルゴリズムはRC4です。</font><font style="vertical-align: inherit;">場合によっては（たとえば、構成ファイル）、イメージにキーが含まれていない場合、BotIdがキーとして機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、設定ファイルに関するいくつかの言葉：解読後、あなたは以下を観察することができます：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/uw/wb/lo/uwwbloaqulwk-b0cncjvmlq_a3g.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zeus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マジックストリング</font><font style="vertical-align: inherit;">が残っています。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロギング</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常によく書かれたプログラムであっても、銀行家はもちろんのこと、問題が発生します。</font><font style="vertical-align: inherit;">開発者はこれを理解したため、ほとんどすべてのステップでロギングを追加しました。</font><font style="vertical-align: inherit;">デフォルトではオフになっ</font><font style="vertical-align: inherit;">ていますが、サーバーのコマンドで変更できる</font><font style="vertical-align: inherit;">グローバル変数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#lf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があります。</font><font style="vertical-align: inherit;">ログフィルターは整数変数であり、最初の3ビットはログに記録する必要があるイベントのタイプを担当します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[情報]</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[警告]</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[エラー]</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、変数は、イベントをログに記録する価値があるモジュールをトロイの木馬に伝えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロギングはメモリの別のセクションで実行され、コマンドに応じてサーバーにアップロードすることもできます。</font><font style="vertical-align: inherit;">さらに、ログ行を分析するとき、それらは私たちを二度以上助けてくれます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発売直後</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、トロイの木馬はBotIDを生成し、感染したマシンに関する情報を収集します。その後、この情報は管理サーバーに渡されます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">予測したように</font><font style="vertical-align: inherit;">、メインモジュールは次の2つの方法で仮想マシンの起動もチェックします。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdtsc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令を使用して</font><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpuid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実験の純粋性</font><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SwitchToThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に対して</font><font style="vertical-align: inherit;">）15回、コード実行時間を測定します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセッサのベンダーIDの最初の4文字を次の値と比較します。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VMwa</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xenv</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイク</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVMK</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lrp</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vbox</font></font></li>
</ul></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いメモ：仮想マシンでの起動の確認は、BCモジュール（後で説明します）の起動にのみ影響しますが、モジュールは起動しませんが、システムがタイミングチェックに合格しなかった場合のみ、VendorID値は無視されます。おそらく、この機能は引き続きテストされており、感染したマシンでトロイの木馬を阻止するとともに、将来的には理想的なものになるでしょう。現時点では、チェックはかなり弱く、プログラムにはほとんど影響しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BotIdとシステムに関する情報を使用して、トロイの木馬はそれ自体が暗い力の目覚めを感じ、これから後世のために保存する必要があるストーリーが作成されることを理解します。ご理解のとおり、この段階からボットはそのアクションのロギングを開始します。しかし、最初の行をクリーンなメモリに書き込む前に、トロイの木馬はグローバル変数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#lfの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値を取得しようとします</font><font style="vertical-align: inherit;">。たとえば、最初のメッセージ：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[00:11:40] 2252 | [情報] bot.init&gt; core init ver = 20 pid = 1234 id = 456 ldr_ver = 3</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者によると、ブートローダーのバージョンは4、カーネルのバージョンは21であることがわかります。次は、トロイの木馬がマシン上で再起動しないようにする標準のスキームです。ミューテックスが作成されます（ミューテックス名の文字列の生成については上記で説明しました）。 mutexがすでに作成されている場合、バンカーはシャットダウンします。繰り返しになりますが、小さなメモ：mutexを作成する前に、アプリケーションは別の名前のイベントにアクセスします。これは、トロイの木馬のブートローダーが更新されたときに作成されます。そして、このイベントのおかげで、新しいIcedIDプロセスは古いプロセスの完了を待ってから、ダーティな作業を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、汚れたビジネスは、感染したデバイスでのトロイの木馬の永続性を確保することから始まります。アプリケーションは最初にファイル名を確認します。</font><b><font style="vertical-align: inherit;">ライン生成</font></b><font style="vertical-align: inherit;">アイテムをスキップしていない方</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前のセクションでは、おそらく</font><font style="vertical-align: inherit;">前の部分文字列に基づいて生成されるインデックスで</font><font style="vertical-align: inherit;">あるアルファベット</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abcedfikmnopsutw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から2文字を追加するステップの1つをハイライトしたことを覚えているでしょう</font><font style="vertical-align: inherit;">。実際には、トロイの木馬はインデックスを再生成し、ファイル名の最後の2文字をテンプレート値と比較します。ファイルが検証に合格した場合、それ以上のアクションは不要です。これがトロイの木馬の最初の起動である場合、アプリケーションは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">％APPDATA％</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">％LOCALAPPDATA％</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">ディレクトリ（またはBotIDに応じて2つ）を</font><font style="vertical-align: inherit;">作成し、そこにブートローダーファイルをコピーし、古いファイルを削除してから、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ITaskService</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> COMインターフェイスを使用して新しいタスクを追加します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gb/3y/bz/gb3ybzqfi0_5bju0s4pgvhx6j20.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクを作成できなかった場合、アプリケーションは、古い方法でレジストリを介して自動起動するように自身を規定します。</font><font style="vertical-align: inherit;">レジストリ値の名前は、タスクの名前と同じです。</font><font style="vertical-align: inherit;">つまり、この場合：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリキー：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HKEY_CURRENT_USER \ Software \ Microsoft \ Windows \ CurrentVersion \ Run</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meayjiduge_ {94D3BBC9-24EA-411F-066A-A604B94A99DA}</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容：ブートローダーへのパス</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要な注意：IcedIDブートローダーは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">だけ</font><font style="vertical-align: inherit;">でなく、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.dllにすること</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もでき</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このような場合、</font><font style="vertical-align: inherit;">それぞれ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regsvr32.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介して開始</font><font style="vertical-align: inherit;">され、次のパスがタスク（レジストリ）に書き込まれます</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。regsvr32.exe / s“ C：\ Users \ &lt;％Username％&gt; \ AppData \ Local \ lepuan \ odnu \ olniyueu3.dll "</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
システムに自分自身をインストールすると、アプリケーションはCnCサーバーのリストを初期化します。</font><font style="vertical-align: inherit;">これは2つの段階で発生します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローダーによって渡されたパラメーターに基づくリストの初期化</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバル変数のリストの初期化</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2点目についてもう少し詳しく説明する必要があると思います。</font><font style="vertical-align: inherit;">2つのグローバル変数があります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃dm-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">署名なしの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CnC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーのリストを保存し、</font><b><font style="vertical-align: inherit;">＃dr</font></b><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">CnC</font></b><font style="vertical-align: inherit;">サーバーの署名済みリストを保存します。</font><font style="vertical-align: inherit;">変数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#dmは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション</font><b><font style="vertical-align: inherit;">で</font></b><font style="vertical-align: inherit;">使用されます。</font><font style="vertical-align: inherit;">この機能は純粋にテスト用のようです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CnCサーバーのリストに加えて、アプリケーションは構成ファイルをダウンロードします。これは現在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.png</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像に</font><font style="vertical-align: inherit;">隠されてい</font><font style="vertical-align: inherit;">ます（つまり、開発者は従来の暗号化をステガノグラフィー+暗号化に置き換えました）。</font><font style="vertical-align: inherit;">IcedIDには、プロキシサーバー（後で詳しく説明します）がMITMを攻撃するために使用する2つの構成ファイルがあります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メイン</font></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Webインジェクトの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リストが含まれています（最初の記事では、このリストは</font><b><font style="vertical-align: inherit;">cfg0</font></b><font style="vertical-align: inherit;">と呼ばれてい</font><b><font style="vertical-align: inherit;">ました</font></b><font style="vertical-align: inherit;">）</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SYS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -グラブが含まれており、無視リスト（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CFG1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、トロイの木馬の操作の準備は完全に完了しています</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。Kraken</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><s><font style="vertical-align: inherit;">リリース</font></s><font style="vertical-align: inherit;">して、3つの主要なプログラムフローを起動</font><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">（以下、便宜上、モジュールと呼びます）。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生きている</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フッカー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">紀元前</font></font></li>
</ul><br>
<div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/ca/9q/nd/ca9qnd4iva_u1pn4wvppkyrkhvm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前述のように、環境がタイミングチェック（VM検出方法）に合格しなかった場合、BCモジュールは起動しません。</font><font style="vertical-align: inherit;">以下、各フローモジュールについて詳しく説明します。</font><font style="vertical-align: inherit;">さて、これで、トロイの木馬を初期化するプロセスが完了し、メインスレッドは無限の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sleep（）になり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生きているモジュール</font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このモジュールは、サーバーが定期的に「タップ」して理解できるように設計されています。ボットはまだ生きていて、コマンドを受信する準備ができています。開始する前に、ボットは1分間「スリープ状態」になり、その後サーバーにアクセスする無限のサイクルに入ります。サーバーは5分に1回アクセスされます（ただし、この値はサーバーのコマンドで変更できます）。では、クエリはどのように見えますか？例から始めましょう：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / audio /？Z == HTTP / 1.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続：キープアライブ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホスト：&lt;％CnC％&gt;</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
リクエストからわかるように、最も興味深いものはすべてBase64エンコードデータに格納されています。デコード後、興味深い行が得られます：</font></font><br>
<img align="left" src="https://habrastorage.org/webt/2q/_z/oq/2q_zoqgxjehxy0kwijmvnojuksw.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、トロイの木馬が管理サーバーに送信する情報です。</font><font style="vertical-align: inherit;">例からわかるように、文字列値（すべてUNICODE）はURLエンコードされています。</font><font style="vertical-align: inherit;">最初のタップ時にのみ送信される青色の強調表示されたデータ-登録データ。</font><font style="vertical-align: inherit;">黒-すべてのリクエストに存在するデータ。</font><font style="vertical-align: inherit;">赤-トロイの木馬が対応する変数の値を取得できた場合にのみ、オプションのデータがリクエストに含まれます。</font><font style="vertical-align: inherit;">変数と言えば、それらの意味は次のとおりです。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダーID</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボットID</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedIDメインモジュールバージョン</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインモジュールがローダーから受け取る整数値</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストのタイプ：1-登録、0-通常のリクエスト</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブタイプをリクエスト</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストフラグ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークデバイスのMACアドレス。</font><font style="vertical-align: inherit;">このようなエントリの数は、ネットワークデバイスの数によって異なります。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メートル</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この例のコンピューター名は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestComputernameです。</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></td>
<td> ,    ,    — <b>TestDomainname</b></td>
</tr>
<tr>
<td>k</td>
<td> </td>
</tr>
<tr>
<td>n</td>
<td> ,       </td>
</tr>
<tr>
<td>o</td>
<td>  </td>
</tr>
<tr>
<td>l</td>
<td> ,    — <b>TestUsername</b></td>
</tr>
<tr>
<td>w</td>
<td> ,    SID' </td>
</tr>
<tr>
<td>q</td>
<td> </td>
</tr>
<tr>
<td>u</td>
<td> </td>
</tr>
<tr>
<td>r</td>
<td>  <b>Sys</b>-</td>
</tr>
<tr>
<td>s</td>
<td>  <b>Main</b>-</td>
</tr>
<tr>
<td>t</td>
<td>  CnC-</td>
</tr>
<tr>
<td>h</td>
<td> ,          <b>pgid</b>.  ,          .<br>
</td>
</tr>
<tr>
<td>i</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションがローダーから受け取り、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてマークする文字列値</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">残念ながら、トロイの木馬のいくつかのバージョンの調査中に、価値を得ることができませんでした。</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダーファイルを開いたとき</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetLastError</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の値</font><font style="vertical-align: inherit;">。</font></font><br>
</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
応答として、サーバーは</font><font style="vertical-align: inherit;">、文字で区切られた</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドとパラメーター</font><font style="vertical-align: inherit;">を含むパケットを送信します</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コマンドを処理する前に、アプリケーションは応答で次の部分文字列を検索し、対応する値に置き換えます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃gid＃</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -メインモジュールがローダーから受け取る文字列値</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃pgid＃</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -メインモジュールがローダーから受け取る文字列値</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃id＃</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ボットID</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃pid＃</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ブートローダーID</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃ドメイン＃</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -CnC</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フロント：//</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">httpsで</font></b><font style="vertical-align: inherit;">置換</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：// &lt;％CnC％&gt;</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、ここで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">について簡単に説明しましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チーム</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取るべき行動</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップデートパック</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインのIcedIDモジュールが非表示になっている画像を更新します。</font><font style="vertical-align: inherit;">ダウンロードが成功すると、アプリケーションは新しいブートローダープロセスを開始し、現在のプロセスの作業が停止します。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローダーの更新</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダーを更新します。</font><font style="vertical-align: inherit;">永続性のロードと設定が正常に完了すると、アプリケーションは新しいブートローダープロセスを開始し、現在のプロセスの作業が停止します。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLリストを更新</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CnCリストを更新します。</font><font style="vertical-align: inherit;">署名をチェックした後、アプリケーションはcnCリストを暗号化し、グローバル変数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#drに保存し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム構成を更新</font></font></td>
<td> -,   grab (<b>cfg1</b>).        .</td>
</tr>
<tr>
<td>5</td>
<td>update main config</td>
<td> -,   web- (<b>cfg0</b>).        .</td>
</tr>
<tr>
<td>6</td>
<td>alive force</td>
<td> alive- .      .</td>
</tr>
<tr>
<td>7</td>
<td>set alive timeout</td>
<td>    .     .</td>
</tr>
<tr>
<td>8</td>
<td>get log</td>
<td>   -.</td>
</tr>
<tr>
<td>9</td>
<td>set log filter</td>
<td>  -.    ,     <b>#lf</b>    .</td>
</tr>
<tr>
<td>10</td>
<td>var set</td>
<td>   .        .</td>
</tr>
<tr>
<td>11</td>
<td>var get</td>
<td>   .      .</td>
</tr>
<tr>
<td>12</td>
<td>var del</td>
<td>  .      .</td>
</tr>
<tr>
<td>13</td>
<td>get process list</td>
<td>     .</td>
</tr>
<tr>
<td>14</td>
<td>desk link</td>
<td>     ,  <b>.lnk</b>-     ,   .   <b>.lnk</b>-   COM- <b>IShellLinkA</b>.</td>
</tr>
<tr>
<td>15</td>
<td>sysinfo</td>
<td>        .</td>
</tr>
<tr>
<td>16</td>
<td>exec</td>
<td> ,        .</td>
</tr>
<tr>
<td>17</td>
<td>dlexec</td>
<td>   .          .      <b>%TEMP%</b>,   <b>c:\ProgramData\</b>.</td>
</tr>
<tr>
<td>18</td>
<td>run cli</td>
<td> ,      .</td>
</tr>
<tr>
<td>19</td>
<td>run shellcode</td>
<td> shell-,      <b>cmd.exe</b>  .</td>
</tr>
<tr>
<td>20</td>
<td>reboot</td>
<td> .</td>
</tr>
<tr>
<td>21</td>
<td>file search</td>
<td>      (  )    .</td>
</tr>
<tr>
<td>22</td>
<td>file get</td>
<td>    .      .</td>
</tr>
<tr>
<td>23</td>
<td>dump pass</td>
<td>    Credential Manager, Outlook, Internet Explorer, Winmail, Google Chrome, Firefox     .</td>
</tr>
<tr>
<td>24</td>
<td>dump cookie</td>
<td> cookie-     .</td>
</tr>
<tr>
<td>25</td>
<td>DlExecAdmin</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dlexec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">同様に</font><font style="vertical-align: inherit;">、アプリケーションはUACをバイパスして起動されます。</font><font style="vertical-align: inherit;">IcedIDに十分な権限がない場合、起動は通常のユーザーに代わって実行されます。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26日</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCを実行</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCモジュールを実行します。</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より詳細にいくつかのコマンドを書きましょう：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">update-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド。</font><font style="vertical-align: inherit;">パラメータとして、イメージをダウンロードするアドレスが入ります。</font><font style="vertical-align: inherit;">画像にはRC4で暗号化されたペイロードが含まれています。</font></font></li>
<li><b>sysinfo</b> —      ,        :<br>
<br>
<b> – cmd /c chcp<br>
 – WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get * /Format:List<br>
 – ipconfig /all<br>
 – systeminfo<br>
 – net config workstation<br>
 – nltest /domain_trusts<br>
 – nltest /domain_trusts /all_trusts<br>
 – net view /all /domain<br>
 – net view /all</b><br>
</li>
<li><b>DlExecAdmin</b> —  UAC    :<br>
<ol>
<li>  <b>fodhelper.exe</b>.        <b>HKCU\Software\Classes\ms-settings\Shell\Open\command</b>,    : <ul>
<li><b>DelegateExecute</b> — </li>
<li><b>(default)</b> —     ,   </li>
</ul><br>
    <b>fodhelper.exe</b>,       UAC   .</li>
<li>  <b>eventvwr.exe</b>.        <b>HKCU\Software\Classes\mscfile\shell\open\command</b>,        -,    <b>eventvwr.exe</b>.</li>
</ol></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、最後に気付いた興味深い機能の1つについてお話ししたいと思います。トロイの木馬の作成者は、かなり興味深いSSLピニングメソッドを開発しました。接続を確立する前に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinHttpSetStatusCallback（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用するアプリケーション</font><font style="vertical-align: inherit;">が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WINHTTP_CALLBACK_STATUS_REQUEST_SENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントのハンドラーを</font><b><font style="vertical-align: inherit;">設定し</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">（データはサーバーに正常に送信されました） ）および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WINHTTP_CALLBACK_STATUS_SENDING_REQUEST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（サーバーにデータを送信する前にトリガーされます）が、処理関数自体は</font><b><font style="vertical-align: inherit;">WINHTTP_CALLBACK_STATUS_SENDING_REQUEST</font></b><font style="vertical-align: inherit;">を除くすべてのイベントを無視します</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">イベントがトリガーされると、アプリケーションはリクエストからサーバー証明書のデータを「プル」し、サーバーの公開鍵からのチェックサムを考慮して、結果の値を証明書のシリアル番号と比較します。</font><font style="vertical-align: inherit;">一致する場合、アプリケーションはサーバーが代替サーバーではないことを認識し、それ以外の場合は接続を閉じます。</font><font style="vertical-align: inherit;">まあ、関数自体は次のようになります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2g/jb/qy/2gjbqyqxfyood-9t9hywetrtdfc.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フッカーモジュール</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IcedIDは、自尊心のある現代の銀行家と同様に、MITM攻撃を実行できます。</font><font style="vertical-align: inherit;">フッカーモジュールがこれを担当し、その操作は3つの主要な部分に分けることができます。</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自己署名証明書の生成</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシサーバーを「上げる」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネイティブモジュールをブラウザーコンテキストに挿入する</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、各部分の詳細。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自己署名証明書の生成</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご存知のように、銀行家にとって最もおいしいデータはすべてHTTPS経由で送信されるようになりました。すべてがSSLによって閉じられているため、被害者のブラウザと銀行のサーバーなどの間のトラフィックを単に聞くだけではそのようなデータを取得することはできません。しかし、開発者たちは、このような興味深い状況から抜け出す方法を見つけました。彼らは証明書を入れました。しかし、それを置くために、最初にそれを生成する必要があります。特に証明書を生成する場合、IcedIdには次の行があります</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。C= US; O = VeriSign、Inc ;; OU = VeriSign Trust Network; OU =©2006 VeriSign、Inc. -許可された使用のみ。 CN =ベリサインクラス3公共プライマリ認証局- G5の</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ようなもの？もちろん、それは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">証明書のサブジェクトです</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！証明書に署名するには、公開鍵と秘密鍵のペアが必要です。これは、CryptoAPI関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptGenKey（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して生成され</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5（&lt;％BotId％&gt; &lt;％Certificate Subject％&gt;）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がキーコンテナー名として使用されます</font><font style="vertical-align: inherit;">。さて、証明書自体は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertCreateSelfSignCertificate（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">を使用して、SHA1とRSA duoを使用して作成されます。これは、以前に作成されたキーペアと発行元に関する情報です。証明書は、1年前から2年前までの3年間作成されます。何らかの理由で証明書を生成できなかった場合、トロイの木馬はそのような場合のための計画Bを持っています。事前に準備され、本文で暗号化された証明書と、失敗した証明書の代わりにロードして使用する鍵です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで全部だと思った？しかし、違います。生成された自己署名証明書は、トロイの木馬が2番目の証明書に署名するためにのみ必要です。これは、すでにMITM攻撃に使用されています。文字列は発行元に関する情報です</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。CN= .com</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
証明書（コンテナーの名前を含む）を生成する手順は、ルート証明書を生成する手順と似ています（ただし、以前に生成/インポートされた証明書のキーで証明書が署名されている点が異なります）。また、問題が再び発生した場合は、以前に準備され、トロイの木馬の本体に保存されていたキーと証明書（以前は暗号化された形式で保存されていた）も読み込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、トロイの木馬がファイル</font><b><font style="vertical-align: inherit;">％TEMP％/ &lt;％BotId％&gt;。Tmpに</font></b><font style="vertical-align: inherit;">証明書ストアを作成することに注意することも重要です</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そこに証明書を置きます。</font><font style="vertical-align: inherit;">したがって、次回の起動時に、トロイの木馬は証明書を再度生成/インポートする必要はありません。</font><font style="vertical-align: inherit;">それは店からそれを得るのに十分です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの起動</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
証明書を生成した後、アプリケーションはポート</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;％BotId％&gt;％14000-15536​​で</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リッスンを開始</font><font style="vertical-align: inherit;">し、Main-およびSys-configsに応じて、暗いことを行います。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回の記事では</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、トラフィックを処理し、さらにはホバーのconfigsそのPythonスクリプトへのリンクを提供する方法を詳細に説明しました。</font><font style="vertical-align: inherit;">この部分で大きな変化は見られなかったので、ここで繰り返す意味はないと思います。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザパッチ</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、トロイの木馬は独自の証明書でサーバーを持ち上げました。</font><font style="vertical-align: inherit;">他に何が残っていますか？</font><font style="vertical-align: inherit;">ああそう：ブラウザにすべてのリクエストをこのプロキシサーバーにリダイレクトさせ、生成された証明書を「信じさせる」。</font><font style="vertical-align: inherit;">これを行うには、1秒間隔で無限ループにあるIcedIDが、実行中のアプリケーションのリストを実行し、ランク内のブラウザーを探します。</font><font style="vertical-align: inherit;">検索は、プロセスに代わってチェックサムによって実行されます。これは、次のように計算されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ix/ef/ry/ixefry29a991vdkzfxsjionwib0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ハードコートされた値と比較します：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x9EFDE0C4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -firefox.exe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x9F96A0E0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -microsoftedgecp.exe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x534B083E</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -iexplore.exe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x7A257A14</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -chrome.exe</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
概して、チェックサム計算アルゴリズムはバンカーの異なるバージョンで変更されません</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でした</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">、定数</font><b><font style="vertical-align: inherit;">0x801128AF</font></b><font style="vertical-align: inherit;">は異なっていたため、他のバージョンのトロイの木馬では、プロセス名のチェックサムが異なります。</font><font style="vertical-align: inherit;">チェックサムの比較に加えて、IcedIDはプロセス名を文字ごとに比較します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/p3/mi/ii/p3miiito-_zwdheblppgusaqx3i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前で一致が見つかった場合、トロイの木馬は独自のコードをブラウザのコンテキストに挿入します。</font><font style="vertical-align: inherit;">Microsoft Edgeを除くすべて。</font><font style="vertical-align: inherit;">さらに、グローバル変数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#keが</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感染したデバイス</font><font style="vertical-align: inherit;">に存在する場合、ボットは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">microsoftedgecp.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスを強制終了します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">開発者はこのブラウザに感染する方法を理解していないようです。</font><font style="vertical-align: inherit;">または、彼らは彼を好きではありません。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ew/w9/1f/eww91fimorga66_fzfoieepcjmq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブラウザパッチの前に、アプリケーションは以前に感染していたかどうかを確認します。アプリケーションには、感染したPIDのリストがあります。さらに、感染後、ブラウザプロセスに挿入されたIcedIDモジュールのコードは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;％generated_eventname％&gt; _ &lt;％browser_pid％&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という名前のイベントを作成します</font><font style="vertical-align: inherit;">。この名前のイベントが作成されない場合、プロセスは感染していません。修正する必要があります！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今は少し面倒です。メインのIcedIDモジュールには、興味深いトロイの木馬機能へのフックを設定する実行可能ファイルが本体に含まれています。彼を</font><b><font style="vertical-align: inherit;">売春婦</font></b><font style="vertical-align: inherit;">と呼ぼう</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ただし、メインファイルと同様に、このファイルは独自の形式でトロイの木馬の本体に保存され、PEヘッダーはありません。エントリーポイント、セクションなどの情報カスタムヘッダーにあります。ブラウザプロセスに感染する前に、トロイの木馬は自身のプロセスでセクションを「展開」し、その後、ブラウザコンテキストに2つのメモリを割り当てます。最初は、おそらくご</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">想像のとおり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すでにデプロイされた</font><b><font style="vertical-align: inherit;">フッカー</font></b><font style="vertical-align: inherit;">がコピーされ</font><font style="vertical-align: inherit;">ます。インターセプター（プロキシポートを含む）の起動に必要な引数は、2番目のセクションにコピーされます。その後、ブラウザコンテキストで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用して</font><font style="vertical-align: inherit;">悪意のあるスレッドが作成され</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここから楽しみが始まります。ブラウザ</font><b><font style="vertical-align: inherit;">フッカーの</font></b><font style="vertical-align: inherit;">コンテキストで</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、独自のインポート（それがない場合）を修正してから、前述のイベント</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;％generated_eventname％&gt; _ &lt;％browser_pid％&gt;を作成し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connect（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の例を使用して、フックのインストールプロセスを図で示す方がよいと思います</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gv/ve/ne/gvvenez7mq3dqbl-js-4terpsbu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例からわかるように、アプリケーションは、独自のハンドラーのインターセプトされた関数の先頭にjmp命令をインストールするだけです（笑）。</font><font style="vertical-align: inherit;">ブラウザに応じて、悪意のあるモジュールはさまざまな機能にフックをかけます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chrome.exe：</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertGetCertificateChain</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertVerifyCertificateChainPolicy</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続する</font></font></li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iexplore.exe：</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertGetCertificateChain</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertVerifyCertificateChainPolicy</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mswsock.dllライブラリの関数</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続する</font></font></li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firefox.exe：</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSL_AuthCertificateHookまたはSSL3.dllライブラリの関数</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続する</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
証明書とSSLを使用する機能のフックは、自己署名を含むすべての証明書をブラウザに受け入れさせるという唯一の目的で設定されています。</font><font style="vertical-align: inherit;">たとえば、</font><b><font style="vertical-align: inherit;">SSL_AuthCertificateHook（）</font></b><font style="vertical-align: inherit;">関数が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firefox.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のコンテキストで</font><font style="vertical-align: inherit;">呼び出されると</font><font style="vertical-align: inherit;">、証明書検証関数を独自のものに変更するように設計されており、</font><b><font style="vertical-align: inherit;">フッカー</font></b><font style="vertical-align: inherit;">は2番目の引数（検証関数のみ）をハンドラーに変更します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/hk/mc/tthkmcm2ny2jhbczlt4vcu5w3pi.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connect（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数ハンドラーは</font><font style="vertical-align: inherit;">、すべてのブラウザー接続をプロキシー・サーバーにリダイレクトするように設計されています。</font><font style="vertical-align: inherit;">フッカーは宛先IPアドレスを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">127.0.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">置き換え、</font><font style="vertical-align: inherit;">ポートをプロキシサーバーポートに</font><font style="vertical-align: inherit;">置き換え</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">IcedIDは、プロキシサーバーに正常に接続した後、次のデータを送信します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPおよび宛先ポート</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザの種類</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインモジュールから引数として受け取った情報</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ブラウザプロセスの干渉を最小限に抑えて、IcedIDは次のMITMスキームを構築することができました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yu/hf/j0/yuhfj0rxe-cd59nqfo8dr3joqys.jpeg"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedID MITMスキーム</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
証明書、プロキシサーバー、パッチが適用されたブラウザーを備えたIcedIDは、すべてのデータがSSLの背後にある場合でも、ブラウザートラフィックを完全に制御できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCモジュール </font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、このモジュールは...サーバーコマンドを処理するためのものです！</font><font style="vertical-align: inherit;">はい、あなたは正しく聞いた：コマンドを処理するための別のモジュール。</font><font style="vertical-align: inherit;">それが管理サーバーに対して行うGET要求をすぐに見てみましょう。</font></font><br>
<img align="left" src="https://habrastorage.org/webt/ta/zq/8l/tazq8la-5-dxyic4fnjrsxtsjva.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、値</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BAADBEEF</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はBotID、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0BADFACE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はLoaderID、</font><b><font style="vertical-align: inherit;">タイムスタンプ</font></b><font style="vertical-align: inherit;">は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sec-WebSocket-Key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータの後ろに隠されています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このモジュールは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSocket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して管理サーバーと通信しているようです（ちなみに、Aliveモジュールと同じアドレスとポート443を使用しています）。</font><font style="vertical-align: inherit;">残念ながら、プロトコルを徹底的に調査してRFCと比較する時間はないので、アプリケーションが管理サーバーとプロセスから受信するコマンドに直行しましょう。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チーム</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメーター</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPを変更</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーにPINGを送信する</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PONGサーバーの応答</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チーム</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速コマンドを実行する</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、BCモジュール</font><font style="vertical-align: inherit;">はAliveモジュールの特権である</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">を実行でき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">おそらく最も興味深いチームはIPを変更することです。</font><font style="vertical-align: inherit;">パラメータとして、アプリケーションは、ポート8080に接続する制御サーバーのIPアドレスを受け取ります。サーバーとのすべての通信は、独自のバイナリプロトコルを使用して実行されます。そのヘッダーは次のとおりです。</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BcMessageStruct</span>
{</span>
	<span class="hljs-keyword">int</span> auth;<font></font>
	byte command;<font></font>
	<span class="hljs-keyword">int</span> id;
	<span class="hljs-keyword">int</span> key;<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IcedIDカーネルの少なくとも5番目のバージョン以降</font><font style="vertical-align: inherit;">
、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドが</font><font style="vertical-align: inherit;">変更され</font><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">いない</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">：定数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x974F014A</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -BotIDおよび</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -LoaderID。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールド</font><font style="vertical-align: inherit;">には次の値を指定できます。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チームリクエスト</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーへのアクセス期間を変更する</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側のエラー。たとえば、VNCモジュールを開始できなかった場合、アプリケーションはこのパッケージを送信します</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再接続コマンド</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOCKSモジュールを起動</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VNCモジュールを起動</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーに接続すると、アプリケーションは0のコマンドフィールドを持つパケットを送信し、サーバーはコマンドに応答します。</font><font style="vertical-align: inherit;">これは、間隔を置いて無限ループで発生します。</font><font style="vertical-align: inherit;">つまり、すべてが再び複雑なので</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font><font style="vertical-align: inherit;">の</font><s><font style="vertical-align: inherit;">想像力を使用し</font></s><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/nb/6f/qxnb6fj4itaqmtwcf91wwey9r2u.jpeg"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCモジュール</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の</font><i><font style="vertical-align: inherit;">IP変更コマンドの進捗状況</font></i><font style="vertical-align: inherit;">スキームは簡略化され、1、2、3チームは含まれていません。</font><font style="vertical-align: inherit;">それでは、VNCおよびSOCKSモジュールがどのように起動されるかを見てみましょう。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VNCモジュールの起動</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VNCモジュールは、新しい</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchost.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスのコンテキストで起動されます</font><font style="vertical-align: inherit;">。モジュール自体は圧縮形式のIcedID本体にあり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlDecompressBuffer（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用して</font><font style="vertical-align: inherit;">、トロイの木馬のコンテキストでアンパックされます（ただし、開始されません）。文脈でトロイの木馬を展開するためのシェルコード：メインIcedIDモジュールのように、VNCモジュールは、2つの部分で構成さ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SVCHOST.EXE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、モジュール自体。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、IcedIDは新しい</font><b><font style="vertical-align: inherit;">svchost.exe</font></b><font style="vertical-align: inherit;">プロセスを開始します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数なしのサスペンドモードでは、VNCモジュールと、モジュールが機能するために必要なパラメーター（CnC IPアドレス、ポート、BotID、キーなど）を書き込みます。そして、モジュールはかなり興味深い方法で起動されます。新しいプロセスのコンテキストで新しいスレッドを作成する代わりに、IcedIDはフックを標準関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlExitUserProcess（）に設定し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。次のようになります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/d8/1n/v-d81ntq4aqgoq66crvdxxcbghu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResumeThread（）で</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスを開始します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">プロセスは引数なしで開始されたので、非常に迅速に作業を完了し</font><font style="vertical-align: inherit;">、アプリケーションが起動されたときとは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なる</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><b><font style="vertical-align: inherit;">RtlExitUserProcess（）</font></b><font style="vertical-align: inherit;">を呼び出します</font><b><font style="vertical-align: inherit;">。JMP</font></b><font style="vertical-align: inherit;">命令は、制御をVNCモジュールのシェルコードに転送します。これはすでに実行されます。彼らの汚いビジネス。</font><font style="vertical-align: inherit;">古いバージョンのトロイの木馬がメインのIcedIDモジュールを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchost.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のコンテキストでこのように展開したことは注目に値します</font><font style="vertical-align: inherit;">が、何らかの理由で、ブートローダーの開発者はこのアイデアを放棄し、現在IcedIDを開始する方がはるかに簡単です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOCKSモジュールを起動</font></font><br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご想像のとおり、このモジュールは2つのリモートサーバー間のトラフィックをプロキシするように設計されています。実際、SOCKSモジュールは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックプロキシプロキシで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり、対応する機能を実行します。リモートCnCサーバーとの接続を確立し、アドレス、ポート、パラメータを要求し、接続を確立し、CnCとリモートサーバー間のトラフィックをプロキシします（正当な場合があります）。そしてもう少し。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールを開始するコマンドを受信した後、アプリケーションはサーバーに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BcMessageStruct</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造体のオブジェクトを送信します</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は4で、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">キーの</font></b><font style="vertical-align: inherit;">値です。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト構造から借用。</font><font style="vertical-align: inherit;">応答として、サーバーは、接続の確立に必要なリモートサーバーのヘッダー、アドレス、およびポートで構成されるデータを送信します。</font><font style="vertical-align: inherit;">アドレスは、ドメインまたはIPのいずれかです。</font><font style="vertical-align: inherit;">ヘッダーは5バイトで構成されます。次に、最も興味深い2つのフィールドについて簡単に説明します。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイアス</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスの種類：ドメインまたはIP</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求タイプ：SOCKS（0）またはcmd（1）</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヘッダーの後にデータが続きます-アドレスとポート。</font><font style="vertical-align: inherit;">また難しいですか？</font><font style="vertical-align: inherit;">それからこれのためのスキームがあります！</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hc/mb/bb/hcmbbbwcmobgrldj7seeuz-fux4.jpeg"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOCKSモジュールの操作スキーム次に</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
、予期しない順番があります。管理サーバーが接続を確立し、アドレスとポートのペアを127.0.0.1lla9426に設定し、「要求タイプ」フィールドが1の場合、アプリケーションは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスを開始します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/i4/pn/8g/i4pn8gtrwqcwnvy3spguvem0t8u.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がcmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をSOCKSモジュールで</font><b><font style="vertical-align: inherit;">実行した</font></b><font style="vertical-align: inherit;">理由を</font><font style="vertical-align: inherit;">説明できません。コマンド処理モジュール（ちなみに、2つです）では実行できません。</font><font style="vertical-align: inherit;">彼のやり方をお話しします</font><font style="vertical-align: inherit;">。cmd.exeを</font><font style="vertical-align: inherit;">作成するとき</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IcedIDは新しいプロセスのI / Oを2つのパイプにバインドし、その後2つのスレッドを作成します。1つはループでサーバーからデータを読み取り、パイプレコードに送信し、2つ目はパイプから読み取ります'読み取り、サーバーに送信します。</font><font style="vertical-align: inherit;">したがって、リモートサーバーはシェルを起動し、その中でコマンドを実行できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lx/po/k1/lxpok1wnbfnvf5vl7kjhw_wym_c.jpeg"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配布管理システムによるcmdコマンドの実行方式</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論があるはずです</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入荷時期です。</font><font style="vertical-align: inherit;">IcedIDは1年半の間、成長し、ファイルシステムとネットワークトラフィックのデータをより効率的に「隠す」ことを学び、VMの検出とデバッグの方法の基礎を習得しました。これは完全なリストではありません。</font><font style="vertical-align: inherit;">開発者は彼のプロジェクトを積極的に開発し続けており、多くの大規模なオープンソースプロジェクトは彼の忍耐をうらやましがります。</font><font style="vertical-align: inherit;">私たちはトロイの木馬の開発を監視し続け、当社の製品を改善し、興味深いアップデートを常に提供しています。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IOC</font></font></b>
                        <div class="spoiler_text"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローダー/ダウンローダー-第2段階：</font></font></b><br>
<br>
<ul>
<li>c897c555d395627dedf7e9e91623f54c</li>
<li>f89d448700de774c0b27762f327bd13f</li>
<li>ca59e8c577f8476dce210bc51c8daf9a</li>
<li>c7ebf2e9976f494355fee936749202a3</li>
<li>589b2d1eff18b651f8344e6a40f6cecf</li>
<li>753a45bfeb6877c2d9d841824d8f59a8</li>
</ul><br>
<b>Encrypted main module:</b><br>
<br>
<ul>
<li>6A44BEFDED3DA2245EF3A78E396CE5E0 — described in this article</li>
</ul><br>
<b>CnC:</b><br>
<br>
<ul>
<li>hXXps://poloturtles[.]top/audio</li>
<li>hXXps://robertogunez[.]xyz/audio</li>
<li>hXXps://gotofresno[.]xyz/audio</li>
<li>hXXps://fordthunderbirth[.]site/audio</li>
<li>hXXps://luxcarlegend[.]top/audio</li>
<li>hXXps://nicebirththunder[.]cloud/audio</li>
<li>hXXps://totheocean[.]pw/audio</li>
</ul></div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja501960/index.html">検索スケーリング。Elasticsearch インストールの利点と基本要件</a></li>
<li><a href="../ja501964/index.html">産業用コンピュータとは何ですか？</a></li>
<li><a href="../ja501966/index.html">2019年のロシアのベストIT雇用者：企業の品質によるランキング</a></li>
<li><a href="../ja501968/index.html">Kotlin MultiplatformのMVIアーキテクチャテンプレート、パート1</a></li>
<li><a href="../ja501970/index.html">RPGで良いダンジョンを作成するには何が必要ですか？</a></li>
<li><a href="../ja501976/index.html">ソフトウェアのテストを学ぶ方法</a></li>
<li><a href="../ja501978/index.html">Prometheusヒストグラムはどのように機能しますか？</a></li>
<li><a href="../ja501980/index.html">1つのプロジェクトの歴史、またはアスタリスクとPhpに基づいて7年間のPBXを作成した方法</a></li>
<li><a href="../ja501982/index.html">シェーダーをゲームエンジンからSubstance Painterに転送する方法</a></li>
<li><a href="../ja501984/index.html">検疫で何を確認しますか？テクノストリームからの厳選された資料（パート4）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>