<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏬ 👩🏻‍🤝‍👨🏽 👩🏿‍🤝‍👩🏽 Temporäre Lokalisierung auf Symfony 4 + Twig 🐄 🚦 🖕🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Notwendigkeit einer vorübergehenden Lokalisierung des Produkts entsteht, wenn das Produkt in einem Ausmaß wächst, das Arbeiten in verschiedenen Ze...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Temporäre Lokalisierung auf Symfony 4 + Twig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495604/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Notwendigkeit einer vorübergehenden Lokalisierung des Produkts entsteht, wenn das Produkt in einem Ausmaß wächst, das Arbeiten in verschiedenen Zeitzonen erfordert (Nachweise). </font><font style="vertical-align: inherit;">Ich möchte eine Variante einer einfachen Idee zur Lösung dieses Falls beschreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Hintergrund ist folgender: Wir haben ein Nischen-CRM / ERP-System entwickelt, und dann wurde uns gesagt, dass sie morgen mit diesem System in einem Franchise von Wladiwostok nach Kaliningrad arbeiten würden. </font><font style="vertical-align: inherit;">Leider wurde ein solches Szenario ursprünglich nicht durchdacht, und wir begannen zu lernen, wie dies mit minimalen Kosten und maximalem Komfort zu tun ist.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insgesamt wurden drei Aufgaben erweitert: Wie wir die Daten ausgeben und wie wir sie eingeben, und dazwischen die Aufgabe, wie wir alles speichern. Da die Zeit, wie Sie wissen, relativ wörtlich und im übertragenen Sinne ist, wurde beschlossen, die Zeit wie zuvor in Moskau UTC + 3 zu speichern, sie jedoch am Ein- und Ausgang zu verarbeiten (und zu beachten, dass der Referenzpunkt UTC + 3 ist). Natürlich haben wir verstanden, dass es in dieser und anderen Richtungen andere Lösungen gibt. Sie können alle vorhandenen Einträge in UTC + -0 konvertieren und spezielle Typen im DBMS verwenden, in denen die Zeitzone gespeichert ist. Sie können diesen benutzerdefinierten Typ selbst schreiben, wenn die Datenbank solche Funktionen plötzlich nicht mehr vollständig unterstützt. Aber nach dem Prinzip der Einfachheit gingen wir den vorgeschlagenen Weg, umso mehr verlor er auf den ersten Blick nicht viel an den Rest.und die Logik zum Bestimmen der gewünschten Zeitzone war ziemlich einfach.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem Moskau zu einem Referenzpunkt geworden war, haben wir jedem Benutzer einen benutzerdefinierten Zeitzonenparameter sowie eine Reihe verwandter Entitäten (Organisation, Stadt, Anwendungen, Geschäfte usw.) hinzugefügt. </font><font style="vertical-align: inherit;">Dann konnte eindeutig festgestellt werden, in welcher Zeitzone der Benutzer oder die Entität, mit der er arbeitet, arbeitet. </font><font style="vertical-align: inherit;">Die Logik dort ist Standard und genau oft projektspezifisch. </font><font style="vertical-align: inherit;">Wir haben diese Logik in den Service eingebunden und eine Zeitzone erhalten, in der Sie sie benötigen</font></font><br>
<br>
<pre><code class="php hljs">$localizationService-&gt;getTimezone();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Entscheidung, Daten in den Vorlagen zu lokalisieren, war wie folgt: Beim Initialisieren von Twig-Erweiterungen wurde die Zeitzone auf die gewünschte geändert:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Environment $twig, LocalizationService $localizationService</span>) </span>{<font></font>
    $twig-&gt;getExtension(<span class="hljs-string">'Twig_Extension_Core'</span>)-&gt;setTimezone($localizationService-&gt;getTimezone());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unsere Situation wurde durch die Tatsache weiter erschwert, dass nach Anzeige einer Datums- und Uhrzeitangabe ein Index „01.01.2020 12:30 (Moskau)“ erstellt werden muss, damit beispielsweise in einer an die Zeitzone gebundenen bedingten Reihenfolge / Aufgabe / Transaktion Informationen über die Uhrzeit vorliegen Gürtel. </font><font style="vertical-align: inherit;">Aus praktischen Gründen ist dies erforderlich, damit ein einzelnes Callcenter im Rahmen einer Aufgabe / Anwendung / Transaktion bequem mit verschiedenen Zeitzonen arbeiten kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die gesamte Logik zum Bestimmen der Priorität von Zeitzonen wurde in die oben erwähnte getTimezone eingebunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Außerdem waren wir mit der Tatsache konfrontiert, dass Sie, wenn Sie Ihren Zweigfilter oder Ihre Zweigfunktion erstellen, eine Reihe von Vorlagen ändern müssen, dies jedoch vermeiden wollten. </font><font style="vertical-align: inherit;">Aus diesem Grund haben wir uns nach einigem Nachfragen entschlossen, das Standard-Zweigfilterdatum neu zu definieren</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'date'</span>], [<span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">date</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{<font></font>
    $appendix = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (format &amp;&amp; strpos($format, <span class="hljs-string">'H:i'</span>) !== <span class="hljs-literal">false</span>)<font></font>
        $appendix = <span class="hljs-string">' ('</span>.DateTimeFunctions::getRussianAbbrev(<span class="hljs-keyword">$this</span>-&gt;localizationService-&gt;getTimezone()).<span class="hljs-string">')'</span>;   <font></font>
...<font></font>
    <span class="hljs-comment">//    date   $result</span><font></font>
...<font></font>
   <span class="hljs-keyword">return</span> $result.$appendix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir den Standardfilter verwendet haben, wurde auch die alte Version neu definiert:</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'native_date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'nativeDate'</span>], [ <span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeDate</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{
    <span class="hljs-comment">//    date </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Standard-Datumsfiltercode befindet sich in / twig / twig / lib / Twig / Extension / Core :: twig_date_format_filter. </font><font style="vertical-align: inherit;">Obwohl in den meisten Fällen eine einfache, nicht viel andere Option ausreicht:</font></font><br>
<br>
<pre><code class="php hljs">$date-&gt;setTimeZone($timezone)<font></font>
$result = $date-&gt;format($format);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich können Sie auch den wesentlicheren Teil von Twig gabeln oder neu definieren, aber wenn die Funktionalität des Standardfilters zu Ihnen passt, können Sie ihn einfach separat herausnehmen und nichts verlieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt das Problem der Eingabe der Datums- und Uhrzeitzeit zu lösen. </font><font style="vertical-align: inherit;">Eine Lösung:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOffsetHours</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $local = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>, <span class="hljs-keyword">new</span> \DateTimeZone(<span class="hljs-keyword">$this</span>-&gt;getTimezone()));<font></font>
    $user = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>);<font></font>
<font></font>
    $localOffset = $local-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
    $globalOffset = $user-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
<font></font>
    $diff = $globalOffset - $localOffset;<font></font>
    <span class="hljs-keyword">return</span> $diff;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toGlobalTime</span>(<span class="hljs-params">\DateTimeInterface $dateTime</span>): \<span class="hljs-title">DateTimeInterface</span> 
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $offsetHours = <span class="hljs-keyword">$this</span>-&gt;getOffsetHours();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ($offsetHours &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify(<span class="hljs-string">'+ '</span>.$offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    } <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>($offsetHours &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify($offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $dateTime;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rufen Sie dann an, bevor Sie Datum und Uhrzeit speichern, z. B. in Listenern. Diese Option kam zu uns, da im Grunde die Uhrzeit und das Datum im Projekt für bestimmte Ereignisse festgelegt und nicht manuell eingegeben wurden. In einem anderen Extremfall, in dem die Zeit ständig durch Formulare eingeführt wird, ist die Lösung möglicherweise nicht optimal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Bonus. Das Projekt verwendet Omines Datatables-Bundle zur Ausgabe von Tabellen. Dort war die Lösung noch einfacher. Anstelle von DateTimeColumn zur Lokalisierung wurde Folgendes verwendet:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomDateTimeColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateTimeColumn</span>
</span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> $localizationService;
    <span class="hljs-keyword">private</span> $timeZone;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">LocalizationService $localizationService</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;localizationService = $localizationService;
        <span class="hljs-keyword">$this</span>-&gt;timeZone = $localizationService-&gt;getTimezoneObject();<font></font>
    }<font></font>
    <font></font>
   <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">$value</span>)
    </span>{<font></font>
        $value-&gt;setTimeZone(<span class="hljs-keyword">$this</span>-&gt;timeZone);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::normalize($value);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank für Ihre Zeit. </font><font style="vertical-align: inherit;">Wenn jemand hilft, die grundlegenden Dinge der Lösung zu verbessern, bin ich sehr dankbar. </font><font style="vertical-align: inherit;">Wir sprechen von grundlegenden, da es klar ist, dass der Code Vakuum ist und in Wirklichkeit einen viel größeren DI und alle Arten von Extras für den internen Gebrauch im Projekt hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusammenfassend. </font><font style="vertical-align: inherit;">Die Idee einer einfachen Lösung für eine schnelle temporäre Lokalisierung des Projekts wird vorgestellt. </font><font style="vertical-align: inherit;">Es hängt nicht von den Versionen ab, oder wenn ja, ist es schwach. </font><font style="vertical-align: inherit;">Diese Lösung wurde erfolgreich von Symfony 4.2 auf 5 migriert.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495588/index.html">Roguelike in Unity von Grund auf neu erstellen: Dungeon-Generator</a></li>
<li><a href="../de495592/index.html">Verwendung von Wörterbüchern (und nicht nur)</a></li>
<li><a href="../de495594/index.html">Verdienen Sie Geld mit Software: Erstellen Sie ein Mini-Digital-Geschäft</a></li>
<li><a href="../de495596/index.html">Fernarbeit im Büro. RDP, Port Knocking, Mikrotik: einfach und sicher</a></li>
<li><a href="../de495602/index.html">Beginnend mit Kerndaten! In einfachen Worten schwierig [Teil 2]</a></li>
<li><a href="../de495606/index.html">"Soziale Überwachung." Ergebnis 1: 0 zu unseren Gunsten</a></li>
<li><a href="../de495608/index.html">[Infografik] Visualisierung von Pandemien in der Geschichte der Menschheit</a></li>
<li><a href="../de495610/index.html">Warum die Zukunft nicht für Python ist</a></li>
<li><a href="../de495612/index.html">Wird Airbnb das Coronavirus überleben? [Spoiler: ja]</a></li>
<li><a href="../de495614/index.html">FFmpeg libav Handbuch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>