<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèø üó®Ô∏è üéÇ Using parallelization when processing data in C # üïî üöÅ ü§≥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! I am a technical specialist working in an internal audit system, my responsibilities include creating ETL tools in the C # programmin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Using parallelization when processing data in C #</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502868/"><img src="https://habrastorage.org/webt/mr/xs/_r/mrxs_ryliqoncau3bzm0xdxj4g4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good day to all! </font><font style="vertical-align: inherit;">I am a technical specialist working in an internal audit system, my responsibilities include creating ETL tools in the C # programming language.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Periodically, data sources are tightly structured files in xml, csv, json, or any other format. Sometimes their number becomes quite large and constantly increasing. For example, in one of my tasks, the number of files increased with an average refresh rate of approximately 150,000 files per day. If at the same time processing a single file (reading an array of bytes from the hard disk into memory, transforming the downloaded data and writing them to the database) takes a second, then it becomes clear that processing all the files will take more than 40 hours. In this case, we will not be able to process these files to the end, since the speed of increasing the number of files will be clearly higher than the speed of their processing.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One solution to this problem is to develop an application in which to create a pool of threads independent of each other. The threads will process files selected from the general queue. However, in this case, difficulties arise with the synchronization of working flows and resource sharing, since mutual locks are very likely. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid these difficulties, Microsoft added the TPL library to the .Net framework (starting with version 4.0). I will tell you how to use this library to solve this problem.</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, initially the operation algorithm looks as follows: A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
file storage directory is scanned and a list (for example, List) containing data about all files is returned; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A cycle starts (for or foreach) in which data from the next file is read into memory, if necessary, transformed and written to the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, the most time-consuming operations are reading data from the hard disk into memory and writing data from memory to the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to optimize our algorithm using the TPL library: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Step 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Change the list returned by scanning the file storage directory from List to ConcurrentQueue.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why are we doing this? The fact is that the ConcurrentQueue class is thread safe, that is, if at the same time two threads try to extract data from this list or write data to it, then we will not throw exceptions (Exception). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Point 1 of our algorithm will look like this: the file storage directory is scanned and the ConcurrentQueue list is returned containing data about all the files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Point 2: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's change the design forming a cycle of processing data from a file. Replace for with Parallel.For or Parallel.ForEach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is the difference between the new construction and for? Everything is simple and basically clear from the name of the language construct. All iterations of the loop are performed in parallel threads. As an example, I will show the organization of the loop with the Parallel.ForEach construct:</font></font><br>
<br>
<pre><code class="plaintext hljs">Parallel.ForEach(listFiles, (currentFile) =&gt;<font></font>
       	  {<font></font>
              	var dataFile = getDataFile(currentFile.FullName);<font></font>
		TransformData(dataFile);<font></font>
		WriteToDB(dataFile);<font></font>
               });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
listFiles is a collection of type ConcurrentQueue containing a list of files in the directory; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 currentFile - an element of the listFiles collection, which is returned by the ForEach construct; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 dataFile - a conditional some data structure in memory, obtained by reading the contents of the file into memory; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 getDataFile - a conditional function that returns the contents of a file in the form of some data structure; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 TransformData - conditional procedure for transforming received data; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 WriteToDB is a conditional procedure for writing data to the database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, using the Parallel.ForEach construct, we will organize the loop. In this cycle, in parallel streams, data is read from the hard disk, their transformation and writing to the database. At the same time, there are no problems in organizing the work of parallel flows. The number of parallel threads depends on the number of processor cores and their workload. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the proposed algorithm, we will speed up file processing by at least 2 times. Although, of course, this figure will vary depending on the number of cores and the memory of the machine on which the program will run. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, to speed up the program, you need to put the record in the database in a separate stream that works regardless of the main one. This can be done using the ConcurrentQueue collection to avoid conflicts when adding data to the queue.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We rewrite the above example, taking into account the optimization of writing to the database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose a file reader returns data to us in a DataTable):</font></font><br>
<br>
<pre><code class="plaintext hljs">Parallel.ForEach(listFiles, (currentFile) =&gt;<font></font>
       	  {<font></font>
              	DataTable dataFile = getDataFile(currentFile.FullName);<font></font>
		TransformData(dataFile);<font></font>
		threadWriteToDB.ListData.Enqueue(dataFile);<font></font>
               });<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, instead of a line with a call to the write procedure in the database, we simply add to the ConcurrentQueue ListData collection described and initialized in a separate thread, an instance of which threadWriteToDB is used in our loop. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Writing to the database is already in a separate stream. </font><font style="vertical-align: inherit;">Writing to the database can be organized similarly to working with files using the Parallel.For and / or Paral-lel.Foreach constructions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my task, where processing of a comparable number of files was required, now, on average, from 200,000 to 400,000 files can be processed per day, and the speed is limited by loading the database and the width of the data channel.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502846/index.html">Zuckerberg launched Shops. Instagram and Facebook gradually become stores.</a></li>
<li><a href="../en502852/index.html">Why do people resist change and how can they help them rebuild</a></li>
<li><a href="../en502854/index.html">Why do ERP implementations fail?</a></li>
<li><a href="../en502860/index.html">Transport on May 20: rapid recovery of aviation is visible</a></li>
<li><a href="../en502862/index.html">LabVIEW NXG - Front Panel Basics - Controls and Indicators</a></li>
<li><a href="../en502870/index.html">What happens to the popularity of MySQL and PostgreSQL? Mitap discussion</a></li>
<li><a href="../en502872/index.html">How to strengthen immunity and protect against SARS and, probably, COVID-19. Science Proof</a></li>
<li><a href="../en502874/index.html">About a strong matrix and atmosphere in the development team</a></li>
<li><a href="../en502876/index.html">Workflow on Google Drive?</a></li>
<li><a href="../en502880/index.html">History of AtariTel. Phones and videophones from the secret department of the company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>