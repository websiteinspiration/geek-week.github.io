<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèæ ü§±üèº üëâüèª How to limit the frequency of requests in HAProxy: step-by-step instructions üë®üèΩ‚Äçüè≠ üà≥ üê¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author explains how to implement in HAProxy query speed limit (rate limiting) with a certain IP-addresses. The Mail.ru Cloud Solutions team transl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to limit the frequency of requests in HAProxy: step-by-step instructions</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499594/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/000/ebc/00e/000ebc00ecfca624add0621c731f2405.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The author explains how to implement in HAProxy </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">query speed limit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (rate limiting) with a certain IP-addresses. The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> team </font><font style="vertical-align: inherit;">translated his article - we hope that with it you will not have to spend as much time and effort on it as you had to spend it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that this is one of the most popular methods of protecting a server from DoS attacks, but it is difficult to find clear instructions on the Internet how to configure it specifically. By trial and error, the author forced HAProxy to limit the frequency of requests on a list of IP addresses, which is updated in real time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No prior knowledge is required to configure HAProxy, as all necessary steps are outlined below.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open source and free HAProxy is a highly accessible load balancer and proxy server. </font><font style="vertical-align: inherit;">In recent years, it has become </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very popular</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> because it provides high performance with a minimum of resources. </font><font style="vertical-align: inherit;">Unlike alternative programs, the nonprofit version of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy Community Edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> offers enough features for reliable load balancing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This program is at first pretty hard to figure out. </font><font style="vertical-align: inherit;">However, she has very meticulous and detailed technical </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The author says that this is the most detailed documentation among all open source programs that he has ever used. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, here is a step-by-step guide.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring a load balancer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To save time and not get distracted by infrastructure setup, take the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Compose</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> images </font><font style="vertical-align: inherit;">and quickly launch the main components. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first task is to raise the working instance of the HAProxy load balancer with several Apache backend servers.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clone the repository</font></font></h4><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> git@github.com:stargazer/haproxy-ratelimiter.git<font></font>
$ <span class="hljs-built_in">cd</span> haproxy-ratelimiter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can look at </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with installation parameters. Their discussion is beyond the scope of this article, so let‚Äôs dwell on the fact that they created a working HAProxy instance called </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with two backend servers </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. To configure HAProxy, we will initially use the file </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then switch to </font></font><code>haproxy-ratelimiting.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For simplicity, the configuration file has been </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduced to the bare minimum and cleared of excess. Let's look at it:</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
use_backend api<font></font>
<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The section </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sets HAProxy to listen on port 80 and forward all requests to the server pool </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the backend. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CATEGORY </font></font><code>backend api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">specifies backend pool </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with two back-end servers </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and corresponding addresses. </font><font style="vertical-align: inherit;">The server for servicing each incoming request is selected by the load balancing algorithm </font></font><code>roundrobin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, in fact, the two available servers are used in turn.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's launch all three of our containers</font></font></h4><br>
<pre><code class="bash hljs">$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have a container </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that redirects requests to two backend </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">servers </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We will get a response from one of them if we enter in the address bar </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is interesting to refresh the page several times and see the logs </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 09 +0000] "GET / HTTP / 1.1" 200 45</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, two servers </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process requests in turn. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We now have a HAProxy instance with a very simple load balancing configuration, and we have some idea of ‚Äã‚Äãhow it works.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add a limit on the number of requests</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To set a limit on the number of requests to the load balancer, you need to modify the configuration file in the HAProxy instance. </font><font style="vertical-align: inherit;">Make sure that the container </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses the configuration file </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just modify the Dockerfile to replace the configuration file.</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM haproxy:1.7<font></font>
COPY haproxy-ratelimiter.cfg /usr/local/etc/haproxy/haproxy.cfg</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting limits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All settings are registered in the configuration file </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Let's study it carefully.</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80<font></font>
<font></font>
backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxy offers a set of low-level primitives that provide more flexibility and are suitable for various use cases. </font><font style="vertical-align: inherit;">Its counters often remind me of the accumulative register (adder) in the CPU. </font><font style="vertical-align: inherit;">They store intermediate results, take different semantics as input, but in the end they are just numbers. </font><font style="vertical-align: inherit;">To understand everything well, it makes sense to start from the very end of the configuration file.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table </font></font><code>Abuse</code></h4><br>
<pre><code class="plaintext hljs">backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we set up a dummy backend called </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(‚Äúabuse‚Äù). </font><font style="vertical-align: inherit;">Fictitious, because it is used only for stick-table, which the rest of the configuration can refer to by name </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A stick-table is a table stored in the process memory, where for each record you can determine the lifetime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our table has the following characteristics:</font></font><br>
<br>
<ul>
<li><code>type ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Requests are saved in the table by IP address as a key. </font><font style="vertical-align: inherit;">Thus, requests from the same IP address will refer to the same record. </font><font style="vertical-align: inherit;">Essentially, this means that we are tracking IP addresses and related data.</font></font><br>
</li>
<li><code>size 100K</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The table contains a maximum of 100 thousand records.</font></font><br>
</li>
<li><code>expire 30m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The record retention period is 30 minutes of inactivity.</font></font><br>
</li>
<li><code>store gpc0,http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The counter </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the number of IP address requests for the last 10 seconds are </font><font style="vertical-align: inherit;">stored with entries </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">With the help, </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will track how many times the IP address is noticed in abuses. </font><font style="vertical-align: inherit;">In fact, a positive counter value means that the IP address is already marked as suspicious. </font><font style="vertical-align: inherit;">Let's call this counter </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, the table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to track whether the IP address is marked as suspicious, as well as the current frequency of requests from this address. </font><font style="vertical-align: inherit;">Therefore, we have a history of records, as well as real-time information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's move on to the section </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and see what's new there.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL Functions and Rules</font></font></h4><br>
<pre><code class="plaintext hljs">frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Access Control Lists (ACLs) are function declarations that are called only when the rule is set. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a closer look at all three ACL entries. </font><font style="vertical-align: inherit;">Keep in mind that they all explicitly reference a table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that uses IP addresses as a key, so each function applies to the request IP address:</font></font><br>
<br>
<ul>
<li><code>acl is_abuse src_http_req_rate(Abuse) ge 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The function </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the current request frequency is greater than or equal to ten.</font></font><br>
</li>
<li><code>acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The function </font></font><code>inc_abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the increment value is </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">greater than zero. </font><font style="vertical-align: inherit;">Since the initial value </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is zero, this function always returns </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In other words, it increases the value </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, essentially signaling abuse from this IP address.</font></font><br>
</li>
<li><code>acl abuse_cnt src_get_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The function </font></font><code>abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the value is </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">greater than zero. </font><font style="vertical-align: inherit;">In other words, he says if this IP address has already been spotted in abuses.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As mentioned earlier, ACLs are simply declarations, that is, function declarations. </font><font style="vertical-align: inherit;">They do not apply to incoming requests until some rule is triggered. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It makes sense to look at the rules defined in the same section </font></font><code>frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The rules are applied to each incoming request one by one - and run the functions from the ACL that we just defined. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what each rule does:</font></font><br>
<br>
<ul>
<li><code>tcp-request connection track-sc0 src table Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Adds a query to the table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Since the key is the IP address in the table, this rule adds to the list of IP addresses.</font></font><br>
</li>
<li><code>tcp-request connection reject if abuse_cnt</code>:   TCP-,  IP-    ,     abuse.  ,   TCP-   IP-.<br>
</li>
<li><code>http-request deny if abuse_cnt</code>:  ,  IP-    .        IP-,      abuse.<br>
</li>
<li><code>http-request deny if is_abuse inc_abuse_cnt</code>:  ,  <code>is_abuse</code>  <code>inc_abuse_cnt</code>   <code>True</code>.  ,    ,    IP-        ,    IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In essence, we introduce two types of checks: in real time and in the blacklist from the query history. </font><font style="vertical-align: inherit;">The second rule rejects all new TCP connections if the IP address has been noticed in abuses. </font><font style="vertical-align: inherit;">The third rule prohibits the service of HTTP requests for an IP address from the black list, regardless of the current frequency of requests from this address. </font><font style="vertical-align: inherit;">The fourth rule ensures that HTTP requests from an IP address are rejected at the very moment as soon as the threshold for request frequency has been overcome. </font><font style="vertical-align: inherit;">Thus, the second rule mainly works on new TCP connections, the third and fourth - on already established connections, the first being a historical check, and the second a real-time check.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try the filter in action!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can assemble and launch our containers again.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo docker-compose down<font></font>
$ sudo docker-compose build<font></font>
$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The load balancer should start before the two backend servers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's direct our browser to </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If we quickly refresh the page a dozen times, we will exceed the threshold of ten requests in a ten-second interval - and our requests will be rejected. </font><font style="vertical-align: inherit;">If we continue to refresh the page, new requests will be rejected immediately - even before the TCP connection is established.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Questions</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is the limit of ten requests per ten seconds?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determines </font></font><code>http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, the frequency of requests is measured in a window of ten seconds. </font><font style="vertical-align: inherit;">A function </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the ACL returns </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at a request rate of ‚â•10 within the specified interval. </font><font style="vertical-align: inherit;">Thus, abuse is considered the frequency of requests of ten or more requests in ten seconds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, for example, we decided to set a low limit to make it easier to check the operation of the limiter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the difference between http-request and tcp-request connection rules?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://cbonte.github.io/haproxy-dconv/1.7/configuration.html&amp;usg=ALkJrhiCTHojoDOjJ0QXKYJPDSzpNWIr8g#4.2-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-request: the http-request statement defines a set of rules that apply at the network layer 7 [OSI model]</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tcp-request connection: performing an action on an incoming connection depending on a condition at the network layer 4</font></font></i></blockquote><br>
<h3>  HTTP-,        TCP-?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that HTTP requests to the server send multiple TCP connections from the same IP address. </font><font style="vertical-align: inherit;">The frequency of HTTP requests will quickly exceed thresholds. </font><font style="vertical-align: inherit;">It is then that the fourth rule comes into effect, which discards requests and blacklisted the IP address. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it is entirely possible that HTTP connections from the same IP address remain open (see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">persistent HTTP connection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and the frequency of HTTP requests has dropped below a threshold value. </font><font style="vertical-align: inherit;">The third rule guarantees continued blocking of HTTP requests, since it is </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">triggered on this IP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now suppose that after a few minutes the same IP tries to establish TCP connections. </font><font style="vertical-align: inherit;">They are dropped immediately, because the second rule applies: it sees the labeled IP address and immediately drops the connection.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, it can be difficult to understand the limitation of the speed of processing requests using HAProxy. </font><font style="vertical-align: inherit;">To do everything right, you need a fairly "low-level" thinking and a number of non-intuitive actions. </font><font style="vertical-align: inherit;">The documentation in this part is probably too technical and suffers from the absence of any basic examples. </font><font style="vertical-align: inherit;">We hope that this guide will make up for the shortcoming and show the direction to everyone who wants to take this path. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else to read</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How fault-tolerant architecture is implemented in the Mail.ru Cloud Solutions platform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Top 10 Kubernetes Tricks and Tips</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our Telegram channel on digital transformation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499582/index.html">Predator-Prey Model at Node.js</a></li>
<li><a href="../en499584/index.html">Industrial touch monitor FPM-215W</a></li>
<li><a href="../en499586/index.html">How to think through navigation in mobile applications</a></li>
<li><a href="../en499588/index.html">Authentication in .NET Core gRpc with JWT</a></li>
<li><a href="../en499592/index.html">AI: Complementing tomorrow's world</a></li>
<li><a href="../en499598/index.html">And we will go north! Will it be possible to save on the cooling of data centers due to the weather?</a></li>
<li><a href="../en499600/index.html">How to work together, working apart</a></li>
<li><a href="../en499602/index.html">Moving a Conference Online: InnerSource Commons Summit Experience</a></li>
<li><a href="../en499604/index.html">4 arguments to convince a director to buy a UPS in a small business</a></li>
<li><a href="../en499606/index.html">Video Conferencing Software: Skype, Hangouts, and Zoom Half-Blood</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>