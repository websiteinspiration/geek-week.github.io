<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öìÔ∏è ü§• üë®‚ÄçüöÄ Bot t√©l√©gramme en python vs COVID-19 üê¢ üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø üöö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="introduction
 

En relation avec la situation de panique totale et de d√©sinformation qui nous parvient de tous les canaux tels que les messageries ins...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bot t√©l√©gramme en python vs COVID-19</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496516/"><img src="https://habrastorage.org/webt/wg/nr/0o/wgnr0o3blvggk6xlfoynxss68hu.jpeg"><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En relation avec la situation de panique totale et de d√©sinformation qui nous parvient de tous les canaux tels que les messageries instantan√©es, les sites d'information, la radio, la t√©l√©vision, il a √©t√© d√©cid√© de montrer comment vous pouvez vaincre le coronavirus en utilisant le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bot </font><font style="vertical-align: inherit;">et d'autres ingr√©dients int√©ressants pour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">je plaisante</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )!</font></font></p><br>
<a name="habracut"></a><br>
<p>  -     , python, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">docker</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">heroku CLI</a>, telegram     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">mongoDB</a>    .        ,              .</p><br>
<h3>   </h3><br>
<p>  ,  ,    ,       :</p><br>
<ul>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">COVID-19</a>      </li>
<li>   COVID-19  </li>
<li>   </li>
<li>  </li>
<li>  </li>
<li>,  ,   </li>
</ul><br>
<h3>     </h3><br>
<p>      -:</p><br>
<ul>
<li>     mongodb(,  , )</li>
<li>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">PyTelegramBotAPI</a></li>
<li>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">API</a></li>
<li>    Docker </li>
<li>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">PAAS  Heroku</a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">CI</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Github</a>  Heroku</li>
</ul><br>
<h3>    Telegram</h3><br>
<p>      Telegram          .  ,            :</p><br>
<ul>
<li>   Telegram   ‚Äú<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">BotFather</a>‚Äù</li>
<li>  /start</li>
<li>  /newbot</li>
<li>           Telegram</li>
<li> token        </li>
</ul><br>
<h3>    </h3><br>
<p>         Telegram       :</p><br>
<ul>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Python</a></li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Heroku CLI</a></li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">git CLI</a></li>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Docker</a></li>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">MongoDb</a></li>
<li>IDE       Python,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Pycharm  JetBrains</a></li>
</ul><br>
<h3> </h3><br>
<p>          ,   .         github           ,          CI  .</p><br>
<p> -      </p><br>
<pre><code class="bash hljs">tree -L 2<font></font>
‚îú‚îÄ‚îÄ Dockerfile<font></font>
‚îú‚îÄ‚îÄ .gitignore<font></font>
‚îú‚îÄ‚îÄ README.md<font></font>
‚îú‚îÄ‚îÄ common<font></font>
‚îÇ   ‚îú‚îÄ‚îÄ containers.py<font></font>
‚îÇ   ‚îî‚îÄ‚îÄ tg_analytics.py<font></font>
‚îú‚îÄ‚îÄ data<font></font>
‚îÇ   ‚îî‚îÄ‚îÄ mongo_context.py<font></font>
‚îú‚îÄ‚îÄ data.csv<font></font>
‚îú‚îÄ‚îÄ heroku.yml<font></font>
‚îú‚îÄ‚îÄ setup.py<font></font>
‚îú‚îÄ‚îÄ requirements.txt<font></font>
‚îú‚îÄ‚îÄ services<font></font>
‚îÇ   ‚îú‚îÄ‚îÄ country_service.py<font></font>
‚îÇ   ‚îî‚îÄ‚îÄ statistics_service.py<font></font>
‚îî‚îÄ‚îÄ templates<font></font>
    ‚îú‚îÄ‚îÄ contacts.html<font></font>
    ‚îú‚îÄ‚îÄ country_statistics.html<font></font>
    ‚îú‚îÄ‚îÄ himydear.html<font></font>
    ‚îú‚îÄ‚îÄ idunnocommand.html<font></font>
    ‚îú‚îÄ‚îÄ notfound.html<font></font>
    ‚îî‚îÄ‚îÄ query_statistics.html<font></font>
</code></pre><br>
<h2>  </h2><br>
<h3>    </h3><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  </a>  ,                  :</p><br>
<pre><code class="bash hljs">python -m venv env <span class="hljs-comment">#   </span>
sourse env/bin/activate <span class="hljs-comment">#    </span>
</code></pre><br>
<p>      (  )   ,        ,       ,             .</p><br>
<p>  -         -    ,               :</p><br>
<pre><code class="bash hljs">deactivate <span class="hljs-comment">#   </span>
</code></pre><br>
<h3> </h3><br>
<p>            .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>,  .</p><br>
<pre><code class="bash hljs">touch requirements.txt <span class="hljs-comment">#   </span>
touch setup.py <span class="hljs-comment">#  python </span>
</code></pre><br>
<p>      :</p><br>
<ul>
<li>Requests ‚Äî   HTTP </li>
<li>Pytelegrambotapi ‚Äî     Telegram API</li>
<li>Pymongo ‚Äî       Mongo</li>
<li>Dependency_injector ‚Äî    </li>
<li>Geocoder ‚Äî     Geonames API</li>
<li>Jinja2 ‚Äî     </li>
<li>Ciso8601 ‚Äî       ISO 8601</li>
<li>Cachetools ‚Äî   </li>
<li>Pandas ‚Äî    </li>
<li>Flask ‚Äî  web framework   python</li>
</ul><br>
<p>      ,          .</p><br>
<pre><code class="plaintext hljs">requests==2.23.0<font></font>
pytelegrambotapi==3.6.7<font></font>
pymongo==3.10.1<font></font>
dependency_injector==3.15.6<font></font>
geocoder==1.38.1<font></font>
jinja2==2.11.1<font></font>
ciso8601==2.1.3<font></font>
cachetools==4.0.0<font></font>
pandas==1.0.3<font></font>
flask==1.1.2<font></font>
</code></pre><br>
<p>         .             ,     API,      ;).</p><br>
<h2> </h2><br>
<p>        requirements.txt          ,                 :</p><br>
<pre><code class="bash hljs">pip install -r requirements.txt <span class="hljs-comment">#  </span>
</code></pre><br>
<p>    ,          .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> setup.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /setup.py file</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span>
<span class="hljs-keyword">import</span> telebot
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
<span class="hljs-keyword">from</span> telebot <span class="hljs-keyword">import</span> types<font></font>
<font></font>
<span class="hljs-comment"># bot initialization</span>
token = os.getenv(<span class="hljs-string">'API_BOT_TOKEN'</span>)<font></font>
bot = telebot.TeleBot(token)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># start command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['start'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_start_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    bot.send_chat_action(cid, <span class="hljs-string">'typing'</span>)<font></font>
    markup = types.ReplyKeyboardMarkup(row_width=<span class="hljs-number">1</span>, resize_keyboard=<span class="hljs-literal">True</span>)<font></font>
    button_geo = types.KeyboardButton(text=<span class="hljs-string">'send location'</span>, request_location=<span class="hljs-literal">True</span>)<font></font>
    markup.add(button_geo)<font></font>
    bot.send_message(cid, <span class="hljs-string">'Hello stranger, please choose commands from the menu'</span>, reply_markup=markup)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># application entry point</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    bot.polling(none_stop=<span class="hljs-literal">True</span>, interval=<span class="hljs-number">0</span>)
</code></pre><br>
</div>
                    </div><br>
<p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> </a> API_BOT_TOKEN,  pycharm IDE    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> </a>.          ‚ÄúEdit configurations‚Äù,    ,      ,        token .</p><br>
<img src="https://habrastorage.org/webt/-m/93/sx/-m93sxsfvn1jd5eeed3bdblnxks.png"><br>
<p>         </p><br>
<img src="https://habrastorage.org/webt/pp/sa/-_/ppsa-_vqfrssclhss_6ogi1h04s.png"><br>
<p>         Telegram   .</p><br>
<img src="https://habrastorage.org/webt/5m/71/bt/5m71btma5e_mmnah6nkl4cuybp0.png"><br>
<p>,           ‚Äúsend location‚Äù,       ¬´contacts¬ª, ¬´help¬ª      -.</p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">HTML</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Markdown</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>   Telegram    .    HTML   .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> setup.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /setup.py file</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span><font></font>
<font></font>
known_users = []<font></font>
user_steps = {}<font></font>
commands = {<font></font>
    <span class="hljs-string">'start'</span>: <span class="hljs-string">'Start using this bot'</span>,
    <span class="hljs-string">'help'</span>: <span class="hljs-string">'Useful information about this bot'</span>,
    <span class="hljs-string">'contacts'</span>: <span class="hljs-string">'Contacts'</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># decorator for bot actions</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_action</span>(<span class="hljs-params">action</span>):</span>
    <span class="hljs-string">"""Sends `action` while processing func command."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorator</span>(<span class="hljs-params">func</span>):</span>
<span class="hljs-meta">        @wraps(func)</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_func</span>(<span class="hljs-params">message, *args, **kwargs</span>):</span><font></font>
            bot.send_chat_action(chat_id=message.chat.id, action=action)<font></font>
            <span class="hljs-keyword">return</span> func(message, *args, **kwargs)
        <span class="hljs-keyword">return</span> command_func
    <span class="hljs-keyword">return</span> decorator<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># help command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['help'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_help_handler</span>(<span class="hljs-params">message</span>):</span>
    help_text = <span class="hljs-string">'The following commands are available: \n'</span>
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> commands:<font></font>
        help_text += <span class="hljs-string">'/'</span> + key + <span class="hljs-string">': '</span>
        help_text += commands[key] + <span class="hljs-string">'\n'</span>
    help_text += <span class="hljs-string">'ANTICOVID19BOT speaks english, be careful and take care!'</span><font></font>
    bot.send_message(message.chat.id, help_text)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># contacts command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['contacts'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_contacts_handler</span>(<span class="hljs-params">message</span>):</span>
    <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/contacts.html'</span>) <span class="hljs-keyword">as</span> file:<font></font>
        template = Template(file.read())<font></font>
        bot.send_message(message.chat.id, template.render(username=message.chat.username), parse_mode=<span class="hljs-string">'HTML'</span>)
</code></pre><br>
</div>
                    </div><br>
<p>             .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> mongo_context.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /data/mongo_context.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span>
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> pymongo <span class="hljs-keyword">import</span> MongoClient<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoDbContext</span>:</span>
    <span class="hljs-string">"""Mongo database context class"""</span><font></font>
<font></font>
    <span class="hljs-comment"># constructor of class</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">try</span>:<font></font>
            self.connection_string = os.getenv(<span class="hljs-string">'CONNECTION_STRING'</span>)<font></font>
            self.client = MongoClient(self.connection_string)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> e<font></font>
<font></font>
    <span class="hljs-comment"># save user query method</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_query</span>(<span class="hljs-params">self, country, user_name</span>):</span>
        db = self.client[os.getenv(<span class="hljs-string">'DB_NAME'</span>)]<font></font>
        countries_stats = db.country_stats<font></font>
        result = countries_stats.insert_one({<span class="hljs-string">'date'</span>: datetime.now(), <span class="hljs-string">'country'</span>: country, <span class="hljs-string">'username'</span>: user_name})<font></font>
<font></font>
    <span class="hljs-comment"># get users queries method</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_queries</span>(<span class="hljs-params">self</span>):</span>
        db = self.client[os.getenv(<span class="hljs-string">'DB_NAME'</span>)]<font></font>
        countries_stats = db.country_stats<font></font>
        queries = countries_stats.aggregate([<font></font>
            {<span class="hljs-string">'$group'</span>: {<span class="hljs-string">'_id'</span>: <span class="hljs-string">'$country'</span>, <span class="hljs-string">'count'</span>: {<span class="hljs-string">'$sum'</span>: <span class="hljs-number">1</span>}}},<font></font>
            {<span class="hljs-string">'$sort'</span>: {<span class="hljs-string">'count'</span>: <span class="hljs-number">-1</span>}},<font></font>
            {<span class="hljs-string">'$limit'</span>: <span class="hljs-number">5</span>}<font></font>
        ])<font></font>
        users = countries_stats.aggregate([<font></font>
            {<span class="hljs-string">'$group'</span>: {<span class="hljs-string">'_id'</span>: <span class="hljs-string">'$username'</span>, <span class="hljs-string">'count'</span>: {<span class="hljs-string">'$sum'</span>: <span class="hljs-number">1</span>}}},<font></font>
            {<span class="hljs-string">'$sort'</span>: {<span class="hljs-string">'count'</span>: <span class="hljs-number">-1</span>}},<font></font>
            {<span class="hljs-string">'$limit'</span>: <span class="hljs-number">5</span>}<font></font>
        ])<font></font>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'queries'</span>: list(queries), <span class="hljs-string">'users'</span>: list(users)}<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>           .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> containers.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /common/containers.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> dependency_injector.containers <span class="hljs-keyword">as</span> containers
<span class="hljs-keyword">import</span> dependency_injector.providers <span class="hljs-keyword">as</span> providers
<span class="hljs-keyword">from</span> data.mongo_context <span class="hljs-keyword">import</span> MongoDBContext<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DbContext</span>(<span class="hljs-params">containers.DeclarativeContainer</span>):</span>
    <span class="hljs-string">"""di for future development"""</span><font></font>
    mongo_db_context = providers.Singleton(MongoDBContext)<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>              API.   API     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> </a>   (, )             Telegram.<br>
</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> country_service.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /services/country_service.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> requests<font></font>
<font></font>
<span class="hljs-keyword">from</span> cachetools <span class="hljs-keyword">import</span> cached, TTLCache<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryService</span>:</span>
    <span class="hljs-string">"""This class provide country information"""</span><font></font>
<font></font>
    <span class="hljs-comment"># 3 hours cache time</span>
    cache = TTLCache(maxsize=<span class="hljs-number">100</span>, ttl=<span class="hljs-number">10800</span>)<font></font>
<font></font>
    <span class="hljs-comment"># method for getting country information by lat nad lng</span>
<span class="hljs-meta">    @cached(cache)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_country_information</span>(<span class="hljs-params">self, latitude, longitude</span>):</span>
        url = <span class="hljs-string">'http://api.geonames.org/countrySubdivisionJSON'</span>
        query_string = {<span class="hljs-string">'lat'</span>: latitude, <span class="hljs-string">'lng'</span>: longitude, <span class="hljs-string">'username'</span>: os.getenv(<span class="hljs-string">'GEO_NAME_API_KEY'</span>)}<font></font>
        geo_result = requests.request(<span class="hljs-string">'GET'</span>, url, params=query_string)
        <span class="hljs-keyword">return</span> geo_result.json()
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> statistics_service.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /services/statistics_service.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> codecs
<span class="hljs-keyword">import</span> ciso8601<font></font>
<font></font>
<span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template
<span class="hljs-keyword">from</span> cachetools <span class="hljs-keyword">import</span> cached, TTLCache
<span class="hljs-keyword">from</span> common.containers <span class="hljs-keyword">import</span> DBContext<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatisticsService</span>:</span>
    <span class="hljs-string">"""This class provide information about statistics"""</span><font></font>
<font></font>
    <span class="hljs-comment"># cache time 3 hours</span>
    cache = TTLCache(maxsize=<span class="hljs-number">100</span>, ttl=<span class="hljs-number">10800</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">try</span>:<font></font>
            self.covid_api_token = os.getenv(<span class="hljs-string">'COVID_STAT_API_TOKEN'</span>)<font></font>
            self.db_context = DBContext.mongo_db_context()<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> e<font></font>
<font></font>
    <span class="hljs-comment"># method for getting statistics from API</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__get_statistics_by_country_from_api</span>(<span class="hljs-params">self, country_name</span>):</span>
        url = <span class="hljs-string">"https://covid-193.p.rapidapi.com/statistics"</span>
        query_string = {<span class="hljs-string">'country'</span>: country_name}<font></font>
        headers = {<font></font>
            <span class="hljs-string">'x-rapidapi-host'</span>: <span class="hljs-string">"covid-193.p.rapidapi.com"</span>,
            <span class="hljs-string">'x-rapidapi-key'</span>: <span class="hljs-string">"db21e48371msh30968ff2ec637d3p19bd08jsn32426bcabdaf"</span><font></font>
        }<font></font>
        response = requests.request(<span class="hljs-string">"GET"</span>, url, headers=headers, params=query_string)
        <span class="hljs-keyword">return</span> response.json()<font></font>
<font></font>
    <span class="hljs-comment"># method for rendering statistics as html</span>
<span class="hljs-meta">    @cached(cache)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__get_statistics_by_country_as_html</span>(<span class="hljs-params">self, country_name</span>):</span>
        <span class="hljs-keyword">try</span>:<font></font>
            statistics_json = self.__get_statistics_by_country_from_api(country_name)<font></font>
            <span class="hljs-keyword">if</span> len(statistics_json[<span class="hljs-string">'response'</span>]) == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/idunnocommand.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
                    template = Template(file.read())<font></font>
                    <span class="hljs-keyword">return</span> template.render(text_command=country_name)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/country_statistics.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
                    template = Template(file.read())<font></font>
                    <span class="hljs-keyword">return</span> template.render(date=ciso8601.parse_datetime(statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'time'</span>]).date(),<font></font>
                                           country=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'country'</span>].upper(),<font></font>
                                           new_cases=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'cases'</span>][<span class="hljs-string">'new'</span>],<font></font>
                                           active_cases=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'cases'</span>][<span class="hljs-string">'active'</span>],<font></font>
                                           critical_cases=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'cases'</span>][<span class="hljs-string">'critical'</span>],<font></font>
                                           recovered_cases=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'cases'</span>][<span class="hljs-string">'recovered'</span>],<font></font>
                                           total_cases=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'cases'</span>][<span class="hljs-string">'total'</span>],<font></font>
                                           new_deaths=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'deaths'</span>][<span class="hljs-string">'new'</span>],<font></font>
                                           total_deaths=statistics_json[<span class="hljs-string">'response'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'deaths'</span>][<span class="hljs-string">'total'</span>])
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> e<font></font>
<font></font>
    <span class="hljs-comment"># method for getting statistics by country_name</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_statistics_by_country_name</span>(<span class="hljs-params">self, country_name, user_name</span>):</span><font></font>
        self.db_context.save_query(country_name, user_name)<font></font>
        <span class="hljs-keyword">return</span> self.__get_statistics_by_country_as_html(country_name)<font></font>
<font></font>
    <span class="hljs-comment"># method for getting statistics of users and queries</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_statistics_of_users_queries</span>(<span class="hljs-params">self</span>):</span><font></font>
        query_statistics = self.db_context.get_users_queries()<font></font>
        <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/query_statistics.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
            template = Template(file.read())<font></font>
            <span class="hljs-keyword">return</span> template.render(queries=query_statistics[<span class="hljs-string">'queries'</span>], users=query_statistics[<span class="hljs-string">'users'</span>])<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>          .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">chatbase</a>,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">csv</a> ,      ,   .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">alekskram</a>.</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> tg_analitycs.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /common/tg_analitycs.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<font></font>
<font></font>
users_type = {<font></font>
    <span class="hljs-number">1</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">2</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">3</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">4</span>: <span class="hljs-string">''</span><font></font>
}<font></font>
day_type = {<font></font>
    <span class="hljs-number">1</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">2</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">3</span>: <span class="hljs-string">''</span>,
    <span class="hljs-number">4</span>: <span class="hljs-string">''</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># remove txt file</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">remove</span>(<span class="hljs-params">user_id</span>):</span>
    path = os.getcwd() + <span class="hljs-string">'/%s.txt'</span> % user_id<font></font>
    os.remove(path)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># write data to csv</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">statistics</span>(<span class="hljs-params">user_id, command</span>):</span>
    data = datetime.datetime.today().strftime(<span class="hljs-string">"%Y-%m-%d"</span>)
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'a'</span>, newline=<span class="hljs-string">""</span>) <span class="hljs-keyword">as</span> fil:<font></font>
        wr = csv.writer(fil, delimiter=<span class="hljs-string">';'</span>)<font></font>
        wr.writerow([data, user_id, command])<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># make report</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">analysis</span>(<span class="hljs-params">bid, user_id</span>):</span>
    season = int(bid[<span class="hljs-number">1</span>])<font></font>
    df = pd.read_csv(<span class="hljs-string">'data.csv'</span>, delimiter=<span class="hljs-string">';'</span>, encoding=<span class="hljs-string">'utf8'</span>)<font></font>
    number_of_users = len(df[<span class="hljs-string">'id'</span>].unique())<font></font>
    number_of_days = len(df[<span class="hljs-string">'data'</span>].unique())<font></font>
<font></font>
    message_to_user = <span class="hljs-string">'    %s %s: \n'</span> % (season, day_type.get(season, <span class="hljs-string">''</span>))<font></font>
    message_to_user += <span class="hljs-string">'    %s %s \n'</span> % (number_of_days, day_type.get(season, <span class="hljs-string">''</span>))
    <span class="hljs-keyword">if</span> season &gt; number_of_days:<font></font>
        season = number_of_days<font></font>
        message_to_user += <span class="hljs-string">'    , \n'</span> \
                           <span class="hljs-string">'      \n'</span><font></font>
<font></font>
    df_user = df.groupby([<span class="hljs-string">'data'</span>, <span class="hljs-string">'id'</span>]).count().reset_index().groupby(<span class="hljs-string">'data'</span>).count().reset_index()<font></font>
    list_of_dates_in_df_user = list(df_user[<span class="hljs-string">'data'</span>])<font></font>
    list_of_number_of_user_in_df_user = list(df_user[<span class="hljs-string">'id'</span>])<font></font>
    list_of_dates_in_df_user = list_of_dates_in_df_user[-season:]<font></font>
    list_of_number_of_user_in_df_user = list_of_number_of_user_in_df_user[-season:]<font></font>
    df_command = df.groupby([<span class="hljs-string">'data'</span>, <span class="hljs-string">'command'</span>]).count().reset_index()<font></font>
    unique_commands = df[<span class="hljs-string">'command'</span>].unique()<font></font>
    commands_in_each_day = []<font></font>
    list_of_dates_in_df_command = list(df_command[<span class="hljs-string">'data'</span>])<font></font>
    list_of_number_of_user_in_df_command = list(df_command[<span class="hljs-string">'id'</span>])<font></font>
    list_of_name_of_command_in_df_command = list(df_command[<span class="hljs-string">'command'</span>])<font></font>
    commands_in_this_day = dict()<font></font>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(list_of_dates_in_df_command)):<font></font>
        commands_in_this_day[list_of_name_of_command_in_df_command[i]] = list_of_number_of_user_in_df_command[i]<font></font>
        <span class="hljs-keyword">if</span> i + <span class="hljs-number">1</span> &gt;= len(list_of_dates_in_df_command) <span class="hljs-keyword">or</span> list_of_dates_in_df_command[i] != list_of_dates_in_df_command[<font></font>
            i + <span class="hljs-number">1</span>]:<font></font>
            commands_in_each_day.append(commands_in_this_day)<font></font>
            commands_in_this_day = dict()<font></font>
    commands_in_each_day = commands_in_each_day[-season:]<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-string">''</span> <span class="hljs-keyword">in</span> bid:<font></font>
        message_to_user += <span class="hljs-string">'     '</span> + <span class="hljs-string">'%s'</span> % number_of_users \<font></font>
                           + <span class="hljs-string">' %s '</span> % users_type.get(number_of_users, <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span> \
                                                                                         <span class="hljs-string">'   %s %s: \n'</span> % (<font></font>
                               season, day_type.get(season, <span class="hljs-string">''</span>))
        <span class="hljs-keyword">for</span> days, number, comm_day <span class="hljs-keyword">in</span> zip(list_of_dates_in_df_user, list_of_number_of_user_in_df_user,<font></font>
                                          commands_in_each_day):<font></font>
            message_to_user += <span class="hljs-string">':%s :%d   :%s\n'</span> % (days, number, comm_day.get(<span class="hljs-string">'/start'</span>, <span class="hljs-number">0</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-string">''</span> <span class="hljs-keyword">in</span> bid:<font></font>
        message_to_user += <span class="hljs-string">'    %s %s: \n'</span> % (season, day_type.get(season, <span class="hljs-string">''</span>))
        <span class="hljs-keyword">for</span> days, commands <span class="hljs-keyword">in</span> zip(list_of_dates_in_df_user, commands_in_each_day):<font></font>
            message_to_user += <span class="hljs-string">':%s\n'</span> % days
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> unique_commands:
                <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> commands:<font></font>
                    message_to_user += <span class="hljs-string">'%s - %s \n'</span> % (i, commands.get(i))
                <span class="hljs-keyword">else</span>:<font></font>
                    message_to_user += <span class="hljs-string">'%s - 0 \n'</span> % i<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'txt'</span> <span class="hljs-keyword">in</span> bid <span class="hljs-keyword">or</span> <span class="hljs-string">''</span> <span class="hljs-keyword">in</span> bid:
        <span class="hljs-keyword">with</span> open(<span class="hljs-string">'%s.txt'</span> % user_id, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> fil:<font></font>
            fil.write(message_to_user)<font></font>
            fil.close()<font></font>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> message_to_user
</code></pre><br>
</div>
                    </div><br>
<br>
<p>      .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> setup.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># /setup.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> telebot
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> codecs
<span class="hljs-keyword">import</span> common.tg_analytics <span class="hljs-keyword">as</span> tga<font></font>
<font></font>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> telebot <span class="hljs-keyword">import</span> types
<span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template
<span class="hljs-keyword">from</span> services.country_service <span class="hljs-keyword">import</span> CountryService
<span class="hljs-keyword">from</span> services.statistics_service <span class="hljs-keyword">import</span> StatisticsService<font></font>
<font></font>
<span class="hljs-comment"># bot initialization</span>
token = os.getenv(<span class="hljs-string">'API_BOT_TOKEN'</span>)<font></font>
bot = telebot.TeleBot(token)<font></font>
user_steps = {}<font></font>
known_users = []<font></font>
stats_service = StatisticsService()<font></font>
country_service = CountryService()<font></font>
commands = {<span class="hljs-string">'start'</span>: <span class="hljs-string">'Start using this bot'</span>,
            <span class="hljs-string">'country'</span>: <span class="hljs-string">'Please, write a country name'</span>,
            <span class="hljs-string">'statistics'</span>: <span class="hljs-string">'Statistics by users queries'</span>,
            <span class="hljs-string">'help'</span>: <span class="hljs-string">'Useful information about this bot'</span>,
            <span class="hljs-string">'contacts'</span>: <span class="hljs-string">'Developer contacts'</span>}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_user_step</span>(<span class="hljs-params">uid</span>):</span>
    <span class="hljs-keyword">if</span> uid <span class="hljs-keyword">in</span> user_steps:
        <span class="hljs-keyword">return</span> user_steps[uid]
    <span class="hljs-keyword">else</span>:<font></font>
        known_users.append(uid)<font></font>
        user_steps[uid] = <span class="hljs-number">0</span>
        <span class="hljs-keyword">return</span> user_steps[uid]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># decorator for bot actions</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_action</span>(<span class="hljs-params">action</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorator</span>(<span class="hljs-params">func</span>):</span>
<span class="hljs-meta">        @wraps(func)</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_func</span>(<span class="hljs-params">message, *args, **kwargs</span>):</span><font></font>
            bot.send_chat_action(chat_id=message.chat.id, action=action)<font></font>
            <span class="hljs-keyword">return</span> func(message, *args, **kwargs)
        <span class="hljs-keyword">return</span> command_func
    <span class="hljs-keyword">return</span> decorator<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># decorator for save user activity</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_user_activity</span>():</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorator</span>(<span class="hljs-params">func</span>):</span>
<span class="hljs-meta">        @wraps(func)</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command_func</span>(<span class="hljs-params">message, *args, **kwargs</span>):</span><font></font>
            tga.statistics(message.chat.id, message.text)<font></font>
            <span class="hljs-keyword">return</span> func(message, *args, **kwargs)
        <span class="hljs-keyword">return</span> command_func
    <span class="hljs-keyword">return</span> decorator<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># start command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['start'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    markup = types.ReplyKeyboardMarkup(row_width=<span class="hljs-number">1</span>, resize_keyboard=<span class="hljs-literal">True</span>)<font></font>
    button_geo = types.KeyboardButton(text=<span class="hljs-string">'send location'</span>, request_location=<span class="hljs-literal">True</span>)<font></font>
    markup.add(button_geo)<font></font>
    bot.send_message(cid, <span class="hljs-string">'Hello, {0}, please choose command from the menu'</span>.format(message.chat.username),<font></font>
                     reply_markup=markup)<font></font>
    help_command_handler(message)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># country command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['country'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">country_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    user_steps[cid] = <span class="hljs-number">1</span>
    bot.send_message(cid, <span class="hljs-string">'{0}, write name of country please'</span>.format(message.chat.username))<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># geo command handler</span>
<span class="hljs-meta">@bot.message_handler(content_types=['location'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">geo_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    geo_result = country_service.get_country_information(message.location.latitude, message.location.longitude)<font></font>
    statistics = stats_service.get_statistics_by_country_name(geo_result[<span class="hljs-string">'countryName'</span>], message.chat.username)<font></font>
    user_steps[cid] = <span class="hljs-number">0</span>
    bot.send_message(cid, statistics, parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># country statistics command handler</span>
<span class="hljs-meta">@bot.message_handler(func=lambda message: get_user_step(message.chat.id) == 1)</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">country_statistics_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    country_name = message.text.strip()<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:<font></font>
        statistics = stats_service.get_statistics_by_country_name(country_name, message.chat.username)<font></font>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> e<font></font>
<font></font>
    user_steps[cid] = <span class="hljs-number">0</span>
    bot.send_message(cid, statistics, parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># query statistics command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['statistics'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">statistics_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    bot.send_message(cid, stats_service.get_statistics_of_users_queries(), parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># contacts command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['contacts'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">contacts_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/contacts.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
        template = Template(file.read())<font></font>
        bot.send_message(cid, template.render(user_name=message.chat.username), parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># help command handler</span>
<span class="hljs-meta">@bot.message_handler(commands=['help'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">help_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    help_text = <span class="hljs-string">'The following commands are available \n'</span>
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> commands:<font></font>
        help_text += <span class="hljs-string">'/'</span> + key + <span class="hljs-string">': '</span>
        help_text += commands[key] + <span class="hljs-string">'\n'</span>
    help_text += <span class="hljs-string">'ANTI_COVID_19_BOT speaks english, be careful and take care'</span><font></font>
    bot.send_message(cid, help_text)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># hi command handler</span>
<span class="hljs-meta">@bot.message_handler(func=lambda message: message.text.lower() == 'hi')</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hi_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/himydear.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
        template = Template(file.read())<font></font>
        bot.send_message(cid, template.render(user_name=message.chat.username), parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># default text messages and hidden statistics command handler</span>
<span class="hljs-meta">@bot.message_handler(func=lambda message: True, content_types=['text'])</span>
<span class="hljs-meta">@send_action('typing')</span>
<span class="hljs-meta">@save_user_activity()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default_command_handler</span>(<span class="hljs-params">message</span>):</span><font></font>
    cid = message.chat.id<font></font>
    <span class="hljs-keyword">if</span> message.text[:int(os.getenv(<span class="hljs-string">'PASS_CHAR_COUNT'</span>))] == os.getenv(<span class="hljs-string">'STAT_KEY'</span>):<font></font>
        st = message.text.split(<span class="hljs-string">' '</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">'txt'</span> <span class="hljs-keyword">in</span> st:<font></font>
            tga.analysis(st, cid)<font></font>
            <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'%s.txt'</span> % cid, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
                bot.send_document(cid, file)<font></font>
                tga.remove(cid)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            messages = tga.analysis(st, cid)<font></font>
            bot.send_message(cid, messages)<font></font>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">with</span> codecs.open(<span class="hljs-string">'templates/idunnocommand.html'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'UTF-8'</span>) <span class="hljs-keyword">as</span> file:<font></font>
            template = Template(file.read())<font></font>
            bot.send_message(cid, template.render(text_command=message.text), parse_mode=<span class="hljs-string">'HTML'</span>)<font></font>
<font></font>
<span class="hljs-comment"># application entry point</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    bot.polling(none_stop=<span class="hljs-literal">True</span>, interval=<span class="hljs-number">0</span>)
</code></pre><br>
</div>
                    </div><br>
<h2>   </h2><br>
<p>  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">   HTML</a>   ¬´templates¬ª        </p><br>
<br>
<h3>        </h3><br>
<ul>
<li>API_BOT_TOKEN ‚Äî  Telegram </li>
<li>COVID_STAT_API_TOKEN ‚Äî  API   </li>
<li>GEO_NAME_API_KEY ‚Äî  API   geonames</li>
<li>CONNECTION_STRING ‚Äî     </li>
<li>STAT_KEY ‚Äî        </li>
<li>DB_NAME ‚Äî   </li>
</ul><br>
<h3>    </h3><br>
<p>    Telegram           BotFather .          .      , ,    Botfather .   BotFather      , ,   .</p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> start, help</b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/7w/ze/fh/7wzefhzq6s-hrzull_i5cfxaycu.png"><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> statistics</b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/8a/tc/ca/8atccabez2rdnv4_k9bngvzvu90.png"><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> country</b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/vp/e7/jv/vpe7jvk2ss1c2n0owtqskb7vqpw.png"><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> contacts</b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/67/tz/fi/67tzfii281pqw_qenidrd3s9tnk.png"><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> send location</b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/at/fe/rq/atferqu9ly6d5jifomwzxfa18a8.png"><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">  </b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/25/v6/tm/25v6tmh0j7qalgnqa55j65h-ly4.png"><br>
</div>
                    </div><br>
<h3>Long polling  webhook </h3><br>
<p>            heroku,   :</p><br>
<ol>
<li>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> ‚ÄúHobby‚Äù</a>,            30   ,     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a></li>
<li>     Telegram  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">long polling</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">webhook</a> ,   ,     ,    HEROKU_URL</li>
</ol><br>
<pre><code class="python hljs"><span class="hljs-comment"># /setup.py</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># dependencies</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request<font></font>
<font></font>
<span class="hljs-comment"># set webhook</span><font></font>
server = Flask(__name__)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@server.route('/' + token, methods=['POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_message</span>():</span>
    bot.process_new_updates([telebot.types.Update.de_json(request.stream.read().decode(<span class="hljs-string">"utf-8"</span>))])
    <span class="hljs-keyword">return</span> <span class="hljs-string">"!"</span>, <span class="hljs-number">200</span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">@server.route("/")</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">web_hook</span>():</span><font></font>
    bot.remove_webhook()<font></font>
    bot.set_webhook(url=os.getenv(<span class="hljs-string">'HEROKU_URL'</span>) + token)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"!"</span>, <span class="hljs-number">200</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<font></font>
    server.run(host=<span class="hljs-string">"0.0.0.0"</span>, port=int(os.environ.get(<span class="hljs-string">'PORT'</span>, <span class="hljs-number">8443</span>)))
</code></pre><br>
<p>             ,      Docker ,     PAAS  Heroku, CI    Github  Heroku.</p><br>
<h2>   Docker </h2><br>
<p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Dockerfile</a>     . Dockerfile      .</p><br>
<pre><code class="bash hljs"><span class="hljs-comment">#         </span><font></font>
FROM python:3.7  <font></font>
<span class="hljs-comment">#      </span><font></font>
COPY /requirements.txt /app/requirements.txt <font></font>
<span class="hljs-comment">#   </span><font></font>
WORKDIR /app  <font></font>
<span class="hljs-comment">#         </span><font></font>
RUN pip install -r /app/requirements.txt<font></font>
<span class="hljs-comment">#         </span><font></font>
COPY . /app<font></font>
<span class="hljs-comment">#   </span><font></font>
CMD python /app/setup.py<font></font>
</code></pre><br>
<h2>   PAAS  Heroku</h2><br>
<p>       Heroku     .       ,  :</p><br>
<ul>
<li>      IDE  Heroku ,      ‚ÄúSettings‚Äù    ‚Äú<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Reveal config vars</a>‚Äù</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">addon    MongoDb</a>   ‚ÄúResources‚Äù,     MongoDb  ,   </li>
<li>  Heroku            ,           addon-</li>
</ul><br>
<p>   MongoDb    ,            (connection string)      .     Heroku,      Heroku         Docker  .</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> project_folder_name <span class="hljs-comment"># go to project folder</span>
heroku container:login <span class="hljs-comment"># login to Heroku</span>
Heroku apps <span class="hljs-comment"># see available apps and copy name to next command</span>
heroku container:push web --app anticovid19bot <span class="hljs-comment">#push docker image to Heroku</span>
heroku container:release web --app anticovid19bot <span class="hljs-comment">#release docker image to Heroku</span>
heroku logs --tail --app anticovid19bot <span class="hljs-comment"># see what‚Äôs going on (logs)</span>
</code></pre><br>
<br>
<p>    Heroku  ,    CI.</p><br>
<h2>CI    Github  Heroku</h2><br>
<p>  CI    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">heroku.yml</a>              .       docker ,   .</p><br>
<pre><code class="bash hljs">build:<font></font>
  docker:<font></font>
    web: Dockerfile<font></font>
</code></pre><br>
<p>   heroku.yml           Github.    heroku,       ‚ÄúDeploy‚Äù  Github ‚Äúconnect to github‚Äù           heroku           .</p><br>
<p>  ,            COVID-19 c      Telegram.</p><br>
<h2></h2><br>
<p>       ,  ,   .           ,       .</p><br>
<p> ,  10 000     ,         , 10 000 ,  ,   ?             ,  ‚Äú10000        ‚Äù     ,   ,   ,       ,        ,     ¬´  ¬ª.<br>
     ,    .</p><br>
<p>          ,                  Telegram,                   .</p><br>
<p>       .  !</p><br>
<h2>P.S...</h2><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>.</p><br>
<p>     -      .</p> <br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/_SQVG5VmJIk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496502/index.html">Utilitaire pour l'ombre humaine connectant des administrateurs non administrateurs √† des sessions utilisateur RDP dans WinServer 2012R2</a></li>
<li><a href="../fr496504/index.html">Robots collaboratifs Hanwha et leur utilisation dans la lutte contre les coronavirus</a></li>
<li><a href="../fr496510/index.html">Comment NE PAS devenir Game Designer</a></li>
<li><a href="../fr496512/index.html"># 05 - Et un octet entier ne suffit pas ... | Manga</a></li>
<li><a href="../fr496514/index.html">Tunnel VPN IPsec IPIP entre la machine Linux et Mikrotik derri√®re le fournisseur NAT</a></li>
<li><a href="../fr496518/index.html">Comment sommes-nous arriv√©s √† la t√©l√©commande</a></li>
<li><a href="../fr496528/index.html">La localisation d'un code QR est une t√¢che importante, sans raison, sans attention</a></li>
<li><a href="../fr496532/index.html">Nous v√©rifions nous-m√™mes: comment d√©ployer et administrer 1C: Flux de documents au sein de l'entreprise 1C</a></li>
<li><a href="../fr496536/index.html">DeepCode: vue lat√©rale</a></li>
<li><a href="../fr496538/index.html">Fractales en Python. Proc√©dure pas √† pas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>