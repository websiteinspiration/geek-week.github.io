<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∂üèº üåØ üè¢ PostgreSQL Adicionar restri√ß√µes n√£o nulas a tabelas grandes üë®‚Äçüé® üíÜ üë®üèº‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=", , , , , , . , , default .
 

 , , not null constraint . constraint PostgreSQL access exclusive lock , ; , null , . , not null constraint, .
 TL;DR:
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Adicionar restri√ß√µes n√£o nulas a tabelas grandes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/493954/"><img src="https://habrastorage.org/webt/cg/yk/a2/cgyka2ygs3frygp-3fh1h7hceeo.jpeg"><br>
<p><br>
 ,   ,   ,   ,    ,           ,     .           ,    ,    <code>default</code>   .</p><br>
<p>  ,           ,   <code>not null constraint</code>  .    <code>constraint</code> PostgreSQL  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>access exclusive lock</code></a>  ,           ;   ,       <code>null</code> ,      .      ,    <code>not null constraint</code>,            .</p><br>
<h4 id="tldr">TL;DR:</h4><br>
<ol>
<li> PostgreSQL 12+   <code>check constraint</code>  ,   ""   <code>not null constraint</code>   .</li>
<li>    ,        <code>pg_attribute</code> (     ).</li>
</ol><a name="habracut"></a><br>
<p><br>
PostgreSQL         .  8.2.0  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   </a>  <code>index concurrently</code>,  9.1.0   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  foreign constraints   not valid</a>    <code>validate</code>   <code>constraints</code>,     .       <code>not null constraint</code>   .     -  </p><br>
<pre><code class="sql hljs">... <span class="hljs-keyword">set</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">not</span> valid;</code></pre><br>
<p>,   <code>constraint</code>    .        <code>constraint</code>  ,   ,     <code>nulls</code>: </p><br>
<pre><code class="sql hljs">... <span class="hljs-keyword">set</span> not_null_but_dont_check_anything_because_i_checked_myself_i_swear;</code></pre><br>
<p> ,         PostgreSQL,   ,      .  ,      ,   ,       . ,  ,       ,       , ‚Äî     ?</p><br>
<p>,      ,     -  <code>not null</code>.</p><br>
<h4 id="1-just-do-it">1. Just do it!</h4><br>
<p>   ‚Äî ,      ,        24/7.  ,      <code>constraint</code>       ,      .</p><br>
<h4 id="2-just-dont-do-it">2. Just‚Ä¶ don't do it?</h4><br>
<p>   ,    ,      <code>not null constraint</code>       -   . , ,  <code>constraints</code>    ‚Äî     ,     .      ,     <code>not null</code>,   , ,          ,   : <code>unique constraints</code>, <code>not null constraints</code>, <code>foreign key constraints</code>, etc.</p><br>
<h4 id="3-proindeksiruyte-stolbec">3.  </h4><br>
<p><del>          <code>foreign key</code>,     .     <code>not null constraint</code>    ,      ,  <code>nulls</code>    .</del></p><br>
<p><del>,      ,   ,     <code>not null constraint</code>, ,      workaround. , ,    .</del></p><br>
<p><strong>Update: </strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Melkij</a>,   PostgreSQL,   ,     constraints  . ..      constraint  .</p><br>
<h4 id="4-dobavte-check-constraint-i-ogranichtes-etim">4.  check constraint   </h4><br>
<p>PostgreSQL     <code>not valid not null constraints</code>,      <code>not valid check constraints</code>.   : </p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> MY_AWESOME_TABLE <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> CHECK_MY_AWESOME_TABLE_ON_MY_SPLENDID_COLUMN <span class="hljs-keyword">check</span> (MY_SPLENDID_COLUMN <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>) <span class="hljs-keyword">not</span> valid;</code></pre><br>
<p>    </p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> MY_AWESOME_TABLE <span class="hljs-keyword">validate</span> <span class="hljs-keyword">constraint</span> CHECK_MY_AWESOME_TABLE_ON_MY_SPLENDID_COLUMN;</code></pre><br>
<p> : <code>not null constraint</code> !  <code>validate</code>   <code>share update exclusive lock</code>,           .</p><br>
<p>      ? -,        .  ,   <code>nullable</code>,   ‚Äî , ,  ,    .   ,       .   ,      , ,  ,   ,   ,     ,     .</p><br>
<p>-,  ,                ORM. ,  ,          <code>not null constraints</code>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CUBA Studio</a>,         ,        Java  .   Studio    <code>not null constraints</code>  <code>check constraints</code>,        JPA  <code>@NotNull</code>,      <code>nullable</code>,      SQL update ,       . , ,      ,      ,    ,         .</p><br>
<p>                    <code>not null constraints</code>,   <code>check constraints</code>     .  ,        <code>check constraints</code>   <code>not null constraints</code>,   PostgreSQL 12         .     .</p><br>
<h4 id="5-dobavte-check-constraint-no-ne-ogranichivaytes-etim">5.  check constraint,    </h4><br>
<p> PostgreSQL  12    :         <code>nulls</code>,   <code>constraint</code>  ,    <code>nulls</code> .       <code>DEBUG1</code>,      : "<em>existing constraints on column MY_AWESOME_TABLE.MY_SPLENDID_COLUMN are sufficient to prove that it does not contain nulls</em>".</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Release notes</a>     ,  release notes  ,        .</p><br>
<p>     PostgreSQL,     ,  <code>not null constraint</code>      .  <code>check constraint</code> ,     <code>nulls</code>,   -  ‚Äî .</p><br>
<h4 id="6-izmenite-sistemnuyu-tablicu-napryamuyu">6.    </h4><br>
<p>   <code>not null constraint</code>  PostgreSQL?   ,  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>pg_attribute</code></a>.           ,     , :  ,  ,   (      ),      ,  ..      <code>boolean</code>  <code>attnotnull</code>,     ,       <code>nulls</code>  .</p><br>
<p>     .</p><br>
<p>,                  .         (  ,  <code>foreign constraints</code>, etc.), , ,  -    :  "<code>alter table MY_AWESOME_TABLE add constraint ‚Ä¶</code>".       .        ,   SQL   .  , ,     <code>not null constraint</code>   <code>pg_attribute</code>,  ,     PostgreSQL     side-effect.</p><br>
<p>   <code>not null constraint</code>  ,    .  ,      <code>not null</code>    .  <code>check constraint</code>       ‚Äî   workarounds,     ,   PostgreSQL.     workarounds     ,    .</p><br>
<p> ,     :</p><br>
<pre><code class="sql hljs"><span class="hljs-comment">-- alter table MY_AWESOME_TABLE alter column MY_SPLENDID_COLUMN set not null ;</span>
<span class="hljs-keyword">do</span> $$
    <span class="hljs-keyword">begin</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">exists</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> <span class="hljs-keyword">from</span> MY_AWESOME_TABLE <span class="hljs-keyword">where</span> MY_SPLENDID_COLUMN <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>)) <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">raise</span> <span class="hljs-keyword">exception</span> <span class="hljs-string">'MY_AWESOME_TABLE.MY_SPLENDID_COLUMN contains null values'</span>;<font></font>
        else<font></font>
            <span class="hljs-keyword">update</span> PG_ATTRIBUTE <span class="hljs-keyword">set</span> ATTNOTNULL = <span class="hljs-literal">true</span>
                <span class="hljs-keyword">where</span> ATTRELID = (<span class="hljs-keyword">select</span> <span class="hljs-keyword">OID</span>  <span class="hljs-keyword">from</span> PG_CLASS <span class="hljs-keyword">where</span> RELNAME = <span class="hljs-keyword">lower</span>(<span class="hljs-string">'MY_AWESOME_TABLE'</span>))
                    <span class="hljs-keyword">and</span> ATTNAME = <span class="hljs-keyword">lower</span>(<span class="hljs-string">'MY_SPLENDID_COLUMN'</span>);
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;
    <span class="hljs-keyword">end</span> $$;</code></pre><br>
<p> <code>select exists</code>    .    <code>not null constraint</code>,     100%,   ,    , <code>null</code>     .</p><br>
<p>   .     ,     .</p><br>
<p> ,  ,     workaround <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     PostgreSQL</a>: "<em>It is possible to change this column to enable or disable the constraint.</em>"  10.12  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>.     ‚Äî  ,       ,   .   : "<em>docs: remove mention that attnotnull should be changed</em>".     -  "<em>because it's a bad practice</em>",  "<em>because I was asked by Tom to do it</em>",  "<em>because recent changes in the attribute cache made it unsafe to work with the table directly</em>",   "<em>just because I decided so</em>",     .  ,       ,      ,    ,      .   ,   ,      ,     .</p><br>
<p><strong>Update: </strong>      ,    ,         <code>attnotnull</code>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.postgresql.org/message-id/flat/20140724122945.GD16857%40alap3.anarazel.de</a>.</p><br>
<p>,       ?    : <code>constraint</code>    ,   -  <code>nulls</code>;  PostgreSQL     ,         .</p><br>
<p>   ‚Äî   .    <code>not null constraint</code>  ,   <code>nulls</code>. Select      ,  .  ,  <code>constraint</code>        <code>update/insert</code>,      .       <code>constraint</code>     ,   , ‚Äî  . ..,    ,    .  ,  -   .</p><br>
<p>,   ‚Äî ,    -  ,     .    ,     : <del>     </del>   .   :   ,     <code>not null constraint</code>;   ,   <code>attnotnull</code>,  ,   ; ,  / <code>pg_attribute</code>   (   ,        , - ?).</p><br>
<p>     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ATController</a>.   :     PostgreSQL  ;  ,     <code>permissions</code>  ,     ;   <code>pg_attribute</code>;   <code>check constraint</code>,   ,     <code>nulls</code>,     ,  ,  <code>nulls</code>   (,   <code>full table scan</code>     ).  ,   ,         .</p><br>
<p>,     ,   <code>attnotnull</code>,  ,  ,   <code>not null</code>   <code>nulls</code>.  ,    <code>update</code>  <code>insert</code>,     .       (logical replication),       .       SQL  ( pg_dump, ).        ,        .         ‚Äú  <code>update</code>  <code>insert</code>‚Äù.    : <code>attnotnull</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">slot_compile_deform</a>.  :        PostgreSQL   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JIT </a>.            (    ).       <code>attnotnull</code>.    <code>true</code>,   ,        <code>null</code>,     ,    . JIT    PostgreSQL 11       .  PostgreSQL 12 JIT     .</p><br>
<p> ,     ,   <code>attnotnull</code>             ,  .  <code>attnotnull = true</code>  ,    <code>null</code>,           ,          .</p><br>
<p>   .   .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CacheInvalidateHeapTuple</a>,       <code>pg_class, pg_attribute, pg_index</code>. ,   ,          .</p><br>
<p>,   ,   <code>not null constraint</code> ‚Äî    <code>attnotnull</code>   <code>pg_attribute</code>.    (     ) ‚Äî  .       ,  PostgreSQL        ,   ,     (  JIT ).</p><br>
<p> ,     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> (partitioning)</a>.     ,      <code>attnotnull</code>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ATController</a>  PostgreSQL.</p><br>
<h4 id="itog"></h4><br>
<p>     PostgreSQL 12+,     <code>check constraint</code>   ,     <code>not null constraint</code>  .            <code>nulls</code>  .</p><br>
<p>,    <code>not null constraint</code>            ,       <code>pg_attribute</code>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493942/index.html">V√≠rus b√°sico em 20 minutos ou por que voc√™ deve usar antiv√≠rus</a></li>
<li><a href="../pt493944/index.html">Continuamos analisando vulnerabilidades de comutadores industriais: executamos c√≥digo arbitr√°rio sem senha</a></li>
<li><a href="../pt493948/index.html">Como eu fiz um respirador KN95 em casa a partir de materiais improvisados. instru√ß√µes detalhadas</a></li>
<li><a href="../pt493950/index.html">Calculadora de rede neural para adicionar e subtrair n√∫meros n√£o muito grandes</a></li>
<li><a href="../pt493952/index.html">Como avaliar a intelig√™ncia? Abordagem do Google</a></li>
<li><a href="../pt493960/index.html">Configurando uma impressora de etiquetas XPrinter no Linux na esta√ß√£o de trabalho VMware</a></li>
<li><a href="../pt493964/index.html">Matem√°tica discreta no exame no ShAD</a></li>
<li><a href="../pt493966/index.html">Onde resolver problemas reais para candidatos a Yandex: treinamento em Codeforces e an√°lises</a></li>
<li><a href="../pt493968/index.html">GoToHome: isolar e programar</a></li>
<li><a href="../pt493970/index.html">V√≠deo para empresas: como atrair o p√∫blico-alvo e n√£o assustar por acidente. 11 erros de mensagens de v√≠deo assassinos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>