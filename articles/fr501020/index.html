<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏽 🎇 🛌🏻 Comment tester le code contenant setTimeout / setInterval sous le capot ✊🏻 🤴🏾 😢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous, les développeurs, aimons beaucoup les tests unitaires, dont l'utilité est évidente. Et pour que ces tests soient vraiment utiles, et n'apportent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment tester le code contenant setTimeout / setInterval sous le capot</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/501020/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous, les développeurs, aimons beaucoup les tests unitaires, dont l'utilité est évidente. </font><font style="vertical-align: inherit;">Et pour que ces tests soient vraiment utiles, et n'apportent pas de douleur, il faut s'assurer de leur stabilité.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre société développe le cadre d'interface </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wasaby</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et vend des produits construits sur sa base, qui sont des applications cloud et de bureau. Le cycle de sortie est étroitement lié au calendrier et des processus d'intégration continue sont mis en place pour contrôler la qualité du produit. Nous utilisons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenkins</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour les assemblages et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mocha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en conjonction avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chai assert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le test unitaire du code JavaScript. </font><font style="vertical-align: inherit;">Et récemment, nous avons été confrontés à une situation où la surveillance de l'assemblage a commencé à montrer qu'environ la moitié de tous les cas de leur chute étaient dus à des tests unitaires JavaScript instables. </font><font style="vertical-align: inherit;">Les symptômes sont les mêmes: un test distinct de l'ensemble n'a pas le temps de s'exécuter ou renvoie le mauvais résultat comme prévu. </font><font style="vertical-align: inherit;">Et l'analyse des cas révèle presque toujours le fait qu'un test contenant des appels aux fonctions </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setTimeout</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setInterval</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en soi ou dans le code testé </font><font style="vertical-align: inherit;">plante </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sur ce qu'il faut faire dans cette situation, nous parlerons plus loin.</font></font></p><a name="habracut"></a><br>
<h2 id="pochemu-tak-proishodit"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi ça arrive?</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout est simple - à l'intérieur du code que le développeur teste, un appel asynchrone se produit, à la fin duquel l'état de l'environnement change en quelque sorte. </font><font style="vertical-align: inherit;">Et le test est conçu pour vérifier que cette condition est conforme aux attentes. </font><font style="vertical-align: inherit;">Mais depuis </font><font style="vertical-align: inherit;">Comme nous ne vivons pas dans un monde idéal, il arrive qu'un test soit écrit pour du code qui fonctionne déjà au combat et qui n'a pas été initialement préparé pour ce type de test. </font><font style="vertical-align: inherit;">Et le développeur doit décider comment il peut tester un tel code.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prenons un exemple simple, le code testé est une méthode de classe qui modifie de manière asynchrone l'état d'une instance. </font><font style="vertical-align: inherit;">Et ce n'est pas écrit parfaitement:</font></font></p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;<font></font>
  methodToTest(): <span class="hljs-keyword">void</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.propToTest = <span class="hljs-literal">true</span>;<font></font>
    }, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br>
<p>   ?        ,         <em>setTimeout</em>  .   c ,      (, 101   100 ).     :</p><br>
<pre><code class="javascript hljs">it(<span class="hljs-string">'should set propToTest to true'</span>, (done: <span class="hljs-built_in">Function</span>) =&gt; {
  <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> Foo();<font></font>
  inst.methodToTest();<font></font>
  setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    assert.isTrue(inst.propToTest);<font></font>
    done();<font></font>
  }, <span class="hljs-number">101</span>);<font></font>
});</code></pre><br>
<p>     ?  ,     , ..   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>,  <em>callback</em>,   <em>setTimeout</em>,       .   —  ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  2 </a>,     .         ,    .             -,    .  , ,   -       ,     —         -.<br>
         <em>setInterval</em>.</p><br>
<h2 id="kak-ne-nado-pytatsya-ispravit-situaciyu">     </h2><br>
<p>     ,   .           ,      .  ,      ,    .</p><br>
<ol>
<li>     callback-  ,       <em>setTimeout/setInterval</em> (<em>"   1001  101,    "</em>).   .</li>
<li>      setTimeout()   (<em>"       event loop,    "</em>).    .</li>
<li>(       1  2)    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a> —        ,         ,      .</li>
</ol><br>
<h2 id="kak-zhe-napisat-test-horosho">    ?</h2><br>
<p>  ,     ,       .    ,    ,     :       .        .</p><br>
<ol>
<li><p>        — ..     .<br>
    ,   ,   :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setProperState</span>(<span class="hljs-params">inst: Foo</span>) </span>{<font></font>
  inst.propToTest = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;<font></font>
  methodToTest(): <span class="hljs-keyword">void</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
      setProperState(<span class="hljs-keyword">this</span>);<font></font>
    }, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br>
<p>  :</p><br>
<pre><code class="javascript hljs">it(<span class="hljs-string">'should set propToTest to true'</span>, () =&gt; {
  <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> Foo();<font></font>
  assert.isFalse(inst.propToTest);<font></font>
  setProperState(inst);<font></font>
  assert.isTrue(inst.propToTest);<font></font>
});</code></pre><br>
<p>    ,       <em>setProperState</em>  <em>methodToTest</em> (        ).      ,     :    ,    . ,     ,    .</p><br>
</li>
<li><p>    ,    ,   .<br>
,      <em>setTimeout</em>  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">constructor</span>(readonly awaiter: Function = setTimeout) {<font></font>
  }<font></font>
  methodToTest(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">this</span>.awaiter(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.propToTest = <span class="hljs-literal">true</span>;<font></font>
    }, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br>
<p>      -,   :</p><br>
<pre><code class="javascript hljs">it(<span class="hljs-string">'should set propToTest to true'</span>, () =&gt; {
  <span class="hljs-keyword">const</span> awaiter = <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> callback();
  <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> Foo(awaiter);<font></font>
  inst.methodToTest();<font></font>
  assert.isTrue(inst.propToTest);<font></font>
});</code></pre><br>
</li>
<li><p> ,   <em>Promise</em>.<br>
     ,     —         ,     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>.      .     :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;<font></font>
  methodToTest(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {<font></font>
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.propToTest = <span class="hljs-literal">true</span>;<font></font>
        resolve();<font></font>
      }, <span class="hljs-number">100</span>);<font></font>
     });<font></font>
  }<font></font>
}</code></pre><br>
<p>     <em>setTimeout</em>:</p><br>
<pre><code class="javascript hljs">it(<span class="hljs-string">'should set propToTest to true'</span>, () =&gt; {
  <span class="hljs-keyword">const</span> inst = newFoo();
  <span class="hljs-keyword">return</span> inst.methodToTest().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    assert.isTrue(inst.propToTest);<font></font>
  });<font></font>
});</code></pre><br>
<p>,              ,    ,  "   ".          <em>setTimeout</em>    , .</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">constructor</span>(readonly asyncTimeout: number = 100) {<font></font>
  }<font></font>
  methodToTest(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {<font></font>
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.propToTest = <span class="hljs-literal">true</span>;<font></font>
        resolve();<font></font>
      }, <span class="hljs-keyword">this</span>.asyncTimeout);<font></font>
     });<font></font>
  }<font></font>
}</code></pre><br>
<p>         .</p><br>
</li>
<li><p> fake timers.<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sinon.JS</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    </a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    </a>.       -      ( ),     <em>setTimeout</em>  .<br>
      :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
  <span class="hljs-attr">propToTest</span>: boolean = <span class="hljs-literal">false</span>;<font></font>
  methodToTest(): <span class="hljs-keyword">void</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.propToTest = <span class="hljs-literal">true</span>;<font></font>
    }, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br>
<p>    fake timer,     (!):</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> clock;<font></font>
<font></font>
beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
  clock = sinon.useFakeTimers();<font></font>
});<font></font>
<font></font>
afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
  clock.restore();<font></font>
});<font></font>
<font></font>
it(<span class="hljs-string">'should set propToTest to true'</span>, () =&gt; {
  <span class="hljs-keyword">const</span> inst = newFoo();<font></font>
  inst.methodToTest();<font></font>
  clock.tick(<span class="hljs-number">101</span>);<font></font>
  assert.isTrue(inst.propToTest);<font></font>
});</code></pre><br>
<p>        " "   <em>clock.restore()</em>,     .</p><br>
</li>
</ol><br>
<h2 id="moral"></h2><br>
<p>-   ,       .      - ,        .   ,        ,        .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501008/index.html">Pavage Dominos</a></li>
<li><a href="../fr501010/index.html">Linux Kernel TLS et Nginx</a></li>
<li><a href="../fr501012/index.html">Comment je cherchais un moteur enfant pour un blog</a></li>
<li><a href="../fr501016/index.html">Sur les tendances de développement de l'architecture de processeur, ou pourquoi je crois au succès de Huawei sur le marché des serveurs</a></li>
<li><a href="../fr501018/index.html">Comment contourner certaines restrictions de Google Translate</a></li>
<li><a href="../fr501022/index.html">«Je suis dans le désert»: pourquoi l'auto-isolement s'est avéré être un sérieux stress pour nous et ce que tout cela a entraîné</a></li>
<li><a href="../fr501026/index.html">Identification bancaire à distance: du complexe au simple, ou aux banques, pourquoi avez-vous besoin de la biométrie?</a></li>
<li><a href="../fr501030/index.html">Démo d'analyse de code Second Reality</a></li>
<li><a href="../fr501032/index.html">Serveur bon marché des pièces chinoises. Partie 1, fer</a></li>
<li><a href="../fr501034/index.html">Séminaires hebdomadaires IBM - mai 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>