<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>тЬНЁЯП╛ ЁЯд╣ЁЯП╛ ЁЯТИ рдЗрд╕реЗ рдПрдХреАрдХреГрдд рдХрд░реЗрдВ: рд▓реИрдореЛрдбрд╛ рдЕрдкрдиреА рдЧреЛ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдХреИрд╕реЗ рд╕реБрд╕рдВрдЧрдд рдмрдирд╛рддрд╛ рд╣реИ ЁЯС▓ЁЯП╜ ЁЯзФЁЯП╗ ЁЯТО</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╣рдо microservice рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдХрд╛ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рдо рдЗрд╕реЗ рдПрдХ рд░рд╛рдордмрд╛рдг рдирд╣реАрдВ рдорд╛рдирддреЗ рд╣реИрдВ, рдФрд░ 2 рд╕рд╛рд▓ рд╕реЗ рдЕрдзрд┐рдХ рдкрд╣рд▓реЗ рд╣рдордиреЗ рдЧреЛ рднрд╛рд╖рд╛ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд┐рдп...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>рдЗрд╕реЗ рдПрдХреАрдХреГрдд рдХрд░реЗрдВ: рд▓реИрдореЛрдбрд╛ рдЕрдкрдиреА рдЧреЛ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдХреИрд╕реЗ рд╕реБрд╕рдВрдЧрдд рдмрдирд╛рддрд╛ рд╣реИ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/495344/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо microservice рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдХрд╛ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рдо рдЗрд╕реЗ рдПрдХ рд░рд╛рдордмрд╛рдг рдирд╣реАрдВ рдорд╛рдирддреЗ рд╣реИрдВ, рдФрд░ 2 рд╕рд╛рд▓ рд╕реЗ рдЕрдзрд┐рдХ рдкрд╣рд▓реЗ рд╣рдордиреЗ рдЧреЛ рднрд╛рд╖рд╛ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдерд╛ред </font><font style="vertical-align: inherit;">рдпрд╣ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рд╕рд░рд▓ рд╣реИ рдФрд░, рдореЗрд░реА рд░рд╛рдп рдореЗрдВ, рд╕рд░рд▓, рдЫреЛрдЯреЗ рдФрд░ рддреЗрдЬ рдорд╛рдЗрдХреНрд░реЛрд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдЕрдиреБрдХреВрд▓ рд╣реИред </font><font style="vertical-align: inherit;">рдЗрд╕ рд╕рд╛рджрдЧреА рдХрд╛ рдПрдХ рдирдХрд╛рд░рд╛рддреНрдордХ рдкрд╣рд▓реВ рд╣реИ: рдЗрд╕рдХреА рд╡рдЬрд╣ рд╕реЗ, рдПрдХ рд╣реА рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рд╣реИрдВред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ, рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡рдХ рдкрдбрд╝реЛрд╕реА рдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рджреВрд╕рд░реЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡реЗрд░реНрд╕ рд╕реЗ рдХрд┐рддрдирд╛ рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ? </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдЯреАрдо Go 1.9, рдЧреНрд▓рд╛рдЗрдб, рдорд╛рдирдХ рдбреЗрдЯрд╛рдмреЗрд╕ / sql рдФрд░ рдПрдХ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ, рдЬрдмрдХрд┐ рджреВрд╕рд░реА рдЯреАрдо Go 1.13, рдореЙрдбреНрдпреВрд▓, sqlx рдФрд░, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдПрдХ рдЕрдиреНрдп рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬрдм рдХрд┐рд╕реА рдХрдВрдкрдиреА рдореЗрдВ рдПрдХ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡рдХ рджреВрд╕рд░реЗ рд╕реЗ рдЕрд▓рдЧ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рдмрджрд▓реЗ рдореЗрдВ, рдПрдХ рддрд┐рд╣рд╛рдИ рд╕реЗ рдЕрд▓рдЧ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╡рд┐рдХрд╛рд╕ рдХреЛ рдзреАрдорд╛ рдХрд░ рджреЗрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдФрд░ рдзреАрдорд╛ рд╡рд┐рдХрд╛рд╕ </font><font style="vertical-align: inherit;">рдЕрдиреБрдХреВрд▓рди рдХреЗ рд▓рд┐рдП </font><font style="vertical-align: inherit;">рдПрдХ </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдиреБрдХрд╕рд╛рди</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣реИред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореЗрд░рд╛ рдирд╛рдо рдПрд▓реЗрдХреНрд╕реА рдкрд╛рд░реНрдЯрд┐рд▓реЛрд╡ рд╣реИ, рдореИрдВ рд▓рдореЛрдбрд╛ рдореЗрдВ рдПрдХ рд╡реЗрдм рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рдЯреАрдо рдХрд╛ рддрдХрдиреАрдХреА рдиреЗрддрд╛ рд╣реВрдВред </font><font style="vertical-align: inherit;">рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рд╣рдо рдЧреЛ рдкрд░ рдЕрдкрдиреЗ рд▓рдЧрднрдЧ 40 рдорд╛рдЗрдХреНрд░реЛрд╕рд░реНрд╡рд┐рд╕ рдХреА рдкрд░рд┐рд╡рд░реНрддрдирд╢реАрд▓рддрд╛ рд╕реЗ рдХреИрд╕реЗ рдирд┐рдкрдЯрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдпрд╣ рд▓реЗрдЦ рдЙрди рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧрд╛ рдЬреЛ рд╕рд┐рд░реНрдл рдЧреЛ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдпрд╣ рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣реЗрд▓реЛрд╡рд░реНрд▓реНрдб рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╣рд╛рдВ рд╢реБрд░реВ рдХрд░рдиреА рд╣реИред</font></font></p><br>
<p><img src="https://habrastorage.org/webt/ab/rl/nw/abrlnwefv_ym93hmomlfzhhslrc.png" alt="рдЫрд╡рд┐"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╢реБрд░реБрдЖрдд рдореЗрдВ, рд▓рдореЛрдбрд╛ рдиреЗ рдкреАрдПрдЪрдкреА рдореЗрдВ рдПрдХрд▓ рдмреЙрдХреНрд╕рд┐рдВрдЧ рдореЛрдиреЛрд▓рд┐рде рдкрд░ рдХрд╛рдо рдХрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рдлрд┐рд░ рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдирдИ рдкрд╛рдпрдерди рдФрд░ рдкреАрдПрдЪрдкреА рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рдЬрд╛рдирд╛ рд╢реБрд░реВ рд╣реБрдЖред </font><font style="vertical-align: inherit;">рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рдмрдбрд╝реЗ рдФрд░ рдЬрдЯрд┐рд▓ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рддрд░реНрдХ рдХреЗ рд╕рд╛рде PHP рдореЗрдВ рдореЛрдиреЛрд▓рд┐рде рд╣реИрдВред </font><font style="vertical-align: inherit;">рдпреЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╣рдорд╛рд░реА рдкрд░рд┐рдЪрд╛рд▓рди рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЗ рд╕реНрд╡рдЪрд╛рд▓рди рдореЗрдВ рд▓рдЧреЗ рд╣реБрдП рд╣реИрдВ: рд╡рд┐рддрд░рдг, рдлреЛрдЯреЛ рд╕реНрдЯреВрдбрд┐рдпреЛ, рд╕рдВрдмрджреНрдз рд╕реЗрд╡рд╛ред </font><font style="vertical-align: inherit;">рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЬрд╛рд╡рд╛ рдореЗрдВ рдПрдХ рдореЛрдиреЛрд▓рд┐рде рднреА рд╣реИ, рдЬреЛ рдЧреЛрджрд╛рдо рдореЗрдВ рдХрдИ рдЬрдЯрд┐рд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИред</font></font></p><br>
<p>       ,       ,         . </p><br>
<p> e-commerce          Python     Golang. ,      UI    Python+Django.</p><br>
<p>       ,        .      . </p><br>
<p>    ,           .  backend-   ,     ,    ,      ,    .</p><br>
<p>              .</p><br>
<h1>0. Spec first</h1><br>
<p>      ,  : <i>          ,      OpenAPI.</i></p><br>
<p>    :</p><br>
<ul>
<li>Backend-,   ,     -     .        .</li>
<li>Frontend-    backend,     .     mock     backend       .</li>
<li>     boilerplate- c  ,     . ,   ,    ,    .</li>
</ul><br>
<p>     OpenAPI-    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> go-swagger </a>(    gogi).      opensource,    ,            .</p><br>
<blockquote>  ,          .  ,      ,    ,      . <br>
</blockquote><p>     ,    docker-.   ,           .      docker.        Makefile: </p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">.PHONY: generate<font></font>
generate:<font></font>
    #    <font></font>
    rm -rf internal/generated/*<font></font>
    docker run -it \<font></font>
    #     <font></font>
    -v $(PWD)/internal/generated:$(DOCKER_SOURCE_DIR)/internal/generated \<font></font>
    #    OpenAPI <font></font>
    -v $(PWD)/specs:$(DOCKER_SOURCE_DIR)/specs \<font></font>
    #    gogi<font></font>
    -v $(PWD)/gogi.yaml:$(DOCKER_SOURCE_DIR)/gogi.yaml \<font></font>
    #  workdir<font></font>
    -w="$(DOCKER_SOURCE_DIR)" \<font></font>
    gotools.docker.lamoda.ru/gogi:v1.3.2 generate</code></pre></div></div><br>
<h1>1.  </h1><br>
<p>          .        ,  ,    .          ,    -.    тАФ ,      :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">/<font></font>
тФЬтФАтФА cmd<font></font>
тФЬтФАтФА deployments<font></font>
тФЬтФАтФА internal<font></font>
тФЬтФАтФА migrations<font></font>
тФЬтФАтФА specs<font></font>
тФЬтФАтФА tests<font></font>
тФЬтФАтФА go.mod<font></font>
тФЬтФАтФА go.sum<font></font>
тФЬтФАтФА Dockerfile<font></font>
тФЬтФАтФА main.go<font></font>
...</code></pre></div></div><br>
<p>                .</p><br>
<p>    ,       (    Postgres),     production-, Kafka     API.    ?  .          .</p><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">cookiecutter.</a>             .            .      ,     .</p><br>
<h1>2. Go modules</h1><br>
<p>   1.11   Go         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">go modules</a>.   1.14    production-ready.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">glide</a>,          go modules, , ,    Go-. Go modules        $GOPATH/pkg/mod        GOPATH. </p><br>
<p>     Go       (build, get, test). , build          .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> </a>.</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">  golang</a>     ,     ,        .        ,   .</p><br>
<p><b> 1.  go modules</b>.       Go   1.13,    $GOPATH,     go mod</p><br>
<pre><code class="bash hljs">go env -w GOMODULE111=<span class="hljs-string">"on"</span></code></pre><br>
<p><b>2.  RSA-   .</b>       RSA- c ,   ,      ssh-agent.         .</p><br>
<pre><code class="bash hljs">ssh-add &lt;  RSA &gt;</code></pre><br>
<p><b>3.    Go proxy. </b>   Go 1.13,       - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">proxy.golang.org</a>,      .    ,       .</p><br>
<pre><code class="bash hljs">go env -w GOPRIVATE=&lt;  &gt;</code></pre><br>
<p><b>4.  go.mod-.</b>       go.mod    .         (, <i>glide</i>),   mod-     lock-.      go.mod тАФ ,     .</p><br>
<pre><code class="bash hljs">go mod init &lt;  &gt;</code></pre><br>
<p>        ,   , , <i>github.com/spf13/cobra</i>.</p><br>
<p><b>5.  .</b>       .     ,  , ,  .     ,    .</p><br>
<pre><code class="bash hljs">go <span class="hljs-built_in">test</span> ./...</code></pre><br>
<h1>3.  Docker-</h1><br>
<p> Lamoda         Kubernetes-,    Docker-   .  ,   Go-    Docker- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">golang.</a>       c       Docker-.       Docker-     ,   .</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">ARG version<font></font>
FROM golang:$version<font></font>
<font></font>
ENV GOOS linux<font></font>
ENV GOARCH amd64<font></font>
ENV CGO_ENABLED 0<font></font>
ENV GO111MODULE on<font></font>
<font></font>
#      <font></font>
RUN go get github.com/axw/gocov/gocov &amp;&amp; \<font></font>
   go get github.com/AlekSi/gocov-xml@d2f6da892a0d5e0b587526abf51349ad654ade51 &amp;&amp; \<font></font>
   go get golang.org/x/tools/cmd/goimports &amp;&amp; \<font></font>
   curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh -s v1.23.7 &amp;&amp; \<font></font>
   go get -u github.com/jstemmer/go-junit-report@af01ea7f8024089b458d804d5cdf190f962a9a0c &amp;&amp; \<font></font>
   rm -rf /go/pkg/mod/<font></font>
<font></font>
#            <font></font>
COPY ./ssh/id_rsa /root/.ssh/id_rsa<font></font>
COPY ./ssh/id_rsa.pub /root/.ssh/id_rsa.pub<font></font>
# Copy Lamoda Root certificate needed to go to the corporate sites without<font></font>
# SSL warning<font></font>
COPY ./certs/LamodaCA.crt /usr/local/share/ca-certificates/LamodaCA.crt<font></font>
<font></font>
RUN echo "StrictHostKeyChecking no" &gt; /root/.ssh/config &amp;&amp; \<font></font>
   chmod 600 /root/.ssh/id_rsa &amp;&amp; \<font></font>
   chmod 600 /root/.ssh/id_rsa.pub &amp;&amp; \<font></font>
   chmod 755 /root/.ssh &amp;&amp; \<font></font>
   update-ca-certificates &amp;&amp; \<font></font>
   #   insteadOf.       Bitbucket  .<font></font>
   git config --global url.ssh://git@stash.lamoda.ru:7999.insteadOf https://stash.lamoda.ru/scm<font></font>
<font></font>
CMD ["/bin/sh"]</code></pre></div></div><br>
<p>   golang-     .      golang    production-.   ,       (    )        :   debian  alpine,  go,  .      Docker-    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Docker multistage</a>. </p><br>
<p>, Docker multistage тАФ     Docker,        ,         ,      ,    .. </p><br>
<p>      : </p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">FROM gotools.docker.lamoda.ru/base-mod:1.14.0 as build<font></font>
<font></font>
ENV GOOS linux<font></font>
ENV GOARCH amd64<font></font>
ENV CGO_ENABLED 0<font></font>
ENV GO111MODULE on<font></font>
<font></font>
WORKDIR /go/src/stash.lamoda.ru/ecom/discounts.endpoint<font></font>
#     <font></font>
COPY go.mod .<font></font>
COPY go.sum .<font></font>
<font></font>
#  go-. -    Docker          go.mod  go.sum.<font></font>
RUN go mod download<font></font>
COPY . .<font></font>
<font></font>
RUN make build<font></font>
<font></font>
#   docker        ca-certificates.crt<font></font>
FROM scratch<font></font>
COPY --from=build /go/src/stash.lamoda.ru/ecom/discounts.endpoint/discounts /bin/discounts<font></font>
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt<font></font>
ENTRYPOINT ["/bin/discounts"]</code></pre></div></div><br>
<h1>4.  </h1><br>
<p>       ,  , Postgres.    ,      . ,        DBA,   .         .    ,        .     SQL-       DBA  DevOps    production . </p><br>
<p>    -  Jira,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">migrate</a>.       ,      . ,  , migrate    Docker- тАФ        . </p><br>
<p>     тАФ   migrations     <i>&lt;тДЦ &gt;_&lt;&gt;.[up|down].sql</i></p><br>
<pre><code class="plaintext hljs">migrations<font></font>
тФЬтФАтФА 00001_init.down.sql<font></font>
тФЬтФАтФА 00001_init.up.sql<font></font>
тФЬтФАтФА 00002_create_ui_users_table.down.sql<font></font>
тФЬтФАтФА 00002_create_ui_users_table.up.sql<font></font>
...</code></pre><br>
<p><i>up</i> тАФ  , ..  ,<br>
<i>down </i>тАФ  , ..  . </p><br>
<p>      SQL-,   .</p><br>
<p>  ┬л┬╗:</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SEQUENCE</span> ui_users_id_seq <span class="hljs-keyword">INCREMENT</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">MINVALUE</span> <span class="hljs-number">1</span> <span class="hljs-keyword">START</span> <span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> ui_users (
  <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  username <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">180</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  username_canonical <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">180</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">180</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  email_canonical <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">180</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  enabled <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-keyword">salt</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
  <span class="hljs-keyword">password</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  last_login <span class="hljs-built_in">TIMESTAMP</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">WITHOUT</span> <span class="hljs-built_in">TIME</span> ZONE <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<font></font>
  confirmation_token <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">180</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<font></font>
  password_requested_at <span class="hljs-built_in">TIMESTAMP</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">WITHOUT</span> <span class="hljs-built_in">TIME</span> ZONE <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-keyword">roles</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  PRIMARY <span class="hljs-keyword">KEY</span>(<span class="hljs-keyword">id</span>)<font></font>
);<font></font>
<span class="hljs-keyword">COMMIT</span>;</code></pre></div></div><br>
<p>  ┬л┬╗:</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">SEQUENCE</span> public.ui_users_id_seq;<font></font>
<font></font>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> ui_users;
<span class="hljs-keyword">COMMIT</span>;</code></pre></div></div><br>
<p>  ,       :</p><br>
<pre><code class="bash hljs">migrate -database <span class="hljs-variable">${DB_DSN}</span> -path db/migrations up</code></pre><br>
<p>     :</p><br>
<pre><code class="bash hljs">migrate create -ext sql -dir migrations -seq create_table_foo</code></pre><br>
<p>     , , .         :      .  ,   ,     .     migrate  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="></a>.</p><br>
<h1>5.  development-</h1><br>
<p> Lamoda  ,    ,      .   /          ,     . ,    Postgres      .        Postgres     .       /   development ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Docker Compose</a>.</p><br>
<p>Compose       development  . ,            :</p><br>
<ol>
<li>   Postgres,</li>
<li> migrate,       Postgres,</li>
<li>  dev- .</li>
</ol><br>
<p>    . ,        .    ,     ,     . </p><br>
<p>  Docker-compose     :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">version: "3.7"<font></font>
services:<font></font>
  #   dev- <font></font>
  gift-certificates-dev:<font></font>
    container_name: gift-certificates-dev<font></font>
    #       ,    pull  docker-<font></font>
    build:<font></font>
      context: ../<font></font>
      #    Dockerfile  multistage,       <font></font>
      #  .          ,<font></font>
      #             <font></font>
      #    go run.<font></font>
      target: build<font></font>
    #     environment  .<font></font>
    env_file:<font></font>
      - local.env<font></font>
    #   <font></font>
    depends_on:<font></font>
      - gift-certificates-db<font></font>
    #       .     <font></font>
    #   go run<font></font>
    volumes:<font></font>
      - "..:/app/"<font></font>
    working_dir: "/app"<font></font>
    #    <font></font>
    command: "go run main.go"<font></font>
    depends_on:<font></font>
      - gift-certificates-db<font></font>
  #    Postgres<font></font>
  gift-certificates-db:<font></font>
    container_name: gift-certificates-db<font></font>
    image: postgres:11.4<font></font>
    #      <font></font>
    #      env_file,    default.env<font></font>
    #   ,       <font></font>
    environment:<font></font>
      - POSTGRES_DB=gift_certificates<font></font>
      - POSTGRES_USER=gift_certificates<font></font>
      - POSTGRES_PASSWORD=gift_certificates<font></font>
      - POSTGRES_PORT=5432<font></font>
    #     docker <font></font>
    #  , ,          docker <font></font>
    ports:<font></font>
      - 6543:5432<font></font>
  #     <font></font>
  gift-certificates-migrate:<font></font>
    container_name: gift-certificates-migrate<font></font>
    image: "migrate/migrate:v4.4.0"<font></font>
    depends_on:<font></font>
      - gift-certificates-db<font></font>
    volumes:<font></font>
      - "../migrations:/migrations"<font></font>
    command: ["-path", "/migrations/", "-database", "$SERVICE_DB_DSN", "up"]</code></pre></div></div><br>
<p>   Docker-compose  Makefile     :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">#   <font></font>
#          <font></font>
.PHONY: test<font></font>
test: dev-migrate<font></font>
    go test -cover -coverprofile=coverage.out ./...<font></font>
    go tool cover -html=coverage.out -o coverage.html<font></font>
<font></font>
#   dev <font></font>
.PHONY: dev-server<font></font>
dev-server:<font></font>
    docker-compose -f deployments/docker-compose.yaml up -d gift-certificates-dev<font></font>
<font></font>
#       <font></font>
.PHONY: dev-migrate<font></font>
dev-migrate:<font></font>
    docker-compose -f deployments/docker-compose.yaml run --rm --service-ports gift-certificates-migrate<font></font>
<font></font>
#   dev <font></font>
.PHONY: dev-down<font></font>
dev-down:<font></font>
    docker-compose -f deployments/docker-compose.yaml down</code></pre></div></div><br>
<h1>6. </h1><br>
<p>  Go   gofmt,      ,       : goimports, go-critic, gocyclo  ..     ,    IDE  CI     .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">golangci-lint,</a>        Go .     ,            -. </p><br>
<p>     ,      ┬л┬╗.       ,     ,      ┬л┬╗ ,       .</p><br>
<p>  :</p><br>
<pre><code class="bash hljs">curl -sfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh| sh -s -- -b $(go env GOPATH)/bin v1.23.7</code></pre><br>
<p>  :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">run:<font></font>
  tests: false<font></font>
  #         <font></font>
  skip-dirs:<font></font>
    - generated<font></font>
  skip-files:<font></font>
    - ".*easyjson\\.go$"<font></font>
output:<font></font>
  print-issued-lines: false<font></font>
<font></font>
issues:<font></font>
  #      <font></font>
  new-from-rev: 7cdb5ce7d7ebb62a256cebf5460356c296dceb3d<font></font>
  exclude-rules:<font></font>
    - path: internal/common/writer.go<font></font>
      linters:<font></font>
        - structcheck<font></font>
      #       <font></font>
      text: "`size` is unused"</code></pre></div></div><br>
<p>:</p><br>
<pre><code class="bash hljs">golangci-lint run ./...</code></pre><br>
<p>    <i>golangci-lint</i>    pre-commit,    .</p><br>
<h1>7. Pre-commit hookтАЩ</h1><br>
<p>   Pull Request      : ,   / ,    .       bash-     git pre-commit .       ,      -.    :            . </p><br>
<p>    python  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">pre-commit</a>:</p><br>
<ul>
<li>  :</li>
</ul><br>
<pre><code class="bash hljs">pip install pre-commit</code></pre><br>
<p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> </a>.</p><br>
<ul>
<li> -.     go:</li>
</ul><br>
<pre><code class="plaintext hljs">repos:<font></font>
- repo: https://github.com/golangci/golangci-lint<font></font>
  rev: v1.23.7<font></font>
  hooks:<font></font>
  - id: golangci-lint</code></pre><br>
<ul>
<li>     git pre-commit hook':</li>
</ul><br>
<pre><code class="bash hljs">pre-commit install</code></pre><br>
<p>  golangci-lint           .    hook' .  all-files      ,       staging'e:</p><br>
<pre><code class="bash hljs">pre-commit run --all-files</code></pre><br>
<p>   hook'       test runner'.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">https://pre-commit.com</a></p><br>
<h1>8.  </h1><br>
<p>Gonkey тАФ    ,   Lamoda.  ,      .   ,   Gonkey,            habr.ru <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">тАЬGonkey тАФ   тАЭ. </a></p><br>
<p>Gonkey :</p><br>
<ul>
<li>  HTTP-  ,     ,</li>
<li>    ,      (   YAML-),</li>
<li>       (  ,   Gonkey   ),</li>
<li>       Allure-.</li>
</ul><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">GitHub.</a></p><br>
<h1>9.   </h1><br>
<p>         ,  ┬л┬╗ .    :  ,    ,   ,      . </p><br>
<p>,         Confluence   .    ,      ┬л ┬╗.          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="> cookiecutter.</a></p><br>
<p> , cookiecutter тАФ  python-,   jinja-       .        jinja-   . </p><br>
<p>           :</p><br>
<pre><code class="bash hljs">cookiecutter https://stash.lamoda.ru/gotools/cookiecutter-go</code></pre><br>
<p>   , ,  ,    ..           .    cookiecutter   ,       .</p><br>
<h1></h1><br>
<p> Lamoda    .       .        ,    ,      .</p><br>
<p>        тАФ  .      ,     (       ),     (        ). </p><br>
<p>,   ,     ,    <del></del>   ,     . </p><br>
<p>  ,   /  ,      ,       .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi495332/index.html">рдЪреМрдХрдбрд╝реА 9: рдПрд▓реЗрдЧреНрд░реЛ | рдЯрд╛рдЗрдкрдкреНрд░рддрд┐</a></li>
<li><a href="../hi495336/index.html">рдПрдХ рдХреЙрд░реНрдкреЛрд░реЗрдЯ рджреВрдд рдХреЗ рд░реВрдк рдореЗрдВ рддреНрдпрд╛рдЧреЗрдВ рдФрд░ рди рдХреЗрд╡рд▓</a></li>
<li><a href="../hi495338/index.html">рдЙрддреНрдкрд╛рджрди рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдФрд░ рдХреБрдмреЗрд░рдиреЗрдЯ рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд░реНрд╡реЛрддреНрддрдо рдЕрднреНрдпрд╛рд╕ рдФрд░ рджрд┐рд╢рд╛рдирд┐рд░реНрджреЗрд╢</a></li>
<li><a href="../hi495340/index.html">рдЖрдИрдЯреА рдореЗрдВ рдПрдХ рдЕрдЪреНрдЫреА рдиреМрдХрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рд░реЗрд╕реНрддрд░рд╛рдВ рдореЗрдВ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рдХрд╛рдо рдХреЛ рдХреИрд╕реЗ рдмрджрд▓рдирд╛ рд╣реИ</a></li>
<li><a href="../hi495342/index.html">рд╡реНрдпрд╛рдкрд╛рд░ рдореЗрдВ рдмреИрдВрдХ рдХрд╛рд░реНрдб рдХрд╛ рдирд┐рдкрдЯрд╛рди - рдПрдХ рдЦреБрд▓рд╛ рдбреЗрдЯрд╛рд╕реЗрдЯ рдФрд░ Google рдбреЗрдЯрд╛ рд╕реНрдЯреВрдбрд┐рдпреЛ рдореЗрдВ рдЗрдиреНрдлреЛрдЧреНрд░рд╛рдлрд┐рдХ рдмрдирд╛рдирд╛</a></li>
<li><a href="../hi495346/index.html">рдХрд╛рд░реНрдпреЛрдВ рд╕реЗ рддреНрд░реБрдЯрд┐ рдХреЗ рдкреНрд░рддрд┐ рд╕рддрд░реНрдХрддрд╛ рд╕реЗ</a></li>
<li><a href="../hi499818/index.html">рдЙрдЬрд╝реНрдмреЗрдХ рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдорд╛рд░реНрдХреЗрдЯрд┐рдВрдЧ</a></li>
<li><a href="../hi499820/index.html">рд╣рдордиреЗ рдХреЛрдЯрд▓рд┐рди рдХреЛ рдЕрдкрдиреА рд▓рдХреНрд╖рд┐рдд рднрд╛рд╖рд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдХреНрдпреЛрдВ рдЪреБрдирд╛ред рднрд╛рдЧ 2: рдХреЛрдЯрд▓рд┐рди рдорд▓реНрдЯреАрдкреНрд▓реЗрдЯ рд░рд┐рдХреЙрд░реНрдбрд░</a></li>
<li><a href="../hi499822/index.html">рд╡рд╛рдпрд░рд▓реЗрд╕ рдПрдХреНрд╕реЗрд╕ рдкреНрд╡рд╛рдЗрдВрдЯ рдмрдирд╛рдо рд░рд╛рдЙрдЯрд░: рдЕрдВрддрд░ рдХреНрдпрд╛ рд╣реИрдВ?</a></li>
<li><a href="../hi499824/index.html">рдордИ 2020 рдореЗрдВ рдПрдЪрдЖрд░ рдФрд░ рдЖрдИрдЯреА рд░рд┐рдХреНрд░реВрдЯрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯреНрд╕ рдХрд╛ рдкрд╛рдЪрди</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>