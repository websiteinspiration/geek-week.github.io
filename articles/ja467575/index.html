<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™‡ğŸ¾ â™‚ï¸ â˜¸ï¸ PostgreSQLã§ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¾…æ©Ÿå±¥æ­´ã‚’å–å¾—ã™ã‚‹1ã¤ã®æ–¹æ³• âš ï¸ ğŸ§“ğŸ¼ ğŸ‘¨ğŸ½â€ğŸš€</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¨˜äº‹ã€ŒPostgreSQLã®ASHã®é¡ä¼¼ç‰©ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€ã®ç¶šãã€‚
 
 ã“ã®è¨˜äº‹ã¯ã€ç‰¹å®šã®ã‚¯ã‚¨ãƒªã¨ä¾‹ã«ã¤ã„ã¦æ¤œè¨ãŠã‚ˆã³è¡¨ç¤ºã•ã‚Œã¾ã™-pg_stat_activityãƒ“ãƒ¥ãƒ¼ã®å±¥æ­´ã‚’ä½¿ç”¨ã—ã¦ã©ã®ã‚ˆã†ãªæœ‰ç”¨ãªæƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‹ã€‚
 è­¦å‘Šã€‚
 ãƒˆãƒ”ãƒƒã‚¯ã®æ–°è¦æ€§ã¨ä¸å®Œå…¨ãªãƒ†ã‚¹ãƒˆæœŸé–“ã®ãŸã‚ã€è¨˜äº‹ã«ã‚¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLã§ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¾…æ©Ÿå±¥æ­´ã‚’å–å¾—ã™ã‚‹1ã¤ã®æ–¹æ³•</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467575/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¨˜äº‹ã€Œ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLã®ASHã®é¡ä¼¼ç‰©ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã®ç¶šã</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®è¨˜äº‹ã¯ã€ç‰¹å®šã®ã‚¯ã‚¨ãƒªã¨ä¾‹ã«ã¤ã„ã¦æ¤œè¨ãŠã‚ˆã³è¡¨ç¤ºã•ã‚Œã¾ã™-pg_stat_activityãƒ“ãƒ¥ãƒ¼ã®å±¥æ­´ã‚’ä½¿ç”¨ã—ã¦ã©ã®ã‚ˆã†ãªæœ‰ç”¨ãªæƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‹ã€‚</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è­¦å‘Šã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ”ãƒƒã‚¯ã®æ–°è¦æ€§ã¨ä¸å®Œå…¨ãªãƒ†ã‚¹ãƒˆæœŸé–“ã®ãŸã‚ã€è¨˜äº‹ã«ã‚¨ãƒ©ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ‰¹åˆ¤ã¨ã‚³ãƒ¡ãƒ³ãƒˆã¯å¼·ãå¥¨åŠ±ã•ã‚Œã€æœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font></blockquote><a name="habracut"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿</font></font></h2> <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å±¥æ­´ã®è¡¨ç¤ºpg_stat_statements</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_history</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> pg_stat_history ( <font></font>
id <span class="hljs-type">SERIAL</span>, <font></font>
snapshot_timestamp  <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>, <font></font>
database_id <span class="hljs-type">integer</span>,<font></font>
dbid <span class="hljs-type">oid</span>,<font></font>
userid <span class="hljs-type">oid</span>,<font></font>
queryid <span class="hljs-type">bigint</span>,<font></font>
query <span class="hljs-type">text</span>,<font></font>
calls <span class="hljs-type">bigint</span>, <font></font>
total_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>, <font></font>
min_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>, <font></font>
max_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>, <font></font>
mean_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>,<font></font>
stddev_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>,
<span class="hljs-keyword">rows</span> <span class="hljs-type">bigint</span>,<font></font>
shared_blks_hit <span class="hljs-type">bigint</span>, <font></font>
shared_blks_read <span class="hljs-type">bigint</span>, <font></font>
shared_blks_dirtied <span class="hljs-type">bigint</span>, <font></font>
shared_blks_written <span class="hljs-type">bigint</span>, <font></font>
local_blks_hit <span class="hljs-type">bigint</span>, <font></font>
local_blks_read <span class="hljs-type">bigint</span>,<font></font>
local_blks_dirtied <span class="hljs-type">bigint</span>, <font></font>
local_blks_written <span class="hljs-type">bigint</span>, <font></font>
temp_blks_read <span class="hljs-type">bigint</span>,<font></font>
temp_blks_written <span class="hljs-type">bigint</span>,<font></font>
blk_read_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>, <font></font>
blk_write_time <span class="hljs-type">double</span> <span class="hljs-type">precision</span>, <font></font>
baseline_id <span class="hljs-type">integer</span> );</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®dblinkã‚’ä½¿ç”¨ã—ã¦1æ™‚é–“ã”ã¨ã«å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚‚ã¡ã‚ã‚“ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã§æœ€ã‚‚èˆˆå‘³æ·±ãæœ‰ç”¨ãªåˆ—ã¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queryid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pg_stat_activityãƒ“ãƒ¥ãƒ¼ã®å±¥æ­´</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_pg_stat_activity</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> archive_pg_stat_activity<font></font>
(<font></font>
  timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>,<font></font>
  datid             <span class="hljs-type">oid</span>, <font></font>
  datname           <span class="hljs-type">name</span>,<font></font>
  pid               <span class="hljs-type">integer</span>,<font></font>
  usesysid          <span class="hljs-type">oid</span>,<font></font>
  usename           <span class="hljs-type">name</span>,<font></font>
  application_name  <span class="hljs-type">text</span>,<font></font>
  client_addr       <span class="hljs-type">inet</span>,<font></font>
  client_hostname   <span class="hljs-type">text</span>,<font></font>
  client_port       <span class="hljs-type">integer</span>,<font></font>
  backend_start     <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>,<font></font>
  xact_start        <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>,<font></font>
  query_start       <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>,<font></font>
  state_change      <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span>,<font></font>
  wait_event_type   <span class="hljs-type">text</span>,                     <font></font>
  wait_event        <span class="hljs-type">text</span>,                   <font></font>
  state             <span class="hljs-type">text</span>,                  <font></font>
  backend_xid       xid,                 <font></font>
  backend_xmin      xid,                <font></font>
  query             <span class="hljs-type">text</span>,               <font></font>
  backend_type      <span class="hljs-type">text</span>,<font></font>
  queryid           <span class="hljs-type">bigint</span>
);</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ã‚¯ãƒ­ãƒƒã‚¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åŒ–ã•ã‚ŒãŸhistory_pg_stat_activityãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ï¼ˆè©³ç´°ã«ã¤ã„ã¦ã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements + pg_stat_activity + loq_query = pg_ashï¼Ÿã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ãŸ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€PostgreSQLã®ASHã®é¡ä¼¼ç‰©ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ï¼‰</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡ºåŠ›</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®CPUæ™‚é–“ï¼ˆã‚·ã‚¹ãƒ†ãƒ +ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> 
 t <span class="hljs-keyword">AS</span><font></font>
 (<font></font>
	<span class="hljs-keyword">SELECT</span> 		
			date_trunc(<span class="hljs-string">'second'</span>, timepoint)
	<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
	<span class="hljs-keyword">WHERE</span> 	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
			( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  ) <span class="hljs-keyword">AND</span>
			aa.state = <span class="hljs-string">'active'</span><font></font>
 )<font></font>
 <span class="hljs-keyword">SELECT</span> count(*) 
 <span class="hljs-keyword">INTO</span> cpu_total
 <span class="hljs-keyword">FROM</span> t ;</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">CLUSTER CPU TIME (SYSTEM + CLIENTS ) : 28:37:46</code></pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å¾…æ©Ÿæ™‚é–“</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> 
 t <span class="hljs-keyword">AS</span><font></font>
 (<font></font>
	<span class="hljs-keyword">SELECT</span> 		
			date_trunc(<span class="hljs-string">'second'</span>, timepoint)
	<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
	<span class="hljs-keyword">WHERE</span> 	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
			( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  ) <span class="hljs-keyword">AND</span>
			aa.state = <span class="hljs-string">'active'</span><font></font>
 )<font></font>
 <span class="hljs-keyword">SELECT</span> count(*) 
 <span class="hljs-keyword">INTO</span> cpu_total
 <span class="hljs-keyword">FROM</span> t ;</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">CLUSTER WAITINGS TIME : 30:12:49</code></pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statementsã®åˆè¨ˆå€¤</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"> <span class="hljs-comment">--TOTAL pg_stat</span>
  <span class="hljs-keyword">SELECT</span> 
    SUM(calls) <span class="hljs-keyword">AS</span> calls, SUM(total_time)  <span class="hljs-keyword">AS</span> total_time, SUM(<span class="hljs-keyword">rows</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">rows</span> ,<font></font>
	SUM(shared_blks_hit)  <span class="hljs-keyword">AS</span> shared_blks_hit,SUM(shared_blks_read) <span class="hljs-keyword">AS</span> shared_blks_read ,<font></font>
	SUM(shared_blks_dirtied) <span class="hljs-keyword">AS</span> shared_blks_dirtied,SUM(shared_blks_written) <span class="hljs-keyword">AS</span> shared_blks_written , <font></font>
    SUM(local_blks_hit) <span class="hljs-keyword">AS</span> local_blks_hit , SUM(local_blks_read) <span class="hljs-keyword">AS</span> local_blks_read , <font></font>
	SUM(local_blks_dirtied) <span class="hljs-keyword">AS</span> local_blks_dirtied , SUM(local_blks_written)  <span class="hljs-keyword">AS</span> local_blks_written,<font></font>
	SUM(temp_blks_read) <span class="hljs-keyword">AS</span> temp_blks_read, SUM(temp_blks_written) temp_blks_written , <font></font>
	SUM(blk_read_time) <span class="hljs-keyword">AS</span> blk_read_time , SUM(blk_write_time) <span class="hljs-keyword">AS</span> blk_write_time
  <span class="hljs-keyword">INTO</span> <font></font>
    pg_total_stat_history_rec<font></font>
  <span class="hljs-keyword">FROM</span> <font></font>
    pg_stat_history<font></font>
  <span class="hljs-keyword">WHERE</span> 
 	snapshot_timestamp <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin <span class="hljs-keyword">AND</span> pg_stat_history_end <span class="hljs-keyword">AND</span> 
	queryid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;</code></pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL DBTIME-åˆè¨ˆã‚¯ã‚¨ãƒªãƒ©ãƒ³ã‚¿ã‚¤ãƒ </font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs">dbtime_total = <span class="hljs-type">interval</span> <span class="hljs-string">'1 millisecond'</span> * pg_total_stat_history_rec.total_time ;</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">SQL DBTIME : 136:49:36</code></pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œã«è²»ã‚„ã•ã‚ŒãŸCPUã®SQL CPU TIMEæ™‚é–“</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> 
 t <span class="hljs-keyword">AS</span><font></font>
 (<font></font>
	<span class="hljs-keyword">SELECT</span> 		
			date_trunc(<span class="hljs-string">'second'</span>, timepoint)
	<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
	<span class="hljs-keyword">WHERE</span> 	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
			( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  ) <span class="hljs-keyword">AND</span>
			backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> 
			aa.state = <span class="hljs-string">'active'</span><font></font>
 )<font></font>
 <span class="hljs-keyword">SELECT</span> count(*) 
 <span class="hljs-keyword">INTO</span> cpu_total
 <span class="hljs-keyword">FROM</span> t ;</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">SQL CPU TIME : 27:40:15</code></pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLå¾…æ©Ÿæ™‚é–“-ã‚¯ã‚¨ãƒªã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> 
 t <span class="hljs-keyword">AS</span><font></font>
 (<font></font>
	<span class="hljs-keyword">SELECT</span> 		
			date_trunc(<span class="hljs-string">'second'</span>, timepoint)
	<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
	<span class="hljs-keyword">WHERE</span> 	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
			( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  ) <span class="hljs-keyword">AND</span>
			aa.state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">AND</span> 
		backend_type = <span class="hljs-string">'client backend'</span><font></font>
 )<font></font>
 <span class="hljs-keyword">SELECT</span> count(*) 
 <span class="hljs-keyword">INTO</span> waiting_total
 <span class="hljs-keyword">FROM</span> t ;</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">SQL WAITINGS TIME : 30:04:09</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®ã‚¯ã‚¨ãƒªã¯ç°¡å˜ã§ã™ã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¯€ç´„ã™ã‚‹ãŸã‚ã«ã€å®Ÿè£…ã®è©³ç´°ã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">| SQL IOTIME : 19:44:50<font></font>
| SQL READ TIME : 19:44:32<font></font>
| SQL WRITE TIME : 00:00:17<font></font>
|<font></font>
| SQL CALLS : 12188248<font></font>
-------------------------------------------------------------<font></font>
| SQL SHARED BLOCKS READS : 7997039120<font></font>
| SQL SHARED BLOCKS HITS : 8868286092<font></font>
| SQL SHARED BLOCKS HITS/READS % : 110.89<font></font>
| SQL SHARED BLOCKS DIRTED : 419945<font></font>
| SQL SHARED BLOCKS WRITTEN : 19857<font></font>
|<font></font>
| SQL TEMPORARY BLOCKS READS : 7836169<font></font>
| SQL TEMPORARY BLOCKS WRITTEN : 10683938<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€ã‚‚èˆˆå‘³æ·±ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é€²ã¿ã¾ã™</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¾…æ©Ÿçµ±è¨ˆ</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“åˆ¥ã®ãƒˆãƒƒãƒ—10å¾…æ©Ÿ</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
  wait_event_type , wait_event ,<font></font>
  get_system_waiting_duration( wait_event_type , wait_event ,pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ,pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span><font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> backend_type != <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <font></font>
  wait_event_type, wait_event<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ ------------------------------------------------- -----------------------------------</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚»ã‚¹ã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“ã«ã‚ˆã‚‹ãƒˆãƒƒãƒ—10å¾…æ©Ÿ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----- + ------------------------------ + ------------ -------- + --------------------</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">ï¼ƒ| </font><font style="vertical-align: inherit;">wait_event_type | </font><font style="vertical-align: inherit;">wait_event | </font><font style="vertical-align: inherit;">æœŸé–“</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ----- + ------------------------------ + ------------ -------- + --------------------</font></font><font></font>
|    1|                      Activity| LogicalLauncherMain|            10:43:28<font></font>
|    2|                      Activity|      AutoVacuumMain|            10:42:49<font></font>
|    3|                      Activity|       WalWriterMain|            10:28:53<font></font>
|    4|                      Activity|    CheckpointerMain|            10:23:50<font></font>
|    5|                      Activity|        BgWriterMain|            09:11:59<font></font>
|    6|                      Activity|   BgWriterHibernate|            01:37:46<font></font>
|    7|                            IO|        BufFileWrite|            00:02:35<font></font>
|    8|                        LWLock|      buffer_mapping|            00:01:54<font></font>
|    9|                            IO|        DataFileRead|            00:01:23<font></font>
|   10|                            IO|            WALWrite|            00:00:59<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
</pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“åˆ¥ã®ãƒˆãƒƒãƒ—10å¾…æ©Ÿ</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
  wait_event_type , wait_event ,<font></font>
  get_clients_waiting_duration( wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration
<span class="hljs-keyword">FROM</span> <font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> wait_event_type, wait_event
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+-----+------------------------------+--------------------+--------------------+----------<font></font>
|    #|               wait_event_type|          wait_event|            duration|  % dbtime<font></font>
+-----+------------------------------+--------------------+--------------------+----------<font></font>
|    1|                          Lock|       transactionid|            08:16:47|      6.05<font></font>
|    2|                            IO|        DataFileRead|            06:13:41|      4.55<font></font>
|    3|                       Timeout|             PgSleep|            02:53:21|      2.11<font></font>
|    4|                        LWLock|      buffer_mapping|            00:40:42|       0.5<font></font>
|    5|                        LWLock|           buffer_io|            00:17:17|      0.21<font></font>
|    6|                            IO|        BufFileWrite|            00:01:34|      0.02<font></font>
|    7|                          Lock|               tuple|            00:01:32|      0.02<font></font>
|    8|                        Client|          ClientRead|            00:01:19|      0.02<font></font>
|    9|                            IO|         BufFileRead|            00:00:37|      0.01<font></font>
|   10|                        LWLock|      buffer_content|            00:00:08|         0<font></font>
+-----+------------------------------+--------------------+--------------------+----------<font></font>
</pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚»ã‚¹ã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“åˆ¥ã®å¾…æ©Ÿã‚¿ã‚¤ãƒ—</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
  wait_event_type ,<font></font>
  get_system_waiting_type_duration( wait_event_type , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration
<span class="hljs-keyword">FROM</span><font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>  backend_type != <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> wait_event_type
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+-----+------------------------------+--------------------<font></font>
|    #|               wait_event_type|            duration<font></font>
+-----+------------------------------+--------------------<font></font>
|    1|                      Activity|            53:08:45<font></font>
|    2|                            IO|            00:06:24<font></font>
|    3|                        LWLock|            00:03:02<font></font>
+-----+------------------------------+--------------------<font></font>
</pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã®åˆè¨ˆå¾…æ©Ÿæ™‚é–“åˆ¥ã®å¾…æ©Ÿã‚¿ã‚¤ãƒ—</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
  wait_event_type ,<font></font>
  get_clients_waiting_type_duration( wait_event_type , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration
<span class="hljs-keyword">FROM</span><font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> wait_event_type
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+-----+------------------------------+--------------------+--------------------<font></font>
|    #|               wait_event_type|            duration|            % dbtime<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
|    1|                          Lock|            08:18:19|                6.07<font></font>
|    2|                            IO|            06:16:01|                4.58<font></font>
|    3|                       Timeout|            02:53:21|                2.11<font></font>
|    4|                        LWLock|            00:58:12|                0.71<font></font>
|    5|                        Client|            00:01:19|                0.02<font></font>
|    6|                           IPC|            00:00:04|                   0<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
</pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚»ã‚¹ã¨å€‹ã€…ã®è¦æ±‚ã«å¯¾ã™ã‚‹æœŸå¾…ã®æœŸé–“ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚»ã‚¹ã®å¾…æ©Ÿ</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> 
  backend_type , datname , wait_event_type , wait_event , get_backend_type_waiting_duration( backend_type , wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span> <font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> backend_type != <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> backend_type , datname , wait_event_type , wait_event
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">5</span> <span class="hljs-keyword">DESC</span></code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+-----+-----------------------------+----------+--------------------+----------------------+--------------------<font></font>
|    #|                 backend_type|    dbname|     wait_event_type|            wait_event|            duration<font></font>
+-----+-----------------------------+----------+--------------------+----------------------+--------------------<font></font>
|    1| logical replication launcher|          |            Activity|   LogicalLauncherMain|            10:43:28<font></font>
|    2|          autovacuum launcher|          |            Activity|        AutoVacuumMain|            10:42:49<font></font>
|    3|                    walwriter|          |            Activity|         WalWriterMain|            10:28:53<font></font>
|    4|                 checkpointer|          |            Activity|      CheckpointerMain|            10:23:50<font></font>
|    5|            background writer|          |            Activity|          BgWriterMain|            09:11:59<font></font>
|    6|            background writer|          |            Activity|     BgWriterHibernate|            01:37:46<font></font>
|    7|              parallel worker|      tdb1|                  IO|          BufFileWrite|            00:02:35<font></font>
|    8|              parallel worker|      tdb1|              LWLock|        buffer_mapping|            00:01:41<font></font>
|    9|              parallel worker|      tdb1|                  IO|          DataFileRead|            00:01:22<font></font>
|   10|              parallel worker|      tdb1|                  IO|           BufFileRead|            00:00:59<font></font>
|   11|                    walwriter|          |                  IO|              WALWrite|            00:00:57<font></font>
|   12|              parallel worker|      tdb1|              LWLock|             buffer_io|            00:00:47<font></font>
|   13|            autovacuum worker|      tdb1|              LWLock|        buffer_mapping|            00:00:13<font></font>
|   14|            background writer|          |                  IO|         DataFileWrite|            00:00:12<font></font>
|   15|                 checkpointer|          |                  IO|         DataFileWrite|            00:00:11<font></font>
|   16|                    walwriter|          |              LWLock|          WALWriteLock|            00:00:09<font></font>
|   17|                 checkpointer|          |              LWLock|          WALWriteLock|            00:00:06<font></font>
|   18|            background writer|          |              LWLock|          WALWriteLock|            00:00:06<font></font>
|   19|                    walwriter|          |                  IO|          WALInitWrite|            00:00:02<font></font>
|   20|            autovacuum worker|      tdb1|              LWLock|          WALWriteLock|            00:00:02<font></font>
|   21|                    walwriter|          |                  IO|           WALInitSync|            00:00:02<font></font>
|   22|            autovacuum worker|      tdb1|                  IO|          DataFileRead|            00:00:01<font></font>
|   23|                 checkpointer|          |                  IO| ControlFileSyncUpdate|            00:00:01<font></font>
|   24|            background writer|          |                  IO|              WALWrite|            00:00:01<font></font>
|   25|            background writer|          |                  IO|         DataFileFlush|            00:00:01<font></font>
|   26|                 checkpointer|          |                  IO|         SLRUFlushSync|            00:00:01<font></font>
|   27|            autovacuum worker|      tdb1|                  IO|              WALWrite|            00:00:01<font></font>
|   28|                 checkpointer|          |                  IO|          DataFileSync|            00:00:01<font></font>
+-----+-----------------------------+----------+--------------------+----------------------+--------------------</pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLã®å¾…æ©Ÿ-queryidã«ã‚ˆã‚‹å€‹ã€…ã®ã‚¯ã‚¨ãƒªã¸ã®æœŸå¾…</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•ã„åˆã‚ã›</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> 
queryid , datname , wait_event_type , wait_event , get_query_waiting_duration( queryid ,  wait_event_type , wait_event , pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) , pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span> <font></font>
  activity_hist.archive_pg_stat_activity aa<font></font>
<span class="hljs-keyword">WHERE</span> 
  timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> queryid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> queryid , datname , wait_event_type , wait_event
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> , <span class="hljs-number">5</span> <span class="hljs-keyword">DESC</span> </code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+-----+-------------------------+----------+--------------------+--------------------+--------------------+--------------------<font></font>
|    #|                  queryid|    dbname|     wait_event_type|          wait_event|            waitings|               total<font></font>
|     |                         |          |                    |                    |            duration|            duration<font></font>
+-----+-------------------------+----------+--------------------+--------------------+--------------------+--------------------<font></font>
|    1|     -8247416849404883188|      tdb1|              Client|          ClientRead|            00:00:02|<font></font>
|    2|     -6572922443698419129|      tdb1|              Client|          ClientRead|            00:00:05|<font></font>
|    3|     -6572922443698419129|      tdb1|                  IO|        DataFileRead|            00:00:01|<font></font>
|    4|     -5917408132400665328|      tdb1|              Client|          ClientRead|            00:00:04|<font></font>
|    5|     -4091009262735781873|      tdb1|              Client|          ClientRead|            00:00:03|<font></font>
|    6|     -1473395109729441239|      tdb1|              Client|          ClientRead|            00:00:01|<font></font>
|    7|        28942442626229688|      tdb1|                  IO|        BufFileWrite|            00:01:34|            00:46:06<font></font>
|    8|        28942442626229688|      tdb1|              LWLock|      buffer_mapping|            00:01:05|            00:46:06<font></font>
|    9|        28942442626229688|      tdb1|                  IO|        DataFileRead|            00:00:44|            00:46:06<font></font>
|   10|        28942442626229688|      tdb1|                  IO|         BufFileRead|            00:00:37|            00:46:06<font></font>
|   11|        28942442626229688|      tdb1|              LWLock|           buffer_io|            00:00:35|            00:46:06<font></font>
|   12|        28942442626229688|      tdb1|              Client|          ClientRead|            00:00:05|            00:46:06<font></font>
|   13|        28942442626229688|      tdb1|                 IPC| MessageQueueReceive|            00:00:03|            00:46:06<font></font>
|   14|        28942442626229688|      tdb1|                 IPC|    BgWorkerShutdown|            00:00:01|            00:46:06<font></font>
|   15|       389015618226997618|      tdb1|                Lock|       transactionid|            03:55:09|            04:14:15<font></font>
|   16|       389015618226997618|      tdb1|                  IO|        DataFileRead|            03:23:09|            04:14:15<font></font>
|   17|       389015618226997618|      tdb1|              LWLock|      buffer_mapping|            00:12:09|            04:14:15<font></font>
|   18|       389015618226997618|      tdb1|              LWLock|           buffer_io|            00:10:18|            04:14:15<font></font>
|   19|       389015618226997618|      tdb1|                Lock|               tuple|            00:00:35|            04:14:15<font></font>
|   20|       389015618226997618|      tdb1|              LWLock|        WALWriteLock|            00:00:02|            04:14:15<font></font>
|   21|       389015618226997618|      tdb1|                  IO|       DataFileWrite|            00:00:01|            04:14:15<font></font>
|   22|       389015618226997618|      tdb1|              LWLock|        SyncScanLock|            00:00:01|            04:14:15<font></font>
|   23|       389015618226997618|      tdb1|              Client|          ClientRead|            00:00:01|            04:14:15<font></font>
|   24|       734234407411547467|      tdb1|              Client|          ClientRead|            00:00:11|<font></font>
|   25|       734234407411547467|      tdb1|              LWLock|      buffer_mapping|            00:00:05|<font></font>
|   26|       734234407411547467|      tdb1|                  IO|        DataFileRead|            00:00:02|<font></font>
|   27|      1237430309438971376|      tdb1|              LWLock|      buffer_mapping|            00:02:18|            02:45:40<font></font>
|   28|      1237430309438971376|      tdb1|                  IO|        DataFileRead|            00:00:27|            02:45:40<font></font>
|   29|      1237430309438971376|      tdb1|              Client|          ClientRead|            00:00:02|            02:45:40<font></font>
|   30|      2404820632950544954|      tdb1|              Client|          ClientRead|            00:00:01|<font></font>
|   31|      2515308626622579467|      tdb1|              Client|          ClientRead|            00:00:02|<font></font>
|   32|      4710212362688288619|      tdb1|              LWLock|      buffer_mapping|            00:03:08|            02:18:21<font></font>
|   33|      4710212362688288619|      tdb1|                  IO|        DataFileRead|            00:00:22|            02:18:21<font></font>
|   34|      4710212362688288619|      tdb1|              Client|          ClientRead|            00:00:06|            02:18:21<font></font>
|   35|      4710212362688288619|      tdb1|              LWLock|           buffer_io|            00:00:02|            02:18:21<font></font>
|   36|      9150846928388977274|      tdb1|                  IO|        DataFileRead|            00:01:19|<font></font>
|   37|      9150846928388977274|      tdb1|              LWLock|      buffer_mapping|            00:00:34|<font></font>
|   38|      9150846928388977274|      tdb1|              Client|          ClientRead|            00:00:10|<font></font>
|   39|      9150846928388977274|      tdb1|              LWLock|           buffer_io|            00:00:01|<font></font>
+-----+-------------------------+----------+--------------------+--------------------+--------------------+--------------------</pre></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSQLçµ±è¨ˆ-TOPã‚¯ã‚¨ãƒª</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãŸã ã—ã€å†åº¦å—ã‘å–ã‚‹è¦æ±‚ã¯ç°¡å˜ã§ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¯€ç´„ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></b><div class="spoiler_text"><pre>+------------------------------------------------------------------------------------<font></font>
| CLIENT SQL ordered by Elapsed Time<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
|        elapsed time|     calls|  % dbtime|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
|            04:14:15|        19|       3.1|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
|            02:45:40|       746|      2.02|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
|            02:18:21|       749|      1.69|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
|            00:46:06|       375|      0.56|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by CPU Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            cpu time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            02:59:49|        19|       3.1|  04:14:15|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
|            01:10:12|       746|      2.02|  02:45:40|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
|            00:56:15|       749|      1.69|  02:18:21|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
|            00:15:35|       375|      0.56|  00:46:06|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by User I/O Wait Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|        io_wait time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            03:23:10|        19|       3.1|  04:14:15|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
|            00:02:54|       375|      0.56|  00:46:06|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
|            00:00:27|       746|      2.02|  02:45:40|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
|            00:00:22|       749|      1.69|  02:18:21|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Shared Buffers Reads<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|       buffers reads|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|          1056388566|        19|       3.1|  04:14:15|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
|            11709251|       375|      0.56|  00:46:06|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
|             3439004|       746|      2.02|  02:45:40|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
|             3373330|       749|      1.69|  02:18:21|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Disk Reads Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|           read time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            02:16:30|        19|       3.1|  04:14:15|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
|            00:04:50|       375|      0.56|  00:46:06|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
|            00:01:10|       749|      1.69|  02:18:21|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
|            00:00:57|       746|      2.02|  02:45:40|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Executions<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|               calls|      rows|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|                 749|       749|      1.69|  02:18:21|      3.39|       0.1|      tdb1| 4710212362688288619<font></font>
|                 746|       746|      2.02|  02:45:40|      4.23|      0.08|      tdb1| 1237430309438971376<font></font>
|                 375|         0|      0.56|  00:46:06|      0.94|      0.41|      tdb1|   28942442626229688<font></font>
|                  19|        19|       3.1|  04:14:15|     10.83|     11.52|      tdb1|  389015618226997618<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------</pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€ä¿¡ã•ã‚ŒãŸè¦æ±‚ã¨çµæœã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€å€‹ã€…ã®è¦æ±‚ã¨ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã®å•é¡Œã‚’åˆ†æãŠã‚ˆã³è§£æ±ºã™ã‚‹ãŸã‚ã®ã‚ˆã‚Šå®Œå…¨ãªçŠ¶æ³ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–‹ç™º</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã¾ã§ã®ã¨ã“ã‚ã€é–‹ç™ºè¨ˆç”»ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ­ãƒƒã‚¯å±¥æ­´ä»˜ãã®è£œè¶³ãƒ¬ãƒãƒ¼ãƒˆã€‚</font><font style="vertical-align: inherit;">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ†ã‚¹ãƒˆä¸­ã§ã€ã¾ã‚‚ãªãé€ä¿¡ã•ã‚Œã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimescaleDBæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€pg_stat_activityãŠã‚ˆã³pg_locksã®å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ¬ç•ªãƒ™ãƒ¼ã‚¹ã§ã®å¤§é‡å±•é–‹ã®ãŸã‚ã«githubã§ãƒãƒƒãƒã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æº–å‚™ã—ã¾ã™ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¤ã¥ãâ€¦</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467557/index.html">å…ˆé€±ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸–ç•Œã‹ã‚‰ã®æ–°é®®ãªé£Ÿæã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆNo. 380ï¼ˆ2019å¹´9æœˆ8æ—¥ã€œ15æ—¥ï¼‰</a></li>
<li><a href="../ja467559/index.html">9æœˆ16æ—¥ã‹ã‚‰22æ—¥ã¾ã§ã®ãƒ¢ã‚¹ã‚¯ãƒ¯ã§ã®ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ</a></li>
<li><a href="../ja467563/index.html">PVS-Studioãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µãƒãƒ¼ãƒˆã‹ã‚‰1æ—¥</a></li>
<li><a href="../ja467567/index.html">ä¸€é€£ã®ssh + tmux + neovimã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã®24ãƒ“ãƒƒãƒˆã‚«ãƒ©ãƒ¼ã®ã‚µãƒãƒ¼ãƒˆ</a></li>
<li><a href="../ja467573/index.html">ä¸Šä½8ã¤ã®æœ‰ç”¨ãªåˆ†æãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</a></li>
<li><a href="../ja467581/index.html">ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ãƒ¬ãƒˆãƒ­ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æ­£ã—ã„ã‚«ãƒ©ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°</a></li>
<li><a href="../ja467583/index.html">LMTOOLSãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€‚ã‚ªãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯è£½å“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹</a></li>
<li><a href="../ja467587/index.html">ã™ã¹ã¦ã®ä¾¿åˆ©ãªWi-Fiã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’1ã‹æ‰€ã«</a></li>
<li><a href="../ja467589/index.html">2019å¹´ã«GDPRã«ã¤ã„ã¦çŸ¥ã£ã¦ãŠãã¹ãã“ã¨</a></li>
<li><a href="../ja467591/index.html">æ–°ã—ã„è¨¼æ˜ã¯ã€piãªã©ã®æ•°å€¤ã®è¿‘ä¼¼ã‚’è§£æ±ºã—ã¾ã™</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>