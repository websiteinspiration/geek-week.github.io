<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏾‍🤝‍🧑🏼 🤳🏿 🎤 Redimensionner les images à la volée à l'aide de Nginx et LuaJIT (OpenResty) 🐈 🚃 💇🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depuis un certain temps maintenant, inspiré par l'article Redimensionner les images à la volée , le redimensionnement d'image avec ngx_http_image_filt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Redimensionner les images à la volée à l'aide de Nginx et LuaJIT (OpenResty)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489544/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depuis un certain temps maintenant, inspiré par l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redimensionner les images à la </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">volée</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le redimensionnement d'image avec </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_" rel="nofollow"><font style="vertical-align: inherit;">ngx_http_image_filter_module a</font></a><font style="vertical-align: inherit;"> été configuré </font><font style="vertical-align: inherit;">et tout a fonctionné comme il se doit. </font><font style="vertical-align: inherit;">Mais il y avait un problème lorsque le gestionnaire devait obtenir des images de tailles exactes pour les télécharger sur certains services, car </font><font style="vertical-align: inherit;">c'étaient leurs exigences techniques. </font><font style="vertical-align: inherit;">Par exemple, si nous avons une image originale de taille </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1200x1200</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et lors du redimensionnement, nous écrivons quelque chose comme </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Resize = 600x400</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous obtiendrons une image proportionnellement réduite au plus petit bord, taille </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">400x400</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il est également impossible d'obtenir une image avec une résolution plus élevée (haut de gamme). </font><font style="vertical-align: inherit;">Ceux. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? resize = 1500x1500</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renverra tout de même la même image</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1200x1200</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un article d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est venu à la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">rescousse: nous transformons NGINX en un serveur d'applications à part entière</font></a><font style="vertical-align: inherit;"> pour comprendre comment Nginx fonctionne avec Lua et la bibliothèque pour Lua </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isage / lua-imagick elle-même</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Lia pure-c bindings à ImageMagick. </font><font style="vertical-align: inherit;">Pourquoi une telle solution a été choisie, et non, disons, quelque chose en python - parce qu'elle est rapide et pratique. </font><font style="vertical-align: inherit;">Vous n'avez même pas besoin de créer de fichiers, tout se passe bien dans la configuration Nginx (facultatif).</font></font></p><a name="habracut"></a><br>
<h2 id="itak-chto-nam-ponadobitsya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors de quoi avons-nous besoin</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des exemples seront donnés sur la base de Debian.</font></font></p><br>
<h3 id="ustanovka-nginx-i-nginx-extras"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer nginx et nginx-extras</font></font></h3><br>
<pre><code class="bash hljs">apt-get update<font></font>
apt-get install nginx-extras</code></pre><br>
<h3 id="ustanovka-luajit"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer LuaJIT</font></font></h3><br>
<pre><code class="bash hljs">apt-get -y install lua5.1 luajit-5.1 libluajit-5.1-dev</code></pre><br>
<h3 id="ustanovka-imagemagick"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer imagemagick</font></font></h3><br>
<pre><code class="bash hljs">apt-get -y install imagemagick</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les bibliothèques </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">magickwand</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dans mon cas pour la version 6</font></font></p><br>
<pre><code class="bash hljs">apt-cache search libmagickwand<font></font>
apt-get -y install libmagickwand-6.q16-3 libmagickwand-6.q16-dev</code></pre><br>
<h3 id="sborka-lua-imagick"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Construction Lua-imagick</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous clonons le référentiel (enfin, ou prenons le zip et le déballons)</font></font></p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~<font></font>
git <span class="hljs-built_in">clone</span> https://github.com/isage/lua-imagick.git
<span class="hljs-built_in">cd</span> lua-imagick<font></font>
mkdir build<font></font>
<span class="hljs-built_in">cd</span> build<font></font>
cmake ..<font></font>
make<font></font>
make install</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tout s'est bien passé, vous pouvez configurer Nginx.</font></font></p><br>
<p>   backend , , ,   .        Nginx,        ()  . .</p><br>
<div class="spoiler"><b class="spoiler_title">nginx backend config</b><div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-comment"># Backend image server</span>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span>       <span class="hljs-number">8082</span>;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">8082</span>;
    <span class="hljs-attribute">set</span> <span class="hljs-variable">$files_root</span> /var/www/example.lh/frontend/web;
    <span class="hljs-attribute">root</span> <span class="hljs-variable">$files_root</span>;
    <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;
    <span class="hljs-attribute">expires</span> <span class="hljs-number">1d</span>;<font></font>
<font></font>
    <span class="hljs-attribute">location</span> /files {
        <span class="hljs-comment">#   </span>
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$w</span> <span class="hljs-number">700</span>;
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$h</span> <span class="hljs-number">700</span>;
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$q</span> <span class="hljs-number">89</span>;<font></font>
<font></font>
        <span class="hljs-comment">#1-89 allowed</span>
        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$arg_q</span> <span class="hljs-regexp">~ "^([1-9]|[1-8][0-9])$")</span> {
            <span class="hljs-attribute">set</span> <span class="hljs-variable">$q</span> <span class="hljs-variable">$arg_q</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$arg_resize</span> <span class="hljs-regexp">~ "([\d\-]+)x([\d\+\!\^]+)")</span> {  
            <span class="hljs-attribute">set</span> <span class="hljs-variable">$w</span> <span class="hljs-variable">$1</span>;
            <span class="hljs-attribute">set</span> <span class="hljs-variable">$h</span> <span class="hljs-variable">$2</span>;
            <span class="hljs-attribute">rewrite</span> <span class="hljs-regexp"> ^(.*)$</span>   /resize/<span class="hljs-variable">$w</span>/<span class="hljs-variable">$h</span>/<span class="hljs-variable">$q</span><span class="hljs-variable">$uri</span>     <span class="hljs-literal">last</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-attribute">rewrite</span> <span class="hljs-regexp"> ^(.*)$</span>   /resize/<span class="hljs-variable">$w</span>/<span class="hljs-variable">$h</span>/<span class="hljs-variable">$q</span><span class="hljs-variable">$uri</span>     <span class="hljs-literal">last</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/resize/([\d]+)/([\d\+\!\^]+)/([\d]+)/files/(.+)$</span> {
        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;<font></font>
<font></font>
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$w</span> <span class="hljs-variable">$1</span>;
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$h</span> <span class="hljs-variable">$2</span>;
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$q</span> <span class="hljs-variable">$3</span>;
        <span class="hljs-attribute">set</span> <span class="hljs-variable">$fname</span> <span class="hljs-variable">$4</span>;<font></font>
<font></font>
        <span class="hljs-comment">#     Lua    </span>
        <span class="hljs-comment"># content_by_lua_file /var/www/some.lua;</span>
        <span class="hljs-comment"># lua_code_cache off; #dev</span>
        <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
        local magick = require "imagick"
        local img = magick.open(ngx.var.files_root .. "/files/" .. ngx.var.fname)
        if not img then ngx.exit(ngx.HTTP_NOT_FOUND) end
        img:set_gravity(magick.gravity["CenterGravity"])

        if string.match(ngx.var.h, "%d+%+") then
            local h = string.gsub(ngx.var.h, "(%+)", "")
            resize = ngx.var.w .. "x" .. h
            --  png   
            img:set_bg_color(img:has_alphachannel() and "none" or img:get_bg_color())
            img:smart_resize(resize)
            img:extent(ngx.var.w, h)
        else
                img:smart_resize(ngx.var.w .. "x" .. ngx.var.h)
        end

        if ngx.var.arg_q then img:set_quality(ngx.var.q) end

        ngx.say(img:blob())
        '</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># Upstream</span>
<span class="hljs-attribute">upstream</span> imageserver {
    <span class="hljs-attribute">server</span> localhost:<span class="hljs-number">8082</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> examaple.lh;<font></font>
<font></font>
    <span class="hljs-comment">#   jpg  png   imageserver</span>
    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* ^/files/.+\.(jpg|png)</span> {
        <span class="hljs-attribute">proxy_buffers</span> <span class="hljs-number">8</span> <span class="hljs-number">2m</span>;
        <span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">10m</span>;
        <span class="hljs-attribute">proxy_busy_buffers_size</span> <span class="hljs-number">10m</span>;
        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<font></font>
<font></font>
        <span class="hljs-attribute">proxy_pass</span>     http://imageserver;  <span class="hljs-comment"># Backend image server</span><font></font>
    }<font></font>
}<font></font>
</code></pre></div></div><br>
<p>,   (   )    <code>img:extent()</code>      <code>resize</code>   <code>+</code>  .</p><br>
<p><strong>  :</strong></p><br>
<ul>
<li>WxH (Keep aspect-ratio, use higher dimension)</li>
<li>WxH^ (Keep aspect-ratio, use lower dimension (crop))</li>
<li>WxH! (Ignore aspect-ratio)</li>
<li>WxH+ (Keep aspect-ratio, add side borders)</li>
</ul><br>
<p><strong>    </strong></p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th> uri </th>
<th>  </th>
</tr>
</thead>
<tbody>
<tr>
<td>?resize=400x200</td>
<td>200x200</td>
</tr>
<tr>
<td>?resize=400x200^</td>
<td>400x400</td>
</tr>
<tr>
<td>?resize=400x200!</td>
<td>400x200 ( )</td>
</tr>
<tr>
<td>?resize=400x200+</td>
<td>400x200 ()</td>
</tr>
</tbody>
</table></div><br>
<p><img src="https://habrastorage.org/webt/ua/lw/dk/ualwdkcnydipmho3j9qtxordrmc.png"></p><br>
<h2 id="itog"></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étant donné la puissance et la simplicité de cette approche, vous pouvez implémenter des choses avec une logique plutôt complexe, par exemple, ajouter watermark'i ou implémenter une autorisation avec un accès limité. </font><font style="vertical-align: inherit;">Afin de découvrir les capacités de l'API pour travailler avec des images, vous pouvez vous référer à la documentation de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bibliothèque isage / lua-imagick</font></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489534/index.html">Encore une fois sur l'analyse des expressions à l'aide de la méthode de descente récursive</a></li>
<li><a href="../fr489536/index.html">Caractéristiques des systèmes d'alimentation utilisant DDIBP</a></li>
<li><a href="../fr489538/index.html">Pourquoi les développeurs n'aiment-ils pas Agile?</a></li>
<li><a href="../fr489540/index.html">Débogage des microcontrôleurs ARM Cortex-M par UART partie 2</a></li>
<li><a href="../fr489542/index.html">IDE nano ou minimaliste</a></li>
<li><a href="../fr489546/index.html">Fabrication d'obturateur pour un respirateur</a></li>
<li><a href="../fr489548/index.html">Environ 20 lignes, à peu près les mêmes résultats: wc sur Elixir</a></li>
<li><a href="../fr489550/index.html">7 astuces avec les opérateurs Rest et Spread lors de l'utilisation d'objets JS</a></li>
<li><a href="../fr489552/index.html">Diagnostiquer les problèmes dans l'architecture de microservices sur Node.js à l'aide d'OpenTracing et de Jaeger</a></li>
<li><a href="../fr489554/index.html">Petites subtilités de java.lang.String</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>