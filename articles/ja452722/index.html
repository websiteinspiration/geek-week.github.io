<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧚🏽 👶 👞 友達CI、ユニットテスト、データベースを作成する 🕺🏾 🙏🏽 👨🏾‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事は、CIでのデータベースとの相互作用をテストすることに関するものです。dockerとtestcontainersを使用したいくつかのソリューションを見ましたが、私には自分のソリューションがあり、それを共有したいと思っています。
 
 私の過去のJavaプロジェクトはデータベースと密接に結びつ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>友達CI、ユニットテスト、データベースを作成する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事は、CIでのデータベースとの相互作用をテストすることに関するものです。</font><font style="vertical-align: inherit;">dockerとtestcontainersを使用したいくつかのソリューションを見ましたが、私には自分のソリューションがあり、それを共有したいと思っています。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の過去のJavaプロジェクトはデータベースと密接に結びついていました。再試行、マルチスレッディング、ロックロックを伴う長い処理。このタスクでは、トリッキーなSQLクエリをいくつか修正する必要がありました。どういうわけか、コードをテストでカバーすることに慣れていましたが、その前はすべてのSQLがプリミティブクエリに削減され、メモリ内のH2ベースで実行できました。そして、ハードコア。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は手で簡単なSQLをテストし、臆病に自己テストをハンマーで叩いて、「私はなんらかのバグではなく、簡単なコードで間違いを犯す」と正当化しました。実際には、テストを利用できるため、エラーの発生頻度は低くなります。テスターに​​責任を押し付けることは可能でした-私がどこかでミスをしたら、彼らはそれを見つけるでしょう。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単体テストのイデオロギーによれば、テストは個々のモジュールをテストする場合にのみ必要であり、モジュールが外部から何かを使用する場合は、スタブに置き換える必要があります。実際には、スタブの実装が難しくなりすぎた場合、モジュールは単に無視されます。速度とモジュール性は重要ですが、カバレッジ指標に表示されない場合でも、コードをテストしないでおくことはより重要です。したがって、モジュールは個別のクラスではなく、接続されたグループと見なされます。このようなステートメントの主なことは、クラスターレベルに拡張するユニットの概念に到達しないことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルテストの場合、各開発者には独自のスキームがありますが、テストはJenkinsで実行され、データベースへの接続はまだありません。</font><font style="vertical-align: inherit;">CIには別の回路が必要ですが、それは明白なようです。</font><font style="vertical-align: inherit;">しかし、空の図では、テストを実行することはあまり適切ではありません。各テストでデータベース構造を作成するのは時間がかかり、テストの構造とバトルの構造に矛盾が生じます。</font><font style="vertical-align: inherit;">事前に準備されたベースで実行します-私はブランチでたくさんの問題を抱えています。</font><font style="vertical-align: inherit;">liquibaseを使用してすべてのテストを実行する前にデータベースを準備し、最初にすべてをゼロにクリアしてから、最新バージョンに更新できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロールバックはファイナライズするのを忘れがちで、テスト環境で手でベースをクリーンアップする必要があります。</font><font style="vertical-align: inherit;">それと彼をテストしてください！</font><font style="vertical-align: inherit;">アルゴリズムは次のとおりです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルートの下のすべてを削除します（実験の純粋さのため）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新バージョンに更新</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1-2バージョンのロールバックを実行する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新バージョンに更新します（新しいデータベース構造でテストを実行する必要があります。さらに、ロールバックで何も削除されていないことを確認すると、更新が再度行われないようになります）。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者の同僚は、各テストの開始時にロールバックテストを実行したくありません。</font><font style="vertical-align: inherit;">切り替えます。</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.doRollbackTest = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'test.rollback.enabled'</span>] <span class="hljs-keyword">as</span> String) }
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
猫のトレーニングがありますが、すべて問題ありません。</font><font style="vertical-align: inherit;">しかし、動的に開発しているプロジェクトは独自の調整を行います-2つのプルクエスト、同時アセンブリ。</font><font style="vertical-align: inherit;">1つのインスタンスは何かをテストしており、2番目のインスタンスはベースを足元からノックしています。</font><font style="vertical-align: inherit;">これは、並列アセンブリの単純な禁止によって解決されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして再び秋-Jenkinsアカウントを使用してテストを実行することにしました。</font><font style="vertical-align: inherit;">すべてが個人的なもので問題なく、リクエストのプールは不明確な理由で落ちます。</font><font style="vertical-align: inherit;">DevOpsは文化であり、個人的な目的でのテクニカルアカウントの使用は受け入れられないという熱烈な話を思い出します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストのプールが10個蓄積されました。収集、再配布されたすべてをマージできます。最初のものは行き、メインブランチは変わりました-残りは一緒に再構築のために並んでいます。進行中にマージすることもできますが、優先順位があります。コードのエラーが原因で、緊急性の高いプルリクエスト、緊急性の低いプルリクエストもハングアップします。一般に、並列化して戻します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立ては単純で、簡単な手順で構成され、昨日の学生にも理解できる必要があります。 99％では、要求と解放プールのアセンブリが順次であり、並列ではないという問題はありません。レビューで1〜2を超えるPRが蓄積されない場合は、同時アセンブリの禁止で十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、並列起動には、実行中の各テストが排他的にアクセスできるベースまたはスキームが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オプション1は動的に割り当てることです。データベースでのスキーマの作成は高速です。 APIを備えたクラウドがあれば、そこにデータベースを割り当てることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古いデータベースの削除がうまくいかない場合は、テストが落ちてリソースを解放することを「忘れる」ときに、ディスク領域をすぐに終了できます。それは「場合」ではなく「時」です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オプション2-個別の管理サービスを備えたデータベース/スキーマプール。 APIが出て、当面のベースを提供し、期間の前に無料ベースを取り戻します。それが返すもの：データベースまたは単なる回路図を備えた専用サーバー、それは問題ではありません。主なことは、リソースが回復不能に失われないことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オプション3-自主規制のための拠点/スキームのプール。ロックおよびデータベースプール自体に関する情報を交換するには、リソースが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後者のオプションを選択しました。固定するのが簡単で、特にサポートする必要がないためです。</font><font style="vertical-align: inherit;">ロジックは次のとおりです-いくつか（たとえば10）の回路が作成され、それらに接続するために必要なすべての情報が共有リソースに追加されます。各テストインスタンスは、開始前に開始マークを付け、終了後に削除します。</font><font style="vertical-align: inherit;">ファイナライズの前にテストがクラッシュした場合、タイムアウトの終わりに回路は空いていると見なされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読書設定：</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.localConfig = new Properties()<font></font>
    localConfig.load(file(<span class="hljs-string">"<span class="hljs-subst">${rootDir}</span>/local.properties"</span>).newReader())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GradleスクリプトからSQLを操作するには、ドライバーの読み込みが必要です。</font></font><br>
<pre><code class="kotlin hljs">    configurations {<font></font>
        driver<font></font>
    }<font></font>
    dependencies {<font></font>
        driver group: <span class="hljs-string">"oracle"</span>, name: <span class="hljs-string">"ojdbc6"</span>, version: <span class="hljs-string">"11.+"</span><font></font>
    }<font></font>
    task initDriver {<font></font>
        doLast {<font></font>
            ClassLoader loader = GroovyObject.<span class="hljs-keyword">class</span>.classLoader<font></font>
            configurations.driver.each { File file -&gt;<font></font>
                loader.addURL(file.toURL())<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続：</font></font><br>
<br>
<pre><code class="kotlin hljs">    <span class="hljs-keyword">import</span> groovy.sql.Sql<font></font>
    project.ext.createSqlInstance = {<font></font>
        <span class="hljs-keyword">return</span> Sql.newInstance(<font></font>
                url: localConfig[<span class="hljs-string">"pool.db.url"</span>],<font></font>
                user: localConfig[<span class="hljs-string">"pool.db.username"</span>],<font></font>
                password: localConfig[<span class="hljs-string">"pool.db.password"</span>],<font></font>
                driver: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>])<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
情報交換は、データベーステーブルを介して実行できます。</font><font style="vertical-align: inherit;">参照テーブルの初期化（一度動作するはずです。その後、テーブルは時間の終わりまで存続します）：</font></font><br>
<br>
<pre><code class="kotlin hljs">    task initDbPool {<font></font>
        dependsOn initDriver<font></font>
        doLast {<font></font>
            Integer poolSize = <span class="hljs-number">10</span>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            String baseName = localConfig[<span class="hljs-string">"pool.db.baseName"</span>]<font></font>
            String basePass = localConfig[<span class="hljs-string">"pool.db.basePass"</span>]<font></font>
            String token = <span class="hljs-string">"{id}"</span>
            List tableExists = sql.rows(<span class="hljs-string">"select table_name from all_tables where table_name=?"</span>, [tableName])<font></font>
            assert tableExists.isEmpty()<font></font>
            sql.execute(<span class="hljs-string">"""
                CREATE TABLE <span class="hljs-subst">${tableName}</span> (
                ID NUMBER(2) NOT NULL PRIMARY KEY,
                METADATA VARCHAR2(200) NOT NULL,
                PROCESSED TIMESTAMP NULL,
                GUID VARCHAR2(36) NULL)
            """</span>, [])<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (Integer i = <span class="hljs-number">0</span> ; i &lt; poolSize ; i++) {<font></font>
                String username = baseName.replace(token, i.toString())<font></font>
                String password = basePass.replace(token, i.toString())<font></font>
                sql.execute(<span class="hljs-string">"""
                    CREATE USER <span class="hljs-subst">${username}</span>
                    IDENTIFIED BY "<span class="hljs-subst">${password}</span>"
                    DEFAULT TABLESPACE USERS
                    TEMPORARY TABLESPACE TEMP
                    PROFILE DEFAULT
                    QUOTA UNLIMITED ON USERS
                """</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant connect to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create sequence to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create session to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create table to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                String metadata = JsonOutput.toJson([<font></font>
                    <span class="hljs-string">"app.db.driverClass"</span>: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>],
                    <span class="hljs-string">"app.db.url"</span>: localConfig[<span class="hljs-string">"pool.db.url"</span>],
                    <span class="hljs-string">"app.db.username"</span>: username,
                    <span class="hljs-string">"app.db.password"</span>: password<font></font>
                        ])<font></font>
<font></font>
                sql.execute(<span class="hljs-string">"""
                    INSERT INTO <span class="hljs-subst">${tableName}</span> (id, metadata)
                    values (?, ?)
                """</span>, [i, metadata])<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者にはデバッグとアセンブリのための独自のスキームがあるため、プールの使用をオフにする必要があります。</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.isCiBuild = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'pool.db.enabled'</span>] <span class="hljs-keyword">as</span> String) }
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テイクアンドフリーベース：</font></font><br>
<br>
<pre><code class="kotlin hljs">    task lockDb {<font></font>
        dependsOn initDriver<font></font>
        onlyIf isCiBuild<font></font>
        doLast {<font></font>
            project.ext.lockUid = UUID.randomUUID().toString()<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            sql.executeUpdate(<span class="hljs-string">"""UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = ?, PROCESSED = SYSDATE
                    WHERE ID IN (
                        SELECT ID FROM (
                            SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN
                            FROM <span class="hljs-subst">${tableName}</span> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE'))
                        ) WHERE RN = 1
                    )
                    """</span>, [lockUid, <span class="hljs-number">15</span>])<font></font>
<font></font>
            def meta = sql.firstRow(<span class="hljs-string">"SELECT METADATA FROM <span class="hljs-subst">${tableName}</span> WHERE GUID = ?"</span>, [lockUid])<font></font>
            assert meta != <span class="hljs-literal">null</span>, <span class="hljs-string">"No free databases in pool"</span><font></font>
            def slurper = new JsonSlurper()<font></font>
            Map metadata = slurper.parseText(meta[<span class="hljs-string">"METADATA"</span>] <span class="hljs-keyword">as</span> String) <span class="hljs-keyword">as</span> Map<font></font>
            localConfig.putAll(metadata)<font></font>
            logger.info(<span class="hljs-string">"Database locked, {}"</span>, metadata)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    task unlockDb {<font></font>
        dependsOn lockDb <span class="hljs-comment">// init lockUid</span><font></font>
        onlyIf isCiBuild<font></font>
        doLast {<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
                Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
                sql.executeUpdate(<span class="hljs-string">"UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = NULL WHERE GUID = ?"</span>,<font></font>
                        [lockUid])<font></font>
                logger.info(<span class="hljs-string">"Database unlocked"</span>)<font></font>
            } <span class="hljs-keyword">catch</span> (ignored) {<font></font>
                logger.error(ignored)<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2回続けてビルドする場合、異なるスキームを選択でき、プロパティファイルをアセンブルするときに、異なる置換値が残ります。</font><font style="vertical-align: inherit;">ローカル起動の場合、設定は静的です。</font></font><br>
<br>
<pre><code class="kotlin hljs">    configure([processResources, processTestResources]) { Task t -&gt;
        <span class="hljs-keyword">if</span> (project.ext.isCiBuild()) {<font></font>
            t.outputs.upToDateWhen { <span class="hljs-literal">false</span> }<font></font>
        }<font></font>
        t.filesMatching(<span class="hljs-string">'**/*.properties'</span>) {<font></font>
            filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string">'${'</span>, endToken: <span class="hljs-string">'}'</span>)<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロールバックをテストするためのタスク：</font></font><br>
<br>
<pre><code class="kotlin hljs">    task restoreAfterRollbackTest(type: LiquibaseTask) {<font></font>
        command = <span class="hljs-string">'update'</span><font></font>
    }<font></font>
<font></font>
    task rollbackTest(type: LiquibaseTask) {<font></font>
        dependsOn lockDb<font></font>
        command = <span class="hljs-string">'rollback'</span>
        requiresValue = <span class="hljs-literal">true</span><font></font>
        doFirst {<font></font>
            project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string">'test.rollback.tag'</span>]<font></font>
        }<font></font>
        doLast {<font></font>
            project.ext.liquibaseCommandValue = <span class="hljs-literal">null</span><font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、実行順序を設定します。</font></font><br>
<br>
<pre><code class="kotlin hljs">    configure([project]) {<font></font>
        tasks.withType(LiquibaseTask.<span class="hljs-keyword">class</span>) { LiquibaseTask t -&gt;<font></font>
            logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), configLiquibase.getName())<font></font>
            (t <span class="hljs-keyword">as</span> Task).dependsOn configLiquibase
            <span class="hljs-keyword">if</span> (isCiBuild()) {<font></font>
                logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), lockDb.getName())<font></font>
                (t <span class="hljs-keyword">as</span> Task).dependsOn lockDb<font></font>
                (t <span class="hljs-keyword">as</span> Task).finalizedBy unlockDb<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment">//   CI:</span>
        <span class="hljs-comment">// 1.    0 (dropAll)</span>
        <span class="hljs-comment">// 2.     rollback (update)</span>
        <span class="hljs-comment">// 3. ,       (rollback tag)</span>
        <span class="hljs-comment">// 4.      (update)</span>
        <span class="hljs-comment">// 5.    </span>
        <span class="hljs-keyword">if</span> (doRollbackTest()) {<font></font>
            def setTaskOrdering = { List&lt;Task&gt; lst -&gt;<font></font>
                <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; lst.size() - <span class="hljs-number">1</span>; i++) {<font></font>
                    logger.info(<span class="hljs-string">"Task {} must run after {}"</span>, lst[i + <span class="hljs-number">1</span>].getName(), lst[i].getName())<font></font>
                    lst[i + <span class="hljs-number">1</span>].dependsOn lst[i]<font></font>
                }<font></font>
            }<font></font>
<font></font>
            setTaskOrdering([<font></font>
                    lockDb,<font></font>
                    configLiquibase,<font></font>
                    dropAll,<font></font>
                    update,<font></font>
                    rollbackTest,<font></font>
                    restoreAfterRollbackTest,<font></font>
                    processTestResources,<font></font>
                    test,<font></font>
            ])<font></font>
<font></font>
            lockDb.finalizedBy unlockDb<font></font>
            test.finalizedBy unlockDb<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベース割り当てとロールバックテストは、テスト内に配置できます。</font><font style="vertical-align: inherit;">すべてのテストが完了する前後にコードを実行する方法：Junit5では、これはTestNG BeforeSuiteのBeforeAllCallbackです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「なぜSQLはJavaプログラマーによってテストされるべきなのか」という質問に対する答えは、すべてのコードをテストする必要があるということです。</font><font style="vertical-align: inherit;">例外があり、特定の時間にテストするのに不合理なコードもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースとの相互作用をテストする問題が他のプログラマーによってどのように解決されるのか知りたいのですが？</font><font style="vertical-align: inherit;">コンテナがすべての家に届きましたか、それとも統合テストがテスターの肩に渡っていますか？</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全リスト</font></font></b><div class="spoiler_text"><pre><code class="kotlin hljs"><span class="hljs-keyword">import</span> groovy.json.JsonOutput
<span class="hljs-keyword">import</span> groovy.json.JsonSlurper
<span class="hljs-keyword">import</span> groovy.sql.Sql
<span class="hljs-keyword">import</span> org.apache.tools.ant.filters.ReplaceTokens
<span class="hljs-keyword">import</span> org.liquibase.gradle.LiquibaseTask<font></font>
<font></font>
plugins {<font></font>
    id <span class="hljs-string">'java'</span>
    id <span class="hljs-string">'org.liquibase.gradle'</span> version <span class="hljs-string">'2.0.1'</span><font></font>
}<font></font>
<font></font>
configurations {<font></font>
    driver<font></font>
}<font></font>
<font></font>
repositories {<font></font>
    jcenter()<font></font>
    mavenCentral()<font></font>
    maven {<font></font>
        url = <span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span><font></font>
    }<font></font>
}<font></font>
<font></font>
dependencies {<font></font>
    implementation <span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span>
    implementation <span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span>
    implementation <span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span>
    implementation <span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span><font></font>
<font></font>
    testImplementation <span class="hljs-string">'junit:junit:4.12'</span>
    testImplementation <span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span><font></font>
<font></font>
    testRuntime <span class="hljs-string">'oracle:ojdbc6:11.+'</span><font></font>
<font></font>
    liquibaseRuntime <span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span>
    liquibaseRuntime <span class="hljs-string">'oracle:ojdbc6:11.+'</span>
    liquibaseRuntime <span class="hljs-string">'org.yaml:snakeyaml:1.24'</span><font></font>
<font></font>
<font></font>
    driver group: <span class="hljs-string">"oracle"</span>, name: <span class="hljs-string">"ojdbc6"</span>, version: <span class="hljs-string">"11.+"</span><font></font>
}<font></font>
<font></font>
project.ext.localConfig = new Properties()<font></font>
localConfig.load(file(<span class="hljs-string">"<span class="hljs-subst">${rootDir}</span>/local.properties"</span>).newReader())<font></font>
<font></font>
project.ext.isCiBuild = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'pool.db.enabled'</span>] <span class="hljs-keyword">as</span> String) }<font></font>
<font></font>
project.ext.doRollbackTest = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'test.rollback.enabled'</span>] <span class="hljs-keyword">as</span> String) }<font></font>
<font></font>
task configLiquibase {<font></font>
    doLast {<font></font>
        liquibase {<font></font>
            activities {<font></font>
                testdb {<font></font>
                    changeLogFile <span class="hljs-string">'changelog.yaml'</span>
                    url localConfig[<span class="hljs-string">'app.db.url'</span>]<font></font>
                    driver localConfig[<span class="hljs-string">'app.db.driverClass'</span>]<font></font>
                    username localConfig[<span class="hljs-string">'app.db.username'</span>]<font></font>
                    password localConfig[<span class="hljs-string">'app.db.password'</span>]<font></font>
                    logLevel <span class="hljs-string">'debug'</span>
                    classpath <span class="hljs-string">"<span class="hljs-subst">${project.projectDir}</span>/db"</span>
                    contexts <span class="hljs-string">'main'</span><font></font>
                }<font></font>
                runList = <span class="hljs-string">'testdb'</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
task initDriver {<font></font>
    doLast {<font></font>
        ClassLoader loader = GroovyObject.<span class="hljs-keyword">class</span>.classLoader<font></font>
        configurations.driver.each { File file -&gt;<font></font>
            loader.addURL(file.toURL())<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
project.ext.createSqlInstance = {<font></font>
    return Sql.newInstance(<font></font>
            url: localConfig[<span class="hljs-string">"pool.db.url"</span>],<font></font>
            user: localConfig[<span class="hljs-string">"pool.db.username"</span>],<font></font>
            password: localConfig[<span class="hljs-string">"pool.db.password"</span>],<font></font>
            driver: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>])<font></font>
}<font></font>
<font></font>
task initDbPool {<font></font>
    dependsOn initDriver<font></font>
    doLast {<font></font>
        Integer poolSize = <span class="hljs-number">10</span>
        Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
        String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
        String baseName = localConfig[<span class="hljs-string">"pool.db.baseName"</span>]<font></font>
        String basePass = localConfig[<span class="hljs-string">"pool.db.basePass"</span>]<font></font>
        String token = <span class="hljs-string">"{id}"</span>
        List tableExists = sql.rows(<span class="hljs-string">"select table_name from all_tables where table_name=?"</span>, [tableName])<font></font>
        assert tableExists.isEmpty()<font></font>
        sql.execute(<span class="hljs-string">"""
            CREATE TABLE <span class="hljs-subst">${tableName}</span> (
            ID NUMBER(2) NOT NULL PRIMARY KEY,
            METADATA VARCHAR2(200) NOT NULL,
            PROCESSED TIMESTAMP NULL,
            GUID VARCHAR2(36) NULL)
        """</span>, [])<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (Integer i = <span class="hljs-number">0</span> ; i &lt; poolSize ; i++) {<font></font>
            String username = baseName.replace(token, i.toString())<font></font>
            String password = basePass.replace(token, i.toString())<font></font>
            sql.execute(<span class="hljs-string">"""
                CREATE USER <span class="hljs-subst">${username}</span>
                IDENTIFIED BY "<span class="hljs-subst">${password}</span>"
                DEFAULT TABLESPACE USERS
                TEMPORARY TABLESPACE TEMP
                PROFILE DEFAULT
                QUOTA UNLIMITED ON USERS
            """</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant connect to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create sequence to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create session to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create table to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            String metadata = JsonOutput.toJson([<font></font>
                <span class="hljs-string">"app.db.driverClass"</span>: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>],
                <span class="hljs-string">"app.db.url"</span>: localConfig[<span class="hljs-string">"pool.db.url"</span>],
                <span class="hljs-string">"app.db.username"</span>: username,
                <span class="hljs-string">"app.db.password"</span>: password<font></font>
                    ])<font></font>
<font></font>
            sql.execute(<span class="hljs-string">"""
                INSERT INTO <span class="hljs-subst">${tableName}</span> (id, metadata)
                values (?, ?)
            """</span>, [i, metadata])<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
task lockDb {<font></font>
    dependsOn initDriver<font></font>
    onlyIf isCiBuild<font></font>
    doLast {<font></font>
        project.ext.lockUid = UUID.randomUUID().toString()<font></font>
        String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
        Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
        sql.executeUpdate(<span class="hljs-string">"""UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = ?, PROCESSED = SYSDATE
                WHERE ID IN (
                    SELECT ID FROM (
                        SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN
                        FROM <span class="hljs-subst">${tableName}</span> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE'))
                    ) WHERE RN = 1
                )
                """</span>, [lockUid, <span class="hljs-number">15</span>])<font></font>
<font></font>
        def meta = sql.firstRow(<span class="hljs-string">"SELECT METADATA FROM <span class="hljs-subst">${tableName}</span> WHERE GUID = ?"</span>, [lockUid])<font></font>
        assert meta != <span class="hljs-literal">null</span>, <span class="hljs-string">"No free databases in pool"</span><font></font>
        def slurper = new JsonSlurper()<font></font>
        Map metadata = slurper.parseText(meta[<span class="hljs-string">"METADATA"</span>] <span class="hljs-keyword">as</span> String) <span class="hljs-keyword">as</span> Map<font></font>
        localConfig.putAll(metadata)<font></font>
        logger.info(<span class="hljs-string">"Database locked, {}"</span>, metadata)<font></font>
    }<font></font>
}<font></font>
<font></font>
task unlockDb {<font></font>
    dependsOn lockDb <span class="hljs-comment">// init lockUid</span><font></font>
    onlyIf isCiBuild<font></font>
    doLast {<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            sql.executeUpdate(<span class="hljs-string">"UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = NULL WHERE GUID = ?"</span>,<font></font>
                    [lockUid])<font></font>
            logger.info(<span class="hljs-string">"Database unlocked"</span>)<font></font>
        } <span class="hljs-keyword">catch</span> (ignored) {<font></font>
            logger.error(ignored)<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
configure([processResources, processTestResources]) { Task t -&gt;<font></font>
    <span class="hljs-keyword">if</span> (project.ext.isCiBuild()) {<font></font>
        t.outputs.upToDateWhen { <span class="hljs-literal">false</span> }<font></font>
    }<font></font>
    t.filesMatching(<span class="hljs-string">'**/*.properties'</span>) {<font></font>
        filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string">'${'</span>, endToken: <span class="hljs-string">'}'</span>)<font></font>
    }<font></font>
}<font></font>
<font></font>
task restoreAfterRollbackTest(type: LiquibaseTask) {<font></font>
    command = <span class="hljs-string">'update'</span><font></font>
}<font></font>
<font></font>
task rollbackTest(type: LiquibaseTask) {<font></font>
    dependsOn lockDb<font></font>
    command = <span class="hljs-string">'rollback'</span>
    requiresValue = <span class="hljs-literal">true</span><font></font>
    doFirst {<font></font>
        project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string">'test.rollback.tag'</span>]<font></font>
    }<font></font>
    doLast {<font></font>
        project.ext.liquibaseCommandValue = <span class="hljs-literal">null</span><font></font>
    }<font></font>
}<font></font>
<font></font>
configure([project]) {<font></font>
    tasks.withType(LiquibaseTask.<span class="hljs-keyword">class</span>) { LiquibaseTask t -&gt;<font></font>
        logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), configLiquibase.getName())<font></font>
        (t <span class="hljs-keyword">as</span> Task).dependsOn configLiquibase
        <span class="hljs-keyword">if</span> (isCiBuild()) {<font></font>
            logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), lockDb.getName())<font></font>
            (t <span class="hljs-keyword">as</span> Task).dependsOn lockDb<font></font>
            (t <span class="hljs-keyword">as</span> Task).finalizedBy unlockDb<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">//   CI:</span>
    <span class="hljs-comment">// 1.    0 (dropAll)</span>
    <span class="hljs-comment">// 2.     rollback (update)</span>
    <span class="hljs-comment">// 3. ,       (rollback tag)</span>
    <span class="hljs-comment">// 4.      (update)</span>
    <span class="hljs-comment">// 5.    </span>
    <span class="hljs-keyword">if</span> (doRollbackTest()) {<font></font>
        def setTaskOrdering = { List&lt;Task&gt; lst -&gt;<font></font>
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; lst.size() - <span class="hljs-number">1</span>; i++) {<font></font>
                logger.info(<span class="hljs-string">"Task {} must run after {}"</span>, lst[i + <span class="hljs-number">1</span>].getName(), lst[i].getName())<font></font>
                lst[i + <span class="hljs-number">1</span>].dependsOn lst[i]<font></font>
            }<font></font>
        }<font></font>
<font></font>
        setTaskOrdering([<font></font>
                lockDb,<font></font>
                configLiquibase,<font></font>
                dropAll,<font></font>
                update,<font></font>
                rollbackTest,<font></font>
                restoreAfterRollbackTest,<font></font>
                processTestResources,<font></font>
                test,<font></font>
        ])<font></font>
<font></font>
        lockDb.finalizedBy unlockDb<font></font>
        test.finalizedBy unlockDb<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<pre><code class="bash hljs">pool.db.enabled=<span class="hljs-literal">false</span>
test.rollback.enabled=<span class="hljs-literal">true</span><font></font>
<font></font>
pool.db.driverClass=oracle.jdbc.driver.OracleDriver<font></font>
pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB<font></font>
pool.db.username=SYSTEM<font></font>
pool.db.password=Oradoc_db1<font></font>
<font></font>
pool.db.referenceTable=c<span class="hljs-comment">##test_user1.REF_TABLE</span>
pool.db.baseName=C<span class="hljs-comment">##CI_SCHEMA_{id}</span><font></font>
pool.db.basePass=CI_SCHEMA_{id}_PASS<font></font>
<font></font>
app.db.driverClass=<font></font>
app.db.url=<font></font>
app.db.username=<font></font>
app.db.password=<font></font>
<font></font>
test.rollback.tag=version_1<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452706/index.html">1983年に、Bella Labsのこのコンピューターは最初のグランドマスターになりました。</a></li>
<li><a href="../ja452712/index.html">私たちがチームで仕事をしようとした方法と、それから生まれたもの</a></li>
<li><a href="../ja452714/index.html">注意5：製品の思考、行動心理学、生産性に関する記事のダイジェスト</a></li>
<li><a href="../ja452716/index.html">人材の活用の最適点を求めて</a></li>
<li><a href="../ja452718/index.html">PsyGuide：注意不足。＃0001/1001</a></li>
<li><a href="../ja452724/index.html">フェニックスライブビュー：JavaScriptコードが楽しいとき*</a></li>
<li><a href="../ja452726/index.html">かわいい骨3D：プラスチックの頭蓋骨の欠陥のための超弾性骨材料</a></li>
<li><a href="../ja452730/index.html">標準セグメントの原則に基づく情報システムの認証。神話と現実</a></li>
<li><a href="../ja452734/index.html">ビットコードを使用してiOS（ARM）アプリケーションをmacOS（x86）に自動的に移行する</a></li>
<li><a href="../ja452736/index.html">SecureDialoguesでのメッセージの暗号化</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>