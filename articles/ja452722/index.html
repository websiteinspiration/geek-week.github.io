<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§šğŸ½ ğŸ‘¶ ğŸ‘ å‹é”CIã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ğŸ•ºğŸ¾ ğŸ™ğŸ½ ğŸ‘¨ğŸ¾â€ğŸ’»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã®è¨˜äº‹ã¯ã€CIã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ç›¸äº’ä½œç”¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚dockerã¨testcontainersã‚’ä½¿ç”¨ã—ãŸã„ãã¤ã‹ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¾ã—ãŸãŒã€ç§ã«ã¯è‡ªåˆ†ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ãã‚Œã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
 
 ç§ã®éå»ã®Javaãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨å¯†æ¥ã«çµã³ã¤...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å‹é”CIã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="ç”»åƒ"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®è¨˜äº‹ã¯ã€CIã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ç›¸äº’ä½œç”¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚</font><font style="vertical-align: inherit;">dockerã¨testcontainersã‚’ä½¿ç”¨ã—ãŸã„ãã¤ã‹ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¾ã—ãŸãŒã€ç§ã«ã¯è‡ªåˆ†ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã€ãã‚Œã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§ã®éå»ã®Javaãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨å¯†æ¥ã«çµã³ã¤ã„ã¦ã„ã¾ã—ãŸã€‚å†è©¦è¡Œã€ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ã€ãƒ­ãƒƒã‚¯ãƒ­ãƒƒã‚¯ã‚’ä¼´ã†é•·ã„å‡¦ç†ã€‚ã“ã®ã‚¿ã‚¹ã‚¯ã§ã¯ã€ãƒˆãƒªãƒƒã‚­ãƒ¼ãªSQLã‚¯ã‚¨ãƒªã‚’ã„ãã¤ã‹ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ã©ã†ã„ã†ã‚ã‘ã‹ã€ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼ã™ã‚‹ã“ã¨ã«æ…£ã‚Œã¦ã„ã¾ã—ãŸãŒã€ãã®å‰ã¯ã™ã¹ã¦ã®SQLãŒãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒªã«å‰Šæ¸›ã•ã‚Œã€ãƒ¡ãƒ¢ãƒªå†…ã®H2ãƒ™ãƒ¼ã‚¹ã§å®Ÿè¡Œã§ãã¾ã—ãŸã€‚ãã—ã¦ã€ãƒãƒ¼ãƒ‰ã‚³ã‚¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§ã¯æ‰‹ã§ç°¡å˜ãªSQLã‚’ãƒ†ã‚¹ãƒˆã—ã€è‡†ç—…ã«è‡ªå·±ãƒ†ã‚¹ãƒˆã‚’ãƒãƒ³ãƒãƒ¼ã§å©ã„ã¦ã€ã€Œç§ã¯ãªã‚“ã‚‰ã‹ã®ãƒã‚°ã§ã¯ãªãã€ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã§é–“é•ã„ã‚’çŠ¯ã™ã€ã¨æ­£å½“åŒ–ã—ã¾ã—ãŸã€‚å®Ÿéš›ã«ã¯ã€ãƒ†ã‚¹ãƒˆã‚’åˆ©ç”¨ã§ãã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿé »åº¦ã¯ä½ããªã‚Šã¾ã™ã€‚ãƒ†ã‚¹ã‚¿ãƒ¼ã«â€‹â€‹è²¬ä»»ã‚’æŠ¼ã—ä»˜ã‘ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã—ãŸ-ç§ãŒã©ã“ã‹ã§ãƒŸã‚¹ã‚’ã—ãŸã‚‰ã€å½¼ã‚‰ã¯ãã‚Œã‚’è¦‹ã¤ã‘ã‚‹ã§ã—ã‚‡ã†ã€‚</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="ç”»åƒ"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å˜ä½“ãƒ†ã‚¹ãƒˆã®ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼ã«ã‚ˆã‚Œã°ã€ãƒ†ã‚¹ãƒˆã¯å€‹ã€…ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã«ã®ã¿å¿…è¦ã§ã‚ã‚Šã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå¤–éƒ¨ã‹ã‚‰ä½•ã‹ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã‚¹ã‚¿ãƒ–ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã«ã¯ã€ã‚¹ã‚¿ãƒ–ã®å®Ÿè£…ãŒé›£ã—ããªã‚Šã™ããŸå ´åˆã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å˜ã«ç„¡è¦–ã•ã‚Œã¾ã™ã€‚é€Ÿåº¦ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ€§ã¯é‡è¦ã§ã™ãŒã€ã‚«ãƒãƒ¬ãƒƒã‚¸æŒ‡æ¨™ã«è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã§ã‚‚ã€ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ãªã„ã§ãŠãã“ã¨ã¯ã‚ˆã‚Šé‡è¦ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å€‹åˆ¥ã®ã‚¯ãƒ©ã‚¹ã§ã¯ãªãã€æ¥ç¶šã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®ä¸»ãªã“ã¨ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«ã«æ‹¡å¼µã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆã®æ¦‚å¿µã«åˆ°é”ã—ãªã„ã“ã¨ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã®å ´åˆã€å„é–‹ç™ºè€…ã«ã¯ç‹¬è‡ªã®ã‚¹ã‚­ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆã¯Jenkinsã§å®Ÿè¡Œã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">CIã«ã¯åˆ¥ã®å›è·¯ãŒå¿…è¦ã§ã™ãŒã€ãã‚Œã¯æ˜ç™½ãªã‚ˆã†ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ç©ºã®å›³ã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã‚ã¾ã‚Šé©åˆ‡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å„ãƒ†ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã‚’ä½œæˆã™ã‚‹ã®ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã€ãƒ†ã‚¹ãƒˆã®æ§‹é€ ã¨ãƒãƒˆãƒ«ã®æ§‹é€ ã«çŸ›ç›¾ãŒç”Ÿã˜ã¾ã™ã€‚</font><font style="vertical-align: inherit;">äº‹å‰ã«æº–å‚™ã•ã‚ŒãŸãƒ™ãƒ¼ã‚¹ã§å®Ÿè¡Œã—ã¾ã™-ç§ã¯ãƒ–ãƒ©ãƒ³ãƒã§ãŸãã•ã‚“ã®å•é¡Œã‚’æŠ±ãˆã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">liquibaseã‚’ä½¿ç”¨ã—ã¦ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æº–å‚™ã—ã€æœ€åˆã«ã™ã¹ã¦ã‚’ã‚¼ãƒ­ã«ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ãƒ•ã‚¡ã‚¤ãƒŠãƒ©ã‚¤ã‚ºã™ã‚‹ã®ã‚’å¿˜ã‚ŒãŒã¡ã§ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§æ‰‹ã§ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã¨å½¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼</font><font style="vertical-align: inherit;">ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ«ãƒ¼ãƒˆã®ä¸‹ã®ã™ã¹ã¦ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå®Ÿé¨“ã®ç´”ç²‹ã•ã®ãŸã‚ï¼‰</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1-2ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã—ã¾ã™ï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ä½•ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¨ã€æ›´æ–°ãŒå†åº¦è¡Œã‚ã‚Œãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼‰ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é–‹ç™ºè€…ã®åŒåƒšã¯ã€å„ãƒ†ã‚¹ãƒˆã®é–‹å§‹æ™‚ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.doRollbackTest = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'test.rollback.enabled'</span>] <span class="hljs-keyword">as</span> String) }
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çŒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒã‚ã‚Šã¾ã™ãŒã€ã™ã¹ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€å‹•çš„ã«é–‹ç™ºã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ç‹¬è‡ªã®èª¿æ•´ã‚’è¡Œã„ã¾ã™-2ã¤ã®ãƒ—ãƒ«ã‚¯ã‚¨ã‚¹ãƒˆã€åŒæ™‚ã‚¢ã‚»ãƒ³ãƒ–ãƒªã€‚</font><font style="vertical-align: inherit;">1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä½•ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãŠã‚Šã€2ç•ªç›®ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ãƒ™ãƒ¼ã‚¹ã‚’è¶³å…ƒã‹ã‚‰ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€ä¸¦åˆ—ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®å˜ç´”ãªç¦æ­¢ã«ã‚ˆã£ã¦è§£æ±ºã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="ç”»åƒ"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦å†ã³ç§‹-Jenkinsã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã™ã¹ã¦ãŒå€‹äººçš„ãªã‚‚ã®ã§å•é¡Œãªãã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ—ãƒ¼ãƒ«ã¯ä¸æ˜ç¢ºãªç†ç”±ã§è½ã¡ã¾ã™ã€‚</font><font style="vertical-align: inherit;">DevOpsã¯æ–‡åŒ–ã§ã‚ã‚Šã€å€‹äººçš„ãªç›®çš„ã§ã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½¿ç”¨ã¯å—ã‘å…¥ã‚Œã‚‰ã‚Œãªã„ã¨ã„ã†ç†±çƒˆãªè©±ã‚’æ€ã„å‡ºã—ã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="ç”»åƒ"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ—ãƒ¼ãƒ«ãŒ10å€‹è“„ç©ã•ã‚Œã¾ã—ãŸã€‚åé›†ã€å†é…å¸ƒã•ã‚ŒãŸã™ã¹ã¦ã‚’ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚æœ€åˆã®ã‚‚ã®ã¯è¡Œãã€ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¯å¤‰ã‚ã‚Šã¾ã—ãŸ-æ®‹ã‚Šã¯ä¸€ç·’ã«å†æ§‹ç¯‰ã®ãŸã‚ã«ä¸¦ã‚“ã§ã„ã¾ã™ã€‚é€²è¡Œä¸­ã«ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€å„ªå…ˆé †ä½ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãŒåŸå› ã§ã€ç·Šæ€¥æ€§ã®é«˜ã„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ç·Šæ€¥æ€§ã®ä½ã„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚ä¸€èˆ¬ã«ã€ä¸¦åˆ—åŒ–ã—ã¦æˆ»ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµ„ã¿ç«‹ã¦ã¯å˜ç´”ã§ã€ç°¡å˜ãªæ‰‹é †ã§æ§‹æˆã•ã‚Œã€æ˜¨æ—¥ã®å­¦ç”Ÿã«ã‚‚ç†è§£ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ 99ï¼…ã§ã¯ã€è¦æ±‚ã¨è§£æ”¾ãƒ—ãƒ¼ãƒ«ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªãŒé †æ¬¡ã§ã‚ã‚Šã€ä¸¦åˆ—ã§ã¯ãªã„ã¨ã„ã†å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§1ã€œ2ã‚’è¶…ãˆã‚‹PRãŒè“„ç©ã•ã‚Œãªã„å ´åˆã¯ã€åŒæ™‚ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ç¦æ­¢ã§ååˆ†ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãŸã€ä¸¦åˆ—èµ·å‹•ã«ã¯ã€å®Ÿè¡Œä¸­ã®å„ãƒ†ã‚¹ãƒˆãŒæ’ä»–çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ã‚¹ã‚­ãƒ¼ãƒ ãŒå¿…è¦ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ—ã‚·ãƒ§ãƒ³1ã¯å‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆã¯é«˜é€Ÿã§ã™ã€‚ APIã‚’å‚™ãˆãŸã‚¯ãƒ©ã‚¦ãƒ‰ãŒã‚ã‚Œã°ã€ãã“ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤ã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‰Šé™¤ãŒã†ã¾ãã„ã‹ãªã„å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆãŒè½ã¡ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã™ã‚‹ã“ã¨ã‚’ã€Œå¿˜ã‚Œã‚‹ã€ã¨ãã«ã€ãƒ‡ã‚£ã‚¹ã‚¯é ˜åŸŸã‚’ã™ãã«çµ‚äº†ã§ãã¾ã™ã€‚ãã‚Œã¯ã€Œå ´åˆã€ã§ã¯ãªãã€Œæ™‚ã€ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ—ã‚·ãƒ§ãƒ³2-å€‹åˆ¥ã®ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‚™ãˆãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¹ã‚­ãƒ¼ãƒãƒ—ãƒ¼ãƒ«ã€‚ APIãŒå‡ºã¦ã€å½“é¢ã®ãƒ™ãƒ¼ã‚¹ã‚’æä¾›ã—ã€æœŸé–“ã®å‰ã«ç„¡æ–™ãƒ™ãƒ¼ã‚¹ã‚’å–ã‚Šæˆ»ã—ã¾ã™ã€‚ãã‚ŒãŒè¿”ã™ã‚‚ã®ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯å˜ãªã‚‹å›è·¯å›³ã‚’å‚™ãˆãŸå°‚ç”¨ã‚µãƒ¼ãƒãƒ¼ã€ãã‚Œã¯å•é¡Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸»ãªã“ã¨ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ãŒå›å¾©ä¸èƒ½ã«å¤±ã‚ã‚Œãªã„ã“ã¨ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ—ã‚·ãƒ§ãƒ³3-è‡ªä¸»è¦åˆ¶ã®ãŸã‚ã®æ‹ ç‚¹/ã‚¹ã‚­ãƒ¼ãƒ ã®ãƒ—ãƒ¼ãƒ«ã€‚ãƒ­ãƒƒã‚¯ãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ¼ãƒ«è‡ªä½“ã«é–¢ã™ã‚‹æƒ…å ±ã‚’äº¤æ›ã™ã‚‹ã«ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¾Œè€…ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¾ã—ãŸã€‚å›ºå®šã™ã‚‹ã®ãŒç°¡å˜ã§ã€ç‰¹ã«ã‚µãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ­ã‚¸ãƒƒã‚¯ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™-ã„ãã¤ã‹ï¼ˆãŸã¨ãˆã°10ï¼‰ã®å›è·¯ãŒä½œæˆã•ã‚Œã€ãã‚Œã‚‰ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªã™ã¹ã¦ã®æƒ…å ±ãŒå…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚å„ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€é–‹å§‹å‰ã«é–‹å§‹ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã€çµ‚äº†å¾Œã«å‰Šé™¤ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒŠãƒ©ã‚¤ã‚ºã®å‰ã«ãƒ†ã‚¹ãƒˆãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®çµ‚ã‚ã‚Šã«å›è·¯ã¯ç©ºã„ã¦ã„ã‚‹ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
èª­æ›¸è¨­å®šï¼š</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.localConfig = new Properties()<font></font>
    localConfig.load(file(<span class="hljs-string">"<span class="hljs-subst">${rootDir}</span>/local.properties"</span>).newReader())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gradleã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰SQLã‚’æ“ä½œã™ã‚‹ã«ã¯ã€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®èª­ã¿è¾¼ã¿ãŒå¿…è¦ã§ã™ã€‚</font></font><br>
<pre><code class="kotlin hljs">    configurations {<font></font>
        driver<font></font>
    }<font></font>
    dependencies {<font></font>
        driver group: <span class="hljs-string">"oracle"</span>, name: <span class="hljs-string">"ojdbc6"</span>, version: <span class="hljs-string">"11.+"</span><font></font>
    }<font></font>
    task initDriver {<font></font>
        doLast {<font></font>
            ClassLoader loader = GroovyObject.<span class="hljs-keyword">class</span>.classLoader<font></font>
            configurations.driver.each { File file -&gt;<font></font>
                loader.addURL(file.toURL())<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¥ç¶šï¼š</font></font><br>
<br>
<pre><code class="kotlin hljs">    <span class="hljs-keyword">import</span> groovy.sql.Sql<font></font>
    project.ext.createSqlInstance = {<font></font>
        <span class="hljs-keyword">return</span> Sql.newInstance(<font></font>
                url: localConfig[<span class="hljs-string">"pool.db.url"</span>],<font></font>
                user: localConfig[<span class="hljs-string">"pool.db.username"</span>],<font></font>
                password: localConfig[<span class="hljs-string">"pool.db.password"</span>],<font></font>
                driver: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>])<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æƒ…å ±äº¤æ›ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä»‹ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">å‚ç…§ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ï¼ˆä¸€åº¦å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚ãã®å¾Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ™‚é–“ã®çµ‚ã‚ã‚Šã¾ã§å­˜ç¶šã—ã¾ã™ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="kotlin hljs">    task initDbPool {<font></font>
        dependsOn initDriver<font></font>
        doLast {<font></font>
            Integer poolSize = <span class="hljs-number">10</span>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            String baseName = localConfig[<span class="hljs-string">"pool.db.baseName"</span>]<font></font>
            String basePass = localConfig[<span class="hljs-string">"pool.db.basePass"</span>]<font></font>
            String token = <span class="hljs-string">"{id}"</span>
            List tableExists = sql.rows(<span class="hljs-string">"select table_name from all_tables where table_name=?"</span>, [tableName])<font></font>
            assert tableExists.isEmpty()<font></font>
            sql.execute(<span class="hljs-string">"""
                CREATE TABLE <span class="hljs-subst">${tableName}</span> (
                ID NUMBER(2) NOT NULL PRIMARY KEY,
                METADATA VARCHAR2(200) NOT NULL,
                PROCESSED TIMESTAMP NULL,
                GUID VARCHAR2(36) NULL)
            """</span>, [])<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (Integer i = <span class="hljs-number">0</span> ; i &lt; poolSize ; i++) {<font></font>
                String username = baseName.replace(token, i.toString())<font></font>
                String password = basePass.replace(token, i.toString())<font></font>
                sql.execute(<span class="hljs-string">"""
                    CREATE USER <span class="hljs-subst">${username}</span>
                    IDENTIFIED BY "<span class="hljs-subst">${password}</span>"
                    DEFAULT TABLESPACE USERS
                    TEMPORARY TABLESPACE TEMP
                    PROFILE DEFAULT
                    QUOTA UNLIMITED ON USERS
                """</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant connect to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create sequence to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create session to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                sql.execute(<span class="hljs-string">"grant create table to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
                String metadata = JsonOutput.toJson([<font></font>
                    <span class="hljs-string">"app.db.driverClass"</span>: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>],
                    <span class="hljs-string">"app.db.url"</span>: localConfig[<span class="hljs-string">"pool.db.url"</span>],
                    <span class="hljs-string">"app.db.username"</span>: username,
                    <span class="hljs-string">"app.db.password"</span>: password<font></font>
                        ])<font></font>
<font></font>
                sql.execute(<span class="hljs-string">"""
                    INSERT INTO <span class="hljs-subst">${tableName}</span> (id, metadata)
                    values (?, ?)
                """</span>, [i, metadata])<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é–‹ç™ºè€…ã«ã¯ãƒ‡ãƒãƒƒã‚°ã¨ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãŸã‚ã®ç‹¬è‡ªã®ã‚¹ã‚­ãƒ¼ãƒ ãŒã‚ã‚‹ãŸã‚ã€ãƒ—ãƒ¼ãƒ«ã®ä½¿ç”¨ã‚’ã‚ªãƒ•ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="kotlin hljs">    project.ext.isCiBuild = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'pool.db.enabled'</span>] <span class="hljs-keyword">as</span> String) }
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ã‚¤ã‚¯ã‚¢ãƒ³ãƒ‰ãƒ•ãƒªãƒ¼ãƒ™ãƒ¼ã‚¹ï¼š</font></font><br>
<br>
<pre><code class="kotlin hljs">    task lockDb {<font></font>
        dependsOn initDriver<font></font>
        onlyIf isCiBuild<font></font>
        doLast {<font></font>
            project.ext.lockUid = UUID.randomUUID().toString()<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            sql.executeUpdate(<span class="hljs-string">"""UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = ?, PROCESSED = SYSDATE
                    WHERE ID IN (
                        SELECT ID FROM (
                            SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN
                            FROM <span class="hljs-subst">${tableName}</span> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE'))
                        ) WHERE RN = 1
                    )
                    """</span>, [lockUid, <span class="hljs-number">15</span>])<font></font>
<font></font>
            def meta = sql.firstRow(<span class="hljs-string">"SELECT METADATA FROM <span class="hljs-subst">${tableName}</span> WHERE GUID = ?"</span>, [lockUid])<font></font>
            assert meta != <span class="hljs-literal">null</span>, <span class="hljs-string">"No free databases in pool"</span><font></font>
            def slurper = new JsonSlurper()<font></font>
            Map metadata = slurper.parseText(meta[<span class="hljs-string">"METADATA"</span>] <span class="hljs-keyword">as</span> String) <span class="hljs-keyword">as</span> Map<font></font>
            localConfig.putAll(metadata)<font></font>
            logger.info(<span class="hljs-string">"Database locked, {}"</span>, metadata)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    task unlockDb {<font></font>
        dependsOn lockDb <span class="hljs-comment">// init lockUid</span><font></font>
        onlyIf isCiBuild<font></font>
        doLast {<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
                Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
                sql.executeUpdate(<span class="hljs-string">"UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = NULL WHERE GUID = ?"</span>,<font></font>
                        [lockUid])<font></font>
                logger.info(<span class="hljs-string">"Database unlocked"</span>)<font></font>
            } <span class="hljs-keyword">catch</span> (ignored) {<font></font>
                logger.error(ignored)<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2å›ç¶šã‘ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã€ç•°ãªã‚‹ã‚¹ã‚­ãƒ¼ãƒ ã‚’é¸æŠã§ãã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ã‚»ãƒ³ãƒ–ãƒ«ã™ã‚‹ã¨ãã«ã€ç•°ãªã‚‹ç½®æ›å€¤ãŒæ®‹ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã®å ´åˆã€è¨­å®šã¯é™çš„ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="kotlin hljs">    configure([processResources, processTestResources]) { Task t -&gt;
        <span class="hljs-keyword">if</span> (project.ext.isCiBuild()) {<font></font>
            t.outputs.upToDateWhen { <span class="hljs-literal">false</span> }<font></font>
        }<font></font>
        t.filesMatching(<span class="hljs-string">'**/*.properties'</span>) {<font></font>
            filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string">'${'</span>, endToken: <span class="hljs-string">'}'</span>)<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚¿ã‚¹ã‚¯ï¼š</font></font><br>
<br>
<pre><code class="kotlin hljs">    task restoreAfterRollbackTest(type: LiquibaseTask) {<font></font>
        command = <span class="hljs-string">'update'</span><font></font>
    }<font></font>
<font></font>
    task rollbackTest(type: LiquibaseTask) {<font></font>
        dependsOn lockDb<font></font>
        command = <span class="hljs-string">'rollback'</span>
        requiresValue = <span class="hljs-literal">true</span><font></font>
        doFirst {<font></font>
            project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string">'test.rollback.tag'</span>]<font></font>
        }<font></font>
        doLast {<font></font>
            project.ext.liquibaseCommandValue = <span class="hljs-literal">null</span><font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ã€å®Ÿè¡Œé †åºã‚’è¨­å®šã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="kotlin hljs">    configure([project]) {<font></font>
        tasks.withType(LiquibaseTask.<span class="hljs-keyword">class</span>) { LiquibaseTask t -&gt;<font></font>
            logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), configLiquibase.getName())<font></font>
            (t <span class="hljs-keyword">as</span> Task).dependsOn configLiquibase
            <span class="hljs-keyword">if</span> (isCiBuild()) {<font></font>
                logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), lockDb.getName())<font></font>
                (t <span class="hljs-keyword">as</span> Task).dependsOn lockDb<font></font>
                (t <span class="hljs-keyword">as</span> Task).finalizedBy unlockDb<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment">//   CI:</span>
        <span class="hljs-comment">// 1.    0 (dropAll)</span>
        <span class="hljs-comment">// 2.     rollback (update)</span>
        <span class="hljs-comment">// 3. ,       (rollback tag)</span>
        <span class="hljs-comment">// 4.      (update)</span>
        <span class="hljs-comment">// 5.    </span>
        <span class="hljs-keyword">if</span> (doRollbackTest()) {<font></font>
            def setTaskOrdering = { List&lt;Task&gt; lst -&gt;<font></font>
                <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; lst.size() - <span class="hljs-number">1</span>; i++) {<font></font>
                    logger.info(<span class="hljs-string">"Task {} must run after {}"</span>, lst[i + <span class="hljs-number">1</span>].getName(), lst[i].getName())<font></font>
                    lst[i + <span class="hljs-number">1</span>].dependsOn lst[i]<font></font>
                }<font></font>
            }<font></font>
<font></font>
            setTaskOrdering([<font></font>
                    lockDb,<font></font>
                    configLiquibase,<font></font>
                    dropAll,<font></font>
                    update,<font></font>
                    rollbackTest,<font></font>
                    restoreAfterRollbackTest,<font></font>
                    processTestResources,<font></font>
                    test,<font></font>
            ])<font></font>
<font></font>
            lockDb.finalizedBy unlockDb<font></font>
            test.finalizedBy unlockDb<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆå†…ã«é…ç½®ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã™ã‚‹å‰å¾Œã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ï¼šJunit5ã§ã¯ã€ã“ã‚Œã¯TestNG BeforeSuiteã®BeforeAllCallbackã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€ŒãªãœSQLã¯Javaãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆã•ã‚Œã‚‹ã¹ããªã®ã‹ã€ã¨ã„ã†è³ªå•ã«å¯¾ã™ã‚‹ç­”ãˆã¯ã€ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¤–ãŒã‚ã‚Šã€ç‰¹å®šã®æ™‚é–“ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã«ä¸åˆç†ãªã‚³ãƒ¼ãƒ‰ã‚‚ã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ç›¸äº’ä½œç”¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å•é¡ŒãŒä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ã«è§£æ±ºã•ã‚Œã‚‹ã®ã‹çŸ¥ã‚ŠãŸã„ã®ã§ã™ãŒï¼Ÿ</font><font style="vertical-align: inherit;">ã‚³ãƒ³ãƒ†ãƒŠãŒã™ã¹ã¦ã®å®¶ã«å±Šãã¾ã—ãŸã‹ã€ãã‚Œã¨ã‚‚çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ†ã‚¹ã‚¿ãƒ¼ã®è‚©ã«æ¸¡ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¨ãƒªã‚¹ãƒˆ</font></font></b><div class="spoiler_text"><pre><code class="kotlin hljs"><span class="hljs-keyword">import</span> groovy.json.JsonOutput
<span class="hljs-keyword">import</span> groovy.json.JsonSlurper
<span class="hljs-keyword">import</span> groovy.sql.Sql
<span class="hljs-keyword">import</span> org.apache.tools.ant.filters.ReplaceTokens
<span class="hljs-keyword">import</span> org.liquibase.gradle.LiquibaseTask<font></font>
<font></font>
plugins {<font></font>
    id <span class="hljs-string">'java'</span>
    id <span class="hljs-string">'org.liquibase.gradle'</span> version <span class="hljs-string">'2.0.1'</span><font></font>
}<font></font>
<font></font>
configurations {<font></font>
    driver<font></font>
}<font></font>
<font></font>
repositories {<font></font>
    jcenter()<font></font>
    mavenCentral()<font></font>
    maven {<font></font>
        url = <span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span><font></font>
    }<font></font>
}<font></font>
<font></font>
dependencies {<font></font>
    implementation <span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span>
    implementation <span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span>
    implementation <span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span>
    implementation <span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span><font></font>
<font></font>
    testImplementation <span class="hljs-string">'junit:junit:4.12'</span>
    testImplementation <span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span><font></font>
<font></font>
    testRuntime <span class="hljs-string">'oracle:ojdbc6:11.+'</span><font></font>
<font></font>
    liquibaseRuntime <span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span>
    liquibaseRuntime <span class="hljs-string">'oracle:ojdbc6:11.+'</span>
    liquibaseRuntime <span class="hljs-string">'org.yaml:snakeyaml:1.24'</span><font></font>
<font></font>
<font></font>
    driver group: <span class="hljs-string">"oracle"</span>, name: <span class="hljs-string">"ojdbc6"</span>, version: <span class="hljs-string">"11.+"</span><font></font>
}<font></font>
<font></font>
project.ext.localConfig = new Properties()<font></font>
localConfig.load(file(<span class="hljs-string">"<span class="hljs-subst">${rootDir}</span>/local.properties"</span>).newReader())<font></font>
<font></font>
project.ext.isCiBuild = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'pool.db.enabled'</span>] <span class="hljs-keyword">as</span> String) }<font></font>
<font></font>
project.ext.doRollbackTest = { <span class="hljs-built_in">Boolean</span>.parseBoolean(localConfig[<span class="hljs-string">'test.rollback.enabled'</span>] <span class="hljs-keyword">as</span> String) }<font></font>
<font></font>
task configLiquibase {<font></font>
    doLast {<font></font>
        liquibase {<font></font>
            activities {<font></font>
                testdb {<font></font>
                    changeLogFile <span class="hljs-string">'changelog.yaml'</span>
                    url localConfig[<span class="hljs-string">'app.db.url'</span>]<font></font>
                    driver localConfig[<span class="hljs-string">'app.db.driverClass'</span>]<font></font>
                    username localConfig[<span class="hljs-string">'app.db.username'</span>]<font></font>
                    password localConfig[<span class="hljs-string">'app.db.password'</span>]<font></font>
                    logLevel <span class="hljs-string">'debug'</span>
                    classpath <span class="hljs-string">"<span class="hljs-subst">${project.projectDir}</span>/db"</span>
                    contexts <span class="hljs-string">'main'</span><font></font>
                }<font></font>
                runList = <span class="hljs-string">'testdb'</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
task initDriver {<font></font>
    doLast {<font></font>
        ClassLoader loader = GroovyObject.<span class="hljs-keyword">class</span>.classLoader<font></font>
        configurations.driver.each { File file -&gt;<font></font>
            loader.addURL(file.toURL())<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
project.ext.createSqlInstance = {<font></font>
    return Sql.newInstance(<font></font>
            url: localConfig[<span class="hljs-string">"pool.db.url"</span>],<font></font>
            user: localConfig[<span class="hljs-string">"pool.db.username"</span>],<font></font>
            password: localConfig[<span class="hljs-string">"pool.db.password"</span>],<font></font>
            driver: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>])<font></font>
}<font></font>
<font></font>
task initDbPool {<font></font>
    dependsOn initDriver<font></font>
    doLast {<font></font>
        Integer poolSize = <span class="hljs-number">10</span>
        Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
        String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
        String baseName = localConfig[<span class="hljs-string">"pool.db.baseName"</span>]<font></font>
        String basePass = localConfig[<span class="hljs-string">"pool.db.basePass"</span>]<font></font>
        String token = <span class="hljs-string">"{id}"</span>
        List tableExists = sql.rows(<span class="hljs-string">"select table_name from all_tables where table_name=?"</span>, [tableName])<font></font>
        assert tableExists.isEmpty()<font></font>
        sql.execute(<span class="hljs-string">"""
            CREATE TABLE <span class="hljs-subst">${tableName}</span> (
            ID NUMBER(2) NOT NULL PRIMARY KEY,
            METADATA VARCHAR2(200) NOT NULL,
            PROCESSED TIMESTAMP NULL,
            GUID VARCHAR2(36) NULL)
        """</span>, [])<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (Integer i = <span class="hljs-number">0</span> ; i &lt; poolSize ; i++) {<font></font>
            String username = baseName.replace(token, i.toString())<font></font>
            String password = basePass.replace(token, i.toString())<font></font>
            sql.execute(<span class="hljs-string">"""
                CREATE USER <span class="hljs-subst">${username}</span>
                IDENTIFIED BY "<span class="hljs-subst">${password}</span>"
                DEFAULT TABLESPACE USERS
                TEMPORARY TABLESPACE TEMP
                PROFILE DEFAULT
                QUOTA UNLIMITED ON USERS
            """</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant connect to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create sequence to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create session to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            sql.execute(<span class="hljs-string">"grant create table to <span class="hljs-subst">${username}</span>"</span>, [])<font></font>
            String metadata = JsonOutput.toJson([<font></font>
                <span class="hljs-string">"app.db.driverClass"</span>: localConfig[<span class="hljs-string">"pool.db.driverClass"</span>],
                <span class="hljs-string">"app.db.url"</span>: localConfig[<span class="hljs-string">"pool.db.url"</span>],
                <span class="hljs-string">"app.db.username"</span>: username,
                <span class="hljs-string">"app.db.password"</span>: password<font></font>
                    ])<font></font>
<font></font>
            sql.execute(<span class="hljs-string">"""
                INSERT INTO <span class="hljs-subst">${tableName}</span> (id, metadata)
                values (?, ?)
            """</span>, [i, metadata])<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
task lockDb {<font></font>
    dependsOn initDriver<font></font>
    onlyIf isCiBuild<font></font>
    doLast {<font></font>
        project.ext.lockUid = UUID.randomUUID().toString()<font></font>
        String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
        Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
        sql.executeUpdate(<span class="hljs-string">"""UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = ?, PROCESSED = SYSDATE
                WHERE ID IN (
                    SELECT ID FROM (
                        SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN
                        FROM <span class="hljs-subst">${tableName}</span> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE'))
                    ) WHERE RN = 1
                )
                """</span>, [lockUid, <span class="hljs-number">15</span>])<font></font>
<font></font>
        def meta = sql.firstRow(<span class="hljs-string">"SELECT METADATA FROM <span class="hljs-subst">${tableName}</span> WHERE GUID = ?"</span>, [lockUid])<font></font>
        assert meta != <span class="hljs-literal">null</span>, <span class="hljs-string">"No free databases in pool"</span><font></font>
        def slurper = new JsonSlurper()<font></font>
        Map metadata = slurper.parseText(meta[<span class="hljs-string">"METADATA"</span>] <span class="hljs-keyword">as</span> String) <span class="hljs-keyword">as</span> Map<font></font>
        localConfig.putAll(metadata)<font></font>
        logger.info(<span class="hljs-string">"Database locked, {}"</span>, metadata)<font></font>
    }<font></font>
}<font></font>
<font></font>
task unlockDb {<font></font>
    dependsOn lockDb <span class="hljs-comment">// init lockUid</span><font></font>
    onlyIf isCiBuild<font></font>
    doLast {<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            String tableName = localConfig[<span class="hljs-string">"pool.db.referenceTable"</span>]<font></font>
            Sql sql = createSqlInstance() <span class="hljs-keyword">as</span> Sql<font></font>
            sql.executeUpdate(<span class="hljs-string">"UPDATE <span class="hljs-subst">${tableName}</span> SET GUID = NULL WHERE GUID = ?"</span>,<font></font>
                    [lockUid])<font></font>
            logger.info(<span class="hljs-string">"Database unlocked"</span>)<font></font>
        } <span class="hljs-keyword">catch</span> (ignored) {<font></font>
            logger.error(ignored)<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
configure([processResources, processTestResources]) { Task t -&gt;<font></font>
    <span class="hljs-keyword">if</span> (project.ext.isCiBuild()) {<font></font>
        t.outputs.upToDateWhen { <span class="hljs-literal">false</span> }<font></font>
    }<font></font>
    t.filesMatching(<span class="hljs-string">'**/*.properties'</span>) {<font></font>
        filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string">'${'</span>, endToken: <span class="hljs-string">'}'</span>)<font></font>
    }<font></font>
}<font></font>
<font></font>
task restoreAfterRollbackTest(type: LiquibaseTask) {<font></font>
    command = <span class="hljs-string">'update'</span><font></font>
}<font></font>
<font></font>
task rollbackTest(type: LiquibaseTask) {<font></font>
    dependsOn lockDb<font></font>
    command = <span class="hljs-string">'rollback'</span>
    requiresValue = <span class="hljs-literal">true</span><font></font>
    doFirst {<font></font>
        project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string">'test.rollback.tag'</span>]<font></font>
    }<font></font>
    doLast {<font></font>
        project.ext.liquibaseCommandValue = <span class="hljs-literal">null</span><font></font>
    }<font></font>
}<font></font>
<font></font>
configure([project]) {<font></font>
    tasks.withType(LiquibaseTask.<span class="hljs-keyword">class</span>) { LiquibaseTask t -&gt;<font></font>
        logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), configLiquibase.getName())<font></font>
        (t <span class="hljs-keyword">as</span> Task).dependsOn configLiquibase
        <span class="hljs-keyword">if</span> (isCiBuild()) {<font></font>
            logger.info(<span class="hljs-string">"Liquibase task {} must run after {}"</span>, t.getName(), lockDb.getName())<font></font>
            (t <span class="hljs-keyword">as</span> Task).dependsOn lockDb<font></font>
            (t <span class="hljs-keyword">as</span> Task).finalizedBy unlockDb<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">//   CI:</span>
    <span class="hljs-comment">// 1.    0 (dropAll)</span>
    <span class="hljs-comment">// 2.     rollback (update)</span>
    <span class="hljs-comment">// 3. ,       (rollback tag)</span>
    <span class="hljs-comment">// 4.      (update)</span>
    <span class="hljs-comment">// 5.    </span>
    <span class="hljs-keyword">if</span> (doRollbackTest()) {<font></font>
        def setTaskOrdering = { List&lt;Task&gt; lst -&gt;<font></font>
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; lst.size() - <span class="hljs-number">1</span>; i++) {<font></font>
                logger.info(<span class="hljs-string">"Task {} must run after {}"</span>, lst[i + <span class="hljs-number">1</span>].getName(), lst[i].getName())<font></font>
                lst[i + <span class="hljs-number">1</span>].dependsOn lst[i]<font></font>
            }<font></font>
        }<font></font>
<font></font>
        setTaskOrdering([<font></font>
                lockDb,<font></font>
                configLiquibase,<font></font>
                dropAll,<font></font>
                update,<font></font>
                rollbackTest,<font></font>
                restoreAfterRollbackTest,<font></font>
                processTestResources,<font></font>
                test,<font></font>
        ])<font></font>
<font></font>
        lockDb.finalizedBy unlockDb<font></font>
        test.finalizedBy unlockDb<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<pre><code class="bash hljs">pool.db.enabled=<span class="hljs-literal">false</span>
test.rollback.enabled=<span class="hljs-literal">true</span><font></font>
<font></font>
pool.db.driverClass=oracle.jdbc.driver.OracleDriver<font></font>
pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB<font></font>
pool.db.username=SYSTEM<font></font>
pool.db.password=Oradoc_db1<font></font>
<font></font>
pool.db.referenceTable=c<span class="hljs-comment">##test_user1.REF_TABLE</span>
pool.db.baseName=C<span class="hljs-comment">##CI_SCHEMA_{id}</span><font></font>
pool.db.basePass=CI_SCHEMA_{id}_PASS<font></font>
<font></font>
app.db.driverClass=<font></font>
app.db.url=<font></font>
app.db.username=<font></font>
app.db.password=<font></font>
<font></font>
test.rollback.tag=version_1<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452706/index.html">1983å¹´ã«ã€Bella Labsã®ã“ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯æœ€åˆã®ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚</a></li>
<li><a href="../ja452712/index.html">ç§ãŸã¡ãŒãƒãƒ¼ãƒ ã§ä»•äº‹ã‚’ã—ã‚ˆã†ã¨ã—ãŸæ–¹æ³•ã¨ã€ãã‚Œã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã‚‚ã®</a></li>
<li><a href="../ja452714/index.html">æ³¨æ„5ï¼šè£½å“ã®æ€è€ƒã€è¡Œå‹•å¿ƒç†å­¦ã€ç”Ÿç”£æ€§ã«é–¢ã™ã‚‹è¨˜äº‹ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ</a></li>
<li><a href="../ja452716/index.html">äººæã®æ´»ç”¨ã®æœ€é©ç‚¹ã‚’æ±‚ã‚ã¦</a></li>
<li><a href="../ja452718/index.html">PsyGuideï¼šæ³¨æ„ä¸è¶³ã€‚ï¼ƒ0001/1001</a></li>
<li><a href="../ja452724/index.html">ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹ãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼ï¼šJavaScriptã‚³ãƒ¼ãƒ‰ãŒæ¥½ã—ã„ã¨ã*</a></li>
<li><a href="../ja452726/index.html">ã‹ã‚ã„ã„éª¨3Dï¼šãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã®é ­è“‹éª¨ã®æ¬ é™¥ã®ãŸã‚ã®è¶…å¼¾æ€§éª¨ææ–™</a></li>
<li><a href="../ja452730/index.html">æ¨™æº–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®åŸå‰‡ã«åŸºã¥ãæƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼ã€‚ç¥è©±ã¨ç¾å®Ÿ</a></li>
<li><a href="../ja452734/index.html">ãƒ“ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦iOSï¼ˆARMï¼‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’macOSï¼ˆx86ï¼‰ã«è‡ªå‹•çš„ã«ç§»è¡Œã™ã‚‹</a></li>
<li><a href="../ja452736/index.html">SecureDialoguesã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æš—å·åŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>