<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíª üë©üèº‚Äçüéì üë∂ DBA: organiser avec comp√©tence la synchronisation et les importations üé´ ‚úäüèæ üßùüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avec le traitement complexe de grands ensembles de donn√©es (diff√©rents processus ETL : importations, conversions et synchronisation avec une source ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: organiser avec comp√©tence la synchronisation et les importations</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec le traitement complexe de grands ensembles de donn√©es (diff√©rents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus ETL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : importations, conversions et synchronisation avec une source externe), il est souvent n√©cessaire de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´m√©moriser¬ª temporairement et de traiter imm√©diatement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quelque chose de volumineux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une t√¢che typique de ce type ressemble g√©n√©ralement √† ceci: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ici, le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service comptable a t√©l√©charg√© les</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> derniers paiements re√ßus </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de la banque cliente</font></a><font style="vertical-align: inherit;"> , nous devons les t√©l√©charger rapidement sur le site Web et les lier aux comptes"</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais lorsque le volume de ce "quelque chose" commence √† √™tre mesur√© en centaines de m√©gaoctets, et le service Cela devrait continuer √† fonctionner avec la base en mode 24x7, il existe de nombreux effets secondaires qui vont ruiner votre vie.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour y faire face dans PostgreSQL (et pas seulement dans celui-ci), vous pouvez utiliser certaines options d'optimisation qui vous permettront de traiter plus rapidement et avec moins de ressources.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. O√π exp√©dier?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, d√©cidons o√π nous pouvons t√©l√©charger les donn√©es que nous voulons ¬´traiter¬ª.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Tables temporaires (TABLE TEMPORAIRE)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, pour PostgreSQL, les tables temporaires sont les m√™mes tables que les autres. </font><font style="vertical-align: inherit;">Par cons√©quent, les superstitions comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´tout y est stock√© uniquement en m√©moire, mais cela peut se terminer¬ª</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont incorrectes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais il existe plusieurs diff√©rences importantes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espace de noms propre pour chaque connexion √† la base de donn√©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si deux connexions tentent d'√©tablir en m√™me temps </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, quelqu'un obtiendra d√©finitivement une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur d'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objets DB </font><b><font style="vertical-align: inherit;">non uniques</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si les deux essaient de s'ex√©cuter </font><font style="vertical-align: inherit;">, les deux le feront normalement et chacun recevra </font><b><font style="vertical-align: inherit;">sa propre copie de la</font></b><font style="vertical-align: inherit;"> table. </font><font style="vertical-align: inherit;">Et il n'y aura rien de commun entre eux.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Autodestruction" avec d√©connexion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous fermez la connexion, toutes les tables temporaires sont automatiquement supprim√©es, il </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'y a donc aucun sens √† </font><font style="vertical-align: inherit;">ex√©cuter "manuellement" </font><font style="vertical-align: inherit;">, sauf ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous travaillez via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la base de donn√©es continue de supposer que cette connexion est toujours active, et cette temporaire la table existe toujours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, une tentative de recr√©ation √† partir d'une autre connexion √† pgbouncer entra√Ænera une erreur. </font><font style="vertical-align: inherit;">Mais cela peut √™tre contourn√© en profitant </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Certes, il vaut mieux ne pas le faire, car vous pourrez alors d√©couvrir ¬´soudainement¬ª les donn√©es laiss√©es par le ¬´propri√©taire pr√©c√©dent¬ª. </font><font style="vertical-align: inherit;">Au lieu de cela, il est pr√©f√©rable de lire le manuel et de voir que lors de la cr√©ation du tableau, il est possible d'ajouter</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est-√†-dire que lorsque la transaction est termin√©e, le tableau sera automatiquement supprim√©.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non r√©plication</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que seule une jointure particuli√®re appartient, les tables temporaires ne sont pas r√©pliqu√©es. </font><font style="vertical-align: inherit;">Mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela √©limine la n√©cessit√© de double-√©crire les donn√©es</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en tas + WAL, donc INSERT / UPDATE / DELETE est beaucoup plus rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comme la table temporaire est toujours une table ¬´presque ordinaire¬ª, elle ne peut pas non plus √™tre cr√©√©e sur la r√©plique. </font><font style="vertical-align: inherit;">Du moins pour l'instant, bien que le patch correspondant existe depuis longtemps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Tables non enregistr√©es (TABLEAU NON LOGG√â)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que faire, par exemple, si vous avez une sorte de processus ETL encombrant qui ne peut pas √™tre impl√©ment√© dans une seule transaction, et que vous avez toujours </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou le flux de donn√©es est si grand qu'il n'y a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas assez de bande passante par connexion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† partir de la base de donn√©es (lecture, un processus sur la CPU)? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou certaines op√©rations vont-elles de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mani√®re asynchrone</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans diff√©rentes connexions? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a qu'une seule option - pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©er temporairement une table non temporaire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pun, ouais. </font><font style="vertical-align: inherit;">C'est √† dire:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©√© ¬´ses¬ª tables avec des noms au maximum al√©atoires afin de ne croiser avec personne</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extraire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : y versait des donn√©es d'une source externe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : transform√©, rempli dans les principaux champs de liaison</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : donn√©es finies vers√©es dans les tables cibles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mes" tables supprim√©es</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant - une mouche dans la pommade. </font><font style="vertical-align: inherit;">En fait, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toute l'√©criture dans PostgreSQL se produit deux fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abord dans le WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis dans le corps de la table / de l'index. </font><font style="vertical-align: inherit;">Tout cela est fait pour prendre en charge ACID et la visibilit√© correcte des donn√©es entre </font><font style="vertical-align: inherit;">les transactions </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imbriqu√©es et </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imbriqu√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous n'en avons pas besoin! </font><font style="vertical-align: inherit;">Nous avons tout le processus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou r√©ussi, ou non</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Peu importe le nombre de transactions interm√©diaires qu'il contient - nous ne souhaitons pas ¬´continuer le processus √† partir du milieu¬ª, surtout quand on ne sait pas o√π il se trouvait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, les d√©veloppeurs de PostgreSQL ont introduit la version 9.1, comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les tables non journalis√©es (UNLOGGED)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En bref, ce </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera beaucoup plus rapide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais si le serveur de base de donn√©es "plante" - ce sera d√©sagr√©able. </font><font style="vertical-align: inherit;">Mais √† quelle fr√©quence cela se produit-il, et votre processus ETL sait-il comment le modifier correctement ¬´√† partir du milieu¬ª apr√®s la ¬´revitalisation¬ª de la base de donn√©es? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinon, et le cas ci-dessus est similaire au v√¥tre - utilisez </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'incluez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jamais </font><b><font style="vertical-align: inherit;">cet attribut sur de vraies tables</font></b><font style="vertical-align: inherit;"> des donn√©es qui vous sont ch√®res.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">ON COMMIT {SUPPRIMER DES RANGS | </font><font style="vertical-align: inherit;">LAISSEZ TOMBER}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette conception permet lors de la cr√©ation d'une table de d√©finir un comportement automatique √† la fin de la transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä propos </font><font style="vertical-align: inherit;">J'ai d√©j√† √©crit ci-dessus, cela g√©n√®re </font><font style="vertical-align: inherit;">, mais la </font><font style="vertical-align: inherit;">situation est plus int√©ressante - ici, elle est g√©n√©r√©e </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
√âtant donn√© que toute l'infrastructure de stockage de la m√©ta description de la table temporaire est exactement la m√™me que celle habituelle, la </font><b><font style="vertical-align: inherit;">cr√©ation et la suppression constantes de tables temporaires entra√Ænent un fort "gonflement" des tables syst√®me</font></b><font style="vertical-align: inherit;"> pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Imaginez maintenant que vous avez un travailleur sur la ligne la connexion √† la base de donn√©es, qui ouvre chaque seconde une nouvelle transaction, cr√©e, remplit, traite et supprime la table temporaire ... Les d√©chets dans les tables syst√®me s'accumulent en exc√®s, ce qui repr√©sente des freins suppl√©mentaires lors de chaque op√©ration.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, non! </font><font style="vertical-align: inherit;">Dans ce cas, il est beaucoup plus efficace </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la retirer du cycle de transaction - puis au d√©but de chaque nouvelle transaction, la table </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existera</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©j√† </font><font style="vertical-align: inherit;">(enregistrer l'appel </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais elle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera vide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , gr√¢ce √† </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(nous avons √©galement enregistr√© l'appel) √† la fin de la transaction pr√©c√©dente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4. </font><font style="vertical-align: inherit;">COMME ... INCLUANT ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai mentionn√© au d√©but que l'un des cas d'utilisation typiques des tables temporaires √©tait divers types d'importations - et le d√©veloppeur copie-colle avec lassitude la liste des champs de la table cible dans la d√©claration de son temporaire ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la paresse est le moteur du progr√®s! </font><font style="vertical-align: inherit;">Par cons√©quent, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©ation d'une nouvelle table ¬´sur le mod√®le¬ª</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut √™tre beaucoup plus simple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que vous pouvez ensuite ajouter de nombreuses donn√©es √† ce tableau, les recherches ne seront jamais rapides. Mais il existe une solution traditionnelle contre cela: les index! Et, oui, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une table temporaire peut √©galement avoir des index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme, souvent, les indices souhait√©s co√Øncident avec les indices de la table cible, vous pouvez simplement √©crire </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Si vous avez √©galement besoin de </font><font style="vertical-align: inherit;">-values ‚Äã‚Äã(par exemple, pour remplir les valeurs de cl√© primaire), vous pouvez utiliser </font><font style="vertical-align: inherit;">. Eh bien, ou tout simplement - </font><font style="vertical-align: inherit;">- cela copiera les valeurs par d√©faut, les index, les contraintes ... </font><font style="vertical-align: inherit;">
Mais ici, vous devez comprendre que si vous avez cr√©√© une </font><b><font style="vertical-align: inherit;">table d'importation tout de suite avec des index, les donn√©es seront remplies plus longtemps</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que si vous remplissez tout d'abord, puis faites rouler les indices - regardez comme un exemple de la fa√ßon dont </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'ensemble, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comment √©crire?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dirai simplement - utilisez </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream au lieu de "packs" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acc√©l√©ration parfois</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous pouvez m√™me directement √† partir d'un fichier pr√©-g√©n√©r√©.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Comment g√©rer?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, laissez notre introduction ressembler √† ceci:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous avez dans votre base de donn√©es une plaque avec les donn√©es client pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1M d'enregistrements</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chaque jour, le client vous envoie une nouvelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´image¬ª compl√®te</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exp√©rience, vous savez que </font><b><font style="vertical-align: inherit;">pas plus de 10 000 enregistrements changent</font></b><font style="vertical-align: inherit;"> de temps en temps</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple classique d'une telle situation est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base de donn√©es KLADR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il y a beaucoup d'adresses, mais dans chaque t√©l√©chargement hebdomadaire de modifications (changement de nom des colonies, associations de rues, apparition de nouvelles maisons), il y en a tr√®s peu, m√™me √† l'√©chelle nationale.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Algorithme de synchronisation complet</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par souci de simplicit√©, disons que vous n'avez m√™me pas besoin de restructurer les donn√©es - il suffit de mettre le tableau sous la bonne forme, c'est-√†-dire:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supprimer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui n'est plus</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre √† jour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui √©tait d√©j√†, et vous devez mettre √† jour</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ins√©rer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui n'a pas √©t√©</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi dans cet ordre cela vaut-il la peine de faire des op√©rations? </font><font style="vertical-align: inherit;">Parce que c'est ainsi que la taille de la table augmente de mani√®re minimale ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rappelez-vous MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SUPPRIMER DE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non, bien s√ªr, vous ne pouvez effectuer que deux op√©rations:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supprimer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) du tout</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout √† partir d'une nouvelle image</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais en m√™me temps, gr√¢ce √† MVCC, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taille de la table augmentera exactement deux fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obtenez + 1M d'enregistrements d'image dans le tableau en raison de la mise √† jour 10K - redondance moyenne ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un d√©veloppeur plus exp√©riment√© sait que toute la plaque peut √™tre nettoy√©e √† peu de frais:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) toute la table</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout √† partir d'une nouvelle image</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode est efficace, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parfois elle est tout √† fait applicable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais il y a un probl√®me ... Nous injecterons 1M d'enregistrements, donc nous ne pouvons pas nous permettre de laisser la table vide pendant tout ce temps (comme cela se passera sans encapsuler dans une seule transaction). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui signifie:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous commen√ßons une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longue transaction</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impose </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous faisons l'insert depuis longtemps, et tout le monde en ce moment </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut m√™me pas</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque chose ne va pas ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENAME ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En option, remplissez tout dans une nouvelle table s√©par√©e, puis renommez-la simplement en l'ancienne. </font><font style="vertical-align: inherit;">Quelques petites choses d√©sagr√©ables:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aussi </font><font style="vertical-align: inherit;">, bien que beaucoup moins de temps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les plans / statistiques de requ√™te de cette table sont r√©initialis√©s, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il est n√©cessaire de conduire ANALYSER</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toutes les cl√©s √©trang√®res</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) se </font><b><font style="vertical-align: inherit;">cassent</font></b><font style="vertical-align: inherit;"> sur la table</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait un correctif WIP de Simon Riggs, qui sugg√©rait de faire une </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">op√©ration pour remplacer le corps de la table au niveau du fichier, sans toucher aux statistiques et FK, mais n'a pas collect√© le quorum.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SUPPRIMER, METTRE √Ä JOUR, INS√âRER</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous arr√™tons donc sur une version non bloquante de trois op√©rations. </font><font style="vertical-align: inherit;">Presque trois ... Comment le faire le plus efficacement possible?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Importer le post-traitement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me KLADER, tous les enregistrements modifi√©s doivent en outre √™tre soumis √† un post-traitement - normaliser, mettre en surbrillance les mots cl√©s et apporter aux structures n√©cessaires. </font><font style="vertical-align: inherit;">Mais comment savoir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactement ce qui a chang√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sans compliquer le code de synchronisation, id√©alement sans le toucher du tout? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si seul votre processus a un acc√®s en √©criture au moment de la synchronisation, vous pouvez utiliser un d√©clencheur qui collectera toutes les modifications pour nous:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous pouvons imposer des d√©clencheurs (ou les activer </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">avant de d√©marrer la synchronisation </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis tranquillement √† partir des tables de journal, nous extrayons toutes les modifications dont nous avons besoin et les ex√©cutons via des gestionnaires suppl√©mentaires.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Importer des ensembles associ√©s</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessus, nous avons consid√©r√© les cas o√π les structures de donn√©es de la source et du r√©cepteur co√Øncident. </font><font style="vertical-align: inherit;">Mais que se passe-t-il si le d√©chargement d'un syst√®me externe a un format diff√©rent de la structure de stockage dans notre base de donn√©es? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons l'exemple du stockage des clients et de leurs comptes, l'option plusieurs-√†-un classique:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le d√©chargement d'une source externe nous vient sous la forme de "tout en un":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute √©vidence, les donn√©es client peuvent √™tre dupliqu√©es de cette mani√®re, et l'enregistrement principal est le ¬´compte¬ª:</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le mod√®le, ins√©rez simplement nos donn√©es de test, mais n'oubliez pas - </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus efficacement!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premi√®rement, nous s√©lectionnons les ¬´coupes¬ª auxquelles nos ¬´faits¬ª se r√©f√®rent. </font><font style="vertical-align: inherit;">Dans notre cas, les comptes se r√©f√®rent aux clients:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin d'associer correctement les comptes aux identifiants clients, nous devons d'abord d√©couvrir ou g√©n√©rer ces identifiants. </font><font style="vertical-align: inherit;">Ajoutez des champs pour eux:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utiliserons la m√©thode de synchronisation des tables avec la petite correction d√©crite ci-dessus - nous ne mettrons √† jour ni ne supprimerons rien dans la table cible, car l'importation de clients se fait uniquement par ajout:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, tout - </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenant nous avons rempli le champ de communication </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec lequel nous allons ins√©rer le compte.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492450/index.html">Mis √† jour 03.31. Le coronavirus se transmet-il par voie a√©rienne? Ce qui est connu en ce moment</a></li>
<li><a href="../fr492454/index.html">Nous vendons le Refactoring d'Architecture √† un client ou quel est le probl√®me des d√©veloppeurs</a></li>
<li><a href="../fr492456/index.html">Comment visualiser et animer des mod√®les (g√©ophysiques). Afficher les donn√©es brutes</a></li>
<li><a href="../fr492458/index.html">Interface graphique simple pour M5Stack (Arduino)</a></li>
<li><a href="../fr492462/index.html">Source de v√©rit√©: comment un analyste apprend √† un manager et √† un d√©veloppeur √† travailler ensemble</a></li>
<li><a href="../fr492466/index.html">Comment passer de n'importe quel fournisseur d'h√©bergement avec cPanel √† Plesk dans Rusonix en seulement cinq √©tapes</a></li>
<li><a href="../fr492468/index.html">Lenovo Thinkserver SE350: un h√©ros de la p√©riph√©rie</a></li>
<li><a href="../fr492474/index.html">Nous structurons les informations sur les bo√Ætiers Android et analysons ce qu'un pr√©fixe normal devrait √™tre capable de faire.</a></li>
<li><a href="../fr492478/index.html">Sans gestion des connaissances, cela fait mal: 5 principales cons√©quences de l'absence de syst√®me</a></li>
<li><a href="../fr492480/index.html">Comment nous avons lutt√© contre les √©pid√©mies auparavant et ce que nous faisons contre les coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>