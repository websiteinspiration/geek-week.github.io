<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍💻 👩🏼‍🎓 👶 DBA: organiser avec compétence la synchronisation et les importations 🎫 ✊🏾 🧝🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avec le traitement complexe de grands ensembles de données (différents processus ETL : importations, conversions et synchronisation avec une source ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: organiser avec compétence la synchronisation et les importations</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec le traitement complexe de grands ensembles de données (différents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus ETL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : importations, conversions et synchronisation avec une source externe), il est souvent nécessaire de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«mémoriser» temporairement et de traiter immédiatement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quelque chose de volumineux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une tâche typique de ce type ressemble généralement à ceci: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ici, le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service comptable a téléchargé les</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> derniers paiements reçus </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de la banque cliente</font></a><font style="vertical-align: inherit;"> , nous devons les télécharger rapidement sur le site Web et les lier aux comptes"</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais lorsque le volume de ce "quelque chose" commence à être mesuré en centaines de mégaoctets, et le service Cela devrait continuer à fonctionner avec la base en mode 24x7, il existe de nombreux effets secondaires qui vont ruiner votre vie.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour y faire face dans PostgreSQL (et pas seulement dans celui-ci), vous pouvez utiliser certaines options d'optimisation qui vous permettront de traiter plus rapidement et avec moins de ressources.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Où expédier?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, décidons où nous pouvons télécharger les données que nous voulons «traiter».</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Tables temporaires (TABLE TEMPORAIRE)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, pour PostgreSQL, les tables temporaires sont les mêmes tables que les autres. </font><font style="vertical-align: inherit;">Par conséquent, les superstitions comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«tout y est stocké uniquement en mémoire, mais cela peut se terminer»</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont incorrectes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais il existe plusieurs différences importantes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espace de noms propre pour chaque connexion à la base de données</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si deux connexions tentent d'établir en même temps </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, quelqu'un obtiendra définitivement une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur d'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objets DB </font><b><font style="vertical-align: inherit;">non uniques</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si les deux essaient de s'exécuter </font><font style="vertical-align: inherit;">, les deux le feront normalement et chacun recevra </font><b><font style="vertical-align: inherit;">sa propre copie de la</font></b><font style="vertical-align: inherit;"> table. </font><font style="vertical-align: inherit;">Et il n'y aura rien de commun entre eux.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Autodestruction" avec déconnexion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous fermez la connexion, toutes les tables temporaires sont automatiquement supprimées, il </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'y a donc aucun sens à </font><font style="vertical-align: inherit;">exécuter "manuellement" </font><font style="vertical-align: inherit;">, sauf ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous travaillez via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la base de données continue de supposer que cette connexion est toujours active, et cette temporaire la table existe toujours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, une tentative de recréation à partir d'une autre connexion à pgbouncer entraînera une erreur. </font><font style="vertical-align: inherit;">Mais cela peut être contourné en profitant </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Certes, il vaut mieux ne pas le faire, car vous pourrez alors découvrir «soudainement» les données laissées par le «propriétaire précédent». </font><font style="vertical-align: inherit;">Au lieu de cela, il est préférable de lire le manuel et de voir que lors de la création du tableau, il est possible d'ajouter</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est-à-dire que lorsque la transaction est terminée, le tableau sera automatiquement supprimé.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non réplication</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que seule une jointure particulière appartient, les tables temporaires ne sont pas répliquées. </font><font style="vertical-align: inherit;">Mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela élimine la nécessité de double-écrire les données</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en tas + WAL, donc INSERT / UPDATE / DELETE est beaucoup plus rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comme la table temporaire est toujours une table «presque ordinaire», elle ne peut pas non plus être créée sur la réplique. </font><font style="vertical-align: inherit;">Du moins pour l'instant, bien que le patch correspondant existe depuis longtemps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Tables non enregistrées (TABLEAU NON LOGGÉ)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que faire, par exemple, si vous avez une sorte de processus ETL encombrant qui ne peut pas être implémenté dans une seule transaction, et que vous avez toujours </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou le flux de données est si grand qu'il n'y a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas assez de bande passante par connexion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à partir de la base de données (lecture, un processus sur la CPU)? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou certaines opérations vont-elles de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manière asynchrone</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans différentes connexions? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a qu'une seule option - pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">créer temporairement une table non temporaire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pun, ouais. </font><font style="vertical-align: inherit;">C'est à dire:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">créé «ses» tables avec des noms au maximum aléatoires afin de ne croiser avec personne</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extraire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : y versait des données d'une source externe</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : transformé, rempli dans les principaux champs de liaison</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : données finies versées dans les tables cibles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mes" tables supprimées</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant - une mouche dans la pommade. </font><font style="vertical-align: inherit;">En fait, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toute l'écriture dans PostgreSQL se produit deux fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abord dans le WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis dans le corps de la table / de l'index. </font><font style="vertical-align: inherit;">Tout cela est fait pour prendre en charge ACID et la visibilité correcte des données entre </font><font style="vertical-align: inherit;">les transactions </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imbriquées et </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imbriquées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous n'en avons pas besoin! </font><font style="vertical-align: inherit;">Nous avons tout le processus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou réussi, ou non</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Peu importe le nombre de transactions intermédiaires qu'il contient - nous ne souhaitons pas «continuer le processus à partir du milieu», surtout quand on ne sait pas où il se trouvait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, les développeurs de PostgreSQL ont introduit la version 9.1, comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les tables non journalisées (UNLOGGED)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En bref, ce </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera beaucoup plus rapide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais si le serveur de base de données "plante" - ce sera désagréable. </font><font style="vertical-align: inherit;">Mais à quelle fréquence cela se produit-il, et votre processus ETL sait-il comment le modifier correctement «à partir du milieu» après la «revitalisation» de la base de données? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinon, et le cas ci-dessus est similaire au vôtre - utilisez </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'incluez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jamais </font><b><font style="vertical-align: inherit;">cet attribut sur de vraies tables</font></b><font style="vertical-align: inherit;"> des données qui vous sont chères.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">ON COMMIT {SUPPRIMER DES RANGS | </font><font style="vertical-align: inherit;">LAISSEZ TOMBER}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette conception permet lors de la création d'une table de définir un comportement automatique à la fin de la transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À propos </font><font style="vertical-align: inherit;">J'ai déjà écrit ci-dessus, cela génère </font><font style="vertical-align: inherit;">, mais la </font><font style="vertical-align: inherit;">situation est plus intéressante - ici, elle est générée </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Étant donné que toute l'infrastructure de stockage de la méta description de la table temporaire est exactement la même que celle habituelle, la </font><b><font style="vertical-align: inherit;">création et la suppression constantes de tables temporaires entraînent un fort "gonflement" des tables système</font></b><font style="vertical-align: inherit;"> pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Imaginez maintenant que vous avez un travailleur sur la ligne la connexion à la base de données, qui ouvre chaque seconde une nouvelle transaction, crée, remplit, traite et supprime la table temporaire ... Les déchets dans les tables système s'accumulent en excès, ce qui représente des freins supplémentaires lors de chaque opération.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, non! </font><font style="vertical-align: inherit;">Dans ce cas, il est beaucoup plus efficace </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la retirer du cycle de transaction - puis au début de chaque nouvelle transaction, la table </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existera</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> déjà </font><font style="vertical-align: inherit;">(enregistrer l'appel </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais elle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera vide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , grâce à </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(nous avons également enregistré l'appel) à la fin de la transaction précédente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4. </font><font style="vertical-align: inherit;">COMME ... INCLUANT ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai mentionné au début que l'un des cas d'utilisation typiques des tables temporaires était divers types d'importations - et le développeur copie-colle avec lassitude la liste des champs de la table cible dans la déclaration de son temporaire ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la paresse est le moteur du progrès! </font><font style="vertical-align: inherit;">Par conséquent, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">création d'une nouvelle table «sur le modèle»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut être beaucoup plus simple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que vous pouvez ensuite ajouter de nombreuses données à ce tableau, les recherches ne seront jamais rapides. Mais il existe une solution traditionnelle contre cela: les index! Et, oui, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une table temporaire peut également avoir des index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme, souvent, les indices souhaités coïncident avec les indices de la table cible, vous pouvez simplement écrire </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Si vous avez également besoin de </font><font style="vertical-align: inherit;">-values ​​(par exemple, pour remplir les valeurs de clé primaire), vous pouvez utiliser </font><font style="vertical-align: inherit;">. Eh bien, ou tout simplement - </font><font style="vertical-align: inherit;">- cela copiera les valeurs par défaut, les index, les contraintes ... </font><font style="vertical-align: inherit;">
Mais ici, vous devez comprendre que si vous avez créé une </font><b><font style="vertical-align: inherit;">table d'importation tout de suite avec des index, les données seront remplies plus longtemps</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que si vous remplissez tout d'abord, puis faites rouler les indices - regardez comme un exemple de la façon dont </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'ensemble, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comment écrire?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dirai simplement - utilisez </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream au lieu de "packs" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accélération parfois</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous pouvez même directement à partir d'un fichier pré-généré.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Comment gérer?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, laissez notre introduction ressembler à ceci:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous avez dans votre base de données une plaque avec les données client pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1M d'enregistrements</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chaque jour, le client vous envoie une nouvelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«image» complète</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par expérience, vous savez que </font><b><font style="vertical-align: inherit;">pas plus de 10 000 enregistrements changent</font></b><font style="vertical-align: inherit;"> de temps en temps</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple classique d'une telle situation est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base de données KLADR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il y a beaucoup d'adresses, mais dans chaque téléchargement hebdomadaire de modifications (changement de nom des colonies, associations de rues, apparition de nouvelles maisons), il y en a très peu, même à l'échelle nationale.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Algorithme de synchronisation complet</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par souci de simplicité, disons que vous n'avez même pas besoin de restructurer les données - il suffit de mettre le tableau sous la bonne forme, c'est-à-dire:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supprimer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui n'est plus</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre à jour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui était déjà, et vous devez mettre à jour</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">insérer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui n'a pas été</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi dans cet ordre cela vaut-il la peine de faire des opérations? </font><font style="vertical-align: inherit;">Parce que c'est ainsi que la taille de la table augmente de manière minimale ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rappelez-vous MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SUPPRIMER DE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non, bien sûr, vous ne pouvez effectuer que deux opérations:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supprimer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) du tout</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout à partir d'une nouvelle image</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais en même temps, grâce à MVCC, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taille de la table augmentera exactement deux fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obtenez + 1M d'enregistrements d'image dans le tableau en raison de la mise à jour 10K - redondance moyenne ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un développeur plus expérimenté sait que toute la plaque peut être nettoyée à peu de frais:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) toute la table</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout à partir d'une nouvelle image</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode est efficace, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parfois elle est tout à fait applicable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais il y a un problème ... Nous injecterons 1M d'enregistrements, donc nous ne pouvons pas nous permettre de laisser la table vide pendant tout ce temps (comme cela se passera sans encapsuler dans une seule transaction). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui signifie:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous commençons une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longue transaction</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impose </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous faisons l'insert depuis longtemps, et tout le monde en ce moment </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut même pas</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelque chose ne va pas ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENAME ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En option, remplissez tout dans une nouvelle table séparée, puis renommez-la simplement en l'ancienne. </font><font style="vertical-align: inherit;">Quelques petites choses désagréables:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aussi </font><font style="vertical-align: inherit;">, bien que beaucoup moins de temps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les plans / statistiques de requête de cette table sont réinitialisés, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il est nécessaire de conduire ANALYSER</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toutes les clés étrangères</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) se </font><b><font style="vertical-align: inherit;">cassent</font></b><font style="vertical-align: inherit;"> sur la table</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait un correctif WIP de Simon Riggs, qui suggérait de faire une </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opération pour remplacer le corps de la table au niveau du fichier, sans toucher aux statistiques et FK, mais n'a pas collecté le quorum.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SUPPRIMER, METTRE À JOUR, INSÉRER</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous arrêtons donc sur une version non bloquante de trois opérations. </font><font style="vertical-align: inherit;">Presque trois ... Comment le faire le plus efficacement possible?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Importer le post-traitement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même KLADER, tous les enregistrements modifiés doivent en outre être soumis à un post-traitement - normaliser, mettre en surbrillance les mots clés et apporter aux structures nécessaires. </font><font style="vertical-align: inherit;">Mais comment savoir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactement ce qui a changé</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sans compliquer le code de synchronisation, idéalement sans le toucher du tout? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si seul votre processus a un accès en écriture au moment de la synchronisation, vous pouvez utiliser un déclencheur qui collectera toutes les modifications pour nous:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous pouvons imposer des déclencheurs (ou les activer </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">avant de démarrer la synchronisation </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis tranquillement à partir des tables de journal, nous extrayons toutes les modifications dont nous avons besoin et les exécutons via des gestionnaires supplémentaires.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Importer des ensembles associés</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessus, nous avons considéré les cas où les structures de données de la source et du récepteur coïncident. </font><font style="vertical-align: inherit;">Mais que se passe-t-il si le déchargement d'un système externe a un format différent de la structure de stockage dans notre base de données? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons l'exemple du stockage des clients et de leurs comptes, l'option plusieurs-à-un classique:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le déchargement d'une source externe nous vient sous la forme de "tout en un":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute évidence, les données client peuvent être dupliquées de cette manière, et l'enregistrement principal est le «compte»:</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le modèle, insérez simplement nos données de test, mais n'oubliez pas - </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus efficacement!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premièrement, nous sélectionnons les «coupes» auxquelles nos «faits» se réfèrent. </font><font style="vertical-align: inherit;">Dans notre cas, les comptes se réfèrent aux clients:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin d'associer correctement les comptes aux identifiants clients, nous devons d'abord découvrir ou générer ces identifiants. </font><font style="vertical-align: inherit;">Ajoutez des champs pour eux:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utiliserons la méthode de synchronisation des tables avec la petite correction décrite ci-dessus - nous ne mettrons à jour ni ne supprimerons rien dans la table cible, car l'importation de clients se fait uniquement par ajout:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, tout - </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenant nous avons rempli le champ de communication </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec lequel nous allons insérer le compte.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492450/index.html">Mis à jour 03.31. Le coronavirus se transmet-il par voie aérienne? Ce qui est connu en ce moment</a></li>
<li><a href="../fr492454/index.html">Nous vendons le Refactoring d'Architecture à un client ou quel est le problème des développeurs</a></li>
<li><a href="../fr492456/index.html">Comment visualiser et animer des modèles (géophysiques). Afficher les données brutes</a></li>
<li><a href="../fr492458/index.html">Interface graphique simple pour M5Stack (Arduino)</a></li>
<li><a href="../fr492462/index.html">Source de vérité: comment un analyste apprend à un manager et à un développeur à travailler ensemble</a></li>
<li><a href="../fr492466/index.html">Comment passer de n'importe quel fournisseur d'hébergement avec cPanel à Plesk dans Rusonix en seulement cinq étapes</a></li>
<li><a href="../fr492468/index.html">Lenovo Thinkserver SE350: un héros de la périphérie</a></li>
<li><a href="../fr492474/index.html">Nous structurons les informations sur les boîtiers Android et analysons ce qu'un préfixe normal devrait être capable de faire.</a></li>
<li><a href="../fr492478/index.html">Sans gestion des connaissances, cela fait mal: 5 principales conséquences de l'absence de système</a></li>
<li><a href="../fr492480/index.html">Comment nous avons lutté contre les épidémies auparavant et ce que nous faisons contre les coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>