<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👧🏿 ✍🏾 🕘 zipアーカイブはどのように見え、それに対して何ができるか 👨🏿‍🎤 👩🏽‍🏫 🐓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、親愛なるハブル！
 
 過去半年間、ペットプロジェクトの曲がりくねった道が私をそのようなジャングルに導いており、そこから出ることはまだ不可能です。そして、それはすべて無害に始まった-写真のサイト、しかし完璧主義の感覚、景品の追求、そして私の考え方のいくつかの機能は、これを当初計画されてい...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>zipアーカイブはどのように見え、それに対して何ができるか</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471066/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、親愛なるハブル！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
過去半年間、ペットプロジェクトの曲がりくねった道が私をそのようなジャングルに導いており、そこから出ることはまだ不可能です。</font><font style="vertical-align: inherit;">そして、それはすべて無害に始まった-写真のサイト、しかし完璧主義の感覚、景品の追求、そして私の考え方のいくつかの機能は、これを当初計画されていた小さな散歩から本当の長い旅に変えた。</font><font style="vertical-align: inherit;">ええ、わかりました。かなり皮肉な革命家が「学び、勉強して、もう一度勉強する」と言っていたように、しかし、私は無邪気に、この忠告に従わなければなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ああ、メイントピックから気が散っていたもの。</font><font style="vertical-align: inherit;">長いスピーチで退屈することはもうありませんが、私は仕事に取りかかります。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zipアーカイブを作成する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、</font><font style="vertical-align: inherit;">ここで</font><font style="vertical-align: inherit;">は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕様を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き換え</font><font style="vertical-align: inherit;">ません。</font><font style="vertical-align: inherit;">全体として、構造を説明しても意味があり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ません</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これはすべて、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">私の前</font></a><font style="vertical-align: inherit;">で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">行われた</font></a><font style="vertical-align: inherit;">ため</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リンクをたどるのが面倒なので、zipアーカイブに含まれるべきことを簡単に説明します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルエントリ：</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルファイルヘッダー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有用なデータ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ記述子（オプション、最後まで読み取るまでファイルサイズとそのハッシュがわからない場合に使用） </font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央ディレクトリファイルヘッダー（ファイルごと。これは本の目次のようなもので、各セクションが示され、そのページが見つかります）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央ディレクトリの終わり</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを知っていれば、2つのファイルのみを含む単純なアーカイブを作成することができます。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-comment">//        (1.txt  2.txt)   :</span><font></font>
$entries = [<font></font>
    <span class="hljs-string">'1.txt'</span> =&gt; <span class="hljs-string">'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc id ante ultrices, fermentum nibh eleifend, ullamcorper nunc. Sed dignissim ut odio et imperdiet. Nunc id felis et ligula viverra blandit a sit amet magna. Vestibulum facilisis venenatis enim sed bibendum. Duis maximus felis in suscipit bibendum. Mauris suscipit turpis eleifend nibh commodo imperdiet. Donec tincidunt porta interdum. Aenean interdum condimentum ligula, vitae ornare lorem auctor in. Suspendisse metus ipsum, porttitor et sapien id, fringilla aliquam nibh. Curabitur sem lacus, ultrices quis felis sed, blandit commodo metus. Duis tincidunt vel mauris at accumsan. Integer et ipsum fermentum leo viverra blandit.'</span>,<font></font>
    <font></font>
    <span class="hljs-string">'2.txt'</span> =&gt; <span class="hljs-string">'Mauris in purus sit amet ante tempor finibus nec sed justo. Integer ac nibh tempus, mollis sem vel, consequat diam. Pellentesque ut condimentum ex. Praesent finibus volutpat gravida. Vivamus eleifend neque sit amet diam scelerisque lacinia. Nunc imperdiet augue in suscipit lacinia. Curabitur orci diam, iaculis non ligula vitae, porta pellentesque est. Duis dolor erat, placerat a lacus eu, scelerisque egestas massa. Aliquam molestie pulvinar faucibus. Quisque consequat, dolor mattis lacinia pretium, eros eros tempor neque, volutpat consectetur elit elit non diam. In faucibus nulla justo, non dignissim erat maximus consectetur. Sed porttitor turpis nisl, elementum aliquam dui tincidunt nec. Nunc eu enim at nibh molestie porta ut ac erat. Sed tortor sem, mollis eget sodales vel, faucibus in dolor.'</span>,<font></font>
];<font></font>
<font></font>
<span class="hljs-comment">//      Lorem.zip,      cwd (      )</span>
$destination = <span class="hljs-string">'Lorem.zip'</span>;<font></font>
$handle = fopen($destination, <span class="hljs-string">'w'</span>);<font></font>
<font></font>
<span class="hljs-comment">//      ,    ,     ,   "" Central Directory File Header</span>
$written = <span class="hljs-number">0</span>;<font></font>
$dictionary = [];<font></font>
<span class="hljs-keyword">foreach</span> ($entries <span class="hljs-keyword">as</span> $filename =&gt; $content) {
    <span class="hljs-comment">//         Local File Header,    </span>
    <span class="hljs-comment">//        ,      .</span><font></font>
    <font></font>
    $fileInfo = [<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-string">'versionToExtract'</span>      =&gt; <span class="hljs-number">10</span>,                                      
        <span class="hljs-comment">//   0,        -</span>
        <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-number">0</span>,                                       
        <span class="hljs-comment">//      ,    0</span>
        <span class="hljs-string">'compressionMethod'</span>     =&gt; <span class="hljs-number">0</span>,                                       
        <span class="hljs-comment">// -    mtime ,    ,      ?</span>
        <span class="hljs-string">'modificationTime'</span>      =&gt; <span class="hljs-number">28021</span>,                                   
        <span class="hljs-comment">//   , ?</span>
        <span class="hljs-string">'modificationDate'</span>      =&gt; <span class="hljs-number">20072</span>,
        <span class="hljs-comment">//      .     ,       ,   ?</span>
        <span class="hljs-string">'crc32'</span>                 =&gt; hexdec(hash(<span class="hljs-string">'crc32b'</span>, $content)),
        <span class="hljs-comment">//     .        . </span>
        <span class="hljs-comment">//       :)</span>
        <span class="hljs-string">'compressedSize'</span>        =&gt; $size = strlen($content),
        <span class="hljs-string">'uncompressedSize'</span>      =&gt; $size,
        <span class="hljs-comment">//   </span>
        <span class="hljs-string">'filenameLength'</span>        =&gt; strlen($filename),
        <span class="hljs-comment">//  .    ,   0.</span>
        <span class="hljs-string">'extraFieldLength'</span>      =&gt; <span class="hljs-number">0</span>,<font></font>
    ];<font></font>
    <font></font>
    <span class="hljs-comment">//      .</span>
    $LFH = pack(<span class="hljs-string">'LSSSSSLLLSSa*'</span>, ...array_values([
        <span class="hljs-string">'signature'</span> =&gt; <span class="hljs-number">0x04034b50</span>, <span class="hljs-comment">//  Local File Header</span>
    ] + $fileInfo + [<span class="hljs-string">'filename'</span> =&gt; $filename]));<font></font>
    <font></font>
    <span class="hljs-comment">//       ,       Central Directory File Header</span><font></font>
    $dictionary[$filename] = [<font></font>
        <span class="hljs-string">'signature'</span>     =&gt; <span class="hljs-number">0x02014b50</span>, <span class="hljs-comment">//  Central Directory File Header</span>
        <span class="hljs-string">'versionMadeBy'</span> =&gt; <span class="hljs-number">798</span>,        <span class="hljs-comment">//  .    ,  -  .</span><font></font>
    ] + $fileInfo + [<font></font>
        <span class="hljs-string">'fileCommentLength'</span>      =&gt; <span class="hljs-number">0</span>,          <span class="hljs-comment">//    . No comments</span>
        <span class="hljs-string">'diskNumber'</span>             =&gt; <span class="hljs-number">0</span>,          <span class="hljs-comment">//     0,       </span>
        <span class="hljs-string">'internalFileAttributes'</span> =&gt; <span class="hljs-number">0</span>,          <span class="hljs-comment">//   </span>
        <span class="hljs-string">'externalFileAttributes'</span> =&gt; <span class="hljs-number">2176057344</span>, <span class="hljs-comment">//   </span>
        <span class="hljs-string">'localFileHeaderOffset'</span>  =&gt; $written,   <span class="hljs-comment">//      Local File Header</span>
        <span class="hljs-string">'filename'</span>               =&gt; $filename,  <span class="hljs-comment">//  .</span><font></font>
    ];<font></font>
    <font></font>
    <span class="hljs-comment">//     </span><font></font>
    $written += fwrite($handle, $LFH);<font></font>
    <span class="hljs-comment">//   </span><font></font>
    $written += fwrite($handle, $content);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ,     ,    .</span>
<span class="hljs-comment">//          End of central directory record (EOCD)</span><font></font>
$EOCD = [<font></font>
    <span class="hljs-comment">//  EOCD</span>
    <span class="hljs-string">'signature'</span>                    =&gt; <span class="hljs-number">0x06054b50</span>, 
    <span class="hljs-comment">//  .    ,   0</span>
    <span class="hljs-string">'diskNumber'</span>                   =&gt; <span class="hljs-number">0</span>,          
    <span class="hljs-comment">//      -  0</span>
    <span class="hljs-string">'startDiskNumber'</span>              =&gt; <span class="hljs-number">0</span>,          
    <span class="hljs-comment">//       .</span>
    <span class="hljs-string">'numberCentralDirectoryRecord'</span> =&gt; $records = count($dictionary), 
    <span class="hljs-comment">//    .    ,    </span>
    <span class="hljs-string">'totalCentralDirectoryRecord'</span>  =&gt; $records, 
    <span class="hljs-comment">//   Central Directory Record. </span>
    <span class="hljs-comment">//      ,     </span>
    <span class="hljs-string">'sizeOfCentralDirectory'</span>       =&gt; <span class="hljs-number">0</span>, 
    <span class="hljs-comment">// ,    Central Directory Records</span>
    <span class="hljs-string">'centralDirectoryOffset'</span>       =&gt; $written,
    <span class="hljs-comment">//    </span>
    <span class="hljs-string">'commentLength'</span>                =&gt; <span class="hljs-number">0</span><font></font>
];<font></font>
<font></font>
<span class="hljs-comment">//     !  </span>
<span class="hljs-keyword">foreach</span> ($dictionary <span class="hljs-keyword">as</span> $entryInfo) {<font></font>
    $CDFH = pack(<span class="hljs-string">'LSSSSSSLLLSSSSSLLa*'</span>, ...array_values($entryInfo));<font></font>
    $written += fwrite($handle, $CDFH);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ,   .  ,   </span>
$EOCD[<span class="hljs-string">'sizeOfCentralDirectory'</span>] = $written - $EOCD[<span class="hljs-string">'centralDirectoryOffset'</span>];<font></font>
    <font></font>
<span class="hljs-comment">//     End of central directory record</span>
$EOCD = pack(<span class="hljs-string">'LSSSSLLS'</span>, ...array_values($EOCD));<font></font>
$written += fwrite($handle, $EOCD);<font></font>
<font></font>
<span class="hljs-comment">//  . </span><font></font>
fclose($handle);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> <span class="hljs-string">'  : '</span> . $written . <span class="hljs-string">' '</span> . PHP_EOL;
<span class="hljs-keyword">echo</span> <span class="hljs-string">'     `unzip -tq '</span> . $destination . <span class="hljs-string">'`'</span> . PHP_EOL;
<span class="hljs-keyword">echo</span> PHP_EOL;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプリミティブコードを実行してみてください。出力により、1.txtと2.txtを含むLorem.zipファイルが得られます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何のために？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、適切な人なら誰でも、phpでアーカイバを書くのは無駄な仕事だと言うでしょう。特に、zipのようなフォーマットの場合、すべてのテイストと色について既成の実装がたくさんあるからです。</font><font style="vertical-align: inherit;">そして同じphpには既製のライブラリがあります。</font><font style="vertical-align: inherit;">私もそう言います:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、なぜこの記事全体、なぜ私はそれを書いて時間を費やして、あなたはそれを読んだのですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すべてがそれほど単純ではなく、zipがどのように機能するかを知ることで、いくつかの可能性が広がります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、私は少なくとも少しは願っていますが、zipの構造を理解したい人には役立ちます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つ目は、自分の手でアーカイブを作成することです。私たちは制御が可能で、最も重要なのは、その内部データにアクセスできることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルファイルヘッダーと中央ディレクトリファイルヘッダーを事前に計算し、必要に応じてコンテンツとファイルの順序を含むzipアーカイブをオンザフライで生成し、このデータを置き換えるだけです。 I / O以外のオーバーヘッドはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、アーカイブを記録して、たとえば、断片化されたダウンロードをサポートするクラウドにアップロードし、各ファイルのオフセットを把握して、アーカイブにないかのようにアーカイブファイルを取得し、1つだけ追加することもできます。リクエストのヘッダー。そして、これらすべてがプロキシ化される可能性があります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。このトピックに興味がある場合は、以下の記事でこれらの機会を検討して、それらの使用方法を示します。</font></font><br>
<br>
<hr><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'diskNumber' =&gt; 0、//私はいつもどこでも0に出くわし、特に掘り下げないことにしました</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提案されたように </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベレス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -マルチボリュームアーカイブのボリューム番号。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471048/index.html">React + Mobx：ポイントは何ですか？</a></li>
<li><a href="../ja471050/index.html">D言語開発資金融資：新しいプラットフォームと新しい助成金...</a></li>
<li><a href="../ja471052/index.html">ハズしてもいいですか？ジェネリック型プログラミングによるヒット</a></li>
<li><a href="../ja471054/index.html">暗号通貨の量子脅威の現実性と「予言2027」の問題についてLongrid</a></li>
<li><a href="../ja471062/index.html">スマートホームを管理するようにアリスに教える方法。Yandexレポート</a></li>
<li><a href="../ja471070/index.html">選択するサーバー言語...モバイル開発者向け</a></li>
<li><a href="../ja471072/index.html">テレグラムのグラム数は？</a></li>
<li><a href="../ja471074/index.html">Synet-CPUで事前トレーニング済みニューラルネットワークを実行するためのフレームワーク</a></li>
<li><a href="../ja471076/index.html">マトリックスが防弾遺産を作成した方法</a></li>
<li><a href="../ja471078/index.html">Chromeは混合コンテンツを完全にブロックします</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>