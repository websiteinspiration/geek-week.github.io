<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüé® üè¥‚Äç‚ò†Ô∏è üéÅ Starting with Core Data! Difficult in simple words [Part 2] üí∫ üñêüèΩ üöû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to further reveal the capabilities of Core Data. This article is a continuation . I really hope that I can get the idea ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Starting with Core Data! Difficult in simple words [Part 2]</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495602/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article, I would like to further reveal the capabilities of Core Data. </font><font style="vertical-align: inherit;">This article is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continuation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I really hope that I can get the idea that Core Data is not one of the many relational databases, but a very powerful tool that can become an integral weapon in the arsenal of any self-respecting IOS developer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, let's get started!</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we look at working with two NSManageObjectContext and NSFetchedResultsController. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two NSManageObjectContext and why is this needed?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your application actively uses any API through which it receives data, and you want to save this data somewhere, then Core Data is an excellent choice. What problems might you have with this? The first and most obvious - the amount of data will be so large that when you try to save them, our application will freeze for some time, which will affect the user's experience. An ordinary GCD can not be dispensed with since it is independent, our Core Data Stack, which was mentioned </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , works synchronously and for any access to our NSManageObjectContext we have to wait until the end of the loop. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But here the private NSManageObjectContext that works in the background thread comes to the rescue. In order to call it, you must first contact our NSPersistentContainer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialization will look like this:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> persistentContainer: <span class="hljs-type">NSPersistentContainer</span> = {
    <span class="hljs-keyword">let</span> container = <span class="hljs-type">NSPersistentContainer</span>(name: <span class="hljs-string">"Preset"</span>)<font></font>
    container.loadPersistentStores { (persistent, error) <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error = error {
            <span class="hljs-built_in">fatalError</span>(<span class="hljs-string">"Error: "</span> + error.localizedDescription)<font></font>
        }<font></font>
    }<font></font>
    container.viewContext.mergePolicy = <span class="hljs-type">NSMergeByPropertyStoreTrumpMergePolicy</span>
    container.viewContext.shouldDeleteInaccessibleFaults = <span class="hljs-literal">true</span>
    container.viewContext.automaticallyMergesChangesFromParent = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> container<font></font>
}()<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mergepolicy</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you specify the merge policy of our NSManageObjectContext. </font><font style="vertical-align: inherit;">Here we explicitly indicate how Core Data should behave in the event of a data conflict. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MergePolicy Options:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSRollbackMergePolicy - In the event of a conflict, discards all changes until it occurs </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSOverwriteMergePolicy - Saves new values ‚Äã‚Äãregardless of data </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSMergeByPropertyStoreTrumpMergePolicy - Saves changed objects property by property, in this case, saved data will prevail</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSMergeByPropertyObjectTrumpMergePolicy - Saves changed objects property by property, in this case new data will prevail </font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AutomaticallyMergesChangesFromParent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - says whether our context will automatically merge data. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then create a new context:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> context = persistentContainer.viewContext
<span class="hljs-keyword">let</span> context = persistentContainer.newBackgroundContext()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have two NSManageObjectContext. </font><font style="vertical-align: inherit;">The first one is for working with the UI and runs on the main thread, and the second one has privateQueueConcurrencyType for working in the background. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will use it to download data.</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> object = <span class="hljs-type">NSEntityDescription</span>.insertNewObject(forEntityName: <span class="hljs-string">"Name"</span>, into: context)<font></font>
saveChanges(with: context)<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we create our Entity and then we can assign the necessary properties to it, after which we call the save method, it looks like this: </font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">saveChanges</span><span class="hljs-params">(with context: NSManagedObjectContext)</span></span> {<font></font>
        context.performAndWait {<font></font>
            <span class="hljs-keyword">if</span> context.hasChanges {
                <span class="hljs-keyword">do</span> {
                    <span class="hljs-keyword">try</span> context.save()<font></font>
                } <span class="hljs-keyword">catch</span> {<font></font>
                    context.rollback()<font></font>
                }<font></font>
            }<font></font>
            context.reset()<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are 2 methods to choose from:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performAndWait - performs actions on the context thread synchronously</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perform - performs actions on the context stream asynchronously</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSFetchedResultsController</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NSFetchedResultsController - a controller that performs certain requests and displays the necessary data to the user.</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> fetchedResultsController: <span class="hljs-type">NSFetchedResultsController</span>&lt;<span class="hljs-type">Pack</span>&gt; = {
        <span class="hljs-keyword">let</span> fetchRequest = <span class="hljs-type">NSFetchRequest</span>&lt;<span class="hljs-type">Pack</span>&gt;(entityName:<span class="hljs-string">"Pack"</span>)<font></font>
        fetchRequest.fetchBatchSize = <span class="hljs-number">20</span>
        fetchRequest.sortDescriptors = [<span class="hljs-type">NSSortDescriptor</span>(key: <span class="hljs-string">"name"</span>, ascending:<span class="hljs-literal">true</span>)]
        <span class="hljs-keyword">let</span> controller = <span class="hljs-type">NSFetchedResultsController</span>(fetchRequest: fetchRequest, managedObjectContext: context, sectionNameKeyPath: <span class="hljs-literal">nil</span>, cacheName: <span class="hljs-literal">nil</span>)<font></font>
<font></font>
        controller.delegate = <span class="hljs-keyword">self</span>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> controller.performFetch()<font></font>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(error.localizedDescription)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> controller<font></font>
    }()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NSFetchedResultsController has a very large number of configurations, we will analyze a couple of them:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fetchlimit</font></font></b><div class="spoiler_text">FetchLimit ‚Äî      <br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sketchoffset</font></font></b><div class="spoiler_text">FetchOffset ‚Äî  .    2,       .<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FetchbatchSize</font></font></b><div class="spoiler_text">FetchBatchSize ‚Äî        .      Table/CollectionView        5 ,        7   ,          .<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FetchbatchSize</font></font></b><div class="spoiler_text">FetchBatchSize ‚Äî                .<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SortDescriptor</font></font></b><div class="spoiler_text">SortDescriptor ‚Äî       ,       .<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReturnsObjectsAsFaults</font></font></b><div class="spoiler_text">ReturnsObjectsAsFaults ‚Äî ,      ,      ,      PersistentStore         RawCache<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, we have an NSFetchedResultsController which should display our data in a table. </font><font style="vertical-align: inherit;">In order to update the data you need to call the delegate method:</font></font><br>
 <br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">ViewController</span>: <span class="hljs-title">NSFetchedResultsControllerDelegate</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">controller</span><span class="hljs-params">(<span class="hljs-number">_</span> controller: NSFetchedResultsController&lt;NSFetchRequestResult&gt;, didChange anObject: <span class="hljs-keyword">Any</span>, at indexPath: IndexPath?, <span class="hljs-keyword">for</span> type: NSFetchedResultsChangeType, newIndexPath: IndexPath?)</span></span> {<font></font>
       collectionView.reloadData()<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This delegate method works when we have any changes in our context. </font><font style="vertical-align: inherit;">In this implementation, this happens after we save the data in a privateContext. </font><font style="vertical-align: inherit;">At this moment, the delegate method is triggered and the data is updated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just a couple of actions and Core Data from a regular database turns into a powerful weapon of any iOS developer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Happy coding!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495580/index.html">Cucumber JVM - Not Just BDD</a></li>
<li><a href="../en495588/index.html">Creating roguelike in Unity from scratch: dungeon generator</a></li>
<li><a href="../en495592/index.html">How to use dictionaries (and not only)</a></li>
<li><a href="../en495594/index.html">Start making money on software: creating mini-digital-business</a></li>
<li><a href="../en495596/index.html">Remote work in the office. RDP, Port Knocking, Mikrotik: simple and safe</a></li>
<li><a href="../en495604/index.html">Temporary localization on Symfony 4 + Twig</a></li>
<li><a href="../en495606/index.html">"Social monitoring." Score 1: 0 in our favor</a></li>
<li><a href="../en495608/index.html">[Infographic] Visualization of pandemics in the history of mankind</a></li>
<li><a href="../en495610/index.html">Why the future is not for Python</a></li>
<li><a href="../en495612/index.html">Will Airbnb survive the coronavirus? [spoiler: yes]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>