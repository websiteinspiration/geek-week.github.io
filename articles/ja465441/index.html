<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊🏿 🐗 ❗️ LuaVela：LuaJIT 2.0に基づくLua 5.1実装 👩🏻‍🍳 ⏮️ 🐩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="しばらく前に、私たちは公開リリースを発表し、MITライセンスの下でLuaJIT 2.0に基づくLua 5.1の実装であるLuaVelaのソースコードをオープンしました。2015年に取り組みを開始し、2017年の初めまでに同社のプロジェクトの95％以上で使用されました。今、私は旅した道を振り返りたいで...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>LuaVela：LuaJIT 2.0に基づくLua 5.1実装</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/465441/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しばらく前に、私たち</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公開リリース</font><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">発表</font></a><font style="vertical-align: inherit;">し、MITライセンスの下</font><font style="vertical-align: inherit;">でLuaJIT 2.0に基づくLua 5.1の実装で</font><font style="vertical-align: inherit;">ある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LuaVela</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のソースコードを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">オープンしました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">2015年に取り組みを開始し、2017年の初めまでに同社のプロジェクトの95％以上で使用されました。</font><font style="vertical-align: inherit;">今、私は旅した道を振り返りたいです。</font><font style="vertical-align: inherit;">プログラミング言語の独自の実装を開発するようになったのはどのような状況ですか？</font><font style="vertical-align: inherit;">どのような問題が発生し、どのように解決しましたか？</font><font style="vertical-align: inherit;">LuaVelaは他のLuaJITフォークとどう違うのですか？</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックグラウンド</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションは</font><font style="vertical-align: inherit;">、HighLoad ++ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関するレポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">基づいています</font><font style="vertical-align: inherit;">。 2008年に、Luaを積極的に使用して製品のビジネスロジックを記述し始めました。最初はバニラLuaでしたが、2009年以降はLuaJITでした。 RTBプロトコルは要求を処理するためのタイトなフレームワークを持っているため、言語のより高速な実装への切り替えは、ある時点から論理的かつ必要な決定でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間が経つにつれ、LuaJITアーキテクチャーに特定の制限があることに気付きました。私たちにとって最も重要なことは、LuaJIT 2.0が厳密に32ビットのポインタを使用することです。これにより、64ビットLinuxで実行すると、プロセスメモリの仮想アドレススペースのサイズが1ギガバイトに制限されました（新しいバージョンのLinuxカーネルでは、この制限は2ギガバイトに引き上げられました）。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* MAP_32BIT    4  x86-64: */</span>
<span class="hljs-keyword">void</span> *ptr = mmap((<span class="hljs-keyword">void</span> *)MMAP_REGION_START, size, MMAP_PROT,<font></font>
                 MAP_32BIT | MMAP_FLAGS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この制限は大きな問題になりました-2015年までに、1〜2ギガバイトのメモリは、多くのプロジェクトがロジックが動作するデータをロードするのに十分でなくなりました。 Lua仮想マシンの各インスタンスはシングルスレッドであり、他のインスタンスとデータを共有する方法を認識していないことに注意してください。つまり、実際には、各仮想マシンは2GB / nを超えないメモリサイズを要求できます。nは、サーバーのワーカースレッドの数です。アプリケーション。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題の解決策をいくつか検討しました。アプリケーションサーバーのスレッド数を減らし、LuaJIT FFIを介してデータへのアクセスを整理しようとし、LuaJIT 2.1への移行をテストしました。残念ながら、これらのオプションはすべて、経済的に不利であるか、長期的にはうまく拡張できませんでした。私たちに残された唯一のものは、チャンスをつかんでLuaJITをフォークすることでした。この時点で、プロジェクトの運命を大きく決定する決定を下しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、LuaJITのアーキテクチャ上の制限を取り除くことに焦点を当て、言語の構文とセマンティクスを変更しないことをすぐに決定しました。これは、会社にとって問題であることが判明しました。もちろん、プロジェクトの開発に伴い、拡張機能を追加し始めました（これについては以下で説明します）。ただし、すべての新しいAPIを標準言語ライブラリから分離しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、唯一の本番プラットフォームであるLinux x86-64のみをサポートするため、クロスプラットフォームを廃止しました。</font><font style="vertical-align: inherit;">残念ながら、プラットフォームに加える予定の膨大な量の変更を適切にテストするための十分なリソースがありませんでした。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プラットフォームのフードの下をざっと見て</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポインタのサイズの制限がどこから来るのか見てみましょう。</font><font style="vertical-align: inherit;">まず</font><font style="vertical-align: inherit;">、Lua 5.1の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数値</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">は（いくつかの小さな注意点があります）C型のdoubleであり、IEEE 754規格で定義されている倍精度型に対応しています。この64ビット型のエンコードでは、値の範囲がプレゼンテーション用に強調表示されていますNaN。</font><font style="vertical-align: inherit;">特に、NaNが[0xFFF8000000000000;の範囲の値を解釈する方法。</font><font style="vertical-align: inherit;">0xFFFFFFFFFFFFFFFF]。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、「実際の」倍精度数または何らかのエンティティのいずれかを単一の64ビット値にパックできます。これは、double型の観点からはNaNとして解釈され、プラットフォームの観点からはより意味のあるものになります。たとえば、オブジェクトタイプ（上位32ビット）とその内容へのポインタ（下位32ビット）：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">union</span> TValue {
        <span class="hljs-keyword">double</span> n;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">object</span> {</span>
                <span class="hljs-keyword">void</span> *payload;
                <span class="hljs-keyword">uint32_t</span> type;<font></font>
        } o;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この手法はNaNタグ付け（またはNaNボクシング）と呼ばれることもあり、TValueは基本的にLuaJITがLuaの変数値を表す方法を記述します。</font><font style="vertical-align: inherit;">TValueには、Luaスタックを巻き戻すための関数ポインターと情報を格納するために使用される3番目の仮説もあります。つまり、最終的な分析では、データ構造は次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">union</span> TValue {
        <span class="hljs-keyword">double</span> n;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">object</span> {</span>
                <span class="hljs-keyword">void</span> *payload;
                <span class="hljs-keyword">uint32_t</span> type;<font></font>
        } o;<font></font>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">frame</span> {</span>
                <span class="hljs-keyword">void</span> *func;
                <span class="hljs-keyword">uintptr_t</span> link;<font></font>
        } f;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の定義のframe.linkフィールドは、タイプがuintptr_tです。これは、ポインターを格納する場合と、整数の場合があります。結果は、仮想マシンスタックの非常にコンパクトな表現です。実際、これはTValue配列であり、配列の各要素は状況に応じて数値として解釈され、次にオブジェクトへの型付きポインターとして、またはLuaスタックのフレームに関するデータとして解釈されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を見てみましょう。 LuaJITでこのLuaコードを開始し、print関数内にブレークポイントを設定したとします。</font></font><br>
<br>
<pre><code class="lua hljs"><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span><span class="hljs-params">(x)</span></span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, "</span> .. x)
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span><span class="hljs-params">(a, b)</span></span>
        <span class="hljs-keyword">local</span> n = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">pi</span><font></font>
        foo(b)<font></font>
<span class="hljs-keyword">end</span><font></font>
<font></font>
bar({}, <span class="hljs-string">"Lua"</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点でのLuaスタックは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/av/hn/1navhnm8vbz-inawirkvewxppme.png" alt="LuaJIT 2.0を使用したLuaスタック"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべて問題はありませんが、この手法は、x86-64で起動しようとするとすぐに失敗し始めます。</font><font style="vertical-align: inherit;">32ビットアプリケーションの互換モードで実行すると、すでに上で述べたmmap制限にぶつかります。</font><font style="vertical-align: inherit;">また、64ビットポインタはそのままでは機能しません。</font><font style="vertical-align: inherit;">何をすべきか？</font><font style="vertical-align: inherit;">私がしなければならなかった問題を修正するために：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TValueを64ビットから128ビットに拡張します。これにより、64ビットプラットフォームで「正直な」void *が得られます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それに応じて仮想マシンコードを修正します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JITコンパイラに変更を加えます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更の総量は非常に重要であり、元のLuaJITからかなり引き離されました。</font><font style="vertical-align: inherit;">TValue拡張機能が問題を解決する唯一の方法ではないことは注目に値します。</font><font style="vertical-align: inherit;">LuaJIT 2.1では、LJ_GC64モードを実装することで、他の方法を採用しました。</font><font style="vertical-align: inherit;">この操作モードの開発に多大な貢献をしたピーターカウリー（ピーターコーリー）は、</font><font style="vertical-align: inherit;">ロンドンのミタポフの1つで</font><font style="vertical-align: inherit;">この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">読み</font><font style="vertical-align: inherit;">ました。</font><font style="vertical-align: inherit;">まあ、LuaVelaの場合、同じ例のスタックは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ar/rj/yv/arrjyvsnfyixhd8haufn95nhgu8.png" alt="LuaVelaを使用する場合のLuaスタック"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの最初の成功と安定化</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数か月にわたる活発な開発の後、LuaVelaを戦闘で試す時が来ました。</font><font style="vertical-align: inherit;">実験的に、メモリ消費の観点から最も問題のあるプロジェクトを選択しました。プロジェクトで使用する必要があるデータの量は明らかに1ギガバイトを超えていたため、さまざまな回避策を使用せざるを得ませんでした。</font><font style="vertical-align: inherit;">最初の結果は有望でした。LuaVelaは安定しており、これらの同じプロジェクトで使用されているLuaJIT構成と比較してより良いパフォーマンスを示しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、テストの問題が生じました。</font><font style="vertical-align: inherit;">幸い、サーバーをステージングすることに加えて、開発の初日から自由に使用できるため、ゼロから始める必要はありませんでした。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての企業プロジェクトのビジネスロジックを実行するアプリケーションサーバーの機能テストと統合テスト。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個々のプロジェクトのテスト。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実践が示しているように、これらのリソースは、プロジェクトをデバッグして最小の安定状態にするのに十分でした（開発アセンブリを実行しました-ステージングにロールアウトしました-機能し、クラッシュしません）。一方、他のプロジェクトによるこのようなテストは、長期的には完全に不適切でした。プログラミング言語の実装が独自のテストを持つことができないほど複雑なプロジェクト。さらに、プロジェクトに直接テストがないため、純粋に技術的にエラーの検索と修正が複雑になりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理想的な世界では、実装だけでなく</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、言語のセマンティクスに</font></a><font style="vertical-align: inherit;">照らして検証できるようにする一連のテストもテストしたかった</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">残念ながら、この件に関しては失望感が待っていました。</font><font style="vertical-align: inherit;">Luaコミュニティーが既存の実装のフォークを喜んで作成するという事実にもかかわらず、最近まで、同様の検証テストのセットが欠けていました。</font><font style="vertical-align: inherit;">2018年末にFrançoisPerrad </font><font style="vertical-align: inherit;">がlua-Harnessプロジェクトを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発表し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た</font><font style="vertical-align: inherit;">とき、状況は良くなりました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、Luaエコシステムの最も完全で代表的なテストスイートをリポジトリに統合することで、テストの問題を解決しました。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua 5.1の実装のために言語の作成者によって書かれた</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">テスト</font></a><font style="vertical-align: inherit;">。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LuaJITの作者であるマイクポールがコミュニティから提供した</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">テスト</font></a><font style="vertical-align: inherit;">。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルアハーネス</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CERNによって開発されている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトのテストのサブセット</font><font style="vertical-align: inherit;">。</font></font></li>
<li>  ,     IPONWEB      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> –    , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">cmocka</a>, –   C API  ,        Lua-.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストの各バッチの導入により、2〜3個の重大なエラーを検出して修正することができたので、私たちの努力が成果を上げたことは明らかです。</font><font style="vertical-align: inherit;">言語ランタイムとコンパイラ（静的と動的の両方）のテストのトピックは本当に無限ですが、プロジェクトの安定した開発のためにかなり強固な基盤を築いたと信じています。</font><font style="vertical-align: inherit;">Luaの独自の実装をテストする際の問題について（テストベンチでの作業や死後のデバッグなどのトピックを含めて）2回、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017年のモスクワ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Lua</font></a><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++ 2018</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">話しました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">もちろん、私たちのリポジトリの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクトリを見てください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新機能</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、LuaJITの遺産と蓄積された専門知識を徐々に「習得」した小さなチームの力によって開発された、Linux x86-64用のLua 5.1の安定した実装を自由に利用できました。このような状況で、プラットフォームを拡張し、バニラLuaにもLuaJITにもない機能を追加したいという願望は、他の差し迫った問題の解決に役立つはずでしたが、かなり自然になりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての拡張機能の詳細な説明は</font><font style="vertical-align: inherit;">、RST形式</font><font style="vertical-align: inherit;">の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">提供され</font><font style="vertical-align: inherit;">ます（cmakeを使用します&amp;&amp; make docsを使用して、HTML形式のローカルコピーを作成します）。 Lua API拡張機能の完全な説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このリンク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にあり、C API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はこちらにあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。残念ながら、レビュー記事ではすべてについて話すことは不可能であるため、最も重要な機能のリストを次に示します。</font></font><br>
<br>
<ul>
<li>DataState –             Lua.</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-  </a>      ,    .</li>
<li>  JIT-,             –    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  HighLoad++ 2017,           ,    .</li>
<li> :  .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">dumpanalyze</a>  . .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの機能はそれぞれ別の記事に値する-あなたがもっと読みたいものをコメントに書いてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、ガベージコレクターの負荷を軽減する方法についてもう少し説明します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シーリング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトをガベージコレクタにアクセスできないようにすることができます。私たちの典型的なプロジェクトでは、Lua仮想マシン内のほとんどのデータ（最大80％）はすでに複雑なLuaテーブルであるビジネスルールです。このテーブルの存続期間（分）は、処理された要求の存続期間（数十ミリ秒）よりもはるかに長く、その中のデータはクエリ処理中に変更されません。このような状況では、ガベージコレクターにこの巨大なデータ構造を何度も再帰させることは意味がありません。これを行うには、ガベージコレクターが「封印された」オブジェクトまたはそのコンテンツに到達しないように、オブジェクトを再帰的に「シール」し、データを並べ替えます。 Vanilla Lua 5.4では、この問題は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決されます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガベージコレクター（世代別ガベージコレクション）でのオブジェクトの世代のサポート。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「封印された」オブジェクトは書き込み可能であってはならないことに留意することが重要です。この不変条件を守らないと、ダングリングポインターが表示されます。たとえば、「密封された」オブジェクトは通常のオブジェクトを参照し、ヒープを渡すときに「密封された」オブジェクトをスキップするガベージコレクターは、通常のオブジェクトをスキップします。「密封された」オブジェクトは解放できないという違いがあります。そして、通常のことができます。この不変式のサポートを実装したので、基本的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">に対する</font></a><font style="vertical-align: inherit;">無料の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">イミュニティ</font></a><font style="vertical-align: inherit;">サポートが提供さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">ます。その不在はLuaでしばしば嘆かれます。不変オブジェクトと「密封された」オブジェクトは同じものではないことを強調します。 2番目のプロパティは最初のプロパティを意味しますが、その逆は意味しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lua 5.1では、メタテーブルを使用してイミュニティを実装できることにも注意します。ソリューションは非常に効果的ですが、パフォーマンスの点で最も収益性が高くありません。</font><font style="vertical-align: inherit;">「封印」、免疫、および日常生活でのそれらの使用方法の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポートを参照してください。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現時点では、安定性と実装の機会に満足しています。</font><font style="vertical-align: inherit;">また、初期の制限のため、実装は移植性の点でバニラLuaおよびLuaJITよりもかなり劣っていますが、多くの問題が解決されています。これらのソリューションが他の誰かに役立つことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、LuaVelaが生産に適していなくても、LuaJITまたはそのフォークがどのように機能するかを理解するためのエントリポイントとして使用することをお勧めします。</font><font style="vertical-align: inherit;">問題の解決と機能の拡張に加えて、長年にわたってコードベースの大部分をリファクタリングし</font><font style="vertical-align: inherit;">、プロジェクトの内部設計に関する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チュートリアル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を書いてき</font><font style="vertical-align: inherit;">ました。それらの多くはLuaVelaだけでなくLuaJITにも適用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご清聴ありがとうございました。プルリクエストをお待ちしております！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja465429/index.html">Cは低水準言語です</a></li>
<li><a href="../ja465431/index.html">PVS-Studio静的アナライザーを使用したApache DubboフレームワークのRPCソースコードの分析</a></li>
<li><a href="../ja465433/index.html">作業ロボット-幸せな男</a></li>
<li><a href="../ja465435/index.html">組み込みシステムにはどのディストリビューションが適していますか？</a></li>
<li><a href="../ja465437/index.html">AWSでの作業を拒否した理由</a></li>
<li><a href="../ja465443/index.html">オーロラハント：弱いサブストーム</a></li>
<li><a href="../ja465445/index.html">IoTプロバイダーの注意事項。インパルス出口呪い</a></li>
<li><a href="../ja465449/index.html">Mail.ruとFSBの問題がPavel Durovの評判とTelegramへの信仰によってどのように偽造されたか</a></li>
<li><a href="../ja465453/index.html">9月3日-サンクトペテルブルクでのCTOデー</a></li>
<li><a href="../ja465455/index.html">インシデントを処理し、インシデントへの対応と技術的な負債額を改善します。バックエンドユナイテッド4 mitapマテリアル：オクローシカ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>