<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤷🏿 🤜🏾 👩🏿‍⚖️ EF Core + Oracle: cara membuat migrasi idempoten 🕺🏼 🌶️ 🙅🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Biasanya, kerangka kerja EF Core digunakan bersama dengan MS SQL, produk Microsoft lainnya. Namun, ini bukan dogma. Misalnya, di CUSTIS kami menulis l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EF Core + Oracle: cara membuat migrasi idempoten</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/494278/"><img src="https://habrastorage.org/webt/3a/lj/or/3aljorcjihhefstlxuybizl-3tg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biasanya, kerangka kerja EF Core digunakan bersama dengan MS SQL, produk Microsoft lainnya. </font><font style="vertical-align: inherit;">Namun, ini bukan dogma. </font><font style="vertical-align: inherit;">Misalnya, di CUSTIS kami menulis logika bisnis dalam C #, dan kami menggunakan Oracle untuk mengelola basis data. </font><font style="vertical-align: inherit;">EF Core memiliki mekanisme migrasi yang luar biasa, tetapi dalam kasus kami mereka tidak idempoten. </font><font style="vertical-align: inherit;">Faktanya adalah bahwa Oracle dan sejumlah database lain, seperti MySQL, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak mendukung DDL transaksional</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini berarti bahwa jika migrasi jatuh di suatu tempat di tengah, itu tidak dapat digulung atau digulung kembali. </font><font style="vertical-align: inherit;">Bagaimana cara menerapkan migrasi idempoten ke EF Core tanpa MS SQL?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latar Belakang</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perusahaan kami memiliki alat yang cukup kuat untuk menginstal tambalan pada basis data Oracle, yang kami gunakan di sejumlah proyek. </font><font style="vertical-align: inherit;">Itu ditulis ketika tidak ada Liquibase, migrasi EF, dan alat terbuka lainnya. </font><font style="vertical-align: inherit;">Patcher memungkinkan Anda untuk bekerja dengan ratusan basis data, melacak riwayat instalasi, melihat log, menyimpan rahasia, dan banyak lagi. </font><font style="vertical-align: inherit;">Skrip untuk mengubah database ditulis dalam bentuk makro SQL atau m4. </font><font style="vertical-align: inherit;">Dengan bantuan mereka, Anda dapat, antara lain, memodifikasi struktur: membuat tabel, kolom, dan objek lainnya. </font><font style="vertical-align: inherit;">Selain itu, makro m4 idempoten. </font><font style="vertical-align: inherit;">Ini berarti bahwa jika Anda mencoba membuat, misalnya, tabel, skrip tidak jatuh, tetapi melihat bahwa itu sudah ada dan melompati ciptaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalkan skrip untuk menginstal tambalan terdiri dari dua operasi:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat tabel A.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat Tabel B.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika skrip macet setelah operasi pertama, tabel A akan tetap di Oracle. Menerapkan kembali tambalan akan berfungsi dengan benar: skrip akan memverifikasi bahwa A sudah ada, sehingga akan segera melanjutkan ke operasi kedua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain kelebihannya, patcher masih memiliki kekurangan - alat ini ditutup dan hanya digunakan di CUSTIS. Pengembang harus belajar untuk bekerja dengannya, dan di luar perusahaan pengalaman seperti itu tidak terlalu berharga. Selain itu, patcher tidak mendukung mode operasi Code First, sehingga semua skrip untuk mengubah struktur database harus ditulis secara manual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami ingin mencoba beberapa mekanisme yang siap pakai untuk menginstal tambalan dan memilih migrasi. Pada akhir 2019, proyek lain baru saja diluncurkan untuk pelanggan, di mana kami memutuskan untuk menguji pendekatan baru. Masalah utama dari mekanisme ini adalah ketidakberpindahan migrasi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam MS SQL, rantai pernyataan atau migrasi DDL dilakukan sebagai transaksi majemuk tunggal. </font><font style="vertical-align: inherit;">Jika terjadi gangguan, operasi dibatalkan sepenuhnya. </font><font style="vertical-align: inherit;">Oracle DDL bersifat non-transaksional, sehingga penurunan migrasi akan menyebabkan kondisi database yang tidak konsisten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita kembali ke tambalan, yang terdiri dari dua operasi: membuat tabel A dan B. Jika migrator jatuh setelah yang pertama, Oracle akan tetap di tabel A. Restart tidak akan berfungsi - operator </font></font><code>CREATE TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak akan suka bahwa A sudah ada. </font><font style="vertical-align: inherit;">Ini juga akan gagal untuk memutar kembali migrasi: EF Core menulis ke tabel sistem bahwa migrasi selesai, hanya di akhir proses. </font><font style="vertical-align: inherit;">Dari sudut pandang EF Core, jika migrasi belum selesai, maka tidak ada yang bisa dibatalkan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pencarian untuk solusi yang sudah jadi untuk Oracle di Internet tidak membuahkan hasil. Yang saya temukan hanyalah artikel tentang cara </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menulis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menginstal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambalan saat bekerja dengan EF. Beberapa saat kemudian di StackOverflow saya datang dengan ide untuk membuat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMigrationsSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saya </font><font style="vertical-align: inherit;">. Antarmuka ini bertanggung jawab untuk menghasilkan kode SQL yang memproses operasi EF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle.EntityFrameworkCore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> termasuk OracleMigrationsSqlGenerator, mengimplementasikan IMigrationsSqlGenerator. Misalnya, jika Anda ingin menambahkan kolom, kode berikut akan dihasilkan:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> MY_TABLE <span class="hljs-keyword">ADD</span> (MY_COLUMN <span class="hljs-built_in">DATE</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian kode tersebut diteruskan ke kelas lain untuk dijalankan dalam database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memulai, saya mencoba menimpa sepasang operasi OracleMigrationsSqlGenerator. </font><font style="vertical-align: inherit;">Tugas itu ternyata cukup layak, dan saya mulai menulis migran idempoten. </font><font style="vertical-align: inherit;">Inilah bagaimana </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muncul </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum operasi EF, migrator kami memeriksa untuk melihat apakah itu telah dilakukan sebelumnya. </font><font style="vertical-align: inherit;">Misalnya, kolom ditambahkan seperti ini:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    i <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> i
    <span class="hljs-keyword">FROM</span> user_tab_columns
    <span class="hljs-keyword">WHERE</span> table_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_TABLE'</span>) <span class="hljs-keyword">AND</span> column_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_COLUMN'</span>);<font></font>
    IF I != 1 THEN<font></font>
        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">IMMEDIATE</span> <span class="hljs-string">'ALTER TABLE MY_TABLE ADD (MY_COLUMN DATE)'</span>;  
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;       
<span class="hljs-keyword">END</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menggunakan paket ini sangat sederhana - Anda hanya perlu menggantinya </font></font><code>IMigrationsSqlGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam konteks yang benar:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
    {<font></font>
        optionsBuilder.ReplaceService&lt;IMigrationsSqlGenerator, IdempotentSqlGenerator&gt;();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Migrasi dibentuk dan ditetapkan oleh </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alat standar untuk EF Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">dotnet ef migrations <span class="hljs-keyword">add</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.1</span>
dotnet ef database update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan umum yang ditetapkan dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat diimplementasikan dalam generator yang ditulis untuk MySQL, MariaDB, Teradata, AmazonAurora dan database lain di mana DDL tidak transaksional.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paket ini tersedia di </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Sumber </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">NuGet </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di GitHub</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id494264/index.html">Cluster dua simpul - iblis secara detail</a></li>
<li><a href="../id494266/index.html">Tentang udalenka, RDP tanpa kondom dan peningkatan jumlah server yang tersedia dari Internet</a></li>
<li><a href="../id494270/index.html">Antiquities: Remote Work di Perangkat 1998</a></li>
<li><a href="../id494272/index.html">Membuat rencana bisnis startup TI: struktur detail langkah demi langkah</a></li>
<li><a href="../id494274/index.html">Sistem autotest E-commerce</a></li>
<li><a href="../id494284/index.html">Antiseptik buatan sendiri dari apa yang ada di apotek. Kami membuat alkohol dari vodka tanpa minuman keras dengan cara kuno</a></li>
<li><a href="../id494286/index.html">Embox RTOS di Raspberry Pi</a></li>
<li><a href="../id494290/index.html">#YAMYWork. Keputusan yang mungkin benar</a></li>
<li><a href="../id494292/index.html">Salah: 5 tahun dengan OKR</a></li>
<li><a href="../id494294/index.html">Pencetakan 3D bersertifikat untuk industri minyak dan gas dan kelautan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>