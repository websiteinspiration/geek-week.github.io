<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😗 👨🏿‍🤝‍👨🏽 🖇️ 我们如何将视频编码加速八倍 👨‍👨‍👧 🧓🏼 💆🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="每天，数百万观众在Internet上观看视频。但是，要使视频可用，不仅必须将其上传到服务器，还必须对其进行处理。这种情况发生得越快，服务及其用户就越好。
 
 我叫Askar Kamalov，一年前我加入了Yandex视频技术团队。今天，我将简单地告诉Habr的读者，我们如何使用编码过程的并行化来设...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>我们如何将视频编码加速八倍</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494154/"><img src="https://habrastorage.org/webt/mu/t5/ov/mut5ovwkds2o3dn2vnxmxvnelwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每天，数百万观众在Internet上观看视频。但是，要使视频可用，不仅必须将其上传到服务器，还必须对其进行处理。这种情况发生得越快，服务及其用户就越好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我叫Askar Kamalov，一年前我加入了Yandex视频技术团队。今天，我将简单地告诉Habr的读者，我们如何使用编码过程的并行化来设法多次加速向用户交付视频。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于那些以前从未考虑过视频服务幕后发生的事情的人来说，这篇文章将是主要的兴趣所在。在评论中，您可以提出问题并为以后的帖子提出建议。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于任务本身的几句话。</font><font style="vertical-align: inherit;">Yandex不仅可以帮助搜索其他站点上的视频，还可以存储自己的服务视频。</font><font style="vertical-align: inherit;">无论是作者的节目还是Ether中的体育比赛，KinoPoisk中的电影或Zen和News中的视频-所有这些都上传到我们的服务器中。</font><font style="vertical-align: inherit;">为了使用户观看视频，需要进行准备：将其转换为所需的格式，创建预览，甚至通过</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeepHD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技术进行驱动</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">未经准备的文件只会占用空间。</font><font style="vertical-align: inherit;">我们不仅在讨论铁的最佳使用方法，还在讨论向用户交付内容的速度。</font><font style="vertical-align: inherit;">示例：在事件本身发生后的一分钟内，就可以在搜索中搜索具有曲棍球比赛决定性时刻的记录。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺序编码</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，用户的满意度很大程度上取决于视频的可用速度。</font><font style="vertical-align: inherit;">而这主要取决于转码的速度。</font><font style="vertical-align: inherit;">如果对视频上传速度没有严格的要求，那么就没有问题。</font><font style="vertical-align: inherit;">取一个不可分割的文件，将其转换，然后上传。</font><font style="vertical-align: inherit;">在旅程的开始，我们是这样工作的：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lh/rv/ix/lhrvixp8ipl0f8yfbtxrm9uh174.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
客户端将视频上传到存储库，Analyzer组件收集元信息，并将视频传输以转换为Worker组件。</font><font style="vertical-align: inherit;">所有步骤均按顺序执行。</font><font style="vertical-align: inherit;">同时，可以有许多用于编码的服务器，但是只有一台服务器正在忙于处理特定的视频。</font><font style="vertical-align: inherit;">简单，透明的布局。</font><font style="vertical-align: inherit;">这就是它的优点所在。</font><font style="vertical-align: inherit;">这样的方案只能纵向扩展（由于购买了功能更强大的服务器）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有中间结果的顺序编码</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了减轻痛苦的期望，业界提出了一种快速编码选项。这是一个欺骗性的名称，因为实际上，完整的编码是顺序进行的，并且持续时间很长。但是有一个中间结果。这个想法是这样的：尽快准备并上传视频的低分辨率版本，只有更高版本的视频才可以上传。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方面，视频变得越来越快。这对于重要事件很有用。但另一方面-画面模糊，这使观众感到烦恼。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，您不仅需要快速处理视频，而且还需要保持其质量。</font><font style="vertical-align: inherit;">这就是用户现在对视频服务的期望。</font><font style="vertical-align: inherit;">似乎足以购买效率最高的服务器（并定期一次升级所有服务器）。</font><font style="vertical-align: inherit;">但这是一条死路一条，因为总有视频会减慢最强大的硬件的速度。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并行编码</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将困难的任务分解为许多不那么复杂的任务，并同时在不同的服务器上解决它们，效率更高。这就是用于视频的MapReduce。在这种情况下，我们不会依赖单个服务器的性能，而是可以水平扩展（通过添加新计算机）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
顺便说一句，将视频分割成小块，同时处理并将它们粘合在一起的想法并不是秘密。您可以找到许多有关此方法的参考（例如，在Habré上，我建议发布有关</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DistVIDc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目的文章</font><font style="vertical-align: inherit;">）。但这通常不会使它变得更容易，因为您不能只是采用现成的解决方案并将其构建到您自己中。我们需要适应我们的基础架构，视频甚至工作量。通常，编写自己的代码会更容易。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在新架构中，我们将按顺序编码的单块Worker块划分为微服务Segmenter，Tcoder和Combiner。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/xo/db/zqxodbzp7qwxo22evvnn1ftyk8o.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分割器会在大约10秒钟内将视频分割成多个片段。</font><font style="vertical-align: inherit;">片段由一个或多个GOP（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图片组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）组成。</font><font style="vertical-align: inherit;">每个GOP是独立的，并且分别进行编码，因此无需参考其他GOP的帧就可以对其进行解码。</font><font style="vertical-align: inherit;">即，片段可以彼此独立地再现。</font><font style="vertical-align: inherit;">这种分段减少了延迟，使您可以更早地开始处理。</font></font></li>
<li>Tcoder   .     ,    ,     (,     ,    ),             .   , Tcoder        .</li>
<li>ombiner   :   ,  Tcoder,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于声音的几句话。</font><font style="vertical-align: inherit;">最受欢迎的AAC音频编解码器具有讨厌的功能。</font><font style="vertical-align: inherit;">如果您分别对片段进行编码，那么将它们无缝地粘在一起根本是行不通的。</font><font style="vertical-align: inherit;">过渡将很明显。</font><font style="vertical-align: inherit;">视频编解码器没有这种问题。</font><font style="vertical-align: inherit;">从理论上讲，您可以寻找一个困难的技术解决方案，但是这款游戏绝对不值得（音频比视频重得多）。</font><font style="vertical-align: inherit;">因此，只有视频与我们并行编码，并且音频轨道作为一个整体进行处理。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多亏了并行视频处理，我们大大减少了下载视频到我们之间以及用户可用之间的延迟。例如，为一个持续一个半小时的FullHD电影创建多个质量不同的完整版本可能需要两个小时。现在，这需要15分钟。此外，在并行处理中，我们使用旧方法创建的高分辨率版本甚至比使用低分辨率版本的高分辨率版本要快，且结果中等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有其他。使用旧方法时，要么服务器可能丢失，要么服务器闲置而没有任务。并行编码可以增加铁利用率的份额。现在，我们拥有一千多台服务器的群集始终忙于处理某些事情。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，仍有改进的空间。</font><font style="vertical-align: inherit;">例如，如果我们甚至在视频完全到达之前就开始处理它的片段，就可以节省很多时间。</font><font style="vertical-align: inherit;">正如他们所说，还有更多。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在评论中写下您想要阅读的视频工作领域中的哪些任务。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与行业同行的有用链接</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SVE：Facebook规模的分布式视频处理</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过Archer简化Netflix的媒体创新。</font><font style="vertical-align: inherit;">Netflix技术博客</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN494132/index.html">Python中的Befunge编译器</a></li>
<li><a href="../zh-CN494136/index.html">滴什么东西以免痒</a></li>
<li><a href="../zh-CN494140/index.html">使用思科威胁响应调查DNSpionage活动，包括远程工作</a></li>
<li><a href="../zh-CN494150/index.html">阿维托的ClickHouse：与Alexey Milovidov的现场聚会</a></li>
<li><a href="../zh-CN494152/index.html">HoughNet：搜索与经典算法融合的消失点</a></li>
<li><a href="../zh-CN494156/index.html">如何在家工作-Plesk去除剂的经验</a></li>
<li><a href="../zh-CN494158/index.html">如何保持检疫工作质量</a></li>
<li><a href="../zh-CN494162/index.html">使用pgCenter对Postgres进行故障排除。阿列克谢·列索夫斯基</a></li>
<li><a href="../zh-CN494164/index.html">如何通过测试来提高敏捷团队​​的绩效</a></li>
<li><a href="../zh-CN494170/index.html">您可能不了解的3大Python功能</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>