<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚦 📆 🍲 Antipadrões do PostgreSQL: qual a profundidade da toca do coelho? passar pela hierarquia 👨‍👩‍👧‍👦 🧓🏻 🐠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em sistemas ERP complexos, muitas entidades têm uma natureza hierárquica , quando objetos homogêneos se alinham em uma árvore de relacionamento ancest...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipadrões do PostgreSQL: qual a profundidade da toca do coelho? passar pela hierarquia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/501614/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em sistemas ERP complexos, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muitas entidades têm uma natureza hierárquica</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , quando objetos homogêneos se alinham em uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">árvore de relacionamento ancestral-descendente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - essa é a estrutura organizacional da empresa (todas essas filiais, departamentos e grupos de trabalho) e o catálogo de produtos, áreas de trabalho e geografia pontos de venda, ... </font><font style="vertical-align: inherit;">
De fato, não existe uma única </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">esfera de automação comercial em</font></a><font style="vertical-align: inherit;"> que pelo menos alguma hierarquia não seja o resultado. Mas, mesmo que você não trabalhe "para negócios", ainda poderá encontrar facilmente relacionamentos hierárquicos. É banal, mesmo a árvore genealógica ou o esquema de andar das instalações do shopping center ter a mesma estrutura. </font><font style="vertical-align: inherit;">
Existem várias maneiras de armazenar essa árvore em um DBMS, mas hoje vamos nos concentrar em apenas uma opção:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/-o/tq/ad/-otqadbymksleulmgjdpxf6e2bo.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> hier(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">integer</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, pid<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> hier<font></font>
, <span class="hljs-keyword">data</span>
    <span class="hljs-keyword">json</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> hier(pid); <span class="hljs-comment">--  ,  FK    ,    PK</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E enquanto você examina as profundezas da hierarquia, ele espera pacientemente o quão [ingênuo] seus modos "ingênuos" de trabalhar com essa estrutura acabarão.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nx/na/_z/nxna_zsl1hv506-owlmrxybpute.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos analisar as tarefas emergentes típicas, sua implementação no SQL e tentar melhorar seu desempenho.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1 </font><font style="vertical-align: inherit;">Qual a profundidade da toca do coelho?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos considerar, por definição, que essa estrutura refletirá a subordinação de departamentos na estrutura da organização: departamentos, divisões, setores, filiais, grupos de trabalho ... como você os chama.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kl/yg/ck/klygckuyurttjnrskva_a6clwfy.png"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, geramos nossa 'árvore' de 10 mil elementos</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hier
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span> <span class="hljs-keyword">id</span>
  , <span class="hljs-string">'{1}'</span>::<span class="hljs-built_in">integer</span>[] pids
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span> + <span class="hljs-number">1</span>
  , pids[<span class="hljs-number">1</span>:(random() * array_length(pids, <span class="hljs-number">1</span>))::<span class="hljs-built_in">integer</span>] || (<span class="hljs-keyword">id</span> + <span class="hljs-number">1</span>)
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">10000</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  pids[array_length(pids, <span class="hljs-number">1</span>)] <span class="hljs-keyword">id</span>
, pids[array_length(pids, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>] pid
<span class="hljs-keyword">FROM</span>
  T;</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos começar com a tarefa mais simples - encontrar todos os funcionários que trabalham em um setor específico ou em termos de hierarquia - para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontrar todos os descendentes de um nó</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Também seria bom obter a "profundidade" do descendente ... Tudo isso pode ser necessário, por exemplo, para criar algum tipo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seleção complexa a partir da lista de identificações desses funcionários</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo ficaria bem se houver apenas alguns níveis desses descendentes e quantitativamente dentro de uma dúzia, mas se houver mais de cinco níveis e já houver dezenas de descendentes, poderá haver problemas. </font><font style="vertical-align: inherit;">Vamos ver como as opções tradicionais de pesquisa "abaixo da árvore" são escritas (e funcionam). </font><font style="vertical-align: inherit;">Mas primeiro, determinamos qual dos nós será o mais interessante para a nossa pesquisa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As </font><font style="vertical-align: inherit;">subárvores </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mais profundas"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span><font></font>
  , pid<font></font>
  , <span class="hljs-built_in">ARRAY</span>[<span class="hljs-keyword">id</span>] <span class="hljs-keyword">path</span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    pid <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    hier.id<font></font>
  , hier.pid<font></font>
  , T.path || hier.id<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    hier<font></font>
      <span class="hljs-keyword">ON</span> hier.pid = T.id<font></font>
)<font></font>
<span class="hljs-keyword">TABLE</span> T <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> array_length(<span class="hljs-keyword">path</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs"> id  | pid  | path<font></font>
---------------------------------------------<font></font>
7624 | 7623 | {7615,7620,7621,7622,7623,7624}<font></font>
4995 | 4994 | {4983,4985,4988,4993,4994,4995}<font></font>
4991 | 4990 | {4983,4985,4988,4989,4990,4991}<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As </font><font style="vertical-align: inherit;">subárvores </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mais largas"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs">...
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">path</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">id</span>
, <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs">id   | count<font></font>
------------<font></font>
5300 |   30<font></font>
 450 |   28<font></font>
1239 |   27<font></font>
1573 |   25<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para essas consultas, usamos um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN recursivo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> típico </font><font style="vertical-align: inherit;">: </font></font><br>
<img src="https://habrastorage.org/webt/lx/cx/3n/lxcx3n6k4cttix3mbrcoj8hyap8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
obviamente, com esse modelo de consulta, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">número de iterações coincidirá com o número total de descendentes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (e existem várias dezenas), e isso pode levar recursos bastante substanciais e, como resultado, tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos verificar a subárvore "mais larga":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    hier.id<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    hier<font></font>
      <span class="hljs-keyword">ON</span> hier.pid = T.id<font></font>
)<font></font>
<span class="hljs-keyword">TABLE</span> T;</code></pre><br>
<img src="https://habrastorage.org/webt/gx/xg/q6/gxxgq6p6c0eynpmffoohetg2iye.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Como esperado, encontramos todas as 30 entradas. </font><font style="vertical-align: inherit;">Mas eles gastaram 60% do tempo todo nisso - porque fizeram 30 pesquisas no índice. </font><font style="vertical-align: inherit;">E menos - você pode?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revisão em massa por índice</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E para cada nó, precisamos fazer uma solicitação de índice separada? Acontece que não - podemos ler o índice </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em várias teclas ao mesmo tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com </font><b><font style="vertical-align: inherit;">uma chamada</font></b></font><code>= ANY(array)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em cada grupo de identificadores, podemos pegar todos os IDs encontrados na etapa anterior por "nós". Ou seja, em cada próximo passo, procuraremos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imediatamente todos os descendentes de um determinado nível de uma só vez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, é uma má sorte, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em uma seleção recursiva, você não pode se referir a si mesmo em uma subconsulta</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas precisamos selecionar de alguma forma exatamente o que foi encontrado no nível anterior ... Acontece que você não pode fazer uma subconsulta para toda a amostra, mas para seu campo específico. lata. E esse campo também pode ser uma matriz - que é o que precisamos usar</font></font><code>ANY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece um pouco selvagem, mas no diagrama - tudo é simples.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/_t/qz/fm_tqzx1c9ri4-mbrgtxqvjizri.png"><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">ARRAY</span>[<span class="hljs-keyword">id</span>] <span class="hljs-keyword">id</span>$
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">id</span>
      <span class="hljs-keyword">FROM</span><font></font>
        hier<font></font>
      <span class="hljs-keyword">WHERE</span>
        pid = <span class="hljs-keyword">ANY</span>(T.id$)<font></font>
    ) <span class="hljs-keyword">id</span>$
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">coalesce</span>(<span class="hljs-keyword">id</span>$, <span class="hljs-string">'{}'</span>) &lt;&gt; <span class="hljs-string">'{}'</span> <span class="hljs-comment">--     -  </span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(<span class="hljs-keyword">id</span>$) <span class="hljs-keyword">id</span>
<span class="hljs-keyword">FROM</span>
  T;</code></pre><br>
<img src="https://habrastorage.org/webt/i0/a-/sk/i0a-sk-ytooivrkxwyxsq-ipnoi.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
E aqui o mais importante nem é </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganhar 1,5 vezes no tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas subtraímos menos buffers, pois temos apenas 5 chamadas para o índice em vez de 30! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um bônus adicional é o fato de que, após os identificadores finais de ninhos permanecerem ordenados por "níveis".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tag do nó</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A próxima consideração que ajudará a melhorar a produtividade é </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que "folhas" não podem ter filhos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, eles não precisam menosprezar nada. Na formulação de nossa tarefa, isso significa que, se seguimos a cadeia de departamentos e alcançamos o funcionário, não há necessidade de pesquisar mais nesse ramo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos introduzir um </font><b><font style="vertical-align: inherit;">campo </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adicional</font></font><code>boolean</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em nossa tabela </font><font style="vertical-align: inherit;">, que nos dirá imediatamente se essa entrada específica em nossa árvore é um "nó" </font><b><font style="vertical-align: inherit;">- ou seja</font></b><font style="vertical-align: inherit;"> , se pode ter algum filho.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> hier
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> branch <span class="hljs-built_in">boolean</span>;<font></font>
<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  hier T<font></font>
<span class="hljs-keyword">SET</span>
  branch = <span class="hljs-literal">TRUE</span>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">EXISTS</span>(
    <span class="hljs-keyword">SELECT</span>
      <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">FROM</span><font></font>
      hier<font></font>
    <span class="hljs-keyword">WHERE</span><font></font>
      pid = T.id<font></font>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
);<font></font>
<span class="hljs-comment">--   : 3033    42 .</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem! </font><font style="vertical-align: inherit;">Acontece que apenas pouco mais de 30% de todos os elementos da árvore têm descendentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora aplicaremos uma mecânica um pouco diferente - conectando-se à parte recursiva </font></font><code>LATERAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que nos permitirá acessar imediatamente os campos da "tabela" recursiva e usar a função agregada com a condição de filtragem baseada no nó para reduzir o conjunto de chaves:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/3x/vb/f13xvb2zblngijramviz8kpidks.png"><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    array_agg(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">id</span>$<font></font>
  , array_agg(<span class="hljs-keyword">id</span>) FILTER(<span class="hljs-keyword">WHERE</span> branch) ns$
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    X.*<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (
    <span class="hljs-keyword">SELECT</span>
      array_agg(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">id</span>$<font></font>
    , array_agg(<span class="hljs-keyword">id</span>) FILTER(<span class="hljs-keyword">WHERE</span> branch) ns$
    <span class="hljs-keyword">FROM</span><font></font>
      hier<font></font>
    <span class="hljs-keyword">WHERE</span>
      pid = <span class="hljs-keyword">ANY</span>(T.ns$)<font></font>
  ) X<font></font>
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">coalesce</span>(T.ns$, <span class="hljs-string">'{}'</span>) &lt;&gt; <span class="hljs-string">'{}'</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(<span class="hljs-keyword">id</span>$) <span class="hljs-keyword">id</span>
<span class="hljs-keyword">FROM</span>
  T;</code></pre><br>
<img src="https://habrastorage.org/webt/jc/6r/fa/jc6rfaqvbbvy6avqifoi1bf5chk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja em explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Conseguimos reduzir outro apelo ao índice e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vencemos mais de duas vezes em termos do valor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deduzido.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">De volta às raízes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse algoritmo será útil se você precisar coletar registros para todos os elementos "na árvore", mantendo informações sobre qual planilha de origem (e com quais indicadores) fez com que ela caísse na amostra - por exemplo, para gerar um relatório de resumo com agregação aos nós.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ah/xs/xb/ahxsxbntkmfs884ggqqqvoeyqbc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O adicional deve ser tomado exclusivamente como prova de conceito, uma vez que a solicitação é muito complicada. </font><font style="vertical-align: inherit;">Mas se ele dominar seu banco de dados - vale a pena considerar o uso de tais técnicas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos começar com algumas declarações simples:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">É </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">melhor ler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o mesmo registro do banco de dados </font><b><font style="vertical-align: inherit;">apenas uma vez</font></b><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As entradas do banco de dados são </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lidas com mais eficiência em um "pacote" do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que individualmente.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos tentar projetar a consulta que precisamos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passo 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, na inicialização da recursão (onde sem ela!) Teremos que subtrair os registros das próprias folhas do conjunto de identificadores de origem:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    rec <span class="hljs-comment">--    </span>
  , <span class="hljs-keyword">id</span>::<span class="hljs-built_in">text</span> chld <span class="hljs-comment">--  ""    </span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier rec<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se pareceu estranho para alguém que o "conjunto" seja armazenado em uma string, não em uma matriz, então há uma explicação simples. </font><font style="vertical-align: inherit;">Para seqüências de caracteres, existe uma função agregada de "colagem" incorporada </font></font><code>string_agg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas para matrizes, não. </font><font style="vertical-align: inherit;">Embora não seja </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">difícil implementá-lo você mesmo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passo 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora obteríamos um conjunto de IDs de seção que precisarão ser subtraídos ainda mais. </font><font style="vertical-align: inherit;">Quase sempre, eles serão duplicados em diferentes registros do conjunto de fontes - para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agrupá-los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mantendo as informações sobre as folhas de origem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas aqui três problemas nos esperam:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A parte "sub-recursiva" de uma consulta não pode conter funções agregadas c </font></font><code>GROUP BY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma chamada para uma "tabela" recursiva não pode estar em uma subconsulta aninhada.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma consulta na parte recursiva não pode conter um CTE.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, todos esses problemas são facilmente contornados. </font><font style="vertical-align: inherit;">Vamos começar do fim.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTE na parte recursiva</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não é assim </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">WITH</span> T (...)
  <span class="hljs-keyword">SELECT</span> ...<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim funciona, os colchetes decidem!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
  (<font></font>
    <span class="hljs-keyword">WITH</span> T (...)
    <span class="hljs-keyword">SELECT</span> ...<font></font>
  )<font></font>
)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulta aninhada para "tabela" recursiva</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm ... Uma chamada para um CTE recursivo não pode estar em uma subconsulta. </font><font style="vertical-align: inherit;">Mas pode estar dentro do CTE! </font><font style="vertical-align: inherit;">Uma sub-solicitação já pode se referir a este CTE!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GRUPO POR recursão interna</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É desagradável, mas ... Também temos uma maneira simples de simular o GROUP BY usando as </font></font><code>DISTINCT ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funções da janela!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  (rec).pid <span class="hljs-keyword">id</span>
, string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) chld
<span class="hljs-keyword">FROM</span><font></font>
  tree<font></font>
<span class="hljs-keyword">WHERE</span>
  (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-comment">--  !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim funciona!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>((rec).pid)<font></font>
  (rec).pid <span class="hljs-keyword">id</span>
, string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> (rec).pid) chld
<span class="hljs-keyword">FROM</span><font></font>
  tree<font></font>
<span class="hljs-keyword">WHERE</span>
  (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vemos por que o ID numérico se transformou em texto - para que possam ser colados com uma vírgula!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etapa 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o final, não temos mais nada:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lemos registros de "seções" em um conjunto de IDs agrupados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">combine as seções subtraídas com os "conjuntos" das folhas de origem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Expandir” a string definida usando </font></font><code>unnest(string_to_array(chld, ',')::integer[])</code></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    rec<font></font>
  , <span class="hljs-keyword">id</span>::<span class="hljs-built_in">text</span> chld
  <span class="hljs-keyword">FROM</span><font></font>
    hier rec<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
  (<font></font>
    <span class="hljs-keyword">WITH</span> prnt <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>((rec).pid)<font></font>
        (rec).pid <span class="hljs-keyword">id</span>
      , string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> (rec).pid) chld
      <span class="hljs-keyword">FROM</span><font></font>
        tree<font></font>
      <span class="hljs-keyword">WHERE</span>
        (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><font></font>
    )<font></font>
    , nodes <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span><font></font>
        rec<font></font>
      <span class="hljs-keyword">FROM</span><font></font>
        hier rec<font></font>
      <span class="hljs-keyword">WHERE</span>
        <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
          <span class="hljs-keyword">SELECT</span>
            <span class="hljs-keyword">id</span>
          <span class="hljs-keyword">FROM</span><font></font>
            prnt<font></font>
        ))<font></font>
    )<font></font>
    <span class="hljs-keyword">SELECT</span><font></font>
      nodes.rec<font></font>
    , prnt.chld<font></font>
    <span class="hljs-keyword">FROM</span><font></font>
      prnt<font></font>
    <span class="hljs-keyword">JOIN</span><font></font>
      nodes<font></font>
        <span class="hljs-keyword">ON</span> (nodes.rec).id = prnt.id<font></font>
  )<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(string_to_array(chld, <span class="hljs-string">','</span>)::<span class="hljs-built_in">integer</span>[]) leaf<font></font>
, (rec).*<font></font>
<span class="hljs-keyword">FROM</span>
  tree;</code></pre><br>
<img src="https://habrastorage.org/webt/hl/e5/jn/hle5jn8eolot086fr-ecmutxlye.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[  explain.tensor.ru]</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt501598/index.html">Um guia modesto para esquemas de banco de dados</a></li>
<li><a href="../pt501600/index.html">Consola de jogos stm32</a></li>
<li><a href="../pt501604/index.html">Tradução do livro de Andrew Un, Passion for Machine Learning. Capítulos 51 e 52</a></li>
<li><a href="../pt501610/index.html">Barra de rolagem personalizada em Angular</a></li>
<li><a href="../pt501612/index.html">Qual placa gráfica escolher para o seu computador em 2020</a></li>
<li><a href="../pt501616/index.html">Retrato do cliente: compor e contar</a></li>
<li><a href="../pt501622/index.html">Caso: como criar um plano de conteúdo para um blog B2B com base na semântica de informações</a></li>
<li><a href="../pt501624/index.html">Modelos reais de localização linguística no campo da TI e das comunicações digitais. Parte 2</a></li>
<li><a href="../pt501628/index.html">Entrevista com Alexander Filippov, World Game Designer de Tanques Blitz</a></li>
<li><a href="../pt501630/index.html">Cinco riscos de segurança ao trabalhar remotamente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>