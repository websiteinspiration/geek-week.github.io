<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§π üôÅ üàπ Mempelajari Pelacakan Peristiwa untuk Windows: Teori dan Praktik üíÖ üõÄ ‚ö°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat sore. Baru-baru ini, saya perlu berurusan dengan layanan jejak Windows. Layanan ini muncul di Windows 2000, namun, ada sangat sedikit artikel ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mempelajari Pelacakan Peristiwa untuk Windows: Teori dan Praktik</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502362/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selamat sore. </font><font style="vertical-align: inherit;">Baru-baru ini, saya perlu berurusan dengan layanan jejak Windows. </font><font style="vertical-align: inherit;">Layanan ini muncul di Windows 2000, namun, ada sangat sedikit artikel tentang layanan ini di Internet, sehingga muncul ide untuk menulis artikel ini. </font><font style="vertical-align: inherit;">Jadi, mari kita mulai! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hari ini saya akan mencoba berbicara tentang:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Teori Layanan Tracing Windows</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Membuat Sesi ETW Anda</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menggunakan API penelusuran peristiwa untuk bekerja dengan ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menggunakan tracerpt dan xperf untuk bekerja dengan ETW</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teori Layanan Tracing Windows</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelacakan Peristiwa untuk Windows (ETW) adalah layanan yang memungkinkan Anda untuk menerima acara dari satu atau lebih penyedia acara secara langsung atau dari file * .etl untuk periode waktu tertentu. </font><font style="vertical-align: inherit;">Tidak jelas? </font><font style="vertical-align: inherit;">Sekarang mari kita cari tahu! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memahami cara kerja ETW, Anda perlu memahami struktur layanan ini. </font></font><br>
<br>
<img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arsitektur ETW mencakup 4 elemen</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penyedia acara</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konsumen acara</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengontrol ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesi ETW (sesi pelacakan acara)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prinsip operasi adalah sebagai berikut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sejumlah penyedia acara terdaftar dalam sistem, mis. </font><font style="vertical-align: inherit;">aplikasi yang dapat berbagi pengalaman mereka dengan sesi ETW. </font><font style="vertical-align: inherit;">Juga dalam sistem ini ada sejumlah sesi ETW aktif yang dapat mengkonsumsi acara dari satu atau lebih penyedia dan memberikannya kepada pengguna baik secara real time atau menulis semua peristiwa dari pemasok ke file log (* .etl). </font><font style="vertical-align: inherit;">Dan pengendali mengendalikan seluruh gerakan ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang kita akan mempertimbangkan setiap elemen arsitektur yang dibahas di atas secara lebih rinci untuk akhirnya memahami prinsip kerja!</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penyedia Acara</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penyedia acara adalah aplikasi yang berisi alat pelacak peristiwa. Setelah penyedia terdaftar, pengontrol dapat mengaktifkan atau menonaktifkan pelacakan peristiwa di penyedia. Penyedia menentukan interpretasinya on atau off. Biasanya, penyedia yang diaktifkan menghasilkan peristiwa, tetapi penyedia yang dinonaktifkan tidak. Ini memungkinkan Anda untuk menambahkan pelacakan acara ke aplikasi kami tanpa harus membuat acara setiap saat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satu vendor dapat membagikan acara mereka dengan beberapa sesi ETW sekaligus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap acara terdiri dari dua elemen: header dan data! </font><font style="vertical-align: inherit;">Header acara mencakup informasi tentang acara: pengidentifikasi penyedia, pengidentifikasi acara, stempel waktu, dll. </font><font style="vertical-align: inherit;">Sisa data ditentukan oleh penyedia tertentu: ETW menerima data apa pun dan menulisnya ke buffer, dan interpretasinya diberikan kepada konsumen informasi. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada empat jenis utama penyedia: penyedia </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MOF (klasik) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
penyedia WPP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
berdasarkan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TraceLogging penyedia nyata. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penyedia acara berbeda dalam jenis bidang yang mereka simpan dalam muatan acara. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penyedia acara tampaknya beres. </font><font style="vertical-align: inherit;">Berpindah!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengontrol </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengontrol adalah aplikasi yang bertanggung jawab untuk pengoperasian satu atau lebih sesi ETW. </font><font style="vertical-align: inherit;">Ini adalah pengontrol yang menentukan ukuran dan lokasi file log, memulai dan menghentikan sesi pelacakan peristiwa (sesi ETW), dan memungkinkan penyedia untuk merekam acara dalam sesi. </font><font style="vertical-align: inherit;">Seperti yang disebutkan sebelumnya, itu adalah pengontrol yang memungkinkan penyedia untuk berbagi acara mereka!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsumen </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konsumen adalah aplikasi yang menerima dan memproses acara dari satu sesi jejak atau lebih pada saat yang sama. </font><font style="vertical-align: inherit;">Konsumen dapat menerima acara yang disimpan dalam file log atau dari sesi yang menyampaikan acara secara real time. </font><font style="vertical-align: inherit;">Seperti yang sudah kita ketahui, satu sesi ETW dapat memiliki beberapa pemasok. </font><font style="vertical-align: inherit;">Muncul pertanyaan: apakah akan ada kebingungan? </font><font style="vertical-align: inherit;">Bagaimana acara dari berbagai sesi ETW saling berhubungan? </font><font style="vertical-align: inherit;">Peristiwa diurutkan berdasarkan waktu terjadinya, yaitu </font><font style="vertical-align: inherit;">sistem menghadirkan peristiwa dalam urutan kronologis!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesi ETW</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sesi pelacakan peristiwa (sesi ETW) merekam acara dari satu atau lebih penyedia yang diizinkan oleh pengontrol. </font><font style="vertical-align: inherit;">Sesi ini juga bertanggung jawab untuk mengelola dan membersihkan buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelacakan Peristiwa mendukung hingga 64 pelacakan sesi sesi berjalan secara bersamaan. </font><font style="vertical-align: inherit;">Dari sesi-sesi ini, ada dua sesi dengan tujuan khusus. </font><font style="vertical-align: inherit;">Sesi yang tersisa tersedia untuk penggunaan umum. </font><font style="vertical-align: inherit;">Dua sesi tujuan khusus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesi logger global</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesi Logger Kernel NT</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sesi pelacakan peristiwa Global Logger mencatat peristiwa yang terjadi pada awal proses boot sistem operasi, seperti yang dihasilkan oleh driver perangkat. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sesi Pelacakan Kejadian NT Sesi Kernel Logger mencatat peristiwa sistem yang telah ditetapkan yang dihasilkan oleh sistem operasi, seperti peristiwa I / O disk atau kegagalan halaman. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, sekarang mari kita berlatih !!!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat Sesi ETW Anda</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum mulai bekerja, kita perlu pengetahuan tentang beberapa utilitas, yaitu: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
daftar penyedia yang tersedia pada OS tertentu</font></font><br>
<br>
<pre><code class="bash hljs">logman query providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dapatkan informasi lengkap tentang penyedia</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp &lt; &gt; /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
daftar semua sesi ETW aktif</font></font><br>
<br>
<pre><code class="bash hljs">xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga, untuk melihat file, disarankan untuk memiliki Notepad ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah melihat daftar penyedia di komputer Anda (dan ada lebih dari 1000 di Windows 10), kami akan memilih salah satunya untuk sesi kami: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/6e/wm/hl6ewmoxww9guutq7rt9m_rnfug.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memilih Microsoft-Windows-WinINet (layanan ini mencatat semua tindakan kami saat bekerja di browser Microsoft Edge). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Win + R -&gt; compmgmt.msc </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. "Kinerja" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. "Set Kolektor Data" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. "Sesi Jejak Acara" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. "Baru" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. "Set Pengumpul Data" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Tetapkan nama pengumpul data </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. "Buat secara manual (Lanjutan)" ("Buat secara manual (untuk yang berpengalaman)") </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/ec/_w/gkec_w2zlyy-m_jo25bm2bfgx38.png" alt="gambar"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9. Tambahkan yang menarik kami penyedia per sesi</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10. Tentukan kata kunci yang menarik bagi kami di bidang ‚ÄúKata Kunci (Apa Saja)‚Äù - 0xFFFFFFFFFFFFFFFFFFFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11. Tentukan tingkat pencatatan 0xFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= </font></font><img src="https://habrastorage.org/webt/d7/yw/3w/d7yw3w3ondmdrmeb_avfvnafa7y.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12. Pilih jalur tempat file log sesi akan disimpan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13. Pilih " Mulai kumpulan pengumpul data ini sekarang ‚Äù(‚Äú Jalankan grup pengumpul data sekarang ‚Äù) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang sesi yang kami buat berhasil. Microsoft Edge memerlukan beberapa pekerjaan untuk mendapatkan sesi untuk mengumpulkan informasi tentang kami! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah beberapa waktu berlalu, kami pergi ke tempat kami menyimpan file log. Kami menjalankan perintah berikut di sana.</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">"   .etl"</span> -o -report -summary -lr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menjalankan perintah ini, 4 file akan dibuat. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/e_/rp/upe_rph8_bnkvfuemiai0lquv0w.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami saat ini tertarik pada dumpfile.xml. </font><font style="vertical-align: inherit;">Anda dapat membuka file ini melalui notepad ++, Anda juga dapat melakukannya di Excel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mempelajari file ini dengan cermat, Anda dapat melihat bahwa sesi ini mengumpulkan hampir semua informasi tentang pergerakan kami di Internet !!! </font><font style="vertical-align: inherit;">Anda dapat membaca lebih lanjut tentang ini di sini. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mempelajari ETW dan mendapatkan keuntungan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baiklah, dan kita melanjutkan. </font><font style="vertical-align: inherit;">Kami baru saja membuat sesi dengan penyedia acara tunggal. </font><font style="vertical-align: inherit;">Menerima data sesi dari file log. </font><font style="vertical-align: inherit;">Sudah waktunya untuk kode!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan API penelusuran peristiwa untuk bekerja dengan ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di habr ada artikel yang menarik, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API Terburuk yang pernah dibuat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam artikel ini Anda akan menemukan jawaban untuk banyak pertanyaan yang kemungkinan besar akan Anda miliki ketika menulis aplikasi! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan kode dalam C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mulai dengan yang paling sederhana.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan dan mulai sesi pelacakan acara</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, pertimbangkan gagasan umum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memulai sesi penelusuran: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Tetapkan struktur EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Mulai sesi dengan menggunakan StartTrace </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, aktifkan penyedia acara </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Nyalakan penyedia menggunakan EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghentikan sesi pelacakan, Anda harus: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Sebelum menghentikan sesi pelacakan, Anda harus menonaktifkan penyedia menggunakan EnableTrace | EnableTraceEx | EnableTraceEx2, melewati EVENT_CONTROL_CODE_DISABLE_PROVIDER </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Panggil fungsi ControlTrace dan berikan EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam contoh di bawah ini, saya membuat sesi yang disebut MyEventTraceSession. </font><font style="vertical-align: inherit;">File log dalam direktori saat ini disebut WriteThePuth.etl. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penyedia acara adalah Microsoft-Windows-Kernel-Process. </font><font style="vertical-align: inherit;">Anda dapat mengetahui GUID-nya menggunakan</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp Microsoft-Windows-Kernel-Process /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode langsung:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#include &lt;windows.h&gt;</span>
<span class="hljs-meta">#include &lt;stdio.h&gt;</span>
<span class="hljs-meta">#include &lt;conio.h&gt;</span>
<span class="hljs-meta">#include &lt;strsafe.h&gt;</span>
<span class="hljs-meta">#include &lt;wmistr.h&gt;</span>
<span class="hljs-meta">#include &lt;evntrace.h&gt;</span>
<span class="hljs-meta">#include &lt;iostream&gt;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGFILE_PATH L"WriteThePuth.etl"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGSESSION_NAME L"MyEventTraceSession"</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,     .</span>
<span class="hljs-comment">//      GUID .</span><font></font>
<font></font>
<span class="hljs-comment">// {AE44CB98-BD11-4069-8093-770EC9258A12}</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID SessionGuid =<font></font>
{ <span class="hljs-number">0xae44cb98</span>, <span class="hljs-number">0xbd11</span>, <span class="hljs-number">0x4069</span>, { <span class="hljs-number">0x80</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xe</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x12</span> } };<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,   ,   </span>
<span class="hljs-comment">//    .</span><font></font>
<font></font>
<span class="hljs-comment">//{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} Microsoft-Windows-Kernel-Process</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID ProviderGuid =<font></font>
{ <span class="hljs-number">0xd22FB2CD6</span>, <span class="hljs-number">0x0E7B</span>, <span class="hljs-number">0x422B</span>, {<span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x16</span> } };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wmain</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span><font></font>
{<font></font>
    setlocale(LC_ALL, <span class="hljs-string">"ru"</span>);<font></font>
    ULONG status = ERROR_SUCCESS;<font></font>
    TRACEHANDLE SessionHandle = <span class="hljs-number">0</span>;<font></font>
    EVENT_TRACE_PROPERTIES* pSessionProperties = NULL;<font></font>
    ULONG BufferSize = <span class="hljs-number">0</span>;<font></font>
    BOOL TraceOn = TRUE;<font></font>
<font></font>
    <font></font>
    BufferSize = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    pSessionProperties = (EVENT_TRACE_PROPERTIES*)malloc(BufferSize);<font></font>
    <span class="hljs-keyword">if</span> (NULL == pSessionProperties)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"Unable to allocate %d bytes for properties structure.\n"</span>, BufferSize);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    ZeroMemory(pSessionProperties, BufferSize);<font></font>
    pSessionProperties-&gt;Wnode.BufferSize = BufferSize;<font></font>
    pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;<font></font>
    pSessionProperties-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>; <span class="hljs-comment">//QPC clock resolution</span><font></font>
    pSessionProperties-&gt;Wnode.Guid = SessionGuid;<font></font>
    pSessionProperties-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;<font></font>
    pSessionProperties-&gt;MaximumFileSize = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1024 MB</span>
    pSessionProperties-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);<font></font>
    pSessionProperties-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    StringCbCopy((LPWSTR)((<span class="hljs-keyword">char</span>*)pSessionProperties + pSessionProperties-&gt;LogFileNameOffset), <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH), LOGFILE_PATH);<font></font>
    <font></font>
<font></font>
    status = StartTrace((PTRACEHANDLE)&amp;SessionHandle, LOGSESSION_NAME, pSessionProperties);<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"StartTrace() failed with %lu\n"</span>, status);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ,   ,      .</span><font></font>
<font></font>
    status = EnableTraceEx2(<font></font>
        SessionHandle,<font></font>
        (LPCGUID)&amp;ProviderGuid,<font></font>
        EVENT_CONTROL_CODE_ENABLE_PROVIDER,<font></font>
        TRACE_LEVEL_INFORMATION,<font></font>
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,<font></font>
        NULL<font></font>
        );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"EnableTrace() failed with %lu\n"</span>, status);<font></font>
        TraceOn = FALSE;<font></font>
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   .    ,   </span>
    wprintf(L<span class="hljs-string">"Run the provider application. Then hit any key to stop the session.\n"</span>);<font></font>
    _getch();<font></font>
   <font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-keyword">if</span> (SessionHandle)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (TraceOn)<font></font>
        {<font></font>
            status = EnableTraceEx2(<font></font>
                SessionHandle,<font></font>
                (LPCGUID)&amp;ProviderGuid,<font></font>
                EVENT_CONTROL_CODE_DISABLE_PROVIDER,<font></font>
                TRACE_LEVEL_INFORMATION,<font></font>
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,<font></font>
                NULL<font></font>
                );<font></font>
        }<font></font>
<font></font>
        status = ControlTrace(SessionHandle, LOGSESSION_NAME, pSessionProperties, EVENT_TRACE_CONTROL_STOP);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
        {<font></font>
            wprintf(L<span class="hljs-string">"ControlTrace(stop) failed with %lu\n"</span>, status);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pSessionProperties)<font></font>
    {<font></font>
        free(pSessionProperties);<font></font>
        pSessionProperties = NULL;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menganalisis program di atas secara lebih rinci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Setel struktur EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengonfigurasi sesi penelusuran peristiwa, Anda harus menggunakan struktur EVENT_TRACE_PROPERTIES untuk menentukan properti sesi. Memori yang Anda alokasikan untuk struktur EVENT_TRACE_PROPERTIES harus cukup besar untuk juga memuat nama-nama sesi dan log file yang mengikuti struktur dalam memori. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Mulai sesi menggunakan StartTrace </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah Anda menentukan properti sesi, panggil fungsi StartTrace untuk memulai sesi. Jika fungsi berhasil, parameter SessionHandle akan berisi deskriptor sesi, dan properti LoggerNameOffset akan berisi offset nama sesi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Nyalakan penyedia menggunakan EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengaktifkan penyedia yang ingin Anda izinkan merekam peristiwa di sesi Anda, panggil fungsi EnableTrace untuk mengaktifkan penyedia klasik dan fungsi EnableTraceEx untuk mengaktifkan penyedia berbasis manifes. Dalam kasus lain - EnableTraceEx2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Sebelum menghentikan sesi penelusuran, Anda harus menonaktifkan penyedia menggunakan EnableTrace | EnableTraceEx | AktifkanTraceEx2 dengan mengirimkan EVENT_CONTROL_CODE_DISABLE_PROVIDER</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghentikan sesi penelusuran setelah mengumpulkan acara, panggil fungsi ControlTrace dan berikan EVENT_TRACE_CONTROL_STOP sebagai kode kontrol. Untuk menentukan sesi yang akan dihentikan, Anda bisa meneruskan deskriptor sesi jejak acara yang diperoleh dari panggilan sebelumnya ke fungsi StartTrace, atau nama sesi yang dimulai sebelumnya. Pastikan untuk memutuskan koneksi semua penyedia sebelum menghentikan sesi. Jika Anda menghentikan sesi sebelum mematikan penyedia untuk pertama kalinya, ETW akan memutuskan sambungan penyedia dan mencoba memanggil fungsi kontrol panggilan balik penyedia. Jika aplikasi yang memulai sesi berakhir tanpa memutuskan penyedia atau memanggil fungsi ControlTrace, penyedia tetap dihidupkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Untuk menghentikan sesi penelusuran, panggil fungsi ControlTrace dan berikan EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang kita lihat dalam contoh di atas, menggunakan API Pelacakan Peristiwa bukan yang termudah. </font><font style="vertical-align: inherit;">Bergantung pada apa yang Anda lakukan, Anda dapat terus menulis penyedia acara atau menulis acara konsumen. </font><font style="vertical-align: inherit;">Namun, kedua tugas ini cukup banyak dan tidak akan dipertimbangkan dalam artikel ini! </font><font style="vertical-align: inherit;">Kompleksitas tambahan dibuat oleh 4 jenis penyedia acara, dan, karenanya, 4 opsi untuk menulis acara dan 4 opsi untuk konsumsi mereka. </font><font style="vertical-align: inherit;">Bekerja dengan API Pelacakan Peristiwa dijelaskan dengan sangat rinci dan baik di Situs Web Microsoft resmi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan Pelacakan Peristiwa</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Setelah bekerja selama beberapa waktu dengan API Pelacakan Peristiwa, saya punya pertanyaan: apakah ada utilitas yang akan menyederhanakan hidup saya?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan tracerpt dan xperf untuk bekerja dengan ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam bab ini, saya tidak akan mempertimbangkan utilitas ini dari sudut pandang teoritis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menggunakan perintah Tracerpt untuk menganalisis log pelacakan peristiwa, file log yang dihasilkan oleh monitor kinerja, dan penyedia pelacakan peristiwa real-time. </font><font style="vertical-align: inherit;">Ini membuat file dump, file laporan, dan skema laporan. </font><font style="vertical-align: inherit;">Utilitas ini memiliki sejumlah besar parameter, tetapi "minimum" berikut ini cocok untuk memulai pekerjaan</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">" 1- .etl"</span> ... <span class="hljs-string">" n- .etl"</span> -o &lt;   &gt; -report &lt;    &gt; -summary&lt;    &gt; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilitas xperf.exe adalah pengontrol lengkap. </font><font style="vertical-align: inherit;">Ini mendukung argumen baris perintah untuk mengelola penyedia dan sesi ETW. </font><font style="vertical-align: inherit;">Pengontrol dapat meminta status sesi aktif saat ini dan menerima daftar semua penyedia yang terdaftar dalam sistem. </font><font style="vertical-align: inherit;">Misalnya, untuk mendapatkan semua sesi aktif, gunakan perintah berikut:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan untuk mendapatkan daftar semua penyedia yang terdaftar dalam sistem, gunakan perintah:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengendali memiliki beberapa fitur utama. </font><font style="vertical-align: inherit;">Mereka dapat memperbarui sesi dan menyiram buffer ke disk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu saja untuk saat ini! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya, dalam artikel ini saya tidak membahas sejumlah masalah menarik (misalnya, konsumsi acara secara real time atau bekerja dengan sesi tujuan khusus). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat membacanya di situs berikut: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelacakan Peristiwa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - dokumentasi Microsoft resmi. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mempelajari ETW dan mengekstrak manfaat </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelacakan Peristiwa untuk Windows di sisi jahat. </font><font style="vertical-align: inherit;">Tapi ini bukan </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API terburuk yang pernah dibuat</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id502350/index.html">Membalikkan rekayasa penguat suara dari konsol portabel yang populer - mendiskusikan temuan utama</a></li>
<li><a href="../id502352/index.html">Intisari materi menarik untuk pengembang seluler # 344 (12 - 17 Mei)</a></li>
<li><a href="../id502354/index.html">Penyedia IaaS berjuang untuk pasar Eropa - mendiskusikan situasi dan peristiwa industri</a></li>
<li><a href="../id502358/index.html">Implementasi MVP berdasarkan ApplicationController dan IoC dalam aplikasi WinForms</a></li>
<li><a href="../id502360/index.html">Pelepasan Grizzly atau Super Bor</a></li>
<li><a href="../id502366/index.html">Bandingkan karya open source Python - libraries untuk pengakuan entitas bernama</a></li>
<li><a href="../id502368/index.html">Kami memompa treadmill</a></li>
<li><a href="../id502370/index.html">Menempatkan game "Snake" di papan tempat memotong roti. Bagian 1: mesin negara</a></li>
<li><a href="../id502372/index.html">Masalah dan prinsip penyesuaian versi kotak Bitrix24</a></li>
<li><a href="../id502374/index.html">Protokol Komunikasi FT8 - Bagaimana Cara Kerjanya</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>