<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌐 ™️ 👩‍⚖️ それほど大きなデータではない ✌🏻 🕵️ 🏣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、PostgreSQLのバージョン12の組み込みまたは宣言型パーティション分割によって提供される機能について説明します。デモンストレーションは、HighLoad ++ Siberia 2019会議で同じ名前のレポート用に準備されました（更新：レポートのビデオが表示されました）。
 
 す...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>それほど大きなデータではない</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/456716/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、PostgreSQLのバージョン12の組み込みまたは宣言型パーティション分割によって提供される機能について説明します。</font><font style="vertical-align: inherit;">デモンストレーションは</font><font style="vertical-align: inherit;">、HighLoad ++ Siberia 2019会議で</font><font style="vertical-align: inherit;">同じ名前の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用に準備されました</font><font style="vertical-align: inherit;">（更新：</font><font style="vertical-align: inherit;">レポートの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビデオが表示さ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れました）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての例は、最近登場したベータ版で実行されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> version();
</code></pre><pre><code class="plaintext hljs">                                                     version                                                      <font></font>
------------------------------------------------------------------------------------------------------------------<font></font>
 PostgreSQL 12beta1 on i686-pc-linux-gnu, compiled by gcc (Ubuntu 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609, 32-bit<font></font>
(1 row)</code></pre><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例では、デモデータベースの予約およびチケットテーブルを使用します。</font><font style="vertical-align: inherit;">予約テーブルには、2017年6月から8月までの3か月間のエントリが含まれており、次の構造になっています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; \d bookings</code></pre><pre><code class="plaintext hljs"><font></font>
                        Table "bookings.bookings"<font></font>
    Column    |           Type           | Collation | Nullable | Default <font></font>
--------------+--------------------------+-----------+----------+---------<font></font>
 book_ref     | character(6)             |           | not null | <font></font>
 book_date    | timestamp with time zone |           | not null | <font></font>
 total_amount | numeric(10,2)            |           | not null | <font></font>
Indexes:<font></font>
    "bookings_pkey" PRIMARY KEY, btree (book_ref)<font></font>
Referenced by:<font></font>
    TABLE "tickets" CONSTRAINT "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予約には複数のチケットが含まれる場合があります。</font><font style="vertical-align: inherit;">チケットのあるテーブルの構造：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; \d tickets</code></pre><pre><code class="plaintext hljs">                        Table "bookings.tickets"<font></font>
     Column     |         Type          | Collation | Nullable | Default <font></font>
----------------+-----------------------+-----------+----------+---------<font></font>
 ticket_no      | character(13)         |           | not null | <font></font>
 book_ref       | character(6)          |           | not null | <font></font>
 passenger_id   | character varying(20) |           | not null | <font></font>
 passenger_name | text                  |           | not null | <font></font>
 contact_data   | jsonb                 |           |          | <font></font>
Indexes:<font></font>
    "tickets_pkey" PRIMARY KEY, btree (ticket_no)<font></font>
Foreign-key constraints:<font></font>
    "tickets_book_ref_fkey" FOREIGN KEY (book_ref) REFERENCES bookings(book_ref)<font></font>
Referenced by:<font></font>
    TABLE "ticket_flights" CONSTRAINT "ticket_flights_ticket_no_fkey" FOREIGN KEY (ticket_no) REFERENCES tickets(ticket_no)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この情報は、テーブルをパーティション化しようとする例を理解するのに十分なはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→デモベースの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください。</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">範囲分割</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、予約テーブルを日付範囲でパーティション化してみます。</font><font style="vertical-align: inherit;">この場合、テーブルは次のように作成されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range (<font></font>
       book_ref     <span class="hljs-type">character</span>(<span class="hljs-number">6</span>),<font></font>
       book_date    <span class="hljs-type">timestamptz</span>,<font></font>
       total_amount <span class="hljs-type">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)<font></font>
   ) <span class="hljs-keyword">PARTITION BY RANGE</span>(book_date);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各月の個別のセクション：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range_201706 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_range 
       <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2017-06-01'</span>::<span class="hljs-type">timestamptz</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2017-07-01'</span>::<span class="hljs-type">timestamptz</span>);<font></font>
=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range_201707 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_range 
       <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2017-07-01'</span>::<span class="hljs-type">timestamptz</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2017-08-01'</span>::<span class="hljs-type">timestamptz</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの境界を示すには、定数だけでなく、関数呼び出しなどの式も使用できます。</font><font style="vertical-align: inherit;">式の値は、セクションが作成され、システムディレクトリに格納されるときに計算されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range_201708 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_range 
       <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (to_timestamp(<span class="hljs-string">'01.08.2017'</span>,<span class="hljs-string">'DD.MM.YYYY'</span>)) 
                    <span class="hljs-keyword">TO</span> (to_timestamp(<span class="hljs-string">'01.09.2017'</span>,<span class="hljs-string">'DD.MM.YYYY'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルの説明：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; \d+ bookings_range</code></pre><pre><code class="plaintext hljs"><font></font>
                                   Partitioned table "bookings.bookings_range"<font></font>
    Column    |           Type           | Collation | Nullable | Default | Storage  | Stats target | Description <font></font>
--------------+--------------------------+-----------+----------+---------+----------+--------------+-------------<font></font>
 book_ref     | character(6)             |           |          |         | extended |              | <font></font>
 book_date    | timestamp with time zone |           |          |         | plain    |              | <font></font>
 total_amount | numeric(10,2)            |           |          |         | main     |              | <font></font>
Partition key: RANGE (book_date)<font></font>
Partitions: bookings_range_201706 FOR VALUES FROM ('2017-06-01 00:00:00+03') TO ('2017-07-01 00:00:00+03'),<font></font>
            bookings_range_201707 FOR VALUES FROM ('2017-07-01 00:00:00+03') TO ('2017-08-01 00:00:00+03'),<font></font>
            bookings_range_201708 FOR VALUES FROM ('2017-08-01 00:00:00+03') TO ('2017-09-01 00:00:00+03')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もういい。</font><font style="vertical-align: inherit;">レコードを挿入するためのトリガーはなく、CHECK制約は必要ありません。</font><font style="vertical-align: inherit;">CONSTRAINT_EXCLUSIONパラメータも不要です。オフにすることもできます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SET</span> constraint_exclusion = <span class="hljs-keyword">OFF</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの自動レイアウトで埋める：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_range <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings;</code></pre><pre><code class="plaintext hljs">INSERT 0 262788</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
宣言的な構文は継承されたテーブルを非表示にするため、クエリによってセクション内の文字列の分布を確認できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span>, count(*) <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> tableoid;</code></pre><pre><code class="plaintext hljs">       tableoid        | count  <font></font>
-----------------------+--------<font></font>
 bookings_range_201706 |   7303<font></font>
 bookings_range_201707 | 167062<font></font>
 bookings_range_201708 |  88423<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、親テーブルにはデータがありません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">ONLY</span> bookings_range;
</code></pre><pre><code class="plaintext hljs"> book_ref | book_date | total_amount <font></font>
----------+-----------+--------------<font></font>
(0 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリプランのセクションの除外を確認します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">WHERE</span> book_date = <span class="hljs-string">'2017-07-01'</span>::<span class="hljs-type">timestamptz</span>;
</code></pre><pre><code class="plaintext hljs">                                 QUERY PLAN                                 <font></font>
----------------------------------------------------------------------------<font></font>
 Seq Scan on bookings_range_201707<font></font>
   Filter: (book_date = '2017-07-01 00:00:00+03'::timestamp with time zone)<font></font>
(2 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予想どおり、1つのセクションのみをスキャンしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の例では、定数の代わりに変動カテゴリSTABLEを指定してto_timestamp関数を使用しています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">WHERE</span> book_date = to_timestamp(<span class="hljs-string">'01.07.2017'</span>,<span class="hljs-string">'DD.MM.YYYY'</span>);
</code></pre><pre><code class="plaintext hljs">                                     QUERY PLAN                                     <font></font>
------------------------------------------------------------------------------------<font></font>
 Append<font></font>
   Subplans Removed: 2<font></font>
   -&gt;  Seq Scan on bookings_range_201707<font></font>
         Filter: (book_date = to_timestamp('01.07.2017'::text, 'DD.MM.YYYY'::text))<font></font>
(4 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数の値は、クエリプランが初期化され、セクションの一部が表示から除外されるときに計算されます（サブプランが削除された行）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これはSELECTに対してのみ機能します。</font><font style="vertical-align: inherit;">データを変更するとき、STABLE関数の値に基づくセクションの除外はまだ実装されていません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">WHERE</span> book_date = to_timestamp(<span class="hljs-string">'01.07.2017'</span>,<span class="hljs-string">'DD.MM.YYYY'</span>);
</code></pre><pre><code class="plaintext hljs">                                     QUERY PLAN                                     <font></font>
------------------------------------------------------------------------------------<font></font>
 Delete on bookings_range<font></font>
   Delete on bookings_range_201706<font></font>
   Delete on bookings_range_201707<font></font>
   Delete on bookings_range_201708<font></font>
   -&gt;  Seq Scan on bookings_range_201706<font></font>
         Filter: (book_date = to_timestamp('01.07.2017'::text, 'DD.MM.YYYY'::text))<font></font>
   -&gt;  Seq Scan on bookings_range_201707<font></font>
         Filter: (book_date = to_timestamp('01.07.2017'::text, 'DD.MM.YYYY'::text))<font></font>
   -&gt;  Seq Scan on bookings_range_201708<font></font>
         Filter: (book_date = to_timestamp('01.07.2017'::text, 'DD.MM.YYYY'::text))<font></font>
(10 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、定数を使用する必要があります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">WHERE</span> book_date = <span class="hljs-string">'2017-07-01'</span>::<span class="hljs-type">timestamptz</span>;
</code></pre><pre><code class="plaintext hljs">                                    QUERY PLAN                                    <font></font>
----------------------------------------------------------------------------------<font></font>
 Delete on bookings_range<font></font>
   Delete on bookings_range_201707<font></font>
   -&gt;  Seq Scan on bookings_range_201707<font></font>
         Filter: (book_date = '2017-07-01 00:00:00+03'::timestamp with time zone)<font></font>
(4 rows)</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの並べ替え</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のクエリを実行するには、さまざまなセクションから取得した結果を並べ替える必要があります。</font><font style="vertical-align: inherit;">したがって、クエリプランでは、SORTノードとプランの高い初期コストがわかります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_date;
</code></pre><pre><code class="plaintext hljs">                                        QUERY PLAN                                        <font></font>
------------------------------------------------------------------------------------------<font></font>
 Sort  (cost=24649.77..25077.15 rows=170952 width=52)<font></font>
   Sort Key: bookings_range_201706.book_date<font></font>
   -&gt;  Append  (cost=0.00..4240.28 rows=170952 width=52)<font></font>
         -&gt;  Seq Scan on bookings_range_201706  (cost=0.00..94.94 rows=4794 width=52)<font></font>
         -&gt;  Seq Scan on bookings_range_201707  (cost=0.00..2151.30 rows=108630 width=52)<font></font>
         -&gt;  Seq Scan on bookings_range_201708  (cost=0.00..1139.28 rows=57528 width=52)<font></font>
(6 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
book_dateにインデックスを作成します。</font><font style="vertical-align: inherit;">単一のグローバルインデックスの代わりに、インデックスが各セクションで作成されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> book_date_idx <span class="hljs-keyword">ON</span> bookings_range(book_date);
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; \di bookings_range*</code></pre><pre><code class="plaintext hljs">                                    List of relations<font></font>
  Schema  |                Name                 | Type  |  Owner  |         Table         <font></font>
----------+-------------------------------------+-------+---------+-----------------------<font></font>
 bookings | bookings_range_201706_book_date_idx | index | student | bookings_range_201706<font></font>
 bookings | bookings_range_201707_book_date_idx | index | student | bookings_range_201707<font></font>
 bookings | bookings_range_201708_book_date_idx | index | student | bookings_range_201708<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
並べ替えのある以前のクエリは、パーティションキーのインデックスを使用して、さまざまなセクションの結果を並べ替えられた形式ですぐに返すことができます。</font><font style="vertical-align: inherit;">SORTノードは不要であり、結果の最初の行を生成するには最小コストが必要です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_range <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_date;
</code></pre><pre><code class="plaintext hljs">                                                           QUERY PLAN                                                           <font></font>
--------------------------------------------------------------------------------------------------------------------------------<font></font>
 Append  (cost=1.12..14880.88 rows=262788 width=52)<font></font>
   -&gt;  Index Scan using bookings_range_201706_book_date_idx on bookings_range_201706  (cost=0.28..385.83 rows=7303 width=52)<font></font>
   -&gt;  Index Scan using bookings_range_201707_book_date_idx on bookings_range_201707  (cost=0.42..8614.35 rows=167062 width=52)<font></font>
   -&gt;  Index Scan using bookings_range_201708_book_date_idx on bookings_range_201708  (cost=0.42..4566.76 rows=88423 width=52)<font></font>
(4 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法で作成されたパーティションインデックスは、一元的にサポートされます。</font><font style="vertical-align: inherit;">新しいセクションを追加すると、インデックスが自動的に作成されます。</font><font style="vertical-align: inherit;">また、1つのセクションのみのインデックスを削除することはできません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> bookings_range_201706_book_date_idx;
</code></pre><pre><code class="plaintext hljs">ERROR:  cannot drop index bookings_range_201706_book_date_idx because index book_date_idx requires it<font></font>
HINT:  You can drop index book_date_idx instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全体でのみ：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> book_date_idx;
</code></pre><pre><code class="plaintext hljs">DROP INDEX</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを作成...同時に</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パーティションテーブルにインデックスを作成する場合、CONCURRENTLYを指定することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、次のことができます。</font><font style="vertical-align: inherit;">最初に、メインテーブルにのみインデックスを作成します。無効なステータスを受け取ります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> book_date_idx <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ONLY</span> bookings_range(book_date);
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> indisvalid <span class="hljs-keyword">FROM</span> pg_index <span class="hljs-keyword">WHERE</span> indexrelid::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span> = <span class="hljs-string">'book_date_idx'</span>;
</code></pre><pre><code class="plaintext hljs"> indisvalid <font></font>
------------<font></font>
 f<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、CONCURRENTLYオプションを使用してすべてのセクションにインデックスを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> book_date_201706_idx <span class="hljs-keyword">ON</span> bookings_range_201706 (book_date);<font></font>
=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> book_date_201707_idx <span class="hljs-keyword">ON</span> bookings_range_201707 (book_date);<font></font>
=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> book_date_201708_idx <span class="hljs-keyword">ON</span> bookings_range_201708 (book_date);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ローカルインデックスをグローバルに接続します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">INDEX</span> book_date_idx <span class="hljs-keyword">ATTACH PARTITION</span> book_date_201706_idx;<font></font>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">INDEX</span> book_date_idx <span class="hljs-keyword">ATTACH PARTITION</span> book_date_201707_idx;<font></font>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">INDEX</span> book_date_idx <span class="hljs-keyword">ATTACH PARTITION</span> book_date_201708_idx;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、パーティションテーブルの接続に似ています。これについては、後で説明します。</font><font style="vertical-align: inherit;">すべてのインデックスセクションが接続されるとすぐに、メインインデックスのステータスが変更されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> indisvalid <span class="hljs-keyword">FROM</span> pg_index <span class="hljs-keyword">WHERE</span> indexrelid::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span> = <span class="hljs-string">'book_date_idx'</span>;
</code></pre><pre><code class="plaintext hljs"> indisvalid <font></font>
------------<font></font>
 t<font></font>
(1 row)</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクションの接続と切断</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの自動作成は提供されていません。</font><font style="vertical-align: inherit;">したがって、パーティション化キーの新しい値を持つレコードをテーブルに追加する前に、事前に作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のトランザクションがテーブルを操作している間に新しいセクションを作成し、同時にロックを見てみましょう：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> bookings_range
    <span class="hljs-keyword">WHERE</span> book_date = to_timestamp(<span class="hljs-string">'01.07.2017'</span>,<span class="hljs-string">'DD.MM.YYYY'</span>);
</code></pre><pre><code class="plaintext hljs"> count <font></font>
-------<font></font>
     5<font></font>
(1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span>, mode <span class="hljs-keyword">FROM</span> pg_locks 
    <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'bookings%'</span>;
</code></pre><pre><code class="plaintext hljs">       relation        |      mode       <font></font>
-----------------------+-----------------<font></font>
 bookings_range_201708 | AccessShareLock<font></font>
 bookings_range_201707 | AccessShareLock<font></font>
 bookings_range_201706 | AccessShareLock<font></font>
 bookings_range        | AccessShareLock<font></font>
(4 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステートメントの冒頭で、メインテーブル、すべてのセクション、およびインデックスにAccessShareLockロックが適用されます。 to_timestamp関数の計算とセクションの除外は後で行われます。関数の代わりに定数が使用された場合、メインテーブルとbookings_range_201707セクションのみがロックされます。したがって、可能であれば、リクエストで定数を指定します。そうしないと、pg_locksの行数がセクションの数に比例して増加し、max_locks_per_transactionを増やす必要が生じる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のトランザクションを完了せずに、新しいセッションで9月の次のセクションを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">    || =&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range_201709 (<span class="hljs-keyword">LIKE</span> bookings_range);<font></font>
    || =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
    || =&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> bookings_range <span class="hljs-keyword">ATTACH PARTITION</span> bookings_range_201709
          <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2017-09-01'</span>::<span class="hljs-type">timestamptz</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2017-10-01'</span>::<span class="hljs-type">timestamptz</span>);<font></font>
    || =&gt; <span class="hljs-keyword">SELECT</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span>, mode <span class="hljs-keyword">FROM</span> pg_locks 
          <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'bookings%'</span>;
</code></pre><pre><code class="plaintext hljs">              relation               |           mode           <font></font>
-------------------------------------+--------------------------<font></font>
 bookings_range_201709_book_date_idx | AccessExclusiveLock<font></font>
 bookings_range                      | ShareUpdateExclusiveLock<font></font>
 bookings_range_201709               | ShareLock<font></font>
 bookings_range_201709               | AccessExclusiveLock<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいセクションを作成すると、AccessShareLockと互換性のあるShareUpdateExclusiveLockロックがメインテーブルに課されます。</font><font style="vertical-align: inherit;">したがって、パーティションを追加する操作は、パーティション分割されたテーブルに対するクエリと競合しません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;</code></pre><br>
<pre><code class="pgsql hljs">    || =&gt; <span class="hljs-keyword">COMMIT</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの切断は、ALTER TABLE ... DETACH PARTITIONコマンドによって実行されます。</font><font style="vertical-align: inherit;">セクション自体は削除されませんが、独立したテーブルになります。</font><font style="vertical-align: inherit;">そこからデータをダウンロードしたり、削除したり、必要に応じて再接続したりできます（ATTACH PARTITION）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
無効にする別のオプションは、DROP TABLEコマンドでセクションを削除することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、DROP TABLEとDETACH PARTITIONの両方のオプションは、メインテーブルでAccessExclusiveLockロックを使用します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトのセクション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションがまだ作成されていないレコードを追加しようとすると、エラーが発生します。</font><font style="vertical-align: inherit;">この動作が望ましくない場合は、デフォルトのセクションを作成できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_range_default <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_range <span class="hljs-keyword">DEFAULT</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レコードを追加するときに、ミレニアムを指定せずに日付を混同するとします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_range <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'XX0000'</span>, <span class="hljs-string">'0017-09-01'</span>::<span class="hljs-type">timestamptz</span>, <span class="hljs-number">0</span>) 
   <span class="hljs-keyword">RETURNING</span> tableoid::<span class="hljs-type">regclass</span>, *;
</code></pre><pre><code class="plaintext hljs">        tableoid        | book_ref |          book_date           | total_amount <font></font>
------------------------+----------+------------------------------+--------------<font></font>
 bookings_range_default | XX0000   | 0017-09-01 00:00:00+02:30:17 |         0.00<font></font>
(1 row)<font></font>
<font></font>
INSERT 0 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RETURNINGという句は新しい行を返すことに注意してください。これはデフォルトのセクションに分類されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在の日付を設定（パーティションキーを変更）した後、レコードは自動的に目的のセクションに移動します。トリガーは必要ありません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">UPDATE</span> bookings_range <span class="hljs-keyword">SET</span> book_date = <span class="hljs-string">'2017-09-01'</span>::<span class="hljs-type">timestamptz</span> <span class="hljs-keyword">WHERE</span> book_ref = <span class="hljs-string">'XX0000'</span> 
   <span class="hljs-keyword">RETURNING</span> tableoid::<span class="hljs-type">regclass</span>, *;
</code></pre><pre><code class="plaintext hljs">       tableoid        | book_ref |       book_date        | total_amount <font></font>
-----------------------+----------+------------------------+--------------<font></font>
 bookings_range_201709 | XX0000   | 2017-09-01 00:00:00+03 |         0.00<font></font>
(1 row)<font></font>
<font></font>
UPDATE 1</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値リストのセクション化</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デモデータベースでは、book_ref列は、bookingsテーブルの主キーである必要があります。</font><font style="vertical-align: inherit;">ただし、選択したパーティション分割スキームでは、そのようなキーを作成できません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> bookings_range <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">PRIMARY KEY</span>(book_ref);
</code></pre><pre><code class="plaintext hljs">ERROR:  insufficient columns in PRIMARY KEY constraint definition<font></font>
DETAIL:  PRIMARY KEY constraint on table "bookings_range" lacks column "book_date" which is part of the partition key.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パーティションキーは主キーに含まれている必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
月ごとに分類し、主キーにbook_refを引き続き含めるには、値のリストに従って、bookingsテーブルを分割する別のスキームを試してみましょう。</font><font style="vertical-align: inherit;">これを行うには、パーティション列として冗長な列book_monthを追加します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_list (<font></font>
       book_ref     <span class="hljs-type">character</span>(<span class="hljs-number">6</span>),<font></font>
       book_month   <span class="hljs-type">character</span>(<span class="hljs-number">6</span>),<font></font>
       book_date    <span class="hljs-type">timestamptz</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<font></font>
       total_amount <span class="hljs-type">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
       <span class="hljs-keyword">PRIMARY KEY</span> (book_ref, book_month)<font></font>
   ) <span class="hljs-keyword">PARTITION BY LIST</span>(book_month);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予約テーブルのデータに基づいて動的にセクションを形成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">WITH</span> dates <span class="hljs-keyword">AS</span> (
       <span class="hljs-keyword">SELECT</span> date_trunc(<span class="hljs-string">'month'</span>,min(book_date)) min_date, <font></font>
              date_trunc(<span class="hljs-string">'month'</span>,max(book_date)) max_date 
         <span class="hljs-keyword">FROM</span> bookings<font></font>
   ), <span class="hljs-keyword">partition</span> <span class="hljs-keyword">AS</span> (
       <span class="hljs-keyword">SELECT</span> to_char(g.month, <span class="hljs-string">'YYYYMM'</span>) <span class="hljs-keyword">AS</span> book_month 
         <span class="hljs-keyword">FROM</span> dates, <font></font>
              generate_series(dates.min_date, dates.max_date, <span class="hljs-string">'1 month'</span>::<span class="hljs-type">interval</span>) <span class="hljs-keyword">AS</span> g(month)<font></font>
   ) <font></font>
   <span class="hljs-keyword">SELECT</span> format(<span class="hljs-string">'CREATE TABLE %I PARTITION OF bookings_list FOR VALUES IN (%L)'</span>,
                  <span class="hljs-string">'bookings_list_'</span> || <span class="hljs-keyword">partition</span>.book_month, <span class="hljs-keyword">partition</span>.book_month) 
     <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">partition</span>\gexec
</code></pre><pre><code class="plaintext hljs">CREATE TABLE<font></font>
CREATE TABLE<font></font>
CREATE TABLE</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが起こったことです：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; \d+ bookings_list
</code></pre><pre><code class="plaintext hljs">                                    Partitioned table "bookings.bookings_list"<font></font>
    Column    |           Type           | Collation | Nullable | Default | Storage  | Stats target | Description <font></font>
--------------+--------------------------+-----------+----------+---------+----------+--------------+-------------<font></font>
 book_ref     | character(6)             |           | not null |         | extended |              | <font></font>
 book_month   | character(6)             |           | not null |         | extended |              | <font></font>
 book_date    | timestamp with time zone |           | not null |         | plain    |              | <font></font>
 total_amount | numeric(10,2)            |           |          |         | main     |              | <font></font>
Partition key: LIST (book_month)<font></font>
Indexes:<font></font>
    "bookings_list_pkey" PRIMARY KEY, btree (book_ref, book_month)<font></font>
Partitions: bookings_list_201706 FOR VALUES IN ('201706'),<font></font>
            bookings_list_201707 FOR VALUES IN ('201707'),<font></font>
            bookings_list_201708 FOR VALUES IN ('201708')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
断面レイアウトの塗りつぶし：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_list(book_ref,book_month,book_date,total_amount) 
   <span class="hljs-keyword">SELECT</span> book_ref,to_char(book_date, <span class="hljs-string">'YYYYMM'</span>),book_date,total_amount
   <span class="hljs-keyword">FROM</span> bookings;
</code></pre><pre><code class="plaintext hljs">INSERT 0 262788
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リトリートとして。</font><font style="vertical-align: inherit;">book_monthを自動的に埋めるには、バージョン12の新機能であるGENERATED ALWAYS列を使用したくなります。</font><font style="vertical-align: inherit;">ただし、残念ながら、パーティションキーとして使用することはできません。</font><font style="vertical-align: inherit;">したがって、月を埋めるタスクは他の方法で解決する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CHECKやNOT NULLなどの整合性制約は、パーティションテーブルに作成できます。</font><font style="vertical-align: inherit;">継承と同様に、INHERIT / NOINHERITステートメントは、すべてのパーティションテーブルで制限を継承する必要があるかどうかを示します。</font><font style="vertical-align: inherit;">デフォルトの継承：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> bookings_range <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> book_date <span class="hljs-keyword">SET</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; \d bookings_range
</code></pre><pre><code class="plaintext hljs">               Partitioned table "bookings.bookings_range"<font></font>
    Column    |           Type           | Collation | Nullable | Default <font></font>
--------------+--------------------------+-----------+----------+---------<font></font>
 book_ref     | character(6)             |           |          | <font></font>
 book_date    | timestamp with time zone |           | not null | <font></font>
 total_amount | numeric(10,2)            |           |          | <font></font>
Partition key: RANGE (book_date)<font></font>
Indexes:<font></font>
    "book_date_idx" btree (book_date)<font></font>
Number of partitions: 5 (Use \d+ to list them.)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; \d bookings_range_201706
</code></pre><pre><code class="plaintext hljs">                  Table "bookings.bookings_range_201706"<font></font>
    Column    |           Type           | Collation | Nullable | Default <font></font>
--------------+--------------------------+-----------+----------+---------<font></font>
 book_ref     | character(6)             |           |          | <font></font>
 book_date    | timestamp with time zone |           | not null | <font></font>
 total_amount | numeric(10,2)            |           |          | <font></font>
Partition of: bookings_range FOR VALUES FROM ('2017-06-01 00:00:00+03') TO ('2017-07-01 00:00:00+03')<font></font>
Indexes:<font></font>
    "book_date_201706_idx" btree (book_date)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EXCLUDE制約は、パーティションでローカルにのみ作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
book_refが最初にリストされているという事実のおかげで、book_refを検索するとすべてのセクションが検索されますが、インデックスによって検索されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>)
   <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_list <span class="hljs-keyword">WHERE</span> book_ref = <span class="hljs-string">'00000F'</span>;
</code></pre><pre><code class="plaintext hljs">                                QUERY PLAN                                <font></font>
--------------------------------------------------------------------------<font></font>
 Append<font></font>
   -&gt;  Index Scan using bookings_list_201706_pkey on bookings_list_201706<font></font>
         Index Cond: (book_ref = '00000F'::bpchar)<font></font>
   -&gt;  Index Scan using bookings_list_201707_pkey on bookings_list_201707<font></font>
         Index Cond: (book_ref = '00000F'::bpchar)<font></font>
   -&gt;  Index Scan using bookings_list_201708_pkey on bookings_list_201708<font></font>
         Index Cond: (book_ref = '00000F'::bpchar)<font></font>
(7 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
book_refとセクションの範囲を検索すると、指定された範囲のみが検索されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>)
   <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_list <span class="hljs-keyword">WHERE</span> book_ref = <span class="hljs-string">'00000F'</span> <span class="hljs-keyword">AND</span> book_month = <span class="hljs-string">'201707'</span>;
</code></pre><pre><code class="plaintext hljs">                                    QUERY PLAN                                     <font></font>
-----------------------------------------------------------------------------------<font></font>
 Index Scan using bookings_list_201707_pkey on bookings_list_201707<font></font>
   Index Cond: ((book_ref = '00000F'::bpchar) AND (book_month = '201707'::bpchar))<font></font>
(2 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INSERT ... ON CONFLICTコマンドは、目的のセクションを正しく見つけ、更新を実行します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_list <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'XX0001'</span>,<span class="hljs-string">'201708'</span>,<span class="hljs-string">'2017-08-01'</span>,<span class="hljs-number">0</span>)
   <span class="hljs-keyword">RETURNING</span> tableoid::<span class="hljs-type">regclass</span>, *;
</code></pre><pre><code class="plaintext hljs">       tableoid       | book_ref | book_month |       book_date        | total_amount <font></font>
----------------------+----------+------------+------------------------+--------------<font></font>
 bookings_list_201708 | XX0001   | 201708     | 2017-08-01 00:00:00+03 |         0.00<font></font>
(1 row)<font></font>
<font></font>
INSERT 0 1<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_list <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'XX0001'</span>,<span class="hljs-string">'201708'</span>,<span class="hljs-string">'2017-08-01'</span>,<span class="hljs-number">100</span>)
   <span class="hljs-keyword">ON</span> <span class="hljs-keyword">CONFLICT</span>(book_ref,book_month) <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span> total_amount = <span class="hljs-number">100</span>
   <span class="hljs-keyword">RETURNING</span> tableoid::<span class="hljs-type">regclass</span>, *;
</code></pre><pre><code class="plaintext hljs">       tableoid       | book_ref | book_month |       book_date        | total_amount <font></font>
----------------------+----------+------------+------------------------+--------------<font></font>
 bookings_list_201708 | XX0001   | 201708     | 2017-08-01 00:00:00+03 |       100.00<font></font>
(1 row)<font></font>
<font></font>
INSERT 0 1</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部キー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デモデータベースでは、チケットテーブルは予約を参照します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部キーを可能にするには、book_month列を追加し、同時に、bookings_listだけでなく、それを月ごとのセクションに分割します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tickets_list (<font></font>
       ticket_no <span class="hljs-type">character</span>(<span class="hljs-number">13</span>),<font></font>
       book_month <span class="hljs-type">character</span>(<span class="hljs-number">6</span>),<font></font>
       book_ref  <span class="hljs-type">character</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<font></font>
       passenger_id <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<font></font>
       passenger_name <span class="hljs-type">text</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<font></font>
       contact_data <span class="hljs-type">jsonb</span>,
       <span class="hljs-keyword">PRIMARY KEY</span> (ticket_no, book_month),
       <span class="hljs-keyword">FOREIGN KEY</span> (book_ref, book_month) <span class="hljs-keyword">REFERENCES</span> bookings_list (book_ref, book_month)<font></font>
   ) <span class="hljs-keyword">PARTITION BY LIST</span> (book_month);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FOREIGN KEY制約は、よく見る価値があります。</font><font style="vertical-align: inherit;">一方で、これは</font><font style="vertical-align: inherit;">パーティション分割テーブル</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の外部キー</font><font style="vertical-align: inherit;">（tickets_list）であり、他方で、これはパーティション分割テーブル（bookings_list）</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">への</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">したがって、パーティション表の外部キーは両方向でサポートされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">WITH</span> dates <span class="hljs-keyword">AS</span> (
       <span class="hljs-keyword">SELECT</span> date_trunc(<span class="hljs-string">'month'</span>,min(book_date)) min_date,<font></font>
              date_trunc(<span class="hljs-string">'month'</span>,max(book_date)) max_date 
         <span class="hljs-keyword">FROM</span> bookings<font></font>
   ), <span class="hljs-keyword">partition</span> <span class="hljs-keyword">AS</span> (
       <span class="hljs-keyword">SELECT</span> to_char(g.month, <span class="hljs-string">'YYYYMM'</span>) <span class="hljs-keyword">AS</span> book_month 
         <span class="hljs-keyword">FROM</span> dates,<font></font>
              generate_series(dates.min_date, dates.max_date, <span class="hljs-string">'1 month'</span>::<span class="hljs-type">interval</span>) <span class="hljs-keyword">AS</span> g(month)<font></font>
   ) <font></font>
   <span class="hljs-keyword">SELECT</span> format(<span class="hljs-string">'CREATE TABLE %I PARTITION OF tickets_list FOR VALUES IN (%L)'</span>,
                  <span class="hljs-string">'tickets_list_'</span> || <span class="hljs-keyword">partition</span>.book_month, <span class="hljs-keyword">partition</span>.book_month) 
     <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">partition</span>\gexec
</code></pre><pre><code class="plaintext hljs">CREATE TABLE<font></font>
CREATE TABLE<font></font>
CREATE TABLE<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; \d+ tickets_list
</code></pre><pre><code class="plaintext hljs">                                    Partitioned table "bookings.tickets_list"<font></font>
     Column     |         Type          | Collation | Nullable | Default | Storage  | Stats target | Description <font></font>
----------------+-----------------------+-----------+----------+---------+----------+--------------+-------------<font></font>
 ticket_no      | character(13)         |           | not null |         | extended |              | <font></font>
 book_month     | character(6)          |           | not null |         | extended |              | <font></font>
 book_ref       | character(6)          |           | not null |         | extended |              | <font></font>
 passenger_id   | character varying(20) |           | not null |         | extended |              | <font></font>
 passenger_name | text                  |           | not null |         | extended |              | <font></font>
 contact_data   | jsonb                 |           |          |         | extended |              | <font></font>
Partition key: LIST (book_month)<font></font>
Indexes:<font></font>
    "tickets_list_pkey" PRIMARY KEY, btree (ticket_no, book_month)<font></font>
Foreign-key constraints:<font></font>
    "tickets_list_book_ref_book_month_fkey" FOREIGN KEY (book_ref, book_month) REFERENCES bookings_list(book_ref, book_month)<font></font>
Partitions: tickets_list_201706 FOR VALUES IN ('201706'),<font></font>
            tickets_list_201707 FOR VALUES IN ('201707'),<font></font>
            tickets_list_201708 FOR VALUES IN ('201708')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記入：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tickets_list<font></font>
       (ticket_no,book_month,book_ref,passenger_id,passenger_name,contact_data)<font></font>
       <span class="hljs-keyword">SELECT</span> t.ticket_no,b.book_month,t.book_ref,<font></font>
              t.passenger_id,t.passenger_name,t.contact_data<font></font>
       <span class="hljs-keyword">FROM</span> bookings_list b <span class="hljs-keyword">JOIN</span> tickets t <span class="hljs-keyword">ON</span> (b.book_ref = t.book_ref);
</code></pre><pre><code class="plaintext hljs">INSERT 0 366733
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">VACUUM</span> <span class="hljs-keyword">ANALYZE</span> tickets_list;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクション内の線の分布：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span>, count(*) <span class="hljs-keyword">FROM</span> tickets_list <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> tableoid;
</code></pre><pre><code class="plaintext hljs">      tableoid       | count  <font></font>
---------------------+--------<font></font>
 tickets_list_201706 |  10160<font></font>
 tickets_list_201707 | 232755<font></font>
 tickets_list_201708 | 123818<font></font>
(3 rows)</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続および集約要求</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ方法で分割された2つのテーブルを結合します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">SELECT</span> b.*
     <span class="hljs-keyword">FROM</span> bookings_list b <span class="hljs-keyword">JOIN</span> tickets_list t 
          <span class="hljs-keyword">ON</span> (b.book_ref = t.book_ref <span class="hljs-keyword">and</span> b.book_month = t.book_month);
</code></pre><pre><code class="plaintext hljs">                                 QUERY PLAN                                 <font></font>
----------------------------------------------------------------------------<font></font>
 Hash Join<font></font>
   Hash Cond: ((t.book_ref = b.book_ref) AND (t.book_month = b.book_month))<font></font>
   -&gt;  Append<font></font>
         -&gt;  Seq Scan on tickets_list_201706 t<font></font>
         -&gt;  Seq Scan on tickets_list_201707 t_1<font></font>
         -&gt;  Seq Scan on tickets_list_201708 t_2<font></font>
   -&gt;  Hash<font></font>
         -&gt;  Append<font></font>
               -&gt;  Seq Scan on bookings_list_201706 b<font></font>
               -&gt;  Seq Scan on bookings_list_201707 b_1<font></font>
               -&gt;  Seq Scan on bookings_list_201708 b_2<font></font>
(11 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続を開始する前に、各テーブルはまずクエリ条件に該当するセクションを結合します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、最初に両方のテーブルの対応する月次セクションを組み合わせ、次に結果を組み合わせることができます。</font><font style="vertical-align: inherit;">これは、enable_partitionwise_joinパラメータを有効にすることで実現できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SET</span> enable_partitionwise_join = <span class="hljs-keyword">ON</span>;<font></font>
=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) 
   <span class="hljs-keyword">SELECT</span> b.*
     <span class="hljs-keyword">FROM</span> bookings_list b <span class="hljs-keyword">JOIN</span> tickets_list t
          <span class="hljs-keyword">ON</span> (b.book_ref = t.book_ref <span class="hljs-keyword">and</span> b.book_month = t.book_month);
</code></pre><pre><code class="plaintext hljs">                                        QUERY PLAN                                        <font></font>
------------------------------------------------------------------------------------------<font></font>
 Append<font></font>
   -&gt;  Hash Join<font></font>
         Hash Cond: ((t.book_ref = b.book_ref) AND (t.book_month = b.book_month))<font></font>
         -&gt;  Seq Scan on tickets_list_201706 t<font></font>
         -&gt;  Hash<font></font>
               -&gt;  Seq Scan on bookings_list_201706 b<font></font>
   -&gt;  Hash Join<font></font>
         Hash Cond: ((t_1.book_ref = b_1.book_ref) AND (t_1.book_month = b_1.book_month))<font></font>
         -&gt;  Seq Scan on tickets_list_201707 t_1<font></font>
         -&gt;  Hash<font></font>
               -&gt;  Seq Scan on bookings_list_201707 b_1<font></font>
   -&gt;  Hash Join<font></font>
         Hash Cond: ((t_2.book_ref = b_2.book_ref) AND (t_2.book_month = b_2.book_month))<font></font>
         -&gt;  Seq Scan on tickets_list_201708 t_2<font></font>
         -&gt;  Hash<font></font>
               -&gt;  Seq Scan on bookings_list_201708 b_2<font></font>
(16 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、まず2つのテーブルの対応するセクションが結合され、次に結合の結果が結合されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
集約に関する同様の状況：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> bookings_list;
</code></pre><pre><code class="plaintext hljs">                            QUERY PLAN                             <font></font>
-------------------------------------------------------------------<font></font>
 Finalize Aggregate<font></font>
   -&gt;  Gather<font></font>
         Workers Planned: 2<font></font>
         -&gt;  Partial Aggregate<font></font>
               -&gt;  Parallel Append<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201707<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201708<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201706<font></font>
(8 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションスキャンは並行して実行できることに注意してください。</font><font style="vertical-align: inherit;">しかし、最初にセクションが集まり、それから初めて集約が始まります。</font><font style="vertical-align: inherit;">または、各セクションで集計を実行し、結果を組み合わせることができます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SET</span> enable_partitionwise_aggregate = <span class="hljs-keyword">ON</span>;<font></font>
=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>) <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> bookings_list;
</code></pre><pre><code class="plaintext hljs">                            QUERY PLAN                             <font></font>
-------------------------------------------------------------------<font></font>
 Finalize Aggregate<font></font>
   -&gt;  Gather<font></font>
         Workers Planned: 2<font></font>
         -&gt;  Parallel Append<font></font>
               -&gt;  Partial Aggregate<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201707<font></font>
               -&gt;  Partial Aggregate<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201708<font></font>
               -&gt;  Partial Aggregate<font></font>
                     -&gt;  Parallel Seq Scan on bookings_list_201706<font></font>
(10 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの一部が外部テーブルである場合、これらの機能は特に重要です。</font><font style="vertical-align: inherit;">デフォルトでは、両方とも無効になっています。</font><font style="vertical-align: inherit;">関連するパラメーターは、計画の作成にかかる時間に影響しますが、常に使用されるとは限りません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュ分割</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルを分割する3番目の方法は、ハッシュ分割です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルを作成する：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_hash (<font></font>
       book_ref     <span class="hljs-type">character</span>(<span class="hljs-number">6</span>) <span class="hljs-keyword">PRIMARY KEY</span>,<font></font>
       book_date    <span class="hljs-type">timestamptz</span>  <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<font></font>
       total_amount <span class="hljs-type">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)<font></font>
   ) <span class="hljs-keyword">PARTITION BY HASH</span>(book_ref);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このバージョンのbook_refでは、パーティションキーとして、それを主キーとしてすぐに宣言できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのセクションに分割します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_hash_p0 
       <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_hash <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">3</span>, REMAINDER <span class="hljs-number">0</span>);<font></font>
=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_hash_p1 
       <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_hash <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">3</span>, REMAINDER <span class="hljs-number">1</span>);<font></font>
=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bookings_hash_p2 
       <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> bookings_hash <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">WITH</span> (MODULUS <span class="hljs-number">3</span>, REMAINDER <span class="hljs-number">2</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの自動レイアウトで埋める：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bookings_hash <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings;
</code></pre><pre><code class="plaintext hljs">INSERT 0 262788</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクション内の線の分布は均等に発生します：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">partition</span>, count(*) <span class="hljs-keyword">FROM</span> bookings_hash <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> tableoid;
</code></pre><pre><code class="plaintext hljs">    partition     | count <font></font>
------------------+-------<font></font>
 bookings_hash_p0 | 87649<font></font>
 bookings_hash_p1 | 87651<font></font>
 bookings_hash_p2 | 87488<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分割されたオブジェクトを表示する新しいコマンド：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; \dP+ 
</code></pre><pre><code class="plaintext hljs">                                      List of partitioned relations<font></font>
  Schema  |        Name        |  Owner  |       Type        |     Table      | Total size | Description <font></font>
----------+--------------------+---------+-------------------+----------------+------------+-------------<font></font>
 bookings | bookings_hash      | student | partitioned table |                | 13 MB      | <font></font>
 bookings | bookings_list      | student | partitioned table |                | 15 MB      | <font></font>
 bookings | bookings_range     | student | partitioned table |                | 13 MB      | <font></font>
 bookings | tickets_list       | student | partitioned table |                | 50 MB      | <font></font>
 bookings | book_date_idx      | student | partitioned index | bookings_range | 5872 kB    | <font></font>
 bookings | bookings_hash_pkey | student | partitioned index | bookings_hash  | 5800 kB    | <font></font>
 bookings | bookings_list_pkey | student | partitioned index | bookings_list  | 8120 kB    | <font></font>
 bookings | tickets_list_pkey  | student | partitioned index | tickets_list   | 19 MB      | <font></font>
(8 rows)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">VACUUM</span> <span class="hljs-keyword">ANALYZE</span> bookings_hash;
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブクエリとネストされたループ結合</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時のセクションの除外は、ネストされたループ接続で可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションの最初の10件の予約の分布：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">WITH</span> top10 <span class="hljs-keyword">AS</span> (
     <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">partition</span>, * <span class="hljs-keyword">FROM</span> bookings_hash <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_ref <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>
   ) <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">partition</span>, count(*) <span class="hljs-keyword">FROM</span> top10 <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>;
</code></pre><pre><code class="plaintext hljs">    partition     | count <font></font>
------------------+-------<font></font>
 bookings_hash_p0 |     3<font></font>
 bookings_hash_p1 |     3<font></font>
 bookings_hash_p2 |     4<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bookings_hashテーブルと前のサブクエリを結合したクエリ実行プランを見てみましょう：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>,<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>,<span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>) 
     <span class="hljs-keyword">WITH</span> top10 <span class="hljs-keyword">AS</span> (
         <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">partition</span>, * <span class="hljs-keyword">FROM</span> bookings <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_ref <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>
   ) <span class="hljs-keyword">SELECT</span> bh.* <span class="hljs-keyword">FROM</span> bookings_hash bh <span class="hljs-keyword">JOIN</span> top10 <span class="hljs-keyword">ON</span> bh.book_ref = top10.book_ref;
</code></pre><pre><code class="plaintext hljs">                                             QUERY PLAN                                              <font></font>
-----------------------------------------------------------------------------------------------------<font></font>
 Nested Loop (actual rows=10 loops=1)<font></font>
   -&gt;  Limit (actual rows=10 loops=1)<font></font>
         -&gt;  Index Only Scan using bookings_pkey on bookings (actual rows=10 loops=1)<font></font>
               Heap Fetches: 0<font></font>
   -&gt;  Append (actual rows=1 loops=10)<font></font>
         -&gt;  Index Scan using bookings_hash_p0_pkey on bookings_hash_p0 bh (actual rows=1 loops=3)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p1_pkey on bookings_hash_p1 bh_1 (actual rows=1 loops=3)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p2_pkey on bookings_hash_p2 bh_2 (actual rows=1 loops=4)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
 Planning Time: 0.632 ms<font></font>
 Execution Time: 0.278 ms<font></font>
(13 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続は、ネストされたループメソッドを使用して行われます。</font><font style="vertical-align: inherit;">一般的なテーブル式による外側のループは10回実行されます。</font><font style="vertical-align: inherit;">ただし、セクションテーブル（ループ）の呼び出し回数に注意してください。</font><font style="vertical-align: inherit;">外部ループの各book_ref値について、この値がbookings_hashテーブルに格納されているセクションのみがスキャンされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
無効なセクションの除外と比較してください：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SET</span> enable_partition_pruning <span class="hljs-keyword">TO</span> <span class="hljs-keyword">OFF</span>;<font></font>
=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>,<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>,<span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>) 
     <span class="hljs-keyword">WITH</span> top10 <span class="hljs-keyword">AS</span> (
         <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">partition</span>, * <span class="hljs-keyword">FROM</span> bookings <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_ref <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>
   ) <span class="hljs-keyword">SELECT</span> bh.* <span class="hljs-keyword">FROM</span> bookings_hash bh <span class="hljs-keyword">JOIN</span> top10 <span class="hljs-keyword">ON</span> bh.book_ref = top10.book_ref;
</code></pre><pre><code class="plaintext hljs">                                              QUERY PLAN                                              <font></font>
------------------------------------------------------------------------------------------------------<font></font>
 Nested Loop (actual rows=10 loops=1)<font></font>
   -&gt;  Limit (actual rows=10 loops=1)<font></font>
         -&gt;  Index Only Scan using bookings_pkey on bookings (actual rows=10 loops=1)<font></font>
               Heap Fetches: 0<font></font>
   -&gt;  Append (actual rows=1 loops=10)<font></font>
         -&gt;  Index Scan using bookings_hash_p0_pkey on bookings_hash_p0 bh (actual rows=0 loops=10)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p1_pkey on bookings_hash_p1 bh_1 (actual rows=0 loops=10)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p2_pkey on bookings_hash_p2 bh_2 (actual rows=0 loops=10)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
 Planning Time: 0.886 ms<font></font>
 Execution Time: 0.771 ms<font></font>
(13 rows)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">RESET</span> enable_partition_pruning;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選択を1つの予約に減らすと、2つのセクションはまったく表示されなくなります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>,<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>,<span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>) 
     <span class="hljs-keyword">WITH</span> top <span class="hljs-keyword">AS</span> (
         <span class="hljs-keyword">SELECT</span> tableoid::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">partition</span>, * <span class="hljs-keyword">FROM</span> bookings <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> book_ref <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
   ) <span class="hljs-keyword">SELECT</span> bh.* <span class="hljs-keyword">FROM</span> bookings_hash bh <span class="hljs-keyword">JOIN</span> top <span class="hljs-keyword">ON</span> bh.book_ref = top.book_ref;
</code></pre><pre><code class="plaintext hljs">                                            QUERY PLAN                                             <font></font>
---------------------------------------------------------------------------------------------------<font></font>
 Nested Loop (actual rows=1 loops=1)<font></font>
   -&gt;  Limit (actual rows=1 loops=1)<font></font>
         -&gt;  Index Only Scan using bookings_pkey on bookings (actual rows=1 loops=1)<font></font>
               Heap Fetches: 0<font></font>
   -&gt;  Append (actual rows=1 loops=1)<font></font>
         -&gt;  Index Scan using bookings_hash_p0_pkey on bookings_hash_p0 bh (actual rows=1 loops=1)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p1_pkey on bookings_hash_p1 bh_1 (never executed)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p2_pkey on bookings_hash_p2 bh_2 (never executed)<font></font>
               Index Cond: (book_ref = bookings.book_ref)<font></font>
 Planning Time: 0.250 ms<font></font>
 Execution Time: 0.090 ms<font></font>
(13 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サブクエリの代わりに、変動STABLEのカテゴリを持つセットを返す関数を使用できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> get_book_ref(top <span class="hljs-type">int</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">SETOF</span> bookings <span class="hljs-keyword">AS</span> $$<span class="pgsql">
       <span class="hljs-keyword">BEGIN</span>
           <span class="hljs-keyword">RETURN QUERY</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT * FROM bookings ORDER BY book_ref LIMIT $1'</span> 
                        <span class="hljs-keyword">USING</span> top;
       <span class="hljs-keyword">END</span>;$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql <span class="hljs-keyword">STABLE</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>,<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>,<span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>) 
       <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> bookings_hash bh <span class="hljs-keyword">JOIN</span> get_book_ref(<span class="hljs-number">10</span>) f <span class="hljs-keyword">ON</span> bh.book_ref = f.book_ref;
</code></pre><pre><code class="plaintext hljs">                                             QUERY PLAN                                              <font></font>
-----------------------------------------------------------------------------------------------------<font></font>
 Nested Loop (actual rows=10 loops=1)<font></font>
   -&gt;  Function Scan on get_book_ref f (actual rows=10 loops=1)<font></font>
   -&gt;  Append (actual rows=1 loops=10)<font></font>
         -&gt;  Index Scan using bookings_hash_p0_pkey on bookings_hash_p0 bh (actual rows=1 loops=3)<font></font>
               Index Cond: (book_ref = f.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p1_pkey on bookings_hash_p1 bh_1 (actual rows=1 loops=3)<font></font>
               Index Cond: (book_ref = f.book_ref)<font></font>
         -&gt;  Index Scan using bookings_hash_p2_pkey on bookings_hash_p2 bh_2 (actual rows=1 loops=4)<font></font>
               Index Cond: (book_ref = f.book_ref)<font></font>
 Planning Time: 0.175 ms<font></font>
 Execution Time: 0.843 ms<font></font>
(11 rows)</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要約すると、PostgreSQL 12の組み込みまたは宣言型のパーティション分割には豊富な機能セットがあり、継承によってパーティション分割を置き換えることを安全に推奨できます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456700/index.html">GeekUniversityが製品管理学部に採用情報を公開</a></li>
<li><a href="../ja456704/index.html">テスターがメリットを享受できる6つの方法（機能テスト以外）</a></li>
<li><a href="../ja456710/index.html">ローコード/コードなしプラットフォームとCRM、CRM +、ERPとは</a></li>
<li><a href="../ja456712/index.html">SOAPサービスの選択的なトラフィックロギング</a></li>
<li><a href="../ja456714/index.html">浮動小数点数について（パート0）</a></li>
<li><a href="../ja456722/index.html">PostgreSQLレシピ：非同期タスクスケジューラ</a></li>
<li><a href="../ja456724/index.html">VueJSアプリケーションを大幅にスピードアップする5つの非常にシンプルな方法</a></li>
<li><a href="../ja456730/index.html">本「{JSのことはわからない}のタイプと文法構文」</a></li>
<li><a href="../ja456732/index.html">メンターになる</a></li>
<li><a href="../ja456736/index.html">PostgreSQLレシピ：cURL：取得、投稿、...メール</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>