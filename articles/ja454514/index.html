<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👋🏼 ⛹🏻 ♒️ ATMEGA8でのシンプルな音楽シンセサイザーの開発 🌖 📞 💗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="数年前、私はATmega8マイクロコントローラーで目覚まし時計を作りました。そこで、私はシングルトーン（シングルボイス）のシンプルなメロディーシンセサイザーを実装しました。このトピックに関する初心者向けのインターネット上の多くの記事があります。原則として、16ビットタイマーは周波数（ノート）を生成す...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ATMEGA8でのシンプルな音楽シンセサイザーの開発</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454514/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数年前、私はATmega8マイクロコントローラーで目覚まし時計を作りました。そこで、私はシングルトーン（シングルボイス）のシンプルなメロディーシンセサイザーを実装しました。このトピックに関する初心者向けのインターネット上の多くの記事があります。原則として、16ビットタイマーは周波数（ノート）を生成するために使用されます。これは特定の方法で構成され、ハードウェアレベルで強制的にMCの特定のピンで蛇行の形で信号を発行します。 2番目の（8ビット）タイマーは、ノートまたは一時停止の期間を実装するために使用されます。よく知られている式によるノートは周波数と比較され、次に、タイマーのカウント期間を指定する周波数に反比例する特定の16ビット数と比較されます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のデザインでは、同じキーとスケールで書かれた3つのメロディーを予見しました。そのため、限られた数のノートを使用する必要があり、モデリングが容易になりました。また、3曲とも同じペースで演奏されました。ノートコードとそのデュレーションコードは簡単に1バイトに収まります。このモデルの唯一の欠点は、汎用性の欠如、メロディをすばやく編集、置換、または補足できることでした。メロディーを録音するために、まずコンピューターの音楽エディターでそれをスケッチし、事前に決めた番号を付けてノートとそのデュレーションをコピーし、結果のバイトを形成しました。最後の操作はExcelプログラムを使用して行いました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来、私は前述の欠点を排除し、デザインに特定の普遍性を裏切り、メロディを実装する時間を短縮したいと考えました。 MKプログラムが有名な音楽フォーマットの1つのバイトを読み取るという考えがありました。最も一般的で一般的なのはMIDIフォーマットです。より文字通り、これはインターネット上で読むことができる「科学」全体としての形式ではありません。 MIDI仕様は、対応する物理インターフェイスを介してリアルタイムメッセージを送信するためのプロトコルを定義し、これらのメッセージを格納できるmidiファイルの配置方法を記述しています。 midiフォーマットは音楽志向なので、関連分野での用途が見出されます。音響機器、カラーミュージック、シンセサイザー、ロボットなどの同期制御です。国内では、携帯電話の開発が始まった時代にミディフォーマットに出会いました。この場合、特定のノートのインクルードまたは非アクティブ化に関するメッセージ、楽器に関する情報、ノートの音量などがmidiファイルに記録されます。このようなファイルを再生する携帯電話には、このファイルのMIDIメッセージをリアルタイムで解釈してメロディを再生するシンセサイザーが含まれています。初期の段階では、電話はシングルトーンのメロディーしか再生できませんでした。やがて、いわゆるポリフォニーが登場しました。このファイルのMIDIメッセージをリアルタイムで解釈し、メロディを再生します。初期の段階では、電話はシングルトーンのメロディーしか再生できませんでした。やがて、いわゆるポリフォニーが登場しました。このファイルのMIDIメッセージをリアルタイムで解釈し、メロディを再生します。初期の段階では、電話はシングルトーンのメロディーしか再生できませんでした。やがて、いわゆるポリフォニーが登場しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターネットで、midiファイルを読み取るMKでのポリフォニックシンセサイザーの実装に関する記事に会いました。この場合、少なくとも事前に作成された「ウェーブテーブル」（音波のリスト）が、MKのメモリに保存されている楽器ごとに使用されます。そして、私の特定のケースでは、より単純なモデル、つまりシングルトーン（単一音声）シンセサイザーの実装に焦点を当てます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、midiファイルの構造を注意深く調査したところ、メモに関する必要な情報に加えて、追加の冗長な情報が含まれているという結論に達しました。そのため、midiファイルを独自の形式に変換する簡単なプログラムを作成することにしました。このプログラムは多くのmidiファイルを処理し、フォーマットを変換するだけでなく、それらを特定の方法で整理します。事前に、ROMメモリー（EEPROM 24XX512）に多くの曲のストレージを整理することにしました。 HEXエディターでの視覚化の便宜上、各メロディーがセクターの最初から始まるようにしました。例えばSDカードと違い、使用しているROMにはセクターという概念が当てはまらないので、条件付きで表現しています。セクターサイズは512バイトです。また、ROMの最初のセクターは、各メロディの最初のセクターのアドレス用に予約されています。メロディーはいくつかのセクターを取ることが想定されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、MIDIファイル形式の完全な説明は、ここで行う価値はありません。私は最も必要で必要な点だけに触れます。 MIDIファイルには、16チャンネルが含まれています。これは、通常、ほとんどの場合、1つまたは別の楽器に対応しています。私たちのケースでは、それがどのような種類の楽器であってもかまいません。必要なチャネルは1つだけです。各チャネルのコンテンツは、ヘッダーとともに、AVIコンテナでのビデオおよびオーディオストリームのストレージの編成と非常によく似た原理に従って、midiファイルに作成されます。後者については、以前の記事の1つで書いた。 MIDIファイルのヘッダーは、いくつかのパラメーターのセットです。そのようなパラメータの1つは時間分解能です。クォーターあたりの「ティック」（ピクセルの一種）の数（PPQN）で表されます。四分の一は、四分音符が演奏される期間です。メロディーのテンポによって、四半期の長さが異なる場合があります。したがって、1つの「ピクセル」の持続時間（サンプリング周期）は、テンポとPPQNに依存します。イベントの時間に関するすべての情報は、この期間に正確に決定されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ヘッダーには、MIDIファイルのタイプ（タイプ0またはタイプ1）とチャネル数が含まれています。詳細には触れずに、タイプ1、チャネル数2を使用します。シングルトーンのメロディを持つ論理的なMIDIファイルには、1つのチャネルが含まれています。ただし、「タイプ1」のMIDIファイルには、メインのファイルに加えて、ノートを含まない追加情報が記録される別の「非音楽」チャンネルがあります。これはいわゆるメタデータです。詳細に入る必要もありません。私たちがそこに必要な唯一の情報は、ペースに関する情報があり、異常な形式である1/4マイクロ秒です。将来的には、この情報をPPQNと一緒に使用して、テンポを担当するMKタイマーを構成する方法が示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノートのあるメインチャネルブロックでは、ノートのオン/オフのイベントに関する情報のみに関心があります。ノート有効化イベントには、ノート番号とボリュームの2つのパラメーターがあります。合計で、128のノートと128のボリュームレベルが提供されます。最初のパラメータのみに注目します。これは、ノートの音量は関係ないためです。MKチューンを再生すると、すべてのノートが同じ音量で聞こえます。そしてもちろん、メロディには「オーバーダビング」されたノートがあってはなりません。つまり、いつでも、複数のノートが同時に鳴ってはなりません。ノートを取る（オンにする）イベントのコードは0x90です。ノートオフイベントコードは0x80です。ただし、少なくともCakewalk Pro Audio 9エディターは、コンポジションをMIDI形式にエクスポートするときに0x80コードのイベントを使用しません。代わりに、イベント0x90が音楽パート全体でアクティブになり、そして、ノートがオフになっているというノートは、そのゼロボリュームです。つまり、「ノートをオフにする」イベントは、「音量をゼロにしてノートをオンにする」イベントと同じです。おそらくこれは経済上の理由で行われます。仕様によると、このイベントが繰り返される場合、イベントコードを書き換えることはできません。イベント間では、時間間隔に関する情報が可変長形式で記録されます。これらは、上記の「ティック」の数の整数値です。ほとんどの場合、一定の時間を記録するには1バイトで十分です。 2つのイベントが次々と続く場合、それらの間の時間間隔は明らかにゼロに等しくなります。たとえば、最初の音符をオフにし、その後にある2番目の音符をオンにします（それらの間に一時停止（スペース）がない場合）。これは経済上の理由で行われます。仕様によると、このイベントが繰り返される場合、イベントコードを書き換えることはできません。イベント間では、時間間隔に関する情報が可変長形式で記録されます。これらは、上記の「ティック」の数の整数値です。ほとんどの場合、一定の時間を記録するには1バイトで十分です。 2つのイベントが次々と続く場合、それらの間の時間間隔は明らかにゼロに等しくなります。たとえば、最初の音符をオフにし、その後にある2番目の音符をオンにします（それらの間に一時停止（スペース）がない場合）。これは経済上の理由で行われます。仕様によると、このイベントが繰り返される場合、イベントコードを書き換えることはできません。イベント間では、時間間隔に関する情報が可変長形式で記録されます。これらは、上記の「ティック」の数の整数値です。ほとんどの場合、一定の時間を記録するには1バイトで十分です。 2つのイベントが次々と続く場合、それらの間の時間間隔は明らかにゼロに等しくなります。たとえば、最初のノートをオフにし、その後に続く2番目のノートをオンにします（それらの間にポーズ（スペース）がない場合）。上記の通り。ほとんどの場合、一定の時間を記録するには1バイトで十分です。 2つのイベントが次々と続く場合、それらの間の時間間隔は明らかにゼロに等しくなります。たとえば、最初の音符をオフにし、その後にある2番目の音符をオンにします（それらの間に一時停止（スペース）がない場合）。上記の通り。ほとんどの場合、一定の時間を記録するには1バイトで十分です。 2つのイベントが次々と続く場合、それらの間の時間間隔は明らかにゼロに等しくなります。たとえば、最初の音符をオフにし、その後にある2番目の音符をオンにします（それらの間に一時停止（スペース）がない場合）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラム「Cakewalk Pro Audio 9」を使って一連の音符を書いてみましょう。</font><font style="vertical-align: inherit;">多くの編集者がいますが、私は最初に出会った編集者に落ち着きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/rs/ig/x2rsigockegfkqq_xux3wgiesly.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、プロジェクト設定を構成する必要があります。</font><font style="vertical-align: inherit;">このエディターでは、時間内の解像度（PPQN）を設定できます。</font><font style="vertical-align: inherit;">私は48に等しい最小値を選択します。サイズが1バイトを超える大きな数値を扱う必要があるため、値が大きすぎても意味がありません。</font><font style="vertical-align: inherit;">ただし、最小値の48で十分です。</font><font style="vertical-align: inherit;">ほとんどすべてのメロディーで、1/32より短い音符は見つかりません。</font><font style="vertical-align: inherit;">また、四半期あたりの「ティック」の数が48の場合、ノートまたはポーズ1/32の継続時間は48 /（32/4）= 6「ティック」になります。</font><font style="vertical-align: inherit;">つまり、理論的には、1/32の音符を2に、さらには3でさえ完全に分割する可能性があります。残りのパラメーターは、デフォルトでプロジェクトプロパティウィンドウに残します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q-/e8/1j/q-e81jrcz7-g-doa-oberdoezju.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最初のトラックのプロパティを開き、1に等しいチャネル番号を割り当てます。好みに合わせて、エディターでメロディーを演奏するときに楽器に対応するパッチを選択します。もちろん、パッチ番号は最終結果には影響しません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/2o/xn/y-2oxnmqemoxj3hwtflnanivyyk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メロディーのテンポは、エディターのツールバーの1分あたりの四半期数で設定されます。デフォルトのテンポ値は100 bpmです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロコントローラーには8ビットタイマーがあり、これは既に述べたように、音符と一時停止の持続時間を制御するために使用されます。そのようなタイマーの隣接する操作（割り込み）間の時間間隔は、1つの「ティック」の間隔に対応することが決定されました。メロディーのテンポによって、この時間間隔の値は異なります。オーバーフロータイマー割り込みを使用することにしました。また、初期タイマー初期化パラメーターに応じて、この時間間隔を調整できます。これは、メロディーのテンポによって異なります。それでは、計算に移りましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、実際には、平均して、曲のテンポは50から200のオーダーの範囲にあります。midiファイルのテンポは1/4マイクロ秒単位で設定されるとすでに言われています。テンポ50の場合、この値は60,000,000 / 50 = 1,200,000で、テンポ250の場合は240,000になります。プロジェクトによると、クォーターには48ティックが含まれるため、最小テンポのティック長は1,200,000 / 48 = 25,000μsになります。最大ペースについては、同じ方法で計算すると-5000μs。クォーツ周波数が8 MHz、最大予備タイマー分周器が1024のMKの場合、次のようになります。最小ペースの場合、タイマーは25000 /（1024/8）= 195回計算する必要があります。結果は最も近い整数値に丸められ、丸め誤差は実際には結果に影響しません。最大ペースの場合-5000 /（1024/8）= 39。ここで、丸め誤差はより多くに影響しません丸められた値39は、248から253までの隣接するテンポ値に対しても取得されます。したがって、タイマーは逆の値で初期化する必要があります。最小テンポの場合-（256-195）= 61、最大の場合-（256-39）= 217。現在のMK構成でタイマー操作が保証される最小ペースは39 bpmです。この値では、タイマーを250回カウントする必要があります。そして、38の値-すでに257で、タイマーの制限を超えています。私は、最小ペースで40 bpm、最大ペースで240の値を取ることにしました。MKの現在の構成でタイマーを使用できるようになるのは、39 bpmです。この値では、タイマーを250回カウントする必要があります。そして、38の値-すでに257で、タイマーの制限を超えています。私は、最小ペースで40 bpm、最大ペースで240の値を取ることにしました。MKの現在の構成でタイマーを使用できるようになるのは、39 bpmです。この値では、タイマーを250回カウントする必要があります。そして、38の値-すでに257で、タイマーの制限を超えています。私は、最小ペースで40 bpm、最大ペースで240の値を取ることにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ティック数をカウントするために、前述に基づいて仮想タイマーが使用されます。すでに述べたように、音符または一時停止の持続時間を設定するのはティックの数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
音楽再生を実装するには、2番目の16ビットタイマーを使用します。 MIDI仕様によれば、合計128のノートが提供されます。しかし、実際にはそれらははるかに使用されません。さらに、最低（約50 Hzの周波数）および最高（約8 kHzの周波数）オクターブのノートは、マイクロコントローラーによって調和して再現されません。しかし、これらすべてについて、固定ディバイダーを備えた16ビットタイマーは、midiによって提供されるノートのほぼすべての範囲をカバーします。つまり、最初の35はありません。しかし、私は最初に37という数字のノートを選択しました（エンコードはゼロからのものであるため、コードは36です）。これは、この数字が従来のスケールの最初の音符としての音符「C」に対応するため、便宜上行われます。それに対応する周波数は65.4 Hzで、半サイクルは-1 / 65.4 / 2 = 0.00764秒です。MK周波数が8 MHzのこの期間と分周器1（つまり、分周器なし）は、タイマーをほぼ全体として0.00764 /（1/8000000）= 61156回カウントします。 35分音符の場合、カウントすると、この値は68645になり、16ビットタイマーの範囲を超えます。ただし、36分より下のノートを演奏する必要があったとしても、8に等しい最初に利用可能なタイマーディバイダーを入力できます。それにもかかわらず、12,543.85 Hzの周波数を持つ最上部の128分音符「G」音符の場合、タイマー値は、同様にカウントした場合、319です。上記のすべての計算の詳細は、後で示すタイマーモードの特定の構成によって決まります。計算すると、この値は68645になり、16ビットタイマーの範囲を超えます。ただし、36分より下のノートを演奏する必要があったとしても、8に等しい最初に利用可能なタイマーディバイダーを入力できます。それにもかかわらず、12,543.85 Hzの周波数を持つ最上部の128分音符「G」音符の場合、タイマー値は、同様にカウントした場合、319です。上記のすべての計算の詳細は、後で示すタイマーモードの特定の構成によって決まります。計算すると、この値は68645になり、16ビットタイマーの範囲を超えます。ただし、36分より下のノートを演奏する必要があったとしても、8に等しい最初に利用可能なタイマーディバイダーを入力できます。それにもかかわらず、12,543.85 Hzの周波数を持つ最上部の128分音符「G」音符の場合、タイマー値は、同様にカウントした場合、319です。上記のすべての計算の詳細は、後で示すタイマーモードの特定の構成によって決まります。一番上の音を鳴らすことすらできないからです。それにもかかわらず、12,543.85 Hzの周波数を持つ最上部の128分音符「G」音符の場合、タイマー値は、同様にカウントされた場合、319です。上記のすべての計算の詳細は、後で示すタイマーモードの特定の構成によって決まります。一番上の音を鳴らすことすらできないからです。それにもかかわらず、12,543.85 Hzの周波数を持つ最上部の128分音符「G」音符の場合、タイマー値は、同様にカウントした場合、319です。上記のすべての計算の詳細は、後で示すタイマーモードの特定の構成によって決まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう少し重要な質問があります。ノート番号とタイマーのコードの関係を取得する方法は？ノートの頻度をその数で計算するためのよく知られた公式があります。また、上記の例に示すように、既知の周波数のタイマーコードは簡単に計算されます。ただし、12次のルートは、周波数の音符への依存性の式に表示されます。一般に、このような計算手順をコントローラーにロードすることは望ましくありません。一方、すべての音符のタイマーコードの配列を作成することも合理的ではありません。そして、私は次のことをすることに決めました。最初の12ノート（1オクターブ）のタイマーコードの配列を作成するだけで十分です。そして、次のオクターブのノートは、最初のオクターブのノートの周波数を2で順次乗算することによって取得する必要があります。または、同じことは、タイマーコードの値を2で順次除算することによって取得する必要があります。もう1つの便利な方法は、オクターブ番号が偶然にも右へのビット単位のシフト（ "）の操作で引数として機能し、2のべき乗による除算の操作として使用されることです。この演算子は2つの除数の累乗の指数（2による除算の数）を反映しているため、私はこの演算子を誤って選択しました。そして、これはオクターブ番号です。私のノートには、合計8オクターブが含まれています（最後のオクターブは不完全です）。 MIDIファイル内のノートは、1バイト、より正確には7ビットでエンコードされます。 MKでノートを演奏するには、上記のアイデアに従って、最初にオクターブ番号とオクターブ内のノート番号をノートコードを使用して計算する必要があります。この操作は、MIDIファイルを簡易形式に変換する段階で行われます。 8オクターブは3ビットでエンコードでき、1オクターブの12ノートは4ビットでエンコードできます。合計はノートはmidiファイルと同じ7ビットでエンコードされていますが、MKには便利な別の表現でしかありません。 16ビットは4ビットでエンコードでき、オクターブは12であるという事実により、未使用のバイトがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の8番目のビットは、ノートをオンまたはオフにするためのマーカーとして使用できます。 MKの場合、メロディの全会一致のため、ミュートされたノートに関する情報は冗長になります。メロディーで音符を直接変更すると、「ターンオフターンオン」ではなく、音符の「スイッチ」になります。また、一時停止が発生した場合は、「無音がオンになります」。これにより、未使用のバイトのセットから特別なバイトを選択でき、ノートをオフにする情報をまったく使用しません。このようなアイデアは、変換後のメロディーのサイズを節約できるという点で優れていますが、一般にモデルが複雑になります。すでにたくさんの記憶があるので、私はこの考えに従わなかった。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
midiファイルのメロディーノートに関する情報は、「interval-event-interval-event ...」ビューの対応するチャンネルのブロックに保存されます。変換された形式でも、まったく同じ原理が適用されます。上記のように、イベントを記録する（ノートを有効または無効にする）には、1バイトが使用されます。最初のビット（最上位ビット7）は、イベントのタイプをエンコードします。値「1」はノートオン、値「0」はノートオフです。次の3ビットはオクターブ番号をエンコードし、最下位の4ビットはオクターブのノート番号をエンコードします。時間間隔の記録にも1バイトが使用されます。元のmidi形式では、可変長形式がこれに使用されます。その小さな欠点は、7ビットのみが時間間隔（「ティック」の数）をエンコードし、8番目のビットが継続の兆候であることです。つまり、実際には1バイトで最大128ティックの間隔をエンコードできます。しかし、実際のメロディーと単純なメロディーのイベント間の時間間隔は128を超える場合がありますが、256を超えることはほとんどないため、可変長形式を放棄し、1バイトのコストがかかりました。最大256ティックの時間間隔をエンコードします。プロジェクトは四半期ごとに48ティック、または48 * 4 =サイクルごとに192ティックを使用するため、1バイトを使用して256/192 = 1期間の間隔をエンコードできます。（3）（1つの整数と1/3）サイクル結構です。次に、1バイトを使用して256/192 = 1期間の間隔をエンコードできます（3）（1つの整数と3分の1）クロックサイクル。次に、1バイトを使用して、256/192 = 1期間の間隔をエンコードできます（3）（1つの整数と3分の1）十分なタクト。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
midiファイルが変換されるネイティブフォーマットでは、サイズが16バイトの小さなヘッダーも適用しました。最初の14バイトにはメロディーの名前が含まれています。当然、名前は14文字を超えてはなりません。その後、スペースはゼロになります。次の最後のバイトは、MKにとって便利なビューでメロディーのテンポを反映しています。この値は変換段階で計算され、ペースに関与するMKタイマーを初期化するのに役立ちます。計算方法については、上記のいくつかの段落で説明しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
17バイト目からメロディーの内容が続きます。各奇数バイトは時間間隔に対応し、各偶数バイトはイベント（注）に対応します。最初のバイトは、メロディがmidiファイルの最初からメモで始まる場合、予備の休止なしでゼロになります。メロディの終わりの記号は、2バイト0xFFのラベルです。タスクには、マイクロコントローラーによるメロディーの周期的な再生が含まれます。ループのメロディーがリズムの点で調和のとれた音にするには、正しくループする必要があります。これを行うには、必要に応じて、最後の音符の後で、通常は最後の小節が満たされるまで、特定の長さを一時停止する必要があります。そのためには、対応するイベントをそらす必要があります。エンコーディングノートでは使用されないバイト0x0Fを使用しました。これは、最初のオクターブの16分音符をオフにすることに相当します。オクターブには12音符しかないので、上記の未使用バイトについてはすでに説明しました。したがって、このバイトは「サイレントノート」をエンコードします。この場合、情報の冗長性にもかかわらず、その上位ビットはサインオンまたはサインオフとしても機能します。このノートをmidiエディターで設定するために、最初または2番目のノート（いずれか）を取った。最初の36個のノートはモデルで使用されていないことを思い出させてください。したがって、メロディーを正しく完了するために必要に応じて1番目（または2番目）のノートが使用されるため、ループで演奏するときにリズムが損なわれることはありません。このノートをmidiエディターで設定するために、最初または2番目のノート（いずれか）を取った。最初の36個のノートはモデルで使用されていないことを思い出させてください。したがって、メロディーを正しく完了するために必要に応じて1番目（または2番目）のノートが使用されるため、ループで演奏するときにリズムが損なわれることはありません。このノートをmidiエディターで設定するために、最初または2番目のノート（いずれか）を取った。最初の36個のノートはモデルで使用されていないことを思い出させてください。したがって、メロディーを正しく完了するために必要に応じて1番目（または2番目）のノートが使用されるため、ループで演奏するときにリズムが損なわれることはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「Cakewalk Pro Audio 9」のエディターで作業を続け、任意のメロディーを作曲します。下の図は、インターネット上の写真から書き直したメロディーのメモです。ノートの画像は、「ピアノロール」とクラシックの2つのスタイルで表示されます。 1つ目は、コンピューターのマウスを使用してメロディーを作成および編集するのに非常に便利です。それが私が使うものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/-r/hy/lr-rhyphwp5xckftmq8fbwhlchc.png"><br>
<br>
<img src="https://habrastorage.org/webt/ot/qf/d7/otqfd7db-6wj0o9dscmg60tp5d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図からわかるように、最後に、適切な時間間隔で最も低い（最初の）ノートが無音のサインに適用され、サイクルを正しく編成します。また、メロディの冒頭では、タッチの存在を考慮して、最初の音符の前に4分の1のインデントがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エディターは、イベントを表形式で表示するモードを提供します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vy/gu/n1/vygun1nauiacc6-zjbq66whb7qg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図からわかるように、音楽プロジェクトで不要な操作を行うと時々発生するので、メモを取ることを除いて、イベントのリストに余分なものはありません。それでも、ノートに関連しない不要なイベントが何らかの理由でリストに含まれている場合は、Delキーを押して削除できます。ただし、変換の段階では、不要なイベントはすべて無視され、デルタ時間は「蓄積」されます。ちなみに、デバッグの段階でこの機能をプログラムに追加しました。ご想像のとおり、この表は各ノートのオンタイムと継続時間、および必要のない他のプロパティを反映しています。つまり、表の1行に2つのMIDIイベントが同時に表されます。ノートのオンとオフです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図のように、メロディを「midi 1」形式で保存します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l6/gx/uf/l6gxufg_2kmfge81godpmmhieki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
保存したファイルをHEXエディターで開きます。同じaviファイル（以前に書いたように）とは異なり、midiファイル内の数値のバイトは逆順ではなく、年功序列（ビッグエンディアン）に従って表示されることをすぐに規定する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/oi/cn/wjoicnlzwx4ixajswxz3m3_jj5i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この図では、必要なバイトのみをマーカーでマークしています。最初に、太字の赤いフレームが、それぞれ2バイトの3つのグループの輪郭を描きます。これはそれぞれ、MIDIフォーマットのタイプ（1）、チャネル数（2）、およびクォーターあたりのティック数（48）です。これらの3つの定数が変換プログラムのさらなる作業のために持っている必要があるのは、これらの値です。紫色の円弧は、2つのチャネルのそれぞれの始まりを示します。最初のチャネルでは、6バイトは灰色のフレームでマークされており、3バイトは青色のフレームで強調表示されています。これらの6バイトは、コードが0x51、コンテンツの長さが0x03バイトのメタイベント（マーカーマーカー0xFF）に関連しています。さらに3バイト-イベントの内容。このイベントは、メロディーのテンポをこれらの3バイトだけで青いフレームに設定します。スーパーの精度は重要ではないため、最後の下位バイトは安全に破棄できます。ファイル内のすべてのバイトの詳細な完全な説明は行いません。2番目のトラック（ノートのあるトラック）では、時間間隔の値が青いフレームで囲まれています。ちなみに、この特定の例では、最後から2番目の音符の場合を除いて、1バイトを超えませんでした。メロディの最後から2番目の音符（エンディングの追加の疑似音符を数える）は、小節の4分の3持続します。これは、48 * 3 = 144ティックで、128を超えます。可変長形式によれば、2バイトを使用する必要があります。また、変換された形式で時間間隔を表すために、値144は1バイトで簡単にエンコードされます。この特別なケースを二重の青いフレームで囲みました。ノートは緑色の枠で囲まれ、コードではありません。各ノートのボリュームは灰色の枠で囲まれています。すでに述べたように、ゼロボリュームはノートのミュート（リリース）の兆候であり、構成全体で1つのイベントがあります。ノートをオンにします。このイベントのコード0x90は黄色でマークされています。メロディが終わるまで、すべての音符の概要を説明しませんでした。唯一の例外は、128ティックのしきい値を超える単一の時間間隔の二重の青いフレームです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しますが、前述のように、midiファイルをMK用の独自の形式に変換するプログラムは、実際にはいくつかのmidiファイルのグループで動作し、出力でEEPROM用のイメージファイルを作成します。上記の例から変換されたメロディーの内容に関連するこのファイルのフラグメントを考えてみます。別のHEXエディターで開いてセクターごとに画像を表示し、注意を払っています。新しいメロディーはそれぞれ新しいセクターから始まります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9p/e5/h1/9pe5h1qaetdg-kjk-abaxvlk6am.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の行の最後のバイト（最初の16バイト）は、赤いフレームで囲まれ、メロディーのテンポを設定します。計算によると、値0xC1（193）はテンポ154、155、および156に当てはまります。このプロジェクトでは、先ほどのスクリーンショットで見たように、メロディのテンポを155 bpmに設定しました。最初のバイト（14番目まで）は、青いフレームで囲まれ、コンポジションの名前を決定します。この例では、「クラシック」です。 MKの場合、この情報は不必要です。HEXエディターでの方向付けにのみ必要です。ただし、ディスプレイを使用してMKでより複雑なプロジェクトを作成する場合、再生されたメロディの名前を表示することにより、この情報を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2行目（17バイト目）からメロディの内容が始まります。元のMIDIファイルと同様に、すべてのノートをペイントするのではなく、一部のみをペイントしました。青色で強調表示されている奇数バイトは時間間隔です。緑のフレームでマークされたバイトでさえ、それらのオン/オフの兆候を伴うノートです。たとえば、最初の2つの緑色のバイト0xB4と0x34は、コード0x34の同じノートを参照しており、バイトは1つの上位ビットのみが異なります。バイト0xB4（0b10110100）では、高位ビットは1であり、これはノートをオンにする兆候です。バイト0x34（0b00110100）では、高位ビットは0であり、ノートをオフにする兆候です。バイト0x34は、オクターブコード0b011およびオクターブ内のノートコード-0b0100のパラメーターでノートをエンコードしました。または、10進数形式では、それぞれ3と4。ゼロから数えないと、メロディーの最初の音は4オクターブに属し、5番目の音であることがわかります。ここでのオクターブの番号付けは、標準の番号付けを考慮せずに任意に選択されます。私の計算補助表Excelによると、合意されたノートは、midi形式のコード76（0x4C）のノート、つまりノートE6（6番目のミッドオクターブのノート“ e”）です。つまり、作曲はこのノートから始まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ミュージカルシーケンスでは、同じ音符が途切れることなく繰り返される特殊なケースに注意してください。この例では、一時停止のない隣接するすべてのノートが異なります。しかし、音符が途切れることなく繰り返されるメロディーがあります。つまり、1つをオフにしてから次のまったく同じノートをオンにするまでの時間間隔はゼロです。複雑な音楽の合成の特殊性のため、このようなシーケンスは、どのシンセサイザーでもおなじみに聞こえます。しかし、MKの場合、まとまりのある音になり、2つの同じ音の違いを聞くのが難しくなります。実際には、もちろん、MCで中間計算が行われるため、明確な合併はありませんが、それでも、この時間間隔は、1ティックの期間よりもはるかに短い可能性があります。このような特殊なケースでは、プログラムは変換フェーズにあり、このような組み合わせにぶつかると、1ティックの長さの音符の間に一時停止が導入され、同じ時間間隔で音符の左側にある音符の継続時間が短縮されます。 1ティックの最小「ギャップ」で十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
二重の青いフレームで、128を超える時間間隔（0x90）の値を丸で囲みました。この長さの可変長形式によると、midiファイルに2バイトを費やす必要がありました。緑色の円は、構成を揃えるために、同じ擬似ノートをオンとオフで囲んだバイトです。 MKプログラムは、これらのバイトを検出すると、それらを無音にすると解釈します。最後に、太字の青いフレームで囲まれた2つの0xFFバイトがメロディの終わりを示します。現在のメモリセクター内の後続のすべてのバイトの値は任意であり、無視されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力EEPROMイメージファイルの最初のセクターを検討してください。私がすでに書いたように、それはメロディーの始まりのセクターのアドレスのリストとして役立ちます。プログラムはエラーなしで8曲を正常にスキャンしました（執筆時点では、8曲を録音していました）。メロディーの数の値は、セクターの最後の512番目のバイトに記録されます。そして、セクターの最初からアドレスが書き込まれます。最初のメロディーの場合、アドレスは0x01で、これは2番目のセクター（最初から数えた場合は最初のセクター）に対応します。 3番目と4番目のメロディー（8つのうち2つ）は長くなり、1つのセクターに収まりませんでした。したがって、アドレスシーケンスにギャップが見られます。 64kBのメモリサイズを計算すると、127曲までしか録音できないため、アドレス指定用の1つのセクターで十分です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/fm/g-/t7fmg-97qcqphlojly3l8xcpnru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事に反映されているすべての予備的な見積もりと計算は、Excelで行いました。</font><font style="vertical-align: inherit;">以下のスクリーンショットは、結果のテーブルのスクリーンショットを示しています（デュアルウィンドウモード）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/31/cb/my/31cbmycwzmmfr_noks7sifxpaps.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/tm/1f/jntm1fp2sga5erx_xmtqq3bbhcy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下のスポイラーの下は、midiファイルをマイクロコントローラー用のファイルに変換するCプログラムのテキストです。</font><font style="vertical-align: inherit;">テキストから、デバッグに使用された余分な行を削除しました。</font><font style="vertical-align: inherit;">これまでのところ、プログラムは機能しており、コードを書く際に読みやすく、読み書きができるふりはしていません。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインファイル1.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPACE 1</span><font></font>
<font></font>
<span class="hljs-function">HANDLE <span class="hljs-title">openInputFile</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * filename)</span> </span>{
       <span class="hljs-keyword">return</span> CreateFile ( filename,      <span class="hljs-comment">// Open Two.txt.</span>
            GENERIC_READ,          <span class="hljs-comment">// Open for writing</span>
            <span class="hljs-number">0</span>,                      <span class="hljs-comment">// Do not share</span>
            <span class="hljs-literal">NULL</span>,                   <span class="hljs-comment">// No security</span>
            OPEN_ALWAYS,            <span class="hljs-comment">// Open or create</span>
            FILE_ATTRIBUTE_NORMAL,  <span class="hljs-comment">// Normal file</span>
            <span class="hljs-literal">NULL</span>);                  <span class="hljs-comment">// No template file       </span><font></font>
}<font></font>
<font></font>
<span class="hljs-function">HANDLE <span class="hljs-title">openOutputFile</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * filename)</span> </span>{
       <span class="hljs-keyword">return</span> CreateFile ( filename,      <span class="hljs-comment">// Open Two.txt.</span>
            GENERIC_WRITE,          <span class="hljs-comment">// Open for writing</span>
            <span class="hljs-number">0</span>,                      <span class="hljs-comment">// Do not share</span>
            <span class="hljs-literal">NULL</span>,                   <span class="hljs-comment">// No security</span>
            OPEN_ALWAYS,            <span class="hljs-comment">// Open or create</span>
            FILE_ATTRIBUTE_NORMAL,  <span class="hljs-comment">// Normal file</span>
            <span class="hljs-literal">NULL</span>);                  <span class="hljs-comment">// No template file       </span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">filepos</span><span class="hljs-params">(HANDLE f, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> p)</span></span>{<font></font>
	LONG LPos;<font></font>
	LPos = p;<font></font>
	SetFilePointer (f, LPos, <span class="hljs-literal">NULL</span>, FILE_BEGIN); <span class="hljs-comment">//FILE_CURRENT</span>
	<span class="hljs-comment">//https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-setfilepointer</span><font></font>
}<font></font>
<font></font>
DWORD wr;<font></font>
DWORD ww;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read32</span><span class="hljs-params">(HANDLE f)</span></span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> b3,b2,b1,b0;<font></font>
    ReadFile(f, &amp;b3, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);<font></font>
	ReadFile(f, &amp;b2, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);<font></font>
    ReadFile(f, &amp;b1, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);	<font></font>
    ReadFile(f, &amp;b0, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> b3&lt;&lt;<span class="hljs-number">24</span>|b2&lt;&lt;<span class="hljs-number">16</span>|b1&lt;&lt;<span class="hljs-number">8</span>|b0;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read24</span><span class="hljs-params">(HANDLE f)</span></span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> b2,b1,b0;<font></font>
	ReadFile(f, &amp;b2, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);<font></font>
    ReadFile(f, &amp;b1, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);	<font></font>
    ReadFile(f, &amp;b0, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> b2&lt;&lt;<span class="hljs-number">16</span>|b1&lt;&lt;<span class="hljs-number">8</span>|b0;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read16</span><span class="hljs-params">(HANDLE f)</span></span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> b1,b0;<font></font>
    ReadFile(f, &amp;b1, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);	<font></font>
    ReadFile(f, &amp;b0, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> b1&lt;&lt;<span class="hljs-number">8</span>|b0;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">read8</span><span class="hljs-params">(HANDLE f)</span></span>{
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> b0;<font></font>
    ReadFile(f, &amp;b0, <span class="hljs-number">1</span>, &amp;wr, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> b0;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">message</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> e)</span></span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error %d: "</span>,e);
    <span class="hljs-keyword">switch</span>(e){
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// -   -;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"In track0 event is not FF\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// -  127</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Len of FF &gt;127\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">//  ;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Midi is incorrect\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">//   ;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Delta&gt;255\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-comment">//    RPN  NRPN;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"RPN or NRPN is detected\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: <span class="hljs-comment">//   ;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Note in 1...35 range\n"</span>);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: <span class="hljs-comment">//    ;</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Long of name of midi file &gt;18\n"</span>);
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    system(<span class="hljs-string">"PAUSE"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{<font></font>
    HANDLE in;<font></font>
	HANDLE out;<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i,j;
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> inpos;
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> outpos=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> byte; <span class="hljs-comment">// ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> byte1; <span class="hljs-comment">//  1  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> byte2; <span class="hljs-comment">//  2  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> status; <span class="hljs-comment">//- ( );</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> sz0; <span class="hljs-comment">// -;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> bsz0; <span class="hljs-comment">//    -;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> <span class="hljs-keyword">int</span> format, ntrks, ppqn; <span class="hljs-comment">//  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> bsz1; <span class="hljs-comment">//    ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> bpm; <span class="hljs-comment">// ( .  );</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> time=<span class="hljs-number">0</span>; <span class="hljs-comment">//    ( );</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> scale; <span class="hljs-comment">//    ,  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> oct; <span class="hljs-comment">//    ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> nt; <span class="hljs-comment">// ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> outnote; <span class="hljs-comment">//      ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> prnote=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> tdt; <span class="hljs-comment">// ()   ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> dt; <span class="hljs-comment">//    ( );</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> outdelta=<span class="hljs-number">0</span>; <span class="hljs-comment">//    ( );</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> prdelta=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
	<span class="hljs-keyword">char</span> fullname[<span class="hljs-number">30</span>]; <span class="hljs-comment">//    ;</span>
	<span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>]; <span class="hljs-comment">// ;</span>
	WIN32_FIND_DATA fld; <span class="hljs-comment">//   mid;</span><font></font>
	HANDLE hf;<font></font>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> <span class="hljs-keyword">int</span> csz; <span class="hljs-comment">//  ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> nfile=<span class="hljs-number">0</span>; <span class="hljs-comment">// ;</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> adr[<span class="hljs-number">128</span>]; <span class="hljs-comment">//    ;</span><font></font>
	<font></font>
	out=openOutputFile(<span class="hljs-string">"IMAGE.out"</span>);<font></font>
	outpos=<span class="hljs-number">512</span>; <span class="hljs-comment">//   ;</span><font></font>
    filepos(out,outpos);<font></font>
	hf=FindFirstFile(<span class="hljs-string">".\\midi\\*.mid"</span>,&amp;fld);
	<span class="hljs-keyword">do</span>{
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n***** %s *****\n"</span>,fld.cFileName);
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(fld.cFileName)&gt;<span class="hljs-number">18</span>){ <span class="hljs-comment">//   ;</span>
            message(<span class="hljs-number">7</span>);<font></font>
        }<font></font>
        <span class="hljs-built_in">sprintf</span>(name,<span class="hljs-string">"%s"</span>,fld.cFileName);<font></font>
        name[<span class="hljs-built_in">strlen</span>(fld.cFileName)<span class="hljs-number">-4</span>]=<span class="hljs-number">0</span>; <span class="hljs-comment">// ;</span>
        <span class="hljs-built_in">sprintf</span>(fullname,<span class="hljs-string">".\\midi\\%s"</span>,fld.cFileName); <span class="hljs-comment">//    ;</span>
        WriteFile(out, name, <span class="hljs-built_in">strlen</span>(name), &amp;ww, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//    ;</span>
        in=openInputFile(fullname); <span class="hljs-comment">//    ;</span><font></font>
        <font></font>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"process.cpp"</span> <span class="hljs-comment">//     ;</span></span><font></font>
        <font></font>
    	outpos+=((csz/<span class="hljs-number">512</span>)+<span class="hljs-number">1</span>)*<span class="hljs-number">512</span>; <span class="hljs-comment">//    ;</span>
    	adr[nfile]=(outpos/<span class="hljs-number">512</span>)-((csz/<span class="hljs-number">512</span>)+<span class="hljs-number">1</span>); <span class="hljs-comment">//  ()   ;</span><font></font>
    	filepos(out,outpos);<font></font>
    	CloseHandle(in);<font></font>
    	nfile+=<span class="hljs-number">1</span>;<font></font>
	}<span class="hljs-keyword">while</span>(FindNextFile(hf,&amp;fld)); <span class="hljs-comment">//   ,    ;</span><font></font>
    FindClose(hf);<font></font>
    WriteFile(out, &amp;outnote, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
    outpos=<span class="hljs-number">0</span>; <span class="hljs-comment">//   ;</span><font></font>
    filepos(out,outpos);<font></font>
    WriteFile(out, adr, nfile, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
    outpos=<span class="hljs-number">511</span>; <span class="hljs-comment">//  ;</span><font></font>
    filepos(out,outpos);<font></font>
    WriteFile(out, &amp;nfile, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
	CloseHandle(out);<font></font>
	system(<span class="hljs-string">"PAUSE"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process.cpp添付ファイル</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">time=<span class="hljs-number">0</span>;<font></font>
inpos=<span class="hljs-number">8</span>;
<span class="hljs-comment">//  ;</span><font></font>
filepos(in,inpos);<font></font>
format=read16(in);<font></font>
ntrks=read16(in);<font></font>
ppqn=read16(in);<font></font>
<span class="hljs-keyword">if</span>(format!=<span class="hljs-number">1</span> || ntrks!=<span class="hljs-number">2</span> || ppqn!=<span class="hljs-number">48</span>){<font></font>
    message(<span class="hljs-number">3</span>);<font></font>
}<font></font>
inpos+=<span class="hljs-number">10</span>;<font></font>
filepos(in,inpos);<font></font>
<font></font>
<span class="hljs-comment">//    -;</span><font></font>
bsz0=read32(in);<font></font>
inpos+=<span class="hljs-number">4</span>;
<span class="hljs-keyword">while</span>(inpos&lt;<span class="hljs-number">22</span>+bsz0){ <span class="hljs-comment">//      ;</span><font></font>
	tdt=read8(in);<font></font>
	inpos+=<span class="hljs-number">1</span>;
	<span class="hljs-comment">//   ;</span>
	dt=(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(tdt&amp;<span class="hljs-number">0x7F</span>);
	<span class="hljs-keyword">while</span>(tdt&amp;<span class="hljs-number">0x80</span>){<font></font>
        tdt=read8(in);<font></font>
        inpos+=<span class="hljs-number">1</span>;<font></font>
        dt=(dt&lt;&lt;<span class="hljs-number">7</span>)|(tdt&amp;<span class="hljs-number">0x7F</span>);<font></font>
    }<font></font>
	byte=read8(in);<font></font>
	inpos+=<span class="hljs-number">1</span>;
	<span class="hljs-keyword">if</span>(byte==<span class="hljs-number">0xFF</span>){ <span class="hljs-comment">//  ,  -    -;</span>
        byte=read8(in); <span class="hljs-comment">//  -;</span>
        sz0=read8(in); <span class="hljs-comment">//  , ,     127 ( );</span>
        <span class="hljs-keyword">if</span>(sz0&amp;<span class="hljs-number">0x80</span>){<font></font>
            message(<span class="hljs-number">2</span>);<font></font>
        }<font></font>
        inpos+=<span class="hljs-number">2</span>;
        <span class="hljs-keyword">switch</span>(byte){
            <span class="hljs-keyword">case</span> <span class="hljs-number">0x51</span>: <span class="hljs-comment">//   "Set Tempo";</span><font></font>
                bpm=read24(in);<font></font>
                scale=<span class="hljs-number">256</span>-(bpm/(ppqn*<span class="hljs-number">128</span>));
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"scale=%d\n"</span>,scale);<font></font>
                filepos(out,outpos+<span class="hljs-number">15</span>); <span class="hljs-comment">// ;</span>
                WriteFile(out, &amp;scale, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
                csz=<span class="hljs-number">16</span>;
            <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
        inpos+=sz0;<font></font>
        filepos(in,inpos); <span class="hljs-comment">// ,     0x51;</span>
    }<span class="hljs-keyword">else</span>{<font></font>
        message(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    ;</span>
outdelta=<span class="hljs-number">0</span>;<font></font>
inpos+=<span class="hljs-number">4</span>;<font></font>
filepos(in,inpos);<font></font>
bsz1=read32(in);<font></font>
inpos+=<span class="hljs-number">4</span>;
<span class="hljs-keyword">while</span>(inpos&lt;<span class="hljs-number">30</span>+bsz0+bsz1){<font></font>
    tdt=read8(in);<font></font>
	inpos+=<span class="hljs-number">1</span>;
	<span class="hljs-comment">//   ;</span>
	dt=(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(tdt&amp;<span class="hljs-number">0x7F</span>);
	<span class="hljs-keyword">while</span>(tdt&amp;<span class="hljs-number">0x80</span>){<font></font>
        tdt=read8(in);<font></font>
        inpos+=<span class="hljs-number">1</span>;<font></font>
        dt=(dt&lt;&lt;<span class="hljs-number">7</span>)|(tdt&amp;<span class="hljs-number">0x7F</span>);<font></font>
    }<font></font>
    outdelta+=dt; <span class="hljs-comment">//  ;</span>
    <span class="hljs-comment">// ,      , ;</span>
    time+=dt; <span class="hljs-comment">//  ;</span>
	byte=read8(in); <span class="hljs-comment">//    ,  ;</span>
	inpos+=<span class="hljs-number">1</span>;
	<span class="hljs-keyword">if</span>(byte&amp;<span class="hljs-number">0x80</span>){ <span class="hljs-comment">//  ;</span>
		status=byte; <span class="hljs-comment">// ;</span>
		<span class="hljs-keyword">if</span>(byte==<span class="hljs-number">0xFF</span>){ <span class="hljs-comment">//   -;</span>
			byte=read8(in); <span class="hljs-comment">//    ,    ;</span><font></font>
            sz0=read8(in);<font></font>
            inpos+=(<span class="hljs-number">2</span>+sz0);<font></font>
            filepos(in,inpos);<font></font>
		}<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//    ;</span><font></font>
			byte1=read8(in);<font></font>
			inpos+=<span class="hljs-number">1</span>;<font></font>
		}<font></font>
	}<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//    ,        ;</span><font></font>
		byte1=byte;	<font></font>
	}<font></font>
    <span class="hljs-keyword">switch</span>(status&amp;<span class="hljs-number">0xF0</span>){ <span class="hljs-comment">// ,      ;</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xF0</span>: <span class="hljs-comment">//   ,  -;</span>
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0x80</span>: <span class="hljs-comment">// ;</span>
			byte2=read8(in); <span class="hljs-comment">//     ( );</span>
            inpos+=<span class="hljs-number">1</span>; <span class="hljs-comment">//     ,    ;</span>
            <span class="hljs-keyword">if</span>(byte1&gt;<span class="hljs-number">1</span>&amp;&amp;byte1&lt;<span class="hljs-number">36</span>){ <span class="hljs-comment">//         ;</span>
                message(<span class="hljs-number">6</span>);<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(byte1&gt;<span class="hljs-number">1</span>){ <span class="hljs-comment">// ;</span>
                oct=((byte1<span class="hljs-number">-36</span>)/<span class="hljs-number">12</span>); <span class="hljs-comment">//  ;</span>
                nt=(byte1<span class="hljs-number">-36</span>)%<span class="hljs-number">12</span>; <span class="hljs-comment">//    ;</span>
            }<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//   ;</span>
                oct=<span class="hljs-number">0</span>;<font></font>
                nt=<span class="hljs-number">15</span>;<font></font>
            }<font></font>
            outnote=(oct&lt;&lt;<span class="hljs-number">4</span>)|nt; <span class="hljs-comment">//  ;</span><font></font>
            prnote=outnote;<font></font>
            prdelta=outdelta;<font></font>
            <span class="hljs-keyword">if</span>(outdelta&gt;<span class="hljs-number">255</span>){ <span class="hljs-comment">//     255 (  );</span>
                message(<span class="hljs-number">4</span>);<font></font>
            }<font></font>
            WriteFile(out, &amp;outdelta, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
            WriteFile(out, &amp;outnote, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
            csz+=<span class="hljs-number">2</span>;<font></font>
            outdelta=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0x90</span>: <span class="hljs-comment">//   ;</span>
			byte2=read8(in); <span class="hljs-comment">//    ( );</span>
            inpos+=<span class="hljs-number">1</span>; <span class="hljs-comment">//     ,    ;</span>
            <span class="hljs-keyword">if</span>(byte1&gt;<span class="hljs-number">1</span>&amp;&amp;byte1&lt;<span class="hljs-number">36</span>){ <span class="hljs-comment">//         ;</span>
                message(<span class="hljs-number">6</span>);<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(byte1&gt;<span class="hljs-number">1</span>){ <span class="hljs-comment">// ;</span>
                oct=((byte1<span class="hljs-number">-36</span>)/<span class="hljs-number">12</span>); <span class="hljs-comment">//  ;</span>
                nt=(byte1<span class="hljs-number">-36</span>)%<span class="hljs-number">12</span>; <span class="hljs-comment">//    ;</span>
            }<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//   ;</span>
                oct=<span class="hljs-number">0</span>;<font></font>
                nt=<span class="hljs-number">15</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(byte2){ <span class="hljs-comment">//  ,   ;</span>
				outnote=<span class="hljs-number">0x80</span>|(oct&lt;&lt;<span class="hljs-number">4</span>)|nt; <span class="hljs-comment">//  = 1;</span>
				<span class="hljs-comment">//   ;</span>
				<span class="hljs-keyword">if</span>(!outdelta &amp;&amp; (outnote&amp;<span class="hljs-number">0x7F</span>)==prnote){ <span class="hljs-comment">//     ;</span>
                    prdelta-=SPACE; <span class="hljs-comment">// -;</span>
                    filepos(out,outpos+csz<span class="hljs-number">-2</span>); <span class="hljs-comment">//    ;</span>
                    WriteFile(out, &amp;prdelta, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// ;</span><font></font>
                    filepos(out,outpos+csz);<font></font>
                    outdelta=SPACE; <span class="hljs-comment">//  -  ;</span><font></font>
                }<font></font>
			}<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//  ,    ;</span>
				outnote=(oct&lt;&lt;<span class="hljs-number">4</span>)|nt;<font></font>
				prnote=outnote; <span class="hljs-comment">//  ;</span>
				prdelta=outdelta; <span class="hljs-comment">//  -;</span><font></font>
			}<font></font>
			<span class="hljs-keyword">if</span>(outdelta&gt;<span class="hljs-number">255</span>){ <span class="hljs-comment">//   -    ;</span>
                message(<span class="hljs-number">4</span>);<font></font>
            }<font></font>
			WriteFile(out, &amp;outdelta, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
			WriteFile(out, &amp;outnote, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
			csz+=<span class="hljs-number">2</span>;<font></font>
			outdelta=<span class="hljs-number">0</span>; <span class="hljs-comment">// -   ;</span>
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">//   () ;</span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xA0</span>: <span class="hljs-comment">// ;</span><font></font>
			byte2=read8(in);<font></font>
            inpos+=<span class="hljs-number">1</span>;
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xB0</span>: <span class="hljs-comment">//   ;</span>
            <span class="hljs-keyword">if</span>(byte1&gt;=<span class="hljs-number">98</span>&amp;&amp;byte1&gt;=<span class="hljs-number">101</span>){ <span class="hljs-comment">//     NRPN  RPN;</span>
                message(<span class="hljs-number">5</span>); <span class="hljs-comment">//  ;</span><font></font>
            }<font></font>
			byte2=read8(in);<font></font>
            inpos+=<span class="hljs-number">1</span>;
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xC0</span>: <span class="hljs-comment">//  (.  );</span>
            <span class="hljs-comment">// , ,    ;</span>
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xD0</span>: <span class="hljs-comment">//;</span>
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0xE0</span>: <span class="hljs-comment">// ;</span><font></font>
			byte2=read8(in);<font></font>
            inpos+=<span class="hljs-number">1</span>;
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>: <span class="hljs-comment">//  (   );</span>
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
}<font></font>
<span class="hljs-comment">//     0xFFFF,    ;</span>
outdelta=<span class="hljs-number">255</span>;<font></font>
outnote=<span class="hljs-number">255</span>;<font></font>
WriteFile(out, &amp;outdelta, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
WriteFile(out, &amp;outnote, <span class="hljs-number">1</span>, &amp;ww, <span class="hljs-literal">NULL</span>);<font></font>
csz+=<span class="hljs-number">2</span>;
<span class="hljs-comment">//   ,     ;</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Length: %i (%i:%02i)\n"</span>,time,time/<span class="hljs-number">192</span>,time%<span class="hljs-number">192</span>);
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、MKのプログラムの基本部分は非常に単純です。</font><font style="vertical-align: inherit;">その実装のオプションの1つ、より正確には、その主要部分を検討してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノートの生成に使用されるタイマー1は、次のように構成されています。</font><font style="vertical-align: inherit;">ノートを有効または無効にするには、それぞれ次の置換を使用します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ENT1 TCCR1B=0x09;TCCR1A=0x40</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DIST1 TCCR1B=0x00;TCCR1A=0x00;PORTB.1=0</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タイマーを開始する前に、OCR1Aレジスタに、再生される周波数に対応する16ビット値を割り当てる必要があります。これは後で示されます。タイマーがオンになると、TCCR1Bレジスタは「波形生成モード」にタイマー分周器が1に割り当てられ、TCCR1Aレジスタは「OC1Aをコンペアマッチでトグル」に設定されます。この場合、MK「OC1A」の特別に指定された出力から信号が削除されます。 SMDパッケージのATmega8では、これはピン13で、PORTB.1と同じです。タイマーがオフになると、両方のレジスタがリセットされ、PORTB.1の出力が強制的にゼロになります。これは、沈黙中に、ULFの入力にとって望ましくない一定電圧の出力を防ぐために必要です。ただし、回路にコンデンサを配置できますが、プログラムで出力を無効にすることもできます。次の場合、この端子に定電圧が発生する可能性があります信号の対応する位相の瞬間にノートがオフになり、これが50％の場合です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のオクターブの12音のタイマー値の配列を作成します。</font><font style="vertical-align: inherit;">これらの値は事前に計算されています。</font></font><br>
<br>
<pre><code class="cpp hljs">freq[]={<span class="hljs-number">61156</span>,<span class="hljs-number">57724</span>,<span class="hljs-number">54484</span>,<span class="hljs-number">51426</span>,<span class="hljs-number">48540</span>,<span class="hljs-number">45815</span>,<span class="hljs-number">43244</span>,<span class="hljs-number">40817</span>,<span class="hljs-number">38526</span>,<span class="hljs-number">36364</span>,<span class="hljs-number">34323</span>,<span class="hljs-number">32396</span>};
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のオクターブのノートは、私が言ったように、2度で割ることによって得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タイマー0の設定はさらに簡単です。</font><font style="vertical-align: inherit;">それは常にオーバーフロー割り込みで動作し、毎回メロディーのテンポに対応する値で新たに初期化されます。</font><font style="vertical-align: inherit;">タイマー分周器は5で、TCCR0 = 0x05です。</font><font style="vertical-align: inherit;">このタイマーに基づいて、メロディーのチック（時間）をカウントする仮想タイマーが作成されます。</font><font style="vertical-align: inherit;">このタイマーの応答の処理は、メインプログラムサイクルに配置されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タイマ0割り込み機能は以下の通りです。</font></font><br>
<br>
<pre><code class="cpp hljs">interrupt [TIM0_OVF] <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">timer0_ovf_isr</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>{
    <span class="hljs-keyword">if</span>(ent01){<font></font>
		vt01+=<span class="hljs-number">1</span>;<font></font>
    }<font></font>
    TCNT0=top0;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、変数ent01は、仮想タイマーのアクティブ化を担当します。</font><font style="vertical-align: inherit;">この変数により、必要に応じてオンまたはオフにできます。</font><font style="vertical-align: inherit;">vt01変数は、仮想タイマーのカウント可能な主要変数です。</font><font style="vertical-align: inherit;">TCNT0 = top0の行は、タイマー0を目的の値top0に初期化することを示しています。これは、メロディを再生する前にタイトルから読み取られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
演奏されるメロディの番号は、変数almに対応します。</font><font style="vertical-align: inherit;">複製開始の旗でもあります。</font><font style="vertical-align: inherit;">彼女は、タスクに応じて、いずれかの方法でメロディー番号を割り当てる必要があります。</font><font style="vertical-align: inherit;">その後、メインサイクルの次のブロックがアクティブになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span>(alm){ <span class="hljs-comment">//     ;</span>
        adr=eepr(alm<span class="hljs-number">-1</span>)&lt;&lt;<span class="hljs-number">9</span>; <span class="hljs-comment">//     (&lt;&lt;9    512);</span>
        adr+=<span class="hljs-number">15</span>; <span class="hljs-comment">//   ,      ;</span>
        top0=eepr(adr); <span class="hljs-comment">//  ;</span>
        adr+=<span class="hljs-number">1</span>; <span class="hljs-comment">//     ;</span>
        adr0=adr; <span class="hljs-comment">//      (  );</span>
        top01=eepr(adr); <span class="hljs-comment">//      " "  ;</span>
        adr+=<span class="hljs-number">1</span>; <span class="hljs-comment">//   ;</span>
        note=eepr(adr); <span class="hljs-comment">// ;</span>
        adr+=<span class="hljs-number">1</span>; <span class="hljs-comment">//    -;</span>
        vt01=<span class="hljs-number">0</span>; <span class="hljs-comment">//    ;</span>
        ent01=<span class="hljs-number">1</span>; <span class="hljs-comment">//  ; </span>
        TCNT0=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
        alm=<span class="hljs-number">0</span>; <span class="hljs-comment">//        ,   ;</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノートからノートへの切り替えは、メインループに配置された仮想タイマーの処理ユニットで行われます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span>(vt01&gt;=top01){ <span class="hljs-comment">//   ,    ;</span>
        vt01=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
        <span class="hljs-keyword">if</span>(note&amp;<span class="hljs-number">0x80</span>){ <span class="hljs-comment">//     "";</span>
            nt=note&amp;<span class="hljs-number">15</span>; <span class="hljs-comment">//    ;</span>
            oct=(note&amp;<span class="hljs-number">0x7F</span>)&gt;&gt;<span class="hljs-number">4</span>; <span class="hljs-comment">//  ;</span>
            <span class="hljs-keyword">if</span>(nt!=<span class="hljs-number">15</span>){ <span class="hljs-comment">//       15,   ;</span>
                OCR1A=freq[nt]&gt;&gt;oct; <span class="hljs-comment">//     ;</span>
                <span class="hljs-comment">//         ;</span>
                ENT1; <span class="hljs-comment">// ;</span>
            }<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//  " "   ;</span>
                DIST1; <span class="hljs-comment">// ;</span><font></font>
            }  <font></font>
        }<span class="hljs-keyword">else</span>{ <span class="hljs-comment">//     "";</span>
            DIST1; <span class="hljs-comment">// ;</span><font></font>
        }<font></font>
        top01=eepr(adr); <span class="hljs-comment">//      " ";</span>
        adr+=<span class="hljs-number">1</span>; <span class="hljs-comment">//   ;</span>
        note=eepr(adr); <span class="hljs-comment">//   ;</span>
        adr+=<span class="hljs-number">1</span>; <span class="hljs-comment">// ;</span>
        <span class="hljs-keyword">if</span>(note==<span class="hljs-number">255</span> &amp;&amp; top01==<span class="hljs-number">255</span>){ <span class="hljs-comment">//      ;</span>
            top01=eepr(adr0); <span class="hljs-comment">//   ,   ;</span>
            note=eepr(adr0+<span class="hljs-number">1</span>); <span class="hljs-comment">//   ;</span>
            adr=adr0+<span class="hljs-number">2</span>; <span class="hljs-comment">//   ;</span><font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムテキストのコメントから、すべてが非常に明確で理解できるはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メロディーを停止するには、次のメインループの挿入を使用します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span>(stop){ <span class="hljs-comment">//  ;</span>
            DIST1; <span class="hljs-comment">//  ;</span>
            ent01=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span>
            vt01=<span class="hljs-number">0</span>; <span class="hljs-comment">//  ;</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メロディの再生の実装について少し注意があります。マイクロコントローラーは、新しい各ノートの開始前に、ノートの読み取りバイトをタイマー値に変換するために少しの時間を費やします。今回は実際に判明したように、比較的小さく、再生の品質には影響しません。しかし、私はこの作戦が目に見えないままであることを疑っていました。この場合、各ノートの前に余分なポーズが表示され、メロディーのリズムが崩れます。しかし、この問題も解決可能です。現在の音が鳴っている間に、次の音のタイマー値を事前に計算しておけば十分です。この手順は、特別に指定されたフラグを使用して、メインプログラムループの仮想タイマーの処理とは別に実行する必要があります。計算時間が最短音の演奏時間を超えることはほとんどないため、そのような決定は適切です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プログラムのテストに移りましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のコードフラグメントに加えて、MKプログラムにボタン処理関数を追加しました。この関数を使用して、特定のメロディの包含または非アクティブ化を制御します。 EEPROMは、ソフトウェアレベルで実装されるI2Cバスを介してMKに接続されます。プロジェクトは、「CodeWizardAVR」とともに「CodeVisionAVR」の助けを借りて行われました。 MKをピン13からディバイダーを介してPCサウンドカードに出力し、メロディーのサウンドをサウンドエディターに録音します。以前の記事の1つで説明したファームウェアを使用して、EEPROMメモリをフラッシュしました。画像ファイルのすべてのバイトが有用であるとは限らないため、メモリファームウェアは、記録時間とチップリソースを節約するために、（メロディーの最後のマーカーまで）有用なバイトでのみ実装できます。これを行うには、別のプログラムを作成するか、または変換中にバイトをチップに直接書き込み、メインプログラムに追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8つのメロディーには3つのテストがあります。それを使って、周波数範囲を耳で評価したり、同一のノートをマージした音、最短の音、クイックトランジションなどを評価したりします。同じノートをマージすると、実際には1ティックのポーズで聞こえ、マージの最初のノートのティックは1ティック少なくなることを思い出してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストチューンの1つは、最初から最後までの一連のノートで、4分の1の持続時間と40 bpmのメロディーテンポです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d7/sr/hx/d7srhxannedgrv63owftqzeaf7k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この状況では、1つの音が1秒より少し長く聞こえるため、音の全範囲がどのように聞こえるかを詳細に聞くことができます。</font><font style="vertical-align: inherit;">オーディオエディター「Adobe Audition」の周波数スペクトルでは、対応するのこぎり波により、主要な周波数成分とその高次高調波が観測されます。</font><font style="vertical-align: inherit;">そして、ノート番号と周波数の間の対数関係は印象的です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/_2/xn/sn_2xnmlyxsmmfo23beniaqvzki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間間隔を分析すると、連続する音符間の実際の一時停止は平均して約145サンプル（オーディオ録音のサンプリング周波数44100 Hzで）であり、約3 msであることがはっきりとわかります。</font><font style="vertical-align: inherit;">これは、MKが必要な計算を実行する時間です。</font><font style="vertical-align: inherit;">これらの挿入は、各ノートの前に定期的に存在します。</font><font style="vertical-align: inherit;">これはそれほど重要ではありませんが、この情報はより独創的でより正確であるため、サンプルの意味を具体的に書きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ue/t6/pg/uet6pgd-e0iac2m2imj3m4fa5o4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、120 bpmの平均メロディーテンポでの1ティックの長さは約10 msです。したがって、原則として、2つの同一の音符が一時停止することなく次々に移動する場合、1ティックで同じ修正を導入しないことが可能です。音符の間に定期的に3ミリ秒挿入するだけで十分だと思います。メロディーを聴いているとき、これらの通常の挿入はまったく目立たず、メロディーは均一に聞こえます。したがって、現在のノートの再生中に次のノートのタイマー値を計算する必要は特にありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンポが200 bpmの別のテストメロディーには、ミドルレンジの同じ1/32音符が途切れることなく連続して含まれています。この場合、処理後、それらの間の再生中に1ティックの一時停止があり、この速いペースでは、記録された信号の310サンプル（約6 ms）です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/on/m_/msonm__-e7svpb38fq22xhul7dm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、このポーズの長さは信号の周期に匹敵し、メロディーのテンポが高いことを示しています。</font><font style="vertical-align: inherit;">そして、その音はトリルに似ています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則としてこれで終わりです。</font><font style="vertical-align: inherit;">装置の結果には満足しました。すべての期待を超えました。</font><font style="vertical-align: inherit;">ほとんどの場合、MIDIフォーマットの研究と変換のためのプログラムのデバッグに専念しました。</font><font style="vertical-align: inherit;">以下の記事の1つでも、MIDIに関連するトピックに専念します。このトピックでは、他の興味深いアプリケーションでのこのフォーマットの適用について説明します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454498/index.html">アスタリスク付きのタスク：Twitter Mantis-E0の例で電磁石を収集します</a></li>
<li><a href="../ja454500/index.html">ダグラスエンゲルバート：「人間の知性の強化：概念フレームワーク」（ステップ2）</a></li>
<li><a href="../ja454506/index.html">Entropic-Node.js用の新しい分散パッケージレジストリ</a></li>
<li><a href="../ja454508/index.html">デスクトップアプリケーションの.NET Coreへの移植</a></li>
<li><a href="../ja454512/index.html">チャールズウェザリーとの朝食レポート、プログラマーのためのカルトブックエチュードの著者</a></li>
<li><a href="../ja454516/index.html">200ルーブルの良いテキストを取得する方法</a></li>
<li><a href="../ja454518/index.html">Wasmer：WebAssemblyコードを実行するための最速のGoライブラリ</a></li>
<li><a href="../ja454520/index.html">クリーンなJavaScriptコードを書くためのガイドライン</a></li>
<li><a href="../ja454522/index.html">Node.js：コンテナーで実行されているアプリケーションで利用可能なメモリの管理</a></li>
<li><a href="../ja454524/index.html">ヘッドバンド修理プロのサムスンレベル</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>