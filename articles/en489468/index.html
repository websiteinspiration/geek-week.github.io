<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÇüèº üöç ü§º Simple Slack App for Publishing Content from Google Sheets üíò üåÖ üë©üèø‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We love to try new things, and therefore often share links to interesting information from the world of IT and programming with our colleagues. We are...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Simple Slack App for Publishing Content from Google Sheets</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489468/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We love to try new things, and therefore often share links to interesting information from the world of IT and programming with our colleagues. We are long-standing users of slack and for such links we have a separate educational channel where everyone can find something interesting for themselves. But since we are ordinary people, periodically in the heat of work, we forget that we need to share these links, and the activity in the channel fades, although many of us have something to share.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We faced an interesting task of developing a ‚Äúbot‚Äù that could automatically take pre-collected information and share links to it on a regular basis. </font><font style="vertical-align: inherit;">We were looking for a ready-made solution on the Internet, and now it has appeared </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an integration of zapier and slack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gb/zc/el/gbzcelbfefmw2trwii1temk6f2a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, we did not find such integration before and decided to write our own small bicycle. </font><font style="vertical-align: inherit;">Below we will describe how exactly we did it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When thinking about the problem, the following solution came to my mind: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javascript code that receives information about relevant useful links from the google table and sends it to Slack. </font><font style="vertical-align: inherit;">Calling a script from the first item on a schedule using cron. </font><font style="vertical-align: inherit;">Let's start in order.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting a token for Slack.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is simple here and it has been repeatedly described in other articles, so I will give only a brief description. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two options: make your own Slack application or use legacy tokens, the first option is a bit more complicated, but it is recommended by Slack, the second one is more simple and quite suitable for our needs, because of its simplicity we will choose it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We open a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link to generate a new token</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and create a new token for the desired workspace (do not forget to copy it, the token is issued once). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/fw/bq/bufwbqnmxbfoliu35xk_lky8gtm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, when implementing code that interacts with the Slack API and Google Sheets, we will be able to use this token for its intended purpose. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to get the token for Google Sheets. First, open </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js Quickstart for Google Sheets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and enable the Google Sheets API. </font><font style="vertical-align: inherit;">Then we copy the code index.js from the example and execute it, go through the authorization process and get the credentials in the file, which are useful for use with our script.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script implementation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now is the time to start developing a script to publish messages from Google Sheets to Slack. </font><font style="vertical-align: inherit;">The full script code can be found by clicking on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we will analyze the part of the code that sends messages to the slack channel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This happens by calling the Slack REST API.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> post = <span class="hljs-keyword">async</span> (text, channel = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CHANNEL</span> <span class="hljs-attr">ID</span>&gt;</span>) =&gt; {</span><font></font><span class="xml">
  const uri = `https://slack.com/api/chat.postMessage?token=${SLACK_AUTH_TOKEN}&amp;channel=${channel}&amp;text=${text}`;</span><font></font><span class="xml">
  const result = await fetch(encodeURI(uri), {</span><font></font><span class="xml">
    headers: {</span><font></font><span class="xml">
      'Content-Type': 'application/json',</span><font></font><span class="xml">
    },</span><font></font><span class="xml">
    method: 'POST',</span><font></font><span class="xml">
    body: JSON.stringify({</span><font></font><span class="xml">
      channel,</span><font></font><span class="xml">
      text,</span><font></font><span class="xml">
      as_user: true</span><font></font><span class="xml">
    })</span><font></font><span class="xml">
  });</span><font></font><span class="xml">
</span><font></font><span class="xml">
  await result.json();</span><font></font><span class="xml">
};</span><font></font><span class="xml">
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For authorization in the Google API, two functions are used (authorize, getNewToken), the code of which is taken from Node.js Quickstart, we will not dwell on them in detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next interesting block of code is getting information to send from Google spreadsheets, this is done using the following function:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> getMessageAndPost = <span class="hljs-keyword">async</span> (auth, spreadsheetId = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ID</span>  <span class="hljs-attr">Google</span> &gt;</span>) =&gt; {</span><font></font><span class="xml">
  const sheets = google.sheets({ version: 'v4', auth });</span><font></font><span class="xml">
  sheets.spreadsheets.values.get({</span><font></font><span class="xml">
    spreadsheetId,</span><font></font><span class="xml">
    range: 'Sheet1!A1:B999',</span><font></font><span class="xml">
  }, async (err, res) =&gt; {</span><font></font><span class="xml">
    if (err) return console.log('The API returned an error: ' + err);</span><font></font><span class="xml">
    const rows = res.data.values;</span><font></font><span class="xml">
    if (rows.length) {</span><font></font><span class="xml">
      // Print columns A and E, which correspond to indices 0 and 4.</span><font></font><span class="xml">
      const ix = rows.findIndex(r =&gt; !r[1]);</span><font></font><span class="xml">
      await post(rows[ix][0]);</span><font></font><span class="xml">
      sheets.spreadsheets.values.update({</span><font></font><span class="xml">
        spreadsheetId: '18VzilQTEDGXBnaH1f_k-uAfa8Mb470gx32Phir6xQT4',</span><font></font><span class="xml">
        range: `Sheet1!B${ix + 1}`,</span><font></font><span class="xml">
        valueInputOption: 'RAW',</span><font></font><span class="xml">
        requestBody: {</span><font></font><span class="xml">
          range: `Sheet1!B${ix + 1}`,</span><font></font><span class="xml">
          values: [['x']]</span><font></font><span class="xml">
        }</span><font></font><span class="xml">
</span><font></font><span class="xml">
      })</span><font></font><span class="xml">
    } else {</span><font></font><span class="xml">
      console.log('No data found.');</span><font></font><span class="xml">
    }</span><font></font><span class="xml">
  });</span><font></font><span class="xml">
};</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The table with which the script interacts has the following form: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/lr/1r/tylr1rijbae8u53q8qvuwbls5te.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, for next to each link after sending a message to Slack, the script puts ‚Äúx‚Äù. Thus, to find the message you want to send, you should select the first line, which does not yet have an ‚Äúx‚Äù, take the message, send it and mark the selected line. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The script that we just disassembled is quite simple and has confirmed its performance for several years in our team. We just have to deploy this script to the server and enjoy using it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this, in our company we use the usual Ubuntu VPS on Digital Ocean (even the most low-power one will do). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, you need to configure the environment for executing javascript code, to do this, install node.js (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installation guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, configure the cron task to call the script on a schedule:</font></font><br>
<br>
<pre><code class="plaintext hljs">crontab -e<font></font>
<font></font>
#### <font></font>
<font></font>
24 14 * * 1-5 cd /root/google-sheets-to-slack &amp;&amp; node post.js<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using these settings, our script from the / root / folder will be called daily from Monday to Friday at 14:24. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The setup is over, but the attentive reader must have noticed some flaws in the script, for example, if there is any error when calling the script, we will never know about it, because it will ‚Äúquietly fall‚Äù and that‚Äôs all. </font><font style="vertical-align: inherit;">To solve this problem, you can add error handling and output of the result of the script call to the same Google spreadsheet or log file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, instead of sending a message at a fixed time, you can send it with a random delay, so that our message is more like a message from a ‚Äúlive‚Äù user.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another interesting idea from one of our colleagues was to create a second table from which messages would be sent exclusively on Fridays and would be more entertaining. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, we see countless ideas for refinement and we will gradually implement them, but in the existing form this script came out quite usable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example table that can be used is available </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks for reading and enjoy using.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489444/index.html">Transform nature into decoration with 3D scanning</a></li>
<li><a href="../en489452/index.html">Microsoft JavaScript Tasks</a></li>
<li><a href="../en489456/index.html">Recommendations after the appointment of a dental surgeon</a></li>
<li><a href="../en489460/index.html">Two-finger UV</a></li>
<li><a href="../en489464/index.html">‚ÄúI'll be back!‚Äù: How Arnold Schwarzenegger‚Äôs English has changed over 50 years in the USA</a></li>
<li><a href="../en489470/index.html">The competitive potential of Besiege-like simulations</a></li>
<li><a href="../en489472/index.html">Web archive: import substitution</a></li>
<li><a href="../en489474/index.html">How to compress fastText model 100 times</a></li>
<li><a href="../en489476/index.html">Styling checkboxes and radio buttons using CSS3</a></li>
<li><a href="../en489482/index.html">What you need to know if you want to call Go functions from assembler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>