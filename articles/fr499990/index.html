<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤟🏻 🤾🏽 🕚 Géocodage Comment lier 250 mille adresses à des coordonnées en 10 minutes? 🌅 🐃 🦁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Dans cet article, je voudrais partager mon expérience dans la résolution d'un petit problème avec un grand nombre d'adresses. Si vo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Géocodage Comment lier 250 mille adresses à des coordonnées en 10 minutes?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499990/"><img src="https://habrastorage.org/webt/6b/g3/oo/6bg3ooc_jcrhty63bg_33x8inta.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je voudrais partager mon expérience dans la résolution d'un petit problème avec un grand nombre d'adresses. </font><font style="vertical-align: inherit;">Si vous avez déjà travaillé avec l'API de géocodage ou utilisé des outils en ligne, je pense que vous partagez ma douleur d'attendre le résultat pendant plusieurs heures, voire plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne s'agit pas d'algorithmes d'optimisation complexes, mais de l'utilisation d'un service de géocodage de paquets qui prend une liste d'adresses en entrée et renvoie un fichier avec les résultats. </font><font style="vertical-align: inherit;">Cela peut réduire le temps de traitement de quelques heures à quelques minutes.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Géocodage par lots</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisir un fournisseur de géocodeur de paquets</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide de service Python</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description complète de la classe de lot</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'analyse des résultats</font></font></h3></a></li>
</ul><br>
<a name="history"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche est arrivée - "Lier aux coordonnées de 24 mille adresses." </font><font style="vertical-align: inherit;">Seules deux solutions au problème se sont produites:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application Web de géocodage, utilisée à l'université;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écrivez un script basé sur l'API REST du géocodeur.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier cas, il s'est avéré que l'application Web se bloquait après avoir traité des milliers d'adresses. La distribution d'un ensemble de données entre collègues est une idée qui a été immédiatement abandonnée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, vous devez utiliser l'API REST du géocodeur pour écrire votre propre script, avec les résultats enregistrés (ce n'est pas une manière complètement légale et vous devez lire les conditions d'utilisation du service). Un nouveau problème survient - c'est une chose lorsque nous utilisons la recherche d'adresses dans l'application et obtenons immédiatement le résultat, mais lorsque la tâche consiste à traiter plus de dix mille adresses avec conservation, le travail du script est considérablement retardé. Vous pouvez attendre une heure ou deux, mais un million d'adresses devront géocoder «un temps immense», vous devez donc chercher une autre solution et c'est le cas!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les grands fournisseurs de services de géolocalisation, en plus du service de géocodage habituel, proposent un géocodeur de paquets (Batch Geocoder), juste pour traiter un grand nombre d'adresses en une seule demande.</font></font><br>
<br>
<a name="batch"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Géocodage par lots</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le nom du service parle de lui-même - nous avons un package (par exemple, un fichier csv avec une liste d'adresses sous la forme d'un tableau), que nous téléchargeons sur le serveur, et il fait tout le travail pour nous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le processus ressemble à ceci:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Préparer l'ensemble de données pour que le service l'accepte sans erreur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définition des paramètres du résultat du travail (sélection des colonnes, séparateur ...);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Téléchargez un fichier dans le cloud;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En attente de fin de traitement;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Téléchargez le fichier fini.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à la puissance du cloud computing, ce qui se fait avec un script auto-écrit en 1 heure se fait en 1 minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étape suivante consiste à choisir l'entreprise avec les conditions d'utilisation les plus fidèles du géocodeur de paquets. </font><font style="vertical-align: inherit;">Tout d'abord, tout le monde n'a pas un tel service, d'autres vous permettent de tester le service avec une sérieuse limitation. </font><font style="vertical-align: inherit;">De plus, si vous avez de très gros volumes, vous devez faire attention au coût des transactions supplémentaires, au cas où la limite du forfait gratuit serait dépassée.</font></font><br>
<br>
<a name="provider"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisir un fournisseur de services de géocodage par lots</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le marché mondial des services de géolocalisation, les positions de leader sont occupées par: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Maps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICI Technologies; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MapBox</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TomTom </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, il ne faut pas oublier Yandex Technologies, qui a une position assez forte en Russie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai pris les paramètres suivants comme base pour choisir un fournisseur:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le nombre de demandes par mois auprès du service de géocodage est gratuit;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite du nombre de transactions par jour;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disponibilité du service de géocodage par lots;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possibilité d'utiliser un géocodeur de paquets dans un plan gratuit. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque entreprise a son propre modèle de monétisation. </font><font style="vertical-align: inherit;">Selon le projet, l'un ou l'autre modèle peut jouer entre les mains ou vice versa être une limitation importante.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Maps</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer avec les services géographiques de Google, la première chose que vous devez faire est d'ajouter des informations de carte de crédit à votre compte. Une limite mensuelle de 200 dollars virtuels, vient ensuite le paiement de transactions supplémentaires à partir de la carte liée. Dans cette limite, vous pouvez utiliser différents services, mais chaque transaction est considérée différemment. Par exemple, mille demandes de géocodage coûteront 5 $, mais le service de création d'itinéraire est deux fois plus cher. Plus de détails peuvent être trouvés sur le site, nous ne sommes intéressés que par le service de géocodage.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si 200 $ par mois, il est facile de calculer le nombre gratuit de transactions - 40 000 (service de géocodage). </font><font style="vertical-align: inherit;">Il n'y a pas de géocodeur de paquets parmi les services. </font><font style="vertical-align: inherit;">Cela signifie que vous devez écrire votre propre script et le résultat sera d'environ 1 adresse par seconde, soit six heures pour 24 000 adresses. </font><font style="vertical-align: inherit;">Pour accélérer le processus, vous pouvez essayer d'exécuter le script sur la plate-forme des API Google Cloud, mais j'ai décidé de rechercher des solutions alternatives. </font><font style="vertical-align: inherit;">Il n'y a aucune restriction sur le nombre de transactions par jour, donc les quarante mille peuvent être dépensés à la fois.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICI Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le passé, Nokia Maps, et dans un passé encore plus profond, Navteq, fournit gratuitement 250 000 transactions par mois. Comme pour Google Maps, ce numéro s'applique à tous les services et chacun est considéré différemment. Lorsque vous utilisez le forfait gratuit, vous n'avez pas besoin de joindre une carte bancaire. Si vous dépassez la limite, alors pour chaque millier de transactions supplémentaires, vous devez payer 1 $. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important d'avoir un géocodeur de paquets en tant que service distinct, qui est inclus dans le plan gratuit. Les transactions y sont prises en compte selon le même modèle que dans l'habituel, c'est-à-dire qu'un géocodeur de paquets percevra chaque adresse d'un fichier en une seule transaction.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par le titre de l'article, il est clair que j'ai utilisé le géocodeur de paquets ICI, car vous pouvez dépenser toutes les transactions sur le géocodeur et effectuer 250 000 opérations de géocodage par mois. </font><font style="vertical-align: inherit;">Mais ce n'est pas la seule option, alors nous regardons ce que les autres entreprises ont.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapbox</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous utilisez le géocodeur MapBox, 100 000 transactions par mois sont disponibles. </font><font style="vertical-align: inherit;">L'entreprise adhère au même modèle de monétisation avec paiement des transactions supplémentaires. </font><font style="vertical-align: inherit;">Seulement, il existe une option intéressante pour les «grossistes» - plus vous avez de transactions, moins elles coûtent (bien sûr, il y a une limite de réduction de prix). </font><font style="vertical-align: inherit;">Par exemple, de 100 000 à 500 000, un millier de demandes supplémentaires coûtera 0,75 $, de 500 000 à 1 million - 0,60 $, etc., pour plus de détails, consultez le site Web. </font><font style="vertical-align: inherit;">Malheureusement, le géocodeur par lots n'est disponible que sur un compte payant.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomtom</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plateforme permet d'effectuer 2500 transactions par jour, environ 75 000 par mois. </font><font style="vertical-align: inherit;">Pendant les tests et le développement, la limite quotidienne ne semble pas très attrayante par rapport aux concurrents, mais le paiement des transactions supplémentaires est le plus flexible. </font><font style="vertical-align: inherit;">Il existe 8 options de paiement pour un millier de demandes supplémentaires et le prix est réduit de 0,5 $ à 0,42 $. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi les services, il y a un géocodeur par lots avec la capacité de traiter jusqu'à 10 000 adresses par demande (cependant, la limite quotidienne doit être prise en compte).</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un modèle avec une limite de transaction quotidienne pour Yandex, mais plus fidèle 25 000 demandes. </font><font style="vertical-align: inherit;">Si vous multipliez ce nombre par le nombre de jours dans un mois, vous obtenez un chiffre impressionnant de 750 mille. </font><font style="vertical-align: inherit;">Le site présente les prix d'un millier de transactions supplémentaires en roubles allant de 120 roubles. </font><font style="vertical-align: inherit;">jusqu'à 11 roubles </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le géocodeur de paquets en tant que service n'est pas présenté, donc pour parvenir à une sorte d'optimisation, il échouera.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un plan gratuit très tentant avec 1 million de transactions par mois. </font><font style="vertical-align: inherit;">L'entreprise facture également 50 crédits à chaque compte (l'équivalent approximatif de 5 $). </font><font style="vertical-align: inherit;">Il convient de noter qu'il s'agit du plan le plus fidèle pour l'utilisation des services de géolocalisation. </font><font style="vertical-align: inherit;">Il existe également un service de géocodage par lots, mais vous ne pouvez l'utiliser que si vous disposez d'un compte d'entreprise sur la plateforme ArcGIS Online.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que choisir à la fin?</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La façon la plus simple est de faire un choix en compilant une petite table: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/xy/b1/kgxyb1kmzemqxqicwajfi7hggva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, mon choix est tombé ICI car c'est la meilleure option pour résoudre mon problème. </font><font style="vertical-align: inherit;">Bien sûr, je suis loin d'une analyse complète, idéalement, vous devez exécuter votre ensemble de données à travers tous les géocodeurs pour évaluer la qualité. </font><font style="vertical-align: inherit;">De plus, si vous avez plusieurs millions d'adresses, vous devriez penser à un forfait payant et vous devez alors prendre en compte le coût de l'ajout. </font><font style="vertical-align: inherit;">transactions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le but de l'article n'est pas de comparer les entreprises, mais de résoudre le problème d'optimisation du géocodage d'un grand volume d'adresses. </font><font style="vertical-align: inherit;">Je viens de montrer mes pensées lors du choix d'un fournisseur de services.</font></font><br>
<br>
<a name="guide"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide de service Python</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord créer un compte sur le portail pour les développeurs et générer une clé API REST dans la section projet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez désormais travailler avec la plateforme. </font><font style="vertical-align: inherit;">Je ne décrirai qu'une partie des fonctionnalités du géocodeur de paquets ICI: chargement des données, vérification de l'état, sauvegarde des résultats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons donc par importer les bibliothèques nécessaires:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, si aucune erreur ne s'est produite, créez une classe:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"your_api_key"</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En d'autres termes, lors de l'initialisation, la classe doit transmettre sa propre clé pour l'API REST. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La variable SERVICE_URL est l'URL de base pour travailler avec le service de géocodage par lots. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans jobId l'identifiant du travail en cours du géocodeur sera stocké. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un point important est la structure de données correcte sur demande. </font><font style="vertical-align: inherit;">Le fichier doit contenir deux colonnes obligatoires: recId et searchText. </font><font style="vertical-align: inherit;">Sinon, le service renverra une réponse contenant des informations sur l'erreur de téléchargement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un exemple de jeu de données:</font></font><br>
<br>
<pre><code class="plaintext hljs">   recId; searchText<font></font>
   1; -, . , 6<font></font>
   2; ,  1,  -., 72<font></font>
   3; 425 W Randolph St Chicago IL 60606<font></font>
   4; , DJ106 20-30, Sibiu 557260<font></font>
   5; 200 S Mathilda Ave Sunnyvale CA 94086<font></font>
  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fonction de téléchargement d'un fichier sur le cloud:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est assez simple, ouvrez un fichier avec une liste d'adresses à lire, formez un dictionnaire des paramètres de requête GET. </font><font style="vertical-align: inherit;">Certains paramètres méritent d'être expliqués:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Action»: «exécuter» - début du traitement de l'adresse;</font></font></li>
<li>“politicalView”: “RUS” –    .         (    );</li>
<li>“gen”: 9 –   (   );</li>
<li>“maxresults”: 1 –          ;</li>
<li>“header”: true –        ;</li>
<li>“indelim”: “;” –   ,  ;</li>
<li>“outdelim”: “;” –    ;</li>
<li>“outcols”: “” –  ,      ;</li>
<li>“outcombined”: true –                .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, envoyez simplement une demande à l'aide de la bibliothèque de demandes et affichez les statistiques. </font><font style="vertical-align: inherit;">Bien sûr, vous devez fermer le fichier à la fin de la fonction. </font><font style="vertical-align: inherit;">La fonction __stats analyse la réponse du serveur, qui contient l'ID du travail en cours d'exécution, et affiche également des informations générales sur l'opération. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étape suivante consiste à vérifier l'état du travail. </font><font style="vertical-align: inherit;">La requête est formée de façon similaire, il suffit de transférer l'opération Id. </font><font style="vertical-align: inherit;">Le paramètre d'action doit contenir la valeur «état». </font><font style="vertical-align: inherit;">La fonction __stats affiche des statistiques complètes sur la console pour estimer l'heure d'arrêt du géocodeur.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des fonctions les plus importantes consiste à enregistrer le résultat. </font><font style="vertical-align: inherit;">Pour plus de commodité, il est préférable de décompresser immédiatement le fichier provenant du serveur. </font><font style="vertical-align: inherit;">La demande de sauvegarde du fichier est identique à la vérification de l'état, il suffit d'ajouter / résultat à la fin.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction finale pour analyser la réponse du service. </font><font style="vertical-align: inherit;">Sa tâche consiste également à enregistrer l'identifiant de la tâche de géocodage en cours:</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le tester, il suffit d'exécuter l'interpréteur Python dans le dossier de script. </font><font style="vertical-align: inherit;">La classe Batch se trouve dans le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geocoder.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; from geocoder import Batch<font></font>
&gt;&gt;&gt; service = Batch(apikey="   REST API")<font></font>
&gt;&gt;&gt; service.start("big_data_addresses.csv", indelim=";", outdelim=";")<font></font>
<font></font>
requestid: "  Id "<font></font>
status: accepted<font></font>
totalcount: 0<font></font>
validcount: 0<font></font>
invalidcount: 0<font></font>
processedcount: 0<font></font>
pendingcount: 0<font></font>
successcount: 0<font></font>
errorcount: 0<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un excellent travail a commencé. </font><font style="vertical-align: inherit;">Vérifiez l'état:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.status()<font></font>
<font></font>
requestid: "  Id "<font></font>
status: completed<font></font>
jobstarted: 2020-04-27T10:09:58.000Z<font></font>
jobfinished: 2020-04-27T10:17:18.000Z<font></font>
totalcount: 249999<font></font>
validcount: 249999<font></font>
invalidcount: 0<font></font>
processedcount: 249999<font></font>
pendingcount: 0<font></font>
successcount: 249978<font></font>
errorcount: 21<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons que le traitement de l'ensemble de données est terminé. </font><font style="vertical-align: inherit;">En seulement sept minutes, il a été possible de procoder les 250 000 adresses (hors erreurs - errorcount). </font><font style="vertical-align: inherit;">Reste à sauvegarder les résultats:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.result()<font></font>
Requesting result data ...<font></font>
File saved successfully<font></font>
</code></pre><br>
<a name="code"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description complète de la classe de lot</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que cela ne fait pas de mal d’ajouter complètement le script:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"   REST API "</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
        <font></font>
            <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
    <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
        <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
    <font></font>
<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br>
<a name="result"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'analyse des résultats</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, je suis passé lentement des applications en ligne aux services de géocodage par lots. </font><font style="vertical-align: inherit;">Le choix d'un géoservice dépend entièrement des tâches qui vous attendent. </font><font style="vertical-align: inherit;">Je reçois régulièrement des demandes de traitement d'un grand nombre d'adresses et l'approche décrite dans l'article a permis de réduire considérablement le temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que cet article vous sera utile et bien sûr je suis ouvert aux commentaires et ajouts!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499974/index.html">Jeux 3D sur Instagram Javascript, ou trajectoire de vol de saucisse</a></li>
<li><a href="../fr499978/index.html">Traduction du livre d'Andrew Un, Passion for Machine Learning, chapitres 36 et 37</a></li>
<li><a href="../fr499982/index.html">Plan de testeur débutant: de "Enter IT" à "I Am an Engineer!"</a></li>
<li><a href="../fr499986/index.html">Et encore une fois sur l'embarqué: la recherche de bugs dans le projet Embox</a></li>
<li><a href="../fr499988/index.html">Sucre et COVID-19</a></li>
<li><a href="../fr499992/index.html">Concevoir des technologies pour la mise en œuvre de systèmes de facturation pour les entreprises clientes (partie 2)</a></li>
<li><a href="../fr499994/index.html">Quand le coronavirus prendra fin</a></li>
<li><a href="../fr500000/index.html">À Radio Day. Communication - les nerfs de la guerre</a></li>
<li><a href="../fr500002/index.html">Spécialistes informatiques vs vendeurs: et le monde a craqué en deux</a></li>
<li><a href="../fr500008/index.html">Rencontrez des ascendants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>