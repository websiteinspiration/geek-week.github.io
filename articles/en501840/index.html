<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëçüèª üêï üèåÔ∏è HTTP over UDP - use the QUIC protocol with benefit üë®üèæ‚Äçüéì üë®‚Äçüî¨ ü•Ö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="QUIC (Quick UDP Internet Connections) is a protocol over UDP that supports all the features of TCP, TLS and HTTP / 2 and solves most of their problems...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HTTP over UDP - use the QUIC protocol with benefit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/501840/"><img src="https://habrastorage.org/webt/ib/w3/ma/ibw3maw_j3wia6wgt4m9nveqruk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QUIC (Quick UDP Internet Connections) is a protocol over UDP that supports all the features of TCP, TLS and HTTP / 2 and solves most of their problems. </font><font style="vertical-align: inherit;">It is often called the new or ‚Äúexperimental‚Äù protocol, but it has long survived the stage of the experiment: development has been ongoing for more than 7 years. </font><font style="vertical-align: inherit;">During this time, the protocol did not manage to become a standard, but it was still widely used. </font><font style="vertical-align: inherit;">For example, such giants as Google and Facebook use QUIC to speed up traffic and reduce latency in mobile networks, and the IETF announced its fork of the protocol as the basis for the HTTP / 3 standard (despite the fact that HTTP / 2 uses </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://w3techs.com/technologies/details/ce-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only 44.8% of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sites).</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concept</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QUIC was developed as a replacement for legacy TCP, which was originally designed for wired networks with a low percentage of losses. TCP delivers packets in order, so when a packet is lost, the entire queue ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">head-of-line blocking</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">rises </font><font style="vertical-align: inherit;">, which negatively affects the quality and stability of the connection. To avoid massive losses, cellular networks resort to the use of large buffers, which in turn leads to redundancy and false negative protocol reactions ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferbloat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). In addition, TCP spends a lot of time establishing a connection: SYN / ACK and TLS requests go separately, requiring three roundtripes instead of one, as QUIC does.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dl/i_/e6/dli_e6nt-_g4uxdyb-lnagxt0og.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since QUIC combines the replacement of TCP and the implementation of TLS 1.3, all connections are always encrypted, decrypting such traffic is not easier than if it went via HTTPS. In addition, QUIC is implemented at the application level, as it would take </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forever to</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> completely replace the TCP stack </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the multiplexing support in HTTP / 2, the head-of-line blocking problem remained there because of the need to deliver packets in order. </font><font style="vertical-align: inherit;">QUIC is implemented on top of UDP, so it does not have any blocking in principle, and so that packets are not lost permanently, they are numbered and can contain parts of "neighbors", providing redundancy. </font><font style="vertical-align: inherit;">In addition, QUIC splits a monolithic queue into several threads for different types of requests within the same connection. </font><font style="vertical-align: inherit;">Thus, when a packet is lost, problems can occur only in one queue (for example, for transferring a specific file):</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/f6d/c5b/11f/f6dc5b11f8a240b4283dcb8de5b9a0f4.gif" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QUIC was originally developed internally by Google and was largely tailored for use internally. </font><font style="vertical-align: inherit;">In 2013, he was transferred to the IETF for standardization (which is still ongoing), and now everyone can participate in the development of the protocol by proposing what he lacks. </font><font style="vertical-align: inherit;">The IETF working group organizes annually meetings, within which a new standard is approved and innovations are discussed. </font><font style="vertical-align: inherit;">This QUIC implementation is considered the main one and it is on its basis that the HTTP / 3 standard is certified. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, we are not talking about enabling HTTP / 3 as the main protocol, because it is not yet finished and is almost not supported: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6f/ur/er/6furermeiz07mne-1xhpqc2s3-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But QUIC can be implemented as a transport between the application and the server, which was successfully done in Uber:</font></font><br>
<blockquote><h3><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uber comment on QUIC implementation</font></font></i></h3><br>
   QUIC        ,     (HTTP/2  TLS/TCP)   QUIC.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Cronet</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Chromium Projects</a>,   ,    ‚Äì gQUIC.     ,     IETF.<br>
<br>
   Cronet   Android-,    QUIC.    ,      .  ,      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://square.github.io/ok">OkHttp</a>,   Cronet   OkHttp API.    ,        (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Retrofit</a>)   API.<br>
<br>
   Android-,   Cronet   Uber  iOS,  HTTP-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">API</a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">NSURLProtocol</a>.  ,  iOS Foundation,  - URL-  ,     Cronet   iOS-    .</blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taken from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of an Uber article</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
On the backend, they caught QUIC connections through Google Cloud lb, which has been </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://cloud.google.com/blog/products/gcp/introducing-quic-support-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supporting the protocol</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> since mid-2018. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not surprisingly, the Google Cloud works great with the protocol developed by Google, but what are the alternatives?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not so long ago, CloudFlare </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://blog.cloudflare.com/experiment-with-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tried to cross</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nginx (which by default does not know HTTP / 3) with its Quiche tool. </font><font style="vertical-align: inherit;">The implementation is available as a single .patch file, which has an installation tutorial included:</font></font><br>
<br>
<pre><code class="bash hljs">curl -O https://nginx.org/download/nginx-1.16.1.tar.gz<font></font>
tar xvzf nginx-1.16.1.tar.gz<font></font>
git <span class="hljs-built_in">clone</span> --recursive https://github.com/cloudflare/quiche
<span class="hljs-built_in">cd</span> nginx-1.16.1<font></font>
patch -p01 &lt; ../quiche/extras/nginx/nginx-1.16.patch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can connect your modules if necessary.</font></font><br>
<br>
<pre><code class="bash hljs">./configure                          	\<font></font>
   	--prefix=<span class="hljs-variable">$PWD</span>                       	\<font></font>
   	--with-http_ssl_module              	\<font></font>
   	--with-http_v2_module               	\<font></font>
   	--with-http_v3_module               	\<font></font>
   	--with-openssl=../quiche/deps/boringssl \<font></font>
   	--with-quiche=../quiche<font></font>
 make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All that remains is to enable HTTP / 3 support.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-section">events</span> {
    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">http</span> {
    <span class="hljs-section">server</span> {
        <span class="hljs-comment"># Enable QUIC and HTTP/3.</span>
        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> quic reuseport;<font></font>
<font></font>
        <span class="hljs-comment"># Enable HTTP/2 (optional).</span>
        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;<font></font>
<font></font>
        <span class="hljs-attribute">ssl_certificate</span>      cert.crt;
        <span class="hljs-attribute">ssl_certificate_key</span>  cert.key;<font></font>
<font></font>
        <span class="hljs-comment"># Enable all TLS versions (TLSv1.3 is required for QUIC).</span>
        <span class="hljs-attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<font></font>
<font></font>
        <span class="hljs-comment"># Request buffering in not currently supported for HTTP/3.</span>
        <span class="hljs-attribute">proxy_request_buffering</span> <span class="hljs-literal">off</span>;<font></font>
<font></font>
        <span class="hljs-comment"># Add Alt-Svc header to negotiate HTTP/3.</span>
        <span class="hljs-attribute">add_header</span> alt-svc <span class="hljs-string">'h3-27=":443"; ma=86400'</span>;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In normal browsers, connecting via HTTP / 3 is not yet possible, but you can take </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrome Canary</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and run it with a flag </font></font><code>--enable-quic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, go to your server or, for example, the quic.rocks website and see the connection type in Developer Tools: </font></font><br>
<img src="https://habrastorage.org/webt/5r/z3/sj/5rz3sjh1pte0qpwur-kpd987iww.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of HTTP / 3 it is written </font></font><code>http2+quic/99</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but it is essentially the same thing.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other technology</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QUIC also supports </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LiteSpeed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (which connected with Facebook with great fanfare over HTTP / 3) and progressive </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caddy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Apache does not yet know how, but work is in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">full swing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">January 21 updated </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draft standard for WebRTC</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just the other day, Microsoft opened the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code for its implementation of msquic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in which not all functions from the IETF standard are yet available, but this is already a big breakthrough.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br>
<img src="https://habrastorage.org/webt/ne/m6/zp/nem6zpxjr_2cvoafckfuiig_cjm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interest in QUIC is unstable, but growing, work is underway to standardize it. </font><font style="vertical-align: inherit;">New protocol implementations appear almost every month, and every year more and more developers are convinced that the future lies with QUIC. </font><font style="vertical-align: inherit;">It is even possible to include the protocol in future versions of the TCP stack, which means that sooner or later the entire Internet will move to more stable and faster connections. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Already, you can configure QUIC interaction for your infrastructure or even give it to browsers - they all plan to add protocol support, and sad statistics with caniuse will become more fun.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501826/index.html">About ambitious founders or how I tried to collect investments for a startup</a></li>
<li><a href="../en501828/index.html">Unreal Engine 5 sets the bar for gaming realism</a></li>
<li><a href="../en501830/index.html">We port Angular project on ESLint, with Prettier, Husky and lint-staged</a></li>
<li><a href="../en501834/index.html">Overview of Creaform Metrascan 3D Scanners</a></li>
<li><a href="../en501836/index.html">Supply ventilation combined with channel air conditioning (part 2 - water)</a></li>
<li><a href="../en501842/index.html">Fine-tuning routing for MetalLB in L2 mode</a></li>
<li><a href="../en501844/index.html">How I stopped being afraid and wrote a game bot</a></li>
<li><a href="../en501846/index.html">How to choose a video surveillance system</a></li>
<li><a href="../en501848/index.html">I explain the reservation in the data center on beer</a></li>
<li><a href="../en501850/index.html">We disassemble EM-algorithm into small bricks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>