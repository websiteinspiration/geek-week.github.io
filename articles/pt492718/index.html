<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìî üêÆ üë©üèº‚Äçü§ù‚Äçüë®üèæ Seguran√ßa atrav√©s da restri√ß√£o do usu√°rio ou como criar uma vulnerabilidade üëãüèæ üë©üèº‚Äçüç≥ üë©üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 2019, a vulnerabilidade de nega√ß√£o de servi√ßo envenenada por cache do CPDoS ) foi descoberta na rede CDN, o que permite envenenar o cache HTTP do p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Seguran√ßa atrav√©s da restri√ß√£o do usu√°rio ou como criar uma vulnerabilidade</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492718/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em 2019, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulnerabilidade de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nega√ß√£o de servi√ßo envenenada por cache </font><font style="vertical-align: inherit;">do </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">CPDoS</font></a><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">foi </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">descoberta</font></a><font style="vertical-align: inherit;"> na rede CDN, o que permite envenenar o cache HTTP do provedor de CDN e causar uma nega√ß√£o de servi√ßo. </font><font style="vertical-align: inherit;">A vulnerabilidade ainda n√£o recebeu muita publicidade, pois n√£o foi vista em ataques reais. </font><font style="vertical-align: inherit;">Mas quero falar sobre um dos m√©todos de envenenamento de cache separadamente. </font><font style="vertical-align: inherit;">Substitui√ß√£o de m√©todo HTTP.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rb/7j/wy/rb7jwy3an79ykaffwer39l297eu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se outras variantes de explorar a vulnerabilidade de uma maneira ou de outra dependem de bugs ou recursos de modifica√ß√£o de solicita√ß√£o por um intermedi√°rio, a variante Substitui√ß√£o de M√©todo √© baseada na t√°tica de mesmo nome, que n√£o faz parte do padr√£o HTTP, carrega consigo problemas adicionais e que surgiram e se espalharam devido a descuido. rela√ß√£o com a seguran√ßa. </font><font style="vertical-align: inherit;">Aqui vamos considerar.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curta sobre o CPDoS, se voc√™ perdeu</font></font></b><div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"> </a> ,         URI  method   .<br>
<br>
      ,       ,       ,         ,      -   .       ‚Äî            -  -   -,      ,    -     ,      .           ,         .<br>
<br>
            ,    . ,  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">   -</a>.      -   ,       ,      .<br>
<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite o cliente, menos pode - menos ir√° quebrar</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A necessidade de substituir o m√©todo na solicita√ß√£o surgiu devido ao fato de algumas implementa√ß√µes de firewalls de aplicativos da Web e de clientes HTTP serem muito limitadas e n√£o permitirem a execu√ß√£o de m√©todos diferentes de GET e POST. O problema n√£o √© que se tratava de uma restri√ß√£o de implementa√ß√£o, mas de uma restri√ß√£o intencional de clientes HTTP por uma pol√≠tica de seguran√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro que tudo foi realizado com a inten√ß√£o de cortar o tr√°fego restrito, n√£o padr√£o para clientes HTTP comuns. Mas, na busca pela seguran√ßa, todos os m√©todos, exceto GET e POST, foram cortados. Talvez porque esses sejam os √∫nicos m√©todos que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">opcionais e necess√°rios</font></a><font style="vertical-align: inherit;"> para servidores de uso geral.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que foi necess√°rio introduzir uma restri√ß√£o t√£o estrita n√£o est√° claro. Sim, ataques com a introdu√ß√£o de v√°rios caracteres para confundir o analisador s√£o apenas o hobby de protocolos de texto. Mas voc√™ pode permitir um pouco mais de m√©todos, por exemplo, usar pelo menos aqueles que s√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descritos no pr√≥prio padr√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.iana.org/assignments/http-methods/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registrados na IANA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . N√£o valeu a pena remover completamente a verifica√ß√£o do m√©todo, mas voc√™ pode discar v√°rios dos m√©todos mais populares e exclu√≠-los daqueles que alteram o protocolo de intera√ß√£o e interrompem o trabalho com conex√µes no servidor proxy (CONNECT). Mas n√£o, surgiu uma pol√≠tica de seguran√ßa que introduziu </font><font style="vertical-align: inherit;">restri√ß√µes e proibi√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desnecess√°rias</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para os clientes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E os clientes estavam limitados aos errados. </font><font style="vertical-align: inherit;">Eles queriam limitar a variabilidade das mensagens dos clientes HTTP e limitar os clientes que esses WAFs protegiam, os servidores de aplicativos finais e seus desenvolvedores. </font><font style="vertical-align: inherit;">Agora, os desenvolvedores ficaram com apenas dois m√©todos que nem sempre eram suficientes para descrever a l√≥gica do cliente HTTP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restri√ß√µes s√£o criadas para super√°-las.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era de se esperar que essa restri√ß√£o excessiva, mais cedo ou mais tarde, come√ßasse a interferir nos desenvolvedores da web. A ironia √© que √© t√£o f√°cil n√£o se livrar dessas WAFs. Especialmente quando eles est√£o com clientes ou fornecedores. Desafiar as pol√≠ticas de seguran√ßa de outras pessoas √© uma quest√£o desastrosa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devido √† flexibilidade do HTTP, n√£o √© dif√≠cil contornar essa limita√ß√£o; basta adicionar algo √† solicita√ß√£o em que voc√™ pode substituir o m√©todo. O WAF estrito verificar√° apenas o m√©todo na Linha de Solicita√ß√£o (a primeira linha da solicita√ß√£o) e ficar√° feliz em ver um GET ou POST aprovado l√°. E o back-end poder√° analisar o elemento adicionado e extrair o m√©todo real dele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode pesquisar no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://fandry.blogspot.com/2012/03/x-" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">google </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√°rios </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://docs.inpaas.com/docs/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigos, </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realmente um </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.infoworld.com/article/3249687/how-to-implement-a-delegatinghandler-for-x-" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre como os proxies ruins quebraram os aplicativos REST e como os autores tiveram que passar o m√©todo real em um cabe√ßalho separado. </font><font style="vertical-align: inherit;">Em todos eles, eles sugerem que voc√™ insira aproximadamente o mesmo cabe√ßalho (X-HTTP-Method, X-HTTP-Method-Override ou X-Method-Override - a ortografia varia um pouco) para indicar um m√©todo substitu√≠do. </font><font style="vertical-align: inherit;">Muito, muito raramente, √© poss√≠vel encontrar refer√™ncias que possam ser usadas para a mesma finalidade URI do componente de consulta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que est√° faltando nesses artigos √© a se√ß√£o Considera√ß√µes de seguran√ßa. </font><font style="vertical-align: inherit;">E eles simplesmente s√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A substitui√ß√£o do m√©todo √© segura?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, os desenvolvedores de aplicativos da web esquecem que, entre o cliente e o servidor, pode haver participantes intermedi√°rios que interagem com o protocolo HTTP: proxies, caches da web do provedor, CDN e WAF. A prolifera√ß√£o do TLS reduz bastante a chance de um participante intermedi√°rio entre o cliente e o servidor. Provavelmente, o √∫nico proxy entre o cliente e o back-end ser√° o seu pr√≥prio servidor com o Nginx. E essa configura√ß√£o √© f√°cil o suficiente para testar em cen√°rios t√≠picos antes do lan√ßamento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas estamos entrando na era da CDN, e mais e mais aplicativos se escondem atr√°s das CDNs que l√™em e manipulam o tr√°fego do usu√°rio. </font><font style="vertical-align: inherit;">Os back-end diretamente quase nunca atendem aos usu√°rios e se escondem atr√°s de proxies reversos para aumentar a capacidade de resposta e o desempenho. </font><font style="vertical-align: inherit;">Portanto, voc√™ precisar√° lembrar como a substitui√ß√£o de um m√©todo pode afetar o processamento de uma solicita√ß√£o em um servidor de media√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os ataques dos quais quero falar s√£o principalmente aplic√°veis ‚Äã‚Äãao HTTP / 1.1. </font><font style="vertical-align: inherit;">O HTTP / 2, de alguma maneira, herda o comportamento do padr√£o antigo; de certa forma, ele segue seu pr√≥prio caminho; portanto, a aplicabilidade de cada ataque ao novo padr√£o ser√° considerada separadamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ataques de cache</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na maioria das vezes, os servidores intermedi√°rios n√£o levam em considera√ß√£o as substitui√ß√µes de m√©todos, n√£o verificam os cabe√ßalhos da fam√≠lia X-HTTP-Method-Override e trabalham com a solicita√ß√£o usando seu m√©todo principal na linha de solicita√ß√£o. E como o m√©todo substitu√≠do n√£o est√° inclu√≠do na chave para procurar uma solicita√ß√£o no cache (m√©todo + URI), esses servidores n√£o podem distinguir POST de POST + POST + X-HTTP-Method-Override: DELETE. Isso significa que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ n√£o pode permitir o armazenamento em cache de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nenhuma solicita√ß√£o para um determinado URI se o back-end puder monitorar e executar m√©todos substitu√≠dos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O documento CPDoS tem um bom exemplo do que acontece se voc√™ armazenar em cache essa solicita√ß√£o. Quando um invasor disfar√ßa uma solicita√ß√£o POST como uma solicita√ß√£o GET, o proxy n√£o reconhece a substitui√ß√£o e trata a solicita√ß√£o como uma solicita√ß√£o GET leg√≠tima. O back-end, no entanto, reconhece o m√©todo substitu√≠do e executa o verbo descrito no cabe√ßalho X-HTTP-Method-Override - POST. Como o m√©todo POST n√£o est√° definido para o URI de destino, o servidor gera um erro. Al√©m disso, a resposta de back-end √© armazenada no cache como uma resposta ao m√©todo original - GET. Agora, qualquer pr√≥xima solicita√ß√£o GET para o mesmo URI retornar√° um erro em cache.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0r/bv/_q/0rbv_qeocdxi9b4ctw2rschthgw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, o ataque √© um pouco mais amplo do que o apresentado no documento. Os autores se concentraram em armazenar o erro no cache, que n√£o est√° em todo lugar (j√°) pode ser reproduzido. Mas se o m√©todo solicitado para o URI selecionado for definido e for executado com √™xito, o proxy receber√° uma resposta com status 200 e o armazenar√° em cache. Em seguida, solicita√ß√µes subsequentes do mesmo URI para receber respostas para o m√©todo completamente errado. Nesse cen√°rio, n√£o h√° mais um requisito com um erro de cache de respostas 4XX, como na descri√ß√£o original do CPDoS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema inverso pode ocorrer. Se um cliente HTTP respeit√°vel enviar uma solicita√ß√£o GET + X-HTTP-Method-Override: PATCH (isso √© ruim, mas mais sobre isso depois) e o cache j√° tiver uma resposta GET, o cliente receber√° essa resposta em cache. Nesse caso, o back-end nunca receber√° uma solicita√ß√£o PATCH, o que pode violar a l√≥gica do aplicativo no cliente e no servidor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode reduzir o efeito no cache criando as pol√≠ticas de cache corretas e dividindo os recursos em dois grupos: aqueles para os quais a opera√ß√£o de substitui√ß√£o do m√©todo √© inaceit√°vel ou n√£o necess√°ria, as respostas podem ser armazenadas em cache e aqueles para os quais a opera√ß√£o de substitui√ß√£o do m√©todo √© necess√°ria, qualquer armazenamento em cache dessas respostas √© inaceit√°vel. . Por√©m, quanto menos recursos forem armazenados em cache, menos √∫til ser√° a CDN e quanto mais tr√°fego atingir o back-end, mais o aplicativo ser√° exposto √† inunda√ß√£o HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, √© melhor usar o cache HTTP o m√°ximo poss√≠vel, para isso √© necess√°rio que o servidor de cache possa distinguir entre solicita√ß√µes com diferentes m√©todos substitu√≠dos. A primeira maneira √© transferir a substitui√ß√£o do m√©todo do componente de consulta para o URI:</font></font><br>
<br>
<pre><code class="plaintext hljs">POST /some-uri HTTP/1.1<font></font>
X-HTTP-Method-Override: DELETE<font></font>
   ‚Üì  ‚Üì   ‚Üì<font></font>
POST /some-uri?method=DELETE HTTP/1.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, solicita√ß√µes com m√©todos diferentes parecem diferentes para o cache, pois elas obt√™m chaves diferentes. Alguns proxies preferem n√£o armazenar em cache respostas a solicita√ß√µes que cont√™m o componente de consulta no URI. Mas isso afetar√° apenas a efici√™ncia do cache. Esse m√©todo sempre resolve problemas com o cache incorreto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra maneira √© deixar a substitui√ß√£o do m√©todo em um cabe√ßalho separado, mas digite uma chave secund√°ria para encontrar a resposta no cache. Isso √© poss√≠vel com o cabe√ßalho Vary. Ao atender a solicita√ß√£o, o servidor repetir√° o cabe√ßalho com a substitui√ß√£o do m√©todo e refletir√° o nome desse cabe√ßalho no cabe√ßalho Vary. Em seguida, nas solicita√ß√µes a seguir, o servidor de cache usar√° o valor do m√©todo substitu√≠do como uma chave secund√°ria ao procurar uma solicita√ß√£o no cache.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oh/1n/rd/oh1nrdf3x18yktd6moekwlr01-w.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este m√©todo funciona se o servidor intermedi√°rio puder trabalhar com chaves secund√°rias. </font><font style="vertical-align: inherit;">Geralmente, esse √© o caso, mas o n√≠vel de confian√ßa do proxy, que corta todos os m√©todos, exceto GET e POST, geralmente √© mais baixo e √© melhor verificar isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A substitui√ß√£o de um m√©todo por qualquer entidade dentro do corpo da solicita√ß√£o tem exatamente as mesmas desvantagens que a substitui√ß√£o por um cabe√ßalho adicional - est√° fora da visibilidade do cache.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ataques de enfileiramento de mensagens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo se os ataques de cache estiverem fechados, isso n√£o √© tudo. </font><font style="vertical-align: inherit;">Um invasor, substituindo um m√©todo, pode tentar alterar o enquadramento da resposta e, assim, violar a correspond√™ncia dos pares solicita√ß√£o-resposta de outros clientes. </font><font style="vertical-align: inherit;">Ou force o lado do servidor do aplicativo a processar a mesma solicita√ß√£o v√°rias vezes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A coisa mais importante necess√°ria para isso √© um servidor intermedi√°rio operando no modo proxy reverso. Ou seja, qualquer servidor de cache ou CDN. Esse proxy suporta um n√∫mero relativamente pequeno de conex√µes com o back-end e multiplica solicita√ß√µes de muitos clientes em cada um deles. Isso √© necess√°rio para suportar o carregamento de um grande n√∫mero de conex√µes de clientes dos back-ends para o servidor proxy e para equilibrar a carga entre os back-end. O t√©rmino das conex√µes TLS tamb√©m ocorre no proxy, as conex√µes do cliente nunca s√£o conectadas diretamente ao back-end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como agora as solicita√ß√µes de clientes diferentes estar√£o na mesma conex√£o entre o back-end e o proxy, √© necess√°rio manter uma correspond√™ncia clara entre os pares solicita√ß√£o-resposta. A maioria dos proxies </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o canaliza</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(pipelines) solicita ao back-end e trabalha com ele no modo solicita√ß√£o-resposta. O modo solicita√ß√£o-resposta √© mais simples e est√° sujeito a praticamente uma amea√ßa - bloqueio de conex√£o. Se voc√™ deixar a conex√£o travada em um √∫nico par de solicita√ß√£o-resposta, poder√° causar um atraso ou at√© uma recusa em processar as seguintes solicita√ß√µes (por exemplo, se voc√™ conseguir transbordar as filas de solicita√ß√µes de proxy).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solicita√ß√µes de pipeline de proxies mais produtivas para o back-end - isso permite enviar um pacote de solicita√ß√µes ao servidor imediatamente e aguardar sua execu√ß√£o. O desempenho √© maior, mas h√° mais amea√ßas. Primeiro, o problema do bloqueio do cabe√ßalho da linha n√£o desaparece em lugar nenhum - mesmo que o back-end possa varrer o pipeline de consulta e execut√°-lo em paralelo, ele n√£o poder√° ser enviado se o primeiro travar. Em segundo lugar, se voc√™ interromper o enquadramento da resposta, poder√° confundir o proxy e interromper a correspond√™ncia dos pares solicita√ß√£o-resposta; alguns clientes poder√£o receber respostas de outras pessoas ou, pelo menos, conseguir um fechamento instant√¢neo da conex√£o com o back-end.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/td/wn/rj/tdwnrjiw4ekrsl7l1aqda-hhyzi.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A redefini√ß√£o mais simples e divertida de um m√©todo √© substituir GET pelo verbo HEAD. Se a resposta para o primeiro tiver um corpo, o segundo n√£o. Al√©m disso, todos os outros cabe√ßalhos s√£o os mesmos, incluindo aqueles que fornecem o enquadramento da solicita√ß√£o. Quando o proxy redireciona um HEAD substitu√≠do para o servidor, ele espera do servidor n√£o apenas os cabe√ßalhos de resposta, mas tamb√©m o corpo da resposta, que o back-end n√£o enviar√°. Se o proxy e o servidor interagirem no modo de solicita√ß√£o-resposta, a conex√£o ser√° travada at√© que o tempo limite seja interrompido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o servidor enviar as seguintes respostas (modo em pipeline), elas poder√£o ser analisadas n√£o como respostas independentes, mas como parte da resposta incompleta anterior ao GET. O proxy os colocar√° (ou parte deles) no corpo da resposta "GET" e o enviar√° ao invasor para l√™-los. Voc√™ pode criar um pseudo-GET para receber um arquivo grande e despejar algum tr√°fego entre o proxy e o back-end. O sucesso depende de como o back-end coloca os cabe√ßalhos de comprimento do conte√∫do e codifica√ß√£o de transfer√™ncia: agrupados para enquadrar as mensagens. O primeiro quase sempre permite que voc√™ obtenha um despejo, o segundo geralmente gera erros de an√°lise e causa uma desconex√£o do back-end. Se voc√™ n√£o tiver sorte, o pseudo-GET pode cobrir v√°rias respostas na √≠ntegra e terminar um pouco antes da pr√≥xima resposta.O proxy n√£o poder√° reconhecer esse problema e, para obter mais respostas nesse sentido, a correspond√™ncia solicita√ß√£o-resposta ser√° violada.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ee/ds/h9/eedsh90uounshmxglkz5aconiim.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo que tudo o que foi conseguido com a substitui√ß√£o do m√©todo estivesse fechando a conex√£o entre o proxy e o back-end, isso pode ser suficiente para um ataque. </font><font style="vertical-align: inherit;">Voc√™ pode enviar solicita√ß√µes de servi√ßo com essas solicita√ß√µes - as conex√µes com os back-ends quebram constantemente. </font><font style="vertical-align: inherit;">N√£o h√° muitos deles, e a redescoberta leva tempo; como resultado, √© poss√≠vel obter uma diminui√ß√£o significativa no desempenho da comunica√ß√£o de back-end do proxy e, assim, reduzir a taxa de transfer√™ncia do servi√ßo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repeti√ß√£o autom√°tica de spam</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu disse acima que os pedidos do formul√°rio GET + X-HTTP-Method-Override: PATCH de clientes respeit√°veis ‚Äã‚Äãs√£o ruins. E isso √© ruim porque os m√©todos t√™m duas propriedades: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seguran√ßa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idempot√™ncia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Seguran√ßa significa que o m√©todo n√£o altera o estado do servidor (somente leitura) e n√£o nos interessa no contexto deste artigo. A idempot√™ncia do m√©todo garante que a solicita√ß√£o repetida tenha o mesmo efeito que uma √∫nica solicita√ß√£o. Voc√™ pode desenhar uma analogia: </font></font><code>(a = 5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- solicita√ß√£o idempotente e </font></font><code>(a += 2) </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- n√£o idempotente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta propriedade √© o que nos interessa. Se a conex√£o entre o cliente e o servidor interromper repentinamente, o cliente, sabendo que o m√©todo √© idempotente, poder√° reenviar automaticamente a solicita√ß√£o. Proxies se comportam da mesma maneira. Solicita√ß√µes n√£o idempotentes n√£o s√£o repetidas automaticamente porque n√£o se sabe como elas afetam o servidor e o que o cliente receber√° no final. Acho que todo mundo conhece os pop-ups no navegador: "Tem certeza de que deseja repetir a solicita√ß√£o?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ mascarar um m√©todo n√£o idempotente como idempotente, em caso de erros, ele n√£o ser√° descartado, mas ser√° redirecionado ao servidor novamente. Mesmo que o cliente considere o m√©todo de solicita√ß√£o real antes de reenvi√°-la, isso n√£o ajudar√° muito, porque o servidor proxy n√£o est√° ciente da substitui√ß√£o do m√©todo e repetir√° essas solicita√ß√µes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se um invasor conseguir for√ßar desconex√µes entre o back-end e os clientes, ele poder√° fazer com que o servidor execute solicita√ß√µes n√£o idempotentes v√°rias vezes e reduza a confiabilidade e a previsibilidade do aplicativo. </font><font style="vertical-align: inherit;">Na se√ß√£o anterior, descobrimos uma maneira de causar interrup√ß√µes de conex√£o com a mesma substitui√ß√£o de m√©todo. </font><font style="vertical-align: inherit;">Embora tenhamos de lembrar que a Internet √© uma rede n√£o confi√°vel, por defini√ß√£o, e o pr√≥prio aplicativo est√° em perigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para se proteger desse ataque, voc√™ deve usar apenas m√©todos que n√£o adicionam novas propriedades √† solicita√ß√£o como transporte. </font><font style="vertical-align: inherit;">O POST √© um bom candidato, porque, por padr√£o, n√£o √© seguro nem idempotente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse antigo HTTP / 1.1, como no HTTP / 2?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O HTTP / 2 mudou a maneira como as solicita√ß√µes s√£o transportadas entre os n√≥s, mas n√£o mudou seu significado lexical. Portanto, naqueles ataques relacionados ao valor da solicita√ß√£o, o HTTP / 2 se comporta da mesma maneira. Mas os ataques de "transporte" n√£o s√£o reproduzidos, pois eles j√° s√£o levados em considera√ß√£o no padr√£o. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ataques no cache s√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reproduzidos de maneira semelhante ao HTTP / 1 e a prote√ß√£o √© semelhante. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os ataques do servi√ßo de enfileiramento de mensagens</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><strong><font style="vertical-align: inherit;">s√£o</font></strong><font style="vertical-align: inherit;"> aplic√°veis ‚Äã‚Äãao HTTP / 2. As mensagens HTTP nele s√£o divididas em quadros separados, com cabe√ßalhos de quadro separados que determinam explicitamente o comprimento e o final da mensagem. Como se o invasor n√£o mudasse o m√©todo e modificasse os cabe√ßalhos HTTP, isso n√£o afetar√° o quadro da mensagem. Roubar a resposta falhar√°. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ataques √† repeti√ß√£o de mensagens n√£o idempotentes s√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aplic√°veis ‚Äã‚Äãmesmo levando em considera√ß√£o o fato de que no HTTP / 2 existem</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo de notifica√ß√£o da √∫ltima solicita√ß√£o processada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No HTTP / 2, v√°rias solicita√ß√µes s√£o multiplicadas no mesmo TCP e, portanto, criam </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluxos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cada thread tem seu pr√≥prio n√∫mero. </font><font style="vertical-align: inherit;">Se o servidor HTTP / 2 for desconectado, poder√° indicar o n√∫mero da √∫ltima solicita√ß√£o processada no GOAWAY. </font><font style="vertical-align: inherit;">Solicita√ß√µes com um n√∫mero maior sempre s√£o seguras para redirecionar; solicita√ß√µes com um n√∫mero menor s√£o redirecionadas apenas se forem idempotentes. </font><font style="vertical-align: inherit;">Se uma solicita√ß√£o com um m√©todo substitu√≠do parecer idempotente para um servidor proxy, o proxy a encaminhar√° para o servidor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como substituir com seguran√ßa um m√©todo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta curta n√£o √© poss√≠vel. √â melhor n√£o usar substitui√ß√µes de m√©todo. E desative completamente o suporte no back-end, se houver. Bloquear clientes HTTP que substituem m√©todos. Recuse o proxy / WAF, que corta os m√©todos "extras". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ precisar, de alguma forma, conviver com a redefini√ß√£o do m√©todo, evite edi√ß√µes suficientes no back-end. Primeiro, √© aconselh√°vel substituir o m√©todo apenas atrav√©s do componente de consulta do URI.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, deve haver uma lista branca da transforma√ß√£o de m√©todos: que s√£o aceit√°veis ‚Äã‚Äãcomo "transporte" e quais s√£o os resultantes. </font><font style="vertical-align: inherit;">N√£o deve haver fun√ß√µes generalizadas de transforma√ß√£o quando qualquer m√©todo puder ser substitu√≠do por qualquer. </font><font style="vertical-align: inherit;">O m√©todo de "transporte" n√£o deve ter as propriedades de seguran√ßa e idempot√™ncia se o resultante n√£o tiver. </font><font style="vertical-align: inherit;">Transforma√ß√µes perigosas devem ser proibidas, a mesma substitui√ß√£o GET -&gt; HEAD.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preciso corrigir um proxy / WAF com problema?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o proxy implementar apenas os m√©todos GET e POST e bloquear os outros por um motivo ou outro, definitivamente sim. </font><font style="vertical-align: inherit;">Voc√™ pode otimiz√°-lo principalmente para GET e POST, mas bloquear outros m√©todos √© uma m√° id√©ia. </font><font style="vertical-align: inherit;">O que ainda cria um abismo de desconfian√ßa no produto: se coisas b√°sicas s√£o bloqueadas, o que esperar da implementa√ß√£o de problemas mais complexos?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ estiver preocupado com a seguran√ßa de aplicativos Web protegidos, pode valer a pena proteger aplicativos de pol√≠ticas de substitui√ß√£o de m√©todo n√£o seguras. </font><font style="vertical-align: inherit;">Obviamente, no caso geral, sem conhecer os detalhes da implementa√ß√£o do aplicativo Web, √© imposs√≠vel proteger completamente o aplicativo contra substitui√ß√µes incorretas, mas voc√™ pode cobrir parcialmente os usu√°rios que simplesmente n√£o conhecem o problema. </font><font style="vertical-align: inherit;">√â necess√°rio n√£o apenas proteger contra o envenenamento de seu pr√≥prio cache, mas tamb√©m possibilitar ou desativar a substitui√ß√£o de cada aplicativo protegido. </font><font style="vertical-align: inherit;">Para fazer isso, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acompanhe os </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cabe√ßalhos mais usados.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todo X-HTTP, Substitui√ß√£o de m√©todo X-HTTP e Substitui√ß√£o de m√©todo X. </font><font style="vertical-align: inherit;">O rastreamento da redefini√ß√£o no componente de consulta do URI n√£o faz muito sentido: o cache n√£o envenena essa solicita√ß√£o e a consulta pode ser muito longa e ter um formato completamente arbitr√°rio.</font></font><br>
<br>
<h2>      ?</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desenvolvedores de seguran√ßa, n√£o limite os desenvolvedores de aplicativos √†s pol√≠ticas de seguran√ßa. </font><font style="vertical-align: inherit;">Eles ainda descobrir√£o como contorn√°-los, e quanto mais flex√≠vel o protocolo, mais f√°cil ser√° faz√™-lo. </font><font style="vertical-align: inherit;">√â muito prov√°vel que eles n√£o o chutem e esperem at√© voc√™ tornar as restri√ß√µes mais razo√°veis, mas simplesmente ignor√°-las. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ descobriu como implementar algo no protocolo, mas isso substitui ou contraria um dos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principais conceitos do</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> padr√£o, certamente haver√° problemas de compatibilidade e seguran√ßa. </font><font style="vertical-align: inherit;">E eles precisam ser cobertos ao mesmo tempo que a decis√£o. </font><font style="vertical-align: inherit;">Toda vez. </font><font style="vertical-align: inherit;">Se voc√™ seguiu esse conselho e n√£o viu avisos de seguran√ßa, n√£o o duplique em toda a Internet. </font><font style="vertical-align: inherit;">Seja sempre cr√≠tico com a decis√£o e descubra o que pode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dar errado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez de um posf√°cio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais problemas do servidor proxy voc√™ encontrou? </font><font style="vertical-align: inherit;">O que tinha que ser contornado e como?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492706/index.html">Arquivos da mem√≥ria: como o c√©rebro codifica e reproduz mem√≥rias</a></li>
<li><a href="../pt492708/index.html">Internet via sat√©lite global - h√° novidades em campo?</a></li>
<li><a href="../pt492710/index.html">Caminho espinhoso do candidato atrav√©s de v√°rios sistemas de GRH</a></li>
<li><a href="../pt492712/index.html">Dominando o desenvolvimento por meio de testes no Android usando testes de interface do usu√°rio</a></li>
<li><a href="../pt492714/index.html">Trabalho eficaz em casa: geral e pessoal</a></li>
<li><a href="../pt492720/index.html">diskussion: servi√ßo de arquivo do projeto</a></li>
<li><a href="../pt492724/index.html">Bj√∂rn Straustrup responde √†s 5 principais perguntas sobre C ++ com estouro de pilha</a></li>
<li><a href="../pt492726/index.html">OS Sivelkiriya: processo de desenvolvimento de software</a></li>
<li><a href="../pt492728/index.html">Asterisco e envio perdidos em Telegram / Slack / E-mail</a></li>
<li><a href="../pt492730/index.html">Departamento de Defesa dos EUA: √âtica para IA e ve√≠culos n√£o tripulados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>