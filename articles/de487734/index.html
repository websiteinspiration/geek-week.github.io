<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∑ üçÑ üë©‚Äçüë©‚Äçüëß‚Äçüë¶ Beschleunigung des Entity Framework-Kerns üíÖ üñ®Ô∏è üë©üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sei nicht gierig!
 Bei der Auswahl von Daten m√ºssen Sie genau so viele ausw√§hlen, wie Sie gleichzeitig ben√∂tigen. Rufen Sie niemals alle Daten aus ein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Beschleunigung des Entity Framework-Kerns</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487734/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sei nicht gierig!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Auswahl von Daten m√ºssen Sie genau so viele ausw√§hlen, wie Sie gleichzeitig ben√∂tigen. </font><font style="vertical-align: inherit;">Rufen Sie niemals alle Daten aus einer Tabelle ab! </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falsch:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);                
<span class="hljs-comment">//    ID  ,       !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.ID, x.Name, x.ShortName }).ToList();
</code></pre> <br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Korrekt:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);  
<span class="hljs-comment">//     ID     !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.Name, x.ShortName }).ToList();<font></font>
ctx.FederalDistricts.Select(x =&gt; <span class="hljs-keyword">new</span> MyClass { Name = x.Name, ShortName = x.ShortName }).ToList();
</code></pre><br>
<a name="habracut"></a><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falsch:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blog.ToList(); <span class="hljs-comment">//       . ?</span>
<span class="hljs-comment">//     ?</span>
<span class="hljs-keyword">var</span> somePost = blogs.FirstOrDefault(x=&gt;x.Title.StartWidth(‚ÄúHello world!‚Äù));
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Korrekt:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> somePost = context.Blog.FirstOrDefault(x=&gt;x.Title.StartWidth(‚ÄúHello world!‚Äù));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine integrierte Daten√ºberpr√ºfung kann durchgef√ºhrt werden, wenn eine Abfrage einige Datens√§tze zur√ºckgibt. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falsch:</font></font></u><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">StandardizeUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> url</span>)</span><font></font>
{<font></font>
    url = url.ToLower();<font></font>
    <span class="hljs-keyword">if</span> (!url.StartsWith(<span class="hljs-string">"http://"</span>))<font></font>
    {<font></font>
        url = <span class="hljs-keyword">string</span>.Concat(<span class="hljs-string">"http://"</span>, url);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> url;<font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Korrekt:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsEnumerable().Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
 <font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; blog.Contains(<span class="hljs-string">"dotnet"</span>))<font></font>
    .OrderByDescending(blog =&gt; blog.Rating)<font></font>
    .Select(blog =&gt; <span class="hljs-keyword">new</span><font></font>
    {<font></font>
        Id = blog.BlogId,<font></font>
        Url = StandardizeUrl(blog.Url)<font></font>
    })<font></font>
    .ToList();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wow, wow, wow, getaktet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist Zeit, Ihr Wissen √ºber LINQ-Techniken ein wenig aufzufrischen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schauen wir uns die Unterschiede zwischen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList </font></font></i><i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsEnumerable</font></font></i></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AsQueryable an</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList</font></font></i><br>
<br>
<ul>
<li>  .</li>
<li> <i>.ToList()</i>           (lazy loading),            .</li>
</ul><br>
<i>AsEnumerable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li> : <i>Func &lt;TSource, bool&gt;</i></li>
<li>          (   <b>Where/Take/Skip</b>   , ,   select * from Table1, </li>
<li>    ,    N )</li>
<li>    : <i>Linq-to-SQL + Linq-to-Object</i>.</li>
<li> <i>IEnumerable </i>          (lazy loading).</li>
</ul><br>
<i>AsQueryable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">  :</a> <pre><code class="cs hljs">AsQueryable(IEnumerable)  AsQueryable&lt;TElement&gt;(IEnumerable&lt;TElement&gt;) </code></pre><br>
</li>
<li> Expression  T-SQL (   ),         .</li>
<li>  DbSet ( Entity Framework)    AsQueryable    .</li>
<li>   ,   <b>Take(5)</b>     <b>¬´select top 5 * SQL¬ª</b>   .  ,       SQL  ,     .  <i>AsQueryable()</i>   ,  <i>AsEnumerable()</i>     T-SQL      Linq  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsQueryable,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Sie eine Datenbankabfrage w√ºnschen, die verbessert werden kann, bevor sie auf der Serverseite ausgef√ºhrt wird.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Beispiel f√ºr die Verwendung von AsQueryable im einfachsten Fall:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;EmailView&gt; <span class="hljs-title">GetEmails</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> <span class="hljs-keyword">int</span> totalRecords, Guid? deviceWorkGroupID,
                DateTime? timeStart, DateTime? timeEnd, <span class="hljs-keyword">string</span> search, <span class="hljs-keyword">int</span>? confirmStateID, <span class="hljs-keyword">int</span>? stateTypeID, <span class="hljs-keyword">int</span>? limitOffset, <span class="hljs-keyword">int</span>? limitRowCount, <span class="hljs-keyword">string</span> orderBy, <span class="hljs-keyword">bool</span> desc</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> List&lt;EmailView&gt;();<font></font>
<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> GJobEntities())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> query = db.Emails.AsQueryable();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (timeStart != <span class="hljs-literal">null</span> &amp;&amp; timeEnd != <span class="hljs-literal">null</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.Created &gt;= timeStart &amp;&amp; p.Created &lt;= timeEnd);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (stateTypeID != <span class="hljs-literal">null</span> &amp;&amp; stateTypeID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.EmailStates.OrderByDescending(x =&gt; x.AtTime).FirstOrDefault().EmailStateTypeID == stateTypeID);<font></font>
                }<font></font>
<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (confirmStateID != <span class="hljs-literal">null</span> &amp;&amp; confirmStateID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> boolValue = confirmStateID == <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<font></font>
                    query = query.Where(p =&gt; p.IsConfirmed == boolValue);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrEmpty(search))<font></font>
                {<font></font>
                    search = search.ToLower();<font></font>
                    query = query.Where(p =&gt; (p.Subject + <span class="hljs-string">" "</span> + p.CopiesEmails + <span class="hljs-string">" "</span> + p.ToEmails + <span class="hljs-string">" "</span> + p.FromEmail + <span class="hljs-string">" "</span> + p.Body)<font></font>
                                        .ToLower().Contains(search));<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (deviceWorkGroupID != Guid.Empty)<font></font>
                {<font></font>
                    query = query.Where(x =&gt; x.SCEmails.FirstOrDefault().SupportCall.Device.DeviceWorkGroupDevices.FirstOrDefault(p =&gt; p.DeviceWorkGroupID == deviceWorkGroupID) != <span class="hljs-literal">null</span>);<font></font>
                }<font></font>
<font></font>
                totalRecords = query.Count();<font></font>
                query = query.OrderByDescending(p =&gt; p.Created);<font></font>
                <span class="hljs-keyword">if</span> (limitOffset.HasValue)<font></font>
                {<font></font>
                    query = query.Skip(limitOffset.Value).Take(limitRowCount.Value);<font></font>
                }<font></font>
                <span class="hljs-keyword">var</span> items = query.ToList(); <span class="hljs-comment">//    </span><font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">new</span> EmailView<font></font>
                    {<font></font>
                        ID = item.ID,<font></font>
                        SentTime = item.SentTime,<font></font>
                        IsConfirmed = item.IsConfirmed,<font></font>
                        Number = item.Number,<font></font>
                        Subject = item.Subject,<font></font>
                        IsDeleted = item.IsDeleted,<font></font>
                        ToEmails = item.ToEmails,<font></font>
                        Created = item.Created,<font></font>
                        CopiesEmails = item.CopiesEmails,<font></font>
                        FromEmail = item.FromEmail,<font></font>
                    };<font></font>
<font></font>
                    <span class="hljs-comment">//     - </span><font></font>
<font></font>
                    r.Add(n);<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> r;<font></font>
        }<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Magie des einfachen Lesens</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie keine Daten √§ndern m√ºssen, verwenden Sie einfach die </font><font style="vertical-align: inherit;">Methode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AsNoTracking ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langsame Probenahme</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.ToList();</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schnellabruf (schreibgesch√ºtzt)</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsNoTracking().ToList();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºhlen Sie sich schon etwas aufgew√§rmt? </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arten des Ladens verwandter Daten</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr diejenigen, die vergessen haben, was </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">faules Laden ist</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lazy Loading </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Lazy Loading)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bedeutet, dass die zugeh√∂rigen Daten beim Zugriff auf die Navigationseigenschaft transparent aus der Datenbank geladen werden. Lesen Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mehr </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig m√∂chte ich Sie an andere Arten des Ladens von Daten erinnern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktives Laden </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Eifriges Laden)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bedeutet, dass die zugeh√∂rigen Daten als Teil der ersten Anforderung aus der Datenbank geladen werden.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blogs = context.Blogs<font></font>
        .Include(blog =&gt; blog.Posts)<font></font>
            .ThenInclude(post =&gt; post.Author)<font></font>
                .ThenInclude(author =&gt; author.Photo)<font></font>
        .Include(blog =&gt; blog.Owner)<font></font>
            .ThenInclude(owner =&gt; owner.Photo)<font></font>
        .ToList();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachtung! </font><font style="vertical-align: inherit;">Ab Version EF Core 3.0.0 wird mit jedem Include ein zus√§tzlicher </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu den von relationalen Anbietern generierten SQL-Abfragen </font><font style="vertical-align: inherit;">hinzugef√ºgt </font><font style="vertical-align: inherit;">, w√§hrend in fr√ºheren Versionen zus√§tzliche SQL-Abfragen generiert wurden. </font><font style="vertical-align: inherit;">Dies kann die Leistung Ihrer Abfragen erheblich verbessern, zum Guten oder zum Schlechten. </font><font style="vertical-align: inherit;">Insbesondere LINQ-Abfragen mit einer extrem gro√üen Anzahl von Einschlussanweisungen k√∂nnen in mehrere separate LINQ-Abfragen aufgeteilt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explizites Laden </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Explizites Laden)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bedeutet, dass die zugeh√∂rigen Daten sp√§ter explizit aus der Datenbank geladen werden.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blog = context.Blogs<font></font>
        .Single(b =&gt; b.BlogId == <span class="hljs-number">1</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> goodPosts = context.Entry(blog)<font></font>
        .Collection(b =&gt; b.Posts)<font></font>
        .Query()<font></font>
        .Where(p =&gt; p.Rating &gt; <span class="hljs-number">3</span>)<font></font>
        .ToList();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ruck und Durchbruch! </font><font style="vertical-align: inherit;">Weitermachen?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereit, noch schneller zu werden?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Abrufen komplex strukturierter und sogar abnormalisierter Daten aus einer relationalen Datenbank erheblich zu beschleunigen, gibt es zwei M√∂glichkeiten: Verwenden Sie indizierte Ansichten (1) oder, noch besser, vorbereitete (berechnete) Daten in einer einfachen flachen Form f√ºr die Anzeige (2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indizierte Ansicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Kontext von MS SQL Server</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die indizierte Ansicht verf√ºgt √ºber einen eindeutigen Clustered-Index. </font><font style="vertical-align: inherit;">Ein eindeutiger Clustered-Index wird in SQL Server gespeichert und wie jeder andere Clustered-Index aktualisiert. </font><font style="vertical-align: inherit;">Eine indizierte Ansicht ist wichtiger als Standardansichten, die eine komplexe Verarbeitung einer gro√üen Anzahl von Zeilen umfassen, z. B. das Aggregieren einer gro√üen Datenmenge oder das Kombinieren mehrerer Zeilen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn in Abfragen h√§ufig auf solche Ansichten verwiesen wird, k√∂nnen wir die Leistung verbessern, indem wir einen eindeutigen Clustered-Index f√ºr die Ansicht erstellen. Bei einer Standardansicht wird die Ergebnismenge nicht in der Datenbank gespeichert, sondern die Ergebnismenge wird f√ºr jede Abfrage berechnet. Bei einem Clustered-Index wird die Ergebnismenge jedoch wie eine Tabelle mit einem Clustered-Index in der Datenbank gespeichert. Abfragen, die die indizierte Ansicht nicht speziell verwenden, k√∂nnen sogar von der Existenz eines Clustered-Index aus der Ansicht profitieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Darstellung eines Index hat bestimmte Kosten in Form von Produktivit√§t. Wenn wir eine indizierte Ansicht erstellen, muss SQL Server jedes Mal, wenn wir die Daten in den Basistabellen √§ndern, nicht nur die Indexdatens√§tze in diesen Tabellen, sondern auch die Indexdatens√§tze in der Ansicht unterst√ºtzen. In SQL Server-Editionen f√ºr Entwickler und Unternehmen kann das Optimierungsprogramm Ansichtsindizes verwenden, um Abfragen zu optimieren, die keine indizierte Ansicht angeben. In anderen Editionen von SQL Server muss die Abfrage jedoch eine indizierte Ansicht enthalten und einen NOEXPAND-Hinweis enthalten, um den Index in der Ansicht nutzen zu k√∂nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(2) Wenn Sie eine Anfrage stellen m√ºssen, bei der mehr als drei Ebenen verwandter Tabellen in H√∂he von drei oder mehr mit erh√∂htem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRUD angezeigt werden m√ºssen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laden, der beste Weg w√§re, die Ergebnismenge regelm√§√üig zu berechnen, in einer Tabelle zu speichern und f√ºr die Anzeige zu verwenden. </font><font style="vertical-align: inherit;">Die resultierende Tabelle, in der die Daten gespeichert werden, sollte einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prim√§rschl√ºssel und Indizes f√ºr die Suchfelder in LINQ enthalten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist mit Asynchronit√§t?</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja! </font><font style="vertical-align: inherit;">Wir verwenden es wo immer m√∂glich! </font><font style="vertical-align: inherit;">Hier ist ein Beispiel:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Do</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> myTask = GetFederalDistrictsAsync ();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> myTask.Result)<font></font>
    {<font></font>
         <span class="hljs-comment">// </span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
    optionsBuilder.UseSqlServer(conn);<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.ToListAsync();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und ja, haben Sie etwas vergessen, um die Produktivit√§t zu steigern? </font><font style="vertical-align: inherit;">Buum!</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.&lt;b&gt;AsNoTracking()&lt;/b&gt;.ToListAsync();</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hinweis: Die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Methode wurde </font><font style="vertical-align: inherit;">nur zu Demonstrationszwecken hinzugef√ºgt, um die Funktionsf√§higkeit der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetFederalDistrictsAsync ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Methode </font><b><font style="vertical-align: inherit;">anzuzeigen</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wie meine Kollegen richtig bemerkt haben, wird ein weiteres Beispiel f√ºr reine Asynchronit√§t ben√∂tigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und lassen Sie es mich basierend auf dem Konzept </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Ansichtskomponente in ASP .NET Core geben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PopularPosts</span> : <span class="hljs-title">ViewComponent</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IStatsRepository _statsRepository;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PopularPosts</span>(<span class="hljs-params">IStatsRepository statsRepository</span>)</span><font></font>
        {<font></font>
            _statsRepository = statsRepository;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
           <span class="hljs-comment">//         -</span>
            <span class="hljs-keyword">var</span> federalDistricts = <span class="hljs-keyword">await</span> _statsRepository.GetFederalDistrictsAsync(); 
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> TablePageModel()<font></font>
            {<font></font>
                FederalDistricts = federalDistricts,<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">return</span> View(model);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">// </span><font></font>
    <font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span>  -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span>
        <span class="hljs-function">IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
	<span class="hljs-comment"><span class="hljs-doctag">///</span> !!!</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><font></font>
        Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync();<font></font>
    }	<font></font>
	<font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StatsRepository</span> : <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;<font></font>
            optionsBuilder = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfigurationRoot configurationRoot;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StatsRepository</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            IConfigurationBuilder configurationBuilder = <span class="hljs-keyword">new</span> ConfigurationBuilder()<font></font>
                    .SetBasePath(Environment.CurrentDirectory)<font></font>
                    .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">true</span>, reloadOnChange: <span class="hljs-literal">true</span>);<font></font>
            configurationRoot = configurationBuilder.Build();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToListAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> ctx.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToList();<font></font>
        }<font></font>
    }<font></font>
<font></font>
   <span class="hljs-comment">//         Home\Index </span>
    &lt;div id=<span class="hljs-string">"tableContainer"</span>&gt;<font></font>
            @await Component.InvokeAsync(<span class="hljs-string">"PopularPosts"</span>)<font></font>
     &lt;/div&gt;<font></font>
  <span class="hljs-comment">//   HTML      Shared\Components\PopularPosts\Default.cshtml</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich m√∂chte Sie daran erinnern, wenn Abfragen im Entity Framework Core ausgef√ºhrt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Aufrufen von LINQ-Anweisungen erstellen Sie einfach eine Abfrageansicht im Speicher. </font><font style="vertical-align: inherit;">Die Anforderung wird erst nach Verarbeitung der Ergebnisse an die Datenbank gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Folgenden sind die h√§ufigsten Vorg√§nge aufgef√ºhrt, die dazu f√ºhren, dass eine Anforderung an die Datenbank gesendet wird.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durchlaufen Sie die Ergebnisse in einer for-Schleife.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden eines Operators wie ToList, ToArray, Single, Count.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binden von Daten aus Abfrageergebnissen an die Benutzeroberfl√§che.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie organisiere ich den EF Core-Code in Bezug auf die Anwendungsarchitektur?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1) Aus Sicht der Architektur der Anwendung m√ºssen Sie sicherstellen, dass der Zugangscode zu Ihrer Datenbank an einer klar definierten Stelle (isoliert) isoliert / getrennt ist. </font><font style="vertical-align: inherit;">Auf diese Weise k√∂nnen Sie Datenbankcode finden, der sich auf die Leistung auswirkt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(2) Mischen Sie den Zugangscode f√ºr Ihre Datenbank nicht mit anderen Teilen der Anwendung, wie z. B. der Benutzeroberfl√§che oder der API. </font><font style="vertical-align: inherit;">Somit kann der Datenbankzugriffscode ge√§ndert werden, ohne sich um andere Probleme zu k√ºmmern, die nicht mit der Datenbank zusammenh√§ngen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie speichere </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ich</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Daten korrekt und schnell mit </font><i><font style="vertical-align: inherit;">SaveChanges</font></i><font style="vertical-align: inherit;"> ?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die eingef√ºgten Datens√§tze identisch sind, ist es sinnvoll, f√ºr alle Datens√§tze einen Speichervorgang zu verwenden. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falsch</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
    <span class="hljs-comment">//   1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1);<font></font>
<font></font>
  <span class="hljs-comment">//          db.SaveChanges();</span><font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Korrekt</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
   <span class="hljs-comment">//  1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1); <font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
   <span class="hljs-comment">//    N </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt immer Ausnahmen von der Regel. </font><font style="vertical-align: inherit;">Wenn der Transaktionskontext komplex ist, dh aus mehreren unabh√§ngigen Vorg√§ngen besteht, k√∂nnen Sie nach jedem Vorgang speichern. </font><font style="vertical-align: inherit;">Und es ist noch korrekter, asynchronen Speicher in einer Transaktion zu verwenden.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddDepositToHousehold</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> householdId, DepositRequestModel model</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> transaction = <span class="hljs-keyword">await</span> Context.Database.BeginTransactionAsync(IsolationLevel.Snapshot))<font></font>
    {<font></font>
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            <span class="hljs-comment">//     </span>
            <span class="hljs-keyword">var</span> deposit = <span class="hljs-keyword">this</span>.Mapper.Map&lt;Deposit&gt;(model);
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Deposits.AddAsync(deposit);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//    </span>
               <span class="hljs-keyword">var</span> debtsToPay = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Debts.Where(d =&gt; d.HouseholdId == householdId &amp;&amp; !d.IsPaid).OrderBy(d =&gt; d.DateMade).ToListAsync();<font></font>
<font></font>
            debtsToPay.ForEach(d =&gt; d.IsPaid = <span class="hljs-literal">true</span>);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//   </span>
            <span class="hljs-keyword">var</span> household = <span class="hljs-keyword">this</span>.Context.Households.FirstOrDefaultAsync(h =&gt; h.Id == householdId);<font></font>
<font></font>
            household.Balance += model.DepositAmount;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            transaction.Commit();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.Ok();<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span><font></font>
        {<font></font>
            transaction.Rollback();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.BadRequest();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trigger, berechnete Felder, benutzerdefinierte Funktionen und EF Core</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Belastung von Anwendungen mit EF Core zu verringern, ist es sinnvoll, einfach berechnete Felder und Datenbankausl√∂ser zu verwenden. Es ist jedoch besser, sich nicht einzumischen, da die Anwendung sehr verwirrend sein kann. </font><font style="vertical-align: inherit;">Benutzerdefinierte Funktionen k√∂nnen jedoch besonders bei Abrufvorg√§ngen sehr n√ºtzlich sein!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallelit√§t in EF Core</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie alles parallelisieren m√∂chten, um die Geschwindigkeit zu erh√∂hen, brechen Sie ab: EF Core unterst√ºtzt nicht die Ausf√ºhrung mehrerer paralleler Operationen in einer Instanz des Kontexts. </font><font style="vertical-align: inherit;">Warten Sie, bis ein Vorgang abgeschlossen ist, bevor Sie mit dem n√§chsten beginnen. </font><font style="vertical-align: inherit;">Dazu m√ºssen Sie normalerweise in jeder asynchronen Operation das Schl√ºsselwort await angeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EF Core verwendet asynchrone Abfragen, um zu vermeiden, dass der Fluss beim Ausf√ºhren einer Abfrage in der Datenbank blockiert wird. </font><font style="vertical-align: inherit;">Asynchrone Anforderungen sind wichtig, um eine schnelle Reaktion der Benutzeroberfl√§che in Thick Clients sicherzustellen. </font><font style="vertical-align: inherit;">Sie k√∂nnen auch den Durchsatz in einer Webanwendung erh√∂hen, in der Sie den Thread f√ºr andere Anforderungen freigeben k√∂nnen. </font><font style="vertical-align: inherit;">Hier ist ein Beispiel:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Blog&gt;&gt; GetBlogsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.Blogs.ToListAsync();<font></font>
    }<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was wissen Sie √ºber LINQ-kompilierte Abfragen?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie eine Anwendung haben, die wiederholt strukturell √§hnliche Abfragen im Entity Framework ausf√ºhrt, k√∂nnen Sie die Leistung h√§ufig verbessern, indem Sie die Abfrage einmal kompilieren und mehrmals mit unterschiedlichen Parametern ausf√ºhren. Beispielsweise muss eine Anwendung m√∂glicherweise alle Kunden in einer bestimmten Stadt erreichen. Die Stadt wird zur Laufzeit vom Benutzer im Formular angegeben. LINQ to Entities unterst√ºtzt zu diesem Zweck die Verwendung kompilierter Abfragen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ab .NET Framework 4.5 werden LINQ-Abfragen automatisch zwischengespeichert. </font><font style="vertical-align: inherit;">Sie k√∂nnen jedoch weiterhin kompilierte LINQ-Abfragen verwenden, um diese Kosten in nachfolgenden L√§ufen zu senken, und kompilierte Abfragen k√∂nnen effizienter sein als LINQ-Abfragen, die automatisch zwischengespeichert werden. </font><font style="vertical-align: inherit;">Beachten Sie, dass LINQ to Entities-Abfragen, die den Operator Enumerable.Contains auf speicherinterne Sammlungen anwenden, nicht automatisch zwischengespeichert werden. </font><font style="vertical-align: inherit;">Die Parametrisierung speicherinterner Sammlungen in kompilierten LINQ-Abfragen ist ebenfalls nicht zul√§ssig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viele Beispiele finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machen Sie keine gro√üen DbContext-Kontexte!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen kenne ich viele von Ihnen, wenn nicht fast alle, von faulen f_u__c_k__e_r__s und der gesamten Datenbank, die Sie in einen Kontext stellen. Dies gilt insbesondere f√ºr den Database-First-Ansatz. </font><font style="vertical-align: inherit;">Und vergebens machst du es! </font><font style="vertical-align: inherit;">Das Folgende ist ein Beispiel daf√ºr, wie der Kontext unterteilt werden kann. </font><font style="vertical-align: inherit;">Nat√ºrlich m√ºssen Verbindungstabellen zwischen Kontexten dupliziert werden, dies ist ein Minus. </font><font style="vertical-align: inherit;">Auf die eine oder andere Weise ist es besser, √ºber eine Aufteilung nachzudenken, wenn Sie mehr als 50 Tabellen im Kontext haben.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden der Kontextgruppierung (Pooling von DdContext)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Bedeutung des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pools </font><font style="vertical-align: inherit;">besteht darin, die Wiederverwendung von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Instanzen </font><font style="vertical-align: inherit;">aus dem Pool zu erm√∂glichen, was in einigen F√§llen zu einer besseren Leistung f√ºhren kann, als jedes Mal eine neue Instanz zu erstellen. </font><font style="vertical-align: inherit;">Dies ist auch der Hauptgrund f√ºr das Erstellen eines Verbindungspools in ADO.NET, obwohl Leistungssteigerungen f√ºr Verbindungen bedeutender sind, da Verbindungen im Allgemeinen eine schwierigere Ressource sind.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Demos</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Blog</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> BlogId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Url { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BloggingContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> InstanceCount;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BloggingContext</span>(<span class="hljs-params">DbContextOptions options</span>)
            : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span>
            =&gt; Interlocked.Increment(<span class="hljs-keyword">ref</span> InstanceCount);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Blog&gt; Blogs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BlogController</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> BloggingContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BlogController</span>(<span class="hljs-params">BloggingContext context</span>)</span> =&gt; _context = context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ActionAsync</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> _context.Blogs.FirstAsync();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> ConnectionString<font></font>
            = <span class="hljs-string">@"Server=(localdb)\mssqllocaldb;Database=Demo.ContextPooling;Integrated Security=True;ConnectRetryCount=0"</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            services.AddDbContext&lt;BloggingContext&gt;(c =&gt; c.UseSqlServer(ConnectionString));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Threads = <span class="hljs-number">32</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Seconds = <span class="hljs-number">10</span>;<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> _requestsProcessed;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> serviceCollection = <span class="hljs-keyword">new</span> ServiceCollection();
            <span class="hljs-keyword">new</span> Startup().ConfigureServices(serviceCollection);
            <span class="hljs-keyword">var</span> serviceProvider = serviceCollection.BuildServiceProvider();<font></font>
<font></font>
            SetupDatabase(serviceProvider);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> stopwatch = <span class="hljs-keyword">new</span> Stopwatch();<font></font>
<font></font>
            MonitorResults(TimeSpan.FromSeconds(Seconds), stopwatch);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> Task.WhenAll(<font></font>
                Enumerable<font></font>
                    .Range(<span class="hljs-number">0</span>, Threads)<font></font>
                    .Select(_ =&gt; SimulateRequestsAsync(serviceProvider, stopwatch)));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetupDatabase</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> context = serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (context.Database.EnsureCreated())<font></font>
                {<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Dog Blog"</span>, Url = <span class="hljs-string">"http://sample.com/dogs"</span> });<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Cat Blog"</span>, Url = <span class="hljs-string">"http://sample.com/cats"</span> });<font></font>
                    context.SaveChanges();<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SimulateRequestsAsync</span>(<span class="hljs-params">IServiceProvider serviceProvider, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.IsRunning)<font></font>
            {<font></font>
                <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
                {<font></font>
                    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> BlogController(serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;()).ActionAsync();<font></font>
                }<font></font>
<font></font>
                Interlocked.Increment(<span class="hljs-keyword">ref</span> _requestsProcessed);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MonitorResults</span>(<span class="hljs-params">TimeSpan duration, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> lastInstanceCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastRequestCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastElapsed = TimeSpan.Zero;<font></font>
<font></font>
            stopwatch.Start();<font></font>
<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.Elapsed &lt; duration)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">1</span>));<font></font>
<font></font>
                <span class="hljs-keyword">var</span> instanceCount = BloggingContext.InstanceCount;
                <span class="hljs-keyword">var</span> requestCount = _requestsProcessed;
                <span class="hljs-keyword">var</span> elapsed = stopwatch.Elapsed;
                <span class="hljs-keyword">var</span> currentElapsed = elapsed - lastElapsed;
                <span class="hljs-keyword">var</span> currentRequests = requestCount - lastRequestCount;<font></font>
<font></font>
                Console.WriteLine(<font></font>
                    <span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now:HH:mm:ss.fff}</span>] "</span>
                    + <span class="hljs-string">$"Context creations/second: <span class="hljs-subst">{instanceCount - lastInstanceCount}</span> | "</span>
                    + <span class="hljs-string">$"Requests/second: <span class="hljs-subst">{Math.Round(currentRequests / currentElapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
                lastInstanceCount = instanceCount;<font></font>
                lastRequestCount = requestCount;<font></font>
                lastElapsed = elapsed;<font></font>
            }<font></font>
<font></font>
            Console.WriteLine();<font></font>
            Console.WriteLine(<span class="hljs-string">$"Total context creations: <span class="hljs-subst">{BloggingContext.InstanceCount}</span>"</span>);<font></font>
            Console.WriteLine(<font></font>
                <span class="hljs-string">$"Requests per second:     <span class="hljs-subst">{Math.Round(_requestsProcessed / stopwatch.Elapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
            stopwatch.Stop();<font></font>
        }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie vermeide ich unn√∂tige Fehler mit CRUD in EF Core?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºgen Sie niemals Berechnungen in denselben Code ein. </font><font style="vertical-align: inherit;">Trennen Sie immer die Bildung / Vorbereitung eines Objekts und dessen Einf√ºgen / Aktualisieren. </font><font style="vertical-align: inherit;">Verteilen Sie es einfach nach Funktionen: √úberpr√ºfen der vom Benutzer eingegebenen Daten, Berechnen der erforderlichen vorl√§ufigen Daten, Zuordnen oder Erstellen eines Objekts und der tats√§chlichen CRUD-Operation.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was tun, wenn die Anwendungsleistung wirklich schlecht ist?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bier wird hier definitiv nicht helfen. </font><font style="vertical-align: inherit;">Was jedoch helfen wird, ist die Trennung von Lesen und Schreiben in der Anwendungsarchitektur, gefolgt von der Zuordnung dieser Operationen zu Sockets. </font><font style="vertical-align: inherit;">Denken Sie an die Verwendung des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CQRS-Musters (Command and Query Responsibility Segregation)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und versuchen Sie auch, Tabellen in Einf√ºgungen aufzuteilen und zwischen zwei Datenbanken zu lesen. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beschleunigen Sie Anwendungen f√ºr Sie, Freunde und Kollegen!</font></font></i></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487716/index.html">Perfekt SAST. Parser</a></li>
<li><a href="../de487720/index.html">Zum Wettbewerbskorutinismus (am Beispiel der reaktiven Programmierung)</a></li>
<li><a href="../de487724/index.html">BlazingPizza: Blazor App von Anfang bis Ende. Teil 2. F√ºgen Sie eine Komponente hinzu</a></li>
<li><a href="../de487728/index.html">@ Pythonetc-Zusammenstellung, Januar 2020</a></li>
<li><a href="../de487730/index.html">Verarbeitung nat√ºrlicher Sprache. Ergebnisse 2019 und Trends f√ºr 2020</a></li>
<li><a href="../de487738/index.html">Schemaanimation in SCADA</a></li>
<li><a href="../de487740/index.html">Zusammenbau eines tragbaren Magnetometers</a></li>
<li><a href="../de487742/index.html">Arbitrage-Handel (Bellman-Ford-Algorithmus)</a></li>
<li><a href="../de487744/index.html">FARO stellt den FOCUS S 70 Laser 3D Scanner vor</a></li>
<li><a href="../de487746/index.html">Ewig</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>