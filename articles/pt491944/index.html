<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèª ‚õ∞Ô∏è üêæ Como combinar duas plataformas em uma e n√£o ofender os usu√°rios. Experi√™ncia dos desenvolvedores do Yandex.Kew üö∂üèª üñïüèº ‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No ano passado, o servi√ßo TheQuestion ingressou na Yandex. Naquela √©poca, j√° havia um servi√ßo semelhante de perguntas e respostas - Yandex.Znatoki. Os...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como combinar duas plataformas em uma e n√£o ofender os usu√°rios. Experi√™ncia dos desenvolvedores do Yandex.Kew</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/491944/"><img src="https://habrastorage.org/webt/je/qm/jf/jeqmjfqycb2lqolmutp76tgjrem.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No ano passado, o servi√ßo TheQuestion ingressou na Yandex. Naquela √©poca, j√° havia um servi√ßo semelhante de perguntas e respostas - Yandex.Znatoki. Os conhecedores tinham um grande p√∫blico e muitas perguntas interessantes, mas n√£o havia especialistas suficientes que pudessem dar respostas de alta qualidade a essas perguntas. A pergunta, pelo contr√°rio, tinha uma forte comunidade de especialistas, mas faltava perguntas interessantes. O passo l√≥gico foi combinar os dois servi√ßos para obter o melhor de cada um deles. Mas como fazer isso se cada servi√ßo tiver sua pr√≥pria base tecnol√≥gica, conte√∫do e usu√°rios?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje vou falar sobre como nossa equipe resolveu esse problema do ponto de vista tecnol√≥gico. Voc√™ descobrir√° quais op√ß√µes de combina√ß√£o n√≥s consideramos e quais no final foram escolhidas. Vou falar sobre a "API de troca", migra√ß√£o de banco de dados, perfis de pool e teste de back-end. E ainda - sobre a noite da mudan√ßa sem o direito de cometer um erro. Voc√™ ver√° que n√£o precisamos ficar entediados.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa de mesclar dois servi√ßos em um n√£o √© nova, mas isso n√£o facilita. A hist√≥ria conhece muitos exemplos bem-sucedidos (e nem tanto) de integra√ß√£o, mas, infelizmente, n√£o existe uma ‚Äúbala de prata‚Äù e uma instru√ß√£o clara ‚Äúfa√ßa isso e tudo dar√° certo‚Äù. Tudo depende muito das especificidades dos servi√ßos que est√£o sendo combinados e do resultado desejado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, o objetivo era o seguinte: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que todo o conte√∫do j√° escrito em cada um dos sites estivesse dispon√≠vel em um servi√ßo unificado e que seus autores pudessem gerenci√°-lo.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ent√£o, como voc√™ combina os dois servi√ßos de perguntas e respostas, que parecem t√£o semelhantes, mas muito diferentes em ess√™ncia? A transfer√™ncia de conte√∫do e usu√°rios de um servi√ßo para outro √© muito semelhante √† mudan√ßa de um apartamento antigo para outro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Somente no nosso caso, o usu√°rio pode viver simultaneamente em dois apartamentos (especialistas e TheQuestion), e voc√™ precisa transport√°-lo cuidadosamente para o terceiro. Voc√™ precisa mover todos os m√≥veis, plantas, um gato e at√© papel de parede para um novo apartamento (ou seja, perguntas, respostas, coment√°rios, curtidas) e depois convid√°-lo a se mudar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como fazer isso? V√°rias op√ß√µes v√™m imediatamente √† mente. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o 1. Muito ruim.</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vamos pegar um dos servi√ßos, transferir todo o conte√∫do para outro (embora at√© isso n√£o seja mais f√°cil) e fechar o servi√ßo original.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta op√ß√£o √© muito ruim do ponto de vista do usu√°rio do primeiro servi√ßo. Acabamos de demolir sua casa antiga e o for√ßamos a mudar para uma nova. Qualquer pessoa n√£o vai gostar dessa atitude e, em vez de se mexer, pode simplesmente entrar no p√¥r do sol. Para n√≥s, o principal valor √© a comunidade de usu√°rios, portanto, n√£o planejamos ofender ningu√©m. E corajosamente mudou para outras op√ß√µes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o 2. Ruim</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
N√£o vamos alterar nenhum dos servi√ßos, em vez disso, inicie um novo e integrado, e adicionaremos periodicamente conte√∫do dos outros dois (por exemplo, uma vez por dia).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, n√£o parecemos piorar o usu√°rio, mas tamb√©m n√£o melhoramos. Seu antigo apartamento permanece inalterado, mas n√£o faz sentido mudar para um novo. Todos os vizinhos tamb√©m moram em uma casa antiga; uma flor rec√©m-comprada ser√° transportada para um novo apartamento somente ap√≥s um dia. Esse servi√ßo unificado n√£o tem chance de se tornar um novo lar. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o 3. Bom, mas dif√≠cil</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
: n√£o fechemos nenhum dos servi√ßos, duplicaremos instantaneamente o conte√∫do e os perfis no servi√ßo integrado e as pessoas se mover√£o com o tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os vizinhos do usu√°rio (e at√© o gato) vivem simultaneamente na casa antiga e na nova. Uma flor que voc√™ acabou de comprar aparece instantaneamente em um apartamento novo. Exatamente o que √© necess√°rio! Esta op√ß√£o √© a mais confort√°vel do ponto de vista do usu√°rio. Portanto, n√≥s escolhemos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comece a se mover</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que fizemos eventualmente pode ser descrito em v√°rias frases. </font><font style="vertical-align: inherit;">Repetimos completamente todo o back-end da API TheQuestion com base no back-end dos conhecedores, obtendo assim um √∫nico back-end que pode funcionar com dois (e at√© tr√™s) sites ao mesmo tempo. </font><font style="vertical-align: inherit;">Ao mesmo tempo, o front end do TheQuestion permaneceu praticamente inalterado, o que significa que, do ponto de vista dos usu√°rios, o pr√≥prio site praticamente n√£o mudou. </font><font style="vertical-align: inherit;">Este projeto recebeu o nome interno "API de troca". </font><font style="vertical-align: inherit;">Mas as primeiras coisas primeiro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que t√≠nhamos na entrada: dois locais completamente independentes. </font><font style="vertical-align: inherit;">Os especialistas vivem nas nuvens internas de Yandex. </font><font style="vertical-align: inherit;">O back-end dos conhecedores √© escrito em Python. </font><font style="vertical-align: inherit;">O TheQuestion vive nas nuvens do Microsoft Azure, o back-end do TheQuestion est√° escrito em Go. </font><font style="vertical-align: inherit;">Os servi√ßos t√™m um esquema de armazenamento de dados completamente diferente nos bancos de dados. </font><font style="vertical-align: inherit;">Al√©m disso, o TheQuestion possui dois aplicativos m√≥veis (para Android e iOS), que tamb√©m precisam ser suportados. </font><font style="vertical-align: inherit;">Em geral, o inimigo n√£o quer unir esse zool√≥gico.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wh/i0/8z/whi08z8r9v_7vhg13ana4ku_nvu.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 0. Dirija-se √† nuvem Yandex</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estritamente falando, essa etapa n√£o √© necess√°ria para a "API do plug-in", mas simplifica significativamente as pr√≥ximas etapas. </font><font style="vertical-align: inherit;">Nesse est√°gio, abandonamos completamente o armazenamento e as instala√ß√µes externas. </font><font style="vertical-align: inherit;">A Pergunta come√ßou a usar servidores DNS Yandex. </font><font style="vertical-align: inherit;">Os servi√ßos rentme foram transferidos para o Yandex.Cloud. </font><font style="vertical-align: inherit;">O banco de dados foi transferido para os bancos de dados gerenciados Yandex. </font><font style="vertical-align: inherit;">Durante a mudan√ßa, tamb√©m conseguimos encontrar e corrigir v√°rios erros no TheQuestion, por exemplo, conex√µes n√£o fechadas com o Redis no c√≥digo de 2015. </font><font style="vertical-align: inherit;">Como b√¥nus, tamb√©m recebemos energia adicional para o TheQuestion.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 1. Migra√ß√£o de Dados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Independentemente de qual op√ß√£o voc√™ deseja combinar servi√ßos, ter√≠amos que combinar os dados em qualquer caso. Para um √∫nico banco de dados, eles decidiram usar o PostgreSQL - esse DBMS j√° foi usado no Experts e no TheQuestion. Para n√£o complicar o projeto, eles n√£o come√ßaram a criar uma terceira base para o servi√ßo integrado, mas simplesmente pegaram o banco de dados Znatokov e o expandiram para poder aceitar todos os dados do TheQuestion. Este foi o primeiro grande desafio tecnol√≥gico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada entrada em cada tabela do banco de dados TheQuestion precisava ser convertida e colocada no banco de dados do Expert. Ent√£o - correlacione cada coluna de uma e de outra base. Muitos campos tiveram que ser convertidos de maneira n√£o trivial de um formato para outro. Portanto, uma grande subtarefa separada foi a convers√£o do formato de armazenamento de texto (o formato real da pergunta ou resposta) de QML (TheQuestion) para Markdown (Experts).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuramos um processo regular (v√°rias vezes ao dia) de transfer√™ncia de novos dados de um banco de dados para outro, mas, ao mesmo tempo, garantimos que os dados do TheQuestion n√£o fossem exibidos em nenhum lugar at√© a conclus√£o do pr√≥ximo est√°gio. </font><font style="vertical-align: inherit;">Como "v√°rias vezes ao dia" est√° longe de ser prometido "instantaneamente", e os dados podem estar em um estado inconsistente com os mesmos dados no TheQuestion, o que enganaria os usu√°rios. </font><font style="vertical-align: inherit;">Ent√£o, por que come√ßamos com a migra√ß√£o de dados se o back-end ainda n√£o estava pronto? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, dessa maneira, estabilizamos o processo. </font><font style="vertical-align: inherit;">Em segundo lugar, eles reduziram a quantidade de novos dados que precisar√£o ser transferidos no futuro, e isso √© importante, pois todo o conte√∫do importado teve que ser direcionado pela marca√ß√£o para qualidade, conte√∫do inapropriado, spam, fraude.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gc/jp/ld/gcjpldkw8v-mv2fg_umevbosowo.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 2. "Trocando API"</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, resolvemos o primeiro dos problemas - aprendemos a pegar o conte√∫do do banco de dados TheQuestion e at√© exibi-lo, se desejar. Agora era necess√°rio fazer com que esse conte√∫do chegasse ao banco de dados integrado instantaneamente, e n√£o v√°rias vezes ao dia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, foi necess√°rio reescrever todo o back-end do TheQuestion com toda a l√≥gica necess√°ria. O nome do projeto, "Swap API", estritamente falando, n√£o reflete completamente a ess√™ncia. Seria mais correto cham√°-lo de "Trocar back-end". O fato √© que, al√©m da implementa√ß√£o direta de todas as "canetas" necess√°rias para o funcionamento do front end TheQuestion, outras possibilidades precisavam ser realizadas. Enfrentamos v√°rias tarefas importantes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Yandex possui um sistema centralizado de autoriza√ß√£o de usu√°rio - Yandex.Passport. E os conhecedores, √© claro, usaram o passaporte. Para fazer login, voc√™ deve ter uma conta no Yandex. Esse foi o problema. Nem todos os usu√°rios do TheQuestion efetuaram login no site atrav√©s do Yandex (embora houvesse essa oportunidade). Muitos usu√°rios n√£o tinham um login no Yandex e passaram pelas redes sociais (VKontakte, Facebook ...). Naturalmente, tivemos que manter essa funcionalidade ao nos mover. Portanto, implementamos a autoriza√ß√£o "sem passaporte". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesquisa no site.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TheQuestion implementou uma busca por perguntas, respostas, usu√°rios e t√≥picos. Para a pesquisa, foi usada uma solu√ß√£o Sphinx de terceiros. Obviamente, se estamos falando de um √∫nico servi√ßo, a pesquisa deve ser a mesma, ou seja, n√£o pode funcionar em dois sistemas ao mesmo tempo. Assim, o Sphinx foi abandonado em favor de um mecanismo de pesquisa interno com suporte para a funcionalidade e indexa√ß√£o necess√°rias de todo o conte√∫do do TheQuestion. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envio de p√°ginas em Zen e Turbo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No momento da ades√£o, o TheQuestion j√° usava as tecnologias Yandex. P√°ginas Turbo foram suportadas, conte√∫do interessante caiu no feed Zen. Tudo isso tamb√©m teve que ser suportado na "API de substitui√ß√£o". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifica√ß√µes no servi√ßo e aplicativos, listas de discuss√£o.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo relacionado √† notifica√ß√£o de usu√°rios: assinaturas, boletins com conte√∫do interessante, informa√ß√µes sobre curtidas e coment√°rios, muito mais. Tudo isso teve que ser cuidadosamente transferido e n√£o esquecido. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistema de Administra√ß√£o do Site</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este par√°grafo refere-se a tudo relacionado ao gerenciamento interno do servi√ßo: modera√ß√£o, an√°lise e assim por diante. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistema de classifica√ß√£o de usu√°rio unificado.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa tarefa n√£o era t√©cnica, mas l√≥gica. Formalmente, n√£o √© necess√°rio desenvolver um sistema de classifica√ß√£o unificado para uma "API de troca", mas esse sistema ainda √© necess√°rio para o futuro servi√ßo integrado. Nos dois sites, os usu√°rios foram classificados pela quantidade e qualidade do conte√∫do criado. Os detalhes da classifica√ß√£o n√£o foram divulgados, mas quanto mais frequentemente e melhor voc√™ responder √†s perguntas, maior ser√° sua classifica√ß√£o. Os princ√≠pios de classifica√ß√£o eram os mesmos nos dois servi√ßos, mas a f√≥rmula em si e os fatores eram muito diferentes. Era necess√°rio n√£o apenas comparar correta e honestamente os usu√°rios de Znatokov e TheQuestion entre si, mas tamb√©m aprender a considerar uma classifica√ß√£o √∫nica para os especialistas que escreveram em dois servi√ßos ao mesmo tempo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E reescreva todas as APIs.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goste ou n√£o, essa tarefa foi a mais importante e dif√≠cil. Muitos processos nos servi√ßos foram semelhantes, ent√£o os tiramos dos especialistas e n√£o escrevemos do zero. Mas havia tamb√©m muitas coisas novas, por exemplo, linhas diretas de usu√°rio ou respostas preliminares. Como resultado, reescrevemos mais de 100 "canetas" na "API de troca" e implementamos mais de 50 recursos REST. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de implementarmos toda a funcionalidade descrita acima, foi poss√≠vel come√ßar a mover. Mas antes de fazermos um truque.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro que antes de alternar e lan√ßar a "API de troca" na produ√ß√£o, ela precisava ser testada muito bem. Antes de tudo, era necess√°rio test√°-lo funcionalmente, ou seja, verificar diretamente o desempenho de todo o site na nova API. Em segundo lugar, √© estressante. N√≥s quer√≠amos ter 100% de certeza de que nosso design n√£o ficaria "sob carga". Naturalmente, realizamos regularmente ‚Äúqueima de carga‚Äù, o que mostra que temos um bom suprimento de desempenho. Mas em quest√µes de desempenho de servi√ßo, √© sempre melhor jogar com seguran√ßa. Qualquer teste de carga sint√©tico, mesmo o melhor, √© de alguma forma diferente da carga de produ√ß√£o. Portanto, decidimos, antes de mudar a API, preencher a carga de produ√ß√£o em nosso estande.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, no front end do TheQuestion, implementamos a duplica√ß√£o de todas as solicita√ß√µes GET (ou seja, solicita√ß√µes de dados, n√£o modifica√ß√µes) em duas APIs ao mesmo tempo: a "antiga API" TheQuestion, que na √©poca era a principal, e a "API de troca" secund√°ria. </font><font style="vertical-align: inherit;">Ao mesmo tempo, o front-end n√£o esperou por uma resposta menor da API e n√£o tratou de erros, mas dessa maneira conseguimos testar o back-end em usu√°rios reais.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/xk/bu/xhxkbuuaimvplykay5--cdqbl30.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 3. E ent√£o nos lembramos das aplica√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, √© claro, lembramos deles o tempo todo, mas enfrentamos um problema. Quem trabalhou com aplicativos m√≥veis sabe que o problema com eles √© muito mais do que com o site. Isso se deve principalmente √† distribui√ß√£o de novas vers√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa trabalhar com servi√ßos externos da App Store e do Google Play e aguardar a aprova√ß√£o das novas vers√µes (e √†s vezes a verifica√ß√£o pode levar um tempo consider√°vel). Em segundo lugar, mesmo se seu aplicativo j√° passou no teste e apareceu na loja, isso n√£o significa que os usu√°rios far√£o uma atualiza√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso do frontend do site, os pr√≥prios desenvolvedores controlam quando uma nova vers√£o √© lan√ßada e sabem com certeza que depois disso todos os usu√°rios receber√£o uma vers√£o atualizada do site. No caso de aplica√ß√µes, n√£o existe essa garantia. Para obter essa garantia, eles costumam usar a "atualiza√ß√£o for√ßada" do aplicativo. Poucas pessoas adoram esse m√©todo e, √© claro, sempre, se poss√≠vel, voc√™ precisa manter a compatibilidade com vers√µes anteriores entre o aplicativo e o back-end. Portanto, seguimos o caminho de fazer altera√ß√µes precisamente no lado de back-end com altera√ß√µes m√≠nimas no front-end em aplicativos. Mas, como muitas vezes acontece, o plano √© confrontado com uma dura realidade.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algumas mudan√ßas foram muito mais f√°ceis de fazer no lado do front-end do que no back-end, portanto, no processo de desenvolvimento de uma "API de plug-in", o front-end foi um pouco, mas alterado. Em particular, o antigo banco de dados TheQuestion usava IDs num√©ricos de 64 bits. O banco de dados dos conhecedores e, consequentemente, o banco de dados combinado e a nova API do TheQuestion usaram IDs de 128 bits da cadeia. Em geral, para um front-end escrito em Node.js, essa diferen√ßa n√£o √© significativa. Mas para aplicativos fortemente tipados, isso acabou sendo fatal. Perdemos a compatibilidade com vers√µes anteriores, e aplicativos mais antigos n√£o podiam funcionar com a "API do plugin".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum momento, havia at√© um projeto chamado "API de plug-in para API de plug-in", cuja ess√™ncia era escrever uma pequena camada entre o novo back-end e os aplicativos que converteriam todos os dados no formato antigo. No entanto, rapidamente abandonamos essa ideia. Essa camada acabaria sendo uma "muleta" muito r√≠gida, que no futuro definitivamente nos traria muitos problemas. Por exemplo, voc√™ n√£o pode simplesmente pegar e converter c√≥digos de 128 bits em c√≥digos de 64 bits. Eu teria que traduzir com perda de informa√ß√µes e, portanto, poss√≠veis colis√µes por ID, ou manter uma tabela intermedi√°ria com IDs antigos e novos correspondentes (para todos os elementos do banco de dados). Tanto isso como outro - n√£o √© a melhor solu√ß√£o arquitet√¥nica.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do ID, houve v√°rias outras altera√ß√µes que tamb√©m eram muito mais f√°ceis de oferecer suporte no front-end e no lado do aplicativo. </font><font style="vertical-align: inherit;">Como resultado, decidimos implementar altera√ß√µes nos aplicativos e ainda usar a atualiza√ß√£o for√ßada. </font><font style="vertical-align: inherit;">Em pouco tempo, desenvolvemos novas vers√µes de aplicativos compat√≠veis com a "API de troca", porque n√£o havia muitas altera√ß√µes no front-end e elas n√£o eram muito graves. </font><font style="vertical-align: inherit;">Enviado para a App Store e o Google Play, moderado com sucesso e come√ßou a esperar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase X. Vamos l√°!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o todo o c√≥digo est√° escrito. </font><font style="vertical-align: inherit;">O suporte com a "API de substitui√ß√£o" √© testado e disparado. </font><font style="vertical-align: inherit;">Novas vers√µes do aplicativo foram testadas nas lojas e est√£o prontas para publica√ß√£o. </font><font style="vertical-align: inherit;">Agora tudo isso tinha que ser lan√ßado em produ√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a c√≥pia de novos dados do banco de dados antigo para o novo ocorre de forma ass√≠ncrona e leva algum tempo, n√£o √© poss√≠vel alternar o back-end (e o banco de dados sob ele) em um site em funcionamento. </font><font style="vertical-align: inherit;">Isso pode resultar em perda ou inconsist√™ncia dos dados do usu√°rio. </font><font style="vertical-align: inherit;">Por isso, escolhemos uma data, alertamos os usu√°rios e preparamos uma placa ‚ÄúTrabalho t√©cnico em andamento‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o chegou a hora, ou melhor, a noite X. O plano de lan√ßamento era assim:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No site TheQuestion, penduramos um esbo√ßo "O trabalho est√° em andamento". </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transferimos aplicativos para o modo somente leitura. </font><font style="vertical-align: inherit;">Os usu√°rios podem ler o conte√∫do do banco de dados antigo, mas n√£o podem criar um novo.</font></font></li>
<li>  TheQuestion   Readonly.    :           .   ,  ,      . </li>
<li>        .            ,     .</li>
<li>       .</li>
<li> ,      ,    API.</li>
<li> API  .  ‚Äî     ,    API   .</li>
<li>,   ,   . </li>
<li>  ¬´ ¬ª,        API.</li>
<li>    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, isso n√£o parece t√£o assustador. Na realidade, tudo correu bem. Das surpresas que encontramos, talvez demorasse muito tempo para publicar o aplicativo na App Store (o aplicativo foi verificado com anteced√™ncia, tratava-se apenas de aparecer na loja). No final, levou v√°rias horas, raz√£o pela qual toda a opera√ß√£o foi um pouco atrasada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, no processo de troca, havia um recurso importante que complicava tudo muitas vezes e aumentava a responsabilidade. O fato √© que o processo de comuta√ß√£o n√£o p√¥de ser revertido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o processo de copiar e converter dados do banco de dados antigo do TheQuestion para um novo e integrado tenha sido configurado e depurado para n√≥s, n√£o houve processo de c√≥pia reversa (do novo banco de dados para o antigo). Isso significa que, assim que abrirmos o site na ‚ÄúAPI de troca‚Äù e iniciarmos o tr√°fego do usu√°rio, todas as perguntas, respostas, coment√°rios e curtidas rec√©m-criadas n√£o poder√£o mais entrar facilmente no antigo banco de dados do TheQuestion. Se algo der errado ap√≥s a abertura, por exemplo, um √∫nico banco de dados n√£o pode lidar com a carga, n√£o ser√° poss√≠vel reverter tudo rapidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, √© claro, eu exagerei. De qualquer forma, n√£o perder√≠amos dados do usu√°rio. T√≠nhamos um plano B e uma maneira de fazer backup de dados manualmente de um novo banco de dados para um antigo. Mas ainda levaria algum tempo, e a revers√£o n√£o teria ocorrido de maneira indolor para os usu√°rios.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, o plano A funcionou e nada teve que ser revertido.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/wy/7g/mjwy7gbw8fyxtqvt0fp0cetrn_4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√°gio final</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, o back-end foi alterado, o banco de dados foi combinado, os aplicativos m√≥veis n√£o foram esquecidos. </font><font style="vertical-align: inherit;">Para os usu√°rios, nada mudou, porque o site Yandex.Ku, que deveria combinar dados de ambos os sites, ainda n√£o foi lan√ßado naquele momento. </font><font style="vertical-align: inherit;">E para o seu lan√ßamento, precis√°vamos resolver mais um problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, escrevi que precis√°vamos combinar n√£o apenas perguntas e respostas de dois servi√ßos em um novo, mas tamb√©m usu√°rios. </font><font style="vertical-align: inherit;">Os usu√°rios deveriam ter conseguido n√£o apenas ver seu conte√∫do no Kew, mas tamb√©m gerenci√°-lo no Kew. </font><font style="vertical-align: inherit;">Tecnicamente, combinar dados e transferir direitos de gerenciamento n√£o √© dif√≠cil. </font><font style="vertical-align: inherit;">√â muito mais dif√≠cil garantir que os direitos sejam transferidos para quem eles devem ser transferidos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao passar de Znatokov para Kew, tudo √© simples: nos dois casos, a mesma conta Yandex √© usada. </font><font style="vertical-align: inherit;">Mas o TheQuestion tem sua pr√≥pria conta, que n√£o pode ser autorizada no Kew. </font><font style="vertical-align: inherit;">Felizmente, pensamos sobre isso de antem√£o. </font><font style="vertical-align: inherit;">Muito antes das a√ß√µes descritas acima, permitimos que os usu√°rios do TheQuestion vinculassem seus perfis Yandex. </font><font style="vertical-align: inherit;">E no momento da consolida√ß√£o f√≠sica dos servi√ßos, mais de 90% dos usu√°rios ativos j√° haviam feito isso. </font><font style="vertical-align: inherit;">Isso nos permitiu iniciar sem esfor√ßo a migra√ß√£o de conte√∫do e usu√°rios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando nos mudamos, quer√≠amos salvar cada usu√°rio, por isso fomos conscientemente para a op√ß√£o mais arriscada e demorada de combinar plataformas. </font><font style="vertical-align: inherit;">Criamos uma base tecnol√≥gica unificada, aprendemos a transportar conte√∫do e perfis instantaneamente. </font><font style="vertical-align: inherit;">Em vez de fechamento inesperado e realoca√ß√£o for√ßada, eles mantiveram a funcionalidade dos servi√ßos antigos, lan√ßaram um novo e explicaram suas vantagens. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dq/1o/e9/dq1oe9ihp4u8tknser_ew3oxx2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lan√ßamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Kew</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no ano passado. </font><font style="vertical-align: inherit;">Agora, mais de 80% dos autores ativos de TheQuestion e Znatokov se mudaram voluntariamente para um novo lar.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491926/index.html">Desenvolvimento de aplicativos m√≥veis multiplataforma em 2020</a></li>
<li><a href="../pt491934/index.html">Perfis psicol√≥gicos dos investidores em a√ß√µes: como funciona</a></li>
<li><a href="../pt491936/index.html">Sobre como as bact√©rias se alimentam de ferro e removem pigmentos de alta qualidade de lix√µes artificiais</a></li>
<li><a href="../pt491938/index.html">5 ferramentas de designer de jogos para ajudar seu jogo</a></li>
<li><a href="../pt491942/index.html">Como usamos o item2vec para recomendar produtos semelhantes</a></li>
<li><a href="../pt491946/index.html">Leis de programa√ß√£o</a></li>
<li><a href="../pt491948/index.html">Os tokens de design podem fazer mais: criar uma √∫nica fonte de informa√ß√µes sobre os componentes da interface do usu√°rio</a></li>
<li><a href="../pt491956/index.html">Lan√ßamento do Rust 1.42.0: modelos de fatia e mensagens de p√¢nico mais convenientes</a></li>
<li><a href="../pt491958/index.html">Guia de compress√£o de anima√ß√£o de esqueleto</a></li>
<li><a href="../pt491960/index.html">Era quando √© dif√≠cil se perder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>