<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💈 🗑️ 🕜 varchar（最大）-varchar（最大）と生産中 👨🏾‍🚀 🤰🏽 🍿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私は最近、nvarchar列で長さを指定することによるパフォーマンスへの影響に関する議論に参加しました。議論は双方にとって合理的であり、私には自由な時間があったので、少しテストすることにしました。結果はこの投稿でした。
 
 スポイラー-それほど単純ではありません。
 
 すべてのテストはSQL S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>varchar（最大）-varchar（最大）と生産中</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は最近、nvarchar列で長さを指定することによるパフォーマンスへの影響に関する議論に参加しました。議論は双方にとって合理的であり、私には自由な時間があったので、少しテストすることにしました。結果はこの投稿でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スポイラー-それほど単純ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのテストはSQL Server 2014 Developer Editionで行われ、SQL Server 2016でもほぼ同じ結果が得られました（わずかな違いはあります）。以下は、SQL Server 2005-2016に関連しているはずです（また、2017/2019にはテストが必要です。これは、アダプティブメモリ許可がそこに表示され、状況をいくらか修正できるためです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erik Darling </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sp_pressure_detector</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からのストアドプロシージャが必要</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。これにより、システムの現在の状態に関する多くの情報を取得でき、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLクエリストレス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、MS SQL Serverの負荷テスト用の非常に優れたオープンソースユーティリティであるAdam Machanic / Erik Ejlskov Jensenです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは何について話していますか</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が答えようとしている質問は、フィールド長（n）のvarcharの選択がパフォーマンスに影響するか（以下、単にすべての場所でvarcharですが、すべてがnvarcharにも関連しています）、または文字列の長さが&lt;8000の場合（nvarcharの場合は4000）文字、varchar（max）およびvarchar（N）はIN-ROWに格納されます。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調理台</font></font></h3><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-comment">##v10  (i int, d datetime, v varchar(10));</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-comment">##v100 (i int, d datetime, v varchar(100));</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-comment">##vmax (i int, d datetime, v varchar(max));</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのフィールドの3つのテーブルを作成します。違いはvarcharの長さのみです：10/100 /最大。</font><font style="vertical-align: inherit;">そして、それらに同じデータを入力します。</font></font><br>
<br>
<pre><code class="sql hljs">;<span class="hljs-keyword">with</span> x <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> x <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>)<font></font>
, xx <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> x <span class="hljs-keyword">from</span> x x1, x x2)<font></font>
, xxx <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> x <span class="hljs-keyword">from</span> xx x1, xx x2, xx x3)<font></font>
, xxxx <span class="hljs-keyword">as</span> (
	<span class="hljs-keyword">select</span> row_number() <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (<span class="hljs-keyword">select</span> <span class="hljs-literal">null</span>)) i<font></font>
		, <span class="hljs-keyword">dateadd</span>(<span class="hljs-keyword">second</span>, row_number() <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (<span class="hljs-keyword">select</span> <span class="hljs-literal">null</span>)), <span class="hljs-string">'20200101'</span>) d<font></font>
		, <span class="hljs-keyword">cast</span> (row_number() <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (<span class="hljs-keyword">select</span> <span class="hljs-literal">null</span>)) <span class="hljs-keyword">as</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">10</span>))  v 		
	<span class="hljs-keyword">from</span> xxx x1, xxx x2, xxx x3<font></font>
) <span class="hljs-comment">--262144 </span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##v10			--varchar(10)</span>
<span class="hljs-keyword">select</span> i, d, v <span class="hljs-keyword">from</span> xxxx;	<font></font>
<font></font>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##v100			--varchar(100)</span>
<span class="hljs-keyword">select</span> i, d, v <span class="hljs-keyword">from</span> <span class="hljs-comment">##v10;</span><font></font>
<font></font>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##vmax			--varchar(max)</span>
<span class="hljs-keyword">select</span> i, d, v <span class="hljs-keyword">from</span> <span class="hljs-comment">##v10;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、各テーブルには262144行が含まれます。</font><font style="vertical-align: inherit;">列I（整数）には、1から262145までの繰り返しのない数値が含まれています。</font><font style="vertical-align: inherit;">d（datetime）の一意の日付とv（varchar）-キャスト（Iはvarchar（10））。</font><font style="vertical-align: inherit;">実際の生活に少し似せるには、iに一意のクラスターインデックスを作成します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> clustered <span class="hljs-keyword">index</span> <span class="hljs-comment">#cidx10 on ##v10(i);</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> clustered <span class="hljs-keyword">index</span> <span class="hljs-comment">#cidx100 on ##v100(i);</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">unique</span> clustered <span class="hljs-keyword">index</span> <span class="hljs-comment">#cidxmax on ##vmax(i);</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行く</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、さまざまなリクエストの実行計画を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、varcharフィールドによる選択がその長さに依存しないことを確認します（8000文字未満が格納されている場合）。</font><font style="vertical-align: inherit;">有効な実行プランを含め、次のようにします。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v10 where v = '123';</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v100 where v = '123';</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax where v = '123';</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jm/ae/ge/jmaegeqd37k-dqa1xelhluv0p7y.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
奇妙なことに、違いはありますが、小さいです。</font><font style="vertical-align: inherit;">varchar（max）を使用したクエリプランは、最初にすべての行を選択してからフィルターで除外し、varchar（10）とvarchar（100）はクラスター化インデックスをスキャンするときに一致をチェックします。</font><font style="vertical-align: inherit;">このため、varchar（10）の0.022に対して、スキャンは約3倍長くなります-0.068秒。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、varchar列を表示し、クラスターインデックスキーでデータを選択した場合の結果を見てみましょう。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v10  where i between 200000 and 201000;</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v100 where i between 200000 and 201000;</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax where i between 200000 and 201000; </span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/-s/kb/cf-skbsef6akggupmzetfl2p8go.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすべてが明確です。そのようなリクエストに違いはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深い部分です。</font><font style="vertical-align: inherit;">前のリクエストでは1001行しか取得できませんでしたが、今度はそれらをインデックスのない列で並べ替えます。</font><font style="vertical-align: inherit;">私たちは試みます：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v10  where i between 200000 and 201000 order by d;</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##v100 where i between 200000 and 201000 order by d;</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax where i between 200000 and 201000 order by d;</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/do/49/yjdo497l7navh17mbg02_gqx8us.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ああ、何が黄色いの？</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ey/me/42/eyme42eioy1wftu3xupiblsy4i8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おかしい、すなわち </font><font style="vertical-align: inherit;">この要求は、ソート用に6.5メガバイトのRAMを要求して受け取り、96キロバイトしか使用しませんでした。</font><font style="vertical-align: inherit;">そして、より多くのラインがある場合、それはどれほど悪化するでしょう。</font><font style="vertical-align: inherit;">さて、それを1000ではなく100000にします。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4e/m9/yj/4em9yjzwjh3nnoqfgfyx54rsing.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ここではもっと深刻です。</font><font style="vertical-align: inherit;">さらに、最小のvarchar（10）で機能する最初の要求も、何かに不満があります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/q8/ni/cq/q8nicqpp2upyxdn1tqkkrj9pmiw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
左側には、最後の要求の警告があります。500メガバイトが要求され、9.5メガバイトのみが使用されました。</font><font style="vertical-align: inherit;">右側は並べ替えの警告です。8840キロバイトが要求されましたが、十分ではなく、別の360ページ（それぞれ8 kb）がtempdbに書き込まれ、そこから読み取られました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここで質問が始まります：WTF？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
答えは、SQL Serverクエリオプティマイザーのしくみです。何かをソートするには、まず何かをメモリに入れる必要があります。どのくらいのメモリが必要かを理解するには？一般に、どのタイプのデータがスペースを占めるかはわかっています。しかし、可変長文字列はどうですか？しかし、彼らにとってはもっと興味深いものです。 /ハッシュ結合ソートにメモリを割り当てるとき、SQL Serverは、平均で半分がフルであると見なします。そして、（サイズ/ 2）*予想される行数としてそれらにメモリを割り当てます。しかし、varchar（最大）は2GBまで格納できます-どれだけ割り当てるのですか？ SQL Serverは、varchar（8000）の半分になると考えています。 1行あたり約4 kb。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いのは、このメモリの割り当てにより、varchar（max）だけでなく問題が発生することです。varcharのサイズが愛情を込めて選択され、それらのほとんどが半分いっぱいになり、それよりも大きくなると、これも問題を引き起こします。</font><font style="vertical-align: inherit;">別の計画の問題ですが、それほど深刻ではありません。</font><font style="vertical-align: inherit;">上の図には説明があります-SQL Serverは、小さなvarcharをソートするためのメモリを正しく割り当てられず、tempdbを使用して中間結果を保存できませんでした。</font><font style="vertical-align: inherit;">tempdbが低速のディスク上にある場合、または他の要求によってアクティブに使用されている場合、これは非常にボトルネックになる可能性があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLクエリストレス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、一括クエリを実行するとどうなるかを見てみましょう。</font><font style="vertical-align: inherit;">SQLクエリストレスを実行してサーバーに接続し、50のスレッドでこれらすべてのクエリを10回実行するとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のクエリの結果：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qv/9r/q8/qv9rq8c7z6tbyqb9k7jqck2yhae.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_9/vw/he/_9vwhedfjdaa22mkptjacumozfa.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5c/um/uv/5cumuvx4-sfl5nojbis65jcdapo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いのですが、インデックスがないと、検索時にvarchar（max）は他の誰よりも悪い結果を示し、反復のプロセッサ時間と全体的な実行時間の点で明らかに悪いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、sp_pressure_detectorに興味深いものは何も表示されないため、その出力については言及しません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のクエリの結果：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/om/nz/yo/omnzyo0dirov8grjqv_xknozi8a.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/um/l8/ck/uml8ckphegosxfz61vucy5cdhmc.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jp/gc/qw/jpgcqwftgnarvin2dubbszhlb0e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではすべてが期待されています-同様に良いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深い部分です。</font><font style="vertical-align: inherit;">結果の1000行をソートするクエリ：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nk/s3/7g/nks37ghsmhyoeu2ufnwjtucspng.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/v5/k8/md/v5k8mduwaak5levom_53ew9tb-c.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ur/dt/cm/urdtcmhikdmqqn17is5z7lgwnom.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが前のリクエストとまったく同じであることが判明しました-行数は多くなく、ソートは問題を引き起こしません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、不当に多くの行をソートする最後のクエリ（ソートされたリスト全体をプルしないように、上位1000を追加しました）：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/so/qf/4x/soqf4xayshv3s96prh41gbho98o.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2d/mo/xz/2dmoxznaetv7dae_o8yfwqewgx0.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ap/s5/0n/aps50nstvvlezyr4qq16jjw8xmu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これがsp_pressure_detectorの出力です。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/ta/-d/5v/ta-d5vvomd180-etwq7kvvkplyy.png"></div></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼は私たちに何を伝えますか？</font><font style="vertical-align: inherit;">すべてのセッションは（ソート用に）それぞれ489 MBを要求しますが、これらの22セッションすべてがそれぞれ9 MBしか使用しないことを考慮しても、SQL Serverに十分なメモリを持っているのは22セッションのみです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
合計で11 GBのメモリが使用可能で、229のセッションにそれぞれ489.625が割り当てられ、SQL Serverには258メガバイトしか使用できませんでした。また、489の新しいセッションを取得したいと考えています。どうすればよいですか？</font><font style="vertical-align: inherit;">メモリが解放されるまで待ちます。実行を開始することすらありません。</font><font style="vertical-align: inherit;">セッションでそのようなリクエストが行われた場合、ユーザーはどうしますか？</font><font style="vertical-align: inherit;">待ちすぎます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、varchar（10）を使用した図に注意してください。varchar（10）を使用したリクエストは、varchar（100）を使用したリクエストよりも時間がかかりました。これは、tempdbが非常に高速なディスク上にあるにもかかわらずです。</font><font style="vertical-align: inherit;">tempdbのドライブが悪いほど、クエリの実行が遅くなります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Server 2012/2014に関する個別の注記</font></font></b><div class="spoiler_text"> SQL Server 2012/2014       sort spills.      char/nchar –     spill’  tempdb. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">MS    </a>,        ,       .<br>
<br>
 :<br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-comment">##c6  (i int, d datetime, v char(6));</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##c6 (i, d, v)</span>
<span class="hljs-keyword">select</span> i, d, v
<span class="hljs-keyword">from</span> <span class="hljs-comment">##v10</span>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##c6 where i between 100000 and 200000 order by d;</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ui/f4/b8/uif4b8p9mykxr4vt6nzawwr67_e.png"></div><br>
    (      ):<br>
<br>
<pre><code class="sql hljs">DBCC TRACEON (7470, -1);</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wy/re/lk/wyrelkcbyfaybdahpngtbvakkla.png"></div><br>
    , spill’  .<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（n）個のvarchar列があるクエリでは、並べ替えに注意してください。それでもソートが必要な場合は、ソート列にインデックスがあることが非常に望ましいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソートを行うために、order byを明示的に使用する必要はないことに注意してください。たとえば、外観はマージ結合でも可能です。メモリの割り当てに関する同じ問題は、ハッシュ結合でも発生する可能性があります。たとえば、varchar（max）を使用します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> top <span class="hljs-number">100</span> * 
<span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax v1</span>
<span class="hljs-keyword">inner</span> <span class="hljs-keyword">hash</span> <span class="hljs-keyword">join</span> <span class="hljs-comment">##v10 v2 on v1.i = v2.i</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ui/zw/65/uizw65mjcy5wysloq-ujohovj1o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.5 GBのメモリが割り当てられ、25メガバイトが使用されます！</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私にとっての主な結論</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：列（n）varcharのサイズ-重要！サイズが小さすぎると、tempdbが流出する可能性があり、大きすぎると、メモリ要求が大きすぎます。並べ替えがある場合は、varcharの長さを平均レコード長* 2として宣言することをお勧めします。SQLServer 2012/2014の場合はそれ以上です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私にとって予期しない結論</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：8000文字未満のvarchar（最大）は、フィルターを使用すると、実際には動作が遅くなります。どう説明したらいいのかまだわかりません-掘り下げます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のためのボーナス引き出し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：既に「公開」をクリックするところがほとんどですが、varchar（max）でも「小さなvarchar'a」の問題が発生する可能性があると思いました。</font><font style="vertical-align: inherit;">実際、varchar（最大）に格納されている場合、4000文字（nvarcharの場合は2000）を超えると、並べ替えが問題になる可能性があります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##vmax(i, d, v)</span>
<span class="hljs-keyword">select</span> i, d, <span class="hljs-keyword">replicate</span>(<span class="hljs-string">'a'</span>, <span class="hljs-number">4000</span>) v
<span class="hljs-keyword">from</span> <span class="hljs-comment">##v10;</span><font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax where i between 200000 and 201000 order by d;</span>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/1r/al/gj/1ralgj_dructufbdmv9okrtarqu.png"></div><br>
<pre><code class="sql hljs"><span class="hljs-keyword">truncate</span> <span class="hljs-keyword">table</span> <span class="hljs-comment">##vmax;</span><font></font>
<font></font>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-comment">##vmax(i, d, v)</span>
<span class="hljs-keyword">select</span> i, d, <span class="hljs-keyword">replicate</span>(<span class="hljs-string">'a'</span>, <span class="hljs-number">4100</span>) v
<span class="hljs-keyword">from</span> <span class="hljs-comment">##v10;</span><font></font>
<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-comment">##vmax where i between 200000 and 201000 order by d;</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wa/hp/s7/wahps7atcyg7xmdkuo0rg6-ojhu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ最初に、すべてがそれほど単純ではないことを書いたのですか？</font><font style="vertical-align: inherit;">たとえば、ハーフデッドディスクのある自宅のラップトップでは、「小さな」varcharをソートするときにtempdbがこぼれて、そのようなリクエストがvarchar（max）を使用した同様のリクエストよりもORDERの実行速度が遅いという事実につながりました。</font><font style="vertical-align: inherit;">あなたが良いハードウェアを持っているなら、それらはそのような問題ではないかもしれませんが、それらについて忘れてはいけません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに興味深いのは、他のDBMSのvarcharのサイズが大きすぎる、または小さすぎるために問題があるかどうかを確認することです。</font><font style="vertical-align: inherit;">確認する機会があれば-共有して頂ければ嬉しいです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少しボーナス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、クエリプランキャッシュを使用してこのような問題を検出することはできません。</font><font style="vertical-align: inherit;">キャッシュからのプランの例を以下に示します。ああ、警告はありません。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/g5/kg/eug5kgej0aai31sbnd3ukzp31qm.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/vg/yp/suvgypz4s5ejzxv_9zootujvoim.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja489164/index.html">ダウンタイムなしのKubernetesクラスターのアップグレード</a></li>
<li><a href="../ja489166/index.html">Windows 10の例とその2のキーボードを使ったPCの操作について</a></li>
<li><a href="../ja489172/index.html">Keycloakを使用して、Active Directory認証をKubernetesに固定します</a></li>
<li><a href="../ja489174/index.html">Laravelによる単一責任原則（SRP）</a></li>
<li><a href="../ja489178/index.html">GSMout-SMSを受信して​​「自宅」で通話</a></li>
<li><a href="../ja489184/index.html">早送り：設計と製造における3Dテクノロジー</a></li>
<li><a href="../ja489186/index.html">マイクロコントローラ用のTDD。パート3：鉄の上を走る</a></li>
<li><a href="../ja489188/index.html">実際のマイクロサービス.Net環境へのログイン</a></li>
<li><a href="../ja489190/index.html">RedHatの調査：オープンソースは企業セグメントからの専有ソフトウェアを置き換えます</a></li>
<li><a href="../ja489192/index.html">スマートエンジンは、FizTechの基本的な組織の中でFWCIランキングのトップ3に入りました</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>