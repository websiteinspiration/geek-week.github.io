<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🌾 👨🏽‍⚕️ 📣 不需要Ableton：将Ableton Push 2连接到VCV机架 🗒️ 🔩 💐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近，音乐创作与十年前的照片大致相同：每个人都有自己的DSLR和instagram帐户。音乐界对此很高兴，因为这种兴趣带来了很多钱。每天都有新的VST插件和模拟设备出现，主题课程的数量在迅速增长，致力于音乐制作的博客在YouTube上排名第一。在这种背景下，开源项目看起来非常有趣，允许任何想要尝试自...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>不需要Ableton：将Ableton Push 2连接到VCV机架</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491244/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/vm/8j/qkvm8jnnid3kb_8kybxztptlbfu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近，音乐创作与十年前的照片大致相同：每个人都有自己的DSLR和instagram帐户。音乐界对此很高兴，因为这种兴趣带来了很多钱。每天都有新的VST插件和模拟设备出现，主题课程的数量在迅速增长，致力于音乐制作的博客在YouTube上排名第一。在这种背景下，开源项目看起来非常有趣，允许任何想要尝试自己作为生产者的人都不必为此花很多钱。 VCV Rack是这样的一个项目，该项目旨在使所有人都能使用最昂贵的一类乐器-模拟模块化合成器。最近，当我想到一个曲目的想法时，当时只有一台linux笔记本电脑，我想用VCV进行整个开发。一直以来，都希望使用midi控制器以无法使用可用模块的方式来控制合成器。最后，我决定编写一个插件以将Ableton Push 2连接到VCV Rack。在本文中，我们将讨论它的来龙去脉，以及如何编写自己的VCV模块。</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">快速参考</font></font></b><div class="spoiler_text">VCV Rack — open source ,   .  VCV  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
Ableton Push 2 —    midi-  Ableton,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> DAW</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">API    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0CdMvkBOUgs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VCV机架API</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VCV中的每个模块都包含两个部分-音频和图形。</font><font style="vertical-align: inherit;">音频部分从</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类继承</font><font style="vertical-align: inherit;">了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">该</font><i><font style="vertical-align: inherit;">过程</font></i><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">针对每个样本进行调用，即具有采样频率。</font><font style="vertical-align: inherit;">顺便说一下，VCV中的采样频率可以从标准的44.1 kHz到高达768 kHz不等，这允许具有足够计算能力的模块化合成器更精确地仿真。</font><i><font style="vertical-align: inherit;">ModuleWidget</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
类型的对象负责图形</font><font style="vertical-align: inherit;">，这些</font><font style="vertical-align: inherit;">图形</font><font style="vertical-align: inherit;">从基本结构继承了</font><i><font style="vertical-align: inherit;">draw</font></i><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">VCV使用nanovg矢量图形库。</font><font style="vertical-align: inherit;">在</font><i><font style="vertical-align: inherit;">draw</font></i><font style="vertical-align: inherit;">方法内</font><i><font style="vertical-align: inherit;">绘图</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它既可以在模块边界内发生（多余的被引擎切断），也可以在例如我们仍然使用的帧缓冲区内发生。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
那么，为VCV编写模块又需要什么呢？</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置环境并安装Rack SDK</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一步</font><font style="vertical-align: inherit;">在文档中</font><font style="vertical-align: inherit;">已得到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">很好的描述</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且不会造成任何困难（至少在linux下），因此我们不再赘述。</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成插件模板</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Rack SDK中有一个helper.py脚本。</font><font style="vertical-align: inherit;">他需要说出createplugin，然后指定插件的名称以及有关它的信息（可选）。</font></font><br>
<br>
<pre><code class="bash hljs">&lt;Rack SDK folder&gt;/helper.py createplugin MyPlugin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建插件模板后，可以使用以下命令对其进行编译和安装</font></font><br>
<br>
<pre><code class="bash hljs">RACK_DIR=&lt;Rack SDK folder&gt; make install</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘制模块的前端</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个插件可以包含多个模块，并且对于每个模块，您都需要绘制一个主面板。为此，VCV文档为我们提供了使用Inkscape或任何其他矢量编辑器的功能。由于VCV中的模块安装在虚拟Eurorack支架上，因此它们的高度始终为128.5 mm，宽度应为5.08 mm的倍数。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本接口元素，例如CV /门插座，按钮和灯泡，可以矢量形式标记。为此，请绘制其相应颜色的位置圆（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处更多详细信息</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），以便</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为该标记</font><i><font style="vertical-align: inherit;">生成</font></i><font style="vertical-align: inherit;">代码。就个人而言，在我看来这不是一个非常方便的功能，直接从代码中放置元素更容易。图片和布局准备就绪后，您需要再次运行</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建模块模板并将其与前面板关联。</font></font><br>
<br>
<pre><code class="bash hljs">helper.py createmodule MyModule res/MyModule.svg src/MyModule.cpp</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们连接按钮和曲折</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/oz/wq/z_/ozwqz_ss4sqqdci_q7dxbarbfve.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了显示屏之外，Ableton Push 2在计算机上还被视为普通的USB-MIDI设备，因此可以轻松地在其与VCV机架之间建立连接。</font><font style="vertical-align: inherit;">为此，请在模块类内创建一个输入Midi队列和一个输出Midi端口。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化代码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AbletonPush2</span> :</span> Module {<font></font>
    midi::Output midiOutput;<font></font>
    midi::InputQueue midiInput;<font></font>
<font></font>
    <span class="hljs-keyword">bool</span> inputConnected;
    <span class="hljs-keyword">bool</span> outputConnected;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们尝试在连接的Midi设备中查找Ableton Push并将其连接。</font><font style="vertical-align: inherit;">由于该模块专用于Ableton Push，因此我们无需为用户选择设备负担，您只需按名称查找即可。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">控制器连接码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">connectPush</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> in_devs = midiInput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; in_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiInput.getDeviceName(in_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiInput.setDeviceId(in_devs[i]);<font></font>
            inputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
		<font></font>
    <span class="hljs-keyword">auto</span> out_devs = midiOutput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; out_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiOutput.getDeviceName(out_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiOutput.setDeviceId(out_devs[i]);<font></font>
            outputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法中，</font><font style="vertical-align: inherit;">您可以定期检查控制器是否已连接，并询问Midi队列是否有任何消息到达。</font><font style="vertical-align: inherit;">在这里值得一提的是，MIDI标准中通常编码什么以及如何编码。</font><font style="vertical-align: inherit;">实际上，消息有两种主要类型，它们是“音符开/关”，传输音符编号和按压力，以及“ CC-命令控制”，传输某些可变参数的数值。</font><font style="vertical-align: inherit;">有关midi的更多信息，请参见</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI队列轮询代码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ProcessArgs &amp;args)</span> <span class="hljs-keyword">override</span> </span>{
    <span class="hljs-keyword">if</span> (sampleCounter &gt; args.sampleRate / updateFrequency) {<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((!inputConnected) &amp;&amp; (!outputConnected)) {<font></font>
            connectPush();<font></font>
        }<font></font>
<font></font>
	midi::Message msg;<font></font>
	<span class="hljs-keyword">while</span> (midiInput.shift(&amp;msg)) {<font></font>
	    processMidi(msg);<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我要教控制器垫以不同的颜色发光，以便更轻松地浏览它们。为此，我们需要向他发送适当的midi命令。例如，考虑打击垫编号36（这是最低的左侧打击垫）。如果单击它，控制器将发送命令0x90（注解开），后跟注解号（36）和0到127之间的数字，这表示压机的强度。相反，当计算机向控制器发送相同的0x90命令和相同的音符编号36时，则第三个数字将指示左下垫发光的颜色。按键和打击垫的编号如上图所示。 Push具有使用颜色，调色板，动画和其他背光参数的多种可能性。我没有详细介绍，只是将默认调色板的所有可能的颜色带到了垫板上，然后选择了我喜欢的颜色。但是在一般情况下，根据文档将midi命令转换为LED上的PWM值看起来像这样：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/at/zq/8oatzqvwy_gwqvgu4cmjgjpbknm.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背光控制码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note, <span class="hljs-keyword">int</span> color)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(color);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x9</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOff</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(<span class="hljs-number">0</span>);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x8</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们连接显示器</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/os/yl/kv/osylkvou5ba8_aoa3rwhst94uiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要连接显示器，您必须使用USB。</font><font style="vertical-align: inherit;">控制器本身不知道如何绘制任何内容，也不了解图形。</font><font style="vertical-align: inherit;">他只希望至少每2秒发送一个160x960像素的帧。</font><font style="vertical-align: inherit;">所有渲染都在计算机侧面进行。</font><font style="vertical-align: inherit;">首先，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">按照文档中的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接并打开USB设备</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示连接码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _MSC_VER</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span><font></font>
<font></font>
<span class="hljs-comment">// see following link for a discussion of the</span>
<span class="hljs-comment">// warning suppression:</span>
<span class="hljs-comment">// http://sourceforge.net/mailarchive/forum.php?</span>
<span class="hljs-comment">// thread_name=50F6011C.2020000%40akeo.ie&amp;forum_name=libusbx-devel</span><font></font>
<font></font>
<span class="hljs-comment">// Disable: warning C4200: nonstandard extension used:</span>
<span class="hljs-comment">// zero-sized array in struct/union</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(disable:4200)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __linux__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libusb-1.0/libusb.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"libusb.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ABLETON_VENDOR_ID 0x2982</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_PRODUCT_ID  0x1967</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> libusb_device_handle* <span class="hljs-title">open_push2_device</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> result;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> ((result = libusb_init(<span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%d] could not initilialize usblib\n"</span>, result);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_set_debug(<span class="hljs-literal">NULL</span>, LIBUSB_LOG_LEVEL_ERROR);<font></font>
<font></font>
  libusb_device** devices;<font></font>
  <span class="hljs-keyword">ssize_t</span> count;<font></font>
  count = libusb_get_device_list(<span class="hljs-literal">NULL</span>, &amp;devices);
  <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%ld] could not get usb device list\n"</span>, count);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_device* device;<font></font>
  libusb_device_handle* device_handle = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
  <span class="hljs-keyword">char</span> ErrorMsg[<span class="hljs-number">128</span>];<font></font>
<font></font>
  <span class="hljs-comment">// set message in case we get to the end of the list w/o finding a device</span>
  <span class="hljs-built_in">sprintf</span>(ErrorMsg, <span class="hljs-string">"error: Ableton Push 2 device not found\n"</span>);<font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; (device = devices[i]) != <span class="hljs-literal">NULL</span>; i++)<font></font>
  {<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">libusb_device_descriptor</span> <span class="hljs-title">descriptor</span>;</span>
    <span class="hljs-keyword">if</span> ((result = libusb_get_device_descriptor(device, &amp;descriptor)) &lt; <span class="hljs-number">0</span>)<font></font>
    {<font></font>
      <span class="hljs-built_in">sprintf</span>(ErrorMsg,
        <span class="hljs-string">"error: [%d] could not get usb device descriptor\n"</span>, result);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (descriptor.bDeviceClass == LIBUSB_CLASS_PER_INTERFACE<font></font>
      &amp;&amp; descriptor.idVendor == ABLETON_VENDOR_ID<font></font>
      &amp;&amp; descriptor.idProduct == PUSH2_PRODUCT_ID)<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ((result = libusb_open(device, &amp;device_handle)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not open Ableton Push 2 device\n"</span>, result);<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((result = libusb_claim_interface(device_handle, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not claim interface 0 of Push 2 device\n"</span>, result);<font></font>
        libusb_close(device_handle);<font></font>
        device_handle = <span class="hljs-literal">NULL</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// successfully opened</span><font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (device_handle == <span class="hljs-literal">NULL</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(ErrorMsg);<font></font>
  }<font></font>
<font></font>
  libusb_free_device_list(devices, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> device_handle;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close_push2_device</span><span class="hljs-params">(libusb_device_handle* device_handle)</span>
</span>{<font></font>
  libusb_release_interface(device_handle, <span class="hljs-number">0</span>);<font></font>
  libusb_close(device_handle);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要发送帧，必须首先发送一个16字节的标头，然后发送160行，每行960个16位数字。</font><font style="vertical-align: inherit;">同时，根据文档，字符串不应该以1920字节传输，而应该以2048字节的数据包传输，并以零进行补充。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帧传输码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Push2Display</span> :</span> FramebufferWidget {<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frame_header[<span class="hljs-number">16</span>] = {
          <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x88</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> <font></font>
    };<font></font>
<font></font>
    libusb_device_handle* device_handle;<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* image;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendDisplay</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * image)</span> </span>{
        <span class="hljs-keyword">int</span> actual_length;<font></font>
     <font></font>
        libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, frame_header, <span class="hljs-keyword">sizeof</span>(frame_header), &amp;actual_length, TRANSFER_TIMEOUT);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">160</span>; i++)<font></font>
            libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, &amp;image[(<span class="hljs-number">159</span> - i)*<span class="hljs-number">1920</span>], <span class="hljs-number">2048</span>, &amp;actual_length, TRANSFER_TIMEOUT);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在只剩下绘制帧并将其写入缓冲区。</font><font style="vertical-align: inherit;">为此，请使用</font><font style="vertical-align: inherit;">实现</font><i><font style="vertical-align: inherit;">drawFramebuffer</font></i><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramebufferWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">开箱即用的VCV Rack使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">nanovg</font></a><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">，因此在此处编写图形非常容易。</font><font style="vertical-align: inherit;">我们从全局变量APP中了解当前的图形上下文并保存其状态。</font><font style="vertical-align: inherit;">接下来，创建一个空的160x960框架，并使用</font><i><font style="vertical-align: inherit;">draw</font></i><font style="vertical-align: inherit;">方法进行</font><i><font style="vertical-align: inherit;">绘制</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">之后，将帧缓冲区复制到将通过USB发送的阵列，然后返回上下文状态。</font><font style="vertical-align: inherit;">最后，设置</font><i><font style="vertical-align: inherit;">dirty</font></i><font style="vertical-align: inherit;">标志，</font><font style="vertical-align: inherit;">以便在下一次渲染渲染时，VCV引擎不会忘记更新我们的小部件。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帧渲染代码</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">drawFramebuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{<font></font>
<font></font>
    NVGcontext* vg = APP-&gt;window-&gt;vg;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (display_connected) {<font></font>
        nvgSave(vg);<font></font>
	glViewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>);<font></font>
        glClearColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
        glClear(GL_COLOR_BUFFER_BIT|GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
	nvgBeginFrame(vg, <span class="hljs-number">960</span>,  <span class="hljs-number">160</span>, <span class="hljs-number">1</span>);<font></font>
        draw(vg);<font></font>
        nvgEndFrame(vg);<font></font>
<font></font>
        glReadPixels(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>, GL_RGB, GL_UNSIGNED_SHORT_5_6_5, image); <font></font>
<font></font>
        <span class="hljs-comment">//  XOR   ,  </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>*<span class="hljs-number">960</span>; i ++){<font></font>
            image[i * <span class="hljs-number">4</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] ^= <span class="hljs-number">0xF3</span>;<font></font>
            image[i * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] ^= <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
	    	<font></font>
	sendDisplay(image);<font></font>
<font></font>
	nvgRestore(vg);<font></font>
    }<font></font>
<font></font>
    dirty = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">交互逻辑和参数映射</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于我的任务，我希望能够切换定序器中记录的模式，并同时控制每组模式自己的一组特定参数。</font><font style="vertical-align: inherit;">通过映射，我了解了一个模块的参数与另一模块或Midi控制器的参数的绑定。</font><font style="vertical-align: inherit;">我发现很少有关于如何进行精美映射的信息，因此我从VCV内置的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI Map</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模块中获取了实现该映射的大部分代码</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">简而言之，对于每组参数，都会</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中</font><i><font style="vertical-align: inherit;">创建</font></i><font style="vertical-align: inherit;">一个特殊的</font><i><font style="vertical-align: inherit;">ParamHandle</font></i><font style="vertical-align: inherit;">对象</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">对象</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过拐杖</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">告诉引擎什么与什么相关。</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是我最后得到的一个模块。</font><font style="vertical-align: inherit;">除了将midi转换为CV的标准方法外，它还允许您对打击垫进行分组，为其分配颜色，以及将任意模块参数与Push编码器相关联，在控制器显示屏上显示其名称和值。</font><font style="vertical-align: inherit;">在下面的视频中，您可以看到他的概述，在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此视频中，您</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以看到实际操作。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OhdxXv6uHF0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完整代码可</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处获得</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们设法仅在Linux（Ubuntu 18.04）下对其进行测试，在MacOS上，由于libusb的特性导致显示器无法连接，并且midi界面出现了奇怪的延迟。</font><font style="vertical-align: inherit;">尽管如此，VCV Rack作为框架和模块化DAW都给人留下了很好的印象，我希望VCV能够继续发展，并且本文将帮助其他人为此编写自己的模块。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN491232/index.html">RPA +机器学习=智能自动化</a></li>
<li><a href="../zh-CN491234/index.html">使用SOLIDWORKS进行3D打印零件建模的三个技巧</a></li>
<li><a href="../zh-CN491236/index.html">.NET中的异步编程：最佳实践</a></li>
<li><a href="../zh-CN491238/index.html">遗传密码分析II</a></li>
<li><a href="../zh-CN491240/index.html">通往云端的道路：昨天和今天</a></li>
<li><a href="../zh-CN491246/index.html">DEFCON会议27.您的车是我的车。第2部分</a></li>
<li><a href="../zh-CN491250/index.html">LED灯高斯基本</a></li>
<li><a href="../zh-CN491252/index.html">JSON.stringify（）的5个鲜为人知的功能</a></li>
<li><a href="../zh-CN491256/index.html">在NXP的iMX8上开发模块。DDR跟踪传输的功能</a></li>
<li><a href="../zh-CN491258/index.html">IT女孩，你来自哪里？建立地图</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>