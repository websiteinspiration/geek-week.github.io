<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåâ üõ´ ü•à Historias de bloqueo con Patroni, o C√≥mo soltar un cl√∫ster PostgreSQL üëæ üëèüèª üßï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL no tiene alta disponibilidad fuera de la caja. Para lograr HA, debe poner algo, configurarlo, hacer un esfuerzo. Existen varias herramienta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Historias de bloqueo con Patroni, o C√≥mo soltar un cl√∫ster PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/489206/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL no tiene alta disponibilidad fuera de la caja. Para lograr HA, debe poner algo, configurarlo, hacer un esfuerzo. Existen varias herramientas que pueden ayudar a aumentar la disponibilidad de PostgreSQL, y una de ellas es Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primera vista, al poner a Patroni en un entorno de prueba, puede ver qu√© gran herramienta es y c√≥mo maneja f√°cilmente nuestros intentos de romper el cl√∫ster. Pero en la pr√°ctica, en un entorno de producci√≥n, no todo sucede siempre de manera tan bella y elegante. Data Egret comenz√≥ a usar Patroni a fines de 2018 y gan√≥ algo de experiencia: c√≥mo diagnosticarlo, configurarlo y cu√°ndo no confiar en el archivador autom√°tico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En HighLoad ++, Alexei Lesovsky describi√≥ en detalle, utilizando ejemplos y an√°lisis de registros, los problemas t√≠picos que surgen al trabajar con Patroni y las mejores pr√°cticas para superarlos.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lqh1eJwVPtk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El art√≠culo no: Instrucciones de instalaci√≥n de Patroni y ejemplos de configuraci√≥n; </font><font style="vertical-align: inherit;">problemas fuera de Patroni y PostgreSQL; </font><font style="vertical-align: inherit;">historias basadas en las experiencias de otras personas, pero solo aquellos problemas que Data Egret descubri√≥ por s√≠ mismos.</font></font><br>
<a name="habracut"></a><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre el orador:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alexey Lesovsky (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lesovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) comenz√≥ como administrador del sistema (administrador del sistema Linux), trabaj√≥ en desarrollo web (administrador de bases de datos PostgreSQL). </font><font style="vertical-align: inherit;">Desde 2014 trabaja en Data Egret. </font><font style="vertical-align: inherit;">Data Egret se dedica a la consultor√≠a en el campo de PostgreSQL, ayuda a muchas compa√±√≠as a usar PostgreSQL correctamente y, por supuesto, ha adquirido una amplia experiencia en el funcionamiento de la base de datos. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El informe en el que se basa este art√≠culo se llama "Historias de fallas de Patroni o C√≥mo bloquear su cl√∫ster PostgreSQL", aqu√≠ hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace a la presentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de que empieces</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©jame recordarte qu√© es Patroni, para qu√© est√° destinado y qu√© puede hacer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni es una plantilla para construir HA fuera de la caja.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por lo tanto, est√° escrito en la documentaci√≥n y, desde mi punto de vista, esta es una aclaraci√≥n muy correcta. Es decir, Patroni no es una bala de plata que estableci√≥ y resolver√° todos los problemas. Es necesario hacer esfuerzos para que comience a funcionar y traer beneficios. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni - servicio de agente.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se instala en cada servidor con una base de datos y es una especie de sistema de inicio para PostgreSQL: se inicia, se detiene, se reinicia, cambia la configuraci√≥n y la topolog√≠a del cl√∫ster. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni almacena el "estado del cl√∫ster" en DCS.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para almacenar el estado del cl√∫ster, su vista actual, necesita almacenamiento. </font><font style="vertical-align: inherit;">Patroni almacena el estado en un sistema externo: un repositorio de configuraci√≥n distribuido. </font><font style="vertical-align: inherit;">Esta puede ser una de las opciones: Etcd, Consul, ZooKeeper o Etcd Kubernetes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni AutoFile est√° habilitado de forma predeterminada. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtiene un archivador autom√°tico de la caja, inmediatamente despu√©s de instalar Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, hay muchas otras cosas, como: mantenimiento de configuraciones, creaci√≥n de nuevas r√©plicas, copia de seguridad, etc. </font><font style="vertical-align: inherit;">Pero esta vez permanecer√° fuera del alcance del informe.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El objetivo principal de Patroni es proporcionar un archivador autom√°tico confiable.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni no tiene que monitorear el equipo, enviar notificaciones, hacer cosas complicadas sobre la posible prevenci√≥n de accidentes, etc. </font><font style="vertical-align: inherit;">Es necesario que el cl√∫ster permanezca operativo y que la aplicaci√≥n pueda continuar trabajando con la base de datos, independientemente de cualquier cambio en la topolog√≠a del cl√∫ster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero cuando comenzamos a usar Patroni con PostgreSQL, nuestro sistema se vuelve un poco m√°s complicado. </font><font style="vertical-align: inherit;">Ahora, adem√°s de la base de datos en s√≠, cuando falla el maestro o la r√©plica, Patroni mismo, el almacenamiento distribuido de los estados del cl√∫ster o la red pueden fallar. </font><font style="vertical-align: inherit;">Considere todas las opciones a medida que se vuelven m√°s complicadas en t√©rminos de lo dif√≠cil que es comprender sus causas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 1. DBMS y DCS en el mismo cl√∫ster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere el caso m√°s simple: tomamos un cl√∫ster de base de datos e implementamos DCS en el mismo cl√∫ster. </font><font style="vertical-align: inherit;">Este error com√∫n no solo est√° relacionado con los errores de implementaci√≥n de PostgreSQL y Patroni. </font><font style="vertical-align: inherit;">Esto es un error en la construcci√≥n general de arquitecturas, ya que combina muchos componentes diferentes en un solo lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hubo una conmutaci√≥n por error. </font><font style="vertical-align: inherit;">Comenzamos a entender lo que pas√≥. </font><font style="vertical-align: inherit;">Aqu√≠ nos interesa saber cu√°ndo ocurri√≥ el feylover, es decir, el </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">momento en que cambi√≥ el estado del cl√∫ster.</font></font></strong><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°ndo ocurri√≥ la conmutaci√≥n por error?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un faylover no siempre ocurre instant√°neamente; puede llevar mucho tiempo. </font><font style="vertical-align: inherit;">Por lo tanto, tiene una hora de inicio y una hora de finalizaci√≥n. </font><font style="vertical-align: inherit;">Todos los eventos se dividen en "antes", "durante" y "despu√©s" del feylover. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, cuando ocurri√≥ el feylover, estamos buscando la raz√≥n.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba est√°n los registros est√°ndar de Patroni, donde informa que la funci√≥n del servidor ha cambiado y la funci√≥n del asistente se ha movido de otro a este nodo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© ocurri√≥ la conmutaci√≥n por error?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, debe comprender qu√© eventos hicieron que la funci√≥n del maestro pasara de un nodo a otro, qu√© sucedi√≥ con el maestro anterior.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: patroni.utils.RetryFailedError: 'Exceeded retry deadline'<font></font>
pgdb-2 patroni: ERROR: Error communicating with DCS<font></font>
pgdb-2 patroni: INFO: demoted self because DCS is not accessible and i was a leader<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, todo es simple: </font></font><code>Error communicating with DCS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- un error al interactuar con el sistema de almacenamiento de configuraci√≥n. </font><font style="vertical-align: inherit;">El maestro se dio cuenta de que no pod√≠a trabajar con DCS y dijo que ya no pod√≠a ser maestro y renunci√≥. </font></font><code>demoted self</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habla sobre esto</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© precedi√≥ al feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si observa los eventos que precedieron al feylover, puede ver las razones que se convirtieron en un problema para que el asistente contin√∫e:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: ERROR: touch_member<font></font>
                ... python trace <font></font>
pgdb-2 patroni: socket.timeout: timed out <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:   raise ReadTimeoutError(self, url, "Read timed out. (read timeout=%s)" % timeout_value) <font></font>
pgdb-2 patroni: urllib3.exceptions.ReadTimeoutError: HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335) <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:     raise MaxRetryError(_pool, url, error or ResponseError(cause)) <font></font>
pgdb-2 patroni: urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='127.0.0.1', port=8500): Max retries exceeded with url: /v1/kv/service/pgdb/members/pgdb-2?acquire=19598b72-c0d5-f066-5d24-09c1a9ad61ee&amp;dc=maindb (Caused by ReadTimeoutError("HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335)",)) <font></font>
pgdb-2 patroni: INFO: no action.  i am the leader with the lock <font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los registros de Patroni muestran muchos errores de tiempo de espera diferentes. </font><font style="vertical-align: inherit;">El Agente Patroni no pudo trabajar con DCS (en este caso, es Consul, puerto = 8500). </font><font style="vertical-align: inherit;">Patroni y la base de datos se ejecutaban en el mismo host, y los servidores de Consul se ejecutaban en el mismo host. </font><font style="vertical-align: inherit;">Habiendo creado la carga en el servidor, tambi√©n creamos problemas para el servidor Consul, por lo que no pod√≠an comunicarse normalmente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo ha vuelto como estaba</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de un tiempo, cuando la carga disminuy√≥, nuestro Patroni pudo comunicarse nuevamente con los agentes, todo se reanud√≥:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mismo servidor pgdb-2 nuevamente se convirti√≥ en maestro. </font><font style="vertical-align: inherit;">Hubo un peque√±o "tir√≥n": en un tiempo relativamente corto renunci√≥ a s√≠ mismo como maestro, y luego volvi√≥ a tomarlos sobre s√≠ mismo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto puede considerarse como un falso positivo o como el hecho de que Patroni hizo todo bien.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos por nosotros mismos que el problema es que los servidores de Consul est√°n en el mismo hardware que las bases de datos. </font><font style="vertical-align: inherit;">En consecuencia, cualquier carga en la CPU y los discos (solicitud de E / S pesada, archivos temporales, aspiradoras autom√°ticas, migraciones, copias de seguridad, etc.) tambi√©n afecta la interacci√≥n con el cl√∫ster Consul. </font><font style="vertical-align: inherit;">Decidimos que esto no deber√≠a vivir en el mismo equipo con la base de datos, y asignamos un grupo separado para el C√≥nsul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como alternativa, puede girar los par√°metros </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>loop_wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>retry_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, intenta debido a su aumento de sobrevivir a los picos de carga a corto plazo. </font><font style="vertical-align: inherit;">Pero si la carga es larga, iremos m√°s all√° de estos par√°metros y el m√©todo no funcionar√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 2. Interrupciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo problema es similar al primero en que nuevamente tenemos problemas para interactuar con el sistema DCS:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: ERROR: get_cluster <font></font>
maindb-1 patroni: Traceback (most recent call last):<font></font>
                ... python trace <font></font>
maindb-1 patroni: RetryFailedError: 'Exceeded retry deadline' <font></font>
maindb-1 patroni: ERROR: Error communicating with DCS <font></font>
maindb-1 patroni: INFO: closed patroni connection to the postgresql cluster <font></font>
maindb-1 patroni: INFO: postmaster pid=214121 <font></font>
... <font></font>
... <font></font>
maindb-1 patroni: INFO: demoted self because DCS is not accessible and i was a leader <font></font>
maindb-1 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni nuevamente dice que no puede interactuar con DCS, por lo que el maestro actual deja de ser un maestro y entra en modo de r√©plica. </font><font style="vertical-align: inherit;">El viejo maestro se convierte en una r√©plica:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: does not have lock <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 <font></font>
maindb-1 patroni: INFO: running pg_rewind from user=postgres host=192.168.11.18 port=5432 ... <font></font>
maindb-1 patroni: servers diverged at WAL location 1FA/A38FF4F8 on timeline 6 <font></font>
maindb-1 patroni: rewinding from last common checkpoint at 1FA/A38FF450 on timeline 6 <font></font>
maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 in progress <font></font>
maindb-1 patroni: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ Patroni funciona como deber√≠a: se inicia </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para rebobinar el registro de transacciones, luego se conecta al nuevo maestro y ya se pone al d√≠a con el nuevo maestro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© precedi√≥ al feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontremos lo primero que precedi√≥ al feylover: los errores que lo causaron. </font><font style="vertical-align: inherit;">Los registros de Patroni son convenientes a este respecto: escribe los mismos mensajes con cierto intervalo. </font><font style="vertical-align: inherit;">Puede desplazarlos r√°pidamente y ver cu√°ndo han cambiado los registros. </font><font style="vertical-align: inherit;">En este punto, comenzaron algunos problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En una situaci√≥n normal, los registros de Patroni se ven as√≠:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock<font></font>
maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El propietario del bloqueo se verifica, si cambia, pueden ocurrir eventos a los que Patroni debe responder. En este caso, todo est√° en orden con nosotros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de desplazarse al lugar donde comenzaron a aparecer los errores, vemos que se produjo un archivador autom√°tico. Dado que los errores estaban relacionados con la interacci√≥n con DCS, tambi√©n miramos los registros del C√≥nsul, lo que sucedi√≥ all√≠. Comparando aproximadamente el tiempo del faylover y el tiempo en los registros del c√≥nsul, vemos que los vecinos del grupo de c√≥nsules comenzaron a dudar de la existencia de otros participantes:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-2 consul[11581]: serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: [INFO] serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: memberlist: Suspect maindb-1 has failed, no acks received<font></font>
maindb-2 consul[11581]: [INFO] memberlist: Suspect maindb-1 has failed, no acks received</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si observa los registros de otros agentes del C√≥nsul, tambi√©n muestra que hay un colapso de la red: todos los miembros del grupo C√≥nsul dudan entre s√≠. </font><font style="vertical-align: inherit;">Este fue el impulso para el feylover. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si observamos entradas anteriores, veremos que el sistema de C√≥nsul para el agente PostgreSQL tiene dificultades con la comunicaci√≥n ( </font></font><code>deadline reached</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RPC failed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 consul: memberlist: Suspect lbs-4 has failed, no acks received<font></font>
maindb-1 consul: [ERR] yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] agent: Coordinate update error: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La respuesta m√°s simple es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reparar la red</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es f√°cil aconsejar, pero las circunstancias pueden ser diferentes, y esto no siempre es posible. </font><font style="vertical-align: inherit;">El sistema puede vivir en un centro de datos, donde no podemos influir en el equipo. </font><font style="vertical-align: inherit;">Necesito otras opciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay opciones de soluci√≥n sin trabajar con una red:</font></font><br>
<br>
<ul>
<li><strong> Consul-</strong> ‚Äî <code>checks: []</code>.<br>
   ,     .    ,    Consul-    .           .</li>
<li><strong></strong> <code>raft_multiplier</code>.<br>
   Consul-,     5 (      staging-).         Consul-.  -   .</li>
<li><strong></strong> <code>renice -n -10 consul</code>.<br>
        .  renice   .          Consul-,             .</li>
<li><strong>   consul?</strong><br>
Consul-         . Patroni   Consul-    ,     :    - ,  Patroni      .   etcd,     ,    etcd   . Patroni      etcd-.    -  ,     ,   ,     Consul.</li>
<li><strong>  </strong> <code>ttl, loop_wait, retry_timeout</code>.<br>
     ,         .     Patroni       .</li>
</ul><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 3. P√©rdida de nodo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si est√° utilizando Patroni, entonces est√° familiarizado con el comando patronictl list, que muestra el estado actual del cl√∫ster:</font></font><br>
<br>
<pre><code class="xml hljs">$ patronictl list<font></font>
<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |          Member         |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster | pg01.dev.zirconus.local | 10.202.1.101 |        | running |    0.0    |<font></font>
| patroni_cluster | pg03.dev.zirconus.local | 10.202.1.103 | Leader | running |    0.0    |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primera vista, tal conclusi√≥n puede parecer normal: hay un maestro, r√©plicas, pero no hay retraso de replicaci√≥n. </font><font style="vertical-align: inherit;">Pero esta imagen es normal exactamente hasta que sepamos que en este grupo deber√≠a haber 3 nodos, y no 2.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© ocurri√≥ la conmutaci√≥n por error?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entendemos que se produjo un archivador autom√°tico y luego desapareci√≥ una r√©plica. </font><font style="vertical-align: inherit;">Necesitamos averiguar por qu√© desapareci√≥ y traerla de vuelta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estudiamos los registros nuevamente para comprender por qu√© se produjo el archivador autom√°tico:</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: ERROR: failed to update leader lock<font></font>
pg02 patroni[1425]: INFO: demoted self because failed to update leader lock in DCS<font></font>
pg02 patroni[1425]: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pg02 patroni[1425]: INFO: Lock owner: None; I am pg02.dev.zirconus.local<font></font>
pg02 patroni[1425]: INFO: not healthy enough for leader race<font></font>
pg02 patroni[1425]: INFO: starting after demotion in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El maestro pg02 no pudo actualizar la clave maestra </font></font><code>ERROR: failed to update leader lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, la segunda r√©plica de db03 se convirti√≥ en el maestro, todo est√° en orden aqu√≠:</font></font><br>
<br>
<pre><code class="xml hljs">pg03 patroni[9648]: INFO: promoted self to leader by acquiring session lock<font></font>
pg03 patroni[9648]: server promoting<font></font>
pg03 patroni[9648]: INFO: cleared rewind state after becoming the leader</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© hay del viejo maestro?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg02, decidiendo convertirse en una r√©plica, comenz√≥ rebobinando el registro de transacciones. </font><font style="vertical-align: inherit;">Aqu√≠ tenemos que mirar los registros de r√©plica, que no est√° en el cl√∫ster. </font><font style="vertical-align: inherit;">Abra los registros de Patroni y vea que durante el proceso de conexi√≥n al cl√∫ster, surgi√≥ un problema en la etapa </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: INFO: running pg_rewind from pg03<font></font>
pg02 patroni[1425]: INFO: running pg_rewind from user=postgres host=10.202.1.103 port=5432 ...<font></font>
pg02 patroni[1425]: servers diverged at WAL location 33F/68E6AD10 on timeline 28<font></font>
pg02 patroni[1425]: could not open file "/data/pgdb/11/pg_wal/0000001C0000033F00000059": No such file or directory<font></font>
pg02 patroni[1425]: could not find previous WAL record at 33F/59FFE368 pg02 patroni[1425]: Failure, exiting<font></font>
pg02 patroni[1425]: ERROR: Failed to rewind from healty master: pg03<font></font>
pg02 patroni[1425]: WARNING: Postgresql is not running.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectarse al cl√∫ster, el nodo debe solicitar el registro de transacciones del asistente y capturarlo. </font><font style="vertical-align: inherit;">En este caso, no hay registro de transacciones ( </font></font><code>No such file or directory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) y la r√©plica no puede iniciarse. </font><font style="vertical-align: inherit;">En consecuencia, PostgreSQL se detiene con un error. </font><font style="vertical-align: inherit;">Debe comprender por qu√© no hab√≠a registro de transacciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu√© tiene el nuevo maestro en WAL:</font></font><br>
<br>
<pre><code class="xml hljs">LOG: checkpoint complete:<font></font>
wrote 62928 buffers (16.0%); 0 WAL file(s) added, 0 removed, 23 recycled;<font></font>
write=12.872 s, sync=0.020 s, total=13.001 s;<font></font>
sync files=16, longest=0.009 s, average=0.001 s;<font></font>
distance=520220 kB, estimate=520220 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resulta que mientras se estaba ejecutando </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se produjo un punto de control y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se cambi√≥ el nombre de algunos de los registros de transacciones anteriores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cuando el viejo maestro intent√≥ conectarse al nuevo maestro y solicitar estos registros, ya se les cambi√≥ el nombre, simplemente no exist√≠an. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n la marca de tiempo, el tiempo entre estos eventos es literalmente de 150 ms.</font></font><br>
<br>
<pre><code class="xml hljs">2019-08-26 00:06:11,369 LOG: checkpoint complete<font></font>
2019-08-26 00:06:11,517 INFO: running pg_rewind</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero esto fue suficiente para que la r√©plica no pueda conectarse y ganar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, utilizamos ranuras de replicaci√≥n. Esta soluci√≥n nos pareci√≥ buena, aunque en la primera etapa de la operaci√≥n apagamos las ranuras. Pensamos que si las ranuras acumularan muchos segmentos de pared, el maestro podr√≠a caerse. Habiendo sufrido durante un tiempo sin espacios, nos dimos cuenta de que los necesit√°bamos y los devolvimos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema es que cuando el asistente ingresa al estado de r√©plica, el asistente elimina las ranuras y los segmentos wal junto con ellos. Para nivelar este problema, aumentamos el par√°metro </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por defecto, es igual a 8 segmentos, nos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">planteamos </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a 1.000</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Asignamos 16 GB </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y ahora, al cambiar, siempre tenemos 16 GB de registros de transacciones en todos los nodos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto tambi√©n es cierto para las tareas de mantenimiento a largo plazo. </font><font style="vertical-align: inherit;">Supongamos que necesitamos actualizar una de las r√©plicas (software, sistema operativo, algo m√°s) y queremos desactivarla. </font><font style="vertical-align: inherit;">Cuando apagamos la r√©plica, la ranura tambi√©n se elimina. </font><font style="vertical-align: inherit;">Si utiliza un valor de par√°metro peque√±o </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, durante una larga ausencia de una r√©plica, solicitar√° los registros de transacciones que ni siquiera aparezcan en el asistente; entonces la r√©plica no podr√° conectarse. </font><font style="vertical-align: inherit;">Por lo tanto, mantenemos una gran oferta de revistas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 4. P√©rdida de datos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubo una conmutaci√≥n por error en una base de producci√≥n. </font><font style="vertical-align: inherit;">Verificamos el cl√∫ster: todo est√° en orden, todas las r√©plicas est√°n en su lugar, no hay retraso de replicaci√≥n y tampoco hay errores en los registros. </font><font style="vertical-align: inherit;">Pero el equipo del producto informa que no </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hay suficientes datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la </font><strong><font style="vertical-align: inherit;">base de datos</font></strong><font style="vertical-align: inherit;"> : est√°n en una fuente, pero no en la base de datos. </font><font style="vertical-align: inherit;">Necesitas entender lo que les pas√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inmediatamente nos dimos cuenta de que era </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">su mermelada, pero tenemos que averiguar por qu√©.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°ndo ocurri√≥ la conmutaci√≥n por error?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Siempre podemos encontrar en los registros cu√°ndo ocurri√≥ el feylover, qui√©n se convirti√≥ en el nuevo maestro, qui√©n era el maestro antes y cu√°ndo quer√≠a convertirse en una r√©plica.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[17836]: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-1 patroni[17836]: server promoting<font></font>
pgdb-1 patroni[17836]: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-1 patroni[17836]: INFO: Lock owner: pgdb-1; I am pgdb-1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de los registros, podemos determinar cu√°ntos registros de transacciones se han perdido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fue as√≠: el viejo asistente se reinici√≥, despu√©s de que se reiniciara con la ejecuci√≥n autom√°tica, se lanz√≥ Patroni, que luego lanz√≥ PostgreSQL. </font><font style="vertical-align: inherit;">PostgreSQL decidi√≥ convertirse en miembro del cl√∫ster Patroni y lanz√≥ un proceso </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que a su vez borr√≥ parte de los registros de transacciones, descarg√≥ nuevos y se conect√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni trabaj√≥ exactamente como estaba previsto. </font><font style="vertical-align: inherit;">El grupo se recuper√≥: hab√≠a 3 nodos, despu√©s del feylover, 3 nodos y se fueron. </font><font style="vertical-align: inherit;">Pero parte de los datos se pierden y debe comprender de qu√© parte se trata. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encuentra en los registros del viejo maestro el momento en que sucedi√≥ </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: running pg_rewind from pgdb-1<font></font>
pgdb-2 patroni[4149]: Lock owner: pgdb-1; I am pgdb-2<font></font>
pgdb-2 patroni[4149]: Deregister service pgdb/pgdb-2<font></font>
pgdb-2 patroni[4149]: running pg_rewind from pgdb-1 in progress<font></font>
pgdb-2 patroni[4149]: running pg_rewind from user=replica host=10.10.1.31 port=5432 ...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
pgdb-2 patroni[4149]: rewinding from last common checkpoint at 0/59DD1070 on timeline 66<font></font>
pgdb-2 patroni[4149]: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe encontrar la posici√≥n en el registro de transacciones, que detuvo al antiguo maestro.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: Local timeline=66 lsn=0/5BDA8EB8<font></font>
pgdb-2 patroni[4149]: INFO: master_timeline=67<font></font>
...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
postgres=# select pg_wal_lsn_diff('0/5BDA8EB8','0/5AD1BFD8');<font></font>
pg_wal_lsn_diff<font></font>
----------------<font></font>
17354464</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, es la marca 0 / 5BDA8EB8. </font><font style="vertical-align: inherit;">La segunda marca, 0 / 5AD1BFD8, es necesaria para encontrar la distancia en la que el antiguo maestro difiere del nuevo. </font><font style="vertical-align: inherit;">Usando la funci√≥n </font></font><code>pg_wal_lsn_diff </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comparamos estas dos marcas, obtenemos 17 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya sea que haya una gran p√©rdida de 17 MB de datos, todos deciden por s√≠ mismos. </font><font style="vertical-align: inherit;">Para algunos, esto es insignificante, pero para alguien es inaceptable. </font><font style="vertical-align: inherit;">Cada uno por s√≠ mismo determina individualmente de acuerdo con las necesidades del negocio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, debe decidir </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el inicio autom√°tico de Patroni siempre es necesario despu√©s de reiniciar el sistema</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Muy a menudo, deber√≠amos ir al antiguo maestro, ver qu√© tan diferente es del estado actual, quiz√°s inspeccionar los segmentos del registro de transacciones. Debe comprender si estos datos se pueden perder o si necesita ejecutar el asistente anterior en modo independiente para extraer los datos. Solo despu√©s de eso, decida qu√© hacer con los datos y conecte este nodo como una r√©plica a nuestro cl√∫ster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, hay un par√°metro</font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, su valor predeterminado es 1 Mb. Funciona as√≠: si la r√©plica est√° 1 MB detr√°s del retraso de replicaci√≥n, entonces esta r√©plica no participa en las elecciones. Si de repente ocurre una conmutaci√≥n por error, Patroni observa qu√© r√©plicas est√°n rezagadas, y aquellas que est√°n rezagadas detr√°s de una gran cantidad de registros de transacciones no pueden convertirse en maestros. Esta es una buena caracter√≠stica de seguridad que le impide perder demasiados datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hay un problema: el retraso de replicaci√≥n se actualiza en un intervalo determinado, el valor </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">predeterminado es 30 s. Es muy posible que el valor del retraso de replicaci√≥n para las r√©plicas en DCS sea uno, pero de hecho es completamente diferente o no hay ning√∫n retraso. Este no es un valor en tiempo real; no siempre refleja la imagen real y no vale la pena vincularle una l√≥gica compleja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El riesgo de "p√©rdidas" siempre permanece:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el peor de los casos: </font></font><code>maximum_lag_on_failover + ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el caso promedio: </font></font><code>maximum_lag_on_failover + (loop_wait / 2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando planea implementar Patroni y evaluar la cantidad de datos que puede perder, considere estas f√≥rmulas para representar aproximadamente posibles p√©rdidas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La buena noticia es que puede haber una WAL de procesos en segundo plano en las "p√©rdidas". </font><font style="vertical-align: inherit;">Estos datos se pueden ignorar y perder f√°cilmente, no hay problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ven los registros si est√°n configurados </font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se produjo un feylover y debe seleccionar un nuevo asistente:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[6202]: INFO: Lock owner: None; I am pgdb-1<font></font>
pgdb-1 patroni[6202]: INFO: not healthy enough for leader race<font></font>
pgdb-1 patroni[6202]: INFO: changing primary_conninfo and restarting in progress<font></font>
...<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√©plica simplemente ve que ella </font></font><code>not healthy enough for leader race</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es y se niega a participar en la carrera de liderazgo. </font><font style="vertical-align: inherit;">Por lo tanto, simplemente espera a que se seleccione un nuevo asistente para conectarse a √©l. </font><font style="vertical-align: inherit;">Esta es una medida adicional contra la p√©rdida de datos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 5. Unidades</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El equipo del producto escribi√≥ que la aplicaci√≥n tiene problemas para trabajar con PostgreSQL. </font><font style="vertical-align: inherit;">Al mismo tiempo, no puede ingresar al maestro, porque no est√° disponible a trav√©s de SSH, pero el archivador autom√°tico tampoco ocurre. </font><font style="vertical-align: inherit;">Luego, el host se reinici√≥ por la fuerza y, por lo tanto, lanz√≥ el archivador autom√°tico. </font><font style="vertical-align: inherit;">Aunque fue posible hacer un feylover manual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s del reinicio, vamos a ver qu√© pas√≥ con el maestro. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_1/2u/rj/_12urj0aobgqg0pp2gkkuolhjog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sab√≠amos de antemano los problemas con los discos; al monitorear sab√≠amos d√≥nde cavar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los registros de PostgreSQL, vemos lo siguiente:</font></font><br>
<br>
<pre><code class="xml hljs">[COMMIT] LOG: duration: 1138.868 ms statement: COMMIT<font></font>
...<font></font>
[] WARNING: autovacuum worker started without a worker entry<font></font>
...<font></font>
[SELECT] LOG: temporary file: path "base/pgsql_tmp/pgsql_tmp11247.983", size 532996096<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la cara est√°n todos los indicadores de problemas con los discos: confirmaciones que duran un segundo, el vac√≠o autom√°tico se ejecuta muy largo y extra√±o, y los archivos temporales en el disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinamos el sistema dmesg, el registro de mensajes del n√∫cleo, y vimos un problema con uno de los discos:</font></font><br>
<br>
<pre><code class="xml hljs">md/raid10:md2: sde3: rescheduling sector 351273392<font></font>
blk_update_request: I/O error, dev sde, sector 64404728<font></font>
md/raid10:md2: sde3: rescheduling sector 63161592<font></font>
blk_update_request: I/O error, dev sde, sector 64404760<font></font>
...<font></font>
md2 : active raid10 sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]<font></font>
      15623340032 blocks super 1.2 512K chunks 2 near-copies [8/7] [UUUUUUU_]<font></font>
      bitmap: 58/59 pages [232KB], 131072KB chunk</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El subsistema de disco en el servidor era un Raid de software de 8 discos, pero faltaba uno. </font></font><code>sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta la </font><font style="vertical-align: inherit;">l√≠nea </font></font><code>sde[4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Relativamente hablando, un disco se cay√≥, esto caus√≥ problemas de disco, y la aplicaci√≥n tuvo problemas para trabajar con el cl√∫ster PostgreSQL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, Patroni no podr√≠a ayudar, porque Patroni no tiene la tarea de monitorear el estado del servidor y los discos. </font><font style="vertical-align: inherit;">Durante los problemas, Patroni continu√≥ interactuando con el cl√∫ster DCS y no vio ninguna dificultad. </font><font style="vertical-align: inherit;">Para tales situaciones, se necesita monitoreo externo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 6. Simulador de cl√∫ster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es uno de los problemas m√°s extra√±os. </font><font style="vertical-align: inherit;">Lo estudi√© durante mucho tiempo, rele√≠ muchos registros y lo llam√© "Simulador de cl√∫ster". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema era que el viejo maestro no pod√≠a convertirse en una se√±al normal. </font><font style="vertical-align: inherit;">Patroni lo ejecut√≥, mostr√≥ que este nodo est√° presente como una r√©plica, pero al mismo tiempo no era una r√©plica normal, ahora ver√° por qu√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo comenz√≥, como en el caso anterior, con problemas de disco:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:55.601 [COMMIT] LOG: duration: 1478.118 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1290.203 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.465 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.449 ms statement: COMMIT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubo conexiones rotas:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:58.078 [idle in transaction] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] FATAL: connection to client lost<font></font>
14:48:58.107 [idle in transaction] FATAL: connection to client lost</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hab√≠a largas expectativas de una respuesta y bloqueo de diversa gravedad:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:26.929 [UPDATE waiting] LOG: process 4298 acquired ExclusiveLock on tuple (2,10) of relation 52082 of database 50587 after 52487.463 ms<font></font>
14:49:26.929 [UPDATE waiting] STATEMENT: UPDATE sessions SET lastaccess='1565005714' WHERE sessionid=...<font></font>
14:49:27.929 [UPDATE waiting] LOG: process 4298 still waiting for ShareLock on transaction 364118337 after 1000.088 ms<font></font>
14:49:27.929 [UPDATE waiting] DETAIL: Process holding the lock: 4294. Wait queue: 4298.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, hay problemas obvios con los discos, incluidos los archivos temporales nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero lo m√°s misterioso para m√≠: vol√≥ </font></font><code>immediate shutdown request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.102 MSK 5335 @ from [] LOG: received immediate shutdown request<font></font>
14:49:34.689 [authentication] WARNING: terminating connection because of crash of another server process<font></font>
14:49:34.689 [authentication] DETAIL: The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL tiene tres modos de apagado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agraciado cuando esperamos que todos los clientes se desconecten solos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√°pido, cuando les decimos a los clientes que se desconecten, porque vamos a cerrar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inmediato, que no le dice a los clientes que es necesario desconectarse, sino que simplemente lo apaga y env√≠a un mensaje RST a todos los clientes (se√±al TCP de que la conexi√≥n se interrumpi√≥).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los procesos en segundo plano de PostgreSQL no se env√≠an se√±ales de solicitud de apagado inmediato, sino que solo responden a ellos. </font><font style="vertical-align: inherit;">Este es un reinicio de emergencia, y qui√©n lo envi√≥ no est√° claro. </font><font style="vertical-align: inherit;">Si lo fuera </font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo ver√≠a en los registros, pero no estaba all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprendiendo m√°s, vi que Patroni no escribi√≥ en el registro durante bastante tiempo, simplemente no hubo mensajes durante 54 segundos. </font><font style="vertical-align: inherit;">Durante este tiempo, una de las r√©plicas se hizo "promocionar" y se produjo un archivador autom√°tico:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql03 patroni: 14:48:25,000 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:48:25,013 INFO: no action.  i am the leader with the lock <font></font>
pgsql03 patroni: 14:48:37,159 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:49:31,155 WARNING: Exception hened during processing of request from 10.1.0.12 <font></font>
pgsql03 patroni: 14:49:31,297 WARNING: Exception hened during processing of request from 10.1.0.11 <font></font>
pgsql03 patroni: 14:49:31,298 WARNING: Exception hened during processing of request from 10.1.0.11</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni volvi√≥ a funcionar perfectamente aqu√≠, el viejo maestro no estaba disponible, por lo que comenz√≥ la elecci√≥n de un nuevo maestro.</font></font><br>
<br>
<pre><code class="xml hljs">pgsql01 patroni: 14:48:57,136 INFO: promoted self to leader by acquiring session lock<font></font>
pgsql01 patroni: server promoting<font></font>
pgsql01 patroni: 14:48:57,214 INFO: cleared rewind state after becoming the leader<font></font>
pgsql01 patroni: 14:49:05,013 INFO: Lock owner: pgsql01; I am pgsql01<font></font>
pgsql01 patroni: 14:49:05,023 INFO: updated leader lock during promote</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pgsql01 se convirti√≥ en el nuevo l√≠der, y solo hubo problemas con la segunda r√©plica. </font><font style="vertical-align: inherit;">Honestamente trat√≥ de reconfigurar:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql02 patroni: 14:48:57,124 INFO: Could not take out TTL lock <font></font>
pgsql02 patroni: 14:48:57,137 INFO: following new leader after trying and failing to obtain lock <font></font>
pgsql02 patroni: 14:49:05,014 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:05,025 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:15,011 INFO: Lock owner: pgsql01; I am pgsql02<font></font>
pgsql02 patroni: 14:49:15,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:25,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:25,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:35,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:35,014 INFO: changing primary_conninfo and restarting in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intent√≥ cambiar recovery.conf, reiniciar PostgreSQL, conectarse al nuevo asistente. </font><font style="vertical-align: inherit;">Cada 10 segundos hay mensajes que est√° intentando, pero no puede. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mientras tanto, la misma se√±al de apagado inmediato vol√≥ hacia el viejo maestro. </font><font style="vertical-align: inherit;">El asistente inici√≥ un reinicio de emergencia, la recuperaci√≥n tambi√©n se detiene. </font><font style="vertical-align: inherit;">La r√©plica no se puede conectar al maestro porque est√° en modo de apagado.</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.293 [idle] LOG:  received replication command: IDENTIFY_SYSTEM <font></font>
WARNING:  terminating connection because of crash of another server process <font></font>
DETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory. <font></font>
14:49:35.232 FATAL:  could not receive data from WAL stream: server closed the connection unexpectedly             <font></font>
        This probably means the server terminated abnormally <font></font>
        before or while processing the request. <font></font>
14:49:35.232 LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:49:35.305 FATAL: could not connect to the primary server: FATAL: the database system is shutting down <font></font>
14:49:40.241 FATAL: could not connect to the primary server: FATAL: the database system is shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En alg√∫n momento, la r√©plica funcion√≥, pero la r√©plica no comenz√≥.</font></font><br>
<br>
<pre><code class="xml hljs">14:50:14.024 [] LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:50:14.028 [] LOG:  fetching timeline history file for timeline 72 from primary server <font></font>
14:50:14.104 [] FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:14.104 [] LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo una sola hip√≥tesis: en recovery.conf era la direcci√≥n del viejo maestro. </font><font style="vertical-align: inherit;">Cuando ya apareci√≥ un nuevo maestro, la segunda r√©plica intent√≥ conectarse al viejo maestro. </font><font style="vertical-align: inherit;">Cuando Patroni comenz√≥ en la segunda r√©plica, el nodo se inici√≥, pero no pudo conectarse a trav√©s de la replicaci√≥n. </font><font style="vertical-align: inherit;">Se form√≥ un retraso de replicaci√≥n que se parec√≠a a esto:</font></font><br>
<br>
<pre><code class="xml hljs">+-----------------+----------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |  Member  |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster |  pgsql01 | 10.2.200.151 | Leader | running |       0.0 |<font></font>
| patroni_cluster |  pgsql02 | 10.2.200.152 |        | running |    9153.0 |<font></font>
| patroni_cluster |  pgsql03 | 10.2.200.153 |        | running |       0.0 |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, los tres nodos estaban en su lugar, pero el segundo nodo estaba detr√°s. </font><font style="vertical-align: inherit;">La replicaci√≥n no pudo comenzar porque los registros de transacciones eran diferentes. </font><font style="vertical-align: inherit;">Los registros de transacciones ofrecidos por el asistente, indicados en recovery.conf, simplemente no se ajustaban al nodo actual. </font><font style="vertical-align: inherit;">PostgreSQL report√≥ un error cada 5 segundos</font></font><br>
<br>
<pre><code class="xml hljs">14:50:44.143 FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
         DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:44.143 LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/ CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ comet√≠ un error y no prob√© mi hip√≥tesis de que nos estamos conectando con el maestro equivocado. </font><font style="vertical-align: inherit;">Acabo de reiniciar Patroni en la r√©plica. </font><font style="vertical-align: inherit;">Honestamente, ya le puse fin y pens√© que tendr√≠a que rehacerlo, pero aun as√≠ decid√≠ intentar reiniciarlo.</font></font><br>
<br>
<pre><code class="xml hljs">15:14:13.511 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:14:13.511 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recuperaci√≥n comenz√≥, e incluso la base de datos abierta, estaba lista para aceptar la conexi√≥n, comenz√≥ la replicaci√≥n:</font></font><br>
<br>
<pre><code class="xml hljs">15:14:17.072 LOG: record with incorrect prev-link 142D46/315602C at 14CF/CF38C160<font></font>
15:14:17.077 LOG: started streaming WAL from primary at 14CF/CF000000 on timeline 72<font></font>
15:14:17.536 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero un minuto despu√©s se cay√≥ con un error </font></font><code>terminating walreceiver process due to administrator command</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: la r√©plica dec√≠a que los registros de transacciones no eran adecuados para ella.</font></font><br>
<br>
<pre><code class="xml hljs">15:15:27.823 FATAL: terminating walreceiver process due to administrator command<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y no reinici√© PostgreSQL, pero fue Patroni el que se reinici√≥ con la esperanza de que lanzara m√°gicamente la base de datos. </font><font style="vertical-align: inherit;">La replicaci√≥n comenz√≥ nuevamente, pero la base de datos se abri√≥ en el mismo lugar:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:33.553 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:17:33.554 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las marcas en el registro de transacciones eran diferentes, eran diferentes que en el intento de lanzamiento anterior; la posici√≥n del registro de transacciones era anterior:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:37.299 LOG: invalid contrecord length 5913 at 14CF/CEFFF7B0<font></font>
15:17:37.304 LOG: started streaming WAL from primary at 14CF/CE000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La replicaci√≥n se detuvo nuevamente, y el mensaje de error fue diferente y nuevamente no muy informativo:</font></font><br>
<br>
<pre><code class="xml hljs">15:18:12.208 FATAL: terminating walreceiver process due to administrator command<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el experimento, reiniciado nuevamente, la base se abri√≥ en el mismo lugar:</font></font><br>
<br>
<pre><code class="xml hljs">15:21:25.135 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:21:25.135 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces se me ocurri√≥ la idea: que si reinicio PostgreSQL, en este punto del asistente actual, har√© un punto de control para mover el punto en el registro de transacciones un poco m√°s adelante y la recuperaci√≥n comenzar√° en otro momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lanz√≥ Patroni, hizo un par de puntos de control en el maestro, un par de puntos de reinicio en la r√©plica cuando se abri√≥:</font></font><br>
<br>
<pre><code class="xml hljs">15:22:43.727 LOG: invalid record length at 14D1/BCF3610: wanted 24, got 0<font></font>
15:22:43.731 LOG: started streaming WAL from primary at 14D1/B000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funcion√≥: la replicaci√≥n comenz√≥ desde un lugar diferente y ya no se rompi√≥. </font><font style="vertical-align: inherit;">Pero para m√≠ este es uno de los problemas m√°s misteriosos sobre los que todav√≠a me estoy estrujando el cerebro. </font><font style="vertical-align: inherit;">Especialmente esa extra√±a solicitud de cierre inmediato. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De esto podemos concluir: Patroni puede funcionar seg√∫n lo planeado y sin errores, pero esto no es una garant√≠a absoluta de que todo est√© realmente en orden. </font><font style="vertical-align: inherit;">Despu√©s del feylover, siempre debe verificar que todo est√© bien con el cl√∫ster: la cantidad correcta de r√©plicas, sin retraso de replicaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En base a estos y muchos otros problemas similares, formul√© recomendaciones generales que le aconsejo que tenga en cuenta al operar Patroni.</font></font><br>
<br>
<blockquote><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando usa Patroni, debe tener monitoreo. </font><font style="vertical-align: inherit;">Siempre necesita saber cu√°ndo se produjo un archivo autom√°tico, porque si no sabe que tiene un archivo autom√°tico, no controla el cl√∫ster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;Despu√©s de cada feylover siempre verifique un cl√∫ster. </font><font style="vertical-align: inherit;">Debe asegurarse de que: las r√©plicas sean siempre el n√∫mero actual; </font><font style="vertical-align: inherit;">sin retraso de replicaci√≥n; </font><font style="vertical-align: inherit;">no hay errores en los registros relacionados con la replicaci√≥n de transmisi√≥n, con Patroni, con el sistema DCS.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni es una muy buena herramienta, pero no importa c√≥mo diga que no es una bala de plata. </font><font style="vertical-align: inherit;">La automatizaci√≥n puede funcionar con √©xito, pero al mismo tiempo, los objetos de automatizaci√≥n pueden estar en un estado de trabajo medio. </font><font style="vertical-align: inherit;">De todos modos, debe tener una idea de c√≥mo funcionan PostgreSQL y la replicaci√≥n, c√≥mo Patroni administra PostgreSQL y c√≥mo se garantiza la interacci√≥n entre los nodos. </font><font style="vertical-align: inherit;">Esto es necesario para poder reparar los problemas que surgen con sus manos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasos de diagn√≥stico</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dio la casualidad de que trabajamos con diferentes clientes, en su mayor parte no tienen una pila ELK, y debe ordenar los registros abriendo 2 pesta√±as y 6 consolas: en una pesta√±a Patroni para cada nodo, en el otro: registros Consul o PostgreSQL. </font><font style="vertical-align: inherit;">Diagnosticar todo esto es dif√≠cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He desarrollado el siguiente enfoque. </font><font style="vertical-align: inherit;">Siempre miro cuando se produce una conmutaci√≥n por error. </font><font style="vertical-align: inherit;">Para m√≠ es una especie de cuenca hidrogr√°fica. </font><font style="vertical-align: inherit;">Miro lo que sucedi√≥ antes, durante y despu√©s de la fiebre. </font><font style="vertical-align: inherit;">La conmutaci√≥n por error tiene dos marcas de tiempo: inicio y fin. </font><font style="vertical-align: inherit;">En los registros, miro lo que precedi√≥ al feylover, es decir, estoy buscando razones. </font><font style="vertical-align: inherit;">Esto proporciona una comprensi√≥n de la imagen de lo que sucedi√≥ y lo que se puede hacer en el futuro para que el feylover no ocurra en las mismas circunstancias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para esto, miro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar, los registros de Patroni.</font></font></li>
<li>  PostgreSQL   DCS    ,     Patroni.</li>
<li>  ‚Äî     ,    .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos otros productos para el archivador autom√°tico: stolon, repmgr, pg_auto_failover, PAF. Prob√© las 4 herramientas y, en mi opini√≥n, Patroni es la mejor que hay en el mercado hoy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øRecomiendo Patroni? Definitivamente, s√≠, porque me gusta Patroni, creo que aprend√≠ a cocinarlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si est√° interesado en ver qu√© otros problemas hay con Patroni, adem√°s de los descritos en el art√≠culo, siempre puede ir a la p√°gina </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/zalando/patroni/issues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hay muchas historias diferentes. A pesar de que la mitad de ellos son de usuarios analfabetos que hacen preguntas est√∫pidas sin molestarse en molestarse con una simple b√∫squeda, tambi√©n se discuten problemas interesantes all√≠ y, como resultado de las discusiones, se abren tareas para corregir errores si es necesario.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a Zalando por desarrollar este proyecto, as√≠ como a las dos personas que comenzaron a trabajar en este producto: Alexander Kukushkin y Alexey Klyukin. Muchas gracias a todos los contribuyentes de Patroni. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de este informe, grabamos una breve entrevista en la que Alex intent√≥ incluir su informe en un consejo y le dijimos por qu√© participar y hablar en las conferencias. Toma las armas y ven a comprobar el enfoque en Saint HighLoad ++.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lnw02pCpgRw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<blockquote> HighLoad++   6-7 .      ,    .          ,        ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>).      -  <strong></strong>     ,  ,     ,     .<br>
<br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Saint HighLoad++</a>!    ,  ,      PostgreSQL:   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>,     PostgreSQL    JSON    ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>   PostgreSQL 13,  ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>     .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es489194/index.html">C√≥mo OpenShift est√° cambiando la estructura organizativa de una organizaci√≥n de TI. La evoluci√≥n de los modelos organizacionales al pasar a PaaS</a></li>
<li><a href="../es489196/index.html">Humo M√°gico: Microcontroladores vs. Reguladores Lineales</a></li>
<li><a href="../es489198/index.html">C√≥mo no dispararte en el pie con Liquibase</a></li>
<li><a href="../es489200/index.html">Qu√© startups est√° buscando Y Combinator en 2020</a></li>
<li><a href="../es489204/index.html">Una mirada al interior de la fiabilidad de los servicios de Facebook</a></li>
<li><a href="../es489210/index.html">Prueba de rendimiento del c√≥digo de Linux con ejemplos</a></li>
<li><a href="../es489212/index.html">1C-Bitrix evita la cancelaci√≥n de la suscripci√≥n al bolet√≠n por el requisito de enviar sus datos personales</a></li>
<li><a href="../es489214/index.html">Enfoque moderno para probar la localizaci√≥n en iOS</a></li>
<li><a href="../es489218/index.html">Es ingenuo. Super: c√≥digo y arquitectura de un juego simple</a></li>
<li><a href="../es489226/index.html">M√©todos para optimizar consultas LINQ en C # .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>