<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📑 ⌨️ 🤸 床へのペダル：PC用の別の足のマニピュレーターを作成する 👨🏿‍💻 🍀 🧗🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ほんの1か月前に、Vimのペダリングについて説明するこの記事を見つけました。少し後、3分の長い勉強の後、このトピックはもはや新しいものではなく、非常に人気があることがわかりました。私自身は緊急の場合にのみVimを使用します（コンソールで作業する必要がある場合は、Nanoを好みます）が、他のアプリケー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>床へのペダル：PC用の別の足のマニピュレーターを作成する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462263/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/4b/ju/y34bjuvl5jcdfxml6kgtlpgkdy4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほんの1か月前に、</font><font style="vertical-align: inherit;">Vimのペダリングについて説明する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font><font style="vertical-align: inherit;">を見つけました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">少し後、3分の長い勉強の後、このトピックはもはや新しいものではなく、非常に人気があることがわかりました。</font><font style="vertical-align: inherit;">私自身は緊急の場合にのみVimを使用します（コンソールで作業する必要がある場合は、Nanoを好みます）が、他のアプリケーションでも同じことができます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は小さな記事を作りたかったのですが、このデバイスを作成するためのチュートリアル全体を、段階的なコードの記述と、何をどのようにして行うかの説明とともに入手しました。</font><font style="vertical-align: inherit;">記事を膨らまさないように、ネタバレの下には、Arduinoの初心者にとって注目に値する興味深く価値があると思われるさまざまな情報がありますが、上級者、特に急いでいるユーザーは、時間を無駄にすることはありません。</font><font style="vertical-align: inherit;">完全なソースコードも記事の最後に記載されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ必要なのですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデバイスの必要性と有用性について疑いがない場合は、この項目をスキップできます。</font><font style="vertical-align: inherit;">残りについては、最初にこのデバイスを作成するための前提条件についてお話したいと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラマーとデザイナーは常に、ユーザーが不必要な問題なしにマウスとキーボードを使用してアプリケーションを操作できるように、便利でユーザーフレンドリーなインターフェイスを作成しようとしました。なぜ別のマニピュレーターが必要なのでしょうか。さて、少し歴史を見てみましょう。つまり、ピアノのような楽器が発明された18世紀初頭のことです。ご存知のように、この言葉は文字通り「うるさくて静か」​​と訳されますが、実際に当時存在していたハープシコードを実際に「活用」する巧妙なイタリアのマスターがそのような楽器を受け取ったと考える人はほとんどいません。キーから手を離します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの例があります。車にはペダルが付いているので、ガスを入れる必要がある場合にハンドルを切る必要はありません。ドラムキットには、バスドラムとシンバルを叩くペダルも付いています。また、コンピュータを使用するとペダルで何ができるのでしょうか。たとえば、ホットキーの組み合わせを設定したり、サウンドのオン/オフなど、そこにないキーを追加したりできます。ペダルは、あなたの手が忙しい場合に役立ちます。私は自分でギターを演奏します。時には伴奏に合わせて、キーボードに常に触れようとせずにバッキングを回すと非常に便利です。そして最後に、コントローラーはゲームで完全に非人道的な機会を与えることができます：ワンクリックで戦略全体で基地全体を構築するか、シューティングゲームで毎秒数十ビートの速度で敵を破壊するのは素晴らしいでしょう？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、私はあなたを納得させたいと願っています。つまり、開発自体に直接進む時がきたということです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なリソース</font></font></h2><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際には、ペダル。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのようなペダルの名前が思いつかなかったのですぐに苦労しました。</font><font style="vertical-align: inherit;">そんなものがミシンに使われているのを知りました。</font><font style="vertical-align: inherit;">一般的に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電動ペダル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のリクエストで</font><font style="vertical-align: inherit;">、Aliexpressで必要なものを見つけることができました。2回考えずに3個注文しました。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラ。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペダルボードは、不要なドライバーなしでPCに接続できるようにするために、キーボードとおそらくマウスの操作をエミュレートする必要があります。</font><font style="vertical-align: inherit;">このため、Arduino Pro Microボードは完璧です。結論はありませんが、可能な限りコンパクトになっています。</font><font style="vertical-align: inherit;">私たちは同じAliexpressに行き、この奇跡の中国語版を購入します。</font></font><br>
</li>
<li><b>.</b>   3   ,         . , ,    .<br>
</li>
<li><b>RGB-  .</b>     ,   —   .<br>
</li>
<li> ,  ,   Arduino IDE,    .<br>
</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
荷物が到着する前から、デバイス図の作成を始めました。</font><font style="vertical-align: inherit;">よく言われますが、ペダル、ダイオード、ボタンをつなぐだけなので。</font><font style="vertical-align: inherit;">次のようなことが判明しました</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/o8/yw/7mo8ywvzsfwlefxt7f-4ijqtejm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。ペダルについては、4つのポートPB1からPB4を一度に割り当てることを決定しました。つまり、今のところペダルは3つしかありませんが、左脚に2つ、右脚に2つを割り当てます。一つの場所へ。</font><font style="vertical-align: inherit;">LEDの下で、ボタンの下にある出力PD0、PD1、およびPD4を取り出しました-PD7。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、コントローラに組み込まれているプルアップ抵抗を使用すれば、プルアップ抵抗は必要ありません。</font><font style="vertical-align: inherit;">ただし、ボタンまたはペダルを押すと入力は低くなり、離すと高くなります。つまり、プレスが反転します。このことを忘れないでください。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階が最も困難でした：ポインターのいくつかのエラーのために、ブートローダーを数回消去し、その結果、ソフトウェアレベルでボードにほとんど障害が発生しました。</font><font style="vertical-align: inherit;">ファームウェアを作成するすべての段階の詳細を以下に説明します。実際に機能するコードを取得したいだけの場合は、記事の最後にあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、プログラムの観点からペダルを理解する必要があります。</font><font style="vertical-align: inherit;">ペダルをリアルタイムとトリガーの2つのモードのいずれかに設定できるようにすることにしました。</font><font style="vertical-align: inherit;">同時に、各ペダルには2つのプログラムがあります。1つ目は、ペダルがリアルタイムで保持されている場合、またはトリガーモードでタップが奇数の場合に実行されます。2つ目は、ペダルがリアルタイムで解放された場合、またはトリガーモードでタップが均等に押された場合です。</font><font style="vertical-align: inherit;">ペダルには、ポート、状態、および2つの変数（プログラム1と2の現在の位置）もあります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> {</span>
  <span class="hljs-keyword">char</span> port; <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">char</span> state; <span class="hljs-comment">//  ,  </span>
  <span class="hljs-keyword">char</span> oldState; <span class="hljs-comment">//  ,  </span>
  <span class="hljs-keyword">char</span> pos1; <span class="hljs-comment">//  1</span>
  <span class="hljs-keyword">char</span> pos2; <span class="hljs-comment">//  2</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type; <span class="hljs-comment">//0 —   , 1 —  ;</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act1[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 1</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act2[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 2</span><font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arduinoにはかなりのメモリがあり、8ビットでもあるため、可能な場合はintではなくcharを使用することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーボードとして機能するには、標準のキーボードライブラリも必要です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリック処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、配列からデータを読み取り、キーストロークの形式でマシンに送信するインタープリターを作成し、さまざまな内部コマンドのいくつかの値を選択する必要があります。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ページ</font></a><font style="vertical-align: inherit;">を開く</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーコードを使用して、何がどのようにクリックできるかを確認します。ここにある情報はそのようなプロジェクトには十分に思えたので、私は深く掘り下げてあらゆる種類のキーボード標準を研究しませんでした。前半は標準のASCII文字用に予約されています（ただし、一部は印刷できないか、使用されません）、後半はさまざまな修飾キー用です。左と右のキーには別々のコードさえありますが、これは非常に喜ばしいことですが、ナンパッドからの数字に特別なコードは表示されませんでしたが、私の知る限り、通常の数字よりもシステムで特別な方法で認識されています。おそらく、それらのコードは範囲の「穴」のどこかにありますが、今はそれについてではありません。したがって、最大のコードはアップキー-218です。これは、219〜255の範囲がフリーであると見なすことができるか、少なくとも重要なキーがないことを意味します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pedalAction</span><span class="hljs-params">()</span> </span>{
 <span class="hljs-comment">//255  ,    </span>
  <span class="hljs-keyword">if</span> (pedal1-&gt;type == <span class="hljs-number">255</span>)
    <span class="hljs-keyword">return</span>;
<span class="hljs-comment">//    </span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *prg;
<span class="hljs-comment">//    </span>
  <span class="hljs-keyword">char</span> *pos;
  <span class="hljs-keyword">if</span> (pedal1-&gt;type) {
<span class="hljs-comment">//       </span>
    <span class="hljs-keyword">int</span> current;
    <span class="hljs-keyword">if</span> ((current = digitalRead(ports[num])) != oldState[num]) {
      <span class="hljs-keyword">if</span> (!current)<font></font>
        state[num] = !state[num];<font></font>
      oldState[num] = current;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!state[num]) {
      <span class="hljs-comment">//act1</span>
      pos2[num] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos1[num]);<font></font>
      prg = pedal1-&gt;act1;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//act2</span>
      pos1[num] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos2[num]);<font></font>
      prg = pedal1-&gt;act2;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {
<span class="hljs-comment">//        </span>
    <span class="hljs-keyword">if</span> (!digitalRead(ports[num])) {
      <span class="hljs-comment">//act1</span>
      pos2[num] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos1[num]);<font></font>
      prg = pedal1-&gt;act1;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//act2</span>
      pos1[num] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos2[num]);<font></font>
      prg = pedal1-&gt;act2;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
   <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">254</span>) {
      <span class="hljs-comment">// ,   *pos</span><font></font>
      Keyboard.press(prg[++*pos]);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">253</span>) {
      <span class="hljs-comment">// ,   *pos</span><font></font>
      Keyboard.release(prg[++*pos]);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">252</span>) {
      <span class="hljs-comment">//" ",   </span><font></font>
      ++*pos;<font></font>
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">251</span>) {
      <span class="hljs-comment">//       *pos+1</span>
      *pos = prg[*pos + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">255</span> || prg[*pos] == <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// ,  </span>
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//  </span><font></font>
      Keyboard.write(prg[*pos]);<font></font>
    }<font></font>
    <span class="hljs-comment">//       ,    </span>
    <span class="hljs-keyword">if</span> (++*pos&gt;=<span class="hljs-number">16</span>)<font></font>
       pos = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cの知識があまりない人でも、ここで何が起こっているのか疑問に思わないでしょう。</font><font style="vertical-align: inherit;">まず、この機能は目的のペダルを選択し、ペダルのモードと状態に応じて、どのプログラムを実行するかを決定します。</font><font style="vertical-align: inherit;">配列の各要素を読み取るときに、それが制御文字でない場合は、Keyboard.write（）関数が呼び出され、キーの押し下げをエミュレートします。</font><font style="vertical-align: inherit;">制御文字は個別に処理され、キーの組み合わせをクランプしてプログラムをナビゲートするために必要です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーボードモードのいくつかの機能</font></font></b><div class="spoiler_text"> Keyboard.write()   ,     ,   ,        ,    . -,   ,           ,    ,    - 0x03 ( )  0x1B ( ESCAPE-)    . -,     ,     ASCII ,        Shift+&lt; &gt;.    ,     CapsLock,    «»       . -,      ,    -   .      -   ,  <b> </b>.  Keyboard.write()     ,   USB    ,  ,        ,      ,    . ,          Arduino,       «Ghbdtn»,    ,    .  «»     ,    ,   ,      ,   ,         . (-   ,          ,  -        ,     .)<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ですから、私達には通訳があり、ペダルボードがコンピュータとどのように相互作用するかについて大まかに理解しています。</font><font style="vertical-align: inherit;">次に、これらすべてを完全なファームウェアの状態にして、1つのペダルのパフォーマンスを確認する必要があります。</font><font style="vertical-align: inherit;">ペダルのインスタンスを作成し、pedalAction（）を周期的に呼び出す場合、理論的には構造で指定されたプログラムを実行します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> *<span class="hljs-title">pedal1</span> = {</span><span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Hello, world!\0"</span>, <span class="hljs-number">0</span>};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">prepare</span> <span class="hljs-params">()</span> </span>{<font></font>
   pinMode(<span class="hljs-number">15</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">//2 - INPUT_PULLUP,       </span><font></font>
   Keyboard.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
   pedalAction();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、Arduinoは設定されていないデータを解釈しようとするだけでなく、高速でマシンに送信するため、長さが配列のサイズよりも小さく、循環的でない場合は、これらの「プログラム」でnullターミネーターを忘れないでください。これはサルにキーボードを与えるのと同じです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのペダルは良いです、そして2つはより良い</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、いくつかのペダルからの信号の処理を処理し、スイッチングモードを追加します。</font><font style="vertical-align: inherit;">記事の冒頭では、ペダルに4つのポートが割り当てられており、各ポートは7つのモードで動作する必要があります。</font><font style="vertical-align: inherit;">なぜ7？</font><font style="vertical-align: inherit;">PWMを使用しないと、LEDは7色しか提供できず、8番目はオフになります。</font><font style="vertical-align: inherit;">この量は平均的なユーザーには十分ですが、極端な場合は簡単に増やすことができます。</font><font style="vertical-align: inherit;">これは、ペダルを7 x 4の2次元配列に格納することを意味します。メモリを詰まらせないために、ポート番号など、いくつかの構造に共通の値を別々の配列で取り出すことができます。</font><font style="vertical-align: inherit;">その結果、次のようなものが得られます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> {</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act1[<span class="hljs-number">16</span>];
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act2[<span class="hljs-number">16</span>];<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> <span class="hljs-title">pedals</span>[7][4] = {</span><font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-string">"Hello, world!\0"</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },<font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">char</span> ports[<span class="hljs-number">4</span>] = {<span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">14</span>, <span class="hljs-number">8</span>};
<span class="hljs-keyword">char</span> pos1[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> pos2[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> state[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> oldState[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};<font></font>
<font></font>
<span class="hljs-keyword">char</span> mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// </span>
<span class="hljs-keyword">char</span> curPedal = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数255の魔法</font></font></b><div class="spoiler_text">  ,         255, ,      0.  , ,         EEPROM,          0,     255,             ,  0,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペダルのタイプと2つのプログラムだけを知っていることが重要です。そのため、これらは直接構造体にのみ残し、オートメーションに残りの作業を任せます。</font><font style="vertical-align: inherit;">prepareおよびloopメソッドは次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">prepare</span><span class="hljs-params">()</span></span>{<font></font>
  pinMode(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(<span class="hljs-number">6</span>, <span class="hljs-number">2</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : ports)<font></font>
    pinMode(i, <span class="hljs-number">2</span>);<font></font>
  Keyboard.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) {
   <span class="hljs-keyword">int</span> current;
  <span class="hljs-keyword">if</span> ((current = digitalRead(modeButton)) != last) {
    <span class="hljs-keyword">if</span> (!current) {
      <span class="hljs-keyword">if</span> (++mode &gt;= <span class="hljs-number">7</span>)<font></font>
        mode = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (pedals[mode][<span class="hljs-number">0</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">1</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">2</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">3</span>].type == <span class="hljs-number">255</span>)
        <span class="hljs-keyword">if</span> (++mode &gt;= <span class="hljs-number">7</span>) {<font></font>
          mode = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
    last = current;<font></font>
    digitalWrite(<span class="hljs-number">2</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b001</span>);<font></font>
    digitalWrite(<span class="hljs-number">3</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b010</span>);<font></font>
    digitalWrite(<span class="hljs-number">4</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b100</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {<font></font>
      pos1[i]  = <span class="hljs-number">0</span>;<font></font>
      pos2[i]  = <span class="hljs-number">0</span>;<font></font>
      state[i]  = <span class="hljs-number">0</span>;<font></font>
      oldState[i]  = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
<font></font>
    delay(<span class="hljs-number">50</span>);<font></font>
  }<font></font>
      curPedal = i;<font></font>
      pedalAction<font></font>
    }<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのペダルが宣言されていない場合（モード= 255）、コントローラーはモードが未使用であると見なします。つまり、モードに到達するとすぐに次のモードに進みますが、最初のモードは常に存在します。</font><font style="vertical-align: inherit;">モードを切り替えると、各モードで値を保存する必要がないため、配列内のすべての値が無効になります（そうですか？）そして、ループはすべてのペダルをバイパスし、それらのペダルActionを呼び出します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、pedalAction（）メソッドの最初に、次の行を追加して、処理する構造を理解できるようにする必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> *<span class="hljs-title">pedal1</span> = &amp;<span class="hljs-title">pedals</span>[<span class="hljs-title">mode</span>][<span class="hljs-title">curPedal</span>];</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
既存のpedal1構造は不要になり削除できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これもすべてうまく機能しますが、Arduinoが送信する速度でクリックを受信する時間がないプログラムがあるという問題が発生しました。</font><font style="vertical-align: inherit;">最も明白な解決策は、必要に応じてアクション間の遅延を設定する機能を追加することです。</font><font style="vertical-align: inherit;">ハードウェアマルチスレッドのようなすべてのチップがハイレベルコンピューターのどこかにとどまっているのは、マイクロコントローラー用のプログラムを書くときだけであり、遅延を追加すると、コントローラーが正しいサイクル数をカウントするまでプログラム全体が停止します。</font><font style="vertical-align: inherit;">マルチスレッディングがないため、作成する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はいと言うのは簡単</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はホイールを再発明し始めませんでしたが、完成したライブラリArduinoThreadを採用しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それがどのように機能するかについて少し読んで、それをダウンロードできます。</font><font style="vertical-align: inherit;">ライブラリはArduino IDE自体からダウンロードできます。</font><font style="vertical-align: inherit;">つまり、一定の間隔で関数を定期的に実行できますが、間隔よりも実行に時間がかかる場合は無限ループに入ることができません。</font><font style="vertical-align: inherit;">まさに必要なもの。</font><font style="vertical-align: inherit;">各ペダルのスレッドを含む別の配列を作成します。</font></font><br>
<br>
<pre><code class="cpp hljs">Thread pedalThreads[<span class="hljs-number">6</span>] = {Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction,  <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>)};
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで6つの同一の仮想スレッドがありますが、同時にそれらは異なるオブジェクトです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい機能を使用するためのペダルサイクルを書き換えましょう。</font></font><br>
<br>
<pre><code class="cpp hljs">...
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
    <span class="hljs-keyword">if</span> (pedalThreads[i].shouldRun()) {<font></font>
      curPedal = i;<font></font>
      pedalThreads[i].run();<font></font>
    }<font></font>
  }<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラム配列の252の値は、「何もしない」に相当し、10ミリ秒の遅延が発生します（ただし、コードの実行にも時間がかかるため、実際には少し長くなります）。インタプリタに数行を追加すると、配列の2バイトのみを使用して、これらの「クォンタム」のいくつかに遅延を設定できるようになります。</font></font><br>
<br>
<pre><code class="cpp hljs">...
<span class="hljs-keyword">if</span> (wait[num]) {<font></font>
      wait[num]--;<font></font>
      <span class="hljs-keyword">return</span>;<font></font>
    }  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">250</span>) {<font></font>
      wait[num] = prg[++*pos];<font></font>
    }<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のコマンドとは異なり、この命令はインタプリタがプログラムの読み取りに進む前に遅延を処理する必要があるため、インタプリタの先頭、つまり「while（1）{」の直後に追加する必要があります。</font><font style="vertical-align: inherit;">ポート、状態などで行われたのと同じ方法で待機配列を宣言する必要があります。</font><font style="vertical-align: inherit;">また、モードを切り替えるときにセルをリセットし、遅延が別のプログラムに渡らないようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、遅延を2.55秒に設定できるようになったため、プログラムによるキーの定義に関する問題は発生しなくなりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外出先でのプログラミング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、ここでコードを完了してデバイスの組み立てを開始することは可能ですが、この場合、誰かが突然ペダルを再プログラムしたい場合は、Arduino IDEを開いてコードを編集し、ファームウェアをリロードする必要があります。もちろん、このオプションは最適ではないので、Arduinoシリアルポートからプログラムを変更して、プログラム自体をEEPROMに保存する機能を追加することにしました。不揮発性メモリを使用するには、標準ライブラリEEPROM.hを接続する必要があります。プログラミングモードコードは次のとおりです。</font></font><br>
<br>
<pre><code class="cpp hljs">...
  <span class="hljs-keyword">if</span> (!digitalRead(modeButton)) {
    <span class="hljs-comment">// </span>
    Serial.begin(<span class="hljs-number">9600</span>);
    <span class="hljs-keyword">while</span> (!Serial) {<font></font>
      PORTD = <span class="hljs-number">0b00000000</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">250</span>);<font></font>
      PORTD = <span class="hljs-number">0b00010000</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">250</span>);<font></font>
    }<font></font>
<font></font>
    Serial.println(F(<span class="hljs-string">"***Programming mode***"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"Write the command as &lt;m&gt; &lt;p&gt; &lt;c&gt;"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"m - number of mode, one digit"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"p - number of pedal, one digit"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"c - command, it can be:"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\tr - read pedal info"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\tw - enter to writing mode and change pedal programm"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\te - erase pedal programm and delete it"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"There are up to 7 modes and 6 pedals per mode can be configured"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"Mode will be incative if there is no pedal configured in it"</span>));
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
        Serial.read();<font></font>
        delay(<span class="hljs-number">1</span>);<font></font>
      }<font></font>
      PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      Serial.println(<span class="hljs-string">""</span>);<font></font>
      Serial.println(F(<span class="hljs-string">"Enter command"</span>));
      <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
      PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">3</span>);
      <span class="hljs-keyword">if</span> (Serial.available() == <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">int</span> curMode = Serial.read() - <span class="hljs-number">48</span>;
        <span class="hljs-keyword">int</span> curPedal = Serial.read() - <span class="hljs-number">48</span>;
        <span class="hljs-keyword">char</span> cmd = Serial.read();
        <span class="hljs-keyword">if</span> (curMode &gt; <span class="hljs-number">6</span> || curMode &lt; <span class="hljs-number">0</span>) {<font></font>
          Serial.print(F(<span class="hljs-string">"Mode must be in 0-6. You entered "</span>));<font></font>
          Serial.println(curMode);<font></font>
          <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (curPedal &gt; <span class="hljs-number">3</span> || curPedal &lt; <span class="hljs-number">0</span>) {<font></font>
          Serial.print(F(<span class="hljs-string">"Pedal must be in 0-3. You entered "</span>));<font></font>
          Serial.println(curPedal);<font></font>
          <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        Serial.println();<font></font>
        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'r'</span>) {
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);<font></font>
          Serial.print(<span class="hljs-string">"type: "</span>);
          <span class="hljs-keyword">int</span> curAddress = beginAddress;<font></font>
          Serial.println(EEPROM[curAddress++]);<font></font>
          Serial.print(<span class="hljs-string">"act1: "</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = curAddress ; i &lt; curAddress + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>; i++) {<font></font>
            Serial.print(EEPROM[i]);<font></font>
            Serial.print(<span class="hljs-string">"\t"</span>);<font></font>
          }<font></font>
          Serial.println();<font></font>
          curAddress = beginAddress + <span class="hljs-number">1</span> + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;<font></font>
          Serial.print(<span class="hljs-string">"act2: "</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = curAddress ; i &lt; curAddress + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>; i++) {<font></font>
            Serial.print(EEPROM[i]);<font></font>
            Serial.print(<span class="hljs-string">"\t"</span>);<font></font>
          }<font></font>
          Serial.println();<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'w'</span>) {<font></font>
          Serial.println(F(<span class="hljs-string">"Enter type:"</span>));<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (!Serial.available());
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);
          <span class="hljs-keyword">int</span> curAddress = beginAddress;<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Enter act1 in DEC divided by space:"</span>));
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            Serial.read();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          curAddress = beginAddress + <span class="hljs-number">1</span> + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;<font></font>
          Serial.println(F(<span class="hljs-string">"Enter act2 in DEC divided by space:"</span>));<font></font>
<font></font>
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            Serial.read();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Finished, don't forget to verify written data!"</span>));<font></font>
        }  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'e'</span>) {
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);<font></font>
          Serial.println(F(<span class="hljs-string">"Disabling pedal..."</span>));<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          EEPROM[beginAddress] = <span class="hljs-number">255</span>;<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Pedal disabled"</span>));<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        Serial.println(F(<span class="hljs-string">"Incorrect command, please read help above"</span>));<font></font>
      }<font></font>
    };<font></font>
  }<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードの機能は、コードに含まれているヘルプで説明されています。モード番号、ペダル番号、およびコマンドにはスペース番号が入力され、3つあります— </font><font style="vertical-align: inherit;">プログラムの削除</font><font style="vertical-align: inherit;">、読み取り、書き込み、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">ペダル上のすべてのデータは、33バイトのシーケンス、つまりペダルのタイプ、および2つのプログラムで次々に格納され、EEPROMの1024バイトのうち7 * 4 * 33 = 924を占有します。</font><font style="vertical-align: inherit;">ペダルの動的サイズをメモリで使用するオプションを放棄しました。この場合、1つのペダルを再プログラムするときは、ほとんどすべてのセルを上書きする必要があり、書き換えサイクルの数には限りがあるため、これをできるだけ少なくすることをお勧めします。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EEPROMとの連携の特徴</font></font></b><div class="spoiler_text">       :<br>
<pre><code class="cpp hljs"> PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
         ...<font></font>
  PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
</code></pre><br>
  ,    ,      char, ,  «»,   ,     —   ,      ~3 ,      .          ,     «»  .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラム録画モードでは、入力はスペースを含む10進数システムのバイトの値によって直接行われます。</font><font style="vertical-align: inherit;">結構厳しいですが、複雑なパーサーを作成する必要はありません。</font><font style="vertical-align: inherit;">さらに、再プログラミングはそれほど頻繁には行われず、これらの場合、ASCIIテーブルを調べることは十分に可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分類された構造を保持した状態で、データをそこから引き出して "ペダル"ビューに変換する必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs">...
 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">4</span>; j++) {
      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> *<span class="hljs-title">p</span> = &amp;<span class="hljs-title">pedals</span>[<span class="hljs-title">i</span>][<span class="hljs-title">j</span>];</span>
      <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (i * <span class="hljs-number">6</span> + j);
      <span class="hljs-keyword">int</span> curAddress = beginAddress;
      <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type = EEPROM[curAddress++];
      <span class="hljs-keyword">if</span> (type == <span class="hljs-number">0</span> || type == <span class="hljs-number">1</span>) {<font></font>
        p-&gt;type = type;<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span> ; k &lt; <span class="hljs-number">16</span>; k++) {<font></font>
          p-&gt;act1[k] = EEPROM[curAddress++];<font></font>
        }<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span> ; k &lt; <span class="hljs-number">16</span>; k++) {<font></font>
          p-&gt;act2[k] = EEPROM[curAddress++];<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでも超自然現象は発生しません。コントローラがメモリからデータを読み取り、既存の構造体にデータを入力します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UARTを介したプログラミングの利点は、特別なドライバーが不要になるため、電話からでもマニピュレーターの動作を設定できることです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモンストレーション</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/pkjtRLlNZnU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なソースコード</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼はここにいます</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Keyboard.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Thread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;EEPROM.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> modeButton 6</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> {</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type; <span class="hljs-comment">//0 —   , 1 —  , 255 —   </span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act1[<span class="hljs-number">16</span>];
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> act2[<span class="hljs-number">16</span>];<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> <span class="hljs-title">pedals</span>[7][4] = {</span><font></font>
  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  },  {<font></font>
    { <span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}, {<span class="hljs-number">255</span>, {<span class="hljs-number">255</span>}, {<span class="hljs-number">255</span>}}<font></font>
  }<font></font>
};<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">char</span> ports[<span class="hljs-number">4</span>] = {<span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">15</span>, <span class="hljs-number">14</span>};
<span class="hljs-keyword">char</span> pos1[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> pos2[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> state[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> oldState[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-keyword">char</span> wait[<span class="hljs-number">4</span>]  = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pedalAction</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">char</span> mode = <span class="hljs-number">0</span>;
<span class="hljs-keyword">char</span> curPedal;<font></font>
<font></font>
<font></font>
Thread pedalThreads[<span class="hljs-number">6</span>] = {Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>), Thread(pedalAction, <span class="hljs-number">10</span>)};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
  pinMode(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>);<font></font>
  pinMode(modeButton, <span class="hljs-number">2</span>);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!digitalRead(modeButton)) {
    <span class="hljs-comment">// </span>
    Serial.begin(<span class="hljs-number">9600</span>);
    <span class="hljs-keyword">while</span> (!Serial) {<font></font>
      PORTD = <span class="hljs-number">0b00000000</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">250</span>);<font></font>
      PORTD = <span class="hljs-number">0b00010000</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">250</span>);<font></font>
    }<font></font>
<font></font>
    Serial.println(F(<span class="hljs-string">"***Programming mode***"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"Write the command as &lt;m&gt; &lt;p&gt; &lt;c&gt;"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"m - number of mode, one digit"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"p - number of pedal, one digit"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"c - command, it can be:"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\tr - read pedal info"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\tw - enter to writing mode and change pedal programm"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"\te - erase pedal programm and delete it"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"There are up to 7 modes and 6 pedals per mode can be configured"</span>));<font></font>
    Serial.println(F(<span class="hljs-string">"Mode will be incative if there is no pedal configured in it"</span>));
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
        Serial.read();<font></font>
        delay(<span class="hljs-number">1</span>);<font></font>
      }<font></font>
      PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      Serial.println(<span class="hljs-string">""</span>);<font></font>
      Serial.println(F(<span class="hljs-string">"Enter command"</span>));
      <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
      PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
      delay(<span class="hljs-number">3</span>);
      <span class="hljs-keyword">if</span> (Serial.available() == <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">int</span> curMode = Serial.read() - <span class="hljs-number">48</span>;
        <span class="hljs-keyword">int</span> curPedal = Serial.read() - <span class="hljs-number">48</span>;
        <span class="hljs-keyword">char</span> cmd = Serial.read();
        <span class="hljs-keyword">if</span> (curMode &gt; <span class="hljs-number">6</span> || curMode &lt; <span class="hljs-number">0</span>) {<font></font>
          Serial.print(F(<span class="hljs-string">"Mode must be in 0-6. You entered "</span>));<font></font>
          Serial.println(curMode);<font></font>
          <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (curPedal &gt; <span class="hljs-number">3</span> || curPedal &lt; <span class="hljs-number">0</span>) {<font></font>
          Serial.print(F(<span class="hljs-string">"Pedal must be in 0-3. You entered "</span>));<font></font>
          Serial.println(curPedal);<font></font>
          <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        Serial.println();<font></font>
        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'r'</span>) {
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);<font></font>
          Serial.print(<span class="hljs-string">"type: "</span>);
          <span class="hljs-keyword">int</span> curAddress = beginAddress;<font></font>
          Serial.println(EEPROM[curAddress++]);<font></font>
          Serial.print(<span class="hljs-string">"act1: "</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = curAddress ; i &lt; curAddress + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>; i++) {<font></font>
            Serial.print(EEPROM[i]);<font></font>
            Serial.print(<span class="hljs-string">"\t"</span>);<font></font>
          }<font></font>
          Serial.println();<font></font>
          curAddress = beginAddress + <span class="hljs-number">1</span> + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;<font></font>
          Serial.print(<span class="hljs-string">"act2: "</span>);
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = curAddress ; i &lt; curAddress + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>; i++) {<font></font>
            Serial.print(EEPROM[i]);<font></font>
            Serial.print(<span class="hljs-string">"\t"</span>);<font></font>
          }<font></font>
          Serial.println();<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'w'</span>) {<font></font>
          Serial.println(F(<span class="hljs-string">"Enter type:"</span>));<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (!Serial.available());
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);
          <span class="hljs-keyword">int</span> curAddress = beginAddress;<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Enter act1 in DEC divided by space:"</span>));
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            Serial.read();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          curAddress = beginAddress + <span class="hljs-number">1</span> + (<span class="hljs-keyword">sizeof</span>(struct pedal) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;<font></font>
          Serial.println(F(<span class="hljs-string">"Enter act2 in DEC divided by space:"</span>));<font></font>
<font></font>
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            Serial.read();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          <span class="hljs-keyword">while</span> (!Serial.available());<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);
          <span class="hljs-keyword">while</span> (Serial.available()) {<font></font>
            EEPROM[curAddress++] = (<span class="hljs-keyword">char</span>)Serial.parseInt();<font></font>
            delay(<span class="hljs-number">1</span>);<font></font>
          }<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Finished, don't forget to verify written data!"</span>));<font></font>
        }  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">'e'</span>) {
          <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (curMode * <span class="hljs-number">6</span> + curPedal);<font></font>
          Serial.println(F(<span class="hljs-string">"Disabling pedal..."</span>));<font></font>
          PORTD = <span class="hljs-number">0b00000010</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          EEPROM[beginAddress] = <span class="hljs-number">255</span>;<font></font>
          PORTD = <span class="hljs-number">0b00000001</span> + (PORTD &amp; <span class="hljs-number">0b11101100</span>);<font></font>
          Serial.println(F(<span class="hljs-string">"Pedal disabled"</span>));<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        Serial.println(F(<span class="hljs-string">"Incorrect command, please read help above"</span>));<font></font>
      }<font></font>
    };<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : ports)<font></font>
    pinMode(i, <span class="hljs-number">2</span>);<font></font>
  pinMode(<span class="hljs-number">17</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">4</span>; j++) {
      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> *<span class="hljs-title">p</span> = &amp;<span class="hljs-title">pedals</span>[<span class="hljs-title">i</span>][<span class="hljs-title">j</span>];</span>
      <span class="hljs-keyword">int</span> beginAddress = <span class="hljs-keyword">sizeof</span>(struct pedal) * (i * <span class="hljs-number">6</span> + j);
      <span class="hljs-keyword">int</span> curAddress = beginAddress;
      <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type = EEPROM[curAddress++];
      <span class="hljs-keyword">if</span> (type == <span class="hljs-number">0</span> || type == <span class="hljs-number">1</span>) {<font></font>
        p-&gt;type = type;<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span> ; k &lt; <span class="hljs-number">16</span>; k++) {<font></font>
          p-&gt;act1[k] = EEPROM[curAddress++];<font></font>
        }<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span> ; k &lt; <span class="hljs-number">16</span>; k++) {<font></font>
          p-&gt;act2[k] = EEPROM[curAddress++];<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  Keyboard.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">int</span> last = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int</span> current;
  <span class="hljs-keyword">if</span> ((current = digitalRead(modeButton)) != last) {
    <span class="hljs-keyword">if</span> (!current) {
      <span class="hljs-keyword">if</span> (++mode &gt;= <span class="hljs-number">7</span>)<font></font>
        mode = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (pedals[mode][<span class="hljs-number">0</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">1</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">2</span>].type == <span class="hljs-number">255</span> &amp;&amp; pedals[mode][<span class="hljs-number">3</span>].type == <span class="hljs-number">255</span>)
        <span class="hljs-keyword">if</span> (++mode &gt;= <span class="hljs-number">7</span>) {<font></font>
          mode = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
    last = current;<font></font>
    digitalWrite(<span class="hljs-number">2</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b001</span>);<font></font>
    digitalWrite(<span class="hljs-number">3</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b010</span>);<font></font>
    digitalWrite(<span class="hljs-number">4</span>, (mode + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0b100</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {<font></font>
      pos1[i]  = <span class="hljs-number">0</span>;<font></font>
      pos2[i]  = <span class="hljs-number">0</span>;<font></font>
      state[i]  = <span class="hljs-number">0</span>;<font></font>
      oldState[i]  = <span class="hljs-number">0</span>;<font></font>
      wait[i]  = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
<font></font>
    delay(<span class="hljs-number">50</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
    <span class="hljs-keyword">if</span> (pedalThreads[i].shouldRun()) {<font></font>
      curPedal = i;<font></font>
      pedalThreads[i].run();<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pedalAction</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pedal</span> *<span class="hljs-title">pedal1</span> = &amp;<span class="hljs-title">pedals</span>[<span class="hljs-title">mode</span>][<span class="hljs-title">curPedal</span>];</span>
  <span class="hljs-keyword">if</span> (pedal1-&gt;type == <span class="hljs-number">255</span>)
    <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *prg;
  <span class="hljs-keyword">char</span> *pos;
  <span class="hljs-keyword">if</span> (pedal1-&gt;type) {
    <span class="hljs-keyword">int</span> current;
    <span class="hljs-keyword">if</span> ((current = digitalRead(ports[curPedal])) != oldState[curPedal]) {
      <span class="hljs-keyword">if</span> (!current)<font></font>
        state[curPedal] = !state[curPedal];<font></font>
      oldState[curPedal] = current;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!state[curPedal]) {
      <span class="hljs-comment">//act1</span>
      pos2[curPedal] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos1[curPedal]);<font></font>
      prg = pedal1-&gt;act1;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//act2</span>
      pos1[curPedal] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos2[curPedal]);<font></font>
      prg = pedal1-&gt;act2;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (!digitalRead(ports[curPedal])) {
      <span class="hljs-comment">//act1</span>
      pos2[curPedal] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos1[curPedal]);<font></font>
      prg = pedal1-&gt;act1;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//act2</span>
      pos1[curPedal] = <span class="hljs-number">0</span>;<font></font>
      pos = &amp;(pos2[curPedal]);<font></font>
      prg = pedal1-&gt;act2;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (wait[curPedal]) {<font></font>
      wait[curPedal]--;<font></font>
      <span class="hljs-keyword">return</span>;<font></font>
    }  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">250</span>) {<font></font>
      wait[curPedal] = prg[++*pos];<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">254</span>) {
      <span class="hljs-comment">// ,   *pos</span><font></font>
      Keyboard.press(prg[++*pos]);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">253</span>) {
      <span class="hljs-comment">// ,   *pos</span><font></font>
      Keyboard.release(prg[++*pos]);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">252</span>) {<font></font>
      delay(<span class="hljs-number">10</span>);
      <span class="hljs-comment">//" ",   </span><font></font>
      ++*pos;<font></font>
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">251</span>) {
      <span class="hljs-comment">//       *pos+1</span>
      *pos = prg[*pos + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prg[*pos] == <span class="hljs-number">255</span> || prg[*pos] == <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// ,  </span>
      <span class="hljs-keyword">return</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//  </span><font></font>
      Keyboard.write(prg[*pos]);<font></font>
    }<font></font>
    <span class="hljs-comment">//       ,    </span>
    <span class="hljs-keyword">if</span> (++*pos &gt;= <span class="hljs-number">16</span>)<font></font>
      pos = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あとがき</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初はギターを弾きながらレコーディングをスクロールできるようにするためにペダルボードを作りましたが、個人的には通常の作業でペダルを使うのが便利だと思いましたが、主なことはそのような変わったマニピュレーターに少し慣れることです。</font><font style="vertical-align: inherit;">そして、ここにはもう1つの問題があります。お気に入りのペダルがないと、何を、どこで、なぜ押すかを覚えておかなければならないので、逆の作業はより難しくなります。</font><font style="vertical-align: inherit;">それでもペダルを着用してオフィスに接続できる場合は、研究所では教室でペダルを一緒に走り回るのがより困難になります。</font><font style="vertical-align: inherit;">したがって、このデバイスを本来の目的以外の目的で使用することは、あなた自身の危険と危険にさらされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立てられたペダルボード：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rw/p9/-v/rwp9-vaul_zvd9awymeb1qexlqi.jpeg"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462245/index.html">Linuxカーネルの例としての自動git bisect</a></li>
<li><a href="../ja462251/index.html">ブラウザのシークレットモードはフィクションですか？</a></li>
<li><a href="../ja462253/index.html">ReddコンプレックスのFPGAでのCPUおよびプロセッサ通信の例でストリーミングプロトコルを使用した最初の実験</a></li>
<li><a href="../ja462257/index.html">KubernetesのKafka-それは良いですか？</a></li>
<li><a href="../ja462259/index.html">スマートホーム用のコントローラーを作る</a></li>
<li><a href="../ja462265/index.html">Pythonとキューブ</a></li>
<li><a href="../ja462269/index.html">ジョン・ロメロからドゥーム：80年代のゲーム開発</a></li>
<li><a href="../ja462271/index.html">iOSでコードをロックする：Appleが防御から防御へと切り替わった方法</a></li>
<li><a href="../ja462273/index.html">digisparkでラップトップスタンドを管理する</a></li>
<li><a href="../ja462275/index.html">PVS-Studio Static Analyzer for Javaの紹介</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>