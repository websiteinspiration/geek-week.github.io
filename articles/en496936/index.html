<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📒 ✍🏾 🎒 Let's encrypt SSL certificates with cert-manager in Kubernetes 🍢 👁‍🗨 👩‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about how to automate the ordering and renewal of certificates from Let's Encrypt (and not only) for Ingress in Kubernetes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Let's encrypt SSL certificates with cert-manager in Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/496936/"><img src="https://habrastorage.org/webt/la/qd/o7/laqdo7i6ovirl5ciie_qmnbrau4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will talk about how to automate the ordering and renewal of certificates from Let's Encrypt (and not only) for Ingress in Kubernetes using the add-on cert-manager. </font><font style="vertical-align: inherit;">But I'll start with a brief introduction to the essence of the problem.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of educational program</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The HTTP protocol, developed in the early 90s of the last century, entered our everyday life so tightly that it’s hard to imagine at least a day without using it. However, by itself, it does not even provide a minimum level of security when exchanging information between a user and a web server. HTTPS (“S” - secure) comes to the rescue: using the packaging of the transmitted data in SSL / TLS, this protocol has proven itself in protecting information from interception and is actively promoted by the industry. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, Google has </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://security.googleblog.com/2014/08/"><font style="vertical-align: inherit;">adhered</font></a><font style="vertical-align: inherit;"> to 2014</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://security.googleblog.com/2014/08/"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“HTTPS everywhere” position and even lowers the priority of sites without it in the search results. This “propaganda” does not bypass ordinary consumers either: modern browsers warn their users about the presence and correctness of SSL certificates for visited sites. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/me/il/srmeilomqktrr7qofwjlgpiw01i.png"><br>
<img src="https://habrastorage.org/webt/mj/jo/pf/mjjopfpjvy84bnbdae_mv6vluw8.png"><br>
<img src="https://habrastorage.org/webt/dd/t4/vn/ddt4vnh-3yseofqyzip5qma-dti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cost of a certificate for a personal site starts from tens of dollars. Not always buying it is justified and appropriate. Fortunately, since the end of 2015, a free alternative in the form of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's Encrypt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (LE) </font><font style="vertical-align: inherit;">certificates is available </font><font style="vertical-align: inherit;">. This nonprofit project was created by Mozilla enthusiasts in order to cover most of the websites with encryption. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certificate Authority issues </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">domain-validated</font></a><font style="vertical-align: inherit;"> certificates</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(the simplest among those available on the market) with a validity period of 90 days, and for many years it has been possible to issue the so-called wildcard certificate for several subdomains. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To obtain the certificate, the site uses the algorithms described in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automated Certificate Management Environment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ACME) </font><font style="vertical-align: inherit;">protocol </font><font style="vertical-align: inherit;">, created specifically for Let's Encrypt. </font><font style="vertical-align: inherit;">When using it, confirmation of domain ownership is carried out by requests through the placement of a specific HTTP code (called </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP-01</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) or the installation of DNS records </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(DNS-01)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - more about them will be given below.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certification manager</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cert-manager</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a special project for Kubernetes, which is a set of CustomResourceDefinitions (hence the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limitation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the minimum supported version of K8s - v1.12) for CA configuration (certification authorities) and direct ordering of certificates. </font><font style="vertical-align: inherit;">Installing CRD in a cluster is trivial and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comes down</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to using one YAML file:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl create ns cert-manager<font></font>
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.13.0/cert-manager.yaml</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also the possibility of installing using Helm.)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
To initiate the ordering procedure, the cluster must have the resources of certification authorities (CAs) declared: </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>ClusterIssuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, - which are used to sign the CSR (certificate issuance requests). </font><font style="vertical-align: inherit;">The difference between the first resource and the second is in scope:</font></font><br>
<br>
<ul>
<li> <code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be used within the same namespace,</font></font></li>
<li> <code>ClusterIssuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a global cluster object.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice with cert-manager</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 1. </font><font style="vertical-align: inherit;">Self Signed Certificate</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the simplest case - ordering a self-signed certificate. </font><font style="vertical-align: inherit;">This option is quite common, for example, for dynamic test environments for developers or in the case of using an external balancer that terminates SSL traffic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The resource </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will look like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Issuer<font></font>
metadata:<font></font>
  name: selfsigned<font></font>
spec:<font></font>
  selfSigned: {}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in order to issue a certificate, it is necessary to describe the resource </font></font><code>Certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where it is indicated how to issue it (see the section </font></font><code>issuerRef</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">below) and where the private key (field </font></font><code>secretName</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is located. </font><font style="vertical-align: inherit;">After that, Ingress will need to refer to this key (see section </font></font><code>tls</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code>spec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Certificate<font></font>
metadata:<font></font>
  name: selfsigned-crt<font></font>
spec:<font></font>
  secretName: tls-secret<font></font>
  issuerRef:<font></font>
    kind: Issuer<font></font>
    name: selfsigned<font></font>
  commonName: "yet-another.website"<font></font>
  dnsNames:<font></font>
  - "yet-another.website"<font></font>
---<font></font>
apiVersion: networking.k8s.io/v1beta1<font></font>
kind: Ingress<font></font>
metadata:<font></font>
  name: app<font></font>
spec:<font></font>
  tls:<font></font>
  - hosts:<font></font>
    - "yet-another.website"<font></font>
    secretName: tls-secret<font></font>
  rules:<font></font>
  - host: "yet-another.website"<font></font>
    http:<font></font>
      paths:<font></font>
      - path: /<font></font>
        backend:<font></font>
          serviceName: app<font></font>
          servicePort: 8080</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few seconds after adding these resources to the cluster, the certificate will be issued. </font><font style="vertical-align: inherit;">You can see the corresponding report in the output of the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">kubectl -n app describe  certificate selfsigned-crt<font></font>
...<font></font>
  Normal  GeneratedKey  5s    cert-manager  Generated a new private key<font></font>
  Normal  Requested     5s    cert-manager  Created new CertificateRequest resource "selfsigned-crt-4198958557"<font></font>
  Normal  Issued        5s    cert-manager  Certificate issued successfully</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look at the secret resource itself, then it contains:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private key </font></font><code>tls.key</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root certificate </font></font><code>ca.crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our self-signed certificate </font></font><code>tls.crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The contents of these files can be seen using the utility </font></font><code>openssl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for example, like this:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app get secret tls-secret -ojson | jq -r <span class="hljs-string">'.data."tls.crt"'</span> | base64 -d | openssl x509 -dates -noout -issuer<font></font>
notBefore=Feb 10 21:01:59 2020 GMT<font></font>
notAfter=May 10 21:01:59 2020 GMT<font></font>
issuer=O = cert-manager, CN = yet-another.website</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that in the general case, the certificate issued using this </font><b><font style="vertical-align: inherit;">will not be trusted by the</font></b></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> connected clients </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The reason is simple: it does not have a CA </font><i><font style="vertical-align: inherit;">(see the </font></i><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">note on the project website</font></a></i><i><font style="vertical-align: inherit;"> )</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To avoid this, you need to specify in the </font><font style="vertical-align: inherit;">path to the secret file where it is contained </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This can be a corporate CA organization - to sign the certificates issued for Ingress with a key that is already used for the needs of other server services / information systems.</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><code>Certificate</code><font style="vertical-align: inherit;"></font><code>ca.crt</code><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 2. </font><font style="vertical-align: inherit;">Let's Encrypt Certificate with HTTP Validation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To issue LE certificates, as mentioned earlier, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two types of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> domain ownership </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">confirmation</font></a><font style="vertical-align: inherit;"> are available </font><font style="vertical-align: inherit;">: HTTP-01 and DNS-01. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first approach (HTTP-01) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://cert-manager.io/docs/configuration/acme/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to launch a small web server with a separate deployment, which will send to the Internet via the link </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;YOUR_DOMAIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; /. Well-known / acme-challenge / &lt;TOKEN&gt; some data requested from the certification server. </font><font style="vertical-align: inherit;">Therefore, this method implies the availability of Ingress from outside on port 80 and the resolution of the DNS record of the domain into public IP addresses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second option to verify the issued certificate (DNS-01) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comes from</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from having an API to the DNS server hosting the domain records. Issuer, using the indicated tokens, creates TXT records on the domain, which the ACME server then receives during confirmation. Among the officially supported DNS providers are CloudFlare, AWS Route53, Google CloudDNS and others, including its own implementation ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acme-dns</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Let's Encrypt has fairly </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strict limits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on requests to ACME servers. In order not to get into a long ban, it is recommended to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">letsencrypt-staging</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> certificate type for debugging </font><font style="vertical-align: inherit;">(the difference is only in the ACME server). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we describe the resources:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Issuer<font></font>
metadata:<font></font>
  name: letsencrypt<font></font>
spec:<font></font>
  acme:<font></font>
    server: https://acme-staging-v02.api.letsencrypt.org/directory <font></font>
    privateKeySecretRef:<font></font>
      name: letsencrypt<font></font>
    solvers:<font></font>
    - http01:<font></font>
       ingress:<font></font>
         class: nginx<font></font>
---<font></font>
apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Certificate<font></font>
metadata:<font></font>
  name: le-crt<font></font>
spec:<font></font>
  secretName: tls-secret<font></font>
  issuerRef:<font></font>
    kind: Issuer<font></font>
    name: letsencrypt<font></font>
  commonName: yet-another.website<font></font>
  dnsNames:<font></font>
  - yet-another.website</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that the </font><font style="vertical-align: inherit;">address of the </font><b><font style="vertical-align: inherit;">staging</font></b><font style="vertical-align: inherit;"> server </font><font style="vertical-align: inherit;">is specified </font><font style="vertical-align: inherit;">as </font></font><code>server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>acme</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(c </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Replace it with a battle will be possible later. </font><font style="vertical-align: inherit;">
Applying this configuration, we trace the entire order path:</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creation </font></font><code>Certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spawned a new resource </font></font><code>CertificateRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe certificate le-crt<font></font>
...<font></font>
Created new CertificateRequest resource <span class="hljs-string">"le-crt-1127528680"</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In his description - a mark on the creation </font></font><code>Order</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe certificaterequests le-crt-1127528680<font></font>
…<font></font>
Created Order resource app/le-crt-1127528680-1805948596</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It </font></font><code>Order</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describes with what parameters the test passes and what its current status is. </font><font style="vertical-align: inherit;">Such verification is carried out by the resource </font></font><code>Challenge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe order le-crt-1127528680-1805948596<font></font>
…<font></font>
Created Challenge resource <span class="hljs-string">"le-crt-1127528680-1805948596-1231544594"</span> <span class="hljs-keyword">for</span> domain <span class="hljs-string">"yet-another.website"</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finally, the details of this resource contain information about the status of the scan itself:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe challenges le-crt-1127528680-1805948596-1231544594<font></font>
...<font></font>
  Reason:      Successfully authorized domain                                                                                                                                                                      <font></font>
...<font></font>
  Normal  Started         2m45s  cert-manager  Challenge scheduled <span class="hljs-keyword">for</span> processing<font></font>
  Normal  Presented       2m45s  cert-manager  Presented challenge using http-01 challenge mechanism<font></font>
  Normal  DomainVerified  2m22s  cert-manager  Domain <span class="hljs-string">"yet-another.website"</span> verified with <span class="hljs-string">"http-01"</span> validation</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If all the conditions have been met (i.e. the domain is accessible from the outside, there is no ban from the LE ...) - in less than a minute, the certificate will be issued. </font><font style="vertical-align: inherit;">If successful, a </font></font><code>describe certificate le-crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">record will appear </font><font style="vertical-align: inherit;">in the output </font></font><code>Certificate issued successfully</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can safely change the server address to combat ( </font></font><code>https://acme-v02.api.letsencrypt.org/directory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and re-order the real certificates already signed not </font></font><code>Fake LE Intermediate X1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but </font></font><code>Let's Encrypt Authority X3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you first need to delete the resource </font></font><code>Certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: otherwise, no order procedures are activated, because the certificate already exists and it is relevant. </font><font style="vertical-align: inherit;">Removing a secret will lead to its immediate return with a message to </font></font><code>describe certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">  Normal  PrivateKeyLost  44s                   cert-manager  Lost private key for CertificateRequest "le-crt-613810377", deleting old resource</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to apply the “combat” manifesto for </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the one already described above </font></font><code>Certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(it has not changed):</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Issuer<font></font>
metadata:<font></font>
  name: letsencrypt<font></font>
spec:<font></font>
  acme:<font></font>
    server: https://acme-v02.api.letsencrypt.org/directory<font></font>
    privateKeySecretRef:<font></font>
      name: letsencrypt<font></font>
    solvers:<font></font>
    - http01:<font></font>
       ingress:<font></font>
         class: nginx</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After receiving the message </font></font><code>Certificate issued successfully</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>describe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check it:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app get secret tls-secret -ojson | jq -r <span class="hljs-string">'.data."tls.crt"'</span> | base64 -d | openssl x509 -dates -noout -issuer<font></font>
notBefore=Feb 10 21:11:48 2020 GMT<font></font>
notAfter=May 10 21:11:48 2020 GMT<font></font>
issuer=C = US, O = Let<span class="hljs-string">'s Encrypt, CN = Let'</span>s Encrypt Authority X3</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number 3. </font><font style="vertical-align: inherit;">Wildcard LE with DNS validation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will complicate the task by writing out a certificate immediately to all subdomains of the site and using this time the DNS check (via CloudFlare). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, get the token in the CloudFlare control panel for working through the API:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Profile → API Tokens → Create Token.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Set permissions as follows:</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permissions:</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zone - DNS - Edit</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zone - Zone - Read</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zone Resources:</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Include - All Zones</font></font></li>
</ul></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy the token received after saving (for example:) </font></font><code>y_JNkgQwkroIsflbbYqYmBooyspN6BskXZpsiH4M</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a Secret in which this token will be stored, and refer to it in Issuer:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: Secret<font></font>
metadata:<font></font>
  name: cloudflare-api-token<font></font>
type: Opaque<font></font>
stringData:<font></font>
  api-token: y_JNkgQwkroIsflbbYqYmBooyspN6BskXZpsiH4M<font></font>
---<font></font>
apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Issuer<font></font>
metadata:<font></font>
  name: letsencrypt<font></font>
spec:<font></font>
  acme:<font></font>
    server: https://acme-v02.api.letsencrypt.org/directory <font></font>
    privateKeySecretRef:<font></font>
      name: letsencrypt<font></font>
    solvers:<font></font>
    - dns01:<font></font>
        cloudflare:<font></font>
          email: my-cloudflare-acc@example.com<font></font>
          apiTokenSecretRef:<font></font>
            name: cloudflare-api-token<font></font>
            key: api-token<font></font>
<font></font>
---<font></font>
apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Certificate<font></font>
metadata:<font></font>
  name: le-crt<font></font>
spec:<font></font>
  secretName: tls-secret<font></font>
  issuerRef:<font></font>
    kind: Issuer<font></font>
    name: letsencrypt<font></font>
  commonName: yet-another.website<font></font>
  dnsNames:<font></font>
  - "yet-another.website"<font></font>
  - "*.yet-another.website"</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Do not forget to use staging if you are experimenting!)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let’s go through the process of confirming domain ownership:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe challenges.acme.cert-manager.io le-crt-613810377-1285319347-3806582233<font></font>
...<font></font>
Status:<font></font>
  Presented:   <span class="hljs-literal">true</span>
  Processing:  <span class="hljs-literal">true</span>
  Reason:      Waiting <span class="hljs-keyword">for</span> dns-01 challenge propagation: DNS record <span class="hljs-keyword">for</span> <span class="hljs-string">"yet-another.website"</span> not yet propagated<font></font>
  State:       pending<font></font>
Events:<font></font>
  Type    Reason     Age   From          Message<font></font>
  ----    ------     ----  ----          -------<font></font>
  Normal  Started    54s   cert-manager  Challenge scheduled <span class="hljs-keyword">for</span> processing<font></font>
  Normal  Presented  53s   cert-manager  Presented challenge using dns-01 challenge mechanism</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A TXT record will appear in the panel: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/hk/jc/pohkjc19ui1olxdlfeaiuuqm3ne.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and after a while the status will change to:</font></font><br>
<br>
<pre><code class="plaintext hljs">Domain "yet-another.website" verified with "dns-01" validation</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Make sure that the certificate is valid for any subdomain:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app get secret tls-secret -ojson | jq -r <span class="hljs-string">'.data."tls.crt"'</span> | base64 -d | openssl x509 -dates -noout -text |grep DNS:<font></font>
          DNS:*.yet-another.website, DNS:yet-another.website</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Validation by DNS, as a rule, does not happen quickly, since most DNS providers have a data update period that shows how much time elapses from the moment the DNS record is changed to the actual update of all the provider’s DNS servers. </font><font style="vertical-align: inherit;">However, the ACME standard also provides a combination of two verification options, which can be used to expedite the receipt of a certificate for the main domain. </font><font style="vertical-align: inherit;">In this case, the description </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be as follows:</font></font><br>
<br>
<pre><code class="1c hljs">apiVersion: cert-manager.io/v1alpha2<font></font>
kind: Issuer<font></font>
metadata:<font></font>
  name: letsencrypt<font></font>
spec:<font></font>
  acme:<font></font>
    server: https:<span class="hljs-comment">//acme-v02.api.letsencrypt.org/directory</span><font></font>
    privateKeySecretRef:<font></font>
      name: letsencrypt<font></font>
    solvers:<font></font>
    - selector:<font></font>
        dnsNames:<font></font>
        - <span class="hljs-string">"*.yet-another.website"</span><font></font>
      dns01:<font></font>
        cloudflare:<font></font>
          email: my-cloudflare-acc@example.com<font></font>
          apiTokenSecretRef:<font></font>
            name: cloudflare-api-token<font></font>
            key: api-token            <font></font>
    - selector:<font></font>
        dnsNames:<font></font>
        - <span class="hljs-string">"yet-another.website"</span><font></font>
      http01:<font></font>
        ingress:<font></font>
          class: nginx</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you apply this configuration, two resources will be created </font></font><code>Challenge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n app describe orders le-crt-613810377-1285319347<font></font>
…<font></font>
  Normal  Created  3m29s  cert-manager  Created Challenge resource <span class="hljs-string">"le-crt-613810377-1285319347-3996324737"</span> <span class="hljs-keyword">for</span> domain <span class="hljs-string">"yet-another.website"</span>                 
  Normal  Created  3m29s  cert-manager  Created Challenge resource <span class="hljs-string">"le-crt-613810377-1285319347-1443470517"</span> <span class="hljs-keyword">for</span> domain <span class="hljs-string">"yet-another.website"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number 4. </font><font style="vertical-align: inherit;">Using Ingress Special Annotations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the direct path to creating certificates in cert-manager, it is possible to use a component called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ingress-shim</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and not explicitly create resources </font></font><code>Certificate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The idea is that with the help of special Ingress annotations, the certificate will be automatically ordered using the one indicated in them </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The result is roughly the following Ingress resource:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: networking.k8s.io/v1beta1<font></font>
kind: Ingress<font></font>
metadata:<font></font>
  annotations:<font></font>
    cert-manager.io/cluster-issuer: letsencrypt<font></font>
spec:<font></font>
  tls:<font></font>
  - hosts:<font></font>
    - "yet-another.website"<font></font>
    secretName: tls-secret<font></font>
  rules:<font></font>
  - host: "yet-another.website"<font></font>
    http:<font></font>
      paths:<font></font>
      - path: /<font></font>
        backend:<font></font>
          serviceName: app<font></font>
          servicePort: 8080</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For correct operation, only the presence of Issuer is enough here, that is, creating one less entity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, there is an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obsolete</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annotation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kube-lego</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>kubernetes.io/tls-acme: "true"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, - which requires a </font></font><code>Issuer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">default </font><font style="vertical-align: inherit;">task </font><font style="vertical-align: inherit;">when installing cert-manager using Helm parameters (or in the manager container launch options). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We at the company do not use these options and cannot advise them due to the opacity of the approaches used to order SSL certificates (and at the same time to various </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">problems that arise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), but still decided to mention in the article for a more complete picture.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of a conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Through simple manipulations with CRD, we learned how to write auto-renewable, self-signed, and free SSL certificates from the Let's Encrypt project for domain sites launched as part of Ingresss in Kubernetes clusters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article provides examples of solving the most common problems in our practice. </font><font style="vertical-align: inherit;">However, the cert-manager functions are not limited to the features described above. </font><font style="vertical-align: inherit;">On the utility website you can find examples of working with other services - for example, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bundle with Vault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use of external issuing centers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (issuers).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An Introduction to Kubernetes Network Policies for Security Professionals</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes tips &amp; tricks: custom error page in the Ingress NGINX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Ingress  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496916/index.html">Teaching, Negotiating, and Consulting Remotely - Part 3: Yealink Meeting Server and 4 Special Offers</a></li>
<li><a href="../en496920/index.html">Making a smart home with ASP.NET Core and Arduino</a></li>
<li><a href="../en496922/index.html">Guide on reverse client-server apk on the example of the job NeoQUEST-2020</a></li>
<li><a href="../en496924/index.html">Web Component Routing</a></li>
<li><a href="../en496926/index.html">John Romero on Doom: 25 Years of Rip & Tear</a></li>
<li><a href="../en496938/index.html">Supercomputers, genome sequencing and the prospects of defeating the coronavirus</a></li>
<li><a href="../en496940/index.html">How GM engineers test electronics</a></li>
<li><a href="../en496942/index.html">Digital events in Moscow April 13-19</a></li>
<li><a href="../en496944/index.html">Digital events in St. Petersburg from April 13 to 19</a></li>
<li><a href="../en496946/index.html">Once again about GPG hardware keys for a penny</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>