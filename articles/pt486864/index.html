<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìí ü•ï üå∑ Migrando do OpenVPN para o WireGuard para ingressar em redes em uma rede L2 üì∂ üîá ü§üüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eu gostaria de compartilhar a experi√™ncia de combinar redes em tr√™s apartamentos geograficamente remotos, em cada um dos quais roteadores com o OpenWR...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Migrando do OpenVPN para o WireGuard para ingressar em redes em uma rede L2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu gostaria de compartilhar a experi√™ncia de combinar redes em tr√™s apartamentos geograficamente remotos, em cada um dos quais roteadores com o OpenWRT s√£o usados ‚Äã‚Äãcomo gateway para uma rede comum. </font><font style="vertical-align: inherit;">Ao escolher um m√©todo para combinar redes entre L3 com sub-redes de roteamento e L2 com bridging, quando todos os n√≥s da rede estar√£o na mesma sub-rede, o segundo m√©todo foi preferido, mais dif√≠cil de configurar, mas oferecendo mais oportunidades, pois a rede foi planejada para usar tecnologias transparentes Wake-on-Lan e DLNA.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: Antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O OpenVPN foi originalmente escolhido como o protocolo para implementar esta tarefa, porque, em primeiro lugar, ele pode criar um dispositivo de toque que pode ser facilmente adicionado √† ponte e, em segundo lugar, o OpenVPN suporta a opera√ß√£o do protocolo TCP, o que tamb√©m foi importante, porque nenhum dos apartamentos tinha um endere√ßo IP dedicado e eu n√£o pude usar o STUN, porque, por algum motivo, meu provedor bloqueia as conex√µes de entrada via UDP de suas redes, enquanto o TCP me permitiu encaminhar a porta do servidor VPN para VPS alugado usando SSH. Sim, essa abordagem gera uma grande carga, porque os dados s√£o criptografados duas vezes, mas eu n√£o queria inserir o VPS na minha rede privada, pois havia o risco de terceiros ganharem controle sobre eles, portanto,ter esse dispositivo na rede dom√©stica era extremamente indesej√°vel e foi decidido pagar pela seguran√ßa com uma grande sobrecarga.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para encaminhar a porta no roteador no qual foi planejado implantar o servidor, o programa sshtunnel foi usado. N√£o descreverei os meandros de sua configura√ß√£o - isso √© feito com bastante facilidade, apenas observei que sua tarefa era encaminhar a porta TCP 1194 do roteador para o VPS. Em seguida, o servidor OpenVPN foi configurado no dispositivo tap0, que acabou na ponte br-lan. Depois de verificar a conex√£o com o servidor que voc√™ acabou de criar a partir do laptop, ficou claro que a id√©ia de encaminhamento de porta valeu a pena e meu laptop se tornou membro da rede do roteador, embora eu n√£o estivesse l√° fisicamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O assunto permaneceu pequeno: era necess√°rio distribuir endere√ßos IP em apartamentos diferentes para que eles n√£o entrassem em conflito e configurassem roteadores como clientes OpenVPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os seguintes endere√ßos IP do roteador e intervalos de servidores DHCP foram selecionados:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com uma gama de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o servidor</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um intervalo de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o roteador no apartamento n ¬∞ 2</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um intervalo de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o roteador no apartamento n ¬∞ 3</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m foi necess√°rio atribuir esses endere√ßos aos roteadores clientes do servidor OpenVPN adicionando as seguintes linhas √† sua configura√ß√£o:</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e adicionando as seguintes linhas ao arquivo /etc/openvpn/ipp.txt:</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
em que flat1_id e flat2_id s√£o os nomes de dispositivos especificados ao criar certificados para conectar-se ao OpenVPN</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, os clientes OpenVPN foram configurados nos roteadores, os dispositivos tap0 nos dois foram adicionados √† ponte br-lan. Nesta fase, parecia que tudo estava em ordem, pois as tr√™s redes se veem e funcionam como um todo. No entanto, acabou sendo um detalhe n√£o muito agrad√°vel: √†s vezes, os dispositivos n√£o conseguiam obter um endere√ßo IP do roteador, com todas as conseq√º√™ncias resultantes. Por algum motivo, o roteador em alguns apartamentos n√£o teve tempo de responder a tempo a DHCPDISCOVER e o dispositivo n√£o recebeu seu endere√ßo. Percebi que preciso filtrar essas solicita√ß√µes no tap0 em cada um dos roteadores, mas, como se viu, o iptables n√£o pode funcionar com o dispositivo se ele faz parte da ponte e o ebtables deve me ajudar. Infelizmente, n√£o estava no meu firmware e tive que reconstruir as imagens para cada dispositivo.Depois de fazer isso e adicionar essas linhas ao /etc/rc.local de cada roteador, o problema foi resolvido:</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa configura√ß√£o durou tr√™s anos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: Apresentando o WireGuard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente, a Internet come√ßou a falar cada vez mais sobre o WireGuard, admirando a simplicidade de sua configura√ß√£o, alta velocidade de transmiss√£o, baixo ping e seguran√ßa compar√°vel. A busca por informa√ß√µes adicionais sobre ele deixou claro que eles n√£o apoiavam o trabalho como membro da ponte ou o protocolo TCP, o que me fez pensar que ainda n√£o havia alternativas ao OpenVPN para mim. Ent√£o adiei a conhecer o WireGuard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns dias atr√°s, sobre os recursos, de uma maneira ou de outra conectados √† TI, surgiram as not√≠cias de que o WireGuard finalmente ser√° inclu√≠do no kernel do Linux, come√ßando na vers√£o 5.6. Os artigos de not√≠cias, como sempre, elogiaram o WireGuard. Novamente, mergulhei na busca de maneiras de substituir o bom e velho OpenVPN. Desta vez, encontrei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ele falou sobre a constru√ß√£o de um t√∫nel Ethernet sobre L3 usando GRE. Este artigo me deu esperan√ßa. Ainda n√£o est√° claro o que fazer com o protocolo UDP. A pesquisa me levou a artigos sobre o uso do socat em conjunto com um t√∫nel SSH para encaminhar uma porta UDP, no entanto, eles observaram que essa abordagem funciona apenas no modo de conex√£o √∫nica, ou seja, o trabalho de v√°rios clientes VPN seria imposs√≠vel. Tive a ideia de criar um servidor VPN no VPS e configurar o GRE para clientes, mas, como se viu, o GRE n√£o suporta criptografia, o que levar√° ao fato de que, no caso de acesso ao servidor por terceiros, todo o tr√°fego entre minhas redes est√° nas m√£os deles. isso n√£o me serviu em princ√≠pio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Novamente, a decis√£o foi tomada em favor da criptografia excessiva, usando uma VPN em uma VPN, de acordo com o seguinte esquema:</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN de primeiro n√≠vel: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um endere√ßo interno 192.168.30.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um cliente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS com um endere√ßo interno 192.168.30.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um cliente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS com um endere√ßo interno 192.168.30.3 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">cliente</font></i><font style="vertical-align: inherit;"> VPS </font><font style="vertical-align: inherit;">com um endere√ßo interno 192.168.30.3 </font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;"> √© </font><i><font style="vertical-align: inherit;">um </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN de segundo n√≠vel: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um endere√ßo externo 192.168.30.2 e um 192.168.31.1 interno </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um cliente </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um endere√ßo 192.168.30.2 e tem um IP interno 192.168.31.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um cliente </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com o endere√ßo 192.168.30.2 e tem um IP interno 192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - roteador-servidor no apartamento 1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - roteador no apartamento 2, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - roteador no apartamento </font><font style="vertical-align: inherit;">2, </font><b><font style="vertical-align: inherit;">MK3</font></b><font style="vertical-align: inherit;"> - roteador no apartamento 3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* As configura√ß√µes do dispositivo s√£o publicadas no spoiler no final do artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, pings entre os n√≥s da rede 192.168.31.0/24, √© hora de seguir para a configura√ß√£o do t√∫nel GRE. Antes disso, para n√£o perder o acesso aos roteadores, vale a pena configurar t√∫neis SSH para encaminhar 22 portas no VPS, para que, por exemplo, o roteador do apartamento 2 esteja dispon√≠vel na porta 10022nd VPS e na 11122th porta o VPS esteja dispon√≠vel o roteador √© do apartamento 3. √â melhor configurar o encaminhamento com o mesmo sshtunnel, pois restaurar√° o t√∫nel se cair.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O t√∫nel est√° configurado, voc√™ pode se conectar ao SSH atrav√©s da porta encaminhada:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, desative o OpenVPN:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora configure o t√∫nel GRE no roteador do apartamento 2:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E adicione a interface criada √† ponte:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos executar um procedimento semelhante no roteador-servidor:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, tamb√©m, adicione a interface criada √† ponte:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a partir deste momento, os pings come√ßam a ir com sucesso para a nova rede e eu, com satisfa√ß√£o, vou tomar caf√©. </font><font style="vertical-align: inherit;">Em seguida, para avaliar como a rede funciona na outra extremidade do fio, tento conectar-me via SSH a um dos computadores do apartamento 2, mas o cliente ssh congela sem solicitar uma senha. </font><font style="vertical-align: inherit;">Tento conectar-me a este computador via telnet na porta 22 e vejo uma linha na qual se entende que a conex√£o est√° sendo estabelecida, o servidor SSH est√° respondendo, apenas por algum motivo n√£o me permite efetuar login.</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tento conectar a ele via VNC e vejo uma tela preta. Garanto a mim mesmo que √© um computador remoto, porque posso me conectar facilmente ao roteador deste apartamento no endere√ßo interno. No entanto, decido conectar-me ao SSH deste computador atrav√©s de um roteador e fico surpreso ao descobrir que a conex√£o foi bem-sucedida e o computador remoto est√° funcionando corretamente, mas tamb√©m n√£o pode se conectar ao meu computador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu removo o dispositivo grelan0 da ponte e executo o OpenVPN no roteador no apartamento 2 e verifique se a rede funciona novamente conforme o esperado e as conex√µes n√£o quebram. Quando procuro, encontro f√≥runs onde as pessoas reclamam dos mesmos problemas e s√£o aconselhadas a aumentar o MTU. No entanto, n√£o foi poss√≠vel aumentar o MTU para a VPN de primeiro n√≠vel (wg0): com MTUs acima de 1420, definidas automaticamente, as quebras s√£o iniciadas, mas, ao mesmo tempo, o segundo n√≠vel de VPN wg1 que trabalha em cima de wg0 funcionou corretamente com o MTU 1600. Isso √© suficiente para instalar O MTU √© 1500 para o dispositivo Gretap, para que essa interface tenha o mesmo valor de MTU que a ponte br-lan na qual o Gretap foi planejado para ser adicionado. Pelo que entendi, a ponte define o MTU igual ao menor dos valores dispon√≠veis em todos os dispositivos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fiz uma configura√ß√£o semelhante no roteador do Apartamento 3, com a √∫nica diferen√ßa: no roteador, o servidor adicionou uma segunda interface gretap chamada grelan1, que tamb√©m foi adicionada √† ponte br-lan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo est√° funcionando. </font><font style="vertical-align: inherit;">Agora voc√™ pode colocar o conjunto do Gretap na inicializa√ß√£o. </font><font style="vertical-align: inherit;">Para fazer isso: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Coloque estas linhas em /etc/rc.local no roteador no apartamento 2:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso foi adicionado ao /etc/rc.local no roteador no apartamento 3:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E no roteador do servidor:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s reiniciar os roteadores clientes, descobri que, por algum motivo, eles n√£o se conectavam ao servidor. </font><font style="vertical-align: inherit;">Ap√≥s conectar-se ao SSH (felizmente, eu pr√©-configurei o sshtunnel para isso), descobriu-se que o WireGuard estava criando uma rota para o endpoint por algum motivo, mas estava incorreto. </font><font style="vertical-align: inherit;">Portanto, para 192.168.30.2, a tabela de rotas indicava a rota atrav√©s da interface pppoe-wan, ou seja, via Internet, embora a rota para ela devesse ter sido roteada atrav√©s da interface wg0. </font><font style="vertical-align: inherit;">Depois de excluir esta rota, a conex√£o foi restaurada. </font><font style="vertical-align: inherit;">N√£o encontrei instru√ß√µes em algum lugar sobre como fazer o WireGuard n√£o criar essas rotas. </font><font style="vertical-align: inherit;">Al√©m disso, eu nem entendi, um recurso √© o OpenWRT ou o pr√≥prio WireGuard. </font><font style="vertical-align: inherit;">N√£o tendo que lidar com esse problema por um longo tempo, simplesmente adicionei uma linha a esse roteador no script repetido por um timer para excluir esta rota:</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumir</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainda n√£o consegui uma rejei√ß√£o completa do OpenVPN, j√° que √†s vezes preciso me conectar a uma nova rede a partir de um laptop ou telefone, e a configura√ß√£o de um dispositivo Gretap neles geralmente √© imposs√≠vel, mas, apesar disso, tenho uma vantagem na velocidade de transfer√™ncia de dados entre apartamentos e, por exemplo, o uso do VNC agora n√£o causa transtornos. </font><font style="vertical-align: inherit;">O ping diminuiu um pouco, mas ficou mais est√°vel: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ao usar o OpenVPN:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar o WireGuard:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â mais afetado pelo alto ping antes do VPS, que √© de aproximadamente 61,5 ms </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
, mas a velocidade aumentou significativamente. </font><font style="vertical-align: inherit;">Assim, em um apartamento com um roteador-servidor, eu tenho uma velocidade de conex√£o √† Internet de 30 Mbit / s, e em outros apartamentos - 5 Mbit / s. </font><font style="vertical-align: inherit;">Ao mesmo tempo, enquanto usava o OpenVPN, n√£o consegui obter uma taxa de transfer√™ncia de dados entre redes de mais de 3,8 Mb / s, de acordo com o iperf, enquanto o WireGuard o "bombeava" para os mesmos 5 Mb / s.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do WireGuard no VPS</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do WireGuard no MS (adicionada a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do WireGuard no MK2 (adicionada a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do WireGuard no MK3 (adicionada a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas configura√ß√µes descritas para a VPN de segundo n√≠vel, eu especifico a porta 51821 para os clientes WireGuard.Em princ√≠pio, isso n√£o √© necess√°rio, pois o cliente estabelecer√° uma conex√£o a partir de qualquer porta livre e sem privil√©gios, mas fiz isso para poder bloquear todas as conex√µes de entrada nas interfaces wg0 de todos os roteadores, exceto conex√µes UDP de entrada √† porta 51821. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este artigo seja √∫til para algu√©m. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Al√©m disso, quero compartilhar meu script que me envia uma notifica√ß√£o PUSH no telefone para o aplicativo WirePusher quando um novo dispositivo aparece na minha rede. </font><font style="vertical-align: inherit;">Aqui est√° o link para o script: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATUALIZA√á√ÉO:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configurando servidor e clientes OpenVPN</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para gerar certificados usados ‚Äã‚Äãeasy-rsa</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486844/index.html">A evolu√ß√£o do processamento de webhook no Facebook: de zero a 25.000 por segundo</a></li>
<li><a href="../pt486850/index.html">Novo assento reservado - como um hotel c√°psula</a></li>
<li><a href="../pt486858/index.html">Criando um Viberbot completo. Parte dois - primeiro contato ou "conversion_started"</a></li>
<li><a href="../pt486860/index.html">ATX12VO - Comer uma nova maneira</a></li>
<li><a href="../pt486862/index.html">5 raz√µes pelas quais o design de movimento ajuda voc√™ a se conectar com as pessoas</a></li>
<li><a href="../pt486866/index.html">Fuete S√≠ncrono: Motores Biol√≥gicos em Nanotecnologia</a></li>
<li><a href="../pt486868/index.html">Por que e para quem fazemos Slime Agile</a></li>
<li><a href="../pt486870/index.html">Como tiramos a fraude da cabana</a></li>
<li><a href="../pt486872/index.html">Linux Configura√ß√£o do teclado</a></li>
<li><a href="../pt486874/index.html">Coronav√≠rus 2019-nCoV: baixa mortalidade, alta mortalidade</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>