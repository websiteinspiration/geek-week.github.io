<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👏🏽 🧒 🏳️ TelegramBot。基本的な機能。別々に飛ぶ、別々にカツレツ。（パート2） 👦🏻 🏩 💗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="電報でボットの基本的な機能を開発し続けています。前のパートでは、メッセージの受信、処理、送信に関するボットの作業を分割する必要がある点について説明しました。基本的なJava Coreツールを使用して、ボットをマルチスレッド化および非同期化してみましょう。処理に時間がかかるタスクを考えます。電報のコマ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>TelegramBot。基本的な機能。別々に飛ぶ、別々にカツレツ。（パート2）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481354/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報でボットの基本的な機能を開発し続けています。前のパートでは、メッセージの受信、処理、送信に関するボットの作業を分割する必要がある点について説明しました。基本的なJava Coreツールを使用して、ボットをマルチスレッド化および非同期化してみましょう。処理に時間がかかるタスクを考えます。電報のコマンドがどのように機能し、どのように処理される必要があるかを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ボット</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の基本的な機能を作成するための</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Java </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">TelegramBot命令でのテレグラム</font></a><font style="vertical-align: inherit;">用のボットボットのプログラミングに関する記事の最初の部分の続きです</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。 （パート1）</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
さらに興味がある人、ようこそ、猫の下で…</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この部分では、多くのすべてが一度に追加され、ボットがマルチスレッドを実行できるようにするすべての機能と、なぜそれが必要なのかを静かに分析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつもと同じように、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事の既製のコードはすべて</font><font style="vertical-align: inherit;">、gitリポジトリの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part2-Handlers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブランチ</font><font style="vertical-align: inherit;">にあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは完全に機能し、傾斜し、ボットの承認のためのデータ（名前とトークン）を変更し、App.classクラスでmainメソッドを実行するだけで十分です。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このクラスは、ボットが開始したときに、ボットが開始したことをボット管理者に通知することに注意してください。</font><font style="vertical-align: inherit;">ボット管理者IDもApp.classクラスで指定されており、変更しない場合、ボットは私にメッセージを送信しようとします:)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ポイントについては、最初の部分のリリース後に発生した変更を分析します。 </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、テレグラムボットと通信するためのシステムにおけるチームの一般的な概念について説明します。</font><font style="vertical-align: inherit;">ボットの設定に応じて、任意の形式のメッセージまたは特別に設計されたコマンドのみを表示できます。</font><font style="vertical-align: inherit;">違いは何ですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのメッセージオプションはどこにありますか？</font></font><br>
<br>
<ol>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレーンテキスト、通常のメッセージ。</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この形式では、ボットはPMでボットにメッセージを書き込むとメッセージを受信します。</font><font style="vertical-align: inherit;">それでも、ボットの設定</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でグループのプライバシーモード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がオフになっている場合、ボットはすべてのメッセージを完全に表示し始めます。</font><font style="vertical-align: inherit;">この設定が有効になっている場合、グループに追加されると、ボットは自分宛てのコマンドのみを認識します。</font><font style="vertical-align: inherit;">それらがどのように見えるか-2番目の段落を参照</font></font></li>
<li> <b>  </b><br>
      : <b>/</b><br>
   .      . :<br>
<b>/start</b><br>
          .            . <br>
<img src="https://habrastorage.org/webt/ol/pi/ud/olpiudptbqgig5zhoqzpnpjquyq.png"><br>
 ,      ,         .       @BotFather. <br>
<br>
  <b>/myBots</b>       «Edit Bot»<br>
   ,                      . <br>
<br>
<img src="https://habrastorage.org/webt/u6/7o/cl/u67oclalxrv7v3v83h1wzp91gr4.png"><br>
<br>
     :<br>
<br>
<img src="https://habrastorage.org/webt/-a/4x/i-/-a4xi-kqpuxjoielhmog7oh1tom.png"><br>
<br>
         —        :<br>
<br>
<img src="https://habrastorage.org/webt/hn/yi/wa/hnyiwabkhmbrc7zn0rbuzkfvook.png"><br>
<br>
    .             (    ,   start  help     ),        ,       .       :<br>
<b>/start@test_habr_bot </b><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、これらすべてのニュアンスを知っているので、スラッシュで始まるコマンドを理解し、コマンドがボット専用か他のボット専用かを区別する方法を理解するような処理オプションを作成しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドの処理を担当するクラスを含むパッケージを作成します。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージcom.example.telegrambot.command</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Commandクラスでは、ボットが理解できるすべてのコマンドをリストします。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Command {<font></font>
    NONE, NOTFORME,<font></font>
<font></font>
    NOTIFY,<font></font>
    START, HELP, ID<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前に見たように、ボットは4つのコマンドを理解できるはずであると@BotFatherで指摘しました。</font><font style="vertical-align: inherit;">これらは標準的なスタートであり、助けになります。</font><font style="vertical-align: inherit;">便利なIDを1つ追加します。</font><font style="vertical-align: inherit;">そしてもう1つ、通知します。これについては後で少し話します。</font><font style="vertical-align: inherit;">そして、2つのチームNONEとNOTFORMEは、テキストメッセージがコマンドではないか、このコマンドがボット用ではないことを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のヘルパークラス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ParsedCommandを追加する</font></font></a><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Getter;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Setter;<font></font>
<font></font>
<span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParsedCommand</span> </span>{<font></font>
    Command command = Command.NONE;<font></font>
    String text=<span class="hljs-string">""</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その主な目的は、テキストを解析した結果をこのクラスのオブジェクトに格納することです。</font><font style="vertical-align: inherit;">チーム自体と、チームの後に続くすべてのテキストのみが含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、チームを解析する別のクラスを作成します。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">パーサー</font></a><font style="vertical-align: inherit;">クラス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a> <br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> javafx.util.Pair;
<span class="hljs-keyword">import</span> org.apache.log4j.Logger;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parser</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = Logger.getLogger(Parser.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String PREFIX_FOR_COMMAND = "/";
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String DELIMITER_COMMAND_BOTNAME = "@";
    <span class="hljs-keyword">private</span> String botName;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Parser</span><span class="hljs-params">(String botName)</span> </span>{
        <span class="hljs-keyword">this</span>.botName = botName;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ParsedCommand <span class="hljs-title">getParsedCommand</span><span class="hljs-params">(String text)</span> </span>{<font></font>
      String trimText = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">if</span> (text != <span class="hljs-keyword">null</span>) trimText = text.trim();<font></font>
        ParsedCommand result = <span class="hljs-keyword">new</span> ParsedCommand(Command.NONE, trimText);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">""</span>.equals(trimText)) <span class="hljs-keyword">return</span> result;<font></font>
        Pair&lt;String, String&gt; commandAndText = getDelimitedCommandFromText(trimText);<font></font>
        <span class="hljs-keyword">if</span> (isCommand(commandAndText.getKey())) {
            <span class="hljs-keyword">if</span> (isCommandForMe(commandAndText.getKey())) {<font></font>
                String commandForParse = cutCommandFromFullText(commandAndText.getKey());<font></font>
                Command commandFromText = getCommandFromText(commandForParse);<font></font>
                result.setText(commandAndText.getValue());<font></font>
                result.setCommand(commandFromText);<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                result.setCommand(Command.NOTFORME);<font></font>
                result.setText(commandAndText.getValue());<font></font>
            }<font></font>
<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">cutCommandFromFullText</span><span class="hljs-params">(String text)</span> </span>{
        <span class="hljs-keyword">return</span> text.contains(DELIMITER_COMMAND_BOTNAME) ?<font></font>
                text.substring(<span class="hljs-number">1</span>, text.indexOf(DELIMITER_COMMAND_BOTNAME)) :<font></font>
                text.substring(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Command <span class="hljs-title">getCommandFromText</span><span class="hljs-params">(String text)</span> </span>{<font></font>
        String upperCaseText = text.toUpperCase().trim();<font></font>
        Command command = Command.NONE;<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            command = Command.valueOf(upperCaseText);<font></font>
        } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {<font></font>
            log.debug(<span class="hljs-string">"Can't parse command: "</span> + text);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> command;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Pair&lt;String, String&gt; <span class="hljs-title">getDelimitedCommandFromText</span><span class="hljs-params">(String trimText)</span> </span>{<font></font>
        Pair&lt;String, String&gt; commandText;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (trimText.contains(<span class="hljs-string">" "</span>)) {
            <span class="hljs-keyword">int</span> indexOfSpace = trimText.indexOf(<span class="hljs-string">" "</span>);<font></font>
            commandText = <span class="hljs-keyword">new</span> Pair&lt;&gt;(trimText.substring(<span class="hljs-number">0</span>, indexOfSpace), trimText.substring(indexOfSpace + <span class="hljs-number">1</span>));<font></font>
        } <span class="hljs-keyword">else</span> commandText = <span class="hljs-keyword">new</span> Pair&lt;&gt;(trimText, <span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> commandText;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCommandForMe</span><span class="hljs-params">(String command)</span> </span>{
        <span class="hljs-keyword">if</span> (command.contains(DELIMITER_COMMAND_BOTNAME)) {<font></font>
            String botNameForEqual = command.substring(command.indexOf(DELIMITER_COMMAND_BOTNAME) + <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> botName.equals(botNameForEqual);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCommand</span><span class="hljs-params">(String text)</span> </span>{
        <span class="hljs-keyword">return</span> text.startsWith(PREFIX_FOR_COMMAND);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要するに。</font><font style="vertical-align: inherit;">パーサーを初期化するとき、パーサーがそのコマンドを見知らぬ人から区別できるように、コンストラクターでボットの名前を渡す必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、私たちはただパブリックメソッドを呼び出します</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> ParsedCommand <span class="hljs-title">getParsedCommand</span><span class="hljs-params">(String text)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
引数でメッセージテキストを渡し、コマンドの後に来るメッセージとメッセージテキストを返送しなければなりません。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">テストクラス</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
でパーサーがどのように機能するかを確認できます</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別々に飛ぶ、別々にカツレツ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、メッセージを受信し、処理して応答を送信するようにボットに教える必要があります。</font><font style="vertical-align: inherit;">一連の試行錯誤の末、私はこのアプリケーションのロジックにたどり着きました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインクラス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はアプリケーションのメインスレッドで動作し、受信したすべてのメッセージが特別なキューに入れられ、ユーザーに応答して送信する予定のメッセージのコンテナーにもなるという事実でのみビジーになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクラスの変更はごくわずかです。</font><font style="vertical-align: inherit;">2つのキューを追加しました。</font></font><br>
<br>
<pre><code class="java hljs">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Queue&lt;Object&gt; sendQueue = <span class="hljs-keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Queue&lt;Object&gt; receiveQueue = <span class="hljs-keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数コード</font><b><font style="vertical-align: inherit;">public void onUpdateReceived（Update update）を</font></b><font style="vertical-align: inherit;">少し書き直しました</font></font><b><font style="vertical-align: inherit;"></font></b><br>
<br>
<pre><code class="java hljs">
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onUpdateReceived</span><span class="hljs-params">(Update update)</span> </span>{<font></font>
        log.debug(<span class="hljs-string">"Receive new Update. updateID: "</span> + update.getUpdateId());<font></font>
        receiveQueue.add(update);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何故ですか？もう一度私は別のオプションを試しました。また、マルチスレッドの主な問題は、共有データの操作です。そして、マルチスレッドキューの実装である</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConcurrentLinkedQueue &lt;&gt;（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がこれ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を</font><font style="vertical-align: inherit;">どのように処理するか、</font><font style="vertical-align: inherit;">そして、ご覧のとおり、両方のキューにオブジェクトデータ型を格納</font><font style="vertical-align: inherit;">する方法が最も気に入っ</font><font style="vertical-align: inherit;">ています。これは将来のブックマークです。したがって、受信するメッセージの種類には依存しません。着信キューでは、Updateタイプのオブジェクトだけでなく、必要な他のオブジェクトも追加できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信キューも同様です。さまざまなタイプのメッセージを送信でき、それらには共通の親がないため、共通のデータ型であるオブジェクトも使用します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この形式でボットを実行すると、ボットは機能しますが、何もしません。受信したすべてのメッセージをログに記録し、キューに入れます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、キューから受信したメッセージを受け取り、それらに対して何らかのアクションを実行して、</font><font style="vertical-align: inherit;">その結果を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendQueue</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューに入れる、何らかのスレッドが必要</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のパッケージを作成してみましょう：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とその中には2つのクラスしかありません：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageReciever-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受信したメッセージの</font><font style="vertical-align: inherit;">ハンドラー</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageSender-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーに送信する必要があるメッセージキューのハンドラー。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下でそれらの作業を検討しますが、ここでは、開始クラスの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">アプリでの</font></a><font style="vertical-align: inherit;">使用について説明します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボットが接続したら、ハンドラーを別々のスレッドで開始します。</font></font><br>
<br>
<pre><code class="java hljs">
        MessageReciever messageReciever = <span class="hljs-keyword">new</span> MessageReciever(test_habr_bot);<font></font>
        MessageSender messageSender = <span class="hljs-keyword">new</span> MessageSender(test_habr_bot);<font></font>
<font></font>
        test_habr_bot.botConnect();<font></font>
<font></font>
        Thread receiver = <span class="hljs-keyword">new</span> Thread(messageReciever);<font></font>
        receiver.setDaemon(<span class="hljs-keyword">true</span>);<font></font>
        receiver.setName(<span class="hljs-string">"MsgReciever"</span>);<font></font>
        receiver.setPriority(PRIORITY_FOR_RECEIVER);<font></font>
        receiver.start();<font></font>
<font></font>
        Thread sender = <span class="hljs-keyword">new</span> Thread(messageSender);<font></font>
        sender.setDaemon(<span class="hljs-keyword">true</span>);<font></font>
        sender.setName(<span class="hljs-string">"MsgSender"</span>);<font></font>
        sender.setPriority(PRIORITY_FOR_SENDER);<font></font>
        sender.start();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のスレッドで、デーモンモードを指定します。</font><font style="vertical-align: inherit;">これは、メインスレッドが実行されている限りスレッドが機能し、処理が停止するとすぐにスレッドが終了するために必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に着信メッセージハンドラを扱いたくありません</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。MessageSender</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスの操作を見てみましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼が何ができるか、何をするかを分析してみましょう。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当然、これはマルチスレッド化のためのインターフェースの継承です</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。Runnable</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を実装し、</font><b><font style="vertical-align: inherit;">run</font></b><font style="vertical-align: inherit;">関数を実装します。</font></font><b><font style="vertical-align: inherit;"></font></b><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、無限ループを開始します。これは、送信キューをチェックして送信コマンドを呼び出すという事実でのみビジーです</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(Object object)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キューに何かが現れた場合。 </font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスコンストラクターでは、Botクラスのオブジェクトを渡します。</font><font style="vertical-align: inherit;">メッセージを送信するためにオブジェクトを取得し、それを使用してメッセージを送信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sendメソッドは、送信するメッセージのタイプを決定し、それに適切なコマンドを適用します。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageReciever</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスの処理を分析し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。MessageSenderと同様に、コンストラクターでBotクラスのオブジェクトを受信して​​マルチスレッド化する必要があります</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">。</font></a><font style="vertical-align: inherit;">このクラスでは、受信したメッセージを無限ループで受け取り、処理して、処理結果を送信するためにキューに入れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、以前に作成したコマンドパーサーを使用します。</font><font style="vertical-align: inherit;">次に、チームにさまざまなタイプのハンドラーを使用する機能を追加し、それらの一部をマルチスレッド化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業サイクルは非常に簡単です。</font></font><br>
<br>
<pre><code class="java hljs">
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<font></font>
        log.info(<span class="hljs-string">"[STARTED] MsgReciever.  Bot class: "</span> + bot);
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
            <span class="hljs-keyword">for</span> (Object object = bot.receiveQueue.poll(); object != <span class="hljs-keyword">null</span>; object = bot.receiveQueue.poll()) {<font></font>
                log.debug(<span class="hljs-string">"New object for analyze in queue "</span> + object.toString());<font></font>
                analyze(object);<font></font>
            }<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                Thread.sleep(WAIT_FOR_NEW_MESSAGE_DELAY);<font></font>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {<font></font>
                log.error(<span class="hljs-string">"Catch interrupt. Exit"</span>, e);
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キューを確認してください。</font><font style="vertical-align: inherit;">何かがある場合は、アナライザーを実行します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">analyze</span><span class="hljs-params">(Object object)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何もない場合はお待ちしております。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーはオブジェクトのタイプをチェックします。</font><font style="vertical-align: inherit;">彼との連携方法を知っている場合は、次のアナライザーを起動します。</font><font style="vertical-align: inherit;">できない場合-誓います:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜですか？</font><font style="vertical-align: inherit;">繰り返しますが、これは将来のためのブックマークであり、この一連の記事の次のパートで開くことを願っています。</font><font style="vertical-align: inherit;">そのような実装により、ボットのある種のタスクを定式化したり、メーリングリストや日中のタスクを実行したりできるようになります。</font><font style="vertical-align: inherit;">このため、レシーバーはタイプUpdateのオブジェクトだけでなく、何かのオブジェクトも処理できる必要があります。</font><font style="vertical-align: inherit;">しかし、それについては後で</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
詳しく説明します。更新タイプについて、アナライザーをさらに詳しく見てみましょう。</font></font><br>
<br>
<pre><code class="java hljs">
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">analyzeForUpdateType</span><span class="hljs-params">(Update update)</span> </span>{<font></font>
        Long chatId = update.getMessage().getChatId();<font></font>
        String inputText = update.getMessage().getText();<font></font>
<font></font>
        ParsedCommand parsedCommand = parser.getParsedCommand(inputText);<font></font>
        AbstractHandler handlerForCommand = getHandlerForCommand(parsedCommand.getCommand());<font></font>
<font></font>
        String operationResult = handlerForCommand.operate(chatId.toString(), parsedCommand, update);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!<span class="hljs-string">""</span>.equals(operationResult)) {<font></font>
            SendMessage message = <span class="hljs-keyword">new</span> SendMessage();<font></font>
            message.setChatId(chatId);<font></font>
            message.setText(operationResult);<font></font>
            bot.sendQueue.add(message);<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チャットIDを定義します。メッセージテキストを取得します。パーサーを使用して、メッセージがコマンドかどうかを判別し、このコマンドを処理するハンドラーを判別します。コマンドの処理を開始し、コマンドの処理で空でないテキストが返された場合-ユーザーに送信するメッセージを形成し、キューに入れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここであなたは「どのようなハンドラーですか？」という質問があるはずです。以前は彼について話していなかったし、彼はコードで言及されていなかった。大丈夫。次に、この機能を分析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、すべてのハンドラーを格納する個別のパッケージを作成します。これを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼び</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、抽象クラスを作成します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> com.example.telegrambot.bot.Bot;
<span class="hljs-keyword">import</span> com.example.telegrambot.command.ParsedCommand;
<span class="hljs-keyword">import</span> org.telegram.telegrambots.api.objects.Update;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractHandler</span> </span>{<font></font>
    Bot bot;<font></font>
<font></font>
    AbstractHandler(Bot bot) {<font></font>
        <span class="hljs-keyword">this</span>.bot = bot;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">operate</span><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼には、対話する必要があるBotオブジェクトを渡す基本的なコンストラクターがあります。</font><font style="vertical-align: inherit;">そして、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する抽象関数</font><b><font style="vertical-align: inherit;">が</font></b><font style="vertical-align: inherit;">宣言され、その</font><font style="vertical-align: inherit;">実装はクラスの相続人に登録する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてすぐに、何も実行しない最も単純なハンドラーを実装し、与えられたコマンドのタイプが理解できず、ボットからの応答が不要な場合にそれを使用します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DefaultHandler.java</font></font></a><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> com.example.telegrambot.bot.Bot;
<span class="hljs-keyword">import</span> com.example.telegrambot.command.ParsedCommand;
<span class="hljs-keyword">import</span> org.apache.log4j.Logger;
<span class="hljs-keyword">import</span> org.telegram.telegrambots.api.objects.Update;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractHandler</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = Logger.getLogger(DefaultHandler.class);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultHandler</span><span class="hljs-params">(Bot bot)</span> </span>{
        <span class="hljs-keyword">super</span>(bot);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">operate</span><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それをどのように適用するか、そしてその作業の結果がどこで得られるかを少し後で分析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の行は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystemHandlerです。</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
彼はstart、helpなどの基本的なコマンドの処理を扱い、idコマンドを実行するように指示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その基礎は次のようになります。</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> com.example.telegrambot.bot.Bot;
<span class="hljs-keyword">import</span> com.example.telegrambot.command.Command;
<span class="hljs-keyword">import</span> com.example.telegrambot.command.ParsedCommand;
<span class="hljs-keyword">import</span> org.apache.log4j.Logger;
<span class="hljs-keyword">import</span> org.telegram.telegrambots.api.methods.send.SendMessage;
<span class="hljs-keyword">import</span> org.telegram.telegrambots.api.objects.Update;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractHandler</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = Logger.getLogger(SystemHandler.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String END_LINE = "\n";<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SystemHandler</span><span class="hljs-params">(Bot bot)</span> </span>{
        <span class="hljs-keyword">super</span>(bot);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">operate</span><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span> </span>{<font></font>
        Command command = parsedCommand.getCommand();<font></font>
<font></font>
        <span class="hljs-keyword">switch</span> (command) {
            <span class="hljs-keyword">case</span> START:<font></font>
                bot.sendQueue.add(getMessageStart(chatId));<font></font>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> HELP:<font></font>
                bot.sendQueue.add(getMessageHelp(chatId));<font></font>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ID:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Your telegramID: "</span> + update.getMessage().getFrom().getId();<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
startコマンドとhelpコマンドへの応答がコードでどのように</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
形成さ</font><font style="vertical-align: inherit;">れるかを確認できます:) </font><font style="vertical-align: inherit;">テキストメッセージ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">生成し、送信のためにキューに入れます。これで、ハンドラーの作業が停止します。誰がどのようにこれらのメッセージを送信するか-彼はまったく気にしません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し高いことを思い出してください。ハンドラーの処理の結果、テキストデータが返されることを述べました。この行が空でない場合-このテキストをユーザーに送信する必要があります。これは、IDコマンドを実行するときに使用した機能とまったく同じです。</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">case</span> ID:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Your telegramID: "</span> + update.getMessage().getFrom().getId();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、ユーザーIDを含むテキストを呼び出したユーザーに返し、すでにそこに送信用のメッセージが生成され、キューに入れられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、記事の冒頭で、作業に時間を必要とするユーザーからのメッセージを処理するためにこのオプションを実装することを述べました。そして、それがハンドラーの邪魔にならないように、別のストリームでそれを選択し、残りを邪魔することなくそのビジネスに取り掛かります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような「重い」スレッドとして、私は通知コマンドを思いつきました。彼女の仕事の原則はこれです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボットに次の形式のコマンドを与えます：</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ notify 300</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ボットはコマンドを理解したことを通知し、300秒後に300秒経過したことを通知します。このチームには実用的な用途さえあるかもしれません:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、餃子を火にかけ、5分後にそれらを取り除く必要があるとします。</font><font style="vertical-align: inherit;">ボットはこれを完全に実行し、チャットがタイムアウトになったことを通知します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、より深刻なタスクを実行します。</font><font style="vertical-align: inherit;">あなたは重要な会議に行く予定であり、対話者と通信するときは会話を中断する必要があることを知っています。</font><font style="vertical-align: inherit;">このため、彼らは通常、友達に電話するかメッセージを書くように依頼します。これは、長い間会話の邪魔をせず、何らかの行動を起こす動機になります。</font><font style="vertical-align: inherit;">しかし、あなたがボットを持っているのに、なぜ友達に迷惑をかけるのですか？</font><font style="vertical-align: inherit;">彼に事前にタスクを尋ね、時間を示した後、必要な通知を電報で受け取ります。</font><font style="vertical-align: inherit;">しかし、これはすべての歌詞です。</font><font style="vertical-align: inherit;">タスクとこのコマンドは、何かを別のストリームに分離する方法を示すためにのみ開発されました。その作業には非常に長い時間がかかる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NotifyHandler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">import</span> com.example.telegrambot.ability.Notify;
<span class="hljs-keyword">import</span> com.example.telegrambot.bot.Bot;
<span class="hljs-keyword">import</span> com.example.telegrambot.command.ParsedCommand;
<span class="hljs-keyword">import</span> org.apache.log4j.Logger;
<span class="hljs-keyword">import</span> org.telegram.telegrambots.api.objects.Update;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotifyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractHandler</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = Logger.getLogger(NotifyHandler.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MILLISEC_IN_SEC = <span class="hljs-number">1000</span>;
    <span class="hljs-keyword">private</span> String WRONG_INPUT_MESSAGE = <span class="hljs-string">"Wrong input. Time must be specified as an integer greater than 0"</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NotifyHandler</span><span class="hljs-params">(Bot bot)</span> </span>{
        <span class="hljs-keyword">super</span>(bot);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">operate</span><span class="hljs-params">(String chatId, ParsedCommand parsedCommand, Update update)</span> </span>{<font></font>
        String text = parsedCommand.getText();<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">""</span>.equals(text))
            <span class="hljs-keyword">return</span> <span class="hljs-string">"You must specify the delay time. Like this:\n"</span> +
                    <span class="hljs-string">"/notify 30"</span>;
        <span class="hljs-keyword">long</span> timeInSec;
        <span class="hljs-keyword">try</span> {<font></font>
            timeInSec = Long.parseLong(text.trim());<font></font>
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-keyword">return</span> WRONG_INPUT_MESSAGE;<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (timeInSec &gt; <span class="hljs-number">0</span>) {<font></font>
            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Notify(bot, chatId, timeInSec * MILLISEC_IN_SEC));<font></font>
            thread.start();<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> WRONG_INPUT_MESSAGE;
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストで遅延時間が指定されているかどうかを確認します。</font><font style="vertical-align: inherit;">そうでなければ、私たちは誓います。</font><font style="vertical-align: inherit;">その場合は、新しいスレッドを開始します。ここで、指示の紹介を渡します。</font><font style="vertical-align: inherit;">このタスクは、別個の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスによって処理され</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能は非常にシンプルです。</font><font style="vertical-align: inherit;">彼は指定された秒数眠ります。</font><font style="vertical-align: inherit;">しかし、彼の睡眠の過程で、あなたのボットは他のメッセージを受信し、あなたと通信し、追加の追加の通知を起動することができます。</font><font style="vertical-align: inherit;">そして、これらすべては互いに別々に機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出しハンドラでこの全体を論理的に完了するために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MessageReciever</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスに戻って、</font><font style="vertical-align: inherit;">必要なハンドラとその実行方法を理解する方法を見</font><font style="vertical-align: inherit;">てみましょう</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なハンドラーはコマンドによって返されます</font></font><br>
<pre><code class="java hljs">
<span class="hljs-function"><span class="hljs-keyword">private</span> AbstractHandler <span class="hljs-title">getHandlerForCommand</span><span class="hljs-params">(Command command)</span> </span>{
        <span class="hljs-keyword">if</span> (command == <span class="hljs-keyword">null</span>) {<font></font>
            log.warn(<span class="hljs-string">"Null command accepted. This is not good scenario."</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultHandler(bot);<font></font>
        }<font></font>
        <span class="hljs-keyword">switch</span> (command) {
            <span class="hljs-keyword">case</span> START:
            <span class="hljs-keyword">case</span> HELP:
            <span class="hljs-keyword">case</span> ID:<font></font>
                SystemHandler systemHandler = <span class="hljs-keyword">new</span> SystemHandler(bot);<font></font>
                log.info(<span class="hljs-string">"Handler for command["</span> + command.toString() + <span class="hljs-string">"] is: "</span> + systemHandler);
                <span class="hljs-keyword">return</span> systemHandler;
            <span class="hljs-keyword">case</span> NOTIFY:<font></font>
                NotifyHandler notifyHandler = <span class="hljs-keyword">new</span> NotifyHandler(bot);<font></font>
                log.info(<span class="hljs-string">"Handler for command["</span> + command.toString() + <span class="hljs-string">"] is: "</span> + notifyHandler);
                <span class="hljs-keyword">return</span> notifyHandler;
            <span class="hljs-keyword">default</span>:<font></font>
                log.info(<span class="hljs-string">"Handler for command["</span> + command.toString() + <span class="hljs-string">"] not Set. Return DefaultHandler"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultHandler(bot);<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、さらにコマンドを追加する場合は、次のことを行う必要があります。</font></font><br>
<br>
<ol>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Command</a>   . </li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>   <b>getHandlerForCommand</b> ,       . </li>
<li>     . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいチームを追加するプロセスを簡略化できることを前に述べておきます。責任あるハンドラーは、コマンドのリストを使用してクラスにすぐに登録できます。しかし、コードは理解しにくいと思います。テキストが非常に長いです。しかし、私は彼をバラバラに倒すことはできません。ここでは、連携して機能する3つの基本的なボット機能について説明します。これらについて個別に説明することは適切ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の部分では何について話しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまなタイプのメッセージを作成する方法を理解する必要があります。キーボードとボタンの操作方法。古い投稿を編集する方法。コールバックの操作方法。いくつかのアクションを実行するためにボットにタスクを与える方法。ボットなどでインタラクティブなメッセージを作成する方法。それ以降のすべての部分は、あなたとあなたの活動次第です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメントでは、私たちが優先的に検討するフィードバックと指示をお待ちしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気軽にご質問ください。</font><font style="vertical-align: inherit;">記事に何かが示されていない場合、またはある時点で不明確な場合-それについて私に書いてください。</font><font style="vertical-align: inherit;">私は間違いなく問題のある問題を修正、編集、または明確にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
楽しくプログラムされており、はい、あなたは強さと美しいコードで到着します:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
py.sy。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事のこの部分で書かれたボットは機能します。</font><font style="vertical-align: inherit;">ここで彼を苦しめることができます：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@test_habr_bot</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
私のプランナーを苦しめることもできます：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@EventCheckPlanner_Bot</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
そして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生意気な映画ファン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">@FilmFanAmateurBot</font></a><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja481344/index.html">2020年のIntelliJプラットフォームチーム計画</a></li>
<li><a href="../ja481346/index.html">自動車業界における5つの大きな変化</a></li>
<li><a href="../ja481348/index.html">Pentest Active Directory。パート1</a></li>
<li><a href="../ja481350/index.html">プレセツク宇宙基地で働く人</a></li>
<li><a href="../ja481352/index.html">DBA：PKなしでテーブルからクローンレコードをクリアする</a></li>
<li><a href="../ja481356/index.html">ありがとう、2019</a></li>
<li><a href="../ja481358/index.html">C ++ロシア：いかがでしたか</a></li>
<li><a href="../ja481360/index.html">今週の結果：ランブラーとトゥイッチが合意、電子労働がロシア連邦に導入され、Facebookが独自のOSを作成する</a></li>
<li><a href="../ja481362/index.html">Docker WebアプリのSSL証明書</a></li>
<li><a href="../ja481364/index.html">敏感な家はスマートホームに取って代わります</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>