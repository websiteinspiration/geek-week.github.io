<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ø üñäÔ∏è ü§≤ Camunda external tasks - a powerful tool for building applications with resilient and scalable architecture üéß ü§´ üñêüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Tinkoff, we use the Camunda + Spring framework to develop business process automation systems . We describe business processes using BPMN (Business...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Camunda external tasks - a powerful tool for building applications with resilient and scalable architecture</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/490656/"><img src="https://habrastorage.org/webt/sw/nv/az/swnvaz2_ifbzirrprmoucnx0zli.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Tinkoff, we use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camunda + Spring</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> framework to develop business process automation systems </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We describe business processes using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPMN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Business Process Management Notation) in the form of flowcharts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most commonly used element in our diagrams is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (gear rectangle). </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> supports two ways to perform </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using a synchronous call to java code.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating an external task.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second method allows you to perform tasks using external systems - for example, if you need to call one </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda application</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from another or even delegate work to any external system.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/27/tm/sd/27tmsdtlkpfvti2vcgdvjl8xcqk.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example BPMN Diagram</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This is useful when you intend to reuse logic in multiple applications. </font><font style="vertical-align: inherit;">Or when you want to stick to microservice architecture. </font><font style="vertical-align: inherit;">For example, separating services that deal with business processes from services that implement technical tasks, such as generating reports or mailing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Along with this feature, an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> provides a scalable, resilient architecture. </font><font style="vertical-align: inherit;">To understand why this happens, you first need to understand how the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> works at the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPMN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and application levels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External task in BPMN</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> involves creating a task that can be performed by an external handler. </font><font style="vertical-align: inherit;">The essence of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern </font><font style="vertical-align: inherit;">is that:</font></font><br>
<br>
<ol>
<li>,  ¬´¬ª  ,      ¬´¬ª.</li>
<li>     <b>camunda</b>   ,       ,       .</li>
<li>     <b>camunda</b>   (/).</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the diagram above, I described a fictional process in which we want to get a list of users, send them an advertisement and after 2 hours calculate the number of applications after the marketing newsletter. </font><font style="vertical-align: inherit;">And, if there are more than 10 applications, increase the selection for the next mailing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I want my </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application to </font><b><font style="vertical-align: inherit;">be</font></b><font style="vertical-align: inherit;"> responsible only for business processes, and any other application </font><b><font style="vertical-align: inherit;">should be</font></b><font style="vertical-align: inherit;"> responsible for emailing. </font><font style="vertical-align: inherit;">In this case, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern works fine for me </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In my process, I will simply create an email newsletter task and wait for it to be completed by some external handler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the diagram </font><font style="vertical-align: inherit;">, you must:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a regular </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change its type to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set implementation to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specify the value of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Topic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">.</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/qk/sf/0p/qksf0pz_6lglnp8_xu42jxphsmg.png" alt="image"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Topic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of the queue into which tasks of one type will be added and to which an external handler will subscribe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that there is an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the process </font><font style="vertical-align: inherit;">, you can start it, but it will not be executed, since no one is processing it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External tasks worker</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern </font><font style="vertical-align: inherit;">is good in that it allows you to implement task processing in any language, using any tools that can perform </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP requests</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an example from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"> blog</font></a><font style="vertical-align: inherit;"> . The example implements an external </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">javascript</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> handler </font><font style="vertical-align: inherit;">that, every 20 seconds, requests a </font><font style="vertical-align: inherit;">list of processing tasks </font><font style="vertical-align: inherit;">from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If there are tasks, then it sends them out and notifies </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about the completion of the task.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">'http://localhost:8080/my-app/rest'</span>;
<span class="hljs-keyword">const</span> workerSettings = {
 <span class="hljs-attr">workerId</span>: <span class="hljs-string">'worker01'</span>, <span class="hljs-comment">// some unique name for the current worker instance</span>
 <span class="hljs-attr">maxTasks</span>: <span class="hljs-number">5</span>,
 <span class="hljs-attr">topics</span>: [<font></font>
   {<font></font>
     <span class="hljs-attr">topicName</span>: <span class="hljs-string">'sendEmail'</span>,
     <span class="hljs-attr">lockDuration</span>: <span class="hljs-number">10000</span>, <span class="hljs-comment">// How much time the worker thinks he needs to process the task</span>
     <span class="hljs-attr">variables</span>: [<span class="hljs-string">'video'</span>] <span class="hljs-comment">// Which variables should be returned in the response (to avoid additional REST calls to read data)</span><font></font>
   }]};<font></font>
<span class="hljs-keyword">const</span> requestParams = {<span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, <span class="hljs-attr">headers</span>: {<span class="hljs-attr">contentType</span>: <span class="hljs-string">'application/json'</span>}};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pollExternalTasks</span>(<span class="hljs-params"></span>) </span>{
 <span class="hljs-keyword">return</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/external-task/fetchAndLock`</span>, {<font></font>
   ...requestParams,<font></font>
   <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(workerSettings)<font></font>
 })<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processExternalTask</span>(<span class="hljs-params">result = []</span>) </span>{
 <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all(result.map(<span class="hljs-function"><span class="hljs-params">externalTask</span> =&gt;</span> {<font></font>
   sendEmail(externalTask); <span class="hljs-comment">// Here the actual work would be done</span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> fetch(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/external-task/<span class="hljs-subst">${externalTask.id}</span>/complete`</span>, {<font></font>
     ...requestParams,<font></font>
     <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">workerId</span>: workerSettings.workerId}),<font></font>
   })<font></font>
 }));<font></font>
}<font></font>
<font></font>
setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
 pollExternalTasks().then(processExternalTask)<font></font>
}, <span class="hljs-number">20000</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the code above, the key methods for handling </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fetchAndLock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The first method requests a list of tasks and secures their implementation, and the second informs about the completion of the task. </font><font style="vertical-align: inherit;">In addition to these two methods, there are others, you can read about them </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the official documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camunda external task client</font></font></h2><br>
<img src="https://habrastorage.org/webt/sf/td/-g/sftd-gp7palq7dtzvgvpjqyj2y0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processing, </font><b><font style="vertical-align: inherit;">camunda</font></b><font style="vertical-align: inherit;"> provided </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javascript</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clients </font><font style="vertical-align: inherit;">that allow you to create external task handlers in just a few lines. </font><font style="vertical-align: inherit;">There is also a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">detailed guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that describes the basic principles of processing external tasks - again with examples in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javascript</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example implementation of an external handler using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExternalTaskClient</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String... args)</span> </span>{
       <span class="hljs-comment">// bootstrap the client</span><font></font>
       ExternalTaskClient client = ExternalTaskClient.create()<font></font>
           .baseUrl(<span class="hljs-string">"http://localhost:8080/engine-rest"</span>)<font></font>
           .asyncResponseTimeout(<span class="hljs-number">1000</span>)<font></font>
           .build();<font></font>
<font></font>
       <span class="hljs-comment">// subscribe to the topic</span>
       client.subscribe(<span class="hljs-string">"sendEmail"</span>).handler((externalTask, externalTaskService) -&gt; {
           <span class="hljs-keyword">try</span> {<font></font>
               String result = sendEmail(externalTask)<font></font>
               Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
<font></font>
               variables.put(<span class="hljs-string">"result"</span>, result);<font></font>
               externalTaskService.complete(externalTask, variables);<font></font>
               System.out.println(<span class="hljs-string">"The External Task "</span> + externalTask.getId() + <span class="hljs-string">" has been completed!"</span>);<font></font>
           } <span class="hljs-keyword">catch</span> (e: Exception) {<font></font>
               externalTaskService.handleFailure(externalTask, e.message, e.stackTrace.toString())<font></font>
           }<font></font>
       }).open();<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your task requires not just performing some synchronous action, but starting the whole process, then you can do it, for example, by starting the process through </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RuntimeService</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailWorker</span></span>(
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> runtimeService: RuntimeService<font></font>
) {<font></font>
   <span class="hljs-keyword">val</span> builder = ExternalTaskClientBuilderImpl().baseUrl(<span class="hljs-string">"http://localhost:8080"</span>).workerId(<span class="hljs-string">"myWorker"</span>)
   <span class="hljs-keyword">val</span> taskClient = builder.build()
   <span class="hljs-keyword">val</span> engineClient = (builder <span class="hljs-keyword">as</span> ExternalTaskClientBuilderImpl).engineClient<font></font>
<font></font>
   <span class="hljs-meta">@PostConstruct</span>
   <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {<font></font>
       taskClient<font></font>
           .subscribe(<span class="hljs-string">"sendEmail"</span>)<font></font>
           .lockDuration(<span class="hljs-number">10000</span>)<font></font>
           .handler { externalTask, externalService -&gt;<font></font>
               runtimeService.startProcessInstanceByKey(<font></font>
                   <span class="hljs-string">"SendEmailProcess"</span>,<font></font>
                   externalTask.getVariable(<span class="hljs-string">"emailId"</span>),<font></font>
                   mapOf(<font></font>
                       <span class="hljs-string">"text"</span> to externalTask.getVariable(<span class="hljs-string">"text"</span>),
                       <span class="hljs-string">"email"</span> to externalTask.getVariable(<span class="hljs-string">"email"</span>)<font></font>
                   )<font></font>
               )<font></font>
           }<font></font>
           .<span class="hljs-keyword">open</span>()<font></font>
   }<font></font>
<font></font>
<font></font>
   <span class="hljs-meta">@PreDestroy</span>
   <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span></span> {<font></font>
       taskClient.stop()<font></font>
   }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Delegate from SendEmailProcess process</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailResultDelegate</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> emailWorker: EmailWorker) {
   <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doExecute</span><span class="hljs-params">(execution: <span class="hljs-type">DelegateExecution</span>)</span></span> {<font></font>
       emailWorker.engineClient.complete(<font></font>
           execution.readVar(EXTERNAL_TASK_ID),<font></font>
           mapOf(<span class="hljs-string">"result"</span> to <span class="hljs-string">"Success"</span>)<font></font>
       )<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, the external tasks handler ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmailWorker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), when the task is received, starts the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SendEmailProcess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that this process performs some actions necessary to send a newsletter, and at the end calls </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmailResultDelegate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which, in turn, completes the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architectural Benefits of External Task</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that there is a way to start the process in another </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application </font><b><font style="vertical-align: inherit;">in</font></b><font style="vertical-align: inherit;"> a simpler way: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST: / rest / process-definition / key / $ {id} / start</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When you use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you do not have any transaction guarantees. But after all, </font><font style="vertical-align: inherit;">we also work </font><font style="vertical-align: inherit;">with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> through </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , what is the difference then? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The difference is that we do not call the external service directly, but only publish tasks that can be processed. Consider an example: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cv/-3/iv/cv-3ivsxpit3o3q8zosyi1e9jkw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some external handler takes a task that is now assigned to it, but when a response is received, the connection is disconnected. Now on the side of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a task that will not be processed is blocked because the external handler did not receive a response. But this is not scary: in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there is a timeout by which the task will return to the queue again and someone else can handle it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's look at the case when an external handler received a task, completed it, and called the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">, which failed because of network problems. Now you will not be able to understand whether the task was successfully completed in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">camunda</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or not. You can try again, but there is a chance that network problems will continue.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the best solution would be to ignore the problem. If the task was successfully completed, then everything is in order. If not, after the timeout the task will again be available for processing. But this means that your external handler must be idempotent or contain logic to deduplicate tasks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar problem can happen when starting a new process, so before that you should check existing instances with the same data, for example </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">businessKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to high fault tolerance </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to easily scale external handlers and implement them in any programming language. </font><font style="vertical-align: inherit;">At the same time, the pattern helps to implement microservices so that they influence each other as little as possible, thereby increasing their stability. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More about </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">external task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://docs.camunda.org/manual/latest/user-guide/process-engine/external-tasks/ </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://docs.camunda.org/manual/latest/reference/rest/external -task / </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://docs.camunda.org/manual/latest/user-guide/ext-client/</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490644/index.html">Simple rpm repository using Inotify and webdav</a></li>
<li><a href="../en490648/index.html">Using Kata Containers in Kubernetes</a></li>
<li><a href="../en490650/index.html">The main mistakes in compiling a CV by beginner IT specialists</a></li>
<li><a href="../en490652/index.html">Logistics. Introduction Just about complicated</a></li>
<li><a href="../en490654/index.html">Dotting over MQ Series gas sensors - deep understanding of datasheet and tuning</a></li>
<li><a href="../en490660/index.html">How did we ensure the growth of CityMobile</a></li>
<li><a href="../en490664/index.html">PHP: array_key_exists searches 500 times faster than in_array</a></li>
<li><a href="../en490668/index.html">The history of the transformation from product to project and vice versa (using the example of Goodness in the Moscow region)</a></li>
<li><a href="../en490670/index.html">How to make a car write tests from code for you</a></li>
<li><a href="../en490674/index.html">Habr Wickley # 41 / More autonomous cars, prof. Fortran, Yandex, the pain of the robot, how to block a competitor‚Äôs site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>