<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçû üå∑ üë©üèº‚Äçü§ù‚Äçüë©üèª Google Cloud Spanner: good, bad, evil üòõ ‚úåÔ∏è üêµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrovsk. Traditionally, we continue to share interesting material in anticipation of the launch of new courses. Today, specially for you, we have...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Google Cloud Spanner: good, bad, evil</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/489012/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, Habrovsk. </font><font style="vertical-align: inherit;">Traditionally, we continue to share interesting material in anticipation of the launch of new courses. </font><font style="vertical-align: inherit;">Today, specially for you, we have published an article about Google Cloud Spanner, timed to coincide with the launch of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the AWS for Developers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><font style="vertical-align: inherit;">.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/aj/iu/8h/ajiu8hhn-nlooidazuy-xsxjb6a.png"><br>
<br>
<hr><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Originally posted </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the Lightspeed HQ blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a company that offers many cloud-based POS solutions for retailers, restaurateurs, and online retailers around the world, Lightspeed uses several different types of database platforms for a variety of transactional, analytic, and search cases. </font><font style="vertical-align: inherit;">Each of these database platforms has its own strengths and weaknesses. Consequently, when Google introduced Cloud Spanner on the market, promising features unprecedented in the world of relational databases, such as virtually unlimited horizontal scalability and a 99.999% service level agreement (SLA), - we could not miss the opportunity to get it in our hands!</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To give a comprehensive overview of our experience with Cloud Spanner, as well as the evaluation criteria we used, we will cover the following topics:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our evaluation criteria</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud Spanner in a Nutshell</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our rating</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our findings</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/2m/br/l7/2mbrl7cdprixgrcxqn4dp25yvju.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Our evaluation criteria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before delving into the features of Cloud Spanner, its similarities and differences with other solutions on the market, let's first talk about the main user cases that we had in mind when considering where to deploy Cloud Spanner in our infrastructure:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a replacement for the (prevailing) traditional SQL database solution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How an OLTP Solution with OLAP Support</font></font></li>
</ul><br>
<blockquote><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For simplicity and ease of comparison, this article compares Cloud Spanner with MySQL GCP Cloud SQL and Amazon AWS RDS family of solutions.</font></font></i></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Cloud Spanner as a replacement for a traditional SQL database solution</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traditional</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> database </font><font style="vertical-align: inherit;">environment </font><font style="vertical-align: inherit;">, when the response time to a database query approaches or even exceeds predefined application thresholds (mainly due to an increase in the number of users and / or queries), there are several ways to reduce the response time to acceptable levels. However, most of these solutions include manual intervention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, the first step you need to take is to look at the various database parameters related to performance and configure them to best match application usage patterns. If this is not enough, you can choose to scale the database vertically or horizontally.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scaling up an application entails updating the server instance, usually by adding more processors / cores, more RAM, faster storage, etc. Adding more hardware resources leads to an increase in database performance, measured mainly in transactions in second, and transaction delay for OLTP systems. Relational database systems (which use a multi-threaded approach), such as MySQL, scale well vertically. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach has several drawbacks, but the most obvious is the maximum server size on the market. Once the limit of the largest server instance is reached, there is only one way: horizontal scaling.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Horizontal scaling is an approach in which more servers are added to the cluster to ideally linearly increase performance with the addition of the number of servers. Most </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traditional</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> database systems do not scale well horizontally or do not scale at all. For example, MySQL can scale horizontally for read operations by adding slave readers, but cannot scale horizontally for write operations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the other hand, due to its nature, Cloud Spanner can easily scale horizontally with minimal interference. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Full-featured </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBMS as a service</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must be evaluated from different angles. </font><font style="vertical-align: inherit;">As a basis, we took the most popular DBMS in the cloud - for Google, GCP Cloud SQL and for Amazon, AWS RDS. </font><font style="vertical-align: inherit;">In our assessment, we focused on the following categories:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feature mapping: SQL extent, DDL, DML; </font><font style="vertical-align: inherit;">connection libraries / connectors, transaction support, and so on.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development support: ease of development and testing.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administration support: management of instances - for example, scaling up / down and upgrade of instances; </font><font style="vertical-align: inherit;">SLA, backup and restore; </font><font style="vertical-align: inherit;">security / access control.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Cloud Spanner as OLTP with OLAP Support</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although Google does not explicitly claim that Cloud Spanner is for analytic processing, it shares some attributes with other mechanisms, such as Apache Impala &amp; Kudu and YugaByte, which are designed for OLAP workloads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even if there was only a small chance that Cloud Spanner included a consistent horizontally scalable HTAP (hybrid transactional / analytical processing) engine with a (more or less) usable set of OLAP features, we think that it would deserve our attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this in mind, we examined the following categories:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data loading, indexes and partitioning support</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Query Performance and DML</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Cloud Spanner in a Nutshell</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Spanner is a cluster relational database management system (RDBMS) that Google uses for several of its own services. </font><font style="vertical-align: inherit;">Google made it publicly available to Google Cloud Platform users in early 2017. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are some of the attributes of Cloud Spanner:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highly consistent scalable RDBMS cluster: Uses hardware time synchronization to ensure data consistency.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cross-table transaction support: transactions can span multiple tables - not necessarily limited to one table (unlike Apache HBase or Apache Kudu).</font></font></li>
<li>    :        (),       .      ,           .       ,             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>.</li>
<li> :        .          .     ,        , ,       -.</li>
<li>: Cloud Spanner   .         .         .         .     , ,    ,   .         ,    .</li>
</ul><br>
<i>¬´Cloud Spanner       .  , Cloud Spanner     ,    - ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>¬ª.</i><br>
<br>
<ul>
<li>    (SLA):      SLA  99,99%;    99,999% SLA.          ,   - ,  ,    Google     ,     . ( , 99,999%  26,3     .)</li>
<li>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">https://cloud.google.com/spanner/</a></li>
</ul><br>
<blockquote><i><b>:</b>  Apache Tephra      Apache HBase (    Apache Phoenix   -).</i></blockquote><br>
<h2>3.  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we all read Google‚Äôs statements about the benefits of Cloud Spanner - virtually unlimited horizontal scaling while maintaining high consistency and very high SLA. </font><font style="vertical-align: inherit;">Although these requirements are, at any rate, extremely difficult to achieve, our goal was not to refute them. </font><font style="vertical-align: inherit;">Instead, let's focus on other things that most database users care about: parity and usability.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We rated Cloud Spanner as a replacement for Sharded MySQL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Cloud SQL and Amazon AWS RDS, the two most popular OLTP DBMSs in the cloud market, have a very large feature set. </font><font style="vertical-align: inherit;">However, to scale these databases beyond the size of a single node, you need to perform application partitioning. </font><font style="vertical-align: inherit;">This approach creates additional complexity for both applications and administration. </font><font style="vertical-align: inherit;">We looked at how Spanner fits into the scenario of combining several segments into one instance and which features (if any) may have to be sacrificed.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for SQL, DML and DDL, as well as connector and libraries?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, when starting with any database, you must create a data model. </font><font style="vertical-align: inherit;">If you think that you can connect the JDBC Spanner to your favorite SQL tool, you will find that you can query your data with it, but you cannot use it to create a table or change (DDL) or any insert / update / delete operations ( DML). </font><font style="vertical-align: inherit;">Google's official JDBC does not support either.</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"The drivers do not currently support DML or DDL." </font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spanner Documentation</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the GCP console, the situation is no better - you can send only SELECT queries. Fortunately, there is a JDBC driver with DML and DDL support from the community, including transactions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/olavloite/spanner-jdbc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Although this driver is extremely useful, the lack of Google's own JDBC driver is surprising. Fortunately, Google offers fairly broad support for client libraries (based on gRPC): C #, Go, Java, node.js, PHP, Python, and Ruby.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The almost mandatory use of Cloud Spanner user APIs (due to the lack of DDL and DML in JDBC) leads to some restrictions for related areas of code, such as connection pools or database binding frameworks (e.g. Spring MVC). As a rule, when using JDBC, you can freely select your favorite connection pool (for example, HikariCP, DBCP, C3PO, etc.), which is tested and works well. In the case of custom Spanner APIs, we must rely on the frameworks / binding pools / sessions we created ourselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The primary key (PC) design allows Cloud Spanner to be very fast when accessing data via a PC, but also leads to some query problems.</font></font><br>
<br>
<ul>
<li>      ;               . (       / .)</li>
<li>  UPDATE  DELETE     WHERE, ,      DELETE all ‚Äî    , : UPDATE xxx WHERE id IN (SELECT id FROM table1)</li>
<li>    - ,      .   ,        .</li>
</ul><br>
<h4> ?</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Cloud Spanner has built-in support for secondary indexes. This is a very nice feature that is not always present in other technologies. Apache Kudu does not currently support secondary indexes at all, and Apache HBase does not support indexes directly, but can add them through Apache Phoenix. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indexes in Kudu and HBase can be modeled as a separate table with different composition of primary keys, but the atomicity of operations performed with the parent table and related index tables must be performed at the application level and is not trivial in the correct implementation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As mentioned in the Cloud Spanner review, its indexes may differ from the MySQL indexes. </font><font style="vertical-align: inherit;">Therefore, particular care should be taken when building queries and profiling to ensure that the proper index is used where it is needed.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Representation?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very popular and useful object in the database is views. </font><font style="vertical-align: inherit;">They can be useful for a large number of user cases; </font><font style="vertical-align: inherit;">my two favorites are the level of logical abstraction and the level of security. </font><font style="vertical-align: inherit;">Unfortunately, Cloud Spanner does NOT support submissions. </font><font style="vertical-align: inherit;">However, this only partially limits us, because for access permissions there is no granularity at the column level where representations may be an acceptable solution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Cloud Spanner documentation has a section that details quotas and restrictions ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spanner / quotas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), there is, in particular, one that may be problematic for some applications: Cloud Spanner out of the box has a limit of a maximum of 100 databases per instance. </font><font style="vertical-align: inherit;">Obviously, this can be a serious obstacle for a database that is designed to scale to more than 100 databases. </font><font style="vertical-align: inherit;">Fortunately, after talking with our Google technical representative, we found out that this limit can be increased to almost any value through Google support.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development support?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cloud Spanner offers pretty decent support for programming languages ‚Äã‚Äãto work with its API. </font><font style="vertical-align: inherit;">Officially supported libraries are in the areas of C #, Go, Java, node.js, PHP, Python, and Ruby. </font><font style="vertical-align: inherit;">The documentation is quite detailed, but, as with other advanced technologies, the community is quite small compared to the most popular database technologies, which can lead to an increase in the time spent on solving less common use cases or problems.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So what about local development support?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We did not find a way to create a Cloud Spanner instance in the local environment. </font><font style="vertical-align: inherit;">The closest we got is the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CockroachDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker image </font><font style="vertical-align: inherit;">, which in principle is similar, but in practice it is very different. </font><font style="vertical-align: inherit;">For example, CockroachDB may use PostgreSQL JDBC. </font><font style="vertical-align: inherit;">Since the development environment should be as close as possible to the working environment, Cloud Spanner is not ideal, since you need to rely on a full Spanner instance. </font><font style="vertical-align: inherit;">To save costs, you can choose an instance for one region.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administration Support?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating a Cloud Spanner instance is easy. </font><font style="vertical-align: inherit;">You just need to choose between creating a multi-regional or instance for one region, specify the region (s) and the number of nodes. </font><font style="vertical-align: inherit;">In less than a minute, the instance will be up and running. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several basic metrics are directly available on the Spanner page in the Google console. </font><font style="vertical-align: inherit;">More detailed views are available through Stackdriver, where you can also set threshold metrics and alert policies.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access to resources?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQL offers extensive and very detailed user permission / role settings. </font><font style="vertical-align: inherit;">You can easily configure access to a specific table, or even just a subset of its columns. </font><font style="vertical-align: inherit;">Cloud Spanner uses the Google Identity &amp; Access Management (IAM) tool, which allows you to set policies and permissions only at a very high level. </font><font style="vertical-align: inherit;">The most detailed option is a database-level resolution that does not fit into most production cases. </font><font style="vertical-align: inherit;">This restriction forces you to add additional security measures to your code, infrastructure, or both to prevent unauthorized use of Spanner resources.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backups?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In simple terms, there are no backups in Cloud Spanner. </font><font style="vertical-align: inherit;">Although the high requirements of the Google SLA can guarantee that you will not lose any data due to hardware or database failures, human errors, application defects, etc. We all know the rule: high availability does not replace a reasonable backup strategy. </font><font style="vertical-align: inherit;">At the moment, the only way to back up data is to programmatically stream it from the database to a separate storage environment.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Query performance?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We used Yahoo! to download data and test queries. Cloud Serving Benchmark. The table below shows the YCSB B workload with a reading ratio of 95% and a write ratio of 5%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vx/po/h4/vxpoh4penig4qvaa5sj1gvflfvm.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* The load test was performed on the n1-standard-32 computational engine (CE) (32 vCPU, 120 GB of memory), and the test instance was never a bottleneck in the tests. </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">** The maximum number of threads in one instance of YCSB is 400. In total, six parallel instances of YCSB tests had to be run to get a total of 2400 threads.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking at the test results, in particular the combination of processor load and TPS, we clearly see that Cloud Spanner scales quite well. </font><font style="vertical-align: inherit;">The large load created by a large number of threads is compensated by the large number of nodes in the Cloud Spanner cluster. </font><font style="vertical-align: inherit;">Although the delay looks rather high, especially when working with 2400 threads, retesting with 6 smaller instances of the computational engine may be necessary to get more accurate numbers. </font><font style="vertical-align: inherit;">Each instance will run one YCSB test instead of one large CE instance with 6 parallel tests. </font><font style="vertical-align: inherit;">Thus, it will be easier to distinguish between Cloud Spanner request delays and delays added by the network connection between Cloud Spanner and the CE instance on which the test is running.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does Cloud Spanner handle OLAP?</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partitioning?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dividing data into physically and / or logically independent segments, called partitions, is a very popular concept inherent in most OLAP mechanisms. Partitions can significantly improve query performance and database support. Further deepening in the partition would come up in a separate article (s), so let's just mention the importance of having a partitioning scheme and sub-partitioning. The ability to partition data into partitions and even further into subpartitions is key to the performance of analytic queries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cloud Spanner does not support partitions per se. It splits data internally into so-called </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">split</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s based on primary key ranges. </font><font style="vertical-align: inherit;">Separation is performed automatically to balance the load in the Cloud Spanner cluster. </font><font style="vertical-align: inherit;">A very convenient feature of Cloud Spanner is to split the base load of the parent table (a table that does not alternate with another). </font><font style="vertical-align: inherit;">Spanner automatically determines if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">split</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains </font><font style="vertical-align: inherit;">data that is read more often than data in other </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">split</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s, and can decide on further separation. </font><font style="vertical-align: inherit;">Thus, more nodes can be involved in the request, which also effectively increases throughput.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loading data?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Cloud Spanner method for bulk data is the same as for regular downloads. </font><font style="vertical-align: inherit;">To achieve maximum performance, you need to follow some recommendations, including:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sort your data by primary key.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divide them by 10 * the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of nodes of</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> individual sections.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a set of work tasks that load data in parallel.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this data download, all Cloud Spanner nodes are used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We used the A YCSB workload to generate a dataset of 10M rows. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4n/-o/nj/4n-onjrzn_2nco-hz8o3vnr42d4.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* The load test was performed on the n1-standard-32 computational engine (32 vCPU, 120 GB of memory), and the test instance was never a bottleneck in the tests. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
** A 1-node configuration is not recommended for any production load.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As mentioned above, Cloud Spanner automatically processes split-s depending on their load, so the results improve after several successive repetitions of the test. </font><font style="vertical-align: inherit;">The results presented here are the best results we have received. </font><font style="vertical-align: inherit;">Looking at the numbers above, we can see how Cloud Spanner scales (well) with an increase in the number of nodes in the cluster. </font><font style="vertical-align: inherit;">The numbers that stand out are extremely low average delays that contrast with the results of mixed workloads (95% for reading and 5% for writing), as described in the section above.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scaling?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Increasing and decreasing the number of Cloud Spanner nodes is a one-click task. If you want to quickly load data, you can consider boosting the instance to the maximum (in our case, it was 25 nodes in the US-EAST region), and then reduce the number of nodes suitable for your regular load after all the data in the database bearing in mind the limitation of 2 TB / node. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We were reminded of this limit even with a much smaller database. After several runs of load tests, our database was about 155 GB in size, and when reduced to an instance of 1 node, we received the following error: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/_b/ge/bx_bgefdcl_ouf3ldvrdoxglyks.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We were able to reduce the scale from 25 to 2 instances, but we were stuck on two nodes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Increasing and decreasing the number of nodes in a Cloud Spanner cluster can be automated using the REST API. </font><font style="vertical-align: inherit;">This can be especially useful to reduce the increased load on the system during busy hours.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OLAP query performance?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, we planned to devote considerable time to our evaluation of Spanner for this part. </font><font style="vertical-align: inherit;">After several SELECT COUNTs, we immediately realized that testing would be short and that Spanner would NOT be an OLAP engine. </font><font style="vertical-align: inherit;">Regardless of the number of nodes in the cluster, a simple selection of the number of rows in a table of 10M rows took 55 to 60 seconds. </font><font style="vertical-align: inherit;">In addition, any request that required more memory to store intermediate results failed with an OOM error. </font></font><br>
<br>
<code>SELECT COUNT(DISTINCT(field0)) FROM usertable; ‚Äî (10M distinct values)-&gt; SpoolingHashAggregateIterator ran out of memory during new row.</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some numbers for TPC-H requests can be found in Todd Lipcon's article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosql-kudu-spanner-slides.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , slides 42 and 43. These numbers are consistent with our own results (unfortunately).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/c2/sh/dic2sh_wvmvfus16nhrbftomm1g.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Our findings</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given the current state of Cloud Spanner features, it‚Äôs hard to imagine it as a simple replacement for an existing OLTP solution, especially when your needs outgrow it. A significant amount of time would have to be spent building a solution that takes into account Cloud Spanner's flaws. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we started evaluating Cloud Spanner, we expected its management features to be at or at least not so far from other Google SQL solutions. But we were surprised at the complete lack of backups and the very limited control of access to resources. Not to mention the lack of views, the lack of a local development environment, unsupported sequences, JDBC without DML and DDL support, and so on.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, where does the one who needs to scale the transactional database go? It seems that there is no single solution on the market that is suitable for all use cases. There are many closed and open source solutions (some of which are mentioned in this article), each of which has its own strengths and weaknesses, but none of them offers SaaS with a 99.999% SLA and a high degree of consistency. If a high SLA is your primary goal and you are not inclined to create your own solution for multiple cloud environments, Cloud Spanner may be the solution you are looking for. But you must be aware of all its limitations.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fairness, it should be noted that Cloud Spanner was not released to the public only in the spring of 2017, so it is reasonable to expect that some of its current shortcomings may eventually disappear (I hope), and when that happens, it can change the game. After all, Cloud Spanner is not just a third-party project for Google. Google uses it as the basis for other Google products. And when Google recently replaced Megastore in Google Cloud Storage with Cloud Spanner, it allowed Google Cloud Storage to be strictly consistent for object listings globally (which still doesn't apply to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazon‚Äôs </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, there is still hope ... we hope.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all. </font><font style="vertical-align: inherit;">Like the author of the article, we also continue to hope, but what do you think about this? </font><font style="vertical-align: inherit;">Write in the comments. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everyone is invited to visit our </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free webinar,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the framework of which we will talk in detail about the </font><font style="vertical-align: inherit;">OTUS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS for Developers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489000/index.html">How to assemble a cool mitap: 16 tips from three ‚Äúserial mitapers‚Äù. Leader-IT events # 1</a></li>
<li><a href="../en489002/index.html">Distributed wheelset registry: experience with Hyperledger Fabric</a></li>
<li><a href="../en489004/index.html">Cell Phone with Disc Dialer</a></li>
<li><a href="../en489008/index.html">Routing in complex chatbots with the Hobot framework</a></li>
<li><a href="../en489010/index.html">We share the largest in Russia layer of data on online training with projects in linguistics, personalization, peddesign, ML</a></li>
<li><a href="../en489014/index.html">The book ‚ÄúPerfect Algorithm. Greedy Algorithms and Dynamic Programming ¬ª</a></li>
<li><a href="../en489016/index.html">German Gref: ‚ÄúWe tried to organize a discussion about the AGI, and not a single self-respecting scientist came to it‚Äù</a></li>
<li><a href="../en489020/index.html">The study of one malicious</a></li>
<li><a href="../en489022/index.html">Using RabbitMQ with MonsterMQ Part 2</a></li>
<li><a href="../en489024/index.html">Webix JavaScript library through the eyes of a beginner. Part 5. Work with data on the user side</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>