<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèæ üë®üèª‚Äçüîß ü§õüèæ Angular: make the code readable for the back-end. Bonus: swapping APIs and query caching üë£ üé≠ üë∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Very often on a project, the frontend development pace is ahead of the backend development pace. In this situation, two things arise:
 
 

1. the abil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Angular: make the code readable for the back-end. Bonus: swapping APIs and query caching</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501674/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very often on a project, the frontend development pace is ahead of the backend development pace. </font><font style="vertical-align: inherit;">In this situation, two things arise:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the ability to launch the front without a backend, or without separate endpoints;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describe to the back-end what endpoints are needed, the format of the request, response, etc.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I want to share my way of organizing the code responsible for API requests, which perfectly solves these two problems, and also allows you to cache requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the api.config.json configuration file in the project root:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"apiUrl"</span>: <span class="hljs-string">"https://api.example.com"</span>,
  <span class="hljs-attr">"useFakeApiByDefault"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">"fakeEndPoints"</span>: [<span class="hljs-string">"Sample"</span>]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we set the base URL for the API, if the useFakeApiByDefault = true parameter, then our application will use only stubs instead of all requests. </font><font style="vertical-align: inherit;">If false, then stubs will be used only for requests from the fakeEndPoints array. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to import JSON into the code, we add two lines to the CompilerOptions section of the tsconfig.json file:</font></font><br>
<br>
<pre><code class="json hljs">    <span class="hljs-string">"resolveJsonModule"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"esModuleInterop"</span>: <span class="hljs-literal">true</span>,
</code></pre><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the base class BaseEndpoint. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/src/app/api/_base.endpoint.ts:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {ApiMethod, ApiService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../services/api/api.service'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> ApiConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../api.config.json'</span>;
<span class="hljs-keyword">import</span> {ErrorService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../services/error/error.service'</span>;
<span class="hljs-keyword">import</span> {NgModule} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;<font></font>
<font></font>
@NgModule({<span class="hljs-attr">providers</span>: [ApiService, ErrorService]})<font></font>
<font></font>
<span class="hljs-keyword">export</span> abstract <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseEndpoint</span>&lt;<span class="hljs-title">Request</span>, <span class="hljs-title">ResponseModel</span>&gt; </span>{<font></font>
  protected url: string;<font></font>
  protected name: string;<font></font>
  protected method: ApiMethod = ApiMethod.Post;<font></font>
  protected sampleResponse: ResponseModel;<font></font>
  protected cache: boolean = <span class="hljs-literal">false</span>;<font></font>
  protected responseCache: ResponseModel = <span class="hljs-literal">null</span>;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(private api: ApiService, private error: ErrorService) {<font></font>
  }<font></font>
<font></font>
  public execute(request: Request): <span class="hljs-built_in">Promise</span>&lt;ResponseModel&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache &amp;&amp; <span class="hljs-keyword">this</span>.responseCache !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;ResponseModel&gt;<span class="hljs-function">(<span class="hljs-params">(resolve, reject</span>) =&gt;</span> {<font></font>
        resolve(<span class="hljs-keyword">this</span>.responseCache);<font></font>
      });<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (ApiConfig.useFakeApiByDefault || ApiConfig.fakeEndPoints.includes(<span class="hljs-keyword">this</span>.name)) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fake Api Request:: '</span>, <span class="hljs-keyword">this</span>.name, request);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fake Api Response:: '</span>, <span class="hljs-keyword">this</span>.sampleResponse);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;ResponseModel&gt;<span class="hljs-function">(<span class="hljs-params">(resolve</span>) =&gt;</span> resolve(<span class="hljs-keyword">this</span>.sampleResponse));<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;ResponseModel&gt;<span class="hljs-function">(<span class="hljs-params">(resolve, reject</span>) =&gt;</span> {
          <span class="hljs-keyword">this</span>.api.execute(<span class="hljs-keyword">this</span>.url, <span class="hljs-keyword">this</span>.method, request).subscribe(
            <span class="hljs-function">(<span class="hljs-params">response: Response&lt;ResponseModel&gt;</span>) =&gt;</span> {
              <span class="hljs-keyword">if</span> (response.status === <span class="hljs-number">200</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache) { <span class="hljs-keyword">this</span>.responseCache = response.payload; }<font></font>
                resolve(<span class="hljs-keyword">this</span>.payloadMap(response.payload));<font></font>
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.error.emit(response.error);<font></font>
                reject(response.error);<font></font>
              }<font></font>
            }, response =&gt; {<font></font>
              <span class="hljs-keyword">this</span>.error.emit(<span class="hljs-string">'    '</span>)<font></font>
              reject(<span class="hljs-string">'    '</span>));<font></font>
           }<font></font>
        });<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  protected payloadMap(payload: ResponseModel): ResponseModel { <span class="hljs-keyword">return</span> payload; }<font></font>
}<font></font>
<font></font>
abstract <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Response</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
  public status: number;<font></font>
  public error: string;<font></font>
  public payload: T;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;Request, ResponseModel&gt; - types of request and response instances. In response, payload is already pulled out. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not post ApiService and ErrorService classes, so as not to inflate the post, there is nothing special there. ApiService sends http requests, ErrorService allows you to subscribe to errors. To display errors, you need to subscribe to ErrorService in the component where we actually want to display errors (I sign the main layout in which I make a modal or a tooltip). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Magic begins when we inherit from this class. The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
derived </font><font style="vertical-align: inherit;">class will look like this: </font><font style="vertical-align: inherit;">/src/app/api/get-users.endpoint.ts</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {BaseEndpoint} <span class="hljs-keyword">from</span> <span class="hljs-string">'./_base.endpoint'</span>;
<span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> {UserModel} <span class="hljs-keyword">from</span> <span class="hljs-string">'../models/user.model'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetUsersEndpoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseEndpoint</span>&lt;<span class="hljs-title">GetUsersRequest</span>, <span class="hljs-title">UserModel</span>[]&gt; </span>{<font></font>
  protected name = <span class="hljs-string">'GetUsers'</span>;<font></font>
  protected url= <span class="hljs-string">'/getUsers'</span>;<font></font>
  protected sampleResponse = [{<font></font>
      <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Ivan'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">18</span><font></font>
  },<font></font>
  {<font></font>
      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Igor'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">25</span><font></font>
   }<font></font>
<font></font>
  protected payloadMap(payload) {<font></font>
    <span class="hljs-keyword">return</span> payload.map(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-keyword">new</span> UserModel(user));<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetUsersRequest</span> </span>{
   <span class="hljs-attr">page</span>: number;<font></font>
   limit: number;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nothing more, from the contents of the file it is immediately clear which URL, what request format (GetUserRequest), what response format. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If such files are in a separate folder / api, each file corresponds to its own endpoint, I think you can show this folder to the back-end, and theoretically, if you are too lazy to write documentation on api, you can do without it. You can still scatter files inside folders / api into folders according to the controllers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you add 'GetUsers' to the ‚ÄúfakeEndPoints‚Äù array of the config, then there will be no request, and the response will be replaced with stub data from sampleResponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for fake requests to be debugged (in the Network tab, of course, we will not see anything), I provided for the output of the console to output two lines to the console class:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fake Api Request:: '</span>, <span class="hljs-keyword">this</span>.name, request);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fake Api Response:: '</span>, <span class="hljs-keyword">this</span>.sampleResponse);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you override the class property cache = true, then the request will be cached (the first time a request to the API is made, then the result of the first request is always returned). The truth here is to finalize: you need to make caching work only if the request parameters (the contents of an instance of the UserRequest class). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We redefine the payloadMap method if we need any transformations of the data received from the server. If the method is not redefined, then the data from payload will be in the returned Promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we get the data from the API in the component:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Component, OnInit, ViewChild} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> {UserModel} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../models/user.model'</span>;
<span class="hljs-keyword">import</span> {GetUsersEndpoint, GetUsersRequest} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../api/get_users.endpoint'</span>;<font></font>
<font></font>
@Component({<font></font>
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-users'</span>,
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./users.component.html'</span>,
  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./users.component.css'</span>],
  <span class="hljs-attr">providers</span>: [GetUsersEndpoint]<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersComponent</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnInit</span> </span>{<font></font>
<font></font>
  public users: UserModel[];<font></font>
  public request: GetUsersRequest = {<span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">limit</span>: <span class="hljs-number">20</span>};<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(private getUsersEndpoint: GetUsersEndpoint) {    <font></font>
  }<font></font>
<font></font>
  private load() {<font></font>
    <span class="hljs-keyword">this</span>.getUsersEndpoint.execute(<span class="hljs-keyword">this</span>.request).then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-keyword">this</span>.users = data;<font></font>
    });<font></font>
  }<font></font>
<font></font>
  ngOnInit(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">this</span>.load();<font></font>
  }<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such an implementation, it is possible to show the customer the result of completing his Wishlist, even if the backend has not yet been completed for these Wishlist. </font><font style="vertical-align: inherit;">Put the necessary endpoints on the stub - and you can already "touch" the features and get a feedback. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the comments I look forward to constructive criticism of what problems may arise when building functionality, which other pitfalls can come out. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future I want to rewrite this solution from promises to async / await. </font><font style="vertical-align: inherit;">I think the code will be even more elegant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In stock there are several more architectural solutions for Angular, in the near future I plan to share.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501662/index.html">Why Axure could bend Sketch and Figma, but didn't bend</a></li>
<li><a href="../en501664/index.html">Video conferencing is now a market and new technologies. Longrid, part two</a></li>
<li><a href="../en501668/index.html">Providing communications of moving objects and tools to increase its reliability</a></li>
<li><a href="../en501670/index.html">How much is life or $ 2.1 million per injection: a wonderful gene therapy</a></li>
<li><a href="../en501672/index.html">How mods for Unity games are developed. Part 2: writing your mod</a></li>
<li><a href="../en501676/index.html">Compare c # operators?: Vs if-else vs switch</a></li>
<li><a href="../en501678/index.html">Universal GUI ~ = end to misery</a></li>
<li><a href="../en501680/index.html">Some tips on how to speed up the assembly of Docker images. For example, up to 30 seconds</a></li>
<li><a href="../en501684/index.html">Cloister -> easy OTP cluster management</a></li>
<li><a href="../en501688/index.html">Additional SSR performance with Nuxt fullstack server (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>