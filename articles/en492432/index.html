<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüíº üç• üêõ FastText: code recipe üöï üëâüèø üîµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends! I present to you an amateur translation of the original article: FastText: stepping through the code by Maria Mestre. 
 
 A small w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FastText: code recipe</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492432/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good day, friends! I present to you an amateur translation of the original article: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FastText: stepping through the code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by Maria Mestre. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A small warning: some of the information provided may not be completely true due to the passage of time and random errors of the author. In any case, any feedback will be desirable!</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You may have encountered a tool such as FastText to vectorize your body of texts, but did you know that FastText can also deal with their classification? Or maybe they knew, but did he know how he does it? Let's look at it from the inside ... I mean, through the screen.</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The FastText library was primarily developed by the Facebook team to classify texts, but it can also be used to train word embeddings. Since the moment when FastText became a product accessible to everyone (2016), it has been widely used due to its good training speed and excellent performance.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reading the official documentation (very scarce for explanation), I realized that it contains a fairly large part of the algorithms that may not be completely transparent, so it was decided to independently figure out how it all works and what it eats with. I started by reading the main article from the creators and a quick look at the Stanford deep learning course in NLP. In the process of all this pleasure, I only increased questions. For example: that in the course of Stanford's lectures and in one part of the article they talk about the use of N-grams, but they do not say any features in their application. So, the parameters prescribed in the command line include a certain bucket the only comments on which sound like ‚Äúthe number of containers (buckets)‚Äù. How are these N-grams calculated? Bucket? It‚Äôs not clear ... One option remains, watch the code on</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After watching all the good, the following was found out</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> FastText confidently uses N-grams of characters with the same success as N-grams of words.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FastText supports multiclass classification, which may not be so obvious the first time.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of model parameters</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model Introduction</font></font></h4><br>
<img src="https://habrastorage.org/getpro/habr/post_images/1f2/9c1/c4a/1f29c1c4a8cf961b0b1a87bfeb64817f.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to an article written by developers, the model is a simple neural network with one hidden layer. The text represented by the word bag (BOW) is passed through the first layer in which it is transformed into word embeds. Subsequently, the resulting embeddings are averaged over the entire text and reduced to the only one that is applicable throughout the text. In the hidden layer, we work with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_words * dim by the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> number of parameters, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the size of embedding, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_words is the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> size of the dictionary used for text. After averaging, we get one single vector that passes through a rather popular classifier: the </font><i><font style="vertical-align: inherit;">softmax</font></i><font style="vertical-align: inherit;"> function is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for linear mapping (conversion) of the input data of the first layer to the last. </font><font style="vertical-align: inherit;">A matrix of dimension </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dim * n_output</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acts as a linear transformation </font><font style="vertical-align: inherit;">, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_output</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is our number of real classes. </font><font style="vertical-align: inherit;">In the original article, the final probability is considered as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log-likelyhood</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/bda/562/e9f/bda562e9f48277570c5ee94c33cbf6c8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x_n is the representation of a word in n-gram. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And this is a look_up matrix that extracts the embedding of a word.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a linear transformation of the output.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f directly the softmax function itself.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything in general is not so bad, but still let's take a look at the code:</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code as an idea translation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file with the source data that we can apply for our classifier must follow a specific form: __label__0 (text). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As examples: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
__label__cat This thext is about cats. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
__label__dog This text is about dogs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source file is used as an argument to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">starts with the initialization and subsequent filling of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dict_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">FastText::train</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Args args)</span> </span>{<font></font>
  args_ = <span class="hljs-built_in">std</span>::make_shared&lt;Args&gt;(args);<font></font>
  dict_ = <span class="hljs-built_in">std</span>::make_shared&lt;Dictionary&gt;(args_);
  <span class="hljs-keyword">if</span> (args_-&gt;input == <span class="hljs-string">"-"</span>) {
    <span class="hljs-comment">// manage expectations</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::invalid_argument(<span class="hljs-string">"Cannot use stdin for training!"</span>);<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-built_in">std</span>::ifstream <span class="hljs-title">ifs</span><span class="hljs-params">(args_-&gt;input)</span></span>;
  <span class="hljs-keyword">if</span> (!ifs.is_open()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::invalid_argument(<font></font>
        args_-&gt;input + <span class="hljs-string">" cannot be opened for training!"</span>);<font></font>
  }<font></font>
  dict_-&gt;readFromFile(ifs);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dict_ is an instance of the Dictionary class.</font></font><br>
<br>
<pre><code class="cpp hljs">
Dictionary::Dictionary(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Args&gt; args) : args_(args),<font></font>
  word2int_(MAX_VOCAB_SIZE, <span class="hljs-number">-1</span>), size_(<span class="hljs-number">0</span>), nwords_(<span class="hljs-number">0</span>), nlabels_(<span class="hljs-number">0</span>),<font></font>
  ntokens_(<span class="hljs-number">0</span>), pruneidx_size_(<span class="hljs-number">-1</span>) {}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After reading and parsing the sentences of the source file, we fill two vectors:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> words_ containing unique words extracted from text</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">word2int_ containing hashes for each word according to its position in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">words_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is actually very important, as it determines which will be used to search for embeddings of matrix A</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">words_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><font style="vertical-align: inherit;">contains instances of entry. </font><font style="vertical-align: inherit;">Each of which can be a word type for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">label</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and have a counter of calls to them. </font><font style="vertical-align: inherit;">There is also a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subwords</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">, but we will look at it a bit further.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">entry</span> {</span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> word;
  <span class="hljs-keyword">int64_t</span> count;<font></font>
  entry_type type;<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt; subwords;<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By adding words or tags to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">word2int_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable, collisions are necessarily resolved in such a way that we never refer to two different words that have the same index. </font><font style="vertical-align: inherit;">There simply won't be any.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int32_t</span> <span class="hljs-title">Dictionary::find</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; w, <span class="hljs-keyword">uint32_t</span> h)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">int32_t</span> word2intsize = word2int_.size();
  <span class="hljs-keyword">int32_t</span> id = h % word2intsize;
  <span class="hljs-keyword">while</span> (word2int_[id] != <span class="hljs-number">-1</span> &amp;&amp; words_[word2int_[id]].word != w) {<font></font>
    id = (id + <span class="hljs-number">1</span>) % word2intsize;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> id;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int32_t</span> <span class="hljs-title">Dictionary::find</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; w)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">return</span> find(w, hash(w));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::add</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; w)</span> </span>{
  <span class="hljs-keyword">int32_t</span> h = find(w);<font></font>
  ntokens_++;<font></font>
  <span class="hljs-keyword">if</span> (word2int_[h] == <span class="hljs-number">-1</span>) {<font></font>
    entry e;<font></font>
    e.word = w;<font></font>
    e.count = <span class="hljs-number">1</span>;<font></font>
    e.type = getType(w);<font></font>
    words_.push_back(e);<font></font>
    word2int_[h] = size_++;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    words_[word2int_[h]].count++;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Both vectors are filtered to ensure that words and tags that are mentioned at least once are included. After we move on to the part where we use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readFromFile</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initNgrams</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font><i><font style="vertical-align: inherit;">called</font></i><font style="vertical-align: inherit;"> . We almost got to the mystic of using N-grams.</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::readFromFile</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::istream&amp; in)</span> </span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> word;
  <span class="hljs-keyword">int64_t</span> minThreshold = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (readWord(in, word)) {<font></font>
    add(word);<font></font>
    <span class="hljs-keyword">if</span> (ntokens_ % <span class="hljs-number">1000000</span> == <span class="hljs-number">0</span> &amp;&amp; args_-&gt;verbose &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"\rRead "</span> &lt;&lt; ntokens_  / <span class="hljs-number">1000000</span> &lt;&lt; <span class="hljs-string">"M words"</span> &lt;&lt; <span class="hljs-built_in">std</span>::flush;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (size_ &gt; <span class="hljs-number">0.75</span> * MAX_VOCAB_SIZE) {<font></font>
      minThreshold++;<font></font>
      threshold(minThreshold, minThreshold);<font></font>
    }<font></font>
  }<font></font>
  threshold(args_-&gt;minCount, args_-&gt;minCountLabel);<font></font>
  initTableDiscard();<font></font>
  initNgrams();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initNgrams</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">defines all combinations of N-gram characters and adds them to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ngram</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the end, all the hashes for N-grams are calculated and added up in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ngram</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><font style="vertical-align: inherit;">, forming the size of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In other words, hashes of N-gram characters are added after adding hashes of N-gram words. </font><font style="vertical-align: inherit;">As a result, their indices do not overlap with the indices of words, but can overlap with each other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, for each word in the text, you can provide </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subwords</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... N-grams of characters. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embedding matrix A displays the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The initial nwords_ lines containing embeddings for each word from the dictionary available for the text.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Follow the bucket of lines containing embeddings for each N-gram of characters</font></font></li>
</ul> <br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::initNgrams</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; size_; i++) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> word = BOW + words_[i].word + EOW;<font></font>
    words_[i].subwords.clear();<font></font>
    words_[i].subwords.push_back(i);<font></font>
    <span class="hljs-keyword">if</span> (words_[i].word != EOS) {<font></font>
      computeSubwords(word, words_[i].subwords);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::computeSubwords</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; word,
                               <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; ngrams)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; word.size(); i++) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> ngram;
    <span class="hljs-keyword">if</span> ((word[i] &amp; <span class="hljs-number">0xC0</span>) == <span class="hljs-number">0x80</span>) <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = i, n = <span class="hljs-number">1</span>; j &lt; word.size() &amp;&amp; n &lt;= args_-&gt;maxn; n++) {<font></font>
      ngram.push_back(word[j++]);<font></font>
      <span class="hljs-keyword">while</span> (j &lt; word.size() &amp;&amp; (word[j] &amp; <span class="hljs-number">0xC0</span>) == <span class="hljs-number">0x80</span>) {<font></font>
        ngram.push_back(word[j++]);<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (n &gt;= args_-&gt;minn &amp;&amp; !(n == <span class="hljs-number">1</span> &amp;&amp; (i == <span class="hljs-number">0</span> || j == word.size()))) {
        <span class="hljs-keyword">int32_t</span> h = hash(ngram) % args_-&gt;bucket;<font></font>
        pushHash(ngrams, h);<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::pushHash</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; hashes, <span class="hljs-keyword">int32_t</span> id)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">if</span> (pruneidx_size_ == <span class="hljs-number">0</span> || id &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (pruneidx_size_ &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (pruneidx_.count(id)) {<font></font>
      id = pruneidx_.at(id);<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
  }<font></font>
  hashes.push_back(nwords_ + id);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we guessed the mystical N-gram characters. Now let's deal with N-grams of words. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returning to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, the following instructions are executed:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> (args_-&gt;pretrainedVectors.size() != <span class="hljs-number">0</span>) {<font></font>
    loadVectors(args_-&gt;pretrainedVectors);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    input_ = <span class="hljs-built_in">std</span>::make_shared&lt;Matrix&gt;(dict_-&gt;nwords()+args_-&gt;bucket, args_-&gt;dim);<font></font>
    input_-&gt;uniform(<span class="hljs-number">1.0</span> / args_-&gt;dim);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::sup) {<font></font>
    output_ = <span class="hljs-built_in">std</span>::make_shared&lt;Matrix&gt;(dict_-&gt;nlabels(), args_-&gt;dim);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    output_ = <span class="hljs-built_in">std</span>::make_shared&lt;Matrix&gt;(dict_-&gt;nwords(), args_-&gt;dim);<font></font>
  }<font></font>
  output_-&gt;zero();<font></font>
  startThreads();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is where the embedding matrix A is initialized. It must be pointed out that if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pretrainedVectors</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> work with this function, then this variable is considered full. If this does not happen, then the matrix is ‚Äã‚Äãinitialized with random numbers </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-1 / dim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 / dim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the size of our embedding. Dimension of matrix A ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_words_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), i.e. we are going to set up all these embeddings for each word. The output is also initialized in this step. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the part where we begin training our model.</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">FastText::trainThread</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> threadId)</span> </span>{
  <span class="hljs-function"><span class="hljs-built_in">std</span>::ifstream <span class="hljs-title">ifs</span><span class="hljs-params">(args_-&gt;input)</span></span>;<font></font>
  utils::seek(ifs, threadId * utils::size(ifs) / args_-&gt;thread);<font></font>
<font></font>
  <span class="hljs-function">Model <span class="hljs-title">model</span><span class="hljs-params">(input_, output_, args_, threadId)</span></span>;
  <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::sup) {<font></font>
    model.setTargetCounts(dict_-&gt;getCounts(entry_type::label));<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    model.setTargetCounts(dict_-&gt;getCounts(entry_type::word));<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">int64_t</span> ntokens = dict_-&gt;ntokens();
  <span class="hljs-keyword">int64_t</span> localTokenCount = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt; line, labels;
  <span class="hljs-keyword">while</span> (tokenCount_ &lt; args_-&gt;epoch * ntokens) {<font></font>
    real progress = real(tokenCount_) / (args_-&gt;epoch * ntokens);<font></font>
    real lr = args_-&gt;lr * (<span class="hljs-number">1.0</span> - progress);
    <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::sup) {<font></font>
      localTokenCount += dict_-&gt;getLine(ifs, line, labels);<font></font>
      supervised(model, lr, line, labels);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::cbow) {<font></font>
      localTokenCount += dict_-&gt;getLine(ifs, line, model.rng);<font></font>
      cbow(model, lr, line);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::sg) {<font></font>
      localTokenCount += dict_-&gt;getLine(ifs, line, model.rng);<font></font>
      skipgram(model, lr, line);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (localTokenCount &gt; args_-&gt;lrUpdateRate) {<font></font>
      tokenCount_ += localTokenCount;<font></font>
      localTokenCount = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (threadId == <span class="hljs-number">0</span> &amp;&amp; args_-&gt;verbose &gt; <span class="hljs-number">1</span>)<font></font>
        loss_ = model.getLoss();<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (threadId == <span class="hljs-number">0</span>)<font></font>
    loss_ = model.getLoss();<font></font>
  ifs.close();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two main points in this part of the code. </font><font style="vertical-align: inherit;">First, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getLine</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">calls the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dict_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Second, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supervised</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is called </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int32_t</span> <span class="hljs-title">Dictionary::getLine</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::istream&amp; in,
                            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; words,
                            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; labels)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt; word_hashes;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> token;
  <span class="hljs-keyword">int32_t</span> ntokens = <span class="hljs-number">0</span>;<font></font>
<font></font>
  reset(in);<font></font>
  words.clear();<font></font>
  labels.clear();<font></font>
  <span class="hljs-keyword">while</span> (readWord(in, token)) {
    <span class="hljs-keyword">uint32_t</span> h = hash(token);
    <span class="hljs-keyword">int32_t</span> wid = getId(token, h);<font></font>
    entry_type type = wid &lt; <span class="hljs-number">0</span> ? getType(token) : getType(wid);<font></font>
<font></font>
    ntokens++;<font></font>
    <span class="hljs-keyword">if</span> (type == entry_type::word) {<font></font>
      addSubwords(words, token, wid);<font></font>
      word_hashes.push_back(h);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == entry_type::label &amp;&amp; wid &gt;= <span class="hljs-number">0</span>) {<font></font>
      labels.push_back(wid - nwords_);<font></font>
    }&lt;source lang=<span class="hljs-string">"cpp"</span>&gt;
    <span class="hljs-keyword">if</span> (token == EOS) <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  addWordNgrams(words, word_hashes, args_-&gt;wordNgrams);<font></font>
  <span class="hljs-keyword">return</span> ntokens;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the function above, we read the texts from the input data, determine the indices for each word one after another by using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">word2int_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We add the N-grams that make up these words to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">words</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">, as indicated in the code. </font><font style="vertical-align: inherit;">And in the end, we add labels directly to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">labels</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After fully reading and adding text (sentences from the corpus) directly to the vectors created for them, we get a part of the code that processes N-grams. </font><font style="vertical-align: inherit;">This is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addWordNgrams</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dictionary::addWordNgrams</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; line,
                               <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; hashes,
                               <span class="hljs-keyword">int32_t</span> n)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; hashes.size(); i++) {
    <span class="hljs-keyword">uint64_t</span> h = hashes[i];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> j = i + <span class="hljs-number">1</span>; j &lt; hashes.size() &amp;&amp; j &lt; i + n; j++) {<font></font>
      h = h * <span class="hljs-number">116049371</span> + hashes[j];<font></font>
      pushHash(line, h % args_-&gt;bucket);<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look further. The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hashes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">is a set of hashes for each word in the text, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">line</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains the number of words in the sentence and the number of N-grams used. The parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wordNgrams</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and indicates the maximum length of the N-grams of words. Each N-gram of words gets its own hash calculated by a recursive formula</font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>h</mi><mo>=</mo><mi>h</mi><mo>&amp;#x2217;</mo><mn>116049371</mn><mo>+</mo><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy=&quot;false&quot;>[</mo><mi>j</mi><mo stretchy=&quot;false&quot;>]</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="30.698ex" height="2.634ex" viewBox="0 -809.3 13216.9 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-68" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-3D" x="854" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-68" x="1910" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2217" x="2709" y="0"></use><g transform="translate(3432,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-31" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-36" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-34" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-39" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-33" x="3003" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-37" x="3503" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-31" x="4004" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2B" x="8158" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-68" x="9159" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-61" x="9735" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-73" x="10265" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-68" x="10734" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-65" x="11311" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-73" x="11777" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-5B" x="12247" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMATHI-6A" x="12525" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-5D" x="12938" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>h</mi><mo>=</mo><mi>h</mi><mo>‚àó</mo><mn>116049371</mn><mo>+</mo><mi>h</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1">h = h*116049371+hashes[j]</script></p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This formula is an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FNV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hash </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">algorithm</font></a><font style="vertical-align: inherit;"> applied to a string: it takes the hash of each word in the N-gram of words and adds them. </font><font style="vertical-align: inherit;">Thus, a set of unique hashes is obtained. </font><font style="vertical-align: inherit;">As a result, this value (can turn out to be quite large) is transmitted modulo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, N-grams of words are calculated approximately in the same way as N-grams of characters, but with a slight difference - we do not hash a specific word. </font><font style="vertical-align: inherit;">Amazing move. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After reading the sentence, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supervised</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is called </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the offer has several tags, we randomly select one of them.</font></font><br>
 <br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">FastText::supervised</span><span class="hljs-params">(
    Model&amp; model,
    real lr,
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; line,
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; labels)</span> </span>{
  <span class="hljs-keyword">if</span> (labels.size() == <span class="hljs-number">0</span> || line.size() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-function"><span class="hljs-built_in">std</span>::uniform_int_distribution&lt;&gt; <span class="hljs-title">uniform</span><span class="hljs-params">(<span class="hljs-number">0</span>, labels.size() - <span class="hljs-number">1</span>)</span></span>;
  <span class="hljs-keyword">int32_t</span> i = uniform(model.rng);<font></font>
  model.update(line, labels[i], lr);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, the model update function.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Model::computeHidden</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; input, Vector&amp; hidden)</span> <span class="hljs-keyword">const</span> </span>{<font></font>
  assert(hidden.size() == hsz_);<font></font>
  hidden.zero();<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = input.cbegin(); it != input.cend(); ++it) {
    <span class="hljs-keyword">if</span>(quant_) {<font></font>
      hidden.addRow(*qwi_, *it);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      hidden.addRow(*wi_, *it);<font></font>
    }<font></font>
  }<font></font>
  hidden.mul(<span class="hljs-number">1.0</span> / input.size());<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Model::update</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int32_t</span>&gt;&amp; input, <span class="hljs-keyword">int32_t</span> target, real lr)</span> </span>{<font></font>
  assert(target &gt;= <span class="hljs-number">0</span>);<font></font>
  assert(target &lt; osz_);<font></font>
  <span class="hljs-keyword">if</span> (input.size() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
  computeHidden(input, hidden_);<font></font>
  <span class="hljs-keyword">if</span> (args_-&gt;loss == loss_name::ns) {<font></font>
    loss_ += negativeSampling(target, lr);<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args_-&gt;loss == loss_name::hs) {<font></font>
    loss_ += hierarchicalSoftmax(target, lr);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    loss_ += softmax(target, lr);<font></font>
  }<font></font>
  nexamples_ += <span class="hljs-number">1</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (args_-&gt;model == model_name::sup) {<font></font>
    grad_.mul(<span class="hljs-number">1.0</span> / input.size());<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = input.cbegin(); it != input.cend(); ++it) {<font></font>
    wi_-&gt;addRow(grad_, *it, <span class="hljs-number">1.0</span>);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Input variables passing through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supervised</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">have a list of indices of all their components (words, N-grams of words and symbols) of the sentence. The goal is to define a class on the output. The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">computeHidden</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">determines all embeddings for each component of the input by searching for them in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wi_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> matrix </font><font style="vertical-align: inherit;">and averaging ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addRow</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font><font style="vertical-align: inherit;">summed </font><font style="vertical-align: inherit;">and divided by their size). After modifying the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hidden_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vector </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> send them for activation via </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">softmax</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and define a label. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This section of code shows the use of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">softmax</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> activation </font><i><font style="vertical-align: inherit;">function</font></i><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log-loss is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also calculated </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Model::computeOutputSoftmax</span><span class="hljs-params">(Vector&amp; hidden, Vector&amp; output)</span> <span class="hljs-keyword">const</span> </span>{
  <span class="hljs-keyword">if</span> (quant_ &amp;&amp; args_-&gt;qout) {<font></font>
    output.mul(*qwo_, hidden);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    output.mul(*wo_, hidden);<font></font>
  }<font></font>
  real max = output[<span class="hljs-number">0</span>], z = <span class="hljs-number">0.0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; osz_; i++) {<font></font>
    max = <span class="hljs-built_in">std</span>::max(output[i], max);<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; osz_; i++) {<font></font>
    output[i] = <span class="hljs-built_in">exp</span>(output[i] - max);<font></font>
    z += output[i];<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; osz_; i++) {<font></font>
    output[i] /= z;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Model::computeOutputSoftmax</span><span class="hljs-params">()</span> </span>{<font></font>
  computeOutputSoftmax(hidden_, output_);<font></font>
}<font></font>
<font></font>
<span class="hljs-function">real <span class="hljs-title">Model::softmax</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> target, real lr)</span> </span>{<font></font>
  grad_.zero();<font></font>
  computeOutputSoftmax();<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; osz_; i++) {<font></font>
    real label = (i == target) ? <span class="hljs-number">1.0</span> : <span class="hljs-number">0.0</span>;<font></font>
    real alpha = lr * (label - output_[i]);<font></font>
    grad_.addRow(*wo_, i, alpha);<font></font>
    wo_-&gt;addRow(hidden_, i, alpha);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> -<span class="hljs-built_in">log</span>(output_[target]);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using this method, we will not get an increase in the size of N-grams of words and characters. </font><font style="vertical-align: inherit;">Growth is limited by the number of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buckets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> already available </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, FastText does not use N-grams, but we recommend the following options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucker = 2,000,000; </font><font style="vertical-align: inherit;">wordNgrams&gt; 1 or maxn&gt; 0</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dim = 100</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_output = 2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n_words = 500000</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In total, we get a fairly large number of parameters for training </font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mo stretchy=&quot;false&quot;>(</mo><mn>5000000</mn><mo>+</mo><mn>2000000</mn><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2217;</mo><mn>100</mn><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mn>2</mn><mo>&amp;#x2217;</mo><mn>100</mn><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mn>250</mn><mo>,</mo><mn>000</mn><mo>,</mo><mn>000</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="53.729ex" height="2.634ex" viewBox="0 -809.3 23133.2 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-35"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="3003" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2B" x="4115" y="0"></use><g transform="translate(5115,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="3003" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-29" x="8619" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2217" x="9231" y="0"></use><g transform="translate(9953,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2B" x="11677" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-28" x="12678" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-32" x="13067" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2217" x="13790" y="0"></use><g transform="translate(14513,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-29" x="16014" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-3D" x="16682" y="0"></use><g transform="translate(17738,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2C" x="19239" y="0"></use><g transform="translate(19685,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-2C" x="21186" y="0"></use><g transform="translate(21631,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/492432/&amp;usg=ALkJrhiLsPZqAFQ7c_gn77rwouP_s_Y5bQ#MJMAIN-30" x="1001" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mo stretchy="false">(</mo><mn>5000000</mn><mo>+</mo><mn>2000000</mn><mo stretchy="false">)</mo><mo>‚àó</mo><mn>100</mn><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><mo>‚àó</mo><mn>100</mn><mo stretchy="false">)</mo><mo>=</mo><mn>250</mn><mo>,</mo><mn>000</mn><mo>,</mo><mn>000</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-2">(5000000+2000000)*100+(2*100) = 250,000,000</script></p> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Too much, isn't it?) As we can see even through such a simple approach, we have a fairly large number of parameters, which is very typical of deep learning methods. </font><font style="vertical-align: inherit;">A very rough estimate is used, for example, the number of N-grams taken for 2_000_000, in order to show order. </font><font style="vertical-align: inherit;">In general, the complexity of the model can be reduced by tuning some hyperparameters, such as a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or the sampling threshold. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some links may be useful: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">research.fb.com/fasttext </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arxiv.org/pdf/1607.01759.pdf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arxiv.org/pdf/1607.04606v1.pdf </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.youtube.com/watch?v=isPiE-DBagM&amp;index=5&amp;list=PLU40WL8Ol94IJzQtileLTqGL_XtG</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (from 47:39)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492414/index.html">NSI system anatomy</a></li>
<li><a href="../en492420/index.html">Wechat or a truly comprehensive application. What can a developer do with it</a></li>
<li><a href="../en492422/index.html">Escobar Fold 2 - The Scam Continues</a></li>
<li><a href="../en492424/index.html">Angular: another way to unsubscribe</a></li>
<li><a href="../en492426/index.html">How to bypass mines of information technology</a></li>
<li><a href="../en492436/index.html">Animated protein anchor link</a></li>
<li><a href="../en492438/index.html">Reddit PC gamers pool their computing power around the Folding @ Home project to fight COVID-19</a></li>
<li><a href="../en492440/index.html">FOSS News No. 7 - a review of free and open source news for March 9-15, 2020</a></li>
<li><a href="../en492444/index.html">News from the world of OpenStreetMap No. 502 (02.25.2020-02.03.2020)</a></li>
<li><a href="../en492446/index.html">Russian developers presented two exoskeletons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>