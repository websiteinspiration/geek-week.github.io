<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßú üç≥ ‚òÑÔ∏è Interesting tricks and SSH tricks üè∑Ô∏è üëêüèª ‚úäüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some tips on using SSH efficiently. Let's talk about how:
 
 

- Use two-factor authentication for SSH connections
- it is safe to use "key forwarding...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Interesting tricks and SSH tricks</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502728/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some tips on using SSH efficiently. </font><font style="vertical-align: inherit;">Let's talk about how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use two-factor authentication for SSH connections</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is safe to use "key forwarding" (agent forwarding);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit a hung SSH session;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leave the terminal open when you exit or disconnect;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Share the remote terminal with a friend (without Zoom!).</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ib/ip/2b/ibip2baduhanlunu57eepm5ff3w.jpeg" alt="image"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSH multi-factor authentication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are five ways to add a second factor for authentication in SSH:</font></font><br>
<br>
<ol>
<li> <b> OpenSSH</b>     ( ). <br>
<br>
  2020   OpenSSH    FIDO U2F (Universal Second Factor).    ,   .<br>
<br>
          ,             8.2   .       <b><code>ssh -V</code></b>,      <b><code>nc [servername] 22</code></b>.<br>
<br>
       ‚Äî <b><code>ecdsa-sk</code></b>  <b><code>ed25519-sk</code></b> (   ).             <b><code>$ ssh-keygen -t ecdsa-sk -f ~/.ssh/id_ecdsa_sk</code></b>.       ,    U2F .    U2F       ,   .<br>
<br>
          . OpenSSH        -sk-¬´¬ª .        U2F .  ,       .      <b><code>$ ssh-keygen -t ecdsa-sk -O resident -f ~/.ssh/id_ecdsa_sk</code></b>.       ,        <b><code> $ ssh-add -K</code></b>.       .</li>
<li> <b> PIV+PKCS11  Yubikey.</b>      ,      SSH-,      .  Yubikey  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> U2F+SSH with PIV/PKCS11</a>.     ,     FIDO U2F.   ,  .</li>
<li> <b> ssh- <code>yubikey-agent.</code></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Filippo Valsorda</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">SSH-  Yubikeys</a>.         .</li>
<li> <b> Touch ID  <code>sekey</code>.</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Sekey</a> ‚Äî  SSH-    ,       secure enclave  MacOS       Touch ID.</li>
<li> <b> Single Sign On SSH.</b>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>  .  Single Sign On SSH   ,          ,    .</li>
</ol><br>
<br>
<h2>    (agent forwarding)</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Forwarding a key in SSH gives the remote host access to your local SSH agent. When your SSH client uses key forwarding (usually activated by the option </font></font><b><code>ssh -A</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), there are 2 channels in the connection - your interactive session and the key forwarding channel. The local SSH agent creates an IPC socket that connects to the remote host through this channel. This is dangerous because A user with root privileges on a remote host has access to your local SSH agent and can potentially use it to access network resources on your behalf. With the standard SSH agent that ships with OpenSSH, you never know what happened. But if you use a U2F key (or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekey</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), you can stop any attempts to use your SSH agent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even with this limitation, periodic use of key forwarding is perfectly acceptable. </font><font style="vertical-align: inherit;">Do not use this method for all of your connections. </font><font style="vertical-align: inherit;">Use only if you are sure of its need in specific situations.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exiting a Hanging SSH Session</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSH sessions often freeze due to network outages, loss of control by an executable program or one of the terminal control sequences that block keyboard input. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are some ways to get out of a hung session:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatic exit when the network breaks. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In your SSH configuration, </font></font><code><b>.ssh/config</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you need to add: it </font><font style="vertical-align: inherit;">will check the connection by sending echo requests to the remote host every </font><font style="vertical-align: inherit;">second. </font><font style="vertical-align: inherit;">If more than </font><font style="vertical-align: inherit;">such requests go unanswered, then SSH will close the connection.</font></font><br>
<br>
<code><b>ServerAliveInterval 5<br>
ServerAliveCountMax 1<br>
</b></code><br>
<br>
<code><b>ssh</b></code><font style="vertical-align: inherit;"></font><code><b>ServerAliveInterval</b></code><font style="vertical-align: inherit;"></font><code><b>ServerAliveCountMax</b></code><font style="vertical-align: inherit;"></font></li>
<li><b> .</b> <code><b>ssh</b></code>   <code><b>~</b></code>     .  <code><b>~.</b></code>        (       ).<br>
<br>
 <code><b>~?</b></code>   ,      .       ,      <code><b>~</b></code> ,    .</li>
</ol><br>
<b>  ?</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the Internet was invented, computers were not particularly mobile. When you work on a laptop and switch between IPv4 WiFi networks, your IP address changes. Since SSH is based on a TCP connection, and TCP connections depend on connection points with fixed IP addresses, each time you connect to another network, your SSH connection is lost. When your IP address changes, it takes some time before the network stack detects that the connection is lost. A TCP connection does not imply a quick shutdown of one of the parties in case of network problems, so it will try to retry sending the data for some more time. In your terminal, the session will look stuck. IPv6 adds functionality that allows devices to maintain their IP address when switching between networks.So someday this will cease to be a problem.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to leave a terminal open on a remote host</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two options for saving a session when you switch between networks or want to disconnect for a while:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mosh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eternal Terminal</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If you really need a connection that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not crash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , even if you switch between networks, use the Mosh - mobile shell. </font><font style="vertical-align: inherit;">Mosh is a secure shell that uses SSH to initialize a session (handshake), after which it switches to its own encrypted channel. </font><font style="vertical-align: inherit;">This channel is very stable. </font><font style="vertical-align: inherit;">It can handle various situations, including disconnections from the Internet, changing the IP address of your laptop, large delays when transmitting over the network, and others. </font><font style="vertical-align: inherit;">Thanks to the magic of UDP and the synchronization protocol used by Mosh.</font></font><br>
<br>
  Mosh       ,          60000‚Äì61000   UDP     .     mosh user@server  .<br>
<br>
Mosh        ,          SSH,      -    .          ,        . SSH        ,  ,  Mosh             .</li>
<li><b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">tmux</a>.</b>      ,           ,    tmux.   SSH- ,      <code><b>tmux attach</b></code>,     <code><b>tmux</b></code>.        ‚Äî    ,      macOS       .<br>
<br>
  tmux   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Byobu</a> ‚Äî ,        . Byobu    Ubuntu      macOS    Homebrew.</li>
</ol><br>
<br>
<h2>     </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you solve a complex problem with servers, I would like to share an SSH session with someone else who is in another place. </font><font style="vertical-align: inherit;">tmux is the best sharing terminal tool. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you need to do the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure that it is </font></font><code><b>tmux</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installed on your server in DMZ (or where you want to connect).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both of you need to connect to the server via SSH </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the same account</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of you must run </font></font><code><b>tmux</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to create a </font></font><code><b>tmux</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">session.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another must execute the command </font></font><code><b>tmux attach</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voila! </font><font style="vertical-align: inherit;">You have shared the terminal.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need more fine-tuning of multi-user sessions, use tmate, this fork </font></font><code><b>tmux</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which allows you to make shared sessions even easier. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translated by Andrey Zinchenko, Head of Rexoft Analytics Department</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502716/index.html">Can't share your home computer? Make one out of two</a></li>
<li><a href="../en502718/index.html">The Talking Head project, or the history of developing software for a telepresence robot</a></li>
<li><a href="../en502720/index.html">Testing Trends to Look At in 2020</a></li>
<li><a href="../en502722/index.html">Silicon Valley in Russian. How # ITX5 works in Innopolis</a></li>
<li><a href="../en502726/index.html">WebRTC Making an application with blackjack and video calls</a></li>
<li><a href="../en502730/index.html">What do industrial designers know about the devices you use every day. Or 50 years of transforming a computer mouse</a></li>
<li><a href="../en502732/index.html">Book ‚ÄúHow to test on Google‚Äù - free electronic version</a></li>
<li><a href="../en502734/index.html">Ack better grep</a></li>
<li><a href="../en502740/index.html">How to disinfect aircraft in the era of covid-19?</a></li>
<li><a href="../en502742/index.html">We invite you to DINS DevOps EVENING (online): the evolution of Prometheus and Zabbix and the processing of Nginx logs in ClickHouse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>