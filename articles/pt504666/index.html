<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ• ğŸ‘¨ğŸ¾â€âš–ï¸ ğŸ³ï¸ DEVOXX UK. Kubernetes em produÃ§Ã£o: implantaÃ§Ã£o azul / verde, dimensionamento automÃ¡tico e automaÃ§Ã£o de implantaÃ§Ã£o. Parte 1 ğŸ‘ğŸ¼ ğŸ¤¶ğŸ¿ ğŸ¤¯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Kubernetes Ã© uma Ã³tima ferramenta para executar contÃªineres do Docker em um ambiente de produÃ§Ã£o em cluster. No entanto, existem tarefas que o Kuber...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DEVOXX UK. Kubernetes em produÃ§Ã£o: implantaÃ§Ã£o azul / verde, dimensionamento automÃ¡tico e automaÃ§Ã£o de implantaÃ§Ã£o. Parte 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504666/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Kubernetes Ã© uma Ã³tima ferramenta para executar contÃªineres do Docker em um ambiente de produÃ§Ã£o em cluster. No entanto, existem tarefas que o Kubernetes nÃ£o consegue resolver. Ao implantar com frequÃªncia em um ambiente de produÃ§Ã£o, precisamos de uma implantaÃ§Ã£o azul / verde totalmente automatizada para evitar o tempo de inatividade nesse processo, que tambÃ©m requer solicitaÃ§Ãµes HTTP externas e upload de SSL. Isso requer integraÃ§Ã£o com um balanceador de carga, como ha-proxy. Outra tarefa Ã© o dimensionamento semiautomÃ¡tico do prÃ³prio cluster Kubernetes ao trabalhar na nuvem, por exemplo, reduÃ§Ã£o parcial da escala do cluster Ã  noite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o Kubernetes nÃ£o tenha esses recursos prontos para uso, ele fornece uma API que pode ser usada para resolver esses problemas. As ferramentas de implantaÃ§Ã£o e escala automatizadas azul / verde do cluster Kubernetes foram desenvolvidas como parte do projeto de cÃ³digo aberto Cloud RTI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta transcriÃ§Ã£o de vÃ­deo descreve como configurar o Kubernetes junto com outros componentes de cÃ³digo-fonte aberto para obter um ambiente pronto para produÃ§Ã£o que aceita cÃ³digo da confirmaÃ§Ã£o de alteraÃ§Ã£o de confirmaÃ§Ã£o do git sem tempo de inatividade na produÃ§Ã£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/4y/jm/cy4yjm9zwmpfpvtfwhwfigavpkw.jpeg"><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje falaremos sobre o Kubernetes, em particular, sobre sua automaÃ§Ã£o. Vamos dar uma olhada no bÃ¡sico deste sistema e depois seguiremos como integrar o Kubernetes em projetos na fase de desenvolvimento. Meu nome Ã© Paul, sou da Holanda, trabalho para uma empresa chamada Luminis Technologies e sou o autor dos livros "Designing Cloud Applications with OSGi" e "Modulating Java 9". O que vou falar Ã© muito diferente do tema desses livros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Ãºltimo ano, passei a maior parte do tempo trabalhando em uma plataforma de infraestrutura baseada no Kubernetes e criando ferramentas para ele, principalmente no Golang. AlÃ©m disso, continuo trabalhando no livro Java 9. Meu hobby Ã© o levantamento de peso. EntÃ£o, vamos ao que interessa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que cuidar do Kubernetes? Primeiro de tudo, porque ele permite executar o Docker em clusters. Se vocÃª nÃ£o usa o Docker, nÃ£o estÃ¡ no assunto. Se vocÃª trabalha com o Docker, sabe que ele foi projetado principalmente para executar contÃªineres em sua prÃ³pria mÃ¡quina. Ele melhora o trabalho com muitas redes, no entanto, tudo isso Ã© limitado a uma mÃ¡quina, portanto nÃ£o hÃ¡ como executar contÃªineres em um cluster. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-j/vz/o4/-jvzo4f26dwscphdsorfnczffik.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os criadores do Docker estÃ£o constantemente expandindo seus recursos, mas se vocÃª realmente precisar executar contÃªineres na produÃ§Ã£o, precisarÃ¡ de algo como o Kubernetes, porque o Docker com sua linha de comando nÃ£o ajudarÃ¡.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos falar sobre o bÃ¡sico do Kubernetes. Antes de analisarmos o uso da API para automaÃ§Ã£o, precisamos entender o conceito de como essa plataforma funciona. Um cluster tÃ­pico inclui os seguintes elementos. O nÃ³ principal gerencia e controla a operaÃ§Ã£o de todo o cluster e decide onde os contÃªineres serÃ£o planejados e como serÃ£o lanÃ§ados. Ele lanÃ§a o servidor da API, que Ã© o elemento mais importante do trabalho da plataforma. Mais tarde, consideraremos esse problema em detalhes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/rr/af/vvrraf7malypw8vgucqll1-p3ec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HÃ¡ vÃ¡rios nÃ³s de trabalho do Node que contÃªm pods de pods com contÃªineres do Docker e etcd de armazenamento distribuÃ­do. NÃ³s Ã© o local onde seus contÃªineres serÃ£o executados. O Kubernetes nÃ£o funciona diretamente com contÃªineres do Docker, mas usa uma abstraÃ§Ã£o chamada Pod para isso. NÃ³s de trabalho iniciam vÃ¡rios contÃªineres e o nÃ³ Mestre garante que eles funcionem. AlÃ©m disso, hÃ¡ um armazenamento etcd do tipo keyd-value distribuÃ­do, que armazena todas as informaÃ§Ãµes sobre o cluster. O etcd Ã© tolerante a falhas; portanto, pelo menos consiste em 3 nÃ³s independentes. Isso garante que o assistente funcione sem perder o estado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ApÃ³s iniciar o Kubernetes com todos os componentes acima, os contÃªineres de agendamento sÃ£o implantados. ImplantaÃ§Ã£o significa que os contÃªineres comeÃ§am a trabalhar em um cluster. Para fazer isso, primeiro de tudo, vocÃª precisa de um objeto chamado Replication Controller, iniciado no servidor mestre, que permite criar e monitorar o status de vÃ¡rias instÃ¢ncias de lareiras.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u-/to/g0/u-tog08sgexmcjn4mn8hkuxdo7s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para configurar o controlador de replicaÃ§Ã£o para criar, por exemplo, 5 rÃ©plicas de contÃªineres em cinco nÃ³s de trabalho diferentes, vocÃª precisa ter muitos nÃ³s. AlÃ©m do fato de o controlador iniciar a operaÃ§Ã£o desses contÃªineres, ele monitora seu status. Se, devido Ã  falta de memÃ³ria, um dos contÃªineres falhar, o controlador registrarÃ¡ uma diminuiÃ§Ã£o no nÃºmero de 5 para 4 e iniciarÃ¡ um novo contÃªiner em um dos nÃ³s disponÃ­veis. Isso significa que, quando o Kubernetes estÃ¡ em execuÃ§Ã£o, vocÃª nÃ£o inicia os contÃªineres em nenhum nÃ³ especÃ­fico, mas define o estado necessÃ¡rio - configure a plataforma para implantar 5 contÃªineres e transfira o controle para o controlador de replicaÃ§Ã£o, que cuida da manutenÃ§Ã£o desse estado. Portanto, o Replication Controller Ã© um conceito muito importante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como eu disse, o Kubernetes nÃ£o funciona diretamente com contÃªineres. Ele faz isso atravÃ©s do Pod - uma abstraÃ§Ã£o em cima de contÃªineres. Ã‰ importante que o Kubernetes opere nÃ£o apenas com contÃªineres do Docker, mas tambÃ©m, por exemplo, com seus contÃªineres alternativos - rkt. Este nÃ£o Ã© um suporte oficial, porque se vocÃª olhar para a documentaÃ§Ã£o tÃ©cnica do Kubernetes, ela fala apenas sobre contÃªineres do Docker. No entanto, Ã  medida que a plataforma se desenvolve, a compatibilidade com contÃªineres de outros formatos Ã© adicionada a ela.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/bv/m2/qlbvm22buned0-bj3_bvef6ub8e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada um deles pode conter muitos contÃªineres com o mesmo ciclo de vida. Isso significa que nÃ£o poderemos executar contÃªineres para vÃ¡rios propÃ³sitos no mesmo pod, porque todos eles podem existir apenas no mesmo perÃ­odo de tempo. Eles comeÃ§am simultaneamente e simultaneamente interrompem seu trabalho. Portanto, se vocÃª trabalha com microsserviÃ§os, nÃ£o pode colocÃ¡-los todos na mesma sub. Os contÃªineres dentro da lareira â€œse vÃªemâ€ no host local.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se vocÃª, por exemplo, estiver implantando um serviÃ§o da Web, o pod para este aplicativo conterÃ¡ o contÃªiner nginx, e o nginx nÃ£o Ã© modificado, mas diretamente pronto para uso. Para que esse nginx funcione, precisamos adicionar nossos prÃ³prios arquivos HTML e colocÃ¡-los em um contÃªiner separado para arquivos da web. Ambos os contÃªineres sÃ£o colocados em um submarino comum e comeÃ§am a trabalhar juntos, como se existissem na mesma mÃ¡quina fÃ­sica, para que eles vissem arquivos do mesmo sistema de arquivos localizados no mesmo host local. Os serviÃ§os que fornecem a interaÃ§Ã£o dos componentes do cluster operam usando variÃ¡veis â€‹â€‹de ambiente do ambiente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prÃ³xima coisa que fornece Ã© rede. Se vocÃª executar vÃ¡rios contÃªineres na mesma mÃ¡quina fÃ­sica, que tambÃ©m pode estar localizada na nuvem, e todos esses contÃªineres usarem portas, por exemplo, usaremos trÃªs aplicativos Java que funcionam com a mesma porta 8080, isso estarÃ¡ repleto de conflitos. Para evitÃ¡-lo, vocÃª precisarÃ¡ de mapeamento de portas, o que complicarÃ¡ bastante o processo de implantaÃ§Ã£o de aplicativos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qm/wt/vs/qmwtvs3ose470fyu5kyhkzsnxoq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, seria Ã³timo se cada contÃªiner lanÃ§ado tivesse seu prÃ³prio endereÃ§o IP virtual com acesso a todas as portas disponÃ­veis, sem pensar em seu possÃ­vel conflito. Ã‰ exatamente isso que o Kubernetes fornece.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada vez que ele cria um pod, ele cria seu prÃ³prio endereÃ§o IP virtual para ele. As portas nÃ£o sÃ£o compartilhadas entre o restante dos pods, portanto, nÃ£o hÃ¡ conflito. A Ãºnica coisa que trabalha nesse endereÃ§o IP Ã© o que esse contÃªiner faz. Tudo simplifica.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, isso gera um novo problema: se o seu endereÃ§o IP virtual muda toda vez que vocÃª reinicia os contÃªineres, o que geralmente acontece, entÃ£o como vocÃª pode usÃ¡-los? Suponha que tenhamos 2 pods diferentes que se comunicam, mas seus endereÃ§os IP mudam o tempo todo. O Kubernetes usa um conceito chamado serviÃ§os para resolver esse problema. Esses serviÃ§os configuram proxies em cima de seus lares e continuam a usar endereÃ§os IP virtuais de um determinado intervalo, mas sÃ£o endereÃ§os fixos que nÃ£o mudam o tempo todo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, quando os pods desejam se comunicar, eles fazem isso nÃ£o diretamente, mas atravÃ©s de serviÃ§os, usando esses endereÃ§os IP fixos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7z/jy/ry/7zjyryqkf6iwxdiyer2_ctwmskm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses serviÃ§os organizam o trÃ¡fego de todas as rÃ©plicas trocadas entre os componentes do cluster. Portanto, os serviÃ§os sÃ£o muito importantes para garantir a comunicaÃ§Ã£o entre os componentes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O conceito de ServiÃ§os facilita muito o processo de implantaÃ§Ã£o de vÃ¡rios componentes quando vÃ¡rios componentes fazem parte de um aplicativo maior, como a arquitetura de microsserviÃ§os, embora eu pessoalmente nÃ£o goste de lidar com microsserviÃ§os.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k2/qq/7d/k2qq7dl7sikpjzngr_cyukdv68e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada componente que vocÃª possui pode ser implantado como um submarino separado com seu prÃ³prio ciclo de vida. Eles sÃ£o independentes um do outro e tÃªm espaÃ§os para nome separados, seus prÃ³prios endereÃ§os IP e intervalos de nÃºmeros de portas, podem ser atualizados e dimensionados independentemente. O uso de serviÃ§os facilita muito a comunicaÃ§Ã£o entre componentes. O slide a seguir mostra um exemplo de aplicaÃ§Ã£o de vÃ¡rios componentes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s4/ig/bq/s4igbqyg-ml1e0bpzq07_oslduu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro no Frontend Ã© uma interface do usuÃ¡rio que usa vÃ¡rios serviÃ§os de back-end ou rÃ©plicas de serviÃ§os de back-end. VocÃª vÃª um pacote de vÃ¡rios desses pods para os quais os serviÃ§os sÃ£o usados â€‹â€‹como proxy. VocÃª nÃ£o deve se preocupar com o desempenho de cada pod, porque se um deles falhar, o Kubernetes reiniciarÃ¡ automaticamente o novo. O serviÃ§o de back-end usa vÃ¡rios outros serviÃ§os localizados em diferentes pods e todos eles usam o conceito de serviÃ§os para interaÃ§Ã£o. Tudo isso funciona muito bem; portanto, se vocÃª usar essa arquitetura, o Kubernetes poderÃ¡ implantÃ¡-la facilmente. Se a arquitetura for baseada em um princÃ­pio diferente, vocÃª poderÃ¡ ter problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O prÃ³ximo conceito importante a ser introduzido Ã© o namespace de Namespaces.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mh/kf/nq/mhkfnqcy6wbrez8clmhjedh9se0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses sÃ£o espaÃ§os isolados no Kubernetes que contÃªm lares, controladores de replicaÃ§Ã£o e serviÃ§os. Isolamento significa, por exemplo, que quando o ambiente de desenvolvimento estÃ¡ em um espaÃ§o para nome e a produÃ§Ã£o em outro, vocÃª usa serviÃ§os com o mesmo nome para evitar conflitos entre diferentes espaÃ§os para nome. Dessa forma, vocÃª pode facilmente colocar diferentes ambientes no mesmo cluster fÃ­sico do Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implantaÃ§Ã£o do aplicativo Ã© uma etapa necessÃ¡ria antes de liberÃ¡-lo na produÃ§Ã£o. A documentaÃ§Ã£o do Kubernetes indica que vocÃª deve usar a ferramenta de linha de comando kubectl para concluir a implantaÃ§Ã£o. Essa ferramenta estÃ¡ sendo aprimorada constantemente e Ã© perfeita para implantar qualquer coisa.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/xx/kx/_pxxkxumpyndwztbngvhezit08u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VocÃª vÃª os arquivos de configuraÃ§Ã£o yaml que precisa criar para a API usando o comando kubectl. O prÃ³ximo slide mostra como Ã© um arquivo yaml tÃ­pico. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3g/e2/3u/3ge23une8cdkvl9xhjou_knhpfo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste arquivo, configuramos o controlador de replicaÃ§Ã£o. A primeira parte importante Ã© a linha com o nÃºmero de rÃ©plicas que queremos replicar: 3. Este nÃºmero Ã© igual ao nÃºmero de nÃ³s a serem utilizados. Nesse caso, o nÃºmero 3 significa que queremos executar pods em trÃªs mÃ¡quinas diferentes em nosso cluster. O controlador de replicaÃ§Ã£o monitora o estado do sistema e, se necessÃ¡rio, reinicia automaticamente os pods para garantir a operaÃ§Ã£o contÃ­nua de um determinado nÃºmero de rÃ©plicas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na parte inferior do cÃ³digo, hÃ¡ linhas representando a especificaÃ§Ã£o da lareira. Ele descreve as portas, nÃ³s de armazenamento, o nome e a imagem do servidor da Web e outras informaÃ§Ãµes necessÃ¡rias para o contÃªiner do Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, hÃ¡ um monte de metadados aqui, como rÃ³tulos. Os rÃ³tulos sÃ£o pares de valores-chave e sÃ£o adicionados a objetos como pods. Eles sÃ£o usados â€‹â€‹para agrupar e selecionar subconjuntos de objetos. Eles sÃ£o muito importantes para organizar interaÃ§Ãµes de API, vinculando controladores, pods e serviÃ§os.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pod nÃ£o sabe qual controlador de replicaÃ§Ã£o o criou eo controlador de replicaÃ§Ã£o nÃ£o conhece a lista de pods que ele cria. Mas os pods e o controlador tÃªm rÃ³tulos, cuja coincidÃªncia indica que um sub especÃ­fico pertence a um controlador especÃ­fico. Essa Ã© uma conexÃ£o bastante fraca, mas flexÃ­vel, que garante a operaÃ§Ã£o estÃ¡vel da API e coisas automatizadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vocÃª verÃ¡ uma breve demonstraÃ§Ã£o mostrando o trabalho do kubectl e depois aprofundaremos o trabalho do balanceador de carga e o uso da API. EntÃ£o, insiro o comando kubectl get pods, mas o sistema nÃ£o mostra nenhuma lareira porque ainda nÃ£o executamos nada. Em seguida, insiro o comando ls para visualizar uma lista de arquivos disponÃ­veis.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o-/hk/ep/o-hkep7n2cltgoxhavqlehq_l5i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, insiro o nome do primeiro arquivo da lista e o arquivo yaml de configuraÃ§Ã£o Ã© exibido, semelhante ao que acabamos de ver. Vamos usar esse arquivo para criar uma lareira digitando kubectl create â€“f nginx-controller.yaml. Como resultado, teremos criado abaixo. Repetindo o comando kubectl get pods, vocÃª pode ver que este funciona. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/ke/hb/pqkehb1prgianxodc101qscmbgi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas este Ã© apenas um abaixo. Vamos tentar escalar nosso controlador criando vÃ¡rias rÃ©plicas. Para fazer isso, insiro o comando kubectl scale rc nginx - replicas = 5, em que rc Ã© o controlador de replicaÃ§Ã£o e 5 Ã© o nÃºmero necessÃ¡rio de instÃ¢ncias ou rÃ©plicas desse controlador. VocÃª vÃª o progresso da criaÃ§Ã£o de contÃªineres e, se vocÃª digitar novamente o comando kubectl get pods apÃ³s alguns segundos, poderÃ¡ ver que a maioria dos contÃªineres criados jÃ¡ comeÃ§ou a funcionar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/rv/bb/curvbbj-qsapsqlbja8jz8ywmu0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, aumentamos o nÃºmero de lares ou rÃ©plicas trabalhando em nosso cluster para 5 cÃ³pias. </font><font style="vertical-align: inherit;">AlÃ©m disso, por exemplo, vocÃª pode dar uma olhada no endereÃ§o IP criado para a primeira rÃ©plica digitando o comando kubectl description pod nginx-772ia. </font><font style="vertical-align: inherit;">Este Ã© o endereÃ§o IP virtual anexado a esse contÃªiner em particular.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/nu/lw/xjnulwtnrrzytonpkxak_chgsy8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seu trabalho serÃ¡ fornecido pelos serviÃ§os mencionados acima. </font><font style="vertical-align: inherit;">Vamos ver o que acontece se vocÃª destruir uma das rÃ©plicas em funcionamento, pois, em qualquer caso, devemos garantir o trabalho de um determinado nÃºmero de cÃ³pias. </font><font style="vertical-align: inherit;">Entro no comando kubectl delete pod nginx-772ia e o sistema relata que o item com esse identificador foi excluÃ­do. </font><font style="vertical-align: inherit;">Usando o comando kubectl get pods, vemos que 5 instÃ¢ncias do controlador estÃ£o funcionando novamente e, em vez da rÃ©plica remota nginx-772ia, uma nova com o identificador nginx-sunfn apareceu.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wo/bx/xj/wobxxjfzhq9y2x-u-bilv6cmw4s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso aconteceu porque o Kubernetes notou a falha de uma das rÃ©plicas. Na realidade, isso nÃ£o foi um mau funcionamento acidental, mas uma aÃ§Ã£o deliberada, na medida em que eu o apaguei pessoalmente. PorÃ©m, como o nÃºmero de rÃ©plicas especificadas pela configuraÃ§Ã£o do cluster permaneceu inalterado, o controlador de replicaÃ§Ã£o observou o desaparecimento de uma das instÃ¢ncias e restaurou imediatamente o estado necessÃ¡rio do cluster, criando e iniciando um novo contÃªiner com um novo ID. Obviamente, este Ã© um exemplo estÃºpido quando eu excluo uma rÃ©plica e espero o controlador restaurÃ¡-la, mas situaÃ§Ãµes semelhantes ocorrem na vida real devido a uma falha do contÃªiner, por exemplo, devido Ã  falta de memÃ³ria. Nesse caso, o controlador tambÃ©m serÃ¡ reiniciado em.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tivermos vÃ¡rios cenÃ¡rios de produÃ§Ã£o nos quais o aplicativo Java nÃ£o estÃ¡ configurado corretamente, por exemplo, a memÃ³ria insuficiente Ã© instalada, isso pode causar um travamento algumas horas e uma semana apÃ³s o inÃ­cio do programa. Nesses casos, o Kubernetes cuida para que o fluxo de trabalho nÃ£o seja interrompido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembrÃ¡-lo mais uma vez de que tudo isso nÃ£o Ã© aplicÃ¡vel no estÃ¡gio de produÃ§Ã£o, quando vocÃª nÃ£o deve usar a linha de comando do kubectl e outras coisas inseridas no teclado para garantir a operaÃ§Ã£o do produto. Portanto, antes de comeÃ§armos a implantar a automaÃ§Ã£o, precisamos resolver outro grande problema. Suponha que eu tenha um contÃªiner nginx em execuÃ§Ã£o no momento, mas nÃ£o tenho acesso a ele do "mundo exterior". No entanto, se for um aplicativo da Web, posso acessÃ¡-lo pela Internet. Para garantir a estabilidade desse processo, Ã© usado um balanceador de carga, localizado na frente do cluster.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos ser capazes de gerenciar os serviÃ§os Kubernetes do mundo exterior, e esse recurso nÃ£o Ã© automaticamente suportado imediatamente. Por exemplo, para garantir o balanceamento de HTTP, vocÃª precisa usar o descarregamento de SSL ou o upload de SSL. Esse Ã© o processo de remoÃ§Ã£o da criptografia baseada em SSL do trÃ¡fego de entrada que o servidor da Web recebe para liberar o servidor da descriptografia de dados. Para equilibrar o trÃ¡fego, vocÃª tambÃ©m pode usar a compactaÃ§Ã£o Gzip de pÃ¡ginas da web. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VersÃµes recentes do Kubernetes, como 1.02, tÃªm um novo recurso chamado Ingress. Serve para configurar o balanceador de carga. Este Ã© um novo conceito na API, no qual vocÃª pode escrever um plug-in que configurarÃ¡ qualquer balanceador de carga externo usado.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/ly/ic/nwlyicpw6nmt0chuu48t9a7zlbs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, hoje esse conceito nÃ£o estÃ¡ finalizado e Ã© oferecido na versÃ£o alfa. VocÃª pode demonstrar como funcionarÃ¡ no futuro, mas nÃ£o corresponderÃ¡ Ã  maneira como funciona hoje. Eu uso o balanceador fornecido pelo Google Cloud Engine, no entanto, se vocÃª nÃ£o trabalhar com este serviÃ§o, precisarÃ¡ fazer algo sozinho, pelo menos no momento. No futuro, provavelmente em um mÃªs, serÃ¡ muito mais fÃ¡cil - vocÃª pode usar a funÃ§Ã£o de ingresso para equilibrar o trÃ¡fego.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, esse problema Ã© resolvido com a criaÃ§Ã£o de um balanceador de trÃ¡fego personalizado. Primeiro de tudo, vocÃª pode usar o ha-proxy localizado na frente do cluster Kubernetes. Ele roda fora do cluster em uma mÃ¡quina externa ou conjunto de mÃ¡quinas. Em seguida, Ã© necessÃ¡rio fornecer configuraÃ§Ã£o dinÃ¢mica automÃ¡tica do ha-proxy, para nÃ£o configurÃ¡-lo manualmente ao criar cada nova lareira. Um trabalho semelhante precisa ser feito para o nginx, Apache e outros servidores, e o ha-proxy atua como uma ferramenta facilmente integrada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O slide a seguir mostra como o nÃ³ do balanceador de carga lida com o trÃ¡fego HTTPS recebido e o ha-proxy estÃ¡ localizado em uma mÃ¡quina externa ou em um cluster de mÃ¡quinas localizadas fora do cluster Kubernetes. O upload de SSL tambÃ©m estÃ¡ localizado aqui. O proxy detecta os endereÃ§os solicitados e passa o trÃ¡fego para os serviÃ§os Kubernetes, sem se interessar pelos endereÃ§os IP dos lares que podem mudar com o tempo. Em seguida, os serviÃ§os transmitem trÃ¡fego para pods em execuÃ§Ã£o com endereÃ§os IP dinÃ¢micos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qk/wc/a2/qkwca2qqlvbk3scsv5em8qhhowc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se vocÃª usa a AWS, pode usar o conceito de balanceador de carga ELB. O Elastic Load Balancing redireciona o trÃ¡fego para instÃ¢ncias saudÃ¡veis â€‹â€‹da Amazon para garantir a estabilidade do aplicativo. Esse mecanismo Ã© especialmente bom se vocÃª precisar de escalabilidade do balanceador de carga.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/27/au/6v/27au6v9dwa5zljlmv8rjsuynh6m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, o trÃ¡fego Ã© enviado primeiro ao serviÃ§o da AWS, onde o SSL Ã© descarregado, apÃ³s o qual entra no nÃ³ do balanceador de carga ha-proxy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VocÃª pode fazer o mesmo se seus clusters estiverem completamente dentro de uma rede VPN virtual privada. Nesse caso, o uso do AWS ELB garante totalmente a seguranÃ§a do sistema. VocÃª nÃ£o precisa implementar o SSL entre vÃ¡rios componentes fora do cluster. A Ãºnica coisa que estarÃ¡ conectada com o mundo exterior Ã© o nosso proxy ha.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/kn/gi/gakngiqkuudm2sdiv7txownahuc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conceitualmente, parece bastante simples, mas como funciona na realidade? Como faÃ§o para configurar um ha-proxy para que ele conheÃ§a os serviÃ§os do Kubernetes? Se vocÃª olhar para o ha-proxy da mesma maneira que consideramos o nginx, notarÃ¡ que ele ainda usa arquivos de configuraÃ§Ã£o estÃ¡ticos. Portanto, se vocÃª deseja adicionar um novo back-end, que neste caso sÃ£o nossos serviÃ§os Kubernetes, precisamos alterar o arquivo de configuraÃ§Ã£o, recarregar o ha-proxy e somente depois disso tudo funcionarÃ¡ como deveria. Obviamente, nÃ£o queremos fazer isso manualmente. Portanto, vocÃª pode usar uma pequena ferramenta de cÃ³digo aberto chamada Confd, que gerencia arquivos de configuraÃ§Ã£o de aplicativos locais usando dados etcd. Se ocorrerem alteraÃ§Ãµes no armazenamento de metadados, etcd, o Confd gerarÃ¡ automaticamente um modelo de configuraÃ§Ã£o,que reconfigura o ha-proxy de acordo com as novas condiÃ§Ãµes de trabalho.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode parecer que essa abordagem exija esforÃ§os adicionais, no entanto, Ã© uma ferramenta muito simples que funciona com modelos, portanto, seu uso Ã© uma tarefa bastante trivial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
26:00 min. A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
continuaÃ§Ã£o serÃ¡ muito em breve ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-Ci4vd4rh4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de publicidade :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado por ficar com a gente. VocÃª gosta dos nossos artigos? Deseja ver materiais mais interessantes? Ajude-nos fazendo um pedido ou recomendando aos seus amigos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS na nuvem para desenvolvedores a partir de US $ 4,99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analÃ³gico exclusivo de servidores de nÃ­vel bÃ¡sico que foi inventado por nÃ³s para vocÃª: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 nÃºcleos) 10 GB DDR4 480 GB SSD 1 Gbps de US $ 19 ou como dividir o servidor?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as opÃ§Ãµes estÃ£o disponÃ­veis com RAID1 e RAID10, atÃ© 24 nÃºcleos e atÃ© 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em AmsterdÃ£?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Somente nÃ³s temos </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na Holanda!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de US $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leia sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como criar um prÃ©dio de infraestrutura. </font><font style="vertical-align: inherit;">classe c usando servidores Dell R730xd E5-2650 v4 que custam 9.000 euros por um centavo?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504656/index.html">Aperte o cinto: como a indÃºstria da nuvem mudarÃ¡</a></li>
<li><a href="../pt504658/index.html">Por que o Yota Ã© um operador inconveniente e o que pode ser feito melhor</a></li>
<li><a href="../pt504660/index.html">Princess Frog 2.0 aka Pelophylax ridibundus</a></li>
<li><a href="../pt504662/index.html">Desenhar mÃºsica: danÃ§a de caixÃ£o no Pure Data</a></li>
<li><a href="../pt504664/index.html">AdiÃ§Ã£o inteligente de grupos musicais ao Planilhas Google via API VK, Tampermonkey e Telegram bot</a></li>
<li><a href="../zh-CN486176/index.html">ä¼ä¸šç”µå­é‚®ä»¶é€šè®¯å¤‡å¿˜å½•</a></li>
<li><a href="../zh-CN486178/index.html">FOSSæ–°é—»1-2020å¹´1æœˆ27æ—¥è‡³2æœˆ2æ—¥å…è´¹å’Œå¼€æºæ–°é—»çš„å›é¡¾</a></li>
<li><a href="../zh-CN486180/index.html">åˆ›å»ºæ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„æç¤ºå’Œèµ„æº</a></li>
<li><a href="../zh-CN486184/index.html">å¦‚ä½•æœ‰æ•ˆä½¿ç”¨æœç´¢</a></li>
<li><a href="../zh-CN486186/index.html">ç¾éš¾æ€§äº‘ï¼šå¦‚ä½•å·¥ä½œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>