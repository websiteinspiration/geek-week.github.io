<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🍳 🥓 🖕🏾 Googleアナリティクスのカスタムパラメータの例を使用して、ネストされた構造のデータをGoogle BigQueryからアンロードする方法 🙋🏿 🗿 👨‍👧‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google BigQueryは、世界中の企業で使用されている人気のクラウドデータベースです。これは、未加工のGoogleアナリティクスデータの操作に特に便利です。GA360は数回のクリックでBigQueryと統合され、無料バージョンにはサードパーティのスクリプトとモジュールがあります。
 
 Go...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Googleアナリティクスのカスタムパラメータの例を使用して、ネストされた構造のデータをGoogle BigQueryからアンロードする方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473884/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/5d/bw/ui/5dbwui5nd3dto8kagpfz51vmade.jpeg" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google BigQueryは、世界中の企業で使用されている人気のクラウドデータベースです。</font><font style="vertical-align: inherit;">これは、未加工のGoogleアナリティクスデータの操作に特に便利です。GA360は数回のクリックでBigQueryと統合され、無料バージョンにはサードパーティのスクリプトとモジュールがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Analyticsの生データでは、各レコード（行）がセッションに対応しています。</font><font style="vertical-align: inherit;">そのようなエントリ内には、セッションのヒットに対応するネストされたフィールドがあります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/nb/7e/htnb7eabrx-hddzh-rirbpkqne4.png" width="300" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、そのようなネストされたデータ構造は、それを使用してそのようなデータをアンロードする方法を理解していないユーザーを混乱させます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例としてGoogleアナリティクスのカスタムパラメータを使用して、埋め込みデータがどのようにGoogle BigQueryに保存され、どのようにアップロードされるかを「実際に」説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定されたクエリコードは機能しており、問題の解決に使用でき、テーブル名と必要なカスタムディメンションのインデックス番号を置き換えます。</font></font><a name="habracut"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">•行のアンロード</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">•ネスト構造を維持したまま</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">アンロード</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">• </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーパラメータの値を置き換える例</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基礎</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BigQueryは、SQLの2つの方言であるレガシーと標準をサポートしています。</font><font style="vertical-align: inherit;">アンロード用のクエリを作成する新しいSQL標準を使用することをお勧めします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLを少しでも使ったことがある人なら誰でも、標準のクエリ構成を知っています。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
    *  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
    *  *<font></font>
<span class="hljs-keyword">WHERE</span><font></font>
    * *<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この設計は、テーブル構造が単純で、セルにネストされた他のフィールドがない場合に機能します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/o6/gw/1r/o6gw1raxw5zzwy0ql0ofziv3hwu.png" alt="画像" width="600"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネストされたフィールドを持つテーブルを検討します。</font><font style="vertical-align: inherit;">このようなテーブルの構造（たとえば、Googleアナリティクスのユーザーパラメータ）：</font></font><br>
<br>
<a name="1"></a><div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/fy/tg/cffytgvvdznjq-pb-kbdaww1dn8.png" alt="画像" width="600"></div><font color="99999"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BQのGAカスタムパラメータ</font></font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Google BigQueryでは、このようなテーブルには次の列名があります（セパレータ「。」はネスト構造を示します）。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0w/-h/23/0w-h23uome6_xjhlnm4nc0rjqzm.png" alt="画像" width="600"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では、ネストされたフィールドからデータをアンロードするにはどうすればよいでしょうか。</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行のアンロード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BQのGAカスタムパラメータの例を含む</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
戻り</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
列</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">customDimensions.index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">customDimensions.value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッション</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー定義の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムディメンション</font><font style="vertical-align: inherit;">のインデックスと値です</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">hits.customDimensions.index</font></i><font style="vertical-align: inherit;">と</font><i><font style="vertical-align: inherit;">hits.customDimensions.value列は</font></i><font style="vertical-align: inherit;">のインデックスと値であり、</font><b><font style="vertical-align: inherit;">ヒット</font></b><font style="vertical-align: inherit;">カスタムディメンション。</font><font style="vertical-align: inherit;">
Google BigQueryには、製品の別のレベルのユーザーパラメータアクションがあります。</font><font style="vertical-align: inherit;">Google BigQueryの</font><b><font style="vertical-align: inherit;">製品の</font></b><font style="vertical-align: inherit;">カスタムディメンション</font><font style="vertical-align: inherit;">の名前と値は</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">hits.product.customDimensions.index</font></i><font style="vertical-align: inherit;">と</font></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hits.product.customDimensions.value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらは、ヒットユーザーパラメータとの類推によってアンロードされます。別のレベルのネストを考慮するだけで済みます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッションおよびユーザーレベルのユーザーオプション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネストされた構造を保存せずに（つまり、行ごとに）各日付のセッション（カスタム）カスタムディメンションの値をアンロードする必要がある場合はどうすればよいですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
質問に答えるために</font><font style="vertical-align: inherit;">、BQのGAユーザーパラメータを含む</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">詳しく見てみましょう</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、customDimensions列のセルの値</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が別のテーブルである</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことを示しています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fu/lp/2b/fulp2bysuqjoz_d_ybwypuvwjcy.png" alt="画像" width="600"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインクエリでこのテーブルにサブクエリを作成するだけで十分です。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-comment">--  </span>
  <span class="hljs-built_in">date</span>,
  <span class="hljs-comment">--    value</span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span>
  <span class="hljs-comment">--   customDimensions,     t</span>
  <span class="hljs-keyword">FROM</span> t.customDimensions
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> customDimensions1
<span class="hljs-keyword">FROM</span>
  <span class="hljs-comment">--    t    </span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力はテーブルです：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8m/er/vn/8mervnhyfmqqqhux8nvzcgff4ek.png" alt="画像" width="300"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のユーザーパラメータの値を含む列を追加する必要がある場合は、別のサブクエリを作成します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,<font></font>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> customDimensions1,
  <span class="hljs-comment">--      customDimensions</span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> customDimensions2
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下を取得します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/in/ex/fu/inexfu276z8gmjzusqhzpwikvg4.png" alt="画像" width="460"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒットレベルのカスタムオプション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヒットユーザーパラメータは、ヒットヒットテーブルに対してサブクエリを作成する必要があることを除いて、セッション（ユーザー）パラメータと同じ方法でアンロードされます。</font><font style="vertical-align: inherit;">言い換えると、Googleアナリティクスの未加工データテーブルのヒット列のセルの値は、customDimensionsテーブルがネストされているネストされたテーブルです。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/se/cs/du/secsdu6j3nbsosiuifbd3gpqzwc.png" alt="画像" width="600"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行ごとのヒットユーザーパラメータをダウンロードするリクエストは次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-comment">--  </span>
  <span class="hljs-built_in">date</span>,
  <span class="hljs-comment">--    value</span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span>
  <span class="hljs-comment">--   customDimensions,     h</span>
  <span class="hljs-keyword">FROM</span> h.customDimensions
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> customDimensions3
<span class="hljs-keyword">FROM</span>
  <span class="hljs-comment">--    t    </span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t,
  <span class="hljs-comment">--   t.hits  h    </span>
  t.hits <span class="hljs-keyword">AS</span> h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリの結果はテーブルになります： </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/22/um/ci/22umciavjunefavmc5tfbwkif3g.png" alt="画像" width="300"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複数のヒットユーザーパラメータをアンロードして、hitNumberパラメータ（セッションでのヒットのシーケンス番号）を追加できます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,<font></font>
  h.hitNumber <span class="hljs-keyword">AS</span> hitNumber,<font></font>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> customDimensions3,
  <span class="hljs-comment">--        h.customDimensions</span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span> = <span class="hljs-number">4</span>) <span class="hljs-keyword">AS</span> customDimensions4
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t,<font></font>
  t.hits <span class="hljs-keyword">AS</span> h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルを取得します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/mz/mg/2xmzmg2subtafonus9_mfrtkuvg.png" alt="画像" width="600"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッション（ユーザー）+ヒットユーザーパラメーター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのクエリでセッションをアンロードしてユーザーパラメータをヒットする場合は、メインテーブルとネストされたテーブルに必要なサブクエリを作成するだけです。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,<font></font>
  h.hitNumber <span class="hljs-keyword">AS</span> hitNumber,
  <span class="hljs-comment">--    </span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> customDimensions1,<font></font>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> customDimensions2,
  <span class="hljs-comment">--    </span>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> customDimensions3,<font></font>
  (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">4</span>) <span class="hljs-keyword">AS</span> customDimensions4
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t,<font></font>
  t.hits <span class="hljs-keyword">AS</span> h</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリの結果として取得されるテーブル：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fq/9j/vb/fq9jvbaqzkjq4-fkt5dlm0-zbhk.png" alt="画像" width="600"></div><br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネスト構造を維持したままアンロード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなアンロードは、Google BigQueryのカスタムパラメータの値を置き換えるときに必要になる場合があります。</font></font><br>
<br>
<i><a name="2"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Google Analyticsでは、国の名前が完全な形式でセッションユーザーパラメータにインデックス12で転送され、ヒットユーザーパラメータがインデックス25でロシアからのユーザー（ロシア）に転送されます。</font><font style="vertical-align: inherit;">国の形式を省略形RUSに変更する必要があります。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、Google BigQueryのデータ履歴全体について、ユーザーパラメータの必要な値をユーザーの国に置き換える必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題を解決するための手順：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">ネスト構造を維持しながら</font></b><font style="vertical-align: inherit;">すべてのデータ</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">アンロードします</font></font><b><font style="vertical-align: inherit;"></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーパラメータの値を国に置き換えます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルを書き直す</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネスト構造を維持しながらデータをアップロードするには、ARRAY関数とSELECT AS STRUCT構文を使用する必要があります。</font><font style="vertical-align: inherit;">それが何であるかを理解しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ARRAY関数の構文は次のとおりです。</font></font><br>
<br>
<pre><code class="sql hljs">ARRAY(**)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要素の配列を返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配列と行ご​​との記録を比較します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/db/c9/j3/dbc9j3wl7upziybxe0sa2sdlu6y.png" alt="画像" width="500"></div><font color="99999"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">左側には、アレイは、右側のライン・バイ・ライン録音されている。</font></font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
我々は、ネストされた構造を保存し、いくつかの列に配列をアンロードしたい場合は、私たちが使用しなければならない</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ARRAY（SELECT AS STRUCTを...） </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ok/cj/42/okcj42lx7rui7szbgovsnd5ejza.png" alt="画像" width="450"></div><font color="99999"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネストされた配列</font></font></i></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッションおよびユーザーレベルのユーザーオプション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッション（カスタム）カスタムディメンションの構造を維持しながらアンロードするには、リクエストを使用します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,
  <span class="hljs-comment">--  ARRAY(SELECT AS STRUCT...)   </span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions) <span class="hljs-keyword">AS</span> customDimensions
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行の結果、「生の」Google Analyticsデータのネスト構造が保存されたテーブルが取得されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/uw/yz/um/uwyzumday5vzrtxyspfrfvizsw4.png" alt="画像" width="500"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒットレベルのカスタムオプション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネスト構造を維持しながらヒットユーザーパラメータの値をGoogle BigQueryからアンロードするには、customDimensionsテーブルがヒットテーブルにネストされていることに注意することが重要です。</font><font style="vertical-align: inherit;">つまり、ARRAYサブクエリを2回作成する必要があります（SELECT AS STRUCT ...）：最初にネストされたヒットテーブル、次にネストされたcustomDimensionsテーブル。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,
  <span class="hljs-comment">--    t.hits</span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> hitNumber,
    <span class="hljs-comment">--    h.customDimensions</span>
    <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions) <span class="hljs-keyword">AS</span> customDimensions
  <span class="hljs-keyword">FROM</span> t.hits <span class="hljs-keyword">AS</span> h ) <span class="hljs-keyword">AS</span> hits
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクエリの結果はテーブルになります：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y9/h2/1j/y9h21jm-5ikmi6qudtwsxlvjuue.png" alt="画像" width="600"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッション（ユーザー）+ヒットユーザーパラメーター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行ごとのアンロードと同様に、同じクエリ内のARRAYサブクエリ（SELECT AS STRUCT ...）を目的のネストされたテーブルに結合する必要があります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">date</span>,
  <span class="hljs-comment">--  () Custom Dimensions</span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> t.customDimensions ) <span class="hljs-keyword">AS</span> customDimensions,
  <span class="hljs-comment">--  Custom Dimensions</span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> hitNumber,
    <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">value</span> <span class="hljs-keyword">FROM</span> h.customDimensions ) <span class="hljs-keyword">AS</span> customDimensions
  <span class="hljs-keyword">FROM</span>
    t.hits <span class="hljs-keyword">AS</span> h) <span class="hljs-keyword">AS</span> hits
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は何ですか：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/la/3j/a7/la3ja7nvkxbpl7bde-qniru8mvu.png" alt="画像" width="600"></div><br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーパラメータ値の置き換えの例</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
戻りましょう</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のセクションでは、ネスト構造を維持しながら、セッション（ユーザー）をダウンロードし、Googleアナリティクスのユーザーパラメータをヒットするリクエストを受け取りました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクエリをSELECT * REPLACEコンストラクトで置き換え、アンロードして置換を行い、CASEで必要なユーザーパラメータの値を更新します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--      t.customDimensions  t.hits</span>
<span class="hljs-keyword">SELECT</span> *<span class="hljs-keyword">REPLACE</span>(
  <span class="hljs-comment">--  () Custom Dimensions</span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>,
        <span class="hljs-comment">--     </span>
        <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">12</span>  <span class="hljs-keyword">AND</span> <span class="hljs-keyword">value</span>=<span class="hljs-string">'RUSSIA'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'RUS'</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span>
        <span class="hljs-keyword">FROM</span> t.customDimensions) <span class="hljs-keyword">AS</span> customDimensions,
  <span class="hljs-comment">--  Custom Dimensions</span>
  <span class="hljs-comment">--   t.hits      h.customDimensions</span>
  <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> *<span class="hljs-keyword">REPLACE</span>(
        <span class="hljs-built_in">ARRAY</span>(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">STRUCT</span> <span class="hljs-keyword">index</span>,
              <span class="hljs-comment">--     </span>
              <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">index</span>=<span class="hljs-number">25</span> <span class="hljs-keyword">AND</span> <span class="hljs-keyword">value</span>=<span class="hljs-string">'RUSSIA'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'RUS'</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span>
              <span class="hljs-keyword">FROM</span> h.customDimensions) <span class="hljs-keyword">AS</span> customDimensions)
        <span class="hljs-keyword">FROM</span> t.hits <span class="hljs-keyword">AS</span> h) <span class="hljs-keyword">AS</span> hits)
<span class="hljs-keyword">FROM</span>
  <span class="hljs-string">`project.dataset.tablename`</span> <span class="hljs-keyword">AS</span> t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリクエストの結果として、Googleアナリティクスからの生データを含む元のテーブルを取得します。</font><font style="vertical-align: inherit;">彼女は元の入れ子構造を完全に保持しますが、必要なユーザーパラメーターの値は新しいものに変更されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google BigQueryでネストされたデータ構造を操作するというトピックは簡単ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を明確にしたいと思います。</font><font style="vertical-align: inherit;">ですが、何かを行う方法を学ぶ最善の方法は、もっと練習することです。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473868/index.html">私たちは中国のチップnovatek NT78820を見ます</a></li>
<li><a href="../ja473872/index.html">Java開発者インタビュー準備計画</a></li>
<li><a href="../ja473874/index.html">11月のITイベントのダイジェスト（パート1）</a></li>
<li><a href="../ja473880/index.html">BlessRNGまたはRNGの正直さをチェック</a></li>
<li><a href="../ja473882/index.html">機能依存関係の概要</a></li>
<li><a href="../ja473886/index.html">公開鍵標準に基づく暗号ワークステーション。ASN1構造を解析および表示するための関数</a></li>
<li><a href="../ja473888/index.html">OpenStreetMap No. 483の世界からのお知らせ（10/15/2019-10/21/2019）</a></li>
<li><a href="../ja473890/index.html">カリプソ作戦：新しいAPTグループが世界中の政府機関を攻撃</a></li>
<li><a href="../ja473894/index.html">フロントエンド開発者のための6つのタスク</a></li>
<li><a href="../ja473904/index.html">Vivaldi 2.9-改善の改善</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>