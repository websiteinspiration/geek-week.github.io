<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📤 🚍 🤹🏾 Houston nous avons un problème. Échec de la conception du système 👨🏿‍🏭 👩‍🔬 🚧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 1970, des ingénieurs américains ont lancé le vaisseau spatial Apollo 13 sur la lune. À bord se trouvent trois batteries de piles à combustible, il ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Houston nous avons un problème. Échec de la conception du système</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497332/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En 1970, des ingénieurs américains ont lancé le vaisseau spatial Apollo 13 sur la lune. À bord se trouvent trois batteries de piles à combustible, il n'y a rien à craindre, tout est dupliqué de manière fiable et répétée. Mais personne n'aurait pu imaginer que l'explosion d'une bouteille d'oxygène désactiverait deux des trois batteries. La tragédie! Les astronautes sont rentrés chez eux, un long métrage a été tourné sur l'événement avec Tom Hanks, et la phrase de l'astronaute Jack Swigert: «Houston, nous avons un problème!», Est entrée dans l'histoire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/oj/oi/iuojoilj6ikne43fxjqm5q6bjm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'histoire d'Apollo 13 est une autre preuve du fait bien connu que vous ne pouvez pas vous préparer à tous les problèmes possibles. C'est une propriété naturelle du monde: le fer se casse périodiquement, le code plante et les gens font des erreurs. Il est impossible d'éliminer complètement cela.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les grands systèmes distribués, ce comportement est normal, il est la conséquence d'économies d'échelle et de statistiques. </font><font style="vertical-align: inherit;">C'est pourquoi Design for Failure (AWS) est le principe de conception de base des services cloud AWS. </font><font style="vertical-align: inherit;">Les systèmes sont initialement construits de manière à restaurer le fonctionnement à temps plein le plus rapidement possible et à minimiser les dommages causés par des défaillances connues et inconnues. </font><font style="vertical-align: inherit;">À </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vasily Pantyukhin, en utilisant des problèmes réels avec les services de combat à titre d'exemple, a montré des modèles de conception pour les systèmes distribués que les développeurs AWS utilisent.</font></font><br>
<a name="habracut"></a><br>
 <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vasily Pantyukhin</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Est l'architecte d'Amazon Web Services en Europe, au Moyen-Orient et en Afrique. Il a commencé en tant qu’administrateur Unix, a travaillé chez Sun Microsystem pendant 6 ans, a enseigné des cours techniques et pendant 11 ans, il a enseigné la concentration des données dans le monde chez EMC. Au sein d'une équipe internationale, il a conçu et mis en œuvre des projets du Cap à Oslo. Désormais, il aide les grandes et petites entreprises à travailler dans des clouds publics.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RxWVxr4uUpI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 1949, un accident d'avion a été enquêté dans une base des forces aériennes de Californie. </font><font style="vertical-align: inherit;">Edward Murphy était l'un des ingénieurs qui a fait cela. </font><font style="vertical-align: inherit;">Il a décrit le travail des techniciens locaux comme suit: "S'il y a deux façons de faire quelque chose et que l'une d'elles mène au désastre, alors quelqu'un choisira cette méthode." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, grâce à Arthur Bloch, la déclaration est entrée dans l'histoire comme l'une des lois de Murphy. </font><font style="vertical-align: inherit;">En russe - la loi de la méchanceté. </font><font style="vertical-align: inherit;">Son essence est qu'il ne sera pas possible d'éviter les pannes et les erreurs humaines, et devra vivre avec elle en quelque sorte. </font><font style="vertical-align: inherit;">C'est pourquoi, lors de la conception, nous introduisons immédiatement les défaillances et les défaillances de composants individuels dans nos systèmes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conception de défaillance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la conception pour l'échec, nous essayons d'améliorer trois caractéristiques:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accessibilité (ces mêmes «neuf»);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fiabilité - propriété du système de fournir le niveau de service nécessaire;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tolérance aux pannes - une propriété du système pour éviter l'apparition de problèmes et récupérer rapidement après eux.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fiabilité a la propriété d '« </font><font style="vertical-align: inherit;">inconnues </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connues</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ». </font><font style="vertical-align: inherit;">Nous nous protégeons des problèmes connus, mais nous ne savons pas quand ils se produiront. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
« </font></font><em><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inconnues connues »</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><font style="vertical-align: inherit;">ajouté à la </font><font style="vertical-align: inherit;">tolérance aux </font><font style="vertical-align: inherit;">pannes </font><font style="vertical-align: inherit;">- ce sont des </font><font style="vertical-align: inherit;">problèmes surprises que nous ne savons rien. </font><font style="vertical-align: inherit;">Beaucoup de ces problèmes dans le cloud sont liés à des économies d'échelle: le système prend de la taille lorsque de nouveaux effets étonnants et inattendus apparaissent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'échec n'est généralement pas un phénomène binaire. </font><font style="vertical-align: inherit;">Sa propriété principale est le </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«rayon de souffle»</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou le niveau de dégradation du service, rayon de destruction. </font><font style="vertical-align: inherit;">Notre tâche est de réduire le "rayon de souffle" des systèmes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous reconnaissons que les problèmes ne peuvent être évités, nous devons alors nous y préparer de manière proactive. </font><font style="vertical-align: inherit;">Cela signifie que nous concevons les services de telle manière qu'en cas de problèmes (ils le seront certainement), nous contrôlons les problèmes, et non l'inverse.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque nous répondons à un problème, il nous contrôle.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plan de données et plan de contrôle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez sûrement des appareils électroniques à la maison qui sont contrôlés par une télécommande, comme un téléviseur. </font><font style="vertical-align: inherit;">L'écran du téléviseur fait partie du plan de données - qui exécute directement la fonction. </font><font style="vertical-align: inherit;">La télécommande est l'interface utilisateur - Plan de contrôle. </font><font style="vertical-align: inherit;">Il est utilisé pour gérer et configurer le service. </font><font style="vertical-align: inherit;">Dans le cloud, nous essayons de séparer le plan de données et le plan de contrôle pour les tests et le développement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les utilisateurs, le plus souvent, ne voient pas la complexité du plan de contrôle. </font><font style="vertical-align: inherit;">Mais les erreurs de conception et de mise en œuvre sont les causes les plus courantes de défaillances massives. </font><font style="vertical-align: inherit;">C'est pourquoi mes conseils se concentrent sur le plan de contrôle - parfois explicitement, parfois non.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'histoire d'un problème</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En juillet 2012, une violente tempête est passée en Virginie du Nord. Le centre de données a une protection, des générateurs diesel, etc., mais il se trouve que dans l'un des centres de données de l'une des zones de disponibilité (zone de disponibilité, AZ) de la région de Virginie du Nord, l'alimentation a été coupée. L'électricité a été rapidement rétablie, mais la restauration des services a duré des heures. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/ev/yd/igevydk5zuise0toukfgy9gdxsw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous expliquer les raisons de l'exemple de l'un des services de base - CLB (Classic Load Balancer). Cela fonctionne simplement: lorsque vous démarrez un nouvel équilibreur dans chaque zone de disponibilité, des instances distinctes sont créées, dont l'IP résoudra le DNS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/al/l0/gwall0xgawp614yocrkqtoz87dk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l'une des instances échoue, un message à ce sujet est envoyé à une base de données spéciale. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/ts/bj/sktsbjffpcebdnovro-u6dyr0pu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En réponse, les procédures commencent: supprimer les enregistrements du DNS, démarrer une nouvelle instance et ajouter une nouvelle IP au DNS.</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque: C'est ainsi que le système fonctionnait dans le passé, maintenant tout est fondamentalement différent.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tout est simple - il n'y a rien à casser. Mais lors d'un échec de masse, lorsque des milliers d'instances s'effondrent en même temps, un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">énorme Backlog</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apparaît </font><strong><font style="vertical-align: inherit;">dans la base</font></strong><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">données à</font></strong><font style="vertical-align: inherit;"> partir des messages à traiter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/--/nw/r2--nw4kqcrocoysqgptvysranu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ça a empiré. Le plan de contrôle est un système distribué. En raison d'un bogue, nous avons reçu des doublons et des milliers d'enregistrements dans la base de données ont augmenté jusqu'à des centaines de milliers. Il est devenu très difficile de travailler avec cela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une défaillance se produit sur l'une des instances, tout le trafic passe presque instantanément aux machines survivantes et la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charge double</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (dans l'exemple, pour plus de simplicité, il n'y a que deux zones d'accès). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/jl/ox/uzjloxrf6wvv5hrju2-votyb-o4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas assez de ressources, une instance en direct commence automatiquement à </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">évoluer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le processus prend un temps relativement long. Tout se passe en pointe et en même temps avec un grand nombre d'instances - les ressources libres de la zone de disponibilité s'épuisent. Le «combat» pour les ressources commence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le nord de la Virginie, l'automatisation n'a pas réussi à faire face à l'échec massif et les ingénieurs ont manuellement (à l'aide de scripts) rétabli le fonctionnement des services. Ces troubles sont rares. Au cours du débriefing, des questions se sont posées sur les causes de l'échec, ils ont décidé que la situation ne devait plus se répéter et que l'ensemble du service devait être changé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les huit modèles que je vais couvrir sont des réponses à certaines des questions. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. Il s'agit de notre expérience dans la conception de services, et non d'une sagesse universelle pour une utilisation généralisée. Les modèles sont utilisés dans des situations spécifiques.</font></font></em><br>
<br>
<em>      —  .   AWS           .    — ,  .    .     —     .     !</em><br>
<br>
<h2>  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour minimiser l'impact des échecs, beaucoup d'approches. L'un d'eux est de répondre à la question: "Comment puis-je m'assurer que les utilisateurs qui ne connaissent pas un problème n'en savent rien pendant une panne et pendant la récupération?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre énorme Backlog reçoit non seulement des messages de plantage, mais aussi d'autres, par exemple, sur la mise à l'échelle ou le fait que quelqu'un lance un nouvel équilibreur. Ces messages doivent être isolés les uns des autres, en regroupant fonctionnellement: un groupe distinct de messages de récupération après une défaillance, en lançant séparément un nouvel équilibreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que dix utilisateurs aient remarqué un problème - l'un des nœuds de leurs équilibreurs est tombé. Les services fonctionnent en quelque sorte sur les ressources restantes, mais le problème se fait sentir.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/wu/3a/3cwu3agcfwjtemyacuneqwtmrfm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons dix utilisateurs frustrés. </font><font style="vertical-align: inherit;">Le onzième apparaît - il ne sait rien du problème, mais veut simplement un nouvel équilibreur. </font><font style="vertical-align: inherit;">Si sa demande de mettre la file d'attente pour traitement, alors très probablement, il n'attendra pas. </font><font style="vertical-align: inherit;">Alors que les autres procédures de traitement sont terminées, le délai de demande prendra fin. </font><font style="vertical-align: inherit;">Au lieu de dix utilisateurs frustrés, nous en aurons onze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour éviter cela, nous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priorisons certaines demandes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous plaçons les files d'attente en haut, par exemple, les demandes de nouvelles ressources. </font><font style="vertical-align: inherit;">En cas d'échec de masse, un nombre relativement faible de ces demandes n'affectera pas le temps de récupération des ressources des autres clients. </font><font style="vertical-align: inherit;">Mais dans le processus de récupération, nous limiterons le nombre d'utilisateurs impliqués dans le problème.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail à plein temps</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La réponse aux rapports de problèmes est le lancement de procédures de récupération, en particulier, le travail avec DNS. Les défaillances de masse sont des charges de pointe énormes sur le plan de contrôle. Le deuxième motif aide le plan de contrôle à être plus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stable et prévisible</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans une telle situation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fg/dv/zm/fgdvzmrez2rrlgfsc4ztmxmkaxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons une approche appelée </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travail constant - travail permanent</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/pa/ee/ripaeenvgoadihywoj90c7vvopa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le DNS peut être rendu un peu plus intelligent: il vérifiera constamment les instances de l'équilibreur, qu'elles soient vivantes ou non. Le résultat sera un bitmap à chaque fois: l'instance répond - 1, morte - 0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS vérifie les instances toutes les quelques secondes, que le système soit restauré après une panne de masse ou fonctionne normalement. Il fait le même travail - pas de pics, tout est prévisible et stable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre exemple simplifié: nous voulons changer la configuration sur une grande flotte. </font><font style="vertical-align: inherit;">Dans notre terminologie, une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flotte est un groupe de machines virtuelles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui, ensemble, font un certain travail. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nb/wq/go/nbwqgolicpqizt1bkehgk4ney9c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous plaçons les modifications de configuration dans le compartiment S3 et, toutes les 10 secondes (par exemple), nous transmettons toute cette configuration à notre parc de machines virtuelles. </font><font style="vertical-align: inherit;">Deux points importants.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous le faisons régulièrement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ne violons jamais la règle. </font><font style="vertical-align: inherit;">Si vous choisissez un segment de 10 secondes, ne poussez que de cette façon, quelle que soit la situation.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous donnons toujours la configuration entière</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qu'elle ait changé ou non. </font><font style="vertical-align: inherit;">Le plan de données (machines virtuelles) décide lui-même quoi en faire. </font><font style="vertical-align: inherit;">Nous ne poussons pas le delta. </font><font style="vertical-align: inherit;">Il peut devenir très important avec des perturbations ou des changements massifs. </font><font style="vertical-align: inherit;">Potentiellement, cela peut contribuer à l'instabilité et à l'imprévisibilité.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous effectuons une sorte de travail permanent, nous payons plus pour cela. Par exemple, 100 machines virtuelles demandent une configuration chaque seconde. Il en coûte environ 1200 $ par an. Ce montant est essentiellement inférieur au salaire d'un programmeur, à qui l'on peut confier le développement d'un plan de contrôle avec une approche classique - une réaction à un échec et la répartition des seuls changements de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous modifiez la configuration toutes les quelques secondes, comme dans l'exemple, cela est lent. Mais dans de nombreux cas, un changement de configuration ou le lancement de services prend quelques minutes - quelques secondes ne résolvent rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les secondes sont importantes pour les services dans lesquels la configuration doit changer instantanément, par exemple lors de la modification des paramètres VPC. Ici, le "travail permanent" n'est pas applicable. Ce n'est qu'un modèle, pas une règle. Si cela ne fonctionne pas dans votre cas, ne l'utilisez pas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise à l'échelle préliminaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre exemple, lorsque l'instance d'équilibrage se bloque, la deuxième instance survivante reçoit la charge doublant presque immédiatement et commence à évoluer. </font><font style="vertical-align: inherit;">En cas d'échec massif, il consomme une énorme quantité de ressources. </font><font style="vertical-align: inherit;">Le troisième modèle aide à contrôler ce processus - à l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">échelle à l'avance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de deux zones de disponibilité, nous évoluons lorsque nous éliminons moins de 50%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/wy/n4/chwyn4ffipap4mcwshur7bikoj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est fait à l'avance, en cas d'échec, les instances survivantes de l'équilibreur sont prêtes à accepter un trafic doublé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auparavant, nous évoluions uniquement avec une utilisation élevée, par exemple 80%, et maintenant à 45%. </font><font style="vertical-align: inherit;">Le système est inactif la plupart du temps et devient plus cher. </font><font style="vertical-align: inherit;">Mais nous sommes prêts à accepter cela et à utiliser activement le modèle, car il </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'agit d'une assurance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vous devez payer une assurance, mais en cas de problème grave, la victoire couvre toutes les dépenses. </font><font style="vertical-align: inherit;">Si vous décidez d'utiliser le modèle, calculez tous les risques et le prix à l'avance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture cellulaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux façons de construire et de mettre à l'échelle des services: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le monolithe</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structure en nid d'abeilles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (à base de cellules). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nc/y7/ab/ncy7abk8fzjvr8lsez7wwcjuc70.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le monolithe se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> développe et se développe comme un seul grand récipient. </font><font style="vertical-align: inherit;">Nous ajoutons des ressources, le système gonfle, nous nous heurtons à différentes limites, les caractéristiques linéaires deviennent non linéaires et entrent en saturation, et le «rayon de souffle» du système - tout le système.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le monolithe est mal testé, il augmente la probabilité de surprises - «inconnues inconnues». Mais un grand monolithe ne peut pas être entièrement testé. Parfois, pour cela, vous devrez créer une zone d'accès distincte, par exemple, pour un service populaire qui est construit comme un monolithe dans la zone d'accès (c'est beaucoup de centres de données). En plus de créer en quelque sorte une énorme charge de test similaire à celle actuelle, cela est impossible d'un point de vue financier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, dans la plupart des cas, nous utilisons une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">architecture cellulaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une configuration dans laquelle un système est construit à partir de cellules de taille fixe. En ajoutant des cellules, nous le mettons à l'échelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'architecture cellulaire est populaire dans le cloud AWS. Il aide à isoler les défauts et à </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réduire le rayon de souffle.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à une ou plusieurs cellules. Nous pouvons tester pleinement les cellules de taille moyenne, ce qui réduit considérablement les risques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une approche similaire est utilisée dans la construction navale: la coque d'un navire ou d'un navire est divisée par des cloisons en compartiments. En cas de trou, un ou plusieurs compartiments sont inondés, mais le navire ne coule pas. Oui, cela n'a pas aidé le Titanic, mais nous rencontrons rarement des problèmes d'iceberg. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais illustrer l'application de l'approche maillée en utilisant le service de formes simples comme exemple. Ce n'est pas un service AWS, je l'ai conçu moi-même. Il s'agit d'un ensemble d'API simples pour travailler avec des formes géométriques simples. Vous pouvez créer une instance d'une forme géométrique, demander le type d'une forme par son identifiant ou compter toutes les instances d'un type donné. Par exemple, </font></font><code>put(triangle)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un objet "triangle" avec un id est créé </font><font style="vertical-align: inherit;">sur une demande </font><font style="vertical-align: inherit;">.</font></font><code>getShape(id)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie le type "triangle", "cercle" ou "losange". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/z6/dv/7tz6dv0w3f9laswjhuwtbpedggs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour rendre un service trouble, il doit être utilisé par différents utilisateurs en même temps. </font><font style="vertical-align: inherit;">Faisons-le multi-locataire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/64/hk/pq/64hkpq9niokkw8w-w9rsu7m-w04.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez trouver un moyen de partitionner - pour séparer les chiffres en cellules. </font><font style="vertical-align: inherit;">Il existe plusieurs options pour choisir la clé de partition. </font><font style="vertical-align: inherit;">Le plus simple est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de forme géométrique</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tous les losanges dans la première cellule, les cercles dans la seconde, les triangles dans la troisième. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette méthode a des avantages et des inconvénients.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il y a sensiblement moins de cercles que les autres figures, alors la cellule correspondante restera sous-utilisée (distribution inégale).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines demandes d'API sont faciles à implémenter. </font><font style="vertical-align: inherit;">Par exemple, en comptant tous les objets dans la deuxième cellule, nous trouvons le nombre de cercles dans le système.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'autres requêtes sont plus compliquées. </font><font style="vertical-align: inherit;">Par exemple, pour trouver une forme géométrique par id, vous devez parcourir toutes les cellules.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième façon consiste à utiliser l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id des objets par plages</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : le premier millier d'objets dans la première cellule, le second dans la seconde. </font><font style="vertical-align: inherit;">La distribution est donc plus uniforme, mais il y a d'autres difficultés. </font><font style="vertical-align: inherit;">Par exemple, pour compter tous les triangles, vous devez utiliser la méthode </font></font><code>scatter/gather</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: nous distribuons les demandes dans chaque cellule, il compte les triangles à l'intérieur de lui-même, puis il recueille les réponses, résume et produit le résultat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La troisième voie - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la division des locataires</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(aux utilisateurs). Ici, nous sommes confrontés à un problème classique. Il y a généralement beaucoup de «petits» utilisateurs dans le cloud qui essaient quelque chose et ne chargent pratiquement pas le service. Il y a des utilisateurs de mastodontes. Ils sont peu nombreux, mais ils consomment une énorme quantité de ressources. Ces utilisateurs ne rentreront jamais dans aucune cellule. Vous devez trouver des moyens délicats de les répartir entre de nombreuses cellules. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/1i/3c/wp1i3c0ac5bjnvnxividrzrq6fk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de moyen idéal, chaque service est individuel. La bonne nouvelle est que la sagesse du monde fonctionne ici - couper du bois de chauffage est plus pratique le long des fibres, plutôt que de les couper en travers. Dans de nombreux services, ces «fibres» sont plus ou moins évidentes. Ensuite, vous pouvez expérimenter et trouver la clé de partition optimale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cellules sont interconnectées (quoique faiblement). Par conséquent, il doit y avoir un niveau de connexion. Elle est souvent appelée couche de routage ou de mappage. Il est nécessaire de comprendre à quelles cellules envoyer des demandes spécifiques. Ce niveau doit être aussi simple que possible. Essayez de ne pas y mettre de logique commerciale. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mg/os/ox/mgosox1qloxyngz5k1fd4wwy_ws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question se pose de la taille des cellules: petite - mauvaise, grande - aussi mauvaise. Il n'y a pas de conseil universel - décidez en fonction de la situation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cloud AWS, nous utilisons des cellules logiques et physiques de différentes tailles. Il y a des services régionaux avec une grande taille de cellule, il y a des services de zone, où les cellules sont plus petites. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z9/s8/k-/z9s8k-8v60dwwojzqv86ozp7s7k.png"><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. J'ai parlé des microcellules à Saint Highload ++ Online début avril de cette année. J'y ai discuté en détail un exemple de l'utilisation spécifique de ce modèle dans notre service principal Amazon EBS.</font></font></em><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-locataire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un utilisateur lance un nouvel équilibreur, il reçoit des instances dans chaque zone de disponibilité. </font><font style="vertical-align: inherit;">Que les ressources soient utilisées ou non, elles sont allouées et appartiennent exclusivement à ce locataire du cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour AWS, cette approche est inefficace, car l'utilisation des ressources de service est en moyenne très faible. </font><font style="vertical-align: inherit;">Cela affecte le coût. </font><font style="vertical-align: inherit;">Pour les utilisateurs du cloud, ce n'est pas une solution flexible. </font><font style="vertical-align: inherit;">Il ne peut pas s'adapter à des conditions changeant rapidement, par exemple, pour fournir des ressources avec une charge augmentée de manière inattendue dans les plus brefs délais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/52/xg/fk52xgzaaqhgq09uw_zlhbhxpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CLB a été le premier équilibreur dans le cloud Amazon. </font><font style="vertical-align: inherit;">Les services utilisent aujourd'hui une approche multi-locataire, telle que NLB (Network Load Balancer). </font><font style="vertical-align: inherit;">La base, le "moteur" de ces services réseau est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperPlane</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il s'agit d'un parc de machines virtuelles (nœuds) interne, invisible pour les utilisateurs finaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-b/65/3a/-b653as3g91ombi9itfq5wwqjxg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages de l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approche multi-locataire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou du cinquième modèle.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tolérance aux pannes est fondamentalement plus élevée</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans HyperPlane, un grand nombre de nœuds sont déjà en cours d'exécution et attendent la charge. </font><font style="vertical-align: inherit;">Les nœuds connaissent l'état les uns des autres - lorsque certaines ressources échouent, la charge est instantanément répartie entre les autres. </font><font style="vertical-align: inherit;">Les utilisateurs ne remarquent même pas les accidents de masse.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection contre les pics de charge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les locataires vivent leur propre vie et leurs charges ne sont généralement pas en corrélation. </font><font style="vertical-align: inherit;">La charge moyenne totale sur HyperPlane est assez fluide.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisation de ces services est fondamentalement meilleure</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par conséquent, offrant de meilleures performances, ils sont moins chers.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ça sonne cool! Mais l'approche multi-locataire présente des inconvénients. Sur la figure, la flotte HyperPlane avec trois locataires (losanges, cercles et triangles), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">répartis sur tous les nœuds</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kv/by/dg/kvbydgnlm6a8plns-cewltag1e8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela pose le problème classique du voisin bruyant: l'action destructrice du locataire, qui génère un trafic ultra-élevé ou mauvais, affectera potentiellement tous les utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3f/b9/v4/3fb9v4-hnl27k0sgihgjybo_x70.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le «rayon de souffle» dans un tel système concerne tous les locataires. La probabilité d'un «voisin bruyant» destructeur dans la véritable zone de disponibilité AWS n'est pas élevée. Mais nous devons toujours être préparés au pire. Nous nous défendons en utilisant une approche maillée - nous sélectionnons des groupes de nœuds comme cellules. Dans ce contexte, nous les appelons des éclats. Cellules, éclats, partitions - ici, c'est la même chose.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d1/7z/yy/d17zyyesjijnpsqpllrwhlthqn4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet exemple, un losange, en tant que «voisin bruyant», n'affectera qu'un seul locataire - un triangle. </font><font style="vertical-align: inherit;">Mais le triangle sera très douloureux. </font><font style="vertical-align: inherit;">Pour lisser l'effet, appliquez le sixième motif - mélanger le sharding.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mélange de sharding</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous distribuons au hasard les locataires aux nœuds. </font><font style="vertical-align: inherit;">Par exemple, un losange atterrit sur 1, 3 et 6 nœuds, et un triangle sur 2, 6 et 8. Nous avons 8 nœuds et un fragment de taille 3. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/6n/-w/ft6n-wgdpnlw1g5_t6thpanrtdm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, la combinatoire simple fonctionne. </font><font style="vertical-align: inherit;">Avec une probabilité de 54%, il n'y aura qu'une seule intersection entre les locataires. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/uu/jq/cguujqg-8xjmp-cktarugsfdd6c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le «voisin bruyant» n'affectera qu'un seul locataire, et non la totalité de la charge, mais seulement 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considérons une configuration proche du réel - 100 nœuds, taille d'éclat 5. Avec une probabilité de 77%, il n'y aura aucune intersection du tout. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/14/tj/dr/14tjdrziuvtturqjld0comvzycy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le partage aléatoire peut réduire considérablement le «rayon de souffle». </font><font style="vertical-align: inherit;">Cette approche est utilisée dans de nombreux services AWS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Une petite flotte entraîne une grande flotte, et non l'inverse»</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la récupération d'une panne de masse, nous mettons à jour la configuration de nombreux composants. Dans ce cas, une question typique est de pousser ou de remplacer une configuration modifiée? Qui est l'initiateur des changements: la source contenant les changements de configuration ou ses consommateurs? Mais ces questions sont fausses. La bonne question est quelle flotte est plus grande? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons une situation simple: un grand parc de machines virtuelles frontales et un certain nombre de backends. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vg/av/er/vgaverdwdhgvag5w_pbichyvro0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons une approche maillée - des groupes d'instances frontales fonctionneront avec certains backends. Pour ce faire, déterminez le routage - mappage des backends et des frontends travaillant avec eux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/_a/_a/bx_a_ayxwrvjrvh9uwmaj5ifsru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le routage statique ne convient pas. Les algorithmes de hachage ne fonctionnent pas bien dans les défaillances de masse, lorsque vous devez modifier rapidement la plupart des itinéraires. Il est donc préférable d'utiliser</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">routage dynamique</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . À côté des grandes flottes d'instances frontales et principales, nous mettons un petit service qui ne traitera que du routage. Il connaîtra et assignera un mappage de backend et de frontend à tout moment. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/o3/kl/jio3kl9vxu3hx5p9b1uvfgxsih8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons eu un gros crash, de nombreuses instances frontales sont tombées. Ils commencent à récupérer massivement et presque simultanément la configuration de mappage des demandes du service de routage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nd/qv/fz/ndqvfzx9d_2qn6nfnu8bpmmjrqc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un petit service de routage est bombardé d'un grand nombre de demandes. Il ne supportera pas la charge, dans le meilleur des cas, elle se dégradera et dans le pire des cas il mourra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, il est correct de ne pas demander de modifications de configuration à un petit service, mais plutôt de construire votre système pour que le «bébé» lui-même</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initié des changements de configuration vers une large flotte d'instances</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/hf/gq/uahfgqlyxt-yn190bzu-q8on_rw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons le modèle du travail constant. </font><font style="vertical-align: inherit;">Un petit service de routage enverra la configuration à toutes les instances de flotte frontales toutes les quelques secondes. </font><font style="vertical-align: inherit;">Il ne pourra jamais surcharger un grand service. </font><font style="vertical-align: inherit;">Le septième motif aide à améliorer la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stabilité et la résilience</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les sept premiers modèles améliorent le système. </font><font style="vertical-align: inherit;">Ce dernier modèle fonctionne différemment.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chute de charge</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un graphique classique du retard en fonction de la charge. </font><font style="vertical-align: inherit;">Sur le côté droit du graphique se trouve le «genou», quand à des charges extrêmement élevées, même une petite augmentation entraîne une augmentation significative de la latence.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/fw/vq/sbfwvqhbni-3lzbd0gjlnorzzqi.png" width="450"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mode normal, nous ne prenons jamais nos services du bon côté de l'horaire. Un moyen simple de contrôler cela consiste à ajouter des ressources à temps. Mais nous nous préparons à tout problème. Par exemple, nous pouvons nous déplacer vers le côté droit du graphique en récupérant d'une défaillance de masse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons mis le délai d'attente du client sur le graphique. Tout le monde peut être un client, par exemple, un autre composant de notre service. Pour simplifier, nous dessinons un graphique de retard de 50 centile. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g5/sj/vw/g5sjvwfpnmekcg2mu-kiynw1p6k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes ici face à une situation appelée </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brownout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Vous connaissez peut-être le terme de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">panne d'</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> électricité lorsque l'électricité est coupée dans la ville. Brownout, c'est quand quelque chose fonctionne, mais est tellement mauvais et lent que, comptez, cela ne fonctionne pas du tout.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le brownout de la zone brune. Le service a reçu une demande du client, l'a traitée et a renvoyé le résultat. Cependant, dans la moitié des cas, les clients ont déjà expiré et personne n'attend le résultat. Dans l'autre moitié, le résultat revient plus rapidement que le délai d'attente, mais dans un système lent, cela prend trop de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons été confrontés à un double problème: nous sommes déjà surchargés et sommes du bon côté du calendrier, mais en même temps nous «réchauffons l'air», faisant beaucoup de travail inutile. Comment éviter cela? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trouvez le «genou»</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le point d'inflexion sur le graphique </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous mesurons ou estimons théoriquement. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drop trafic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui nous oblige à aller à droite du point d'inflexion </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><br>
<br>
<img src="https://habrastorage.org/webt/nz/2e/t7/nz2et7zg-cebdkle6rzusm0f0ts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons simplement ignorer une partie des demandes. </font><font style="vertical-align: inherit;">Nous n'essayons même pas de les traiter, mais renvoyons immédiatement une erreur au client. </font><font style="vertical-align: inherit;">Même avec une surcharge, nous pouvons nous permettre cette opération - elle est «bon marché». </font><font style="vertical-align: inherit;">Les demandes ne sont pas satisfaites, la disponibilité globale du service est réduite. </font><font style="vertical-align: inherit;">Bien que les demandes rejetées soient traitées tôt ou tard après une ou plusieurs tentatives des clients. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/4n/xk/bz4nxkpmofmaqg-deszxrwhra5m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, une autre partie des requêtes est traitée avec une faible latence garantie. </font><font style="vertical-align: inherit;">En conséquence, nous ne faisons pas de travail inutile, et ce que nous faisons, nous le faisons bien.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brève compression des modèles de conception de systèmes pour échec</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isolement et régulation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Parfois, il est logique de prioriser certains types de requêtes. Par exemple, avec un volume relativement faible de demandes de création de nouvelles ressources, elles peuvent être placées en tête de file d'attente. Il est important que cela n'empiète pas sur les autres utilisateurs. En cas de panne massive, les utilisateurs qui attendent la récupération de leurs ressources ne ressentiront pas de différence significative. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail à plein temps</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Réduisez ou éliminez complètement la commutation des modes de service. Un mode, qui fonctionne de manière stable et constante, quelles que soient les situations d'urgence ou de travail, améliore fondamentalement la stabilité et la prévisibilité du plan de contrôle. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise à l'échelle préliminaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Échelle à l'avance avec des valeurs d'élimination plus faibles. Vous devrez payer un peu plus pour cela, mais c'est une assurance qui porte ses fruits lors de graves défaillances du système. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture cellulaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De nombreuses cellules à couplage lâche sont préférées à un monolithe. L'approche par maillage réduit le «rayon de souffle» et la probabilité d'erreurs surprises. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'approche multi-locataire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> améliore considérablement l'utilisation du service, réduit son coût et réduit le "rayon de souffle". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mélange de sharding</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit d'une approche qui s'applique aux services multi-locataires. Il vous permet en outre de contrôler le "rayon de souffle". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Une petite flotte entraîne une grande flotte, et non l'inverse»</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous essayons de créer des services afin que les petits services initient des changements dans les grandes configurations. Nous l'utilisons souvent en conjonction avec un modèle de charge constante. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abandonner la charge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans les situations d'urgence, nous essayons de ne faire que du travail utile et de bien le faire. Pour ce faire, nous jetons une partie de la charge, que nous ne pouvons toujours pas gérer.</font></font><br>
<br>
<blockquote>  —    ,    Saint HighLoad++ Online.  --  , Q&amp;A-,  ,    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> -</a>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>. ,   -   . <br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  telegram- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@HighLoadChannel</a> —         ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497322/index.html">Test de niveau de qualité objectif avec la carte du parcours client</a></li>
<li><a href="../fr497324/index.html">"Comme la prunelle d'un œil ..." ou on fait un système de sécurité simple basé sur un microcontrôleur (Canny ou Arduino) et Raspberry PI</a></li>
<li><a href="../fr497326/index.html">Connectivité SSH plus sécurisée avec DNSSEC</a></li>
<li><a href="../fr497328/index.html">Un moyen facile d'apprendre une langue (n'importe laquelle)</a></li>
<li><a href="../fr497330/index.html">Bureau à distance Chrome. Assistance à distance</a></li>
<li><a href="../fr497334/index.html">Les bugs notoires et comment les éviter sur l'exemple de ClickHouse</a></li>
<li><a href="../fr497336/index.html">Marques d'ordinateurs des années 90, partie 3, finale</a></li>
<li><a href="../fr497338/index.html">Qu'est-il arrivé aux transports la semaine dernière - la crise se développe</a></li>
<li><a href="../fr497340/index.html">COVID-19: comment arrêter de lire les nouvelles et commencer à analyser les données</a></li>
<li><a href="../fr497342/index.html">Navigateur à l'affût des requêtes API: création d'une communication sécurisée entre le front-end et le back-end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>