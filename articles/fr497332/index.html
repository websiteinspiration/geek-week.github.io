<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì§ üöç ü§πüèæ Houston nous avons un probl√®me. √âchec de la conception du syst√®me üë®üèø‚Äçüè≠ üë©‚Äçüî¨ üöß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 1970, des ing√©nieurs am√©ricains ont lanc√© le vaisseau spatial Apollo 13 sur la lune. √Ä bord se trouvent trois batteries de piles √† combustible, il ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Houston nous avons un probl√®me. √âchec de la conception du syst√®me</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497332/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En 1970, des ing√©nieurs am√©ricains ont lanc√© le vaisseau spatial Apollo 13 sur la lune. √Ä bord se trouvent trois batteries de piles √† combustible, il n'y a rien √† craindre, tout est dupliqu√© de mani√®re fiable et r√©p√©t√©e. Mais personne n'aurait pu imaginer que l'explosion d'une bouteille d'oxyg√®ne d√©sactiverait deux des trois batteries. La trag√©die! Les astronautes sont rentr√©s chez eux, un long m√©trage a √©t√© tourn√© sur l'√©v√©nement avec Tom Hanks, et la phrase de l'astronaute Jack Swigert: ¬´Houston, nous avons un probl√®me!¬ª, Est entr√©e dans l'histoire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/oj/oi/iuojoilj6ikne43fxjqm5q6bjm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'histoire d'Apollo 13 est une autre preuve du fait bien connu que vous ne pouvez pas vous pr√©parer √† tous les probl√®mes possibles. C'est une propri√©t√© naturelle du monde: le fer se casse p√©riodiquement, le code plante et les gens font des erreurs. Il est impossible d'√©liminer compl√®tement cela.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les grands syst√®mes distribu√©s, ce comportement est normal, il est la cons√©quence d'√©conomies d'√©chelle et de statistiques. </font><font style="vertical-align: inherit;">C'est pourquoi Design for Failure (AWS) est le principe de conception de base des services cloud AWS. </font><font style="vertical-align: inherit;">Les syst√®mes sont initialement construits de mani√®re √† restaurer le fonctionnement √† temps plein le plus rapidement possible et √† minimiser les dommages caus√©s par des d√©faillances connues et inconnues. </font><font style="vertical-align: inherit;">√Ä </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vasily Pantyukhin, en utilisant des probl√®mes r√©els avec les services de combat √† titre d'exemple, a montr√© des mod√®les de conception pour les syst√®mes distribu√©s que les d√©veloppeurs AWS utilisent.</font></font><br>
<a name="habracut"></a><br>
 <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vasily Pantyukhin</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Est l'architecte d'Amazon Web Services en Europe, au Moyen-Orient et en Afrique. Il a commenc√© en tant qu‚Äôadministrateur Unix, a travaill√© chez Sun Microsystem pendant 6 ans, a enseign√© des cours techniques et pendant 11 ans, il a enseign√© la concentration des donn√©es dans le monde chez EMC. Au sein d'une √©quipe internationale, il a con√ßu et mis en ≈ìuvre des projets du Cap √† Oslo. D√©sormais, il aide les grandes et petites entreprises √† travailler dans des clouds publics.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RxWVxr4uUpI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 1949, un accident d'avion a √©t√© enqu√™t√© dans une base des forces a√©riennes de Californie. </font><font style="vertical-align: inherit;">Edward Murphy √©tait l'un des ing√©nieurs qui a fait cela. </font><font style="vertical-align: inherit;">Il a d√©crit le travail des techniciens locaux comme suit: "S'il y a deux fa√ßons de faire quelque chose et que l'une d'elles m√®ne au d√©sastre, alors quelqu'un choisira cette m√©thode." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, gr√¢ce √† Arthur Bloch, la d√©claration est entr√©e dans l'histoire comme l'une des lois de Murphy. </font><font style="vertical-align: inherit;">En russe - la loi de la m√©chancet√©. </font><font style="vertical-align: inherit;">Son essence est qu'il ne sera pas possible d'√©viter les pannes et les erreurs humaines, et devra vivre avec elle en quelque sorte. </font><font style="vertical-align: inherit;">C'est pourquoi, lors de la conception, nous introduisons imm√©diatement les d√©faillances et les d√©faillances de composants individuels dans nos syst√®mes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conception de d√©faillance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la conception pour l'√©chec, nous essayons d'am√©liorer trois caract√©ristiques:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accessibilit√© (ces m√™mes ¬´neuf¬ª);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fiabilit√© - propri√©t√© du syst√®me de fournir le niveau de service n√©cessaire;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tol√©rance aux pannes - une propri√©t√© du syst√®me pour √©viter l'apparition de probl√®mes et r√©cup√©rer rapidement apr√®s eux.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fiabilit√© a la propri√©t√© d '¬´ </font><font style="vertical-align: inherit;">inconnues </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connues</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª. </font><font style="vertical-align: inherit;">Nous nous prot√©geons des probl√®mes connus, mais nous ne savons pas quand ils se produiront. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬´ </font></font><em><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inconnues connues ¬ª</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><font style="vertical-align: inherit;">ajout√© √† la </font><font style="vertical-align: inherit;">tol√©rance aux </font><font style="vertical-align: inherit;">pannes </font><font style="vertical-align: inherit;">- ce sont des </font><font style="vertical-align: inherit;">probl√®mes surprises que nous ne savons rien. </font><font style="vertical-align: inherit;">Beaucoup de ces probl√®mes dans le cloud sont li√©s √† des √©conomies d'√©chelle: le syst√®me prend de la taille lorsque de nouveaux effets √©tonnants et inattendus apparaissent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©chec n'est g√©n√©ralement pas un ph√©nom√®ne binaire. </font><font style="vertical-align: inherit;">Sa propri√©t√© principale est le </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´rayon de souffle¬ª</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou le niveau de d√©gradation du service, rayon de destruction. </font><font style="vertical-align: inherit;">Notre t√¢che est de r√©duire le "rayon de souffle" des syst√®mes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous reconnaissons que les probl√®mes ne peuvent √™tre √©vit√©s, nous devons alors nous y pr√©parer de mani√®re proactive. </font><font style="vertical-align: inherit;">Cela signifie que nous concevons les services de telle mani√®re qu'en cas de probl√®mes (ils le seront certainement), nous contr√¥lons les probl√®mes, et non l'inverse.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque nous r√©pondons √† un probl√®me, il nous contr√¥le.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plan de donn√©es et plan de contr√¥le</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez s√ªrement des appareils √©lectroniques √† la maison qui sont contr√¥l√©s par une t√©l√©commande, comme un t√©l√©viseur. </font><font style="vertical-align: inherit;">L'√©cran du t√©l√©viseur fait partie du plan de donn√©es - qui ex√©cute directement la fonction. </font><font style="vertical-align: inherit;">La t√©l√©commande est l'interface utilisateur - Plan de contr√¥le. </font><font style="vertical-align: inherit;">Il est utilis√© pour g√©rer et configurer le service. </font><font style="vertical-align: inherit;">Dans le cloud, nous essayons de s√©parer le plan de donn√©es et le plan de contr√¥le pour les tests et le d√©veloppement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les utilisateurs, le plus souvent, ne voient pas la complexit√© du plan de contr√¥le. </font><font style="vertical-align: inherit;">Mais les erreurs de conception et de mise en ≈ìuvre sont les causes les plus courantes de d√©faillances massives. </font><font style="vertical-align: inherit;">C'est pourquoi mes conseils se concentrent sur le plan de contr√¥le - parfois explicitement, parfois non.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'histoire d'un probl√®me</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En juillet 2012, une violente temp√™te est pass√©e en Virginie du Nord. Le centre de donn√©es a une protection, des g√©n√©rateurs diesel, etc., mais il se trouve que dans l'un des centres de donn√©es de l'une des zones de disponibilit√© (zone de disponibilit√©, AZ) de la r√©gion de Virginie du Nord, l'alimentation a √©t√© coup√©e. L'√©lectricit√© a √©t√© rapidement r√©tablie, mais la restauration des services a dur√© des heures. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/ev/yd/igevydk5zuise0toukfgy9gdxsw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous expliquer les raisons de l'exemple de l'un des services de base - CLB (Classic Load Balancer). Cela fonctionne simplement: lorsque vous d√©marrez un nouvel √©quilibreur dans chaque zone de disponibilit√©, des instances distinctes sont cr√©√©es, dont l'IP r√©soudra le DNS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/al/l0/gwall0xgawp614yocrkqtoz87dk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l'une des instances √©choue, un message √† ce sujet est envoy√© √† une base de donn√©es sp√©ciale. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/ts/bj/sktsbjffpcebdnovro-u6dyr0pu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√©ponse, les proc√©dures commencent: supprimer les enregistrements du DNS, d√©marrer une nouvelle instance et ajouter une nouvelle IP au DNS.</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque: C'est ainsi que le syst√®me fonctionnait dans le pass√©, maintenant tout est fondamentalement diff√©rent.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tout est simple - il n'y a rien √† casser. Mais lors d'un √©chec de masse, lorsque des milliers d'instances s'effondrent en m√™me temps, un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©norme Backlog</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appara√Æt </font><strong><font style="vertical-align: inherit;">dans la base</font></strong><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">donn√©es √†</font></strong><font style="vertical-align: inherit;"> partir des messages √† traiter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/--/nw/r2--nw4kqcrocoysqgptvysranu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais √ßa a empir√©. Le plan de contr√¥le est un syst√®me distribu√©. En raison d'un bogue, nous avons re√ßu des doublons et des milliers d'enregistrements dans la base de donn√©es ont augment√© jusqu'√† des centaines de milliers. Il est devenu tr√®s difficile de travailler avec cela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une d√©faillance se produit sur l'une des instances, tout le trafic passe presque instantan√©ment aux machines survivantes et la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charge double</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (dans l'exemple, pour plus de simplicit√©, il n'y a que deux zones d'acc√®s). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/jl/ox/uzjloxrf6wvv5hrju2-votyb-o4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas assez de ressources, une instance en direct commence automatiquement √† </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©voluer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le processus prend un temps relativement long. Tout se passe en pointe et en m√™me temps avec un grand nombre d'instances - les ressources libres de la zone de disponibilit√© s'√©puisent. Le ¬´combat¬ª pour les ressources commence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le nord de la Virginie, l'automatisation n'a pas r√©ussi √† faire face √† l'√©chec massif et les ing√©nieurs ont manuellement (√† l'aide de scripts) r√©tabli le fonctionnement des services. Ces troubles sont rares. Au cours du d√©briefing, des questions se sont pos√©es sur les causes de l'√©chec, ils ont d√©cid√© que la situation ne devait plus se r√©p√©ter et que l'ensemble du service devait √™tre chang√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les huit mod√®les que je vais couvrir sont des r√©ponses √† certaines des questions. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. Il s'agit de notre exp√©rience dans la conception de services, et non d'une sagesse universelle pour une utilisation g√©n√©ralis√©e. Les mod√®les sont utilis√©s dans des situations sp√©cifiques.</font></font></em><br>
<br>
<em>      ‚Äî  .   AWS           .    ‚Äî ,  .    .     ‚Äî     .     !</em><br>
<br>
<h2>  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour minimiser l'impact des √©checs, beaucoup d'approches. L'un d'eux est de r√©pondre √† la question: "Comment puis-je m'assurer que les utilisateurs qui ne connaissent pas un probl√®me n'en savent rien pendant une panne et pendant la r√©cup√©ration?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre √©norme Backlog re√ßoit non seulement des messages de plantage, mais aussi d'autres, par exemple, sur la mise √† l'√©chelle ou le fait que quelqu'un lance un nouvel √©quilibreur. Ces messages doivent √™tre isol√©s les uns des autres, en regroupant fonctionnellement: un groupe distinct de messages de r√©cup√©ration apr√®s une d√©faillance, en lan√ßant s√©par√©ment un nouvel √©quilibreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que dix utilisateurs aient remarqu√© un probl√®me - l'un des n≈ìuds de leurs √©quilibreurs est tomb√©. Les services fonctionnent en quelque sorte sur les ressources restantes, mais le probl√®me se fait sentir.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/wu/3a/3cwu3agcfwjtemyacuneqwtmrfm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons dix utilisateurs frustr√©s. </font><font style="vertical-align: inherit;">Le onzi√®me appara√Æt - il ne sait rien du probl√®me, mais veut simplement un nouvel √©quilibreur. </font><font style="vertical-align: inherit;">Si sa demande de mettre la file d'attente pour traitement, alors tr√®s probablement, il n'attendra pas. </font><font style="vertical-align: inherit;">Alors que les autres proc√©dures de traitement sont termin√©es, le d√©lai de demande prendra fin. </font><font style="vertical-align: inherit;">Au lieu de dix utilisateurs frustr√©s, nous en aurons onze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour √©viter cela, nous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priorisons certaines demandes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous pla√ßons les files d'attente en haut, par exemple, les demandes de nouvelles ressources. </font><font style="vertical-align: inherit;">En cas d'√©chec de masse, un nombre relativement faible de ces demandes n'affectera pas le temps de r√©cup√©ration des ressources des autres clients. </font><font style="vertical-align: inherit;">Mais dans le processus de r√©cup√©ration, nous limiterons le nombre d'utilisateurs impliqu√©s dans le probl√®me.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail √† plein temps</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√©ponse aux rapports de probl√®mes est le lancement de proc√©dures de r√©cup√©ration, en particulier, le travail avec DNS. Les d√©faillances de masse sont des charges de pointe √©normes sur le plan de contr√¥le. Le deuxi√®me motif aide le plan de contr√¥le √† √™tre plus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stable et pr√©visible</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans une telle situation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fg/dv/zm/fgdvzmrez2rrlgfsc4ztmxmkaxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons une approche appel√©e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travail constant - travail permanent</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/pa/ee/ripaeenvgoadihywoj90c7vvopa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le DNS peut √™tre rendu un peu plus intelligent: il v√©rifiera constamment les instances de l'√©quilibreur, qu'elles soient vivantes ou non. Le r√©sultat sera un bitmap √† chaque fois: l'instance r√©pond - 1, morte - 0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS v√©rifie les instances toutes les quelques secondes, que le syst√®me soit restaur√© apr√®s une panne de masse ou fonctionne normalement. Il fait le m√™me travail - pas de pics, tout est pr√©visible et stable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre exemple simplifi√©: nous voulons changer la configuration sur une grande flotte. </font><font style="vertical-align: inherit;">Dans notre terminologie, une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flotte est un groupe de machines virtuelles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui, ensemble, font un certain travail. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nb/wq/go/nbwqgolicpqizt1bkehgk4ney9c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pla√ßons les modifications de configuration dans le compartiment S3 et, toutes les 10 secondes (par exemple), nous transmettons toute cette configuration √† notre parc de machines virtuelles. </font><font style="vertical-align: inherit;">Deux points importants.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous le faisons r√©guli√®rement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ne violons jamais la r√®gle. </font><font style="vertical-align: inherit;">Si vous choisissez un segment de 10 secondes, ne poussez que de cette fa√ßon, quelle que soit la situation.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous donnons toujours la configuration enti√®re</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qu'elle ait chang√© ou non. </font><font style="vertical-align: inherit;">Le plan de donn√©es (machines virtuelles) d√©cide lui-m√™me quoi en faire. </font><font style="vertical-align: inherit;">Nous ne poussons pas le delta. </font><font style="vertical-align: inherit;">Il peut devenir tr√®s important avec des perturbations ou des changements massifs. </font><font style="vertical-align: inherit;">Potentiellement, cela peut contribuer √† l'instabilit√© et √† l'impr√©visibilit√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous effectuons une sorte de travail permanent, nous payons plus pour cela. Par exemple, 100 machines virtuelles demandent une configuration chaque seconde. Il en co√ªte environ 1200 $ par an. Ce montant est essentiellement inf√©rieur au salaire d'un programmeur, √† qui l'on peut confier le d√©veloppement d'un plan de contr√¥le avec une approche classique - une r√©action √† un √©chec et la r√©partition des seuls changements de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous modifiez la configuration toutes les quelques secondes, comme dans l'exemple, cela est lent. Mais dans de nombreux cas, un changement de configuration ou le lancement de services prend quelques minutes - quelques secondes ne r√©solvent rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les secondes sont importantes pour les services dans lesquels la configuration doit changer instantan√©ment, par exemple lors de la modification des param√®tres VPC. Ici, le "travail permanent" n'est pas applicable. Ce n'est qu'un mod√®le, pas une r√®gle. Si cela ne fonctionne pas dans votre cas, ne l'utilisez pas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise √† l'√©chelle pr√©liminaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre exemple, lorsque l'instance d'√©quilibrage se bloque, la deuxi√®me instance survivante re√ßoit la charge doublant presque imm√©diatement et commence √† √©voluer. </font><font style="vertical-align: inherit;">En cas d'√©chec massif, il consomme une √©norme quantit√© de ressources. </font><font style="vertical-align: inherit;">Le troisi√®me mod√®le aide √† contr√¥ler ce processus - √† l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©chelle √† l'avance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de deux zones de disponibilit√©, nous √©voluons lorsque nous √©liminons moins de 50%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/wy/n4/chwyn4ffipap4mcwshur7bikoj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est fait √† l'avance, en cas d'√©chec, les instances survivantes de l'√©quilibreur sont pr√™tes √† accepter un trafic doubl√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auparavant, nous √©voluions uniquement avec une utilisation √©lev√©e, par exemple 80%, et maintenant √† 45%. </font><font style="vertical-align: inherit;">Le syst√®me est inactif la plupart du temps et devient plus cher. </font><font style="vertical-align: inherit;">Mais nous sommes pr√™ts √† accepter cela et √† utiliser activement le mod√®le, car il </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'agit d'une assurance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vous devez payer une assurance, mais en cas de probl√®me grave, la victoire couvre toutes les d√©penses. </font><font style="vertical-align: inherit;">Si vous d√©cidez d'utiliser le mod√®le, calculez tous les risques et le prix √† l'avance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture cellulaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux fa√ßons de construire et de mettre √† l'√©chelle des services: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le monolithe</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structure en nid d'abeilles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (√† base de cellules). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nc/y7/ab/ncy7abk8fzjvr8lsez7wwcjuc70.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le monolithe se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©veloppe et se d√©veloppe comme un seul grand r√©cipient. </font><font style="vertical-align: inherit;">Nous ajoutons des ressources, le syst√®me gonfle, nous nous heurtons √† diff√©rentes limites, les caract√©ristiques lin√©aires deviennent non lin√©aires et entrent en saturation, et le ¬´rayon de souffle¬ª du syst√®me - tout le syst√®me.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le monolithe est mal test√©, il augmente la probabilit√© de surprises - ¬´inconnues inconnues¬ª. Mais un grand monolithe ne peut pas √™tre enti√®rement test√©. Parfois, pour cela, vous devrez cr√©er une zone d'acc√®s distincte, par exemple, pour un service populaire qui est construit comme un monolithe dans la zone d'acc√®s (c'est beaucoup de centres de donn√©es). En plus de cr√©er en quelque sorte une √©norme charge de test similaire √† celle actuelle, cela est impossible d'un point de vue financier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, dans la plupart des cas, nous utilisons une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">architecture cellulaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une configuration dans laquelle un syst√®me est construit √† partir de cellules de taille fixe. En ajoutant des cellules, nous le mettons √† l'√©chelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'architecture cellulaire est populaire dans le cloud AWS. Il aide √† isoler les d√©fauts et √† </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©duire le rayon de souffle.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† une ou plusieurs cellules. Nous pouvons tester pleinement les cellules de taille moyenne, ce qui r√©duit consid√©rablement les risques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une approche similaire est utilis√©e dans la construction navale: la coque d'un navire ou d'un navire est divis√©e par des cloisons en compartiments. En cas de trou, un ou plusieurs compartiments sont inond√©s, mais le navire ne coule pas. Oui, cela n'a pas aid√© le Titanic, mais nous rencontrons rarement des probl√®mes d'iceberg. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais illustrer l'application de l'approche maill√©e en utilisant le service de formes simples comme exemple. Ce n'est pas un service AWS, je l'ai con√ßu moi-m√™me. Il s'agit d'un ensemble d'API simples pour travailler avec des formes g√©om√©triques simples. Vous pouvez cr√©er une instance d'une forme g√©om√©trique, demander le type d'une forme par son identifiant ou compter toutes les instances d'un type donn√©. Par exemple, </font></font><code>put(triangle)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un objet "triangle" avec un id est cr√©√© </font><font style="vertical-align: inherit;">sur une demande </font><font style="vertical-align: inherit;">.</font></font><code>getShape(id)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie le type "triangle", "cercle" ou "losange". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/z6/dv/7tz6dv0w3f9laswjhuwtbpedggs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour rendre un service trouble, il doit √™tre utilis√© par diff√©rents utilisateurs en m√™me temps. </font><font style="vertical-align: inherit;">Faisons-le multi-locataire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/64/hk/pq/64hkpq9niokkw8w-w9rsu7m-w04.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez trouver un moyen de partitionner - pour s√©parer les chiffres en cellules. </font><font style="vertical-align: inherit;">Il existe plusieurs options pour choisir la cl√© de partition. </font><font style="vertical-align: inherit;">Le plus simple est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de forme g√©om√©trique</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tous les losanges dans la premi√®re cellule, les cercles dans la seconde, les triangles dans la troisi√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette m√©thode a des avantages et des inconv√©nients.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il y a sensiblement moins de cercles que les autres figures, alors la cellule correspondante restera sous-utilis√©e (distribution in√©gale).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines demandes d'API sont faciles √† impl√©menter. </font><font style="vertical-align: inherit;">Par exemple, en comptant tous les objets dans la deuxi√®me cellule, nous trouvons le nombre de cercles dans le syst√®me.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'autres requ√™tes sont plus compliqu√©es. </font><font style="vertical-align: inherit;">Par exemple, pour trouver une forme g√©om√©trique par id, vous devez parcourir toutes les cellules.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me fa√ßon consiste √† utiliser l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id des objets par plages</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : le premier millier d'objets dans la premi√®re cellule, le second dans la seconde. </font><font style="vertical-align: inherit;">La distribution est donc plus uniforme, mais il y a d'autres difficult√©s. </font><font style="vertical-align: inherit;">Par exemple, pour compter tous les triangles, vous devez utiliser la m√©thode </font></font><code>scatter/gather</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: nous distribuons les demandes dans chaque cellule, il compte les triangles √† l'int√©rieur de lui-m√™me, puis il recueille les r√©ponses, r√©sume et produit le r√©sultat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La troisi√®me voie - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la division des locataires</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(aux utilisateurs). Ici, nous sommes confront√©s √† un probl√®me classique. Il y a g√©n√©ralement beaucoup de ¬´petits¬ª utilisateurs dans le cloud qui essaient quelque chose et ne chargent pratiquement pas le service. Il y a des utilisateurs de mastodontes. Ils sont peu nombreux, mais ils consomment une √©norme quantit√© de ressources. Ces utilisateurs ne rentreront jamais dans aucune cellule. Vous devez trouver des moyens d√©licats de les r√©partir entre de nombreuses cellules. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/1i/3c/wp1i3c0ac5bjnvnxividrzrq6fk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de moyen id√©al, chaque service est individuel. La bonne nouvelle est que la sagesse du monde fonctionne ici - couper du bois de chauffage est plus pratique le long des fibres, plut√¥t que de les couper en travers. Dans de nombreux services, ces ¬´fibres¬ª sont plus ou moins √©videntes. Ensuite, vous pouvez exp√©rimenter et trouver la cl√© de partition optimale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cellules sont interconnect√©es (quoique faiblement). Par cons√©quent, il doit y avoir un niveau de connexion. Elle est souvent appel√©e couche de routage ou de mappage. Il est n√©cessaire de comprendre √† quelles cellules envoyer des demandes sp√©cifiques. Ce niveau doit √™tre aussi simple que possible. Essayez de ne pas y mettre de logique commerciale. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mg/os/ox/mgosox1qloxyngz5k1fd4wwy_ws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question se pose de la taille des cellules: petite - mauvaise, grande - aussi mauvaise. Il n'y a pas de conseil universel - d√©cidez en fonction de la situation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cloud AWS, nous utilisons des cellules logiques et physiques de diff√©rentes tailles. Il y a des services r√©gionaux avec une grande taille de cellule, il y a des services de zone, o√π les cellules sont plus petites. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z9/s8/k-/z9s8k-8v60dwwojzqv86ozp7s7k.png"><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. J'ai parl√© des microcellules √† Saint Highload ++ Online d√©but avril de cette ann√©e. J'y ai discut√© en d√©tail un exemple de l'utilisation sp√©cifique de ce mod√®le dans notre service principal Amazon EBS.</font></font></em><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-locataire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un utilisateur lance un nouvel √©quilibreur, il re√ßoit des instances dans chaque zone de disponibilit√©. </font><font style="vertical-align: inherit;">Que les ressources soient utilis√©es ou non, elles sont allou√©es et appartiennent exclusivement √† ce locataire du cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour AWS, cette approche est inefficace, car l'utilisation des ressources de service est en moyenne tr√®s faible. </font><font style="vertical-align: inherit;">Cela affecte le co√ªt. </font><font style="vertical-align: inherit;">Pour les utilisateurs du cloud, ce n'est pas une solution flexible. </font><font style="vertical-align: inherit;">Il ne peut pas s'adapter √† des conditions changeant rapidement, par exemple, pour fournir des ressources avec une charge augment√©e de mani√®re inattendue dans les plus brefs d√©lais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/52/xg/fk52xgzaaqhgq09uw_zlhbhxpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CLB a √©t√© le premier √©quilibreur dans le cloud Amazon. </font><font style="vertical-align: inherit;">Les services utilisent aujourd'hui une approche multi-locataire, telle que NLB (Network Load Balancer). </font><font style="vertical-align: inherit;">La base, le "moteur" de ces services r√©seau est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperPlane</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il s'agit d'un parc de machines virtuelles (n≈ìuds) interne, invisible pour les utilisateurs finaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-b/65/3a/-b653as3g91ombi9itfq5wwqjxg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages de l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approche multi-locataire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou du cinqui√®me mod√®le.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tol√©rance aux pannes est fondamentalement plus √©lev√©e</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans HyperPlane, un grand nombre de n≈ìuds sont d√©j√† en cours d'ex√©cution et attendent la charge. </font><font style="vertical-align: inherit;">Les n≈ìuds connaissent l'√©tat les uns des autres - lorsque certaines ressources √©chouent, la charge est instantan√©ment r√©partie entre les autres. </font><font style="vertical-align: inherit;">Les utilisateurs ne remarquent m√™me pas les accidents de masse.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection contre les pics de charge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les locataires vivent leur propre vie et leurs charges ne sont g√©n√©ralement pas en corr√©lation. </font><font style="vertical-align: inherit;">La charge moyenne totale sur HyperPlane est assez fluide.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisation de ces services est fondamentalement meilleure</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par cons√©quent, offrant de meilleures performances, ils sont moins chers.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa sonne cool! Mais l'approche multi-locataire pr√©sente des inconv√©nients. Sur la figure, la flotte HyperPlane avec trois locataires (losanges, cercles et triangles), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©partis sur tous les n≈ìuds</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kv/by/dg/kvbydgnlm6a8plns-cewltag1e8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela pose le probl√®me classique du voisin bruyant: l'action destructrice du locataire, qui g√©n√®re un trafic ultra-√©lev√© ou mauvais, affectera potentiellement tous les utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3f/b9/v4/3fb9v4-hnl27k0sgihgjybo_x70.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le ¬´rayon de souffle¬ª dans un tel syst√®me concerne tous les locataires. La probabilit√© d'un ¬´voisin bruyant¬ª destructeur dans la v√©ritable zone de disponibilit√© AWS n'est pas √©lev√©e. Mais nous devons toujours √™tre pr√©par√©s au pire. Nous nous d√©fendons en utilisant une approche maill√©e - nous s√©lectionnons des groupes de n≈ìuds comme cellules. Dans ce contexte, nous les appelons des √©clats. Cellules, √©clats, partitions - ici, c'est la m√™me chose.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d1/7z/yy/d17zyyesjijnpsqpllrwhlthqn4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet exemple, un losange, en tant que ¬´voisin bruyant¬ª, n'affectera qu'un seul locataire - un triangle. </font><font style="vertical-align: inherit;">Mais le triangle sera tr√®s douloureux. </font><font style="vertical-align: inherit;">Pour lisser l'effet, appliquez le sixi√®me motif - m√©langer le sharding.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©lange de sharding</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous distribuons au hasard les locataires aux n≈ìuds. </font><font style="vertical-align: inherit;">Par exemple, un losange atterrit sur 1, 3 et 6 n≈ìuds, et un triangle sur 2, 6 et 8. Nous avons 8 n≈ìuds et un fragment de taille 3. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/6n/-w/ft6n-wgdpnlw1g5_t6thpanrtdm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, la combinatoire simple fonctionne. </font><font style="vertical-align: inherit;">Avec une probabilit√© de 54%, il n'y aura qu'une seule intersection entre les locataires. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/uu/jq/cguujqg-8xjmp-cktarugsfdd6c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le ¬´voisin bruyant¬ª n'affectera qu'un seul locataire, et non la totalit√© de la charge, mais seulement 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rons une configuration proche du r√©el - 100 n≈ìuds, taille d'√©clat 5. Avec une probabilit√© de 77%, il n'y aura aucune intersection du tout. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/14/tj/dr/14tjdrziuvtturqjld0comvzycy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le partage al√©atoire peut r√©duire consid√©rablement le ¬´rayon de souffle¬ª. </font><font style="vertical-align: inherit;">Cette approche est utilis√©e dans de nombreux services AWS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Une petite flotte entra√Æne une grande flotte, et non l'inverse¬ª</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la r√©cup√©ration d'une panne de masse, nous mettons √† jour la configuration de nombreux composants. Dans ce cas, une question typique est de pousser ou de remplacer une configuration modifi√©e? Qui est l'initiateur des changements: la source contenant les changements de configuration ou ses consommateurs? Mais ces questions sont fausses. La bonne question est quelle flotte est plus grande? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons une situation simple: un grand parc de machines virtuelles frontales et un certain nombre de backends. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vg/av/er/vgaverdwdhgvag5w_pbichyvro0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons une approche maill√©e - des groupes d'instances frontales fonctionneront avec certains backends. Pour ce faire, d√©terminez le routage - mappage des backends et des frontends travaillant avec eux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/_a/_a/bx_a_ayxwrvjrvh9uwmaj5ifsru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le routage statique ne convient pas. Les algorithmes de hachage ne fonctionnent pas bien dans les d√©faillances de masse, lorsque vous devez modifier rapidement la plupart des itin√©raires. Il est donc pr√©f√©rable d'utiliser</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">routage dynamique</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √Ä c√¥t√© des grandes flottes d'instances frontales et principales, nous mettons un petit service qui ne traitera que du routage. Il conna√Ætra et assignera un mappage de backend et de frontend √† tout moment. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/o3/kl/jio3kl9vxu3hx5p9b1uvfgxsih8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons eu un gros crash, de nombreuses instances frontales sont tomb√©es. Ils commencent √† r√©cup√©rer massivement et presque simultan√©ment la configuration de mappage des demandes du service de routage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nd/qv/fz/ndqvfzx9d_2qn6nfnu8bpmmjrqc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un petit service de routage est bombard√© d'un grand nombre de demandes. Il ne supportera pas la charge, dans le meilleur des cas, elle se d√©gradera et dans le pire des cas il mourra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, il est correct de ne pas demander de modifications de configuration √† un petit service, mais plut√¥t de construire votre syst√®me pour que le ¬´b√©b√©¬ª lui-m√™me</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initi√© des changements de configuration vers une large flotte d'instances</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/hf/gq/uahfgqlyxt-yn190bzu-q8on_rw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons le mod√®le du travail constant. </font><font style="vertical-align: inherit;">Un petit service de routage enverra la configuration √† toutes les instances de flotte frontales toutes les quelques secondes. </font><font style="vertical-align: inherit;">Il ne pourra jamais surcharger un grand service. </font><font style="vertical-align: inherit;">Le septi√®me motif aide √† am√©liorer la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stabilit√© et la r√©silience</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les sept premiers mod√®les am√©liorent le syst√®me. </font><font style="vertical-align: inherit;">Ce dernier mod√®le fonctionne diff√©remment.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chute de charge</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un graphique classique du retard en fonction de la charge. </font><font style="vertical-align: inherit;">Sur le c√¥t√© droit du graphique se trouve le ¬´genou¬ª, quand √† des charges extr√™mement √©lev√©es, m√™me une petite augmentation entra√Æne une augmentation significative de la latence.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/fw/vq/sbfwvqhbni-3lzbd0gjlnorzzqi.png" width="450"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mode normal, nous ne prenons jamais nos services du bon c√¥t√© de l'horaire. Un moyen simple de contr√¥ler cela consiste √† ajouter des ressources √† temps. Mais nous nous pr√©parons √† tout probl√®me. Par exemple, nous pouvons nous d√©placer vers le c√¥t√© droit du graphique en r√©cup√©rant d'une d√©faillance de masse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons mis le d√©lai d'attente du client sur le graphique. Tout le monde peut √™tre un client, par exemple, un autre composant de notre service. Pour simplifier, nous dessinons un graphique de retard de 50 centile. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g5/sj/vw/g5sjvwfpnmekcg2mu-kiynw1p6k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes ici face √† une situation appel√©e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brownout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Vous connaissez peut-√™tre le terme de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">panne d'</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©lectricit√© lorsque l'√©lectricit√© est coup√©e dans la ville. Brownout, c'est quand quelque chose fonctionne, mais est tellement mauvais et lent que, comptez, cela ne fonctionne pas du tout.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le brownout de la zone brune. Le service a re√ßu une demande du client, l'a trait√©e et a renvoy√© le r√©sultat. Cependant, dans la moiti√© des cas, les clients ont d√©j√† expir√© et personne n'attend le r√©sultat. Dans l'autre moiti√©, le r√©sultat revient plus rapidement que le d√©lai d'attente, mais dans un syst√®me lent, cela prend trop de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©t√© confront√©s √† un double probl√®me: nous sommes d√©j√† surcharg√©s et sommes du bon c√¥t√© du calendrier, mais en m√™me temps nous ¬´r√©chauffons l'air¬ª, faisant beaucoup de travail inutile. Comment √©viter cela? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trouvez le ¬´genou¬ª</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le point d'inflexion sur le graphique </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous mesurons ou estimons th√©oriquement. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drop trafic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui nous oblige √† aller √† droite du point d'inflexion </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><br>
<br>
<img src="https://habrastorage.org/webt/nz/2e/t7/nz2et7zg-cebdkle6rzusm0f0ts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons simplement ignorer une partie des demandes. </font><font style="vertical-align: inherit;">Nous n'essayons m√™me pas de les traiter, mais renvoyons imm√©diatement une erreur au client. </font><font style="vertical-align: inherit;">M√™me avec une surcharge, nous pouvons nous permettre cette op√©ration - elle est ¬´bon march√©¬ª. </font><font style="vertical-align: inherit;">Les demandes ne sont pas satisfaites, la disponibilit√© globale du service est r√©duite. </font><font style="vertical-align: inherit;">Bien que les demandes rejet√©es soient trait√©es t√¥t ou tard apr√®s une ou plusieurs tentatives des clients. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/4n/xk/bz4nxkpmofmaqg-deszxrwhra5m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me temps, une autre partie des requ√™tes est trait√©e avec une faible latence garantie. </font><font style="vertical-align: inherit;">En cons√©quence, nous ne faisons pas de travail inutile, et ce que nous faisons, nous le faisons bien.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Br√®ve compression des mod√®les de conception de syst√®mes pour √©chec</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isolement et r√©gulation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Parfois, il est logique de prioriser certains types de requ√™tes. Par exemple, avec un volume relativement faible de demandes de cr√©ation de nouvelles ressources, elles peuvent √™tre plac√©es en t√™te de file d'attente. Il est important que cela n'empi√®te pas sur les autres utilisateurs. En cas de panne massive, les utilisateurs qui attendent la r√©cup√©ration de leurs ressources ne ressentiront pas de diff√©rence significative. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail √† plein temps</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . R√©duisez ou √©liminez compl√®tement la commutation des modes de service. Un mode, qui fonctionne de mani√®re stable et constante, quelles que soient les situations d'urgence ou de travail, am√©liore fondamentalement la stabilit√© et la pr√©visibilit√© du plan de contr√¥le. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise √† l'√©chelle pr√©liminaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. √âchelle √† l'avance avec des valeurs d'√©limination plus faibles. Vous devrez payer un peu plus pour cela, mais c'est une assurance qui porte ses fruits lors de graves d√©faillances du syst√®me. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture cellulaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De nombreuses cellules √† couplage l√¢che sont pr√©f√©r√©es √† un monolithe. L'approche par maillage r√©duit le ¬´rayon de souffle¬ª et la probabilit√© d'erreurs surprises. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'approche multi-locataire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> am√©liore consid√©rablement l'utilisation du service, r√©duit son co√ªt et r√©duit le "rayon de souffle". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©lange de sharding</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit d'une approche qui s'applique aux services multi-locataires. Il vous permet en outre de contr√¥ler le "rayon de souffle". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Une petite flotte entra√Æne une grande flotte, et non l'inverse¬ª</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous essayons de cr√©er des services afin que les petits services initient des changements dans les grandes configurations. Nous l'utilisons souvent en conjonction avec un mod√®le de charge constante. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abandonner la charge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans les situations d'urgence, nous essayons de ne faire que du travail utile et de bien le faire. Pour ce faire, nous jetons une partie de la charge, que nous ne pouvons toujours pas g√©rer.</font></font><br>
<br>
<blockquote>  ‚Äî    ,    Saint HighLoad++ Online.  --  , Q&amp;A-,  ,    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> -</a>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>. ,   -   . <br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  telegram- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@HighLoadChannel</a> ‚Äî         ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497322/index.html">Test de niveau de qualit√© objectif avec la carte du parcours client</a></li>
<li><a href="../fr497324/index.html">"Comme la prunelle d'un ≈ìil ..." ou on fait un syst√®me de s√©curit√© simple bas√© sur un microcontr√¥leur (Canny ou Arduino) et Raspberry PI</a></li>
<li><a href="../fr497326/index.html">Connectivit√© SSH plus s√©curis√©e avec DNSSEC</a></li>
<li><a href="../fr497328/index.html">Un moyen facile d'apprendre une langue (n'importe laquelle)</a></li>
<li><a href="../fr497330/index.html">Bureau √† distance Chrome. Assistance √† distance</a></li>
<li><a href="../fr497334/index.html">Les bugs notoires et comment les √©viter sur l'exemple de ClickHouse</a></li>
<li><a href="../fr497336/index.html">Marques d'ordinateurs des ann√©es 90, partie 3, finale</a></li>
<li><a href="../fr497338/index.html">Qu'est-il arriv√© aux transports la semaine derni√®re - la crise se d√©veloppe</a></li>
<li><a href="../fr497340/index.html">COVID-19: comment arr√™ter de lire les nouvelles et commencer √† analyser les donn√©es</a></li>
<li><a href="../fr497342/index.html">Navigateur √† l'aff√ªt des requ√™tes API: cr√©ation d'une communication s√©curis√©e entre le front-end et le back-end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>