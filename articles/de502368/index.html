<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎻 👼🏾 😽 Wir pumpen das Laufband 📪 👩🏾‍🤝‍👩🏻 🎰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor kurzem habe ich mich für einen sehr seltsamen Kauf entschieden. Ja, ich habe ein Laufband gekauft. 
 
 
 
 Und bald wurde mir klar, dass es nicht ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wir pumpen das Laufband</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vor kurzem habe ich mich für einen sehr seltsamen Kauf entschieden. </font><font style="vertical-align: inherit;">Ja, ich habe ein Laufband gekauft. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und bald wurde mir klar, dass es nicht genug detaillierte Statistiken gab, wie beim Fahrradfahren. </font><font style="vertical-align: inherit;">Im Falle eines Fahrrads schreibt die Anwendung auf dem Telefon meine Geschwindigkeit, Herzfrequenz, Trittfrequenz und meinen Auftrieb. </font><font style="vertical-align: inherit;">Es ist sehr neugierig, all diese Parameter während des Trainings zu steuern, um Diagramme anzeigen und von Zeit zu Zeit Ihre Ergebnisse vergleichen zu können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deshalb habe ich mich für etwas Ähnliches mit dem Laufband entschieden: Schließen Sie es an ein Smartphone oder Tablet an, um Statistiken zu sammeln und anzuzeigen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie üblich ist meine Geschichte in Form eines traditionellen Textartikels und per Video. </font><font style="vertical-align: inherit;">Wie du mehr magst.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selbst in dem Moment, als ich das Laufband abholte, bemerkte ich, dass die Fernbedienung und der Laufriemen selbst nur vier Drähte verbanden. Anscheinend werden einige von ihnen zur Stromversorgung der Konsole verwendet, da die Leinwand selbst an das 220-Volt-Netzwerk angeschlossen ist und die verbleibenden Kabel benötigt werden, um Steuersignale in die entgegengesetzte Richtung zu übertragen - von der Konsole zur Leinwand steuern sie die Geschwindigkeit und den Winkel der Spur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe das Oszilloskop parallel zu diesen Drähten angeschlossen und verschiedene Kombinationen ausprobiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis stellte ich fest, dass alles ungefähr so ​​war, wie ich es erwartet hatte. Einer der Drähte ist geerdet und ein anderer hat eine Spannung von 12 Volt. Der Rest überträgt digitale Daten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In einem von ihnen ändert sich das Signal beim Umschalten von Geschwindigkeit und Winkel. </font><font style="vertical-align: inherit;">Genau das brauche ich! </font><font style="vertical-align: inherit;">Die Signalamplitude beträgt ca. vier Volt. </font><font style="vertical-align: inherit;">Das Protokoll sieht jedoch nicht wie ein Standard aus, und das Signal ist sehr verrauscht. Wenn die Spur eingeschaltet ist, müssen Sie es irgendwie filtern. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der letzte Draht besteht nur aus Impulsen mit einer konstanten Frequenz. </font><font style="vertical-align: inherit;">Anscheinend soll die Konsole die Verbindung zum Laufband sehen. </font><font style="vertical-align: inherit;">Wenn Sie dieses Kabel abziehen, gibt die Fernbedienung sofort einen Fehler aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anzeigen vom Impulssensor auf diesen Drähten werden eindeutig nicht übertragen, sind jedoch nicht erforderlich. </font><font style="vertical-align: inherit;">Es ist besser, einen separaten Brustsensor anzuschließen, den ich schon lange beim Fahrradfahren benutze. </font><font style="vertical-align: inherit;">Außerdem stellte sich heraus, dass der Herzfrequenzsensor am Laufband selbst viel liegt und die Messwerte unterschätzt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerätebaugruppe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die nächste Aufgabe besteht also darin, eine Karte zusammenzubauen, die parallel zu diesen Drähten angeschlossen ist, die aktuelle Geschwindigkeit und den aktuellen Winkel liest und sie irgendwie drahtlos auf ein Tablet oder Smartphone überträgt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mich erneut für den Onion Omega2 Single-Board-Computer entschieden. Er muss einen exzellenten Job machen. Es ist nur erforderlich, die Versorgungsspannung auf 3,3 Volt zu senken und die Daten vor Störungen zu filtern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Spannung zu reduzieren, verwende ich jetzt diese vorgefertigten Karten mit einem DC-DC-Wandler. Sie kosten einen Cent, halten bis zu ein paar Ampere stand und die Ausgangsspannung wird mit einem Dreh eingestellt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig hat diese Platine Schlussfolgerungen, direkt auf eine andere Platine zu löten, was sehr praktisch ist. Die Hauptsache ist, die Spannungsverdrehung nach dem Einbau in den Stromkreis nicht zu verdrehen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Rauschen auf der Datenleitung zu filtern, habe ich ein normales RC-Filter hergestellt: einen 2,2-Kilo-Ohm-Widerstand und einen 22-Picofarad-Kondensator. </font><font style="vertical-align: inherit;">Dies sollte das Hochfrequenzrauschen herausfiltern und ein Niederfrequenzsignal hinterlassen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass es ein ziemlich kleiner Schal war. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe es an die Laufbandkabel angeschlossen, um zu sehen, wie gut das Signal gefiltert wird, wenn es eingeschaltet wird, und anscheinend ist die Wellenform fast perfekt geworden.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernelmodul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist jedoch nicht so einfach, die Leistung von Eisen zu überprüfen. Wie wir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bereits am Oszilloskop gesehen haben, gehen die Signale sehr schnell und wir verwenden keinen Mikrocontroller, sondern einen Omega2-Computer mit einer Karte und Linux an Bord. Unter Linux können wir Signale aus dem Benutzerbereich nicht so schnell verarbeiten. Aber von Grund auf können wir! Daher ist es Zeit, ein Linux-Kernelmodul zu schreiben! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu müssen Sie die Linux-Kernelquellen herunterladen. In unserem Fall handelt es sich um eine OpenWRT-Assembly für Omega2, und ein Verzeichnis mit dem Quellcode unseres Moduls erstellen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Schreiben von Modulcode ähnelt dem Programmieren eines Mikrocontrollers. Wir schreiben auch in C, auch alles ist Low-Level, wir arbeiten auch mit Interrupts und wenden uns auch den GPIO-Schlussfolgerungen zu. Nur hier, zusätzlich zu all dem oben Genannten, interagieren wir noch mit dem Benutzerraum über eine Pseudodatei. Somit wird unser Kernelmodul zu einer Art Adapter zwischen der Hardware und gewöhnlichen Anwendungen. Eigentlich nennt man das den Treiber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anfangs wusste ich nicht, wie ich die Signale dekodieren sollte, also habe ich einfach ihre Dauer abgeleitet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde schnell klar, dass die Signale mit hoher Pegeldauer codiert wurden. Es ist entweder 600 Mikrosekunden lang oder 1200 Mikrosekunden lang. Der niedrige Pegel ist bis auf die Anfangssequenz immer 600 Mikrosekunden lang.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insgesamt 17 solcher Tropfen fallen auf und ab. </font><font style="vertical-align: inherit;">Anscheinend sind dies 16 Datenbits plus die Anfangssequenz. </font><font style="vertical-align: inherit;">Ich habe ihre Dekodierung vorgenommen, wobei ich davon ausgegangen bin, dass lange, hohe Unterschiede eine logische Null sind und kurze eine logische Einheit, und ich habe verstanden, was passiert ist. </font><font style="vertical-align: inherit;">Ich habe sofort die Daten gesehen, die ich brauchte! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16 Bit sind bekanntlich zwei Bytes. </font><font style="vertical-align: inherit;">Das erste Byte gibt die Art der übertragenen Daten an: den Neigungs- oder Geschwindigkeitswinkel und das zweite Byte die Daten selbst. </font><font style="vertical-align: inherit;">Der Fahrer ist sehr einfach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der einzige Treiberparameter ist die Portnummer.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurieren Sie es beim Initialisieren für die Eingabe und stellen Sie den Interrupt ein, der jedes Mal ausgelöst wird, wenn sich der Pegel ändert.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Unterbrechung schauen wir zuerst auf die aktuelle Zeit. Als nächstes verwenden wir diesen Wert, um zu berechnen, wie viel Zeit seit der letzten Interrupt-Operation vergangen ist, und um ihn in ein Array einzufügen. Natürlich erinnern wir uns beim nächsten Mal an die aktuelle Zeit für die Berechnung. Außerdem müssen Sie den speziellen Timer neu starten.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Trick besteht darin, dass, wenn der Timer noch funktioniert, lange Zeit keine Pegelabfälle am Pin aufgetreten sind und es dementsprechend an der Zeit ist, die gesammelten Informationen zu verarbeiten. </font><font style="vertical-align: inherit;">In der Funktion, die der Timer aufruft, wird überprüft, ob genau 34 Tropfen vorhanden sind. Danach sehen wir uns an, wie lang jedes Intervall war. </font><font style="vertical-align: inherit;">Wenn es 600 Mikrosekunden gibt, dann 1200 Mikrosekunden, dann nehmen wir 900 im Ausland. Wenn das Intervall kürzer ist, schreiben wir eins in das Ergebnis und verschieben es um ein Bit. </font><font style="vertical-align: inherit;">Nach der Verarbeitung jedes Intervalls senden wir das Ergebnis an geöffnete Pseudodateien und übertragen so Daten in den Benutzerbereich.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python-Server und Geschwindigkeitserkennung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann muss noch ein Python-Skript geschrieben werden, das sie aus der Pseudodatei liest und als JSON-Zeichenfolgen über das Netzwerk sendet. Es scheint, dass alles ziemlich einfach ist. Wenn jedoch mit dem Neigungswinkel alles einfach ist und der Wert im zweiten Byte genau dem Neigungswinkel in Prozent entspricht, hat sich mit der Geschwindigkeit alles als viel komplizierter herausgestellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Wert von 9 entspricht einem Kilometer pro Stunde und ein Wert von 160 entspricht 18 Kilometern pro Stunde. Das heißt, die Abhängigkeit der Daten von der tatsächlichen Geschwindigkeit ist überhaupt nicht offensichtlich. Ich schrieb alle Werte manuell aus, fuhr sie in Excel, zeichnete sie und erhielt eine sehr ungleichmäßige Kurve.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und es gibt Geschwindigkeiten, bei denen die Messwerte auf der Fernbedienung unterschiedlich sind, aber die Daten und die Geschwindigkeit der Spur selbst bleiben gleich! Zum Beispiel sind 5,2 km / h und 5,3 km / h tatsächlich die gleichen Geschwindigkeiten. Überall betrügen. Ich frage mich, welche Geschwindigkeit es wirklich gibt. Messen Sie es irgendwie, aber lassen Sie es für später. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abgesehen von dieser Übertragung von Papageien auf Kilometer pro Stunde erwies sich das Drehbuch als äußerst einfach. Wir lesen die Daten aus der Linux-Pseudodatei, dekodieren sie, akzeptieren Netzwerkverbindungen und übertragen die Daten als JSON-Zeichenfolge an die über das Netzwerk verbundenen Clients.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich denke, hier sind keine Autorisierung und Sicherheit erforderlich. </font><font style="vertical-align: inherit;">Der Zustand des Laufbandes ist nicht die Art von Daten, die ich vor Hackern schützen möchte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir setzen dieses Skript in den Start und entfernen das Board im Laufband. </font><font style="vertical-align: inherit;">Leider passt es nur in ein Metallrohr, das die Konsole mit dem Laufband verbindet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie wissen, schirmt Metall das Funksignal ab, also habe ich die WLAN-Antenne aus dem Rohr geholt, aber unter einem Kunststoffgehäuse, das die Drähte verbirgt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf diesem direkt „intelligenten“ Laufband steht bereit. </font><font style="vertical-align: inherit;">Sie weiß bereits, wie man Statistiken über das Netzwerk verteilt. </font><font style="vertical-align: inherit;">Es bleibt nur ein Kunde für sie zu schreiben!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android-Client</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was sollte meiner Meinung nach so ein Kunde sein. </font><font style="vertical-align: inherit;">Dies ist eine Android-Anwendung, die ich auf einem Tablet oder Smartphone ausführen und auf das Display des Laufbands selbst legen werde. Sie sollte alle Informationen zu den Übungen auf dem Bildschirm anzeigen und das Display des Laufbands selbst ersetzen. </font><font style="vertical-align: inherit;">Die Anwendung sollte im Hintergrund arbeiten können, damit ich das Video beim Joggen problemlos ansehen kann. </font><font style="vertical-align: inherit;">Außerdem sollte es detaillierte Statistiken über Läufe führen, alles mit der Wolke synchronisieren und Diagramme der Abhängigkeit des Impulses von Geschwindigkeit und Neigungswinkel zeichnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Herzstück einer solchen Anwendung sollte ein Dienst sein, der im Hintergrund ausgeführt wird, sich in einer Endlosschleife mit dem Laufband verbindet, Daten empfängt und dekodiert. </font><font style="vertical-align: inherit;">Hierbei gibt es keine besonderen Schwierigkeiten.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Herzfrequenzsensor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am schwierigsten war es plötzlich, mit einem Herzfrequenzsensor zu arbeiten. </font><font style="vertical-align: inherit;">Viele Fallstricke wurden entdeckt. </font><font style="vertical-align: inherit;">Ich habe hier einen solchen Brustherzfrequenzmesser: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich benutze ihn schon lange, wenn ich Fahrrad fahre. </font><font style="vertical-align: inherit;">Es ist Standard, funktioniert mit BLE a la Bluetooth Low Enegy und kann problemlos mit einem Telefon und einem Garmin-Navigator gekoppelt werden. </font><font style="vertical-align: inherit;">Ich konnte mir nicht einmal vorstellen, dass die Arbeit mit meiner Anwendung so offensichtlich wäre. </font><font style="vertical-align: inherit;">Solche Sensoren haben Standard-GUIDs für unterschiedliche Messwerte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eine Herzfrequenz zu erhalten, müssen Sie zuerst Ihren Herzfrequenzmesser so konfigurieren, dass regelmäßig Messwerte gesendet werden. </font><font style="vertical-align: inherit;">Ich konnte dies nur tun, indem ich nicht funktionierende Beispiele studierte und tippte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesem Grund habe ich eine Klasse für die Arbeit mit einem Herzfrequenzsensor geschrieben, der automatisch versucht, eine Verbindung herzustellen, und regelmäßig die aktuelle Herzfrequenz meldet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie für Statistiken und Grafiken. </font><font style="vertical-align: inherit;">Ich habe mich entschieden, das Rad nicht neu zu erfinden, sondern das zu verwenden, was ich bereits beim Fahrradfahren benutze, nämlich mich irgendwie mit der wunderbaren Samsung Health App anzufreunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt wird es wahrscheinlich so aussehen, als würde ich wieder für Samsung werben. </font><font style="vertical-align: inherit;">Aber auf einem Fahrrad hat sich diese Anwendung wirklich sehr gut bewährt. </font><font style="vertical-align: inherit;">Zu meiner Überraschung lässt es sich problemlos mit allen Sensoren verbinden, zeigt sowohl die Trittfrequenz als auch die Raddrehzahl an und diktiert die Statistiken in den Kopfhörern, zeigt die gleichen Statistiken mit Grafiken an, gibt Erfolge aus und speichert alles in der Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Suche ergab, dass Samsung Health über ein eigenes SDK verfügt, das zwar nicht vollständig verständlich ist, aber dennoch dokumentiert ist: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Arbeit damit basiert im Wesentlichen auf einer Datenbank, in der eine Vielzahl von Messwerten gespeichert ist, von durchgeführten Schritten und Herzfrequenzmessungen bis hin zu Blutzucker- und Schlafphasen. </font><font style="vertical-align: inherit;">Aber jetzt sind wir an Aufzeichnungen von Übungen interessiert, die sowohl skalare Werte wie die Art der Übung, Zeit, Entfernung, Dauer, verbrannte Kalorien als auch Anordnungen von Live-Daten wie die Geschichte von Herzfrequenz, Geschwindigkeit und Koordinaten enthalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle diese Daten müssen korrekt gespeichert und aufbereitet werden. </font><font style="vertical-align: inherit;">Einige müssen berechnet werden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Höhenberechnung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel Hubhöhe. </font><font style="vertical-align: inherit;">Vom Laufband kennen wir den Steigwinkel zu jedem Zeitpunkt, der in Prozent gemessen wird. </font><font style="vertical-align: inherit;">Der Prozentsatz des Höhenwinkels ist das Verhältnis der zurückgelegten Strecke zum Aufstieg. </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass die vertikale Geschwindigkeit gleich der üblichen Geschwindigkeit multipliziert mit der Steigung in Prozent ist und durch einhundert geteilt wird. </font><font style="vertical-align: inherit;">Wenn wir die vertikale Geschwindigkeit kennen, können wir die aktuelle Höhe zu jedem Zeitpunkt berechnen. </font><font style="vertical-align: inherit;">Infolgedessen muss es in die aktuellen Koordinaten eingegeben werden, obwohl sie sich während der Übung nicht ändern und nicht berücksichtigt werden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Reaktion auf diese Daten zeigt die Samsung Health App, wie viel ich angeblich geklettert bin, sowie die vertikale Geschwindigkeit zu jedem Zeitpunkt des Trainings.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kalorienzählen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wie zählt man Kalorien? Darüber hinaus ist die Kalorienzählung ein Muss für Samsung Health. Gleichzeitig ist der Kalorienverbrauch ein sehr ungenauer Indikator, der von vielen verschiedenen Faktoren abhängt. Ich bin mir nicht sicher, ob es Sinn macht, sie zu zählen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mir nichts Eigenes ausgedacht und einfach den Taschenrechner (https://42.195km.net/e/treadsim/) googelt und den Algorithmus aus meinem Javascript (https://42.195km.net/e/treadsim/treadsim107) kopiert .js). Am Eingang nimmt er die zurückgelegte Strecke, den Höhenwinkel und ... das Gewicht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich könnte mein Gewicht manuell einstellen, aber da wir mit Samsung Health arbeiten, kann ich mein aktuelles Gewicht von dort nehmen. </font><font style="vertical-align: inherit;">Immerhin verwende ich intelligente Waagen von Xiaomi, die mit Google Fit auf meinem Handy synchronisiert sind. Google FIt wird über eine separate Anwendung mit Samsung Health synchronisiert. Samsung Health wird über die Cloud mit sich selbst auf dem Tablet synchronisiert, auf dem meine Anwendung es bereits empfängt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">App Aussehen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visuell besteht die Aufgabe der Anwendung darin, die Hauptindikationen in großem Maßstab anzuzeigen: Geschwindigkeit, Winkel, Herzfrequenz, Entfernung, Kalorien. Es ist besser, dies in Weiß auf schwarzem Hintergrund zu tun, damit der Batterieverbrauch bei Verwendung des AMOLED-Bildschirms minimal ist, da wir auf jeden Fall darauf hinweisen, dass der Bildschirm bei der Anzeige unserer Aktivitäten ständig eingeschaltet sein sollte. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Tasten werden automatisch ausgeblendet, wenn das Laufband aktiv ist. Sie können das Training nur mit der Geschwindigkeit Null starten und beenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und natürlich müssen Sie den Modus „Bild in Bild“ unterstützen. Dies geschieht in nur wenigen Zeilen. Sie müssen nur im Manifest angeben, dass die Aktivität diesen Modus unterstützt, und im Code darauf zugreifen, wenn die Anwendung minimiert wird. So können Sie beispielsweise YouTube ansehen und Laufbandwerte in einer Ecke des Bildschirms anzeigen. Es stellte sich als sehr praktisch heraus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber zu diesem Zeitpunkt wurde ich schließlich von den Schmerzen des Entwicklers für Android überholt, da ich bereits vier verschiedene Bildschirmgrößen habe: das Telefon und das Tablet im normalen Modus und sie befinden sich auch im Modus „Bild in Bild“. Und so kam es, dass, wenn ich die normale Schriftgröße für eine Bildschirmgröße auswähle, in anderen Fällen alles zu klein und dann zu groß ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Entwicklung für Android gibt es mehrere Kategorien von Bildschirmen, und Sie können festlegen, dass unterschiedliche Einstellungen automatisch für sie angewendet werden. In meinem Fall war dies jedoch nicht ausreichend. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen musste ich die Schriftgrößen im Code berechnen und einstellen, was ich für sehr falsch halte. </font><font style="vertical-align: inherit;">Infolgedessen funktioniert es jedoch perfekt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier ist das Ergebnis. </font><font style="vertical-align: inherit;">Wir öffnen die Anwendung, warten auf die Verbindung mit dem Laufband und dem Herzfrequenzsensor, beginnen mit dem Training und verwenden das Laufband wie gewohnt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende des Trainings stoppen wir das Laufband. </font><font style="vertical-align: inherit;">Bei Erreichen der Geschwindigkeit Null erscheint die Schaltfläche „Training beenden“. </font><font style="vertical-align: inherit;">Klicken Sie darauf, und die Statistiken werden an Samsung Health gesendet. </font><font style="vertical-align: inherit;">Öffnen Sie es und sehen Sie alle Daten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können die Grafik von Puls, Geschwindigkeit und Anstieg sehen, Ihren Fortschritt in verschiedenen Zeitintervallen vergleichen, all dies wird in der Cloud gespeichert und ist von allen Geräten aus zugänglich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können es mit Google Fit synchronisieren. </font><font style="vertical-align: inherit;">Die Schönheit. </font><font style="vertical-align: inherit;">Ich bin mit dem Ergebnis zufrieden. </font><font style="vertical-align: inherit;">Jetzt ist die Hauptsache, keine Klassen zu werfen. </font><font style="vertical-align: inherit;">Sie können die Funktionalität der Anwendung erweitern, sodass sie dem Training ähnelt, wenn ich lange Zeit faul bin. </font><font style="vertical-align: inherit;">Aber ich bin schon zu faul, um diese Funktion auszuführen.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502354/index.html">IaaS-Anbieter kämpfen für den europäischen Markt und diskutieren die Situation und Branchenereignisse</a></li>
<li><a href="../de502358/index.html">Implementierung von MVP basierend auf ApplicationController und IoC in einer WinForms-Anwendung</a></li>
<li><a href="../de502360/index.html">Grizzly Discharges oder Super Drill</a></li>
<li><a href="../de502362/index.html">Lernereignisverfolgung für Windows: Theorie und Praxis</a></li>
<li><a href="../de502366/index.html">Vergleichen Sie die Arbeit von Open Source Python - Bibliotheken zur Erkennung benannter Entitäten</a></li>
<li><a href="../de502370/index.html">Das Spiel "Snake" auf das Steckbrett legen. Teil 1: Zustandsautomaten</a></li>
<li><a href="../de502372/index.html">Probleme und Prinzipien der Anpassung der Box-Version von Bitrix24</a></li>
<li><a href="../de502374/index.html">FT8-Kommunikationsprotokoll - wie es funktioniert</a></li>
<li><a href="../de502380/index.html">Sellerie + Asyncio</a></li>
<li><a href="../de502382/index.html">Interface Bikes Giftiger Großvater. "Lügen, Drohungen und Erpressung." (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>