<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧦 🧘🏻 🉐 Unter der Haube des Yandex.Music Bot-Clients 🏺 🏨 🕡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einführung
 Hallo Habr! Wieder bin ich mit dem zweiten Artikel, der die Yandex.Music-API betrifft. Der Fall wird im ersten Artikel geplant und erwähnt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unter der Haube des Yandex.Music Bot-Clients</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487428/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hallo Habr! </font><font style="vertical-align: inherit;">Wieder bin ich mit dem zweiten Artikel, der die Yandex.Music-API betrifft. </font><font style="vertical-align: inherit;">Der Fall wird im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ersten Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geplant und erwähnt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hände erreicht, fertig. </font><font style="vertical-align: inherit;">Heute werde ich über interessante Momente sprechen, die meiner Meinung nach in der Codebasis meines Telegramm-Bots vorhanden sind, der sich als vollwertiger Kunde von Musik positioniert. </font><font style="vertical-align: inherit;">Wir werden auch die Yandex-Musikerkennungs-API berühren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie mit der Punkt-für-Punkt-Geschichte der Implementierung einer bestimmten Sache fortfahren, sollten Sie sich ein Bild über den Bot selbst und seine funktionalen Fähigkeiten machen.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client-Video-Demo</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/YOw9hs8tFg0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Hauptteil werde ich über Folgendes sprechen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melden Sie sich über die Website auf </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub-Seiten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Ihrem Konto an </font><font style="vertical-align: inherit;">(warum und warum).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Datenformat, seine Verpackung und Verwendung in Schaltflächendaten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktualisieren Sie das Routing, die Datenversionierung und den Kontext, der in Handler geworfen wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dienstleistungen:</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service-Reload-Track im Telegramm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Dienst der "Abonnements", um einen Titel mit dem Senden des Status des Downloads zu erhalten.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die einfachste und eleganteste Implementierung für das Zwischenspeichern von Abfragen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erkennung eines Titels durch Sprachnachricht und wie er im Bot allgemein angezeigt wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kleine Notizen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie an mindestens einem Punkt interessiert sind - willkommen bei cat.</font></font><br>
<img src="https://habrastorage.org/webt/uv/4s/a3/uv4sa3pslohuzlmuzrjzteju2dk.png"><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Bot arbeitet mit Benutzern, die sich in ihrem Konto angemeldet haben, aber nein. </font><font style="vertical-align: inherit;">Alles dreht sich um vier Hauptdienstklassen: Album, Künstler, Wiedergabeliste und Titel. </font><font style="vertical-align: inherit;">Alle Entitätsdaten werden unterstützt, es gibt eine Paginierung mit Seitenauswahl. </font><font style="vertical-align: inherit;">Um mit ihnen zu interagieren, kann ein autorisierter Benutzer sein persönliches Menü verwenden, das Folgendes umfasst: intelligente Wiedergabelisten, die Wiedergabeliste „Ich mag“ und eigene Wiedergabelisten. </font><font style="vertical-align: inherit;">Für nicht autorisierte Benutzer ist eine Suche verfügbar, bei der eine Suchanfrage als reguläre Nachricht gesendet wird. </font><font style="vertical-align: inherit;">Jetzt gibt es nur noch eine trockene Liste dessen, was es sonst noch gibt: Empfangen von Titeln und anderen Objekten über einen direkten Link, Empfangen von Texten, die Möglichkeit, den Titel und den Künstler zu mögen / nicht zu mögen, ähnliche Titel anzuzeigen, den Titel anhand einer Sprachnachricht zu erkennen und vieles mehr.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hauptteil</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Melden Sie sich bei Ihrem Konto an</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ursprünglich war nicht geplant, dass der Bot ohne Autorisierung funktioniert. Daher wurde auch während des Entwurfs entschieden, wie die Autorisierung erfolgen soll - über </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seine Website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Die Hauptargumente waren Sicherheit und Transparenz. In keinem Fall wollte Benutzeranmeldungen und Passwörter in klaren Nachrichten nicht akzeptieren. Die Autorisierung vom Computer des Benutzers ist elementar. Daher wurde eine Site zur Autorisierung von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">React geschrieben</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es ist eine Form der Autorisierung mit einer Weiterleitung zurück zum Bot. Ein Stück mit Autorisierung und Verarbeitung von Captcha wurde aus der Bibliothek in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entnommen </font><font style="vertical-align: inherit;">und in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript neu geschrieben</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Autorisierung wird das empfangene OAuth-Token verwendet, das über </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Deep Linking</font></a><font style="vertical-align: inherit;"> zurück an den Bot übertragen wird</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der letzte Link für die Umleitung sieht folgendermaßen aus: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/music_yandex_bot?start={oauth_token}</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ich wollte es besser, aber die Benutzer hatten kein Vertrauen. Nur jeder zehnte Benutzer wurde autorisiert (zu dem Zeitpunkt, als dies obligatorisch war). Daher musste ich mit den folgenden Updates erklären, warum Sie vertrauen sollten. Alle Artikel zu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ausschließlich zu Anfragen von Seiten des Clients und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open Source Code,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurden auf der Site zur Autorisierung veröffentlicht und in einer Begrüßungsnachricht im Bot dupliziert. Wurde besser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter den Faktoren geringer Autorisierung erwies sich die Unzugänglichkeit von Spiegeln für t.me in Russland als Unterstützung nur für Benutzer mit einem Abonnement (mehr dazu im Anhang, Absatz 7).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste Element wurde mithilfe des </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URI</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tg: //</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">aufgelöst. Zur </font><font style="vertical-align: inherit;">Not gibt es bereits einen Link zum Spiegel (wenn die automatische Umleitung nicht funktioniert hat und die Schaltfläche nicht geholfen hat), und das zweite Element befindet sich wieder in Element 7.</font></font><br>
<img src="https://habrastorage.org/webt/ez/2_/0j/ez2_0japfosbu9k4bjelikl8x-i.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Datenformat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für diesen Bot habe ich mich zum ersten Mal für </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DB - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB entschieden</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Verstanden: Wenn </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dokument </font><i><font style="vertical-align: inherit;">eingebettet ist</font></i><font style="vertical-align: inherit;"> , wenn nicht. Arbeitete gern mit Mongoengine. Aber ich wollte wirklich nicht alle Schaltflächendaten zu Hause speichern, und der Client hat nur die </font><font style="vertical-align: inherit;">Datensatz- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in der Datenbank. Ich hatte Angst vor der Datenmenge, wollte aber einen kostenlosen Mongo-Server mit einem Limit von 512 MB für die Datenspeicherung verwenden. Es ist viel schwieriger, eine schöne Wiederverwendung von Datensätzen zu finden, wenn die Daten in mehreren Schaltflächen übereinstimmen, und veraltete zu bereinigen, als alles in den Schaltflächen selbst zu speichern. Nachdem ich die Größe der zu speichernden Daten analysiert hatte, kam ich zu dem Schluss, dass sie leicht passen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst habe ich nur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON verwendet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aber er lehnte es sehr schnell ab, als er an ein Limit stieß. In Telegramm darf der Inhalt der Schaltflächendaten in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nur 64 Byte </font><i><font style="vertical-align: inherit;">betragen</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher begann ich mit der Aufforderung eines Freundes, das </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus dem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strukturmodul zu betrachten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . So wurden die Arten von Abfragen geboren, das primitive Format, das Verpacken und Auspacken. Jetzt wird es im Bot absolut überall eingesetzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Format ist sehr einfach. Das erste Byte ist der Typ, das zweite die Version. Alles andere sind Daten für einen bestimmten Typ. Typen werden als Enum gespeichert und haben eine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die das erste Byte ist. Zusätzlich zur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verfügt jeder Typ über ein Format zum Packen und Entpacken von Daten. Beispiel: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben Sie SHOW_TRACK_MENU ein</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wessen Format hat den Wert "s?", wobei "s" die eindeutige Kennung der Spur ist und "?" - Hat der Track Text? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei Tracks wird ein String-Typ verwendet, weil: Erstens kann die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des Tracks eine Verkettung von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und Album- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des Tracks durch den Doppelpunkt sein, und zweitens kann es sich um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die UUID handeln</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tracks mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - selbst geladene Tracks, die nur dem Benutzer zur Verfügung stehen, der sie heruntergeladen hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da die Daten beispielsweise nicht immer dem Format entsprechen, </font><font style="vertical-align: inherit;">kann </font><font style="vertical-align: inherit;">dieselbe </font><font style="vertical-align: inherit;">Spur- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einfach durch eine Zahl dargestellt werden. Vor dem Packen muss sie in einen Typ für das Format umgewandelt werden. In diesem Fall </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Daher gibt es in der Klasse eine Methode, die die übertragenen Daten für das Packen normalisiert, um dies beim Übergeben an den Konstruktor nicht selbst zu tun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saiten sind autark und können ihre Länge beim Verpacken angeben und diese Länge beim Auspacken berücksichtigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Unterstützung älterer Versionen war nicht geplant, daher wird eine Ausnahme ausgelöst, wenn die Versionen nicht übereinstimmen. </font><font style="vertical-align: inherit;">Bei der Verarbeitung von Updates, auf die ich im nächsten Absatz eingehen werde, wird die erforderliche Logik aufgerufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da Telegram ausschließlich </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> isst </font><font style="vertical-align: inherit;">, werden die gepackten Daten in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> codiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ja, ich verliere hier an Geschwindigkeit und speichere die kleinste Größe ohne Verwendung von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base64</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber angesichts der kleinen Daten halte ich die Verwendung von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85 für</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> angemessen.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle. </font><font style="vertical-align: inherit;">Datei callback_data.py</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> base64<font></font>
<font></font>
<span class="hljs-keyword">from</span> ext.query_types <span class="hljs-keyword">import</span> QueryType<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadDataVersion</span>(<span class="hljs-params">Exception</span>):</span>
    <span class="hljs-keyword">pass</span><font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CallbackData</span>:</span>
    ACTUAL_VERSION = <span class="hljs-number">7</span>
    BASE_FORMAT = <span class="hljs-string">'&lt;BB'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, type_: QueryType, data=None, version=None</span>):</span><font></font>
        self.type = type_<font></font>
        self.version = version <span class="hljs-keyword">or</span> CallbackData.ACTUAL_VERSION<font></font>
        self.data = data<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isinstance(self.data, list):<font></font>
            self.data = [self.data]<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.data = self._normalize_data_to_format(self.data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'&lt;CallbackData&gt; Type: <span class="hljs-subst">{self.type}</span> Version: <span class="hljs-subst">{self.version}</span> Data: <span class="hljs-subst">{self.data}</span>'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_normalize_data_to_format</span>(<span class="hljs-params">self, data, bytes_object=False</span>):</span><font></font>
        normalized_data = data.copy()<font></font>
        <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> enumerate(self.type.format):<font></font>
            cast = str<font></font>
            <span class="hljs-keyword">if</span> c.lower() <span class="hljs-keyword">in</span> <span class="hljs-string">'bhilqn'</span>:<font></font>
                cast = int<font></font>
            <span class="hljs-keyword">elif</span> c <span class="hljs-keyword">in</span> <span class="hljs-string">'efd'</span>:<font></font>
                cast = float<font></font>
            <span class="hljs-keyword">elif</span> c == <span class="hljs-string">'?'</span>:<font></font>
                cast = bool<font></font>
<font></font>
            casted = cast(data[i])<font></font>
            <span class="hljs-keyword">if</span> bytes_object <span class="hljs-keyword">and</span> cast == str:<font></font>
                casted = casted.encode(<span class="hljs-string">'utf-8'</span>)<font></font>
            normalized_data[i] = casted<font></font>
<font></font>
        <span class="hljs-keyword">return</span> normalized_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode_type</span>(<span class="hljs-params">callback_data</span>):</span>
        decoded = base64.b85decode(callback_data.encode(<span class="hljs-string">'utf-8'</span>))<font></font>
        type_, version = struct.unpack(CallbackData.BASE_FORMAT, decoded[:<span class="hljs-number">2</span>])<font></font>
<font></font>
        <span class="hljs-keyword">if</span> CallbackData.ACTUAL_VERSION != version:
            <span class="hljs-keyword">raise</span> BadDataVersion()<font></font>
<font></font>
        <span class="hljs-keyword">return</span> QueryType(type_), version, decoded<font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span>(<span class="hljs-params">cls, type_, version, decoded</span>):</span>
        start, data = <span class="hljs-number">2</span>, []<font></font>
<font></font>
        <span class="hljs-keyword">if</span> start &lt; len(decoded):<font></font>
            format_iter = iter(type_.format)<font></font>
<font></font>
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-keyword">if</span> start &gt;= len(decoded):
                    <span class="hljs-keyword">break</span><font></font>
<font></font>
                format_ = next(format_iter, type_.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                decode_str = format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>
                <span class="hljs-keyword">if</span> decode_str:
                    <span class="hljs-comment"># struct.calcsize('b') = 1</span>
                    length = list(struct.unpack(<span class="hljs-string">'b'</span>, decoded[start: start + <span class="hljs-number">1</span>]))[<span class="hljs-number">0</span>]<font></font>
                    start += <span class="hljs-number">1</span><font></font>
<font></font>
                    format_ = <span class="hljs-string">f'<span class="hljs-subst">{length}</span><span class="hljs-subst">{format_}</span>'</span><font></font>
<font></font>
                step = struct.calcsize(format_)<font></font>
<font></font>
                unpacked = list(struct.unpack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, decoded[start: start + step]))
                <span class="hljs-keyword">if</span> decode_str:<font></font>
                    unpacked[<span class="hljs-number">0</span>] = unpacked[<span class="hljs-number">0</span>].decode(<span class="hljs-string">'UTF-8'</span>)<font></font>
<font></font>
                data += unpacked<font></font>
                start += step<font></font>
<font></font>
        <span class="hljs-keyword">return</span> cls(type_, data <span class="hljs-keyword">if</span> data <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, version)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encode</span>(<span class="hljs-params">self</span>):</span><font></font>
        encode = struct.pack(self.BASE_FORMAT, self.type.value, self.version)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            format_iter = iter(self.type.format)<font></font>
            normalized_data = self._normalize_data_to_format(self.data, bytes_object=<span class="hljs-literal">True</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> normalized_data:<font></font>
                format_ = next(format_iter, self.type.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                <span class="hljs-keyword">if</span> format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>:
                    <span class="hljs-comment">#        .  'b'  </span>
                    <span class="hljs-comment"># -      ,    &gt; 36 </span>
                    encode += struct.pack(<span class="hljs-string">'b'</span>, len(data))<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{len(data)}</span><span class="hljs-subst">{format_}</span>'</span>, data)
                <span class="hljs-keyword">else</span>:<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, data)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> base64.b85encode(encode).decode(<span class="hljs-string">'utf-8'</span>)<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Routing von Updates und Kontext</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Projekt verwendet die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python-Telegramm-Bot-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">, um mit der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegramm-Bot-API zu arbeiten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es gibt bereits ein System zum Registrieren von Handlern für bestimmte eingetroffene Aktualisierungstypen, Filter für reguläre Ausdrücke, Befehle usw. </font><font style="vertical-align: inherit;">Aufgrund meines eigenen Datenformats und meiner Typen musste ich jedoch von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelegramHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erben </font><font style="vertical-align: inherit;">und meinen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementieren </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update und Kontext werden über Argumente an jeden Handler übergeben. </font><font style="vertical-align: inherit;">In diesem Fall habe ich meinen eigenen Kontext und er befindet sich in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es wird gebildet, und dies ist: Empfangen und / oder Hinzufügen eines Benutzers zur Datenbank, Überprüfen der Relevanz des Tokens für den Zugriff auf Musik, Initialisieren des Yandex.Music-Clients, abhängig vom Autorisierungsstatus und der Verfügbarkeit eines Abonnements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weiter von meinem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'a gibt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es spezifischere Handler, zum Beispiel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallbackQueryHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Damit wird ein Handler für eine bestimmte Art von Aktualisierung registriert (mein Typ, mit einem Datenformat). Um zu überprüfen, ob dieses Update für den aktuellen Handler geeignet ist, werden nicht alle Daten entpackt, sondern nur die ersten beiden Bytes. Zu diesem Zeitpunkt wird überprüft, ob ein Rückruf gestartet werden muss. Nur wenn das Starten des Rückrufs erforderlich ist - werden die Daten vollständig entpackt und als </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kwargs übertragen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zum letzten Handler. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ab</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sofort werden analytische Daten an </font><i><font style="vertical-align: inherit;">ChatBase gesendet</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Registrierung erfolgt nacheinander, und die Priorität ist höher für diejenigen, die früher registriert werden (tatsächlich wie beim </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Routing und in anderen Projekten). </font><font style="vertical-align: inherit;">Daher ist die Registrierung eines Handlers für eine veraltete Version die erste unter den </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallBackQuery-Handlern</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Logik der Verarbeitung der veralteten Version ist einfach - informieren Sie den Benutzer darüber und senden Sie nach Möglichkeit aktualisierte Daten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Dienstleistungen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Dienste werden initialisiert, wenn der Bot in einer Steuerungsklasse gestartet wird, die dann überall im Bot ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DJ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">universell verwendet wird </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Dienst verfügt über einen eigenen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadPoolExecutor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einer bestimmten Anzahl von Mitarbeitern, an die Aufgaben </font><i><font style="vertical-align: inherit;">gesendet</font></i><font style="vertical-align: inherit;"> werden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einen Track in Telegram neu laden</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derzeit wurde dieser Dienst nicht in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User Bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> umgeschrieben, </font><font style="vertical-align: inherit;">um die Beschränkung der Größe der heruntergeladenen Datei in Telegram zu umgehen. Wie sich herausstellte, gibt es in Yandex.Music Dateien, die größer als 50 MB sind - Podcasts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Dienst überprüft die Dateigröße und gibt im Falle eines Überschusses eine Warnung an den Benutzer aus. Dank des in Absatz 5 beschriebenen Caching-Systems wird die Verfügbarkeit und der Empfang der Texte überprüft. Tracks werden ebenfalls zwischengespeichert. Der Hash der Datei wird in der Datenbank gespeichert. Wenn es einen gibt, wird Audio mit einem bekannten Cache gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn keine Datei in der Datenbank vorhanden ist, wird ein direkter Link von Yandex.Music empfangen. Im Moment haben Benutzer zwar nicht die Möglichkeit, die Qualitätseinstellungen zu ändern, aber alle sind auf Standardwerte eingestellt. Die Datei wird in den Benutzereinstellungen nach Bitrate und Codec gesucht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Datei und ihr Cover werden als </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempfile.TemporaryFile ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> heruntergeladen und </font><i><font style="vertical-align: inherit;">anschließend</font></i><font style="vertical-align: inherit;"> in Telegram hochgeladen. </font><font style="vertical-align: inherit;">Es ist erwähnenswert, dass TG die Dauer des Tracks nicht immer richtig erkennt, aber ich schweige im Allgemeinen über den Künstler und den Titel. </font><font style="vertical-align: inherit;">Daher stammen diese Daten von Yandex, zum Glück ist es möglich, sie in den Warenkorb zu übertragen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine Audiodatei von diesem Dienst gesendet wird, wird </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finish_callback ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aufgerufen </font><font style="vertical-align: inherit;">, um den Dienst per Abonnement gegen Ende des Downloads zu signalisieren.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abonnement-Service zum Empfangen von Titeln und zum Senden des Download-Status</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tracks werden nicht sofort geladen. Es ist möglich, dass mehrere Benutzer denselben Titel angefordert haben. In diesem Fall ist der Benutzer, der den Track zuerst angefordert hat, der Initiator und Eigentümer des Tracks. Wenn das Laden länger als eine Sekunde dauert, beginnt der Download-Status: "Der Benutzer sendet eine Sprachnachricht". Andere Benutzer, die denselben Titel angefordert haben, sind reguläre Abonnenten. Sie erhalten wie der Eigentümer alle ~ 4 Sekunden den Download-Status, damit die Nachricht nicht unterbrochen wird (der Status bleibt 5 Sekunden lang hängen). Sobald der Download des Titels für den Eigentümer abgeschlossen ist, wird </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finish_callback ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vom obigen Dienst </font><font style="vertical-align: inherit;">aufgerufen </font><font style="vertical-align: inherit;">. Danach werden alle Abonnenten aus der Statusliste gelöscht und erhalten den heruntergeladenen Titel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Architekturlösung ist der Eigentümer des Tracks auch ein Abonnent, jedoch mit einer bestimmten Markierung, da die Arten des Sendens des Tracks unterschiedlich sind.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Abfrage-Caching</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir uns aus meinem letzten Artikel erinnern, sind die Anfragen an die Yandex.Music-API sehr hoch. Die Liste der Tracks kann 3 oder 5 MB groß sein. Darüber hinaus gibt es nur viele Anfragen. Bei jeder Aktualisierungsverarbeitung werden mindestens zwei Anforderungen an Yandex gesendet: zum Initialisieren des Clients und für eine bestimmte Aktion. Um genügend Informationen zu sammeln (z. B. für eine Wiedergabeliste), müssen Sie an einigen Stellen eine Wiedergabeliste anfordern, ihre Titel empfangen, Informationen von der Zielseite abrufen (wenn es sich um eine intelligente Wiedergabeliste handelt) und die Initialisierung des Clients nicht vergessen. Im Allgemeinen leiser Horror in Bezug auf die Anzahl der Anfragen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich wollte etwas sehr Universelles und keine Speicherung für bestimmte Objekte, die gleichen Kunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da Sie in der Bibliothek zusätzlich zu den </font><i><font style="vertical-align: inherit;">Anforderungen</font></i><font style="vertical-align: inherit;"> Ihre eigene Instanz für die Ausführung von Abfragen angeben können</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dann habe ich das ausgenutzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Punkt ist einfach. Die Cache-Klasse selbst ist ein Singleton. Es gibt nur zwei Parameter: Cache-Lebensdauer, Größe. Wenn die Anforderung ausgeführt wird, wird der Wrapper aufgerufen. Er wird überschrieben. Das Überprüfen des Caches erfolgt durch Hash von eingefrorenen Args und Quarts. Der Cache hat Zeit zum Hinzufügen. Bei der Überprüfung der Notwendigkeit der Aktualisierung der Daten werden entweder Daten von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LimitedSizeDict abgerufen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder eine echte Anforderung gestellt und dem Cache hinzugefügt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige Anforderungen können nicht zwischengespeichert werden, z. B. das Festlegen eines "Gefällt mir" / "Gefällt mir nicht". Wenn der Benutzer die folgende Sequenz drückt: "Gefällt mir", "Gefällt mir nicht", "Gefällt mir", wird am Ende das Gleiche nicht geliefert. In solchen Fällen müssen Sie beim Senden einer Anforderung das Argument </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_cache</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einem Wert gleich </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False übergeben</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dies ist der einzige Ort, an dem der Cache nicht verwendet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dank dessen mache ich die kühnsten Anfragen, damit sie zwischengespeichert werden. </font><font style="vertical-align: inherit;">Ich versuche nicht, es in kleine zu unterteilen, die nur für die aktuelle Seite benötigt werden. </font><font style="vertical-align: inherit;">Ich nehme alles auf einmal und beim Wechseln zwischen Seiten habe ich eine enorme Umschaltgeschwindigkeit (im Vergleich zum alten Ansatz). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zwischengespeicherte Anforderungsklasse hat sich für mich als wunderschön herausgestellt und wurde einfach integriert.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> copy
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Union
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict<font></font>
<font></font>
<span class="hljs-keyword">import</span> requests<font></font>
<font></font>
<span class="hljs-keyword">from</span> yandex_music.utils.request <span class="hljs-keyword">import</span> Request <span class="hljs-keyword">as</span> YandexMusicRequest<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LimitedSizeDict</span>(<span class="hljs-params">OrderedDict</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        self.size_limit = kwargs.pop(<span class="hljs-string">"size_limit"</span>, <span class="hljs-literal">None</span>)<font></font>
        OrderedDict.__init__(self, *args, **kwargs)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__setitem__</span>(<span class="hljs-params">self, key, value</span>):</span><font></font>
        OrderedDict.__setitem__(self, key, value)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_check_size_limit</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">if</span> self.size_limit <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">while</span> len(self) &gt; self.size_limit:<font></font>
                self.popitem(last=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedItem</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, response: requests.Response</span>):</span><font></font>
        self.timestamp = time.time()<font></font>
        self.response = response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span>:</span>
    __singleton: <span class="hljs-string">'Cache'</span> = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, lifetime: Union[str, int], size: Union[str, int]</span>):</span><font></font>
        Cache.__singleton = self<font></font>
<font></font>
        self.lifetime = int(lifetime) * <span class="hljs-number">60</span><font></font>
        self.size = int(size)<font></font>
<font></font>
        self.storage: LimitedSizeDict = LimitedSizeDict(size_limit=int(size))<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> self.storage[hash_].response<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">self, response: requests.Response, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        self.storage.update({hash_: CachedItem(response)})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">need_to_fetch</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        cached_item = self.storage.get(hash_)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cached_item:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> time.time() - cached_item.timestamp &gt; self.lifetime:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_instance</span>(<span class="hljs-params">cls</span>) -&gt; 'Cache':</span>
        <span class="hljs-keyword">if</span> cls.__singleton <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> cls.__singleton
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f'<span class="hljs-subst">{cls.__name__}</span> not initialized'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_dict</span>(<span class="hljs-params">d: dict</span>) -&gt; Union[frozenset, tuple, dict]:</span>
        <span class="hljs-keyword">if</span> isinstance(d, dict):
            <span class="hljs-keyword">return</span> frozenset((key, Cache.freeze_dict(value)) <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> d.items())
        <span class="hljs-keyword">elif</span> isinstance(d, list):
            <span class="hljs-keyword">return</span> tuple(Cache.freeze_dict(value) <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> d)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> d<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_hash</span>(<span class="hljs-params">*args, **kwargs</span>):</span>
        <span class="hljs-keyword">return</span> hash((args, Cache.freeze_dict(kwargs)))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span>(<span class="hljs-params">YandexMusicRequest</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_request_wrapper</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        use_cache = kwargs.get(<span class="hljs-string">'use_cache'</span>, <span class="hljs-literal">True</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'use_cache'</span> <span class="hljs-keyword">in</span> kwargs:<font></font>
            kwargs.pop(<span class="hljs-string">'use_cache'</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> use_cache:<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
        <span class="hljs-keyword">elif</span> use_cache <span class="hljs-keyword">and</span> Cache.get_instance().need_to_fetch(*args, **kwargs):<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
            Cache.get_instance().update(response, *args, **kwargs)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            response = Cache.get_instance().get(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> response<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Verfolgen Sie die Erkennung per Sprachnachricht</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Anfang gab es keinen Gedanken, dies dem Bot hinzuzufügen, aber es passierte eine interessante Situation. Der Bot hat einen Chat (dies wird in der Beschreibung des Bots angegeben). Nach einiger Zeit bemerkte ich, dass Leute hineingehen und Sprachnachrichten mit Musik senden. Zuerst dachte ich, es sei eine neue Art von Spam, so dass jemand einen Bottom machte und Spaß machte. Aber als es bereits 10 solcher Leute gab und alle das Gleiche taten, schlug mein Freund (derselbe, der von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vorgeschlagen wurde </font><font style="vertical-align: inherit;">) vor, dass Benutzer Yandex.Music auf der Suche nach einem offiziellen Bot fahren sollten, um Musik von Yandex zu erkennen. Sie sehen dort einen Chatraum und senden ihm in aller Ernsthaftigkeit Sprachnachrichten! Es war nur eine brillante und wahre Annahme. Dann sagte ich scherzhaft, dass es Zeit sei, Anerkennung zu finden und dem Chat einen Bot hinzuzufügen. Zum Spaß ... Nach einer Weile war das erledigt!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun zur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In letzter Zeit hat Yandex zunehmend Web-Sockets verwendet. Ich habe ihre Verwendung bei der Verwaltung eines i.module und einer i.station kennengelernt. Der Musikerkennungsdienst arbeitet auch daran. Ich habe die minimale Arbeitslösung in meinen Bot geworfen, aber die Implementierung nicht zur Bibliothek hinzugefügt. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> befindet sich unter der folgenden Adresse: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wss: //voiceservices.yandex.net/uni.ws</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir benötigen nur zwei Nachrichten - Autorisierung und eine Anforderung zur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erkennung</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex selbst sendet in seiner offiziellen Anwendung kurze Dateien in ein oder drei Sekunden. Als Antwort können Sie die Notwendigkeit erhalten, mehr Daten oder das Ergebnis zu senden - gefunden oder nicht. Wenn das Ergebnis gefunden wird, wird die Track-ID zurückgegeben. </font><i><font style="vertical-align: inherit;">.Ogg-</font></i><font style="vertical-align: inherit;"> Dateien werden mit </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gesendet</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENCODER = SpeechKit Mobile SDK v3.28.0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ich habe nicht überprüft, wie es mit anderen Encodern funktioniert, ich ändere es einfach in der von Telegram aufgezeichneten Datei. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Rückwärtsfahren mit einem Web-Socket passierte manchmal Magie. </font><font style="vertical-align: inherit;">Manchmal konnte ich den Titel nicht finden, aber als ich die Sprache in der Nachricht mit der Erkennungsanforderung änderte, tat ich es. </font><font style="vertical-align: inherit;">Oder zuerst wurde es gefunden und dann gestoppt, obwohl die Datei dieselbe ist. </font><font style="vertical-align: inherit;">Ich dachte, dass die Sprache des Tracks durch ihr </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpeechKit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf dem Client festgelegt wird. </font><font style="vertical-align: inherit;">Da ich nicht die Möglichkeit habe, es selbst zu tun, mache ich eine Brute-Force-Suche.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meine kniegefertigte Implementierung der Spracherkennung durch Sprachnachrichten von Telegramm</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> lomond<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_auth_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"SynchronizeState"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"System"</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"accept_invalid_auth"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"auth_token"</span>: <span class="hljs-string">"5983ba91-339e-443c-8452-390fe7d9d308"</span>,
                <span class="hljs-string">"uuid"</span>: str(uuid.uuid4()).replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">''</span>),<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_asr_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"Recognize"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"ASR"</span>,
                <span class="hljs-string">"streamId"</span>: <span class="hljs-number">1</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"advancedASROptions"</span>: {
                    <span class="hljs-string">"manual_punctuation"</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">"partial_results"</span>: <span class="hljs-literal">False</span><font></font>
                },<font></font>
                <span class="hljs-string">"disableAntimatNormalizer"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"format"</span>: <span class="hljs-string">"audio/opus"</span>,
                <span class="hljs-string">"music_request2"</span>: {
                    <span class="hljs-string">"headers"</span>: {
                        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"audio/opus"</span><font></font>
                    }<font></font>
                },<font></font>
                <span class="hljs-string">"punctuation"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"tags"</span>: <span class="hljs-string">"PASS_AUDIO;"</span>,
                <span class="hljs-string">"topic"</span>: <span class="hljs-string">"queries"</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recognition</span>:</span>
    URI = <span class="hljs-string">'wss://voiceservices.yandex.net/uni.ws'</span>
    LANGS = [<span class="hljs-string">''</span>, <span class="hljs-string">'ru-RU'</span>, <span class="hljs-string">'en-US'</span>]<font></font>
    POLL_DELAY = <span class="hljs-number">0.3</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, binary_data, status_msg</span>):</span><font></font>
        self.status_msg = status_msg<font></font>
        self.websocket = lomond.WebSocket(self.URI)<font></font>
        self.chunks = self.get_chunks_and_replace_encoder(binary_data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_track_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">for</span> lang <span class="hljs-keyword">in</span> Recognition.LANGS:<font></font>
            asr_data = get_asr_data()<font></font>
            <span class="hljs-keyword">if</span> lang:<font></font>
                asr_data[<span class="hljs-string">'event'</span>][<span class="hljs-string">'payload'</span>].update({<span class="hljs-string">'lang'</span>: lang})<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'     <span class="hljs-subst">{lang}</span>...'</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'      ...'</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> self.websocket.connect(poll=self.POLL_DELAY):
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'ready'</span>:<font></font>
                    self.websocket.send_json(get_auth_data())<font></font>
                    self.websocket.send_json(asr_data)<font></font>
<font></font>
                    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.chunks:<font></font>
                        self.websocket.send_binary(chunk)<font></font>
<font></font>
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'text'</span>:<font></font>
                    response = msg.json.get(<span class="hljs-string">'directive'</span>)<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> self.is_valid_response(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">return</span> self.parse_track_id(response)
                    <span class="hljs-keyword">elif</span> self.is_fatal_error(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">break</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_valid_response</span>(<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'success'</span>:<font></font>
            self.status_msg.edit_text(<span class="hljs-string">f' ,  !'</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_fatal_error</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'music'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_track_id</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'payload'</span>][<span class="hljs-string">'data'</span>][<span class="hljs-string">'match'</span>][<span class="hljs-string">'id'</span>]<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_chunks_and_replace_encoder</span>(<span class="hljs-params">binary_data</span>):</span><font></font>
        chunks = []<font></font>
<font></font>
        <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> binary_data.split(<span class="hljs-string">b'OggS'</span>)[<span class="hljs-number">1</span>:]:
            <span class="hljs-keyword">if</span> <span class="hljs-string">b'OpusTags'</span> <span class="hljs-keyword">in</span> chunk:<font></font>
                pos = chunk.index(<span class="hljs-string">b'OpusTags'</span>) + <span class="hljs-number">12</span><font></font>
                size = len(chunk)<font></font>
                chunk = chunk[:pos] + <span class="hljs-string">b'#\x00\x00\x00\x00ENCODER=SpeechKit Mobile SDK v3.28.0'</span>
                chunk += <span class="hljs-string">b"\x00"</span> * (size - len(chunk))<font></font>
<font></font>
            chunks.append(<span class="hljs-string">b'\x00\x00\x00\x01OggS'</span> + chunk)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> chunks<font></font>
<font></font>
</code></pre><br>
     ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"> </a>.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Kleine Notizen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anfänglich konnten nur Benutzer mit einem Abonnement den Bot verwenden, da der Dienst in einer begrenzten Anzahl von Ländern (ohne Abonnement) verwendet werden kann und sich der Server mit dem Bot in Europa befindet. Das Problem wird gelöst, indem ein Proxy verwendet wird, um Anforderungen von Benutzern ohne Abonnement auszuführen. Der Proxyserver befindet sich in Moskau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine Auswahl an Seiten, diese ist jedoch auf 100 begrenzt (es können keine weiteren Schaltflächen hinzugefügt werden, Telegrammbeschränkung). Einige häufig verwendete Seitenanforderungen haben viel mehr Seiten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Yandex-Suche wird die Anzahl der Elemente auf der Seite fest codiert. Wie viele Titel, wie viele Wiedergabelisten. Manchmal entspricht dies nicht einmal der Datenmenge, die auf der Vorderseite angezeigt wird. Es gibt einen Seitenwechsel, die Anzahl der Elemente schwebt. Daher springt es im Bot auch, was nicht sehr schön ist. Und ihren Paginator mit seinem eigenen zu kombinieren - so etwas. An anderen Stellen, an denen eine bestimmte Anzahl von Elementen pro Seite angefordert werden kann, ist alles perfekt. Die Sprachnachricht nach der Implementierung der Suche im Bot lautet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/MarshalC/416</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Audio in Telegramm weitergeleitet wird, geht der Autor verloren und wird demjenigen zugewiesen, der die Weiterleitung vorgenommen hat. Daher werden alle Tracks mit der Signatur des Bot-Benutzernamens gesendet. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Sprachnachricht</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
mit allem, was ich nach der Implementierung des Radios in der Bibliothek getroffen habe - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/MarshalC/422</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(über die Kette von Tracks, die mit dem Senden eines Haufens von Feedback, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">durchlaufen werden</font></i><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der Tatsache, dass dies ein weiterer Artikel über den Telegramm-Bot ist, haben Sie ihn bis hierher gelesen, höchstwahrscheinlich, weil Sie an einem der Artikel im Schnitt interessiert waren und dies ist wunderbar, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vielen Dank</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider habe ich den Quellcode des Bots nicht vollständig geöffnet (da ich an einigen Stellen eine Umgestaltung vornehmen muss). </font><font style="vertical-align: inherit;">In diesem Artikel wurde viel beschrieben, aber einige Aspekte, beispielsweise bei virtuellen Tastaturen und deren Generierung, sind nicht betroffen. </font><font style="vertical-align: inherit;">Zum größten Teil ist das, was nicht in dem Artikel steht, nur die Arbeit mit meiner Bibliothek, nichts Interessantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Klassen, um die sich alles dreht, habe ich in der Form gezeigt, in der sie jetzt sind. Ich gebe zu, dass es Fehler gibt, aber alles funktioniert schon lange. An einigen Stellen mag ich meinen Code, an einigen Stellen nicht - und das ist normal. Vergessen Sie nicht, dass die Arbeit mit WS zur Erkennung eine Lösung für das Knie ist. Bereit, begründete Kritik in den Kommentaren zu lesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obwohl der Bot schon geplant war, als ich anfing, die Bibliothek zu schreiben, lehnte ich diese Idee ab, aber anscheinend kehrte ich zurück (es war langweilig). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Music Bot - ein Projekt, das die Eignung der Verwendung der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bibliothek für die Arbeit mit der API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Projekten belegt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank an Mama, Yana, Sana'a, Ruhm. </font><font style="vertical-align: inherit;">Jemand zum Korrekturlesen von Fehlern, einige für Hinweise, ohne die einige Punkte in diesem Artikel möglicherweise nicht vorhanden wären, und für einige lediglich zum Bewerten des Artikels vor der Veröffentlichung. </font><font style="vertical-align: inherit;">Arthur für picci für den Artikel, Lyod für das Logo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jetzt habe ich ein akutes Problem mit der Verteilung nach dem Studium. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie bereit sind, mich anzurufen - sagen Sie mir, wohin ich den Lebenslauf senden soll, interviewen Sie mich bitte. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle meine Kontakte sind im Profil. </font><font style="vertical-align: inherit;">Das Timing brennt, ich hoffe für dich. </font><font style="vertical-align: inherit;">Nach dem Gesetz kann ich nur in der Republik Belarus trainieren. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dies war der zweite von drei Artikeln, aber ohne die geringste Ahnung werde ich Zeit haben, ein weiteres Projekt zu diesem Thema durchzuführen und ob es benötigt wird. </font><font style="vertical-align: inherit;">Ich werde sein Thema öffentlich bekannt geben - den plattformübergreifenden Kunden Yandex.Music.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487428/">https://habr.com/ru/post/de487428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487418/index.html">Was ist SAP?</a></li>
<li><a href="../de487420/index.html">Sound War Z. Testen von MusicDealer-Lautsprechern und -Kopfhörern</a></li>
<li><a href="../de487422/index.html">Verantwortlichkeiten des Salesforce-Administrators: Was sollte wann getan werden?</a></li>
<li><a href="../de487424/index.html">So skalieren Sie von 1 auf 100.000 Benutzer</a></li>
<li><a href="../de487426/index.html">Flexibilität bestimmt den Erfolg.</a></li>
<li><a href="../de487430/index.html">Welche Fähigkeiten sind erforderlich, um eine iOS-Anwendung zu erstellen? Yandex-Bericht</a></li>
<li><a href="../de487432/index.html">Auf den Spuren von DevConf und CfgMgmtCamp oder was Sie lernen können, indem Sie in 2 Wochen auf zwei internationalen Konferenzen zum Redner gehen</a></li>
<li><a href="../de487438/index.html">Wie erstelle ich ein IT-Unternehmen von Grund auf neu - ohne Erfahrung in diesem Bereich und Programmierkenntnisse?</a></li>
<li><a href="../de487444/index.html">"Während Sie Kaffee trinken, in Rechnung gestellt und einen Push for Payment erhalten" - Innovationen, mit denen Sie rund um die Uhr Geschäfte abwickeln können</a></li>
<li><a href="../de487446/index.html">Kann ein Unternehmen Farbe „besitzen“?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>