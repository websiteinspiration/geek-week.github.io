<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯджЁЯП┐ ЁЯд▒ЁЯП┐ ЁЯТУ DBA: рдлреНрд▓рд╛рдЗрдВрдЧ рд▓реЙрдХ рдХреА рдЦреЛрдЬ рдореЗрдВ ЁЯШд ЁЯзЩЁЯП╛ ЁЯП┤єаБзєаБвєаБ╖єаБмєаБ│єаБ┐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ, рдЬрд╣рд╛рдБ рдореИрдВрдиреЗ PostgreSQL рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХреА рдереА , рд╡рд╣рд╛рдБ рдЗрд╕ рддрд░рд╣ рдХрд╛ рдПрдХ рд╡рд╛рдХреНрдпрд╛рдВрд╢ рдерд╛:
 рдмрдврд╝реЛ wait- рдЖрд╡реЗрджрди рдХрд┐рд╕реА рдХреЗ рддрд╛рд▓реЗ рдкрд░ "рдЖрд░рд╛рдо...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: рдлреНрд▓рд╛рдЗрдВрдЧ рд▓реЙрдХ рдХреА рдЦреЛрдЬ рдореЗрдВ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/503680/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ, рдЬрд╣рд╛рдБ рдореИрдВрдиреЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХреА рдереА</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , рд╡рд╣рд╛рдБ рдЗрд╕ рддрд░рд╣ рдХрд╛ рдПрдХ рд╡рд╛рдХреНрдпрд╛рдВрд╢ рдерд╛:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдмрдврд╝реЛ </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- рдЖрд╡реЗрджрди рдХрд┐рд╕реА </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЗ рддрд╛рд▓реЗ рдкрд░ "рдЖрд░рд╛рдо" рд╣реИ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рдпрджрд┐ рдпрд╣ рдкрд┐рдЫрд▓реЗ рдПрдХ рд╕рдордп рдХреА рд╡рд┐рд╕рдВрдЧрддрд┐ рд╣реИ - рдореВрд▓ рдХрд╛рд░рдг рдХреЛ рд╕рдордЭрдиреЗ рдХрд╛ рдЕрд╡рд╕рд░ред</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рд╕реНрдерд┐рддрд┐ рдбреАрдмреАрдП рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЕрдкреНрд░рд┐рдп рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд╣рд▓реА рдирдЬрд╝рд░ рдореЗрдВ, рдЖрдзрд╛рд░ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЛрдИ рд╕рд░реНрд╡рд░ рд╕рдВрд╕рд╛рдзрди рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... рд▓реЗрдХрд┐рди рдХреБрдЫ рдЕрдиреБрд░реЛрдз "рдзреАрдорд╛"</font></font></li>
</ul><img src="https://habrastorage.org/webt/jy/wa/sk/jywaskrftah-9f7d9xwp3jvkn_q.png" align="right"><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"рдХреНрд╖рдг рдореЗрдВ" рддрд╛рд▓реЗ рдХреЛ рдкрдХрдбрд╝рдиреЗ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
рдХреА рд╕рдВрднрд╛рд╡рдирд╛ </font><font style="vertical-align: inherit;">рдмрд╣реБрдд рдХрдо рд╣реИ, рдФрд░ рд╡реЗ рдХреЗрд╡рд▓ рдХреБрдЫ рд╕реЗрдХрдВрдб рддрдХ рд░рд╣ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрдиреБрд░реЛрдз рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рд╕рдордп рдХреЛ рджрд╕рд┐рдпреЛрдВ рдмрд╛рд░ рдЦрд░рд╛рдм рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рдЖрдк рдмрд╕ рдмреИрдардирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдФрд░ рдСрдирд▓рд╛рдЗрди рдЬреЛ рд╣реЛ рд░рд╣рд╛ рд╣реИ рдЙрд╕реЗ рдкрдХрдбрд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╢рд╛рдВрдд рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреМрди рд╕реЗ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреНрдпрд╛ рд╕рдорд╕реНрдпрд╛ рд╣реИ - рдХреМрди, рдХрд┐рд╕рдХреЗ рд╕рд╛рде рдФрд░ рдХрд┐рд╕ рд╡рдЬрд╣ рд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд╕рдВрд╕рд╛рдзрди рд╕рдВрдШрд░реНрд╖ рдореЗрдВ рдЖрдПред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдкрд░ рдХреИрд╕реЗ? </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЗрд╕рдХреА рдпреЛрдЬрдирд╛ рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЬреЛ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдкрдХреЛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╕рдордЭрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд┐ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдХреНрдпрд╛ рдЧрдпрд╛ рдФрд░ рдХрд┐рддрдирд╛ рд╕рдордп рд▓рдЧрд╛, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рддрд╛рд▓рд╛</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдРрд╕реЗ </font><b><font style="vertical-align: inherit;">рд╕реНрдкрд╖реНрдЯ рдирд┐рд╢рд╛рди рдирд╣реАрдВ рдЫреЛрдбрд╝рддрд╛ рд╣реИ</font></b><font style="vertical-align: inherit;"> ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЬрдм рддрдХ рдХрд┐ рдПрдХ рд▓рдШреБ рдкреНрд░рд╡реЗрд╢ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдирд╣реАрдВ рд╣реИ: </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рдЪрд▓реЛ рдЗрд╕реЗ рдкрдХрдбрд╝рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!</font></font><code><blockquote>process ... <b>still waiting for</b> ...</blockquote></code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рд▓реЙрдЧ рдореЗрдВ рд▓реЙрдХ рдХреЛ рдкрдХрдбрд╝рддреЗ рд╣реИрдВ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд▓реЗрдХрд┐рди рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдХрдо рд╕реЗ рдХрдо рдЗрд╕ рд▓рд╛рдЗрди рдХреЗ рд▓реЙрдЧ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП, рд╕рд░реНрд╡рд░ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">log_lock_waits</a> = <b>'on'</b></code></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... рдФрд░ рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рд▓рд┐рдП рдПрдХ рдиреНрдпреВрдирддрдо рд╕реАрдорд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдВ:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">deadlock_timeout</a> = <b>'100ms'</b></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЬрдм рдкреИрд░рд╛рдореАрдЯрд░ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИ </font></font><code>log_lock_waits</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рддреЛ рдпрд╣ рдкреИрд░рд╛рдореАрдЯрд░ рдпрд╣ рднреА рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрд┐рд╕ рд╕рдордп рдЕрд╡рд░реБрджреНрдз рд╣реЛрдиреЗ рдХреЗ рдЗрдВрддрдЬрд╛рд░ рдХреЗ рд╕рдВрджреЗрд╢ рд╕рд░реНрд╡рд░ рд▓реЙрдЧ рдореЗрдВ рд▓рд┐рдЦреЗ рдЬрд╛рдПрдВрдЧреЗред </font><font style="vertical-align: inherit;">рдпрджрд┐ рдЖрдк рддрд╛рд▓реЗ рдХреЗ рдХрд╛рд░рдг рд╣реЛрдиреЗ рд╡рд╛рд▓реА рджреЗрд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рдореВрд▓реНрдп рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЗрд╕реЗ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИ </font></font><code>deadlock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕ рд╕рдордп рдХреЗ рджреМрд░рд╛рди "рдЕрдирдЯреЗрд▓реА" рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рднреА рдЧрддрд┐рд░реЛрдзреЛрдВ рдХреЛ рдлрд╛рдбрд╝рд╛ рдирд╣реАрдВ рдЬрд╛рдПрдЧрд╛ред </font><font style="vertical-align: inherit;">рдФрд░ рдпрд╣рд╛рдВ "рд╕рд╛рдорд╛рдиреНрдп" рддрд╛рд▓реЗ рд╣реИрдВ - рд▓реЙрдЧ рдореЗрдВ рдХрдИ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдбрдВрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:</font></font><br>
<blockquote><i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> still waiting for ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 100.047 ms</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest DETAIL: <b>Process holding the lock: 38154. Wait queue: <font color="red">38162</font>.</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest CONTEXT: SQL statement <code>"SELECT pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer )"<br>
 PL/pgSQL function inline_code_block line 2 at PERFORM</code><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest STATEMENT: <code> DO $$ BEGIN<br>
 PERFORM pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer );<br>
 EXCEPTION<br>
 WHEN query_canceled THEN RETURN;<br>
 END; $$;</code><br>
тАж<br>
<br>
<i>2019-03-27 00:06:46.077</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> <font color="green">acquired</font> ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 150.741 ms</b></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рд╣рдорд╛рд░реЗ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд╛рд╕</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓реЙрдЧ рдХреЗ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рдХреЗ рдХреНрд╖рдг рд╕реЗ </font><b><font style="vertical-align: inherit;">рдХреЗрд╡рд▓ 50ms рд╣реА рдерд╛</font></b><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рдХреЗрд╡рд▓ рдЗрд╕ рдЕрдВрддрд░рд╛рд▓ рдореЗрдВ рд╣рдо рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЬрд┐рддрдиреА рддреЗрдЬреА рд╕реЗ рд╣рдо рдРрд╕рд╛ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ, рдЙрддрдиреЗ рд╣реА рдЕрдзрд┐рдХ рддрд╛рд▓реЗ рд╣рдо рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрд╣рд╛рдВ рд╣рдорд╛рд░реЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд╛ </font><b><font style="vertical-align: inherit;">рдкреАрдЖрдИрдбреА тАЛтАЛрд╣реИ</font></b><font style="vertical-align: inherit;"> рдЬреЛ рд▓реЙрдХ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реА рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдЗрд╕ рдкрд░ рд╣реИ рдХрд┐ рд╣рдо рд▓реЙрдЧ рдФрд░ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЗ рдмреАрдЪ рдЬрд╛рдирдХрд╛рд░реА рдХреА рддреБрд▓рдирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдФрд░ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдПрдХ рд╡рд┐рд╢реЗрд╖ рддрд╛рд▓рд╛ рдХрд┐рддрдирд╛ рд╕рдорд╕реНрдпрд╛рдЧреНрд░рд╕реНрдд рдерд╛ - рдЕрд░реНрдерд╛рдд, рдпрд╣ "рд▓рдЯрдХрд╛" рдХрдм рддрдХред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдХреЗрд╡рд▓ рд╕рд╛рдордЧреНрд░реА </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд░рд┐рдХреЙрд░реНрдб </font><font style="vertical-align: inherit;">рдкрд░ RegExp рдХреЗ рдПрдХ рдЬреЛрдбрд╝реЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> RE_lock_detect = <span class="hljs-regexp">/^process (\d+) still waiting for (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> RE_lock_acquire = <span class="hljs-regexp">/^process (\d+) acquired (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//   </span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рд▓реЙрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд┐рд▓рддрд╛ рд╣реИ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╣ рдереЛрдбрд╝рд╛ рд░рд╣рддрд╛ рд╣реИ - рд▓реЙрдЧ рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрд╕рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдирд╛ рдФрд░ рддрджрдиреБрд╕рд╛рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рдирд╛ рд╕реАрдЦреЗрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рдм рдХреБрдЫ рд╣реИ - рдПрдХ рдСрдирд▓рд╛рдЗрди рд▓реЙрдЧ рдкрд╛рд░реНрд╕рд░ рдФрд░ рдПрдХ рдкреВрд░реНрд╡-рд╕рдХреНрд░рд┐рдп рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди, рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореИрдВрдиреЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдкрдиреЗ рдкреЛрд╕реНрдЯрдЧреНрд░реЗрдХреНрдпреВрдПрд▓ рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рд▓реЗрдЦ рдореЗрдВ рдмрд╛рдд рдХреА рдереА </font><font style="vertical-align: inherit;">: </font></font><br>
<img src="https://habrastorage.org/webt/tc/pv/oq/tcpvoqmeliadskfh2rpnffg7uwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХреЛрдИ рд╕рдорд╛рди рд╕рд┐рд╕реНрдЯрдо рддреИрдирд╛рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рдареАрдХ рд╣реИ, рд╣рдо рд╕рдм рдХреБрдЫ рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗред "рдХрдВрд╕реЛрд▓ рд╕реЗ рд░рд╛рдЗрдЯ"! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрджрд┐ PostgreSQL 10 рдФрд░ рдЙрдЪреНрдЪрддрд░ рдХрд╛ рд╕реНрдерд╛рдкрд┐рдд рд╕рдВрд╕реНрдХрд░рдг рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдлрд╝рдВрдХреНрд╢рди </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_logfile ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ </font><font style="vertical-align: inherit;">, рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╡рд░реНрддрдорд╛рди рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдирд╛рдо рджреЗрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдХрдВрд╕реЛрд▓ рд╕реЗ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдХрд╛рдлреА рдЖрд╕рд╛рди рд╣реЛрдЧрд╛:</font></font><br>
<br>
<pre><code class="bash hljs">psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) &lt;&gt; '/' THEN current_setting('data_directory') ELSE '' END || '/' || pg_current_logfile()"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрджрд┐ рд╕рдВрд╕реНрдХрд░рдг рдЕрдЪрд╛рдирдХ рдЫреЛрдЯрд╛ рд╣реИ - рд╕рдм рдХреБрдЫ рдмрд╛рд╣рд░ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╣рдореЗрдВ рдкреВрд░реНрдг рдлрд╝рд╛рдЗрд▓ рдирд╛рдо </font></font><code>tail -f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдорд┐рд▓рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">, рдЬрд┐рд╕реЗ рд╣рдо рджреЗрддреЗ рд╣реИрдВ </font><font style="vertical-align: inherit;">рдФрд░ рд╡рд╣рд╛рдВ рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреЛ рдкрдХрдбрд╝реЗрдВрдЧреЗ </font></font><code>'still waiting for'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЦреИрд░, рдЬреИрд╕реЗ рд╣реА рдЗрд╕ рдзрд╛рдЧреЗ рдореЗрдВ рдХреБрдЫ рдЙрддреНрдкрдиреНрди рд╣реБрдЖ, рд╣рдо рдХрд╣рддреЗ рд╣реИрдВ ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдЕрдиреБрд░реЛрдз</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдХрд╛рд╢, рд▓реЙрдЧ рдореЗрдВ рдЕрд╡рд░реБрджреНрдз рдХрд░рдиреЗ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рд╣рдореЗрд╢рд╛ рд╕рдВрд╕рд╛рдзрди рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рд╕рдВрдШрд░реНрд╖ рдХрд╛ рдХрд╛рд░рдг рдмрдирддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдк рд╕рдорд╛рдирд╛рдВрддрд░ рдореЗрдВ рд╕рдорд╛рди рдирд╛рдо рдХрд╛ рдПрдХ рдЗрдВрдбреЗрдХреНрд╕ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд▓реЙрдЧ рдореЗрдВ рдХреЗрд╡рд▓ рдХреБрдЫ рдРрд╕рд╛ рд╣реА рд╣реЛрдЧрд╛ </font></font><code>still waiting for ExclusiveLock on transaction 12345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕рд▓рд┐рдП, рд╣рдореЗрдВ рдЕрдкрдиреА </font><font style="vertical-align: inherit;">рд░реБрдЪрд┐ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд╕рднреА рддрд╛рд▓реЛрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рджреВрд░ рдХрд░рдирд╛</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣реЛрдЧрд╛ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдФрд░ рдХреЗрд╡рд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдПрдХ рдЬреЛрдбрд╝реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА (рдЬреЛ рддрд╛рд▓рд╛ рд▓рдЧрд╛рддрд╛ рд╣реИ / рдЬреЛ рдЙрдореНрдореАрдж рдХрд░рддрд╛ рд╣реИ) рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЕрдХреНрд╕рд░ рд▓реЗрдирджреЗрди рдХреЗ рдмреАрдЪ рд╡рд┐рднрд┐рдиреНрди рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдЕрдкреЗрдХреНрд╖рд╛рдУрдВ рдХреА рдПрдХ "рд╢реНрд░реГрдВрдЦрд▓рд╛" рд╣реЛрддреА рд╣реИ:</font></font><br>
<br>
<pre><code class="plaintext hljs">tx1 [resA] -&gt; tx2 [resA]<font></font>
tx2 [resB] -&gt; tx3 [resB]<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдХреНрд▓рд╛рд╕рд┐рдХ: "рд╢рд▓рдЬрдо рдХреЗ рд▓рд┐рдП рджрд╛рджрд╛, рджрд╛рджрд╛ рдХреЗ рд▓рд┐рдП рджрд╛рджреА, рджрд╛рджреА рдХреЗ рд▓рд┐рдП рдкреЛрддреА, ..." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕рд▓рд┐рдП, рд╣рдо рдПрдХ рдЕрдиреБрд░реЛрдз рд▓рд┐рдЦреЗрдВрдЧреЗ рдЬреЛ рд╣рдореЗрдВ рдмрддрд╛рдПрдЧрд╛ рдХрд┐ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдПрд╕рдЖрдИрдбреА рдХреЗ рд▓рд┐рдП рдкреВрд░реА рдЕрд╡рд░реБрджреНрдз рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЗ рд╕рд╛рде рдореБрд╕реАрдмрддреЛрдВ рдХрд╛ рдореВрд▓ рдХрд╛рд░рдг рдХреМрди рдмрди рдЧрдпрд╛ред</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> lm <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- lock modes</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    rn<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">THEN</span> row_number() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rn)
    <span class="hljs-keyword">END</span> rx<font></font>
  , lm || <span class="hljs-string">'Lock'</span> lm
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
      row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
    , lm<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">unnest</span>(
        <span class="hljs-built_in">ARRAY</span>[
          <span class="hljs-string">'AccessShare'</span>
        , <span class="hljs-string">'RowShare'</span>
        , <span class="hljs-string">'RowExclusive'</span>
        , <span class="hljs-string">'ShareUpdateExclusive'</span>
        , <span class="hljs-string">'Share'</span>
        , <span class="hljs-string">'ShareRowExclusive'</span>
        , <span class="hljs-string">'Exclusive'</span>
        , <span class="hljs-string">'AccessExclusive'</span><font></font>
        ]<font></font>
      ) T(lm)<font></font>
  ) T<font></font>
)<font></font>
<span class="hljs-comment">-- lock types</span>
, lt <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
  , lt<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(
      <span class="hljs-built_in">ARRAY</span>[
        <span class="hljs-string">'relation'</span>
      , <span class="hljs-string">'extend'</span>
      , <span class="hljs-string">'page'</span>
      , <span class="hljs-string">'tuple'</span>
      , <span class="hljs-string">'transactionid'</span>
      , <span class="hljs-string">'virtualxid'</span>
      , <span class="hljs-string">'object'</span>
      , <span class="hljs-string">'userlock'</span>
      , <span class="hljs-string">'advisory'</span>
      , <span class="hljs-string">''</span><font></font>
      ]<font></font>
    ) T(lt)<font></font>
)<font></font>
<span class="hljs-comment">-- lock modes conflicts</span>
, lmx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    lr.rn lrn<font></font>
  , lr.rx lrx<font></font>
  , lr.lm lr<font></font>
  , ld.rn ldn<font></font>
  , ld.rx ldx<font></font>
  , ld.lm ld<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    lm lr<font></font>
  <span class="hljs-keyword">JOIN</span>
    lm ld <span class="hljs-keyword">ON</span>
      ld.rx &gt; (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rx) <span class="hljs-keyword">FROM</span> lm) - lr.rx <span class="hljs-keyword">OR</span><font></font>
      (<font></font>
        (lr.rx = ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
        (lr.rx, ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span>
        ld.rn &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rn) <span class="hljs-keyword">FROM</span> lm) - lr.rn<font></font>
      )<font></font>
)<font></font>
<span class="hljs-comment">-- locked targets/pids</span>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) target<font></font>
  , ld.pid  ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid  lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks ld<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_locks lr <span class="hljs-keyword">ON</span>
      lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
      (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (ld.locktype, ld.database, ld.relation, ld.page, ld.tuple, ld.virtualxid, ld.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, ld.classid, ld.objid, ld.objsubid) <span class="hljs-keyword">AND</span>
      (lr.granted, ld.granted) = (<span class="hljs-literal">TRUE</span>, <span class="hljs-literal">FALSE</span>)
  <span class="hljs-keyword">JOIN</span>
    lmx <span class="hljs-keyword">ON</span><font></font>
      (lmx.lr, lmx.ld) = (lr.mode, ld.mode)<font></font>
  <span class="hljs-keyword">WHERE</span>
    (ld.pid, ld.granted) = ($<span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span>, <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">-- PID</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span>          <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span>         <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span>    <span class="hljs-keyword">THEN</span> regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-string">"locked"</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, (lc.locktype, lc.database, lc.relation, lc.page, lc.tuple, lc.virtualxid, lc.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lc.classid, lc.objid, lc.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-string">"conflict"</span>
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span>
  pg_locks lc <span class="hljs-keyword">ON</span>
    lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдорд╕реНрдпрд╛ # 1 - рдзреАрдореА рд╢реБрд░реБрдЖрдд</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд▓реЙрдЧ рд╕реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдПрдХ рд▓реЙрдХ ( </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">рдХреА рдШрдЯрдирд╛ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рд░реЗрдЦрд╛ рдХреЗ рдмрдЧрд▓ рдореЗрдВ </font><font style="vertical-align: inherit;">, 3 рдФрд░ рд▓рд╛рдЗрдиреЗрдВ ( </font></font><code>DETAIL, CONTEXT, STATEMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдЬрд╛рдирдХрд╛рд░реА рдХреА рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдХрд░ рд░рд╣реА рд╣реИрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдордиреЗ рд╕рднреА 4 рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЗ рдкреВрд░реНрдг "рдкреИрдХреЗрдЬ" рдХреЗ рдЧрдарди рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд┐рдпрд╛ рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рд╣реА рд╣рдордиреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрд╛ рд░реБрдЦ рдХрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рд╣рдо рдкреИрдХреЗрдЬ рдХреЗ рдЧрдарди рдХреЛ рдХреЗрд╡рд▓ рддрднреА рдкреВрд░рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдЕрдЧрд▓рд╛ (рдкрд╣рд▓реЗ рд╕реЗ рд╣реА 5 рд╡рд╛рдВ!) рд░рд┐рдХреЙрд░реНрдб рдЖрддрд╛ рд╣реИ, рдПрдХ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЗ рд╕рд╛рде, рдпрд╛ рдЯрд╛рдЗрдордЖрдЙрдЯ рдХреЗ рд╕рд╛рдеред </font><font style="vertical-align: inherit;">рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рджреЛрдиреЛрдВ рд╡рд┐рдХрд▓реНрдк рдЕрдирд╛рд╡рд╢реНрдпрдХ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХреЛ рдЙрддреНрддреЗрдЬрд┐рдд рдХрд░рддреЗ рд╣реИрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрди рджреЗрд░реА рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдордиреЗ </font><font style="vertical-align: inherit;">рд▓реЙрдХ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд░рд┐рдХреЙрд░реНрдб</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреА </font><b><font style="vertical-align: inherit;">рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ</font></b><font style="vertical-align: inherit;"> рдХреЛ </font><b><font style="vertical-align: inherit;">рд╕реНрдЯреНрд░реАрдо</font></b><font style="vertical-align: inherit;"> рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрд╡рд┐рдЪ рдХрд┐рдпрд╛ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣реА рд╣реИ, рдЕрдм рд╣рдо </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рдХреНрд╖реНрдп рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЬрд╛рддреЗ рд╣реИрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЬреИрд╕реЗ рд╣реА рд╣рдордиреЗ рдкрд╣рд▓рд╛ рд░рд┐рдХреЙрд░реНрдб рд╕реЙрд░реНрдЯ рдХрд┐рдпрд╛, рдФрд░ рдорд╣рд╕реВрд╕ рдХрд┐рдпрд╛ рдХрд┐ рдпрд╣ рд╡рд╣рд╛рдВ рд╡рд░реНрдгрд┐рдд рд▓реЙрдХ рдерд╛ред</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдорд╕реНрдпрд╛ # 2 - рдзреАрдореА рдЧрддрд┐ рд╕реЗ рдЕрдиреБрд░реЛрдз</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд▓реЗрдХрд┐рди рдлрд┐рд░ рднреА, рдХреБрдЫ рддрд╛рд▓реЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рдирд╣реАрдВ рдерд╛ред </font><font style="vertical-align: inherit;">рдЙрдиреНрд╣реЛрдВрдиреЗ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреБрджрд╛рдИ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ - рдФрд░ рдкрддрд╛ рдЪрд▓рд╛ рдХрд┐ рдХреБрдЫ рд╕рд░реНрд╡рд░реЛрдВ рдкрд░ рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЕрдиреБрд░реЛрдз рдХреЛ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15-20ms рдХреЗ рд▓рд┐рдП</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдирд┐рд╖реНрдкрд╛рджрд┐рдд </font><b><font style="vertical-align: inherit;">рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ</font></b><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдХрд╛рд░рдг рдЖрдо рд╣реЛ рдЧрдпрд╛ - рдЖрдзрд╛рд░ рдкрд░ рд╕рдХреНрд░рд┐рдп рддрд╛рд▓реЗ рдХреА рдХреБрд▓ рд╕рдВрдЦреНрдпрд╛, рдХрдИ рд╣рдЬрд╛рд░ рддрдХ рдкрд╣реБрдВрдЪ рдЧрдИ:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/sp/ex/lkspexwtgdfrqhmh3siwsnx_s30.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрд╣рд╛рдВ рдпрд╣ рдзреНрдпрд╛рди рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ PostgreSQL рдореЗрдВ рддрд╛рд▓реЗ рдХрд╣реАрдВ рднреА "рд╕рдВрдЧреНрд░рд╣реАрдд" рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рд┐рд╕реНрдЯрдо рд╡реНрдпреВ pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ </font><font style="vertical-align: inherit;">, рдЬреЛ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкреНрд░рддреНрдпрдХреНрд╖ рдкреНрд░рддрд┐рдмрд┐рдВрдм рд╣реИ </font></font><code>pg_lock_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдФрд░ рд╣рдорд╛рд░реЗ рдЕрдиреБрд░реЛрдз рдореЗрдВ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдЗрд╕реЗ рддреАрди рдмрд╛рд░ рд╕реЗ рдкрдврд╝рддреЗ рд╣реИрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">рдЗрд╕ рдмреАрдЪ, рд╣рдо рдЗрди рд╣рдЬрд╛рд░реЛрдВ рд▓реЙрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдкрдврд╝рддреЗ рд╣реИрдВ, рдФрд░ рдЙрди рд▓реЛрдЧреЛрдВ рдХреЛ рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВ рдЬреЛ рд╣рдорд╛рд░реЗ рдкреАрдЖрдИрдбреА тАЛтАЛрд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИрдВ, рд▓реЙрдХ рд╣реА "рд╣рд▓" рдХрд░рдиреЗ рдореЗрдВ рдХрд╛рдордпрд╛рдм рд░рд╣реЗ ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╕рдорд╛рдзрд╛рди </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реАрдЯреАрдИ рдореЗрдВ pg_locks рдХреА рд╕реНрдерд┐рддрд┐</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреЛ </font><b><font style="vertical-align: inherit;">"рднреМрддрд┐рдХ" рдХрд░рдирд╛ рдерд╛</font></b><font style="vertical-align: inherit;"> - рдЗрд╕рдХреЗ рдмрд╛рдж, рдЖрдк рдЗрд╕реЗ рдЬрд┐рддрдиреА рдмрд╛рд░ рдЪрд╛рд╣реЗрдВ рдЙрддрдиреА рдмрд╛рд░ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╣реИред рдирд╣реАрдВ рдмрджрд▓рддрд╛ред </font><font style="vertical-align: inherit;">рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдПрд▓реНрдЧреЛрд░рд┐рдереНрдо рдкрд░ рдмреИрдардиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕рдХреЗ рджреЛ рд╕реНрдХреИрди рддрдХ рд╕рдм рдХреБрдЫ рдХрдо рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ред</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрддреНрдпрдзрд┐рдХ рдЧрддрд┐рд╢реАрд▓рддрд╛</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдФрд░ рдЕрдЧрд░ рдКрдкрд░ рдХреА рдХреНрд╡реЗрд░реА рдХреЛ рдереЛрдбрд╝рд╛ рдХрд░реАрдм рд╕реЗ рджреЗрдЦреЗрдВ, рддреЛ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╕реАрдЯреАрдИ </font></font><code>lm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдФрд░ </font></font><code>lmx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рдбреЗрдЯрд╛ рд╕реЗ рдмрдВрдзрд╛ рд╣реБрдЖ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореЛрдб рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдиреЗ рдХреЗ рдмреАрдЪ рд╕рдВрдШрд░реНрд╖</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреА рд╣рдореЗрд╢рд╛ рд╕рдорд╛рди "рд╕реНрдерд┐рд░" рдореИрдЯреНрд░рд┐рдХреНрд╕ рдкрд░рд┐рднрд╛рд╖рд╛ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рддреЛ рдЪрд▓рд┐рдП рдЗрд╕реЗ рдЧреБрдгрд╡рддреНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ </font></font><code>VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдорд╕реНрдпрд╛ # 3 - рдкрдбрд╝реЛрд╕реА</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд▓реЗрдХрд┐рди рддрд╛рд▓реЛрдВ рдХрд╛ рдХреБрдЫ рд╣рд┐рд╕реНрд╕рд╛ рдЕрднреА рднреА рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рдЖрдорддреМрд░ рдкрд░ рдпрд╣ рдирд┐рдореНрди рдпреЛрдЬрдирд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╣реЛрддрд╛ рд╣реИ - рдХрд┐рд╕реА рдиреЗ рдПрдХ рд▓реЛрдХрдкреНрд░рд┐рдп рд╕рдВрд╕рд╛рдзрди рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░ рджрд┐рдпрд╛, рдФрд░ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЬрд▓реНрджреА рдФрд░ рдЬрд▓реНрджреА рд╕реЗ рдЗрд╕рдореЗрдВ рдпрд╛ рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЗ рд╕рд╛рде рдЖрдЧреЗ рдмрдврд╝реАрдВ </font><font style="vertical-align: inherit;">ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдирддреАрдЬрддрди, рд╣рдордиреЗ рдкрд╣рд▓реЗ рдкреАрдЖрдИрдбреА тАЛтАЛрдХреЛ рдкрдХрдбрд╝рд╛, рд▓рдХреНрд╖реНрдп рдмреЗрд╕ рдкрд░ рдЧрдпрд╛ (рдФрд░ рдЗрд╕реЗ рдЕрдзрд┐рднрд╛рд░ рдирд╣реАрдВ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХреЗрд╡рд▓ рдПрдХ рдХрдиреЗрдХреНрд╢рди рд░рдЦрддреЗ рд╣реИрдВ), рдХреНрдпрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд┐рдпрд╛, рдкрд░рд┐рдгрд╛рдо рдХреЗ рд╕рд╛рде рд▓реМрдЯрд╛, рдЕрдЧрд▓рд╛ рдкреАрдЖрдИрдбреА тАЛтАЛрд▓реЗ рд▓рд┐рдпрд╛ ... рд▓реЗрдХрд┐рди рдЖрдзрд╛рд░ рдкрд░ рдЬреАрд╡рди рдЗрд╕рдХреЗ рд▓рд╛рдпрдХ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдкреАрдЖрдИрдбреА тАЛтАЛрд▓реЙрдХ # 2 рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЪрд▓рд╛ рдЧрдпрд╛ рд╣реИ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╣рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдкреАрдЖрдИрдбреА тАЛтАЛрдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ рд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреНрдпреЛрдВ рд╣реИ, рдЕрдЧрд░ рд╣рдо рдЕрднреА рднреА рдЕрдиреБрд░реЛрдз рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдп рд╕реВрдЪреА рд╕реЗ рддрд╛рд▓реЗ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рддреЗ рд╣реИрдВ? рдЖрдЗрдП </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд╕реАрдзреЗ рдкрд░рд╕реНрдкрд░ рд╡рд┐рд░реЛрдзреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдкреВрд░реА рд╕реВрдЪреА рдХреЛ рддреБрд░рдВрдд</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓реЗ рд▓реЗрдВ </font><font style="vertical-align: inherit;">рдФрд░ рдЕрдиреБрд░реЛрдз рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди рдЧрд┐рд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рднреА рдкреАрдЖрдИрдбреА тАЛтАЛрдкрд░ рдЕрдкрдиреЗ рддрд╛рд▓реЗ рд╡рд┐рддрд░рд┐рдд рдХрд░реЗрдВ:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> lm(ld, lr) <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'AccessShareLock'</span>, <span class="hljs-string">'{AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowShareLock'</span>, <span class="hljs-string">'{ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowExclusiveLock'</span>, <span class="hljs-string">'{ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareUpdateExclusiveLock'</span>, <span class="hljs-string">'{ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareRowExclusiveLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ExclusiveLock'</span>, <span class="hljs-string">'{RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'AccessExclusiveLock'</span>, <span class="hljs-string">'{AccessShareLock,RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
)<font></font>
, locks <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    (<font></font>
      locktype<font></font>
    , <span class="hljs-keyword">database</span><font></font>
    , relation<font></font>
    , page<font></font>
    , tuple<font></font>
    , virtualxid<font></font>
    , transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span><font></font>
    , classid<font></font>
    , objid<font></font>
    , objsubid<font></font>
    ) target<font></font>
  , *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks<font></font>
)<font></font>
, ld <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> granted<font></font>
)<font></font>
, lr <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    target::<span class="hljs-built_in">text</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        target::<span class="hljs-built_in">text</span>
      <span class="hljs-keyword">FROM</span><font></font>
        ld<font></font>
    )) <span class="hljs-keyword">AND</span><font></font>
    granted<font></font>
)<font></font>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
    lr.target<font></font>
  , ld.pid ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    ld<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    lr<font></font>
      <span class="hljs-keyword">ON</span> lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
        lr.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> ld.target<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span> <span class="hljs-keyword">THEN</span>
      regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-keyword">as</span> <span class="hljs-keyword">locked</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, lc.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-keyword">as</span> conflict
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span><font></font>
  locks lc<font></font>
    <span class="hljs-keyword">ON</span> lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ </font><font style="vertical-align: inherit;">рд▓реЙрдЧ рдореЗрдВ рдЖрдиреЗ рдХреЗ рдмрд╛рдж </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЗрд╡рд▓ 1-2 рдПрдордПрд╕ рдореЗрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдореМрдЬреВрдж рддрд╛рд▓реЗ рдХрд╛ рднреА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ </font><font style="vertical-align: inherit;">ред</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рджрд░рдЕрд╕рд▓, рд╣рдордиреЗ рдЗрддрдиреА рд▓рдВрдмреА рдХреЛрд╢рд┐рд╢ рдХреНрдпреЛрдВ рдХреА? </font><font style="vertical-align: inherit;">рдЗрд╕рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рд╣рдореЗрдВ рдХреНрдпрд╛ рдорд┐рд▓рддрд╛ рд╣реИ?</font></font><br>
<br>
<pre><code class="plaintext hljs">type     | target                  | locked | pid    | mode        | granted | conflict<font></font>
---------------------------------------------------------------------------------------<font></font>
relation | {225388639}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {423576026}             | f      | 216547 | AccessShare | t       | f<font></font>
advisory | {225386226,194303167,2} | t      |  24964 | Exclusive   | f       | t<font></font>
relation | {341894815}             | t      |  24964 | AccessShare | t       | f<font></font>
relation | {416441672}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {225964322}             | f      | 216547 | AccessShare | t       | f<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕ рдкреНрд▓реЗрдЯ рдореЗрдВ, </font></font><code>target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рдкреНрд░рдХрд╛рд░ рдХреЗ </font><font style="vertical-align: inherit;">рдорд╛рди рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИрдВ </font></font><code>relation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдРрд╕рд╛ рдорд╛рди </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдпрд╛ рд╕реВрдЪрдХрд╛рдВрдХ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд╛ рдПрдХ </font><b><font style="vertical-align: inherit;">OID рд╣реИ</font></b><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рдЕрдм рдмрд╣реБрдд рдХрдо рдмрдЪрд╛ рд╣реИ - рдорд╛рдирд╡-рдкрдардиреАрдп рд░реВрдк рдореЗрдВ рдЕрдиреБрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдЕрднреА рднреА рдЕрдЬреНрдЮрд╛рдд рдУрдЖрдИрдбреА рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдкреВрдЫрддрд╛рдЫ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>::<span class="hljs-keyword">oid</span>::regclass;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЕрдм, рддрд╛рд▓реЗ рдХреЗ рд╕рднреА "рдореИрдЯреНрд░рд┐рдХреНрд╕" рдФрд░ рдЙрди рд╕рднреА рд╡рд╕реНрддреБрдУрдВ рдХреЛ рдЬрд╛рдирдирд╛, рдЬрд┐рди рдкрд░ рд╡реЗ рд▓реЗрдирджреЗрди рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рджреНрд╡рд╛рд░рд╛ рдЖрд░реЛрдкрд┐рдд рдереЗ, рд╣рдо </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирд┐рд╖реНрдХрд░реНрд╖ рдирд┐рдХрд╛рд▓</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рдХрддреЗ рд╣реИрдВ </font><b><font style="vertical-align: inherit;">рдХрд┐ "рдХреНрдпрд╛ рд╣реБрдЖ"</font></b><font style="vertical-align: inherit;"> , рдФрд░ рдХрд┐рд╕ рд╕рдВрд╕рд╛рдзрди рдиреЗ рд╕рдВрдШрд░реНрд╖ рдХреЛ рд░реЛрдХ рджрд┐рдпрд╛, рднрд▓реЗ рд╣реА рдЕрдиреБрд░реЛрдз рдЕрд╡рд░реБрджреНрдз рд╣реЛ рдЧрдпрд╛ рд╣реЛ, рд╣рдо рдЕрдЬреНрдЮрд╛рдд рдереЗред </font><font style="vertical-align: inherit;">рдпрд╣ рдЖрд╕рд╛рдиреА рд╕реЗ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЬрдм рд▓реЙрдЧ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд╡рд░реБрджреНрдз рдЕрдиреБрд░реЛрдз рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╕рдордп рдХрд╛рдлреА рд▓рдВрдмрд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд▓реЗрдирджреЗрди рдЗрд╕рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж рд╕рдХреНрд░рд┐рдп рдерд╛ рдФрд░ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рд╕рдорд╕реНрдпрд╛рдПрдВ рдкреИрджрд╛ рдХрд░рддрд╛ рдерд╛ред </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/4m/j7/4m4mj7nqgpeoxe13qoldzrmhhr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд▓реЗрдХрд┐рди рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ - рдПрдХ рдЕрдиреНрдп рд▓реЗрдЦ рдореЗрдВред</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"рд╕рдм рдЕрдкрдиреЗ рдЖрдк рд╕реЗ"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕ рдмреАрдЪ, рд╣рдо "рдирд┐рдЧрд░рд╛рдиреА" рдХрд╛ рдкреВрд░рд╛ рд╕рдВрд╕реНрдХрд░рдг рдПрдХрддреНрд░ рдХрд░реЗрдВрдЧреЗ, рдЬреЛ рд▓реЙрдЧ рдореЗрдВ рдХреБрдЫ рд╕рдВрджрд┐рдЧреНрдз рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реА рдЕрдкрдиреЗ рд╕рдВрдЧреНрд░рд╣ рдХреЗ рд▓рд┐рдП рддрд╛рд▓реЗ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╣рдЯрд╛ рджреЗрдЧрд╛ред</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span> \<font></font>
  | xargs -l -I{} tail -f {} \<font></font>
  | stdbuf -o0 grep <span class="hljs-string">'still waiting for'</span> \<font></font>
  | xargs -l -I{} date <span class="hljs-string">'+%Y%m%d-%H%M%S.%N'</span> \<font></font>
  | xargs -l -I{} psql -U postgres postgres -f detect-lock.sql -o {}-lock.log<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдФрд░ </font></font><code>detect-lock.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдЦрд┐рд░реА рдирд┐рд╡реЗрджрди </font><font style="vertical-align: inherit;">рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдЧрд▓рд╛ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рднрд╛рдЧреЛ - рдФрд░ рд╡рд╛рдВрдЫрд┐рдд рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рдПрдХ рдЧреБрдЪреНрдЫрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat 20200526-181433.331839375-lock.log<font></font>
     type      |     target     | locked |  pid   |     mode     | granted | conflict<font></font>
---------------+----------------+--------+--------+--------------+---------+----------<font></font>
 relation      | {279588430}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | t      | 136325 | RowExclusive | t       | f<font></font>
 virtualxid    | {110,12171420} | t      | 136325 | Exclusive    | t       | f<font></font>
 relation      | {279588430}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | f      |  39339 | RowExclusive | t       | f<font></font>
 virtualxid    | {360,11744113} | f      |  39339 | Exclusive    | t       | f<font></font>
 virtualxid    | {638,4806358}  | t      |  80553 | Exclusive    | t       | f<font></font>
 advisory      | {1,1,2}        | t      |  80553 | Exclusive    | f       | t<font></font>
 advisory      | {1,1,2}        | f      |  80258 | Exclusive    | t       | t<font></font>
 transactionid | {3852607686}   | t      | 136325 | Exclusive    | t       | f<font></font>
 extend        | {279588422}    | t      | 136325 | Exclusive    | f       | t<font></font>
 extend        | {279588422}    | f      |  39339 | Exclusive    | t       | t<font></font>
 transactionid | {3852607712}   | f      |  39339 | Exclusive    | t       | f<font></font>
(15 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЦреИрд░, рдлрд┐рд░ - рдмреИрдареЛ рдФрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЛ ...</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi503668/index.html">рд╕рд░реНрдХрд▓ рд╕реНрдХреНрд╡рд╛рдпрд░реНрдб: рд╡рд┐рдЬреБрдЕрд▓ рдПрд╡рд┐рдбреЗрдВрд╕</a></li>
<li><a href="../hi503670/index.html">рдХреНрдпрд╛ рдореИрдХ рдУрдПрд╕ рдзреАрдорд╛ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ? - рдХреИрдЯрд╛рд▓рд┐рдирд╛ рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдкрд░ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдХрд┐рд╕реА рднреА рдЕрд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХреЛрдб рдХреА рдЬрд╛рдБрдЪ рдХрд░рддреА рд╣реИ</a></li>
<li><a href="../hi503672/index.html">рдЖрдк рдХрд┐рд╕ рдкрдХреНрд╖ рдкрд░ рд╣реИрдВ: рд╡рд╛рдВрдЫрд┐рдд рд╕реНрдерд┐рддрд┐ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдкреБрд╢ рдФрд░ рдЦреАрдВрдЪреЛ</a></li>
<li><a href="../hi503676/index.html">рдЧреАрдХ рдкреНрд░рд╛рдЗрдб рдбреЗ рдХреЗ рд▓рд┐рдП рддреАрди рдЧреАрдХ рдкреНрд░реЛрдЬреЗрдХреНрдЯ</a></li>
<li><a href="../hi503678/index.html">Vuex рдЕрддрд┐рдХреНрд░рдордг рдХреЛ рддреЛрдбрд╝рддрд╛ рд╣реИ</a></li>
<li><a href="../hi503682/index.html">рд╕реНрдиреЛрдо рдПрдХреНрд╕рдЪреЗрдВрдЬ рдП рдЯреВ рдЬреЗрдб</a></li>
<li><a href="../hi503688/index.html">рдЬреЛрдПрд▓ рд╕реНрдкреЛрд▓рд╕реНрдХреА: рдЗрд╕рдХрд╛ рдорддрд▓рдм рдХреНрдпрд╛ рд╣реИ рдПрдХ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдбреЗрд╡рд▓рдкрд░ (рдбреЗрд╡рд▓рдкрд░ рдХреЗ рд▓рд┐рдП рдХреЛрдбрд░ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╕реНрддрд╛рд╡рдирд╛)</a></li>
<li><a href="../hi503690/index.html">рдХреБрдмреЗрд░рдиреЗрддреНрд╕ рд╕рд░реНрд╡реЛрддреНрддрдо рдкреНрд░рдерд╛рдУрдВред рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдЬреАрд░реЛ рдбрд╛рдЙрдирдЯрд╛рдЗрдо рдХреНрд▓рд╕реНрдЯрд░ рдЕрдкрдЧреНрд░реЗрдб</a></li>
<li><a href="../hi503696/index.html">рдпреБрджреНрдз рдХреЗ рдЧрд┐рдпрд░: рдЬрдм рдпрд╛рдВрддреНрд░рд┐рдХ рдПрдирд╛рд▓реЙрдЧ рдХрдВрдкреНрдпреВрдЯрд░ рдиреЗ рд╕рдореБрджреНрд░ рдкрд░ рд╢рд╛рд╕рди рдХрд┐рдпрд╛</a></li>
<li><a href="../hi503698/index.html">рджреВрд░рд╕реНрде рд▓реЗрдЦрд╛рдВрдХрди - рдПрдХ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рд▓рд╛рдн рдХреЗ рд░реВрдк рдореЗрдВ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>