<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴🏾 👡 🖖🏻 Implementação do processo de upload de um arquivo de um contêiner com um navegador para uma estrutura de teste 🖖🏻 🗾 👨‍👩‍👦‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automação do teste de ponta a ponta de um sistema de informação integrado 
 Parte 2-2. Implementando o processo de upload de um arquivo de um contêine...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementação do processo de upload de um arquivo de um contêiner com um navegador para uma estrutura de teste</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489268/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automação do teste de ponta a ponta de um sistema de informação integrado </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parte 2-2. </font><font style="vertical-align: inherit;">Implementando o processo de upload de um arquivo de um contêiner com um navegador para uma estrutura de teste. </font><font style="vertical-align: inherit;">Pesquise o nome do arquivo baixado pelo navegador</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autor: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/us/users/anrad</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hubs: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tags: #autotest, #selenium, #selenoid, #headlessbrowser, #download</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Quando desenvolvíamos autotestes de ponta a ponta para a interface do usuário, fomos confrontados com a pergunta “Como obter o nome do último carregado navegador de arquivos do WebDriver? ”, o Google não recebeu nada rapidamente. Portanto, escrevi este artigo, que ao mesmo tempo dizia o que exatamente tínhamos um problema e como o resolvíamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com este artigo, continuamos uma série de publicações sobre como automatizamos o processo de teste manual (doravante referido como autoteste) de um grande sistema de informação (doravante referido como Sistemas) em um dos grandes projetos LANIT e o que aconteceu com ele. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/wz/lk/9wwzlkncoqwymqxqltqhcxatig0.jpeg" alt="imagem"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonte</font></font></i></a><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artigo em si completa o ciclo; abaixo, há um link para todas as partes anteriores: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parte 1. Organizacional e gerencial. Por que precisamos de automação. Organização do processo de desenvolvimento e gerenciamento. Organização de uso </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parte 2. Técnico. Arquitetura e pilha técnica. Detalhes da implementação e surpresas técnicas </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parte 2-1. Implementação da classe base para todos os testes e o JUnit RuleChain </font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso foi há um ano. Então, hoje, isso pode não ser relevante. Escreva nos comentários se você souber uma maneira eficiente de processar arquivos com vários servidores de grade selenoide.</font></font></i></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ao desenvolver “autotestes”, tivemos a tarefa de baixar (baixar) arquivos do sistema com uma análise subsequente de seu conteúdo. Para "fazer upload" de arquivos do sistema testado, usamos as seguintes soluções:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o modo de inicialização "local" (inicie diretamente no PC em funcionamento) - quando o navegador "local" é inicializado, o nome da pasta local temporária é passado a ele como parâmetro. </font><font style="vertical-align: inherit;">Em seguida, o arquivo é lido diretamente da pasta local para posterior análise;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o modo "remoto" (via Bamboo) - o arquivo foi "obtido" do contêiner com o navegador através do recurso do servidor Solenoid: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} / {FILE_NAME}</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os detalhes estão descritos na documentação. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos dois modos, para acessar o arquivo, você precisava saber o nome dele. </font><font style="vertical-align: inherit;">Isso foi uma surpresa. </font><font style="vertical-align: inherit;">O problema da falta de dados no nome do arquivo "download" era o seguinte:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depois de “clicar” no botão “baixar arquivo”, o navegador baixou o arquivo para a pasta local apropriada no contêiner;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nesse caso, o nome do arquivo foi formado dinamicamente e, como determiná-lo com antecedência, não conseguimos encontrar. </font><font style="vertical-align: inherit;">Esta foi uma característica do nosso sistema de teste;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Além disso, esse arquivo deve ser "retirado" do contêiner e a verificação comercial de seu conteúdo deve ser realizada;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para "retirar" o arquivo, você deve saber seu nome, mas não o conhecíamos, pois o nome foi gerado dinamicamente e não havia valor no link.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, a situação foi agravada pelo fato de que, devido à grande complexidade de alguns testes, vários arquivos podem ser descarregados durante o teste como parte de diferentes scripts de teste independentes da composição do próprio teste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A melhor solução para nós foi o método em que determinamos o último arquivo baixado. </font><font style="vertical-align: inherit;">Havia várias maneiras de fazer isso:</font></font><br>
<ul>
<li>        .        .   ,    ;</li>
<li>    Google Chrome   javascript  chrome://downloads/,      html-.       .<br>
</li>
</ul><br>
<br>
<h3>      <br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analisar a composição dos arquivos carregados pelo navegador para o modo local é uma tarefa trivial. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No modo remoto, você precisa usar o recurso “não documentado” do servidor selenoid: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} exibe uma lista de todos os arquivos baixados com êxito, em que SESSION_ID é um ID de sessão selenoide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o esquema funciona bem com uma exceção: nós Você precisa esperar um pouco até que o arquivo seja baixado e apareça na lista. A espera pode ser definida através de um ciclo de tempo limite, no entanto, dessa forma, não podemos obter informações sobre um possível erro de upload de arquivo. Só podemos determinar que o arquivo não foi carregado neste circuito. Portanto, no final, decidimos pelo método de determinar o nome do arquivo através do chrome: // downloads / page.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtendo o nome do arquivo através do chrome: // downloads / página</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este método funciona igualmente bem no modo local e remoto. </font><font style="vertical-align: inherit;">O esquema do trabalho é bastante simples:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execute o script java para abrir a janela do chrome: // downloads /;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processar dados na janela da maneira usual. </font><font style="vertical-align: inherit;">Aguarde até o primeiro arquivo da lista ser carregado e determine seu nome;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">feche o chrome: // downloads / window e retorne o nome do arquivo que você está procurando.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pesquisamos a ideia de usar o chrome: // downloads / e, infelizmente, não posso fornecer um link para a fonte, pois ela não foi preservada. </font><font style="vertical-align: inherit;">A implementação real da classe para obter o nome do arquivo é fornecida abaixo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Classe para obter o nome do arquivo baixado via chrome: // downloads /</font></font><br>
<pre><code class="java hljs">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> DOWNLOADS_PAGE_LOAD_TIMEOUT = <span class="hljs-number">5_000</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> MAX_GET_FILE_NAME_ATTEMPT = <span class="hljs-number">5</span>;<font></font>
 <font></font>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getLastDownloadedFilename</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> DownloaderException </span>{<font></font>
        String[] filename = <span class="hljs-keyword">new</span> String[<span class="hljs-number">1</span>];<font></font>
        Exception[] ex = <span class="hljs-keyword">new</span> Exception[<span class="hljs-number">1</span>];<font></font>
        WebDriver driver = WebDriverRunner.getWebDriver();<font></font>
        JavascriptExecutor executor = (JavascriptExecutor) driver;<font></font>
        Utils.driver.openNewTabCheckAndClose(<font></font>
                () -&gt; {<font></font>
                    executor.executeScript(<span class="hljs-string">"window.open('','_blank');"</span>);<font></font>
                },<font></font>
                () -&gt; {<font></font>
                    driver.get(<span class="hljs-string">"chrome://downloads/"</span>);<font></font>
 <font></font>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_GET_FILE_NAME_ATTEMPT; i++) {<font></font>
                    	ex[<span class="hljs-number">0</span>] = <span class="hljs-keyword">null</span>;<font></font>
                        sleep();<font></font>
                    	<span class="hljs-keyword">try</span> {<font></font>
                        	WebElement element = (WebElement) executor.executeScript(<font></font>
                                    <span class="hljs-string">"return document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('file-link')"</span>);<font></font>
                        	filename[<span class="hljs-number">0</span>] = element.getText();<font></font>
                            LOGGER.info(<span class="hljs-string">"Attempt get file name "</span> + i + <span class="hljs-string">". Name = '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'"</span>);<font></font>
                    	} <span class="hljs-keyword">catch</span> (WebDriverException e) {<font></font>
                        	ex[<span class="hljs-number">0</span>] = e;<font></font>
                            LOGGER.info(<span class="hljs-string">"Failed attempt "</span>+ i + <span class="hljs-string">" to get filename text: "</span> + e.getMessage());
                        	<span class="hljs-keyword">continue</span>;<font></font>
                    	}<font></font>
                    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
                        	 <span class="hljs-comment">//             </span><font></font>
                         	executor.executeScript(<font></font>
                                    <span class="hljs-string">"document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('remove').click()"</span>);
                        	<span class="hljs-keyword">break</span>;<font></font>
                    	}<font></font>
                    }<font></font>
                }<font></font>
    	);<font></font>
 <font></font>
    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
            <span class="hljs-keyword">return</span> filename[<span class="hljs-number">0</span>];<font></font>
    	}<font></font>
 <font></font>
    	String message = <span class="hljs-string">"Timeout. Can not get last downloaded file name from chrome://downloads/. File name is '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'. Exception: "</span> + ex[<span class="hljs-number">0</span>].getMessage();<font></font>
        LOGGER.warning(message);<font></font>
    	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DownloaderException(message, ex[<span class="hljs-number">0</span>]);<font></font>
	}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489254/index.html">O Yandex ajuda a espalhar malware?</a></li>
<li><a href="../pt489256/index.html">Sistemas de automação Foundation Fieldbus</a></li>
<li><a href="../pt489258/index.html">Como os tipos inteiros muito longos são implementados no Python?</a></li>
<li><a href="../pt489260/index.html">Como projetar um sistema automatizado em larga escala para uma grande empresa em sete etapas</a></li>
<li><a href="../pt489262/index.html">Por que não é fácil dar aos desenvolvedores liberdade de escolha</a></li>
<li><a href="../pt489270/index.html">WebAuthn na vida real</a></li>
<li><a href="../pt489272/index.html">Olhos, cérebro, qualidade de vídeo: reflexões sobre 120fps, 8K, HDR, varinhas, cones e o “efeito novela”</a></li>
<li><a href="../pt489274/index.html">Afirmar mensagens em testes</a></li>
<li><a href="../pt489276/index.html">Exame de sangue para ferro - como controlar o nível, diagnosticar as razões pelas quais é importante</a></li>
<li><a href="../pt489280/index.html">Faça ping em todos os hosts IPv6 no canal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>