<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👤 👨‍👩‍👧‍👧 🏂🏻 CI / CD链和Docker自动化 💡 📫 🧛🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我在90年代后期写了我的第一个网站。然后使它们进入工作状态非常简单。在某些共享主机上有一台Apache服务器，您可以通过FTP登录该服务器，并在浏览器行中编写类似的内容ftp://ftp.example.com。然后，必须输入名称和密码，然后将文件上传到服务器。有时候，一切都比现在容易。 在过去的二...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CI / CD链和Docker自动化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/488668/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我在90年代后期写了我的第一个网站。然后使它们进入工作状态非常简单。在某些共享主机上有一台Apache服务器，您可以通过FTP登录该服务器，并在浏览器行中编写类似的内容</font></font><code>ftp://ftp.example.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。然后，必须输入名称和密码，然后将文件上传到服务器。有时候，一切都比现在容易。</font><font style="vertical-align: inherit;">
在过去的二十年中，一切都发生了很大变化。场地变得越来越复杂，必须将它们组装起来才能投入生产。一个单一的服务器已成为在负载平衡器后面工作的多个服务器；版本控制系统的使用已变得司空见惯。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/cg/bv/ch/cgbvchdac53hqrfbqadsqimp0oa.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于我的个人项目，我有一个特殊的配置。而且我知道我需要能够在生产环境中部署站点的能力，只需执行一个操作即可：将代码编写到</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub上</font><font style="vertical-align: inherit;">的分支</font><font style="vertical-align: inherit;">。另外，我知道要确保我的小型Web应用程序的运行，我不想管理一个巨大的Kubernetes集群，也不想使用Docker Swarm技术，也不想维护一个带有Pod，代理和各种其他困难的服务器园区。为了实现尽可能简化工作的目标，我需要熟悉CI / CD。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您有一个小型项目（在我们的案例中，我们正在谈论一个Node.js项目），并且您想了解如何自动执行此项目的部署，同时确保存储在存储库中的内容完全匹配什么对生产有效，我想您可能会对本文感兴趣。</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">先决条件</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
希望本文的读者具有命令行区域和编写Bash脚本的基本知识。</font><font style="vertical-align: inherit;">此外，他将需要</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis CI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帐户</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目标</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不会说这篇文章可以无条件地称为“培训手册”。</font><font style="vertical-align: inherit;">这是一份文档，其中我谈论了我学到的东西，并描述了在适合我的生产环境中测试和部署代码的过程，这些过程是一次自动执行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是我的工作流程的结局。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了发送到存储库任何分支的代码外，</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还将执行以下操作：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Travis CI上构建项目。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行所有的单元，集成和端到端测试。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仅针对进入</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下</font><font style="vertical-align: inherit;">代码的代码</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以上所有内容，再加上...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据当前代码，设置和环境构建Docker映像。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将映像放置在Docker Hub上。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接到生产服务器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将映像从Docker Hub上载到服务器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">停止当前容器，然后基于新映像启动一个新容器。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您对Docker，映像和容器一无所知-不用担心。</font><font style="vertical-align: inherit;">我将告诉大家有关此事的信息。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是CI / CD？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CI / CD的缩写代表“持续集成/持续部署”-“持续集成/持续部署”。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍持续整合</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
持续集成是开发人员对项目源代码的主存储库（通常是分支</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">进行提交的过程</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下，可以通过执行自动测试来确保代码的质量。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍持续部署</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
持续部署是生产中频繁的代码自动部署。</font><font style="vertical-align: inherit;">缩写CI / CD的第二部分有时公开为“连续交付”（“ continuous delivery”）。</font><font style="vertical-align: inherit;">通常，这与“连续部署”相同，但是“连续交付”意味着需要在开始项目部署过程之前手动确认更改。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开始工作</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我掌握了所有这些的应用程序称为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TakeNote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。这是我正在从事的Web项目，旨在做笔记。最初，我尝试制作一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JAMStack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目，或者只是一个没有服务器的前端应用程序，以利用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netlify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供的标准托管和部署</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">功能</font></a><font style="vertical-align: inherit;">。随着应用程序复杂性的增加，我需要创建其服务器部分，这意味着我将必须制定自己的策略以实现项目的自动集成和自动部署。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就我而言，该应用程序是一个运行在Node.js环境中的Express服务器，它服务于单页React应用程序并支持安全的服务器API。</font><font style="vertical-align: inherit;">该体系结构遵循</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完整堆栈身份验证指南中</font><font style="vertical-align: inherit;">的策略</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我咨询了</font><font style="vertical-align: inherit;">一位自动化专家</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">朋友</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并问他需要做些什么才能使其按我的方式工作。</font><font style="vertical-align: inherit;">他给了我一个想法，本文的目标部分概述了自动化工作流程的外观。</font><font style="vertical-align: inherit;">我为自己设定了这样的目标，这意味着我需要弄清楚如何使用Docker。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker是一种工具，由于采用了容器化技术，因此即使Docker平台本身在不同的环境中工作，也可以轻松地分发应用程序以及在同一环境中部署和启动它们。首先，我需要使用Docker命令行工具（CLI）。</font><font style="vertical-align: inherit;">安装Docker </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并不是很清楚易懂，但是您可以从中了解到，要迈出第一步的安装，您需要下载Docker Desktop（适用于Mac或Windows）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker Hub与</font><font style="vertical-align: inherit;">git存储库或</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">npm</font></a><font style="vertical-align: inherit;">注册表的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大致相同</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于JavaScript包。</font><font style="vertical-align: inherit;">这是Docker映像的在线存储库。</font><font style="vertical-align: inherit;">它连接到它的Docker Desktop。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，为了开始使用Docker，您需要做两件事：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Desktop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注册</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您可以通过运行以下命令来验证Docker版本来验证Docker CLI是否正常运行：</font></font><br>
<br>
<pre><code class="plaintext hljs">docker -v</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，在询问时输入您的用户名和密码，登录到Docker Hub：</font></font><br>
<br>
<pre><code class="plaintext hljs">docker login</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使用Docker，您必须了解映像和容器的概念。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍图片</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
图像就像一个计划，其中包含用于构建容器的说明。</font><font style="vertical-align: inherit;">这是文件系统和应用程序设置的不变快照。</font><font style="vertical-align: inherit;">开发人员可以轻松共享图像。</font></font><br>
<br>
<pre><code class="plaintext hljs">#     <font></font>
docker images</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此命令将显示带有以下标题的表：</font></font><br>
<br>
<pre><code class="plaintext hljs">REPOSITORY &nbsp; &nbsp; TAG     IMAGE ID &nbsp; &nbsp; CREATED     SIZE<font></font>
---</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我们将考虑一些具有相同格式的命令示例-首先是带有注释的命令，然后是可输出命令的示例。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍容器</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
容器是一个可执行程序包，其中包含运行应用程序所需的一切。</font><font style="vertical-align: inherit;">无论采用哪种基础结构，采用这种方法的应用程序始终可以在同一个环境中工作：在隔离的环境中和在同一环境中。</font><font style="vertical-align: inherit;">关键是在不同的环境中，将启动同一图像的实例。</font></font><br>
<br>
<pre><code class="plaintext hljs">#   <font></font>
docker ps -a<font></font>
CONTAINER ID &nbsp; &nbsp; IMAGE     COMMAND &nbsp; &nbsp; CREATED     STATUS     PORTS &nbsp; &nbsp; NAMES<font></font>
---</code></pre><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍标签</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
标签是图像特定版本的指示。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍Docker命令摘要</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一些常用的Docker命令的概述。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">球队</font></font><br>
</th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语境</font></font><br>
</th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">法案</font></font><br>
</th>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从Dockerfile组装映像</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人标签</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图片标记</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人图像</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列表图片</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">泊坞窗运行</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容器</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于图像的容器启动</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人推</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将图像提交到注册表</font></font><br>
</td>
</tr>
<tr>
<td><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人拉</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从注册表下载图像</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人ps</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容器</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列出容器</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">码头工人系统修剪</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图片/容器</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除未使用的容器和图像</font></font><br>
</td>
</tr>
</tbody></table></div><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍Dockerfile</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我知道如何在本地运行生产应用程序。</font><font style="vertical-align: inherit;">我有一个Webpack配置，旨在构建一个现成的React应用程序。</font><font style="vertical-align: inherit;">接下来，我有一个命令，用于在port上启动基于Node.js的服务器</font></font><code>5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">看起来像这样：</font></font><br>
<br>
<pre><code class="plaintext hljs">npm i &nbsp; &nbsp; &nbsp; &nbsp; #  <font></font>
npm run build #  React-<font></font>
npm run start #  Node-</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
应当指出，我没有该材料的示例应用程序。</font><font style="vertical-align: inherit;">但是在这里，对于实验来说，任何简单的Node应用程序都适用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使用该容器，您需要提供Docker指令。</font><font style="vertical-align: inherit;">这是通过</font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">位于项目根目录中的</font><font style="vertical-align: inherit;">一个文件完成</font><font style="vertical-align: inherit;">的。</font><font style="vertical-align: inherit;">起初，此文件似乎很晦涩。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是它仅包含一些特殊命令，描述了与设置工作环境类似的内容。</font><font style="vertical-align: inherit;">以下是其中一些命令：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FROM-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此命令启动文件。</font><font style="vertical-align: inherit;">它指示构建容器的基础图像。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COPY-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将文件从本地源复制到容器。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WORKDIR-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为以下命令设置工作目录。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUN-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行命令。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPOSE-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">端口设置。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENTRYPOINT-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定要执行的命令。</font></font></li>
</ul><br>
<code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 可能看起来像这样：</font></font><br>
<br>
<pre><code class="plaintext hljs">#   <font></font>
FROM node:12-alpine<font></font>
<font></font>
#        app/<font></font>
COPY . app/<font></font>
<font></font>
#  app/    <font></font>
WORKDIR app/<font></font>
<font></font>
#   ( npm ci  npm i,     )<font></font>
RUN npm ci --only-production<font></font>
<font></font>
#   React-  <font></font>
RUN npm run build<font></font>
<font></font>
#   <font></font>
EXPOSE 5000<font></font>
<font></font>
#  Node-<font></font>
ENTRYPOINT npm run start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据所选的基本映像，您可能需要安装其他依赖项。</font><font style="vertical-align: inherit;">事实是某些基本映像（例如Node Alpine Linux）旨在使它们尽可能紧凑。</font><font style="vertical-align: inherit;">因此，他们可能没有您要依靠的某些程序。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍构建，标记和启动容器</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有了容器之后，容器的本地组装和启动</font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就很简单了。</font><font style="vertical-align: inherit;">在将映像发送到Docker Hub之前，您需要在本地对其进行测试。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍组装</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，您需要</font><font style="vertical-align: inherit;">通过指定名称和（可选）标签</font><font style="vertical-align: inherit;">来收集</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图像</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（如果未指定标签，则系统将自动为图像分配标签</font></font><code>latest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="plaintext hljs">#  <font></font>
docker build -t &lt;image&gt;:&lt;tag&gt; .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行此命令后，您可以观察Docker如何构建映像。</font></font><br>
<br>
<pre><code class="plaintext hljs">Sending build context to Docker daemon &nbsp; 2.88MB<font></font>
Step 1/9 : FROM node:12-alpine<font></font>
&nbsp;---&gt; ...  ...<font></font>
Successfully built 123456789123<font></font>
Successfully tagged &lt;image&gt;:&lt;tag&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
组装可能要花费几分钟-这完全取决于您拥有多少依赖项。</font><font style="vertical-align: inherit;">组装完成后，您可以执行命令</font></font><code>docker images</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并查看新映像的描述。</font></font><br>
<br>
<pre><code class="plaintext hljs">REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG               IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CREATED              SIZE<font></font>
&lt;image&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latest            123456789123&nbsp; &nbsp; &nbsp; &nbsp; About a minute ago   x.xxGB</code></pre><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍开始</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
图像已创建。</font><font style="vertical-align: inherit;">这意味着在此基础上可以启动容器。</font><font style="vertical-align: inherit;">因为我希望能够访问容器中运行的应用程序</font><font style="vertical-align: inherit;">，所以在下</font></font><code>localhost:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一条</font></font><code>5000:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">中，该地址将</font><font style="vertical-align: inherit;">安装</font><font style="vertical-align: inherit;">在该对的左侧</font></font><code>5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">右侧是容器端口。</font></font><br>
<br>
<pre><code class="plaintext hljs">#      5000    5000<font></font>
docker run -p 5000:5000 &lt;image&gt;:&lt;tag&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在已经创建并启动了容器，您可以使用命令</font></font><code>docker ps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看有关此容器的信息（或者可以使用</font></font><code>docker ps -a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示所有容器（而不仅仅是工作容器）信息</font><font style="vertical-align: inherit;">的命令</font><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="plaintext hljs">CONTAINER ID&nbsp; &nbsp; &nbsp; &nbsp; IMAGE               COMMAND&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CREATED              STATUS                  &nbsp; &nbsp; PORTS                    NAMES<font></font>
987654321234&nbsp; &nbsp; &nbsp; &nbsp; &lt;image&gt;             "/bin/sh -c 'npm run…" &nbsp; 6 seconds ago        Up 6 seconds            &nbsp; &nbsp; 0.0.0.0:5000-&gt;5000/tcp   stoic_darwin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果现在转到该地址</font></font><code>localhost:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则可以看到正在运行的应用程序的页面，该页面看起来与在生产环境中运行的应用程序的页面完全相同。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍标签分配和发布</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了在生产服务器上使用创建的映像之一，我们需要能够从Docker Hub下载该映像。</font><font style="vertical-align: inherit;">这意味着您必须首先在Docker Hub上为项目创建一个存储库。</font><font style="vertical-align: inherit;">之后，我们将为您提供一个可以修复图像的地方。</font><font style="vertical-align: inherit;">必须重命名映像，以便其名称以Docker Hub上的用户名开头。</font><font style="vertical-align: inherit;">此后应该是存储库的名称。</font><font style="vertical-align: inherit;">名称末尾可以是任何标签。</font><font style="vertical-align: inherit;">以下是使用此方案命名图像的示例。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以使用新名称收集映像并运行命令</font></font><code>docker push</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以将其发送到Docker Hub存储库。</font></font><br>
<br>
<pre><code class="plaintext hljs">docker build -t &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt; .<font></font>
docker tag &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt; &lt;username&gt;/&lt;repository&gt;:latest<font></font>
docker push &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt;<font></font>
<font></font>
#     , , :<font></font>
docker build -t user/app:v1.0.0 .<font></font>
docker tag user/app:v1.0.0 user/app:latest<font></font>
docker push user/app:v1.0.0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果一切顺利，该映像将在Docker Hub上可用，并且可以轻松下载到服务器或转移给其他开发人员。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
迄今为止，我们已经确保以Docker容器形式的应用程序在本地工作。</font><font style="vertical-align: inherit;">我们将容器上传到Docker Hub。</font><font style="vertical-align: inherit;">所有这些意味着我们已经朝着这个目标取得了非常好的进展。</font><font style="vertical-align: inherit;">现在我们需要解决两个问题：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置用于测试和部署代码的CI工具。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置生产服务器，以便它可以加载和运行我们的代码。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的案例中，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis CI被</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用作CI / CD解决方案</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">作为服务器</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-DitigalOcean</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
应该注意的是，您可以在这里使用其他服务组合。</font><font style="vertical-align: inherit;">例如，可以使用CircleCI或Github Actions代替Travis CI。</font><font style="vertical-align: inherit;">而不是DigitalOcean-AWS或Linode。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们决定使用Travis CI，并且在此服务中我已经配置了一些东西。</font><font style="vertical-align: inherit;">因此，现在我将简要讨论如何准备工作。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特拉维斯</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travis CI是用于测试和部署代码的工具。由于每个项目都是唯一的，所以我不想复杂地设置Travis CI，这不会带来太多好处。但是，我将告诉您有关决定使用Travis CI的基础知识。无论选择什么-Travis CI，CircleCI，Jenkins或其他任何东西，类似的配置方法将在各处使用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了开始使用Travis CI，请访问</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目网站</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并创建一个帐户。</font><font style="vertical-align: inherit;">然后将Travis CI与您的GitHub帐户集成。</font><font style="vertical-align: inherit;">在系统设置期间，您将需要指定要用于自动化的存储库并启用对其的访问。</font><font style="vertical-align: inherit;">（我使用GitHub，但是我确定Travis CI可以与BitBucket，GitLab和其他类似服务集成）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每次使用Travis CI进行工作时，都会启动服务器，该服务器执行配置文件中指定的命令，包括部署相应的存储库分支。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍任务生命周期</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travis CI配置文件（称为</font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并存储在项目的根目录中）支持</font><font style="vertical-align: inherit;">作业</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生命周期</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件的概念</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些事件按发生的顺序列出：</font></font><br>
<br>
<ul>
<li><code>apt addons</code></li>
<li><code>cache components</code></li>
<li><code>before_install</code></li>
<li><code>install</code></li>
<li><code>before_script</code></li>
<li><code>script</code></li>
<li><code>before_cache</code></li>
<li><code>after_success  after_failure</code></li>
<li><code>before_deploy</code></li>
<li><code>deploy</code></li>
<li><code>after_deploy</code></li>
<li><code>after_script</code></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍测试</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在配置文件中，我将配置本地Travis CI服务器。作为语言，我选择了Node 12，并告诉系统安装使用Docker所需的依赖项。</font><font style="vertical-align: inherit;">除非另有说明，否则在执行对存储库的所有分支的所有拉取请求时</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，</font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将执行</font><font style="vertical-align: inherit;">列出的</font><font style="vertical-align: inherit;">所有内容。这是一个有用的功能，因为这意味着我们可以测试进入存储库的所有代码。这使您可以知道代码是否准备好写入分支，</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及是否会破坏项目的构建过程。在这种全局配置中，我将所有内容安装在本地，在后台启动Webpack开发人员服务器（这是我的工作流程的一项功能）并运行测试。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果要在存储库上显示带有测试代码覆盖率信息的图标，</font><font style="vertical-align: inherit;">可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到有关使用Jest，Travis CI和Coveralls收集和显示此信息的简要说明。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所以这是文件的内容</font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">#  <font></font>
language: node_js<font></font>
<font></font>
#   Node.js<font></font>
node_js:<font></font>
&nbsp;&nbsp;- '12'<font></font>
<font></font>
services:<font></font>
&nbsp;&nbsp;#    Docker<font></font>
&nbsp;&nbsp;- docker<font></font>
<font></font>
install:<font></font>
&nbsp;&nbsp;#    <font></font>
&nbsp;&nbsp;- npm ci<font></font>
<font></font>
before_script:<font></font>
&nbsp;&nbsp;#      <font></font>
&nbsp;&nbsp;- npm run dev &amp;<font></font>
<font></font>
script:<font></font>
&nbsp;&nbsp;#  <font></font>
&nbsp;&nbsp;- npm run test</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，对存储库的所有分支和拉取请求执行的操作结束。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍部署</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基于所有自动化测试均已成功完成的假设，我们可以选择将代码部署在生产服务器上。</font><font style="vertical-align: inherit;">由于我们只想对来自分支的代码执行此操作</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此我们在部署设置中为系统提供了适当的说明。</font><font style="vertical-align: inherit;">在尝试使用项目中的代码（稍后我们将对其进行讨论）之前，我想警告您，您必须具有一个用于部署的真实脚本。</font></font><br>
<br>
<pre><code class="plaintext hljs">deploy:<font></font>
&nbsp;&nbsp;#  Docker-     Docker Hub<font></font>
&nbsp;&nbsp;provider: script<font></font>
&nbsp;&nbsp;script: bash deploy.sh<font></font>
&nbsp;&nbsp;on:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;branch: master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部署脚本解决了两个问题：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用CI工具（在我们的示例中为Travis CI）构建，标记映像并将其发送到Docker Hub。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将图像加载到服务器上，停止旧容器并启动新容器（在我们的示例中，服务器在DigitalOcean平台上运行）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，您需要配置自动组装，标记和将映像发送到Docker Hub的过程。所有这些都与我们已经手动完成的工作非常相似，除了这里我们需要一种为图像分配唯一标签并自动登录的策略。我在部署脚本的一些细节方面遇到了困难，例如标记策略，登录，对SSH密钥进行编码，建立SSH连接。但是，幸运的是，我的男朋友能很好地处理bash，以及其他许多事情。他帮助我编写了这个脚本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，脚本的第一部分是将映像发送到Docker Hub。这很简单。我使用的标记方案包括将git哈希和git标记（如果存在）组合在一起。这样可以创建唯一的标签，并简化对其所基于组件的标识。</font></font><code>DOCKER_USERNAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且</font></font><code>DOCKER_PASSWORD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是可以使用的特拉维斯CI接口设置用户环境变量。 Travis CI自动处理敏感数据，以免将其落入错误的手中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是脚本的第一部分</font></font><code>deploy.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">#!/bin/sh<font></font>
set -e #     <font></font>
<font></font>
IMAGE="&lt;username&gt;/&lt;repository&gt;" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #  Docker<font></font>
GIT_VERSION=$(git describe --always --abbrev --tags --long) # Git-  <font></font>
<font></font>
#    <font></font>
docker build -t ${IMAGE}:${GIT_VERSION} .<font></font>
docker tag ${IMAGE}:${GIT_VERSION} ${IMAGE}:latest<font></font>
<font></font>
#   Docker Hub   <font></font>
echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin<font></font>
docker push ${IMAGE}:${GIT_VERSION}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
脚本的第二部分将完全取决于您所使用的主机以及与该主机的连接方式。就我而言，由于我使用Digital Ocean，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">doctl</font></a><font style="vertical-align: inherit;">命令连接到服务器</font><font style="vertical-align: inherit;">。使用Aws时，将使用实用程序</font></font><code>aws</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，依此类推。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设置服务器并不是特别困难。因此，我根据基本图像设置了一个小滴。应当注意，我选择的系统需要一次性手动安装Docker和一次性手动启动Docker。我使用Ubuntu 18.04安装Docker，因此，如果您使用Ubuntu进行相同的操作，则可以按照</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单指南进行操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我在这里不是在谈论服务的特定命令，因为在不同情况下，这方面可能会有很大的不同。</font><font style="vertical-align: inherit;">我只会给出通过SSH连接到将要部署项目的服务器后要执行的总体行动计划：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您需要找到当前正在运行的容器并将其停止。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后，在后台，您需要启动一个新容器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您需要将本地服务器端口设置为一个值</font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-这将使您可以在表单地址处输入站点</font></font><code>example.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而无需指定端口，并且不能使用像这样的地址</font></font><code>example.com:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后，您需要删除所有旧的容器和图像。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是脚本的延续。</font></font><br>
<br>
<pre><code class="plaintext hljs">#  ID  <font></font>
CONTAINER_ID=$(docker ps | grep takenote | cut -d" " -f1)<font></font>
<font></font>
#   ,  ,  <font></font>
docker stop ${CONTAINER_ID}<font></font>
docker run --restart unless-stopped -d -p 80:5000 ${IMAGE}:${GIT_VERSION}<font></font>
docker system prune -a -f</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要考虑的一些事情</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也许当您从Travis CI通过SSH连接到服务器时，您会看到一条警告，该警告将不允许继续安装，因为系统将等待用户响应。</font></font><br>
<br>
<pre><code class="plaintext hljs">The authenticity of host '&lt;hostname&gt; (&lt;IP address&gt;)' can't be established.<font></font>
RSA key fingerprint is &lt;key fingerprint&gt;.<font></font>
Are you sure you want to continue connecting (yes/no)?</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我了解到可以使用base64对字符串键进行编码，以便将其保存为一种使用起来方便且可靠的形式。</font><font style="vertical-align: inherit;">在安装阶段，您可以解码公共密钥并将其写入文件</font></font><code>known_hosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中，以摆脱上述错误。</font></font><br>
<br>
<pre><code class="plaintext hljs">echo &lt;public key&gt; | base64 #  &lt; ,   base64&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，此命令可能如下所示：</font></font><br>
<br>
<pre><code class="plaintext hljs">echo "123.45.67.89 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAklOUpkDHrfHY17SbrmTIpNLTGK9Tjom/BWDSU<font></font>
GPl+nafzlHDTYW7hdI4yZ5ew18JH4JW9jbhUFrviQzM7xlELEVf4h9lFX5QVkbPppSwg0cda3<font></font>
Pbv7kOdJ/MTyBlWXFCR+HAo3FXRitBqxiX1nKhXpHAZsMciLq8V6RjsNAQwdsdMFvSlVK/7XA<font></font>
t3FaoJoAsncM1Q9x5+3V0Ww68/eIFmb1zuUFljQJKprrX88XypNDvjYNby6vw/Pb0rwert/En<font></font>
mZ+AW4OZPnTPI89ZPmVMLuayrD2cE86Z/il8b+gw3r3+1nKatmIkjn2so1d01QraTlMqVSsbx<font></font>
NrRFi9wrf+M7Q== you@example.com" | base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是它给出的内容-一个base64编码的字符串：</font></font><br>
<br>
<pre><code class="plaintext hljs">MTIzLjQ1LjY3Ljg5IHNzaC1yc2EgQUFBQUIzTnphQzF5YzJFQUFBQUJJd0FBQVFFQWtsT1Vwa0RIcmZIWTE3U2JybVRJcE5MVEdLOVRqb20vQldEU1UKR1BsK25hZnpsSERUWVc3aGRJNHlaNWV3MThKSDRKVzlqYmhVRnJ2aVF6TTd4bEVMRVZmNGg5bEZYNVFWa2JQcHBTd2cwY2RhMwpQYnY3a09kSi9NVHlCbFdYRkNSK0hBbzNGWFJpdEJxeGlYMW5LaFhwSEFac01jaUxxOFY2UmpzTkFRd2RzZE1GdlNsVksvN1hBCnQzRmFvSm9Bc25jTTFROXg1KzNWMFd3NjgvZUlGbWIxenVVRmxqUUpLcHJyWDg4WHlwTkR2allOYnk2dncvUGIwcndlcnQvRW4KbVorQVc0T1pQblRQSTg5WlBtVk1MdWF5ckQyY0U4NlovaWw4YitndzNyMysxbkthdG1Ja2puMnNvMWQwMVFyYVRsTXFWU3NieApOclJGaTl3cmYrTTdRPT0geW91QGV4YW1wbGUuY29tCg==</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是上面提到的团队</font></font><br>
<br>
<pre><code class="plaintext hljs">install:<font></font>
&nbsp;&nbsp;- echo &lt;  ,   base64&gt; | base64 -d &gt;&gt; $HOME/.ssh/known_hosts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
建立连接时，可以对私钥使用相同的方法，因为您可能需要私钥才能访问服务器。</font><font style="vertical-align: inherit;">使用键时，只需要确保将其安全存储在Travis CI环境变量中即可，因此不会在任何地方显示它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您还应注意的另一件事是，您可能需要运行整个部署脚本，以单行显示，例如，使用</font></font><code>doctl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这可能需要一些额外的努力。</font></font><br>
<br>
<pre><code class="plaintext hljs">doctl compute ssh &lt;droplet&gt; --ssh-command "    &amp;&amp; "</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLS / SSL和负载平衡</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完成上面讨论的所有事情之后，摆在我面前的最后一个问题是服务器没有SSL。由于我使用Node.js服务器，因此为了使</font><font style="vertical-align: inherit;">Nginx和“加密反向代理” </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正常工作</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我需要进行很多修改。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我真的不希望手动进行所有这些SSL设置，因此我创建了一个负载均衡器并将其信息记录在DNS中。例如，对于DigitalOcean，在负载均衡器上创建一个自我更新的自签名证书是一个简单，免费和快速的过程。这种方法还有一个优势，如果有必要，它可以使在运行负载均衡器的各种服务器上配置SSL非常容易。这样一来，服务器本身根本就不会“思考” SSL，而是照常使用端口</font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，与其他SSL配置方法相比，在负载平衡器上设置SSL更加简单和方便。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以在服务器上关闭所有接受传入连接的端口-除了用于</font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与负载平衡器通信的端口</font></font><code>22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和SSH </font><font style="vertical-align: inherit;">的端口以外</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">结果，除这两个端口外，尝试直接访问任何端口上的服务器都将失败。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">摘要</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完成了本材料中描述的所有操作之后，我不再担心Docker平台或自动CI / CD链的概念。我能够建立一个持续的集成链，在此过程中，代码将在投入生产之前经过测试，并将代码自动部署到服务器中。对我而言，所有这一切仍然相对较新，并且我确信有多种方法可以改善自动化工作流程并使其更加高效。因此，如果您对此主题有任何想法，请告诉</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。希望本文对您的事务有所帮助。我想相信，在阅读完所有内容后，您会学到很多东西，而我却学到了很多。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在我们的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">市场上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有</font><font style="vertical-align: inherit;">一个形象</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一键安装。</font><font style="vertical-align: inherit;">您可以在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上检查容器的操作</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">所有新客户均可免费享受3天的测试。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">亲爱的读者们！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您是否在项目中使用CI / CD技术？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488658/index.html">使用faiss搜索多维空间</a></li>
<li><a href="../zh-CN488660/index.html">现在该忘记React并升级到Svelte吗？</a></li>
<li><a href="../zh-CN488662/index.html">每个Web开发人员都需要的浏览器扩展</a></li>
<li><a href="../zh-CN488664/index.html">寻找完美的工具包：分析流行的Python项目模板</a></li>
<li><a href="../zh-CN488666/index.html">适用于所有场合的10种React组件</a></li>
<li><a href="../zh-CN488670/index.html">关于掩码寄存器</a></li>
<li><a href="../zh-CN488672/index.html">通过UART调试ARM Cortex-M微控制器</a></li>
<li><a href="../zh-CN488674/index.html">图表与Excel和PowerPoint</a></li>
<li><a href="../zh-CN488678/index.html">Node.js对小缓冲区的需求很大</a></li>
<li><a href="../zh-CN488682/index.html">如何测试Python编程技能？Yandex的任务</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>