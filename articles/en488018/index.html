<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧕 👰🏽 👨🏻‍🏫 CAPTCHA, special case: we break a neural network with thirty lines of code 🈁 🥒 ☘️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don’t remember how I came across the article habr.com/ru/post/464337 , but it sunk into my brain and did not give rest until the last day. Several t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CAPTCHA, special case: we break a neural network with thirty lines of code</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;&nbsp;I don’t remember how I came across the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/ru/post/464337</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but it sunk into my brain and did not give rest until the last day. </font><font style="vertical-align: inherit;">Several times I tried to understand what was happening, a couple of times I tried to make it work, but to no avail: I do not understand anything at all in neural networks and even program like a real programmer.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4z/eb/8b/4zeb8bn8i97b4662ssgxu8x_rgk.jpeg" alt="happy captcha"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Finally, a few days ago, I overpowered the launch of the python and decided, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">why not</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and so on. Having forgotten everything that I read in the mentioned article, I went my own way. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Remembering the myriad of resolved captchas, I suggested that you can solve them by banal comparison with the mask, which was later confirmed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;First, manually assembled test captcha (83 pieces) and gave them obvious names. The script turned them into bitmaps.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ps/kq/ku/pskqkuzoyxdkyh8d4d8ty_pkq_m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;The numbers in the captcha are two sizes in height with a difference of 1 pixel and three to four faces in width. </font><font style="vertical-align: inherit;">The baseline of all characters in all captcha is the same. </font><font style="vertical-align: inherit;">All this diversity, as it turned out, has a certain common mask, a comparison with which uniquely identifies a figure. </font><font style="vertical-align: inherit;">I cut out several (at first - 5, then added another 1-2; with "4" it took longer than the rest) of the same numbers from different captchas. </font><font style="vertical-align: inherit;">In paint.net, I put them on top of each other and got a mask that is common to all faces of each digit.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gp/9_/tg/gp9_tggrvacz2jncx6eesiffz7c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;I discovered the only problem later, already during mass processing, but successfully bypassed it</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a crutch</font></font></b>
                        <div class="spoiler_text">&nbsp;&nbsp;&nbsp;,     —      «1»,  «2»  ..  «9». ,    ,        «4»,      «4»,  «1». , -,      «123456789»  «423156789»  -,    «4»    ,    «1». <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;In addition to this small misunderstanding, the noise does not interfere at all. </font><font style="vertical-align: inherit;">The result of this stage was a set of 9 masks. </font><font style="vertical-align: inherit;">Two nested loops and voila! </font><font style="vertical-align: inherit;">- all my 83 captchas are recognized with a bang! </font></font><br>
<img src="https://habrastorage.org/webt/dc/we/3f/dcwe3fms8fxijery7_mg-s_isfa.png"><br>
&nbsp;&nbsp;&nbsp;<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Then the question arose: where to get a large set of captcha for verification. </font><font style="vertical-align: inherit;">And I downloaded “29,000 captcha” from the mentioned article.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, this turned out to be a waste of time.</font></font></b>
                        <div class="spoiler_text">&nbsp;&nbsp;&nbsp;- (, -, ..    ),    :         : 6503 , 5420 , 760  .. – ..    14882, , ,  .<br>
-,     – -, –    .      PNG,    – JPG,    ,   .  ,       –     «”” ».<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;So I had to uncover Google and mine the perfect captcha on my own: 3224 files were accumulated per night, including 49 completely empty ones, as it turned out later. Thank you Ganesha for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Actually recognition of captcha fits into 26 lines of boring python code. From external modules only PIL is needed. The speed is about 1000 captcha per minute (one thousand captcha per minute) on the old Core 2 “four cores four gigs”. On a more decent eight-stream i5 is noticeably faster, although the matter, of course, is not in the threads. Recognition of 100% or very close to that: spot check showed no errors.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Of course, all this is not interesting in the sense of neural networks and other blockchains, but it has a very definite advantage over the previously proposed option: speed and accuracy. </font><font style="vertical-align: inherit;">It is also true that any change in the parameters of the captcha - headset or font size, type of noise, etc. </font><font style="vertical-align: inherit;">- will lead to the complete inoperability of my decision. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download the archive with captcha from Yandex.Disk (14MB).</font></font><br>
</a><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageTk<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recognize</span>(<span class="hljs-params">filepath</span>):</span>
  Zlist = [] <span class="hljs-comment"># [(x1, z1), (x2, z2), (x3, z3), etc.] - position and digit</span>
  captcha = <span class="hljs-string">""</span>
  originalimage = Image.open(filepath).convert(<span class="hljs-string">'L'</span>).point(<span class="hljs-keyword">lambda</span> x : <span class="hljs-number">255</span> <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">20</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>, mode=<span class="hljs-string">'1'</span>).convert(<span class="hljs-string">'1'</span>).convert(<span class="hljs-string">'RGBA'</span>)
  <span class="hljs-keyword">if</span> originalimage.getextrema() == ((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>)):
    <span class="hljs-keyword">return</span>(<span class="hljs-string">"empty image"</span>)
  <span class="hljs-keyword">for</span> z <span class="hljs-keyword">in</span> [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]: <span class="hljs-comment"># reorder to exclude false 1 on 4</span>
    mask = Image.open(<span class="hljs-string">'mask'</span> + str(z) + <span class="hljs-string">'.png'</span>).convert(<span class="hljs-string">'RGBA'</span>)<font></font>
    previ = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">15</span>, <span class="hljs-number">120</span>): <span class="hljs-comment"># no digit in left part</span>
      resultimage = Image.alpha_composite(originalimage.crop((i, <span class="hljs-number">0</span>, i + <span class="hljs-number">30</span>, <span class="hljs-number">0</span> + <span class="hljs-number">50</span>)), mask)
      <span class="hljs-keyword">if</span> resultimage.getextrema() == ((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>)):
        <span class="hljs-keyword">if</span> z == <span class="hljs-number">4</span>: <span class="hljs-comment"># delete 4 to exclude false 1 on 4</span>
          maskx = Image.open(<span class="hljs-string">'mask4x.png'</span>).convert(<span class="hljs-string">'RGBA'</span>) <font></font>
          originalimage.paste(Image.alpha_composite(originalimage.crop((i, <span class="hljs-number">0</span>, i + <span class="hljs-number">30</span>, <span class="hljs-number">0</span> + <span class="hljs-number">50</span>)), maskx), (i, <span class="hljs-number">0</span>))
        <span class="hljs-keyword">if</span> previ == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> i &gt; previ + <span class="hljs-number">15</span>: <span class="hljs-comment">#no digit closer then 15 px</span><font></font>
          Zlist.append((i, z))<font></font>
          <span class="hljs-keyword">if</span> len(Zlist) == <span class="hljs-number">5</span>:<font></font>
              Zlist.sort()<font></font>
              <span class="hljs-keyword">for</span> z <span class="hljs-keyword">in</span> Zlist:<font></font>
                captcha = captcha + str(z[<span class="hljs-number">1</span>])
              <span class="hljs-keyword">return</span>(captcha)<font></font>
          previ = i<font></font>
          i = i + <span class="hljs-number">15</span> <span class="hljs-comment">#skip a little</span><font></font>
  Zlist.sort()<font></font>
  <span class="hljs-keyword">return</span>(str(Zlist)) <span class="hljs-comment">#if less then 5 digits recognized</span><font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
  captcha = recognize(entry.path)<font></font>
<span class="hljs-comment">#----------------------------------------------#</span>
<span class="hljs-comment">#          #</span>
<span class="hljs-comment">#----------------------------------------------#</span><font></font>
<font></font>
main()<font></font>
</code></pre><br>
<br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update as of February 13, 2020. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;What was it all about? Not for the sake of sports recognition of saved images? No, all this was purely for pragmatic purposes. </font></font><br>
&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready solution for work.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Local http recognition server plus extension for Chrome. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;So far, the only thing that it can (I hope that can) is to automatically insert the captcha in the right place. The plans: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp; - clean the site interface, leaving the necessary minimum; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp; - automate captcha updating when viewing information, as one captcha makes it possible to open only 4 objects. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp; - Download all prepared statements at once, and not one at a time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update as of March 5, 2020. </font></font><br>
&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready solution for work.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Local http recognition server plus extension for Chrome. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Updated the extension for Chrome. </font><font style="vertical-align: inherit;">Now it can, in addition to captcha auto-substitution, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;1. when opening pages with information about real estate objects, expand information about rights; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;2. Collect information from these pages for further processing. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;Screenshot in the comment </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/post/488018/#comment_21360646</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Update as of April 17, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">2020</font></a><font style="vertical-align: inherit;"> . </font></font><br>
&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot for ordering statements from the list</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - due to the restriction on the frequency of ordering statements - 1 statement in 5 minutes. </font><font style="vertical-align: inherit;">Screenshot in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488006/index.html">At Moscow Python Conf ++, come talk to the language developers</a></li>
<li><a href="../en488008/index.html">Taming the beast: legacy code, tests and you</a></li>
<li><a href="../en488010/index.html">Domain Driven Design Tools</a></li>
<li><a href="../en488012/index.html">Parking for your cons</a></li>
<li><a href="../en488014/index.html">9. Fortinet Getting Started v6.0. Logging and Reporting</a></li>
<li><a href="../en488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../en488024/index.html">Fantastic advisory locks and where they live</a></li>
<li><a href="../en488026/index.html">Jewelery, Formlabs 3D Printer and Environmental Care</a></li>
<li><a href="../en488028/index.html">How to start making a game in UE4</a></li>
<li><a href="../en488030/index.html">How to organize skins in symfony</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>