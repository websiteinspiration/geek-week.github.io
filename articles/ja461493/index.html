<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ† ğŸ¤³ğŸ½ ğŸ•ºğŸ¼ Django 3.0ã¯éåŒæœŸã«ãªã‚Šã¾ã™ ğŸšš â˜•ï¸ ğŸ‘©ğŸ¿â€ğŸ“</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Andrew GodwinãŒDEP 0009ï¼šAsync-capable Djangoã‚’5æœˆ9æ—¥ã«å…¬é–‹ã—ã€7æœˆ21æ—¥ã«Django æŠ€è¡“è©•è­°ä¼šã«ã‚ˆã£ã¦æ‰¿èªã•ã‚ŒãŸãŸã‚ã€Django 3.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¾ã§ã«ã€èˆˆå‘³æ·±ã„ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚ãã‚Œã¯Habrã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã©ã“ã‹ã§ã™ã§ã«...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Django 3.0ã¯éåŒæœŸã«ãªã‚Šã¾ã™</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461493/"><p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andrew GodwinãŒ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEP 0009ï¼šAsync-capable Django</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’5æœˆ9æ—¥ã«</font><font style="vertical-align: inherit;">å…¬é–‹ã—ã€</font><font style="vertical-align: inherit;">7æœˆ21æ—¥ã«</font><font style="vertical-align: inherit;">Django </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŠ€è¡“è©•è­°ä¼šã«ã‚ˆã£ã¦</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¿èªã•</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã‚ŒãŸ</font></a><font style="vertical-align: inherit;">ãŸã‚ã€Django 3.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¾ã§ã«ã€èˆˆå‘³æ·±ã„ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habrã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã©ã“ã‹ã§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã™ã§ã«è¨€åŠã•ã‚Œ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã¦ã„ã¾ã—ãŸ</font></a><font style="vertical-align: inherit;">ãŒã€ç§ã¯ã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ç¿»è¨³ã—ã¦ã‚ˆã‚Šåºƒã„è´è¡†ã«ä¼ãˆã‚‹ã“ã¨ã‚’æ±ºã‚ã¾ã—ãŸ-ä¸»ã«ã€ç§ã®ã‚ˆã†ã«ã€ç‰¹ã«Djangoã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ãªã„äººã®ãŸã‚ã«ã€‚</font></font></em></p><br>
<div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="1153030952915890177"></twitter-widget>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éåŒæœŸPythonã¯é•·å¹´é–‹ç™ºã•ã‚Œã¦ãŠã‚Šã€Djangoã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã§ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸»ã«Webã‚½ã‚±ãƒƒãƒˆã®ã‚µãƒãƒ¼ãƒˆã«é‡ç‚¹ã‚’ç½®ã„</font><font style="vertical-align: inherit;">ã¦ã€</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ãƒãƒ£ãƒãƒ«ã§</font></a><font style="vertical-align: inherit;">å®Ÿé¨“ã‚’</font><font style="vertical-align: inherit;">è¡Œã„ã¾ã—ãŸã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ãŒç™ºå±•ã™ã‚‹ã«ã¤ã‚Œã€Djangoã‚’æ‹¡å¼µã—ã¦Webã‚½ã‚±ãƒƒãƒˆãªã©ã®éHTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€éåŒæœŸã‚µãƒãƒ¼ãƒˆã¯å¾“æ¥ã®Djangoãƒ¢ãƒ‡ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«å¤šãã®ãƒ¡ãƒªãƒƒãƒˆã‚’ã‚‚ãŸã‚‰ã™ã“ã¨ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ©ç‚¹ã¯ä»¥ä¸‹ã®å‹•æ©Ÿã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ãŒã€ç§ãŒå¾—ãŸä¸€èˆ¬çš„ãªçµè«–ã¯ã€éåŒæœŸã®Djangoã‹ã‚‰å¤šãã®ã“ã¨ã‚’å¾—ã‚‹ã®ã§ã€ãã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã®ã¯å¤§å¤‰ãªä½œæ¥­ã«å€¤ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ç§ã¯ã¾ãŸã€ç‡ƒãˆå°½ãã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹1äººã¾ãŸã¯2äººã®å¤ã„è²¢çŒ®è€…ã«ä¾å­˜ã—ãªã„ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹åå¾©çš„ãªæ–¹æ³•ã§å¤‰æ›´ã‚’åŠ ãˆã‚‹ã“ã¨ãŒéå¸¸ã«é‡è¦ã§ã‚ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚</font></font><a name="habracut"></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Œæ©Ÿèƒ½ã€DEPã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã™ã¹ã¦ã€ä¸€éƒ¨ãŒãƒ—ãƒ­ã‚»ã‚¹DEPã§ã‚‚ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã«ææ¡ˆã™ã‚‹å¤‰æ›´ã®ç¯„å›²ã¯ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©å¤§ããã€å¾“æ¥ã®å˜ä¸€æ©Ÿèƒ½ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦ãã‚Œã‚‰ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã¯å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p><br>
<p>,         Django,    ,       .     ,    Django â€”    ,      ,        ,  ,       .</p><br>
<p>  ? .   ,       Django â€”        ,   ,      ,    .</p><br>
<p> ,  Django     ,        ,             .     , -       -      .</p><br>
<p> DEP     , ,  ,   .  ,           ,     .         ;     ,    . Django        , ,       ,     .</p><br>
<h2 id="kratkoe-opisanie"> </h2><br>
<p>    Django   , middleware, ORM    .</p><br>
<p>               .  API     ,           .</p><br>
<p> ASGI   Django    .  WSGI    event loop     Django,        .</p><br>
<p>  ORM           (sticky threads)     ORM.</p><br>
<p>  Django    ,        ,     ,       ,    .</p><br>
<p> ,     ,      DEP  ,     .  DEP     HTTP-middleware-view flow   ORM.</p><br>
<p>   .   Django 2.2     Django (  3.0  3.1)  .</p><br>
<p>     ,        master-,               .</p><br>
<p>     .    ,    .     ,     .</p><br>
<h2 id="specifikaciya"></h2><br>
<p>    ,     Django,     â€”     CPU-bound  â€”   (   event loop  ).</p><br>
<p>     :</p><br>
<ul>
<li>  (Middleware)</li>
<li> (Views)</li>
<li>ORM</li>
<li></li>
<li></li>
<li></li>
<li> </li>
<li>Email</li>
</ul><br>
<p>     ,  ,       ,   CPU-bound ,      ,  ,       management command.</p><br>
<p>  ,    ,     ,      API ( 2.2)    â€”       ,    ,   API   .</p><br>
<p> ,    ,  ,         .        Django,       ,       .</p><br>
<p>    , Â« Â»,  ,           ,            .</p><br>
<h3 id="tehnicheskiy-obzor"> </h3><br>
<p>,         , â€”       .</p><br>
<p>      :</p><br>
<ul>
<li>  (  )</li>
<li>    </li>
<li>    </li>
</ul><br>
<h4 id="asinhronnaya-obyortka"> </h4><br>
<p>        ,       .          ,        .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">asgiref</a>    <code>sync_to_async</code>,        threadlocals (   ).</p><br>
<p>           â€”   , ,     ,       , â€”       -      .</p><br>
<p> ,    Django,      <em> </em>    ; ,    .      <code>atomic()</code> - ,      ORM   ,   ,     ,        ,     .</p><br>
<p>    Â« Â» ("sticky thread"),                     ,    ORM      .   Django, ,   ,   ,     ORM,    <code>sync_to_async</code>,   ,      .          â€”  . Â«ORMÂ» .</p><br>
<h4 id="asinhronnaya-realizaciya"> </h4><br>
<p>  â€”             ,       event loop.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">asgiref</a>    <code>async_to_sync</code>.</p><br>
<p>          .        ,           ,     Python  ,        ;   .</p><br>
<p>        Django,    ,    ,   Python     ,    .      ,  Django   API   ,    core- Python,       Python.</p><br>
<h3 id="threadlocals">Threadlocals</h3><br>
<p>     Django,         , â€”  threadlocals.    , threadlocals    ,   Django   <code>HttpRequest</code>   threadlocal,       â€” ,       .</p><br>
<p> threadlocals      :</p><br>
<ul>
<li>Â«Context localsÂ»,       stack-based ,   .      .</li>
<li>Â«True threadlocalsÂ»,            .       .</li>
</ul><br>
<p>    ,  Â«context localsÂ»        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">contextvars</a>  Python,  Django 3.0     Python 3.6,         3.7.  , <code>contextvars</code>      ,   , ,   ,         ,    <code>sync_to_async</code>  <code>async_to_sync</code>     .  Django    3.7  ,       <code>contextvars</code>,        Django.</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">asgiref</a> <code>Local</code>,      .     <code>contextvars</code>,           3.6   .</p><br>
<p>Â«True threadlocalsÂ»,   ,       .   ,     ,        ;           ,       ORM (   Â« ,  Â»),  ,      ,    .</p><br>
<p>            ; ,    ,     .</p><br>
<h3 id="odnovremennaya-podderzhka-sinhronnogo-i-asinhronnogo-interfeysov">     </h3><br>
<p>   ,        Django,   ,  Python              .</p><br>
<p> ,         API,     :</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#  </span>
value = cache.get(<span class="hljs-string">"foo"</span>)
<span class="hljs-comment">#  </span>
value = <span class="hljs-keyword">await</span> cache.get(<span class="hljs-string">"bar"</span>)</code></pre><br>
<p>    ,     Python,      .  - ,   ,    await'  ,    ,    .</p><br>
<p>(:    ,  Python     Â« callable   Â»,    -  Â«  <code>__acall__</code>  Â».         ,        <code>__aiter__</code>  <code>__aenter__</code>.)</p><br>
<p>               ,    .          <code>sync=True</code>,       /     <code>async def</code>,        .    ,      , .</p><br>
<p>        Django          â€” , <code>cache.get_async</code>     <code>cache.get</code>.    ,          (   <code>await</code>  <code>_async</code>-).</p><br>
<h3 id="predstavleniya-i-obrabotka-http">   HTTP</h3><br>
<p> (views), ,     ,   ,           .</p><br>
<p>Django     :</p><br>
<ul>
<li> , ,   ,       <code>__call__</code></li>
<li> ,    ( )     <code>__call__</code>.</li>
</ul><br>
<p>   <code>BaseHandler</code>,    ,   URL resolver,     .       Django,   ,       WSGI,        event loop,  <code>async_to_sync</code>.</p><br>
<p>  (middleware)    <code>ATOMIC_REQUESTS</code>,      -  (,  <code>atomic()</code>),  ,       (,    ORM    <code>atomic()</code>).</p><br>
<p>  <code>StreamingHttpResponse</code>  ,      ,   ,        .    <code>FileResponse</code>.         ,      Response,        <code>__iter__</code>   .</p><br>
<p>WSGI -   Django    ,   WSGI     middleware       event loop. , ,     ,          .</p><br>
<p>   HTTP    WSGI,  long-polling   ,      ,   ,   /   .  ASGI  ,       ,    -HTTP ,   WebSocket,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Channels</a>.</p><br>
<h3 id="promezhutochnye-sloi"> </h3><br>
<p>           request/response,  middleware    - ,     .</p><br>
<p>Django middleware     ,    middleware  <code>get_response</code>      middleware (     middleware  ).         middleware   ,           .</p><br>
<p> ,    middleware,       middleware  get_response,               middleware  ,    .           middleware  Django 1.0    , , ,  API  .</p><br>
<p>    middleware ,         .          ,       middleware     ,  .</p><br>
<h3 id="orm">ORM</h3><br>
<p>ORM â€”    Django          .</p><br>
<p>     ,          by design,       , ,    .      ,        ,     ,         .</p><br>
<p>  ORM      â€”    .</p><br>
<h4 id="potoki"></h4><br>
<p>   ORM  ,  Django      <code>connections</code>,          .</p><br>
<p>   â€”           â€”    ,    .  -   ,   ORM  ,         .</p><br>
<p> ,       ,         . Django    thread-safety       ORM,             .</p><br>
<p>   <code>connections</code> ,     ,    â€”      <code>asgiref.local</code>,     .         ,     â€”     <code>sync_to_async</code>  <code>async_to_sync</code> â€”          Â« Â» ("sticky thread"),           thread-safety.</p><br>
<p> ,               ,  <code>atomic()</code>.        sticky threads         ,      .           <code>connections</code>,      .</p><br>
<p>   Django      ,       ,            Â« Â».    ,   ,       /;        ,     management-    <code>close_old_connections</code>   .</p><br>
<p>  ,        <code>connections</code>       ,        ;  ,      Â« Â»,   ,   .</p><br>
<p> ,         <code>transaction.atomic()</code>   <code>transaction.autocommit()</code>           ,         ,  ,       .</p><br>
<p>        <code>db.new_connections()</code>,    ,        ,   ,     <code>atomic()</code>  .</p><br>
<p>      <code>new_connections()</code> Django         .  ,     , ;   ORM                  .       ,      ,  ,         ,  -     .</p><br>
<p> ,     <code>new_connections</code>    <code>atomic()</code>        .       ,   ,   <code>new_connections</code>,    Â«Â»      ORM   ,       <code>new_connections</code>.</p><br>
<p>,   API  :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_authors</span>(<span class="hljs-params">pattern</span>):</span>
    <span class="hljs-comment"># Create a new context to call concurrently</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.new_connections():
        <span class="hljs-keyword">return</span> [<font></font>
            author.name<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> author <span class="hljs-keyword">in</span> Authors.objects.filter(name__icontains=pattern)<font></font>
        ]<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_books</span>(<span class="hljs-params">pattern</span>):</span>
    <span class="hljs-comment"># Create a new context to call concurrently</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.new_connections():
        <span class="hljs-keyword">return</span> [<font></font>
            book.title<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> Book.objects.filter(name__icontains=pattern)<font></font>
        ]<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_view</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-comment"># Query authors and books concurrently</span>
    task_authors = asyncio.create_task(get_authors(<span class="hljs-string">"an"</span>))<font></font>
    task_books = asyncio.create_task(get_books(<span class="hljs-string">"di"</span>))
    <span class="hljs-keyword">return</span> render(<font></font>
        request,<font></font>
        <span class="hljs-string">"template.html"</span>,<font></font>
        {<font></font>
            <span class="hljs-string">"books"</span>: <span class="hljs-keyword">await</span> task_books,
            <span class="hljs-string">"authors"</span>: <span class="hljs-keyword">await</span> task_authors,<font></font>
        },<font></font>
    )</code></pre><br>
<p>  ,      ,    ,     (     <code>asyncio.ensure_future</code>  Python 3.6  <code>asyncio.create_task</code>  3.7).</p><br>
<p>      Â« Â»       ,      ,       ;  ,             ,  <code>yield</code>,      .</p><br>
<h4 id="neyavnye-blokirovki"> </h4><br>
<p>    ORM  ,       (  ) ,     .</p><br>
<p>         <code>model_instance.related_field</code>, Django         .       â€”        ,       .</p><br>
<p> ,  Django      â€” <code>select_related</code>,     ,  <code>prefetch_related</code>   Â«  Â».    ORM ,      ,      ,     , ,      .</p><br>
<p>   ,     ,   N    <code>for</code>,         Django.    ,  ,   Django   â€”  -    ,    (     ,        ).</p><br>
<p><code>QuerySet</code>,  ,          ,  :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">view</span>(<span class="hljs-params">request</span>):</span><font></font>
    data = []<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> User.objects.all():<font></font>
        data.append(<span class="hljs-keyword">await</span> extract_important_info(user))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> render(<span class="hljs-string">"template.html"</span>, data)</code></pre><br>
<h4 id="drugoe"></h4><br>
<p> ORM,    ,   ;      management-.       ,         .</p><br>
<h3 id="shablony"></h3><br>
<p>   ,     ,       .     ,      ,     DEP.</p><br>
<p> ,  Jinja2   ,              .</p><br>
<p> ,         Django     ,       .  Jinja2       ,    ,        ,    .</p><br>
<p>      ,     <code>render_async</code>,   <code>render</code>;      ,   ,        .</p><br>
<h3 id="keshirovanie"></h3><br>
<p>   Django      â€”     <code>_async</code>-  (, <code>get_async</code>, <code>set_async</code>).</p><br>
<p>  ,       API  <code>sync_to_async</code>,    <code>BaseCache</code>.</p><br>
<p>,     thread-safety   API ,   Django,        ,       .    ,     ORM, ,      .</p><br>
<h3 id="formy"></h3><br>
<p>        ,        ,    ,     <code>ModelForm</code>  ORM     .</p><br>
<p> ,   -   <code>clean</code>  <code>save</code>,  ,   . ,      ,  ,                         DEP.</p><br>
<h3 id="email">Email</h3><br>
<p>        Django,      .    <code>send_mail_async</code>  <code>send_mail</code>,   <code>async</code>-        (, <code>mail_admins</code>).</p><br>
<p>        Django  ,    -  SMTP,     .  , ,      ,      ,   .</p><br>
<h3 id="testirovanie"></h3><br>
<p>    ,      Django  .</p><br>
<p>    ASGI-     <code>asgiref.testing.ApplicationCommunicator</code>.             assert'  .</p><br>
<p>   Django        ,    ,      .  ,      â€”     ,    ,        HTTP    event loop,    WSGI.</p><br>
<p>               .  ,      ,      .</p><br>
<p>  ,     ,      .       <code>async def</code>    <code>@async_to_sync</code>,       , ,    Django test runner.</p><br>
<p>       asyncio (   loop'  ,    )   , , ,   <code>DEBUG=True</code>.          â€”   ,       ,       .</p><br>
<h3 id="websockets">WebSockets</h3><br>
<p>      Django;      ,   Channels   ,        ASGI,      .</p><br>
<p>   ,         Channels,        ,     ASGI.</p><br>
<h3 id="poryadok-deystviy"> </h3><br>
<p>     ,     ,   .       ,          .</p><br>
<p>  ,                .         ,       â€”         .</p><br>
<p> ,      ,              .    ,   ORM,       ,  ,          .</p><br>
<p>  :</p><br>
<ul>
<li><p>  (  3.0)</p><br>
<ul>
<li> HTTP,     (    )</li>
<li> async       ORM</li>
<li>  </li>
</ul><br>
</li>
<li><p>  (  3.1)</p><br>
<ul>
<li>ORM (     )</li>
<li> (     )</li>
<li> (     )</li>
</ul><br>
</li>
<li><p>  </p><br>
<ul>
<li>ORM (       )</li>
<li> (    )</li>
<li>Email</li>
<li></li>
</ul><br>
</li>
</ul><br>
<p>         ;      ,    .     ,   ,       , ,            .</p><br>
<p>  ,      -   ;            ,     ,        .    ,      ,  Django,     Django  async-only .</p><br>
<p>   ,  ,    DEP  ,   , , email  .         DBAPI â€”  ,        core Python , , PEP,         .</p><br>
<h2 id="motivaciya"></h2><br>
<p>    ,  , ,    .   Django      ,   -       ,    -;             .</p><br>
<p>         ,      - .         ,   â€”  ,       ,       .</p><br>
<p>         Python â€”   . -  Python       ,     ,       .</p><br>
<p> Python            <code>asyncio</code>,       ,         .     ,     ,     ,  ,      Django-size   .</p><br>
<h3 id="chto-eto-dayot">  </h3><br>
<p>      Django,     Â«Â»;    ,    ,      â€” ,      Django â€”     .</p><br>
<p>    ,       .      ,    API     ,   Django      -   .</p><br>
<p>     ,      ,  Django     .             ,    Django ORM ,     ,    ,      -.</p><br>
<p> ,   , â€”             .    -   long-poll   server-sent events.  Django          ,    -      .</p><br>
<h3 id="sinhronnost-vsyo-eschyo-imeet-znachenie">    </h3><br>
<p>    <em></em>    Django;         .   ,  ,             ,          .</p><br>
<p>Django          ,    .    ;  Django-   ,         ,  ,     ,     ,     .</p><br>
<p>     ,       --  Django      .</p><br>
<h3 id="obratnaya-sovmestimost"> </h3><br>
<p> ,    .      Â« DjangoÂ»,       ;     ,        ,          .</p><br>
<p> ,      ,     ,        ,    API Django,      ,      ,    Python 3,        API,        Django  Python.</p><br>
<h3 id="pomosch-python"> Python</h3><br>
<p>Python     .           Python,  ,    ,     .</p><br>
<p>  , Django â€”   - Python   â€”   ,    Python,        Python   .      ,       ,    ,        .</p><br>
<h3 id="privlechenie-novyh-uchastnikov">  </h3><br>
<p>     ,   Django,              .   ,  Django   ,       .</p><br>
<p>                  â€”  ,  ,    ,   ,        .</p><br>
<p> ,      â€”      ,   , â€”               Django (     ,       Python  ).</p><br>
<h3 id="chto-takoe-django">  Django?</h3><br>
<p>     ,   Django.   ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Lawrence Journal-World</a>    â€”    ,  , SPA â€”  , ,    .  , ,   ,     ,     .</p><br>
<p>   ,   Django   ,   - ,    â€”        â€”     . , ,        ; ,     Django    , .</p><br>
<p>  ,     Django     .     ,       .    ,         ,    ,    â€” ,        ,   .</p><br>
<h2 id="obosnovanie"></h2><br>
<p>   Django       django-developers   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>    ,        ,  ,   ,   DEP.</p><br>
<p>     , ,   ,      :</p><br>
<ul>
<li>:       master-        Django    .</li>
<li> :     Django    ,    ,    ,     ,      Django       .</li>
<li>:    ,    ,      Django,   ,  Django.     ,   ,   ,      ,  .</li>
</ul><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Channels</a>          DEP ;        Django      ,  .</p><br>
<p>  ,   ,     .  DEP    ,   ,       â€”      Django           .</p><br>
<p>                .     Django, ,     ,    WSGI    ,    event loop     ,      .         10%   â€”     ,      .     ,      .</p><br>
<p>    ,  ,      (-  ,   Python    ).    ,     Django      ;     ,   ,     ,   Django   master-    .</p><br>
<p> ,           ( ORM,    ..),      ;                 Python.</p><br>
<p>       ,      ,        Django,     Â«Â»  .   ,      ,              ,  ,     .</p><br>
<h3 id="alternativy"></h3><br>
<p>      ,   ,  , .</p><br>
<h4 id="asinhronnye-moduli-vmesto-_async-funkciy">   _async </h4><br>
<p>       ,    ,     (, <code>django.core.cache.cache.get_async</code>),               :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> django.core.cache_async <span class="hljs-keyword">import</span> cache<font></font>
cache.get(<span class="hljs-string">"foo"</span>)</code></pre><br>
<p>  ,           ;   ,    ,        .</p><br>
<p>  ,    ,      ;       .</p><br>
<h4 id="fork-django"> Django</h4><br>
<p>-   ,      ;  ,        ,       ,       â€”  .</p><br>
<p>          ,   ,     , â€”   ,      .</p><br>
<h4 id="rasshirenie-channels"> Channels</h4><br>
<p>   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Channels</a>      , Â«Â»  Django. ,     -     ,  ,         Django;      ORM,   HTTP/middleware flow    .</p><br>
<h4 id="ne-asyncio"> asyncio</h4><br>
<p>     event loop'  Python,   <code>asyncio</code>          ,   Django.   <code>await</code>  <code>async</code>  Python     event loop   .</p><br>
<p>  ,   <code>asyncio</code>,     ; Django     ,        ,   .         Django        ;    , ,      async runtime,    ,    .</p><br>
<h4 id="greenletsgevent">Greenlets/Gevent</h4><br>
<p>      Gevent,      ,      Python.</p><br>
<p>       ,       .   <code>yield</code>  <code>await</code> ,   API,    Django,       ,         .               ,     .</p><br>
<p>  ,      ,  ,     .      greenlet-safe   Django ORM   -   new-connection-context,  .</p><br>
<p> ,      .   Django     Â« Â»    gevent, , ,      ,   .</p><br>
<h2 id="finansirovanie"></h2><br>
<p>            DEP.</p><br>
<p>  ,        â€”        , â€”     ,             (   ).</p><br>
<p> ,       ,  -           .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Django Fellows</a>  ;     â€”   ,           (  ), ,   ,  - .</p><br>
<p>      â€” ,   Kickstarter  <code>migrations</code>  <code>contrib.postgres</code>,    MOSS (Mozilla)  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Channels</a>.   ,   Django,  ,          .</p><br>
<p>    , <em></em>     .  â€”      Python,    Django â€”    â€”       .        ,     Django/async,        .</p><br>
<p>               HTTP/middleware/view flow,     ,  ,  ,      Â« Â»,      .</p><br>
<p>    ,     ,     ,            (   ,  Fellows, /     ,     Channels,       ,   ),   ,       .</p><br>
<p>        ,         ,   ,        ,       Django,      .</p><br>
<h2 id="obratnaya-sovmestimost-1"> </h2><br>
<p>, ,   ,       ,            API.</p><br>
<p>  , ,        ,  , HTTP/middleware flow. ,    API,       APM,     .</p><br>
<p> ,  ,   Django     ,     ,      .  ,   ORM  , ,   â€”      ,  ORM             .</p><br>
<h2 id="etalonnaya-realizaciya"> </h2><br>
<p> DEP  ,    ;       Django      .</p><br>
<p>  ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">asgiref</a>,       ,         .      Django         Django.</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Channels</a>,         Django,          Django.</p><br>
<h2 id="avtorskie-prava"> </h2><br>
<p>  <em>(  )</em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">CC0 1.0 Universal</a>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461469/index.html">1000ãƒ¯ãƒ¼ãƒ‰/åˆ†ã§ã‚³ãƒ¼ãƒ‰ã‚’èãã®ã¯ã©ã†ã§ã™ã‹</a></li>
<li><a href="../ja461473/index.html">ã‚°ãƒ©ãƒ•ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ‡ãƒãƒƒã‚°-å†™çœŸä»˜ã</a></li>
<li><a href="../ja461475/index.html">Habrã€‚1011ã«ã‚ˆã‚‹AMA</a></li>
<li><a href="../ja461483/index.html">Openstackã®è² è·åˆ†æ•£</a></li>
<li><a href="../ja461487/index.html">ãƒŸãƒ‹CTFãƒ†ã‚¹ãƒˆ</a></li>
<li><a href="../ja461497/index.html">Linuxã§ã®æœ€æ–°ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šãƒ‘ãƒ¼ãƒˆ1</a></li>
<li><a href="../ja461499/index.html">2019å¹´ã«ã‚²ãƒ¼ãƒ ã‚’ç¿»è¨³ã™ã‚‹è¨€èª</a></li>
<li><a href="../ja461501/index.html">ãªãœç±³å›½ã§å¤§è¦æ¨¡ãªITä¼æ¥­ã®ä»•äº‹ã‚’èª¿æŸ»ã—ã¦ã„ã‚‹ã®ã‹</a></li>
<li><a href="../ja461503/index.html">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹</a></li>
<li><a href="../ja461505/index.html">ã‚ãªãŸãŒãƒ—ãƒ­ã«ãªã‚‹ã®ã‚’å¦¨ã’ã‚‹åˆå¿ƒè€…JavaScripté–‹ç™ºè€…ã®8ã¤ã®ãƒã‚°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>