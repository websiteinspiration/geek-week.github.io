<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õÖÔ∏è üëõ üèè Falta la historia de soporte de DNS Cloud de Google Cloud üë† üö• ü§¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De un editor de blogs de Google: ¬øAlguna vez se pregunt√≥ c√≥mo los ingenieros de Google Cloud Technical Solutions (TSE) manejan sus llamadas de soporte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Falta la historia de soporte de DNS Cloud de Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De un editor de blogs de Google:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øAlguna vez se pregunt√≥ c√≥mo los ingenieros de Google Cloud Technical Solutions (TSE) manejan sus llamadas de soporte t√©cnico? La responsabilidad de los ingenieros de soporte t√©cnico de TSE es detectar y resolver las fuentes de problemas identificados por los usuarios. Algunos de estos problemas son bastante simples, pero a veces te encuentras con una apelaci√≥n que requiere la atenci√≥n de varios ingenieros a la vez. En este art√≠culo, uno de los empleados de TSE nos contar√° sobre un problema muy complicado de su pr√°ctica reciente: el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caso de paquetes DNS perdidos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En el curso de esta historia, veremos c√≥mo los ingenieros lograron resolver la situaci√≥n y qu√© cosas nuevas aprendieron al eliminar el error. Esperamos que esta historia no solo le cuente sobre un error profundamente enraizado, sino que tambi√©n le brinde una comprensi√≥n de los procesos que ocurren al enviar una solicitud para admitir Google Cloud.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
La resoluci√≥n de problemas es tanto una ciencia como un arte. Todo comienza con la construcci√≥n de una hip√≥tesis sobre la causa del comportamiento no est√°ndar del sistema, despu√©s de lo cual se prueba su resistencia. Sin embargo, antes de formular una hip√≥tesis, debemos identificar claramente y formular con precisi√≥n el problema. Si la pregunta suena demasiado vaga, entonces debe analizar todo correctamente; Este es el "arte" de la soluci√≥n de problemas.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el contexto de Google Cloud, estos procesos son complicados a veces, ya que Google Cloud est√° luchando por garantizar la privacidad de sus usuarios. </font><font style="vertical-align: inherit;">Debido a esto, los ingenieros de TSE no tienen acceso para editar sus sistemas, ni la capacidad de ver configuraciones tan ampliamente como los usuarios. </font><font style="vertical-align: inherit;">Por lo tanto, para probar cualquiera de nuestras hip√≥tesis, nosotros (ingenieros) no podemos modificar r√°pidamente el sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunos usuarios creen que arreglaremos todo como si la mec√°nica en el servicio del autom√≥vil, y simplemente nos env√≠an la identificaci√≥n de la m√°quina virtual, mientras que en realidad el proceso contin√∫a en el formato de una conversaci√≥n: recolectando informaci√≥n, generando y confirmando (o refutando) hip√≥tesis y, en √∫ltima instancia, resolviendo Los problemas se basan en la comunicaci√≥n con el cliente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tema bajo consideraci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy tenemos una historia con un buen final. </font><font style="vertical-align: inherit;">Una de las razones para la soluci√≥n exitosa del caso propuesto es una descripci√≥n muy detallada y precisa del problema. </font><font style="vertical-align: inherit;">A continuaci√≥n puede ver una copia del primer ticket (editado, para ocultar informaci√≥n confidencial): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este mensaje tiene mucha informaci√≥n √∫til para nosotros:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VM especificada</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se indica el problema: DNS no funciona</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se indica d√≥nde se manifiesta el problema: VM y contenedor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se indican los pasos que el usuario tom√≥ para identificar el problema.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La apelaci√≥n se registr√≥ como ‚ÄúP1: Impacto cr√≠tico: servicio inutilizable en producci√≥n‚Äù, lo que significa un monitoreo constante de la situaci√≥n las 24 horas del d√≠a, los 7 d√≠as de la semana, de acuerdo con el esquema ‚ÄúFollow the Sun‚Äù (el enlace se puede leer con m√°s detalle sobre las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prioridades de las llamadas de los usuarios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), con la transferencia de un equipo de soporte t√©cnico al otro en cada cambio de zona horaria. </font><font style="vertical-align: inherit;">De hecho, cuando el problema lleg√≥ a nuestro equipo en Z√∫rich, ella logr√≥ circunnavegar el mundo. </font><font style="vertical-align: inherit;">En este momento, el usuario tom√≥ medidas para reducir las consecuencias, sin embargo, tem√≠a que se repitiera la situaci√≥n en la producci√≥n, ya que a√∫n no se encontraba la raz√≥n principal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cuando el boleto lleg√≥ a Zurich, ya ten√≠amos la siguiente informaci√≥n a mano:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenido </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenido </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archivo pcap </font><font style="vertical-align: inherit;">compilado por el comando</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con estos datos, est√°bamos listos para comenzar la fase de "investigaci√≥n" y resoluci√≥n de problemas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestros primeros pasos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, verificamos los registros y el estado del servidor de metadatos y nos aseguramos de que funcione correctamente. </font><font style="vertical-align: inherit;">El servidor de metadatos responde con la direcci√≥n IP 169.254.169.254 y, entre otras cosas, es responsable de controlar los nombres de dominio. </font><font style="vertical-align: inherit;">Tambi√©n verificamos dos veces que el firewall funciona correctamente con VM y no bloquea los paquetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este fue un problema extra√±o: la prueba nmap refut√≥ nuestra hip√≥tesis principal sobre la p√©rdida de paquetes UDP, por lo que dedujimos mentalmente varias opciones y m√©todos m√°s para verificarlos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øLos paquetes desaparecen selectivamente? </font><font style="vertical-align: inherit;">=&gt; Verifique las reglas de iptables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øEl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU es</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> demasiado peque√±o </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Verificar salida</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øEl problema afecta solo a los paquetes UDP o TCP? </font><font style="vertical-align: inherit;">=&gt; Conducir</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øSe devuelven los paquetes de excavaci√≥n generados? </font><font style="vertical-align: inherit;">=&gt; Conducir</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øLibdns funciona correctamente? </font><font style="vertical-align: inherit;">=&gt; Conduzca </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para verificar la transferencia de paquetes en ambas direcciones</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ decidimos llamar al usuario para solucionar problemas en vivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante la llamada, logramos verificar varias cosas:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de varias verificaciones, excluimos las reglas de iptables de la lista de razones.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificamos las interfaces de red y las tablas de enrutamiento, y verificamos dos veces la MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encontramos que </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) funciona como deber√≠a, pero </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) no funciona</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habiendo </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corrido mientras funciona </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, encontramos que los paquetes UDP est√°n siendo devueltos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corremos </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y vemos c√≥mo excavar correctamente las llamadas </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sin embargo, el segundo se ve interrumpido por el tiempo de espera</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, el cambio est√° por terminar y nos vemos obligados a transferir el problema a la siguiente zona horaria. Sin embargo, la apelaci√≥n despert√≥ inter√©s en nuestro equipo, y un colega sugiere crear el paquete DNS de origen con el m√≥dulo de Python scrapy.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este fragmento crea un paquete DNS y env√≠a la solicitud al servidor de metadatos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El usuario ejecuta el c√≥digo, se devuelve la respuesta DNS y la aplicaci√≥n lo recibe, lo que confirma la ausencia de un problema a nivel de red. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s del pr√≥ximo "viaje alrededor del mundo", la apelaci√≥n regresa a nuestro equipo, y la traduzco completamente a m√≠ mismo, creyendo que ser√° m√°s conveniente para el usuario si la apelaci√≥n deja de circular de un lugar a otro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mientras tanto, el usuario acepta amablemente proporcionar una instant√°nea de la imagen del sistema. Esta es una muy buena noticia: la capacidad de probar el sistema usted mismo acelera significativamente la resoluci√≥n de problemas, porque ya no necesita pedirle al usuario que ejecute comandos, me env√≠e resultados y los analice, ¬°puedo hacer todo por m√≠ mismo!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los colegas comienzan a envidiarme un poco. </font><font style="vertical-align: inherit;">Durante el almuerzo, discutimos la apelaci√≥n, pero nadie tiene idea de lo que est√° sucediendo. </font><font style="vertical-align: inherit;">Afortunadamente, el propio usuario ya ha tomado medidas de mitigaci√≥n y no tiene prisa, por lo que tenemos tiempo para preparar el problema. </font><font style="vertical-align: inherit;">Y como tenemos una imagen, podemos realizar cualquier prueba que nos interese. </font><font style="vertical-align: inherit;">¬°Multa!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retrocediendo un paso</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las preguntas de entrevista m√°s populares para un ingeniero de sistemas es: "¬øQu√© sucede cuando haces ping a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.google.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">La pregunta es elegante, porque el candidato debe describirse desde el shell al espacio del usuario, al n√∫cleo del sistema y m√°s all√° de la red. </font><font style="vertical-align: inherit;">Sonr√≠o: a veces las preguntas de la entrevista tambi√©n son √∫tiles en la vida real ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decido aplicar esta pregunta de eychar al problema actual. </font><font style="vertical-align: inherit;">En t√©rminos generales, cuando intenta determinar el nombre DNS, sucede lo siguiente:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La aplicaci√≥n llama a la biblioteca del sistema, por ejemplo libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns verifica la configuraci√≥n del sistema que servidor DNS debe usar (en el diagrama es 169.254.169.254, servidor de metadatos)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns usa llamadas del sistema para crear un socket UDP (SOKET_DGRAM) y enviar paquetes UDP con una solicitud DNS en ambas direcciones</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando la interfaz sysctl, puede configurar la pila UDP a nivel de n√∫cleo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El n√∫cleo interact√∫a con el hardware para transmitir paquetes a trav√©s de la red a trav√©s de una interfaz de red.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El hipervisor captura y pasa el paquete al servidor de metadatos cuando entra en contacto con √©l.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servidor de metadatos determina el nombre DNS por su brujer√≠a y devuelve la respuesta de la misma manera.</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perm√≠tame recordarle qu√© hip√≥tesis ya hemos logrado considerar: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tesis: bibliotecas rotas</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 1: ejecute strace en el sistema, verifique que la excavaci√≥n provoque las llamadas correctas al sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: se llaman las llamadas correctas al sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 2: a trav√©s de la terapia para verificar si podemos determinar los nombres sin pasar por las bibliotecas del sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: podemos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 3: ejecute rpm ‚ÄìV en el paquete libdns y los archivos de la biblioteca md5sum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: el c√≥digo de la biblioteca es completamente id√©ntico al c√≥digo del sistema operativo en funcionamiento</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 4: monte la imagen del sistema ra√≠z del usuario en la VM sin este comportamiento, ejecute chroot, vea si DNS funciona</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: DNS funciona correctamente</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n basada en pruebas: el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema no est√° en las bibliotecas </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tesis: hay un error en la configuraci√≥n de DNS</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 1: verifique tcpdump y vea si los paquetes DNS se env√≠an y devuelven correctamente despu√©s de ejecutar dig</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: los paquetes se transmiten correctamente</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 2: vuelva a verificar en el servidor </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: todo es correcto</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre la base de la conclusi√≥n de la prueba:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el problema no es la </font><b><font style="vertical-align: inherit;">hip√≥tesis de</font></b><font style="vertical-align: inherit;"> configuraci√≥n de DNS </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: el n√∫cleo est√° da√±ado</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba: instale un nuevo n√∫cleo, verifique la firma, reinicie</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: comportamiento similar</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n basada en pruebas: el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√∫cleo no est√° da√±ado </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tesis: comportamiento incorrecto de la red del usuario (o la interfaz de red del hipervisor)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 1: verifique la configuraci√≥n del firewall</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: el cortafuegos pasa paquetes DNS tanto en el host como en GCP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 2: intercepte el tr√°fico y realice un seguimiento de la correcci√≥n de la transferencia y la devoluci√≥n de consultas DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: tcpdump acusa recibo de los paquetes devueltos por el host</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n basada en pruebas: el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema no est√° en la red </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tesis: el servidor de metadatos no funciona</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 1: verifique los registros del servidor de metadatos en busca de anomal√≠as</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: no hay anomal√≠as en los registros</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba 2: omita el servidor de metadatos a trav√©s de </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: se viola el permiso incluso sin usar un servidor de metadatos</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n basada en pruebas: el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema no est√° en el servidor de metadatos. En pocas </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">palabras:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬°probamos todos los subsistemas excepto la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuraci√≥n de tiempo de ejecuci√≥n!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zambullirse en la configuraci√≥n del tiempo de ejecuci√≥n del kernel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para configurar el tiempo de ejecuci√≥n del kernel, puede usar las opciones de l√≠nea de comandos (grub) o la interfaz sysctl. </font><font style="vertical-align: inherit;">Mir√© </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y pens√© solo, encontr√© algunas configuraciones personalizadas. </font><font style="vertical-align: inherit;">Sintiendo como si me hubiera agarrado a algo, descart√© todas las configuraciones que no son de red o que no son TCP, quedando de la configuraci√≥n de la monta√±a </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Luego me dirig√≠ al lugar donde la VM tiene permisos de host y comenc√© a aplicar una tras otra, una tras otra con una VM rota, hasta que llegu√© al criminal:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Aqu√≠ est√°, una configuraci√≥n de ruptura de DNS! Encontr√© un instrumento de crimen. Pero ¬øpor qu√© sucede esto? Todav√≠a necesitaba un motivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuraci√≥n del tama√±o base del b√∫fer de paquetes DNS se realiza a trav√©s de </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Un valor t√≠pico var√≠a en alg√∫n lugar dentro de 200 KB, sin embargo, si su servidor recibe muchos paquetes DNS, puede aumentar el tama√±o del b√∫fer. Si el b√∫fer est√° lleno en el momento en que llega un nuevo paquete, por ejemplo, debido a que la aplicaci√≥n no lo procesa lo suficientemente r√°pido, entonces comenzar√° a perder paquetes. Nuestro cliente aument√≥ correctamente el tama√±o del b√∫fer porque tem√≠a la p√©rdida de datos, porque utiliz√≥ la aplicaci√≥n para recopilar m√©tricas a trav√©s de paquetes DNS. El valor que estableci√≥ fue el m√°ximo posible: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (si establece 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el n√∫cleo devolver√° ‚ÄúARGUMENTO NO V√ÅLIDO‚Äù).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De repente, me di cuenta de por qu√© nmap y scapy funcionaban correctamente: ¬°usaban sockets sin procesar! Los sockets sin procesar son diferentes de los sockets normales: funcionan sin pasar por iptables, ¬°y no est√°n almacenados en b√∫fer! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øpor qu√© "un b√∫fer demasiado grande" est√° causando problemas? Obviamente no funciona seg√∫n lo previsto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, podr√≠a reproducir el problema en m√∫ltiples n√∫cleos y m√∫ltiples distribuciones. El problema ya se manifest√≥ en el n√∫cleo 3.x y ahora tambi√©n se manifest√≥ en el n√∫cleo 5.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, al inicio</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS ha dejado de funcionar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenc√© a buscar valores de trabajo a trav√©s de un algoritmo de b√∫squeda binaria simple y descubr√≠ que el sistema funciona con 2147481343, sin embargo, este n√∫mero era un conjunto de n√∫meros sin sentido para m√≠. Invit√© al cliente a probar este n√∫mero, y √©l respondi√≥ que el sistema funcionaba con google.com, pero a√∫n as√≠ dio un error con otros dominios, as√≠ que continu√© mi investigaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , una herramienta que deber√≠a haberse usado antes: muestra exactamente d√≥nde llega el paquete en el n√∫cleo. La funci√≥n era culpable </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Descargu√© las fuentes del kernel y agregu√© varias </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciones</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para rastrear d√≥nde se encuentra espec√≠ficamente el paquete. Encontr√© r√°pidamente la condici√≥n correcta</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y por un momento simplemente lo mir√≥ fijamente, porque fue entonces cuando todo finalmente se uni√≥ en una imagen completa: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, un n√∫mero sin sentido, un dominio inactivo ... Era un c√≥digo en </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tiene tipo int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es del tipo u16 (int. de 16 bits sin signo) y almacena el tama√±o del paquete</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es de tipo int y almacena el tama√±o del b√∫fer, que por definici√≥n es igual al valor en </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acercarse a 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la suma del tama√±o del paquete puede conducir a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un desbordamiento de enteros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y dado que es un int, su valor se vuelve negativo, por lo que la condici√≥n se vuelve verdadera cuando deber√≠a ser falsa (se puede encontrar m√°s sobre esto por </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referencia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El error se corrige de manera trivial: enviando a </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Apliqu√© el parche y reinici√© el sistema, despu√©s de lo cual el DNS comenz√≥ a funcionar nuevamente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sabor de la victoria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Envi√© mis hallazgos al cliente y envi√© el </font><font style="vertical-align: inherit;">parche del kernel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Estoy satisfecho: cada pieza del rompecabezas se uni√≥ en un solo conjunto, puedo explicar con precisi√≥n por qu√© observamos lo que observamos y, lo m√°s importante, ¬°pudimos encontrar una soluci√≥n al problema trabajando juntos! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena reconocer que el caso result√≥ ser raro y, afortunadamente, rara vez recibimos llamadas tan complejas de parte de los usuarios.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es503096/index.html">¬øPor qu√© los gerentes quieren que los trabajadores reciclen?</a></li>
<li><a href="../es503100/index.html">Jefe de internet</a></li>
<li><a href="../es503106/index.html">Resumen de descubrimiento no est√°ndar: genealog√≠a de plantas depredadoras, hongos en Twitter y gas de risa del guano</a></li>
<li><a href="../es503108/index.html">Ocho colores del arcoiris: sobre el color en t√©rminos matem√°ticos</a></li>
<li><a href="../es503110/index.html">Epidemia digital: CoronaVirus vs CoViper</a></li>
<li><a href="../es503118/index.html">David Yang - sobre no invasividad, crisis y tierra quemada</a></li>
<li><a href="../es503126/index.html">Likbez sobre VPS: c√≥mo configurar el escritorio remoto si es un usuario de Win</a></li>
<li><a href="../es503128/index.html">C√≥mo incrustar ColorPicker en JavaScript Gantt para cambiar el color de las tareas</a></li>
<li><a href="../es503132/index.html">Parquet Apache de alta velocidad en Python con Apache Arrow</a></li>
<li><a href="../es503134/index.html">Gesti√≥n = Equipo + Producto. Revelamos la f√≥rmula de este a√±o: lo m√°s √∫til sobre las personas y para las personas en DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>