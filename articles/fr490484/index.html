<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚐 🤸🏼 👩🏼‍🤝‍👨🏽 Gérer les capteurs de maison intelligente avec l'Assistant Google ⤵️ 👨🏾‍🏫 ♉️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, les collègues de ce guide vous diront comment contrôler les capteurs de maison intelligente à l'aide de Google Assistant et du protocole mqtt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gérer les capteurs de maison intelligente avec l'Assistant Google</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, les collègues de ce guide vous diront comment contrôler les capteurs de maison intelligente à l'aide de Google Assistant et du protocole mqtt, en utilisant la carte ESP8266 et la LED comme exemple. </font><font style="vertical-align: inherit;">Nous allons également créer notre propre application Assistant avec des scripts blackjack et php. </font><font style="vertical-align: inherit;">Je demande du chat à tout le monde.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, nous avons besoin du contrôleur ESP8266, ou d'autres contrôleurs avec une connexion Internet, ainsi que d'un serveur avec un certificat SSL valide (au lieu d'un SSL valide, vous pouvez utiliser un proxy inverse qui en a déjà un) et un serveur MQTT (courtier). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'intégration avec google assistant, nous utiliserons le service Google Actions et Dialogflow. </font><font style="vertical-align: inherit;">Commençons donc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/n4/so/7nn4sojacyuqznn0ngm2_az_tek.jpeg" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création et configuration d'un projet</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Console d'action Google</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord vous connecter au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et créer un projet, sélectionnez une langue et une région. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/8d/8p/3c8d8pr_uuzir7e6jizg3cx-xf4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après vous devez choisir la portée. </font><font style="vertical-align: inherit;">J'ai choisi Kids &amp; Family. </font><font style="vertical-align: inherit;">D'après l'expérience des autres, je dirai que la catégorie logiquement demandée Smart Home ne fonctionne correctement qu'avec les appareils de Google, pour les projets avec ses propres capteurs, il est préférable de choisir une catégorie différente pour un fonctionnement correct. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/jk/-x/qrjk-xl3cvbhcrpdocrfhyfiecm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lisons et acceptons l'accord. </font><font style="vertical-align: inherit;">Dans la catégorie Configuration rapide, accédez à Décider comment votre action est invoquée. </font><font style="vertical-align: inherit;">Nous trouvons comment notre bot sera appelé et sélectionnerons une voix parmi celles disponibles, sauvegardez-la. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w1/oz/ue/w1ozueqhhrzh0y42i1xwfwk8330.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accédez à l'onglet Actions, ajoutez une action d'intention personnalisée</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/sg/n4/ntsgn4ps4curjg5c0ociivilfma.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dialogflow</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir cliqué sur le bouton Build, nous sommes redirigés vers la ressource Dialogflow, nous nous connectons également et procédons à la création du projet:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisissez la langue et le fuseau horaire par défaut.</font></font></li>
<li>   Fulfillment   <abbr title="interface entre deux programmes">Webhook</abbr>.       (     ,  )   Dialogflow   POST .<br>
<br>
<img src="https://habrastorage.org/webt/2e/tu/ij/2etuijbmkox37tup8de8t8sq694.png" alt="image"></li>
<li>3.    .<br>
<br>
 intets         .       .      +   Intents.       .</li>
</ol><br>
<img src="https://habrastorage.org/webt/ay/d4/zy/ayd4zyszkzl59pzklkt8ps34sh4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La page elle-même peut être divisée en trois catégories: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les phrases de formation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont des mots auxquels l'assistant répond avec l'équipe. </font><font style="vertical-align: inherit;">Ils peuvent être différents pour une équipe. </font><font style="vertical-align: inherit;">Par exemple, faites briller les mots, coupez la lumière, allumez la lampe, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/v8/mm/duv8mm1gpmvibh2w6fd0u7x777w.png" alt="image"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Action</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'action elle-même, ou le mot que le capteur comprendra, c'est un et concret. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les réponses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont les réponses de l'assistant après l'exécution de la commande. </font><font style="vertical-align: inherit;">Voici juste un champ de créativité.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/vj/hp/yxvjhpwsqueymkbo-4llo9jfvh8.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration d'hébergement </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant que serveur, j'ai acheté la droplet la moins chère (5 $) et y ai installé Debian 10.2. </font><font style="vertical-align: inherit;">L'hébergement que vous choisissez n'a pas d'importance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurer le proxy inverse et le DNS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez ignorer cette partie si vous avez un hébergement avec un certificat valide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le service Cloudflare lui-même propose de nombreux noms de niveau inférieur, donc si vous rencontrez des problèmes avec l'étape 4, vous devrez peut-être indiquer votre adresse IP au lieu de celle par défaut dans la colonne de contenu à côté de www ***, https // www *** (*** est votre domaine) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour interagir avec Dialogflow, vous avez besoin d'un certificat SSL. </font><font style="vertical-align: inherit;">Je ne l'ai pas installé sur le serveur, j'ai plutôt utilisé le proxy DNS Cloudflare (gratuit - basique). </font><font style="vertical-align: inherit;">Pour ce faire, lors de la configuration de Cloudflare, j'ai ajouté mon nom de domaine acheté précédemment et y ai ajouté l'adresse IP de mon serveur (colonne Contenu). </font><font style="vertical-align: inherit;">Également ajouté deux enregistrements A (dans l'image, il s'agit de Value) dans les paramètres du fournisseur de noms. </font><font style="vertical-align: inherit;">Il convient de noter que l'ajout d'un enregistrement n'est pas une question de secondes et peut prendre jusqu'à plusieurs jours ouvrables.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yp/gz/qz/ypgzqzczh7qgdveopje4to1dtp8.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation du logiciel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Première chose après avoir démarré le serveur pour la première fois, n'oubliez pas de mettre à jour la base de données des packages</font></font><br>
<br>
<pre><code class="bash hljs">apt update</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis mettez à jour les packages installés </font></font><pre><code class="bash hljs">apt upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Après avoir installé LAMP </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache</font></font><br>
<br>
<pre><code class="bash hljs">apt install apache2 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Php / mysql</font></font><br>
<br>
<pre><code class="bash hljs">apt-get install php libapache2-mod-php php-mcrypt php-mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez l'adresse du serveur dans apache2.conf. Cela peut être fait avec la commande nano /etc/apache2/apache2.conf en spécifiant à la fin du fichier ServerName *** à la fin de votre fichier, où au lieu d'astérisques vous devez remplacer l'IP du serveur. Vérifiez la syntaxe et redémarrez le service Apach En savoir plus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir terminé avec succès les étapes décrites ci-dessus lors de la saisie de votre nom de domaine dans la barre du navigateur, vous recevrez la page d'accueil Apache2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/3k/uw/wu3kuwqec_ykskpcqtqttzph6wm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cela ne se produit pas, vérifiez si les commandes ont été exécutées correctement et si la page fonctionne avec une connexion http non sécurisée. Si cela fonctionne, le serveur écoute probablement sur le port 80, pas sur le port 443. Ou un service est déjà en cours d'exécution dessus. Plus de détails </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Installation de la bibliothèque Mosquitto pour PHP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les appareils IoT peuvent utiliser différents protocoles pour l'interopérabilité. </font><font style="vertical-align: inherit;">Un tel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui fonctionne sur une base éditeur-abonné. </font><font style="vertical-align: inherit;">Dans ce cas, les abonnés peuvent recevoir des informations de nombreux éditeurs. </font><font style="vertical-align: inherit;">Mais comme le protocole ne comprend que certains types de messages, il a besoin d'un convertisseur (courtier). </font><font style="vertical-align: inherit;">Ici, nous l'avons installé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Si vous n'avez pas installé PECL, installez-le</font></font><br>
<br>
<pre><code class="bash hljs">apt install pecl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après être devenu courtier </font></font><br>
<br>
<pre><code class="bash hljs">pecl install Mosquitto-alpha</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez ensuite extension = mosquitto.so à votre php.ini. </font><font style="vertical-align: inherit;">Et n'oubliez pas le client</font></font><br>
<br>
<pre><code class="bash hljs">apt install mosquitto mosquitto-clients
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus de détails </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration du script php, abonnement au sujet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le script lui-même. </font><font style="vertical-align: inherit;">Son but est d'accepter une demande de publication de Dialogflow, d'en isoler l'action et de l'envoyer sous forme de message au courtier dans le sujet, dont le nom est indiqué à la fin du script. </font><font style="vertical-align: inherit;">Ce que vous appelez un script n'a pas d'importance. </font><font style="vertical-align: inherit;">Au fait, c'est le script que nous avons indiqué dans l'onglet Exécution. </font><font style="vertical-align: inherit;">Placez le script dans / var / www / html </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les sujets sont créés par les abonnés. Pour créer un sujet, utilisez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_sub -h localhost - t /<span class="hljs-built_in">test</span>/light</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de localhost, vous pouvez spécifier toute autre adresse, ou domaine, où vous souhaitez créer un éditeur (pub). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de / test / light, vous pouvez spécifier n'importe quel sujet. </font><font style="vertical-align: inherit;">Dans notre cas, l'essentiel est qu'il soit indiqué dans le script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les messages sont créés par les éditeurs. </font><font style="vertical-align: inherit;">Pour créer un message, vous pouvez utiliser la commande.</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_pub -h localhost - t /<span class="hljs-built_in">test</span>/light -m “light”</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous n'en aurons pas besoin, car notre éditeur (pub) sera notre application. </font><font style="vertical-align: inherit;">Le schéma est le suivant: lorsque notre application reçoit une commande, elle envoie une requête à notre script. </font><font style="vertical-align: inherit;">Le script est destiné au courtier et le courtier à l'abonné (esp8266). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous vérifierons l'envoi des messages via l'onglet Test Action Console.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/j0/ff/ljj0ffysayc5d3wfg8ui2rcc15w.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/j5/tf/xz/j5tfxzjm9gbh7toxf9wi6zah2zw.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script PHP</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">//Make sure that it is a POST request.</span>
<span class="hljs-keyword">if</span>(strcasecmp($_SERVER[<span class="hljs-string">'REQUEST_METHOD'</span>], <span class="hljs-string">'POST'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Request method must be POST!'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Make sure that the content type of the POST request has been set to application/json</span>
$contentType = <span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>]) ? trim($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>])                                                                                                              : <span class="hljs-string">''</span>;
<span class="hljs-keyword">if</span>(strcasecmp($contentType, <span class="hljs-string">'application/json'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Content type must be: application/json'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Receive the RAW post data.</span>
$content = trim(file_get_contents(<span class="hljs-string">"php://input"</span>));<font></font>
<font></font>
<span class="hljs-comment">//Attempt to decode the incoming RAW post data from JSON.</span><font></font>
$decoded = json_decode($content);<font></font>
<font></font>
<span class="hljs-comment">//file_put_contents($filename, $data);</span><font></font>
var_dump($decoded);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> $decoded-&gt;queryResult-&gt;action;<font></font>
<font></font>
define(<span class="hljs-string">'BROKER'</span>, <span class="hljs-string">'localhost'</span>);<font></font>
define(<span class="hljs-string">'PORT'</span>, <span class="hljs-number">1883</span>);<font></font>
define(<span class="hljs-string">'CLIENT_ID'</span>,  getmypid());<font></font>
  <font></font>
$client = <span class="hljs-keyword">new</span> Mosquitto\Client(CLIENT_ID);<font></font>
$client-&gt;connect(BROKER, PORT, <span class="hljs-number">60</span>);<font></font>
<font></font>
        $message = $decoded-&gt;queryResult-&gt;action;<font></font>
        $client-&gt;publish(<span class="hljs-string">'/test/light'</span>, $message, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
        $client-&gt;loop();<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Micrologiciel ESP8266</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le firmware, nous utiliserons l'IDE Arduino. </font><font style="vertical-align: inherit;">Si quelqu'un installe l'IDE pour la première fois, n'oubliez pas le pilote ch340. </font><font style="vertical-align: inherit;">Par défaut, il n'y a pas un tel paiement en arduino. </font><font style="vertical-align: inherit;">Dans Fichier &gt;&gt; Paramètres, vous devez spécifier l'adresse des cartes supplémentaires: arduino.esp8266.com/stable/package_esp8266com_index.json. </font><font style="vertical-align: inherit;">Dans Tools &gt;&gt; board &gt;&gt; board manager, vous devez installer le package esp8266. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'esquisse après const char * ssid, vous devez indiquer le nom de votre réseau wi-fi. </font><font style="vertical-align: inherit;">Après const char * mot de passe, son mot de passe. </font><font style="vertical-align: inherit;">Après const char * mqtt_server, spécifiez l'adresse IP de votre serveur.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Croquis Arduino IDE</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;ESP8266WiFi.h&gt;<font></font>
#include &lt;PubSubClient.h&gt;<font></font>
<font></font>
// Update these with values suitable for your network.<font></font>
<font></font>
const char* ssid = "***";<font></font>
const char* password = "********";<font></font>
const char* mqtt_server = "**.**.*.*";<font></font>
<font></font>
WiFiClient espClient;<font></font>
PubSubClient client(espClient);<font></font>
long lastMsg = 0;<font></font>
char msg[50];<font></font>
int value = 0;<font></font>
<font></font>
int led = D5;<font></font>
<font></font>
void setup_wifi() {<font></font>
<font></font>
  delay(10);<font></font>
  // We start by connecting to a WiFi network<font></font>
  Serial.println();<font></font>
  Serial.print("Connecting to ");<font></font>
  Serial.println(ssid);<font></font>
<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  while (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(500);<font></font>
    Serial.print(".");<font></font>
  }<font></font>
<font></font>
  randomSeed(micros());<font></font>
<font></font>
  Serial.println("");<font></font>
  Serial.println("WiFi connected");<font></font>
  Serial.println("IP address: ");<font></font>
  Serial.println(WiFi.localIP());<font></font>
}<font></font>
<font></font>
void callback(char* topic, byte* payload, unsigned int length) {<font></font>
  String msg="";<font></font>
  Serial.print("Message arrived [");<font></font>
  Serial.print(topic);<font></font>
  Serial.print("] ");<font></font>
  for (int i = 0; i &lt; length; i++) {<font></font>
    Serial.print((char)payload[i]);<font></font>
    msg+=(char)payload[i];<font></font>
  }<font></font>
  Serial.println();<font></font>
<font></font>
  // Switch on the LED if an 1 was received as first character<font></font>
//  if ((char)payload[0] == '1') {<font></font>
  if (msg == "light") {<font></font>
    digitalWrite(led, HIGH);   // Turn the LED on <font></font>
  } else {<font></font>
    digitalWrite(led, LOW);  // Turn the LED off <font></font>
  }<font></font>
<font></font>
}<font></font>
<font></font>
void reconnect() {<font></font>
  // Loop until we're reconnected<font></font>
  while (!client.connected()) {<font></font>
    Serial.print("Attempting MQTT connection...");<font></font>
    // Create a random client ID<font></font>
    String clientId = "ESP8266Client-";<font></font>
    clientId += String(random(0xffff), HEX);<font></font>
    // Attempt to connect<font></font>
    if (client.connect(clientId.c_str())) {<font></font>
      Serial.println("connected");<font></font>
      // ... and resubscribe<font></font>
      client.subscribe("/test/light");<font></font>
    } else {<font></font>
      Serial.print("failed, rc=");<font></font>
      Serial.print(client.state());<font></font>
      Serial.println(" try again in 5 seconds");<font></font>
      // Wait 5 seconds before retrying<font></font>
      delay(5000);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
void setup() {<font></font>
  pinMode(led, OUTPUT);     // Initialize the led pin as an output<font></font>
  Serial.begin(115200);<font></font>
  setup_wifi();<font></font>
  client.setServer(mqtt_server, 1883);<font></font>
  client.setCallback(callback);<font></font>
}<font></font>
<font></font>
void loop() {<font></font>
<font></font>
  if (!client.connected()) {<font></font>
    reconnect();<font></font>
  }<font></font>
  client.loop();<font></font>
<font></font>
}<font></font>
</code></pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Résultat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, après avoir compilé l'esquisse, nous obtenons une application qui est intégrée dans l'assistant google et gère les capteurs. </font><font style="vertical-align: inherit;">Au lieu d'un smartphone, j'ai utilisé une application web, mais testé sur Android - le résultat est le même. </font><font style="vertical-align: inherit;">L'essentiel est que si vous testez à partir d'un smartphone, n'oubliez pas de dire: "Parlez avec l'application ***".</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/vh/ug/qfvhugumopat-isohcimmyujd08.jpeg" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/eh/or/mv/ehormvyz41fgzhgogas1yrszpvs.jpeg" alt="image"><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/g-S82CdMIrY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490472/index.html">Comme j'ai écrit une crypto-monnaie semi-décentralisée en PHP. (Partie 1 - Collecte des bibliothèques)</a></li>
<li><a href="../fr490474/index.html">STM32 Partie 1: Les bases</a></li>
<li><a href="../fr490476/index.html">Capteur sans fil pour l'ouverture et la fermeture avec des fonctionnalités avancées</a></li>
<li><a href="../fr490478/index.html">Station de soudage DIY DIY v2</a></li>
<li><a href="../fr490480/index.html">O Tiling-wm en 2 mots</a></li>
<li><a href="../fr490490/index.html">Week-end de lecture: 10 documents sur les effets du son sur la santé - de «l'hygiène du bruit» au bon sommeil et au GTD</a></li>
<li><a href="../fr490492/index.html">Un robot d'entrepôt apprend à trier les choses non standard</a></li>
<li><a href="../fr490494/index.html">Shop rats, Widiots et gamers: propagande des dangers des jeux vidéo dans les années 80</a></li>
<li><a href="../fr490496/index.html">Création d'une boutique en ligne sur Nuxt.js 2 Procédure pas à pas, partie 1</a></li>
<li><a href="../fr490498/index.html">Comme j'ai écrit une crypto-monnaie semi-décentralisée en PHP. (Partie 2 - Développement)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>