<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💬 👨🏼‍✈️ 🗺️ Création d'un Viberbot à part entière. Deuxième partie - premier contact ou "conversion_started" 💂🏼 🤶🏿 🕴🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Envoi du premier message à l'utilisateur - bienvenue et signature
 Dans la première partie, nous avons appris comment lancer un démarreur, installer u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Création d'un Viberbot à part entière. Deuxième partie - premier contact ou "conversion_started"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486858/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi du premier message à l'utilisateur - bienvenue et signature</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">première partie,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons appris comment </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lancer un démarreur,</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installer un webhook pour notre projet botviber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce 2ème, nous apprendrons comment envoyer le premier message affiché à nos utilisateurs, créer des liens pour rechercher et lancer notre bot, à la fois dans ViberURL et NoViberURL</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/k4/py/cik4pyycxovsxsmki6rjrtupv6a.jpeg" alt="image"><br>
<br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous formerons des liens vers le bot</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Hors ligne QR - il peut être téléchargé à partir de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zone d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> administration de l'affilié </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">viber</font></a></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2) Lien pour le messager ViberURL et le transfert de messager</font></font><br>
<br>
<pre><code class="plaintext hljs">viber://pa?chatURI=dinner&amp;context=fromhabr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lien de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirection </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">NoViberURL</font></a><font style="vertical-align: inherit;"> sur Internet, il existe de nombreux raccourcisseurs d'URL - mais ils ressemblent tous à du spam, je vous recommande donc de créer votre propre code à partir de trois lignes de PHP et de placer le fichier sur votre hébergement, voici le contenu du fichier foot.php</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
header (<span class="hljs-string">"Location: viber://pa?chatURI=dinner"</span>);
<span class="hljs-keyword">exit</span>();</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salutations botviber ou "événement": "conversation_started"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir ouvert le QR ou cliqué sur le lien vers l'adresse de notre application à partir des serveurs Viber (Jetty), les requêtes POST avec un événement ("event": "conversation_started") arrivent et leur contenu complet ressemble à ceci:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST DES PARAMÈTRES ENTRANTS - ou JSON de 13 champs</font></font></b><div class="spoiler_text"><pre><code class="python hljs">{
  <span class="hljs-string">"chat_hostname"</span>: <span class="hljs-string">"SN-327_"</span>, <span class="hljs-comment">#  Viber    -   "chat_hostname"</span>
  <span class="hljs-string">"event"</span>: <span class="hljs-string">"conversation_started"</span>, <span class="hljs-comment">#          </span>
  <span class="hljs-string">"context"</span>: <span class="hljs-string">"fromlanding"</span>, <span class="hljs-comment">#    UTM     </span>
  <span class="hljs-string">"message_token"</span>: <span class="hljs-number">5406893180055821524</span>, <span class="hljs-comment">#  </span>
  <span class="hljs-string">"subscribed"</span>: false, <span class="hljs-comment">#    ,   true   </span>
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-number">1581161565470</span>, <span class="hljs-comment"># UNIXTIME </span>
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"open"</span>, <span class="hljs-comment">#  </span>
  <span class="hljs-string">"user"</span>: {
    <span class="hljs-string">"api_version"</span>: <span class="hljs-number">8</span>,  <span class="hljs-comment">#   API   . </span>
    <span class="hljs-string">"avatar"</span>: <span class="hljs-string">"https://media-direct.cdn.viber.com/avatar..."</span>, <span class="hljs-comment">#      -   ,   </span>
    <span class="hljs-string">"country"</span>: <span class="hljs-string">"RU"</span>, <span class="hljs-comment">#       (UA-, BY-, IL-, MD - )</span>
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"J2k6sasdgghaazDeoXVYww=="</span>, <span class="hljs-comment"># ID    </span>
    <span class="hljs-string">"language"</span>: <span class="hljs-string">"ru"</span>, <span class="hljs-comment">#      (  )</span>
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Denis"</span> № <span class="hljs-comment">#   Viber -      -     name  </span><font></font>
  }<font></font>
}</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais dans la plupart des cas, nous ne sommes intéressés que par ces 5 domaines</font></font></b><div class="spoiler_text"><pre><code class="python hljs">{
  <span class="hljs-string">"context"</span>: <span class="hljs-string">"fromlanding"</span>, <span class="hljs-comment">#      </span>
  <span class="hljs-string">"subscribed"</span>: false,
   <span class="hljs-string">"user"</span>: {
    <span class="hljs-string">"country"</span>: <span class="hljs-string">"RU"</span>, <span class="hljs-comment">#      </span>
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"J2k6sasdgghaazDeoXVYww=="</span>, <span class="hljs-comment"># ID    </span>
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Denis"</span> № <span class="hljs-comment">#   ,   .</span><font></font>
  }<font></font>
}</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et parfois, nous n'avons besoin que d'un seul champ</font></font></b><div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Id": "J2k6sasdgghaazDeoXVYww =="</font></font><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit de l'identifiant Viber principal de l'utilisateur, analogue de chat_id dans le télégramme. </font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et, veuillez noter que dans le panier chat_id, l'unique messager dans tous les bots est le même que le numéro de mobile dans tous les bots, et l'id de la vibe est comme un token et est unique dans l'un de vos bots. </font><font style="vertical-align: inherit;">Dans un autre bot, votre identifiant sera différent ...</font></font><br>
 </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous les traitons et répondons pour obtenir l'une des trois réponses comme dans la capture d'écran ci </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- </font><font style="vertical-align: inherit;">dessus </font><font style="vertical-align: inherit;">a) type = "text" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
b) et ici nous voyons le cas classique de type = "rich_media" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
c) sur le troisième écran Type = "keyboard" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">détails</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">API REST viber</font></a><font style="vertical-align: inherit;"> , et ci-dessous, nous verrons comment obtenir la première option</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme nous le voyons déjà, botviber peut être marqué pour toute entreprise ou mini-boutique, et également personnaliser les styles de votre site principal</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) pour traiter les messages utilisateur dans le fichier de projet myviberbot / views.py, apportez les modifications:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-comment">#</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> requests <span class="hljs-comment">#      </span>
<span class="hljs-keyword">import</span> json 
<span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> HttpResponse
<span class="hljs-keyword">from</span> django.views.decorators.csrf <span class="hljs-keyword">import</span> csrf_exempt<font></font>
<font></font>
auth_token = <span class="hljs-string">'45df835d27d01f-cd2e7wetwerga18a8-9a7wert786234'</span> <span class="hljs-comment">#!     </span>
url = <span class="hljs-string">'https://chatapi.viber.com/pa/send_message'</span>
headers = {<span class="hljs-string">'X-Viber-Auth-Token'</span>: auth_token}<font></font>
<font></font>
<span class="hljs-comment">#     </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sending</span>(<span class="hljs-params">func</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped</span>(<span class="hljs-params">*args</span>):</span>
        <span class="hljs-keyword">return</span> requests.post(url, json.dumps(func(*args)), headers=headers)
    <span class="hljs-keyword">return</span> wrapped<font></font>
<font></font>
<span class="hljs-comment">#  </span>
<span class="hljs-meta">@sending</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_text</span>(<span class="hljs-params">agent, text, track=None</span>):</span>
    m = dict(receiver=agent, min_api_version=<span class="hljs-number">2</span>, tracking_data=track, type=<span class="hljs-string">"text"</span>, text=text)
    <span class="hljs-keyword">return</span> m<font></font>
<font></font>
<span class="hljs-meta">@csrf_exempt</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">trx_bot</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"POST"</span>:<font></font>
        viber = json.loads(request.body.decode(<span class="hljs-string">'utf-8'</span>))
        <span class="hljs-keyword">if</span> viber[<span class="hljs-string">'event'</span>] == <span class="hljs-string">'conversation_started'</span>:<font></font>
            print(<span class="hljs-string">" "</span>)<font></font>
            conversation(viber) <span class="hljs-comment">#  -    .</span>
        <span class="hljs-keyword">elif</span> viber[<span class="hljs-string">'event'</span>] == <span class="hljs-string">'webhook'</span>:
            <span class="hljs-comment">#print(viber)</span>
            <span class="hljs-comment">#print("Webhook  ")</span>
            <span class="hljs-keyword">return</span> HttpResponse(status=<span class="hljs-number">200</span>)
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"  Webhook -   ,   POSTMAN"</span>) 
            <span class="hljs-keyword">return</span> HttpResponse(status=<span class="hljs-number">500</span>)
        <span class="hljs-keyword">return</span> HttpResponse(status=<span class="hljs-number">200</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">conversation</span>(<span class="hljs-params">viber</span>):</span>
    id = viber[<span class="hljs-string">'user'</span>][<span class="hljs-string">'id'</span>]
    <span class="hljs-keyword">if</span> viber[<span class="hljs-string">'subscribed'</span>]:<font></font>
	    send_text(id, <span class="hljs-string">'  '</span>)
    <span class="hljs-keyword">else</span>:<font></font>
        send_text(id, <span class="hljs-string">'   ?\n\n   .      ...'</span>)<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redémarrez notre projet Django. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, "Rakuten Viber" ne donne des pages officielles à PA et à la communauté à personne, à l'exception des grandes marques et des personnalités publiques, par conséquent, pour la promotion SEO et les relations publiques sur les réseaux sociaux, etc. Je recommande de créer un mini-landing - une petite page vers laquelle tout le monde va depuis le site principal ou d'autres. Voici un échantillon de ressources: </font><font style="vertical-align: inherit;">
Lancez botviber avec succès. </font><font style="vertical-align: inherit;">
À suivre ... </font><font style="vertical-align: inherit;">
Dans le prochain article, nous analyserons l'événement ["message"], pour traiter les messages des utilisateurs, vous apprendrez quoi faire pour mener un dialogue, comment séparer les messages suivants, généralement comment apprendre à Botviber à comprendre que ce sont les suivants. </font><font style="vertical-align: inherit;">
(Création d'un Viberbot à part entière sur Django 2 et l'API Viber REST. Troisième partie - Message) </font><font style="vertical-align: inherit;">
Matériaux: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">documentation de l'API REST viber</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/le/f8/jp/lef8jpeb1jvzrdzheg-qqbtf3eq.jpeg"><br>
</a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django version 2.2 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Radio-mineur</font></font></a></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486828/index.html">Food Design Digest, janvier 2020</a></li>
<li><a href="../fr486832/index.html">Combien d'années vont la taïga - ne comprends pas</a></li>
<li><a href="../fr486842/index.html">Consul + iptables =: 3</a></li>
<li><a href="../fr486844/index.html">L'évolution du traitement des webhooks Facebook: de zéro à 25 000 par seconde</a></li>
<li><a href="../fr486850/index.html">Nouveau siège réservé - comme un hôtel capsule</a></li>
<li><a href="../fr486860/index.html">ATX12VO - Manger d'une nouvelle façon</a></li>
<li><a href="../fr486862/index.html">5 raisons pour lesquelles le Motion Design vous aide à vous connecter avec les gens</a></li>
<li><a href="../fr486864/index.html">Migration d'OpenVPN vers WireGuard pour joindre des réseaux en un seul réseau L2</a></li>
<li><a href="../fr486866/index.html">Synchronous Fuete: Moteurs biologiques en nanotechnologie</a></li>
<li><a href="../fr486868/index.html">Pourquoi et pour qui nous faisons Slime Agile</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>