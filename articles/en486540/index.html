<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¶ üë∞üèº ‚ùì HighLoad ++, Mikhail Makurov, Maxim Chernetsov (Intersvyaz): Zabbix, 100kNVPS on one server üßôüèø üéá ‚ò∫Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The next HighLoad ++ conference will be held on April 6 and 7, 2020 in St. Petersburg. Details and tickets here . HighLoad ++ Moscow 2018. Moscow Hall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Mikhail Makurov, Maxim Chernetsov (Intersvyaz): Zabbix, 100kNVPS on one server</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/486540/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next HighLoad ++ conference will be held on April 6 and 7, 2020 in St. Petersburg. Details and tickets </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . HighLoad ++ Moscow 2018. Moscow Hall. November 9, 3 p.m. Abstracts and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/dm/mu/sadmmupp8vt5l5vl5obukgut36a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Monitoring - online and analytics. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* The main limitations of the ZABBIX platform. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Solution for scaling analytics storage. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* ZABBIX server optimization. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* UI optimization. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Experience in operating the system with loads of more than 40k NVPS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Briefly conclusions.</font></font><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Makurov (hereinafter - MM):</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Hello everyone! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maxim Chernetsov (hereinafter - MCH):</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Good afternoon! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Let me introduce Maxim. Max is a talented engineer, the best networker I know. Maxim deals with networks and services, their development and operation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/pn/q6/ujpnq61idhrrwq2dszdhb3hxjza.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And I would like to talk about Michael. Michael is a C developer. He wrote some highly loaded traffic processing solutions for our company. We live and work in the Urals, in the city of severe peasants in Chelyabinsk, at Intersvyaz. Our company is a provider of Internet and cable television services for one million people in 16 cities. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- And it is worth saying that Intersvyaz is much more than just a provider, it is an IT company. </font><font style="vertical-align: inherit;">Most of our decisions are made by our IT department. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from servers that process traffic, to the call center and mobile application. </font><font style="vertical-align: inherit;">There are about 80 people in the IT department with very, very diverse competencies.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About Zabbix and its architecture</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And now I‚Äôll try to set a personal record and say in one minute what Zabbix is ‚Äã‚Äã(hereinafter - ‚ÄúZabbiks‚Äù). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix positions itself as a monitoring system ‚Äúout of the box‚Äù at the enterprise level. </font><font style="vertical-align: inherit;">It has many life-simplifying features: advanced escalation rules, APIs for integration, grouping and auto-detection of hosts and metrics. </font><font style="vertical-align: inherit;">In Zabbix there are so-called scaling tools - proxies. </font><font style="vertical-align: inherit;">Zabbix is ‚Äã‚Äãan open source system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Briefly about architecture. </font><font style="vertical-align: inherit;">We can say that it consists of three components:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oc/fn/xv/ocfnxvdx0gy8qi4055lipyifl1q.jpeg"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server. </font><font style="vertical-align: inherit;">It is written in C. </font><font style="vertical-align: inherit;">With rather complicated processing and transmission of information between streams. </font><font style="vertical-align: inherit;">All processing takes place in it: from receiving to saving to the database.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All data is stored in the database. </font><font style="vertical-align: inherit;">Zabbix supports MySQL, PostreSQL, and Oracle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The web interface is written in PHP. </font><font style="vertical-align: inherit;">On most systems, it comes with an Apache server, but works more efficiently in the nginx + php bundle.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we would like to tell from the life of our company one story related to Zabbix ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Life story of Intersvyaz company. </font><font style="vertical-align: inherit;">What do we have and what is needed?</font></font></h3><br>
<img src="https://habrastorage.org/webt/d2/cr/rk/d2crrkodjpn2arv0aojibu6vsq4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 or 6 months ago. Once after work ... </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Misha, hello! Glad I managed to catch you - there is a conversation. We again had problems with monitoring. During a major accident, everything slowed down, and there was no information about the status of the network. Unfortunately, this is not the first time repeated. I need your help. Let's make our monitoring work under any circumstances! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - But let's synchronize first. I have not looked there for a couple of years. As far as I remember, we refused Nagios and switched to Zabbix 8 years ago. And now we seem to have 6 powerful servers and about a dozen proxies. Am I confusing anything? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Nearly. 15 servers, some of which are virtual machines. Most importantly, this does not save us at the moment when we need it most. Like an accident - the servers are slowing down and nothing is visible. We tried to optimize the configuration, but this does not give the optimal performance gain. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I see. Did you look something, did you dig something from the diagnosis? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- The first thing you have to deal with is just the database. </font><font style="vertical-align: inherit;">MySQL is so constantly loaded, preserving new metrics, and when Zabbix starts generating a bunch of events, the database goes into itself literally for several hours. </font><font style="vertical-align: inherit;">I already told you about the configuration optimization, but literally this year we updated the hardware: there are more than a hundred gigabytes of memory on the servers and disk arrays on SSD RAID-ahs - it makes no sense to grow it linearly far. </font><font style="vertical-align: inherit;">What do we do? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I see. </font><font style="vertical-align: inherit;">In general, MySQL is an LTP database. </font><font style="vertical-align: inherit;">Apparently, it is no longer suitable for storing an archive of metrics of our size. </font><font style="vertical-align: inherit;">Let's figure it out. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Come on!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix and Clickhouse integration as a result of hackathon</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After some time, we received interesting data: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2r/vp/of/2rvpofn2alwwhizhv4e7qrwhpsm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the space in our database was occupied by the archive of metrics and less than 1% was used for configuration, templates and settings. </font><font style="vertical-align: inherit;">By that time, for more than a year now we had been operating the Big data solution based on Clickhouse. </font><font style="vertical-align: inherit;">The direction of movement was obvious to us. </font><font style="vertical-align: inherit;">At our spring Hackathon, he wrote the integration of Zabbix with Clickhouse for the server and frontend. </font><font style="vertical-align: inherit;">At that time, Zabbix already had support for ElasticSearch, and we decided to compare them.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/jv/hq/bgjvhq9lwget5l-hy1xt9zz2mvo.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare Clickhouse and Elasticsearch</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - For comparison, we generated the same load that the Zabbix server provides and looked at how the systems would behave. We wrote data in batches of 1000 lines, used CURL. We previously suggested that the Clickhouse would be more effective for the load profile that Zabbix does. The results even exceeded our expectations: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zz/iz/pj/zzizpjgv0rf9zjuuasv7mds7is8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the same test conditions, the Clickhouse wrote three times as much data. At the same time, both systems consumed very efficiently (a small amount of resources) while reading data. But ‚ÄúElastix‚Äù required a large amount of processor when recording:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zz/iz/pj/zzizpjgv0rf9zjuuasv7mds7is8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In total, Clickhouse significantly exceeded Elastix in processor consumption and speed. At the same time, due to data compression, ‚ÄúClickhouse‚Äù uses 11 times less on the hard disk and does about 30 times less disk operations: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yf/0u/ce/yf0uceb3lvfa4e3mdwz1fsgufkw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, working with the disk subsystem at ‚ÄúClickhouse‚Äù is very effective. Under the bases, you can use huge SATA disks and get a write speed of hundreds of thousands of lines per second. The system "out of the box" supports sharding, replication, it is very easy to configure. We are more than happy with its operation for a year. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To optimize resources, you can install "Clickhouse" next to the existing main base and thereby save a lot of processor time and disk operations. We took out the archive of metrics to the existing ‚ÄúClickhouse‚Äù clusters:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qu/xr/p9/quxrp9ah4u-nhwlbkkcgynf2to0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We unloaded the main MySQL database so much that we could combine it on the same machine with the Zabbix server and abandon the dedicated server for MySQL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does polling work in Zabbix?</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 months ago </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Well, you can forget about the problems with the base? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - That's for sure! Another problem we need to solve is slow data collection. Now all of our 15 proxies are overloaded with SNMP and polling processes. And there are none other than setting up new and new servers. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Great. But first tell me how polling works in Zabbix. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In short, there are 20 types of metrics and a dozen ways to obtain them. Zabbix can collect data either in the "request-response" mode, or expect new data through the "Trapper Interface". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/dd/jc/f1ddjcw--iidqz7psmv82znkwk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that in the original Zabbix this method (Trapper) is the fastest. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are proxies for load balancing:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/n3/2v/qln32vd8mjkz2xbe0bowbswrpsu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proxies can perform the same collection functions as the Zabbix server, receiving tasks from it and sending collected metrics through the Trapper interface. </font><font style="vertical-align: inherit;">This is the officially recommended load balancing method. </font><font style="vertical-align: inherit;">Also, proxies are useful for monitoring a remote infrastructure that works through NAT or a slow channel: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/uv/mh/bauvmh-9-mcmokuu7ldhtx59--0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Everything is clear with the architecture. </font><font style="vertical-align: inherit;">We must look at the source ... </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A couple of days later</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tale of how nmap fping won</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - It seems that I dug up something. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Tell me! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I found that during availability checks, Zabbix does a check of up to 128 hosts at a time. I tried to increase this figure to 500 and removed the inter-packet interval in their ping (ping) - this increased the performance by a factor of two. But I would like big numbers. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In my practice, I sometimes have to check the availability of thousands of hosts, and I haven‚Äôt seen anything faster than nmap. I am sure this is the fastest way. Let's try it! You need to significantly increase the number of hosts in one iteration. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Check more than five hundred? 600? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - At least a couple of thousand. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Okay. The most important thing I wanted to say: I found that most of the polling in Zabbix was done synchronously. We must redo it asynchronously. Then we can dramatically increase the number of metrics collected by the pollers, especially if we increase the number of metrics in one iteration. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Great! And when? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - As usual, yesterday. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - We compared both versions of fping and nmap:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/du/ii/qoduiid8hzk_wy8sxvgityvungo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On a large number of hosts, nmap was expected to be up to five times more efficient. </font><font style="vertical-align: inherit;">Since nmap only checks for the fact of availability and response time, we transferred the loss calculation to triggers and significantly reduced the availability check intervals. </font><font style="vertical-align: inherit;">We found the optimal number of hosts for nmap in the region of 4 thousand per iteration. </font><font style="vertical-align: inherit;">Nmap allowed us to reduce the CPU costs for availability checks by three times and reduce the interval from 120 seconds to 10.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Polling optimization</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Then we went in for pollers. We were mainly interested in SNMP removal and agents. In Zabbix, polling was done synchronously and special measures were taken in order to increase the efficiency of the system. In synchronous mode, host unavailability causes significant polling degradation. There is a whole system of states, there are special processes - the so-called unreachable-pollers, which work only with inaccessible hosts: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3g/h1/fm/3gh1fmfnq3nqxkpwsow7j4h80ra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a commentary that demonstrates the state matrix, the complexity of the transition system that is required in order for the system to remain effective. In addition, synchronous polling itself is rather slow:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h7/0r/tm/h70rtmvjonmj3itlmq4wk44vpr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is why thousands of poller threads on a dozen proxies could not collect the necessary amount of data for us. The asynchronous implementation solved not only the problems with the number of threads, but also significantly simplified the state system of inaccessible hosts, because for any number checked in one iteration of polling, the maximum wait time was 1 timeout: In </font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/te/bj/retebjsm9vthvrjy7rmpobeiwqa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
addition, we modified and improved the polling system for SNMP- queries. The fact is that most cannot respond to multiple SNMP requests at the same time. Therefore, we made a hybrid mode when SNMP polling of the same host does asynchronously: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/9a/sj/mj9asjfzaisviljstpkdjpvmnya.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is done for the entire host bundle. This mode in the end is not slower than completely asynchronous, since polling one and a half hundred SNMP values ‚Äã‚Äãis still much faster than 1 timeout.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our experiments showed that the optimal number of requests in one iteration is about 8 thousand with SNMP polling. </font><font style="vertical-align: inherit;">In total, the transition to asynchronous mode allowed to accelerate polling performance by 200 times, several hundred times. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - The obtained polling optimizations showed that we can not only get rid of all proxies, but also reduce the intervals for many checks, and proxies will not be needed as a way to share the load. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About three months ago</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the architecture - increase the load!</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Well, Max, is it time to be productive? I need a powerful server and a good engineer. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Well, we plan. It's time to get off the ground at 5,000 metrics per second. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Morning after the </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">upgrade </font></i><b><font style="vertical-align: inherit;">:</font></b><font style="vertical-align: inherit;"> - Misha, we updated, but rolled back in the morning ... Guess what speed you achieved? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Thousand 20 maximum. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yeah, 25! Unfortunately, we are where we started. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And so? Did you get any diagnostics? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, of course! Here, for example, an interesting top: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6c/zv/6s/6czv6sdkoykmdkm0vn-sddnbbpw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Let's see. I see that we tried a huge number of polling threads: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qb/a0/cl/qba0clfwpherpsufnk_7fbn5ioy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But at the same time we were not able to utilize the system even halfway:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sp/wv/8b/spwv8blrzyggfwo5ps-objpypak.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the overall performance is quite small, about 4 thousand metrics per second: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tt/6o/zr/tt6ozrt2ortiof4kckeghltzrnq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Is there anything else? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, strace of one of the pollers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/ny/y3/p8nyy3kb_ffjhsjynlpz4wjfh8w.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - It is clearly seen here that the polling process is waiting for the "semaphores". These are locks: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/ks/mh/z7ksmh8kes9yc23tm0vuyu5g8r8.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - It is not clear. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Look, this is like a situation where a bunch of threads are trying to work with resources that only one can work with at a time. Then all they can do is share this resource by time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/ce/mo/incemofethgxpp3fwyabr8kstd4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the total productivity of working with such a resource is limited by the speed of one core: There </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oq/oh/9f/oqoh9fqs9ppftn5mab3aivoo2nq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
are two ways to solve this problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upgrade machine iron, switch to faster kernels:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/io/bd/zi/iobdziopu3g_vkfoengg2zhhcro.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Or change the architecture and </font><font style="vertical-align: inherit;">, at the same time </font><font style="vertical-align: inherit;">, the load: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/sl/wt/nuslwtjkx-poqob5ciqyyfifq48.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - By the way, we‚Äôll use fewer cores on a test machine than on a combat one, but they‚Äôll be 1.5 times faster in frequency per core! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Is that clear? </font><font style="vertical-align: inherit;">It is necessary to look at the server code.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Path in Zabbix Server</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - To understand, we began to analyze how the data is transmitted inside the Zabbix server: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v9/iu/a2/v9iua26a6om3flgzj_vb3te0hak.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cool picture, right? Let's go through it step by step to more or less clarify. There are streams and services responsible for collecting data: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h3/m9/kt/h3m9ktuwhpgwe1g4mbqjiw8l_zs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They transfer the collected metrics through the socket to the Preprocessor manager, where they are queued: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9d/ct/fv/9dctfvdiw2zaves1vn34gliuvmu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preprocessor-manager ‚Äùtransfers data to its workers who execute the preprocessing instructions and return them back through the same socket: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ma/qd/ss/maqdssje-vzlzzpfzl0x2cuthwo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the preprocessor -manager saves them in the history cache:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5r/9q/vw/5r9qvwyriydt0pcroma7n-14fsa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From there, they are taken by historical syncers that perform quite a lot of functions: for example, calculating triggers, filling the value cache and, most importantly, saving metrics in the history store. </font><font style="vertical-align: inherit;">In general, the process is complex and very confusing. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f7/o8/ih/f7o8ihzf_g5_2ecganu1t0zoss0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - The first thing we saw is that most threads compete for the so-called ‚Äúconfiguration cache‚Äù (a memory area where all server configurations are stored). </font><font style="vertical-align: inherit;">Especially a lot of locks are made by the streams responsible for data collection: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/oo/48/baoo48qthdg_pcp0ojgqh0de5us.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... since the configuration stores not only metrics with their parameters, but also queues, from which the pollers take information on what to do next. </font><font style="vertical-align: inherit;">When there are a lot of pollers, and one blocks the configuration, the rest are waiting for requests:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y5/zb/np/y5zbnpqumrszencyhaasflytwvm.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pollers must not conflict</font></font></h3><br>
<img src="https://habrastorage.org/webt/kw/11/4f/kw114ff5k91eqlycs-yg8p8bmem.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the first thing we did was divide the queue into 4 parts and allow the pollers to safely block these queues, these parts at the same time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/la/gi/xu/lagixuseh1aghovklgd6m3blkxu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This removed competition for the configuration cache, and the speed of the pollers increased significantly. </font><font style="vertical-align: inherit;">But then we were faced with the fact that the preprocessor manager began to accumulate a job queue:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/0c/4i/ui0c4i7aae8kqdvkdtorchzft-y.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preprocessor manager should be able to prioritize</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This happened when he lacked productivity. </font><font style="vertical-align: inherit;">Then all he could do was to accumulate requests from the data collection processes and add their buffer until he eats up all the memory and crashes: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9y/iy/oz/9yiyozxavyibcw8pog3tidwy-xc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem, we added a second socket, which was allocated specifically for workers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/sz/25/rbsz25axpkn6a832h9k7otp9je4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus , the preprocessor-manager got the opportunity to prioritize his work and in case the buffer grows, the task is to slow down the eat, giving workers the opportunity to pick up this buffer: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/og/cg/qiogcgztt1an1ewlrear7oqxt7g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we found that one of the reasons for the slowdown was because the workers themselves were competing for </font><font style="vertical-align: inherit;">vital resource for their work. </font><font style="vertical-align: inherit;">We registered this problem with a bug-fix, and in the new versions of Zabbix it has already been solved:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/6q/lr/yd6qlrqamuxreroffkeracyrnim.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We increase the number of sockets - we get the result</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, the preprocessor manager itself became a narrow link, since it is a single thread. </font><font style="vertical-align: inherit;">It rested on the speed of the core, giving a maximum speed of about 70 thousand metrics per second: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/s1/2_/uks12_i65kx3ohfqdfmvedyqdqw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we made four, with four sets of sockets, workers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qt/-u/ws/qt-uwsmlriplii491ao0we3jhg4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And this allowed us to increase the speed to about 130 thousand metrics: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/vp/cf/qlvpcfggoinhdxc4dfkniaz9po8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nonlinearity of growth is explained by the fact that there was competition for the cache stories. </font><font style="vertical-align: inherit;">For him, 4 preprocessor managers and historical synkers competed. </font><font style="vertical-align: inherit;">At this point, we received about 130 thousand metrics per second on the test machine, utilizing it by about 95% on the processor: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yo/7l/mh/yo7lmhcfcdbhek5blp5xdz0osfy.jpeg"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About 2.5 months ago</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refusal of snmp-community increased NVPs by one and a half times</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Max, I need a new test machine! We no longer fit into the current one. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And what is now? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Now - 130k NVPs and a ‚Äúshelf‚Äù processor. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Wow! Cool! Wait, I have two questions. According to my calculations, our need is in the region of 15-20 thousand metrics per second. Why do we need more? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I want to finish the job to the end. I want to see how much we can squeeze out of this system. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - But ... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - But it is useless for business. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I see. And the second question: what we have now, can we support ourselves, without the help of a developer? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- I do not think. Changing the configuration cache is a problem. It deals with changes in most threads and is difficult to maintain. Most likely, supporting her will be very difficult. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Then you need some kind of alternative. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - There is such an option. We can switch to fast cores, while abandoning the new locking system. We still get the performance of 60-80 thousand metrics. In this case, we can leave the rest of the code. Clickhouse, asynchronous polling will work. And it will be easy to maintain. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Great! I propose to dwell on this.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After optimizing the server side, we were finally able to run the new code into the productive. </font><font style="vertical-align: inherit;">We abandoned part of the changes in favor of switching to a machine with fast kernels and minimizing the number of changes in the code. </font><font style="vertical-align: inherit;">We also simplified the configuration and, if possible, abandoned the macros in the data elements, since they are the source of additional locks. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bk/v7/tp/bkv7tps-i9usalann4sbqpdbkqm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, the rejection of the snmp-community macro, which is often found in documentation and examples, in our case allowed us to additionally speed up NVPs by about 1.5 times. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After two days in production</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remove incident history pop-ups</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Misha, we use the system for two days, and everything works. But only when everything works! We had planned work with the transfer of a sufficiently large segment of the network, and again with our hands we checked that it had risen, that it hadn‚Äôt. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - It cannot be! We checked everything 10 times. The server processes even complete network inaccessibility instantly. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, I understand everything: server, database, top, austat, logs - everything is fast ... But we look at the web interface, and there we have the processor "in the shelf" on the server and this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/un/p2/vjunp2evh3whasvpw4hwsipeshk.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I see. Let's watch the web. We found that in a situation where there were a large number of active incidents, most operational widgets began to work very slowly:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/vw/kz/nzvwkzfbeg-4r1iue0y4178eg2q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The reason for this was the generation of pop-ups with a history of incidents that are generated for each item in the list. </font><font style="vertical-align: inherit;">Therefore, we refused to generate these windows (commented out 5 lines in the code), and this solved our problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The widget loading time, even when completely inaccessible, was reduced from a few minutes to the acceptable for us 10-15 seconds, and the history can still be viewed by clicking on the time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/dc/4l/hudc4lsz_skbshg7jphleuprc4a.jpeg"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After work. </font><font style="vertical-align: inherit;">2 months ago </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Misha, are you leaving? </font><font style="vertical-align: inherit;">We have to talk. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Not going to. </font><font style="vertical-align: inherit;">Again something with Zabbix? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Oh no, relax! </font><font style="vertical-align: inherit;">I just wanted to say: everything works, thanks! </font><font style="vertical-align: inherit;">Beer with me.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix is ‚Äã‚Äãeffective</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix is ‚Äã‚Äãa fairly versatile and rich system and function. </font><font style="vertical-align: inherit;">It can be used for small installations out of the box, but with the growth of needs it has to be optimized. </font><font style="vertical-align: inherit;">To store a large archive of metrics, use the appropriate storage:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use the built-in tools in the form of integration with Elastixerch or uploading the history to text files (available from the fourth version);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can take advantage of our experience and integration with Clickhouse.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To drastically increase the speed of collecting metrics, collect them asynchronously and transfer them through the trapper interface to the Zabbix server; </font><font style="vertical-align: inherit;">or you can use the patch for asynchronous pollers of Zabbix itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix is ‚Äã‚Äãwritten in C and is quite effective. </font><font style="vertical-align: inherit;">The solution of several narrow architectural places allows us to further increase its productivity and, in our experience, to receive more than 100 thousand metrics on a single-processor machine.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5r/db/d2/5rdbd2jcvr75sosfvfa6ziniwps.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The same Zabbix patch</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I want to add a couple of points. </font><font style="vertical-align: inherit;">The entire current report, all tests, numbers are given for the configuration that is used with us. </font><font style="vertical-align: inherit;">We are now taking about 20 thousand metrics per second from it. </font><font style="vertical-align: inherit;">If you are trying to understand if this will work for you - you can compare. </font><font style="vertical-align: inherit;">What they talked about today is posted on GitHub as a patch: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/miklert/zabbix</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/xb/wd/y1/xbwdy18hq9dolceyxku_2wxsj4a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The patch includes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">full integration with Clickhouse (both Zabbix server and frontend);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solving problems with the preprocessor manager;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronous polling.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The patch is compatible with all version 4, including lts. </font><font style="vertical-align: inherit;">Most likely, with minimal changes, it will work on version 3.4. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for the attention.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Questions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Question from the audience (hereinafter - A): - Good afternoon! Please tell me, do you have plans for intensive interaction with the Zabbix team or do they have with you so that this is not a patch, but the normal behavior of Zabbix? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, we will certainly commit part of the changes. Something will be, something will remain in the patch. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Thank you very much for the excellent report! Tell me, please, after applying the patch, the support from the side of Zabbix will remain and how to continue to upgrade to higher versions? Will it be possible to update Zabbix after your patch to 4.2, 5.0? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- I can‚Äôt say about support. If I were Zabbix's tech support, I would probably say no, because this is someone else's code. As for the code base 4.2, our position is this: "We will go with time, and we will be updated on the next version." Therefore, for some time we will upload the patch to updated versions. I already said in the report: the number of changes with the versions is still quite small. I think the transition from 3.4 to 4 took us, it seems, about 15 minutes. Something has changed there, but not very important. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - So you plan to maintain your patch and you can safely put it on production, in the future getting updates in some way? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - We strongly recommend it. This solves a lot of problems for us. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Once again, I would like to emphasize that changes that do not relate to architecture and do not relate to locks, queues - they are modular, they are in separate modules. Even on their own with minor changes, they can be maintained quite easily. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - If the details are interesting, then ‚ÄúClickhouse‚Äù uses the so-called history library. It is untied - this is a copy of the support of Elastic, that is, it is configurable. Polling only changes pollers. We believe that this will work for a long time. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Thank you very much. But tell me, is there any documentation of the changes made? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r7/vv/h3/r7vvh3optatasclqsm9tjftkmja.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Documentation is a patch. </font><font style="vertical-align: inherit;">Obviously, with the introduction of ‚ÄúClickhouse,‚Äù with the introduction of new types of pollers, new configuration options arise. </font><font style="vertical-align: inherit;">The link from the last slide has a short description of how to use it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About replacing fping with nmap</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - How did you eventually implement this? </font><font style="vertical-align: inherit;">Can you give specific examples: is it your strappers and an external script? </font><font style="vertical-align: inherit;">What eventually checks out so many hosts so quickly? </font><font style="vertical-align: inherit;">How do you get these hosts? </font><font style="vertical-align: inherit;">Do nmap need to somehow feed them, get them from somewhere, put them in, start something? .. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Cool. Very correct question! The point is this. We modified the library (ICMP ping, part of Zabbix) for ICMP checks, which indicate the number of packets - unit (1), and the code tries to use nmap. That is, this is the internal work of Zabbix, it has become the internal work of the pinger. Accordingly, no synchronization or use of a trapper is required. This was done deliberately in order to leave the system coherent and not engage in the synchronization of two base systems: what to check, fill in through the poller, and if the fill has broken in us? .. This is much simpler. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">Does</font></b><font style="vertical-align: inherit;"> it work for a proxy too? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Yes, but we did not check. The polling code is the same in both Zabbix and the server. Should work. I emphasize again: the system performance is such that we do not need a proxy.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - The correct answer to the question is: ‚ÄúWhy do you need a proxy with such a system?‚Äù </font><font style="vertical-align: inherit;">Only because of NAT'a or to monitor through a slow channel some ... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And you use Zabbix as an allergen, if I understand correctly. </font><font style="vertical-align: inherit;">Or the graphics (where is the archive layer) you left for another system, such as Grafana? </font><font style="vertical-align: inherit;">Or are you not using this functionality? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I will emphasize once again: we have made full integration. </font><font style="vertical-align: inherit;">We pour history into ‚ÄúClickhouse‚Äù, but at the same time changed the php frontend. </font><font style="vertical-align: inherit;">Php-frontend goes to ‚ÄúClickhouse‚Äù and does all the graphics from there. </font><font style="vertical-align: inherit;">At the same time, to be honest, we have a part that builds from the same ‚ÄúClickhouse‚Äù, from the same Zabbix data, data in other graphic display systems. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In "Grafan" as well.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How was the decision to allocate resources made?</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Share a little inner kitchen. </font><font style="vertical-align: inherit;">How was the decision made that resources should be allocated for serious product processing? </font><font style="vertical-align: inherit;">These are, in general, certain risks. </font><font style="vertical-align: inherit;">And please tell me, in the context of the fact that you are going to support new versions: how is this decision justified from a management point of view? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Apparently, we did not tell the drama of the story very well. </font><font style="vertical-align: inherit;">We found ourselves in a situation where something had to be done, and went essentially two parallel commands:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One was engaged in launching a monitoring system using new methods: monitoring as a service, a standard set of open source solutions that we combine and then try to change the business process in order to work with the new monitoring system.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In parallel, we had an enthusiastic programmer who was doing this (about himself). </font><font style="vertical-align: inherit;">It so happened that he won.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - And what is the size of the team? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - She is in front of you. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - That is, as always, a passionary is needed? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I do not know what a passionarian is. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In this case, apparently, you. </font><font style="vertical-align: inherit;">Thank you very much, you are cool. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Thank you.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About patches for Zabbix</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - For a system that uses proxies (for example, in some distributed systems), is it possible for your decision to adapt and patch, say, pollers, proxies and partially the preprocessor of Zabbix itself; and their interaction? Is it possible to optimize existing developments for a system with multiple proxies? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I know that the Zabbix server is assembled using a proxy (it compiles and the code is obtained). We did not test this in the product. I am not sure about this, but, in my opinion, the preprocessor manager is not used in the proxy. The proxy‚Äôs task is to take a set of metrics from Zabbix, fill them in (it also writes the configuration, local database) and return it to the Zabbix server. Then the server itself will do the preprocessing when it receives it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interest in proxies is understandable. </font><font style="vertical-align: inherit;">We will verify this. </font><font style="vertical-align: inherit;">This is an interesting topic. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - The idea was this: if you can patch pollers, they can be patched to proxies and patch interaction with the server, and the preprocessor can be adapted for these purposes only on the server. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - I think everything is even simpler. </font><font style="vertical-align: inherit;">You take the code, apply the patch, then configure it as you need - collect the proxy servers (for example, with ODBC) and distribute the patched code to the systems. </font><font style="vertical-align: inherit;">Where necessary - collect proxies, where necessary - server. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In addition, you won‚Äôt have to patch the proxy transmission to the server, most likely? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCH:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - No, it's standard. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Actually, one of the ideas did not sound. </font><font style="vertical-align: inherit;">We always maintained a balance between an explosion of ideas and the number of changes, the ease of support.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3yRt9jSwrlg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486518/index.html">Like 20 years ago</a></li>
<li><a href="../en486528/index.html">This is the norm - 3: normal map types</a></li>
<li><a href="../en486530/index.html">Mainstream. Honorary Workers. Biographical novel</a></li>
<li><a href="../en486532/index.html">Data backup using a bunch of FreeFileSync and 7-zip</a></li>
<li><a href="../en486538/index.html">How I uploaded soft skills online and what it gave me</a></li>
<li><a href="../en486542/index.html">Parse the sound of a dial-up modem</a></li>
<li><a href="../en486544/index.html">Two hours and 3.5 dollars. How I made a simple site with visualization of the distribution of coronavirus</a></li>
<li><a href="../en486548/index.html">Primitive recursive functions and Ackerman function</a></li>
<li><a href="../en486552/index.html">‚ÄúCultural code: the secrets of extremely successful groups and organizations‚Äù - notes from the book</a></li>
<li><a href="../en486554/index.html">Slurm DevOps. Three days of immersion in DevOps. And a lecture by Anatoly Wasserman "The Computational Problem of Socialism"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>