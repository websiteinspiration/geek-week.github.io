<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧤 🚂 🤛🏼 BpfTrace - finally, a complete replacement for Dtrace on Linux 🧕🏾 👩🏾‍🎓 👨‍👩‍👦‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It happens that systems are buggy, slow down, break down. The larger the system, the more difficult it is to find the cause. To find out why something...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>BpfTrace - finally, a complete replacement for Dtrace on Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/500456/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It happens that systems are buggy, slow down, break down. </font><font style="vertical-align: inherit;">The larger the system, the more difficult it is to find the cause. </font><font style="vertical-align: inherit;">To find out why something is not working as expected, to fix or prevent future problems, you need to look inside. </font><font style="vertical-align: inherit;">For this, systems must possess the property of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">observability</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is achieved by instrumentation in the broad sense of the word.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/6ExXwQecMrs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Peter Zaitsev (Percona) reviewed the available infrastructure for tracing in Linux and talked about bpfTrace, which (as the name implies) provides many advantages. </font><font style="vertical-align: inherit;">We made a text version of the report, so that it would be convenient for you to review the details and additional materials were always at hand.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instrumentation can be divided into two large blocks:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when the collection of information is wired into code: recording logs, counters, time, etc.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when the code is not instrumented by itself, but it is possible to do it when necessary.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another classification option is based on the approach to recording data:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracing</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - events are generated if a certain code has worked.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sampling</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the status of the system is checked, for example, 100 times per second and it determines what is happening in it.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Static instrumentation has existed for many years and is in almost everything. </font><font style="vertical-align: inherit;">On Linux, many standard tools like Vmstat or top use it. </font><font style="vertical-align: inherit;">They read data from procfs, where, roughly speaking, different timers and counters are written from the kernel code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But you cannot insert too many of these counters; you cannot cover everything in the world with them. </font><font style="vertical-align: inherit;">Therefore, dynamic instrumentation can be useful, which allows you to watch exactly what you need. </font><font style="vertical-align: inherit;">For example, if there are any problems with the TCP / IP stack, then you can go very deep and instruct specific details.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x8/nh/hz/x8nhhza-v08u7nlo01rb778nxqs.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dtrace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DTrace is one of the first known dynamic tracing frameworks created by Sun Microsystems. It began to be made back in 2001, and for the first time it was released in Solaris 10 in 2005. The approach turned out to be very popular and later went into many other distributions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, DTrace allows you to instrument both kernel space and user space. You can put traces on any function calls and specifically instruct programs: introduce special DTrace tracepoints, which for users can be more understandable than the function names.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This was especially important for Solaris, because it is not an open operating system. It was not possible to just look into the code and understand that tracepoint needs to be put on such a function, as it can now be done in the new open source Linux software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the unique, especially at that time, features of DTrace is that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while tracing is not enabled, it costs nothing</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It works in such a way that it simply replaces some CPU instructions with a DTrace call, which executes these instructions when it returns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In DTrace, instrumentation is written in a special D language, similar to C and Awk.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later DTrace appeared almost everywhere except Linux: on MacOS in 2007, on FreeBSD in 2008, in NetBSD in 2010. Oracle in 2011 included DTrace in Oracle Unbreakable Linux. </font><font style="vertical-align: inherit;">But few people use Oracle Linux, and DTrace never entered the main Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, in 2017, Oracle finally licensed DTrace under GPLv2, which in principle made it possible to include it in mainline Linux without licensing difficulties, but it was already too late. </font><font style="vertical-align: inherit;">At that time, Linux had good BPF, which was mainly used for standardization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DTrace is even going to be included in Windows; now it is available in some test versions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux tracing</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is in Linux instead of DTrace? </font><font style="vertical-align: inherit;">In fact, in Linux there is a lot of things in the best (or worst) manifestation of the open source spirit, a bunch of different tracing frameworks have accumulated over this time. </font><font style="vertical-align: inherit;">Therefore, figuring out what's what is not so simple. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wr/vu/ij/wrvuijy1unvtq2thcngvonvzsrq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to get acquainted with this variety and are interested in history, see the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with pictures and a detailed description of approaches for tracing in Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we talk about the infrastructure for tracing in Linux in general, there are three levels:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface for kernel instrumentation:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kprobe, Uprobe, Dtrace probe, etc.</font></font></li>
<li><strong>«»,    .</strong> ,  probe,      ,          user space   .       :   ,     user space,  Kernel Module,   - ,  eBPF.</li>
<li><strong>-</strong>,    ,    : Perf, SystemTap, SysDig, BCC  .. bpfTtrace       ,  ,   .</li>
</ol><br>
<h2>eBPF —   Linux</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With all of these frameworks, eBPF has become the standard on Linux in recent years. </font><font style="vertical-align: inherit;">This is a more advanced, highly flexible and effective tool that allows almost everything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is eBPF and where did it come from? </font><font style="vertical-align: inherit;">In fact, eBPF is an Extended Berkeley Packet Filter, and BPF was developed in 1992 as a virtual machine for efficient packet filtering by a firewall. </font><font style="vertical-align: inherit;">Initially, he had no relation to monitoring, observability, or tracing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In more modern versions, eBPF has been expanded (hence the word extended), as a common </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">framework for handling events</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Current versions are integrated with the JIT compiler for greater efficiency. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Differences of eBPF from classical BPF:</font></font></strong><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registers added;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a stack has appeared;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are additional data structures (maps).</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/gj/9v/uh/gj9vuhqn64yciwp2zyjmekazpvs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now people most often forget that there was an old BPF, and eBPF is simply called BPF. </font><font style="vertical-align: inherit;">In most modern expressions, eBPF and BPF are one and the same. </font><font style="vertical-align: inherit;">Therefore, the tool is called bpfTrace, not eBpfTrace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF has been included in mainline Linux since 2014 and is gradually included in many Linux tools, including Perf, SystemTap, SysDig. </font><font style="vertical-align: inherit;">There is a standardization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, development is still underway. </font><font style="vertical-align: inherit;">Modern kernels support eBPF better and better. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f9/ad/xi/f9adxi6tahas6qaz0crpgc4fldk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see what modern kernel versions have appeared </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EBPF Programs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So what is eBPF and why is it interesting? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF is a program in its special bytecode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is included directly in the kernel and performs the processing of trace events. Moreover, the fact that it is made in a special bytecode allows the kernel to carry out certain verification that the code is quite safe. For example, check that it does not use loops, because the loop in the critical section in the kernel can hang the whole system.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this does not allow to be completely secure. For example, if you write a very complex eBPF program, insert it into an event in the kernel that occurs 10 million times per second, then everything can slow down very much. But at the same time, eBPF is much safer than the old approach, when just some Kernel Modules were inserted through insmod, and anything could be in these modules. If someone made a mistake, or simply because of binary incompatibility, the whole core could fall.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The eBPF code can be compiled by LLVM Clang, that is, by and large, use a subset of C to create eBPF programs, which, of course, is quite complicated. And it’s important that compilation depends on the kernel: headers are used to understand what structures are used and what they are used for, etc. This is not very convenient in the sense that either some modules related to a specific core are always supplied, or need to be recompiled. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The diagram shows how eBPF works. </font></font><br>
<img src="https://habrastorage.org/webt/vf/f6/fq/vff6fqzhay_0tskbjguckrqe6e4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.brendangregg.com/ebpf.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The user creates an eBPF program. Further, the kernel, for its part, checks and loads it. After that, eBPF can connect to various tools for traces, process information, save it in maps (data structure for temporary storage). Then the user program can read statistics, receive perf-events, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It shows which eBPF features in which versions of Linux kernels. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/ck/gr/cyckgrqgpnhpfmbg2wptd77b1q0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that almost all subsystems of the Linux kernel are covered, plus there is good integration with hardware data, eBPF has access to all kinds of cache miss or branch miss prediction, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you're interested in eBPF, check out the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">IO Visor</font></a><font style="vertical-align: inherit;"> project</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it contains most of the tools. </font><font style="vertical-align: inherit;">IO Visor company is engaged in their development, they will have the latest versions and very good documentation. </font><font style="vertical-align: inherit;">More and more eBPF tools are appearing on Linux distributions, so I would recommend that you always use the latest available versions.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EBPF performance</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of performance, eBPF is quite effective. </font><font style="vertical-align: inherit;">To understand how much and whether there is overhead, you can add a probe, which twitches several times per second, and check how long it takes to execute it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/jb/tq/rbjbtq7wvfiqdggh5bohn0dcaxc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The guys from Cloudflare made a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">benchmark</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A simple eBPF probe took them about 100 ns, while a more complex one took 300 ns. </font><font style="vertical-align: inherit;">This means that even a complex probe can be called up on a single core about 3 million times per second. </font><font style="vertical-align: inherit;">If probe jerks 100 thousand or a million times per second on a multi-core processor, then this will not affect performance too much.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frontend for eBPF</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you're interested in eBPF and the topic of Observability in general, you've probably heard of Brendan Gregg. He </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and talks a </font><font style="vertical-align: inherit;">lot about this </font><font style="vertical-align: inherit;">and made such a beautiful picture that shows tools for eBPF. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/-o/fi/da-ofi9xtmuvnkvygmbhzdftz00.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can see that, for example, you can use Raw BPF - just write bytecode - this will give a full range of features, but it will be very difficult to work with it. Raw BPF is about how to write a web application in assembler - in principle, it is possible, but without the need to do it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, bpfTrace, on the one hand, allows you to get almost everything from BCC and raw BPF, but it is much easier to use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my opinion, two tools are most useful:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCC. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the fact that according to Gregg's scheme, BCC is complex, it includes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">many ready-made functions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that can be simply launched from the command line.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BpfTrace</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It allows you to simply write your own toolkit or use ready-made solutions.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can imagine how much easier it is to write on bpfTrace if you look at the code of the same tool in two versions.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/yj/rg/dfyjrg8q4abkcjgcsnp00vuuymg.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTrace vs bpfTrace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, DTrace and bpfTrace are used for the same thing. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rh/uo/rm/rhuormrzvwap7cr3uwlqk8hcnqu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.brendangregg.com/blog/2018-10-08/dtrace-for-linux-2018.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The difference is that there is also a BCC in the BPF ecosystem that can be used for complex tools. </font><font style="vertical-align: inherit;">There is no BCC equivalent in DTrace, therefore, to make complex toolkits, usually use the Shell + DTrace bundle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When creating bpfTrace, there was no task to fully emulate DTrace. That is, you cannot take a DTrace script and run it on bpfTrace. But this doesn’t make much sense, because the logic in the lower level tools is quite simple. It is usually more important to understand which tracepoints you need to connect to, and the names of the system calls and what they directly do at a low level differ in Linux, Solaris, FreeBSD. That is where the difference arises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, bpfTrace is made 15 years after DTrace. It has some additional features that DTrace does not have. For example, he can do stack traces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But of course, much is inherited from DTrace. For example, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function names and syntax are similar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , although not completely equivalent.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/9l/cf/0z/9lcf0z37mltxok_7fsdvdhxanv8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The DTrace and bpfTrace scripts are close in code size and similar in complexity and language capabilities.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/ud/br/reudbrcb_yoslb9ylo0loe9e-os.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bpfTrace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see in more detail what is in bpfTrace, how it can be used and what is needed for this. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux requirements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for using bpfTrace: </font></font><br>
<img src="https://habrastorage.org/webt/1_/sc/tk/1_sctkrpgkd3rd2b0ccrk4fur2y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use all the features, you need a version of at least 4.9. </font><font style="vertical-align: inherit;">BpfTrace allows you to make a lot of different probes, starting with uprobe for instrumenting a function call in a user application, kernel-probes, etc.</font></font><br>
<img src="https://habrastorage.org/webt/la/v4/zq/lav4zqiss3uj4a42cx9lf5cu9hs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, there is an uretprobe equivalent for a custom uprobe function. For kernel, the same thing is kprobe and kretprobe. This means that in fact in the tracing framework you can generate events when the function is called and upon completion of this function - this is often used for timing. Or you can analyze the values ​​that the function returned and group them according to the parameters with which the function was called. If you catch a function call and return from it, you can do a lot of cool things. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside bpfTrace it works like this: we write a bpf program that is parsed, converted to C, then processed through Clang, which generates bpf byte code, after which the program loads.</font></font><br>
<img src="https://habrastorage.org/webt/2r/my/_i/2rmy_ipzm97oydg5q8xdltdbchs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The process is quite difficult, so there are limitations. </font><font style="vertical-align: inherit;">On powerful servers, bpfTrace works well. </font><font style="vertical-align: inherit;">But dragging Clang to a small embedded device to figure out what's going on is not a good idea. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ply is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suitable for this </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It, of course, does not have all the features of bpfTrace, but it generates bytecode directly.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux support</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A stable version of bpfTrace was released about a year ago, so it is not available on older Linux distributions. </font><font style="vertical-align: inherit;">It is best to take packages or compile the latest version that IO Visor distributes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, the latest Ubuntu LTS 18.04 does not have bpfTrace, but it can be delivered using the snap package. </font><font style="vertical-align: inherit;">On the one hand, this is convenient, but on the other hand, due to the way snap packages are made and isolated, not all functions will work. </font><font style="vertical-align: inherit;">For kernel-tracing, a package with snap works well; for user-tracing, it may not work correctly.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d3/si/co/d3sicofnas8mpwyrsvmkp1kdbvm.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Tracing Example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the simplest example that allows you to get statistics on IO requests:</font></font><br>
<br>
<pre><code class="bash hljs">bpftrace -e <span class="hljs-string">'kprobe:vfs_read { @start[tid] = nsecs; }
kretprobe:vfs_read /@start[tid]/ { @ns[comm] = hist(nsecs - @start[tid]); delete(@start[tid]); }'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we connect to the function </font></font><code>vfs_read</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, both kretprobe and kprobe. </font><font style="vertical-align: inherit;">Further for each thread ID (tid), that is, for each request, we track the beginning and end of its execution. </font><font style="vertical-align: inherit;">Data can be grouped not only by the totality of the entire system, but also by different processes. </font><font style="vertical-align: inherit;">Below is the IO output for MySQL. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e1/dx/om/e1dxomau1ormvas-7juk1as0sqy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The classic bimodal I / O distribution is visible. </font><font style="vertical-align: inherit;">A large number of fast requests are data that is read from the cache. </font><font style="vertical-align: inherit;">The second peak is reading data from disk, where latency is much higher. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can save this as a script (the bt extension is usually used), write comments, format it and just use it further </font></font><code>#bpftrace read.bt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">// read.bt file<font></font>
tracepoint:syscalls:sys_enter_read<font></font>
{<font></font>
  @start[tid] = nsecs;<font></font>
}<font></font>
tracepoint:syscalls:sys_exit_read / @start[tid]/ <font></font>
{<font></font>
  @<span class="hljs-built_in">times</span> = hist(nsecs - @start[tid]);<font></font>
  delete(@start[tid]);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The general concept of the language is quite simple.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Syntax:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> select probe to connect </font></font><code>probe[,probe,...] /filter/ { action }</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filter:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specify a filter, for example, only data on a given process of a given Pid.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Action: a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mini-program that converts directly to a bpf program and runs when bpfTrace is called.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More details can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bpftrace tools</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BpfTrace also has a toolbox. </font><font style="vertical-align: inherit;">Many fairly simple tools on BCC are now implemented on bpfTrace. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/sr/f1/dzsrf1-klsvpjawbgtdzffgegra.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is still small, but there is something that is not in the BCC. </font><font style="vertical-align: inherit;">For example, killsnoop allows you to track the signals caused by kill (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in looking at the bpf code, then in bpfTrace you can </font></font><code>-v</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">see the generated byte code </font><font style="vertical-align: inherit;">through </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is useful if you want to understand a heavy probe or not. </font><font style="vertical-align: inherit;">Having looked at the code and just having estimated its size (one page or two), you can understand how complicated it is.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fo/sr/zg/fosrzgluhzrwsysvgvtsrkth8qe.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL tracing example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me show you an example of MySQL, how it works. </font><font style="vertical-align: inherit;">MySQL has a function </font></font><code>dispatch_command</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which all MySQL query executions occur.</font></font><br>
<br>
<pre><code class="bash hljs">bpftrace -e <span class="hljs-string">'uprobe:/usr/sbin/mysqld:dispatch_command { printf("%s\n", str(arg2)); }'</span>
failed to <span class="hljs-built_in">stat</span> uprobe target file /usr/sbin/mysqld: No such file or directory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I just wanted to connect an uprobe to print the text of queries that come to MySQL - a primitive task. </font><font style="vertical-align: inherit;">Got a problem - says that there is no such file. </font><font style="vertical-align: inherit;">Like not when here it is:</font></font><br>
<br>
<pre><code class="xml hljs">root@mysql1:/# ls -la /usr/sbin/mysqld<font></font>
-rwxr-xr-x 1 root root 60718384 Oct 25 09:19 /usr/sbin/mysqld</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are just surprises with snap. </font><font style="vertical-align: inherit;">If set via snap, then there may be problems at the application level. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then I installed through the apt version, a newer Ubuntu, started again:</font></font><br>
<br>
<pre><code class="xml hljs">root@mysql1:~# bpftrace -e 'uprobe:/usr/sbin/mysqld:dispatch_command { printf("%s\n", str(arg2)); }'<font></font>
Attaching 1 probe...<font></font>
Could not resolve symbol: /usr/sbin/mysqld:dispatch_command</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“There is no such symbol” - how not ?! </font><font style="vertical-align: inherit;">I look through </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whether there is such a symbol or not:</font></font><br>
<br>
<pre><code class="xml hljs">root@mysql1:~# nm -D /usr/sbin/mysqld | grep dispatch_command<font></font>
00000000005af770 T <font></font>
_Z16dispatch_command19enum_server_commandP3THDPcjbb<font></font>
<font></font>
root@localhost:~# bpftrace -e 'uprobe:/usr/sbin/mysqld:_Z16dispatch_command19enum_server_commandP3THDPcjbb { printf("%s\n", str(arg2)); }'<font></font>
Attaching 1 probe...<font></font>
select @@version_comment limit 1<font></font>
select 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is such a symbol, but since MySQL is compiled from C ++, mangling is used there. </font><font style="vertical-align: inherit;">In fact, the present name of the function that is used in this command, the following: </font></font><code>_Z16dispatch_command19enum_server_commandP3THDPcjbb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If you use it in a function, then you can connect and get the result. </font><font style="vertical-align: inherit;">In the perf ecosystem, many tools make unmangling automatic, and bpfTrace is not yet able. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also pay attention to the flag </font></font><code>-D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is important because MySQL, and now many other packages, come without dynamic symbols (debug symbols) - they come in other packages. </font><font style="vertical-align: inherit;">If you want to use these characters, you need a flag </font></font><code>-D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, otherwise nm will not see them.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">useful links</font></font></b>
                        <div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">github.com/zoidbergwill/awesome-ebpf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">slideplayer.com/slide/12710510</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.brendangregg.com/ebpf.html</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">vger.kernel.org/netconf2018_files/BrendanGregg_netconf2018.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.brendangregg.com/Slides/Velocity2017_BPF_superpowers.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">lwn.net/Articles/740157</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">tracingsummit.org/w/images/8/82/Tracingsummit2018-bpftrace-robertson.pdf</a></li>
</ul></div>
                    </div><br>
<blockquote><i>   :</i>  ++ 25–26    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>        ,     .    ,       ,            . <br>
<br>
<i>   :</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">++ Online</a>   .       5 900        ,      ,        -.<br>
<br>
<i>   :</i>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">DevOpsConf 2019</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">HighLoad++ 2019</a> —   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>. <br>
<br>
       — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>, . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500446/index.html">A few words about R2DBC and PostgreSQL</a></li>
<li><a href="../en500448/index.html">Prometheus: HTTP monitoring through Blackbox exporter</a></li>
<li><a href="../en500450/index.html">Making a MIDI keyboard from an old children's synthesizer</a></li>
<li><a href="../en500452/index.html">High Reasoning on Deep Learning</a></li>
<li><a href="../en500454/index.html">“What marinas?” or we control the controller via bluetooth using a mobile application on Xamarin (Android)</a></li>
<li><a href="../en500458/index.html">Online Speech Technical Features: Starter Pack</a></li>
<li><a href="../en500462/index.html">Detect scene changes and save h264 video clips on Raspberry Pi without decoding</a></li>
<li><a href="../en500468/index.html">Java Features Guide 8-14</a></li>
<li><a href="../en500470/index.html">Adapting your existing business solution for SwiftUI. Part 3. Working with architecture</a></li>
<li><a href="../en500472/index.html">Python is time to make room. About the prospects of Julia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>