<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👇🏻 👨🏼‍🎓 🤪 ハイブリッドPHP / RoadRunnerを使用したGoアプリケーション開発 📀 🎻 ✋🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="古典的なPHPアプリケーションは、シングルスレッドで負荷が高く（もちろんマイクロフレームに書き込む場合を除き）、要求ごとにプロセスを強制的に停止させます。このようなアプリケーションは重くて遅いですが、ハイブリダイゼーションによって2番目の寿命を与えることができます。スピードアップするには、メモリリー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ハイブリッドPHP / RoadRunnerを使用したGoアプリケーション開発</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/461827/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古典的なPHPアプリケーションは、シングルスレッドで負荷が高く（もちろんマイクロフレームに書き込む場合を除き）、要求ごとにプロセスを強制的に停止させます。このようなアプリケーションは重くて遅いですが、ハイブリダイゼーションによって2番目の寿命を与えることができます。スピードアップするには、メモリリークを悪用して最適化し、パフォーマンスを向上させます。独自のGolang RoadRunner PHPアプリケーションサーバーを実装して柔軟性を追加します。PHPコードを簡素化し、スタックを拡張して、サーバーとアプリケーション間で責任を共有します。本質的には、Javaや他の言語でアプリケーションを作成しているかのようにアプリケーションを動作させます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハイブリダイゼーションのおかげで、以前は低速だったアプリケーションが負荷時に502エラーに悩まされなくなり、リクエストへの平均応答時間が減少し、生産性が向上し、アプリケーションの統合とnginx + php-fpmの形式での不要なバインディングの排除により、展開とアセンブリが容易になりました。 </font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RUm94xCaXMo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アントン・チトフ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラチェジス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）-CTOおよびSpiralScout LLCの共同創設者。PHPでの12年の商業開発の経験。</font><font style="vertical-align: inherit;">過去数年間、彼は会社の開発スタックにGolangを積極的に実装してきました。</font><font style="vertical-align: inherit;">アントンは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPロシア2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で1つの例について話しました</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPアプリケーションのライフサイクル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
概略的には、特定のフレームワークを備えた抽象的なアプリケーションのデバイスは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mm/va/0d/mmva0djqxjc5l733ikzi738ydry.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスにリクエストを送信すると、次のようになります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの初期化; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有ライブラリ、フレームワーク、およびORMの読み込み。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のプロジェクトに必要なライブラリをロードする。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーティング;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のコントローラーへのルーティングを要求します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応答の生成。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、</font><font style="vertical-align: inherit;">単一のエントリポイントを持つ</font><font style="vertical-align: inherit;">従来の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シングルスレッドアプリケーション</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の動作原理で</font><font style="vertical-align: inherit;">あり、各実行後に完全に破棄されるか、その状態をクリアします。</font><font style="vertical-align: inherit;">すべてのコードがメモリからアンロードされるか、ワーカーがクリアされるか、単にその状態をリセットします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延読み込み</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
速度を上げるための標準的で簡単な方法は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延読み込みシステム</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">またはオンデマンド読み込みライブラリ</font><font style="vertical-align: inherit;">の実装です</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/eb/gp/vjebgpv7_a4fuvu64x4g8eqmbke.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延読み込みでは、必要なコードのみを要求します。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定のコントローラーにアクセスすると、必要なライブラリーのみがメモリーにロードされ、処理されてからアンロードされます。</font><font style="vertical-align: inherit;">これにより</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プロジェクトの平均応答時間</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">短縮</font></strong><font style="vertical-align: inherit;">し、サーバーでの作業プロセスを大幅に促進できます。</font><font style="vertical-align: inherit;">現在使用しているすべてのフレームワークで、遅延読み込みの原則が実装されています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頻繁な計算をキャッシュする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法はより複雑で、Symfonyフレームワーク、テンプレートエンジン、ORMスキーム、ルーティングなどで積極的に使用されています。</font><font style="vertical-align: inherit;">これは、memcachedやRedisのようなユーザーデータのキャッシュではありません。</font><font style="vertical-align: inherit;">このシステム</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、コードの一部を事前にウォームアップします</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">システムは最初の要求でコードまたはキャッシュファイルを生成し、その後の要求では、たとえばテンプレートのコンパイルに必要なこれらの計算は実行されなくなります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nb/44/f6/nb44f6isfvs6vouultxridabeps.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシング</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はアプリケーションを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大幅に</font><strong><font style="vertical-align: inherit;">高速化します</font></strong><font style="vertical-align: inherit;">が、同時に</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それを複雑にし</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">たとえば、キャッシュの無効化やアプリケーションの更新に問題があります。</font><font style="vertical-align: inherit;">ユーザーキャッシュとアプリケーションキャッシュを混同しないでください。一方はデータが時間とともに変化し、もう一方はコードが更新されたときにのみ変化します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストを処理しています</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部のPHP-FPMサーバーからリクエストを受信すると、リクエストのエントリポイントと初期化が一致します。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントの要求はプロセスの状態であることがわかりました。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この状態を変更する唯一の方法は、ワーカーを完全に破棄して、新しいリクエストでやり直すことです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/cr/rb/jccrrb-szkhb6_nfn2zthotuctk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、利点のあるシングルスレッドのクラシックモデルです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの最後にいたすべての労働者は死にます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリリーク、競合状態、デッドロックはPHPに固有のものではありません。</font><font style="vertical-align: inherit;">あなたはそれを心配することはできません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードは単純です。私たちは、要求を記述して処理し、終了して次に進みます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、リクエストごとに、フレームワーク、すべてのライブラリを完全にロードし、いくつかの計算を実行し、テンプレートを再コンパイルします。</font><font style="vertical-align: inherit;">サークル内のリクエストごとに、多くの操作と不要な作業が発生します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーでの動作</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、nginxとPHPの束が動作します。</font><font style="vertical-align: inherit;">Nginxはリバースプロキシとして機能します。ユーザーに静力学の一部を与え、リクエストの一部を以下のPHPプロセスマネージャーPHP-FPMに委任します。</font><font style="vertical-align: inherit;">マネージャーはすでにリクエスト用に別のワーカーをレイズして処理します。</font><font style="vertical-align: inherit;">その後、労働者は破壊されるかクリアされます。</font><font style="vertical-align: inherit;">次に、次のリクエストのために新しいワーカーが作成されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8f/lc/fp/8flcfpz6zxemgxlas6avx5aguqa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなモデルは安定して動作します-アプリケーションを殺すことはほとんど不可能です。</font><font style="vertical-align: inherit;">ただし、負荷が高い場合、ワーカーを初期化および破棄するための作業量はシステムパフォーマンスに影響します。これは、単純なGETリクエストでも、多くの依存関係をプルしてデータベース接続を再確立しなければならないことが多いためです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションの高速化</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシュと遅延読み込みを導入した後、クラシックアプリケーションを高速化するにはどうすればよいですか？</font><font style="vertical-align: inherit;">他にどのようなオプションがありますか？</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言語そのものに目を向けてください</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OPCacheを使用します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OPCacheを有効にせずに運用環境でPHPを実行している人はいないと思いますか？</font></font></li>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC：Preloadingを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">待ち</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これにより、一連のファイルを仮想マシンにプリロードできます。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -CPUにバインドされたタスクでアプリケーションを大幅に高速化します。</font><font style="vertical-align: inherit;">残念ながら、データベースに関連するタスクでは、あまり役に立ちません。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代替案を使用します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、FacebookのHHVM仮想マシン。</font><font style="vertical-align: inherit;">より合理化された環境でコードを実行します。</font><font style="vertical-align: inherit;">残念ながら、HHVMはPHP構文と完全には互換性がありません。</font><font style="vertical-align: inherit;">代替策として、コードを完全に.NET C＃に変換するVKまたはPeachPieのkPHPコンパイラーが代替策です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別の言語に完全に書き換えます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは根本的なオプションです-リクエスト間でロードされるコードを完全に取り除きます。</font><b><font style="vertical-align: inherit;">アプリケーションの状態をメモリ</font></b><font style="vertical-align: inherit;">に</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">格納し、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このメモリを作業にアクティブに使用し、死にかけているワーカーの概念を忘れて、リクエスト間でアプリケーションを完全にクリアできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを実現するために、以前は初期化ポイントと一緒に使用されていたエントリポイントをアプリケーションの奥まで削除します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリポイントの転送-悪魔化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、アプリケーションに無限ループが作成されます。受信リクエスト-フレームワークを介して実行-ユーザーへの応答を生成します。</font><font style="vertical-align: inherit;">これは重大な節約です。すべてのブートストラップ、すべてのフレームワークの初期化は1回だけ実行され、その後、いくつかの要求がアプリケーションによって処理されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/7k/3l/ce7k3lov0kzcyxc3zyjq008taiy.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションを適合させます</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いことに、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイムで実行さ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れるアプリケーションのその部分のみを最適化することに焦点を当てることができ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">：コントローラー、ビジネスロジック。</font><font style="vertical-align: inherit;">この場合、遅延読み込みモデルを破棄できます。</font><font style="vertical-align: inherit;">初期化時に、プロジェクトのブートストラップに最初から参加します。</font><font style="vertical-align: inherit;">予備計算：ルーティング、テンプレート、設定、ORMスキームは初期化を膨らませますが、将来的には特定の1つのリクエストの処理時間を節約するでしょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fz/kj/ft/fzkjftdkc41niwqyrmml-ijjkwy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーをダウンロードするときにテンプレートをコンパイルすることはお勧めしませんが、たとえば、すべての構成をダウンロードすると便利です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデルを比較する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪魔化されたモデル（左）とクラシックモデルを比較します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/en/6r/zoen6rl8zyj6tpn7bghp_ozv61m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスが作成された瞬間から応答がユーザーに返される瞬間までの悪魔化されたモデルは、より時間がかかります。</font><font style="vertical-align: inherit;">従来のアプリケーションは、迅速な作成、処理、破棄のために最適化されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、コードのウォームアップ後の後続のすべてのリクエストははるかに高速です。</font><font style="vertical-align: inherit;">フレームワーク、アプリケーション、コンテナはすでにメモリ内にあり、要求を受け入れて迅速に応答する準備ができています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長寿命モデルの問題</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
利点にもかかわらず、モデルには一連の制限があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリリーク。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションは非常に長い間メモリ内にあり、ライブラリの「曲線」、誤った依存関係またはグローバル状態を使用すると、メモリがリークし始めます。</font><font style="vertical-align: inherit;">ある時点で、ユーザーの要求を壊す致命的なエラーが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題は2つの方法で解決されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正確なコードを記述し、実績のあるライブラリを使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">積極的に労働者を監視します。</font><font style="vertical-align: inherit;">プロセス内でメモリリークが発生していると思われる場合は、プロアクティブにメモリを下限のあるアナログに変更してください。つまり、まだクリーンアップされていないメモリを蓄積できていない新しいコピーに変更します。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ漏洩</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、受信リクエスト中にシステムの現在のユーザーをグローバル変数に保存し、リクエスト後にこの変数をリセットするのを忘れた場合、システムの次のユーザーが誤って、表示してはならないデータにアクセスする可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題は、アプリケーションアーキテクチャレベルで解決されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクティブなユーザーをグローバルコンテキストに保存しないでください。</font><font style="vertical-align: inherit;">要求コンテキストに固有のすべてのデータは破棄され、次の要求の前に消去されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッションデータを慎重に処理します。</font><font style="vertical-align: inherit;">PHPのセッション-古典的なアプローチでは、これはグローバルオブジェクトです。</font><font style="vertical-align: inherit;">後続の要求でリセットされるように正しくラップします。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソース管理</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースへの接続を監視します。</font><font style="vertical-align: inherit;">アプリケーションが1〜2か月間メモリ内でハングした場合、開いている接続はおそらくこの時間で閉じます。データベースが再インストールされるか、再起動されるか、ファイアウォールが接続をリセットします。</font><font style="vertical-align: inherit;">コードレベルでは、再接続を検討するか、各要求の後に接続をリセットして、次の要求で再接続します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長期間有効なファイルロックを回避します。</font><font style="vertical-align: inherit;">ワーカーが情報をファイルに書き込む場合、問題はありません。</font><font style="vertical-align: inherit;">ただし、このファイルが開いていてロックされている場合、ロックが解除されるまで、システム内の他のプロセスはそのファイルにアクセスできません。</font></font></li>
</ul><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長寿命モデルを探索する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長期間有効なワーカーモデルを検討し、アプリケーションを悪用し、それを実装する方法を検討します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非ブロッキングアプローチ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非同期PHPを使用します。アプリケーションをメモリに一度ロードし、アプリケーション内で着信HTTP要求を処理します。これで、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションとサーバーは1つのプロセスになります</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リクエストが到着すると、別のコルーチンを作成するか、イベントループでpromiseを提供し、処理してユーザーに提供します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v6/js/od/v6jsodvtlxjfy1udzwvl0wa2njk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの紛れもない利点は、最大のパフォーマンスです。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションでWebSocketを直接構成</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するなど、興味深いツールを使用することもでき</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このアプローチ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は開発の複雑さを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大幅に</font><strong><font style="vertical-align: inherit;">増大させます</font></strong><font style="vertical-align: inherit;">。 ELDOをインストールする必要があります。すべてのデータベースドライバーがサポートされるわけではなく、PDOライブラリは除外されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノンブロッキングアプローチによる悪魔化の場合の問題を解決するには、よく知られたツールである</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amphp</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用できます</font><font style="vertical-align: inherit;">。これは、C拡張形式の興味深い開発です。</font><font style="vertical-align: inherit;">これらのツールはすぐに機能し、優れたコミュニティと優れたドキュメントを備えています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロッキングアプローチ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーション内でコルーチンを発生させるのではなく、外部から発生させます。</font><font style="vertical-align: inherit;">PHP-FPMと</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/ul/eq/adulequ1msa3sb6ae6saah3bu-c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように、いくつかのアプリケーションプロセスをピックアップし</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これらのリクエストをプロセス状態の形式で送信する代わりに、プロトコルまたはメッセージングの形式で外部から配信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、私たちが知っているのと同じ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シングルスレッドコード</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を記述し、</font><font style="vertical-align: inherit;">すべて同じライブラリと同じPDOを使用しています。ソケット、HTTP、その他のツールを操作するための大変な作業はすべて、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPアプリケーションの外部で</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行われ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイナス点として</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メモリ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">監視し、</font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2つの異なるプロセス間の通信は自由</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><strong><font style="vertical-align: inherit;">はない</font></strong><font style="vertical-align: inherit;">ことを覚えて</font><font style="vertical-align: inherit;">おかなければなりません</font><font style="vertical-align: inherit;">が、データを転送する必要があります。これにより、わずかなオーバーヘッドが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するために、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で記述され</font><font style="vertical-align: inherit;">た</font><strong><font style="vertical-align: inherit;">PHP-RMツール</font></strong><font style="vertical-align: inherit;">がすでに存在</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">ReactPHPライブラリでは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、いくつかのフレームワークと統合されてい</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ただし、PHP-PMは非常に</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低速であり、サーバーレベルでメモリリークが発生し、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷がかかった状態ではPHP-FRMほどの増加は見られません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションサーバーを書きます</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは書いた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのアプリケーションサーバ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHP-RMに似ている、しかし、より多くの機能があります。サーバーに何を求めましたか？</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存のフレームワークと組み合わせる。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">市場のほぼすべてのフレームワークと柔軟に統合したいと考えています。特定のケースでのみ機能するツールを書く気がしません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーとアプリケーションの異なるプロセス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ローカルでの開発中にF5キーを押して、新しく更新されたコードを確認し、それらを個別に展開できるようにする、ホットリブートの可能性。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速性と安定性</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。それでも、HTTPサーバーを作成しています。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単な拡張性</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">サーバーをHTTPサーバーとしてだけでなく、キューサーバーやgRPCサーバーなどの個々のシナリオにも使用したいと考えています。</font><font style="vertical-align: inherit;">可能な限り</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">箱から出して作業します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：Windows、Linux、ARM CPU。</font><font style="vertical-align: inherit;">アプリケーションに固有の</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常に</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速なマルチスレッド拡張機能</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成する機能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにご存じのとおり、Golangで記述します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RoadRunnerサーバー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPサーバーを作成するには、4つの主要な問題を解決する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GolangとPHPプロセス間の通信を確立します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセス管理：労働者の作成、破壊、監視。</font></font></li>
<li>  —    .    ,         ,   ,    ,         .</li>
<li>HTTP- —   HTTP- .    —   ,     ,   PHP   .</li>
</ul><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、GolangとPHPプロセス間の通信の問題を解決しましょう。</font><font style="vertical-align: inherit;">いくつかの方法があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">埋め込み：Golangに直接PHPインタープリターを埋め込みます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは可能ですが、カスタムPHPアセンブリ、複雑なセットアップ、サーバーとPHPの共通プロセスが必要です。</font><font style="vertical-align: inherit;">たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go-phpの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように</font><font style="vertical-align: inherit;">、PHPインタープリターがGolangに統合されています。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有メモリ- </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセスがこの空間</font></font></strong><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">を共有する共有メモリ空間の使用</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">骨の折れる作業が必要です。</font><font style="vertical-align: inherit;">データを交換するときは、手動で状態を同期する必要があり、発生する可能性のあるエラーの量は非常に大きくなります。</font><font style="vertical-align: inherit;">共有メモリもOSに依存します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランスポートプロトコルの記述-Goridge</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linuxシステムのほとんどすべてのソリューションで使用されている単純な方法を使用しました。トランスポートプロトコルを使用しました。それはされ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、標準のパイプとUNIX / TCPソケットの上に書かれました</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
双方向でデータを転送し、エラーを検出し、リクエストにタグを付けてヘッダーを付けることができます。私たちにとって重要なニュアンスは、PHPとGolangの両方の側で依存関係なしでプロトコルを実装できることです-純粋な言語でのC拡張なし。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のプロトコルと同様に、基盤はデータパケットです。この例では、パケットのヘッダーは17バイトに固定されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wb/_h/g_/wb_hg_qtkmoxe74sthy12rhtzms.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のバイトは、パケットのタイプを決定するために割り当てられます。これは、データのシリアル化の種類を示すストリームまたはフラグにすることができます。次に2回、データサイズをリトルエンディアンとビッグエンディアンにパックします。このレガシーを使用して、伝送エラーを検出します。 2つの異なる順序でパックされたデータのサイズが一致しない場合は、おそらくデータ転送エラーが発生しています。その後、データが送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/rb/dr/btrbdre8cwionih8m6e7yze2crw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージの3番目のバージョンでは、そのようなレガシーを取り除き、チェックサムを使用したより古典的なアプローチを導入し、非同期PHPプロセスでこのプロトコルを使用する機能も追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GolangとPHPでプロトコルを実装するために、標準ツールを使用しました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golangの場合：</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準パイプとUNIX / TCPソケットを操作するためのエンコーディング/バイナリライブラリとioおよびnetライブラリ。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP：</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリデータのパック/アンパック、およびパイプとソケットの拡張ストリームとソケットを操作するための使い慣れた関数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装中に興味深い</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">副作用</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が発生しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを標準のGolang net / rpcライブラリと統合しました。これにより、アプリケーションでGolangからサービスコードを直接呼び出すことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスを作成します。</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">//  sample </span>
<span class="hljs-keyword">type</span>  <span class="hljs-keyword">struct</span>{}<font></font>
<font></font>
<span class="hljs-comment">// Hi returns greeting message.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *App)</span> <span class="hljs-title">Hi</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, r *<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> {<font></font>
    *r = fmt.Sprintf(<span class="hljs-string">"ll, %s!"</span>, name) 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをアプリケーションからの少量のコードと呼びます。</font></font><br>
<br>
<pre><code class="go hljs">&lt;?php<font></font>
use Spiral\Goridge;<font></font>
<font></font>
require <span class="hljs-string">"vendor/autoload.php"</span>;<font></font>
<font></font>
$rpc = <span class="hljs-built_in">new</span> Goridge\RPC(
    <span class="hljs-built_in">new</span> Goridge\SocketRelay(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6001</span>)<font></font>
);<font></font>
<font></font>
echo $rpc-&gt;call(<span class="hljs-string">"App.Hi"</span>, <span class="hljs-string">"Antony"</span>);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPプロセスマネージャー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーの次の部分は、PHPワーカーの管理です。</font></font><br>
<img src="https://habrastorage.org/webt/vt/jy/tk/vtjytk9effas7jkgjgadvbek_zw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーは、Golangから常に監視しているPHPプロセスです。エラーのログをSTDERRファイルに収集し、Goridgeトランスポートプロトコルを介してワーカーと通信し、メモリ消費、タスク実行、およびブロッキングに関する統計を収集します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装は簡単です-これはos / exec、runtime、sync、atomicの標準機能です。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワーカー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成するには、</font><strong><font style="vertical-align: inherit;">Worker Factory</font></strong><font style="vertical-align: inherit;">を使用します</font><font style="vertical-align: inherit;">。</font></font><br>
<img src="https://habrastorage.org/webt/wq/kr/tt/wqkrtt0n0xxvhdnxuvx_4f2deiy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜワーカーファクトリーなのか？</font><font style="vertical-align: inherit;">標準パイプとソケットの両方で通信​​したいからです。</font><font style="vertical-align: inherit;">この場合、初期化プロセスは少し異なります。</font><font style="vertical-align: inherit;">パイプで通信するワーカーを作成すると、すぐに作成して直接データを送信できます。</font><font style="vertical-align: inherit;">ソケットの場合、ワーカーを作成し、それがシステムに到達するまで待機し、PIDハンドシェイクを作成して、作業を続ける必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクバランサー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーの3番目の部分は、パフォーマンスにとって最も重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装には、標準のGolang機能である</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファチャネル</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。特に、いくつかのワーカーを作成し、それらをLIFOスタックとしてこのチャネルに配置します。</font></font><br>
<img src="https://habrastorage.org/webt/bm/po/f4/bmpof4s5-owl810px69ectqiw_i.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーからタスクを受け取ると、LIFOスタックにリクエストを送信し、最初のフリーワーカーの発行を要求します。ワーカーが一定時間割り当てられない場合、ユーザーは「タイムアウトエラー」タイプのエラーを受け取ります。ワーカーが割り当てられている場合-ワーカーはスタックから出てブロックされ、その後ユーザーからタスクを受け取ります。</font></font><br>
<img src="https://habrastorage.org/webt/cm/2o/cq/cm2ocqak94ubao7tk8vxnglfyyo.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクが処理されると、応答がユーザーに返され、ワー​​カーはスタックの最後に立ちます。彼は再び次のタスクを実行する準備ができています。</font></font><br>
<img src="https://habrastorage.org/webt/oj/f_/l4/ojf_l4ipil8fcslpyherhsg02la.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーが発生すると、ワーカーが破棄されるため、ユーザーはエラーを受け取ります。</font><font style="vertical-align: inherit;">ワーカープールとワーカーファクトリに同じプロセスを作成してスタック上で置き換えるように依頼します。</font><font style="vertical-align: inherit;">これにより、PHP-FPMに類似した方法でワーカーを再作成するだけで、致命的なエラーが発生した場合でもシステムが機能するようになります。</font></font><br>
<img src="https://habrastorage.org/webt/qs/li/dq/qslidqche8glb-q5pucwfwnpogw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、非常に高速に動作する小さなシステムを実装することが判明しました- </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワーカーの割り当てに200 ns</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">致命的なエラーが発生した場合でも機能します。</font><font style="vertical-align: inherit;">ある時点での各ワーカーは1つのタスクのみを処理するため、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">従来のブロッキングアプローチ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロアクティブな監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスマネージャとタスクバランサの両方の別個の部分は、プロアクティブな監視システムです。</font></font><br>
<img src="https://habrastorage.org/webt/83/zq/ep/83zqepdmerd6ozakntcmv33hnus.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、1秒に1回ワーカーをポーリングしてインジケーターを監視するシステムです。ワーカーが消費するメモリの量、メモリの量、IDLEかどうかを調べます。</font><font style="vertical-align: inherit;">追跡に加えて、システムはメモリリークを監視します。</font><font style="vertical-align: inherit;">ワーカーが特定の制限を超えると、致命的なリークが発生する前に、それが表示され、システムから慎重に削除されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPスタック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の簡単な部分。</font></font><br>
<img src="https://habrastorage.org/webt/hl/cc/7e/hlcc7ehfob5vhc_zjse_em8e0eg.jpeg"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装方法：</font></font></strong><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang側でHTTPポイントを発生させます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストを受け取る;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSR-7形式に変換します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のフリーワーカーにリクエストを送信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストをPSR-7オブジェクトにアンパックします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは処理します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは答えを生成します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装には、標準の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang NET / HTTPライブラリ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用しました</font><font style="vertical-align: inherit;">。これは多くの拡張機能を持つ有名なライブラリです。 HTTPSとHTTP / 2プロトコルの両方で機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP側では、PSR-7標準を使用しました</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの拡張機能とミドルウェアを備え</font><font style="vertical-align: inherit;">た</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独立したフレームワーク</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。 PSR-7の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設計</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><strong><font style="vertical-align: inherit;">不変で</font></strong><font style="vertical-align: inherit;">あり、長寿命のアプリケーションの概念にうまく適合し、グローバルクエリエラーを回避します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GolangとPSR-7の両方の構造は類似しており、1つの言語から別の言語にリクエストをマッピングする時間を大幅に節約しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーを起動するには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小限のバインディング</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<pre><code class="go hljs">http:<font></font>
    address: <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8080</span> <font></font>
    workers:<font></font>
        command: <span class="hljs-string">"php psr-worker.php"</span> <font></font>
        pool:<font></font>
            numWorkers: <span class="hljs-number">4</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、バージョン1.3.0以降では、構成の最後の部分を省略できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーのバイナリファイルをダウンロードし、Dockerコンテナーまたはプロジェクトフォルダーに配置します。</font><font style="vertical-align: inherit;">または、グローバルに、リッスンするポッド、エントリポイントであるワーカー、必要な数を記述した小さな構成ファイルを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP側では、PSR-7要求を受信して​​処理し、サーバーに応答またはエラーを返すプライマリループを記述します。</font></font><br>
<br>
<pre><code class="go hljs">while ($req = $psr7-&gt;acceptRequest()) {<font></font>
    try {<font></font>
        $resp = <span class="hljs-built_in">new</span> \Zend\Diactoros\Response();<font></font>
        $resp-&gt;getBody()-&gt;write(<span class="hljs-string">"hello world"</span>);<font></font>
<font></font>
        $psr7-&gt;respond($resp);<font></font>
    } catch (\Throwable $e) {<font></font>
        $psr7-&gt;getWorker()-&gt;error((<span class="hljs-keyword">string</span>)$e);<font></font>
    }<font></font>
}</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">サーバーを実装するために、コンポーネントアプローチのアーキテクチャを選択しました。</font><font style="vertical-align: inherit;">これにより、プロジェクトのニーズに合わせてサーバーを組み立て、アプリケーションの要件に応じて個々の部分を追加または削除することができます。</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
    rr.Container.Register(env.ID, &amp;env.Service{}) <font></font>
    rr.Container.Register(rpc.ID, &amp;rpc.Service{}) <font></font>
    rr.Container.Register(http.ID, &amp;http.Service{}) <font></font>
    rr.Container.Register(static.ID, &amp;static.Service{}) <font></font>
    rr.Container.Register(limit.ID, &amp;limit.Service{}<font></font>
<font></font>
    <span class="hljs-comment">// you can register additional commands using cmd.CLI</span><font></font>
     rr.Execute()<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユースケース</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーを使用し、構造を変更するためのオプションを検討してください。</font><font style="vertical-align: inherit;">まず、従来のパイプライン、つまりサーバーがリクエストを処理することを考えます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーはHTTPポイントへのリクエストを受信し、Golangで記述された一連のミドルウェアに渡します。</font><font style="vertical-align: inherit;">着信要求は、ワーカーが理解できるタスクに変換されます。</font><font style="vertical-align: inherit;">サーバーはワーカーにタスクを渡し、それを返します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zz/v5/ak/zzv5akvapzklanxdlzunxdq-xpu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、ワーカーはGoridgeプロトコルを使用してサーバーと通信し、そのステータスを監視してデータを転送します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golangのミドルウェア：承認</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが最初に行うことです。</font><font style="vertical-align: inherit;">このアプリケーションでは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、JWTトークンによってユーザー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">認証する</font></strong><font style="vertical-align: inherit;">ミドルウェアを</font><strong><font style="vertical-align: inherit;">作成しました</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ミドルウェアは、他のタイプの許可についても同様に作成されます。</font><font style="vertical-align: inherit;">非常に平凡でシンプルな実装は、Rate-LimiterまたはCircuit-Breakerを作成することです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/on/zg/ro/onzgroqwxc7umuy-y2xfv9s7dqe.jpeg"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認は迅速</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">リクエストが有効でない場合-PHPアプリケーションに送信せず、無駄なタスクの処理にリソースを費やさないでください。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニタリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の使用例。</font><font style="vertical-align: inherit;">監視システムをGolangミドルウェアに直接統合できます。</font><font style="vertical-align: inherit;">たとえば、Prometheusは、応答ポイントの速度、エラー数に関する統計を収集します。</font><strong><font style="vertical-align: inherit;">監視をアプリケーション固有のメトリックと組み合わせる</font></strong></font><br>
<br>
<img src="https://habrastorage.org/webt/rz/_o/hz/rz_ohzkiz6bwjoebzqu2qt4e6dc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
こともでき</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（1.4.5で標準として利用可能）。</font><font style="vertical-align: inherit;">たとえば、データベースへのリクエスト数または処理された特定のリクエスト数をGolangサーバーに送信してから、Prometheusに送信できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散トレースとロギング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスマネージャーを使用してミドルウェアを作成します。</font><font style="vertical-align: inherit;">特に、リアルタイムシステムに接続してログを監視し</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すべてのログを1つの中央データベース</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><strong><font style="vertical-align: inherit;">収集</font></strong><font style="vertical-align: inherit;">できます。これは、分散アプリケーションを作成するときに役立ちます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lf/ir/cd/lfircdprhx6nqetmadblqftvbu4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><strong><font style="vertical-align: inherit;">タグ</font></strong><font style="vertical-align: inherit;">を付けて特定のIDを与え、このIDをすべてのダウンストリームサービスまたは</font><strong><font style="vertical-align: inherit;">リクエスト</font></strong><font style="vertical-align: inherit;">間の通信システムに渡す</font><font style="vertical-align: inherit;">こともでき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">その結果、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散トレース</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">構築して</font><font style="vertical-align: inherit;">、アプリケーションログの状態を確認できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリ履歴を記録する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、すべての着信要求を記録して外部データベースに保存する小さなモジュールです。</font><font style="vertical-align: inherit;">このモジュールを使用すると、プロジェクトでリクエストを再生して、自動テストシステム、負荷テストシステムを実装したり、APIをチェックしたりできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ex/q3/kg/exq3kgpym1uf6tjcfwysjk1so00.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールをどのように実装しましたか？</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golangのリクエストの一部を処理します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Golangでミドルウェアを作成し、リクエストの一部をHandlerに送信できます。HandlerもGolangで作成されています。</font><font style="vertical-align: inherit;">アプリケーションのいずれかのポイントでパフォーマンスの問題が懸念される場合は、それをGolangに書き換えて、スタックをある言語から別の言語にドラッグします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q0/zf/qn/q0zfqnzddo_mn7h-d779cg9ganm.jpeg"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSocketサーバーを作成しています</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">WebSocketサーバーまたはプッシュ通知サーバーの実装は簡単な作業になりつつあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーレベルのGolangサービス。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通信にはGoridgeを使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPのシンサービスレイヤー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通知サーバーを実装します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを受け取り、WebSocket接続を確立します。</font><font style="vertical-align: inherit;">アプリケーションが何らかの通知をユーザーに送信する必要がある場合は、RPCプロトコルを介してこのメ​​ッセージをWebSocketサーバーに送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/ta/fv/gotafvsepr8u8_r_lvfdjpff2rg.jpeg"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP環境を管理します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワーカープールを作成するとき、RoadRunnerは環境変数の状態を完全に制御し、環境変数を好きなように変更できます。</font><font style="vertical-align: inherit;">大規模な分散アプリケーションを作成している場合は、単一の構成データソースを使用して、それをシステムとして接続し、環境を構成できます。</font><font style="vertical-align: inherit;">サービスのセットを上げると、これらのサービスはすべて1つのシステムをノックし、構成してから機能します。</font><font style="vertical-align: inherit;">これにより、デプロイメントが大幅に簡略化され、.envファイルが削除されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/m5/03/ivm503pht02yug6do6-od3pyt6i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深いことに、ワーカー内で使用できる環境変数はシステム内でグローバルではありません。</font><font style="vertical-align: inherit;">これにより、コンテナの安全性が少し向上します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPでのGolangライブラリの統合</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RoadRunner</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の公式Webサイトでこのオプションを使用しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、実質的に本格的なデータベース</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー内の</font><strong><font style="vertical-align: inherit;">全文検索BleveSearchの統合</font></strong><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5a/ba/uc/5abaucml3dmvxqpns_h7bug_ldi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントページにインデックスを付けました。それらをBolt DBに配置した後、MySQLなどの実際のデータベースやElasticsearchなどの検索クラスターなしで全文検索を実行しました。</font><font style="vertical-align: inherit;">その結果は、一部の機能がPHPにある小さなプロジェクトでしたが、検索はGolangにあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lambda関数の実装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに進ん</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、HTTPレイヤーを完全に取り除く</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことができ</font><strong><font style="vertical-align: inherit;">ます。</font></strong><font style="vertical-align: inherit;">この場合、たとえばLambda関数の実装は簡単な作業です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/ie/dy/tyiedyrsetx2l5wljnllkbju0xg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装には</font><font style="vertical-align: inherit;">、Lambda関数に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ランタイム</font></a><font style="vertical-align: inherit;">を使用し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">小さなバインディングを作成し、HTTPサーバーを完全に切り取り、データをバイナリ形式でワーカーに送信します。</font><font style="vertical-align: inherit;">また、Amazonの管理パネルから直接構成する関数を作成できる環境設定にもアクセスできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスの存続期間中、ワーカーはメモリ内にあり、最初のリクエスト後のLambda関数は15分間メモリに残ります。</font><font style="vertical-align: inherit;">現時点では、コードは読み込まれず、すばやく応答します。</font><font style="vertical-align: inherit;">模擬テストでは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つの着信リクエストあたり</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大</font><strong><font style="vertical-align: inherit;">0.5 ms</font></strong><font style="vertical-align: inherit;">を受け取りました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPのgRPC</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より難しいオプションは、HTTPレイヤーをgRPCレイヤーに置き換えることです。</font><font style="vertical-align: inherit;">この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージはGitHubで入手できます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<img src="https://habrastorage.org/webt/jh/u5/cg/jhu5cgv7-cdj6wf4ifukhqxnd0u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての着信Protobufリクエストを完全に下位のPHPアプリケーションにプロキシできます。そこで、それらを解凍し、処理して、応答することができます。</font><font style="vertical-align: inherit;">PHPとGolangの両方でコードを記述し、機能を組み合わせてスタック間で転送することができます。</font><font style="vertical-align: inherit;">このサービスはミドルウェアをサポートしています。</font><font style="vertical-align: inherit;">スタンドアロンアプリケーションは、HTTPと組み合わせて使用​​することもできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューサーバー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の最も興味深いオプションは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、キューサーバーの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装です</font><font style="vertical-align: inherit;">。</font></font><br>
<img src="https://habrastorage.org/webt/rn/ch/1i/rnch1i0ieekunszmsv_ppegtwbu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP側では、バイナリペイロードを取得し、それを解凍して、作業を行い、サーバーに成功を伝えます。 Golang側では、ブローカーとの接続の管理に全面的に取り組んでいます。 RabbitMQ、Amazon SQS、またはBeanstalkが考えられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Golang側では、ワーカーの「</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グレースフルシャットダウン」</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実装してい</font><font style="vertical-align: inherit;">ます。 「永続的な接続」の実装を美しく待つことができます。ブローカーとの接続が失われた場合、サーバーは「バックオフ戦略」を使用してしばらく待機し、接続を解除し、アプリケーションはそれに気づくことさえありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのリクエストをPHPとGolangの両方で処理し、両側でキューに入れることができます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP側からGoridgeプロトコルGoridge RPCを介して。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golangから-SDKライブラリとの通信。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペイロードが低下した場合、コンシューマ全体が低下するのではなく、1つの個別のプロセスのみが低下します。</font><font style="vertical-align: inherit;">システムはすぐにそれを発生させ、タスクは次のワーカーに送信されます。</font><font style="vertical-align: inherit;">これにより、ノンストップタスクを実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブローカーの1つをサーバーメモリに直接実装し、Golang機能を使用しました。</font><font style="vertical-align: inherit;">これにより、最終的なスタックを選択する前に、キューを使用してアプリケーションを作成できます。</font><font style="vertical-align: inherit;">アプリケーションをローカルで持ち上げて実行すると、メモリ内で動作し、RabbitMQ、Amazon SQS、またはBeanstalkで動作するのと同じように動作するキューがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなハイブリッドの組み合わせで2つの言語を使用する場合、それらを分離する方法を覚えておく価値があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個別のドメインドメイン</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golangは、マルチスレッド化された高速言語であり、インフラストラクチャロジックやユーザーモニタリングおよび承認ロジックの記述に適しています。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、</font><font style="vertical-align: inherit;">データソースにアクセスするための</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムドライバーの実装に</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も役立ち</font><font style="vertical-align: inherit;">ます。これらは、Kafka、Cassandraなどのキューです。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPは、ビジネスロジックを作成するための優れた言語です。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、HTMLレンダリング、ORM、およびデータベースの操作に適したシステムです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツール比較</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数か月前</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にHabréで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHP-FPM、PHP-PM、React-PHP、Roadrunner、その他のツールを比較しました。ベンチマークは、実際のSymfony 4を使用したプロジェクトで実施されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷がかかっているRoadRunnerは良好な結果を示し、すべてのサーバーより優れています。 PHP-FPMと比較すると、パフォーマンスは6〜8倍になります。</font></font><br>
<img src="https://habrastorage.org/webt/ny/tx/yl/nytxylmddyrmglxjoe8hos7tnka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じベンチマークで、RoadRunnerは単一のリクエストを失うことはなく、すべてが100％うまくいきました。残念ながら、React-PHPは負荷のかかった状態で8-9リクエストを失いました-これは受け入れられません。サーバーがクラッシュせず、安定して動作することを望みます。</font></font><br>
<img src="https://habrastorage.org/webt/7b/fl/gq/7bflgqhrq1f-y0jixnud_k1ckdg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitHubのパブリックドメインでRoadRunnerが公開されて以来、30,000を超えるインストールがありました。コミュニティは私たちが特定の拡張機能、改善のセットを書くのを助け、ソリューションが生きる権利を持っていると信じています。</font></font><br>
<br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font><strong><font style="vertical-align: inherit;">大幅に高速化し</font></strong><font style="vertical-align: inherit;">たい</font><strong><font style="vertical-align: inherit;">が、まだ非同期PHPにジャンプする準備ができていない</font></strong><font style="vertical-align: inherit;">場合は、RoadRunnerが適しています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これはある程度の労力を必要とする妥協ですが、コードベースの完全な書き換えほど重要ではありません。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードランナーを取る</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したい場合は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPのライフサイクルをより細かく制御</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十分なPHPの機能がない場合、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例えば、キューシステムやカフカのために、そして人気のGolangライブラリはあなたの問題を解決するとき、あなたはどちらか持たない、PHPに存在し、書き込みには時間がかかるしません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサーバーを作成し、それを運用インフラストラクチャで使用することで得られたもの。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPMと比較して</font><strong><font style="vertical-align: inherit;">、アプリケーションポイントの反応速度が4倍になりました</font></strong><font style="vertical-align: inherit;">。</font></font></li>
<li><strong>    502  </strong>.           ,      .</li>
<li>     <strong>    2- </strong>.      ,          .</li>
<li><strong> Keep-Alive. </strong>      .</li>
<li>   <strong>   Alpine Docker  Kubernetes</strong>.       . ,   —    RoadRunner build  ,     Docker,  Docker-,       pod  Kubernetes.</li>
<li>        ,      , <strong>   0,33 </strong>.</li>
</ul><br>
<blockquote>    PHP- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PHP Russia</a>    .   :<br>
<br>
<ul>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GolangConf</a>,      Go               .      —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</li>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">HighLoad++</a>  ,    ,     , —    7 ,   .</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">telegram-</a>,       PHP Russia 2020. </li>
</ul></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461815/index.html">半世紀前のコンピュータ電源設計の革命</a></li>
<li><a href="../ja461817/index.html">CMakeとC ++-永遠の兄弟</a></li>
<li><a href="../ja461819/index.html">シンプルなウェブサイトのデザインが科学的に優れている理由</a></li>
<li><a href="../ja461821/index.html">新しい免疫療法は転移性乳がんの女性のすべての腫瘍を除去しました</a></li>
<li><a href="../ja461823/index.html">ソフトウェア設計の4つのルールの強化</a></li>
<li><a href="../ja461829/index.html">TCP対UDPまたは将来のネットワークプロトコル</a></li>
<li><a href="../ja461831/index.html">StealthWatch：展開とカスタマイズ。パート2</a></li>
<li><a href="../ja461833/index.html">3つのマツで迷子にならないでください：環境の自己中心的な表現</a></li>
<li><a href="../ja461845/index.html">財政を維持する方法としての交換への投資：3つの作業方法</a></li>
<li><a href="../ja461849/index.html">﻿PVS-StudioがRed Dead Redemptionエンジンをちらりと見た-Bullet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>