<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∑ ‚òùüèæ ü¶ë Not a day without sports - 2: reprogramming a Chinese bracelet üê≠ üó®Ô∏è ‚óÄÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For people involved in sports, a frequent companion for jogging or riding is a smartphone with various applications. With a bicycle it‚Äôs easier, you c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Not a day without sports - 2: reprogramming a Chinese bracelet</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499774/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For people involved in sports, a frequent companion for jogging or riding is a smartphone with various applications. </font><font style="vertical-align: inherit;">With a bicycle it‚Äôs easier, you can fix a smartphone, for example, on the steering wheel and watch the data from the sensors. </font><font style="vertical-align: inherit;">But what if you are running or skiing? </font><font style="vertical-align: inherit;">You can fix the smart on your hand, for this there are special covers (including swivel ones). </font><font style="vertical-align: inherit;">But this is inconvenient and sometimes cumbersome. </font><font style="vertical-align: inherit;">In addition, the Russian hero does not go directly.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/j1/q_/fz/j1q_fzwtiw73syp5etvzvj7rtz0.png"></div><br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are various articles on the Internet in which enthusiasts make their smart watches. </font><font style="vertical-align: inherit;">Self-made or printed case. </font><font style="vertical-align: inherit;">Make the filling. </font><font style="vertical-align: inherit;">But there are a lot of ready-made devices on aliexpress. </font><font style="vertical-align: inherit;">For example, as in the photo below. </font><font style="vertical-align: inherit;">If you believe the description, then it‚Äôs a direct super device: it measures heart rate, pressure, calories and something else.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/1e/lx/_m/1elx_m11liwbpplrvgyeuv6ysre.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's open and see what's inside.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zh/nh/a7/zhnha7n6p12xuxjq7orp3viizem.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ig/yt/c2/igytc2hz31xj2jcedbdn2wjxuso.jpeg"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in fact</font></font></b>
                        <div class="spoiler_text">        .           .       Random()  . ,  ,    ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oa/hw/qq/oahwqqwuxmukbxri_l8ripqzsha.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The brain of this bracelet is a PHY6202 chip from a manufacturer from the Middle Kingdom Fengjia Microelectronics. Inside it has a Cortex-M0 and a standard set of peripherals. Memory: 512kB Flash, 138kB SRAM and 128kB ROM. ROM contains a BLE stack and a UART bootloader, as programmable chip through UART. The Chinese comrades carefully brought out contacts for UART. To switch to UART mode, the bootloader needs to pull the TM output to a high level and reset the chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The utilities and SDKs for the PHY6202 (as well as for his older brother PHY6212) can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The chip programming utility PhyPlusKit is provided directly. </font><font style="vertical-align: inherit;">The documentation has a list of commands: erase, write, etc. Details in the document PHY62XX_UART_FlashWrite_Protocol at the link above (in Chinese). </font><font style="vertical-align: inherit;">Honestly, the list of commands is not complete. </font><font style="vertical-align: inherit;">PhyPlusKit uses another </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdreg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">(read any register). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's get started. </font><font style="vertical-align: inherit;">We disassemble, solder the necessary contacts to the UART-USB adapter and </font></font><abbr title="Backup everything that is possible.  ‚ÄúReadback?  No, not heard. ‚Äù"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SDK contains many examples. </font><font style="vertical-align: inherit;">In itself, in my opinion, it is crooked and damp. </font><font style="vertical-align: inherit;">Sometimes you have to edit the source, because </font><font style="vertical-align: inherit;">they are not designed for ‚Äúexternal‚Äù use only. </font><font style="vertical-align: inherit;">Here is the battery level metering function from Battery Service. </font><font style="vertical-align: inherit;">Why is she there at all incomprehensible.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> uint8 <span class="hljs-title">battMeasure</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{<font></font>
  uint8 percent;<font></font>
  percent = <span class="hljs-number">95</span>;
  <span class="hljs-keyword">return</span> percent;<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not an SDK, but one solid example. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The pinout of the bracelet is:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) accelerometer</font></font></td>
<td>SDA P32<br>
SCL P33</td>
</tr>
<tr>
<td>2) LCD</td>
<td>SDA P25<br>
SCL P31<br>
RS P00<br>
Reset P01<br>
CS P02<br>
LED P34</td>
</tr>
<tr>
<td>3)  </td>
<td>P03</td>
</tr>
<tr>
<td>4) </td>
<td>P20</td>
</tr>
<tr>
<td>5) USB Vin (   USB)</td>
<td>P15</td>
</tr>
<tr>
<td>6) Vbat</td>
<td>P14/AIO3</td>
</tr>
<tr>
<td>7) Green LED (  )</td>
<td>P23</td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The display is standard (full on aliexpress) on the ST7735 with a resolution of 80 * 160. Powered by SPI. There are ready-made libraries for it, but it's better to make your own light version, for your font size and your own characters. The display is color, but this is not very relevant on the street, as low contrast (sadly remembered the transflective displays from Siemens phones). Yes, and tinted glass. We will use white color to display text, it is best seen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The touch button is made on a Tontec TTP233D-HA6 chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The accelerometer is unknown, but the scan of the I2C bus showed that it uses registers like all ST accelerometers. Most of all it is similar to LIS2DH12. It seems that all control registers correspond.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To display our information on the bracelet, we need our own BLE-service for data transfer. </font><font style="vertical-align: inherit;">Something like </font></font><abbr title="Serial port profile"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPP</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Additionally, you can add Battery Service and firmware update via BLE. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a basis for the project, we take an example of firmware for updating </font></font><abbr title="Over-the-air"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OTA</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and remake it to our needs. </font><font style="vertical-align: inherit;">Add a service for the battery. </font><font style="vertical-align: inherit;">To transfer data, you can use an example of implementing a custom service from the SDK. </font><font style="vertical-align: inherit;">It uses one service FF01 and in it one characteristic FF02.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b>
                        <div class="spoiler_text">   SDK     GPIO     0,   .    .       ,      .         ,     pull-up   pull-down (   100 )        .     .           40 ,    ¬´¬ª pull-down,    15  (     ).<br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We fasten the working services:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrupt handling by touch button. </font><font style="vertical-align: inherit;">In addition to turning on the screen and turning on / off the bracelet itself, we will make single and double tap recognition with the transmission of a command through our FF02 characteristic.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> output of data received from a smartphone through the same characteristic to the display.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">short inclusion of a vibromotor for drawing attention.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the accelerometer, turning on the screen with a sharp wave of the hand (it‚Äôs difficult to set up, because when you run, you wave your hands).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, the bracelet is ready. </font><font style="vertical-align: inherit;">We check through nRFConnect, it allows you to read and write the values ‚Äã‚Äãof the characteristics. </font><font style="vertical-align: inherit;">On the screen, the pulse, time, distance and another timer (for example, to display the time lag or lead the graph, i.e. a kind of pacemaker, but this can only be obtained from your application).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yw/15/c8/yw15c888j_n2kg56fpeuxwi0lim.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to take the data somewhere to transmit it. I currently use the Strava app, although I like it less and less. Perhaps the easiest way to get running time from her and the distance (though with rounding to 100 m) from notifications in the status bar. To do this, you need to write an application with a service for listening to notifications. This is not difficult. But we will read the pulse directly from the BLE or ANT + belt. Well, since we have notifications from the bracelet about pressing buttons, we need to use them somewhere. For example, you can, by sending messages through BroadCastReceiver, pause Strava and restart it. And it is better to someday make your Strava with bells and whistles. The application requires rights to access the location (this is necessary to work with BLE) and rights to access notifications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to verify the case. Unfortunately, the winter ended in February, so the cycle from the picture at the beginning of the article has already ended. But you can go for a run. The accelerometer often turns on the screen unnecessarily, maybe it should be turned off completely. A touch button can react to a drop that has fallen from the forehead.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vc/7c/go/vc7cgorhq8yuzwjdl2ju4oqhrpa.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ad/za/tt/adzattbhn-7hvqcxu0e55o55f88.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lu/er/lt/luerltdtedmppo1bwkiy4skyrhk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, the good news. </font><font style="vertical-align: inherit;">The bracelet already from the factory supports OTA update through the PhyApp application (it lies in the same place as the SDK, originally in Chinese). </font><font style="vertical-align: inherit;">Therefore, having ready-made firmware, even disassembling the bracelet is not required. </font><font style="vertical-align: inherit;">Flash and use. </font><font style="vertical-align: inherit;">To do this, you need to install the application, put the firmware in the ‚Äúroot‚Äù of the phone (HEX, not HEXF, since the latter contains the bootloader that we already have from the factory), connect to the bracelet and use the OTA button to upload the firmware to the bracelet. </font><font style="vertical-align: inherit;">After flashing the bracelet will be turned off, to turn it on you need to hold the button for 2 seconds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, watches and bracelets on the PHY62 can be easily converted to anything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
References:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source codes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and APK of an android application (it was written under Android 8.1, it seems to work under 9, it didn‚Äôt check under others);</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HEX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> firmware </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">file</font></a><font style="vertical-align: inherit;"> via BLE, and HEXF - for firmware via UART (I don‚Äôt mind the source, but I need to understand that I can upload it by license agreement and who doesn‚Äôt write in this special) + PhyApp firmware application for firmware OTA.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I bought a bracelet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but I can‚Äôt guarantee that the filling will be the same, because </font><font style="vertical-align: inherit;">a lot of the same in appearance, but with a different chip. </font><font style="vertical-align: inherit;">There are kind of options with a larger screen, which also have PHY6202. </font><font style="vertical-align: inherit;">In general, there are watches / bracelets with different chips (Phy +, Telink, and even nRF).</font></font><br>
</li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS In general, it looks like the SDK for PHY62 was created based on the Texas Instruments SDK for their BLE chips.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499758/index.html">Convenient architectural patterns</a></li>
<li><a href="../en499762/index.html">Upgrade your skills in DevSecOps: 5 webinars with theory and practice</a></li>
<li><a href="../en499764/index.html">XYZPrinting 3D Hand Scanner 2.0 3D Scanner Review</a></li>
<li><a href="../en499770/index.html">Learn while self-isolation</a></li>
<li><a href="../en499772/index.html">It will be very, very much: how 5G technology will change the advertising market</a></li>
<li><a href="../en499776/index.html">Features of the implementation of the MSH language</a></li>
<li><a href="../en499784/index.html">What touch virtual walls?</a></li>
<li><a href="../en499786/index.html">Weak heap sorting</a></li>
<li><a href="../en499788/index.html">Free online course "Technical documentation in IT projects"</a></li>
<li><a href="../en499792/index.html">Load Testing Atlassian Jira, Confluence, Bitbucket Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>