<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔃 ♋️ 👂🏼 早く行かなきゃ 高速IMAPメール同期 👍🏿 👷 🔠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは！イリヤです。 2年前、IMAPモバイルクライアントに参加しました。以前のバージョンのアプリケーションは、手紙のリストを長時間ダウンロードし、メールボックスの更新に多くのトラフィックを費やしていました。プロトコルでの作業の最適化と、このプロトコルの機能全般についての質問がありました。私はプ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>早く行かなきゃ 高速IMAPメール同期</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは！イリヤです。 2年前、IMAPモバイルクライアントに参加しました。以前のバージョンのアプリケーションは、手紙のリストを長時間ダウンロードし、メールボックスの更新に多くのトラフィックを費やしていました。プロトコルでの作業の最適化と、このプロトコルの機能全般についての質問がありました。私はプロトコルについて何も知らず、ドキュメントを読むことに突入しました。今までのところ、クライアントは中断することなくプロトコルを使用し、実装機能をまったく考慮していませんでした。これらの機能により、メールのダウンロードが2〜3倍高速になりました。 IMAPとは何か、そして私の記事の後半でそれを最適化するためのチップとは何かについて。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はプロトコルを深く掘り下げません。</font><font style="vertical-align: inherit;">「2年前にこの記事を読みたい」というカテゴリの記事ではありません。</font><font style="vertical-align: inherit;">IMAPの教祖は、自分のために新しい情報を見つけることはほとんどありません。</font><font style="vertical-align: inherit;">この記事は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコル記述に依存しています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー接続</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAPはステートフルプロトコルです。</font><font style="vertical-align: inherit;">これは、そのようなプロトコルを見たり操作したりする前は、私にとっては発見でした。</font><font style="vertical-align: inherit;">サーバーでの作業のスキームを検討してください。&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
順番に、そして最も重要なことは、例を挙げてみましょう。</font><font style="vertical-align: inherit;">まず、サーバーへの接続を作成する必要があります。</font><font style="vertical-align: inherit;">これを行うには、openSSLライブラリを使用します。</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続が確立され、CAPABILITY応答で始まる行でOK応答を観察できます。</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各CAPABILITY </font><font style="vertical-align: inherit;">には</font><font style="vertical-align: inherit;">便利な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チートシート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり、</font><font style="vertical-align: inherit;">可能なすべてのCAPABILITY値がRFCへのリンクとともに記述されています。</font><font style="vertical-align: inherit;">たとえば、IMAP4rev1は、サーバーがIMAP4標準に従って動作していることをクライアントに通知し、IDLEは、メールボックスで発生する変更をサブスクライブできることを通知します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー認証</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーに接続したら、メールボックスに移動する必要があります。</font><font style="vertical-align: inherit;">これは、LOGINコマンドを使用して行われます。</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それで、停止して、ログインして、理解しました。</font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たぶんあなたは尋ねます。</font><font style="vertical-align: inherit;">そして、これがチームタグです。</font><font style="vertical-align: inherit;">クライアントの利益のために、応答は要求と同じタグで到着するため、タグは異なる必要があります。これは、チーム間の解析のために一致させることができることを意味します。</font><font style="vertical-align: inherit;">サーバーは、* OKなど、最初にアスタリスクが付いた応答を返すこともできます。これはタグなし応答と呼ばれます。</font><font style="vertical-align: inherit;">基本的に、そのような回答は、たとえばLISTのように、応答に複数のエンティティがあることを期待するチームに対して返されます。&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダリストリクエスト</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォルダー内のレターのリストを要求するには、まずこれらのフォルダーを見つける必要があります。</font><font style="vertical-align: inherit;">これは、LISTコマンドによって行われます。</font><font style="vertical-align: inherit;">このコマンドは、サーバー上のフォルダーのリストを返します。</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST «» *<font></font>
* LIST (\HasNoChildren \Trash) «/» Trash<font></font>
* LIST (\HasNoChildren \Sent) «/» Sent<font></font>
* LIST (\HasNoChildren \Drafts) «/» Drafts<font></font>
* LIST (\HasNoChildren \Junk) «/» Junk<font></font>
* LIST (\HasNoChildren) «/» INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドの最初のパラメーターは名前空間です。サーバーが名前空間をサポートしている場合、NAMESPACEクエリを使用してその値をリクエストできます。標準の名前空間は空の文字列のように見えます。次に、wildcardsパラメータが機能します。これにより、返す必要のあるフォルダーをサーバーに通知できます。たとえば、上の例のように、フォルダツリーのブランチ、ルートのみ、またはすべてだけを取得できます。ユーザーがボックスに持っているフォルダの数を誰が知っているので、これを行わない方が良いでしょう。プロトコルの作成者は「％」の使用を推奨しています-この場合、メールボックスからすべてのトップレベルのフォルダーを取得します。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答から、これはタグの付いていない回答であり、各行がボックス内のフォルダーであることがわかります。</font><font style="vertical-align: inherit;">最初は、フォルダーのメタ情報を読み取るためのフラグがあります。たとえば、この例では、すべてのフォルダーに子孫がなく、いくつかの特別な目的のフォルダー（ゴミ箱、ジャンクなど）があります。</font><font style="vertical-align: inherit;">次に、フォルダー区切り文字があります。</font><font style="vertical-align: inherit;">この記号はサブフォルダーに使用されます。</font><font style="vertical-align: inherit;">たとえば、ゴミ箱フォルダの子孫の場合、名前は「ゴミ箱/新しいフォルダ」のようになります。</font><font style="vertical-align: inherit;">すべてのフォルダーの後、サーバーは、コマンドに割り当てたタグとこのコマンドの実行時間とともにOKを返します。&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダの選択</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらにこのスキームによれば、メッセージを厳しくするフォルダを選択する必要があります。</font><font style="vertical-align: inherit;">これは、SELECTコマンドを使用して行われます。</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォルダを選択すると、そのフォルダに関するすべての情報が返されます。</font><font style="vertical-align: inherit;">順番に行きましょう。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手紙のフォルダー内で許可されているフラグで答えます。&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントが永久に変更できることを示すフラグで回答する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダ内の文字数で返信する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">答えは最近の手紙の数、つまりフォルダの選択の間に受け取ったものです</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未読メッセージの数で返信する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、今のところ、これについて考えましょう。</font><font style="vertical-align: inherit;">私たちが必要としない残りの情報。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手紙をリクエストする</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今最も興味深いのは手紙の要求です。</font><font style="vertical-align: inherit;">ここでは、特にモバイルクライアントでは、非常に注意する必要があります。</font><font style="vertical-align: inherit;">同意します。アプリケーションにアクセスしたときに、サーバーからデータベースに何千ものメッセージを受信することはまずありません。</font><font style="vertical-align: inherit;">さらに、たとえばすべての文字のリストを表示することは現実的ではない可能性があるため、文字全体をダウンロードしても意味がありません。</font><font style="vertical-align: inherit;">たとえば、ユーザーレターをすばやく表示するために、「エンベロープ」のみを要求します。</font><font style="vertical-align: inherit;">このエンベロープでは、送信者、受信者、手紙の件名、および送信日を確認します。</font><font style="vertical-align: inherit;">最初の10件の投稿を読み込みます。</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コロンは、受信する文字数のセグメントを列挙し、括弧内にこれらの文字から読み取るもの、この場合は文字のエンベロープを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答を省略形で示します。</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何もはっきりしていないことは明らかです。</font><font style="vertical-align: inherit;">そして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なのは、エンベロープ形式が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">RFC 2822</font></a><font style="vertical-align: inherit;">によって規定され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">いるということです。この記事ではそれを考慮しません。</font><font style="vertical-align: inherit;">このエンベロープには、必要なすべての情報（手紙の受領日、手紙の件名、送信者、受信者、さらにはmessageId）が含まれています。</font><font style="vertical-align: inherit;">彼のクライアントは会話を表示するために使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、ユーザーに手紙に関する基本的な情報を示すことができましたが、本文はどうですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイズに関係なく、手紙の本文全体をすぐにダウンロードできます。もちろん、これは長くはありませんが、ネットワークとメモリのコストがかかります。</font><font style="vertical-align: inherit;">ちなみに、これは同じFETCHコマンドで行われます。&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信トレイでそのようなコマンドを試してみてください。10通のメッセージがあっても、手紙に関するすべての情報を含むかなり大量の応答が返ってきても、「高額」という意味を理解できます。彼女と言えば。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手紙のソースを元の形式でどのように表示するかを確認するために、知っているクライアントで手紙のソースをダウンロードした頻度はどれくらいですか。そうでない場合は、テストレターを取得しましょう。その中で、私は手紙に直接絵を添え、絵を添付ファイルとして加えました。 eml形式で保存してから、任意のテキストエディターで開きます。クライアントによって、手紙の出所は異なりますが、一般的には同じです。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電子メールのヘッダーから始めましょう：</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=»--=_Part_722_554093397.1567975288»<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのメタ情報は、メッセージのコンテンツの種類、件名、優先度など、レターのヘッダーに、誰から、いつ、誰に、いつ送信されるかが記載されています。</font><font style="vertical-align: inherit;">境界フィールドは、文字の境界を示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが何を意味するかをさらに理解してください。</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=»--=_Part_583_946112260.1567975288»<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=»--=_Part_881_599167713.1567975288»<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D«font-family: XO Tahion; font-size: 16px; direction: ltr»&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=«2018-09-04 22.46.36.jpg»<font></font>
Content-Disposition: inline; filename=«2018-09-04 22.46.36.jpg»<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各境界線は、通常の文章の境界線です。</font><font style="vertical-align: inherit;">2つのハイフン「-」で始まります。</font><font style="vertical-align: inherit;">終了ボーダーの最後にこれら2つのハイフンがあります。</font><font style="vertical-align: inherit;">これは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC1341で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">詳細に説明されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます。</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
これは手紙の主要部分と呼ぶことができ、手紙の一部とそのMIMEタイプがここで説明されています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIMEタイプについて</font></font></b><div class="spoiler_text">MIME-   ,     MIME (<i>Multipurpose Internet Mail Extensions) </i>     email .&nbsp;<br>
<br>
<ul>
<li>multipart/mixed         ,             .&nbsp;</li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここには単純なテキストがないので、html表現を使用する方がより論理的です。このhtmlプレゼンテーションには、Content-Disposition：インラインパラメータを持つ画像のみがあります。つまり、添付されたドキュメントではなく、手紙の本文に直接配置されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この画像へのリンクはかなり単純ではありません。これは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と等しいContent-IDパラメーターによって記述されます</font><font style="vertical-align: inherit;">。これは手紙の次の部分へのリンクです-base-64でエンコードされた画像。私の神経を救うために、私はすべてのbase-64コードを含めませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手紙の最後の部分は&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Disposition: attachment; filename=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上の画像のように、インラインではなくContent-Dispositionが既にアタッチされています。</font><font style="vertical-align: inherit;">この画像はbase-64でエンコードされていてサイズが大きいため、添付ファイルパネルに移動する必要があります。</font><font style="vertical-align: inherit;">ここで、基本的な情報のみを表示したい場合は、レターの本文全体を再度ロードしてはならないことが明らかになりました。&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルに戻る</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字を操作した後、選択したフォルダーを閉じ、サーバーに別れを告げる必要があります。</font><font style="vertical-align: inherit;">フォルダを閉じるには、CLOSEコマンドを入力する必要があります。</font><font style="vertical-align: inherit;">はい、とても簡単です</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、あなたが私と並行してコンソールを操作して記事を読んだ場合、それほど好ましくないイベントが発生し、サーバーがタイムアウトによって接続を閉じる可能性があります。</font><font style="vertical-align: inherit;">これは完全に正常であり、各サーバーには独自のタイムアウトがあります。たとえば、30分です。&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、バックグラウンドでNOOPコマンドを実行することをお勧めします</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字通り何もしませんが、必要なだけタイムアウトなしで接続を維持できます。</font><font style="vertical-align: inherit;">現在フォルダーを選択している場合、NOOPはこのフォルダーへの変更に対する定期的な要求として機能します。&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この応答では、2つの削除されたメッセージ、1つは新しいメッセージ、およびこのフォルダー内のメッセージ数は16 472であることが通知されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ここで選択できるフォルダーは1つだけなので、並行して作業することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、最後に、サーバーとのセッションを閉じます。これで、別れを告げます。</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグ付けされていない悲しいBYEの回答が表示されます。つまり、仕事を終える番です。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONDSOTOREおよびQRESYNCとのクイック同期</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NOOP操作を使用して、選択したフォルダー内のボックスの変更を追跡できます。しかし、別のフォルダで作業しているときにフォルダの変更点を知りたい場合はどうでしょうか。最も明白なオプションは、ローカルストレージのすべての文字を、それがキャッシュであろうとデータベースであろうとソートし、サーバーが返すものと比較することです。一方では、これは実際に解決策であり、一部のサーバーでは文字通り唯一の真のソリューションになります。一方、プロトコルが一般的に許す限りの速さで文字を表示したいと考えています。幸いなことに、私たちのサーバーは、このようなに追加されたCONDSTOREとQRESYNC、などのプロトコルの拡張機能をサポート</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。最初のものは、メッセージとフォルダーに特別な63ビットの数値を追加します。これはmod-sequenceと呼ばれ、この文字に対する操作ごとに増加します。すべてのメッセージの中で最も高いmodシーケンスがフォルダーに追加されます。その結果、CONDSTOREをサポートするサーバー上のフォルダーに接続するたびに、ローカルフォルダーとサーバーフォルダーのmodシーケンス値を比較するだけで、何かが変更されたかどうかを簡単に確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、この拡張機能は、STOREおよびFETCHコマンドの追加パラメーター-CHANGEDSINCE mod-sequenceおよびUNCHANGEDSINCE mod-sequenceを追加します。これらにより、送信されたメッセージのmod-sequenceがそれぞれこれよりも大きい場合や小さい場合に操作を実行できます。例を見てみましょう。</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はメールボックスにアクセスし、それについて以前に何も知らなかった状況をシミュレートしました。つまり、ローカルのmodシーケンスは0です。ご覧のように、サーバーは通常、メールボックスにあるすべてのメッセージを返します。箱について何も知りません。 CHANGEDSINCEからのUID文字のリクエストに応じて、タグなしの応答OKには、今保存するHIGHESTMODESEQと、メッセージごとにMODSEQが付属しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メールボックスでいくつかの操作を</font><font style="vertical-align: inherit;">実行</font><font style="vertical-align: inherit;">します：新しい文字の追加、フラグの変更。新しいリクエストを作成しましょうが、以前のmod-sequenceを使用します</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すでに違いがわかります。到着したばかりの古いコミュニティと新しいコミュニティを出力する代わりに（17221のアスタリスク：*は、番号17221から可能な限り最大の文字を受け取ることを意味します）、MODSEQが前のものよりも大きい文字を受け取ります。これは、すべての可能な文字を試すのではなく、しばらくの間使用していないフォルダを同期し、変更された文字の一種のキャストを取得するのに非常に役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それははるかに良いと思われるでしょうか？しかしQRESYNCを使用すると、同期操作がさらに高速になり、フォルダーの選択中にMODSEQパラメーターと既知のメッセージUIDを指定できます。例を挙げて説明しましょう。まず、ENABLEコマンドでQRESYNCを有効にする必要があります。&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前はフォルダーについて何も知らなかったので、サーバーはフォルダーに関する情報のみを返し、変更のナゲットはありません。最初の20件のメッセージを尋ねて、それらのUIDとHIGHESTMODESEQも覚えていたとします。フォルダーを離れ、メッセージを送信し、メッセージを削除し、フラグを変更して、フォルダーに関する過去の情報を返します</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、変更されたフォルダーを選択すると、削除されたメッセージにはVANISHED（EARLIER）の応答、追加または変更されたメッセージにはFETCHの形式で、変更のナゲットをすぐに取得します。ユーザーが長時間アクセスしていない場合でも、フォルダを同期するのがさらに簡単になりました。キャッシュにローカルに保存されている大量のメッセージがあり、それらをサーバー上のメッセージと比較したくない場合、これは非常に優れた方法です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリクエストの最初のパラメーターはUIDVALIDITYです。これは、基本的に、以前に受け取ったuidがフォルダー内で変更されていないことを確認するために使用されます。これは、サーバーがすべてのメッセージのセッションuidをセッションからセッションに変更した場合、またはフォルダが削除され、同じ場所に同じ名前のフォルダが作成された場合に発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のパラメーターは既知のHIGHESTMODSEQであり、最後のパラメーターは既知のUIDの間隔です。間隔が連続しているか、コンマで区切られている場合、それらはコロンとして記述できます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の例では、対象領域を知らないと、アプリケーションが正しくなく、最適ではない状態で動作する状況に遭遇しました。</font><font style="vertical-align: inherit;">この記事では、プロトコルを使用するために考えられるすべてのオプションについては取り上げませんでした。</font><font style="vertical-align: inherit;">しかし、IMAPクライアントの次の開発者に、上記の情報が役立つことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAPには興味深いものがたくさんあります。</font><font style="vertical-align: inherit;">迅速な同期のためのコマンドはほんの始まりにすぎません。実際、サーバーの機能に応じてさまざまなIMAPコマンドをさらに最適化し、メールの処理をより高速に、ネットワークとメモリをより経済的に、そして一般的に快適にすることができます。</font><font style="vertical-align: inherit;">しかし、これについては後で話します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492058/index.html">ROS2 vs ROS1。Ubuntu 18.04へのROS2のインストール</a></li>
<li><a href="../ja492060/index.html">の解き方？「ECONNREFUSED-サーバーによって接続が拒否されました」</a></li>
<li><a href="../ja492062/index.html">Golangバックエンドサーバーテンプレート-パート1（HTTPサーバー）</a></li>
<li><a href="../ja492066/index.html">イベントソーシングがマイクロサービス相互作用のアンチパターンである理由</a></li>
<li><a href="../ja492068/index.html">S7グループ、MIPTに「航空における情報技術」部門を開設</a></li>
<li><a href="../ja492076/index.html">Javaの六角形アーキテクチャの例</a></li>
<li><a href="../ja492078/index.html">コロナウイルスCOVID-19の最も重要で有用な資料</a></li>
<li><a href="../ja492082/index.html">ホームデバイスの管理を簡略化してセキュリティで保護する方法（カウリセーフスマートホームに関するアイデアを共有する）</a></li>
<li><a href="../ja492086/index.html">コロナウイルス対ロシアのITビジネス：企業は従業員を遠隔地に移動する準備ができていますか？</a></li>
<li><a href="../ja492088/index.html">Amazon Lumberyardゲームエンジンをテストします。アプローチとツール</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>