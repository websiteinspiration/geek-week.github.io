<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçü§ù‚Äçüë®üèª üî∑ üèüÔ∏è Todas las etapas de la creaci√≥n de un robot para seguir la l√≠nea, o c√≥mo recolectar todos los rastrillos con STM32 üñïüèæ üï† üôçüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 
 
 Esta publicaci√≥n discutir√° mi experiencia en la creaci√≥n de un robot para competiciones, es decir, seguir la l√≠nea. Intentar√© contar to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Todas las etapas de la creaci√≥n de un robot para seguir la l√≠nea, o c√≥mo recolectar todos los rastrillos con STM32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497782/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta publicaci√≥n discutir√° mi experiencia en la creaci√≥n de un robot para competiciones, es decir, seguir la l√≠nea. </font><font style="vertical-align: inherit;">Intentar√© contar todas las etapas desde el dise√±o de los circuitos y el pedido de una placa de circuito impreso hasta un algoritmo y un programa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carrera de robots a lo largo de la l√≠nea ha sido durante mucho tiempo una prueba b√°sica para la rob√≥tica principiante. </font><font style="vertical-align: inherit;">Casi todas las competiciones regionales e internacionales incluyen esta direcci√≥n, por lo que al hacer un robot puedes participar en casi todas partes. </font><font style="vertical-align: inherit;">En el primer a√±o de universidad, esta fue la siguiente tarea despu√©s del primer parpadeo del LED.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulaci√≥n del problema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier desarrollo comienza con una tarea t√©cnica, en nuestro caso, las regulaciones de competencia de las competencias de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robofinist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se utilizan como TK </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Estamos interesados ‚Äã‚Äãen los requisitos de dimensiones (no m√°s de 25x25x25 cm) y el peso del robot (no m√°s de 1 kg), as√≠ como la forma de la pista y su ancho 1.5 cm. Dependiendo de la complejidad de la pista, se establece un umbral para el tiempo m√≠nimo que tarda en pasar (60 segundos). ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea es clara, necesitamos un robot capaz de detectar una l√≠nea y conducirla de principio a fin en un tiempo m√≠nimo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dise√±o conceptual</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El n√∫cleo del robot es el microcontrolador STM32F103C8T6, lee la informaci√≥n de seguimiento utilizando sensores √≥pticos QRE1113 y controla los motores a trav√©s del controlador A3906. Para mayor claridad, cada sensor tiene asignado su propio LED, tan pronto como el sensor "ve" la l√≠nea negra, el LED se ilumina, esto simplifica enormemente el proceso de depuraci√≥n. Como fuente de alimentaci√≥n, se eligi√≥ una bater√≠a Li-po tipo 18650 con un voltaje de 3.7 V y un chip de carga LTC4054ES5. Pero para el correcto funcionamiento de los motores, se necesitan al menos 6 V, por lo tanto, instal√© el convertidor elevador de voltaje DC-DC LM2577 y el LM1117 lineal de 3.3 V para suministrar la parte l√≥gica.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/aa5/0a0/ddf/aa50a0ddf75671c4ee28137f1fbf8c47.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es hora de hablar sobre los primeros errores. Sin prestar atenci√≥n mezcl√© un par de pines de alimentaci√≥n del microcontrolador y al inicio pas√© varias horas buscando un problema, como resultado tuve que morderlos. Entonces surgi√≥ el problema de que no todos los sensores reaccionaron a la l√≠nea, mi primera reacci√≥n fue que quem√© el microcontrolador o que las patas rotas de la fuente de alimentaci√≥n en la √∫ltima etapa no eran en absoluto superfluas, o que sold√© mal los contactos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando un osciloscopio, descubr√≠ que el problema estaba en los sensores mismos, de los 10 sensores 4 no funcionaban, reemplaz√°ndolos por otros nuevos apareci√≥ el siguiente problema: tres LED indicadores PB3, PB4 y PA15 no funcionaron. Despu√©s de reescribir y revisar todo mi c√≥digo, no pude encontrar ninguna diferencia en la inicializaci√≥n de los puertos que no funcionaban y que funcionaban en todas partes: Push Pull, 10 MHz y reloj habilitado. Despu√©s de mirar el oscilograma, not√© que un pin estaba atra√≠do por la ventaja e incluso en modo de depuraci√≥n no se restableci√≥ en absoluto, me di cuenta de que el microcontrolador estaba quemado. Al cerrar la hoja de datos, not√© que, por una extra√±a coincidencia, estos pines se usan para JTAG, y uso SWD, pero habiendo decidido que no empeorar√≠a, comenc√© a buscar en Google c√≥mo deshabilitar JTAG y realmente ayud√≥ (ver m√°s abajo).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mini conclusi√≥n, verifique la nutrici√≥n correcta en todas las etapas para que no piense que algo se quem√≥ m√°s tarde o que no funciona por otros motivos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo que hay que mejorar en el esquema</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adivin√© poner el chip de carga, pero olvid√© la descarga, aunque no es menos importante, adem√°s, en 2020 puse un mini USB en lugar del tipo C. Me gustar√≠a usar el microcontrolador para controlar la carga de la bater√≠a, pero no ten√≠a ning√∫n pin ADC. </font><font style="vertical-align: inherit;">Al elegir un controlador, confi√© en las caracter√≠sticas del motor de 6 V y 700 mA, pero no tom√© en cuenta que su voltaje m√°ximo es de 9 V, pero me gustar√≠a 12 V.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dise√±o de PCB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, se decidi√≥ determinar el tama√±o y la forma del PP y la plataforma a tiempo parcial del robot. Recordamos que de acuerdo con las regulaciones, las dimensiones no deben exceder los 25x25 cm, pero tambi√©n vale la pena considerar que al ordenar software en una f√°brica (PCBWay) en China, los tableros de m√°s de 10x10 cm aumentan significativamente su precio. Creo que la elecci√≥n de las dimensiones es obvia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, debe distribuir los sensores sim√©tricamente (en la parte inferior del tablero), teniendo en cuenta el ancho de l√≠nea y luego los elementos m√°s pesados, como los motores y la bater√≠a. Los LED est√°n montados en el mismo eje que los sensores correspondientes, en el lado opuesto de la placa. Para mayor comodidad, instalamos un interruptor de alimentaci√≥n y un conector de carga de bater√≠a en la parte posterior de la plataforma. Los elementos restantes se colocan m√°s cerca del centro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de cortar los bordes vac√≠os del tablero en lugar de un cuadrado, se obtiene una imagen completamente decente de la plataforma del robot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tablero result√≥ ser bastante simple debido a la peque√±a cantidad de elementos √∫nicos. </font><font style="vertical-align: inherit;">Total 2 capas m√≠nimo espesor de v√≠a 0.25 mm. </font><font style="vertical-align: inherit;">Habiendo guardado la placa base en el formato Gerber, la envi√© a la f√°brica seleccionando el color blanco de la m√°scara, luego no tuve ning√∫n problema especial. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/57e/f74/2c8/57ef742c8e35e324720908b0758200cc.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y una vista en 3D del tablero con los elementos. </font><font style="vertical-align: inherit;">La foto en vivo estar√° al final.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/37f/a8b/65d/37fa8b65d80595744c2e2436490b304e.jpg" alt="imagen"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo que necesita ser finalizado en el tablero</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal√© algunos elementos demasiado cerca de la carcasa de pl√°stico de la bater√≠a y fue dif√≠cil soldarlos, y a√∫n m√°s dif√≠cil de soldar. </font><font style="vertical-align: inherit;">Olvid√© firmar el pinout del conector de programaci√≥n SWD, UART y motores, como resultado, tengo que mirar dentro del circuito.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compra de componentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El desarrollo de todo lo nuevo requiere los costos relativos m√°s altos por unidad de bienes, puede y debe intentar ahorrar, pero dentro de l√≠mites razonables, por lo que al ordenar sensores de l√≠nea para Aliexpress 4.5 veces m√°s baratos que en una tienda de productos electr√≥nicos, pagu√© por el hecho de que aproximadamente el 40% de ellos resultaron ser no funciona, y este es el momento de buscar y corregir errores. </font><font style="vertical-align: inherit;">Por otro lado, no quer√≠a comprar el chip LM2577 por 460 rublos, mientras que el m√≥dulo con todos los flejes cuesta 100 rublos. </font><font style="vertical-align: inherit;">Ped√≠ parte de las partes a Ali, otra parte en una tienda local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√°n mis costos estimados de componentes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Motores y ruedas - 800 rublos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bater√≠a y estuche - 400 rublos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cargador - 300 rublos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontrolador y controlador - 200 rublos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estabilizadores - 400 rublos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarifas 10 unidades con entrega 2400/10 = 240 rublos por unidad;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resto del arn√©s - 150 rublos.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4650 rublos de costos totales para componentes, o 2490 si resta el precio de las nueve placas restantes sin usar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: comenc√© a calcular el costo de la instalaci√≥n de tableros y componentes y por lote de 10 unidades. </font><font style="vertical-align: inherit;">El precio aument√≥ a 16,000 rublos. </font><font style="vertical-align: inherit;">Hay ideas sobre c√≥mo optimizar, pero este es otro momento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo implementado es el m√°s simple, si la l√≠nea result√≥ ser, por ejemplo, en el lado derecho, el motor derecho comenzar√° a disminuir la velocidad y cuanto m√°s se acerque la l√≠nea al borde, m√°s lento funcionar√° el motor, hasta que se detenga por completo, mientras que el motor izquierdo funcionar√° a la velocidad m√°xima tratando de girar hacia la l√≠nea. </font><font style="vertical-align: inherit;">Una situaci√≥n similar si la l√≠nea est√° en el lado izquierdo. </font><font style="vertical-align: inherit;">Por lo tanto, el robot intenta estabilizarse, devolviendo la l√≠nea a los sensores centrales.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22b/07d/9ab/22b07d9ab0c0795c33cda8c42236e18f.jpg" alt="imagen"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo en im√°genes</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ae3/234/6c5/ae32346c5611292cf0b7fc155317da5a.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b47/403/545/b47403545480435eed6c7b362dbad0bd.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5d8/55b/68c/5d855b68c11937aa1196d6d281c5c939.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/481/545/42c4815453ca35de5c6dc32570e09506.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/587/7ee/4db/5877ee4db1610d2aab5ace1af4cd27b3.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n es necesario prever otras situaciones, por ejemplo, si todos los sensores han detectado una l√≠nea, esto probablemente significa que estamos cruzando la intersecci√≥n y es probable que tengamos que avanzar m√°s. </font><font style="vertical-align: inherit;">O si solo los sensores extremos detectaron la l√≠nea, entonces llegamos a la l√≠nea de meta y tenemos que parar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta etapa, debes obtener una pandereta y golpearla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribi√≥ en Atollic True Studio us√≥ solo CMSIS y FreeRTOS. Pas√≥ media semana para iniciar FreeRTOS, hizo todo de acuerdo con las instrucciones, pero detect√≥ errores durante el proceso de compilaci√≥n, corrigi√≥ 1, 63 aparecieron o no hubo errores, pero el controlador se bloque√≥. En alg√∫n momento, me di cuenta de que el nivel de mi mano ... alcanz√≥ alturas sin precedentes y era hora de pensar en lo que estaba haciendo y lo que estaba haciendo. Gracias a camaradas de la comunidad, comenc√© a cavar en la direcci√≥n correcta y de muchas fuentes redibujadas encontr√© varias que me ayudaron (ver m√°s abajo). Como resultado, logr√© derrotar a FreeRTOS y hasta ahora lo he usado al 0%, porque met√≠ todo en una tarea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> me ayudaron m√°s </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema de temporizaci√≥n, aqu√≠ todav√≠a no estoy seguro de si funciona como deber√≠a. Despu√©s de sintonizar la frecuencia del sistema a trav√©s de PLL a 48 MHz, vi 24 MHz (/ 2) en el pie de la MCO, no, vi una se√±al de 22-25 MHz remotamente parecida a un seno. Al mismo tiempo, configur√© 48 MHz en la configuraci√≥n de FreeRTOS y configur√© el retraso en 500 ms y lo ejecut√©, vi que mis 500 ms se convirtieron en 300, pas√© por todas las configuraciones posibles, not√© que obtengo el objetivo de 500 ms solo cuando se sincroniza desde el generador interno a 8 MHz, y el valor de frecuencia La configuraci√≥n de FreeRTOS no afect√≥ en absoluto, establezca 1 Hz y 48 GHz. Decid√≠ devolver 48 MHz y trabajar con 300 ms, despu√©s de lo cual accidentalmente reinici√© True Studio y funcion√≥ maravillosamente como pensaba, y desde el principio ya indiqu√© todas las rutas de archivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema de JTAG y LED, descrito anteriormente, la soluci√≥n se encontr√≥ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y solo necesita deshabilitarlo, liberando as√≠ el acceso a los pines PB3, PB4 y PA15.</font></font><br>
<br>
<pre><code class="cpp hljs">AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estructura del proyecto es aproximadamente la siguiente:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mucho c√≥digo</font></font></b>
                        <div class="spoiler_text">1.   ;<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{						<span class="hljs-comment">// Quartz 16 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLXTPRE;	<span class="hljs-comment">// PLLXTPRE set divider (/2) = 8 MHz</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_HSEON;			<span class="hljs-comment">// On HSE</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_HSERDY)) {<font></font>
	};<font></font>
<font></font>
	RCC-&gt;CFGR |= (RCC_CFGR_PLLMULL6);     <span class="hljs-comment">// Setup PLLMULL set multiplier (x6) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLSRC;		<span class="hljs-comment">// PLLSRC set HSE</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_PLLON;			<span class="hljs-comment">// ON PLL</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_PLLRDY)) {<font></font>
	};<font></font>
<font></font>
	FLASH-&gt;ACR &amp;= ~FLASH_ACR_LATENCY;	<span class="hljs-comment">// Setup FLASH</span><font></font>
	FLASH-&gt;ACR |= FLASH_ACR_LATENCY_1;<font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_HPRE_DIV1; 	<span class="hljs-comment">// Set not divider (AHB) = 48 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE1_DIV2; 	<span class="hljs-comment">// Set divider (/2) (APB1) = 24 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE2_DIV1; 	<span class="hljs-comment">// Set not divider (APB2) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR &amp;= ~RCC_CFGR_SW; 		<span class="hljs-comment">// Setup SW, select PLL</span><font></font>
	RCC-&gt;CFGR |= RCC_CFGR_SW_PLL;<font></font>
<font></font>
<span class="hljs-comment">//	RCC-&gt;CFGR |= RCC_CFGR_MCO_SYSCLK;</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
2.  ,      ,     ,      Push Pull;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GPIO_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB2ENR |=	(RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN); <span class="hljs-comment">// Enable clock portA, portB and Alternative function</span><font></font>
<font></font>
	AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;	<span class="hljs-comment">// Disable JTAG for pins B3,B4 and A15</span><font></font>
<font></font>
	<span class="hljs-comment">//---------------LED: (B3 to B9; A11, A12, A15); Output mode: Push Pull, max 10 MHz---------------//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE3_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE4_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup B4 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE5_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup B5 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE6_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup B6 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE7_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);	<span class="hljs-comment">// Setup B7 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF9 | GPIO_CRH_MODE9);	<span class="hljs-comment">// Setup B8 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE9_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF11 | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup A11 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE11_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);	<span class="hljs-comment">// Setup A12 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE12_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF15 | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup A15 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE15_0;<font></font>
<font></font>
	<span class="hljs-comment">//--Motors: (A8 to A10; B12 to B15); Output and input (B12, B13) mode: Alternative function, PWM - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);		<span class="hljs-comment">// Setup B12 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13);		<span class="hljs-comment">// Setup B13 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF14   | GPIO_CRH_MODE14);	<span class="hljs-comment">// Setup B14 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  GPIO_CRH_MODE14_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF15   | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup B15 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF15_1 | GPIO_CRH_MODE15_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF9    | GPIO_CRH_MODE9);		<span class="hljs-comment">// Setup A9 pins PP, AF, 10MHz</span><font></font>
	GPIOA-&gt;CRH |=  (GPIO_CRH_CNF9_1  | GPIO_CRH_MODE9_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF10 | GPIO_CRH_MODE10);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE10_0;<font></font>
<font></font>
	<span class="hljs-comment">//--UART3: (B10 - TX; B11 - RX); Output mode: Alternative function, UART - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10   | GPIO_CRH_MODE10);	<span class="hljs-comment">// Setup B10 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF10_1 | GPIO_CRH_MODE10_0);<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF11   | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup B11 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF11_1 | GPIO_CRH_MODE11_0);<font></font>
<font></font>
	<span class="hljs-comment">//--Optical sensors: (B0, B1, A0 - A7); Input mode: Analog--//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup B0 pins analog input</span>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup B1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup A0 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup A1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF2 | GPIO_CRL_MODE2);	<span class="hljs-comment">// Setup A2 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup A3 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup A4 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup A5 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup A6 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup A7 pins analog input</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
3.       DMA,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ADC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	 RCC-&gt;AHBENR |= RCC_AHBENR_DMA1EN;<font></font>
	 DMA1_Channel1-&gt;CPAR = (<span class="hljs-keyword">uint32_t</span>) &amp;ADC1-&gt;DR;		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CMAR = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>) adc_buf;   	<span class="hljs-comment">//    </span><font></font>
<font></font>
	 DMA1_Channel1-&gt;CNDTR = <span class="hljs-number">10</span>;			  				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;			   		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MSIZE_0;		  		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_PSIZE_0;		 		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MINC;			  	<span class="hljs-comment">// memory increment mode</span><font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_CIRC;<font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_TCIE;				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;				  	<span class="hljs-comment">//  </span>
	 NVIC_SetPriority(DMA1_Channel1_IRQn, <span class="hljs-number">10</span>);<font></font>
	 NVIC_EnableIRQ(DMA1_Channel1_IRQn);<font></font>
<font></font>
	 RCC-&gt;CFGR &amp;= ~RCC_CFGR_ADCPRE;<font></font>
	 RCC-&gt;CFGR |= RCC_CFGR_ADCPRE_DIV8;<font></font>
	 RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN;<font></font>
<font></font>
	 ADC1-&gt;SQR3 = <span class="hljs-number">0</span>;			<span class="hljs-comment">// 1</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 2     </span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 3</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 4</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">20</span>;		<span class="hljs-comment">// 5</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">5</span> &lt;&lt; <span class="hljs-number">25</span>;		<span class="hljs-comment">// 6</span>
	 ADC1-&gt;SQR2 = <span class="hljs-number">6</span>;			<span class="hljs-comment">// 7</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">7</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 8</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 9</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 10</span><font></font>
<font></font>
	 ADC1-&gt;CR2 = ADC_CR2_EXTSEL_0 | ADC_CR2_EXTSEL_1 | ADC_CR2_EXTSEL_2<font></font>
	 | ADC_CR2_EXTTRIG;<font></font>
	 ADC1-&gt;SMPR1 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//   </span>
	 ADC1-&gt;SMPR2 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//</span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 0,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">1</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 1,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">2</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 2,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">3</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 3,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">4</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 4,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 5,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">6</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 6,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">7</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 7,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">8</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 8,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">9</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 9,   6 </span>
	 ADC1-&gt;SMPR1 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 10,   6 </span><font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_RSTCAL;<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_RSTCAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_CAL;<font></font>
<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_CAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;SQR1 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">20</span>;						<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR1 |= ADC_CR1_SCAN;					<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR2 |= ADC_CR2_DMA;				  	<span class="hljs-comment">// DMA on</span>
	 <span class="hljs-comment">// ADC1-&gt;CR2 |= ADC_CR2_CONT;</span><font></font>
<font></font>
	 <span class="hljs-comment">//  ADC1-&gt;CR2 |= ADC_CR2_SWSTART;</span><font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
}<font></font>
</code></pre><br>
4.        ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"></a>;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM1_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	<span class="hljs-comment">/*************** Enable TIM1 (CH1) ***************/</span><font></font>
	RCC-&gt;APB2ENR |= RCC_APB2ENR_TIM1EN;<font></font>
	TIM1-&gt;CCER = <span class="hljs-number">0</span>;										<span class="hljs-comment">//  CCER ( )</span>
	TIM1-&gt;ARR = <span class="hljs-number">1000</span>; 									<span class="hljs-comment">//  ,     </span>
	TIM1-&gt;PSC = <span class="hljs-number">48</span> - <span class="hljs-number">1</span>;                					<span class="hljs-comment">// </span>
	TIM1-&gt;BDTR |= TIM_BDTR_MOE;     					<span class="hljs-comment">//     </span><font></font>
<font></font>
	TIM1-&gt;CCR2 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= (TIM_CCER_CC2P |TIM_CCER_CC2E); 		<span class="hljs-comment">//        </span>
														<span class="hljs-comment">//   -   3</span>
	TIM1-&gt;CCR3 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= TIM_CCER_CC3NE; 						<span class="hljs-comment">//        </span><font></font>
	TIM1-&gt;CCER &amp;= ~TIM_CCER_CC3NP;<font></font>
<font></font>
	TIM1-&gt;CR1 |= TIM_CR1_CEN;<font></font>
}<font></font>
</code></pre><br>
5.  UART  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"> </a>     ;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB1ENR |= RCC_APB1ENR_USART3EN;<font></font>
<font></font>
	USART3-&gt;BRR = <span class="hljs-number">0xD0</span>;						<span class="hljs-comment">// Speed = 115200; (24 000 000 + (115200 / 2)) / 115200 = 208 -&gt; 0xD0</span><font></font>
<font></font>
	USART3-&gt;CR1 |= USART_CR1_TE | USART_CR1_RE | USART_CR1_UE;<font></font>
<font></font>
<span class="hljs-comment">//	USART3-&gt;CR1 |= USART_CR1_RXNEIE;</span>
<span class="hljs-comment">//	NVIC_EnableIRQ(USART3_IRQn);</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send</span><span class="hljs-params">(<span class="hljs-keyword">char</span> chr)</span> </span>{
	<span class="hljs-keyword">while</span> (!(USART3-&gt;SR &amp; USART_SR_TC))<font></font>
		;<font></font>
	USART3-&gt;DR = chr;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_String</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* str)</span> </span>{
	<span class="hljs-keyword">uint8_t</span> i = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (str[i])<font></font>
		UART3_Send(str[i++]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_Number_Float</span><span class="hljs-params">(<span class="hljs-keyword">float</span> data)</span></span>{<font></font>
<font></font>
	<span class="hljs-keyword">char</span> str[<span class="hljs-number">100</span>];<font></font>
<font></font>
	<span class="hljs-keyword">char</span> *tmpSign = (data &lt; <span class="hljs-number">0</span>) ? <span class="hljs-string">"-"</span> : <span class="hljs-string">""</span>;
	<span class="hljs-keyword">float</span> tmpVal = (data &lt; <span class="hljs-number">0</span>) ? -data : data;<font></font>
<font></font>
	<span class="hljs-keyword">int</span> tmpInt1 = tmpVal;                  <span class="hljs-comment">// Get the integer (678).</span>
	<span class="hljs-keyword">float</span> tmpFrac = tmpVal - tmpInt1;      <span class="hljs-comment">// Get fraction (0.0123).</span>
	<span class="hljs-keyword">int</span> tmpInt2 = trunc(tmpFrac * <span class="hljs-number">10</span>);  <span class="hljs-comment">// Turn into integer (123).	int tmpInt2 = trunc(tmpFrac * 10000)</span><font></font>
<font></font>
	<span class="hljs-comment">// Print as parts, note that you need 0-padding for fractional bit.</span><font></font>
<font></font>
	<span class="hljs-built_in">sprintf</span> (str, <span class="hljs-string">"%s%d.%01d"</span>, tmpSign, tmpInt1, tmpInt2);<font></font>
<font></font>
	UART3_Send_String(str);<font></font>
}<font></font>
</code></pre><br>
6.     FreeRtos config<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*
 * FreeRTOS Kernel V10.3.1
 * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * http://www.FreeRTOS.org
 * http://aws.amazon.com/freertos
 *
 * 1 tab == 4 spaces!
 */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> FREERTOS_CONFIG_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREERTOS_CONFIG_H</span><font></font>
<font></font>
<span class="hljs-comment">/* Library includes. */</span>
<span class="hljs-comment">//#include "stm32f10x_lib.h"</span>
<span class="hljs-comment">/*-----------------------------------------------------------
 * Application specific definitions.
 *
 * These definitions should be adjusted for your particular hardware and
 * application requirements.
 *
 * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE
 * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE. 
 *
 * See http://www.freertos.org/a00110.html
 *----------------------------------------------------------*/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler		<span class="hljs-comment">// fix problem</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortPendSVHandler PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortSysTickHandler SysTick_Handler</span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_PREEMPTION		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_IDLE_HOOK			0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TICK_HOOK			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configCPU_CLOCK_HZ			( ( unsigned long ) 48000000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTICK_RATE_HZ			( ( TickType_t ) 1000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_PRIORITIES		( 5 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMINIMAL_STACK_SIZE	( ( unsigned short ) 32 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTOTAL_HEAP_SIZE		( ( size_t ) ( 17 * 1024 ) )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_TASK_NAME_LEN		( 16 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TRACE_FACILITY	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_16_BIT_TICKS		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configIDLE_SHOULD_YIELD		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_MUTEXES			1</span><font></font>
<font></font>
<span class="hljs-comment">/* Co-routine definitions. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_CO_ROUTINES 		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES ( 2 )</span><font></font>
<font></font>
<span class="hljs-comment">/* Set the following definitions to 1 to include the API function, or zero
 to exclude the API function. */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskPrioritySet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_uxTaskPriorityGet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelete				1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskCleanUpResources	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskSuspend			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelayUntil			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelay				1</span><font></font>
<font></font>
<span class="hljs-comment">/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255
 (lowest) to 0 (1?) (highest). */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configKERNEL_INTERRUPT_PRIORITY 		255</span>
<span class="hljs-comment">/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!!
 See http://www.FreeRTOS.org/RTOS-Cortex-M3-M4.html. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY 	191 <span class="hljs-comment">/* equivalent to 0xb0, or priority 11. */</span></span><font></font>
<font></font>
<span class="hljs-comment">/* This is the value being used as per the ST library which permits 16
 priority values, 0 to 15.  This must correspond to the
 configKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowest
 NVIC value of 255. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configLIBRARY_KERNEL_INTERRUPT_PRIORITY	15</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* FREERTOS_CONFIG_H */</span></span><font></font>
<font></font>
</code></pre><br>
7.    main;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"main.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//define      typedef enum :)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorLeft		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorRight		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveBack		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveForward		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MaxSpeedMotor	1000</span><font></font>
<font></font>
<span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];				<span class="hljs-comment">// Buffer DMA ADC sensors</span>
<span class="hljs-keyword">uint16_t</span> SensWhiteOrBlack[<span class="hljs-number">10</span>];		<span class="hljs-comment">// Buffer sensors white or black</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC_Init();<font></font>
	GPIO_Init();<font></font>
	TIM1_Init();<font></font>
	UART3_Init();<font></font>
	ADC_Init();<font></font>
<font></font>
	xTaskCreate(vTaskUART2, <span class="hljs-string">"UART"</span>, <span class="hljs-number">512</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
	xTaskCreate(vTaskConvADC, <span class="hljs-string">"ADC"</span>, <span class="hljs-number">128</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	UART3_Send_String(<span class="hljs-string">"Start program\r\n"</span>);<font></font>
<font></font>
	GPIOA-&gt;BSRR |= GPIO_BSRR_BS10;	<span class="hljs-comment">// Motor enable</span><font></font>
<font></font>
	vTaskStartScheduler();<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">/*************************************Tasks***************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
<span class="hljs-comment">//-------------------Read sensors from buff DMA ADC, and print to UART3-------------//</span><font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (adc_buf[i] &lt;= <span class="hljs-number">300</span>)		<span class="hljs-comment">// value sens is white</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">0</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">0</span>;<font></font>
			} <span class="hljs-keyword">else</span>						<span class="hljs-comment">// else value sens is black</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">1</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">1</span>;<font></font>
			}<font></font>
<font></font>
<span class="hljs-comment">//			UART3_Send_Number_Float(SensWhiteOrBlack[i]);</span>
<span class="hljs-comment">//			UART3_Send_String("\t");</span><font></font>
		}<font></font>
<span class="hljs-comment">///		UART3_Send_String("\r\n");</span><font></font>
<font></font>
<span class="hljs-comment">//-----------------------------------------Move-----------------------------------------//</span><font></font>
<font></font>
<font></font>
		<span class="hljs-comment">//----Normal mode----//</span>
		<span class="hljs-keyword">float</span> devMotorLeft  = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">float</span> devMotorRight = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">uint32_t</span> flagSizeBuf = <span class="hljs-number">0</span>;<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">6</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">6</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">7</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">8</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">9</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">5</span>; i &gt;= <span class="hljs-number">0</span>; i--)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span>(SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">3</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">2</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">if</span>(!flagSizeBuf)<font></font>
		{<font></font>
			devMotorLeft  = <span class="hljs-number">0</span>;<font></font>
			devMotorRight = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
<font></font>
		Motor(MotorRight, (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorRight), MoveForward);<font></font>
		Motor(MotorLeft,  (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorLeft),  MoveForward);<font></font>
<font></font>
<font></font>
<span class="hljs-comment">/*
		if (adc_buf[0] &gt; 1000)
		{
			Motor(MotorLeft, 500, MoveBack);
		}
		else if (adc_buf[0] &lt;= 1000)
		{
			Motor(MotorLeft, 0, MoveForward);
		}

		if (adc_buf[9] &gt; 1000)
		{
			Motor(MotorRight, 500, MoveBack);//Motor(0, 500, 1);	MotorRight	MoveBack
		}
		else if (adc_buf[9] &lt;= 1000)
		{
			Motor(MotorRight, 0, MoveForward);
		}
*/</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">50</span>);<font></font>
	}<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
		<span class="hljs-comment">// just void :)</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">5000</span>);<font></font>
	}<font></font>
<font></font>
}<font></font>
<span class="hljs-comment">/**********************************Function*************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS11;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR11;<font></font>
	}<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (which == <span class="hljs-number">0</span>)	<span class="hljs-comment">//Right motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\t"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR3 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">0</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BS14;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR3 = <span class="hljs-number">0</span>;<font></font>
			GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (which == <span class="hljs-number">1</span>)	<span class="hljs-comment">//left motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\r\n"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR2 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">1</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR2 = <span class="hljs-number">0</span>;<font></font>
			GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*************************************IRQ***************************************/</span>
<span class="hljs-comment">/*
 void USART2_IRQHandler(void) {

 if (USART2-&gt;SR &amp; USART_CR1_RXNEIE) {

 USART2-&gt;SR &amp;= ~USART_CR1_RXNEIE;

 if (USART2-&gt;DR == '0') {
 UART2_Send_String("OFF\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BS13;
 } else if (USART2-&gt;DR == '1') {
 UART2_Send_String("ON\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 } else if (USART2-&gt;DR == '2') {
 uint16_t d0 = ADC1-&gt;DR;
 float Vdd = 1.2 * 4069 / d0;
 UART2_Send(Vdd);
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 }
 }
 }
 */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DMA1_Channel1_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	DMA1-&gt;IFCR = DMA_IFCR_CGIF1 | DMA_IFCR_CTCIF1;	<span class="hljs-comment">// clear DMA interrupt flags</span>
	DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;					<span class="hljs-comment">//  </span>
	<span class="hljs-comment">/*
	 * Code
	 */</span>
	DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;			   <span class="hljs-comment">//  </span><font></font>
	ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habla un poco</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este proyecto ha estado pendiente de mis planes durante varios a√±os y se ha pospuesto todo el tiempo, pero ahora realmente llega a su conclusi√≥n l√≥gica, que estoy muy feliz de terminar, me gustar√≠a abrirlo parcialmente y venderlo como otra plataforma / constructor, si es posible, entonces el robot del sumoista no est√° lejos, y all√≠ ir√°n otros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hab√≠a planes para escribir un art√≠culo, pero la participaci√≥n en la competencia lo requiere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Casi me olvido de la foto, algunos componentes a√∫n no han llegado, y la fecha l√≠mite de la competencia es ma√±ana, as√≠ que tuve que usar el bricolaje sin su mejor rendimiento.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto robot</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/961/400/6f6961400a8062733354fd8ac85b41a0.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ hay un mini video de prueba</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hk-FURUHLvc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es497764/index.html">C√≥mo preparar el juego para portarlo a PC y consola</a></li>
<li><a href="../es497768/index.html">Desinfecci√≥n automatizada</a></li>
<li><a href="../es497770/index.html">Presentamos PyCaret: una biblioteca abierta de Python Machine Learning de c√≥digo bajo</a></li>
<li><a href="../es497772/index.html">Desarrollo en Wargaming - reuni√≥n con Maxim Baryshnikov, Jefe de Plataforma (Parte II)</a></li>
<li><a href="../es497780/index.html">Tres a√±os en Am√©rica Latina: c√≥mo me fui por un sue√±o y regres√© despu√©s de un "reinicio" total</a></li>
<li><a href="../es497784/index.html">Soluci√≥n HiDC para construir una infraestructura moderna de TIC de centros de datos basados ‚Äã‚Äãen equipos Huawei Enterprise</a></li>
<li><a href="../es497786/index.html">Ahora un zapatero con botas, o c√≥mo obtuvimos nuestra propia gu√≠a de estilo</a></li>
<li><a href="../es497788/index.html">Las 10 mejores extensiones de Chrome para dise√±adores</a></li>
<li><a href="../es497790/index.html">Te invitamos a DINS QA EVENING: hablando sobre Postman y los m√©todos de evaluaci√≥n de cobertura de prueba</a></li>
<li><a href="../es497792/index.html">Herramientas de un inversor de acciones novato: acceso de prueba, tarifa de inicio, terminal de negociaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>