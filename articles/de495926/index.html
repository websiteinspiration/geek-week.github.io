<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÄ üì† üé¶ Wir schreiben Firmware f√ºr TI cc2530 auf Z-Stack 3.0 f√ºr ZigBee Sonoff BASICZBR3 Relais mit ds18b20 Sensor ‚õëÔ∏è üïù üî∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es wird davon ausgegangen, dass der Leser bereits √ºber Grundkenntnisse der C-Sprache verf√ºgt, etwas √ºber Zigbee, den cc2530-Chip, Methoden zum Flashen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben Firmware f√ºr TI cc2530 auf Z-Stack 3.0 f√ºr ZigBee Sonoff BASICZBR3 Relais mit ds18b20 Sensor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/495926/"><img src="https://habrastorage.org/webt/pk/k8/1r/pkk81rmgifam0ccamhmapnesahq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird davon ausgegangen, dass der Leser bereits √ºber Grundkenntnisse der C-Sprache verf√ºgt, etwas √ºber Zigbee, den cc2530-Chip, Methoden zum Flashen und Verwenden des Cigbee2mqtt wei√ü und auch mit Projekten wie zigbee2mqtt vertraut ist. </font><font style="vertical-align: inherit;">Wenn nicht, machen Sie sich bereit oder lesen Sie es unter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://myzigbee.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.zigbee2mqtt.io/. Der</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Artikel wird zuerst ausf√ºhrlich geschrieben, beschleunigt sich jedoch allm√§hlich und h√∂rt nicht bei den Details auf, sondern beschreibt den fertigen Firmware-Code. </font><font style="vertical-align: inherit;">Wenn jemand nicht an Argumenten interessiert ist, √∂ffnen Sie einfach die Firmware-Quellen und lesen Sie sie. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Quellcode der fertigen Firmware</font></font></a><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Der Code- und Entwicklungsansatz erhebt keinen Anspruch auf Ideal. </font><font style="vertical-align: inherit;">"Ich bin kein Zauberer, ich lerne nur."</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweck</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Hauptziel ist es, zu verstehen, wie man lange Zeit Firmware f√ºr Z-Stack schreibt. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus diesem Grund habe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ich mich entschlossen, eine alternative Firmware f√ºr das fertige Ger√§t zu implementieren (als Beispiel wurde das </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Sonoff BASICZBR3-</font></a><font style="vertical-align: inherit;"> Relais ausgew√§hlt </font><font style="vertical-align: inherit;">) und den beliebten Temperatursensor ds18b20 anzuschlie√üen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au√üerdem wollte ich Anf√§ngern von ZigBee-Entwicklern ein Beispiel f√ºr die Entwicklung einer Firmware f√ºr den TI cc2530-Chip auf Z-Stack zeigen.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Vorbereitung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um mit der Entwicklung zu beginnen, m√ºssen Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Stack 3.0.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunterladen und installieren. </font><font style="vertical-align: inherit;">Dies ist ein SDK f√ºr die Entwicklung von Firmware mit Beispielen und Dokumentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie m√ºssen auch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IAR Embeded Workbench f√ºr 8051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunterladen und installieren </font><font style="vertical-align: inherit;">- dies ist eine Entwicklungsumgebung mit der F√§higkeit, f√ºr TI cc2530-Chips zu kompilieren. </font><font style="vertical-align: inherit;">Die kostenlose Nutzungsdauer betr√§gt 1 Monat (der Suchende findet jedoch eine L√∂sung). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr die Entwicklung und das Debuggen verwende ich CCDebugger - es erm√∂glicht nicht nur das Flashen von cc2531 / cc2530-Chips, sondern auch das Debuggen der Anwendung in der IAR-Umgebung. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/aj/pr/_jajpr3cvn5q93lo6_igpenpdly.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Experimente, das Prototyping und das Debuggen auf dem Devboard und dem entsprechenden cc2530-Modul zu vereinfachen:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/xc/cq/qlxccqkdbxnqt3pcuo8049lj0ci.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Erstellen einer neuen Anwendung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir erstellen ein neues Projekt basierend auf GenericApp. </font><font style="vertical-align: inherit;">Dies ist ein Beispiel f√ºr eine grundlegende Z-Stack-Anwendung. </font><font style="vertical-align: inherit;">Es befindet sich im Ordner Z-Stack 3.0.2 \ Projects \ zstack \ HomeAutomation \ GenericApp. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir kopieren es in der N√§he und benennen es beispielsweise in DIYRuZRT um (nennen wir die Anwendung f√ºr unser Ger√§t). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Ordner CC2530DB befinden sich Dateien:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewd - Projekteinstellungen f√ºr C-SPY</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewp - Projektdatei</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.eww - Arbeitsbereich</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Benennen Sie die Dateien in DIYRuZRT.eww und DIYRuZRT.ewp um. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In allen Dateien (einschlie√ülich des Quellordners) √§ndern wir auch alle Verweise auf GenericApp in DIYRuZRT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ñffnen Sie nun das DIYRuZRT.ewp-Projekt in IAR. Wir w√§hlen die Konfiguration von RouterEB aus und f√ºhren Rebuild All durch. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/re/mb/fbremb-ma8rcyafhwdcj6klys9k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der RouterEB-Ordner wird im CC2530DB-Ordner erstellt, und die DIYRuZRT.d51-Datei wird im EXE-Ordner angezeigt. Diese Datei eignet sich zum Flashen und Debuggen √ºber IAR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir die Firmware jedoch √ºber den SmartRF Flash Programmer flashen m√ºssen, werden wir kleine √Ñnderungen vornehmen. √Ñndern Sie dazu in den Projekteinstellungen im Abschnitt Link auf der Registerkarte Ausgabe die Einstellungen f√ºr die Ausgabedatei und das Format: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/cb/xl/r5cbxlrunrutiwxxgt-gytlwjz4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach wird die Firmware-Datei DIYRuZRT.hex im EXE-Ordner erstellt, die zum Flashen mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anderen Tools und auf andere Weise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geeignet ist </font><font style="vertical-align: inherit;">.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Hochladen dieser Firmware stellt das Ger√§t jedoch keine Verbindung zum Netzwerk her. </font><font style="vertical-align: inherit;">Nun, wir werden verstehen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Ein bisschen Terminologie</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ZigBee-Terminologie hat folgende Konzepte:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Endpunkt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Der Beschreibungspunkt des Endger√§ts. </font><font style="vertical-align: inherit;">Normalerweise in einfachen Ger√§ten ein Endpunkt. </font><font style="vertical-align: inherit;">Es k√∂nnen mehrere davon in Multifunktionsger√§ten sowie in Ger√§ten mit unterschiedlichen Interaktionsprofilen (ein Profil - ein Endpunkt) vorhanden sein.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster (Cluster)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Eine Reihe von Attributen und Befehlen, die sich auf eine einzelne Funktion beziehen (Ein / Aus, Dimmen, Temperaturmessungen usw.). </font><font style="vertical-align: inherit;">Der Cluster gibt die vom Endpunkt realisierten Opportunities an. </font><font style="vertical-align: inherit;">In einem Endpunkt k√∂nnen Sie mehrere verschiedene Cluster implementieren, jedoch nicht dieselben.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribut (Attribut)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ein Merkmal eines Clusters, dessen Wert gelesen oder geschrieben werden kann. </font><font style="vertical-align: inherit;">Ein Cluster kann viele Attribute haben.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befehl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Eine Kontrollnachricht, die der Cluster verarbeiten kann. </font><font style="vertical-align: inherit;">Ein Team kann Parameter haben. </font><font style="vertical-align: inherit;">Dies wird durch eine Funktion implementiert, die ausgef√ºhrt wird, wenn ein Befehl und Parameter empfangen werden.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arten von Clustern, Attributen und Befehlen sind in der ZigBee-Cluster-Bibliothek standardisiert. </font><font style="vertical-align: inherit;">Hersteller k√∂nnen jedoch ihre eigenen Cluster mit ihren eigenen Attributen und Teams verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige erb√§rmliche Produzenten k√ºmmern sich nicht um die Standards und tun etwas gegen den Standard. </font><font style="vertical-align: inherit;">Dann muss man sich an sie anpassen. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Die Z-Stack-</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Terminologie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hat auch eigene Konzepte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , zum Beispiel:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL (Operating System Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - die Abstraktionsebene des Betriebssystems. </font><font style="vertical-align: inherit;">Hier arbeiten sie mit Aufgaben (Aufgaben), Nachrichten (Nachrichten), Ereignissen (Ereignissen), Timern (Timern) und anderen Objekten.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL (Hardware Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ebene der Ger√§teabstraktion. </font><font style="vertical-align: inherit;">Hier arbeiten sie mit Tasten (Tasten), LEDs (LEDs), Interrupts (Interrupt) usw.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hardwareschicht bietet eine Isolierung des Programmcodes und der von ihr gesteuerten Ger√§te. </font><font style="vertical-align: inherit;">Die Betriebsebene bietet Mechanismen zum Erstellen und Interagieren zwischen Anwendungselementen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies alles erwartet Sie unten und im Prinzip bei der Entwicklung der Firmware.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Was haben wir in der Basisanwendung?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Anwendungscode befindet sich im Quellordner:</font></font><br>
<br>
<ul>
<li><i>OSAL_DIYRuZRT.c</i> ‚Äî    <br>
</li>
<li><i>zcl_DIYRuZRT.h</i> ‚Äî  <br>
</li>
<li><i>zcl_DIYRuZRT.c</i> ‚Äî   <br>
</li>
<li><i>zcl_DIYRuZRT_data.c</i> ‚Äî  ,   <br>
</li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Die Hauptdatei, in der das Array der Task-Handler (Task)&nbsp; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn taskArr gef√ºllt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und die Initialisierungsfunktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks implementiert ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle anderen Dateien werden ben√∂tigt, um diese Initialisierer und Handler zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Liste der Task-Handler </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn-TasksAr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r enth√§lt Funktionsreferenzen. Einige Aufgaben werden durch die entsprechenden Kompilierungsanweisungen verbunden / getrennt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen Kompilierungsanweisungen in den Compileroptionen f√ºr definierte Symbole anzeigen und konfigurieren:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/tl/u6/pntlu6bioazjsoaywmdfofeloas.png"><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> pTaskEventHandlerFn tasksArr[] = {<font></font>
  macEventLoop,<font></font>
  nwk_event_loop,<font></font>
#<span class="hljs-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)<font></font>
  gp_event_loop,<font></font>
#endif  <font></font>
  Hal_ProcessEvent,<font></font>
#<span class="hljs-keyword">if</span> defined( MT_TASK )<font></font>
  MT_ProcessEvent,<font></font>
#endif<font></font>
  APS_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )<font></font>
  APSF_ProcessEvent,<font></font>
#endif<font></font>
  ZDApp_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )<font></font>
  ZDNwkMgr_event_loop,<font></font>
#endif<font></font>
  <span class="hljs-comment">//Added to include TouchLink functionality</span>
  #<span class="hljs-keyword">if</span> defined ( INTER_PAN )<font></font>
    StubAPS_ProcessEvent,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_INITIATOR )<font></font>
    touchLinkInitiator_event_loop,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink target functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_TARGET )<font></font>
    touchLinkTarget_event_loop,<font></font>
  #endif<font></font>
  zcl_event_loop,<font></font>
  bdb_event_loop,<font></font>
  zclDIYRuZRT_event_loop<font></font>
};<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist die Anwendungsstartfunktion, </font><b><font style="vertical-align: inherit;">die von der</font></b><font style="vertical-align: inherit;"> Anwendung ausgef√ºhrte Aufgaben registriert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Registrierung der Aufgaben erfolgt in der richtigen Reihenfolge, und jede Aufgabe erh√§lt eine eigene Nummer. Es ist wichtig , in </font><font style="vertical-align: inherit;">der gleichen Reihenfolge wie in der folgen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tasksArr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Array </font><font style="vertical-align: inherit;">, wie Handler werden entsprechend der Aufgabennummer aufgerufen.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">osalInitTasks</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{<font></font>
  uint8 taskID = <span class="hljs-number">0</span>;<font></font>
<font></font>
  tasksEvents = (uint16 *)osal_mem_alloc( <span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt);<font></font>
  osal_memset( tasksEvents, <span class="hljs-number">0</span>, (<span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt));<font></font>
<font></font>
  macTaskInit( taskID++ );<font></font>
  nwk_init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)</span><font></font>
  gp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  Hal_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( MT_TASK )</span><font></font>
  MT_TaskInit( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  APS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )</span><font></font>
  APSF_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  ZDApp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )</span><font></font>
  ZDNwkMgr_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-comment">// Added to include TouchLink functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( INTER_PAN )</span><font></font>
  StubAPS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( BDB_TL_INITIATOR )</span><font></font>
  touchLinkInitiator_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink target functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( BDB_TL_TARGET )</span><font></font>
  touchLinkTarget_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  zcl_Init( taskID++ );<font></font>
  bdb_Init( taskID++ );<font></font>
  zclDIYRuZRT_Init( taskID );<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unsere Anwendung hat den Funktionshandler </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und die Initialisierungsfunktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init registriert</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sie werden zuletzt in der Liste hinzugef√ºgt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies sind die beiden Hauptfunktionen unserer Anwendung. Die Implementierung dieser Funktionen erfolgt in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Aufgabenregistrierungsfunktion. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - die von unserer Anwendung implementierte Endpunktnummer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Registrierungsschritte, die unsere Anwendung beschreiben, werden nacheinander ausgef√ºhrt:</font></font><br>
<br>
<ul>
<li><b>bdb_RegisterSimpleDescriptor </b> ‚Äî    .    <b>SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc</b> ‚Äî    ,  , ,    .       <i>OSAL_DIYRuZRT_data.c</i><br>
</li>
<li><b>zclGeneral_RegisterCmdCallbacks </b> ‚Äî      <b>zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks</b> ‚Äî  ,       .<br>
</li>
<li><b>zcl_registerAttrList </b> ‚Äî    <b>zclAttrRec_t zclDIYRuZRT_Attrs</b> ‚Äî  ,     .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_registerForMsg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Registriert den Empfang von Kontrollnachrichten.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegisterForKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Wir unterschreiben unsere Aufgabe f√ºr den Empfang von Schaltfl√§chenklickereignissen.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 * SIMPLE DESCRIPTOR
 */</span>
<span class="hljs-comment">// This is the Cluster ID List and should be filled with Application</span>
<span class="hljs-comment">// specific cluster IDs.</span>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_InClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  ZCL_CLUSTER_ID_GEN_IDENTIFY,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Input Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
  <font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_INCLUSTERS   (sizeof(zclDIYRuZRT_InClusterList) / sizeof(zclDIYRuZRT_InClusterList[0]))</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_OutClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Output Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_OUTCLUSTERS  (sizeof(zclDIYRuZRT_OutClusterList) / sizeof(zclDIYRuZRT_OutClusterList[0]))</span><font></font>
<font></font>
<font></font>
SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc =<font></font>
{<font></font>
  DIYRuZRT_ENDPOINT,                  <span class="hljs-comment">//  int Endpoint;</span>
  ZCL_HA_PROFILE_ID,                     <span class="hljs-comment">//  uint16 AppProfId;</span>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Replace ZCL_HA_DEVICEID_ON_OFF_LIGHT with application specific device ID</span>
  ZCL_HA_DEVICEID_ON_OFF_LIGHT,          <span class="hljs-comment">//  uint16 AppDeviceId; </span>
  DIYRuZRT_DEVICE_VERSION,            <span class="hljs-comment">//  int   AppDevVer:4;</span>
  DIYRuZRT_FLAGS,                     <span class="hljs-comment">//  int   AppFlags:4;</span>
  ZCLDIYRuZRT_MAX_INCLUSTERS,         <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_InClusterList, <span class="hljs-comment">//  byte *pAppInClusterList;</span>
  ZCLDIYRuZRT_MAX_OUTCLUSTERS,        <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_OutClusterList <span class="hljs-comment">//  byte *pAppInClusterList;</span><font></font>
};<font></font>
</code></pre><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Funktion der Ereignishandler unserer Anwendung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst werden die Systemereignisse in einer Schleife verarbeitet:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZCL_INCOMING_MSG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ger√§testeuerungsbefehle werden in zclDIYRuZRT_ProcessIncomingMsg verarbeitet.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KEY_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Schaltfl√§chenklickereignisse werden in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_HandleKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verarbeitet </font><font style="vertical-align: inherit;">.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZDO_STATE_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ereignisse zur √Ñnderung des Netzwerkstatus.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; SYS_EVENT_MSG )<font></font>
  {<font></font>
    <span class="hljs-keyword">while</span> ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( zclDIYRuZRT_TaskID )) )<font></font>
    {<font></font>
      <span class="hljs-keyword">switch</span> ( MSGpkt-&gt;hdr.event )<font></font>
      {<font></font>
        <span class="hljs-keyword">case</span> ZCL_INCOMING_MSG:
          <span class="hljs-comment">// Incoming ZCL Foundation command/response messages</span><font></font>
          zclDIYRuZRT_ProcessIncomingMsg( (zclIncomingMsg_t *)MSGpkt );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> KEY_CHANGE:<font></font>
          zclDIYRuZRT_HandleKeys( ((keyChange_t *)MSGpkt)-&gt;state, ((keyChange_t *)MSGpkt)-&gt;keys );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> ZDO_STATE_CHANGE:<font></font>
          zclDIYRuZRT_NwkState = (devStates_t)(MSGpkt-&gt;hdr.status);<font></font>
<font></font>
          <span class="hljs-comment">// now on the network</span>
          <span class="hljs-keyword">if</span> ( (zclDIYRuZRT_NwkState == DEV_ZB_COORD) ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_ROUTER)   ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_END_DEVICE) )<font></font>
          {<font></font>
            giGenAppScreenMode = GENERIC_MAINMODE;<font></font>
            zclDIYRuZRT_LcdDisplayUpdate();<font></font>
          }<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
<font></font>
      <span class="hljs-comment">// Release the memory</span><font></font>
      osal_msg_deallocate( (uint8 *)MSGpkt );<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als n√§chstes folgt die Verarbeitung des Sonderereignisses </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das den Status der LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2 umschaltet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und den Timer f√ºr 500 m mit demselben Ereignis startet. </font><font style="vertical-align: inherit;">Dies startet das Blinken der LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">// toggle LED 2 state, start another timer for 500ms</span><font></font>
    HalLedSet ( HAL_LED_2, HAL_LED_MODE_TOGGLE );<font></font>
    osal_start_timerEx( zclDIYRuZRT_TaskID, DIYRuZRT_EVT_1, <span class="hljs-number">500</span> );<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_1 );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsache ist, dass beim Start der Firmware das Ereignis </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_SW_1 auftritt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und darin der Timer und das Ereignis </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1 initialisiert werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und wenn Sie die S2-Taste dr√ºcken, h√∂rt das Blinken auf (meine LED bleibt an). </font><font style="vertical-align: inherit;">Durch erneutes Dr√ºcken beginnt es zu blinken.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. HAL: LEDs und Tasten</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Warten Sie, welche LED und Tasten?", Fragen Sie. </font><font style="vertical-align: inherit;">Zun√§chst konzentrieren sich alle Beispiele in Z-Stack auf verschiedene Arten von Debug-Boards der SmartRF05 EB-Serie: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/bl/ru/tzblrurrrpoze3kghx_dd1zrume.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe ein etwas anderes Debug-Board und ein Modul mit einem Chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Platine befinden sich 2 Tasten (+ Reset) und 3 LEDs (+ Stromanzeige). </font><font style="vertical-align: inherit;">Hier blinkt einer von ihnen (D2), wenn die Firmware ordnungsgem√§√ü funktioniert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir die Kontakte angerufen haben, bestimmen wir die Entsprechung von Pins, Dioden und Tasten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1 - P10</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D2 - P11</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D3 - P14</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S2 - P20</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1 - P01</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAL ist also eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardware-Abstraktionsschicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , eine M√∂glichkeit, von der Implementierung von Ger√§ten zu abstrahieren. Der Anwendungscode verwendet Makros und Funktionen, die mit Abstraktionen wie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Button 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED 2 arbeiten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , und die spezifische Entsprechung von Abstraktionen und Ger√§ten wird separat festgelegt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, was f√ºr eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Art von HAL_LED_2 ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und wie man versteht, an welchem ‚Äã‚ÄãPin es h√§ngt. </font><i><font style="vertical-align: inherit;">Bei der</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Suche finden wir die Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_led.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in der diese Konstanten und die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedSet-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><b><font style="vertical-align: inherit;">beschrieben werden</font></b><font style="vertical-align: inherit;"> , in der die LED-Nummer und der LED-Modus √ºbertragen werden. Im Inneren wird die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedOnOff-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><b><font style="vertical-align: inherit;">aufgerufen</font></b><font style="vertical-align: inherit;"> , um die LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und auszuschalten, die wiederum entweder </font><b><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></b><font style="vertical-align: inherit;"> oder </font><font style="vertical-align: inherit;">ausf√ºhrt</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sind die in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beschriebenen </font><i><font style="vertical-align: inherit;">Makros</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Makros √§ndern sich je nach Hardwarekonfiguration. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In meinem Fall:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_OFF_LED2() &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (0); )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_ON_LED2()&nbsp; &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (1); )</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Etwas h√∂her in der Datei befinden sich die Entsprechungen von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_SBIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_POLARITY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">&nbsp;&nbsp;<span class="hljs-comment">/* 2 - Red */</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT &nbsp; &nbsp; &nbsp; &nbsp; P1_1</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; P1DIR</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet, dass sich LED 2 an Pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1 befindet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und der Schaltpegel hoch ist. </font><font style="vertical-align: inherit;">Nach dem Code zu urteilen, sollte die LED erl√∂schen, wenn die Taste gedr√ºckt wird, aber bei uns bleibt sie an. </font><font style="vertical-align: inherit;">Wenn in dieser Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √§ndern </font><i><font style="vertical-align: inherit;">wir</font></i><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
auf der</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_LOW</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dann erlischt jetzt die LED, wenn Sie die S2-Taste dr√ºcken, wie es logisch sein sollte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um allgemeine Dateien, die nicht mit unserer Anwendung zusammenh√§ngen, nicht zu √§ndern, ist es besser, Folgendes zu tun:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie eine Kopie der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (aus dem Ordner Z-Stack 3.0.2 \ Components \ hal \ target \ CC2530EB \) in unserem Quellordner und nennen Sie sie beispielsweise </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie uns unsere Kopie der Datei zur allerersten machen (wodurch die Verbindung der freigegebenen Datei ausgeschlossen wird). </font><font style="vertical-align: inherit;">Erstellen Sie eine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Datei in unserem </font><i><font style="vertical-align: inherit;">Quellordner</font></i><font style="vertical-align: inherit;"> und schreiben Sie die folgende Zeile:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"hal_board_cfg_DIYRuZRT.h"</span></span></code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben Sie an, dass die Verbindung dieser Datei die allererste ist - in den Projekteinstellungen:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">$PROJ_DIR$\..\Source\preinclude.h</code></pre><br>
<img src="https://habrastorage.org/webt/jl/_f/j_/jl_fj_oy71xhwehgszprw9jhdiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt k√∂nnen wir die Ger√§teparameter in unserer Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h √§ndern</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">ohne freigegebene Dateien bearbeiten zu m√ºssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe die Compiler-Direktiven in dieselbe preinclude.h-Datei √ºbertragen und sie in den Compiler-Optionen gel√∂scht:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SECURE 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TC_LINKKEY_JOIN</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_INIT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_RESTORE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xZTOOL_P1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_TASK</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_SYS_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_MGMT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_CNF_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEGACY_LCD_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MULTICAST_ENABLED FALSE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_READ</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_WRITE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_BASIC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_IDENTIFY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_SCENES</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_GROUPS</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In derselben Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> finden wir die Beschreibung der S1-Taste und des Joystick Center Press:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* S1 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P0_1</span><font></font>
<font></font>
<span class="hljs-comment">/* Joystick Center Press */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P2_0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_POLARITY&nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies entspricht den Pin-Pins auf der Platine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns die Hardware-Initialisierung an - das Makro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_INIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in derselben Datei. </font><font style="vertical-align: inherit;">Standardm√§√üig ist die Direktive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_CC2530EB_REV17 aktiviert</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , daher sehen wir uns die entsprechende </font><b><font style="vertical-align: inherit;">Makrovariante</font></b><font style="vertical-align: inherit;"> an.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* ----------- Board Initialization ---------- */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined (HAL_BOARD_CC2530EB_REV17) &amp;&amp; !defined (HAL_PA_LNA) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2590) &amp;&amp; !defined (HAL_PA_LNA_SE2431L) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2592)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_BOARD_INIT()                                         \
{                                                                \
  uint16 i;                                                      \
                                                                 \
  SLEEPCMD &amp;= ~OSC_PD;                       <span class="hljs-comment">/* turn on 16MHz RC and 32MHz XOSC */</span>                \
  while (!(SLEEPSTA &amp; XOSC_STB));            <span class="hljs-comment">/* wait for 32MHz XOSC stable */</span>                     \
  asm(<span class="hljs-meta-string">"NOP"</span>);                                <span class="hljs-comment">/* chip bug workaround */</span>                            \
  for (i=0; i&lt;504; i++) asm(<span class="hljs-meta-string">"NOP"</span>);          <span class="hljs-comment">/* Require 63us delay for all revs */</span>                \
  CLKCONCMD = (CLKCONCMD_32MHZ | OSC_32KHZ); <span class="hljs-comment">/* Select 32MHz XOSC and the source for 32K clock */</span> \
  while (CLKCONSTA != (CLKCONCMD_32MHZ | OSC_32KHZ)); <span class="hljs-comment">/* Wait for the change to be effective */</span>   \
  SLEEPCMD |= OSC_PD;                        <span class="hljs-comment">/* turn off 16MHz RC */</span>                              \
                                                                 \
  <span class="hljs-comment">/* Turn on cache prefetch mode */</span>                              \
  PREFETCH_ENABLE();                                             \
                                                                 \
  HAL_TURN_OFF_LED1();                                           \
  LED1_DDR |= LED1_BV;                                           \
  HAL_TURN_OFF_LED2();                                           \
  LED2_DDR |= LED2_BV;                                           \
  HAL_TURN_OFF_LED3();                                           \
  LED3_DDR |= LED3_BV;                                           \
  HAL_TURN_OFF_LED4();                                           \
  LED4_SET_DIR();                                                \
                                                                 \
  <span class="hljs-comment">/* configure tristates */</span>                                      \
  P0INP |= PUSH2_BV;                                             \
}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Makro werden die Modi und Register des Prozessors initialisiert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stattdessen werden </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_DDR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und andere durch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1DIR ersetzt.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Registrieren Sie diesen Port </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und laden Sie die Betriebsmodus-Pins (Eingang oder Ausgang). Dementsprechend setzt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_BV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 pro Bit des entsprechenden Pins (in unserem Fall 1 Bit, was </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pin entspricht </font><font style="vertical-align: inherit;">): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/ed/0y/qred0ypxdrfxxkaleymbpqmjgto.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register und Prozessormodi sind in der Dokumentation des </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äûcc253x-Benutzerhandbuchs‚Äú beschrieben.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Es ist jedoch nirgends sichtbar, wie die Tasten konfiguriert sind. Schaltfl√§chen werden √§hnlich verarbeitet, jedoch in einer anderen Datei - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es definiert die Parameter der Schaltfl√§chen und Funktionen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyConfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyRead</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyPoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Diese Funktionen sind f√ºr die Initialisierung des Subsystems f√ºr die Arbeit mit Schaltfl√§chen und das Lesen von Werten verantwortlich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Standardm√§√üig wird die Tastenverarbeitung alle 100 ms auf einem Timer ausgef√ºhrt. </font><font style="vertical-align: inherit;">Pin P2_0 f√ºr die aktuelle Konfiguration wird dem Joystick zugewiesen und sein aktueller Status wird als Klick gelesen - daher startet der LED-Blink-Timer.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Wir konfigurieren das Ger√§t f√ºr uns</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ñnderung in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT am 1</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT_data.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_DEVICE_VERSION bei 1</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ManufacturerName auf {6, 'D', 'I', 'Y', 'R', 'u', 'Z'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ModelId auf {9, 'D', 'I', 'Y', 'R', 'u', 'Z', '_', 'R', 'T'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_DateCode auf {8, '2', '0', '2', '0', '0', '4', '0', '5'}</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit das Ger√§t auf einem beliebigen Kanal eine Verbindung zum Netzwerk herstellen kann (standardm√§√üig nur 11, angegeben in der Direktive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_CHANLIST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datei Tools \ f8wConfig.cfg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), m√ºssen Sie diese Funktion in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> angeben, </font><i><font style="vertical-align: inherit;">indem Sie</font></i><font style="vertical-align: inherit;"> den Wert der Direktive √§ndern. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir f√ºgen auch die Kompilierungsanweisung </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISABLE_GREENPOWER_BASIC_PROXY hinzu,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> damit der GREENPOWER-Endpunkt nicht f√ºr unser Ger√§t erstellt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schalten Sie auch die unn√∂tige Unterst√ºtzung f√ºr den LCD-Bildschirm aus.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DISABLE_GREENPOWER_BASIC_PROXY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEFAULT_CHANLIST 0x07FFF800&nbsp; <span class="hljs-comment">// ALL Channels</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit unser Ger√§t automatisch versucht, eine Verbindung zum Netzwerk herzustellen, f√ºgen wir die Verbindung zum Netzwerk im Funktionscode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init hinzu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">bdb_StartCommissioning(BDB_COMMISSIONING_MODE_NWK_STEERING |<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BDB_COMMISSIONING_MODE_FINDING_BINDING);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºhren Sie danach Build aus, f√ºllen Sie die Firmware in den Chip und beginnen Sie mit dem Pairing auf dem Koordinator. </font><font style="vertical-align: inherit;">Ich √ºberpr√ºfe den Betrieb des ZigBee-Netzwerks in ioBroker.zigbee. So sieht das neu angeschlossene Ger√§t aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/ik/ss/umikss4n4f19icobraxj-rb_tj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gro√üartig, es stellte sich heraus, dass das Ger√§t verbunden wurde!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Wir erschweren den Betrieb des Ger√§ts</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir nun, die Funktionalit√§t ein wenig anzupassen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Vorgang zum Verbinden des Ger√§ts mit dem Netzwerk erfolgt durch langes Dr√ºcken der Taste.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn sich das Ger√§t bereits im Netzwerk befand, wird es durch langes Dr√ºcken aus dem Netzwerk angezeigt.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurzes Dr√ºcken - schaltet den Status der LED um.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Status der LED sollte beibehalten werden, wenn das Ger√§t nach einem Stromausfall startet.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um meine eigene Schaltfl√§chenverarbeitung einzurichten, habe ich die Funktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √§hnlich der im Modul </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c erstellt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , jedoch ausschlie√ülich f√ºr meine Schaltfl√§chen.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    ()</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyInit</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">/*      0 */</span>
  halKeySavedKeys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  PUSH1_SEL &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    - GPIO */</span>
  PUSH1_DIR &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    -  */</span><font></font>
  <font></font>
  PUSH1_ICTL &amp;= ~(PUSH1_ICTLBIT); <span class="hljs-comment">/*      */</span>
  PUSH1_IEN &amp;= ~(PUSH1_IENBIT);   <span class="hljs-comment">/*     */</span><font></font>
  <font></font>
  PUSH2_SEL &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin function to GPIO */</span>
  PUSH2_DIR &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin direction to Input */</span><font></font>
  <font></font>
  PUSH2_ICTL &amp;= ~(PUSH2_ICTLBIT); <span class="hljs-comment">/* don't generate interrupt */</span>
  PUSH2_IEN &amp;= ~(PUSH2_IENBIT);   <span class="hljs-comment">/* Clear interrupt enable bit */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aufruf dieser Funktion zur Makro- </font><font style="vertical-align: inherit;">Datei </font><i><font style="vertical-align: inherit;">HAL_BOARD_INIT </font></i></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h </font></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hinzugef√ºgt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Deaktivieren Sie den integrierten hal_key in derselben Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> um Konflikte zu vermeiden </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_KEY FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
weil </font><font style="vertical-align: inherit;">Der Standard-Tastenleser ist deaktiviert. Wir werden dies selbst tun. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Initialisierungsfunktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> starten </font><b><font style="vertical-align: inherit;">wir</font></b><font style="vertical-align: inherit;"> den Timer zum Lesen der Zust√§nde der Tasten. </font><font style="vertical-align: inherit;">Der Timer generiert unser </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ereignis </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs">osal_start_reload_timer( zclDIYRuZRT_TaskID, HAL_KEY_EVENT, <span class="hljs-number">100</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Ereignisschleife behandeln wir das Ereignis </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">indem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir die</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><b><font style="vertical-align: inherit;">DIYRuZRT_HalKeyPoll</font></b><font style="vertical-align: inherit;"> aufrufen </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyPoll</span> <span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  uint8 keys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   1 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON1())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_1;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">//   2 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON2())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_2;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (keys == halKeySavedKeys)<font></font>
  {<font></font>
    <span class="hljs-comment">//  -  </span>
    <span class="hljs-keyword">return</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//        . </span><font></font>
  halKeySavedKeys = keys;<font></font>
<font></font>
  <span class="hljs-comment">//     </span><font></font>
  OnBoard_SendKeys(keys, HAL_KEY_STATE_NORMAL);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch Speichern des Status der Schaltfl√§chen in der Variablen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">halKeySavedKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> k√∂nnen wir den Zeitpunkt der √Ñnderung bestimmen - Dr√ºcken und Loslassen der Schaltfl√§chen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie auf die Schaltfl√§che klicken, starten Sie den Timer f√ºr 5 Sekunden. </font><font style="vertical-align: inherit;">Wenn dieser Timer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ausgel√∂st</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird, wird das Ereignis </font><b><font style="vertical-align: inherit;">DIYRuZRT_EVT_LONG</font></b><font style="vertical-align: inherit;"> generiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn die Taste losgelassen wird, wird der Timer zur√ºckgesetzt. </font><font style="vertical-align: inherit;">In jedem Fall √§ndern wir den Status der LED, wenn Sie die Taste dr√ºcken.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_HandleKeys</span><span class="hljs-params">( byte shift, byte keys )</span>
</span>{
  <span class="hljs-keyword">if</span> ( keys &amp; HAL_KEY_SW_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">//       - 5 </span>
    osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG, <span class="hljs-number">5000</span>);
    <span class="hljs-comment">//  </span>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    <span class="hljs-comment">//     </span><font></font>
    osal_stop_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Verarbeitung eines Ereignisses mit langer </font><b><font style="vertical-align: inherit;">Drucklaufzeit ber√ºcksichtigen</font></b><font style="vertical-align: inherit;"> wir nun den aktuellen Status des Netzwerks √ºber das Strukturattribut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bdbAttributes.bdbNodeIsOnANetwork</font></font></b><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  DIYRuZRT_EVT_LONG</span>
  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_LONG )<font></font>
  {<font></font>
    <span class="hljs-comment">//    </span>
    <span class="hljs-comment">//      ?</span>
    <span class="hljs-keyword">if</span> ( bdbAttributes.bdbNodeIsOnANetwork )<font></font>
    {<font></font>
      <span class="hljs-comment">//  </span><font></font>
      zclDIYRuZRT_LeaveNetwork();<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <font></font>
    {<font></font>
      <span class="hljs-comment">//    </span><font></font>
      bdb_StartCommissioning(<font></font>
        BDB_COMMISSIONING_MODE_NWK_FORMATION | <font></font>
        BDB_COMMISSIONING_MODE_NWK_STEERING | <font></font>
        BDB_COMMISSIONING_MODE_FINDING_BINDING | <font></font>
        BDB_COMMISSIONING_MODE_INITIATOR_TL<font></font>
      );<font></font>
      <span class="hljs-comment">//  ,   </span>
      osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_BLINK, <span class="hljs-number">500</span>);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_LONG );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen weiter. </font><font style="vertical-align: inherit;">Der Zustand der LED wird in einer Variablen gespeichert, deren Wert wir im NV-Speicher speichern. </font><font style="vertical-align: inherit;">Wenn das Ger√§t startet, lesen wir den Wert aus dem Speicher in eine Variable.</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  NVM   RELAY STATE</span>
  <span class="hljs-keyword">if</span> ( SUCCESS == osal_nv_item_init( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">1</span>, &amp;RELAY_STATE ) ) {
    <span class="hljs-comment">//   RELAY STATE  </span>
    osal_nv_read( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE );<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateRelay</span> <span class="hljs-params">( <span class="hljs-keyword">bool</span> value )</span>
</span>{
  <span class="hljs-keyword">if</span> (value) {<font></font>
    RELAY_STATE = <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    RELAY_STATE = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span>
  osal_nv_write(NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE);
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
}<font></font>
  <font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">applyRelay</span> <span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">if</span> (RELAY_STATE == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_OFF );<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_ON );<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Jetzt werden wir uns mit Zigbee befassen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bisher haben wir die Hardware aussortiert - mit der Taste steuern wir die LED. </font><font style="vertical-align: inherit;">Jetzt implementieren wir dasselbe durch Zigbee. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Steuerung des Relais reicht es aus, unseren einzigen Endpunkt zu verwenden und den </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cluster zu implementieren </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir lesen die Zigbee-Cluster-Bibliotheksspezifikation f√ºr den </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cluster </font><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/9z/z7/zo9zz7ccj2oyfyrxrk3mithxh0i.png"><br>
<br>
<img src="https://habrastorage.org/webt/7b/na/ek/7bnaekoi4gmleiisjwvbfw75hao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es reicht aus, das OnOff-Attribut und die Befehle On, Off, Toggle zu implementieren. </font><i><font style="vertical-align: inherit;">F√ºgen</font></i></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sie zun√§chst die Direktive zu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h hinzu</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_ON_OFF</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Beschreibung unserer Attribute zclDIYRuZRT_Attrs f√ºgen wir neue Clusterattribute hinzu:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ***  On/Off  ***</span><font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    { <span class="hljs-comment">// </span><font></font>
      ATTRID_ON_OFF,<font></font>
      ZCL_DATATYPE_BOOLEAN,<font></font>
      ACCESS_CONTROL_READ,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;RELAY_STATE<font></font>
    }<font></font>
  },<font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    {  <span class="hljs-comment">//  On/Off </span><font></font>
      ATTRID_CLUSTER_REVISION,<font></font>
      ZCL_DATATYPE_UINT16,<font></font>
      ACCESS_CONTROL_READ | ACCESS_CLIENT,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;zclDIYRuZRT_clusterRevision_all<font></font>
    }<font></font>
  },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir f√ºgen den Cluster auch der Liste der unterst√ºtzten eingehenden Endpunktcluster </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_InClusterList hinzu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">F√ºgen Sie der</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tabelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_CmdCallbacks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einen Handler hinzu, um </font><b><font style="vertical-align: inherit;">Steuerbefehle zu</font></b><font style="vertical-align: inherit;"> implementieren </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 *    ZCL 
 */</span>
<span class="hljs-keyword">static</span> zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks =<font></font>
{<font></font>
  zclDIYRuZRT_BasicResetCB,               <span class="hljs-comment">// Basic Cluster Reset command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Identify Trigger Effect command</span>
  zclDIYRuZRT_OnOffCB,                    <span class="hljs-comment">// On/Off cluster commands</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command Off with Effect</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Recall Global Scene</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Timed Off</span><font></font>
#ifdef ZCL_LEVEL_CTRL<font></font>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move to Level command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Step command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Stop command</span><font></font>
#endif<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wir setzen es um:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    OnOff</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_OnOffCB</span><span class="hljs-params">(uint8 cmd)</span>
</span>{
  <span class="hljs-comment">//  ,   </span>
  <span class="hljs-comment">//    </span><font></font>
  afIncomingMSGPacket_t *pPtr = zcl_getRawAFMsg();<font></font>
  zclDIYRuZRT_DstAddr.addr.shortAddr = pPtr-&gt;srcAddr.addr.shortAddr;<font></font>
  <font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">if</span> (cmd == COMMAND_ON) {<font></font>
    updateRelay(TRUE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_OFF) {<font></font>
    updateRelay(FALSE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_TOGGLE) {<font></font>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gro√üartig, jetzt kann das Relais durch Befehle geschaltet werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rg/_b/r5/rg_br5mwpw1z8g63trgcdts2o84.png"><br>
<br>
<img src="https://habrastorage.org/webt/sc/s8/-h/scs8-heldl3hz6l7h4ia3jllscw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das reicht aber nicht. </font><font style="vertical-align: inherit;">Jetzt m√ºssen wir auch den Koordinator √ºber den aktuellen Zustand der LED informieren, wenn wir sie mit der Taste umschalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºgen Sie erneut die Direktive hinzu:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_REPORTING_DEVICE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie nun eine Funktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die eine Statusmeldung sendet. </font><font style="vertical-align: inherit;">Wir werden es nennen, wenn die LED geschaltet wird und wenn das Ger√§t startet.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportOnOff</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_ON_OFF;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_BOOLEAN;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;RELAY_STATE);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_GEN_ON_OFF, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt sehen wir in den Protokollen Meldungen √ºber eine √Ñnderung des Status der LED.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. Schlie√üen Sie den Temperatursensor ds18b20 an</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Sensor ist mit einem beliebigen freien Pin verbunden (in meinem Fall </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1 einstellen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºgen Sie der Anwendung den Sensorabrufcode hinzu. Wir werden regelm√§√üig interviewen - einmal pro Minute. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unmittelbar nach der Abfrage benachrichtigt Sie der Netzwerkkoordinator √ºber den aktuellen Wert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie die ZCL-Spezifikationen zum Senden von Daten von Temperatursensoren. Wir ben√∂tigen eine Cluster- </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperaturmessung.</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/o2/_q/8h/o2_q8h7gtgxs7cjvvz8dumonsgq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir sehen, dass wir 3 Attribute implementieren m√ºssen, von denen eines den mit 100 multiplizierten Temperaturwert darstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier f√ºgen wir die Attribute analog zum </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cluster hinzu </font><font style="vertical-align: inherit;">. Der Koordinator wird √ºber das Ereignis </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_REPORTING_EVT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informiert </font><font style="vertical-align: inherit;">, das wir zu Beginn einmal pro Minute planen. Im Event-Handler werden wir anrufen</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportTemp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das die Temperatur des Sensors liest und eine Nachricht sendet.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportTemp</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span><font></font>
  zclDIYRuZRT_MeasuredValue = readTemperature();<font></font>
  <font></font>
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_MS_TEMPERATURE_MEASURED_VALUE;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_INT16;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;zclDIYRuZRT_MeasuredValue);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_MS_TEMPERATURE_MEASUREMENT, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. Gie√üen Sie Firmware in das Ger√§t</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Devboard auf Sonoff BASICZBR3 umzustellen, m√ºssen Sie die √úbereinstimmung der LED-Pins und -Tasten anpassen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/fu/we/egfuweya8lj53yh-5rarbvslzvk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wiederholen Sie die LED 1 an Pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0_7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um das Relais zu steuern. Die Aufnahme erfolgt durch ein hohes Ma√ü an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTIVE_HIGH</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">Wir h√§ngen die </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Taste </font><font style="vertical-align: inherit;">an Pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und die Informations-LED 2 an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_0 wieder auf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wir lassen den Temperatursensor an Pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wir nehmen alle diese √Ñnderungen in der Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h vor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Um eine Konfiguration auszuw√§hlen, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erstellen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir eine separate Direktive </font><b><font style="vertical-align: inherit;">HAL_SONOFF</font></b><font style="vertical-align: inherit;"> . Wenn es eingestellt ist, werden die Einstellungen f√ºr Sonoff BASICZBR3 verwendet, andernfalls f√ºr devboard.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> HAL_SONOFF</span>
  <span class="hljs-comment">/* 1 - P0_7  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(7)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P0_7</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P0DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_HIGH</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-comment">/* 1 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_LOW</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_1  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(1)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_1</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer wichtiger Parameter musste korrigiert werden - das Vorhandensein von "Uhr" -Quarz, weil </font><font style="vertical-align: inherit;">Auf der Sonoff BASICZBR3-Platine ist es nicht verl√∂tet:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define HAL_CLOCK_CRYSTAL</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> OSC32K_CRYSTAL_INSTALLED FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ohne diese Optionen startet die Firmware nicht (oder besser gesagt nicht immer). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach sammeln wir die Firmware und stellen eine Verbindung zur Firmware her.</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEACHTUNG!!! </font><font style="vertical-align: inherit;">Trennen Sie das Sonoff BASICZBR3-Relais vor jeder Verbindung und Firmware vom Stromnetz!</font></font></b></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verbinden die Sonoff BASICZBR3-Verkabelung mit CCDebugger, l√∂schen den Chip und flashen unsere Firmware.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/w-/3b/bzw-3bib84ucfczt0kg_mmbajtw.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. Wir starten das Ger√§t in zigbee2mqtt und ioBroker.Zigbee</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ger√§t ist zwar in der Liste der angeschlossenen Ger√§te aufgef√ºhrt und wir k√∂nnen es durch Senden von Befehlen verwalten, aber wir m√ºssen dies korrekter tun - mit Bildern und Zust√§nden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ein neues Ger√§t in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.Zigbee zu erhalten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , m√ºssen Sie zwei Schritte ausf√ºhren:</font></font><br>
<br>
<ol>
<li>     <b>zigbee-herdsman-converters</b>.       ,       <b>zigbee2mqtt</b>.<br>
</li>
<li>    <b>ioBroker.Zigbee</b><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle √Ñnderungen k√∂nnen zuerst in lokalen Dateien und dann in den entsprechenden Repositorys vorgenommen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir finden den Speicherort des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee-herdsman-converter-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pakets </font><font style="vertical-align: inherit;">im installierten ioBroker (oder zigbee2mqtt). Im Paket befindet sich die Datei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">device.js </font></font></i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Koenkk/zigbee-herdsman-converters/blob/master/devices.js.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Diese Datei enth√§lt Beschreibungen aller Ger√§te, mit denen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt arbeiten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> k√∂nnen </font><font style="vertical-align: inherit;">. Wir finden darin einen Block mit Beschreibungen von DIYRuZ-Ger√§ten (nach 2300 Zeilen). F√ºgen Sie diesem Block eine Beschreibung des neuen Ger√§ts hinzu:</font></font><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">zigbeeModel</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">model</span>: <span class="hljs-string">'DIYRuZ_RT'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">description</span>: <span class="hljs-string">''</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">supports</span>: <span class="hljs-string">'on/off, temperature'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">fromZigbee</span>: [fz.on_off, fz.temperature],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">toZigbee</span>: [tz.on_off],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fromZigbee-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Attribut geben </font><font style="vertical-align: inherit;">wir die Konverter an, die vom Ger√§t kommende Nachrichten verarbeiten. Unsere beiden Stellen sind standardisiert. Der Konverter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.on_off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verarbeitet die Ein / Aus-Nachricht und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.temperature verarbeitet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die Temperaturdaten. Der Code dieser Konverter (in den Dateikonvertern / fromZigbee.js) zeigt, wie eingehende Nachrichten verarbeitet werden und dass die Temperatur durch 100 geteilt wird.</font></font><br>
<br>
<pre><code class="javascript hljs">   on_off: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'genOnOff'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (msg.data.hasOwnProperty(<span class="hljs-string">'onOff'</span>)) {
                <span class="hljs-keyword">const</span> property = getProperty(<span class="hljs-string">'state'</span>, msg, model);
                <span class="hljs-keyword">return</span> {[property]: msg.data[<span class="hljs-string">'onOff'</span>] === <span class="hljs-number">1</span> ? <span class="hljs-string">'ON'</span> : <span class="hljs-string">'OFF'</span>};<font></font>
            }<font></font>
        },<font></font>
    },<font></font>
</code></pre><br>
<pre><code class="javascript hljs"> temperature: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'msTemperatureMeasurement'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> temperature = <span class="hljs-built_in">parseFloat</span>(msg.data[<span class="hljs-string">'measuredValue'</span>]) / <span class="hljs-number">100.0</span>;
            <span class="hljs-keyword">return</span> {<span class="hljs-attr">temperature</span>: calibrateAndPrecisionRoundOptions(temperature, options, <span class="hljs-string">'temperature'</span>)};<font></font>
        },<font></font>
    },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Attribut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toZigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geben </font><b><font style="vertical-align: inherit;">wir</font></b><font style="vertical-align: inherit;"> die Konverter an, die unsere Befehle an das Ger√§t verarbeiten. </font><font style="vertical-align: inherit;">In unserem Fall ist es der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tz.on_off-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wandler </font><font style="vertical-align: inherit;">zum Schalten von Relais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles zu den "Konvertern" hinzugef√ºgt. </font><font style="vertical-align: inherit;">Wer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt verwendet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Sie k√∂nnen es bereits verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und ioBroker-Benutzer f√ºgen der Datei </font><i><font style="vertical-align: inherit;">ioBroker.zigbee \ lib \ device.js</font></i><font style="vertical-align: inherit;"> weiterhin eine Beschreibung des Ger√§ts </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hinzu</font></font></i><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">models</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">icon</span>: <span class="hljs-string">'img/DIYRuZ.png'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">states</span>: [<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.state,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.temperature,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier reicht es aus, genau das gleiche Modell, eine Datei mit einem Bild und eine Liste von Zust√§nden anzugeben. </font><font style="vertical-align: inherit;">In unserem Fall sind die Zust√§nde ebenfalls Standard: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zustand</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> f√ºr den Zustand des Relais, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperatur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> f√ºr die Anzeige von Temperaturwerten.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oz/fu/zm/ozfuzmz72p-e1lwweegnd4fv74q.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. Was kommt als n√§chstes?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider konnte ich nicht alle Aspekte und Funktionen von Z-Stack 3.0 herausfinden. </font><font style="vertical-align: inherit;">H√∂chstwahrscheinlich habe ich eine Funktion nicht einmal richtig implementiert, oder es k√∂nnten einige integrierte Mechanismen verwendet werden, um sie zu implementieren. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher kann die obige L√∂sung verbessert und entwickelt werden. </font><font style="vertical-align: inherit;">Hier sind einige Anweisungen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich konnte nicht schnell L√∂sungen f√ºr die M√∂glichkeit finden, untergeordnete Ger√§te √ºber Relais anzuschlie√üen. </font><font style="vertical-align: inherit;">Andere Router-Ger√§te k√∂nnen den Befehl allow_join ausf√ºhren und neue Ger√§te √ºber sich selbst verbinden, ohne das neue Ger√§t zum Koordinator bringen zu m√ºssen. </font><font style="vertical-align: inherit;">Das Ger√§t wird durch einen Router dargestellt. Es wird korrekt auf der Netzwerkkarte angezeigt, weigert sich jedoch, den Befehl "allow_join" auszuf√ºhren. </font><font style="vertical-align: inherit;">Genauer gesagt wird der Befehl ausgef√ºhrt, aber die Ger√§te stellen keine Verbindung √ºber ihn her.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au√üerdem wurde keine korrekte Berichterstellung implementiert. </font><font style="vertical-align: inherit;">Auf diese Weise k√∂nnen Sie die Statusbenachrichtigung konfigurieren, wenn Sie mit dem Befehl configReport eine Liste der zu sendenden Attribute und die H√§ufigkeit der Benachrichtigung angeben k√∂nnen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeite mit Gruppen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Behandeln Sie Interrupts und implementieren Sie Polling-Schaltfl√§chen durch Interrupts.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, f√ºr die folgenden Ger√§te m√ºssen Sie sich mit Stromversorgungsmodi und der Erstellung von "schlafenden" Ger√§ten mit Batterien befassen.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie immer lade ich Sie zus√§tzlich zu den Kommentaren ein, dieses und andere Ger√§te im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegramm-Chat auf Zigbee zu diskutieren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich m√∂chte mich f√ºr die Unterst√ºtzung und Unterst√ºtzung bei der Entwicklung meiner Kollegen in der Telegramm-Chat- und Zigbee-Community bedanken:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/DJONvl</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/antstar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/Jager_f</font></font></a></li>
</ul><br>
</blockquote><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hauptdokumentation ist im Z-Stack 3.0.2 SDK enthalten und wird mit diesem installiert. </font><font style="vertical-align: inherit;">Aber ich werde einen Teil der Links hier geben:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL und HAL </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TI ZIgbee Wiki</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Create New Application For SmartRF05 + CC2530 SWRA231 Version 1.1</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Z-Stack Home Sample Application User's Guide SWRU354 Version 1.3</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Z-Stack Sample Applications SWRA201 Version 1.6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Z-Stack Developer's Guide SWRA176 Version 1.12</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Z-Stack 3.0 Developer's Guide Version 1.14</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Z-Stack API SWRA195 Version 1.10</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TI CC253x User's Guide</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/formtapez/ZigUP</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zigbee Cluster Library rev 6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   DIYRuZ_RT</a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495910/index.html">Installieren von ROS in einem Ubuntu Single-Board IMG-Image</a></li>
<li><a href="../de495912/index.html">Intelligente Wiederholungsaufkleber</a></li>
<li><a href="../de495918/index.html">Wie man realistischen Sound in Computerspielen und VR reproduziert und warum es schwierig ist</a></li>
<li><a href="../de495920/index.html">Implementierungsdetails des PTPv2-Zeitsynchronisationsprotokolls</a></li>
<li><a href="../de495924/index.html">Warum ist es so verdammt schwierig, ein gutes COVID-19-Verteilungsmodell zu erstellen?</a></li>
<li><a href="../de495932/index.html">Was ist die verborgene Bedeutung der Autoren im SCRUM-Handbuch? Teil 1. √úber den Prozess</a></li>
<li><a href="../de495934/index.html">DataGovernance zu Hause</a></li>
<li><a href="../de495938/index.html">Eine Auswahl von Artikeln zum maschinellen Lernen: F√§lle, Leitf√§den und Studien f√ºr M√§rz 2020</a></li>
<li><a href="../de495942/index.html">Sparen Sie Zeit, Nerven und Arbeitsstunden</a></li>
<li><a href="../de495944/index.html">Aktualisiert TOP50 (Bewertung von CIS-Supercomputern): Dynamik und Trends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>