<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÇ üå¨Ô∏è ü§üüèº PuppetConf 2016. Kubernetes for system administrators. Part 2 üë©üèº‚Äçüöí üêô üçé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PuppetConf 2016. Kubernetes for system administrators. Part 1
 
 Set a resource usage limit. Using simple math, you can calculate how many copies of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PuppetConf 2016. Kubernetes for system administrators. Part 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504358/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PuppetConf 2016. Kubernetes for system administrators. Part 1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Set a resource usage limit. Using simple math, you can calculate how many copies of the application you can run - if one copy needs 1 GB of RAM, then having 10 GB of memory, you can run 10 copies. This will not need to be monitored, because I know that the core of the system will simply begin to fulfill the stipulated contract. This contract, or agreement between you and the system, is very important because if it is available, all tools work much better. Thus, we introduce the discipline of execution into the system.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rt/dm/hk/rtdmhkgbqphvjfsp1rnutwussnm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the scheduler will launch this only if each of the replicas gets 1 GB of free memory. If there is not enough memory, the process will not start. So, I enter the kubectl create command, and after its execution the mysql container will be created. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ue/nn/cb/uenncbh1llvnqifuk9cbvpu38pu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is one caveat here related to stateful systems - you have several choices. I highlighted a piece of code in which I indicated that I want to use the PersistentDisk of my cloud provider.</font></font><a name="habracut"></a> <br>
<br>
<img src="https://habrastorage.org/webt/pr/8a/wq/pr8awqvvo0lyyjsgncrxlywt0ok.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be NFS, ISCSI or any other protocol that provides network block-level access to storage devices. I do this in order to disconnect my storage from the machines. If one of the machines fails, I can recreate the process on the other machine using the same data store. If you mount the storage from the host on which the failure occurs, you simply lose your data and will have to restore everything from the backup again.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, our goal is for storage to run faster as our networks grow faster. This is not about migration, but about the ability to quickly mount and unmount the storage outside the machine. This is quite possible to do. Let's see how things are with our hearth - it is still being created, and now I want to create services for it so that other applications can find ours.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hy/2d/oe/hy2doelinhdbejod6z8f_fss65e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as I create this service, Kubernetes will generate a DNS record, so you can just call mysql and automatically detect that this container is running. Let's continue and enter the command $ kubectl create ‚Äìf services / mysql.yaml. As you can see, the container is still being created. By the way, you can watch this demo video on my website. You see what service looks like for a mysql application - it contains the cluster IP addresses, external IP addresses, port numbers and network protocols. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ha/0c/xz/ha0cxzzrsfoyo5ek4hay2kqqxlw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what happens with this particular container. As you can see, it works.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/ty/hw/cstyhwtr63jxia7ykouafay2gy4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, at the moment, I believe that the mysql application really works. The next thing we need is a web application. So let's deploy such an application called "lobsters", I took it on GitHub, this is a clone of Hacker News. It is a Ruby-on-Rails project, I just created a container based on the data given here and the basic configuration. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h4/ub/50/h4ub50vnea02ewzgmu66jtgnld4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you're not up to date: Hacker News will make you super popular at any hacker conference. Just read what is written here, and you can discuss all the popular topics from the world of computer technology. So if you want to impress others - read the news of this portal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, I want to create a clone of this thing and put it on the Internet to make money. Of course, this is not a real business project, but just a demonstration of opportunities. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I am currently deploying an application called Lobsters. From my secret I get the database URL, for which I use the $ kubectl get secrets command. Secret also has a username and password. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qu/lv/x9/qulvx91cws2umcovml7nlpqjbru.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, I want to create a container that will communicate with my application, for which I use the command $ kubectl create ‚Äìf deployments / lobsters.yaml. As you can see, the application is running. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-g/iq/b7/-giqb7vac52pvm5fofzrpgzdshe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, we have an IP address. I enter the $ kubectl get svc command and use the global load balancer, which points to the page with the external IP address 101.198.12.60.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2i/_e/2f/2i_e2flrrchj_apj_fu864dustm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/qq/qy/8o/qqqy8odng1kwohxvqqtdgj_cahm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We‚Äôll go to the browser and try to enter this address through HTTP. Yeah, error waiting for migration! This is Ruby-on-Rails, so I was expecting something like that. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tc/32/yp/tc32ypvkowr_1irq1eesyovcbic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we need a database migration. We need to run this process once, and that‚Äôs it. However, we want to do this in the same way - no authorization on the server, no special servers such as Jump box, we want to contact the scheduler and say: ‚ÄúHey, run this task once and after execution just kill the process!‚Äù. That is, I want to run just one command and exit. Therefore, to perform batch processing using the $ cat jobs / lobsters-db-schema-load.yaml command, I create a Jobs object that implements such a scheme.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b1/ze/ur/b1zeurot_p-tsnh1fnjaldrjhl0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rake command flag ‚Äúdb: schema: load‚Äù is sent directly to the GitHub website and says: ‚Äútake the code image: kelseyhightower / lobsters: 2.0.0 and run this command 1 time‚Äù. The restartPolicy: never line at the end of the code tells Kubernetis that he should run this only once and never repeat it. I also limit the resources of the processor and memory, that is, I indicate the parameters of a suitable machine on which this can be started and executed, after which the database transfer will be completed. So I ‚Äúput on the rails‚Äù all the Jobs objects that should be run on the system using the command $ kubectl create ‚Äìf jobs / lobsters-db-schema-load.yaml. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You see that the corresponding job is created, after which I type the command $ watch kubectl get jobs.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bd/ll/e7/bdlle7wpyyar1wyv7ormfo6kxpw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the container was pulled to the machine, the scheduler worked, the rake task was created. Let's go back and refresh the database error page. As you can see, now our scheme has been successfully implemented. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/2u/gc/ui2ugcq0f4twz46cjnovwkfqsru.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next I need to log in. I use the command $ kubectl create ‚Äìf jobs / lobsters-db-seed.yaml. You see that the scheduler is still loading the container, and after a few seconds the work is completed. To start the migration, we use the same level of code as before. I log in to this page, and all that needs to be done now is to get the content. Content is necessary if we want to ‚Äúraise‚Äù some money. This is what growth hacking looks like, or ‚Äúhacking growth‚Äù - you go to someone else‚Äôs site, grab the content from there and post it on your own site, which looks similar to the original.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/is/qj/7o/isqj7ohlwteznz2dtvayckyugbm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we need not just content, but good content. It would be a shame to let things drift, so I manually borrow some news. You could copy the content automatically, but it is not legal. So I select the news, copy the link address, set the ‚Äútest‚Äù tag, check the box ‚ÄúI am the author of the story located at this URL‚Äù and press the Submit button. See how great the stolen news looks! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b0/mk/oa/b0mkoaerhx41o0t1ce76fklbozg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it's time to scale the application. To do this, you just need to change the definition of what we are doing - instead of 1 replica, go, for example, to 10. Then I run the command block again.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lt/hy/ll/lthylllce0ydg35jdzrry8ovwgg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes accepts this information, performs an action, and now we have 10 copies of the Lobsters application running in our hearth. Moreover, this process is automatically added to the load balancer thanks to the work of Services. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tc/io/pb/tciopbuur3lmjsvcj3pnwdgam_m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what happens in the backend. To do this, I use the $ kubectl get svc command, get a short status and ask to describe it with the $ kubectl describe svc command. Kubernetes automatically detects all of our endpoints and places them behind a load balancer. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sb/mq/dv/sbmqdvkdtcefahi8w0ej8qxzqzs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, everything that is useless is deleted, and everything that is needed is automatically added. We do not need to create this thing again and again, everything is fully integrated into the platform.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next important question is how to update and how to get logs. If you remember, I took away your SSH access, so you need to centralize the logs using something like Log Stash or internal Google Cloud logging. But if you just want to view ad hoc logs, remember that you do not have access to the machines. However, you can use the API to capture logs using container names. To do this, enter the command $ kubectl logs lobsters-240734871-03rmn ‚Äìf, where 03rmn is the name of a specific copy of the lobsters-240734871 application in the container. So you can view the log of each container with a replica, so that if necessary, troubleshoot.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zr/j9/to/zrj9tonhod93xiol95miogdzgis.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's view our content using the $ kubectl get pods command, as you can see, everything works. </font><font style="vertical-align: inherit;">The next important thing to do is hire a marketer. </font><font style="vertical-align: inherit;">He looks at this page and says: ‚ÄúDo what you want, but remove these white spots from the site!‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sq/k3/y0/sqk3y0nwdrnyknrev5r5fsd37fk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All you need to do for this is to create a new container in addition to the already created one and customize the CSS for what we want to promote. </font><font style="vertical-align: inherit;">Let me remind you that we are not talking about nodes, nodes are not important to us, because the system itself will provide exactly what we want. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sequel will be very soon ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HlAXp0-M6SY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504344/index.html">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî CUSTOM SETUP / AWS Amplify + React Native</a></li>
<li><a href="../en504348/index.html">Monowheel: what happens during training, and how to accelerate this process</a></li>
<li><a href="../en504352/index.html">Ten companies that Figma helped achieve new design results and more</a></li>
<li><a href="../en504354/index.html">Reduce the size of the ML model without registration and SMS</a></li>
<li><a href="../en504356/index.html">PHP 8 in eight pieces of code</a></li>
<li><a href="../en504362/index.html">Quickly load large amounts of data in Google Colab</a></li>
<li><a href="../en504370/index.html">Office 365 & Microsoft Teams - Convenience of Collaboration and Impact on Security</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electr√≥nico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>