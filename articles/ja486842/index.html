<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔩 💅 👨🏿 領事+ iptables =：3 👞 🤧 🧑🏾‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2010年、Wargamingには50台のサーバーとシンプルなネットワークモデル（バックエンド、フロントエンド、ファイアウォール）がありました。サーバーの数が増加し、モデルがさらに複雑になりました。ステージング、ACLを備えた分離されたVLAN、次にVRFを備えたVPN、L2上のACLを備えたVLA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>領事+ iptables =：3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2010年、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargamingに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は50台のサーバーとシンプルなネットワークモデル（バックエンド、フロントエンド、ファイアウォール）がありました。サーバーの数が増加し、モデルがさらに複雑になりました。ステージング、ACLを備えた分離されたVLAN、次にVRFを備えたVPN、L2上のACLを備えたVLAN、L3上のACLからのVRF。頭が回転していますか？もっと楽しくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーが非常に多くの異機種混在セグメントで16,000枚も動作し始めたとき、それは不可能になりました。したがって、彼らは別の解決策を考え出しました。私たちはNetfilterスタックを採用し、Consulをデータソースとして追加し、高速分散ファイアウォールを取得しました。それらはルーターのACLを置き換え、外部および内部ファイアウォールとして使用されました。動的なツール管理のために、食料品ネットワークへのユーザーアクセスの制御からネットワークセグメントの分離まで、あらゆる場所で使用されるBEFWシステムを開発しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてがどのように機能するか、そしてなぜこのシステムを詳細に検討する必要があるのか​​、と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">年金</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）-ミンスク企業開発センターのメンテナンスユニットのインフラストラクチャセキュリティグループの責任者。</font><font style="vertical-align: inherit;">IvanはSELinuxファンで、Perlが大好きで、コードを書いています。</font><font style="vertical-align: inherit;">彼はIBグループの責任者として、ログ、バックアップ、R＆Dを定期的に使用して、Wargamingをハッカーから保護し、社内のすべてのゲームサーバーの運用を保証しています。</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴参照</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
方法を説明する前に、これをどのようにして実現したのか、なぜそれが必要なのかを説明します。これを行うために、私たちは9年前に乗り換えました：2010年、World of Tanksのみが登場しました。 Wargamingには約50台のサーバーがありました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">企業サーバーの成長グラフ。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ネットワークモデルがありました。その時それは最適でした。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2010年のネットワークモデル。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
フロントエンドには、私たちを破壊したい悪者がいますが、その中にファイアウォールがあります。バックエンドにはファイアウォールはありませんが、そこには50台のサーバーがあります。すべてうまくいきます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4年間で、サーバーフリートは100倍になり、最大5,000になりました。最初の分離されたネットワークが登場しました-ステージング：それらは本番環境に入ることができず、危険なことが多いものがそこでスピンしていました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2014年のネットワークモデル。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
慣性により、同じ鉄片がすべて使用され、すべての作業は分離されたVLANで行われました。ACLは、接続を許可または禁止するVLANに書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2016年には、サーバーの数は8000に達しました。Wargamingは他のスタジオを吸収し、追加のアフィリエイトネットワークが登場しました。それらは私たちのもののようですが、完全ではありません。VLANはパートナーには機能しないことが多く、VRFでVPNを使用する必要があり、分離はより複雑になります。 ACL分離株の混合物が成長した。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年のネットワークモデル。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2018年の初めまでに、車の保有台数は16,000に増加しました。6つのセグメントがあり、残りは、クローズドセグメントを含め、財務データが保存されていて、カウントしませんでした。たとえばIVSから、VPN経由で接続されたコンテナーネットワーク（Kubernetes）、DevOps、クラウドネットワークがあります。多くのルールがありました-それは痛いです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018年のネットワークモデルと分離方法。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分離に使用したのは、L2にACLを備えたVLAN、L3にACLを備えたVRF、VPNなどです。</font><font style="vertical-align: inherit;">過度に。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰もがACLとVLANを使用しています。</font><font style="vertical-align: inherit;">一般的に何が間違っていますか？</font><font style="vertical-align: inherit;">ハロルドは、痛みを隠して、この質問に答えます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの問題がありましたが、5つの大きな問題がありました。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいルールの幾何価格の上昇</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初にそのようなルールがあるかどうかを最初に確認する必要があったため、新しいルールはそれぞれ前のルールよりも長く追加されました。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント内にファイアウォールはありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">セグメントはどういうわけか互いに分離されていて、内部にはすでに十分なリソースがありません。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルールは長い間適用されてきました。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンズワンローカルルールオペレーターは1時間で書くことができます。</font><font style="vertical-align: inherit;">グローバルは数日かかりました。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルールの監査の難しさ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">より正確には、それは不可能でした。</font><font style="vertical-align: inherit;">最初の規則は2010年に書かれており、彼らの作者のほとんどはもはや会社で働いていません。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラストラクチャに対する低レベルの制御</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これが主な問題です-何が起こっているのかよくわかりませんでした。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークエンジニアが2018年に聞いたときの様子は次のとおりです。「さらにACLが必要です。」</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018年の初めに、それについて何かをすることが決定されました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統合の価格は常に上昇しています。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開始点は、デバイスのメモリが不足したため、大規模なデータセンターが分離されたVLANおよびACLのサポートを停止したことでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策：人的要因を取り除き、最大限のアクセスの提供を自動化しました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい規則が長期間適用されます。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決策：ルールの適用を高速化し、ルールを分散して並列化します。これを行うには、分散システムが必要です。これにより、1000システムごとにrsyncまたはSFTPを使用せずに、ルールが独自に配信されます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント内のファイアウォールの欠如。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じネットワーク内で異なるサービスが出現したとき、セグメント内のファイアウォールが私たちに飛んでいきました。解決策：ホストベースのファイアウォールを使用します。私たちがLinuxを持っているほとんどすべての場所で、iptablesはどこにでもあり、これは問題ではありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルールの監査の難しさ。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決策：すべてのルールを1か所にまとめてレビューと管理を行い、すべてを監査できるようにします。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラストラクチャに対する低レベルの制御。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決策：すべてのサービスとそれらの間のアクセスの一覧を取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、技術的なプロセスというよりは、管理上のプロセスです。</font><font style="vertical-align: inherit;">特にプロモーション中や休暇中は、週に200〜300の新しいリリースがある場合があります。</font><font style="vertical-align: inherit;">ただし、これはDevOpsの1つのチームのみを対象としています。</font><font style="vertical-align: inherit;">非常に多くのリリースがあるため、必要なポート、IP、統合の種類を確認することは不可能です。</font><font style="vertical-align: inherit;">したがって、チームにインタビューを行う特別なトレーニングを受けたサービスマネージャーが必要でした。「何があり、なぜそれを上げたのですか？」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが立ち上げたすべての後、2019年のネットワークエンジニアは次のようになり始めました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">領事</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
発見したすべてをサービスマネージャーの助けを借りてConsulに配置し、そこからiptablesルールを作成することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのようにしてこれを行うことにしたのですか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはすべてのサービス、ネットワーク、ユーザーを収集します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらに基づいてiptablesルールを作成しましょう。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動制御。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利益。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConsulはリモートAPIではなく、すべてのノードで動作し、iptablesに書き込むことができます。</font><font style="vertical-align: inherit;">余分なものを取り除く自動制御を考え出すだけで、問題のほとんどは解決されます！</font><font style="vertical-align: inherit;">残りはプロセスで確定します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ領事？</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よく確立されました。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2014-15では、パスワードを格納するVaultのバックエンドとして使用しました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを失うことはありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。使用中、領事はいかなる事故でもデータを失うことはありませんでした。これは、ファイアウォール管理システムの大きな利点です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2P通信は、変化の広がりを加速します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 P2Pを使用すると、すべての変更が迅速に行われ、数時間待つ必要がありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">便利なREST API。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apache ZooKeeperも検討しましたが、REST APIがないため、松葉杖を使用する必要があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、キーストア（KV）およびディレクトリ（Service Discovery）として機能し</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。サービス、カタログ、データセンターをすぐに保存できます。これは、私たちだけでなく、近隣のチームにとっても便利です。グローバルなサービスを構築するとき、私たちは大きなことを考えるからです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargamingスタックの一部であるGoで書かれています。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはこの言語が大好きで、多くのGo開発者がいます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強力なACLシステム。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulでは、ACLを使用して、誰と何を書くかを管理できます。</font><font style="vertical-align: inherit;">ファイアウォールのルールが他のルールと重複しないことを保証します。これにより問題が発生することはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、領事には欠点があります。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスバージョンがない場合、データセンター内で拡張されません。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">連合によってのみスケーリングされます。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークの品質とサーバーの負荷に大きく依存します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulは、ネットワークに速度の不均一などの遅延がある場合、ビジーサーバー上のサーバーとして正常に機能しません。</font><font style="vertical-align: inherit;">これは、P2P接続と更新配布モデルが原因です。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセシビリティ監視の難しさ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">領事はすべてが順調であると言うことができますが、彼は長い間亡くなっています。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題のほとんどは領事の運営中に解決したので、それを選びました。</font><font style="vertical-align: inherit;">同社は代替のバックエンドを計画していますが、問題への対処方法を学び、現在も執政官と暮らしています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">領事のしくみ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
条件付きデータセンターでは、3〜5台のサーバーをインストールします。</font><font style="vertical-align: inherit;">1つまたは2つのサーバーは機能しません。データが一致しない場合、クォーラムを整理して、誰が正しいか、誰が間違っているかを判断できません。</font><font style="vertical-align: inherit;">5つを超えると意味がなくなり、パフォーマンスが低下します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントは任意の順序でサーバーに接続します：同じエージェント、フラグのみ</font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、クライアントはP2P接続のリストを受け取り、クライアント間の接続を構築します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グローバルレベルでは、複数のデータセンターを相互接続しています。</font><font style="vertical-align: inherit;">また、P2Pを接続して通信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のデータセンターからデータを収集する場合、リクエストはサーバー間で送信されます。</font><font style="vertical-align: inherit;">このような方式は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serfプロトコル</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ConsulのようなSerfプロトコルはHashiCorpによって開発されました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">領事に関するいくつかの重要な事実</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
領事は彼の仕事を説明する文書を持っています。</font><font style="vertical-align: inherit;">知っておく価値のある選択された事実だけをあげます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulサーバーは有権者の中からマスターを選択します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Consulは各データセンターのサーバーのリストからウィザードを選択し、サーバーの数に関係なく、すべての要求はウィザードのみに送信されます。</font><font style="vertical-align: inherit;">ウィザードをぶら下げても再選にはつながりません。</font><font style="vertical-align: inherit;">ウィザードが選択されていない場合、要求は誰にも提供されません。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">水平スケーリングが必要ですか？</font><font style="vertical-align: inherit;">申し訳ありませんが、ありません。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のデータセンターへのリクエストは、どのサーバーにアクセスしたかに関係なく、マスターからマスターに送信されます。</font><font style="vertical-align: inherit;">選択したマスターは、転送要求の負荷を除いて、負荷の100％を受け取ります。</font><font style="vertical-align: inherit;">すべてのデータセンターサーバーには最新のデータのコピーがありますが、答えは1つだけです。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーリングする唯一の方法は、クライアントで古いモードを有効にすることです。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古いモードでは、クォーラムなしで応答できます。これは、データの一貫性を拒否するモードですが、通常よりも少し速く読み取り、どのサーバーも応答します。当然、録音はマスターを通してのみ行われます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consulは、データセンター間でデータをコピーしません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。連携を収集する場合、各サーバーは独自のデータのみを保持します。他の人にとって、彼はいつも誰かに目を向けます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作の原子性は、トランザクション外では保証されません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。あなただけが何かを変更できるわけではないことを覚えておいてください。別にそれが必要な場合は、ロックを使用してトランザクションを実行します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロッキング操作は、ブロッキングを保証するものではありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リクエストはマスターからマスターに送られ、直接ではないため、たとえば別のデータセンターでロックしたときにロックが機能する保証はありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACLもアクセスを保証しません（多くの場合）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 ACLはフェデレーションの1つのデータセンター-ACLデータセンター（プライマリDC）に格納されているため、機能しない可能性があります。 DCが応答しない場合、ACLは機能しません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのホバリングウィザードでフェデレーション全体がフリーズします</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。たとえば、フェデレーションには10のデータセンターがあり、1つには不良ネットワークがあり、1つのマスターが落ちます。彼と通信するすべての人が輪になっています。要求が行われていますが、応答がなく、スレッドがハングします。これがいつ発生するかを知ることはできません。1〜2時間で連合全体が崩壊します。あなたはそれについて何もすることができません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステータス、クォーラム、選挙は別のスレッドで処理されます。</font><font style="vertical-align: inherit;">再選択は行われず、ステータスには何も表示されません。</font><font style="vertical-align: inherit;">あなたはあなたが生きている領事を持っていると思って、あなたは尋ねます、そして何も起こりません-答えはありません。</font><font style="vertical-align: inherit;">さらに、ステータスはすべてが正常であることを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはこの問題に直面し、それを回避するためにデータセンターの特定の部分を再構築する必要がありました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul Enterpriseのビジネスバージョンには、上記の欠点がいくつかありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">投票、配布、スケーリングなど、多くの便利な機能があります。</font><font style="vertical-align: inherit;">「しかし」は1つしかありません。分散システムのライセンスシステムは非常に高価です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライフハック：</font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-エージェントのすべての病気の治療法。</font><font style="vertical-align: inherit;">何かがうまくいかない場合は、データを削除し、コピーからデータをダウンロードしてください。</font><font style="vertical-align: inherit;">ほとんどの場合、領事は機能します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befw</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、領事に追加した内容について説明します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bed and</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ack </font><strong><font style="vertical-align: inherit;">the </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nd </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the F </font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the ire of </font><strong><font style="vertical-align: inherit;">the W</font></strong><font style="vertical-align: inherit;"> allの</font><font style="vertical-align: inherit;">頭字語</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初のテストコミットをリポジトリに入れるために、リポジトリを作成したときに何らかの方法で製品に名前を付ける必要がありました。</font><font style="vertical-align: inherit;">この名前は残っています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルールテンプレート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルールはiptables構文で記述されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P入力ドロップ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -m状態—状態が関連付けられ、確立されている-j ACCEPT</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -i lo -j ACCEPT</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A入力-j BEFW</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とlocalhost </font><font style="vertical-align: inherit;">
を除いて</font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">すべてBEFWチェーンに行き</font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">テンプレートは何でもかまいません。これは単なる例です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFWは何に役立ちますか？</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちにはサービスがあり、常にポートがあり、それが機能するノードがあります。</font><font style="vertical-align: inherit;">私たちのノードから、ローカルでエージェントに質問し、何らかのサービスがあることを確認できます。</font><font style="vertical-align: inherit;">タグを付けることもできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consulで実行および登録されているサービスはすべて、iptablesルールになります。</font><font style="vertical-align: inherit;">SSH-ポート22を開きます。bashスクリプトは単純です。curlとiptablesで、他に必要なものはありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お客さま</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての人にではなく、選択的にアクセスを開く方法は？</font><font style="vertical-align: inherit;">サービスの名前で、IPリストをKVリポジトリに追加します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、10番目のネットワークのすべてのユーザーがSSH_TCP_22サービスにアクセスできるようにします。</font><font style="vertical-align: inherit;">小さなTTLフィールドを1つ追加しますか？</font><font style="vertical-align: inherit;">そして今、例えば、私たちは一時的な権限を持っています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスとお客様をつなぎます。各KVストレージの準備ができているため、サービスがあります。</font><font style="vertical-align: inherit;">今では、全員にではなく、選択的にアクセス権を付与しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">団体</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセス用に何千ものIPを書き込むたびに、私たちは疲れます。</font><font style="vertical-align: inherit;">グループ化を考えてみましょう-KVの個別のサブセットです。</font><font style="vertical-align: inherit;">これをエイリアス（またはグループ）と呼び、同じ原則に従ってグループをそこに格納します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続：SSHをP2Pだけでなく、グループ全体または複数のグループで開くことができるようになりました。</font><font style="vertical-align: inherit;">同様に、TTLがあります。グループに追加したり、グループから一時的に削除したりできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統合</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの問題は人的要因と自動化です。これまでのところ、そのように解決しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはPuppetと連携し、システム（アプリケーションコード）に関連するすべてのものをPuppetに転送します。 Puppetdb（通常のPostgreSQL）は、そこで実行されているサービスのリストを保存します。リソースタイプで検索できます。そこに誰がどこへ行くのかを見つけることができます。このためのプルリクエストおよびマージリクエストシステムもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの転送を支援する最も簡単なソリューションであるbefw-syncを作成しました。最初に、同期cookieはpuppetdbに送られます。そこでHTTP APIが構成されます。どのサービスを実行し、何を実行する必要があるかを尋ねます。それから彼らは領事に要求を出します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
統合はありますか？</font><font style="vertical-align: inherit;">はい：彼らはルールを作成し、プルリクエストの受け入れを許可しました。</font><font style="vertical-align: inherit;">いくつかのポートが必要ですか、またはホストをいくつかのグループに追加しますか？</font><font style="vertical-align: inherit;">プルリクエスト、確認-「他の200個のACLを見つけて、それについて何かしようとする」ことはもうありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
空のルールチェーンを使用したローカルホストのpingには0.075ミリ秒かかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このチェーンに10,000のiptablesを追加します。</font><font style="vertical-align: inherit;">その結果、pingは5倍に増加します。iptablesは完全に線形であり、各アドレスの処理には時間がかかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数千のACLを移行するファイアウォールの場合、多くのルールがあり、これにより遅延が発生します。</font><font style="vertical-align: inherit;">ゲームプロトコルの場合、これは良くありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ipset</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><strong><font style="vertical-align: inherit;">10,000個のアドレス</font></strong><font style="vertical-align: inherit;">を入れると</font><strong><font style="vertical-align: inherit;">、</font></strong><font style="vertical-align: inherit;"> pingはさらに減少します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポイントは、ipsetの「O」（アルゴリズムの複雑さ）は、ルールの数に関係なく、常に1であることです。</font><font style="vertical-align: inherit;">確かに、制限があります-ルールは65535を超えることはできません。今のところは、これらを組み合わせて、拡張し、2つのipsetを1つにまとめることができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレージ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反復プロセスの論理的な継続は、サービスの顧客情報をipsetに格納することです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで同じSSHができました。すぐに100 IPを書き込むのではなく、通信するipsetという名前と次のルールを設定し</font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">「誰がここにいない、つまりDROPである」というルールをやり直すことができますが、より明確にできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでルールとセットができました。</font><font style="vertical-align: inherit;">主なタスクは、ルールを記述する前にセットを作成することです。それ以外の場合、iptablesはルールを記述しません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的なスキーム</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダイアグラムの形で、私が言ったすべてはこのようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puppetにコミットすると、すべてがホストに送信され、サービスがここにあり、ipsetがあり、登録されていない人は許可されません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">許可して拒否</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
世界をすばやく保存したり、誰かをすばやくオフにしたりするために、すべてのチェーンの最初に2つのipset：</font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">を作成</font><font style="vertical-align: inherit;">しました</font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">使い方？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ボットを持つ誰かが私たちのWebに負荷をかけます。</font><font style="vertical-align: inherit;">以前は、ログからIPを見つける必要がありました。ネットワークエンジニアに問い合わせて、トラフィックのソースを見つけて禁止できるようにしました。</font><font style="vertical-align: inherit;">今では違って見えます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは領事に出荷し、2.5秒待って、完了です。</font><font style="vertical-align: inherit;">ConsulはP2Pを通じて迅速に配布されるため、世界中のどこにいても機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どういうわけか、WOTを完全に停止し、ファイアウォールを間違えました。</font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これはそのような場合に対する私たちの保険です。</font><font style="vertical-align: inherit;">ファイアウォールのどこかで間違いを犯した場合、どこかで何かがブロックされた場合は、常に条件</font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">送信して</font><font style="vertical-align: inherit;">すべてを迅速に上げる</font><font style="vertical-align: inherit;">ことができ</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">その後、すべてを手で修正します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その他のセット</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スペースに他のセットを追加できます</font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何のために？</font><font style="vertical-align: inherit;">たとえば、クラスターの一部の切断をエミュレートするために、誰かがipsetを必要とする場合があります。</font><font style="vertical-align: inherit;">誰でもどんなセットでも持参して呼び出すことができ、彼らは領事館から連れて行かれます。</font><font style="vertical-align: inherit;">同時に、セットはiptablesルールに参加することも、チームのように</font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なることもできます。デーモンによって一貫性がサポートされます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前は次のようでした：ユーザーがネットワークに接続し、ドメインを介してパラメーターを受信しました。</font><font style="vertical-align: inherit;">次世代のファイアウォールが登場するまで、シスコはユーザーがどこにいてIPがどこにあるのか理解できませんでした。</font><font style="vertical-align: inherit;">したがって、アクセスはホスト名-マシンを介してのみ許可されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは何をしましたか？</font><font style="vertical-align: inherit;">住所を受け取った時点で押し込まれた。</font><font style="vertical-align: inherit;">通常、それはdot1x、Wi-FiまたはVPNです-すべてがRADIUSを通過します。</font><font style="vertical-align: inherit;">各ユーザーについて、ユーザー名でグループを作成し、そのdhcp.leaseに等しいTTLを含むIPを入れます。期限が切れるとすぐに、ルールは表示されなくなります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、ユーザー名でサービスや他のグループへのアクセスを開くことができます。</font><font style="vertical-align: inherit;">ホスト名が変更されたときの苦痛を取り除き、ネットワークエンジニアがシスコを必要としなくなったため、負荷を軽減しました。</font><font style="vertical-align: inherit;">現在、エンジニア自身がサーバーへのアクセスを規定しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">絶縁</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
並行して、断熱材の分解を開始しました。</font><font style="vertical-align: inherit;">サービスマネージャーがインベントリを取得し、すべてのネットワークを分析しました。</font><font style="vertical-align: inherit;">それらを同じグループに分解し、必要なサーバー上で、たとえば拒否するためにグループを追加しました。</font><font style="vertical-align: inherit;">これで、同じステージング分離が本番環境ではrules_denyに含まれますが、本番環境自体では行われません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスキームは迅速かつ簡単に機能します。サーバーからすべてのACLを削除し、ハードウェアをアンロードし、分離されたVLANの数を減らします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全性管理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前は、特別なトリガーが機能し、誰かがファイアウォールルールを自分の手で変更したときに通知されました。</font><font style="vertical-align: inherit;">巨大なファイアウォールルールチェッカーを作成しましたが、難しかったです。</font><font style="vertical-align: inherit;">次に、整合性がBEFWを制御します。</font><font style="vertical-align: inherit;">彼は熱心に彼が作ったルールが変更されないことを確認します。</font><font style="vertical-align: inherit;">誰かがファイアウォールのルールを変更した場合、彼はすべてを元に戻します。</font><font style="vertical-align: inherit;">「私は自宅で仕事をするためにここですぐにプロキシを上げました」-そのようなオプションはもうありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFWは、サービスからipsetを制御し、BEFWチェーン内のサービスルールbefw.confにリストします。</font><font style="vertical-align: inherit;">ただし、他のチェーンとルール、および他のipsetには従いません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事故保護</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFWは常に最後に成功した状態を、state.binのバイナリ構造に直接保存します。問題が発生した場合は、常にこのstate.binにロールバックされます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、データを送信しなかった場合、または誰かがミスを犯し、適用できないルールを使用した場合のConsulの不安定な保険です。ファイアウォールがなくならないようにするため、ある段階でエラーが発生すると、BEFWは最後の状態にロールバックします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重大な状況では、これは、正常に機能するファイアウォールを維持することを保証します。管理者が来て修正することを期待して、すべての灰色のネットワークを開きます。いつか私は設定でそれを取り出すでしょうが、今私たちは3つの灰色のネットワークを持っています：10 / 8、172 / 12、192.168 / 16。私たちの領事の一部として、これは更なる発展を助ける重要な機能です。</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが遭遇したバグについてお話します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset add set 0.0.0.0/0。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ipset 0.0.0.0/0に追加するとどうなりますか？すべてのIPが追加されますか？インターネットアクセスは開かれますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいえ、2時間のダウンタイムが発生するバグが発生します。さらに、バグは2016年以降機能しておらず、番号＃1297092のRedHat Bugzillaにありますが、開発者のレポートによると、偶然発見されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今BEFWは、厳格なルール、持っている</font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二つのアドレスに変身を：</font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset復元セット&lt;ファイル。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたがそれを言うとき、ipsetは何をします</font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か？ iptablesと同じように機能すると思いますか？データを回復しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
種類は何もありません-彼はマージを行い、古いアドレスは消えません、あなたはアクセスを閉じません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分離をテストしたところ、バグが見つかりました。現在、かなり複雑なシステムがあります- </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行されるの</font></font><code>create temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font><font style="vertical-align: inherit;">なく、</font></font><code>restore flush temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして</font></font><code>restore temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。スワップの最後：アトミック性のため。最初に実行し</font></font><code>flush</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そのときにいくつかのパッケージが到着すると、そのパッケージは破棄され、何かがうまくいきません。したがって、少し黒魔術があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul kv get -datacenter = other。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに述べたように、データを要求していると思いますが、データまたはエラーが発生します。これはConsulを介してローカルで実行できますが、この場合、どちらか一方がハングします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルのConsulクライアントは、HTTP APIのラッパーです。しかし、それはハングするだけで、Ctrl + C、またはCtrl + Zのいずれにも応答しません。</font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">隣接するコンソールで。</font><font style="vertical-align: inherit;">大規模なクラスターを構築しているときに、これに遭遇しました。</font><font style="vertical-align: inherit;">しかし、まだ解決策はありません。領事でこのエラーを修正する準備をしています。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">領事リーダーは応答していません。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データセンターのマスターは応答しません。「おそらく、再選択アルゴリズムは今すぐ機能しますか？」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいえ、機能しません。監視しても何も表示されません。領事は、コミットメントインデックスがある、リーダーが見つかった、すべてが正常であると言うでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやってこれと戦っていますか？</font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cronで毎時間。</font><font style="vertical-align: inherit;">50台のサーバーがある場合-大したことはありません。</font><font style="vertical-align: inherit;">16,000になると、それがどのように機能するかを理解できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、次の利点が得られました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのLinuxマシンを100％カバーします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">速度。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オートメーション</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鉄とネットワークのエンジニアを奴隷から解放した。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほぼ無限の統合の機会があります。Kubernetesを使用しても、Ansibleを使用しても、Pythonを使用しても。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">短所</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：現在私たちが住んでいる領事。非常に高額のエラー。</font><font style="vertical-align: inherit;">例として、午後6時（ロシアのプライムタイム）に1回、ネットワークのリストで何かを支配しました。</font><font style="vertical-align: inherit;">私たちはちょうどその時BEFWで断熱材を建てていました。</font><font style="vertical-align: inherit;">どこかで間違えたようですが、マスクを間違えたようですが、すべてが2秒で落ちました。</font><font style="vertical-align: inherit;">監視が点灯すると、当直の担当官が「すべては私たちにあります！」</font><font style="vertical-align: inherit;">なぜこれが起こったのかを事業部に説明したとき、部長は灰色に変わりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーの代償は非常に高いため、独自の複雑な予防手順を思い付きました。</font><font style="vertical-align: inherit;">大規模な製品に実装する場合は、マスタートークンをConsul経由で全員に渡す必要はありません。</font><font style="vertical-align: inherit;">ひどく終わります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">費用。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードは400時間だけで書きました。</font><font style="vertical-align: inherit;">私の4人のチームをサポートするために、月に10時間を費やしています。</font><font style="vertical-align: inherit;">新世代のファイアウォールの価格と比較すると、無料です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予定。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長期計画は、領事と引き換えに、または領事に加えて代替輸送手段を探すことです。</font><font style="vertical-align: inherit;">おそらくそれはカフカかそのようなものでしょう。</font><font style="vertical-align: inherit;">しかし、今後数年間は領事に住んでいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
即時計画：Fail2banとの統合、監視、nftables、場合によっては他のディストリビューション、メトリック、高度な監視、最適化との統合。</font><font style="vertical-align: inherit;">Kubernetesのサポートも計画のどこかにあります。現在、いくつかのクラスターと要望があるからです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の計画：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">交通異常を検索します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークマップ管理;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesのサポート。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのシステムのパッケージの組み立て。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web UI</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、構成の拡張、メトリックの増加、最適化に常に取り組んでいます。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトに参加します。</font><font style="vertical-align: inherit;">プロジェクトはクールであることがわかりましたが、残念ながら、これはまだ一人のプロジェクトです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubにアクセス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">、コミット、テスト、何かを提供し、評価を行ってください。</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それまでの間、</font><font style="vertical-align: inherit;">4月6日と7日にサンクトペテルブルクで開催される</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">準備を進めて</font><font style="vertical-align: inherit;">おり、高負荷システムの開発者に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポートの提出を</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">依頼しています</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">経験豊富なスピーカーはすでに何をすべきかを知っているので、スピーチの初心者は少なくともを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試す</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことをお勧めし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">スピーカーとして会議に参加することには、いくつかの利点があります。</font><font style="vertical-align: inherit;">これは、たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後で読むことができます</font><font style="vertical-align: inherit;">。</font></font></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486822/index.html">[ドックで]フラッター。パート4. Web開発者向け</a></li>
<li><a href="../ja486824/index.html">ANTLRを使用する際の悪いアドバイス</a></li>
<li><a href="../ja486826/index.html">Django 2とViber REST APIで本格的なViberbotを作成します。パート1-Webhook</a></li>
<li><a href="../ja486828/index.html">フードデザインダイジェスト、2020年1月</a></li>
<li><a href="../ja486832/index.html">タイガは何年ですか-わかりません</a></li>
<li><a href="../ja486844/index.html">Facebook Webhook処理の進化：1秒あたり0から25,000に</a></li>
<li><a href="../ja486850/index.html">新しい指定席-カプセルホテルのよう</a></li>
<li><a href="../ja486858/index.html">本格的なViberbotの作成。パート2-最初の連絡先または「conversion_started」</a></li>
<li><a href="../ja486860/index.html">ATX12VO-新しい方法を食べる</a></li>
<li><a href="../ja486862/index.html">モーションデザインが人とのつながりを助ける5つの理由</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>