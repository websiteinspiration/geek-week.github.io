<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💕 👩🏽‍🤝‍👩🏼 📱 PostgreSQLロック：2.文字列ロック 🧕🏽 🦒 👩‍❤️‍👨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前回、オブジェクトレベルのロック、特にリレーションシップのロックについて説明しました。今日は、PostgreSQLで行ロックがどのように配置され、オブジェクトロックと共にどのように使用されるかを確認し、待機キューについて、また順番を変えて登る人について説明します。
 
 
 
 行ロック
 端末
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLロック：2.文字列ロック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/463819/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトレベルのロック</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、特にリレーションシップのロックについて説明しました。</font><font style="vertical-align: inherit;">今日は、PostgreSQLで行ロックがどのように配置され、オブジェクトロックと共にどのように使用されるかを確認し、待機キューについて、また順番を変えて登る人について説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/u5/jj/6xu5jj3edymfhel21v9obwhsxai.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行ロック</font></font></h1><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">端末</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前回の記事からいくつかの重要な結論を思い出させてください。</font></font><br>
<br>
<ul>
<li>   -    .</li>
<li>   ,    (contention)    .</li>
<li>  ,   ,       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに、1つの行の変更によって、同じテーブルの他の行がブロックされないようにする必要があります。しかし、各行を独自のロックで開始する余裕はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決する方法はいくつかあります。一部のDBMSでは、ロックのレベルが高くなります。行レベルのロックが多すぎる場合、それらは1つのより一般的なロック（たとえば、ページレベルまたはテーブル全体）に置き換えられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後で見るように、PostgreSQLもこのメカニズムを使用しますが、これは述語ロックに対してのみです。ラインロックは異なります。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLでは、行がロックされているという情報は、</font><font style="vertical-align: inherit;">（RAMではなく）データページ内の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">バージョンに</font></a><font style="vertical-align: inherit;">のみ排他的に格納さ</font><font style="vertical-align: inherit;">れます。つまり、これは通常の意味でのブロックではなく、単なる標識です。この符号は、実際には追加の情報ビットと組み合わせたxmaxトランザクション番号です。少し後で、これがどのように機能するかを詳しく見ていきます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プラス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、リソースを消費することなく、好きなだけ行をブロックできることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">点が</font><font style="vertical-align: inherit;">あります。ロックに関する情報はRAMに提示されないため、他のプロセスが並ぶことはできません。また、監視の可能性はありません（ロックを計算するには、テーブル全体を読み取る必要があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
監視は問題ありませんが、キューで何かを行う必要があります。</font><font style="vertical-align: inherit;">これを行うには、「通常の」ロックを使用する必要があります。</font><font style="vertical-align: inherit;">行が解放されるまで待機する必要がある場合は、実際には、ブロッキングトランザクションが終了するまで待機する必要があります。コミットまたはロールバック時にすべてのロックが解放されます。</font><font style="vertical-align: inherit;">このため、ブロッキングトランザクションのブロッキング番号をリクエストできます（これは、トランザクション自体が例外モードで保持しています）。</font><font style="vertical-align: inherit;">したがって、使用されるロックの数は、同時に実行されるプロセスの数に比例し、変更される行の数には比例しません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">卓越したモード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回線をロックできるモードは全部で4つあります。</font><font style="vertical-align: inherit;">これらのうち、2つのモードは、</font><font style="vertical-align: inherit;">一度に1つのトランザクションのみが保持できる</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">排他</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックを</font><font style="vertical-align: inherit;">表します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li> FOR UPDATE    ( ) .</li>
<li> FOR NO KEY UPDATE —    ,       ( ,         ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPDATEコマンド自体は、最小限の適切なロックモードを選択します。</font><font style="vertical-align: inherit;">通常、行はFOR NO KEY UPDATEモードでロックされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">覚えている</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行を削除または変更するときに、現在のトランザクションのバージョン番号は、現在の現行バージョンのXMAX分野で書かれています。</font><font style="vertical-align: inherit;">行のバージョンがこのトランザクションによって削除されたことを示しています。</font><font style="vertical-align: inherit;">そのため、同じxmax番号がブロッキングの兆候として使用されます。</font><font style="vertical-align: inherit;">実際、ラインのバージョンのxmaxがアクティブな（まだ完了していない）トランザクションに対応し、この特定のラインを更新したい場合、トランザクションが完了するのを待つ必要があるため、追加のサインは必要ありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見てみましょう。</font><font style="vertical-align: inherit;">前の記事と同じように、アカウントのテーブルを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts(<font></font>
  acc_no <span class="hljs-type">integer</span> <span class="hljs-keyword">PRIMARY KEY</span>,<font></font>
  amount <span class="hljs-type">numeric</span><font></font>
);<font></font>
=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">100.00</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">200.00</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">300.00</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、ページを見るには、すでにおなじみのpageinspect拡張機能が必要です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> pageinspect;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
便宜上、関心のある情報のみを表示するビューを作成します：xmaxといくつかの情報ビット。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> accounts_v <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'(0,'</span>||lp||<span class="hljs-string">')'</span> <span class="hljs-keyword">AS</span> ctid,<font></font>
       t_xmax <span class="hljs-keyword">as</span> xmax,
       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">128</span>) &gt; <span class="hljs-number">0</span>   <span class="hljs-keyword">THEN</span> <span class="hljs-string">'t'</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> lock_only,
       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">4096</span>) &gt; <span class="hljs-number">0</span>  <span class="hljs-keyword">THEN</span> <span class="hljs-string">'t'</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> is_multi,
       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (t_infomask2 &amp; <span class="hljs-number">8192</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'t'</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> keys_upd,
       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">16</span>) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'t'</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> keyshr_lock,
       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> (t_infomask &amp; <span class="hljs-number">16</span>+<span class="hljs-number">64</span>) = <span class="hljs-number">16</span>+<span class="hljs-number">64</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'t'</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> shr_lock
<span class="hljs-keyword">FROM</span> heap_page_items(get_raw_page(<span class="hljs-string">'accounts'</span>,<span class="hljs-number">0</span>))
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> lp;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、トランザクションを開始し、最初の口座の金額（キーは変更されません）と2番目の口座の番号（キーは変更されます）を更新します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;<font></font>
=&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> acc_no = <span class="hljs-number">20</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">2</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビューを調べます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts_v <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">2</span>;
</code></pre><pre><code class="plaintext hljs"> ctid  |  xmax  | lock_only | is_multi | keys_upd | keyshr_lock | shr_lock <font></font>
-------+--------+-----------+----------+----------+-------------+----------<font></font>
 (0,1) | 530492 |           |          |          |             | <font></font>
 (0,2) | 530492 |           |          | t        |             | <font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックモードは、keys_updated情報ビットによって決定されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT FOR UPDATEコマンドを使用して行をロックするときにも同じxmaxフィールドが使用されますが、この場合、追加の情報ビット（xmax_lock_only）が表示されます。これは、行のバージョンがロックされているだけで、削除されておらず、関連性があることを示しています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ROLLBACK</span>;<font></font>
=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR NO KEY</span> <span class="hljs-keyword">UPDATE</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">2</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts_v <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">2</span>;
</code></pre><pre><code class="plaintext hljs"> ctid  |  xmax  | lock_only | is_multi | keys_upd | keyshr_lock | shr_lock <font></font>
-------+--------+-----------+----------+----------+-------------+----------<font></font>
 (0,1) | 530493 | t         |          |          |             | <font></font>
 (0,2) | 530493 | t         |          | t        |             | <font></font>
(2 rows)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ROLLBACK</span>;
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有モード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのモードは</font><font style="vertical-align: inherit;">、複数のトランザクションで保持できる</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（共有）ロックです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FOR SHAREモードは、文字列を読み取る必要がある場合に使用されますが、別のトランザクションによって文字列を変更することはできません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FOR KEY SHAREモードでは、文字列を変更できますが、非キーフィールドのみを変更できます。</font><font style="vertical-align: inherit;">このモードは特に、外部キーをチェックするときにPostgreSQLによって自動的に使用されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
様子を見よう。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR KEY</span> <span class="hljs-keyword">SHARE</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">2</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SHARE</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行バージョンでは次のようになります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts_v <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">2</span>;
</code></pre><pre><code class="plaintext hljs"> ctid  |  xmax  | lock_only | is_multi | keys_upd | keyshr_lock | shr_lock <font></font>
-------+--------+-----------+----------+----------+-------------+----------<font></font>
 (0,1) | 530494 | t         |          |          | t           | <font></font>
 (0,2) | 530494 | t         |          |          | t           | t<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どちらの場合も、keyshr_lockビットが設定されており、SHAREモードは、もう1つの情報ビットを見ることで認識できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なモードの互換性マトリックスは次のようになります。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モード</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーシェア用</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェア用</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーの更新なし</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新用</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーシェア用</font></font></td>
<td></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェア用</font></font></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーの更新なし</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新用</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バツ</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはそれを示しています：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例外モードは互いに競合します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有モードは互いに互換性があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有のFOR KEY SHAREモードは、排他的なFOR NO KEY UPDATEモードと互換性があります（つまり、非キーフィールドを同時に更新して、キーが変更されないようにすることができます）。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチトランザクション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでは、ロックはxmaxフィールドのブロックしているトランザクションの数で表されると考えていました。</font><font style="vertical-align: inherit;">ただし、共有ロックは複数のトランザクションで保持でき、複数の番号を同じxmaxフィールドに書き込むことはできません。</font><font style="vertical-align: inherit;">になる方法 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
共有ロックの場合、いわゆる</font><em><font style="vertical-align: inherit;">マルチトランザクション</font></em><font style="vertical-align: inherit;">が適用されます。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（MultiXact）。これは、別の番号が割り当てられたトランザクショングループです。この番号は通常のトランザクション番号と同じ次元ですが、番号は個別に割り当てられます（つまり、システムは同じトランザクション番号と複数トランザクション番号を持つことができます）。両者を区別するために、別の情報ビット（xmax_is_multi）が使用され、そのようなグループのメンバーとロックモードに関する詳細情報は、$ PGDATA / pg_multixact /ディレクトリのファイルにあります。当然のことながら、最後に使用されたデータは、サーバーの共有メモリのバッファに格納され、より高速にアクセスできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
既存のロックに、別のトランザクションによって実行される別の例外的なロックを追加します（FOR KEY SHAREモードとFOR NO KEY UPDATEモードは相互に互換性があるため、これを行うことができます）。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts_v <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">2</span>;
</code></pre><pre><code class="plaintext hljs"> ctid  |  xmax  | lock_only | is_multi | keys_upd | keyshr_lock | shr_lock <font></font>
-------+--------+-----------+----------+----------+-------------+----------<font></font>
 (0,1) |     61 |           | t        |          |             | <font></font>
 (0,2) | 530494 | t         |          |          | t           | t<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の行で、通常の番号がマルチトランザクション番号に置き換えられていることがわかります。これは、xmax_is_multiビットによって証明されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチトランザクション実装の内部を掘り下げないようにするために、便利な方法ですべてのタイプの行ロックに関するすべての情報を表示できるようにする別の拡張機能を使用できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> pgrowlocks;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pgrowlocks(<span class="hljs-string">'accounts'</span>) \gx
</code></pre><pre><code class="plaintext hljs">-[ RECORD 1 ]-----------------------------<font></font>
locked_row | (0,1)<font></font>
locker     | 61<font></font>
multi      | t<font></font>
xids       | {530494,530495}<font></font>
modes      | {"Key Share","No Key Update"}<font></font>
pids       | {5892,5928}<font></font>
-[ RECORD 2 ]-----------------------------<font></font>
locked_row | (0,2)<font></font>
locker     | 530494<font></font>
multi      | f<font></font>
xids       | {530494}<font></font>
modes      | {"For Share"}<font></font>
pids       | {5892}<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">ROLLBACK</span>;
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フリーズ設定</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カウンタービットの制限により、行バージョンのxmaxフィールドに書き込まれるマルチトランザクションには個別の番号が割り当てられるため</font><font style="vertical-align: inherit;">、通常の番号と</font><font style="vertical-align: inherit;">同じ</font><font style="vertical-align: inherit;">xidラップアラウンド</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、マルチトランザクション番号の場合、フリーズのアナログを実行することも必要です。古い番号を新しい番号（またはフリーズ時にロックが1つのトランザクションだけで保持されている場合は、通常のトランザクション番号）に置き換えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のトランザクション番号のフリーズはxminフィールドに対してのみ実行されることに注意してください（行のバージョンに空でないxmaxフィールドがある場合、それは無関係なバージョンであり、クリアされるか、またはxmaxトランザクションがキャンセルされてその番号が私たちに興味を持たないかのいずれかです）。</font><font style="vertical-align: inherit;">ただし、マルチトランザクションについては、現在のバージョンの回線のxmaxフィールドについて説明しています。これは関連性を保つことができますが、共有モードではさまざまなトランザクションによって常にブロックされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチ</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フリーズには、通常のフリーズのパラメーターと同様のパラメーター（</font><em><font style="vertical-align: inherit;">vacuum_multixact_freeze_min_age</font></em><font style="vertical-align: inherit;">、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_multixact_freeze_table_age</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_multixact_freeze_max_age）</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><em><font style="vertical-align: inherit;">責任を</font></em><em><font style="vertical-align: inherit;">負い</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰が極端ですか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
徐々に甘いものに近づきます。</font><font style="vertical-align: inherit;">複数のトランザクションが同じ行を更新する場合のロックのパターンを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg_locksのビューを作成することから始めましょう。</font><font style="vertical-align: inherit;">最初に、結論をもう少しコンパクトにします。次に、興味深いロックに制限します（実際には、仮想トランザクション番号のロック、アカウントテーブルのインデックス、pg_locksとビュー自体を破棄します。一般に、関係のないすべての気を散らすだけ）。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> locks_v <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> pid,<font></font>
       locktype,<font></font>
       <span class="hljs-keyword">CASE</span> locktype
         <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span>
         <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> transactionid::<span class="hljs-type">text</span>
         <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span> relation::<span class="hljs-type">regclass</span>::<span class="hljs-type">text</span>||<span class="hljs-string">':'</span>||tuple::<span class="hljs-type">text</span>
       <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> lockid,<font></font>
       mode,<font></font>
       granted<font></font>
<span class="hljs-keyword">FROM</span> pg_locks
<span class="hljs-keyword">WHERE</span> locktype <span class="hljs-keyword">in</span> (<span class="hljs-string">'relation'</span>,<span class="hljs-string">'transactionid'</span>,<span class="hljs-string">'tuple'</span>)
<span class="hljs-keyword">AND</span> (locktype != <span class="hljs-string">'relation'</span> <span class="hljs-keyword">OR</span> relation = <span class="hljs-string">'accounts'</span>::<span class="hljs-type">regclass</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最初のトランザクションを開始して、行を更新します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs"> txid_current | pg_backend_pid <font></font>
--------------+----------------<font></font>
       530497 |           5892<font></font>
(1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><pre><code class="plaintext hljs">UPDATE 1
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックについてはどうですか？</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5892</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |  lockid  |       mode       | granted <font></font>
------+---------------+----------+------------------+---------<font></font>
 5892 | relation      | accounts | RowExclusiveLock | t<font></font>
 5892 | transactionid | 530497   | ExclusiveLock    | t<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションは、テーブルと独自の番号ロックを保持します。</font><font style="vertical-align: inherit;">これまでのところ、すべてが期待されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションを開始し、同じ行を更新しようとします。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">|   txid_current | pg_backend_pid <font></font>
|  --------------+----------------<font></font>
|         530498 |           5928<font></font>
|  (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションロックはどうですか？</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5928</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |   lockid   |       mode       | granted <font></font>
------+---------------+------------+------------------+---------<font></font>
 5928 | relation      | accounts   | RowExclusiveLock | t<font></font>
 5928 | transactionid | 530498     | ExclusiveLock    | t<font></font>
 5928 | transactionid | 530497     | ShareLock        | f<font></font>
 5928 | tuple         | accounts:1 | ExclusiveLock    | t<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここはもっと面白いです。</font><font style="vertical-align: inherit;">テーブルと自分の番号をロックすることに加えて、さらに2つのロックがあります。</font><font style="vertical-align: inherit;">2番目のトランザクションは、行が最初にロックされ、その数を待って「ハング」したことを発見しました（granted = f）。</font><font style="vertical-align: inherit;">しかし、行バージョンのロック（locktype = tuple）はどこから、なぜ発生したのでしょうか。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行バージョンロック（タプルロック）と行ロック（行ロック）を混同しないでください。</font><font style="vertical-align: inherit;">1つ目は、通常のタプルタイプのロックで、pg_locksに表示されます。</font><font style="vertical-align: inherit;">2番目は、データページのマークです。xmaxと情報ビットです。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションが行を変更しようとすると、次の一連のアクションが実行されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可変バージョンの文字列（タプル）の排他ロックをキャプチャします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xmaxおよび情報ビットが行がロックされていることを示す場合、xmaxトランザクション番号のロックを要求します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xmaxと必要な情報ビットを規定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行バージョンのロックを解除します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のトランザクションによって行が更新されたときに、行バージョンのロックも取得しましたが（ステップ1）、すぐに解放しました（ステップ4）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションが到着したとき、彼女は行バージョンロック（p。1）をキャプチャしましたが、最初のトランザクション（p。2）の番号のロックを要求することを強制され、これにハングしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の同様のトランザクションが表示された場合はどうなりますか？</font><font style="vertical-align: inherit;">彼女は文字列のバージョン（アイテム1）のロックを取得しようとし、このステップですでにハングします。</font><font style="vertical-align: inherit;">見てみな。</font></font><br>
<br>
<pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
||     =&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">||      txid_current | pg_backend_pid <font></font>
||     --------------+----------------<font></font>
||            530499 |           5964<font></font>
||     (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5964</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |   lockid   |       mode       | granted <font></font>
------+---------------+------------+------------------+---------<font></font>
 5964 | relation      | accounts   | RowExclusiveLock | t<font></font>
 5964 | tuple         | accounts:1 | ExclusiveLock    | f<font></font>
 5964 | transactionid | 530499     | ExclusiveLock    | t<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ行を更新したい4番目、5番目などのトランザクションは、トランザクション3と何の違いもありません。それらはすべて同じ行バージョンロックで「ハング」します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヒープに別のトランザクションを追加します。</font></font><br>
<br>
<pre><code class="pgsql hljs">|||        =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|||        =&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">|||         txid_current | pg_backend_pid <font></font>
|||        --------------+----------------<font></font>
|||               530500 |           6000<font></font>
|||        (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">|||        =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount - <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">6000</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |   lockid   |       mode       | granted <font></font>
------+---------------+------------+------------------+---------<font></font>
 6000 | relation      | accounts   | RowExclusiveLock | t<font></font>
 6000 | transactionid | 530500     | ExclusiveLock    | t<font></font>
 6000 | tuple         | accounts:1 | ExclusiveLock    | f<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在の期待の全体像は、プロセスのブロックに関する情報を追加したpg_stat_activityビューで確認できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pid, wait_event_type, wait_event, pg_blocking_pids(pid) 
<span class="hljs-keyword">FROM</span> pg_stat_activity 
<span class="hljs-keyword">WHERE</span> backend_type = <span class="hljs-string">'client backend'</span>;
</code></pre><pre><code class="plaintext hljs"> pid  | wait_event_type |  wait_event   | pg_blocking_pids <font></font>
------+-----------------+---------------+------------------<font></font>
 5892 |                 |               | {}<font></font>
 5928 | Lock            | transactionid | {5892}<font></font>
 5964 | Lock            | tuple         | {5928}<font></font>
 6000 | Lock            | tuple         | {5928,5964}<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 最初の（文字列のロックバージョンを保持する）と、最初の後ろに並ぶ他のすべてが存在する、一種の「キュー」がわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜそのような洗練されたデザインが必要なのですか？文字列のバージョンロックがないとします。次に、2番目と3番目（以降も同様）のトランザクションは、最初のトランザクションの数がブロックされるのを待ちます。最初のトランザクションが完了すると、ブロックされたリソースが消え（</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、ここで何をしているのですか、トランザクションは終了しました</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、すべての待機中のプロセスがオペレーティングシステムによって最初に起こされることに依存しているため、回線をロックする時間があります。他のすべてのプロセスも起こされますが、それらは再びキューに入れられる必要があります-今度は別のプロセスの後で。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、状況の不運な組み合わせにより、他のトランザクションを常に「巡回」する場合、一部のトランザクションが順番を無期限に待機できるという事実に満ちています。英語では、この状況はロックスタベーションと呼ばれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのケースでは、同じことがわかりますが、それでも少し優れています。2番目に発生したトランザクションは、次のリソースにアクセスできることが保証されています。しかし、以下（3番目と4番目）はどうなりますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のトランザクションがロールバックで終了する場合、すべてが正常に行われます。着信トランザクションは、整列した順序で実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは不運です。最初のトランザクションがコミットで完了すると、トランザクション番号だけでなく、行のバージョンも消えます。</font><font style="vertical-align: inherit;">つまり、もちろんバージョンは残りますが、関連性がなくなり、完全に異なる最新バージョン（同じ行のもの）を更新する必要があります。</font><font style="vertical-align: inherit;">キューの背後にあるリソースが消え、誰もが新しいリソースを所有するための競争を手配します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のトランザクションをcommitで完了させます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションが起こされ、段落が実行されます。</font><font style="vertical-align: inherit;">3および4。</font></font><br>
<br>
<pre><code class="plaintext hljs">|  UPDATE 1
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5928</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |  lockid  |       mode       | granted <font></font>
------+---------------+----------+------------------+---------<font></font>
 5928 | relation      | accounts | RowExclusiveLock | t<font></font>
 5928 | transactionid | 530498   | ExclusiveLock    | t<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目のトランザクションはどうですか？</font><font style="vertical-align: inherit;">彼女はステップ1をスキップし（リソースがなくなったため）、ステップ2でスタックします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5964</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |  lockid  |       mode       | granted <font></font>
------+---------------+----------+------------------+---------<font></font>
 5964 | relation      | accounts | RowExclusiveLock | t<font></font>
 5964 | transactionid | 530498   | ShareLock        | f<font></font>
 5964 | transactionid | 530499   | ExclusiveLock    | t<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、4番目のトランザクションでも同じことが起こります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">6000</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |  lockid  |       mode       | granted <font></font>
------+---------------+----------+------------------+---------<font></font>
 6000 | relation      | accounts | RowExclusiveLock | t<font></font>
 6000 | transactionid | 530498   | ShareLock        | f<font></font>
 6000 | transactionid | 530500   | ExclusiveLock    | t<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、3番目と4番目のトランザクションの両方が2番目のトランザクションの完了を待っています。</font><font style="vertical-align: inherit;">ラインは</font></font><strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カボチャの</font></font></strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">群衆に</font><font style="vertical-align: inherit;">変わりました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始されたすべてのトランザクションを完了します。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<pre><code class="plaintext hljs">||     UPDATE 1
</code></pre><pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<pre><code class="plaintext hljs">|||        UPDATE 1
</code></pre><pre><code class="pgsql hljs">|||        =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列のブロックの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">README.tuplockを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
</blockquote><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたはここに立っていませんでした</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、2レベルのブロックスキームのアイデアは、「不運」トランザクションの永遠の待機の可能性を減らすことです。</font><font style="vertical-align: inherit;">それにもかかわらず、すでに見てきたように、そのような状況はかなり可能です。</font><font style="vertical-align: inherit;">また、アプリケーションが共有ロックを使用する場合、すべてがさらに悲しくなる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のトランザクションで行を共有モードでロックします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs"> txid_current | pg_backend_pid <font></font>
--------------+----------------<font></font>
       530501 |           5892<font></font>
(1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SHARE</span>;
</code></pre><pre><code class="plaintext hljs"> acc_no | amount <font></font>
--------+--------<font></font>
      1 | 100.00<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションは同じ行を更新しようとしますが、できません-SHAREモードとNO KEY UPDATEモードには互換性がありません。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">|   txid_current | pg_backend_pid <font></font>
|  --------------+----------------<font></font>
|         530502 |           5928<font></font>
|  (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のトランザクションは、最初のトランザクションの完了を待ち、行バージョンのロックを保持します。今のところ、すべてが前回と同じです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5928</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |   lockid    |       mode       | granted <font></font>
------+---------------+-------------+------------------+---------<font></font>
 5928 | relation      | accounts    | RowExclusiveLock | t<font></font>
 5928 | tuple         | accounts:10 | ExclusiveLock    | t<font></font>
 5928 | transactionid | 530501      | ShareLock        | f<font></font>
 5928 | transactionid | 530502      | ExclusiveLock    | t<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、共有ロックを必要とする3番目のトランザクションが表示されます。</font><font style="vertical-align: inherit;">問題は、行のバージョンのロックを取得しようとせず（行を変更しないため）、順番を逆にクロールすることです。これは、最初のトランザクションと互換性があります。</font></font><br>
<br>
<pre><code class="pgsql hljs">||     <span class="hljs-keyword">BEGIN</span>
||     =&gt; <span class="hljs-keyword">SELECT</span> txid_current(), pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">||      txid_current | pg_backend_pid <font></font>
||     --------------+----------------<font></font>
||            530503 |           5964<font></font>
||     (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SHARE</span>;
</code></pre><pre><code class="plaintext hljs">||      acc_no | amount <font></font>
||     --------+--------<font></font>
||           1 | 100.00<font></font>
||     (1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、2つのトランザクションが行をブロックします。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pgrowlocks(<span class="hljs-string">'accounts'</span>) \gx
</code></pre><pre><code class="plaintext hljs">-[ RECORD 1 ]---------------<font></font>
locked_row | (0,10)<font></font>
locker     | 62<font></font>
multi      | t<font></font>
xids       | {530501,530503}<font></font>
modes      | {Share,Share}<font></font>
pids       | {5892,5964}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のトランザクションが完了するとどうなりますか？</font><font style="vertical-align: inherit;">2番目のトランザクションは起こされますが、行ロックがどこにも消えていないことがわかり、再び「キュー」に待機します。今回は3番目のトランザクションです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> locks_v <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">5928</span>;
</code></pre><pre><code class="plaintext hljs"> pid  |   locktype    |   lockid    |       mode       | granted <font></font>
------+---------------+-------------+------------------+---------<font></font>
 5928 | relation      | accounts    | RowExclusiveLock | t<font></font>
 5928 | tuple         | accounts:10 | ExclusiveLock    | t<font></font>
 5928 | transactionid | 530503      | ShareLock        | f<font></font>
 5928 | transactionid | 530502      | ExclusiveLock    | t<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、3番目のトランザクションが完了した場合（およびこの間に他の共有ロックが表示されない場合）に限り、2番目のトランザクションは更新を実行できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<pre><code class="plaintext hljs">|  UPDATE 1
</code></pre><pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">ROLLBACK</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、いくつかの実用的な結論を出す時が来ました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの並列プロセスでテーブルの同じ行を同時に更新することは良い考えではありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションでSHAREタイプの共有ロックを使用する場合は、慎重に行ってください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常、キーフィールドは変更されず、KEY SHAREモードとNO KEY UPDATEモードには互換性があるため、外部キーのチェックは干渉しません。</font></font></li>
</ul><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">借りないで</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、SQLコマンドは、必要なリソースを解放することを期待しています。</font><font style="vertical-align: inherit;">ただし、ロックをすぐに取得できない場合は、コマンドの実行を拒否したい場合があります。</font><font style="vertical-align: inherit;">これを行うには、SELECT、LOCK、ALTERなどのコマンドでNOWAIT句を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例えば：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">NOWAIT</span>;
</code></pre><pre><code class="plaintext hljs">|  ERROR:  could not obtain lock on row in relation "accounts"
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースがビジーの場合、コマンドはすぐに失敗します。アプリケーションコードでは、このようなエラーを傍受して処理することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPDATEおよびDELETEコマンドにNOWAIT句を指定することはできませんが、最初にSELECT FOR UPDATE NOWAITを実行してから、可能であれば行を更新または削除できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
待機しない別のオプションがあります-SKIP LOCKED句を指定したSELECT FORコマンドを使用してください。このようなコマンドはロックされた行をスキップしますが、空き行は処理します。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">DECLARE</span> c <span class="hljs-keyword">CURSOR</span> <span class="hljs-keyword">FOR</span>
|       <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> acc_no <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SKIP LOCKED</span>;<font></font>
|  =&gt; <span class="hljs-keyword">FETCH</span> c;
</code></pre><pre><code class="plaintext hljs">|   acc_no | amount <font></font>
|  --------+--------<font></font>
|        2 | 200.00<font></font>
|  (1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、最初のブロックされた行がスキップされ、2番目の行がすぐに受信（およびブロック）されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、これによりキューのマルチスレッド処理を整理できます。</font><font style="vertical-align: inherit;">このコマンド用に別のアプリケーションを考え出すことはできません。それを使用したい場合は、いくつかの単純なソリューションを見失う可能性があります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ROLLBACK</span>;
</code></pre><pre><code class="plaintext hljs">|  =&gt; ROLLBACK;
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続くこと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja463805/index.html">ゲームデザイナーになりたい人のための7冊</a></li>
<li><a href="../ja463811/index.html">Android Q用のアプリケーションの準備。パート1</a></li>
<li><a href="../ja463813/index.html">Mikrotik RouterOSでのマルチバンとルーティング</a></li>
<li><a href="../ja463815/index.html">なぜ外資系銀行が資金源に関心を持っているのですか？</a></li>
<li><a href="../ja463817/index.html">20人の製品マネージャーと、すべての中で最も多次元のマトリックス構造。スカイエンとの会話</a></li>
<li><a href="../ja463821/index.html">AMO、Bitrix、1Cなど：どこから始めればよいか？</a></li>
<li><a href="../ja463823/index.html">Rust 1.37.0リリース：プロファイルに基づく最適化、名前のない定数およびカーゴベンダー</a></li>
<li><a href="../ja463825/index.html">Googleスプレッドシートプロジェクト管理ツール</a></li>
<li><a href="../ja463829/index.html">FreePBX キュー内の不在着信コールの電子メール通知のためのアスタリスクの構成</a></li>
<li><a href="../ja463831/index.html">ロシアのIT教育の何が問題になっていますか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>