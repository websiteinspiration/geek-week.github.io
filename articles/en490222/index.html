<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äç‚úàÔ∏è ü§òüèæ üò° Death Day Standard Library ü§∫ üëï üë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day in Prague, the C ++ standardization committee conducted a series of surveys on the issue of changing the ABI, and ultimately it was deci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Death Day Standard Library</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490222/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The other day in Prague, the C ++ standardization committee conducted a series of surveys on the issue of changing the ABI, and ultimately it was decided not to change anything in it. </font><font style="vertical-align: inherit;">There was no applause in the hall. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think we did not fully realize the consequences that this decision would entail, and I do not believe that, in principle, it can positively affect the development of the language.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7a/j5/al/7aj5al5kxo5gjlw1lbrr0ftlemq.png"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is ABI?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ABI - a set of conventions that define how your program is represented in binary form, how names are declared in it, class markup is defined, and function calling conventions are defined. </font><font style="vertical-align: inherit;">In fact, this is a kind of binary protocol, but it is not versioned. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to confuse you in terminology, let's look at examples of what the ABI change entails and its breakdown within the program: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You cannot use the exported symbol in the new version of your compiled library if you did any of the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added a new field to an existing class</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changed the template parameters of the class / function, turned the template function into a non-template, or vice versa, added </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">variadic template</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apply the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inline</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specifier </font><font style="vertical-align: inherit;">to something</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added default parameters in function declaration</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New virtual method announced</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And much, much more, but the examples above are the main ones that are mentioned by the committee, and the very ones, thanks to which most of the proposals in the standard are destroyed on the spot. </font><font style="vertical-align: inherit;">I omitted the options for violating the ABI, during which the source code of the program also breaks (for example, deleting or changing functions). </font><font style="vertical-align: inherit;">However, this is not always true. </font><font style="vertical-align: inherit;">For example, deleting a function does not always entail breaking the source code. </font></font><code>std::string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It has a conversion operator in </font></font><code>std::string_view</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which I would gladly get rid of, and although deleting it will break the ABI, it will not lead to significant problems in the source code.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why should we break ABI</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, there are several useful changes in the implementation of the standard library that you can implement if you break the current ABI:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make associative containers (much) faster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speed ‚Äã‚Äãup your work </font></font><code>std::regex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(At the moment, it‚Äôs faster to run PHP and search on it with a regular expression than use the standard one </font></font><code>std::regex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some changes in </font></font><code>std::string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>std::vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as well as in the layout of other containers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unity of the class interface: at the moment, some of their implementations intentionally do not correspond to a single interface for the sake of ABI stability</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More importantly, there are changes in the design of the library that cannot be made without encountering the ABI security issue. </font><font style="vertical-align: inherit;">Here is an incomplete list of all that is currently not feasible for the reason mentioned above:</font></font><br>
<br>
<ul>
<li><code>std::scoped_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was added in order not to break the abi change </font></font><code>lock_guard</code></li>
<li><code>int128_t</code>    ,    <code>intmax_t</code>. ,    ,    ,  <code>intmax_t</code>   <i>deprecated</i></li>
<li><code>std::unique_ptr</code>           ,     <i>zero-overhead</i>     </li>
<li>   <code>error_code</code>     - ,       ABI</li>
<li><code>status_code</code>     ABI</li>
<li>    <code>recursive_directory_iterator</code>  ,     ABI</li>
<li>      <code>&lt;cstring&gt;</code> <code>constexpr</code> ( <code>strlen</code>)     ,   ABI</li>
<li>  UTF-8  <code>std::regex</code> ‚Äî  ABI</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adding support to </font></font><code>realloc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returning the size of allocated memory is an ABI breakdown for polymorphic allocators</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating Implicit Virtual Destructors for Polymorphic Types</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the return type y </font></font><code>push_back</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be changed if the current ABI is broken</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, do we really need and </font></font><code>push_back</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and </font></font><code>emplace_back</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">?</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><code> std::shared_ptr</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also causes ABI breakdown</font></font></li>
<li><code>[[no_unique_address]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> could be output by the compiler if we did not care about saving the current ABI</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the list does not end there. </font><font style="vertical-align: inherit;">I think WG21 should try to keep up to date the list of such things. </font><font style="vertical-align: inherit;">But I will take note of everyone who says ‚Äúit will break the ABI‚Äù, being with me in the same room.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else do we want to change?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I dont know. </font><font style="vertical-align: inherit;">And I don‚Äôt know what I don‚Äôt know. </font><font style="vertical-align: inherit;">But if I were asked to guess, I would say the following:</font></font><br>
<br>
<ul>
<li>     C++23      ABI,    -        ,    ABI.          </li>
<li>   ,  ,          ,    ,          ABI</li>
<li>        ABI,       </li>
<li>    ,     ABI</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Tombstone</a>      ABI</li>
</ul><br>
<h2> ABI  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the last ABI discussion, a number of surveys were conducted in Prague, which, however, do not tell us anything. </font><font style="vertical-align: inherit;">Depending on whether you are a pessimist or an optimist, the current results can be interpreted by you differently. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Key facts:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WG21 does not want to break ABI in 23</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WG21 considers it necessary to break the ABI in future versions of C ++ (C ++ 26 or later)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WG21 will take time to consider proposals that violate ABI</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WG21 does not promise eternal stability</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WG21 considers it important to maintain priority on performance, even to the detriment of language stability</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These statements have many important points, but there is no consensus. </font><font style="vertical-align: inherit;">The committee, oddly enough, split in half.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortune telling</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In which version of C ++ to wait for changes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The obvious drawback of all these polls is that we have not decided </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when exactly</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we want to break the ABI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in c ++ 23? No, definitely not already. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in C ++ 26? Some people intend to vote for, but another part is likely to vote for C ++ 41 or for the time when they retire and they do not have to support their current project. One of the questions just mentioned C ++ - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; very comfortably!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no reason to believe that if the ABI cannot be violated now, it can be violated later. People who need stability are several years behind the standard. So if we don‚Äôt break it now, people will continue to rely on the never-promised ABI, maybe another ten or even twenty years. The simple fact that we conducted this survey eventually voted not to violate the ABI, shows that the whole ecosystem is gradually becoming stony and stagnant - every day the problem only gets worse and potentially more expensive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I don‚Äôt think that something will change in the survey conducted in three years. It‚Äôs like global warming: everyone agrees that someday we need to tackle this problem. And then let's ban diesel in 2070?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything that is not planned to be done in the next five years is likely to never happen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About offers that violate ABI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WG21 voted to devote more time to proposals that violate the current ABI. </font><font style="vertical-align: inherit;">This means a few things:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will waste more time in one of the noisiest rooms of the committee to discuss this issue and leave less on those proposals that have more chances of adoption, and in the end we will reject them all the same</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will look for alternatives that do not break ABI (this will be discussed below)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partial changes in ABI may be introduced (see also below)</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance is more important than ABI stability</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's like asking if a five year old wants a candy. </font><font style="vertical-align: inherit;">Of course we will vote on the importance of performance. </font><font style="vertical-align: inherit;">However, I am worried that some people still voted against. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems to me that the committee at the same time wants to sit on two chairs at once. </font><font style="vertical-align: inherit;">And this is impossible:</font></font><br>
<blockquote><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bryce Adelstein Lelbach</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> @blebach</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Performance</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Stability ABI</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Ability to change something</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Choose two options from the proposed ones.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
the stability of the language and ABI, of course, collide with each other, forcing us to ask such a fundamental question - What is C ++ and what is its standard library? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually in this case, the terms ‚Äúperformance‚Äù, ‚Äú </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zero-cost</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> abstraction‚Äù, ‚Äú </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do not pay for what you do not use</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù are </font><font style="vertical-align: inherit;">remembered </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And the stability of ABI stands across all of this.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Far reaching consequences</font></font></h2><br>
<img src="https://habrastorage.org/getpro/habr/post_images/5d7/90b/d50/5d790bd50abd97b45921c4f61a8ef757.webp" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I am deeply convinced that the decision not to break the ABI in the 23rd year is the biggest mistake the committee has ever made. </font><font style="vertical-align: inherit;">And I know that some people believe the opposite. </font><font style="vertical-align: inherit;">But here is what is likely to happen soon:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nightmare of learning</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's be honest. All programs that rely on ABI are likely to violate </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ODR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principles somewhere </font><font style="vertical-align: inherit;">or use incompatible flags, which, fortunately, still work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
New programs must be compiled from the source code, we need tools built on the assembly from the sources, and not a collection of libraries that we got from somewhere and somehow inserted into the project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, building from source is something that is not so easy to achieve. But we need to encourage this approach to the product, regularly update compilers so that people benefit from the newly introduced features a month after the release, and not ten years later. Right, reliable, scalable, and reproducible solutions, open source libraries, and a dependency system need to be encouraged.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refusing to violate ABI, the committee openly states that it will support poorly written programs throughout their existence. </font><font style="vertical-align: inherit;">Even if you do not link to the libraries obtained through apt-install (which are actually intended for the system), there will be other people, because the committee gave them their blessing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a huge step back. </font><font style="vertical-align: inherit;">How can we teach others good language practices if we have no incentive to do this?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loss of interest in the standard library</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The estimated loss in library performance due to our unwillingness to violate ABI is estimated at 5-10%. </font><font style="vertical-align: inherit;">This number will only grow with time. </font><font style="vertical-align: inherit;">Let's look at examples:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are a large company, you can buy yourself a new data center or pay a team of programmers who would support their own library</font></font></li>
<li>    ,   5%              ,     </li>
<li>   ,   5-10%  ,               VR-</li>
<li>   ,        ‚Äî     </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think, here, willy-nilly, the question arises between: ‚ÄúI definitely should use C ++ and its standard library!‚Äù and ‚ÄúMaybe I should not use the standard library? Or maybe I should not use C ++ in principle? Perhaps .NET, julia or Rust would be a better solution? ‚Äù Of course, there are many factors that influence the answer, but we see what is happening recently. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many game developers are extremely skeptical of the standard library. They would rather develop their own alternative, such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EASTL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , than take advantage of STL. Facebook has </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">folly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Google has </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abseil</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and so on.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's like a snowball. </font><font style="vertical-align: inherit;">If people do not use the standard library, they have no interest in improving it. </font><font style="vertical-align: inherit;">Performance is the key factor that keeps the library afloat. </font><font style="vertical-align: inherit;">Without a guarantee of performance, much less effort will be put into its development.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt;&gt; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://twitter.com/foonathan" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jonathan M√ºller</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> @foonathan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is the point of using containers from the standard library if they do not provide better performance? </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Titus Winters</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> @TitusWinters </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps because they are common and easily accessible? </font><font style="vertical-align: inherit;">(these two facts do not mean the same thing). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voting to preserve ABI is like saying that the standard library should strive to be McDonald's - he is also everywhere, he is stable and technically solves the tasks.</font></font><br>
</blockquote> <h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can a committee consider proposals breaking an ABI?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several options are offered as pain relief caused by the inability to accept offers if they violate the ABI:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding New Names</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/9db/f42/6f8/9dbf426f89a37d487fb3b446edebc89d.webp" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the first and obvious solution. If we cannot change </font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, can we just add </font></font><code>std::fast_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? There are several reasons why this is bad. Adding types to the standard library is expensive, both in terms of support costs and in terms of education. After the introduction of the new class, thousands of articles will inevitably appear, explaining which container should be used. For example, should I use </font></font><code>std::scoped_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>std::lock_guard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? I have no idea! I need to google every time. There is also the problem that good names end sooner or later. We also get some overhead during program execution, since all containers must be constantly converted to each other, it becomes difficult to control a huge number of conversion overloads in the class, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs ironic, but those people who support the solution above can also argue that C ++ is too complex a language. </font><font style="vertical-align: inherit;">Adding duplicates to the library will definitely not make it easier.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we could accept this offer as a standard!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some library developers claim that their offers were rejected due to an ABI violation, although they did not actually violate anything, or they could be changed to circumvent ABI failure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a cynical person, it's a little hard for me to believe. </font><font style="vertical-align: inherit;">The fact is that before there were no such proposals, and the scenarios in which they can be applied are very limited. </font><font style="vertical-align: inherit;">ABI Review Group (ARG) could help in this matter, but they are likely to recommend another name for the class / function again.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partial Abi Violation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main idea is not to break the entire ABI, but only change it for a specific class or function. </font><font style="vertical-align: inherit;">The problem with this approach is that instead of an error at the linking stage, we will see the problem already during the launch of the program, and it will be unpleasant to surprise us. </font><font style="vertical-align: inherit;">The committee had already tried this approach in C ++ 11 when it changed the markup </font></font><code>std::string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nothing good came of it. </font><font style="vertical-align: inherit;">Everything was so bad that this fact is still used as an argument in favor of maintaining the current ABI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another level of indexation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solution to some of the problems with ABI would be the ability to access the data of the class through a pointer, then the markup of the class would be just that pointer. The idea is very close to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIMPL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> idiom </font><font style="vertical-align: inherit;">, which is actively used in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> because of its ABI. Yes, that would solve the problem with class members, but what to do with virtual methods? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considering the problem from a more critical point of view, we are talking about adding one more level of indirection (pointer index) and additional allocation of memory in the heap for everything that is enclosed in the framework of ABI. In STL, in fact, everything is enclosed within this framework because it is a collection of generalized classes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the price of this approach will be huge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a solution to this problem, there are already several proposals in the standard. </font><font style="vertical-align: inherit;">Some of them want to make PIMPL one of the features of the language, so you can choose between ABI stability and high performance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ironically, however, but in order to turn library types into PIPML types, we need to ... break the ABI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reassemble all code every three years</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just my thoughts out loud.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All current offers in the standard must be destroyed</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paradoxically, C ++ has never been as lively as it is now. </font><font style="vertical-align: inherit;">In Prague, 250 people worked on many things for him, including:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numerics</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linear algebra</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unicode</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchronous I / O</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2D and 3D Graphics</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many other features</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All these proposals are united by one common fact - they are much more optional in comparison with what we have in the standard at the moment. People are simply trying to standardize things from their field of research and work, or that which is constantly evolving and changing. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In particular, Unicode algorithms are extremely unstable and change rapidly over time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then, such horror as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">networking</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> looms over the horizon </font><font style="vertical-align: inherit;">. It is very, very irresponsible to try to standardize anything that might lead to security problems, and at the same time not be able to change it later (remember about ABI).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since C ++ decided to make it stable, all of these suggestions must be destroyed and burned. I would not want to be destroyed, but this must be done. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But they still won‚Äôt do it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the best case, we will not make mistakes and standardize the current state of things in one of the new versions of C ++, and then let everything decompose slowly, since it will not be possible to fix it (In the case of Networking TS, we seem to be unable to change anything at all, therefore we will have to standardize what existed ten years ago, then of course the library can still be significantly improved, but let's leave this story for another time). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But of course, we will make many, many mistakes.</font></font><br>
<br>
<blockquote>&gt;&gt; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>√ìlafur Waage</b></a> @olafurw<br>
(      ,    )<br>
<br>
 ,  !<br>
<br>
         .       ,      ( : , , )?<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>Hyrum Wright</b></a> @hyrumwright<br>
    ,    ,  .       ‚Äî    ,      .<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some mistakes are made intentionally, as they are trade-offs, while others go unnoticed for many years. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Time passes, but the standard library stands still. Previously made trade offs are gradually starting to bother us, and later become real ‚Äúbottlenecks‚Äù in the existing code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some things are really impossible to change, since they are embedded in the API. We all have an idea of ‚Äã‚Äãhow difficult it is to change an existing API. But part of the code can still be fixed and improved if we could break the ABI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ will still be afloat in the next 40 years. If we cannot realize the need to change it in an unpredictable way at any time, then the only right move will be to not play this game in principle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everyone knows that a standard associative container has been relevant for use for less than ten years. </font><font style="vertical-align: inherit;">But why then do we think that larger proposals in the standard will be more successful? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Your offer to the standard </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> destroyed, mine will be destroyed in the same way.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can a committee in principle break an ABI?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many are sure that the committee cannot, in principle, make such a decision, because then the library developers will simply ignore it. </font><font style="vertical-align: inherit;">All this painfully resembles arm wrestling, in which the committee decided not to play. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the fact is that developers of any product have their own users. </font><font style="vertical-align: inherit;">Users are those who first of all need to understand what trade-offs are imposed on them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people rely on ABI quite by accident, without making an informed choice. </font><font style="vertical-align: inherit;">Many people also rely on stability because, of course, everyone wants to rely on it. </font><font style="vertical-align: inherit;">But like any other thing, stability has a price, and now the entire C ++ ecosystem pays for it.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490198/index.html">Trust but verify! Demo zone with Epson projectors for home theater in the demo hall Pult.ru</a></li>
<li><a href="../en490202/index.html">Query Counting: Basic Django Performance Testing</a></li>
<li><a href="../en490204/index.html">The digest of events for HR and IT recruiters in March 2020</a></li>
<li><a href="../en490208/index.html">Backend section on DUMP2020: banter, fan, fail</a></li>
<li><a href="../en490210/index.html">Speeding up the frontend. When a lot of server requests are good</a></li>
<li><a href="../en490224/index.html">Fashionable stealth</a></li>
<li><a href="../en490226/index.html">Blending and Unity Terrain: how to get rid of intersections and stop making your eyes hurt</a></li>
<li><a href="../en490232/index.html">Load Balancing with AWS ELB</a></li>
<li><a href="../en490242/index.html">GSM Location service of SIM800x modules and its work with Yandex.Locator API</a></li>
<li><a href="../en490244/index.html">Python code optimization with ctypes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>