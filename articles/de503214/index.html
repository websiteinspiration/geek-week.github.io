<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰🏽 👨🏾‍🎓 👩🏾‍🎤 Lastoptimierung für ein Highload-Projekt mit ElasticSearch 🥤 👨🏼‍🤝‍👨🏻 🧑🏽‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Mein Name ist Maxim Vasiliev, ich arbeite als Analyst und Projektmanager bei FINCH. Heute möchte ich Ihnen sagen, wie wir mit ElasticSearc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lastoptimierung für ein Highload-Projekt mit ElasticSearch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503214/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font><font style="vertical-align: inherit;">Mein Name ist Maxim Vasiliev, ich arbeite als Analyst und Projektmanager bei FINCH. </font><font style="vertical-align: inherit;">Heute möchte ich Ihnen sagen, wie wir mit ElasticSearch 15 Millionen Anfragen in 6 Minuten bearbeiten und die tägliche Belastung auf der Website eines unserer Kunden optimieren konnten. </font><font style="vertical-align: inherit;">Leider müssen wir auf Namen verzichten, da wir die NDA haben, hoffen wir, dass der Inhalt des Artikels nicht beeinflusst wird. </font><font style="vertical-align: inherit;">Lass uns gehen.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie das Projekt aufgebaut ist</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Backend erstellen wir Services, die die Leistung von Websites und mobilen Anwendungen unseres Kunden sicherstellen. </font><font style="vertical-align: inherit;">Die allgemeine Struktur ist im Diagramm zu sehen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/yw/mx/svywmxdiqxb59mwxobsses8vrc8.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dabei verarbeiten wir eine Vielzahl von Transaktionen: Käufe, Zahlungen, Vorgänge mit Benutzersalden, auf denen wir viele Protokolle speichern, und importieren und exportieren diese Daten auch in externe Systeme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt auch umgekehrte Prozesse, wenn wir Daten von einem Kunden empfangen und an den Benutzer übertragen. </font><font style="vertical-align: inherit;">Darüber hinaus gibt es noch Verfahren für die Arbeit mit Zahlungs- und Bonusprogrammen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurzer Hintergrund</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anfangs haben wir PostgreSQL als einziges Data Warehouse verwendet. Die Standardvorteile für DBMS: Verfügbarkeit von Transaktionen, entwickelte Sprache für die Datenerfassung, umfassende Tools für die Integration; In Verbindung mit guter Leistung haben zufriedene Menschen unsere Bedürfnisse seit langem befriedigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben absolut alle Daten in Postgres gespeichert: von Transaktionen bis zu Nachrichten. Aber die Anzahl der Benutzer wuchs und damit auch die Anzahl der Anfragen. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zum Verständnis beträgt die jährliche Anzahl der Sitzungen im Jahr 2017 allein auf der Desktop-Site 131 Millionen. Im Jahr 2018 sind es 125 Millionen, 2019 sind es erneut 130 Millionen. Fügen Sie dort weitere 100 bis 200 Millionen aus der mobilen Version der Site und der mobilen Anwendung hinzu, und Sie erhalten eine große Anzahl von Anfragen.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem Wachstum des Projekts hörte Postgres auf, mit der Last fertig zu werden, wir hatten keine Zeit - es erschien eine große Anzahl verschiedener Abfragen, unter denen wir keine ausreichende Anzahl von Indizes erstellen konnten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben festgestellt, dass andere Data Warehouses erforderlich sind, die unsere Anforderungen erfüllen und PostgreSQL entlasten. </font><font style="vertical-align: inherit;">Elasticsearch und MongoDB wurden als mögliche Optionen in Betracht gezogen. </font><font style="vertical-align: inherit;">Letzterer verlor in folgenden Punkten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langsame Indizierungsgeschwindigkeit mit zunehmendem Datenvolumen in Indizes. </font><font style="vertical-align: inherit;">Bei Elastic ist die Geschwindigkeit unabhängig von der Datenmenge.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Volltextsuche</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also haben wir uns für Elastic entschieden und uns auf den Übergang vorbereitet. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wechseln zu Elastic</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Wir haben den Übergang mit einem Point-of-Sale-Suchdienst begonnen. </font><font style="vertical-align: inherit;">Unser Kunde verfügt über insgesamt rund 70.000 Verkaufsstellen und erfordert verschiedene Arten der Suche auf der Website und in der Anwendung:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Textsuche nach Städtenamen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geosuche in einem bestimmten Radius von einem bestimmten Punkt. </font><font style="vertical-align: inherit;">Zum Beispiel, wenn ein Benutzer sehen möchte, welche Verkaufsstellen seinem Haus am nächsten liegen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suche nach einem bestimmten Quadrat - Der Benutzer zeichnet ein Quadrat auf der Karte und zeigt alle Punkte in diesem Radius an. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchen Sie nach zusätzlichen Filtern. </font><font style="vertical-align: inherit;">Verkaufsstellen unterscheiden sich im Sortiment voneinander</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apropos Organisation, dann haben wir in Postgres eine Datenquelle sowohl auf der Karte als auch in den Nachrichten, und in Elastic Snapshots werden aus den Originaldaten erstellt. Tatsache ist, dass Postgres die Suche zunächst nicht nach allen Kriterien bewältigen konnte. Es gab nicht nur viele Indizes, sie konnten sich auch überschneiden, sodass der Postgres-Scheduler verloren ging und nicht verstand, welcher Index dafür verwendet werden sollte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Als nächstes folgte der Nachrichtenbereich. Jeden Tag erscheinen Veröffentlichungen auf der Website, damit der Benutzer nicht im Informationsfluss verloren geht. Die Daten müssen vor der Ausgabe sortiert werden. Dazu benötigen Sie eine Suche: Auf der Site können Sie nach Textübereinstimmungen suchen und gleichzeitig zusätzliche Filter verbinden, da diese ebenfalls über Elastic erstellt werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Dann haben wir die Transaktionsverarbeitung verschoben. </font><font style="vertical-align: inherit;">Benutzer können ein bestimmtes Produkt auf der Website kaufen und an der Verlosung teilnehmen. </font><font style="vertical-align: inherit;">Nach solchen Einkäufen verarbeiten wir eine große Datenmenge, insbesondere an Wochenenden und Feiertagen. </font><font style="vertical-align: inherit;">Zum Vergleich: Wenn an normalen Tagen die Anzahl der Einkäufe zwischen 1,5 und 2 Millionen liegt, kann sie an Feiertagen 53 Millionen erreichen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig müssen die Daten in einer minimalen Zeit verarbeitet werden - Benutzer möchten nicht mehrere Tage auf ein Ergebnis warten. </font><font style="vertical-align: inherit;">Sie werden solche Fristen nicht durch Postgres erreichen - wir haben häufig Sperren erhalten, und während wir alle Anfragen bearbeitet haben, konnten Benutzer nicht überprüfen, ob sie Preise erhalten haben oder nicht. </font><font style="vertical-align: inherit;">Dies ist für das Unternehmen nicht sehr angenehm, daher haben wir die Verarbeitung auf Elasticsearch verlagert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periodizität</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werden Updates ereignisweise unter den folgenden Bedingungen konfiguriert:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kasse. </font><font style="vertical-align: inherit;">Sobald Daten von einer externen Quelle zu uns kommen, starten wir sofort das Update.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachrichten. </font><font style="vertical-align: inherit;">Sobald Nachrichten auf der Website bearbeitet wurden, werden sie automatisch an Elastic gesendet.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier sind die Vorteile von Elastic zu erwähnen. </font><font style="vertical-align: inherit;">In Postgres müssen Sie beim Senden einer Anfrage warten, bis alle Datensätze ehrlich verarbeitet wurden. </font><font style="vertical-align: inherit;">Sie können 10.000 Datensätze an Elastic senden und sofort mit der Arbeit beginnen, ohne zu warten, bis die Datensätze auf alle Shards verteilt sind. </font><font style="vertical-align: inherit;">Natürlich sehen einige Shard oder Replica die Daten möglicherweise nicht sofort, aber sehr bald wird alles verfügbar sein.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrationsmethoden</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt zwei Möglichkeiten, sich in Elastic zu integrieren:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Über den nativen Client über TCP. </font><font style="vertical-align: inherit;">Der native Treiber stirbt allmählich aus: Er wird nicht mehr unterstützt, er hat eine sehr unpraktische Syntax. </font><font style="vertical-align: inherit;">Daher verwenden wir es praktisch nicht und versuchen, es vollständig aufzugeben.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Über eine HTTP-Schnittstelle, in der Sie sowohl JSON-Anforderungen als auch Lucene-Syntax verwenden können. </font><font style="vertical-align: inherit;">Letzteres ist eine Text-Engine, die Elastic verwendet. </font><font style="vertical-align: inherit;">Mit dieser Option erhalten wir die Möglichkeit, JSON-Anforderungen über HTTP zu stapeln. </font><font style="vertical-align: inherit;">Dies ist die Option, die wir verwenden möchten.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dank der HTTP-Schnittstelle können wir Bibliotheken verwenden, die eine asynchrone Implementierung des HTTP-Clients ermöglichen. </font><font style="vertical-align: inherit;">Wir können Batch und die asynchrone API nutzen, die letztendlich eine hohe Leistung bietet, was in den Tagen einer großen Aktion sehr hilfreich war (mehr dazu weiter unten). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein paar Zahlen zum Vergleichen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speichern von Benutzern, die Preise in Postgres erhalten haben, in 20 Streams ohne Gruppierung: 460.713 Einträge in 42 Sekunden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elastischer + reaktiver Client für 10 Threads + Batch für 1000 Elemente: 596749 Datensätze in 11 Sekunden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elastischer + reaktiver Client für 10 Threads + Batch für 1000 Elemente: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23801684 Datensätze in 4 Minuten</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir einen HTTP-Anforderungsmanager geschrieben, der JSON als Batch / not Batch erstellt und unabhängig von der Bibliothek über einen beliebigen HTTP-Client sendet. </font><font style="vertical-align: inherit;">Sie können auch wählen, ob Anforderungen synchron oder asynchron gesendet werden sollen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In einigen Integrationen verwenden wir immer noch den offiziellen Transport-Client, aber dies ist nur eine Frage des kommenden Refactorings. </font><font style="vertical-align: inherit;">Gleichzeitig wird ein benutzerdefinierter Client, der auf der Basis von Spring WebClient erstellt wurde, für die Verarbeitung verwendet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/sx/qg/x2sxqgijaic0-ldqbrjlwse_tp0.jpeg" alt="Bild"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Große Förderung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einmal im Jahr findet eine große Kampagne für Benutzer des Projekts statt - dies ist dieselbe Hochlast, da wir zu diesem Zeitpunkt gleichzeitig mit zig Millionen Benutzern arbeiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalerweise treten Spitzenlasten in den Ferien auf, aber diese Aktion ist ein völlig anderes Niveau. Im vorletzten Jahr, am Tag der Aktion, haben wir 27.580.890 Wareneinheiten verkauft. Die Daten wurden mehr als eine halbe Stunde lang verarbeitet, was den Benutzern Unannehmlichkeiten bereitete. Die Benutzer erhielten Preise für die Teilnahme, aber es wurde klar, dass der Prozess beschleunigt werden musste. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anfang 2019 haben wir beschlossen, ElasticSearch zu benötigen. Ein ganzes Jahr lang haben wir die Verarbeitung der empfangenen Daten in Elastic und deren Ausgabe in der API der mobilen Anwendung und Site organisiert. Infolgedessen haben wir im nächsten Jahr während der Kampagne </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15 131 783 Datensätze in 6 Minuten verarbeitet.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir viele Leute haben, die Waren kaufen und an der Verlosung von Werbeaktionen teilnehmen möchten, ist dies eine vorübergehende Maßnahme. </font><font style="vertical-align: inherit;">Jetzt senden wir relevante Informationen an Elastic, aber in Zukunft planen wir, Archivinformationen aus den letzten Monaten als permanentes Repository an Postgres zu übertragen. </font><font style="vertical-align: inherit;">Um den elastischen Index nicht zu verstopfen, der auch seine Grenzen hat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung / Schlussfolgerungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Moment haben wir alle Dienste, die wir wollten, auf Elastic übertragen und vorerst angehalten. </font><font style="vertical-align: inherit;">Jetzt erstellen wir einen Index in Elastic über dem persistenten Hauptspeicher in Postgres, der die Benutzerlast übernimmt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Zukunft planen wir die Übertragung von Diensten, wenn wir verstehen, dass die Datenanforderung zu vielfältig wird und von einer unbegrenzten Anzahl von Spalten durchsucht wird. </font><font style="vertical-align: inherit;">Dies ist für Postgres keine Aufgabe mehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir eine Volltextsuche in der Funktion benötigen oder wenn wir viele verschiedene Suchkriterien haben, wissen wir bereits, dass dies in Elastic übersetzt werden muss.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">⌘⌘⌘</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danke fürs Lesen. </font><font style="vertical-align: inherit;">Wenn Ihr Unternehmen auch ElasticSearch verwendet und über eigene Implementierungsfälle verfügt, teilen Sie uns dies mit. </font><font style="vertical-align: inherit;">Es wird interessant sein zu wissen, wie andere haben :-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503200/index.html">YOLOv4 - das genaueste neuronale Echtzeitnetzwerk im Microsoft COCO-Dataset</a></li>
<li><a href="../de503204/index.html">So flashen Sie Xiaomi Redmi 4 Prime / Pro / Premium auf Android 10</a></li>
<li><a href="../de503208/index.html">Wann ist der beste Zeitpunkt für eine Investition?</a></li>
<li><a href="../de503210/index.html">Können Phishing-Sites ausgerottet werden?</a></li>
<li><a href="../de503212/index.html">30 Life Hacks, um den Online-Kurs abzuschließen</a></li>
<li><a href="../de503218/index.html">GlobalSign stellt Atlas vor - PKI-Plattform der nächsten Generation</a></li>
<li><a href="../de503226/index.html">Was hindert das Geschäft daran, sich in eine „Zahl“ zu verwandeln, und was hat es mit dem Ruf zu tun?</a></li>
<li><a href="../de503228/index.html">Herzfrequenzkontrolle beim Joggen durch musikalisches Feedback - oder „Tester, die gerne laufen, suchen“</a></li>
<li><a href="../de503230/index.html">Incident Response Platform-Klassensysteme: Anwendungs- und Hauptfunktionen</a></li>
<li><a href="../de503232/index.html">So werden Sie in sechs Monaten oder noch schneller DevOps-Ingenieur. Teil 6. Starten der Anwendung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>