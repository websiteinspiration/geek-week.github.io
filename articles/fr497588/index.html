<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👧🏿 🚿 🤲🏾 Spring Security - Un exemple d'application Web d'autorisation OAuth2 via BitBucket 👩🏻‍💼 👩🏿‍🎨 🍭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous examinerons un moyen d'autoriser des utilisateurs dans des applications Web sur Spring Boot en utilisant le protocole OAuth2 en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spring Security - Un exemple d'application Web d'autorisation OAuth2 via BitBucket</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497588/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cet article, nous examinerons un moyen d'autoriser des utilisateurs dans des applications Web sur Spring Boot en utilisant le protocole OAuth2 en utilisant un serveur d'autorisation externe (en utilisant l'exemple de Bitbucket).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que voulons-nous obtenir</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous développons une application Web sécurisée qui a accès aux ressources des utilisateurs sur un serveur externe, par exemple, un système d'intégration continue, et Bitbucket agit comme un serveur externe, et nous ne voudrions pas stocker le nom d'utilisateur et le mot de passe de l'utilisateur à partir du système externe. </font><font style="vertical-align: inherit;">Autrement dit, nous devons autoriser l'utilisateur via Bitbucket afin d'accéder à son compte et à ses ressources, vérifier en outre qu'il est un utilisateur de notre application et faire en sorte que l'utilisateur ne nous divulgue pas ses informations d'identification de Bitbucket. </font><font style="vertical-align: inherit;">Je me demande comment faire - bienvenue au chat.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 est un protocole d'autorisation qui vous permet de fournir à un tiers un accès limité aux ressources protégées d'un utilisateur sans avoir à lui donner (un tiers) un nom d'utilisateur et un mot de passe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 définit 4 rôles:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Propriétaire de la ressource </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Serveur de ressources </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Serveur d'autorisation </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Client (application) </font></font></li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un propriétaire de ressource</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un utilisateur qui utilise une application cliente et lui permet d'accéder à son compte hébergé sur un serveur de ressources. L'accès des applications au compte est limité par les autorisations accordées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur de ressources</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> héberge des comptes d'utilisateurs sécurisés. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur d'autorisation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> authentifie le propriétaire de la ressource et émet des jetons d'accès. Le serveur d'autorisation peut être simultanément un serveur de ressources. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une application cliente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une application qui souhaite accéder au compte et aux ressources d'un utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, l'application cliente est l'application que nous développons, et Bitbucket sera à la fois un serveur d'autorisation et un serveur de ressources.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 prend en charge quatre types d'autorisation: code d'autorisation, implicite, informations d'identification du mot de passe du propriétaire de la ressource et informations d'identification du client. </font><font style="vertical-align: inherit;">Nous ne les considérerons pas tous, nous sommes intéressés par le type de code d'autorisation. </font><font style="vertical-align: inherit;">Le type de code d'autorisation est optimisé pour les applications serveur dans lesquelles le code source n'est pas accessible au public et le code secret client peut rester confidentiel. </font><font style="vertical-align: inherit;">Ce type fonctionne sur la base d'une redirection, c'est-à-dire que l'utilisateur sera redirigé vers le serveur d'autorisation afin de confirmer son identité et permettre à l'application d'utiliser son compte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le processus d'autorisation via le code d'autorisation consiste en une séquence de deux demandes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Demande d'autorisation </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Demande de jeton d'accès </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une demande d'autorisation est utilisée pour confirmer l'identité de l'utilisateur, ainsi que pour demander l'autorisation de notre application à l'utilisateur. </font><font style="vertical-align: inherit;">Cette demande est une demande GET avec les paramètres suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> response_type - la valeur doit être égale au code </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - valeur obtenue lors de l'enregistrement d'un client auprès du fournisseur OAuth2 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - URL où l'utilisateur sera redirigé après autorisation </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> scope - un paramètre facultatif indiquant quel niveau d'accès est demandé </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> état - chaîne générée aléatoirement pour vérifier la réponse </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de demande:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://server.example.com/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;state=xyz&amp;redirect_uri=REDIRECT_URI
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si l'utilisateur confirme son identité et autorise l'application à accéder à ses ressources, l'agent utilisateur sera redirigé vers l'URL de rappel spécifiée lors de l'inscription du client avec le code de paramètre supplémentaire contenant le code d'autorisation et le paramètre d'état avec la valeur transmise dans la demande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de rappel:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://client.example.com/cb?code=AUTH_CODE_HERE&amp;state=xyz
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une demande de code d'accès est utilisée pour échanger le code d'autorisation reçu contre un code d'accès aux ressources utilisateur. </font><font style="vertical-align: inherit;">Cette demande est une demande POST avec les paramètres suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grant_type - la valeur doit être code_autorisation </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code - code d'autorisation obtenu à l'étape précédente </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - doit correspondre à l'URL spécifiée à l'étape précédente </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - valeur obtenue lors de l'enregistrement d'un client auprès du fournisseur OAuth2 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_secret - valeur obtenue lors de l'enregistrement d'un client auprès du fournisseur OAuth2 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de demande:</font></font><br>
<br>
<pre><code class="plaintext hljs">POST https://server.example.com/token<font></font>
    grant_type=authorization_code&amp;<font></font>
    code=AUTH_CODE&amp;<font></font>
    redirect_uri=REDIRECT_URI&amp;<font></font>
    client_id=CLIENT_ID&amp;<font></font>
    client_secret=CLIENT_SECRET<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La réponse du serveur contient le code d'accès et sa durée de vie:</font></font><br>
<br>
<pre><code class="plaintext hljs">{<font></font>
    "access_token": "2YotnFZFEjr1zCsicMWpAA",<font></font>
    "expires_in": 3600,<font></font>
    "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA"<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ensemble de ce processus est déjà automatisé dans Spring Security et nous n'avons pas à nous soucier de sa mise en œuvre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inscription client</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous enregistrerons notre application en tant que client dans Bitbucket pour obtenir une clé (Key) et un code d'accès (Client Secret). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/gz/ba/sngzbaxdqi0wpbsua7eurx_wcis.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saisissez le nom du client et l'URL de rappel. </font><font style="vertical-align: inherit;">Ensuite, nous notons ce qui sera disponible pour ce client. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/y3/3z/vky33zq59j1qg1nvtwmtwxpwqni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les valeurs Key et ClientSecret obtenues sont stockées dans application.properties:</font></font><br>
<br>
<pre><code class="plaintext hljs">client_id=ZJsdANfWkJ7jcktw2x<font></font>
client_secret=28uUrJ9m43svbkcnXVNj8qeBjFtd8jaD<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurer Spring Security</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, configurons Spring Security. </font><font style="vertical-align: inherit;">Pour que OAuth2 fonctionne, vous devez créer un objet ClientRegistration. </font><font style="vertical-align: inherit;">ClientRegistration stocke des informations sur le client enregistré auprès du fournisseur OAuth2. </font><font style="vertical-align: inherit;">Ici, nous avons besoin du client_id et du client_secret obtenus à l'étape précédente. </font><font style="vertical-align: inherit;">Puisqu'il peut y avoir plusieurs de ces objets ClientRegistration en général, Spring Security utilise l'objet ClientRegistrationRepository pour les stocker et y accéder. </font><font style="vertical-align: inherit;">Créons-le aussi. </font><font style="vertical-align: inherit;">Nous indiquons également que seul un utilisateur autorisé peut appeler une demande et redéfinir UserService avec sa mise en œuvre.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SecurityConfig.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_id}")</span>
    <span class="hljs-keyword">private</span> String clientId;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_secret}")</span>
    <span class="hljs-keyword">private</span> String clientSecret;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistration <span class="hljs-title">clientRegistration</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> ClientRegistration<font></font>
                .withRegistrationId(<span class="hljs-string">"bitbucket"</span>)<font></font>
                .clientId(clientId)<font></font>
                .clientSecret(clientSecret)<font></font>
                .userNameAttributeName(<span class="hljs-string">"username"</span>)<font></font>
                .clientAuthenticationMethod(BASIC)<font></font>
                .authorizationGrantType(AUTHORIZATION_CODE)<font></font>
                .userInfoUri(<span class="hljs-string">"https://api.bitbucket.org/2.0/user"</span>)<font></font>
                .tokenUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/access_token"</span>)<font></font>
                .authorizationUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/authorize"</span>)<font></font>
                .redirectUriTemplate(<span class="hljs-string">"{baseUrl}/login/oauth2/code/{registrationId}"</span>)<font></font>
                .build();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> MyOAuth2UserService <span class="hljs-title">oAuth2userService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2UserService(userService);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistrationRepository <span class="hljs-title">clientRegistrationRepository</span><span class="hljs-params">(List&lt;ClientRegistration&gt; registrations)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InMemoryClientRegistrationRepository(registrations);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@EnableWebSecurity</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MyOAuth2UserService userService;<font></font>
<font></font>
        <span class="hljs-meta">@Autowired</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthConfig</span><span class="hljs-params">(MyOAuth2UserService userService)</span> </span>{
            <span class="hljs-keyword">this</span>.userService = userService;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
            http<font></font>
                    .authorizeRequests(authorizeRequests -&gt; authorizeRequests<font></font>
                            .anyRequest().authenticated()<font></font>
                    )<font></font>
                    .oauth2Login(oauth2Login -&gt; oauth2Login<font></font>
                            .userInfoEndpoint(userInfoEndpoint -&gt; userInfoEndpoint.userService(userService))<font></font>
                    );<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserService de personnalisation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring Security non seulement implémente entièrement le processus d'autorisation, mais offre également la possibilité de le personnaliser. Par exemple, la possibilité de personnaliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une demande d'autorisation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demander un code d'accès</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ainsi que la possibilité de post-traitement personnalisé d'une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réponse à une demande de code d'accès</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Une fois l'autorisation réussie, Spring Security utilise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserInfo Endpoint</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour récupérer les attributs utilisateur du serveur d'autorisation. En particulier, l'implémentation de l'interface OAuth2UserService est utilisée à cet effet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons créer notre propre implémentation de ce service, afin qu'après autorisation de l'utilisateur sur le serveur d'autorisation, nous vérifions également s'il est un utilisateur de notre application, ou l'enregistrons si l'inscription est ouverte à tous. </font><font style="vertical-align: inherit;">Par défaut, Spring Security utilise l'implémentation de DefaultOAuth2UserService. </font><font style="vertical-align: inherit;">Il constituera la base de notre mise en œuvre.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyOAuth2UserService.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyOAuth2UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OAuth2UserService</span>&lt;<span class="hljs-title">OAuth2UserRequest</span>, <span class="hljs-title">OAuth2User</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_INFO_URI_ERROR_CODE = <span class="hljs-string">"missing_user_info_uri"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String INVALID_USER_INFO_RESPONSE_ERROR_CODE = <span class="hljs-string">"invalid_user_info_response"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE = <span class="hljs-string">"missing_user_name_attribute"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt; PARAMETERIZED_RESPONSE_TYPE = <span class="hljs-keyword">new</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt;() {<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestOperations restOperations;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = <span class="hljs-keyword">new</span> OAuth2UserRequestEntityConverter();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyOAuth2UserService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">this</span>.userService = requireNonNull(userService);
        <span class="hljs-keyword">this</span>.restOperations = createRestTemplate();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2User <span class="hljs-title">loadUser</span><span class="hljs-params">(OAuth2UserRequest userRequest)</span> <span class="hljs-keyword">throws</span> OAuth2AuthenticationException </span>{<font></font>
        checkNotNull(userRequest, <span class="hljs-string">"userRequest cannot be null"</span>);
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri())) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(MISSING_USER_INFO_URI_ERROR_CODE, <span class="hljs-string">"Missing required UserInfo Uri in UserInfoEndpoint for Client Registration: "</span> + userRequest.getClientRegistration().getRegistrationId(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        String registrationId = userRequest.getClientRegistration().getRegistrationId();<font></font>
        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();<font></font>
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userNameAttributeName)) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(<font></font>
                    MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE,<font></font>
                    <span class="hljs-string">"Missing required \"user name\" attribute name in UserInfoEndpoint for Client Registration: "</span> + registrationId, <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        ResponseEntity&lt;Map&lt;String, Object&gt;&gt; response;<font></font>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// OAuth2UserRequestEntityConverter cannot return null values.</span>
            <span class="hljs-comment">//noinspection ConstantConditions</span>
            response = <span class="hljs-keyword">this</span>.restOperations.exchange(requestEntityConverter.convert(userRequest), PARAMETERIZED_RESPONSE_TYPE);<font></font>
        } <span class="hljs-keyword">catch</span> (OAuth2AuthorizationException ex) {<font></font>
            OAuth2Error oauth2Error = ex.getError();<font></font>
            StringBuilder errorDetails = <span class="hljs-keyword">new</span> StringBuilder();<font></font>
            errorDetails.append(<span class="hljs-string">"Error details: ["</span>);<font></font>
            errorDetails.append(<span class="hljs-string">"UserInfo Uri: "</span>).append(<font></font>
                    userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri());<font></font>
            errorDetails.append(<span class="hljs-string">", Error Code: "</span>).append(oauth2Error.getErrorCode());
            <span class="hljs-keyword">if</span> (oauth2Error.getDescription() != <span class="hljs-keyword">null</span>) {<font></font>
                errorDetails.append(<span class="hljs-string">", Error Description: "</span>).append(oauth2Error.getDescription());<font></font>
            }<font></font>
            errorDetails.append(<span class="hljs-string">"]"</span>);<font></font>
            oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + errorDetails.toString(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        } <span class="hljs-keyword">catch</span> (RestClientException ex) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + ex.getMessage(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        }<font></font>
<font></font>
        Map&lt;String, Object&gt; userAttributes = emptyIfNull(response.getBody());<font></font>
<font></font>
        Set&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<font></font>
        authorities.add(<span class="hljs-keyword">new</span> OAuth2UserAuthority(userAttributes));<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (String authority : userRequest.getAccessToken().getScopes()) {<font></font>
            authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"SCOPE_"</span> + authority));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//     ,   </span>
        <span class="hljs-comment">//          ,</span>
        <span class="hljs-comment">//    </span><font></font>
        User user = findOrCreate(userAttributes);<font></font>
        userAttributes.put(MyOAuth2User.ID_ATTR, user.getId());<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2User(userNameAttributeName, userAttributes, authorities);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">findOrCreate</span><span class="hljs-params">(Map&lt;String, Object&gt; userAttributes)</span> </span>{<font></font>
        String login = (String) userAttributes.get(<span class="hljs-string">"username"</span>);<font></font>
        String username = (String) userAttributes.get(<span class="hljs-string">"display_name"</span>);<font></font>
<font></font>
        Optional&lt;User&gt; userOpt = userService.findByLogin(login);<font></font>
        <span class="hljs-keyword">if</span> (!userOpt.isPresent()) {<font></font>
            User user = <span class="hljs-keyword">new</span> User();<font></font>
            user.setLogin(login);<font></font>
            user.setName(username);<font></font>
            <span class="hljs-keyword">return</span> userService.create(user);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> userOpt.get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>{<font></font>
        RestTemplate restTemplate = <span class="hljs-keyword">new</span> RestTemplate();<font></font>
        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> OAuth2ErrorResponseErrorHandler());
        <span class="hljs-keyword">return</span> restTemplate;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point final de test</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est temps de créer un point de terminaison pour tester la santé de ce que nous venons de faire. </font><font style="vertical-align: inherit;">Notre point de terminaison consistera en une seule demande, qui accueillera l'utilisateur actuel.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WelcomeEndpoint.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Path("/")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WelcomeEndpoint</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-meta">@GET</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">welcome</span><span class="hljs-params">()</span> </span>{<font></font>
        User currentUser = getCurrentUser();<font></font>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Welcome, %s! (user id: %s, user login: %s)"</span>,<font></font>
                currentUser.getName(), currentUser.getId(), currentUser.getLogin());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getCurrentUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> userService.findByLogin(getAuthenticatedUser().getName()).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"No user logged in."</span>));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Authentication <span class="hljs-title">getAuthentication</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> MyOAuth2User <span class="hljs-title">getAuthenticatedUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (MyOAuth2User) getAuthentication().getPrincipal();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bilan de santé</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lançons l'application et nous nous rendons à l'adresse </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // localhost: 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et constatons que nous avons été redirigés vers le site Web de Bitbucket pour confirmer notre compte. </font><font style="vertical-align: inherit;">Saisissez le nom d'utilisateur et le mot de passe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vn/g7/g5/vng7g5ick7pzzako7jzlwafgqeu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons maintenant autoriser notre application à accéder à notre compte et à nos ressources. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k0/4g/hr/k04ghrn2luycrilhcghd5gdo-g0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le message d'accueil de l'utilisateur contient à la fois des attributs du serveur d'autorisation et l'ID utilisateur dans notre application.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/ud/tl/reudtl-zj8py7cgal2rroct6nvu.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La source</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code source complet de cette application est sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Références</font></font></h3><br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth - Wikipedia</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Référence de sécurité Spring</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le cadre d'autorisation OAuth 2.0</font></font></a> </li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497574/index.html">L'oncologie dans le contexte de la pandémie de COVID-19: comment sauver un maximum de vies</a></li>
<li><a href="../fr497578/index.html">AMD s'engage à gagner une part significative du marché des datacenters</a></li>
<li><a href="../fr497580/index.html">La quarantaine dure est très très mauvaise</a></li>
<li><a href="../fr497582/index.html">Habr prend la première place dans le classement des droits numériques des utilisateurs</a></li>
<li><a href="../fr497584/index.html">Auto quantifié: comment Madrobots a introduit les balances intelligentes Picooc en Russie</a></li>
<li><a href="../fr497590/index.html">Nous traitons de l'algorithme d'effondrement de la fonction d'onde</a></li>
<li><a href="../fr497594/index.html">Stockage de données externes: de l'époque d'IBM 1311 à nos jours. Partie 1</a></li>
<li><a href="../fr497596/index.html">Vive PHP</a></li>
<li><a href="../fr497602/index.html">Vous considérez-vous comme signataire? Qui plaisantez-vous</a></li>
<li><a href="../fr497606/index.html">Système d'arrosage automatique du jardin pour Home Assistant, ESP8266 et MiFlora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>