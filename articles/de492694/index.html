<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👉🏿 ⏮️ 🐄 Rezepte für angeschlagene SQL-Abfragen 🐌 🚂 🐵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einigen Monaten haben wir EXPLAIN.tensor.ru angekündigt , einen öffentlichen Dienst zum Parsen und Visualisieren von Abfrageplänen für PostgreSQL....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rezepte für angeschlagene SQL-Abfragen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vor einigen Monaten haben </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN.tensor.ru</font></font></b></i></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"> angekündigt</font></a><font style="vertical-align: inherit;"> , einen öffentlichen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dienst zum Parsen und Visualisieren von Abfrageplänen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Vergangenheit haben Sie es bereits mehr als 6.000 Mal verwendet, aber eine der praktischen Funktionen könnte unbemerkt bleiben - dies sind </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strukturelle Hinweise</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die ungefähr so ​​aussehen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/66/1s/jp661svgeudxc0wvgnzqoyjffbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hören Sie sie sich an und Ihre Anfragen werden „glatt und seidig“. :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber im Ernst, viele der Situationen, die die Anfrage langsam und „gefräßig“ in Bezug auf Ressourcen machen, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sind typisch und können an der Struktur und den Daten des Plans erkannt werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall muss nicht jeder einzelne Entwickler selbst nach einer Optimierungsoption suchen, sondern verlässt sich ausschließlich auf seine Erfahrung. Wir können ihm sagen, was hier passiert, was der Grund sein könnte und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie er mit der Lösung umgehen soll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Was wir getan haben. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/br/mr/upbrmra7tcpkdnygwg0abfhbqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns diese Fälle genauer an - wie sie bestimmt werden und zu welchen Empfehlungen sie führen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um einen besseren Einblick in das Thema zu erhalten, können Sie zuerst den entsprechenden Block aus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meinem Bericht zu PGConf.Russia 2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anhören </font><font style="vertical-align: inherit;">und dann eine detaillierte Analyse jedes Beispiels durchführen:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jHqaLp040rY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: Index "Untersortierung"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zeigen Sie die letzte Rechnung für den Kunden "LLC Bell" an.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Limit<font></font>
   -&gt; Sort<font></font>
      -&gt; Index [Only] Scan [Backward] | Bitmap Heap Scan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie den Index </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zum Sortieren von Feldern</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">1</span> <span class="hljs-comment">--    </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  pk <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    "" </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/nn/u1/wp/nnu1wpmpqryyy3rrpmhpofv1izk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru] Sie</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
können sofort feststellen, dass der Index mehr als 100 Einträge abgezogen hat, die dann sortiert wurden und dann der einzige übrig war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir reparieren:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_cli_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli, pk <span class="hljs-keyword">DESC</span>); <span class="hljs-comment">--   </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/gv/ny/ni/gvnyniyvlmcsfk-f2qk4voomvzo.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Selbst bei einer solchen primitiven Stichprobe - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8,5-mal schneller und 33-mal weniger Messwerte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Der Effekt wird umso sichtbarer, je mehr „Fakten“ Sie für jeden Wert haben </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich stelle fest, dass ein solcher Index als "Präfix" nicht schlechter als der vorherige für andere Abfragen funktioniert </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bei denen </font></font><code>pk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es keine </font><font style="vertical-align: inherit;">Sortierung </font><font style="vertical-align: inherit;">und keine </font><font style="vertical-align: inherit;">Sortierung gab </font><font style="vertical-align: inherit;">(mehr dazu finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in meinem Artikel über das Auffinden ineffizienter Indizes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Insbesondere wird </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein expliziter Fremdschlüssel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in diesem Bereich </font><font style="vertical-align: inherit;">normal </font><b><font style="vertical-align: inherit;">unterstützt</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: Indexschnittpunkt (BitmapAnd)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zeigen Sie alle Verträge für den Kunden LLC Kolokolchik, die im Auftrag von NAO Buttercup abgeschlossen wurden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapAnd<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zusammengesetzten Index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für die Felder aus der Quelle oder erweitern Sie eines der vorhandenen Felder aus der zweiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org); <span class="hljs-comment">--   foreign key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  (fk_org, fk_cli) = (<span class="hljs-number">1</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">--    </span></code></pre><br>
<img src="https://habrastorage.org/webt/dh/y4/mz/dhy4mzknpsqyk3ejuetev5mlmiy.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Richtig:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_org_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli);
</code></pre><br>
<img src="https://habrastorage.org/webt/vt/nm/2c/vtnm2csqildllccdfsffjgxu4ya.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hier ist die Verstärkung geringer, da Bitmap Heap Scan an sich sehr effektiv ist. </font><font style="vertical-align: inherit;">Aber immer noch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7-mal schneller und 2,5-mal weniger Messwerte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: Indexverknüpfung (BitmapOr)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zeigen Sie die ersten 20 ältesten "eigenen" oder nicht zugewiesenen Anwendungen für die Verarbeitung und ihre Priorität an.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapOr<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION [ALL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um Unterabfragen für jeden der ODER-Bedingungsblöcke zu kombinieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--   1:16  ""</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk); <span class="hljs-comment">--   "  " </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_own = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> <span class="hljs-comment">-- </span>
  fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">-- ...  ""</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
, (fk_own = <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  ""</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/7k/n2/d1/7kn2d1ko1hrbobs44a69hasatcs.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Richtig:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own = <span class="hljs-number">1</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">--   - 20,    </span></code></pre><br>
<img src="https://habrastorage.org/webt/pa/ej/2f/paej2f1lpkzhinvlz64tvf9n8ti.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir haben die Tatsache ausgenutzt, dass alle 20 erforderlichen Datensätze sofort im ersten Block empfangen wurden, sodass der zweite mit dem „teureren“ Bitmap-Heap-Scan nicht einmal durchgeführt wurde - infolgedessen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22-mal schneller 44 mal weniger Messwerte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine detailliertere Geschichte über diese Optimierungsmethode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anhand spezifischer Beispiele</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> finden Sie in den Artikeln von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: schädliche JOIN- und OR-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL-Antipatterns: eine Geschichte über die iterative Verfeinerung der Suche nach Namen oder „Optimierung hin und zurück“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine verallgemeinerte Version der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geordneten Auswahl durch mehrere Schlüssel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (und nicht nur durch ein const / NULL-Paar) wird im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL HowTo-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Artikel betrachtet </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">: Wir schreiben eine while-Schleife direkt in die Abfrage oder "Elementary Three-Way"</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4: Lesen Sie viel Unnötiges</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Regel tritt es auf, wenn Sie einen anderen Filter an einer vorhandenen Anforderung befestigen möchten.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Und du hast nicht das gleiche, aber </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit Perlmuttknöpfen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Film "Diamond Hand"</font></font></i><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie beispielsweise die obige Aufgabe ändern, werden die ersten 20 ältesten „kritischen“ Anwendungen für die Verarbeitung angezeigt, unabhängig von ihrem Zweck.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; 5 × rows &lt; RRbF --  &gt;80% <font></font>
   &amp;&amp; loops × RRbF &gt; 100 --     100  <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie einen [mehr] benutzerdefinierten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Index mit einer WHERE-Klausel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder fügen Sie zusätzliche Felder in den Index ein.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die Filterbedingung für Ihre Aufgaben "statisch" ist, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dh die</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Liste der Werte in Zukunft </font><b><font style="vertical-align: inherit;">nicht erweitert</font></b><font style="vertical-align: inherit;"> wird, ist es </font><font style="vertical-align: inherit;">besser, einen WHERE-Index zu verwenden. </font><font style="vertical-align: inherit;">Verschiedene Boolesche / Enum-Status passen gut in diese Kategorie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Filterbedingung </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterschiedliche Werte annehmen kann</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ist es besser, den Index mit diesen Feldern zu erweitern - wie in der obigen Situation mit BitmapAnd.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own<font></font>
, (random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">50</span>) <span class="hljs-keyword">critical</span>; <span class="hljs-comment">-- 1:50,   ""</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk);<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">critical</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ca/lg/hn/calghnldd9_313mns2a535sjwma.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Richtig:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk)
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">critical</span>; <span class="hljs-comment">--  ""  </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/op/t2/u4/opt2u4yh2mzocmdot9qovn6pzgu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wie Sie sehen, ist die Filterung vollständig aus dem Plan verschwunden und die Anforderung ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fünfmal schneller geworden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5: spärlicher Tisch</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verschiedene Versuche, eine eigene Warteschlange für Verarbeitungsaufgaben zu erstellen, wenn eine große Anzahl von Aktualisierungen / Löschungen von Datensätzen in der Tabelle zu einer großen Anzahl von "toten" Datensätzen führt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM [FULL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manuell durch </font><font style="vertical-align: inherit;">oder erzielen Sie ausreichend häufige </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autovakuumtests</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch Feinabstimmung der Parameter, auch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für eine bestimmte Tabelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In den meisten Fällen werden diese Probleme durch schlecht strukturierte Abfragen beim Aufrufen aus der Geschäftslogik verursacht, wie sie beispielsweise in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: Kampf gegen Horden von „Toten“ beschrieben werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber Sie müssen verstehen, dass selbst VACUUM FULL möglicherweise nicht immer hilft. </font><font style="vertical-align: inherit;">In solchen Fällen sollten Sie sich mit dem Algorithmus aus dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Artikel vertraut machen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">: Wenn VACUUM erfolgreich ist, bereinigen wir die Tabelle manuell</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: Lesen aus der Mitte des Index</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass sie nicht viel und alles nach Index gelesen haben und nichts extra gefiltert haben - aber trotzdem wurden deutlich mehr Seiten gelesen, als wir möchten.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sehen Sie sich die Struktur des verwendeten Index und die in der Anforderung angegebenen Schlüsselfelder genau an - höchstwahrscheinlich ist ein </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil des Index nicht angegeben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Höchstwahrscheinlich müssen Sie einen ähnlichen Index erstellen, jedoch ohne Präfixfelder, oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lernen, wie Sie deren Werte durchlaufen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli); <span class="hljs-comment">--     #2</span>
<span class="hljs-comment">--      fk_cli      </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">999</span> <span class="hljs-comment">--  fk_org  ,     </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/tl/py/lb/tlpylbllwrea5ilsf-epratclha.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru] Alles</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
scheint in Ordnung zu sein, auch nach Index, aber irgendwie verdächtig - für jeden der 20 gelesenen Datensätze musste ich 4 Datenseiten subtrahieren, 32 KB pro Datensatz - ist es nicht fett? </font><font style="vertical-align: inherit;">Ja, und der Name des Index ist </font><font style="vertical-align: inherit;">suggestiv. </font><font style="vertical-align: inherit;">
Wir reparieren:</font></font><code>tbl_<b>fk_org</b>_fk_cli_idx</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli);</code></pre><br>
<img src="https://habrastorage.org/webt/n9/5x/uz/n95xuzh7tcrmlv3eqg-bq2axhk4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Plötzlich - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 Mal schneller und 4 Mal weniger gelesen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weitere Beispiele für Situationen ineffizienter Verwendung von Indizes finden Sie im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Artikel </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">: Suchen Sie nach nutzlosen Indizes</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 7: CTE × CTE</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Abfrage haben wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"fette" CTEs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus verschiedenen Tabellen </font><b><font style="vertical-align: inherit;">eingegeben</font></b><font style="vertical-align: inherit;"> und dann beschlossen, zwischen ihnen zu </font><b><font style="vertical-align: inherit;">wechseln</font></b></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Fall ist relevant für Versionen unter Version 12 oder Anfragen von </font></font><code>WITH MATERIALIZED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; CTE Scan<font></font>
   &amp;&amp; loops &gt; 10<font></font>
   &amp;&amp; loops × (rows + RRbF) &gt; 10000<font></font>
      --     CTE<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysieren Sie die Anfrage sorgfältig - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird hier überhaupt CTE benötigt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Wenn dies </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trotzdem der Fall ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><b><font style="vertical-align: inherit;">wenden Sie in hstore / json das "Zerreißen"</font></b><font style="vertical-align: inherit;"> gemäß dem in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beschriebenen Modell an </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">: Schlagen Sie das Wörterbuch mit einem starken JOIN an</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 8: Swap to Disk (Temp geschrieben)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die einmalige Verarbeitung (Sortierung oder Eindeutigkeit) einer großen Anzahl von Datensätzen passt nicht in den dafür zugewiesenen Speicher.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; temp written &gt; 0</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die von der Operation verwendete Speichermenge den eingestellten Wert des Parameters </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_mem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nicht wesentlich überschreitet </font><font style="vertical-align: inherit;">, sollten Sie ihn anpassen. </font><font style="vertical-align: inherit;">Sie können sofort in der Konfiguration für alle, aber Sie können </font></font><code>SET [LOCAL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für eine bestimmte Anfrage / Transaktion durch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SHOW</span> work_mem;
<span class="hljs-comment">-- "16MB"</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  random()<font></font>
<span class="hljs-keyword">FROM</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/x-/mu/my/x-mumysko4noy3qy8qhdk0fecpq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Richtig:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> work_mem = <span class="hljs-string">'128MB'</span>; <span class="hljs-comment">--   </span></code></pre><br>
<img src="https://habrastorage.org/webt/h0/4z/kx/h04zkxsgcscgj8yxdasba8jdi2s.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[siehe EXPLAIN.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wenn aus offensichtlichen Gründen nur Speicher und keine Festplatte verwendet wird, wird die Anforderung viel schneller ausgeführt. </font><font style="vertical-align: inherit;">Gleichzeitig wird auch ein Teil der Last von der Festplatte entfernt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber Sie müssen verstehen, dass das Zuweisen von viel Speicher immer auch nicht funktioniert - es wird nicht für alle ausreichen.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 9: irrelevante Statistiken</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie haben viel auf einmal in die Datenbank gegossen, aber es nicht geschafft, sie zu vertreiben </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; ratio &gt;&gt; 10</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mach dasselbe </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Situation wird in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausführlicher </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">beschrieben: Statistiken sind allgegenwärtig</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 10: "etwas ist schief gelaufen"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wann entsteht</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde erwartet, dass eine Sperre durch eine konkurrierende Anforderung auferlegt wird, oder es gab nicht genügend CPU- / Hypervisor-Hardwareressourcen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man erkennt</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; (shared hit / 8K) + (shared read / 1K) &lt; time / 1000<font></font>
      -- RAM hit = 64MB/s, HDD read = 8MB/s<font></font>
   &amp;&amp; time &gt; 100ms --  ,   <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie ein externes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System, um den</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Server auf Sperren oder abnormalen Ressourcenverbrauch </font><b><font style="vertical-align: inherit;">zu überwachen</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Über unsere Version der Organisation dieses Prozesses für Hunderte von Servern haben wir bereits </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier gesprochen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/bi/9s/tsbi9svuilrqhgpgftjytkknpk4.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h7/zm/6d/h7zm6d-va_yx8g0mtxbdkyevcwq.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de492676/index.html">Speicher auf Magnetkernen in der Saturn 5-Rakete</a></li>
<li><a href="../de492678/index.html">Entwicklung des ersten Projekts auf der Plattform von Microsoft Dynamics 365 For Finance and Operations</a></li>
<li><a href="../de492682/index.html">Testosteron, warum ist es für Männer und wie man im Alter Kraft behält</a></li>
<li><a href="../de492684/index.html">Kostenloser Proxyserver für Unternehmen mit Domänenauthentifizierung</a></li>
<li><a href="../de492686/index.html">Wenn Linux Conntrack nicht mehr dein Freund ist</a></li>
<li><a href="../de492696/index.html">Worauf sollen Algorithmen zur Erkennung und Verarbeitung von Ausweisdokumenten getestet werden?</a></li>
<li><a href="../de492700/index.html">Deklaratives Einkaufen im Internet mit Zahlungsanforderungs-API und Angular</a></li>
<li><a href="../de492702/index.html">Maschinelle Übersetzung. Vom Kalten Krieg bis zur Gegenwart</a></li>
<li><a href="../de492704/index.html">Um die Effektivität des Implantatüberlebens um das 5-7-fache zu erhöhen - wie ist das möglich?</a></li>
<li><a href="../de492706/index.html">Gedächtnisarchive: Wie das Gehirn Erinnerungen codiert und reproduziert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>