<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛩️ 👵🏼 🏸 Überwachen von Fehlern und Ereignissen im PostgreSQL-Protokoll (grok_exporter) 🕋 🈚️ 🤵🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, Kollegen und Habretchiki! Heute möchte ich Ihnen einen kleinen Hinweis geben, wie Sie die betriebliche Überwachung von Fehlern und Ereignis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Überwachen von Fehlern und Ereignissen im PostgreSQL-Protokoll (grok_exporter)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487302/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guten Tag, Kollegen und Habretchiki! </font><font style="vertical-align: inherit;">Heute möchte ich Ihnen einen kleinen Hinweis geben, wie Sie die betriebliche Überwachung von Fehlern und Ereignissen, die im PostgreSQL-Protokoll angezeigt werden, mit Prometheus und dem Exporteur von Metriken grok_exporter organisieren können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich muss sofort sagen, dass dies natürlich ein Sonderfall bei der Verwendung dieses Exporteurs ist. </font><font style="vertical-align: inherit;">Warum wird es benötigt und wer könnte interessiert sein?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wer braucht das?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Prometheus bereits in Ihrer Infrastruktur vorhanden ist und die Erstellung einer separaten Infrastruktur zum Sammeln und Analysieren von Protokollen wie ELK oder Greylog teuer und unpraktisch ist (wenn Prometheus nicht vorhanden ist, ist dies kein Problem, es ist einfach und schnell zu installieren). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Tool ist nicht nur für DBAs nützlich, sondern auch für Anwendungsadministratoren im Allgemeinen für alle, die irgendwie mit Anwendungsprotokollen arbeiten. </font><font style="vertical-align: inherit;">Es ermöglicht Ihnen, schnell Informationen über das Verhalten von Freiberuflern zu erhalten und einen bestimmten Bezugspunkt für die weitere Analyse der Situation zu haben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wofür ist das alles?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch die Überwachung von Protokollen erhalten Sie ein vollständigeres Bild und können schneller auf neu auftretende Probleme reagieren, sei es: Autorisierungsversuche (einschließlich erfolgloser), verschiedene Fehler oder bestimmte Ereignisse. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gibt es eine gute Liste, die aus Ereigniskategorien besteht (siehe Abschnitt Protokollereigniskategorien). Sie kann zum Erstellen von Regeln in Prometheus verwendet werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metrikexporter grok_exporter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> können </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Sie</font></a><font style="vertical-align: inherit;"> unstrukturierte Daten aus der Quelle lesen, sie gemäß den Regeln in strukturierte Daten konvertieren und als Metriken in einem von Prometheus verstandenen Format weitergeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Exporter wurde im Image eines Plug- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ins</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in ELK </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;">Plugins-Filters-Grok erstellt</font></a><font style="vertical-align: inherit;"> , mit dem Sie eine Reihe von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plugins-Filtern-Grok-Vorlagen unverändert verwenden können</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Installation ist unkompliziert und einfach. </font><font style="vertical-align: inherit;">Folgen Sie dazu einfach dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und laden Sie die gewünschte Version herunter (und ja, alle sind Vorabversionen, und die neuesten Versionen befinden sich noch im Release Candidate-Stadium) und entpacken Sie das resultierende Archiv. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis erhalten wir den folgenden Satz:</font></font><br>
<br>
<pre><code class="plaintext hljs">grok_exporter-1.0.0.RC3.linux-amd64<font></font>
├── patterns<font></font>
│&nbsp;&nbsp; ├── ruby<font></font>
│&nbsp;&nbsp; ├── redis<font></font>
│&nbsp;&nbsp; ├── rails<font></font>
│&nbsp;&nbsp; ├── postgresql<font></font>
│&nbsp;&nbsp; ├── nagios<font></font>
│&nbsp;&nbsp; ├── mongodb<font></font>
│&nbsp;&nbsp; ├── mcollective-patterns<font></font>
│&nbsp;&nbsp; ├── mcollective<font></font>
│&nbsp;&nbsp; ├── linux-syslog<font></font>
│&nbsp;&nbsp; ├── junos<font></font>
│&nbsp;&nbsp; ├── java<font></font>
│&nbsp;&nbsp; ├── haproxy<font></font>
│&nbsp;&nbsp; ├── grok-patterns<font></font>
│&nbsp;&nbsp; ├── firewalls<font></font>
│&nbsp;&nbsp; ├── exim<font></font>
│&nbsp;&nbsp; ├── bro<font></font>
│&nbsp;&nbsp; ├── bacula<font></font>
│&nbsp;&nbsp; └── aws<font></font>
├── grok_exporter<font></font>
└── example<font></font>
    ├── exim-rejected-RCPT-examples.log<font></font>
    ├── config.yml<font></font>
    └── config_logstash_http_input_ipv6.yml<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
wo:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ausführbare Exporter-Datei</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enthält eine Reihe von Mustern</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enthält einen Testdatensatz und eine Beispielkonfigurationsdatei</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um den Exporter zu starten, führen Sie einfach die ausführbare Datei aus. </font><font style="vertical-align: inherit;">Die Konfigurationsdatei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird in dem Verzeichnis durchsucht, aus dem die Anwendung gestartet wird, oder ihr Speicherort wird durch die Option </font><b><font style="vertical-align: inherit;">-config</font></b><font style="vertical-align: inherit;"> angegeben</font></font><b><font style="vertical-align: inherit;"></font></b></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichtung und Vorbereitung der Arbeit</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h3><br>
<p>,      PostgreSQL.  :</p><br>
<ol>
<li>     grok_exporter    .    ,   pg_reload_conf. <br>
<br>
<ul>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_directory <span class="hljs-keyword">to</span> <span class="hljs-string">'/var/log/postgresql'</span>; </code></pre></li>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_mode <span class="hljs-keyword">to</span> <span class="hljs-string">'0644'</span>;</code></pre> </li>
</ul></li>
<li> log_line_prefix,  .      ,    .  : <br>
<br>
<pre><code class="sql hljs"> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_line_prefix <span class="hljs-keyword">to</span> <span class="hljs-string">'%t datname:%d,client:%h,app:%a,usename:%u,session:%c '</span>;</code></pre></li>
</ol><br>
<h3>grok_exporter</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst bearbeiten wir die Vorlage </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pattern / postgresql</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entsprechend dem Format unserer Protokolldatei und fügen zusätzliche Konstruktionen hinzu. </font><font style="vertical-align: inherit;">Ich betone noch einmal, dass die Syntax der Vorlagen vollständig mit der in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plugins-Filters-Grok verwendeten übereinstimmt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Daher können und sollten Sie für alle Probleme im Zusammenhang mit der Syntax die Dokumentation </font><b><font style="vertical-align: inherit;">lesen</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Lassen Sie uns also unsere Vorlage für PostgreSQL in das Formular bringen (die Datei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns / grok-patterns</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enthält bereits eine große </font><b><font style="vertical-align: inherit;">Anzahl</font></b><font style="vertical-align: inherit;"> grundlegender Vorlagen):</font></font><br>
<br>
<pre><code class="plaintext hljs">#     - postgresql<font></font>
PG_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND} [A-Z]{3,4}<font></font>
<font></font>
#    <font></font>
PG_ERROR_PATTERN (ERROR|WARNING|FATAL|PANIC)<font></font>
<font></font>
# log_line_prefix   - PostgreSQL<font></font>
PG_PREFIX %{PG_TIMESTAMP} datname:(%{DATA:datname})?,client:(%{DATA:client_host})?,app:(%{DATA:app_name})?,usename:(%{USER:usename})?,session:(%{DATA:session})?<font></font>
<font></font>
#    log_level     <font></font>
PG_ERROR_LEVEL %{PG_ERROR_PATTERN:log_level}:<font></font>
<font></font>
#    <font></font>
PG_EVENT_AUTH LOG:  connection authorized:<font></font>
<font></font>
#      SIGHUP,   <font></font>
PG_EVENT_RELOAD LOG:  received SIGHUP, reloading configuration files<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit dem Design </font></font><code>()?</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können Sie angeben, dass der Wert optional ist.</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird anhand von Beispielen ausführlich beschrieben, wie eine Konfigurationsdatei erstellt wird. </font><font style="vertical-align: inherit;">Im Folgenden wird nur angegeben, was verwendet wird.</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine kurze Beschreibung der Konfigurationsdatei (aus der Dokumentation)</font></font></b>
                        <div class="spoiler_text">      YAML     :<br>
<br>
<ol>
<li><b>global</b> —  <br>
<ul>
<li><b>config_version</b> —   .    grok_exporter,   ≥ 1.0.0.RC3,   3<br>
 <b>retention_check_interval</b> —    .    ,   .<br>
</li>
</ul><br>
</li>
<li><b>input</b> —         .<br>
<br>
<ul>
<li><b>type</b> —   .  : file, stdin, webhook.   ,    <b>file</b>;</li>
<li><b>path|paths</b> — c      -(-).   ;</li>
<li><b>readall</b> — ,       .<br>
  <b>true</b> —     ,     .       Prometheus . <br>
  <b>false</b> —      ,        grok_exporter;</li>
<li><b>fail_on_missing_logfile</b> —       -.  <b>true</b> —    ,    ;</li>
</ul></li>
<li><b>imports</b> — ,   ,          .    2,    ,   <b>grok</b>.<br>
<br>
<ul>
<li><b>type</b> —     <b>grok_patterns</b> ()  metrics ();</li>
<li><b>file|dir</b> —  .          , .</li>
</ul><br>
</li>
<li><b>grok_patterns</b> — ,         .</li>
<li><b>metrics</b> —    .   — counter, gauge, histogram, or summary.</li>
<li><b>server</b> —    <br>
<br>
<pre><code class="plaintext hljs">  protocol: https<font></font>
  host: localhost<font></font>
  port: 9144<font></font>
  path: /metrics<font></font>
  cert: /path/to/cert<font></font>
  key: /path/to/key<font></font>
</code></pre><br>
 </li>
</ol><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Syntax der 3. Version der Konfigurationsdatei wurde es möglich, Metriken aus einzelnen Dateien zu importieren. Auf diese Weise können Sie Metriken nach Zweck gruppieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie als </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nächstes die</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konfigurationsdatei base </font><b><font style="vertical-align: inherit;">config.yml</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Darin setzen wir: den Pfad zu den PostgreSQL-Protokolldateien per Maske; </font><font style="vertical-align: inherit;">Importvorlagen aus dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Verzeichnis </font><font style="vertical-align: inherit;">und Metriken aus dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics.d</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verzeichnis </font><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">Wir geben an, nach welchem ​​Protokoll und an welchem ​​Port Metriken beantragt werden müssen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  config_version: 3<font></font>
  retention_check_interval: 10s<font></font>
input:<font></font>
  type: file<font></font>
  path: /var/log/postgresql/postgresql-*.log<font></font>
  readall: false<font></font>
imports:<font></font>
- type: grok_patterns<font></font>
  dir: ./patterns<font></font>
- type: metrics<font></font>
  dir: ./metrics.d<font></font>
server:<font></font>
  protocol: http<font></font>
  port: 9144<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>,   <b>metrics.d</b>      <b>postgresql.yml</b>,       .<br>
<br>
 ,       , ..       (  retention, - 2  30 )    ,    .        <b>retention_check_interval</b>.<br>
<br>
 ,  :<br>
<br>
</p><ul>
<li>       ,        ;</li>
<li>     —   GAUGE  COUNTER,   . ..     GAUGE,         ;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn kumulativ auf true gesetzt ist, werden die Werte der Metriken mit demselben Satz von Beschriftungen summiert. Dies ist das erwartete Verhalten. </font><font style="vertical-align: inherit;">Eine unerwartete Situation kann auftreten, wenn Sie bei der zweiten Anforderung die Summe der Werte in der Anforderung plus des vorherigen Werts abrufen können.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn kumulativ auf falsch gesetzt ist und Metriken mit denselben Beschriftungen vorhanden sind, wird nur der letzte Wert angezeigt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass viele Briefe verwirrend und stellenweise unverständlich waren, aber ich werde versuchen, dies in den folgenden Beispielen offenzulegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben also eine Konfigurationsdatei, die vier Metriken, drei Zähler und einen beliebigen Wert zurückgeben kann. </font><font style="vertical-align: inherit;">Tatsächlich berücksichtigen die ersten drei die Anzahl der Übereinstimmungen des Übereinstimmungsvorlagenfelds mit den von der Quelle empfangenen Zeichenfolgen, die vierte - zeigt die Summe der Werte an.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.yaml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">#  - <font></font>
- type:   counter<font></font>
  name:   pg_grok_error_count<font></font>
  help:   Count of line error<font></font>
  match:  '%{PG_PREFIX} %{PG_ERROR_LEVEL}  %{GREEDYDATA:message}'<font></font>
  labels:<font></font>
    log_level:   '{{.log_level}}'<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
    message:     '{{.message}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_auth_succes_count<font></font>
  help:   Count of connections authorized<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_AUTH}'<font></font>
  labels:<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_reload_conf_count<font></font>
  help:   Count of call pg_reload_conf<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_RELOAD}'<font></font>
  labels:<font></font>
    session:     '{{.session}}'<font></font>
<font></font>
#   <font></font>
- type:       gauge<font></font>
  name:       pg_grok_tpm_file_size_bytes<font></font>
  help:       Size of tmp file created by time<font></font>
  match:      '%{PG_PREFIX} %{PG_EVENT_TMP_FILE}'<font></font>
  value:      '{{.size}}'<font></font>
  cumulative: true<font></font>
  retention:  5s<font></font>
  labels:<font></font>
    static:     'temp_file'<font></font>
</code></pre><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trainieren</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_error_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Metrik zählt die Anzahl der Ereignisse ERROR, WARNING, FATAL und PANIC gemäß dem Muster. </font><font style="vertical-align: inherit;">Es kann zur Überwachung und Warnung im Notfall nützlich sein. </font><font style="vertical-align: inherit;">Beispielsweise können Sie eine Warnung in den folgenden Fällen konfigurieren: Versuche einer nicht erfolgreichen Autorisierung, Überschreiten des Schwellenwerts für die Anzahl der Fehler pro Zeiteinheit oder wenn sich die Datenbank nach einem Fehler in einem Wiederherstellungszustand befindet, und vieles mehr ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokollereigniskategorien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispielsweise richten wir eine Warnung über fehlgeschlagene Autorisierungsversuche ein. </font><font style="vertical-align: inherit;">Ein Beispiel für einen erfolglosen Anmeldeversuch in der PostgreSQL-Protokolldatei sieht folgendermaßen aus:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 FATAL:  password authentication failed for user "test_user"<font></font>
2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 DETAIL:  Password does not match for user "test_user".<font></font>
        Connection matched pg_hba.conf line 86: "host    all             all             127.0.0.1/32            md5"<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der Ausgabe von grok_exporter können fehlgeschlagene Authentifizierungsversuche anhand des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachrichtenetiketts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> identifiziert werden, das </font><font style="vertical-align: inherit;">die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kennwortkennwortauthentifizierung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enthält, die </font><b><font style="vertical-align: inherit;">für ... fehlgeschlagen ist</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
</p><pre><code class="plaintext hljs">pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="postgres",log_level="FATAL",message="password authentication failed for user "postgres"", usename="postgres"} 15<font></font>
pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="test",log_level="FATAL",message="password authentication failed for user \"test_user\"",usename="test_user"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erhaltenen Daten helfen bei der Formulierung einer Regel für Prometheus. </font><font style="vertical-align: inherit;">Die Empfindlichkeit kann basierend auf Ihren eigenen Realitäten angepasst werden.</font></font><br>
<br>
<pre><code class="plaintext hljs">groups:<font></font>
- name: AuthAlert<font></font>
  rules:<font></font>
  - alert: AuthFail<font></font>
    expr: sum(rate(pg_grok_error_count{message=~"password authentication failed for user.*"}[1m])) by (instance) &gt; 0.1<font></font>
    for: 30s<font></font>
    labels:<font></font>
      severity: warning<font></font>
    annotations:<font></font>
      summary: Too many fail authorization for {{ $labels.instance }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_reload_conf_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ebenso können Sie die Ausführung des Befehls pg_reload_conf verfolgen. </font><font style="vertical-align: inherit;">Darüber hinaus lohnt es sich, auf die Liste der Labels oder vielmehr auf die Tatsache zu achten, dass nur ein Session-Label verwendet wird. </font><font style="vertical-align: inherit;">Dies liegt an der Tatsache, dass das Ereignis als Teil des Serverprozesses und nicht der Benutzersitzung erstellt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der PostgreSQL-Protokolldatei sieht dieses Ereignis folgendermaßen aus:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:20:26 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received SIGHUP, reloading configuration files
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jene. </font><font style="vertical-align: inherit;">Es ist ersichtlich, dass die im vorherigen Beispiel verwendeten Beschriftungen leer sind. </font><font style="vertical-align: inherit;">In diesem Fall verwenden wir die Sitzungskennung zur Identifizierung und sie ändert sich erst, wenn die Instanz von PostgreSQL gestoppt oder neu gestartet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine ähnliche Situation besteht für andere ähnliche Fälle, z. B. das Stoppen einer Instanz:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:32:52 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received fast shutdown request<font></font>
2020-04-21 01:32:53 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  database system is shut down<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Ausgabe von grok_exporter erhalten wir:</font></font><br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_reload_conf_count Count of call pg_reload_conf<font></font>
# TYPE pg_grok_reload_conf_count counter<font></font>
pg_grok_reload_conf_count{session="5e9d9371.564"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Regel für die Benachrichtigung, es macht keinen Sinn, sie zur Sprache zu bringen, sie wird der oben diskutierten ähnlich sein.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_tpm_file_size_bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde sofort reservieren, dass dieses Beispiel aus der Kategorie "Kugelpferd im Vakuum" stammt und in größerem Umfang angegeben wird, um zu zeigen, wie Sie das Verhalten von Metriken ändern können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Verhalten der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spurmetriken</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kann durch Änderung der beeinflusst werden </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retention</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kumulative</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parameter </font><font style="vertical-align: inherit;">. Im Gegensatz zu einem normalen Zähler, der die Anzahl der Zeilen berücksichtigt, die mit dem Übereinstimmungsmuster übereinstimmen, können Sie mit der Anzeige Daten aus der Protokolldatei bearbeiten. Es stellt sich heraus, dass wir es akkumulieren können, indem wir es um den erhaltenen Wert erhöhen oder verringern oder es als willkürlich ändernden Wert verwenden. Im ersten Fall interessiert uns also die Größe des Inkrements, im zweiten der Wert an sich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns einige Beispiele an:</font></font><br>
<br>
<ol>
<li>    ,     (<b>cumulative: true</b>).      ,    ,     .     ,  <b>retention_check_interval + retention &lt;= scrape_interval</b> —        Prometheus.<br>
<br>
        - PostgreSQL  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1278 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4728.0", size 46931968<font></font>
2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1279 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4729.0", size 46276608<font></font>
2020-04-21 02:51:15 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.14", size 47194112<font></font>
</code></pre><br>
,      :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
               .<br>
<br>
,       :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07
</code></pre><br>
     :      ,    .</li>
<li><p> ,       ,       (<b>retention</b>)    (<b>cumulative: true</b>)<br>
    ,  - PostgreSQL :</p><br>
<pre><code class="plaintext hljs">2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c6 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4806.0", size 46260224<font></font>
2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c5 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4805.0", size 46833664<font></font>
2020-04-21 03:03:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.15", size 47316992<font></font>
</code></pre><br>
   :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
   ,  . :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1325 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4901.0", size 46776320<font></font>
2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1324 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4900.0", size 45768704<font></font>
2020-04-21 03:10:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.18", size 47841280<font></font>
</code></pre><br>
    :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 2.80772608e+08
</code></pre><br>
          ,     .       ,    .</li>
<li>     ,   <b>cumulative</b>  <b>false</b>    ,  .<br>
<br>
  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1393 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5011.0", size 11763712<font></font>
2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1392 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5010.0", size 11501568<font></font>
2020-04-21 03:41:04 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.19", size 11911168<font></font>
</code></pre><br>
 :<br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_tpm_file_size_bytes Size of tmp file created by time<font></font>
# TYPE pg_grok_tpm_file_size_bytes gauge<font></font>
pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07<font></font>
</code></pre><br>
 ,       .  ,            .</li>
</ol><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweifellos ist grok_exporter das richtige Werkzeug zur Überwachung von Anwendungen. </font><font style="vertical-align: inherit;">Es ermöglicht Ihnen, die "schwer zugänglichen" Systeme für Überwachungssysteme und -orte zu untersuchen und die Überwachung mit zusätzlichen (Kontroll-) Metriken zu bereichern, während Sie recht einfach, funktional und leicht bleiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig ist es auch für Entwickler nützlich, da es zumindest indirekt über ein Überwachungssystem auf Anwendungsprotokolle zugreift. </font><font style="vertical-align: inherit;">Hier können Sie Metriken aus verschiedenen Quellen korrelieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer positiver Punkt ist, dass das Projekt neue Funktionen entwickelt und erwirbt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe wiederum, dass diese kurze Notiz nützlich sein wird, auch für das Projekt selbst. </font><font style="vertical-align: inherit;">Mehr Sterne, mehr Spaß bei der Arbeit! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danke an alle!</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487302/">https://habr.com/ru/post/de487302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487288/index.html">Wie Atari Apple auf dem Heim-PC-Feld der 1980er Jahre herausforderte</a></li>
<li><a href="../de487290/index.html">Samsung blockiert seinen „grauen“ Smart-TV in Russland aus der Ferne. UPD - Samsung Statement</a></li>
<li><a href="../de487294/index.html">Dramatiker - Microsoft Playwright und neues Testtool</a></li>
<li><a href="../de487296/index.html">Erleben Sie das Erstellen einer Webanwendung mit Pony ORM</a></li>
<li><a href="../de487298/index.html">Der Einfluss von Ethernet auf die Netzwerktechnologie im Jahr 2020</a></li>
<li><a href="../de487308/index.html">Java Records (JEP 359)</a></li>
<li><a href="../de487310/index.html">Wie berechnet man das Finanzmodell eines Treueprogramms?</a></li>
<li><a href="../de487314/index.html">Die Belastung der Angestellten (über Diskriminierung in der IT)</a></li>
<li><a href="../de487318/index.html">Einführung in die gegenseitige Authentifizierung von Diensten in Java mit TLS / SSL</a></li>
<li><a href="../de487322/index.html">Visualisierung der Wissenschaft: Illustrationen und Infografiken</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>