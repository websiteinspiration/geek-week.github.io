<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤷🏾 👔 📆 Hack Age of Empires III to change shader quality settings 🚚 🖐️ 🚶🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The beginning of May 2020 - if you are like me, then quarantine made you redo games that have not been launched for many years. 
 
 And if you are eve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hack Age of Empires III to change shader quality settings</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500542/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The beginning of May 2020 - if you are like me, then quarantine made you redo games that have not been launched for many years. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if you are even more like me, then somewhere you might have a disk of Age of Empires 3 lying around. Maybe you are playing on a Mac, maybe you have not upgraded to Catalina yet and want to command Morgan Black. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you start the game, get into the main menu, and immediately notice that something is wrong ... The menu looks </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disgusting</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5be/dfa/a66/5bedfaa660037faa86c176d9586f9d1a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are wondering what exactly is “disgusting,” then pay attention to the water. </font><font style="vertical-align: inherit;">Everything else is terrible too, but it's less obvious.</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/578/2d3/34f/5782d334f3be69385a0b69072ef6b7ed.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you go into the options, raise all the parameters to the maximum ... But the game is still ugly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You notice that the " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shader Quality</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">options are </font><font style="vertical-align: inherit;">suspiciously locked to " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ."</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attempt No. 1 - hack parameters</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, you begin to search for the game’s folder, which was supposedly created somewhere in the Documents folder, because the game was in 2005, and then everyone did it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What are we looking for? Of course, the file in which the parameters are stored. The menu interface does not allow us to change the settings, but we are tricky, right? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We find the right XML, because the game is 2005 and it’s, of course, XML, where we come across the option " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optiongrfxshaderquality</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", which is set to 0. It seems that we were looking for it, so we increase the value to 100, because there is not much quality. Here I agree with you.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/61d/de5/d85/61dde5d85e5442f781fe9c4eaeb46a55.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may also notice that this is a terrible use of XML. Fortunately, he has no good uses.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Satisfied with ourselves, we launch the game. Alas, nothing has changed. Looking again at the XML file, we see that the parameter is again set to 0. Ensemble Studios (may it rest in peace) looks with contempt at all your ingenuity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, we </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">could give</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> up. This is a Mac, therefore, the patches written by users are unlikely to be found (in fact, I checked - there are all sorts of dubious solutions that may work). It's all about the graphics. It seems to fix the problem will be difficult.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we will not give up. </font><font style="vertical-align: inherit;">Because we remember what Age 3 should look like. We remember how we admired this beautiful wavy water. </font><font style="vertical-align: inherit;">These particle effects. </font><font style="vertical-align: inherit;">These huge ships that just do not fit into the frame. </font><font style="vertical-align: inherit;">And, it’s just that the camera was zoomed in, what was I just thinking?</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attempt No. 1 - hacking data</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the very beginning of the folder in Documents there is a log file. The game wrote a graphics card there and reported that it had selected the “generic dx7” setting. It says that you have installed Intel GMA 950, which really was on the previous computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But on this you have Intel Iris Graphics 6100. Something is really wrong. You make an assumption - the game determines the graphic capabilities of the computer, comparing it with a database of graphic cards instead of checking the capabilities of the card itself. Because that's exactly what AAA developers do, and if you worked on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open-source RTS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then you know how this happens.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6e/8b3/fb2/b6e8b3fb28030917e8300cdce5653fac.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The contents of the log file. If you find it funny that Intel is designated as 0x8086, then you have chosen the appropriate article.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
By chance, you find old </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patch notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that confirm your concerns. You look into the GameData folder, but there are only </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bar</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.xmb files</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that are mostly unreadable. </font><em><font style="vertical-align: inherit;">You are looking</font></em><font style="vertical-align: inherit;"> for grep " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " and " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dx7</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Nothing happens. Delete several files ... Nothing happens. But you know that AAA games can store some resources in strange places, and this is the port of Windows games on Mac, so everything can be very bizarre here.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ultimately, you find the file “render.bar”; if you move it, the game crashes when it starts. It’s not very clear, but not bad. We open the file in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hex Fiend</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because this program usually allows you to learn something about binary files. And so it turns out. Part of this data is readable text. Some of them are shaders. But most of the data is strangely divided by empty space ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9d1/3a2/6f5/9d13a26f5dfff14c2b44f59dbc69b673.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hex Fiend Interface It is minimalistic, but it works. The first bytes are the letters “ESPN”, which are most likely the .bar header.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You exclaim: “Obviously, this is UTF-16!” The game was created for Windows, so it is logical that it stores text in UTF-16, wasting almost half of a 30-megabyte data file. After all, Windows loved UTF-16 (although </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it shouldn't</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), so why not use this encoding and ASCII shaders in one file. It is a logical idea! </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Actually, it took me about a day to figure it out)</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hex Fiend has the option of parsing bytes like UTF-16, so again we are looking for the grep string dx7. There are several entries. We replace them with the dx9 line, which is also found in the data, save the file and launch the game.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yeah Logs again do not display "dx9". This is probably set elsewhere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try something else. Suppose that the game recognizes graphic cards, and their hex identifiers are stored in the logs (in my case, 0x8086 is Intel, and also 0x2773). We are looking for “8086” in Hex Fiend, we find something, and part of the text looks promising. The Intel 9 Series is the GMA 950 series, and Age 3 probably didn't work very well on it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/af6/b22/f44/af6b22f4473691b673cb5dba2fd197f0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some numbers are like card identifiers (2582, 2592); perhaps if you replace them, then something will change. We made a copy of the file anyway, so you can try. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alas, this is also a dead end. In fact, we are studying the wrong file. Fortunately, I can tell you this because I spent a lot of time on it and tried </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">too</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> much. This damn thing took about 20 hours. And this is not counting the time for all the screenshots ... The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
desired file is called "DataP.bar", and if we wisely replace the ID, we will see something completely new in the logs:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/e79/6a2/445e796a2ca507e1f1a056da1cbd30a3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I don’t quite understand why this “generic dx7” is not the same as in the screenshot above. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, in the game we are still limited by the “Low” settings, that is, the logs do not lie. </font><font style="vertical-align: inherit;">We were hoping for a Medium, but </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alas</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that more from hacking data can not be achieved. </font><font style="vertical-align: inherit;">It’s time to get the tools seriously.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attempt No. 2 - hacking</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, if nothing succeeds, we have one last thing left: to change the executable file itself (that is, as they said in 2005, “crack” it). </font><font style="vertical-align: inherit;">It seems that today it is simply called hacking, but this term has been preserved in the field of game piracy (of course, I personally </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have never</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> done this). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We move on to the most interesting part of the article (yes, you have already read a thousand words, but wasn’t it curious?).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disassembler Hopper</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, our tool will be a disassembler: an application that receives the binary code of the executable file and turns it into readable (ha ha) assembler code. The most popular of these is IDA Pro, but it's insanely expensive and I'm not sure if it works on a Mac, so I’ll use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is not free (costs $ 90), but it can be freely used for 30 minutes at a time with almost all the necessary functions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not explain the interface in detail, because </font><font style="vertical-align: inherit;">everything is well laid out </font><font style="vertical-align: inherit;">in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopper tutorial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but I will tell you what I will do and try to take enough screenshots so that you can learn something.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to say: it took me five days to resolve, and many unsuccessful attempts were made. Basically, I will talk about successful steps, so it will seem magic. But it was </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">difficult</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Do not worry if you have any problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And one more note: “cracking” is most often illegal and / or performed for illegal purposes. I demonstrate a rather rare example of a fairly legitimate use, which at the same time is completely “white hat”, so everything is in order here. I will assume that, strictly speaking, this is illegal / contrary to the end user agreement, but, obviously, is a case of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force majeure</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Be that as it may, pay for what you like, and only for that, because anti-consumerism is cool.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a04/597/b6a/a04597b6a9ad1979e14216547ecf61d6.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db3/dfb/1e3/db3dfb1e3ec50890530001d69a22cdd2.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/605/66d/e69/60566de69653b745f83d196f56679263.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drag the Age 3 app to open it. </font><font style="vertical-align: inherit;">Just select "x86" instead of powerPC, because the game is something 2005.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage 1 - search for the desired fragment</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Surprisingly, this may be the most difficult. </font><font style="vertical-align: inherit;">We have a disassembled code, but we have no idea where to look. </font><font style="vertical-align: inherit;">Yes, some games have debugging symbols, so you can read the function names, but not in our case. </font><font style="vertical-align: inherit;">Hopper gives us names like "sub_a8cbb6", which we have to deal with on our own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, we have a head start: our </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log file</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It is highly likely that </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">string literals</font></a><font style="vertical-align: inherit;"> are used when writing to the log</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, ASCII are flashed in the executable file. </font><font style="vertical-align: inherit;">We can look for them with grep, because we won’t get rid of them by any compilation (however, they can be hidden by obfuscation of the code. Fortunately, this did not happen.). </font><font style="vertical-align: inherit;">Finding grep string literals is usually the first thing they do when disassembling a program. </font><font style="vertical-align: inherit;">So, let's enter “found vendor” in the Hopper search box and it will find something:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/da7/114/b61/da7114b61ecba23df73633ad41ab338f.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh yes, string literals, I adore them. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This in itself did not advance us so much. </font><font style="vertical-align: inherit;">But since the address of this "string of literals" is hard-coded, we can find links to it. </font><font style="vertical-align: inherit;">Hopper highlighted them in green on the right: "DATA XREF = sub_1d5908 + 1252." </font><font style="vertical-align: inherit;">Double-clicking on the line, we will move on to our hero - </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_1d5908</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> procedure </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d6d/d6a/e8b/d6dd6ae8bbe346215273e7beb930b0a7.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we find the assembler code. </font><font style="vertical-align: inherit;">It is believed to be difficult to read, but it is not. </font><font style="vertical-align: inherit;">The hardest thing is to understand it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, Hopper uses "Intel syntax", that is, the first operand is the receiver, and the second is the source. </font><font style="vertical-align: inherit;">In the highlighted line we see </font></font><code>mov dword [esp+0x1DC8+var_1DC4], aXmlRenderConfi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Let's make it out.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our first line in assembler</font></font></h2><br>
<code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is a MOV team known for being on x86 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turing-complete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It moves (actually copies) the data from A to B, which essentially means reading A and writing it to B. Based on the foregoing, </font></font><code>aXmlRenderConfi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is A, and </font></font><code>dword [esp+0x1DC8+var_1DC4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is B, the recipient. Let's take a closer look at this. </font></font><br>
<br>
<code>aXmlRenderConfi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is the value that Hopper helps us. This is actually an alias for the memory address of the string literal that we clicked a few seconds ago. If you split the window and look at the code in Hex mode (which is the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preferred</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode for hackers), we will see there </font></font><code>88 18 83 00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0d3/d74/31d/0d3d7431d27f6a03c2af6142f27c9a9b.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopper conveniently highlights the same selected fragments in both windows.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If the “flip” value is correct, then we will get 0x00831888 - the memory address of the string literal (in one of the screenshots shown above it is even highlighted in yellow). So, one riddle is solved: the code executes MOV, that is, it writes the address 0x00831888. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is it written as </font></font><code>88 18 83 00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, not how </font></font><code>00 83 18 88</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? This happened because of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">byte order</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a rather confusing topic that usually has little impact. This is one of those things that make people say that “computers don't work.” For us, this means that this problem will occur in all numbers with which we will work today.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may have noticed that I said “write down the address”, and that’s true: we don’t really care about the contents, which turned out to be a string literal with a zero byte at the end. We write down the address because the code will later refer to this address. This is a pointer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What about </font></font><code>dword [esp+0x1DC8+var_1DC4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Everything is more complicated here. </font></font><code>dword</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">means that we are working with "double words (double-words)", that is, with 16 * 2 bits. That is, we copy 32 bits. Recall: our address is</font></font><code>0x00831888</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, 8 hexadecimal characters, and each hexadecimal character can have 16 values, i.e. 4 data bits. So we get 8 * 4 = 32. By the way, the notation “32-bit” for computer systems came from here. If we used 64 bits, then the memory address would be written as 0x001122334455667788, would be twice as long and 2 ^ 32 times larger, and we would have to copy 16 bytes. So we would have much more memory, but copying the pointer would require twice as much work, and therefore 64 bits are actually not twice as fast as 32 bits. By the way, a more detailed explanation of the term “word” can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Because it is, of course, more complicated than my explanation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, what about the part in square brackets? The brackets mean that we calculate what is inside, and consider it a pointer. Therefore, the MOV command will write to the memory address obtained from the calculations. Let's look at it again in more detail (and don’t worry, when you are done with this, you will essentially know how to read assembler code with Intel syntax). </font></font><br>
<br>
<code>esp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is a </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">register</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that in assembler is the closest equivalent to a variable. There are a lot of registers in x86 architecture, and different registers have different ways of application, but we won’t really care. Learn more about this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Just be aware that there are special registers for floating point numbers, as well as “flags” that are used for comparisons and similar operations. Everything else is just hexadecimal numbers that Hopper reworked a bit to help us. </font></font><code>var_1DC4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this </font></font><code>-0x1DC4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we can see it at the beginning of the procedure, or in the right panel. This means that the result of the calculation </font></font><code>[esp+0x1DC8+var_1DC4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be </font></font><code>[esp + 0x1DC8 — 0x1DC4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that equals </font></font><code>[esp + 4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In essence, this means "take the 32-bit value of the ESP register, add 4, and interpret the result as a memory address." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we repeat: we write the address of the string literal in “esp + 4”. This is correct information, but it is completely useless. What does this mean?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the difficulty in reading assembly code: in parsing what it should do. </font><font style="vertical-align: inherit;">Here we have a head start: we know that he most likely writes something to the log. </font><font style="vertical-align: inherit;">Therefore, we can expect a call to a function that writes to the log. </font><font style="vertical-align: inherit;">Let's look for her.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c57/7f8/827/c577f8827feb59247a7c69ed0467fef2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the screenshot above, there are several similar calls, as well as the command </font></font><code>call</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that calls the procedure. </font><font style="vertical-align: inherit;">Hopper usually talks about this (I don’t know why he didn’t do it here), but in essence, we give arguments for calling the function. </font><font style="vertical-align: inherit;">If you click on different subroutine calls, we find something called imp___jump_table___Z22StringVPrintfExWorkerAPcmmPS_PmmPKcS_. </font><font style="vertical-align: inherit;">This is the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decoded</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> name of the function, and the “Printf” part is enough to understand that it really outputs something. </font><font style="vertical-align: inherit;">We don’t care how she does it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take a step back</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, we completely departed from what we did: we tried to convince the game that our 2015 graphics card was powerful enough to launch the 2005 game. Let's summarize. We found the place where the log is being recorded. If we are lucky, then here is the code that checks the parameters and capabilities of graphic cards. Fortunately, we were really lucky (there is a high probability that otherwise this article would not have been). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get the big picture, we will use the Hopper Control Flow Graph function, which breaks the code into small blocks and draws arrows indicating different transitions. This is much easier to understand than in ordinary assembler, in which often everything is in a mess.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e3a/4bd/1b1/e3a4bd1b1528d0344f4f1174b16be79c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The call to the log entry is in the middle of a terribly long function, because this, again, usually happens in AAA games. </font><font style="vertical-align: inherit;">Here we should look for other Hopper string literals and "hints", hoping to find something. </font><font style="vertical-align: inherit;">At the beginning of the procedure is the rest of the logging, and below there are interesting parts about “forcing dx7” and “Very High” options, as well as a problem with the version of pixel shaders ... </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which we have.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The log of our "hacked" data reported that we had pixel shaders of version 0.0, and they are incompatible with the "High" parameters. </font><font style="vertical-align: inherit;">This code is located in the lower left corner of our function, and if you look closely, you can see something curious (highlighted by your humble servant): it is the same code four times repeated for the parameters "Very High", "High", "Medium" and "Low". </font><font style="vertical-align: inherit;">And yes, it took me several hours to find this.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/27b/132/603/27b13260328e5da3cbef4323e840563f.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I highlighted in blue the block in which “pixel shader version 0.0 High” is displayed in the log. I highlighted similar parts with other beautiful colors.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The only differences are that we write “0x0”, “0x1”, “0x2” and “0x3” in different places. This is suspiciously similar to the parameters file that we examined above and the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optiongrfxshaderquality</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">(you may not understand this yet. But it is, believe me). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, we can try to go in different ways, which I did. But I will be brief - we will do the most necessary: ​​find out why pixel shader verification fails. Let's look for a branch. The output block to the log is linear, which means it should be somewhere above.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/724/d53/3a7/724d533a7f9af2353f611c6bea4f15b7.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEMVER fans, see a more advanced version format: floating point numbers.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And in fact, right above it there </font></font><code>jb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a transition command (think of “goto”). This is a " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conditional jump</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", and the condition is " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if less</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." Assembler “ifs” work through </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">register flags</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which I briefly talked about above. It’s enough just to know that we need to look at the command above: most likely, it sets the flag. Often this is a command </font></font><code>cmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but used here </font></font><code>ucomiss</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is barbarism. But she easily googles: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ucomiss</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is a floating point comparison command, and this explains why the code has</font></font><code>xmm0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: This is a register of floating point numbers. This is logical: the logs report that our version of the pixel shaders is “0.0”, which is a floating-point value. So what is located at memory address 0x89034c then? Hexadecimal data has a look </font></font><code>00 00 00 40</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and it can be confusing. But we know that we should expect floating point numbers, so let's interpret the data like that: that means </font></font><code>2.0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Which is a logical floating point value for the version of pixel shaders that Microsoft actually used in its </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">High-Level Shading Language</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on which DirectX shaders are written. </font><font style="vertical-align: inherit;">And Age 3 is a DirectX game, even though the port on the Mac uses OpenGL. </font><font style="vertical-align: inherit;">It is also logical that in 2005 pixel shaders of version 2.0 are required to enable the High parameter, so we are moving in the right direction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do we fix this? </font><font style="vertical-align: inherit;">This comparison instruction performs a comparison with the value at </font></font><code>xmm0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is given in the above line: </font></font><code>movss xmm0, dword [eax+0xA2A8]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">MOVSS is a special “move” command for floating point registers, and we write 32 bits from the address, which is the result of evaluating eax + 0xA2A8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presumably, this value is not 2.0, but rather 0.0. </font><font style="vertical-align: inherit;">Let's fix it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doing real hacking</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we are ready to get to the parameters of the High game. We want to go along the “red” path and skip all the logic with the “wrong version of pixel shaders”. This can be done by successfully passing the comparison, that is, by reversing the transition condition, but we have one more trick: the code is composed in such a way that when deleting the transition we will go the “red” way. Let's just replace the transition with </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an operation that does nothing (it is impossible to simply delete or add data to the executable file because an offset will occur and everything will break). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I recommend getting out of CFG for this, because otherwise Hopper starts to go crazy. If everything is done correctly, then in the Hex window we will see red lines.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/903/09d/db2/90309ddb2fecf42031e8bf9d4a6abe88.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/010/d39/b35/010d39b355b0cb7e5b55fc83007e17ae.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Red shows the changes we have made. </font><font style="vertical-align: inherit;">At this point, if you paid for Hopper, you can simply save the file. </font><font style="vertical-align: inherit;">But I didn’t pay, so I will open the executable file in Hex Fiend, find the desired area (by copying the area from Hopper to the Find tab inside Hex Fiend) and change it manually. </font><font style="vertical-align: inherit;">Be careful here, you can break everything, so I recommend copying the source executable file somewhere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having done this, start the game, go to the options ... And cheers - we can select "High". </font><font style="vertical-align: inherit;">But we can not choose "medium". </font><font style="vertical-align: inherit;">And we can not use the high parameters of the shadows. </font><font style="vertical-align: inherit;">Nevertheless, we are making progress!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3df/3a2/bba/3df3a2bbaa02e57ce2997e53137bdb56.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just take a look at these magnificent reflections in the water!</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enhancements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, you can fix this in the best way. Our solution worked, but we can make it so that the condition is met correctly: making the game think that our graphics card actually has shaders of version 2.0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we recall, the game loads the value at the address </font></font><code>eax+0xA2A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can use Hopper to find out what was originally recorded there. We need to find a command in which 0xA2A8 is used as the recipient operand (I chose 0xA2A8 because it is a fairly specific value, and we cannot be sure that the same register is not used elsewhere). Here the Hopper backlight is very useful to us, because we can just click on 0xA2A8 and look for the yellow parts in CFG.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bbd/5ed/75b/bbd5ed75b7b712a39861769efc3f63cd.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our victory is a little higher: as expected, we write the value of some kind of floating-point register. I admit that I do not really understand what is happening before this (my best guess: the game checks the possibility of texture compression), but this is not particularly important. Let's write “2.0” and continue the work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we will use the “Assemble instruction” of the Hopper application, and then do the same manipulations in Hex Fiend.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/92d/3d1/637/92d3d1637e2c46321c9983f68ffda742.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/784/a8f/f5b/784a8ff5bb2755f378143d4740d4201f.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9b6/fed/ff0/9b6fedff0d7cbbeb9713c34513776468.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use MOV instead of MOVSS because we write the usual value, and not the special value of the floating-point register. In addition, it is in direct byte order, that is, inverted.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You will notice that something strange is happening: we “ate” the team </font></font><code>jb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It happened because the new command takes more bytes than the previous one, and as I said, we cannot add or remove data from the executable file to save offsets. Therefore, Hopper has no choice but to destroy the team </font></font><code>jb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This can become a problem, and we can eliminate it by moving the command up (after all, we no longer need to write the xmm3 value). This will work here, because in any case, we are doing the branching on the right path. Lucky.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you start the game ... then nothing will change much. </font><font style="vertical-align: inherit;">I suggested that the Intel 9 series is not fast enough, so the game complains. </font><font style="vertical-align: inherit;">This is not a problem, because in reality we are striving for “Very High”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What was the most powerful card around 2004? </font><font style="vertical-align: inherit;">NVIDIA GeforceFX 6800. Let’s trick us into convincing the game that we have it installed.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Down the rabbit hole</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, this is a completely new section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We know that the game uses Hex codes to refer to graphic cards, and that it receives information from data files. We know that this should happen in the function we are studying (at least it would be strange if it weren’t). So we can find the code that does this. But it can still be difficult, because we do not know what exactly to look for. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have one clue: options behave strangely; there is Low / High, but no Medium. So maybe there is another code that handles all of these “Very High”, “High”, “Medium” and “Low”. And he actually is, in the same function. He's a lot earlier at CFG, and seems interesting.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e73/73a/ea1/e7373aea138358b603c609d8704cfed0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can assume that the raw data is stored in some kind of XML, because it is very likely, because there are several other data files that are XML. And XML is essentially a bunch of pointers and attributes. Therefore, the code here most likely checks for some XML attributes (and in fact, below is “expected one of ID, Very High ...”, which is very similar to checking the correctness of the file). We can imagine a similar XML structure in which Boolean values ​​determine the quality of shaders:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e8/bf7/411/4e8bf7411dd677f1415ae71c887cbef5.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is worth considering that this is a very arbitrary guess. </font><font style="vertical-align: inherit;">Everything may look a little different. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very interesting part is shown on the left side of the CFG (for you it can be on the right, but shown on the left in the screenshot): we see the same </font></font><code>var_CC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one that is used in the code that writes the device ID to the log. </font><font style="vertical-align: inherit;">That is </font></font><code>ebp+var_CC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, probably refers to the ID of our device, 0x2773. </font><font style="vertical-align: inherit;">The strange thing is that there is no string literal in the first “check”, but this is a Hopper bug: the address 0x0089da8e contains hexadecimal data 69006400, which in UTF-16 stands for “id” (in fact, probably Hopper could not understand this because UTF16). </font><font style="vertical-align: inherit;">And we </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are just</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> looking for an ID. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You know what? </font><font style="vertical-align: inherit;">Let's run the debugger and check everything in reality.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Game debugging</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open a terminal window and run lldb (just type lldb and press enter). First we need to tell LLDB to follow Age 3, and then we can start the game by calling </font></font><code>run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The game starts, and we get nothing useful.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/47b/0f2/279/47b0f227957a0414bc739002abafb432.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to add a breakpoint: to confirm our assumptions, we want to stop execution when we get to the code shown above. We do not have source code, but it doesn’t matter: we can set a breakpoint at the memory address. And we have the address in the code. Let's add a stop to a MOV call that receives an "id", its address is 0x001d5e68. To add a breakpoint, just enter </font></font><code>br set -a 001D5E68</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After starting the game, it stops and LLDB shows the disassembled code (in the AT&amp;T syntax, not Intel, so all the operands are inverted, but we see that this is the same code). You may notice that LLDB in this case is actually smarter than Hopper; he tells us that we are performing operations related to XML and printf output.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cd0/2fa/07c/cd02fa07c9a2dbd13ed07558f0983595.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95d/fa6/710/95dfa671088f1c7097b439851f586b24.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feel like a hacker? </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To move on, let's take a “step instruction”. </font><font style="vertical-align: inherit;">A short command for this </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 is </font></font><code>ni</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Repeating several times, we notice that we are back to where we started. </font><font style="vertical-align: inherit;">This is a cycle! </font><font style="vertical-align: inherit;">And this is completely logical: we are probably iterating around some kind of XML. </font><font style="vertical-align: inherit;">In fact, Hopper showed us this - if we follow the CFG, we will see a (possible) cycle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/70f/63f/fdd/70f63ffddb8c3c073dcc257af70581d8.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means:</font></font><code>if (*(ebp+var_CC) == *(ebp+var_28)) { *(ebp+var_1D84)=edi }</code></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Its exit condition is for the value to </font></font><code>ebp+var_1D84</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">be non-zero. </font><font style="vertical-align: inherit;">And we see an interesting code parameter in the one highlighted by me </font></font><code>var_CC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's add a breakpoint on this one </font></font><code>cmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and we'll figure it out.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9a3/c32/d3a/9a3c32d3a01dd202e192648f5ef6609c.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/593/bc4/34d/593bc434d505cb29799846d61cb177bb.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Left: set a breakpoint on the CMP and continue execution. On the right, we monitor the registers and memory.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We look at registers with </font></font><code>reg r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the value of memory with </font></font><code>mem read $ebp-0x28</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and actually contains 0x2773, and the value in memory is now 0x00A0. If you execute </font></font><code>thread c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it </font><font style="vertical-align: inherit;">several times </font><font style="vertical-align: inherit;">, then we will see that iteration occurs over different IDs in search of matches. At some stage, the values ​​will coincide, the loop will exit, and the game will begin. Now we know how to manage it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recall the log file: it identified both the device and the manufacturer. Probably somewhere there is a similar cycle for the names of manufacturers. And in fact, it is very similar and located in the CFG directly above our cycle. This loop is a bit simpler, and we look for the string “vendor”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This time the comparison is done with</font></font><code>var_D0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This variable is actually used as the manufacturer ID. </font><font style="vertical-align: inherit;">If we put a breakpoint here and check everything, we will see the familiar 0x8086 at </font></font><code>eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and at the same time, a comparison with 0x10DE is happening. </font><font style="vertical-align: inherit;">Let's write it in </font></font><code>eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and see what happens.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/014/fd5/e4a014fd58bcc6408f48de1411db83b8.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/03b/9ce/7d0/03b9ce7d056048ecdf69987c3e8d774a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wow. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, 0x10DE is NVIDIA. </font><font style="vertical-align: inherit;">In fact, one could understand this when studying a data file, but it’s not very interesting. </font><font style="vertical-align: inherit;">Now the question is: what is the identifier of the GeforceFX 6800? </font><font style="vertical-align: inherit;">We can use LLDB and just check each identifier, but it will take time (there are a lot of them, I tried to find the right one). </font><font style="vertical-align: inherit;">So let's take a look at render.bar this time.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cbc/605/7f4/cbc6057f454e5ee95865324fea40e271.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose this is “XMB”, the binary representation of XML used in Age 3.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This file is pretty chaotic. But after the Geforce FX 6800 tags, we see several identifiers. Most likely, we need one of them. Let's try 00F1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way to test this is to use LLDB and set the desired breakpoints. I will skip this step, but I will say that 00F1 came up (fortunately). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, we need to answer the question: “How to make this change permanent?” It seems that it will be easier to change the values </font></font><code>var_CC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>var_D0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on 0X00F1 and 0X10DE. To do this, we just need to get space for the code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A simple solution would be to replace one of the log record calls with a NOP, for example, a subsystem call. </font><font style="vertical-align: inherit;">This will free us several tens of bytes, and this is even more than necessary. </font><font style="vertical-align: inherit;">Let's select all of this and replace it with NOP. </font><font style="vertical-align: inherit;">Then we just need to write information using the MOV variables: assembler </font></font><code>mov dword [ebp+var_CC], 0xF1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>mov dword [ebp+var_D0], 0x10DE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e6f/eb6/d19/e6feb6d1903ca8305714594fe1911413.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/79c/096/783/79c096783f59920be40a85fdac85f44f.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before and after</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let's run the game. </font><font style="vertical-align: inherit;">Finally, we have achieved something: you can choose from Low, Medium or High, as well as enable High parameters for shadows.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/370/8b5/7cb/3708b57cb8d0d5e405e54e4c5ee99eb8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we still can’t enable Very High, and this is sad. </font><font style="vertical-align: inherit;">What's happening?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e16/2e6/732/e162e673279757ba3cac035fa5f9b0f6.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ah, got it.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As it turned out, the Geforce FX 6800 should support version 3.0 pixel shaders, and we only set version 2.0. Now it’s easy for us to fix it: just write 3.0 floating point in </font></font><code>ebp+0xA2A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This value is 0x40400000. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the game is no longer capricious, and we can enjoy Very High settings.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f3c/24e/2c1/f3c24e2c156feb16f1d34bf67aa33d5a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strange, but it looks completely different. The colors are much less vibrant, and range-dependent fog has appeared. There is also a small problem of shadow conflict (it is also in the screenshots above, this is due to the High shadow parameters, not the quality of the shaders), which I have not been able to solve yet.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And this is the end of our journey, thanks for reading. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, I will give examples of how each of the parameters in the game looks like, because all the screenshots found online are terrible or incomplete. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The graphics on Medium are quite acceptable, but suffer from a lack of shadows. As far as I can tell, Very High for the most part adds a completely different LUT (a good explanation of this term can be found in the Color Grading section of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), fog in the distance, and perhaps even a completely different lighting model? </font><font style="vertical-align: inherit;">The picture is very different, and it is rather strange.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5a/ed3/00d/b5aed300d967d53f67bf3e8798615525.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c8/0b8/bd7/1c80b8bd77a9cdfb4fdbd1da13146035.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45a/73b/776/45a73b7760497a9424b4e92984071e2c.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/817/12a/54c/81712a54ca17e71925eea886f628db3f.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From top to bottom: Very-High, High (with High shadow options), Medium (just with shadow enabled), Low (with shadow disabled).</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other useful links</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The blog I linked to above contains a wonderful analysis of modern rendering pipelines: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.adriancourreges.com/blog/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Rate 0 AD is an open-source RTS game of the same genre: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://play0ad.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . She needs developers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to know more about the XMB format, you can read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">its code in 0 AD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I didn’t check, but I’m almost sure that this is the same format, because the person who wrote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the XMB decoder for Age 3 on Age of Empires heaven</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also implemented these files in the 0 AD source code in 2004. So this will be a fun lesson in code paleontology. Thank you for all the work, Ykkrosh.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I remember exactly that I read an excellent tutorial on using Hopper, but now I can not find the link. </font><font style="vertical-align: inherit;">If anyone knows what I'm talking about, then drop the link. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the end, I would like to mention the Cosmic Frontier project: a remake of the classic Escape Velocity series (more of Override, but it is also compatible with Nova). </font><font style="vertical-align: inherit;">This is an amazing game, and it is very sad that few people know it. </font><font style="vertical-align: inherit;">Now the creators have launched a campaign on Kickstarter, and the lead developer has a very interesting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which talks about using Hex Fiend to reverse engineer data formats of the original game. </font><font style="vertical-align: inherit;">This is a great read. </font><font style="vertical-align: inherit;">If you think </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my article</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was insane. </font><font style="vertical-align: inherit;">then in one of the posts they:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We launched the classic Mac emulator to use the long-obsolete APIs to read an encrypted data file.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reverse engineering encryption from the game code</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They used a file system hack to access the same data on a modern Mac.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, these are truly passionate people, and I hope that their project will be successfully completed, because EV Nova is my favorite game.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500518/index.html">Iterations of introducing scrum in a company</a></li>
<li><a href="../en500520/index.html">How to make your applications use around the world: 10 tips from CEO Wachanga</a></li>
<li><a href="../en500528/index.html">About the translation of "practice" / "practicality" without practice / practical</a></li>
<li><a href="../en500530/index.html">Canvas API Memo</a></li>
<li><a href="../en500538/index.html">Podcasts Rusbase, Medusa and KinoPoisk</a></li>
<li><a href="../en500546/index.html">Create a simple table document using the ODF Toolkit</a></li>
<li><a href="../en500552/index.html">How to speed up code review</a></li>
<li><a href="../en500554/index.html">Golang backend server template - part 2 (REST API)</a></li>
<li><a href="../en500556/index.html">Two years of digital transformation in two months</a></li>
<li><a href="../en500558/index.html">A selection of articles on machine learning: case studies, guides and research for April 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>