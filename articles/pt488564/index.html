<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚ù§Ô∏è‚Äçüë® ü§πüèæ ‚è© Sua primeira rede neural em uma unidade de processamento gr√°fico (GPU). Guia do iniciante üìÆ üëá üõåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, mostrarei como configurar um ambiente de aprendizado de m√°quina em 30 minutos, criar uma rede neural para reconhecimento de imagens e ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sua primeira rede neural em uma unidade de processamento gr√°fico (GPU). Guia do iniciante</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488564/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, mostrarei como configurar um ambiente de aprendizado de m√°quina em 30 minutos, criar uma rede neural para reconhecimento de imagens e executar a mesma rede em uma unidade de processamento gr√°fico (GPU). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, vamos definir o que √© uma rede neural. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, esse √© um modelo matem√°tico, bem como sua implementa√ß√£o de software ou hardware, constru√≠da com base no princ√≠pio de organiza√ß√£o e funcionamento de redes neurais biol√≥gicas - redes de c√©lulas nervosas de um organismo vivo. Esse conceito surgiu no estudo de processos que ocorrem no c√©rebro e na tentativa de simular esses processos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As redes neurais n√£o s√£o programadas no sentido usual da palavra, elas s√£o treinadas. </font><font style="vertical-align: inherit;">A capacidade de aprendizado √© uma das principais vantagens das redes neurais em rela√ß√£o aos algoritmos tradicionais. </font><font style="vertical-align: inherit;">Tecnicamente, o treinamento consiste em encontrar os coeficientes de conex√µes entre os neur√¥nios. </font><font style="vertical-align: inherit;">No processo de aprendizagem, a rede neural √© capaz de identificar rela√ß√µes complexas entre entrada e sa√≠da, al√©m de realizar generaliza√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do ponto de vista do aprendizado de m√°quina, uma rede neural √© um caso especial de m√©todos de reconhecimento de padr√µes, an√°lise discriminante, m√©todos de agrupamento e outros m√©todos.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, vamos lidar com o equipamento. Precisamos de um servidor com o sistema operacional Linux instalado. O equipamento para a opera√ß√£o de sistemas de aprendizado de m√°quina requer uma capacidade suficientemente poderosa e, como conseq√º√™ncia, dispendiosa. Para aqueles que n√£o t√™m um bom carro em m√£os, recomendo prestar aten√ß√£o √† oferta dos provedores de nuvem. O servidor necess√°rio pode ser alugado rapidamente e pagado apenas pelo tempo de uso.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos projetos em que √© necess√°rio criar redes neurais, eu uso os servidores de um dos provedores de nuvem russos. </font><font style="vertical-align: inherit;">A empresa oferece servidores de aluguel de nuvem especificamente para aprendizado de m√°quina com as poderosas unidades de processamento gr√°fico (GPUs) Tesla V100 da NVIDIA. </font><font style="vertical-align: inherit;">Em resumo: o uso de um servidor com uma GPU pode ser dezenas de vezes mais eficiente (r√°pido) em compara√ß√£o com um servidor com custo semelhante e que usa uma CPU (um processador central conhecido) para c√°lculos. </font><font style="vertical-align: inherit;">Isso √© alcan√ßado devido √†s especificidades da arquitetura da GPU, que lida com os c√°lculos mais rapidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para executar os exemplos descritos abaixo, adquirimos o seguinte servidor por v√°rios dias:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD de 150 GB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 32 GB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processador Tesla V100 de 16 Gb com 4 n√∫cleos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Ubuntu 18.04 foi instalado na m√°quina.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina o ambiente</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora instale no servidor tudo o que voc√™ precisa para funcionar. </font><font style="vertical-align: inherit;">Como nosso artigo √© principalmente para iniciantes, falarei sobre alguns pontos que ser√£o √∫teis para eles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muito trabalho ao configurar o ambiente √© feito atrav√©s da linha de comando. </font><font style="vertical-align: inherit;">A maioria dos usu√°rios usa o Windows como um sistema operacional ativo. </font><font style="vertical-align: inherit;">O console padr√£o neste sistema operacional deixa muito a desejar. </font><font style="vertical-align: inherit;">Portanto, usaremos a conveniente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmder /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ferramenta </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Baixe a vers√£o mini e execute o Cmder.exe. </font><font style="vertical-align: inherit;">Em seguida, voc√™ precisa se conectar ao servidor via SSH:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de server-ip-or-hostname, especifique o endere√ßo IP ou o nome DNS do seu servidor. </font><font style="vertical-align: inherit;">Em seguida, digite a senha e, ap√≥s uma conex√£o bem-sucedida, devemos obter algo parecido com isto.</font></font><br>
<br>
<pre><code class="bash hljs">Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principal linguagem para o desenvolvimento de modelos de ML √© o Python. </font><font style="vertical-align: inherit;">E a plataforma mais popular para us√°-lo no Linux √© o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anaconda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale-o em nosso servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos atualizando o gerenciador de pacotes local:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale o curl (utilit√°rio de linha de comando):</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install curl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fa√ßa o download da vers√£o mais recente do Anaconda Distribution:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /tmp<font></font>
curl ‚ÄìO https://repo.anaconda.com/archive/Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciamos a instala√ß√£o:</font></font><br>
<br>
<pre><code class="bash hljs">bash Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante o processo de instala√ß√£o, voc√™ precisar√° confirmar o contrato de licen√ßa. </font><font style="vertical-align: inherit;">Na instala√ß√£o bem-sucedida, voc√™ deve ver o seguinte:</font></font><br>
<br>
<pre><code class="bash hljs">Thank you <span class="hljs-keyword">for</span> installing Anaconda3!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desenvolver modelos de ML, muitas estruturas foram criadas, trabalhamos com as mais populares: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyTorch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensorflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O uso da estrutura permite aumentar a velocidade do desenvolvimento e usar ferramentas prontas para tarefas padr√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste exemplo, trabalharemos com o PyTorch. </font><font style="vertical-align: inherit;">Instale-o:</font></font><br>
<br>
<pre><code class="bash hljs">conda install pytorch torchvision cudatoolkit=10.1 -c pytorch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora precisamos lan√ßar o Jupyter Notebook - uma ferramenta de desenvolvimento popular entre os especialistas em ML. </font><font style="vertical-align: inherit;">Permite escrever c√≥digo e ver imediatamente os resultados de sua execu√ß√£o. </font><font style="vertical-align: inherit;">O Jupyter Notebook faz parte do Anaconda e j√° est√° instalado em nosso servidor. </font><font style="vertical-align: inherit;">Voc√™ precisa se conectar a ele no nosso sistema de desktop. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, primeiro executamos o Jupyter no servidor especificando a porta 8080:</font></font><br>
<br>
<pre><code class="bash hljs">jupyter notebook --no-browser --port=8080 --allow-root</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, abrindo outra guia no console do Cmder (o menu superior √© a caixa de di√°logo Novo console), conecte na porta 8080 ao servidor via SSH:</font></font><br>
<br>
<pre><code class="plaintext hljs">ssh -L 8080:localhost:8080 root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando voc√™ digita o primeiro comando, ser√£o oferecidos links para abrir o Jupyter em nosso navegador:</font></font><br>
<br>
<pre><code class="bash hljs">To access the notebook, open this file <span class="hljs-keyword">in</span> a browser:<font></font>
        file:///root/.<span class="hljs-built_in">local</span>/share/jupyter/runtime/nbserver-18788-open.html<font></font>
    Or copy and paste one of these URLs:<font></font>
        http://localhost:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
     or http://127.0.0.1:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use o link para localhost: 8080. </font><font style="vertical-align: inherit;">Copie o caminho completo e cole na barra de endere√ßos do navegador local do seu PC. </font><font style="vertical-align: inherit;">O Caderno Jupyter √© aberto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos criar um novo laptop: Novo - Notebook - Python 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verifique a opera√ß√£o correta de todos os componentes que instalamos. </font><font style="vertical-align: inherit;">Introduzimos um exemplo de c√≥digo PyTorch no Jupyter e iniciamos a execu√ß√£o (bot√£o Executar):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> torch<font></font>
x = torch.rand(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)<font></font>
print(x)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado deve ser algo assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ps/o8/su/pso8sugii4txi_beqrbx13nsry8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ tiver um resultado semelhante, todos n√≥s configuramos corretamente e podemos come√ßar a desenvolver uma rede neural!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie uma rede neural</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criaremos uma rede neural para reconhecimento de imagem. </font><font style="vertical-align: inherit;">Tomamos este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guia como</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> base </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para treinar a rede, usaremos o conjunto de dados CIFAR10 dispon√≠vel ao p√∫blico. </font><font style="vertical-align: inherit;">Ele tem aulas: ‚Äúavi√£o‚Äù, ‚Äúcarro‚Äù, ‚Äúp√°ssaro‚Äù, ‚Äúgato‚Äù, ‚Äúcervo‚Äù, ‚Äúcachorro‚Äù, ‚Äúsapo‚Äù, ‚Äúcavalo‚Äù, ‚Äúnavio‚Äù, ‚Äúcaminh√£o‚Äù. </font><font style="vertical-align: inherit;">As imagens no CIFAR10 t√™m um tamanho de 3x32x32, ou seja, imagens coloridas de 3 canais de 32x32 pixels.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o trabalho, usaremos o pacote PyTorch criado para trabalhar com imagens - torchvision. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seguiremos as seguintes etapas em ordem:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixe e normalize conjuntos de dados de treinamento e teste</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defini√ß√£o de rede neural</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treinamento em rede sobre dados de treinamento</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testando a rede com dados de teste</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repita o treinamento e teste da GPU</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo o c√≥digo abaixo iremos executar no Jupyter Notebook.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixe e normalize o CIFAR10</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copie e execute o seguinte c√≥digo no Jupyter:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torchvision
<span class="hljs-keyword">import</span> torchvision.transforms <span class="hljs-keyword">as</span> transforms<font></font>
<font></font>
transform = transforms.Compose(<font></font>
    [transforms.ToTensor(),<font></font>
     transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<font></font>
<font></font>
trainset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>,<font></font>
                                        download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
trainloader = torch.utils.data.DataLoader(trainset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                          shuffle=<span class="hljs-literal">True</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
testset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">False</span>,<font></font>
                                       download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
testloader = torch.utils.data.DataLoader(testset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                         shuffle=<span class="hljs-literal">False</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
classes = (<span class="hljs-string">'plane'</span>, <span class="hljs-string">'car'</span>, <span class="hljs-string">'bird'</span>, <span class="hljs-string">'cat'</span>,
           <span class="hljs-string">'deer'</span>, <span class="hljs-string">'dog'</span>, <span class="hljs-string">'frog'</span>, <span class="hljs-string">'horse'</span>, <span class="hljs-string">'ship'</span>, <span class="hljs-string">'truck'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta deve ser assim:</font></font><br>
<br>
<pre><code class="python hljs">Downloading https://www.cs.toronto.edu/~kriz/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz<font></font>
Extracting ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data<font></font>
Files already downloaded <span class="hljs-keyword">and</span> verified</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obteremos v√°rias imagens de treinamento para verifica√ß√£o:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<font></font>
<font></font>
<span class="hljs-comment"># functions to show an image</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">imshow</span>(<span class="hljs-params">img</span>):</span>
    img = img / <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>     <span class="hljs-comment"># unnormalize</span><font></font>
    npimg = img.numpy()<font></font>
    plt.imshow(np.transpose(npimg, (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)))<font></font>
    plt.show()<font></font>
<font></font>
<span class="hljs-comment"># get some random training images</span><font></font>
dataiter = iter(trainloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># show images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
<span class="hljs-comment"># print labels</span>
print(<span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/yy/w4/xw/yyw4xwjhaa6kfy41fvnylvz6qdy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defini√ß√£o de rede neural</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos primeiro examinar como funciona uma rede neural para reconhecimento de imagens. </font><font style="vertical-align: inherit;">Esta √© uma rede de conex√£o direta simples. </font><font style="vertical-align: inherit;">Ele recebe entrada, passa por v√°rias camadas, uma a uma e, finalmente, fornece a sa√≠da. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/4m/yg/t84mygi1sjuzssoezguistupmeo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos criar uma rede semelhante em nosso ambiente:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Net</span>(<span class="hljs-params">nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
        super(Net, self).__init__()<font></font>
        self.conv1 = nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>)<font></font>
        self.pool = nn.MaxPool2d(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<font></font>
        self.conv2 = nn.Conv2d(<span class="hljs-number">6</span>, <span class="hljs-number">16</span>, <span class="hljs-number">5</span>)<font></font>
        self.fc1 = nn.Linear(<span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>, <span class="hljs-number">120</span>)<font></font>
        self.fc2 = nn.Linear(<span class="hljs-number">120</span>, <span class="hljs-number">84</span>)<font></font>
        self.fc3 = nn.Linear(<span class="hljs-number">84</span>, <span class="hljs-number">10</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span><font></font>
        x = self.pool(F.relu(self.conv1(x)))<font></font>
        x = self.pool(F.relu(self.conv2(x)))<font></font>
        x = x.view(<span class="hljs-number">-1</span>, <span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>)<font></font>
        x = F.relu(self.fc1(x))<font></font>
        x = F.relu(self.fc2(x))<font></font>
        x = self.fc3(x)<font></font>
        <span class="hljs-keyword">return</span> x<font></font>
<font></font>
net = Net()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m definimos a fun√ß√£o de perda e o otimizador </font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treinamento em rede sobre dados de treinamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a treinar nossa rede neural. </font><font style="vertical-align: inherit;">Chamo a aten√ß√£o para o fato de que, depois disso, ao executar esse c√≥digo, voc√™ precisar√° esperar um pouco at√© que o trabalho seja conclu√≠do. </font><font style="vertical-align: inherit;">Levei 5 minutos. </font><font style="vertical-align: inherit;">Rede leva tempo.</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span><font></font>
        inputs, labels = data<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtemos o seguinte resultado: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sw/05/k2/sw05k2ewk-gu9fiyrv3xncxjaki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salvamos nosso modelo treinado:</font></font><br>
<br>
<pre><code class="python hljs">PATH = <span class="hljs-string">'./cifar_net.pth'</span>
torch.save(net.state_dict(), PATH)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testando a rede com dados de teste</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s treinamos a rede usando um conjunto de dados de treinamento. </font><font style="vertical-align: inherit;">Mas precisamos verificar se a rede aprendeu alguma coisa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificaremos isso prevendo o r√≥tulo da classe que a rede neural gera e verificando a verdade. </font><font style="vertical-align: inherit;">Se a previs√£o estiver correta, adicionamos a amostra √† lista de previs√µes corretas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos mostrar a imagem da su√≠te de testes:</font></font><br>
<br>
<pre><code class="python hljs">dataiter = iter(testloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># print images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
print(<span class="hljs-string">'GroundTruth: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))</code></pre><br>
<img src="https://habrastorage.org/webt/hp/ph/zm/hpphzma6rus04gw-edxsowf1ifu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora pe√ßa √† rede neural para nos dizer o que h√° nessas figuras:</font></font><br>
<br>
<pre><code class="python hljs"><font></font>
net = Net()<font></font>
net.load_state_dict(torch.load(PATH))<font></font>
<font></font>
outputs = net(images)<font></font>
<font></font>
_, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
<font></font>
print(<span class="hljs-string">'Predicted: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[predicted[j]]
                              <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/j2/vp/uc/j2vpucdaps0fuci2yg38ip2fbdo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resultados parecem muito bons: a rede identificou corretamente tr√™s das quatro fotos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como a rede funciona em todo o conjunto de dados.</font></font><br>
<br>
<pre><code class="python hljs">
correct = <span class="hljs-number">0</span>
total = <span class="hljs-number">0</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs.data, <span class="hljs-number">1</span>)<font></font>
        total += labels.size(<span class="hljs-number">0</span>)<font></font>
        correct += (predicted == labels).sum().item()<font></font>
<font></font>
print(<span class="hljs-string">'Accuracy of the network on the 10000 test images: %d %%'</span> % (
    <span class="hljs-number">100</span> * correct / total))</code></pre><br>
<img src="https://habrastorage.org/webt/fy/i4/cn/fyi4cnkjgimshkhhbsva4udixhw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que a rede conhece e funciona. </font><font style="vertical-align: inherit;">Se ele definisse as aulas aleatoriamente, a precis√£o seria de 10%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos ver quais classes a rede define melhor:</font></font><br>
<br>
<pre><code class="python hljs">class_correct = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))<font></font>
class_total = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
        c = (predicted == labels).squeeze()<font></font>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>):<font></font>
            label = labels[i]<font></font>
            class_correct[label] += c[i].item()<font></font>
            class_total[label] += <span class="hljs-number">1</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<font></font>
    print(<span class="hljs-string">'Accuracy of %5s : %2d %%'</span> % (<font></font>
        classes[i], <span class="hljs-number">100</span> * class_correct[i] / class_total[i]))</code></pre><br>
<img src="https://habrastorage.org/webt/l9/s9/qu/l9s9quxd-lzx2kh7wphxe9-2qzs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que a rede determina melhor os carros e os navios: 71% de precis√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o a rede est√° funcionando. </font><font style="vertical-align: inherit;">Agora vamos tentar transferir seu trabalho para o processador gr√°fico (GPU) e ver o que muda.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treinamento em rede neural da GPU</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, explicarei brevemente o que √© CUDA. </font><font style="vertical-align: inherit;">CUDA (Compute Unified Device Architecture) √© uma plataforma de computa√ß√£o paralela desenvolvida pela NVIDIA para computa√ß√£o geral em GPUs. </font><font style="vertical-align: inherit;">Com o CUDA, os desenvolvedores podem acelerar significativamente os aplicativos de computa√ß√£o usando os recursos das GPUs. </font><font style="vertical-align: inherit;">No servidor que compramos, essa plataforma j√° est√° instalada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos primeiro definir nossa GPU como o primeiro dispositivo cuda vis√≠vel.</font></font><br>
<br>
<pre><code class="python hljs">device = torch . device ( <span class="hljs-string">"cuda:0"</span> <span class="hljs-keyword">if</span> torch . cuda . is_available () <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span> )
<span class="hljs-comment"># Assuming that we are on a CUDA machine, this should print a CUDA device:</span>
<span class="hljs-keyword">print</span> ( device )</code></pre><br>
<img src="https://habrastorage.org/webt/n2/2k/bf/n22kbfvilr6kn30eel6dfhaose4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Envie a rede para a GPU:</font></font><br>
 <br>
<pre><code class="python hljs">net.to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m teremos que enviar insumos e metas a cada passo e para a GPU:</font></font><br>
<br>
<pre><code class="python hljs">inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a reciclagem da rede j√° na GPU: </font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span>
    inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desta vez, o treinamento em rede durou cerca de 3 minutos. </font><font style="vertical-align: inherit;">Lembre-se de que o mesmo est√°gio em um processador regular durou 5 minutos. </font><font style="vertical-align: inherit;">A diferen√ßa n√£o √© significativa, isso ocorre porque nossa rede n√£o √© t√£o grande. </font><font style="vertical-align: inherit;">Ao usar matrizes grandes para treinamento, a diferen√ßa entre a velocidade da GPU e o processador tradicional aumentar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso parece ser tudo. </font><font style="vertical-align: inherit;">O que conseguimos fazer:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinamos o que √© a GPU e escolhemos o servidor em que est√° instalada;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criamos um ambiente de software para criar uma rede neural;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criamos uma rede neural para reconhecimento de imagens e a treinamos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repetimos o treinamento da rede usando a GPU e recebemos um aumento na velocidade.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ficarei feliz em responder √†s perguntas nos coment√°rios.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt488548/index.html">Experi√™ncia: como aprender a criar textos populares em ingl√™s (e por que os habristas de l√≠ngua inglesa l√™em t√£o pouco)</a></li>
<li><a href="../pt488550/index.html">Quem quer transformar as cooperativas em gigantes de TI</a></li>
<li><a href="../pt488552/index.html">Desenvolvedores Apple FAS e Controle dos Pais</a></li>
<li><a href="../pt488558/index.html">Garantindo a alta disponibilidade de aplicativos com o Kafka Streams</a></li>
<li><a href="../pt488560/index.html">Hospedagem gratuita de bot de Telegram no Google Cloud Platform</a></li>
<li><a href="../pt488566/index.html">Como um engenheiro de controle de qualidade salvou um dia inteiro vinculando Testes autom√°ticos no Visual Studio e Test IT</a></li>
<li><a href="../pt488568/index.html">As redes neurais sonham com dinheiro el√©trico?</a></li>
<li><a href="../pt488570/index.html">Como o Servi√ßo Secreto dos EUA confundiu o RPG cyberpunk com um livro did√°tico para hackers</a></li>
<li><a href="../pt488572/index.html">Analisadores Unity agora de c√≥digo aberto</a></li>
<li><a href="../pt488574/index.html">Alunos escrevem driver Uart para STM32F411</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>