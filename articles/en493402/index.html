<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅🏽 👟 🌷 Rostelecom advertising banners and how to deal with them 👨🏿‍⚕️ 👨🏻‍⚖️ 🍺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many already know that Rostelecom, with the support of Mail.ru, has begun the implementation of its advertising banners on sites that are not protecte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rostelecom advertising banners and how to deal with them</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493402/"><img src="https://habrastorage.org/webt/tf/gs/ve/tfgsvevdniakse3ighqxm8mfdt4.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many already know that </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rostelecom, with the support of Mail.ru, has begun the implementation of its advertising banners on sites that are not protected by the HTTPS protocol</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can protect yourself from their appearance on your site by transferring it to HTTPS. </font><font style="vertical-align: inherit;">But what if you do not have such an opportunity or it is too time-consuming for you? </font><font style="vertical-align: inherit;">I have done my little research and want to share a simple and yet effective way against this infection.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were already investigations on this subject on Habré and I relied on them:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You do not watch ads during development? </font><font style="vertical-align: inherit;">Disorder</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPI: Deep Packet INJECTION, or conspiracy theory of conspiracy between RTK and MRG</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is known that banners are implemented by replacing the original JavaScript file with malicious one through a redirect. And already he inserts a banner on the website page and uploads the original file. Thus, when checking for viruses, it is impossible to immediately detect how advertising appeared on the site, because the original files are not changed, and the redirect is performed at a certain interval and it is quite difficult to detect it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For research, you need a site that uses the HTTP protocol and contains JS files. As an example, I took the site of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Museum of Kirov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With some periodicity, banners can be observed on it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lh/fk/2f/lhfk2fknn2m77txskd39umbmoea.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wrote a special </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utility</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. She makes a request at a specific URL at regular intervals and compares the received content with the previous one. If the content of the answer is different, it is saved for study. When analyzing requests for a small script </font></font><code>http://muzey43.ru/js/script-eye.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it was found that the same content is always returned - there is no redirect. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jn/lg/1d/jnlg1dha5akq_goqg_b8m1udp5a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then how does the banner appear? In the study of the source code of a site was discovered another JS file that is downloaded by HTTP, but with a different host: </font></font><code>http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. When analyzing this request, we periodically observe the receipt of the contents of a malicious file.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dv/ud/zn/dvudznxszrrg9y1m_snwkvbomna.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The screenshot shows that malicious content is downloaded approximately twice a minute, but there may be short breaks in the redirect. The contents of the malware each time changes by obfuscating the code and contains a link to the original script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most likely, there is a certain “white list” of hosts for which the JS redirect is prohibited. For example, the site of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ministry of Culture of the Kirov region</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Despite the fact that it works through the HTTP protocol, banners do not appear on it. But on the Kirov Museums website there is a banner, although there is no redirect for its scripts, but through a redirect of a script from another host a banner is embedded in it. In order to eliminate the vulnerability in this case, most likely, it is enough to request the file using the HTTPS protocol, i.e. just replace the script URL with</font></font><br>
<br>
<pre><code class="plaintext hljs">https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what if your site is not in the “white list” and you need to use your own scripts? I found an easy way to avoid JS redirect. It is enough to add an arbitrary parameter to the script URL: </font></font><code>https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js?banner=off</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the redirect will not be performed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tt/zu/va/ttzuvamwqxv6uagryx6rljnm6k0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is probably done so that the redirect does not interfere with the operation of complex dynamic JS sites, or the necessary files are simply identified by the extension </font></font><code>.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But in any case, it’s enough to add random parameters and Rostelecom advertising banners to the URLs of scripts on the pages of your site on it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As the comments correctly indicate, the most appropriate solution for website owners will be switching to HTTPS, especially since now some hosting companies offer installing a free certificate directly from the panel with one button. </font><font style="vertical-align: inherit;">After all, tomorrow Rostelecom can easily tighten the redirect algorithm and the solution given above will stop working. </font><font style="vertical-align: inherit;">And just blocking a redirect by a filter on the client, as some suggest, can only solve the client’s problem - there will be no banner, but there will be no substitution of the script that it replaced and the site’s functionality may suffer.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493392/index.html">Machine Learning in Kazan, or how machine learning specialists are trained in Tatarstan</a></li>
<li><a href="../en493394/index.html">God’s syndrome: the story of how the main infectious disease specialist of the Stavropol Territory coronavirus spread (a) *</a></li>
<li><a href="../en493396/index.html">Abstract on forecasting methods</a></li>
<li><a href="../en493398/index.html">Costume</a></li>
<li><a href="../en493400/index.html">The Japanese have found a way to mark the nematode neurons</a></li>
<li><a href="../en493404/index.html">How to find an artist to develop a site</a></li>
<li><a href="../en493406/index.html">How the disk subsystem works in OpenNebula</a></li>
<li><a href="../en493408/index.html">DJI Mavic mini copter fell like a crowbar</a></li>
<li><a href="../en493412/index.html">Games with Wifi on ESP32</a></li>
<li><a href="../en493416/index.html">IDA Pro and reverse engineering techniques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>