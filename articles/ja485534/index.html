<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🔬 🤸🏻 ⚱️ HighLoad ++、Mikhail Makurov（Intersvyaz）：バックアップおよびクラスター化されたZabbixサービスの作成経験 🐅 ✌🏽 👭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbixは、多くの企業で使用されている人気のあるオープンモニタリングシステムです。監視クラスターを作成した経験についてお話します。
 
 レポートでは、以前に行った変更（パッチ）について簡単に触れています。これにより、システムの機能が大幅に拡張され、クラスターの基礎が準備されます（「Clickh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++、Mikhail Makurov（Intersvyaz）：バックアップおよびクラスター化されたZabbixサービスの作成経験</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbixは、多くの企業で使用されている人気のあるオープンモニタリングシステムです。監視クラスターを作成した経験についてお話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レポートでは、以前に行った変更（パッチ）について簡単に触れています。これにより、システムの機能が大幅に拡張され、クラスターの基礎が準備されます（「Clickhouse」への履歴のアップロード、非同期ポーリング）。システムのクラスタリング中に発生した問題を詳細に検討します-データベースのIDの競合の解決、CAPの定理と分散データベースでの監視について、クラスタモードで動作するZabbixのニュアンスについて：「ドメインの監視」と新しい外観に関するバックアップとサーバーとプロキシの調整についてシステムアーキテクチャ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自宅でクラスターを起動する方法、ソースを取得する場所、その他のことについて簡単に説明します。クラスターの設定が必要になります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uv/cy/1r/uvcy1rw-6ttiumnzmjuizgl4ml4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HighLoad ++シベリア2019。トムスクホール。 6月24日午後5時アブストラクトと</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンテーション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次回のHighLoad ++カンファレンスは、2020年4月6日と7日にサンクトペテルブルクで開催されます。詳細とチケットは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhaili Makurov（以下-MM）：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -私はプロバイダー会社で働いています。</font><font style="vertical-align: inherit;">プロバイダーはIntersvyazと呼ばれ、チェリャビンスク市で動作します。</font><font style="vertical-align: inherit;">約150万人がいます。</font><font style="vertical-align: inherit;">そして、プロバイダーが機能するためには、巨大なインフラストラクチャがあります。</font><font style="vertical-align: inherit;">当社には約7万個の機器があります。スイッチ、IoTデバイス...-監視する必要のあるすべてのもの。</font><font style="vertical-align: inherit;">具体的には、このレポートはZabbixの使用に関するものであり、インフラストラクチャの監視のためにZabbixに基づくクラスターを構築することに関するものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はプロバイダーで12歳です。</font><font style="vertical-align: inherit;">今、私は技術的なことをまったくしていません。それは人を管理することです。</font><font style="vertical-align: inherit;">そして、これ（技術的なこと）は私の趣味です。</font><font style="vertical-align: inherit;">このトピックを少し発展させます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラッキーだと思います。約1年半前、私は次のようなプロジェクトに行きました。「監視に関するいくつかの問題を解決する必要があります。」私は一連のサーバー、具体的には21台のサーバーで構成される責任領域（監視）を継承しました</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/om/mx/euommxg6onyd7rdbncwqbnrhvtc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。4台の強力なサーバーと15台のプロキシがあり、すべてハードウェアでした。この監視についていくつかの不満がありました。最初はそれがたくさんあったということです。プロバイダーとのサーバーが1つもないため、それほど多くのスペースを占有しませんでした。これはお金、電気です...実際、これは大きな問題ではありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/jf/u3/uijfu32ebg7upocsepwtvptenk4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大きな問題は、監視が私たちが望んでいた量に追いついていないことでした。 Zabbixを積極的に使用していない人のために、これは小切手の遅れを示すダッシュボードです：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/jd/ti/igjdtilbejkchus711uvbzzeuyo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小切手のほとんどはレッドゾーンにありました。</font><font style="vertical-align: inherit;">彼らは私たちが望むよりも10分以上遅く実行されました、すなわち、彼らは10分遅れました。</font><font style="vertical-align: inherit;">それはあまり楽しいことではありませんでしたが、多かれ少なかれ生きることは可能でした。</font><font style="vertical-align: inherit;">最大の問題はこれ</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vf/ai/nw/vfainwua91q6pgxnj2msbx_tzle.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
でした</font><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">動作しているネットワークの監視システムでした。</font><font style="vertical-align: inherit;">計画された作業が実行されたとき、数千のセグメントが5つのスイッチで落ちました。</font><font style="vertical-align: inherit;">これらのスイッチとともに、スイッチと監視は忘れ去られました。</font><font style="vertical-align: inherit;">すべてが復元されたとき、2時間後に監視が復元されました。</font><font style="vertical-align: inherit;">それは痛々しいほど不快であり、このフレーズはすべてのレポートにあるはずです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/aw/o-/t3/awo-t3j-xbu181dyneis-q4ozjo.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「このプロジェクトで何かしなければなりません！」</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは2つの話をします。</font><font style="vertical-align: inherit;">次に、2つの方法で同時に移動しようとしました。</font><font style="vertical-align: inherit;">私たちは統合グループを持っています-それはモジュラーシステムを構築する方法を選択しました（昨年11月にモスクワでAvitoからHighloadへの非常にクールなレポートがありました-彼らはこれについて話しました）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qg/f5/nv/qgf5nvonycfltfd8vge1tbeloj8.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix =人+ API +効率</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小片の男たちはシステムを構築し始めました。</font><font style="vertical-align: inherit;">そして、何人かの愛好家と一緒に、私はZabbixに取り組み続けました。</font><font style="vertical-align: inherit;">それには理由がありました。</font><font style="vertical-align: inherit;">どんな理由？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、クールなAPIがあります。</font><font style="vertical-align: inherit;">また、6万個から7万個の監視要素がある場合、これはすべて自動的にしか機能しないことは明らかです。多くの手をエラーなしで追加することはできません。</font></font></li>
<li>.    ,   24/7.   ,   .   «», -   –  .  ,    ,     «»: ,  –   !</li>
<li>«»   .</li>
</ul><br>
<h3> SQL ?   – Clickhouse</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の理由は明白でした。その後、MySQLに取り組み、毎秒約6,000〜7,000のメトリックに遭遇し、ディスク上で一定の遅延が見られました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kb/ke/wf/kbkewfpy7l6b2qdexbuljdwr6ia.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日、それはすでに100回鳴り響いています。唯一の答えはClickhouseです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/lm/iw/w-lmiwpxynx-rmj4spjyv_gc1cc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストの構造では、リクエストの大部分（数時間でのプロファイリング）はメトリックレコードです。 SQLデータベースへのメトリックの書き込みは非常にコストがかかります。ここにTimeScaleDBが登場しました...その後、他のタスクのために約1年間「Clickhouse」が稼働していました（ビッグデータを実行し、大きなアプリケーションを持っています-一般に、プロバイダーは現在、ITビジネス全体です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターネットからの美しいグラフ（「Clickhouse」は数百倍高速で、スペースがほとんど必要ない）を見て、現在の経験を積んだ後、「Zabbix」のHistoryStorageモジュールを作成して、「Clickhouse」データを直接保存できるようにしました（つまり、ファイルのエクスポートからではなく、オンザフライで）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tp/f4/p2/tpf4p2z5jftziqwqhtdtxsb99-g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、「フロント」のモジュールを作成しました。</font><font style="vertical-align: inherit;">Zabbix管理パネルのこれらの美しいグラフィックはすべて、Clickhouseから構築できます。</font><font style="vertical-align: inherit;">APIも機能することは明らかです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
効果はほぼ同じです-専用エンティティーとしてのSQLサーバーは完全にはなりませんでした。つまり、負荷はゼロになりました。</font><font style="vertical-align: inherit;">最も注目すべき点は、専用の「Clickhouse」クラスターが既にありました。そこですべての負荷を与えると、メトリックが6から1万に増加しました。</font><font style="vertical-align: inherit;">管理者は言った：「しかし、私たちは何かが来るのを見ません。</font><font style="vertical-align: inherit;">番号！ "</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clickhouseの拡張方法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに言います：テストでは毎秒最大140-150千のメトリックをロードしようとしました（Zabbixからスクイーズできなくなったので、後で理由を述べます）。Clickhouseにもこのロードは表示されません。つまり、とても快適でクールな負荷です。一般的に、そのようなモジュールがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、少し拡張しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/ha/aj/_uhaajlqcp9mcjuh-ih8sc-dn3k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このバージョンでは、ナノ秒をオフにできます。おそらくご存知でしょう：Zabbixは2つのフィールドに秒とナノ秒を書き込みます。クリックハウスでは、変動性が非常に大きいフィールドは、多くのスペースを占めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、場所について。 Clickhouseの1つのメトリック（現在、約7,000億のメトリックが記録されています）は2.9バイトを使用します。 Zabbixのドキュメントによると、SQLデータベースの1つのメトリックは40〜100バイトかかります。ナノ秒をオフにすると、さらに40％、つまりメトリックあたり約1.5バイトを節約できます。つまり、「Clickhouse」は場所の点で非常に効果的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機械学習に携わるスタッフの要請に応じて、ホストとメトリックの名前を書き込むことができるオプションを作成しました。データの変動性が大きいため、テキストデータが重要である可能性があるにもかかわらず、これが追加のスペースを占めることはありません（これは長いテストでまだ検証されていません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、Zabbixを開発し、しばしばそれをプルする必要があったため、2つの追加を行いました。</font><font style="vertical-align: inherit;">非常にクールな追加：最初に、「Clickhouse」では数百万のレコードを読み取ることができるため、履歴キャッシュを埋めることができます。</font><font style="vertical-align: inherit;">最初はさらに30〜40秒遅れますが、キャッシュがウォームされたサービスがすぐに開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャから収集する方が簡単な場合でも、キャッシュからの読み取りをしばらく禁止するなどのオプションがあります。</font><font style="vertical-align: inherit;">トリガーをカウントせずに5分間すばやく作業することをお勧めします。そうすると、キャッシュがいっぱいになります。これを行わないと、ヒストリシンカーの停滞が始まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、「Clickhouse」モジュールがあります。</font><font style="vertical-align: inherit;">使用できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポーリング効率</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、ベースの問題を解決したにもかかわらず、ブレーキと15個のプロキシの問題が残っていました。彼らは</font></font><br>
<br>
<img src="https://habrastorage.org/webt/un/ec/u8/unecu8ujsgk7scstaonbt3dueim.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに</font><font style="vertical-align: inherit;">関係していました：</font><font style="vertical-align: inherit;">これはZabbixでのデータ処理のためのメインパイプラインです。データ収集の段階があり、前処理があり、すべての作業（トリガー、アラート、保存履歴の計算）を行う履歴シンクロナイズがあります。キャッシュのボトルネックが判明：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/jg/ei/erjgein-xwdpitoa8eql3b5dw1g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜポーリングが遅くなるのですか？リクエストを行うスレッドは、ユニットメトリックのキャッシュ構成のキューに移動し、それをブロックするためです。他にも場所はありますが、それほど狭くはありません。たとえば、前処理自体と履歴キャッシュがあります。 SQLでは、次の制限がありました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-w/ys/-b/-wys-btlu1uxulrqcinsvbmac5a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらくこれは、私たちのケースでは、ベースが約500万のメトリックであり、これを削除しているためです。</font><font style="vertical-align: inherit;">行ったすべての最適化により、ボトルネック（構成キャッシュ上）で70千のメトリックを取得できましたが、それらを一括で処理した場合に限られました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一括処理とは何ですか？</font><font style="vertical-align: inherit;">ポーラーは構成キャッシュに移動し、1つのメトリックではなく、4または8000のタスクを実行します。</font><font style="vertical-align: inherit;">同時に、彼は別の大きな機会を得ました。彼は4000のメトリックを得たので、非同期でポーリングを実行できるようになりました...なぜ次々に実行するのですか？</font><font style="vertical-align: inherit;">あなたはすぐにすべてを尋ねることができます！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期ポーリングはプロキシよりも効率的です！</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーが使用する主なタイプ（SNMPおよびAGENT）については、ポーリングを非同期モードに書き直しました。これにより、総計で約100倍から200倍の速度向上が得られました。 15のプロキシがあり、150に分割しました-完全になくなりました。その結果、すべてが2つのバンクになりました。これは、予備にのみ必要です</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ax/7z/lk/ax7zlkk-yg9oafyuruz9blq7l-q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。シングルプロセッサバンク（1つのXeon 1280コスト）。これはアイドル時間です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/qf/nc/zqqfncyu4fxo38fiegvr0kunhhw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
約60％は無料ですが、この60％から40％の呼び出し音は、マシン自体で定期的に実行されるスクリプト（外部スクリプト）です。問題が発生するまで最適化できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スケールは次のようなものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/pa/nj/kmpanjjtpdm3660spp8haz7ypo0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは62,000台のホスト、約500万のメトリックです。現在のニーズは、毎秒約2万メトリックです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、すべてのように？パフォーマンスの問題を解決し、履歴が拡張されました。ポーリングは素晴らしいです。問題は解決しましたか？それほどではない...すべてが単純すぎるでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は前のチャートでトリックをしました（すべてが示されているわけではありません）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ds/ag/k5/dsagk5zrh8bog_ogrq35w1uvawy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの問題があります。私は言いたい：「ばか、道」。人的要因があり、設備があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのサーバーではまだ十分ではありません。約1年間の運用で、ハードウェアに問題がある2つのケースがありました-SSDドライブとその他の問題です。問題のほとんどは、人々がある種のテストを行うときの人的要因です。私たちの会社では、Zabbixはサービスとして使用されています：すべての部門がそこで独自の何かを書くことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡大したいです。</font><font style="vertical-align: inherit;">缶に頼りたくない。</font><font style="vertical-align: inherit;">もっと強く固執できるようになりたかった。</font><font style="vertical-align: inherit;">そして、スケールアウトの原則に従ってスケールアウトしたいと思います。</font><font style="vertical-align: inherit;">ここで議論することすら何もありません。1つの缶の容量を増やすことは、20年前から無関係です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yl/hy/vn/ylhyvn7za42rcr2allqhjzlmw2i.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターは要求しました...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12月のどこかで、最初のバージョンが登場しました。クラスターのアトミック単位は、別のホストで処理されるものです。ホストが選択されました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9j/yo/sy/9jyosycj6yj7ecx7k5mn0esrfnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、Zabbixでは、同じホスト上にある可能性のあるアイテム間にかなり強い接続があります。つまり、トリガーを接続でき、前処理でそれらを一緒に処理できます。ただし、ホスト間の接続性はそれほど高くないため、クラスタのノード間でこのクラスタを使用するのが普通です—大量のトラフィックはそこにありません。クラスタの主なタスクは、どのホストに従事しているかを互いに合意することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
食欲には食事が伴うので、上限の60〜7万メトリックを回避したいと思います。</font><font style="vertical-align: inherit;">QoEに携わっている人たちがいます... Quality of Experience-トランジットメトリックに基づいてインターネットが加入者にどのように機能するかを分析します。つまり、すべてのTCPメトリックを150万人に提供し、モニタリングに注ぎ込みます-多くのデータがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして私は信頼性を求めていました。</font><font style="vertical-align: inherit;">何かが起こったら私はそれを欲しかった...シフト勤務の担当官は、「サーバーに問題がある」と言って、それを止めました、私たちは明日それを理解します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のクラスター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のバージョンはetcdに基づいて実装されました</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oh/kr/qu/ohkrqu9wh-gldd6q6yheyoztro4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。Etcdは、多くのプログレッシブプロジェクト（私が理解している限り、Kubernetes）で使用されている分散キー値ストレージです。すべてが素晴らしかった。 Etcdは非常に興味深いツールを提供します-例えば、それはメインサーバーを選択する問題を解決します。しかし、そのような問題は... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古典的な3つのリンク「Zabbix」がありました。「web」-ベース-サーバー自体。そして、そこに「Clickhouse」を追加し、今度はetcdも追加しました。管理者は頭を悩ませ始めました：ここには多くの依存関係があります-おそらく、それは信頼できません。開発の過程でもう1つ明らかになりました。Zabbix自体には、サーバー間通信の組み込みの方法がすでにあり、サーバーとプロキシの間で使用されます。これは、いわゆるプロキシポーラープロセスです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4x/cf/jh/4xcfjhgqaf-2h33nnzrjduw8rn8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最小限の変更でクロスサーバー通信を行うのに最適です。</font><font style="vertical-align: inherit;">これにより、etcdが（少なくとも一時的に）使用できなくなり、コードが大幅に簡略化され、最も重要なこととして、検証済みのコード（このコードは5年または7年前のようです）で作業できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーはクラスター内でどのように調整されますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IGPプロトコルのように、調整はタイプごとに行われます。</font><font style="vertical-align: inherit;">サーバーに優先順位を付けるため（これが必要な理由を説明します）、ログの書き込み時にSQLデータベースでの競合を回避するために、各サーバーには識別子（これまで手動で）が割り当てられます。これは0〜63の番号です（63-それは単なる定数であり、おそらくそれ以上です）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kb/ei/xf/kbeixf3xjk6fo4oucwf9yk9yi9c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最大の識別子を持つサーバーが「マスター」になります。</font><font style="vertical-align: inherit;">最初のテストクラスタを起動したとき、管理者が最初に言ったのは、</font><font style="vertical-align: inherit;">そして、それらを別のサイトに配置しましょう。</font><font style="vertical-align: inherit;">うーん、すごい！」</font><font style="vertical-align: inherit;">（これに戻ります）。</font><font style="vertical-align: inherit;">そして、誰かがクラスターを分散させた場合、トポロジーがどのように再分散されるかを制御することができます。メインの「Zabbix」サーバーが落ちた場合、「マスター」の役割はどこに行くでしょうか</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/n8/nx/fan8nxkovjbepqscnyljtfbc00o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。この場合、このようになります：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5l/qu/ou/5lquouk5h0tkzky-e6_m8dfdkn4.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステッピング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オリジナルのZabbixでは、これは次のように行われます。サーバー自体が自動インクリメントインデックスの生成を担当します。</font><font style="vertical-align: inherit;">多くのインスタンスが互いのかかとを踏まないようにするため（同じインデックスでログを作成しないようにするため）、ステッピングが使用されます。</font><font style="vertical-align: inherit;">識別子は "7"-7、17、27（ニュアンスあり）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モディファイアを使って運転しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t3/fo/2-/t3fo2-qoqlx0zwmxds7vc_7y2pw.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーはどのように相互に作用しますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、5秒ごとのIGPのHelloパケットのレガシーです。そのため、サーバーは、ネイバーがいることを認識しています。したがって、「マスター」は近隣が近隣にあることを認識しており、これに基づいて、「マスター」はどのホストをどのサーバーに分散できるかを決定します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/vm/pn/umvmpn5x2hljbhbuzfp6b3umqpo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、構成があります。古いメモリによると、私はそれをトポロジーと呼んでいます。トポロジは基本的に、サーバーとそれらに属するホストのリストです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトコルはシンプルです-これはJSONです：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qd/xx/rz/qdxxrzw2rj3akue1h8nwcqum1cc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これもZabbixプロキシとZabbixサーバー通信のレガシーです。一般に、他のものを使用することは意味がありません。唯一のことは、Zabbixの場合、4バイト（ZBXD）があることですが、それは重要ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
helloパケットでは、サーバー識別子が送信されます。サーバーがパケットを送信すると、サーバーの識別子とトポロジのバージョンが示されます。これにより、サーバーはトポロジの新しいバージョンがあることをすばやく確認し、非常にすばやく更新されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、トポロジー自体は単なるツリーであり、サーバーのリストです。</font><font style="vertical-align: inherit;">各サーバーについて-サーバーがサポートするホストのリスト：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/dv/ec/xpdvecth8pp7eaukwxmykgysqiu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして興味深い問題が発生します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのような魔法のフレーズがあります-ドメインの監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポイントは？従来のZabbixでは、すべてがシンプルでした-明確な態度：このホストはこのプロキシによって監視され、このプロキシはサーバーにデータを提供します。プロキシがインストールされていない（または必要ない）場合、このサーバーはすべてのホストを監視します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/ly/fh/x2lyfh4prsystuyggxb0elwclx4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーが多数ある場合、どうすればよいですか？さらに、地理的に分散したサーバーがあり、ケメロヴォの一部の作業が遅いオフィスのサーバーがノボシビルスクのインフラ全体を監視しようとするという事実に問題がある可能性があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ep/06/cy/ep06cyiqx3dx4kkyfer1wcgn8um.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは必要ありません。すべてのサーバーではなく、（おそらく地理に基づいて）選択したサーバーが特定のホストを監視できるように、何らかのメカニズムが必要です。同時に、それを管理したいと考えています。また、シンプルであることも求めています。このため、ドメインを監視するというアイデアが考案されました。実際、これらは単純なグループです-単にレコードにすでにグループがあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私がこれを行ったとき、作戦の部下は私と話しました-彼らは言った：「グループは私たちを非常に混乱させます。私たちは常に通常のグループについて考え始めます。したがって、この名前は監視ドメインです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストは明確に関連しています：1つのホスト-1つのドメイン：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/hi/z5/6xhiz5ocnajnjzoxin17log0liq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストドメインには、任意の数のサーバーを含めることができます。</font><font style="vertical-align: inherit;">サーバーは任意の数のドメインに配置できます。</font><font style="vertical-align: inherit;">これは非常に柔軟なことです。</font><font style="vertical-align: inherit;">柔軟性を高めて頭を完全に壊すために、デフォルトドメインもあります。デフォルトドメインに</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/zl/2x/adzl2xgso7st_v9c7vg9-fyryvg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
含まれるサーバーは、ライブサーバーを持たない、または監視ドメインを持たないすべてのホストによって監視されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、ホストをいくつかのサーバーにトポロジ的にバインドし、1つのサーバーが故障した場合にホストがどのように分散されるかを制御できます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/og/nr/fmognrgop74jgnsqkwtxdzddqgw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。次に発生した問題...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター：異なる考え方</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多数のサーバーがある場合、トポロジーを構築するためのクラスターを構築するための新しい機会があります。これは、ある種の中央サイトがあり、リモートサイトがある場合、非常に古典的です。または、たとえば、負荷が委任されたプロキシ：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rn/ar/qd/rnarqdcbs1knledntrvqoibsozs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスタ化されたZabbixの場合、2つの方法で実装できます。インフラストラクチャを2倍にするだけで、従来の方法を使用できます。中央には、クラスターを形成する2台のサーバーがあり、ホストを再配置したり、隣接サーバーが落ちた場合にサーバー自体に負担をかけたりすることができます。したがって、同じサーバーで追加のプロキシを発生させることができます-二重の予約を取得し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/es/g4/bxesg4ijxn4b9pirro22u3-omoa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。新しい「機能」を使用してこれを行うことができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v0/-o/ki/v0-okiiibpq1yyurxipbugjqfwq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主なことは、地理的に離れたサーバーが別の場所にある大きなインフラストラクチャを監視している状況に行くことではありません。</font><font style="vertical-align: inherit;">これは構成の問題であるため、管理上の問題（私はビジネスと呼んでいます）の詳細です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター：スプリットブレインと視点</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターによって、私たちが遭遇した別の興味深い状況が起こりました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スプリットブレイン;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">視点。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは少し交差します。スプリットブレイン-これは、同じインフラストラクチャのポーリングを担当する2つのサーバーがある場合です。私たちのつながりが壊れたとき、ある種の事故が始まりました-彼らはどのように行動しますか？それらがあなたがそれらを設定する方法で振る舞うことは明らかであり、あなたはこれを事前に考える必要があります（シナリオは異なります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
視点の問題は次のようなものです。サーバーのトポロジー距離に依存するチェックは、遠く離れているため、同じホストに対して異なる結果を生成する可能性があります。これは、アクセス速度チェックに適用されます。 RTTを測定する場合、それは異なる場合があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テクノロジーの観点から、彼らはそのようなマクロを作りました：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ab/qa/gc/abqagc2w3ky3kufvm6omjfsjheo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは、トリガーのレベルで、データ要素のレベルで機能します。</font><font style="vertical-align: inherit;">これらを使用すると、このデータがどこから来たのか、どのサーバーがトリガーのイニシエーターであったのかを識別できます。</font><font style="vertical-align: inherit;">そして、データをどのように解釈するか、何をすべきか-自分で決める。</font><font style="vertical-align: inherit;">しかし、どのサーバーがホストの可用性の低下を記録したかがわかっている場合は、何をすべきかがわかります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLデータベースクラスター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、多数のサーバーを分散する場合は、誰もが近くに独自の拠点を持つことを望みます。</font><font style="vertical-align: inherit;">一つのコモンを結ぶのは間違っているでしょう。</font><font style="vertical-align: inherit;">残念ながら、今では既製のソリューションがあると言いますが...そのような経験はまだありません。</font><font style="vertical-align: inherit;">理由をお話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、誰かがクラスターのテストと使用を開始した場合、標準のソリューションを使用できると思います。</font><font style="vertical-align: inherit;">Galera for MySQLとしましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLには、数多くの非同期レプリケーションソリューションがあります。</font><font style="vertical-align: inherit;">Zabbixの場合、これは正常に機能します。インデックスが重複することはなく、データがログに少し遅れて少し遅れて書き込まれることは問題ではありません。</font><font style="vertical-align: inherit;">もちろん、「クリックハウス」はアプリオリにクラスター化できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既製のソリューションがないのはなぜですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストの一般的な構造には、履歴に関係のない小さな部分があります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/u1/4s/q4u14s11rryz7afktbdfkn0s9sy.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/pj/0p/uq/pj0puqdn9zkhsm2uwolcaw40a1w.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。この小さな部分のうち、現在のリクエストの大部分はログです。</font><font style="vertical-align: inherit;">ログは基本的に3つのテーブルを形成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラストラクチャで発生したいくつかのログ（ログ）。</font><font style="vertical-align: inherit;">これらは、問題、イベント、およびイベント回復テーブルです。</font><font style="vertical-align: inherit;">サーバーがクラッシュし、サーバーが回復しました。トリガーが起動すると、すべて書き込まれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15％が州です。</font><font style="vertical-align: inherit;">状態はインフラストラクチャ要素の変化です（サーバーまたはホストが落ちた-トリガーが機能した-Zabbixがデータベースに書き込みます）。</font><font style="vertical-align: inherit;">実際、その状態はデータベースに保存されます。</font><font style="vertical-align: inherit;">一方で、それは素晴らしいことです。</font><font style="vertical-align: inherit;">他方で、私はこの問題について何か言いたいことがあります...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かなりのクエリは、構成の読み込みと変更（構成の更新）に関するものです。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こちらがクラシックなZabbixです。彼らはそれに「Clickhouse」を追加し、SQLデータベースからメトリックを削除しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/if/cc/neifccswcjikrxfetvhuip-agva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、サーバーにアクセスしてステータスを確認します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/o4/ti/4fo4ticljuykrkh6zjmop4qc5sg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうです。サーバーをドロップし、2時間後にWeb管理を開くと、監視状況が表示されます...真実ではありません-2時間前の状態が表示されます！ 「ネットワークの現在の状態がわかりません」と言うのは正しいでしょう。特定のことに関心がある場合は、問題やイベントの履歴、そこで何が起こったかを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
二つ目。ログは、より安価なストレージシステムに移動するよう求められます。これにより、ディスクスペースが大幅に節約され、リソースの消費も少なくなります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/wh/ug/ljwhugg1tdfbehcxjcrloiolwks.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、あなたは何をすべきかを考えるかもしれません。</font><font style="vertical-align: inherit;">私は本当にSQLデータベースを取り除きたいです。</font><font style="vertical-align: inherit;">まず、SQLデータベースの外部でログを記録したいと思います。</font><font style="vertical-align: inherit;">簡単に複製されるか（変更がほとんどないため）、「クリックハウス」にドラッグできます（突然、本格的なデータの変更と削除のサポートが開始されます）。</font><font style="vertical-align: inherit;">様子を見よう…</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">練習。</font><font style="vertical-align: inherit;">取り付け</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスター、理論、「水」と言った。詳細。自分でクラスタを設定する場合は、どうすればよいですか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/yo/ne/ciyonezibe3bfla-7xodyyx_zwg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の「Zabbiks」サーバーを配置する必要があります（つまり、「syshny」デーモンです）。クラスターには2つの新しいパラメーターが表示されます（それらについて説明しました）。サーバー識別子（1から63までの数字。最高の識別子を持つサーバーが「マスター」になります）とホスト名（データベースからサーバーのリストを読み込むときにサーバーの自己識別に必要です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーごとに、ServerIPとIPポートを指定する必要があります。これは、サーバーがお互いを見つけることができ、ポートのこれらのIPアドレス間のトラフィックが機能するために必要です。すべてが標準のプロキシポーラーを通じて機能するため、追加のポートは必要ありません。つまり、標準のトラッパーがhelloリクエストをキャッチし、プロキシポーラーがトラフィックを開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに小さな変更。</font><font style="vertical-align: inherit;">以前はプロキシ制御を使用していたところに、「クラスター管理」パネルが表示され</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dr/1z/pi/dr1zpi2hbe9penikzazqcycw-oa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。いくつかの新しいオブジェクトがあります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/pg/jb/kfpgjbghzsonjmsizlbcatyo3ja.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。最も重要なことは、そこに移動してデフォルトドメインを作成することです。</font><font style="vertical-align: inherit;">テストの最小構成について話している。</font><font style="vertical-align: inherit;">2つ目は、両方のサーバーを起動し、構成で指定したのと同じIPアドレス、ポート、ホスト名を書き留めます（一致する必要があります）。</font><font style="vertical-align: inherit;">サーバーには新しい「ドメイン」フィールドがあり、このデフォルトを選択します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的には、これですべてです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのサーバーを起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼がクラスターについて書いたものを見てください。「私はフィールドで唯一の戦士です。ここで私は最も重要です。」</font><font style="vertical-align: inherit;">監視を開始します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しばらく待って、2台目のサーバーを起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初に彼らはお互いを見るでしょう、それから特定のハロータイムが過ぎます、彼らは言うでしょう：「私たちは一緒に働くことができます」; </font><font style="vertical-align: inherit;">ホスト間で共有します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事を楽しんでください。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーを調整する価値はあると思います。それがどのように機能するかを見てください。</font><font style="vertical-align: inherit;">私たちのテストでは、サーバーの1つが故障した場合に監視が行われない時間は、約30〜40秒です。</font><font style="vertical-align: inherit;">これを減らすことはできますが、サーバー間の通信が低下します。特に、ネットワークが信頼できない場合は、小さなリンギングが始まります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技術的な部分ではありません</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべて生まれ、パッチの形でmainブランチにプッシュするように計画されていましたが、さまざまな理由でうまくいきませんでした。そして今年の4月から、コミュニティの誰かが提案しました：「それでは、別のプロジェクトであるフォークをやってみましょう！」さあ出発！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/ta/ah/nqtaahv3gipyew36m8nhrmwukew.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして興味深いのは、GitLab、CI / CDを見たり、構成したり、クールなアイデアを生み出したりする熱狂的なファンがたくさんいることです。ここでは、例えば、ナノ秒-それはコミュニティから来ました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、独立したプロジェクトとして存在しますが、ほぼ自動的に現在のバージョンに更新されます-4.0.9です（4.2は使用していません）。特定のロードマップがあります-今ではすでにdebianパッケージの形でダウンロードできます。私の意見では、Ubuntaのアセンブリがあります。 RPMがあるかどうかはわかりません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/kn/2r/erkn2r6h9law8l3xynd6i8_jwne.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
間もなく、プロキシ（いくつかの問題点があります）の完全なサポートと、Zabbixパネルでのクラスターステータスの現在の表示のための「調整」が行われます。</font><font style="vertical-align: inherit;">私たちの経験では。</font><font style="vertical-align: inherit;">管理者は、問題の調査を開始するために、どのサーバーでどのホストが処理されているかを知ることが重要です。</font><font style="vertical-align: inherit;">システムは新しいです-純粋に心理的な要因：クラスタを設定しました、何かがうまくいっていません...誰のせいですか？</font><font style="vertical-align: inherit;">クラスタ！..したがって、「チューニング」が必要であり、理解する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
夏の終わりまで、SQLデータベースから、そこに必要のないすべての情報フローを引き出したいのですが、そうする必要はありません。</font><font style="vertical-align: inherit;">履歴ストレージ。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まだ5分あります。</font><font style="vertical-align: inherit;">余った話題についてお話ししたいと思います。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、私が話したすべてのことは、アクティブな監視のイデオロギー、つまりサーバーがどこかでチェックを行うときのイデオロギーにうまく適合します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/3a/gr/zp3agr9epncvnjndf-hgpwt_zke.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクティブおよびパッシブポーリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッシブモニタリングがある場合はどうなりますか？</font><font style="vertical-align: inherit;">たくさんあります！</font><font style="vertical-align: inherit;">たとえば、カウントに長い時間がかかるチェックがあります。</font><font style="vertical-align: inherit;">または、特定のスクリプトがどこかに行った場合、データを準備してから、サーバーに送信する必要があります。</font><font style="vertical-align: inherit;">そのようなスクリプトはクラスターの構造全体を知ることができず、誰もベース全体をそれらに委任しないことは明らかです。</font><font style="vertical-align: inherit;">このために、そのようなことを生き残るためのメカニズムがクラスターに作成されました：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/fo/pf/acfopfqzuwvtfvtni2n9rjx-ywy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーがあります。</font><font style="vertical-align: inherit;">「マスター」サーバーは、どのサーバー上のどのホストを処理するかを決定しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、ホストがそのサーバーにデータを強制的に送信しない場合、このサーバーはデータを受信して​​処理します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準の「Zabbix」にチェックがあります。これらのメトリックが構成キャッシュに実際に存在することを確認し、タイプをチェックします。</font></font></li>
<li>  ,           ,     .        ,    ,   .</li>
<li>  -    ,   .      ,    ,    .    200     ,     –   .</li>
</ul><br>
<h3> </h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：パッシブプロキシはまだサポートされていません。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを削除しました。</font><font style="vertical-align: inherit;">これは、別のメカニズムを作成するのが難しいためです。このサーバーは、このプロキシを担当します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクティブなプロキシ自体がサーバーに送信されます。</font><font style="vertical-align: inherit;">これにはサーバーオプションがあります（標準プロキシ）。</font><font style="vertical-align: inherit;">変更されたプロキシにはサーバーオプションがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/ym/6t/jmym6tfhwlg_ix6o5xnnkbwphri.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような変更されたサーバーは何をしますか？</font><font style="vertical-align: inherit;">指定されたすべてのサーバーとのKPI接続を維持します。</font><font style="vertical-align: inherit;">構成を要求し、リストから最初に使用可能なサーバーにデータを送信します。</font><font style="vertical-align: inherit;">これは問題を解決します。</font><font style="vertical-align: inherit;">Zabbixサーバー用に構成されたプロキシがあり、Zabbixサーバーが落ちた場合、プロキシなしで残されないように、クラスタ内に別のサーバーが存在するとします。</font><font style="vertical-align: inherit;">その後、プロキシは別のものにフックします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご質問</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
聴衆からの質問（以下-A）：-サーバー間の接続状況を明確にしたいのですが？彼らはどのプロトコルと通信しますか？セキュリティはありますか？サーバー間の通信をインターネットに接続することはあまり「安全」ではないため、これはどうですか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -これは最良の質問の候補だと思います-要点まで！実際、標準通信に切り替えたとき、サーバー間通信のサーバーは、サーバーとプロキシの間に存在するすべての通信プロトコル機能を継承しました。明確にします。暗号化、データ圧縮があります。サーバーとプロキシに対して標準的に構成されているため、すべて同じようにWeb経由で構成されます。すべてが機能します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Clickhouseの場合、Hauskiperはどのように機能しますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">んん：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-標準の「Zabbix」では、「ハウスキーパー」から履歴インターフェイスへのインターフェイスはありません。つまり、履歴インターフェイスはデータローテーションをサポートしていません（たとえば、ElasticSearchはサポートしていません）。たぶん4.2ではそれは（私は見ていませんでしたが）、今のところ4.0.9です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単にする！新しい「Clickhouse」にはパーティションがあります。古いパーティションを切り離してやりたいのですが。個々のアイテムのレベルではローテーションがないことは明らかですが、Zabbixにはトリックがあります：グローバル値を指定できます（たとえば、履歴全体を90日以内で保存します）-このグローバル値からすべてのアイテム、履歴全体をクリアできます。そしてそれが行われます！ Gitlabにはこのトピックに関する詳細があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはアーキテクチャ上の権利を実行したいと思います。HistoryInterfaceを拡張して、基本的にそうなるようにするかどうかです。一般的に、私は技術的な負債を残したくありませんが、実行されます。それが必要なので、より多くの「Clickhouse」がサポートし始めました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -これについてどう思いますか？あなたは、結局のところ、プロバイダー以外の多くの仕事を回しています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -おそらく私はそれをあまり正しく入れなかったでしょう。これが私の趣味です！私は実際には技術的な専門家ではありません-私はマネージャーです。私の自由な時間に私は練習します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -あなたはあなたのコアビジネスの一部としてそれをやっていたと思いました... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ビジネスは私にテストするための涼しい場所を与えます。実際、私は強くお勧めします-それは脳を和らげます。経営上の「もの」のどこかで私はこれを言うでしょう-あなたが人間の問題からこれらに切り替えることができるとき。彼らはとてもクールに解決されています！これらは技術的な問題です。あなたがプログラムし、それはあなたがプログラムした方法で動作します！そんなことをしてはいけないのは残念だ。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -プロキシ経由で、または直接「Clickhouse」に書き込みますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -直接。実際、「エラスティックス」で使用されている変更された履歴インターフェースも継承されます。 URLが使用されます。つまり、httpインターフェイスを介して「Zabbiks」が「Clickhouse」を送信します。すばらしいことに、Zabbixは、大きな履歴のストリーム、1つのパックに何千ものメトリックが存在する場合に集約され、これは非常にクールにClickhouseに当てはまります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-実際、彼は彼のためにバチを書いていますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MM：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -はい。 URLによって実行される1つのSQLクエリには、通常、1,000のメトリックが含まれます。管理者「Clickhouse」だけで満足しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレゼンター：-これはこの部屋でのプログラムの終わりです。組織されている夜のプログラムがあり、あなただけが行うことができる何かがあります。そして、私は、あなたがお互いにコミュニケーションする間、あなたが何ができるか面白いものについて考えるために提案します...あなたのケースについてお互いに話すとき、これはあなたが話すことができるものである可能性が最も高いです。お互いに話し合って、概要を見つけるだけで見つけることができます-プログラム委員会があなたの申請を受け入れ、検討し、そこから良いストーリーを作るのに役立ちます。たぶん、プログラム委員会との協力について何か話がありますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">んん：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-実際、多くのフィードバックが与えられています。</font><font style="vertical-align: inherit;">私はとても幸運でした。プログラム委員会のメンバーが私のチェリャビンスクに住んでおり、Highloadはスピーカーと緊密に連携する唯一の会議です。</font><font style="vertical-align: inherit;">このようなものはどこにも見たことがありません。</font><font style="vertical-align: inherit;">とてもお得です！</font><font style="vertical-align: inherit;">さまざまな段階：みんながビデオを見て、スライドにコメントを付けます。これは件名（スペル、事務エラー）で非常に多く発生します。</font><font style="vertical-align: inherit;">結構！</font><font style="vertical-align: inherit;">私はお勧め！</font><font style="vertical-align: inherit;">ぜひお試しください！</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/wbIpn44Z2_8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">広告のビット:)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつもご利用いただきありがとうございます。私たちの記事は好きですか？もっと面白い資料を見たいですか？私たちが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発した</font></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリーレベルサーバーのユニークなアナログで</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">$ 4.99から</font></a><font style="vertical-align: inherit;">、注文またはお友達</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">への開発者向けクラウドベースVPSの開発者</font></a><font style="vertical-align: inherit;">への推奨によって私たちをサポートして</font><b><font style="vertical-align: inherit;">ください：</font></b></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS（KVM）E5-2697 v3（6コア）10GB DDR4 480GB SSD 1Gbpsの真実19ドルから、またはサーバーを分割する方法？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（オプションは、RAID1およびRAID10、最大24コア、最大40GB DDR4で利用可能です）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xdは、アムステルダムのEquinix Tier IVデータセンターで2倍安いですか？</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">オランダでは</font></b><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">199ドルのIntel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV</font></a></b><font style="vertical-align: inherit;">が</font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">2つ</font></a></b><font style="vertical-align: inherit;">だけあり</font><b><font style="vertical-align: inherit;">ます！</font></b></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デルR420-2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB-$ 99から！</font></font></b></b><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">インフラストラクチャビルディングの構築方法</font></a><font style="vertical-align: inherit;">について</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">お</font></a><font style="vertical-align: inherit;">読みください</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Dell R730xd E5-2650 v4サーバーを使用するクラスcは、1ペニーで9,000ユーロかかりますか？</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485522/index.html">ハックザボックス-ウォークスルーAI。JDWPのSreach、SSH転送、およびRCEへのAPIテキストでのSQLi</a></li>
<li><a href="../ja485524/index.html">モバイル＃330開発者向けの興味深い資料のダイジェスト（1月20〜26日）</a></li>
<li><a href="../ja485526/index.html">誰が、なぜインターネットを「共有」したいのか</a></li>
<li><a href="../ja485530/index.html">ガイド付き学習</a></li>
<li><a href="../ja485532/index.html">それらを理解していないプログラマのためのインタビューガイド</a></li>
<li><a href="../ja485536/index.html">飛行機をハックすることは可能ですか-2</a></li>
<li><a href="../ja485538/index.html">Zabbix：行のすべてを監視します（例としてRedisを使用）</a></li>
<li><a href="../ja485540/index.html">リバースアナログカメラの設計</a></li>
<li><a href="../ja485542/index.html">Notionにグラフィックを追加する</a></li>
<li><a href="../ja485544/index.html">動的システムとしてのチェス</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>