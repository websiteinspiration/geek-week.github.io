<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐛 👵🏽 🛒 Flutter + arduino nano 33 BLE sense = sensor BLE yang sangat sederhana 🥩 🧖🏾 🍮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini saya ingin memberi tahu cara membuat stasiun cuaca bluetooth yang sangat sederhana (di mana tanpanya :)) dan menulis aplikasi seluler...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Flutter + arduino nano 33 BLE sense = sensor BLE yang sangat sederhana</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492404/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada artikel ini saya ingin memberi tahu cara membuat stasiun cuaca bluetooth yang sangat sederhana (di mana tanpanya :)) dan menulis aplikasi seluler di Flutter untuk itu.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ep/ad/j7/epadj7tyxlocbup948zmgsyafdc.jpeg"><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada awalnya, perhatikan sensor itu sendiri</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengulang, Anda akan memerlukan papan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akal Arduino nano 33 BLE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Papan dibangun di atas nrf52840. </font><font style="vertical-align: inherit;">Kami menginstalnya melalui manajer papan di Arduino. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/ry/nl/gorynl7zdxmfbzidptj5g-p7wtm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera instal perpustakaan yang diperlukan:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino ble</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino HTS221</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino LPS22HB</font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perpustakaan ini diperlukan untuk sensor yang sudah disolder di papan itu sendiri.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sedikit teori, dan kemudian pertimbangkan implementasi praktisnya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gagasan utamanya bukan untuk membuat perangkat plug-in, tetapi untuk mengimplementasikan paket siaran dengan semua informasi yang diperlukan yang termasuk di dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mode tag bluetooth biasa digunakan, tetapi dengan modifikasi ManufacturerData. Paket ini dapat ditransmisikan dalam setiap paket iklan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ukuran total paket iklan adalah 31 byte. Ini termasuk semua informasi yang diperlukan: nama perangkat, data sistem, data pengguna. Dalam bentuknya yang murni, pengguna di ManufacturerData adalah sekitar 20 byte. Ini cukup untuk mengirimkan data stasiun cuaca. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kelebihan metode transmisi data ini adalah konsumsi daya yang lebih rendah, tidak perlu menjaga koneksi konstan dengan perangkat, siaran. Pesan semacam itu dapat menangkap jumlah penerima yang tidak terbatas dalam radius penerimaan.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManufacturerData diinstal sebelum awal iklan.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan sekarang bagian praktisnya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kode Arduino, kami menunjukkan jenis pekerjaan dari bagian BLE dan mengatur ManufacturerData </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
awal.Juga, untuk kenyamanan, saya menentukan nama perangkat, sehingga lebih mudah ditemukan dalam aplikasi.</font></font><br>
<br>
<pre><code class="cpp hljs">BLE.setLocalName(<span class="hljs-string">"nrf52840.ru"</span>);<font></font>
BLE.setConnectable(<span class="hljs-literal">false</span>);<font></font>
byte data[<span class="hljs-number">8</span>] = { <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x08</span>};<font></font>
BLE.setManufacturerData(data, <span class="hljs-number">8</span>);
<span class="hljs-comment">// start advertising</span><font></font>
BLE.advertise();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data awal diberikan sebagai satu set byte untuk mengisi array. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang dalam kode utama kita membuat penghentian iklan, menghentikan radio, mengukur data yang diperlukan dan mengisi data FactoryData dengan data nyata, kemudian mulai menyiarkan kembali. </font><font style="vertical-align: inherit;">Operasi ini dilakukan setiap 2 detik.</font></font><br>
<br>
<pre><code class="cpp hljs">BLE.stopAdvertise();
<span class="hljs-comment">// read all the sensor values</span><font></font>
---------------------<font></font>
       <font></font>
---------------------<font></font>
byte data[<span class="hljs-number">8</span>] = { <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, t1, t2, h1, h2, p1, p2}; <span class="hljs-comment">// t -  (2 ), h -  (2 ), p -  (2 )</span>
BLE.setManufacturerData(data, <span class="hljs-number">8</span>);<font></font>
BLE.advertise();<font></font>
<span class="hljs-comment">// wait 2 second to print again</span>
delay(<span class="hljs-number">2000</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini melengkapi pekerjaan dengan sensor. </font><font style="vertical-align: inherit;">Sensor akan menyiarkan setiap 100ms dan setiap 2sec akan memperbarui data ke yang sekarang. </font><font style="vertical-align: inherit;">Hasilnya adalah kode cuaca dan sensor implementasi yang sangat sederhana.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang perhatikan aplikasi seluler</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan segera melakukan reservasi: Saya bukan pengembang aplikasi seluler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk bekerja, saya menggunakan VSCode dengan plugin Flutter. </font><font style="vertical-align: inherit;">Lingkungan ini tampaknya lebih sederhana daripada Android Studio, seperti yang saya duga. </font><font style="vertical-align: inherit;">Untuk bekerja dengan BLE, pustaka </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flutter_blue digunakan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang sangat menyederhanakan koneksi perangkat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logika aplikasi ini juga cukup sederhana. </font><font style="vertical-align: inherit;">Sensor kami mengudara dalam mode Beacon normal, jadi Anda hanya perlu melakukan beberapa tindakan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pindai siaran - temukan perangkat dengan nama yang diberikan, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uraikan ManufacturerData untuk menampilkan data di layar. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat bagaimana ini dilakukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah memulai aplikasi, timer secara berkala diluncurkan, yang memindai perangkat Bluetooth setiap 10 detik selama 2 detik. </font><font style="vertical-align: inherit;">Lebih sering dan lebih lama tidak masuk akal untuk memindai, konsumsi baterai akan meningkat, dan sensor menyiarkan umumnya setiap 100ms.</font></font><br>
<br>
<pre><code class="java hljs">DeviceScanner() {<font></font>
   _subscribeToScanEvents();<font></font>
   _timer = <span class="hljs-keyword">new</span> Timer.periodic(<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">Duration</span><span class="hljs-params">(seconds: <span class="hljs-number">10</span>)</span>, startScan)</span>;<font></font>
 }<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">startScan</span><span class="hljs-params">(Timer timer)</span> </span>{<font></font>
   FlutterBlue.instance.startScan(timeout: Duration(seconds: <span class="hljs-number">2</span>));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, kami mulai menganalisis hasil pemindaian, memeriksa apakah ada perangkat dengan nama yang diberikan dalam daftar pemindaian, dan jika demikian, kami menguraikan paketnya dan menampilkan hasilnya kepada pengguna.</font></font><br>
<br>
<pre><code class="java hljs">
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">_subscribeToScanEvents</span><span class="hljs-params">()</span> </span>{<font></font>
    FlutterBlue.instance.scanResults.listen((scanResults) {<font></font>
      <span class="hljs-keyword">for</span> (ScanResult scanResult in scanResults) {
        <span class="hljs-keyword">if</span> (scanResult.device.name.toString() == <span class="hljs-string">"nrf52840.ru"</span>) {
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> rssi = scanResult.rssi;
          <span class="hljs-keyword">final</span> String name = scanResult.device.name;
          <span class="hljs-keyword">final</span> String mac = scanResult.device.id.toString();
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> temp = scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>]<font></font>
                  [<span class="hljs-number">0</span>] +<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">1</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> humm = scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>]<font></font>
                  [<span class="hljs-number">2</span>] +<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">3</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span> press =<font></font>
              scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">4</span>] +<font></font>
                  scanResult.advertisementData.manufacturerData[<span class="hljs-number">256</span>][<span class="hljs-number">5</span>] * <span class="hljs-number">0.01</span>;
          <span class="hljs-keyword">final</span> SensorData sensorData = <span class="hljs-keyword">new</span> SensorData(<font></font>
              name: name,<font></font>
              rssi: rssi,<font></font>
              mac: mac,<font></font>
              temperature: temp,<font></font>
              humidity: humm,<font></font>
              pressure: press);<font></font>
          _streamController.add(sensorData);<font></font>
          print(<font></font>
              <span class="hljs-string">'Manufacturer data ${scanResult.advertisementData.manufacturerData}'</span>);<font></font>
          FlutterBlue.instance.stopScan();<font></font>
        }<font></font>
<font></font>
        print(<font></font>
            <span class="hljs-string">'${scanResult.device.name} found! mac: ${scanResult.device.id} rssi: ${scanResult.rssi}'</span>);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuansa sedikit. </font><font style="vertical-align: inherit;">Pustaka Bluetooth untuk Flutter mungkin tampak aneh, ia menerima data dalam bentuk array int, dan dalam Arduino kami membentuk paket dari byte, jadi saya membentuk paket di sensor untuk menyederhanakan analisisnya. </font><font style="vertical-align: inherit;">Temperatur 25,85 derajat dibagi menjadi dua nilai 25 dan 85, yang dikirim sebagai nilai byte terpisah, dan dikumpulkan dengan cara yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasil akhirnya adalah aplikasi seperti itu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/27/6z/on/276zonw0i_fms8koszpnnrqwifs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode sumber proyek dapat diunduh dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id492386/index.html">Bagaimana sektor TI membantu dunia membuang lebih sedikit makanan</a></li>
<li><a href="../id492390/index.html">Perang rem. Mengoptimalkan jumlah rendering komponen di React Native</a></li>
<li><a href="../id492392/index.html">IntelliJ IDEA Tips & Trik: 3. Menyesuaikan gaya kode untuk setiap folder</a></li>
<li><a href="../id492394/index.html">Dark Universe. Bagian 2</a></li>
<li><a href="../id492398/index.html">Kami mengkonfigurasi perangkat kami untuk pekerjaan jarak jauh, podcasting, video dan streaming</a></li>
<li><a href="../id492406/index.html">Podcast untuk geek: beberapa program yang telah terbukti tentang manajemen proyek, analisis teknologi dan GTD</a></li>
<li><a href="../id492408/index.html">Kehadiran desktop Yandex telah menurun: apa yang terjadi pada 2019 dan bagaimana pengaruhnya pada 2020</a></li>
<li><a href="../id492414/index.html">Anatomi sistem NSI</a></li>
<li><a href="../id492420/index.html">WeChat atau aplikasi yang benar-benar komprehensif. Apa yang bisa dilakukan pengembang dengan itu</a></li>
<li><a href="../id492422/index.html">Escobar Fold 2 - Scam Berlanjut</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>