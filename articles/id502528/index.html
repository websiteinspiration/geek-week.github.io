<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍗 ☦️ 🥑 Memprogram game untuk perangkat yang disematkan di ESP32 👁️ 🐪 🀄️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagian 0: motivasi
 pengantar
 Saya mencari proyek hobi yang bisa saya kerjakan di luar tugas utama saya untuk melarikan diri dari situasi di dunia. S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Memprogram game untuk perangkat yang disematkan di ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502528/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 0: motivasi</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mencari proyek hobi yang bisa saya kerjakan di luar tugas utama saya untuk melarikan diri dari situasi di dunia. </font><font style="vertical-align: inherit;">Saya sebagian besar tertarik pada pemrograman game, tapi saya juga suka sistem embedded. </font><font style="vertical-align: inherit;">Sekarang saya bekerja di perusahaan game, tetapi sebelumnya saya terutama terlibat dalam mikrokontroler. </font><font style="vertical-align: inherit;">Meskipun pada akhirnya saya memutuskan untuk mengubah jalur saya dan masuk ke industri game, saya masih suka bereksperimen dengan mereka. </font><font style="vertical-align: inherit;">Jadi mengapa tidak menggabungkan kedua hobi?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid pergi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memiliki </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang akan menarik untuk dimainkan. </font><font style="vertical-align: inherit;">Intinya adalah ESP32 - mikrokontroler yang sangat populer dengan fungsionalitas standar MK (SPI, I2C, GPIO, timer, dll.), Tetapi juga dengan WiFi dan Bluetooth, yang membuatnya menarik untuk membuat perangkat IoT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go melengkapi ESP32 dengan banyak periferal, mengubahnya menjadi mesin game portabel yang mengingatkan Gameboy Color: layar LCD, speaker, palang kontrol, dua tombol tambahan utama dan empat, baterai dan pembaca kartu SD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kebanyakan orang membeli Odroid Go untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menjalankan emulator dari</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sistem 8-bit lama. </font><font style="vertical-align: inherit;">Jika benda ini mampu meniru permainan lama, itu juga akan mengatasi peluncuran game asli yang dirancang khusus untuk itu.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/800/42e/44b80042e94aa2f2da9da2d2296461ad.jpg"></div><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keterbatasan</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolusi 320x240</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Layar hanya memiliki ukuran 320x240, jadi kami sangat terbatas dalam jumlah informasi yang ditampilkan di layar pada saat yang bersamaan. Kita perlu mempertimbangkan dengan cermat game apa yang akan kita buat dan sumber daya apa yang digunakan. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warna 16-bit</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Layar mendukung </font><strong><font style="vertical-align: inherit;">warna</font></strong><font style="vertical-align: inherit;"> 16-bit per piksel: 5 bit untuk merah, 6 bit untuk hijau, dan 5 untuk biru. Untuk alasan yang jelas, sirkuit seperti itu biasanya disebut RGB565. Hijau menjadi sedikit lebih merah dan biru, karena mata manusia lebih baik membedakan antara gradasi hijau daripada biru atau merah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warna 16-bit berarti kita hanya memiliki akses ke 65 ribu warna. Bandingkan ini dengan warna standar 24-bit (8 bit per warna), memberikan 16 </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">juta</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> warna. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangnya GPU</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tanpa GPU, kami tidak dapat menggunakan API seperti OpenGL. Saat ini, GPU yang sama biasanya digunakan untuk rendering game 2D seperti untuk game 3D. Hanya alih-alih objek, segi empat digambar, di mana tekstur bit ditumpangkan. Tanpa GPU, kita harus meraster setiap piksel dengan CPU, yang lebih lambat tapi lebih sederhana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan resolusi layar 320x240 dan warna 16-bit, ukuran buffer bingkai total adalah 153.600 byte. Ini berarti bahwa setidaknya tiga puluh kali per detik kita perlu mengirimkan 153.600 byte ke layar. Ini pada akhirnya dapat menyebabkan masalah, jadi kita harus lebih pintar saat merender layar. Misalnya, Anda dapat mengubah warna yang diindeks menjadi palet sehingga untuk setiap piksel Anda perlu menyimpan satu byte, yang akan digunakan sebagai indeks palet 256-warna.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 MB</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ESP32 memiliki RAM internal 520 KB, sementara Odroid Go menambahkan 4 MB RAM eksternal. Tetapi tidak semua memori ini tersedia untuk kita, karena sebagian digunakan oleh ESP32 SDK (lebih lanjut tentang ini nanti). Setelah menonaktifkan semua kemungkinan fungsi luar dan memasukkan fungsi utama saya, ESP32 melaporkan bahwa kita dapat menggunakan 4.494.848 byte. Jika di masa depan kita membutuhkan lebih banyak memori, maka nanti kita dapat kembali memangkas fungsi yang tidak perlu. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prosesor 80-240 MHz</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU dikonfigurasi pada tiga kemungkinan kecepatan: 80 MHz, 160 MHz dan 240 MHz. Bahkan maksimum 240 MHz jauh dari kekuatan lebih dari tiga gigahertz komputer modern yang biasa kita gunakan untuk bekerja. Kita akan mulai dari 80 MHz dan melihat sejauh mana kita bisa melangkah. Jika kita ingin game bekerja dengan daya baterai, maka konsumsi daya harus rendah. Untuk melakukan ini, alangkah baiknya untuk menurunkan frekuensinya. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debugging buruk</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada beberapa cara untuk menggunakan debugger dengan perangkat yang disematkan (JTAG), tetapi, sayangnya, Odroid Go tidak memberi kami kontak yang diperlukan, jadi kami tidak dapat menelusuri kode dalam debugger, seperti yang biasanya terjadi. </font><font style="vertical-align: inherit;">Ini berarti bahwa debugging dapat menjadi proses yang sulit, dan kami harus secara aktif menggunakan debugging di layar (menggunakan warna dan teks), dan juga menampilkan informasi ke konsol debugging (yang, untungnya, mudah diakses melalui USB UART).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa semua masalah?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa bahkan mencoba membuat game untuk perangkat yang lemah ini dengan semua batasan yang tercantum di atas, dan tidak menulis apa pun untuk PC desktop? Ada dua alasan untuk ini: </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keterbatasan menstimulasi kreativitas</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ketika Anda bekerja dengan sistem yang memiliki seperangkat peralatan tertentu, yang masing-masing memiliki keterbatasannya sendiri, itu membuat Anda memikirkan bagaimana cara terbaik memanfaatkan kelebihan dari keterbatasan ini. Jadi kami lebih dekat dengan pengembang game sistem lama, misalnya, Super Nintendo (tapi itu masih jauh lebih mudah bagi kami daripada bagi mereka). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengembangan tingkat rendah itu menyenangkan</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menulis game dari awal untuk sistem desktop biasa, kita harus bekerja dengan konsep mesin tingkat rendah standar: rendering, fisika, pengenalan tabrakan. </font><font style="vertical-align: inherit;">Tetapi ketika menerapkan semua ini pada perangkat yang disematkan, kita juga harus berurusan dengan konsep komputer tingkat rendah, misalnya, menulis driver LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seberapa rendah perkembangannya?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika datang ke tingkat rendah dan membuat kode Anda sendiri, Anda harus menggambar perbatasan di suatu tempat. Jika kami mencoba menulis game tanpa pustaka untuk desktop, maka perbatasan kemungkinan merupakan sistem operasi atau API lintas platform seperti SDL. Dalam proyek saya, saya akan menarik garis pada penulisan hal-hal seperti driver SPI dan bootloader. Bersama mereka lebih banyak siksaan daripada kesenangan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, kita akan menggunakan ESP-IDF, yang pada dasarnya adalah SDK untuk ESP32. Kita dapat mengasumsikan bahwa ia memberi kita beberapa utilitas yang biasanya disediakan oleh </font><font style="vertical-align: inherit;">sistem operasi </font><font style="vertical-align: inherit;">, tetapi </font><font style="vertical-align: inherit;">sistem operasi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bekerja </font><font style="vertical-align: inherit;">di ESP32 </font><font style="vertical-align: inherit;">. Sebenarnya, MK ini menggunakan FreeRTOS, yang merupakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sistem operasi real-time</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tapi ini bukan OS nyata. </font><font style="vertical-align: inherit;">Ini hanya perencana. </font><font style="vertical-align: inherit;">Kemungkinan besar, kita tidak akan berinteraksi dengannya, tetapi pada intinya ESP-IDF menggunakannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDF menyediakan kami dengan API untuk periferal ESP32 seperti SPI, I2C, dan UART, serta pustaka runtime C, jadi ketika kita memanggil sesuatu seperti printf, ia sebenarnya mentransfer byte melalui UART untuk ditampilkan pada monitor antarmuka serial. </font><font style="vertical-align: inherit;">Itu juga memproses semua kode startup yang diperlukan untuk menyiapkan mesin sebelum memanggil titik peluncuran game kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam posting ini saya akan menyimpan majalah pengembangan di mana saya akan berbicara tentang hal-hal menarik yang menurut saya dan menjelaskan aspek yang paling sulit. </font><font style="vertical-align: inherit;">Saya tidak punya rencana dan kemungkinan besar saya akan membuat banyak kesalahan. </font><font style="vertical-align: inherit;">Semua ini saya buat karena minat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 1: membangun sistem</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum kita dapat mulai menulis kode untuk Odroid Go, kita perlu mengkonfigurasi ESP32 SDK. </font><font style="vertical-align: inherit;">Ini berisi kode yang memulai ESP32 dan memanggil fungsi utama kami, serta kode periferal (misalnya, SPI) yang akan kita perlukan ketika kita menulis driver LCD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espressif menyebut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDK-nya </font><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">kami menggunakan versi stabil terbaru </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4.0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami dapat mengkloning repositori sesuai dengan instruksi mereka (dengan bendera </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rekursif</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), atau cukup mengunduh zip dari halaman rilis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuan pertama kami adalah aplikasi Hello World bergaya minimal yang diinstal di Odroid Go yang membuktikan pengaturan lingkungan build yang benar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C atau C ++</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDF menggunakan C99, jadi kami akan memilihnya juga. </font><font style="vertical-align: inherit;">Jika diinginkan, kita bisa menggunakan C ++ (ada kompiler C ++ di ESP32 toolchain), tetapi untuk sekarang, kita akan tetap menggunakan C. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, saya suka C dan kesederhanaannya. </font><font style="vertical-align: inherit;">Tidak peduli berapa banyak saya menulis kode dalam C ++, saya tidak pernah berhasil mencapai momen menikmatinya. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orang ini meringkas pikiran saya dengan cukup baik. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, jika perlu, kami dapat beralih ke C ++ kapan saja.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyek minimal</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDF menggunakan CMake untuk mengelola sistem pembangunan. Itu juga mendukung Makefile, tetapi tidak digunakan lagi di v4.0, jadi kami hanya akan menggunakan CMake. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minimal, kita memerlukan file </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan deskripsi proyek kami, folder </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utama</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan file sumber dari titik masuk ke dalam permainan, dan file </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lain </font><font style="vertical-align: inherit;">di dalam </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang berisi daftar file sumber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CMake perlu referensi variabel lingkungan yang memberitahukan di mana harus mencari IDF dan toolchain. Saya kesal karena saya harus menginstalnya kembali setiap kali saya memulai sesi terminal baru, jadi saya menulis skrip </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ini menetapkan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan juga sumber ekspor IDF yang menetapkan variabel lingkungan lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal ini cukup untuk pengguna script untuk mengatur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH variabel</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="powershell hljs">IDF_PATH=<font></font>
IDF_TOOLS_PATH=<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_TOOLS_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_TOOLS_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<font></font>
export IDF_PATH<font></font>
export IDF_TOOLS_PATH<font></font>
<font></font>
source <span class="hljs-variable">$IDF_PATH</span>/export.sh</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di root:</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>)<font></font>
<font></font>
<span class="hljs-keyword">set</span>(COMPONENTS <span class="hljs-string">"esptool_py main"</span>)<font></font>
<font></font>
<span class="hljs-keyword">include</span>($ENV{IDF_PATH}/tools/cmake/<span class="hljs-keyword">project</span>.cmake)<font></font>
<font></font>
<span class="hljs-keyword">project</span>(game)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara default, sistem build akan membangun setiap komponen yang mungkin ada di dalam </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ESP_IDF / komponen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang akan menghasilkan lebih banyak waktu kompilasi. </font><font style="vertical-align: inherit;">Kami ingin mengkompilasi sekumpulan komponen minimal untuk memanggil fungsi utama kami, dan menghubungkan komponen tambahan nanti jika perlu. </font><font style="vertical-align: inherit;">Ini adalah untuk apa variabel </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KOMPONEN</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di dalam </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cmake hljs">idf_component_register(<font></font>
	SRCS <span class="hljs-string">"main.c"</span>
    INCLUDE_DIRS <span class="hljs-string">""</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segala sesuatu yang dia lakukan - tak terhingga satu detik ditampilkan di monitor antarmuka serial "Hello World". </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTaskDelay</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menggunakan FreeRTOS </font><font style="vertical-align: inherit;">untuk menunda </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sangat sederhana:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/FreeRTOS.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/task.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello World!\n"</span>);<font></font>
		vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhatikan bahwa fungsi kita disebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bukan </font></font></em> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Fungsi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utama</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> digunakan oleh IDF untuk persiapan yang diperlukan, dan kemudian itu membuat </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tugas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan fungsi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami </font><font style="vertical-align: inherit;">sebagai titik masuk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas hanyalah blok yang dapat dieksekusi yang dapat dikelola FreeRTOS. Meskipun kita tidak perlu khawatir tentang ini (atau mungkin tidak sama sekali), penting untuk dicatat di sini bahwa permainan kita berjalan dalam satu inti (ESP32 memiliki dua inti), dan dengan setiap iterasi dari for loop, tugas menunda eksekusi selama satu detik. Selama penundaan ini, penjadwal FreeRTOS dapat mengeksekusi kode lain yang sedang menunggu untuk dieksekusi (jika ada).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita dapat menggunakan kedua inti, tetapi untuk sekarang, mari kita batasi diri kita sendiri.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Komponen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan jika kita mengurangi daftar komponen ke minimum yang diperlukan untuk aplikasi Hello World (yang </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esptool_py</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utama</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), karena konfigurasi rantai ketergantungan, ia masih mengumpulkan beberapa komponen lain yang tidak kita butuhkan. </font><font style="vertical-align: inherit;">Ia mengumpulkan semua komponen ini:</font></font><br>
<br>
<pre><code class="cmake hljs">app_trace app_update bootloader bootloader_support cxx driver efuse esp32 esp_common esp_eth esp_event esp_ringbuf<font></font>
esp_rom esp_wifi espcoredump esptool_py freertos heap log lwip main mbedtls newlib nvs_flash partition_table pthread<font></font>
soc spi_flash tcpip_adapter vfs wpa_supplicant xtensa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Banyak dari mereka cukup logis ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bootloader</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freertos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), tetapi mereka diikuti oleh komponen yang tidak perlu karena kami tidak menggunakan fungsi jaringan: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_eth, esp_wifi, lwip, mbedtls, tcpip_adapter, wpa_supplicant</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sayangnya, kami masih dipaksa untuk merakit komponen-komponen ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untungnya, tautannya cukup pintar dan tidak memasukkan komponen yang tidak digunakan ke dalam file biner permainan yang sudah jadi. </font><font style="vertical-align: inherit;">Kami dapat memverifikasi ini dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membuat ukuran-komponen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<code><pre>Total sizes:
 DRAM .data size:    8476 bytes
 DRAM .bss  size:    4144 bytes
Used static DRAM:   12620 bytes ( 168116 available, 7.0% used)
Used static IRAM:   56345 bytes (  74727 available, 43.0% used)
      Flash code:   95710 bytes
    Flash rodata:   40732 bytes
Total image size:~ 201263 bytes (.bin may be padded larger)
Per-archive contributions to ELF file:
            Archive File DRAM .data &amp; .bss   IRAM Flash code &amp; rodata   Total
                  libc.a        364      8   5975      63037     3833   73217
              libesp32.a       2110    151  15236      15415    21485   54397
           libfreertos.a       4148    776  14269          0     1972   21165
                libsoc.a        184      4   7909        875     4144   13116
          libspi_flash.a        714    294   5069       1320     1386    8783
                libvfs.a        308     48      0       5860      973    7189
         libesp_common.a         16   2240    521       1199     3060    7036
             libdriver.a         87     32      0       4335     2200    6654
               libheap.a        317      8   3150       1218      748    5441
             libnewlib.a        152    272    869        908       99    2300
        libesp_ringbuf.a          0      0    906          0      163    1069
                liblog.a          8    268    488         98        0     862
         libapp_update.a          0      4    127        159      486     776
 libbootloader_support.a          0      0      0        634        0     634
                libhal.a          0      0    519          0       32     551
            libpthread.a          8     12      0        288        0     308
             libxtensa.a          0      0    220          0        0     220
                libgcc.a          0      0      0          0      160     160
               libmain.a          0      0      0         22       13      35
                libcxx.a          0      0      0         11        0      11
                   (exe)          0      0      0          0        0       0
              libefuse.a          0      0      0          0        0       0
         libmbedcrypto.a          0      0      0          0        0       0
     libwpa_supplicant.a          0      0      0          0        0       0</pre></code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang terpenting, libc mempengaruhi ukuran biner, dan itu tidak masalah.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi proyek</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDF memungkinkan Anda menentukan parameter konfigurasi waktu kompilasi yang digunakan selama perakitan untuk mengaktifkan atau menonaktifkan berbagai fungsi. </font><font style="vertical-align: inherit;">Kita perlu mengatur parameter yang memungkinkan kita memanfaatkan aspek tambahan dari Odroid Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, Anda perlu menjalankan skrip sumber </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agar CMake memiliki akses ke variabel lingkungan yang diperlukan. </font><font style="vertical-align: inherit;">Selanjutnya, seperti untuk semua proyek CMake, kita perlu membuat folder perakitan dan memanggil CMake darinya.</font></font><br>
<br>
<pre><code class="cmake hljs">source <span class="hljs-keyword">export</span>.sh<font></font>
mkdir build<font></font>
cd build<font></font>
cmake ..</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menjalankan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make menuconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sebuah jendela akan terbuka di mana Anda dapat mengonfigurasi pengaturan proyek.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memperluas memori flash hingga 16 MB</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go memperluas kapasitas flash drive standar hingga 16 MB. </font><font style="vertical-align: inherit;">Anda dapat mengaktifkan fitur ini dengan masuk ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serial flasher config -&gt; Flash size -&gt; 16MB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nyalakan RAM SPI eksternal</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami juga memiliki akses ke tambahan 4 MB RAM eksternal yang terhubung melalui SPI. </font><font style="vertical-align: inherit;">Anda dapat mengaktifkannya dengan masuk ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi komponen -&gt; ESP32-spesifik -&gt; Dukungan untuk RAM eksternal yang terhubung dengan SPI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan menekan spasi untuk mengaktifkannya. </font><font style="vertical-align: inherit;">Kami juga ingin dapat mengalokasikan memori secara eksplisit dari RAM SPI; </font><font style="vertical-align: inherit;">ini dapat diaktifkan dengan masuk ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konfigurasi RAM SPI -&gt; Metode akses RAM SPI -&gt; Jadikan RAM dapat dialokasikan menggunakan heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turunkan frekuensinya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32 bekerja secara default dengan frekuensi 160 MHz, tapi mari kita turunkan ke 80 MHz untuk melihat seberapa jauh Anda bisa pergi dengan frekuensi clock terendah. Kami ingin game bekerja dengan daya baterai, dan menurunkan frekuensi akan menghemat daya. Anda dapat mengubahnya dengan masuk ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi komponen -&gt; ESP32-spesifik -&gt; frekuensi CPU -&gt; 80MHz</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda memilih </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simpan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , file </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan disimpan ke root folder proyek </font><font style="vertical-align: inherit;">. Kita dapat menulis file ini di git, tetapi memiliki banyak parameter yang tidak penting bagi kita. Sejauh ini, kami puas dengan parameter standar, kecuali untuk yang baru saja kami ubah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat membuat file </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults sebagai gantinya</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang akan berisi nilai yang diubah di atas. </font><font style="vertical-align: inherit;">Segala sesuatu yang lain akan dikonfigurasi secara default. </font><font style="vertical-align: inherit;">Selama proses pembuatan, IDF akan membaca </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , menimpa nilai yang kita atur, dan menggunakan standar untuk semua parameter lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.default</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terlihat seperti ini:</font></font><br>
<br>
<pre><code class="cpp hljs"># Set flash size to <span class="hljs-number">16</span>MB<font></font>
CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y<font></font>
<font></font>
# Set CPU frequency to <span class="hljs-number">80</span>MHz<font></font>
CONFIG_ESP32_DEFAULT_CPU_FREQ_80=y<font></font>
<font></font>
# Enable SPI RAM <span class="hljs-keyword">and</span> allocate with heap_caps_malloc()<font></font>
CONFIG_ESP32_SPIRAM_SUPPORT=y<font></font>
CONFIG_SPIRAM_USE_CAPS_ALLOC=y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, struktur asli permainan terlihat seperti ini:</font></font><br>
<br>
<code><pre>game
├── CMakeLists.txt
├── export.sh
├── main
│   ├── CMakeLists.txt
│   └── main.c
└── sdkconfig.defaults</pre></code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bangun dan flash</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proses perakitan dan firmware itu sendiri cukup sederhana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita jalankan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to compile (untuk build paralel, tambahkan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atau </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j8</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buat flash</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk menulis gambar ke Odroid Go, dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buat monitor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk melihat output dari pernyataan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cmake hljs">make<font></font>
make flash<font></font>
make monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami juga dapat menjalankannya dalam satu baris.</font></font><br>
<br>
<pre><code class="cmake hljs">make flash monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya tidak terlalu mengesankan, tetapi itu akan menjadi dasar untuk sisa proyek.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c2/329/62f/3c232962f8e782c9220b25b7e3c0df5e.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentasi ESP-IDF: Build System</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentasi FreeRTOS: vTaskDelay</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 2: input</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita harus bisa membaca tombol yang ditekan oleh pemain dan umpan silang di Odroid Go.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tombol</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/142/ca2/106142ca2250eb9301215015b6f0bbad.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go memiliki enam tombol: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilih</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mulai</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menu</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volume</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masing-masing tombol terhubung ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pin General Purpose IO (GPIO) yang terpisah</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pin GPIO dapat digunakan sebagai input (untuk membaca) atau sebagai output (kami menulis kepada mereka). </font><font style="vertical-align: inherit;">Dalam hal tombol, kita perlu membaca. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, Anda perlu mengkonfigurasi kontak sebagai input, setelah itu kami dapat membaca statusnya. </font><font style="vertical-align: inherit;">Kontak di dalam memiliki satu dari dua tegangan (3.3V atau 0V), tetapi ketika membacanya menggunakan fungsi IDF, mereka dikonversi ke nilai integer.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inisialisasi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elemen yang ditandai sebagai </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam diagram </font><font style="vertical-align: inherit;">adalah tombol fisik itu sendiri. Ketika tidak ditekan, kontak ESP32 ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dll.) Terhubung ke 3.3 V; yaitu 3.3 V berarti bahwa tombol </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak ditekan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Logikanya di sini adalah kebalikan dari apa yang diharapkan. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memiliki resistor fisik di papan tulis. Jika tombol tidak ditekan, maka resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menarik</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kontak ke tegangan tinggi. Jika tombol ditekan, maka arus yang </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengalir</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melalui kontak ke tanah sebagai gantinya, sehingga tegangan 0 akan dibaca dari kontak. </font><strong><font style="vertical-align: inherit;">IO13</font></strong><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak memiliki resistor, karena kontak pada ESP32 memiliki resistor internal, yang kami konfigurasikan untuk mode pull-up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengetahui hal ini, kita dapat mengonfigurasi enam tombol menggunakan GPIO API.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_A = GPIO_NUM_32;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_B = GPIO_NUM_33;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_START = GPIO_NUM_39;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_SELECT = GPIO_NUM_27;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_VOLUME = GPIO_NUM_0;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_MENU = GPIO_NUM_13;<font></font>
<font></font>
<span class="hljs-keyword">gpio_config_t</span> gpioConfig = {};<font></font>
<font></font>
gpioConfig.mode = GPIO_MODE_INPUT;<font></font>
gpioConfig.pull_up_en = GPIO_PULLUP_ENABLE;<font></font>
gpioConfig.pin_bit_mask =<font></font>
	  (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_A)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_B)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_START)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_SELECT)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_VOLUME)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_MENU);<font></font>
<font></font>
ESP_ERROR_CHECK(gpio_config(&amp;gpioConfig));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konstanta yang ditentukan pada awal kode sesuai dengan masing-masing kontak sirkuit. Kami menggunakan struktur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk mengkonfigurasi masing-masing dari enam tombol sebagai input pull-up. Dalam kasus </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita perlu meminta IDF untuk mengaktifkan resistor pull-up dari kontak ini. Untuk </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita tidak perlu melakukan ini karena mereka memiliki resistor fisik, tetapi kita tetap akan melakukannya untuk membuat konfigurasi yang indah. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_ERROR_CHECK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah makro pembantu dari IDF yang secara otomatis memeriksa hasil semua fungsi yang mengembalikan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_err_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(sebagian besar IDF) dan menyatakan bahwa hasilnya tidak sama dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_OK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Makro ini nyaman digunakan untuk fungsi jika kesalahannya kritis dan setelah itu tidak masuk akal untuk melanjutkan eksekusi. </font><font style="vertical-align: inherit;">Dalam game ini, game tanpa input bukanlah game, jadi pernyataan ini benar. </font><font style="vertical-align: inherit;">Kami akan sering menggunakan makro ini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tombol membaca</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, kami mengkonfigurasi semua kontak, dan akhirnya dapat membaca nilainya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tombol angka dibaca oleh fungsi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_get_level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi kita perlu membalikkan nilai yang diterima, karena kontak ditarik ke atas, yaitu, sinyal tinggi sebenarnya berarti "tidak ditekan", dan yang rendah berarti "ditekan". </font><font style="vertical-align: inherit;">Pembalikan mempertahankan logika yang biasa: 1 berarti "ditekan", 0 - "tidak ditekan".</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> a = !gpio_get_level(BUTTON_PIN_A);
<span class="hljs-keyword">int</span> b = !gpio_get_level(BUTTON_PIN_B);
<span class="hljs-keyword">int</span> select = !gpio_get_level(BUTTON_PIN_SELECT);
<span class="hljs-keyword">int</span> start = !gpio_get_level(BUTTON_PIN_START);
<span class="hljs-keyword">int</span> menu = !gpio_get_level(BUTTON_PIN_MENU);
<span class="hljs-keyword">int</span> volume = !gpio_get_level(BUTTON_PIN_VOLUME);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crosspiece (D-pad)</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/d9e/a73/1e8d9ea7303257afd45846771726a275.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menghubungkan salib berbeda dari menghubungkan tombol. </font><font style="vertical-align: inherit;">Tombol atas dan ke bawah terhubung ke satu pin dari </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konverter analog-ke-digital (Analog-to-Digital Converter, ADC)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan tombol kiri dan kanan </font><font style="vertical-align: inherit;">terhubung </font><font style="vertical-align: inherit;">ke pin ADC lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak seperti kontak digital GPIO, yang darinya kita dapat membaca salah satu dari dua keadaan (tinggi atau rendah), ADC mengubah tegangan analog kontinu (mis., Dari 0 V ke 3,3 V) menjadi nilai numerik diskrit (mis., Dari 0 hingga 4095) ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya kira desainer Odroid Go melakukannya untuk menghemat pin GPIO (Anda hanya perlu dua pin analog alih-alih empat pin digital). </font><font style="vertical-align: inherit;">Bagaimanapun, ini sedikit mempersulit konfigurasi dan membaca dari kontak ini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kontak </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terhubung ke sumbu Y dari </font><strong><font style="vertical-align: inherit;">laba</font></strong><font style="vertical-align: inherit;"> - </font><strong><font style="vertical-align: inherit;">laba</font></strong><font style="vertical-align: inherit;"> , dan kontak </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34 terhubung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke sumbu X dari </font><strong><font style="vertical-align: inherit;">laba</font></strong><font style="vertical-align: inherit;"> - </font><strong><font style="vertical-align: inherit;">laba</font></strong><font style="vertical-align: inherit;"> . Kita melihat bahwa sambungan salib sedikit lebih rumit daripada tombol angka. Setiap sumbu memiliki dua sakelar ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk sumbu Y, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk sumbu X), yang masing-masing terhubung ke satu set resistor ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika tidak "atas" atau "bawah" ditekan, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pin IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditarik ke tanah melalui </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan kami menganggap nilai 0 V. Jika tidak "kiri" atau "kanan" ditekan, hubungi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menarik ke tanah melalui </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan kami menghitung nilainya menjadi 0 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditekan </font><strong><font style="vertical-align: inherit;">("atas")</font></strong><font style="vertical-align: inherit;"> , maka dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita menghitung 3.3 V. Jika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditekan </font><strong><font style="vertical-align: inherit;">("bawah")</font></strong><font style="vertical-align: inherit;"> , maka dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita menghitung sekitar 1, 65 V, karena setengah tegangan akan jatuh pada resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditekan </font><strong><font style="vertical-align: inherit;">("kiri")</font></strong><font style="vertical-align: inherit;"> , maka dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita menghitung 3,3 V. Jika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditekan </font><strong><font style="vertical-align: inherit;">("kanan")</font></strong><font style="vertical-align: inherit;"> , maka dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kita juga menghitung sekitar 1,65 V, karena setengah tegangan akan jatuh pada resistor </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua kasus adalah contoh </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pembagi tegangan.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ketika dua resistor pada pembagi tegangan memiliki resistansi yang sama (dalam kasus kami - 100K), maka penurunan tegangan akan menjadi setengah dari tegangan input. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengetahui hal ini, kita dapat mengonfigurasi crosspiece:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_X_AXIS = ADC1_GPIO34_CHANNEL;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_Y_AXIS = ADC1_GPIO35_CHANNEL;<font></font>
<font></font>
ESP_ERROR_CHECK(adc1_config_width(ADC_WIDTH_BIT_12));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_X_AXIS,ADC_ATTEN_DB_11));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_Y_AXIS,ADC_ATTEN_DB_11));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengatur ADC ke lebar 12 bit sehingga 0 V dibaca sebagai 0, dan 3,3 V sebagai 4095 (2 ^ 12). </font><font style="vertical-align: inherit;">Atenuasi melaporkan bahwa kita tidak perlu melemahkan sinyal sehingga kita mendapatkan rentang tegangan penuh dari 0 V hingga 3,3 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada 12 bit, kita dapat berharap bahwa jika tidak ada yang ditekan, maka 0 akan dibaca, ketika ditekan ke atas dan ke kiri - 4096, dan sekitar 2048 akan dibaca ketika ditekan ke bawah dan ke kanan (karena resistor mengurangi tegangan hingga setengahnya).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membaca silang</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Membaca salib lebih sulit daripada tombol, karena kita perlu membaca nilai mentah (dari 0 hingga 4095) dan menafsirkannya.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_POSITIVE_LEVEL = <span class="hljs-number">3072</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_NEGATIVE_LEVEL = <span class="hljs-number">1024</span>;<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadX = adc1_get_raw(DPAD_PIN_X_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadX &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Left pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadX &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Right pressed</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadY = adc1_get_raw(DPAD_PIN_Y_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadY &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Up pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadY &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Down pressed</span>
}</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_POSITIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_NEGATIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah nilai dengan margin, memastikan bahwa kami selalu membaca nilai yang benar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemilihan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada dua opsi untuk mendapatkan nilai tombol: polling atau interupsi. Kita dapat membuat fungsi pemrosesan input dan meminta IDF untuk memanggil fungsi-fungsi ini ketika tombol ditekan, atau secara manual menyurvei keadaan tombol ketika kita membutuhkannya. Perilaku yang didorong oleh interupsi membuat segalanya menjadi lebih rumit dan sulit untuk dipahami. Selain itu, saya selalu berusaha untuk membuat semuanya sesederhana mungkin. Jika perlu, kita dapat menambahkan interupsi nanti. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan membuat struktur yang akan menyimpan keadaan enam tombol dan empat arah salib. Kita dapat membuat struktur dengan 10 boolean, atau 10 int, atau 10 int tanpa tanda tangan. Namun, sebagai gantinya, kami akan membuat struktur menggunakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bidang bit</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span>
	<span class="hljs-keyword">uint16_t</span> a : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> b : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> volume : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> menu : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> select : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> start : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> left : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> right : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> up : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> down : <span class="hljs-number">1</span>;<font></font>
} Odroid_Input;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat memprogram untuk sistem desktop, bidang bit biasanya dihindari karena portingnya buruk ke mesin yang berbeda, tetapi kami memprogram untuk mesin tertentu dan kami tidak perlu khawatir tentang itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alih-alih bidang, struktur dengan 10 nilai Boolean dengan ukuran total 10 byte dapat digunakan. </font><font style="vertical-align: inherit;">Pilihan lain adalah satu </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint16_t dengan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bit shift dan bit masking macro yang dapat mengatur, </font><strong><font style="vertical-align: inherit;">menghapus</font></strong><font style="vertical-align: inherit;"> , dan memeriksa bit individual. </font><font style="vertical-align: inherit;">Itu akan berhasil, tetapi itu tidak akan sangat indah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bidang bit sederhana memungkinkan kita untuk mengambil keuntungan dari kedua pendekatan: dua byte data dan bidang bernama.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita dapat polling keadaan input di dalam loop utama dan menampilkan hasilnya.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-built_in">printf</span>(
			<span class="hljs-string">"\ra: %d  b: %d  start: %d  select: %d  vol: %d  menu: %d  up: %d  down: %d  left: %d  right: %d"</span>,<font></font>
			input.a, input.b, input.start, input.select, input.volume, input.menu,<font></font>
			input.up, input.down, input.left, input.right);<font></font>
<font></font>
		fflush(<span class="hljs-built_in">stdout</span>);<font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">250</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menggunakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk menimpa baris sebelumnya alih-alih menambahkan yang baru. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fflush</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diperlukan untuk menampilkan garis, karena dalam keadaan normal itu diatur ulang oleh karakter baris baru </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ n</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Browser Anda tidak mendukung video HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_2/media/input.mp4" type="video/mp4"></video></div></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skema Odroid pergi</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentasi ESP-IDF: ADC</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentasi ESP-IDF: GPIO</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 3: tampilan</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita harus dapat membuat piksel pada Odroid Go LCD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menampilkan warna pada layar akan lebih sulit daripada membaca status input karena LCD memiliki otak. </font><font style="vertical-align: inherit;">Layar dikendalikan oleh </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ILI9341</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - driver LCD TFT yang sangat populer pada satu chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan kata lain, kita berbicara dengan ILI9341, yang merespons perintah kita dengan mengendalikan piksel pada LCD. </font><font style="vertical-align: inherit;">Ketika saya mengatakan "layar" atau "tampilan" di bagian ini, sebenarnya saya maksudkan ILI9341. </font><font style="vertical-align: inherit;">Kami berurusan dengan ILI9341. </font><font style="vertical-align: inherit;">Ini mengontrol LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LCD terhubung ke ESP32 melalui </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI (Serial Peripheral Interface)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPI adalah protokol standar yang digunakan untuk bertukar data antar perangkat pada papan sirkuit tercetak. Ini memiliki empat sinyal: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI (Master Out Slave In)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO (Master In Slave Out)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK (Clock)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS (Pilih Chip)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satu perangkat master di bus mengoordinasikan transfer data dengan mengendalikan SCK dan CS. Mungkin ada beberapa perangkat di satu bus, masing-masing akan memiliki sinyal CS sendiri. Ketika sinyal CS pada perangkat ini diaktifkan, ia dapat mengirim dan menerima data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32 akan menjadi master SPI (master), dan LCD akan menjadi budak SPI. </font><font style="vertical-align: inherit;">Kita perlu mengkonfigurasi bus SPI dengan parameter yang diperlukan dan menambahkan layar LCD ke bus dengan mengkonfigurasi kontak yang sesuai.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bc/60e/18c/7bc60e18c1b066ba7c22756464f92512.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f12/463/615/f124636158029efeab3259f299a2af36.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nama-nama </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSPI.XXXX</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hanya label untuk kontak dalam diagram, tetapi kita dapat melalui kontak sendiri dengan melihat bagian-bagian dari diagram LCD dan ESP32.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MOSI -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO23</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MISO -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO19</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.SCK -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO18</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.CS0 -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO5</font></font></strong></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami juga memiliki </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO14</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang merupakan pin GPIO yang digunakan untuk menyalakan lampu latar, dan juga </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO21</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang terhubung ke pin </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pada </font><font style="vertical-align: inherit;">LCD. Kontak ini mengontrol jenis informasi yang kami kirimkan ke layar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, konfigurasikan bus SPI.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MISO = GPIO_NUM_19;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MOSI = GPIO_NUM_23;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_SCLK = GPIO_NUM_18;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_CS = GPIO_NUM_5;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_DC = GPIO_NUM_21;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_BACKLIGHT = GPIO_NUM_14;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_WIDTH = <span class="hljs-number">320</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_HEIGHT = <span class="hljs-number">240</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_DEPTH = <span class="hljs-number">2</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">spi_bus_config_t</span> spiBusConfig = {};<font></font>
spiBusConfig.miso_io_num = LCD_PIN_MISO;<font></font>
spiBusConfig.mosi_io_num = LCD_PIN_MOSI;<font></font>
spiBusConfig.sclk_io_num = LCD_PIN_SCLK;<font></font>
spiBusConfig.quadwp_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span>
spiBusConfig.quadhd_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span><font></font>
spiBusConfig.max_transfer_sz = LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_initialize(VSPI_HOST, &amp;spiBusConfig, <span class="hljs-number">1</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengkonfigurasi bus menggunakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_bus_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Penting untuk mengomunikasikan kontak yang kami gunakan dan ukuran maksimum satu transfer data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk saat ini, kami akan melakukan satu transmisi SPI untuk semua data buffer bingkai, yang sama dengan lebar LCD (dalam piksel) kali tinggi (dalam piksel) dikalikan jumlah byte per piksel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebar adalah 320, tingginya 240, dan kedalaman warna 2 byte (tampilan mengharapkan warna pixel menjadi 16 bit).</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">spi_handle_t</span> gSpiHandle;<font></font>
<font></font>
<span class="hljs-keyword">spi_device_interface_config_t</span> spiDeviceConfig = {};<font></font>
spiDeviceConfig.clock_speed_hz = SPI_MASTER_FREQ_40M;<font></font>
spiDeviceConfig.spics_io_num = LCD_PIN_CS;<font></font>
spiDeviceConfig.queue_size = <span class="hljs-number">1</span>;<font></font>
spiDeviceConfig.flags = SPI_DEVICE_NO_DUMMY;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_add_device(VSPI_HOST, &amp;spiDeviceConfig, &amp;gSpiHandle));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menginisialisasi bus, kita perlu menambahkan perangkat LCD ke bus sehingga kita dapat mulai berbicara dengannya.</font></font><br>
<br>
<ul>
<li><strong>clock_speed_hz</strong> —   - ,      SPI   40 ,     .        80 ,         .</li>
<li><strong>spics_io_num</strong> —    CS,  IDF     CS,        ( SD-     SPI).</li>
<li><strong>queue_size</strong> —     1,           (  ).</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flags</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - driver IDF SPI biasanya memasukkan bit kosong dalam transmisi untuk menghindari masalah waktu selama membaca dari perangkat SPI, tetapi kami melakukan transmisi satu arah (kami tidak akan membaca dari tampilan). </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_DEVICE_NO_DUMMY</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melaporkan bahwa kami mengonfirmasi transmisi satu arah ini dan kami tidak perlu memasukkan bit kosong.</font></font></li>
</ul><br>
<br>
<pre><code class="cpp hljs">gpio_set_direction(LCD_PIN_DC, GPIO_MODE_OUTPUT);<font></font>
gpio_set_direction(LCD_PIN_BACKLIGHT, GPIO_MODE_OUTPUT);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita juga perlu mengatur </font><font style="vertical-align: inherit;">pin </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan backlight sebagai pin GPIO. </font><font style="vertical-align: inherit;">Setelah beralih </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lampu latar akan terus menyala.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tim</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komunikasi dengan LCD adalah dalam bentuk perintah. </font><font style="vertical-align: inherit;">Pertama, kita melewatkan byte yang menunjukkan perintah yang ingin kita kirim, dan kemudian kita meneruskan parameter perintah (jika ada). </font><font style="vertical-align: inherit;">Layar mengerti bahwa byte adalah perintah jika </font><font style="vertical-align: inherit;">sinyal </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rendah. </font><font style="vertical-align: inherit;">Jika </font><font style="vertical-align: inherit;">sinyal </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tinggi, maka data yang diterima akan dianggap sebagai parameter dari perintah yang dikirimkan sebelumnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, alirannya terlihat seperti ini:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memberikan </font><font style="vertical-align: inherit;">sinyal rendah </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengirim satu byte dari perintah</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memberikan </font><font style="vertical-align: inherit;">sinyal tinggi </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kirim nol atau lebih byte, tergantung pada persyaratan perintah</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ulangi langkah 1-4</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini sahabat kami adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spesifikasi ILI9341</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini mencantumkan semua perintah yang mungkin, parameternya dan cara menggunakannya.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68d/8d8/09c/68d8d809ceb9446142cd5c77bb78d0e2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh perintah tanpa parameter adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tampilan ON</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Byte perintah adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x29</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi tidak ada parameter yang ditentukan untuk itu.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35a/4e0/446/35a4e04466c22aa6746fe441f345c02f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh perintah dengan parameter adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set Alamat Kolom</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Byte perintah adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi empat parameter yang diperlukan ditentukan untuk itu. </font><font style="vertical-align: inherit;">Untuk menggunakan perintah, Anda perlu mengirim </font><font style="vertical-align: inherit;">sinyal rendah </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mengirim </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mengirim </font><font style="vertical-align: inherit;">sinyal tinggi </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan kemudian mentransfer byte dari empat parameter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode perintah itu sendiri ditentukan dalam enumerasi.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span><font></font>
{<font></font>
	SOFTWARE_RESET = <span class="hljs-number">0x01</span>u,<font></font>
	SLEEP_OUT = <span class="hljs-number">0x11</span>u,<font></font>
	DISPLAY_ON = <span class="hljs-number">0x29</span>u,<font></font>
	COLUMN_ADDRESS_SET = <span class="hljs-number">0x2A</span>u,<font></font>
	PAGE_ADDRESS_SET = <span class="hljs-number">0x2B</span>u,<font></font>
	MEMORY_WRITE = <span class="hljs-number">0x2C</span>u,<font></font>
	MEMORY_ACCESS_CONTROL = <span class="hljs-number">0x36</span>u,<font></font>
	PIXEL_FORMAT_SET = <span class="hljs-number">0x3A</span>u,<font></font>
} CommandCode;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai gantinya, kami dapat menggunakan makro ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define SOFTWARE_RESET (0x01u)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), tetapi mereka tidak memiliki simbol di debugger dan mereka tidak memiliki cakupan. </font><font style="vertical-align: inherit;">Mungkin juga untuk menggunakan konstanta statis bilangan bulat, seperti yang kami lakukan dengan kontak GPIO, tetapi berkat enum, sekilas kami dapat memahami data apa yang diteruskan ke fungsi atau anggota struktur: mereka bertipe </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandCode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kalau tidak, bisa jadi ini adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint8_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mentah </font><font style="vertical-align: inherit;">yang tidak </font><strong><font style="vertical-align: inherit;">memberitahukan</font></strong><font style="vertical-align: inherit;"> apa pun kepada programmer yang membaca kode.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meluncurkan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama inisialisasi, kita dapat melewati perintah yang berbeda untuk dapat menggambar sesuatu. </font><font style="vertical-align: inherit;">Setiap perintah memiliki byte perintah, yang akan kita sebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode Perintah</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menentukan struktur untuk menyimpan perintah peluncuran sehingga Anda dapat menentukan larik mereka.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span><font></font>
	CommandCode code;<font></font>
	<span class="hljs-keyword">uint8_t</span> parameters[<span class="hljs-number">15</span>];
	<span class="hljs-keyword">uint8_t</span> length;<font></font>
} StartupCommand;</code></pre><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font><strong><font style="vertical-align: inherit;">kode</font></strong><font style="vertical-align: inherit;"> perintah.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah larik parameter perintah (jika ada). </font><font style="vertical-align: inherit;">Ini adalah array statis ukuran 15, karena ini adalah jumlah maksimum parameter yang kita butuhkan. </font><font style="vertical-align: inherit;">Karena sifat statis array, kami tidak perlu khawatir mengalokasikan array dinamis untuk setiap perintah setiap waktu.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">panjang</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah jumlah parameter dalam array </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan menggunakan struktur ini, kita dapat menentukan daftar perintah peluncuran.</font></font><br>
<br>
<pre><code class="cpp hljs">StartupCommand gStartupCommands[] =<font></font>
{<font></font>
	<span class="hljs-comment">// Reset to defaults</span><font></font>
	{<font></font>
		SOFTWARE_RESET,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Landscape Mode</span>
	<span class="hljs-comment">// Top-Left Origin</span>
	<span class="hljs-comment">// BGR Panel</span><font></font>
	{<font></font>
		MEMORY_ACCESS_CONTROL,<font></font>
		{<span class="hljs-number">0x20</span> | <span class="hljs-number">0xC0</span> | <span class="hljs-number">0x08</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// 16 bits per pixel</span><font></font>
	{<font></font>
		PIXEL_FORMAT_SET,<font></font>
		{<span class="hljs-number">0x55</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Exit sleep mode</span><font></font>
	{<font></font>
		SLEEP_OUT,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Turn on the display</span><font></font>
	{<font></font>
		DISPLAY_ON,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perintah tanpa parameter, misalnya, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOFTWARE_RESET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , atur daftar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initializer menjadi </font><font style="vertical-align: inherit;">kosong (yaitu, dengan satu nol) dan panjangnya diatur ke 0. Perintah dengan parameter mengisi parameter dan tentukan panjang. </font><font style="vertical-align: inherit;">Akan lebih bagus jika kita dapat menetapkan panjang secara otomatis dan tidak menulis angka (jika kita membuat kesalahan atau parameternya berubah), tapi saya tidak berpikir itu sepadan dengan masalahnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuan sebagian besar tim jelas dari namanya, dengan pengecualian dua. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_ACCESS_CONTROL</font></font></strong><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mode Lansekap:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Secara default, tampilan menggunakan orientasi potret (240x320), tetapi kami ingin menggunakan lansekap (320x240).</font></font></li>
<li><strong>Top-Left Origin:</strong>      (0,0)     ,    ( )         .</li>
<li><strong>BGR Panel:</strong>  ,        BGR.   ,    , ,   ,     .</li>
</ul><br>
<strong>PIXEL_FORMAT_SET</strong><br>
<br>
<ul>
<li><strong>16 bits per pixel:</strong>   16- .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak perintah lain yang dapat dikirim saat startup untuk mengontrol berbagai aspek, seperti gamma. Parameter yang diperlukan dijelaskan dalam spesifikasi LCD itu sendiri (dan bukan pengontrol ILI9341), yang tidak dapat diakses oleh kami. Jika kami tidak mengirimkan perintah ini, maka pengaturan tampilan default digunakan, yang sangat cocok untuk kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menyiapkan berbagai perintah peluncuran, kita dapat mulai mentransfernya ke layar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kita membutuhkan fungsi yang mengirim satu byte perintah ke layar. Jangan lupa bahwa perintah pengiriman berbeda dengan mengirim parameter, karena kita perlu mengirim </font><font style="vertical-align: inherit;">sinyal rendah </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BYTES_TO_BITS(value) ( (value) * 8 )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandCode</span><span class="hljs-params">(CommandCode code)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(<span class="hljs-number">1</span>);<font></font>
	transaction.tx_data[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">uint8_t</span>)code;<font></font>
	transaction.flags = SPI_TRANS_USE_TXDATA;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">0</span>);<font></font>
	spi_device_transmit(gSpiHandle, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDF memiliki struktur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_transaction</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang kami isi ketika kami ingin mentransfer sesuatu melalui bus SPI. Kita tahu berapa banyak bit payload-nya dan mentransfer beban itu sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita dapat meneruskan pointer ke payload, atau menggunakan </font><font style="vertical-align: inherit;">struktur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> struct internal </font><font style="vertical-align: inherit;">, yang hanya berukuran empat byte, tetapi menyimpan driver dari keharusan mengakses memori eksternal. Jika kita menggunakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kita harus mengatur flag </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum mengirimkan data, kami mengirim </font><font style="vertical-align: inherit;">sinyal rendah </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , menunjukkan bahwa ini adalah kode perintah.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandParameters</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* data, <span class="hljs-keyword">int</span> length)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(length);<font></font>
	transaction.tx_buffer = data;<font></font>
	transaction.flags = <span class="hljs-number">0</span>;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">1</span>);<font></font>
	spi_device_transmit(SPIHANDLE, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Melewati parameter mirip dengan mengirim perintah, hanya kali ini kami menggunakan buffer ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">kami sendiri </font><font style="vertical-align: inherit;">dan mengirimkan </font><font style="vertical-align: inherit;">sinyal tinggi </font><font style="vertical-align: inherit;">ke </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk memberi tahu tampilan bahwa parameter sedang dikirim. </font><font style="vertical-align: inherit;">Selain itu, kami tidak menetapkan flag </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> karena kami melewati buffer kami sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian Anda dapat mengirim semua perintah peluncuran.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ARRAY_COUNT(value) ( sizeof(value) / sizeof(value[0]) )</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> commandCount = ARRAY_COUNT(gStartupCommands);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> commandIndex = <span class="hljs-number">0</span>; commandIndex &lt; commandCount; ++commandIndex)<font></font>
{<font></font>
	StartupCommand* command = &amp;gStartupCommands[commandIndex];<font></font>
<font></font>
	SendCommandCode(command-&gt;code);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (command-&gt;length &gt; <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		SendCommandData(command-&gt;parameters, command-&gt;length);<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami berulang-ulang melintasi larik perintah peluncuran, melewati kode perintah terlebih dahulu, dan kemudian parameter (jika ada).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gambar bingkai</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menginisialisasi tampilan, Anda dapat mulai menggambar di atasnya.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UPPER_BYTE_16(value) ( (value) &gt;&gt; 8u )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOWER_BYTE_16(value) ( (value) &amp; 0xFFu )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Odroid_DrawFrame</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* buffer)</span>
</span>{
	<span class="hljs-comment">// Set drawing window width to (0, LCD_WIDTH)</span>
    <span class="hljs-keyword">uint8_t</span> drawWidth[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_WIDTH), LOWER_BYTE_16(LCD_WIDTH) };<font></font>
	SendCommandCode(COLUMN_ADDRESS_SET);<font></font>
	SendCommandParameters(drawWidth, ARRAY_COUNT(drawWidth));<font></font>
<font></font>
	<span class="hljs-comment">// Set drawing window height to (0, LCD_HEIGHT)</span>
    <span class="hljs-keyword">uint8_t</span> drawHeight[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_HEIGHT), LOWER_BYTE_16(LCD_HEIGHT) };<font></font>
	SendCommandCode(PAGE_ADDRESS_SET);<font></font>
	SendCommandParameters(drawHeight, ARRAY_COUNT(drawHeight));<font></font>
<font></font>
	<span class="hljs-comment">// Send the buffer to the display</span><font></font>
	SendCommandCode(MEMORY_WRITE);<font></font>
	SendCommandParameters(buffer, LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341 memiliki kemampuan untuk menggambar ulang setiap bagian layar. Ini mungkin berguna di masa depan jika kita melihat penurunan dalam frame rate. Dalam hal ini, akan mungkin untuk memperbarui hanya bagian yang diubah dari layar, tetapi untuk saat ini kami hanya akan menggambar ulang seluruh layar lagi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk membuat bingkai, itu membutuhkan pengaturan jendela render. Untuk melakukan ini, kirim perintah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLUMN_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan lebar jendela dan perintah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAGE_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan tinggi jendela. Setiap perintah membutuhkan empat byte parameter yang menggambarkan jendela tempat kita akan melakukan rendering. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPPER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOWER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ini adalah makro bantu untuk mengekstraksi byte tinggi dan rendah dari nilai 16-bit. </font><font style="vertical-align: inherit;">Parameter dari perintah ini mengharuskan kita untuk membagi nilai 16-bit menjadi dua nilai 8-bit, itulah sebabnya kami melakukan ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rendering dimulai oleh perintah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_WRITE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan mengirim ke layar semua </font><strong><font style="vertical-align: inherit;">153.600</font></strong><font style="vertical-align: inherit;"> byte frame buffer sekaligus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada cara lain untuk mentransfer frame buffer ke tampilan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami dapat membuat tugas FreeRTOS lain (tugas), yang bertanggung jawab untuk mengoordinasikan transaksi SPI.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat mentransfer bingkai bukan dalam satu, tetapi dalam beberapa transaksi.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat menggunakan transmisi non-pemblokiran, di mana kami memulai pengiriman, dan kemudian melanjutkan untuk melakukan operasi lain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat menggunakan kombinasi metode di atas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk saat ini, kami akan menggunakan cara paling sederhana: satu-satunya transaksi pemblokiran. </font><font style="vertical-align: inherit;">Ketika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DrawFrame</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dipanggil, </font><font style="vertical-align: inherit;">transfer ke layar dimulai dan tugas kami dijeda hingga transfer selesai. </font><font style="vertical-align: inherit;">Jika nanti kita mengetahui bahwa kita tidak dapat mencapai frame rate yang baik dengan metode ini, maka kita akan kembali ke masalah ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565 dan urutan byte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampilan khas (misalnya, monitor komputer Anda) memiliki kedalaman 24 bit (1,6 juta warna): 8 bit per merah, hijau, dan biru. Pixel ditulis ke memori sebagai </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRRRRGGGGGGGGGBGBBBBBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LCD Odroid memiliki kedalaman 16 bit (65 ribu warna): 5 bit merah, 6 bit hijau dan 5 bit biru. Pixel ditulis ke memori sebagai </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRGGGGGGGBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Format ini disebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAP_ENDIAN_16(value) ( (((value) &amp; 0xFFu) <span class="hljs-meta-string">&lt;&lt; 8u) | ((value) &gt;&gt; 8u)  )</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RGB565(red, green, blue) ( SWAP_ENDIAN_16( ((red) &lt;&lt; 11u) | ((green) &lt;&lt; 5u) | (blue) ) )</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentukan makro yang menciptakan warna dalam format RGB565. Kami akan memberinya byte merah, byte hijau dan byte biru. Dia akan mengambil lima bit paling signifikan dari merah, enam bit paling signifikan dari hijau dan lima bit paling signifikan dari biru. Kami memilih bit tinggi karena mengandung lebih banyak informasi daripada bit rendah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, ESP32 menyimpan data dalam urutan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Little Endian</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yaitu byte paling signifikan disimpan di alamat memori yang lebih rendah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, nilai 32-bit </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xDE 0xAD 0xBE 0xEF]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan disimpan dalam memori sebagai </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xEF 0xBE 0xAD 0xDE]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Saat mentransfer data ke layar, ini menjadi masalah karena byte paling signifikan akan dikirim terlebih dahulu, dan LCD mengharapkan untuk menerima byte paling signifikan terlebih dahulu. </font><strong><font style="vertical-align: inherit;">Setel SWAP_ENDIAN_16</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
makro</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk menukar byte dan menggunakannya dalam makro </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut adalah bagaimana masing-masing dari tiga warna utama dijelaskan dalam RGB565 dan bagaimana mereka disimpan dalam memori ESP32 jika Anda tidak mengubah urutan byte. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merah</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
11111 | 000000 | 00000? -&gt; 11111000 00000000 -&gt; 00000000 11111000 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hijau</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 111111 | 00000? -&gt; 00000111 11100000 -&gt; 11100000 00000111 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biru</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 000000 | 11111? -&gt; 00000000 00011111 -&gt; 0001111000000</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami dapat membuat demo sederhana untuk menonton LCD beraksi. </font><font style="vertical-align: inherit;">Pada awal bingkai, flush buffer frame menjadi hitam dan menggambar persegi 50x50. </font><font style="vertical-align: inherit;">Kita dapat memindahkan kotak dengan tanda silang dan mengubah warnanya dengan tombol </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mulai</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
	Odroid_InitializeDisplay();<font></font>
<font></font>
	ESP_LOGI(LOG_TAG, <span class="hljs-string">"Odroid initialization complete - entering main loop"</span>);<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span>* framebuffer = (<span class="hljs-keyword">uint16_t</span>*)heap_caps_malloc(<span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
	assert(framebuffer);<font></font>
<font></font>
	<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> y = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span> color = <span class="hljs-number">0xffff</span>;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">memset</span>(framebuffer, <span class="hljs-number">0</span>, <span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>);<font></font>
<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.left) { x -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.right) { x += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.up) { y -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.down) { y += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.a) { color = RGB565(<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.b) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.start) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>); }<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = y; row &lt; y + <span class="hljs-number">50</span>; ++row)<font></font>
		{<font></font>
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = x; col &lt; x + <span class="hljs-number">50</span>; ++col)<font></font>
			{<font></font>
				framebuffer[<span class="hljs-number">320</span> * row + col] = color;<font></font>
			}<font></font>
		}<font></font>
<font></font>
		Odroid_DrawFrame(framebuffer);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengalokasikan buffer bingkai sesuai dengan ukuran penuh tampilan: 320 x 240, dua byte per piksel (warna 16-bit). </font><font style="vertical-align: inherit;">Kami menggunakan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sehingga dialokasikan dalam memori, yang dapat digunakan untuk transaksi SPI dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct Memory Access (DMA)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">DMA memungkinkan periferal SPI untuk mengakses frame buffer tanpa perlu keterlibatan CPU. </font><font style="vertical-align: inherit;">Tanpa DMA, transaksi SPI membutuhkan waktu lebih lama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami tidak melakukan pemeriksaan untuk memastikan bahwa rendering tidak terjadi di luar batas layar.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Browser Anda tidak mendukung video HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_3/media/demo.mp4" type="video/mp4"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Robekan yang kuat terlihat. Dalam aplikasi desktop, cara standar untuk menghilangkan robekan adalah dengan menggunakan beberapa buffer. Misalnya, ketika buffering ganda, ada dua buffer: buffer depan dan belakang. Saat buffer depan ditampilkan, perekaman dilakukan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
di belakang. Kemudian mereka mengubah tempat dan proses berulang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32 tidak memiliki RAM yang cukup dengan kemampuan DMA untuk menyimpan dua frame buffer (4 MB RAM SPI eksternal, sayangnya, tidak memiliki kemampuan DMA), jadi opsi ini tidak cocok. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341 memiliki sinyal ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) yang memberi tahu Anda ketika </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VBLANK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terjadi </font><strong><font style="vertical-align: inherit;">sehingga</font></strong><font style="vertical-align: inherit;"> kami dapat menulis ke layar sampai gambar itu diambil. Tetapi dengan Odroid (atau modul tampilan) sinyal ini tidak terhubung, jadi kami tidak dapat mengaksesnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mungkin kita dapat menemukan nilai yang layak, tetapi untuk saat ini kita tidak akan melakukannya, karena sekarang tugas kita hanyalah menampilkan piksel pada layar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua kode sumber dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skema Odroid pergi</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pergi bermain</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentasi ESP-IDF: Master SPI</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembar Data Driver LCD</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id502518/index.html">Cara memanjat pohon</a></li>
<li><a href="../id502520/index.html">Laporan video dari laporan mitap tentang analitik produk</a></li>
<li><a href="../id502522/index.html">Kami membuka chip isolasi galvanik dengan transformator kecil di dalamnya</a></li>
<li><a href="../id502524/index.html">Psikos membuat peradaban</a></li>
<li><a href="../id502526/index.html">JUG Ru Group # 2 Streaming Minggu Online</a></li>
<li><a href="../id502532/index.html">Revolusi di departemen TI (departemen). Apakah itu perlu?</a></li>
<li><a href="../id502536/index.html">Tayangan pertama dan fitur utama MIUI 12</a></li>
<li><a href="../id502538/index.html">Cara membuat versi lama NGINX Ingress Controller dan menambalnya</a></li>
<li><a href="../id502540/index.html">Alpine.js - terus berkencan</a></li>
<li><a href="../id502542/index.html">Bagaimana kami mengajar Yandex untuk menjawab pertanyaan dan menghemat pengguna 20 ribu jam sehari</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>