<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>❓ 😛 🧑🏿‍🤝‍🧑🏽 Rustの非同期：標準ライブラリとasync / .await 🧑🏿‍🤝‍🧑🏿 👨🏼‍⚕️ 👩🏾‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 

これは、Rustの非同期プログラミングの詳細へのガイドです。ライブラリのエコシステムへの入り口であり、システムを設計して重要なタスクを解決するときに信頼できるリファレンスです。読書には、このうさぎの穴に突入することを決めた、Rustの経験豊富な開発者と初心者の両方をお勧めします。
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rustの非同期：標準ライブラリとasync / .await</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504020/"><p><img src="https://habrastorage.org/webt/bb/of/xl/bbofxlb7l5mmqv_ejwfybdcogvs.png"></p><br>
<h1 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の非同期プログラミングの詳細へのガイド</font><font style="vertical-align: inherit;">です。ライブラリのエコシステムへの入り口であり、システムを設計して重要なタスクを解決するときに信頼できるリファレンスです。</font><font style="vertical-align: inherit;">読書には、このうさぎの穴に突入することを決めた、Rustの経験豊富な開発者と初心者の両方をお勧めします。</font></font></p><br>
<p>         ,     ,       Rust,     -    , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  .</p><br>
<p>   API          <code>async/.await</code>.</p><a name="habracut"></a><br>
<hr><br>
<h1 id="teoriya"></h1><br>
<p>     .       ( ):</p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Programming Paradigms for Dummies: What Every Programmer Should Know"</a></li>
<li><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">":   "</a></li>
</ol></li>
<li>Wikipedia<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Asynchronous I/O"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Event Loop"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Reactor pattern"</a> &amp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Proactor pattern"</a></li>
</ol></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"The C10K problem"</a></li>
</ol><br>
<hr><br>
<h1 id="std">std</h1><br>
<p>        ,   —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>std::task</code></a>.            (   — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Tokio</a>,       ),           .</p><br>
<p> ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>   <em></em>   ,  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>   <em></em>     (  , , ).  ,   ,        (  , ),        (  /).</p><br>
<p>      :</p><br>
<p><img src="https://habrastorage.org/webt/ur/pb/wn/urpbwninp--k2l9byrhwvno6syw.png"></p><br>
<p>  <code>poll</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>;        ( , ),  ,   ,          (,  ).  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,     , ,  ,        .      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Tokio</a>.</p><br>
<p><img src="https://habrastorage.org/webt/rd/yc/0q/rdyc0qi1f5nbmbn7kje8tn-zk_o.png"></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><ul>
<li>          , ..        ,      .</li>
<li>    "",  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,     , , .</li>
</ul></div>
                    </div><br>
<p>   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>    <code>poll</code>,   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Poll::Ready(Output)</code></a>:   ,         .  ,   ,  (  ,    ),     ,     <code>poll</code>   <code>unsafe</code>  .      ,   .</p><br>
<p> ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>, — ,  ,   (, ).      ,   ,   ,  ,     ,      .    —  ( ) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,        Rust — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>.</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Waker</code></a>.      .</p><br>
<hr><br>
<h1 id="writefuture">WriteFuture</h1><br>
<p>       <code>WriteFuture</code>,    ,       TCP .</p><br>
<p>[<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://gist.github.com/2f2040d1639bebf723924a73aaa262e7</a>]</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">use</span> std::{<font></font>
    future::Future,<font></font>
    io::{<span class="hljs-keyword">self</span>, Read, Write},<font></font>
    net::{TcpListener, TcpStream},<font></font>
    pin::Pin,<font></font>
    task::{Context, Poll},<font></font>
    thread::{<span class="hljs-keyword">self</span>, JoinHandle},<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">use</span> tokio::runtime::Runtime;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">WriteFuture</span></span>&lt;<span class="hljs-symbol">'a</span>&gt; {<font></font>
    socket: TcpStream,<font></font>
    data: &amp;<span class="hljs-symbol">'a</span> [<span class="hljs-built_in">u8</span>],<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; WriteFuture&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-meta">#[allow(dead_code)]</span>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(socket: TcpStream, data: &amp;<span class="hljs-symbol">'a</span> [<span class="hljs-built_in">u8</span>]) -&gt; <span class="hljs-keyword">Self</span> {<font></font>
        socket.set_nonblocking(<span class="hljs-literal">true</span>).unwrap();
        <span class="hljs-keyword">Self</span> { socket, data }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span> Future <span class="hljs-keyword">for</span> WriteFuture&lt;<span class="hljs-symbol">'_</span>&gt; {
    <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Output</span></span> = io::<span class="hljs-built_in">Result</span>&lt;<span class="hljs-built_in">usize</span>&gt;;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll</span></span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>&gt;, cx: &amp;<span class="hljs-keyword">mut</span> Context) -&gt; Poll&lt;Self::Output&gt; {
        <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">self</span>.data;<font></font>
<font></font>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.socket.write(data) {
            <span class="hljs-literal">Ok</span>(length) =&gt; Poll::Ready(<span class="hljs-literal">Ok</span>(length)),
            <span class="hljs-literal">Err</span>(err) <span class="hljs-keyword">if</span> err.kind() == io::ErrorKind::WouldBlock =&gt; {<font></font>
                cx.waker().wake_by_ref();<font></font>
                Poll::Pending<font></font>
            }<font></font>
            <span class="hljs-literal">Err</span>(err) =&gt; Poll::Ready(<span class="hljs-literal">Err</span>(err)),<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> server = run_server();
    <span class="hljs-keyword">let</span> client = run_client();<font></font>
<font></font>
    server.join().unwrap();<font></font>
    client.join().unwrap();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> ADDR: &amp;<span class="hljs-symbol">'static</span> <span class="hljs-built_in">str</span> = <span class="hljs-string">"127.0.0.1:18373"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run_server</span></span>() -&gt; JoinHandle&lt;()&gt; {<font></font>
    thread::spawn(|| {<font></font>
        <span class="hljs-keyword">let</span> listener = TcpListener::bind(ADDR).unwrap();<font></font>
<font></font>
        <span class="hljs-keyword">let</span> (<span class="hljs-keyword">mut</span> client_accepted, _addr) = listener.accept().unwrap();<font></font>
<font></font>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> message = <span class="hljs-built_in">String</span>::new();<font></font>
        client_accepted.read_to_string(&amp;<span class="hljs-keyword">mut</span> message).unwrap();<font></font>
        dbg!(message);<font></font>
    })<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run_client</span></span>() -&gt; JoinHandle&lt;()&gt; {<font></font>
    thread::spawn(|| {<font></font>
        <span class="hljs-keyword">let</span> client = TcpStream::connect(ADDR).unwrap();<font></font>
<font></font>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> rt = Runtime::new().unwrap();<font></font>
        rt.block_on(WriteFuture::new(client, <span class="hljs-string">b"Hello, world!"</span>)).unwrap();<font></font>
    })<font></font>
}</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><p> <code>WriteFuture</code>    :     <code>self.socket.write(data)</code>        <code>WriteFuture::poll</code>.    —   .</p></div>
                    </div><br>
<p>:</p><br>
<pre><code class="plaintext hljs">[src/main.rs:60] message = "Hello, world!"</code></pre><br>
<p>   <code>WriteFuture::poll</code>.      <code>self.socket.write(data)</code>:</p><br>
<ul>
<li><p><strong> .</strong>   ,  <code>Poll::Ready(Ok(length))</code>.     .</p><br>
</li>
<li><p><strong> .</strong>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>io::ErrorKind::WouldBlock</code></a>.  ,       ,       .       ,         ,   .</p><br>
</li>
<li><p><strong> .</strong>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>io::ErrorKind::WouldBlock</code></a>.     ,  .      ,      .</p><br>
</li>
</ul><br>
<p>      ,          ,    .     ,        ,   ,   .</p><br>
<p><img src="https://habrastorage.org/webt/xa/vz/lm/xavzlmlk1gv1iio1nh5ofkmydyw.png"></p><br>
<p>-       (),     <code>poll</code>, , ,     ,  "". <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Waker</code></a> —       :   .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>.wake_by_ref()</code></a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>.wake()</code></a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Waker</code></a>,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>cx.waker()</code></a>.</p><br>
<p> ,       poll    ,         <code>poll</code>  .            , , ,     (   )   /    ,      (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">epoll</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">kqueue</a>, ...)   .</p><br>
<p>           ;      . ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a> ( -   )     ,           .</p><br>
<p> <code>fn run_client</code>     <code>WriteFuture</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> rt = Runtime::new().unwrap();<font></font>
rt.block_on(WriteFuture::new(client, <span class="hljs-string">b"Hello, world!"</span>));</code></pre><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code> Tokio</code></a>,       (,   <code>fn run_client</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>thread::spawn</code></a>)    ,   <code>WriteFuture</code>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>block_on</code></a> —     ,   ,     (    ).</p><br>
<hr><br>
<h1 id="asyncawait">async/.await</h1><br>
<p>   ,        ,           ?     , , /  / ,    /   ,      .</p><br>
<p>    :</p><br>
<ol>
<li>       [<code>Future::poll</code>];</li>
<li>;</li>
<li> <code>async</code>/<code>.await</code>.</li>
</ol><br>
<h2 id="variant-1-ruchnoe-upravlenie"> №1 ( )</h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="rust hljs"><span class="hljs-keyword">use</span> std::{<font></font>
    future::Future,<font></font>
    ops::AddAssign,<font></font>
    pin::Pin,<font></font>
    task::{Context, Poll},<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">use</span> pin_project::pin_project;<font></font>
<font></font>
<span class="hljs-meta">#[pin_project]</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CompoundFuture</span></span>&lt;Fut1, Fut2, Fut3, F, U&gt; {<font></font>
    fut1: <span class="hljs-built_in">Option</span>&lt;Fut1&gt;,<font></font>
    fut2: <span class="hljs-built_in">Option</span>&lt;Fut2&gt;,<font></font>
    fut3: Fut3,<font></font>
    f: F,<font></font>
    result: <span class="hljs-built_in">Option</span>&lt;U&gt;,<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span>&lt;Fut1, Fut2, Fut3, F, U, T&gt; CompoundFuture&lt;Fut1, Fut2, Fut3, F, U&gt;
<span class="hljs-keyword">where</span><font></font>
    Fut1: Future&lt;Output = T&gt;,<font></font>
    Fut2: Future&lt;Output = T&gt;,<font></font>
    Fut3: Future&lt;Output = T&gt;,<font></font>
    F: <span class="hljs-built_in">FnMut</span>(T) -&gt; U,<font></font>
{<font></font>
    <span class="hljs-meta">#[allow(dead_code)]</span>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(fut1: Fut1, fut2: Fut2, fut3: Fut3, f: F) -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {<font></font>
            fut1: <span class="hljs-literal">Some</span>(fut1),<font></font>
            fut2: <span class="hljs-literal">Some</span>(fut2),<font></font>
            fut3,<font></font>
            f,<font></font>
            result: <span class="hljs-literal">None</span>,<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span>&lt;Fut1, Fut2, Fut3, F, T, U&gt; Future <span class="hljs-keyword">for</span> CompoundFuture&lt;Fut1, Fut2, Fut3, F, U&gt;
<span class="hljs-keyword">where</span><font></font>
    Fut1: Future&lt;Output = T&gt;,<font></font>
    Fut2: Future&lt;Output = T&gt;,<font></font>
    Fut3: Future&lt;Output = T&gt;,<font></font>
    F: <span class="hljs-built_in">FnMut</span>(T) -&gt; U,<font></font>
    U: AddAssign,<font></font>
{<font></font>
    <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Output</span></span> = U;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll</span></span>(<span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>&gt;, cx: &amp;<span class="hljs-keyword">mut</span> Context) -&gt; Poll&lt;Self::Output&gt; {
        <span class="hljs-keyword">let</span> this = <span class="hljs-keyword">self</span>.project();<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(fut1) = this.fut1 {
            <span class="hljs-comment">// SAFETY: Pin::new_unchecked is safe because</span>
            <span class="hljs-comment">// we won't move fut1 (fut2, fut3)</span>
            <span class="hljs-keyword">match</span> <span class="hljs-keyword">unsafe</span> { Pin::new_unchecked(fut1) }.poll(cx) {<font></font>
                Poll::Pending =&gt; <span class="hljs-keyword">return</span> Poll::Pending,<font></font>
                Poll::Ready(x) =&gt; {<font></font>
                    *this.result = <span class="hljs-literal">Some</span>((this.f)(x));<font></font>
                    *this.fut1 = <span class="hljs-literal">None</span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(fut2) = this.fut2 {
            <span class="hljs-keyword">match</span> <span class="hljs-keyword">unsafe</span> { Pin::new_unchecked(fut2) }.poll(cx) {<font></font>
                Poll::Pending =&gt; <span class="hljs-keyword">return</span> Poll::Pending,<font></font>
                Poll::Ready(x) =&gt; {<font></font>
                    <span class="hljs-keyword">let</span> result = this.result.as_mut().unwrap();<font></font>
                    *result += (this.f)(x);<font></font>
                    *this.fut2 = <span class="hljs-literal">None</span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">unsafe</span> { Pin::new_unchecked(this.fut3) }.poll(cx) {<font></font>
            Poll::Pending =&gt; Poll::Pending,<font></font>
            Poll::Ready(x) =&gt; {<font></font>
                <span class="hljs-keyword">let</span> result = this.result.as_mut().unwrap();<font></font>
                *result += (this.f)(x);<font></font>
                Poll::Ready(this.result.take().unwrap())<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<h2 id="variant-2-adaptory"> №2 ()</h2><br>
<pre><code class="rust hljs"><span class="hljs-keyword">use</span> std::ops::AddAssign;<font></font>
<font></font>
<span class="hljs-keyword">use</span> futures::Future;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">compound_future</span></span>&lt;<span class="hljs-symbol">'a</span>, Fut1, Fut2, Fut3, T, U, F&gt;(<font></font>
    fut1: Fut1,<font></font>
    fut2: Fut2,<font></font>
    fut3: Fut3,<font></font>
    <span class="hljs-keyword">mut</span> f: F,<font></font>
) -&gt; <span class="hljs-keyword">impl</span> Future&lt;Item = U, Error = ()&gt; + <span class="hljs-symbol">'a</span>
<span class="hljs-keyword">where</span>
    Fut1: Future&lt;Item = T, Error = ()&gt; + <span class="hljs-symbol">'a</span>,<font></font>
    Fut2: Future&lt;Item = T, Error = ()&gt; + <span class="hljs-symbol">'a</span>,<font></font>
    Fut3: Future&lt;Item = T, Error = ()&gt; + <span class="hljs-symbol">'a</span>,<font></font>
    F: <span class="hljs-built_in">FnMut</span>(T) -&gt; U + <span class="hljs-symbol">'a</span>,<font></font>
    U: AddAssign,<font></font>
{<font></font>
        fut1.join3(fut2, fut3).map(<span class="hljs-keyword">move</span> |(a, b, c)| {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> result = f(a);<font></font>
                result += f(b);<font></font>
                result += f(c);<font></font>
                result<font></font>
        })<font></font>
}</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><p>     <code>futures = "0.1"</code>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>  ,       .</p></div>
                    </div><br>
<h2 id="variant-3-asyncawait"> №3 (async/.await)</h2><br>
<pre><code class="rust hljs"><span class="hljs-keyword">use</span> std::{future::Future, ops::AddAssign};<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">compound_future</span></span>&lt;Fut1, Fut2, Fut3, T, U, F&gt;(<font></font>
    fut1: Fut1,<font></font>
    fut2: Fut2,<font></font>
    fut3: Fut3,<font></font>
    <span class="hljs-keyword">mut</span> f: F,<font></font>
) -&gt; U<font></font>
<span class="hljs-keyword">where</span><font></font>
    Fut1: Future&lt;Output = T&gt;,<font></font>
    Fut2: Future&lt;Output = T&gt;,<font></font>
    Fut3: Future&lt;Output = T&gt;,<font></font>
    F: <span class="hljs-built_in">FnMut</span>(T) -&gt; U,<font></font>
    U: AddAssign,<font></font>
{<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> result = f(fut1.<span class="hljs-keyword">await</span>);<font></font>
    result += f(fut2.<span class="hljs-keyword">await</span>);<font></font>
    result += f(fut3.<span class="hljs-keyword">await</span>);<font></font>
    result<font></font>
}</code></pre><br>
<h2 id="analiz"></h2><br>
<p>         <code>CompoundFuture</code>     <code>poll</code>     .   ,    ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a> (   )  -  .        ,      , ..    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>     (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">futures</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Tokio</a>  ).</p><br>
<p>     24 ,   3.5      , ,  ,   ,    .     ().    :</p><br>
<blockquote>     —  ,    <code>Fut1</code>,  (,   ,   ) <code>Fut1</code>  <code>Fut2&lt;..., Fut1, ...&gt;</code>,  <code>Fut1: Future, Fut2: Future</code>.</blockquote><p>        ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>),      . ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>futures::future::Future::join3</code></a>  ,      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>futures::future::Future::map</code></a>  ,      ,      .</p><br>
<p>        ,      .               :</p><br>
<pre><code class="plaintext hljs">= note: expected type ()<font></font>
        found type futures::future::and_then::AndThen&lt;futures::stream::concat::Concat2&lt;hyper::body::body::Body&gt;, futures::future::or_else::OrElse&lt;futures::future::map::Map&lt;futures::future::and_then::AndThen&lt;futures::future::and_then::AndThen&lt;futures::future::map_err::MapErr&lt;futures::future::result_::FutureResult&lt;contract::Update, serde_json::error::Error&gt;, [closure@src\main.rs:139:22: 144:14]&gt;, std::result::Result&lt;(contract::User, std::string::String, i64, i64), http::response::Response&lt;hyper::body::body::Body&gt;&gt;, [closure@src\main.rs:145:23: 162:14]&gt;, futures::future::map_err::MapErr&lt;futures::future::and_then::AndThen&lt;impl futures::future::Future, futures::future::either::Either&lt;futures::future::and_then::AndThen&lt;impl futures::future::Future, futures::future::either::Either&lt;futures::future::then::Then&lt;impl futures::future::Future, futures::future::either::Either&lt;impl futures::future::Future, futures::future::result_::FutureResult&lt;(), telegram_client::TelegramClientError&gt;&gt;, [closure@src\main.rs:211:51: 224:46 telegram_client:_, chat_id:_, text:_]&gt;, futures::future::result_::FutureResult&lt;(), telegram_client::TelegramClientError&gt;&gt;, [closure@src\main.rs:173:90: 230:30 file_id:_, ext:_, user:_, message_id:_, dbs:_, chat_id:_, telegram_client:_]&gt;, futures::future::result_::FutureResult&lt;(), telegram_client::TelegramClientError&gt;&gt;, [closure@src\main.rs:166:31: 235:22 user:_, chat_id:_, message_id:_, telegram_client:_, file_id:_, dbs:_]&gt;, [closure@src\main.rs:236:30: 242:22]&gt;, [closure@src\main.rs:163:23: 243:14 telegram_client:_, dbs:_]&gt;, [closure@src\main.rs:245:18: 248:14]&gt;, std::result::Result&lt;http::response::Response&lt;hyper::body::body::Body&gt;, hyper::error::Error&gt;, fn(http::response::Response&lt;hyper::body::body::Body&gt;) -&gt; std::result::Result&lt;http::response::Response&lt;hyper::body::body::Body&gt;, hyper::error::Error&gt; {std::result::Result&lt;http::response::Response&lt;hyper::body::body::Body&gt;, hyper::error::Error&gt;::Ok}&gt;, [closure@src\main.rs:136:54: 250:6 telegram_client:_, dbs:_]&gt;</code></pre><br>
<p>[ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>]</p><br>
<p> ,       :    —    .      ,       ,     ,     (      ).</p><br>
<p>     <code>async</code>/<code>.await</code>,         .    (<code>async fn</code>, <code>async { ... }</code>  <code>async move { ... }</code>)    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>,  <code>fut.await</code>       <code>fut</code>.  ,     <code>poll</code> ,   <code>fut.await</code>,   ,  <code>fut</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Poll::Ready(Output)</code></a>.        (     ).           ,      .</p><br>
<p>    <code>async</code>/<code>.await</code>  /  —     "" <code>.await</code> —        () .</p><br>
<hr><br>
<h1 id="alternativnye-vzglyady-na-problemu">   </h1><br>
<p>        ,         ,    .     <code>async</code>/<code>.await</code>:</p><br>
<ul>
<li><p><strong>  </strong>.   <code>async</code>/<code>.await</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> 2018 </a> (  ),           / (      , , Scala, Java, ...)       , ,   ,  ,         ,         (  ,  (     )).</p><br>
</li>
<li><p><strong> </strong>. <code>Future</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">do-</a>,  ,    <code>Result</code>, <code>Option</code>, <code>Either</code>   .      Rust     <strong>-</strong>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><strong>HKT</strong> — <strong>H</strong>igher-<strong>K</strong>inded <strong>T</strong>ypes</a>.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">"    "</a>.    HKT,     </p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Associated type constructors, part 3: What higher-kinded types might look like"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Idiomatic monads in Rust"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">"Rust's Type System is Turing-Complete"</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">fp-core.rs — A library for functional programming in Rust</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">frunk — Funktional generic type-level programming in Rust: HList, Coproduct, Generic, LabelledGeneric, Validated, Monoid and friends</a></li>
</ul><br>
</li>
</ul><br>
<hr><br>
<h1 id="async-move----ili-async----">async move {… }  async {… } ?</h1><br>
<p>   <code>async move { ... }</code>  <code>async { ... }</code>    ,      (<code>{ ... }</code>)   move-.   ,     ( <code>move</code>)   ,    ( <code>move</code>) —     ,    —  ,      —  (,        ,   <code>Future</code>).</p><br>
<p>  ,  .  <code>foo()</code>      <code>abc</code>  :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>() {
    <span class="hljs-keyword">let</span> string = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">"abc"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">async</span> { dbg!(&amp;string); }.<span class="hljs-keyword">await</span>;
    <span class="hljs-keyword">async</span> { dbg!(&amp;string); }.<span class="hljs-keyword">await</span>;<font></font>
}</code></pre><br>
<p>      <code>string</code>.      <code>move</code>   ,   <code>async</code>,    ,    ,  <code>async move { ... }</code>  <strong></strong>  :</p><br>
<pre><code class="plaintext hljs">error[E0382]: use of moved value: `string`<font></font>
 --&gt; src/lib.rs:5:16<font></font>
  |<font></font>
2 |     let string = String::from("abc");<font></font>
  |         ------ move occurs because `string` has type `std::string::String`, which does not implement the `Copy` trait<font></font>
3 |     <font></font>
4 |     async move { dbg!(&amp;string); }.await;<font></font>
  |                ------------------<font></font>
  |                |       |<font></font>
  |                |       variable moved due to use in generator<font></font>
  |                value moved here<font></font>
5 |     async move { dbg!(&amp;string); }.await;<font></font>
  |                ^^^^^^^^------^^^^<font></font>
  |                |       |<font></font>
  |                |       use occurs due to use in generator<font></font>
  |                value used here after move</code></pre><br>
<p>   :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>() -&gt; <span class="hljs-built_in">String</span> {
    <span class="hljs-keyword">let</span> string = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">"abc"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">async</span> { string }.<span class="hljs-keyword">await</span>
}</code></pre><br>
<p>      <code>string</code>   ,     ()  —  .      <code>move</code>,     .</p><br>
<p> ,     :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> string = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">"abc"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">async</span> { string.push_str(<span class="hljs-string">"def"</span>); }.<span class="hljs-keyword">await</span>;<font></font>
<font></font>
    dbg!(string);<font></font>
}</code></pre><br>
<p>   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>String::push_str</code></a>  <code>&amp;mut self</code>,    —  .    <code>move</code>, ,    ,   ,         <code>dbg!</code>,   <code>string</code>:</p><br>
<pre><code class="plaintext hljs">error[E0382]: use of moved value: `string`<font></font>
 --&gt; src/lib.rs:6:10<font></font>
  |<font></font>
2 |     let mut string = String::from("abc");<font></font>
  |         ---------- move occurs because `string` has type `std::string::String`, which does not implement the `Copy` trait<font></font>
3 |     <font></font>
4 |     async move { string.push_str("def"); }.await;<font></font>
  |                ---------------------------<font></font>
  |                | |<font></font>
  |                | variable moved due to use in generator<font></font>
  |                value moved here<font></font>
5 |     <font></font>
6 |     dbg!(string);<font></font>
  |          ^^^^^^ value used here after move</code></pre><br>
<hr><br>
<h1 id="asinhronnye-zamykaniya"> ?</h1><br>
<p>   :</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> closure = <span class="hljs-keyword">async</span> || {<font></font>
        dbg!();<font></font>
    };<font></font>
}</code></pre><br>
<p>:</p><br>
<pre><code class="plaintext hljs">error[E0658]: async closures are unstable<font></font>
 --&gt; src/main.rs:2:19<font></font>
  |<font></font>
2 |     let closure = async || {<font></font>
  |                   ^^^^^<font></font>
  |<font></font>
  = note: see issue #62290 &lt;https://github.com/rust-lang/rust/issues/62290&gt; for more information</code></pre><br>
<p>       (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">RFC</a>).      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>:</p><br>
<ul>
<li> — <code>async [move] |...| { ... }</code> ()</li>
<li> — <code>|...| async [move] { ... }</code> ()</li>
</ul><br>
<hr><br>
<h1 id="pin">Pin</h1><br>
<p>    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future::poll</code></a>  <code>self: Pin&lt;&amp;mut Self&gt;</code>.   ?    ,          .   ?  ,        ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>):</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> x = [<span class="hljs-number">0</span>; <span class="hljs-number">128</span>];
    <span class="hljs-keyword">let</span> read_into_buf_fut = read_into_buf(&amp;<span class="hljs-keyword">mut</span> x);<font></font>
    read_into_buf_fut.<span class="hljs-keyword">await</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, x);<font></font>
}</code></pre><br>
<p>   :</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ReadIntoBuf</span></span>&lt;<span class="hljs-symbol">'a</span>&gt; {<font></font>
    buf: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> [<span class="hljs-built_in">u8</span>], <span class="hljs-comment">//   `x` </span><font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AsyncFuture</span></span> {<font></font>
    x: [<span class="hljs-built_in">u8</span>; <span class="hljs-number">128</span>],<font></font>
    read_into_buf_fut: ReadIntoBuf&lt;<span class="hljs-symbol">'self</span>&gt;,<font></font>
}</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><p> <code>'self</code>     ,        <code>read_into_buf_fut: ReadIntoBuf&lt;'self&gt;</code>.  ,     ,     <code>AsyncFuture</code>.</p></div>
                    </div><br>
<p>  <code>AsyncFuture</code>   ,    <code>read_into_buf_fut.buf</code>  (    ),  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> UB</a>.   —          ,    <code>self: Pin&lt;&amp;mut Self&gt;</code>.</p><br>
<p><code>Pin</code>      Rust,     ,       .         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<hr><br>
<h1 id="itog"></h1><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a> —    ()   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">poll-based</a>   .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future</code></a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>:        ,         —   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Future::poll</code></a>   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>Poll::Ready(Output)</code></a>.     ,   ( ).</p><br>
<p><code>async</code>/<code>.await</code>  Rust —      .    ,     .</p><br>
<p>  <code>async</code>,      ,    ,    , .. ,    .</p><br>
<p>  <code>await</code>,      ,    <code>fut</code> (<code>fut.await</code>).          <code>fut</code>.   — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>futures::Future::and_then</code></a> (futures 0.1.x).</p><br>
<hr><br>
<p> —  ,        :     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Tokio</a>.</p><br>
<h1 id="blagodarnosti"></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レビュー</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@blandgerに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感謝します</font><font style="vertical-align: inherit;">。また、ロシア語のテレグラムチャット</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@rust_async</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">サポートしてくれた他の人々にも</font><font style="vertical-align: inherit;">感謝しています</font><font style="vertical-align: inherit;">。ここでは、Rustの非同期プログラミングに関する質問をすることもできます。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504006/index.html">数行のコードでパンダを大幅に高速化する6つの方法。パート2</a></li>
<li><a href="../ja504008/index.html">アルゴリズムとは？！パート1</a></li>
<li><a href="../ja504012/index.html">並べ替えを反転</a></li>
<li><a href="../ja504014/index.html">公国主義はロシア語を捕らえます：なぜこれが起こるのか</a></li>
<li><a href="../ja504016/index.html">豊かで影響力のある人へのストイシズムの魅力</a></li>
<li><a href="../ja504022/index.html">情報セキュリティ専門家。何をし、どのくらい稼ぐのか</a></li>
<li><a href="../ja504026/index.html">なぜシリコンバレーは苦しみのおかげでそんなに取りつかれているのですか？</a></li>
<li><a href="../ja504030/index.html">ReactおよびReact Nativeパート2でAzure AD B2Cを構成した方法の物語（チュートリアル）</a></li>
<li><a href="../ja504032/index.html">5月27日の輸送</a></li>
<li><a href="../ja504034/index.html">電気マグ。クレイジーな電動スクーター/電動自転車を構築しています。反射</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>