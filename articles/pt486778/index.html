<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçü§ù‚Äçüë®üèª üë©‚Äç‚úàÔ∏è üßê SSO na arquitetura de microsservi√ßo. Usamos Keycloak. N√∫mero da pe√ßa 1 üßöüèΩ ‚úàÔ∏è üöª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em qualquer empresa grande, o X5 Retail Group n√£o √© exce√ß√£o, pois o n√∫mero de projetos em que a autentica√ß√£o do usu√°rio √© necess√°ria aumenta √† medida ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SSO na arquitetura de microsservi√ßo. Usamos Keycloak. N√∫mero da pe√ßa 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/486778/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em qualquer empresa grande, o X5 Retail Group n√£o √© exce√ß√£o, pois o n√∫mero de projetos em que a autentica√ß√£o do usu√°rio √© necess√°ria aumenta √† medida que o n√∫mero de projetos aumenta. Com o tempo, √© necess√°ria uma transi√ß√£o cont√≠nua de usu√°rios de um aplicativo para outro e, em seguida, √© necess√°rio usar um √∫nico servidor Single-Sing-On (SSO). Mas e quando provedores de identidade como o AD ou outros que n√£o possuem atributos adicionais j√° s√£o usados ‚Äã‚Äãem v√°rios projetos. Uma classe de sistemas chamados "agentes de identidade" vir√° em socorro. Os mais funcionais s√£o seus representantes, como Keycloak, gerenciamento de Gravitee Access, etc. Na maioria das vezes, os cen√°rios de uso podem ser diferentes: intera√ß√£o da m√°quina, participa√ß√£o do usu√°rio etc. A solu√ß√£o deve oferecer suporte a funcionalidades flex√≠veis e escalon√°veis,capaz de combinar todos os requisitos em um, e essa solu√ß√£o em nossa empresa agora √© um corretor de indicadores - Keycloak.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hm/bi/eh/hmbiehmxsfcq_cfltz8xj0mhrgc.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloak √© um produto de c√≥digo aberto para autentica√ß√£o e controle de acesso suportado pelo RedHat. </font><font style="vertical-align: inherit;">√â a base para os produtos da empresa usando SSO - RH-SSO.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conceitos B√°sicos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßar a lidar com decis√µes e abordagens, voc√™ deve determinar os termos e a sequ√™ncia de processos: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mm/j1/c2/mmj1c2uynwb23y5j4me13zzcrb4.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifica√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o processo de reconhecimento de um assunto por seu identificador (em outras palavras, √© determinar um nome, login ou n√∫mero). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A autentica√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um procedimento de autentica√ß√£o (o usu√°rio √© verificado com uma senha, o email √© verificado por assinatura eletr√¥nica, etc.) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o fornecimento de acesso a algum recurso (por exemplo, email).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corretor de identidade de Keycloak</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Keycloak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma solu√ß√£o de gerenciamento de acesso e identidade de c√≥digo aberto projetada para uso em ICs onde padr√µes de arquitetura de microsservi√ßo podem ser usados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Keycloak oferece recursos como logon √∫nico (SSO), identifica√ß√£o do broker e logon social, federa√ß√£o de usu√°rios, adaptadores de clientes, um console de administrador e um console de gerenciamento de contas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funcionalidade b√°sica suportada no Keycloak:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√£o √∫nica e sa√≠da √∫nica para aplicativos baseados no navegador.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte para OpenID / OAuth 2.0 / SAML.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corretagem de identidade - autentica√ß√£o usando provedores de identidade externos do OpenID Connect ou SAML.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Login social - suporte para Google, GitHub, Facebook, Twitter para identifica√ß√£o do usu√°rio.</font></font></li>
<li>User Federation ‚Äì    LDAP  Active Directory     .</li>
<li>Kerberos bridge ‚Äì  Kerberos     .</li>
<li>Admin Console ‚Äî         Web.</li>
<li>Account Management Console ‚Äì     .</li>
<li>      .</li>
<li>2FA Authentication ‚Äì  TOTP/HOTP   Google Authenticator  FreeOTP.</li>
<li>Login Flows ‚Äì   ,      .</li>
<li>Session Management ‚Äì        .</li>
<li>Token Mappers ‚Äì   ,       .</li>
<li>    realm, application  .</li>
<li>CORS Support ‚Äì      CORS.</li>
<li>Service Provider Interfaces (SPI) ‚Äì   SPI,      :  ,  ,     .</li>
<li>   JavaScript applications, WildFly, JBoss EAP, Fuse, Tomcat, Jetty, Spring.</li>
<li>    ,  OpenID Connect Relying Party library  SAML 2.0 Service Provider Library.</li>
<li>    plugins.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para processos de CI / CD, bem como a automa√ß√£o de processos de gerenciamento no Keycloak, a API REST API / JAVA pode ser usada. </font><font style="vertical-align: inherit;">A documenta√ß√£o est√° dispon√≠vel em formato eletr√¥nico: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
API REST </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/rest-api/index.html</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
API JAVA </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/javadocs /index.html</font></font></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provedores de identidade corporativa (no local)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A capacidade de autenticar usu√°rios atrav√©s dos servi√ßos de Federa√ß√£o de Usu√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8j/s9/cl/8js9cl3cx9whnsshxcel0xynpqs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A autentica√ß√£o de passagem tamb√©m pode ser usada - se os usu√°rios se autenticarem em esta√ß√µes de trabalho com Kerberos (LDAP ou AD), eles poder√£o ser autenticados automaticamente com o Keycloak sem precisar digitar novamente o nome de usu√°rio e a senha. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para autentica√ß√£o e autoriza√ß√£o adicional dos usu√°rios, √© poss√≠vel usar um DBMS relacional, o mais aplic√°vel aos ambientes de desenvolvimento, pois n√£o implica configura√ß√µes e integra√ß√µes de longo prazo nos est√°gios iniciais dos projetos. Por padr√£o, o Keycloak usa um DBMS interno para armazenar configura√ß√µes e dados do usu√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lista de DBMSs suportados √© extensa e inclui: MS SQL, Oracle, PostgreSQL, MariaDB, Oracle e outros. </font><font style="vertical-align: inherit;">Os mais testados no momento s√£o o cluster Oracle 12C Release1 RAC e Galera 3.12 para MariaDB 10.1.19.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provedores de identidade - login social </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â poss√≠vel usar um login nas redes sociais. </font><font style="vertical-align: inherit;">Para ativar a capacidade de autenticar usu√°rios, o console administrativo do Keycloack √© usado. </font><font style="vertical-align: inherit;">Altera√ß√µes no c√≥digo do aplicativo n√£o s√£o necess√°rias e essa funcionalidade est√° dispon√≠vel "pronta para uso" e pode ser ativada em qualquer est√°gio do projeto. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/rj/vp/bsrjvpxnw7eojom-_bv816iwoxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para autenticar usu√°rios, √© poss√≠vel usar provedores de identidade OpenID / SAML.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rios t√≠picos de autoriza√ß√£o usando o OAuth2 no Keycloak</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fluxo do c√≥digo de autoriza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - usado com aplicativos do lado do servidor. Um dos tipos mais comuns de permiss√µes de autoriza√ß√£o, pois √© adequado para aplicativos de servidor nos quais o c√≥digo-fonte do aplicativo e os dados do cliente n√£o est√£o acess√≠veis a pessoas de fora. O processo neste caso √© baseado no redirecionamento. O aplicativo deve poder interagir com o agente do usu√°rio (agente do usu√°rio), como um navegador da Web - para receber c√≥digos de autoriza√ß√£o da API redirecionados pelo agente do usu√°rio. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fluxo impl√≠cito</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - usado por aplicativos m√≥veis ou da Web (aplicativos em execu√ß√£o no dispositivo do usu√°rio).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um tipo impl√≠cito de permiss√£o de autoriza√ß√£o √© usado por aplicativos m√≥veis e da Web em que a privacidade do cliente n√£o pode ser garantida. </font><font style="vertical-align: inherit;">O tipo de permiss√£o impl√≠cita tamb√©m usa o redirecionamento do agente do usu√°rio, e o token de acesso √© passado ao agente do usu√°rio para uso posterior no aplicativo. </font><font style="vertical-align: inherit;">Isso torna o token dispon√≠vel para o usu√°rio e outros aplicativos no dispositivo do usu√°rio. </font><font style="vertical-align: inherit;">Com esse tipo de permiss√£o de autoriza√ß√£o, o aplicativo n√£o √© autenticado e o pr√≥prio processo depende de uma URL de redirecionamento (anteriormente registrada no servi√ßo).</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O fluxo impl√≠cito n√£o suporta tokens de atualiza√ß√£o.
</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fluxo de concess√£o de credenciais do cliente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - usado quando o aplicativo acessa a API. </font><font style="vertical-align: inherit;">Esse tipo de permiss√£o de autoriza√ß√£o geralmente √© usado para intera√ß√µes entre servidores que devem ser executadas em segundo plano sem intera√ß√£o imediata do usu√°rio. </font><font style="vertical-align: inherit;">O fluxo de credenciais do cliente permite que o servi√ßo da Web (o cliente confidencial) use suas pr√≥prias credenciais em vez de se passar por usu√°rio para autentica√ß√£o ao chamar outro servi√ßo da Web. </font><font style="vertical-align: inherit;">Para um n√≠vel mais alto de seguran√ßa, √© poss√≠vel que o servi√ßo de chamada use um certificado (em vez de um segredo compartilhado) como credenciais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A especifica√ß√£o OAuth2 est√° descrita em </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-6749 </font></font></a> <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-8252 </font></font></a> <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-6819</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token JWT e suas vantagens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JWT (JSON Web Token) √© um padr√£o aberto ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://tools.ietf.org/html/rfc7519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) que define um m√©todo compacto e independente para transferir com seguran√ßa informa√ß√µes entre partes como um objeto JSON. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com o padr√£o, o token consiste em tr√™s partes no formato base 64, separadas por pontos. </font><font style="vertical-align: inherit;">A primeira parte √© chamada de cabe√ßalho, que cont√©m o tipo de token e o nome do algoritmo de hash para obter uma assinatura digital. </font><font style="vertical-align: inherit;">A segunda parte armazena as informa√ß√µes b√°sicas (usu√°rio, atributos, etc.). </font><font style="vertical-align: inherit;">A terceira parte √© uma assinatura digital.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;cabe√ßalho codificado&gt;. &lt;carga √∫til codificada&gt;. &lt;assinatura&gt;</font></font></oembed><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nunca salve um token no seu banco de dados. </font><font style="vertical-align: inherit;">Como um token v√°lido √© equivalente a uma senha, armazenar um token √© como armazenar uma senha em texto n√£o criptografado.</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um token de acesso</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um token que fornece ao propriet√°rio acesso aos recursos protegidos do servidor. </font><font style="vertical-align: inherit;">Geralmente, tem uma vida √∫til curta e pode transportar informa√ß√µes adicionais, como o endere√ßo IP da parte que solicitou esse token. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um token de atualiza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um token que permite que os clientes solicitem novos tokens de acesso ap√≥s o t√©rmino da vida √∫til. </font><font style="vertical-align: inherit;">Esses tokens geralmente s√£o emitidos por um longo per√≠odo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Principais vantagens da aplica√ß√£o na arquitetura de microsservi√ßos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A capacidade de acessar v√°rios aplicativos e servi√ßos por meio de autentica√ß√£o √∫nica.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na aus√™ncia de v√°rios atributos necess√°rios no perfil do usu√°rio, √© poss√≠vel enriquecer com dados que podem ser adicionados √† carga, incluindo automatizados e din√¢micos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° necessidade de armazenar informa√ß√µes sobre sess√µes ativas; o aplicativo do servidor deve verificar apenas a assinatura.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controle de acesso mais flex√≠vel com atributos adicionais na carga √∫til.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O uso de uma assinatura de token para o cabe√ßalho e a carga √∫til aumenta a seguran√ßa da solu√ß√£o como um todo.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token JWT - Composi√ß√£o</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cabe√ßalho</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - por padr√£o, o cabe√ßalho cont√©m apenas o tipo de token e o algoritmo usado para criptografia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tipo de token √© armazenado na tecla "typ". </font><font style="vertical-align: inherit;">A chave "typ" √© ignorada no JWT. </font><font style="vertical-align: inherit;">Se a chave de tipo estiver presente, seu valor dever√° ser JWT para indicar que este objeto √© um Token da Web JSON. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda chave alg define o algoritmo usado para criptografar o token. </font><font style="vertical-align: inherit;">Por padr√£o, ele deve ser definido como HS256. </font><font style="vertical-align: inherit;">O cabe√ßalho √© codificado em base64.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg": "HS256", "typ": "JWT"}</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga √∫til (conte√∫do)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a carga √∫til armazena qualquer informa√ß√£o que precise ser verificada. </font><font style="vertical-align: inherit;">Cada chave na carga √∫til √© conhecida como "declara√ß√£o". </font><font style="vertical-align: inherit;">Por exemplo, o aplicativo pode ser inserido apenas por convite (promo√ß√£o fechada). </font><font style="vertical-align: inherit;">Quando queremos convidar algu√©m para participar, enviamos uma carta de convite a ele. </font><font style="vertical-align: inherit;">√â importante verificar se o endere√ßo de e-mail pertence √† pessoa que aceita o convite, portanto, incluiremos esse endere√ßo na carga √∫til, para isso o salvaremos na chave "e-mail"</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"email": "example@x5.ru"}
</font></font></oembed><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As chaves na carga √∫til podem ser arbitr√°rias. </font><font style="vertical-align: inherit;">No entanto, existem alguns reservados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iss (Emissor) - define o aplicativo a partir do qual o token √© enviado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub (Assunto) - define o t√≥pico do token.</font></font></li>
<li>aud (Audience) ‚Äì       URI,     .     JWT   ,        ‚Äî   .</li>
<li>exp (Expiration Time) ‚Äî ,     .  JWT ,           . Exp       unix .</li>
<li>nbf (Not Before) ‚Äî    unix ,  ,    .</li>
<li>iat (Issued At) ‚Äî     ,            JWT. iat       unix .</li>
<li>Jti (JWT ID) ‚Äî ,      c  .</li>
</ul><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â importante entender que a carga √∫til n√£o √© transmitida na forma criptografada (embora os tokens possam ser incorporados e, em seguida, seja poss√≠vel transmitir dados criptografados). </font><font style="vertical-align: inherit;">Portanto, √© imposs√≠vel armazenar qualquer informa√ß√£o secreta nele. </font><font style="vertical-align: inherit;">Como o cabe√ßalho, a carga √∫til √© codificada em base64.</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assinatura</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - quando temos um cabe√ßalho e uma carga √∫til, podemos calcular a assinatura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codificado em Base64: cabe√ßalho e carga √∫til, s√£o combinados em uma linha atrav√©s de um ponto. </font><font style="vertical-align: inherit;">Em seguida, essa linha e a chave secreta s√£o enviadas para a entrada do algoritmo de criptografia especificado no cabe√ßalho (chave "alg"). </font><font style="vertical-align: inherit;">A chave pode ser qualquer sequ√™ncia. </font><font style="vertical-align: inherit;">Cordas mais longas ser√£o prefer√≠veis, pois levar√° mais tempo para combinar.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg": "RSA1_5", "carga": "A128CBC-HS256"}</font></font></oembed><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura de Cluster de Failover de Keycloak</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar um √∫nico cluster para todos os projetos, h√° um aumento nos requisitos para uma solu√ß√£o para SSO. Quando o n√∫mero de projetos √© pequeno, esses requisitos n√£o s√£o t√£o percept√≠veis para todos os projetos, mas com um aumento no n√∫mero de usu√°rios e integra√ß√µes, os requisitos de acessibilidade e produtividade aumentam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aumentar o risco de falha de um √∫nico SSO aumenta os requisitos para a arquitetura da solu√ß√£o e os m√©todos usados ‚Äã‚Äãpara redund√¢ncia de componentes e leva a um SLA muito r√≠gido. Nesse sentido, mais freq√ºentemente ao desenvolver ou nos est√°gios iniciais da implementa√ß√£o de solu√ß√µes, os projetos t√™m sua pr√≥pria infraestrutura n√£o tolerante a falhas. √Ä medida que voc√™ desenvolve, voc√™ precisa estabelecer a possibilidade de desenvolvimento e dimensionamento. O mais flex√≠vel √© criar um cluster de failover usando a virtualiza√ß√£o de cont√™iner ou uma abordagem h√≠brida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para trabalhar em clusters Ativo / Ativo e Ativo / Passivo, √© necess√°rio garantir a consist√™ncia dos dados em um banco de dados relacional - ambos os n√≥s do banco de dados devem ser replicados de forma s√≠ncrona entre diferentes datacenters distribu√≠dos geograficamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O exemplo mais simples de uma instala√ß√£o √† prova de falhas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/tw/7w/xotw7wkifwb3h6nnclvnjbbe72c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais s√£o os benef√≠cios de usar um √∫nico cluster:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alta disponibilidade e desempenho.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte para modos de opera√ß√£o: Ativo / Ativo, Ativo / Passivo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A capacidade de escalar dinamicamente - ao usar a virtualiza√ß√£o de cont√™iner.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possibilidade de gerenciamento e monitoramento centralizados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abordagem unificada para identifica√ß√£o / autentica√ß√£o / autoriza√ß√£o de usu√°rios em projetos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intera√ß√£o mais transparente entre v√°rios projetos sem a participa√ß√£o do usu√°rio.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A capacidade de reutilizar o token JWT em v√°rios projetos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ponto √∫nico de confian√ßa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lan√ßamento mais r√°pido de projetos usando microsservi√ßos / virtualiza√ß√£o de cont√™iner (sem necessidade de aumentar e configurar componentes adicionais).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez a aquisi√ß√£o de suporte comercial do fornecedor. </font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coisas a considerar ao planejar um cluster</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBMS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Keycloak usa um sistema de gerenciamento de DBMS para salvar: regi√µes, clientes, usu√°rios etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma grande variedade de DBMSs √© suportada: MS SQL, Oracle, MySQL, PostgreSQL. </font><font style="vertical-align: inherit;">O Keycloak vem com seu pr√≥prio banco de dados relacional embutido. </font><font style="vertical-align: inherit;">√â recomendado o uso para ambientes n√£o carregados, como ambientes de desenvolvimento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para operar em clusters Ativo / Ativo e Ativo / Passivo, √© necess√°rio garantir a consist√™ncia dos dados em um banco de dados relacional, e os dois n√≥s do cluster de banco de dados s√£o replicados de forma s√≠ncrona entre os datacenters.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache Distribu√≠do (Infinspan)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que o cluster funcione corretamente, √© necess√°ria uma sincroniza√ß√£o adicional dos seguintes tipos de cache usando o JBoss Data Grid: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sess√µes de autentica√ß√£o - usadas para salvar dados durante a autentica√ß√£o de um usu√°rio espec√≠fico. </font><font style="vertical-align: inherit;">As solicita√ß√µes desse cache normalmente incluem apenas o navegador e o servidor Keycloak, n√£o o aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tokens de a√ß√£o - usados ‚Äã‚Äãpara cen√°rios em que o usu√°rio precisa confirmar a a√ß√£o de forma ass√≠ncrona (via email). </font><font style="vertical-align: inherit;">Por exemplo, durante o fluxo de senhas para esquecer, o cache actionTokens Infinispan √© usado para rastrear metadados sobre marcadores de a√ß√£o relacionados que j√° foram usados, para que n√£o possam ser reutilizados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armazenamento em cache e invalida√ß√£o de dados persistentes - usado para armazenar em cache dados persistentes para evitar consultas desnecess√°rias ao banco de dados. </font><font style="vertical-align: inherit;">Quando um servidor Keycloak atualiza dados, todos os outros servidores Keycloak em todos os datacenters devem estar cientes disso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalho - usado apenas para enviar mensagens de invalida√ß√£o entre n√≥s do cluster e data centers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sess√µes de usu√°rio - usadas para salvar dados sobre sess√µes de usu√°rio v√°lidas para a sess√£o do navegador de um usu√°rio. </font><font style="vertical-align: inherit;">O cache deve manipular solicita√ß√µes HTTP do usu√°rio final e do aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prote√ß√£o de for√ßa bruta - usada para rastrear dados de login com falha.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Balanceamento de carga</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O balanceador de carga √© um ponto de entrada √∫nico no keycloak e deve suportar sess√µes persistentes. </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de aplica√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles s√£o usados ‚Äã‚Äãpara controlar a intera√ß√£o dos componentes entre si e podem ser virtualizados ou cont√™ineres usando as ferramentas de automa√ß√£o existentes e escalando dinamicamente as ferramentas de automa√ß√£o da infraestrutura. </font><font style="vertical-align: inherit;">Os cen√°rios de implanta√ß√£o mais comuns no OpenShift, Kubernetes, Rancher. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre isso, a primeira parte - te√≥rica - acabou. </font><font style="vertical-align: inherit;">Na s√©rie de artigos a seguir, ser√£o discutidos exemplos de integra√ß√µes com v√°rios provedores de identifica√ß√£o e exemplos de configura√ß√£o.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486764/index.html">Fa√ßa Voc√™ Mesmo Schema.org: personalizando o micro-layout sem um programador</a></li>
<li><a href="../pt486766/index.html">Como transferir todas as transa√ß√µes on-line no mercado arcaico de factoring? Experi√™ncia de Sberbank Factoring</a></li>
<li><a href="../pt486768/index.html">Revis√£o do painel de administra√ß√£o do Webasyst</a></li>
<li><a href="../pt486772/index.html">Queime, mas n√£o queime - queime para brilhar</a></li>
<li><a href="../pt486776/index.html">Conclus√£o de c√≥digo e verifica√ß√£o de tipo para boto3</a></li>
<li><a href="../pt486780/index.html">Desenvolvimento de front-end na empresa: o que √© e como torn√°-lo eficaz</a></li>
<li><a href="../pt486782/index.html">UI / UX - design. Tend√™ncias e previs√µes para 2020</a></li>
<li><a href="../pt486784/index.html">Os irm√£os Lumiere nunca sonharam</a></li>
<li><a href="../pt486788/index.html">Webinar ‚ÄúMonitoramento remoto e diagn√≥stico de equipamentos. Estudos de caso da solu√ß√£o CNC da Winnum ¬ª</a></li>
<li><a href="../pt486790/index.html">E, novamente, Qbot - uma nova linhagem de cavalos de Troia banc√°rios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>