<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇 📼 🔞 CortexMマイクロコントローラーに保存されている定数の場所（例としてC ++ IARコンパイラーを使用） 👋🏽 👩🏾‍🔧 ➖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私は生徒にSTM32F411REマイクロコントローラーの操作方法を教えます。このボードには512 kBのROMと128 kBのRAMが搭載されています。
 通常、プログラムはこのマイクロコントローラーのROMメモリに書き込まれ、定数がROMになるようにRAMデータを変更する必要があります。 STM3...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CortexMマイクロコントローラーに保存されている定数の場所（例としてC ++ IARコンパイラーを使用）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453262/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は生徒にSTM32F411REマイクロコントローラーの操作方法を教えます。このボードには512 kBのROMと128 kBのRAMが搭載されています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常</font><font style="vertical-align: inherit;">、プログラムは</font><font style="vertical-align: inherit;">このマイクロコントローラーの</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリに書き込まれ</font><font style="vertical-align: inherit;">、定数が</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">になるように</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを変更する必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
STM32F411RE、</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">マイクロコントローラーでは、</font><font style="vertical-align: inherit;">メモリは</font><i><font style="vertical-align: inherit;">0x08000000 ... 0x0807FFFFの</font></i><font style="vertical-align: inherit;">アドレス</font><font style="vertical-align: inherit;">に、</font><u><font style="vertical-align: inherit;">RAM</font></u><font style="vertical-align: inherit;">は</font><i><font style="vertical-align: inherit;">0x20000000 ... 0x2001FFFFの</font></i><font style="vertical-align: inherit;">アドレスに配置されます</font><i><font style="vertical-align: inherit;">。</font></i><font style="vertical-align: inherit;"> 
そして、すべてのリンカ設定が正しい場合、学生はそのような単純なコードで彼の定数が</font><u><font style="vertical-align: inherit;">ROMにあると</font></u><font style="vertical-align: inherit;">期待します</font><font style="vertical-align: inherit;">：</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WantToBeInROM</span>
{</span>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">int</span> i;
<span class="hljs-keyword">public</span>:<font></font>
  WantToBeInROM(<span class="hljs-keyword">int</span> value): i(value) {}
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> i;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> WantToBeInROM <span class="hljs-title">myConstInROM</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{  
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;myConstInROM &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、質問に答えることもできます：</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMの</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数myConstInROMはどこにあり</font><u><font style="vertical-align: inherit;">ます</font></u><font style="vertical-align: inherit;">か？</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">で</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この質問に答えた場合</font><font style="vertical-align: inherit;">、私はおめでとう、実際にはあなたが間違っている可能性が最も高いです。定数は一般的に</font><u><font style="vertical-align: inherit;">RAMに</font></u><font style="vertical-align: inherit;">あり、定数を</font><u><font style="vertical-align: inherit;">ROMに</font></u><font style="vertical-align: inherit;">正しく正しく配置する方法を理解します</font><font style="vertical-align: inherit;">-猫へようこそ。</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、少し余談ですが、なぜこれについてまったく気にしないのですか。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IEC 61508-3：2010または</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GOST IEC 61508-3-2018の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国内同等物に準拠する測定デバイス用の安全上重要なソフトウェアを開発する場合</font><font style="vertical-align: inherit;">、従来のソフトウェアにとって重要ではないいくつかの点を考慮する必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この標準の主なメッセージは、ソフトウェアがシステムの信頼性に影響を与える障害を検出し、システムを「クラッシュ」モードにする必要があるということです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
たとえば、センサーの障害や劣化、電子部品の障害などの明らかな機械的障害に加えて、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font><font style="vertical-align: inherit;">マイクロコントローラー</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのソフトウェア環境の障害</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の2つのケースで、かなり混乱した間接的な方法でのみエラーを検出できる場合（センサーの故障を判断するアルゴリズム、たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抵抗熱コンバーターの状態を評価する方法がある</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、ソフトウェア環境の故障の場合、これははるかに簡単に実行できます。たとえば、メモリの故障が発生する可能性があります。簡単なデータ整合性チェックで確認します。データの整合性が侵害されている場合は、これをメモリ障害として解釈します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェックと更新を行わずにデータが長期間RAMにある場合、</font><u><font style="vertical-align: inherit;">RAMの</font></u><font style="vertical-align: inherit;">障害により</font><u><font style="vertical-align: inherit;">データに</font></u><font style="vertical-align: inherit;">何かが発生する可能性</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時間の経過とともに高くなります。例としては、工場で設定され外部EEPROMに書き込まれた温度を計算するためのいくつかの校正係数があり、起動時に</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み込まれて書き込まれ</font><font style="vertical-align: inherit;">、電源がオフになるまでそこにあります。そして、実際には、温度センサーは、相互校正間隔の全期間、最大3〜5年で機能します。明らかに、そのような</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データは保護され、完全性を定期的にチェックする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、単に読みやすくするために宣言された定数などのデータ、LCDドライバのオブジェクト、SPIまたはI2Cは変更してはならず、一度作成され、電源がオフになるまで削除されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータは</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">に保存する方が良い</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">テクノロジーの観点から見るとより信頼性が高く、チェックもはるかに簡単です。優先度の低いタスクですべての永続メモリのチェックサムを定期的に読み取るだけで十分です。</font><font style="vertical-align: inherit;">チェックサムが一致しない場合は、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">障害</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">報告するだけで</font><font style="vertical-align: inherit;">診断システムに事故が表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータが</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にある場合、不変データがRAM内のどこにあり、どこが変更可能であるかが明確ではないため、リンカーがデータを必要に応じて配置し、チェックサムで各RAMオブジェクトを保護すると、次のようになります。パラノイア。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、最も簡単な方法は、定数データが</font><u><font style="vertical-align: inherit;">ROMにある</font></u><font style="vertical-align: inherit;">ことを100％確認することです。</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを行う方法を説明しようと思います。</font><font style="vertical-align: inherit;">ただし、最初にARMにおけるメモリの構成について説明する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご存知のように、ARMコアにはハーバードアーキテクチャがあり、データバスとコードバスが分離されています。</font><font style="vertical-align: inherit;">通常、これはプログラム用の個別のメモリとデータ用の個別のメモリがあることを意味します。</font><font style="vertical-align: inherit;">しかし実際には、ARMは修正されたハーバードアーキテクチャです。</font><font style="vertical-align: inherit;">メモリへのアクセスは1つのバスを介して行われ、メモリ管理デバイスは、制御信号（メモリ領域の読み取り、書き込み、または選択）を使用してバスの分離をすでに提供しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、データとコードを同じメモリ領域に置くことができます。</font><font style="vertical-align: inherit;">この単一のアドレス空間には、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリと</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および周辺機器を</font><font style="vertical-align: inherit;">配置できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、これは実際には、コードとデータの両方がコンパイラとリンカーに依存している場所でも取得できることを意味しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM（フラッシュ）</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMの</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ領域を区別するために</font><u><font style="vertical-align: inherit;">、</font></u><font style="vertical-align: inherit;">それらは通常リンカ設定で示されます。たとえば、IAR 8.40.1では次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs">define symbol __ICFEDIT_region_ROM_start__ = <span class="hljs-number">0x08000000</span>;<font></font>
define symbol __ICFEDIT_region_ROM_end__   = <span class="hljs-number">0x0807FFFF</span>;<font></font>
define symbol __ICFEDIT_region_RAM_start__ = <span class="hljs-number">0x20000000</span>;<font></font>
define symbol __ICFEDIT_region_RAM_end__   = <span class="hljs-number">0x2001FFFF</span>;<font></font>
define region ROM_region   = mem:[from __ICFEDIT_region_ROM_start__   to __ICFEDIT_region_ROM_end__];<font></font>
define region RAM_region   = mem:[from __ICFEDIT_region_RAM_start__   to __ICFEDIT_region_RAM_end__];<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このマイクロコントローラー</font><u><font style="vertical-align: inherit;">のRAM</font></u><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x20000000 ... 0x2001FFFに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x008000000 ... 0x0807FFFFにあり</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始アドレスROM_startをRAMアドレスに簡単に変更できます。たとえば、RAM_startと終了アドレスROM_end__をRAM_end__アドレスに変更すると、プログラムは完全にRAMに配置されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反対の操作を行っ</font><font style="vertical-align: inherit;">て</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">メモリ領域に</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を指定することもでき</font><font style="vertical-align: inherit;">ます。プログラムは正常にコンパイルおよびフラッシュされますが、機能しません:) </font><font style="vertical-align: inherit;">
AVRなどの一部のマイクロコントローラーは、最初はプログラムメモリ、データメモリ、および周辺機器用に個別のアドレススペースを持っているため、そこにあります。このようなトリックは機能せず、プログラムはデフォルトで</font><u><font style="vertical-align: inherit;">ROMに書き込ま</font></u><font style="vertical-align: inherit;">れます</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> メモリ。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CortexMのすべてのアドレス空間は単一であり、コードとデータはどこにでも配置できます。</font><font style="vertical-align: inherit;">リンカ設定を使用して、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスの領域を設定できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">IARは</font><font style="vertical-align: inherit;">領域</font><u><font style="vertical-align: inherit;">ROM</font></u><font style="vertical-align: inherit;">メモリに</font><font style="vertical-align: inherit;">コードセグメント</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.textを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">持ってい</font><i><font style="vertical-align: inherit;">ます</font></i></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font></blockquote> <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトファイルとセグメント</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では、コードセグメントについて説明しました。コードセグメントを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイルされたモジュールごとに個別のオブジェクトファイルが作成され、次の情報が含まれます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードとデータセグメント </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DWARFデバッグ情報</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャラクターテーブル</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは</font><font style="vertical-align: inherit;">コードとデータ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメントに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味が</font><font style="vertical-align: inherit;">あります。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、メモリ内の物理アドレスに配置する必要があるコードまたはデータを含む要素です。</font><font style="vertical-align: inherit;">セグメントには複数のフラグメントを含めることができます。通常、各変数または関数ごとに1つのフラグメントです。</font><font style="vertical-align: inherit;">セグメントは</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMの</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">両方に配置でき</font><u><font style="vertical-align: inherit;">ます</font></u><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各セグメントには、名前とその内容を定義する属性があります。</font><font style="vertical-align: inherit;">この属性は、リンカーの構成でセグメントを定義するために使用されます。</font><font style="vertical-align: inherit;">たとえば、属性は次のようになります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> コード-実行可能コード</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> readonly-定数変数</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> readwrite-初期化された変数</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zeroinit-ゼロで初期化された変数</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、デバッグ情報を含むセグメントなど、他のタイプのセグメントもありますが、ここでは、アプリケーションのコードまたはデータを含むセグメントのみを対象とします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、セグメントはリンク可能な最小のブロックです。</font><font style="vertical-align: inherit;">ただし、必要に応じて、リンカはさらに小さなブロック（フラグメント）を示すこともできます。</font><font style="vertical-align: inherit;">このオプションは考慮せず、セグメントを扱います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイル中、データと関数は異なるセグメントに配置されます。</font><font style="vertical-align: inherit;">また、リンク時に、リンカーは実際の物理アドレスをさまざまなセグメントに割り当てます。</font><font style="vertical-align: inherit;">IARコンパイラには事前定義されたセグメント名があり、その一部を以下に示します。</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bss</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -0に初期化された静的変数とグローバル変数が含まれています</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.CSTACK-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムが使用するスタックが含まれています</font></font></li>
<li><i>.data</i> —       </li>
<li><i>.data_init</i> —       .data ,       </li>
<li><i>HEAP</i> —  ,      </li>
<li><i>.intvec</i> —     </li>
<li><i>.rodata</i> —   </li>
<li><i>.text </i> —   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
定数が置かれているかを理解するために、我々は、のみに興味があるであろう</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodataの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">-定数は、格納されたセグメント</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.DATA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -すべて初期化静的およびグローバル変数をしたセグメント</font><font style="vertical-align: inherit;">格納され</font><font style="vertical-align: inherit;">、</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bssの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -すべてゼロに初期化するものが格納されたセグメント（0）静的およびグローバル変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.DATA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の.text</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -コードを格納するためのセグメント。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、これは、変数を定義する</font></font><code>int val = 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、変数自体がコンパイラによって</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">に配置され、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readwrite</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">マークされ</font><font style="vertical-align: inherit;">、数値3は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.text</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">または</font><font style="vertical-align: inherit;">セグメントのいずれかに配置できることを意味し</font><i><font style="vertical-align: inherit;">ます</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.data_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内のリンカー用の特別なディレクティブ</font><i><font style="vertical-align: inherit;">が適用さ</font></i><font style="vertical-align: inherit;">れ、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み取り専用</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてマークさ</font><i><font style="vertical-align: inherit;">れている場合</font></i><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">.rodata</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
セグメントに</font><font style="vertical-align: inherit;">は定数データが​​含まれ、定数変数、文字列、集計リテラルなどが含まれます。</font><font style="vertical-align: inherit;">また、</font><u><b><font style="vertical-align: inherit;">このセグメントはメモリ内のどこにでも配置できます。</font></b></u><font style="vertical-align: inherit;">
これで、リンカ設定で何が規定されているのか、およびその理由が明らかになります。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><u><b><font style="vertical-align: inherit;"></font></b></u><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs">place in ROM_region   { readonly }; <span class="hljs-comment">//    .rodata  .data_init (  )  ROM: </span>
place in RAM_region   { readwrite, <span class="hljs-comment">//   .data, .bss,  .noinit </span>
                                     block STACK }; <span class="hljs-comment">//  STACK   HEAP  RAM</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readonly</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性でマークされたすべてのデータ</font><font style="vertical-align: inherit;">はROM_regionに配置する必要が</font><font style="vertical-align: inherit;">あり</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、異なるセグメントからのデータで、読み取り専用属性でマークされているものは、ROMに入ることができます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり、すべての定数はROMになければならないということですが、なぜコードの最初の部分で、定数オブジェクトがまだRAMにあるのでしょうか。</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WantToBeInROM</span>
{</span>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">int</span> i;
<span class="hljs-keyword">public</span>:<font></font>
  WantToBeInROM(<span class="hljs-keyword">int</span> value): i(value) {}
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> i;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> WantToBeInROM <span class="hljs-title">myConstInROM</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{  
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;myConstInROM &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数データ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状況を明確にする前に、まず、グローバル変数が共有メモリ、ローカル変数、つまり </font><font style="vertical-align: inherit;">「通常の」関数内で宣言された変数は、スタックまたはレジスタに作成され、静的ローカル変数も共有メモリに作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはC ++で何を意味します。</font><font style="vertical-align: inherit;">例を見てみましょう：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C2, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C3, 
         <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C4, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C5, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>&amp; C6)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; C1 &lt;&lt; C2 &lt;&lt; C3 &lt;&lt; C4 &lt;&lt; C5 &lt;&lt; C6 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//     </span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">int</span> Case1  = <span class="hljs-number">1</span>  ;     
<span class="hljs-comment">//  (      ) </span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Case2 = <span class="hljs-number">2</span>; 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//  . </span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Case3 = <span class="hljs-number">3</span> ;  
  <span class="hljs-comment">// . </span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Case4 = <span class="hljs-number">4</span> ; 
  <span class="hljs-comment">//      ,     .</span>
  <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">int</span> Case5 = Case1 + <span class="hljs-number">5</span> ;  
  <span class="hljs-comment">//     . </span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">int</span> Case6 = <span class="hljs-number">6</span> ;  <font></font>
  foo(Case1,Case2,Case3,Case4,Case5,Case6); <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべて定数データです。</font><font style="vertical-align: inherit;">ただし、それらのいずれにも上記の作成ルールが適用され、ローカル変数がスタックに作成されます。</font><font style="vertical-align: inherit;">したがって、リンカー設定を使用すると、次のようになります。</font></font><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case1グローバル定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROMに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なければなりません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">.rodataセグメント内</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case2グローバル定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROMに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なければなりません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">.rodataセグメント内</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case3ローカル定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内になければなりません</font><font style="vertical-align: inherit;">（定数はスタックセグメントのスタックに作成されました）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case4静的定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROMに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なければなりません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">.rodataセグメント内</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case5ローカル定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内になければなりません</font><font style="vertical-align: inherit;">（興味深いケースですが、ケース3とまったく同じです）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case6静的定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROMに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なければなりません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">.rodataセグメント内</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、デバッグ情報と生成されたマップファイルを見てみましょう。</font><font style="vertical-align: inherit;">デバッガーは、これらの定数がどのアドレスにあるかを示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n_/x9/at/n_x9atq0wduhrlaqbrhiudu5qc8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前に言ったように、アドレス0x0800 ...これらは</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレス</font><font style="vertical-align: inherit;">であり、0x200 ...これらは</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレス</font><u><font style="vertical-align: inherit;">です</font></u><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コンパイラーがこれらの定数を配布したセグメントを見てみましょう。</font></font><br>
<br>
<pre><code class="cmake hljs">  .rodata                const     <span class="hljs-number">0</span>x800'<span class="hljs-number">4</span>e2c     <span class="hljs-number">0</span>x4  main.o  //Case1<font></font>
  .rodata                const     <span class="hljs-number">0</span>x800'<span class="hljs-number">4</span>e30     <span class="hljs-number">0</span>x4  main.o //Case2<font></font>
  .rodata                const     <span class="hljs-number">0</span>x800'<span class="hljs-number">4</span>e34     <span class="hljs-number">0</span>x4  main.o //Case4<font></font>
  .rodata                const     <span class="hljs-number">0</span>x800'<span class="hljs-number">4</span>e38     <span class="hljs-number">0</span>x4  main.o //Case6</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4つのグローバル定数と静的定数が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">に分類され、2つのローカル変数はスタック上に作成され、それらのアドレスがスタックのアドレスに対応しているため、マップファイルには分類されませんでした。</font><font style="vertical-align: inherit;">CSTACKセグメントは0x2000'2488で始まり、0x2000'0488で終わります。</font><font style="vertical-align: inherit;">図からわかるように、定数はスタックの最初に作成されます。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラーは、グローバル定数と静的定数を</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">に配置します。その場所はリンカー設定で指定されます。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、もう1つの重要なポイントである</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意する価値があり</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。定数を含むグローバル変数と静的変数を初期化する必要があります。そして、これはいくつかの方法で行うことができます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">ある定数の場合</font><font style="vertical-align: inherit;">、初期化はコンパイル段階で行われます。値は定数が配置されているアドレスにすぐに書き込まれます。これが通常の変数である場合、ROMメモリーからグローバル変数に値をコピーすることで初期化が発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、グローバル変数が定義されている</font></font><code>int i = 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合、コンパイラーはデータセグメント</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">それを識別し</font><font style="vertical-align: inherit;">、リンカーは0x20000000：</font></font><br>
<code>.data inited 0x2000'0000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">配置し</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、初期化用の値（ 3）セグメントにあります</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at 0x8000190：</font></font><br>
<code>Initializer bytes const 0x800'0190</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードを記述した場合：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> c = i;</code></pre><br><font style="vertical-align: inherit;"></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバル変数が初期化された後</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまり実行時に</font><font style="vertical-align: inherit;">のみ</font><font style="vertical-align: inherit;">
、グローバル定数</font><font style="vertical-align: inherit;">が初期化さ</font><font style="vertical-align: inherit;">れることは明らかです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この場合、定数は</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></u> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に配置され</font><u><font style="vertical-align: inherit;">ます。</font></u></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ここで、</font></font><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の例</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WantToBeInROM</span>
{</span>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">int</span> i;
<span class="hljs-keyword">public</span>:<font></font>
  WantToBeInROM(<span class="hljs-keyword">int</span> value): i(value) {}
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> i;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> WantToBeInROM <span class="hljs-title">myConstInROM</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{  
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;myConstInROM &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;<font></font>
}<font></font>
</code></pre><br>
</div></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、自問してみましょう：コンパイラは定数オブジェクトをどのセグメントで定義しました</font></font><code>myConstInROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か？そして、答えが得られます。定数は</font><font style="vertical-align: inherit;">、ゼロ（0）に初期化された静的変数とグローバル変数を含む</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bss</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメントに</font><font style="vertical-align: inherit;">あります。</font><font style="vertical-align: inherit;">
どうして？ C ++では、定数として宣言され、動的初期化が必要なデータオブジェクトは読み取り/書き込みメモリに配置され、作成時に初期化されます。</font><font style="vertical-align: inherit;">
この場合、動的初期化が行われ、</font><font style="vertical-align: inherit;">コンパイラはこのオブジェクトを配置します。</font><i><font style="vertical-align: inherit;">.bss</font></i><font style="vertical-align: inherit;">セグメントに</font><font style="vertical-align: inherit;">、最初にすべてのフィールド0を初期化し、次に定数オブジェクトを作成するときにコンストラクターを呼び出して、フィールドを</font><font style="vertical-align: inherit;">値10 </font><font style="vertical-align: inherit;">で初期化します</font><font style="vertical-align: inherit;">。</font></font><br>
<code>.bss inited 0x2000'0004 0x4<br>
myConstInROM 0x2000'0004 0x4 </code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>const WantToBeInROM myConstInROM(10)</code><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><code>i</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラーにオブジェクトを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメントに配置させるにはどうすればよい</font><font style="vertical-align: inherit;">ですか？この質問への答えは簡単です。常に静的な初期化を実行する必要があります。これは次のようにして行うことができます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1.この例では、コンストラクターが非常に単純であるため、原則として、コンパイラーが動的初期化を静的に最適化できることがわかります。コンパイラーのIARの場合、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__ ro_placement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性で定数をマークできます</font><i><font style="vertical-align: inherit;">。</font></i></font><br>
<code>__ro_placement const WantToBeInROM myConstInROM </code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
このオプションを使用すると、コンパイラーは変数をROM内のアドレスに配置します。</font></font><br>
<code>myConstInROM 0x800'0144 0x4 Data</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、このアプローチは普遍的ではなく、一般的に非常に限定的です。したがって、私たちは正しい方法に進みます:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.それはコンストラクタを作ることです</font></font><code>constexpr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">静的な初期化を使用するようにコンパイラーに直ちに指示します。</font><font style="vertical-align: inherit;">コンパイル段階では、オブジェクト全体が事前に完全に「計算」され、すべてのフィールドが既知になります。</font><font style="vertical-align: inherit;">コンストラクターにconstexprを追加するだけです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトがROMに飛ぶ</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WantToBeInROM</span>
{</span>
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">int</span> i;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">WantToBeInROM</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span> </span>{}
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> i;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> WantToBeInROM <span class="hljs-title">myConstInROM</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{  
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;myConstInROM &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、定数オブジェクトがROM内にあることを確認するには、単純なルールに従う必要があります。</font></font><br>
<blockquote><ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードが配置される</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.text</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">はROMにある必要があります。</font><font style="vertical-align: inherit;">リンカ設定で構成されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバル定数と静的定数が配置される</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.rodata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セグメント</font><font style="vertical-align: inherit;">は、ROMに存在する必要があります。</font><font style="vertical-align: inherit;">リンカ設定で構成されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 定数はグローバルまたは静的でなければなりません。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 定数変数クラスの属性は変更可能であってはなりません </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> オブジェクトの初期化は静的でなければなりません。つまり、オブジェクトが定数になるクラスのコンストラクタはconstexprであるか、まったく定義されていない必要があります（動的な初期化はありません）。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 可能であれば、オブジェクトをconstではなくROMに保存する必要があると確信している場合は、constexprを使用してください。 </font></font></li>
</ol></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
constexprおよびconstexprコンストラクターについて少し説明します。</font><font style="vertical-align: inherit;">constとconstexprの主な違いは、const変数の初期化を実行時まで遅延できることです。</font><font style="vertical-align: inherit;">constexpr変数はコンパイル時に初期化する必要があります。</font></font><br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのconstexpr変数はconst型です。</font></font></u></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
constexprコンストラクターの定義は、次の要件を満たす必要があります。</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスに仮想基本クラスがあってはなりません。 </font></font><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">D2</span> :</span> <span class="hljs-keyword">virtual</span> BASE { 
  <span class="hljs-comment">//error, D2 must not have virtual base class.</span>
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">D2</span><span class="hljs-params">()</span> : <span class="hljs-title">BASE</span><span class="hljs-params">()</span>, <span class="hljs-title">mem</span><span class="hljs-params">(<span class="hljs-number">55</span>)</span> </span>{ }    
<span class="hljs-keyword">private</span>:
  <span class="hljs-keyword">int</span> mem; <font></font>
};  </code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> クラスの各パラメータータイプは、リテラルタイプである必要があります。</font></font></li>
<li>     <code>= delete</code>  <code>= default</code>.    :</li>
<li>     <code>try catch</code> .</li>
<li>      <code>nullptr</code></li>
<li>      <code>static_assert</code> </li>
<li>      <code>typedef</code>,     </li>
<li>         <code>using</code></li>
<li>           </li>
<li>     ,           ,   <code>constexpr</code>.</li>
<li>      ,   <code>constexpr</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスメンバーを初期化するとき、すべての型変換は定数式で有効でなければなりません。</font><font style="vertical-align: inherit;">たとえば</font><font style="vertical-align: inherit;">、ポインタから別の型への</font></font><code>reinterpret_cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャストおよびキャスト</font><font style="vertical-align: inherit;">は許可されていません</font></font><code>void*</code><font style="vertical-align: inherit;"></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗黙のデフォルトコンストラクターはconstexprコンストラクターです。</font><font style="vertical-align: inherit;">次に、いくつかの例を見てみましょう。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1. ROM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:<font></font>
    Test() {} ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-keyword">const</span> Test test; <span class="hljs-comment">//  ROM.    . i  0  . </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
属性iを初期化するとすぐに、オブジェクトはRAMに飛ぶので、これは記述しない方が適切です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例2. RAM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-comment">// i.       constexpr .</span>
  <span class="hljs-keyword">public</span>:<font></font>
    Test() {} ; <span class="hljs-comment">//       ,       ,  constexpr</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-keyword">const</span> Test test; <span class="hljs-comment">//  RAM. i    </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例3. RAM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:<font></font>
    Test(<span class="hljs-keyword">int</span> value): i(value) {} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  RAM. i    </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例4. ROM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span> </span>{} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  ROM. i     constexpr </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例5. RAM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span> </span>{} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  RAM.   </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例6. ROM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span> </span>{} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  ROM.   </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例7.コンパイルエラー</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span> </span>{} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-comment">// Get  ,  ,       (i),     .   ,       .</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例8.抽象クラスから継承したROM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">private</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> </span>{} ;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    }  <font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  ROM. i     constexpr , j   constexpr   ITest</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Give() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例9. ROM内のオブジェクトがRAM内にあるオブジェクトを集約する</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: <font></font>
    TestImpl(<span class="hljs-keyword">int</span> value): k(value), ITest(value)<font></font>
    {<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>
    </span>{<font></font>
      k = value; <font></font>
      j = value + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function">TestImpl <span class="hljs-title">testImpl</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; <span class="hljs-comment">//    RAM. </span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;<font></font>
    TestImpl &amp; obj; <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value, TestImpl &amp; ref)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(ref)</span>, <span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>, testImpl)</span></span>; <span class="hljs-comment">//  ROM.     constexpr </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例10. ROM内の同じで静的なオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: <font></font>
    TestImpl(<span class="hljs-keyword">int</span> value): k(value), ITest(value)<font></font>
    {<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>
    </span>{<font></font>
      k = value; <font></font>
      j = value + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;<font></font>
    TestImpl &amp; obj; <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value, TestImpl &amp; ref)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(ref)</span>,<span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> TestImpl <span class="hljs-title">testImpl</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; <span class="hljs-comment">// </span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>, testImpl)</span></span>; <span class="hljs-comment">//    ROM.     constexpr </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例11.そして、定数オブジェクトは静的ではないため、RAMにある</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: <font></font>
    TestImpl(<span class="hljs-keyword">int</span> value): k(value), ITest(value)<font></font>
    {<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>
    </span>{<font></font>
      k = value; <font></font>
      j = value + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;<font></font>
    TestImpl &amp; obj; <span class="hljs-comment">//   </span>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value, TestImpl &amp; ref)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(ref)</span>,<span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> TestImpl <span class="hljs-title">testImpl</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; <span class="hljs-comment">// </span>
  <span class="hljs-function"><span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>, testImpl)</span></span>; <span class="hljs-comment">//    RAM. </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例12.コンパイルエラー。</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: <font></font>
   TestImpl(<span class="hljs-keyword">int</span> value): k(value), ITest(value)<font></font>
    {<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>
    </span>{<font></font>
      k = value; <font></font>
      j = value + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;<font></font>
    TestImpl  obj; <span class="hljs-comment">//   TestImpl  </span>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(TestImpl(value))</span>, <span class="hljs-comment">//   constexpr   TestImpl</span>
                <span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> TestImpl <span class="hljs-title">testImpl</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; <span class="hljs-comment">// </span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//   </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例13.コンパイルエラー</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: 
   <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">TestImpl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">k</span><span class="hljs-params">(value)</span>, <span class="hljs-title">ITest</span><span class="hljs-params">(value)</span> <span class="hljs-comment">//   constexpr</span>
    </span>{<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> <span class="hljs-comment">//   ,  k  j.       ROM,        RAM</span>
    </span>{<font></font>
      k = value; <font></font>
      j = value + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;<font></font>
    TestImpl  obj; <font></font>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(TestImpl(value))</span>, <span class="hljs-comment">// constexpr     obj,    obj  .rodata .</span>
           <span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//        constexpr    </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-function"><span class="hljs-keyword">static</span> TestImpl <span class="hljs-title">testImpl</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; <span class="hljs-comment">// </span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//  </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例14. ROM内のオブジェクト</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ITest</span>
{</span>
<span class="hljs-keyword">protected</span>: 
  <span class="hljs-keyword">int</span> j;
<span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;  
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">ITest</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> : <span class="hljs-title">j</span><span class="hljs-params">(value)</span>
  </span>{<font></font>
  }<font></font>
  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Give</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
  </span>{
    <span class="hljs-keyword">return</span> j ;<font></font>
  }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestImpl</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k;
  <span class="hljs-keyword">public</span>: 
   <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">TestImpl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">k</span><span class="hljs-params">(value)</span>, <span class="hljs-title">ITest</span><span class="hljs-params">(value)</span>
    </span>{<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">override</span>
    </span>{
      <span class="hljs-keyword">return</span> j + <span class="hljs-number">10</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> <span class="hljs-keyword">const</span> <span class="hljs-comment">//   const</span>
    </span>{
      <span class="hljs-comment">//do something</span><font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>:</span> <span class="hljs-keyword">public</span> ITest<font></font>
{<font></font>
  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">const</span> TestImpl  obj; <span class="hljs-comment">// ,    constexpr </span>
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span>: <span class="hljs-title">i</span><span class="hljs-params">(value)</span>, <span class="hljs-title">obj</span><span class="hljs-params">(TestImpl(value))</span>, <span class="hljs-title">ITest</span><span class="hljs-params">(value+<span class="hljs-number">1</span>)</span> 
    </span>{<font></font>
    } ;<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
      <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Set</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{<font></font>
      obj.Set(<span class="hljs-number">100</span>) ; <span class="hljs-comment">//  </span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//static TestImpl testImpl(1); // </span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> Test <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>; <span class="hljs-comment">//    ROM.     constexpr </span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Set() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、配列を含む定数オブジェクト、constexpr関数による配列の初期化。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
<span class="hljs-keyword">private</span>: 
    <span class="hljs-keyword">int</span> k[<span class="hljs-number">100</span>];
   <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitArray</span><span class="hljs-params">()</span>
   </span>{
     <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
     <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; it: k)<font></font>
     {<font></font>
       it = i++ ;       <font></font>
     }<font></font>
   }<font></font>
<font></font>
<span class="hljs-keyword">public</span>: 
   <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">()</span>: <span class="hljs-title">k</span><span class="hljs-params">()</span>
   </span>{<font></font>
     InitArray(); <span class="hljs-comment">// constexpr    </span><font></font>
   }<font></font>
   <font></font>
   <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> <span class="hljs-keyword">const</span>
   </span>{
     <span class="hljs-keyword">return</span> k[index];<font></font>
   }<font></font>
} ;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> Test test; <span class="hljs-comment">//    ROM.     ,  constexpr .</span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; test.Get(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span> ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参照：</font></font><br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IAR C / C ++開発ガイド</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constexprコンストラクター（C ++ 11）</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constexpr（C ++）</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PS。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
との非常に有用な議論の後</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヴァルダロス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のモーメントの正接定数を追加する必要があります。</font><font style="vertical-align: inherit;">C ++標準およびこのドキュメント</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N1076.pdfによると</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1.存続期間中に定数オブジェクト（クラスの変更可能なメンバーを除く）を変更すると、未定義の動作が発生します。</font><font style="vertical-align: inherit;">それら。</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> ci = <span class="hljs-number">1</span> ;
 <span class="hljs-keyword">int</span>* iptr = <span class="hljs-keyword">const_cast</span>&lt;<span class="hljs-keyword">int</span>*&gt;(&amp;ci); <span class="hljs-comment">//UB,      </span>
*iptr = <span class="hljs-number">2</span> ; 
</code></pre><br>
<pre><code class="cpp hljs"> <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span>* ci = &amp;i ;
<span class="hljs-keyword">int</span>* iptr = <span class="hljs-keyword">const_cast</span>&lt;<span class="hljs-keyword">int</span> *&gt; (ci); <span class="hljs-comment">//  </span>
*iptr = <span class="hljs-number">2</span> ; <span class="hljs-comment">// UB,   i</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.問題は、これが定数オブジェクトの存続期間中のみ機能することですが、コンストラクターおよびデストラクターでは機能しません。</font><font style="vertical-align: inherit;">したがって、そうすることは非常に正当です。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
<span class="hljs-keyword">public</span>:
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">()</span>: <span class="hljs-title">i</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span> </span>{<font></font>
    foo(<span class="hljs-keyword">this</span>) ;<font></font>
  }<font></font>
} ;<font></font>
<font></font>
Test *test1;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(Test* value)</span>
</span>{<font></font>
  value-&gt;i = <span class="hljs-number">1</span>;   <span class="hljs-comment">//       0  1</span>
  test1 =  value ; <span class="hljs-comment">//          </span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> Test test;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
   test1-&gt;i = <span class="hljs-number">2</span>;     <span class="hljs-comment">//           2.</span>
   <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;test &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれは合法であると考えられています。</font><font style="vertical-align: inherit;">constexprコンストラクターとその中でconstexpr関数を使用したという事実にもかかわらず。</font><font style="vertical-align: inherit;">オブジェクトはRAMに直接送られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを回避するには、constの代わりにconst-constexprを使用します。コンパイルエラーが発生し、何かがおかしく、オブジェクトを定数にすることはできません。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{</span>
<span class="hljs-keyword">public</span>:
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-title">Test</span><span class="hljs-params">()</span>: <span class="hljs-title">i</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span> </span>{<font></font>
    foo(<span class="hljs-keyword">this</span>) ;<font></font>
  }<font></font>
} ;<font></font>
<font></font>
Test *test1;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(Test* value)</span>
</span>{<font></font>
  value-&gt;i = <span class="hljs-number">1</span>;   <span class="hljs-comment">//       0  1</span>
  test1 =  value ; <span class="hljs-comment">//          </span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">constexpr</span> Test test; <span class="hljs-comment">// / Error[Pe2400]: calling the default constructor for "Test" does not produce a constant value main.cpp 151 </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
   test1-&gt;i = <span class="hljs-number">2</span>;     <span class="hljs-comment">//           2.</span>
   <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; &amp;test &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453252/index.html">Sportmasterクラブプログラムの実施方法</a></li>
<li><a href="../ja453254/index.html">GOSTのコード、Grasshopper、そのSBox、および失われた種子について</a></li>
<li><a href="../ja453256/index.html">SObjectizer-5.6.0：さらに成長するためにライブカット</a></li>
<li><a href="../ja453258/index.html">PT2399チップを使用したリバーブペダルの作成（パート1）</a></li>
<li><a href="../ja453260/index.html">DPI設定機能</a></li>
<li><a href="../ja453264/index.html">Virtuali-tee：カバーはしないが露出する「医療用Tシャツ」</a></li>
<li><a href="../ja453272/index.html">GitHubスポンサー：オープンソースに貢献する新しい方法</a></li>
<li><a href="../ja453274/index.html">サムスンペイの隠し手数料Yandex.Money</a></li>
<li><a href="../ja453276/index.html">Arduinoとタイマー割り込み</a></li>
<li><a href="../ja453278/index.html">なぜエンジニアはアプリケーションの監視を気にしないのですか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>