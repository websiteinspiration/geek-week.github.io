<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßíüèø üôãüèΩ üì§ Warum Discord von Go nach Rust migriert ü¶Ü üò£ ü§∑üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rust wird zu einer erstklassigen Sprache in einer Vielzahl von Bereichen. Wir bei Discord setzen es erfolgreich sowohl auf Server- als auch auf Client...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Warum Discord von Go nach Rust migriert</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487116/"><img src="https://habrastorage.org/getpro/habr/post_images/84a/0f1/d61/84a0f1d6126d5fd59b9c708f19c84692.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rust wird zu einer erstklassigen Sprache in einer Vielzahl von Bereichen. </font><font style="vertical-align: inherit;">Wir bei Discord setzen es erfolgreich sowohl auf Server- als auch auf Clientseite ein. </font><font style="vertical-align: inherit;">Zum Beispiel auf der Clientseite in der Videokodierungspipeline f√ºr Go Live und auf der Serverseite f√ºr die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir NIF-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktionen (Native Implemented Functions). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben k√ºrzlich die Leistung eines einzelnen Dienstes dramatisch verbessert und ihn von Go to Rust umgeschrieben. </font><font style="vertical-align: inherit;">In diesem Artikel wird erl√§utert, warum es f√ºr uns sinnvoll war, den Service neu zu schreiben, wie wir ihn durchgef√ºhrt haben und wie stark sich die Produktivit√§t verbessert hat.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read State Tracking Service (Status lesen)</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Unternehmen basiert auf einem Produkt. Beginnen wir also mit einem Kontext, den wir genau von Go to Rust √ºbertragen haben. Dies ist ein Read States-Dienst. Ihre einzige Aufgabe ist es, zu verfolgen, welche Kan√§le und Nachrichten Sie lesen. Auf die Lesezust√§nde wird jedes Mal zugegriffen, wenn Sie eine Verbindung zu Discord herstellen, wenn Sie eine Nachricht senden und wenn Sie die Nachricht lesen. Kurz gesagt, Zust√§nde werden kontinuierlich gelesen und befinden sich auf einem ‚Äûhei√üen Pfad‚Äú. Wir m√∂chten sicherstellen, dass Discord immer schnell ist, daher sollte die Statuspr√ºfung schnell sein.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Implementierung des Service on Go erf√ºllte nicht alle Anforderungen. </font><font style="vertical-align: inherit;">Die meiste Zeit funktionierte es schnell, aber alle paar Minuten gab es starke Verz√∂gerungen, die f√ºr die Benutzer sp√ºrbar waren. </font><font style="vertical-align: inherit;">Nachdem wir die Situation untersucht hatten, stellten wir fest, dass die Verz√∂gerungen auf die Hauptmerkmale von Go zur√ºckzuf√ºhren waren: das Speichermodell und den Garbage Collector (GC).</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum gehen, erf√ºllt unsere Leistungsziele nicht</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu erkl√§ren, warum Go unsere Leistungsziele nicht erreicht, m√ºssen zun√§chst Datenstrukturen, Skalierung, Zugriffsmuster und Servicearchitektur er√∂rtert werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Speichern von Statusinformationen verwenden wir eine Datenstruktur, die als "Status lesen" bezeichnet wird. In Discord gibt es Milliarden davon: einen Status f√ºr jeden Benutzer pro Kanal. Jeder Zustand hat mehrere Z√§hler, die atomar aktualisiert und oft auf Null zur√ºckgesetzt werden m√ºssen. Einer der Z√§hler ist beispielsweise die Nummer </font></font><code>@mention</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Kanal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Atomz√§hler schnell zu aktualisieren, verf√ºgt jeder Read States-Server √ºber einen LRU-Cache (Least Recent Used). Jeder Cache hat Millionen von Benutzern und zig Millionen von Zust√§nden. Der Cache wird hunderttausend Mal pro Sekunde aktualisiert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus Sicherheitsgr√ºnden wird der Cache mit dem Cassandra-Datenbankcluster synchronisiert. </font><font style="vertical-align: inherit;">Wenn ein Schl√ºssel aus dem Cache gedr√ºckt wird, geben wir die Status dieses Benutzers in die Datenbank ein. </font><font style="vertical-align: inherit;">In Zukunft planen wir, die Datenbank bei jeder Statusaktualisierung innerhalb von 30 Sekunden zu aktualisieren. </font><font style="vertical-align: inherit;">Dies sind Zehntausende von Datens√§tzen in der Datenbank pro Sekunde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgende Grafik zeigt die Antwortzeit und die CPU-Auslastung im Spitzenzeitintervall f√ºr den Go </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><sup><font style="vertical-align: inherit;">1-</font></sup></a><font style="vertical-align: inherit;"> Dienst</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><sup><font style="vertical-align: inherit;"></font></sup></a><a name="1_1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist ersichtlich, dass Verz√∂gerungen und Lastst√∂√üe auf der CPU ungef√§hr alle zwei Minuten auftreten.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/90d/37b/89f/90d37b89f25eab54420107e63c086c44.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Woher kommt also das Wachstum der Verz√∂gerungen alle zwei Minuten?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Go wird der Speicher nicht sofort freigegeben, wenn eine Taste aus dem Cache gedr√ºckt wird. Stattdessen wird der Garbage Collector regelm√§√üig ausgef√ºhrt und sucht nach nicht verwendeten Speicherbereichen. Dies ist eine Menge Arbeit, die ein Programm verlangsamen kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist sehr wahrscheinlich, dass regelm√§√üige Verlangsamungen unseres Dienstes mit der Speicherbereinigung verbunden sind. Wir haben jedoch einen sehr effizienten Go-Code mit minimaler Speicherzuweisung geschrieben. Es sollte nicht mehr viel M√ºll √ºbrig sein. Was ist da los? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Durchsuchen des Go-Quellcodes haben wir erfahren, dass Go </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mindestens alle zwei Minuten mit der</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Speicherbereinigung beginnt </font><font style="vertical-align: inherit;">. Unabh√§ngig von der Gr√∂√üe des Heapspeichers erzwingt Go den Start, wenn der GC zwei Minuten lang nicht gestartet wurde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben beschlossen, dass Sie diese Spitzen mit gro√üen Verz√∂gerungen vermeiden k√∂nnen, wenn Sie GC h√§ufiger ausf√ºhren. Daher legen wir einen Endpunkt im Service fest, um den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GC-Prozentwert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im laufenden Betrieb zu √§ndern </font><font style="vertical-align: inherit;">. Leider hat die Konfiguration von GC Percent nichts beeinflusst. Wie konnte das passieren? Es stellt sich heraus, dass GC nicht √∂fter starten wollte, weil wir nicht oft genug Speicher zugewiesen haben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir begannen weiter zu graben. Es stellte sich heraus, dass solche gro√üen Verz√∂gerungen nicht aufgrund der gro√üen Menge an freigegebenem Speicher auftreten, sondern weil der Garbage Collector den gesamten LRU-Cache durchsucht, um den gesamten Speicher zu √ºberpr√ºfen. Dann haben wir beschlossen, dass das Scan-Volumen abnimmt, wenn wir den LRU-Cache verringern. Aus diesem Grund haben wir dem Dienst einen weiteren Parameter hinzugef√ºgt, um die Gr√∂√üe des LRU-Cache zu √§ndern, und die Architektur ge√§ndert, wodurch die LRU auf jedem Server in viele separate Caches aufgeteilt wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und so geschah es. Bei kleineren Caches werden Spitzenverz√∂gerungen reduziert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider hat der Kompromiss mit der Verringerung des LRU-Cache das 99. Perzentil erh√∂ht (dh der Durchschnittswert f√ºr eine Stichprobe von 99% der Verz√∂gerungen hat sich erh√∂ht, mit Ausnahme der Spitzenverz√∂gerungen). Dies liegt daran, dass durch Verringern des Caches die Wahrscheinlichkeit verringert wird, dass sich der Lesestatus des Benutzers im Cache befindet. Wenn es nicht hier ist, m√ºssen wir uns an die Datenbank wenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einer gro√üen Anzahl von Lasttests f√ºr verschiedene Cache-Gr√∂√üen haben wir eine akzeptable Einstellung gefunden. </font><font style="vertical-align: inherit;">Obwohl nicht ideal, war es eine zufriedenstellende L√∂sung, so dass wir den Service f√ºr eine lange Zeit verlassen haben, um so zu arbeiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig haben wir Rust sehr erfolgreich in anderen Discord-Systemen implementiert und daher gemeinsam beschlossen, Frameworks und Bibliotheken f√ºr neue Dienste nur in Rust zu schreiben. </font><font style="vertical-align: inherit;">Und dieser Dienst schien ein ausgezeichneter Kandidat f√ºr die Portierung nach Rust zu sein: Er ist klein und autonom, und wir hofften, dass Rust diese Ausbr√ºche mit Verz√∂gerungen beheben und den Dienst letztendlich f√ºr Benutzer angenehmer machen w√ºrde </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup></a><a name="2_2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speicherverwaltung in Rust</font></font></h1><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust ist unglaublich schnell und effizient mit Speicher: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Da keine Laufzeitumgebung und kein Garbage Collector vorhanden sind,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eignet es sich f√ºr Hochleistungsdienste, eingebettete Anwendungen und l√§sst sich problemlos in andere Sprachen integrieren. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup></a><a name="3_3"></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rust hat keinen M√ºllsammler, deshalb haben wir beschlossen, dass es keine solchen Verz√∂gerungen wie Go geben w√ºrde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Speicherverwaltung verwendet er einen ziemlich einzigartigen Ansatz mit der Idee, Speicher zu "besitzen". </font><font style="vertical-align: inherit;">Kurz gesagt, Rust verfolgt, wer das Recht hat, aus dem Speicher zu lesen und in den Speicher zu schreiben. </font><font style="vertical-align: inherit;">Er wei√ü, wann ein Programm Speicher verwendet, und gibt ihn sofort frei, sobald kein Speicher mehr ben√∂tigt wird. </font><font style="vertical-align: inherit;">Rust erzwingt Speicherregeln zur Kompilierungszeit, wodurch die M√∂glichkeit von Speicherfehlern zur Laufzeit praktisch ausgeschlossen wird. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></sup></a><a name="4_4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie m√ºssen den Speicher nicht manuell verfolgen. </font><font style="vertical-align: inherit;">Der Compiler wird sich darum k√ºmmern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn in der Rust-Version der Lesestatus aus dem LRU-Cache ausgeschlossen wird, wird der Speicher sofort freigegeben. </font><font style="vertical-align: inherit;">Dieser Speicher sitzt nicht und wartet nicht auf den Garbage Collector. </font><font style="vertical-align: inherit;">Rust wei√ü, dass es nicht mehr verwendet wird und gibt es sofort frei. </font><font style="vertical-align: inherit;">Zur Laufzeit gibt es keinen Prozess zum Scannen des freizugebenden Speichers.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchroner Rost</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab jedoch ein Problem mit dem Rust-√ñkosystem. Zum Zeitpunkt der Implementierung unseres Dienstes gab es im stabilen Zweig von Rust keine anst√§ndigen asynchronen Funktionen. F√ºr einen Netzwerkdienst ist die asynchrone Programmierung ein Muss. Die Community hat mehrere Bibliotheken entwickelt, jedoch mit einer nicht trivialen Verbindung und sehr dummen Fehlermeldungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gl√ºcklicherweise hat das Rust-Team hart daran gearbeitet, die asynchrone Programmierung zu vereinfachen, und sie war bereits auf dem instabilen Kanal (Nightly) verf√ºgbar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Discord hatte nie Angst, vielversprechende neue Technologien zu lernen. Zum Beispiel waren wir einer der ersten Benutzer von Elixir, React, React Native und Scylla. Wenn eine Technologie vielversprechend aussieht und uns einen Vorteil verschafft, sind wir bereit, uns den unvermeidlichen Schwierigkeiten bei der Implementierung und der Instabilit√§t fortschrittlicher Tools zu stellen. Dies ist einer der Gr√ºnde, warum wir so schnell ein Publikum von 250 Millionen Benutzern mit weniger als 50 Programmierern im Bundesstaat erreicht haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Einf√ºhrung neuer asynchroner Funktionen aus dem instabilen Rust-Kanal ist ein weiteres Beispiel f√ºr unsere Bereitschaft, eine neue, vielversprechende Technologie einzuf√ºhren. Das Engineering-Team entschied sich, die erforderlichen Funktionen zu implementieren, ohne auf deren Unterst√ºtzung in der stabilen Version zu warten. Zusammen mit anderen Vertretern der Gemeinschaft haben wir alle aufgetretenen Probleme √ºberwunden und jetzt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchrones Rust</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem stabilen Zweig gehalten. </font><font style="vertical-align: inherit;">Unser Tarif hat sich ausgezahlt.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung, Stresstest und Start</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nur den Code neu zu schreiben war einfach. Wir haben mit einer groben Sendung begonnen und sie dann auf Orte reduziert, an denen es Sinn machte. Zum Beispiel hat Rust ein exzellentes Typsystem mit umfassender Unterst√ºtzung f√ºr Generika (f√ºr die Arbeit mit Daten aller Art), so dass wir den Go-Code leise weggeworfen haben, was den Mangel an Generika kompensierte. Dar√ºber hinaus ber√ºcksichtigt das Rust-Speichermodell die Speichersicherheit in verschiedenen Threads, sodass wir die Schutzgoroutinen weggeworfen haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Belastungstests zeigten sofort ein hervorragendes Ergebnis. Die Serviceleistung von Rust war genauso hoch wie die der Go-Version, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jedoch ohne diese Verz√∂gerungen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalerweise haben wir die Rust-Version praktisch nicht optimiert. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aber selbst mit den einfachsten Optimierungen konnte Rust eine sorgf√§ltig abgestimmte Version von Go √ºbertreffen.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist ein beredter Beweis daf√ºr, wie einfach es ist, effektive Rust-Programme zu schreiben, anstatt tief in Go einzusteigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wir haben die einfache Leistung quo nicht erf√ºllt. </font><font style="vertical-align: inherit;">Nach ein wenig Profilerstellung und Optimierung haben </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir Go in jeder Hinsicht √ºbertroffen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Verz√∂gerung, CPU und Speicher - in der Rust-Version wurde alles besser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rostleistungsoptimierungen enthalten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wechseln zu BTreeMap anstelle von HashMap im LRU-Cache, um die Speichernutzung zu optimieren.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen der urspr√ºnglichen Metrikbibliothek durch eine Version mit Unterst√ºtzung f√ºr modernes Parallelit√§ts-Rust.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verringern Sie die Anzahl der Kopien im Speicher.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zufrieden entschieden wir uns, den Service bereitzustellen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Start verlief ziemlich reibungslos, da wir Stresstests durchgef√ºhrt haben. </font><font style="vertical-align: inherit;">Wir haben den Service mit einem Testknoten verbunden, mehrere Grenzf√§lle entdeckt und behoben. </font><font style="vertical-align: inherit;">Bald darauf rollten sie eine neue Version in den gesamten Serverpark. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Ergebnisse sind unten gezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das lila Diagramm ist Go, das blaue Diagramm ist Rust.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/yb/-v/mi/yb-vmise0bioz33f8yfrockjr_0.png"></a><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erh√∂hen Sie die Cache-Gr√∂√üe</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem der Dienst mehrere Tage erfolgreich funktioniert hatte, haben wir beschlossen, den LRU-Cache erneut zu vergr√∂√üern. </font><font style="vertical-align: inherit;">Wie oben erw√§hnt, war dies in der Go-Version nicht m√∂glich, da sich die Zeit f√ºr die Speicherbereinigung erh√∂hte. </font><font style="vertical-align: inherit;">Da wir keine Speicherbereinigung mehr durchf√ºhren, k√∂nnen Sie die Cache-Z√§hlung erh√∂hen, um die Leistung noch weiter zu steigern. </font><font style="vertical-align: inherit;">Daher haben wir den Speicher auf den Servern erh√∂ht, die Datenstruktur f√ºr eine geringere Speichernutzung (zum Spa√ü) optimiert und die Cache-Gr√∂√üe auf 8 Millionen Lesezustandszust√§nde erh√∂ht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgenden Ergebnisse sprechen f√ºr sich. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beachten Sie, dass die durchschnittliche Zeit jetzt in Mikrosekunden und die maximale Verz√∂gerung </font></font><code>@mention</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in Millisekunden gemessen wird.</font></font></b><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93f/55a/500/93f55a500413c691a4e711e4c90ceada.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ñkosystementwicklung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schlie√ülich hat Rust ein wunderbares √ñkosystem, das schnell w√§chst. </font><font style="vertical-align: inherit;">Eine neue Version der von uns verwendeten asynchronen Laufzeit ist beispielsweise Tokio 0.2. </font><font style="vertical-align: inherit;">Wir haben aktualisiert und ohne unser Zutun die Belastung der CPU automatisch reduziert. </font><font style="vertical-align: inherit;">In der folgenden Grafik k√∂nnen Sie sehen, wie sich die Last seit dem 16. Januar verringert hat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5f/128/490/e5f12849036cfea0b9e9246a1e321ed0.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschlie√üende Gedanken</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Discord verwendet Rust derzeit in vielen Teilen des Software-Stacks: f√ºr GameSDK, zum Aufnehmen und Codieren von Videos in Go Live, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir NIF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mehreren Backend-Diensten und vielem mehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie ein neues Projekt oder eine neue Softwarekomponente starten, ziehen wir definitiv die Verwendung von Rust in Betracht. Nat√ºrlich nur dort, wo es Sinn macht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben der Leistung bietet Rust Entwicklern viele weitere Vorteile. Zum Beispiel vereinfachen die Typensicherheit und der Leihpr√ºfer das Refactoring erheblich, wenn sich die Produktanforderungen √§ndern oder neue Sprachfunktionen eingef√ºhrt werden. Das √ñkosystem und die Werkzeuge sind ausgezeichnet und entwickeln sich schnell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unterhaltsame Tatsache: Das Rust-Team verwendet auch Discord zur Koordinierung. Es gibt sogar eine sehr n√ºtzliche</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust Community Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , wo wir manchmal chatten.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/webt/br/pc/l_/brpcl_fl4bwj8fcmaeodxotfw5s.png"></div></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fu√ünoten</font></font></h4><br>
<font color="gray"><ol>
<li><a name="1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagramme aus Go Version 1.9.2. </font><font style="vertical-align: inherit;">Wir haben die Versionen 1.8, 1.9 und 1.10 ohne Verbesserungen ausprobiert. </font><font style="vertical-align: inherit;">Die erste Migration von Go nach Rust wurde im Mai 2019 abgeschlossen. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[zur√ºckgeben]</font></font></a><br>
</li>
<li><a name="2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus Gr√ºnden der √úbersichtlichkeit empfehlen wir nicht, alles in Rust ohne Grund neu zu schreiben. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[zur√ºckgeben]</font></font></a><br>
</li>
<li><a name="3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zitat aus der offiziellen Seite. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[zur√ºckgeben]</font></font></a><br>
</li>
<li><a name="4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nat√ºrlich, bis Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsicher verwenden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[zur√ºckgeben]</font></font></a></li>
</ol></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487116/">https://habr.com/ru/post/de487116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487100/index.html">Unver√§nderliche Datenstrukturen auf dem neuesten Stand der Technik</a></li>
<li><a href="../de487106/index.html">RunUO-Pr√ºfung des PVS-Studio-Analysators</a></li>
<li><a href="../de487108/index.html">Mobiles Spielerprofil: MyTracker Research</a></li>
<li><a href="../de487110/index.html">Slurm SRE. Ein komplettes Experiment mit Experten von Booking.com und Google.com</a></li>
<li><a href="../de487112/index.html">Rand des Wahnsinns: Der Grundkreis</a></li>
<li><a href="../de487118/index.html">Loki - Sammeln von Protokollen nach dem Prometheus-Ansatz</a></li>
<li><a href="../de487120/index.html">Wie man K√§tzchen verteilt</a></li>
<li><a href="../de487122/index.html">Google JavaScript Style Guide √úbersetzung</a></li>
<li><a href="../de487124/index.html">Interview mit Borey Yangel √ºber Yandex Selbstfahrer und Alices Sch√∂pfungsgeschichte</a></li>
<li><a href="../de487126/index.html">Wie Unternehmensentwicklungsteams GitLab und Mattermost ChatOps verwenden, um die Entwicklung zu beschleunigen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>