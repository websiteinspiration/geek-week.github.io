<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤹🏾 🎴 📧 Methods for dealing with legacy code using GitLab as an example 🌑 👴🏾 👨‍👧‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You can endlessly cheat on whether GitLab is a good product. It’s better to look at the numbers: according to the results of the investment round, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Methods for dealing with legacy code using GitLab as an example</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/493000/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can endlessly cheat on whether GitLab is a good product. It’s better to look at the numbers: according to the results of the investment round, the GitLab valuation was $ 2.7 billion, while the previous valuation was $ 1.1 billion. This means rapid growth and the company will hire more and more front-end developers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the story of the appearance of the frontend in GitLab. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/uq/uh/cyuquhlxnzithh35ujtiswr5upy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a graph of the number of front-end vendors in GitLab, beginning in 2016, when they were not there at all, and ending in 2019, when there were already a few dozen of them. But GitLab itself has been around for 7 years. So, until 2017, the main code on the frontend was written by backend developers, worse, the backend developers on Ruby on Rails (in no case do we want to offend anyone and explain below what we are talking about).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For 7 years, any project, whether you like it or not, is becoming obsolete. </font><font style="vertical-align: inherit;">At some point, refactoring becomes impossible to put off anymore. </font><font style="vertical-align: inherit;">And the journey begins, full of adventure, the final point of which never reach. </font><font style="vertical-align: inherit;">About how this happens in GitLab, said Ilya Klimov.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3tdfBMRq34o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About the speaker: Ilya Klimov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xanf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) senior frontend engineer at GitLab. </font><font style="vertical-align: inherit;">Prior to that, he worked in startups and outsourcing, led a small outsourcing company. </font><font style="vertical-align: inherit;">Then I realized that I had not had time to work out the product yet, and came to GitLab. </font></font></em><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The article is based on a report by Ilya at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FrontendConf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , therefore it does not so much structure the information as reflects the speaker’s experience. </font><font style="vertical-align: inherit;">It may seem overly conversational, but no less interesting from the point of view of working with legacy. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In GitLab, as in many other projects, they are gradually migrating from old technologies to something more relevant:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CoffeeScript in JavaScript. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Developers on Ruby on Rails, when they started the project, could not help but pay attention to CoffeeScript, which looks very similar to Ruby.</font></font></li>
<li><strong>JQuery  Vue. </strong>  ,        JQuery.   GitLab  SPA.  server-side rendering  progressive enhancement,        Vue-.  ,    :     Vue-,    .</li>
<li><strong>Karma  Jest. </strong>Jest  -     . Karma     , , .</li>
<li><strong>REST  GraphQL</strong> ,   , <strong>Vuex  Apollo</strong>.      Vuex,    Redux   Vue,  Apollo local state  ,     .    GraphQL    ,      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, replacements take place in several directions at once, in the project there is simultaneously a legacy-code at different stages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now imagine that you are coming to a project that is in the middle of all these migrations. The standard and reference point for me was the situation when you open editing a project, press the save button - and what do you think is coming? If you thought that we are such old-phages that HTML comes, then no. JavaScript comes in that you need to “evolve” to display a pop-up window. This is the bottom point in my legacy picture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further up: self-written classes in jQuery, Vue-components and, as the highest point, new modern features written with Vuex, Apollo, Jest, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is what my contribution-graph on GitLab looks like.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ew/ml/io/ewmliousc_qzjvrr0pfshtqlrj0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In it - and this is very important for understanding the essence of the story and all my pains - several segments can be distinguished:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onboarding</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the April area. </font><font style="vertical-align: inherit;">“Honeymoon” when I just started working at GitLab. </font><font style="vertical-align: inherit;">At this time, beginners are given easier tasks.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the end of April until mid-May there are only a few commits - a period of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denial</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : “No, it cannot be that everything is done that way!” </font><font style="vertical-align: inherit;">I tried to understand where I don’t understand something, so there are so few commits.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second half of May is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : "I don't give a damn about everything - I need to move production, share features, try to do something about it."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The beginning of June (zero commits) is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depression</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This was not a vacation, I watched and understood that my hands were falling, I do not know what to do with it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, I </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agreed with myself</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decided that I was hired as a professional, and I can make GitLab better. </font><font style="vertical-align: inherit;">In June and July, I offered a huge number of improvements. </font><font style="vertical-align: inherit;">Not all of them resonated for reasons that we will talk about.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now I am at the stage of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adoption</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and clearly understand: how, where, why and what to do with all this.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I’ll tell you in more detail what I did from August to October. </font><font style="vertical-align: inherit;">Honestly, in a small outsourcing company or in a startup, I would have been fired five times with such productivity in these three months. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, in three months I did:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segmented control - three buttons.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The search string that stores the local history is a slightly more complex component.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spinner. </font><font style="vertical-align: inherit;">And this component is not frozen yet.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/p6/fw/uw/p6fwuwfxi5dxzpyuewu9vn7_zc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, step by step, we will analyze why this happened and how to live with it. If it seems to you that I'm exaggerating, here is a screenshot of some of the tasks that hang on me on GitLab (you can look directly at GitLab, it is open). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/em/ax/o9/emaxo9j3iwkxpdefee2ghsokjpi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
See: missed 12.1, missed 12.2, missed 12.3. Sprint lasts a month, and segmented control - 3 sprints. Spinner is still gone, he will be our main character. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem of refactoring and the philosophy of refactoring has been facing humanity for a very long time - for millennia. Now I will prove:</font></font><br>
<blockquote><em>«        ;      ,   ,   ;        ;    ,  .<br>
<br>
 ,   ,    ,  :  ».<br>
<br>
 </em></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Bible tells us how to combine old and new functionality. </font><font style="vertical-align: inherit;">The second part of the quotation is valuable from a management point of view: no matter how you go out with initiatives, you will meet with great resistance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the depression phase, I watched a lot of reports on refactoring large projects, but about 70% of them reminded me of a joke. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javist talk: </font></font></em><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- How do we speed up our Java application? </font></font></em><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Oh, so I had a report about it! </font><font style="vertical-align: inherit;">Do you want to tell? </font></font></em><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- To tell and I can, I would speed up! </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you still decide to embark on the dangerous and shaky path of refactoring, I have some simple recipes that I have developed for myself and which work in conditions that are close to reality.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Insulation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To speed things up, improve, refactor, you need to cut the elephant into steaks, that is, divide the task into parts. GitLab is very large, we have a Slack channel “Is this known”, where people ask questions like “Is this a bug or a feature, who can explain?” - and the answer is not always found. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A simple example: screenshots of the same place in GitLab, taken with a difference of one day. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_i/e7/t3/_ie7t3qfxsof8p9kwrdzy2wsymi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was very upset, because I was working on this button, and this is all one way or another problems with the button. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happened? It's simple: we develop a design system, and as part of a separate story book tool for testing a design system, we disabled the global CSS GitLab to check how CSS components are isolated from global CSS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Summarizing: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSS is no longer save</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at least in GitLab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I’ve been working with JavaScript for 14 years and have never seen a project that at least a year or two in length preserve fully managed CSS. By the way, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTML can</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not be saved </font><strong><font style="vertical-align: inherit;">either</font></strong><font style="vertical-align: inherit;"> (in GitLab for sure). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab has been developed for a long time and backendov. They made a controversial decision to use Bootstrap because Bootstrap offered a backend-friendly layout system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what is Bootstrap in terms of component isolation philosophy? This is about 600-700 global classes (in fact, each CSS class is global) that permeate the entire application. In terms of manageability, nothing good will come of it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next action (let's not call it a mistake) - GitLab took Vue.js. The choice was reasonable, because of the three frameworks, it is Vue that allows you to most smoothly rewrite something. You don’t need to immediately throw out and cut a large Single Page Application, but you can rewrite individual small nodes. Now it can be done on Angular, but 3-4 years ago, when Angular 2 appeared, it could not coexist on a page in more than one instance. React is also possible now, but all this magic with the lack of a build step and so on tipped the scales towards Vue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, one evil was combined with the second. This is bad, because Bootstrap styles do not know anything about the component system, and Vue components were written at first, anyhow. Therefore, a strong-willed decision was made to create their own design system. We have it called</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pajamas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but no one could explain to me why. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I see that now there are more and more of our own design systems, and this is nice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The design system involves isolation, but since GitLab was already written in Bootstrap, approximately 50-60% of our design system is a wrapper over Bootstrap / Vue components with a decrease in their functionality. This is necessary so that the design system does not allow you to use the component incorrectly. If we talk about an abstract library, then flexibility is important there, for example, the ability to make any button you want. If in GitLab spinners can be four sizes approved by designers, then you need to physically not let others do it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Someday, good will win, and we will have an important tool with which, of course, if you scored on support for IE and Edge, you can effectively refactor front-end projects - this is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shadow DOM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Shadow DOM solves the problem of global styles flowing into components. Please do not take Polymer, which even Google has already buried. Use lit-element and lit-HTML, and you can build isolated styles using your favorite framework.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can say that React has CSS modules, Vue has scoped styles that do the same. Be very careful with them: CSS modules do not provide 100% isolation because they only work with classes. And with scoped styles in Vue, a very interesting scenario can be realized when the styles of the top component fall into the root element of the parent, and data attributes are used there that slow down. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that I scolded Angular for three years, now I have to admit that at the moment it is implemented in it best. In Angular, in order to ensure good style isolation, it is enough to simply switch the isolation mode and, if necessary, use the Shadow DOM, otherwise normal emulation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Back to the spinner. </font><font style="vertical-align: inherit;">Of the three months that I fought with him, for some time I was engaged in an exciting business: cleaning. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s8/zv/u0/s8zvu0h5yauznhgfqthij_96rkc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A class </font></font><code>loading-container</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an implementation detail of a spinner, that is, it is a class inside a spinner implementation. </font><font style="vertical-align: inherit;">We decided, since CSS is not to be saved, in Pajamas to create separate CSS based on Atomic CSS. </font><font style="vertical-align: inherit;">I personally don't really like the Atomic CSS concept, but we have what we have. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, I was engaged in cleaning out styles in the code of the main product that were hung on elements that are implementation details. </font><font style="vertical-align: inherit;">It all looks very simple - because, of course, there are tests in GitLab.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Tests</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests in GitLab cover all code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , provide reliability. </font><font style="vertical-align: inherit;">And so the pipeline is completed in 98 minutes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fl/uz/bb/fluzbboaa7on25ueq9z6pkvcdb4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab collects 40% of the time of public runners on GitLab.com because GitLab collects pipelines for every merge request. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was very inspired: I finally got on a project where everything is covered in tests! </font><font style="vertical-align: inherit;">The backend code coverage is close to 100%, and the front-end code at the time of my arrival was covered by </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89.3%. </font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, it turned out that most of this coverage is trash because:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">breaks down when changes are made that are not related to the components;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doesn't break when changes are made.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will explain with examples. </font><font style="vertical-align: inherit;">We took Jest because we thought that he would allow us in certain situations not to write assertions, but to use snapshots. </font><font style="vertical-align: inherit;">The problem is that if you did not configure Jest and add the correct serializer, then Vue Test Utils simply outputs props in HTML. </font><font style="vertical-align: inherit;">Then, for example, it turns out props with the name user, which had props in the parameters with the name data, to which the object object was passed. </font><font style="vertical-align: inherit;">Any changes in the format of the transmitted data do not lead to a failure of the snapshot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ruby developers are used to doing tests, roughly speaking, covering all methods.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we do tests for Vue or React components, we need to test how the public API behaves.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we had huge tests for computed properties, which were not used in some scenarios, but in others it was physically impossible to reach the state when this computed would be called. </font><font style="vertical-align: inherit;">Special thanks to Vue, in which the templates are strings, so you cannot calculate the test coverage of the template. </font><font style="vertical-align: inherit;">In Vue 3, Source Maps will appear and the ability to fix it, but it will not be soon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, there is one simple skill that will allow you to effectively refactor legacy. </font><font style="vertical-align: inherit;">This is the ability to write what is called the pinning test in the world of big testing.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinning test</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a test that tries to capture the behavior that you are refactoring. Please note that the pinning test will most likely not end up being committed to the repository. That is, you, through all sorts of refinements, for example, using the staging environment, write for yourself a test that describes how your component is rendered. After refactoring, the pinning test should either generate the same HTML, and this is most likely a good sign, or you should understand what changes have occurred.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will give an example from life. A few months ago, I conducted a merge request review with refactoring a drop down list. The legacy context is this: earlier, in order to separate the branches of a friend from each other by a dash in the drop-down list, the text string “divider” was simply passed. Therefore, if your branch was called divider, then you are out of luck. In the process of refactoring, a person swapped two classes in an HTML node, this went into production and ruined it. In fairness, of course, not quite production, but in staging, but nonetheless.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, when we started writing such tests, we found that, despite the cool test coverage indicator, the tests were written incorrectly. Because, firstly, we had tests for Karma, that is, old ones. Secondly, almost all tests made assumptions about the internals of the component. That is, they pretended to be unit tests, and worked essentially like end-to-end, checking that a specific tag with a specific class was being rendered, instead of checking that a specific component was being rendered with specific props. Understand the difference: classes are components? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, my 18 merge requests with refactoring tests for a total of 8-9 thousand lines, the total changelog turned out to be about 20 thousand, because 11 thousand were cut.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/q_/qs/ayq_qsjbluc3lyjaiwft9oxkefo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, formally, I reworked all these tests for the sake of one thing: to remove assertions regarding spinner classes, and instead to check that the spinner with the correct props is rendered there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, this is a thankless job. </font><font style="vertical-align: inherit;">But rewriting tests for the right architecture was pretty easy to sell to the business. </font><font style="vertical-align: inherit;">GitLab is a commercially profitable product. </font><font style="vertical-align: inherit;">Of course, if you tell the product manager that you need three iterations to rewrite 20 tests, guess where you will be sent. </font><font style="vertical-align: inherit;">Another thing: “I need three iterations to rewrite the test. </font><font style="vertical-align: inherit;">This will allow us to introduce spinners more efficiently and accelerate the future implementation of new elements of the design system. ” </font><font style="vertical-align: inherit;">And here we come to the important.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Resistance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is another functionality that more of my spinners are waiting for in the GitLab design system - these are ordinary SVG icons.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yu/to/cc/yutoccm3twkiswgiyqe2flvse_w.png" width="500"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have icons drawn by the designer that are used in the main project, but they are not in the design system, because GitLab has a difficult childhood. </font><font style="vertical-align: inherit;">For example, in 2019 CSS is collected not through Webpack, but by a piece called Sprockets - this is pipeline Ruby, because we need to reuse the same CSS on the backend and frontend. </font><font style="vertical-align: inherit;">Because of this, icons must be connected to different projects in different ways. </font><font style="vertical-align: inherit;">Therefore, someone refactored the main code base for three months so that you could connect the icons from the design system to related projects. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is an important point here that you will inevitably encounter. </font><font style="vertical-align: inherit;">Refactoring is a process of continuous improvement. </font><font style="vertical-align: inherit;">But sooner or later you have to stop.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It’s absolutely normal to stop, not completing refactoring, but getting concrete measurable improvements.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But if you are working on a legacy project, you will inevitably come across people who do this. </font></font><br>
<img src="https://habrastorage.org/webt/to/bx/ix/tobxixkebgoqq2lvl-2fijjeqme.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that they write in the old way, because they are so used to it. For example, our backenders say: “I don’t want to teach this your Jest. I’ve written tests for Karma for three years, I need to add new functionality, and since they won’t take functionality without tests, here’s a test for Karma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Your task is to resist this as much as possible. This is relatively easy to fight, but there is an even greater sin than that. Sometimes in the process of refactoring you come across a problem, and there is a desire to generally go aside.</font></font><br>
<img src="https://habrastorage.org/webt/pz/va/st/pzvast70b3gpomnqsaic1iignns.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, to substitute a new crutch simply because for certain reasons it is not possible to bring refactoring to the end. </font><font style="vertical-align: inherit;">For example, if we have problems integrating icons into the main code base, we can leave a utility class that will be pulled from the global Application CSS. </font><font style="vertical-align: inherit;">Formally, the business task will be solved, but in practice, as in the history of the Lernean hydra: there were 8 bugs, 4 fixed, 13 remained. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refactoring, like repairing a house - it is impossible to finish, you can only stop it.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first 80% of the refactoring takes 20% of the time, the remaining 80% of the refactoring (just like that) takes another 80% of the time.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It’s important not to introduce new hacks during the refactoring process. </font><font style="vertical-align: inherit;">Believe me, during the development process, they themselves will appear.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Tools</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, even before I arrived, GitLab embarked on the righteous path of introducing good tools: Prettier, Vue Test Utils, Jest. Although Prettier implemented crookedly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will explain what is at stake. While I figured out what and why so historically, 80% of my searches came across a commit of 37 thousand lines of prettify code. It was almost impossible to use the history, and I had to configure the plug-in for VS Code so that it would exclude this commit when searching for the history of changes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sure, tools are important, but you need to choose them carefully. For example, we have Vue, and Vue has a good testing tool - Vue Test Utils. But if Vue 2 was released 2-3 years ago, then Vue Test Utils still haven't gotten out of beta. Moreover, according to insider information, at the moment the only developer of Vue Test Utils does not write on Vue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the process of choosing tools, you play toss with fate, and really try to win. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab had a childhood injury with CoffeeScript. That is why it is impossible to push even the theoretical idea of ​​writing in TypeScript in GitLab. Everything breaks down into one simple argument: will it not be the same as with CoffeeScript when the language that compiles into JavaScript has died.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When choosing tools, try so that the tool can be replaced, or, in extreme cases, maintained independently.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We at GitLab use a cool thing called Danger. </font></font><br>
<img src="https://habrastorage.org/webt/lv/ol/oh/lvolohfoqnrzwiqzur-ziqhaaxw.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a real screenshot of their </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in 2019. </font><font style="vertical-align: inherit;">But, colleagues said that in fact in 2019 the site may look like anything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danger is a bot that occupies an intermediate state between the linter in your CI and the written guidelines. </font><font style="vertical-align: inherit;">This bot can be expanded and it will come to pull request or, as they are correctly called with us, merge request and leave comments like:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“There is an ESlint disable comment in this file, fix it.”</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“This file used to be ruled by this person. </font><font style="vertical-align: inherit;">Perhaps you need to put a review on it. ”</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my opinion, this is a very good, important and extensible framework for monitoring the state of the code base.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Abstraction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'll start with an example. </font><font style="vertical-align: inherit;">A few months ago, I saw the news: “GitHub got rid of jQuery. </font><font style="vertical-align: inherit;">We have come a long hard way and are no longer using jQuery. ” </font><font style="vertical-align: inherit;">Naturally, I thought that we also need to get rid of jQuery in GitLab. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e3/3d/4z/e33d4zkjkbo05u2iz2ehkjp9oh8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quick search showed that jQuery is used in 300 files. </font><font style="vertical-align: inherit;">It looks scary, but nothing - the eyes are afraid, the hands are doing. </font><font style="vertical-align: inherit;">But no! </font><font style="vertical-align: inherit;">jQuery is an integral glue in the GitLab code base, because we have Bootstrap. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bootstrap was originally written in jQuery. </font><font style="vertical-align: inherit;">This means that if you need, for example, to catch the dropdown opening event in Bootstrap, this is a jQuery event. </font><font style="vertical-align: inherit;">You cannot intercept it natively.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the first thing you should abstract when working with legacy code. </font><font style="vertical-align: inherit;">If you have jQuery that you cannot throw out, write your own Event Emitter, which will hide inside work with jQuery events. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a bright future comes, we can remove jQuery, but for now, sorry, you need to concentrate the govnokod. </font><font style="vertical-align: inherit;">In a regular legacy project, it is evenly spread throughout the code. </font><font style="vertical-align: inherit;">Collect it in bottlenecks marked with the flags “Do not enter without a chemical protection suit”.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Metrics</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You cannot do something whose result cannot be measured. At GitLab, we measure everything we do to objectively know that the code is working better. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/me/0g/qb/me0gqbigji1jssyvv6be_ve_bjq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we have a migration schedule from Karma tests (blue) to Jest (green): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You see that there is gradual progress. And we have a lot of such schedules. But it is important to understand that not always everything ends well. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will give one more example (the demo in the report starts from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> moment). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6s/az/t7/6sazt7jddhpg2kshoo0sodo-hbu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the usual merge request interface in GitLab production. Obviously, we can collapse files, click on the header and the file will begin to collapse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do you think, how long does it take to collapse a file of 50 lines, while the machine with the eighth generation Core i7 is twisted for maximum performance? </font><font style="vertical-align: inherit;">How long does the deployment take? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The time it takes for the file to collapse ranges from 7 to 15 seconds. </font><font style="vertical-align: inherit;">Deployment occurs instantly. </font><font style="vertical-align: inherit;">Before refactoring, both worked equally fast. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is why it is very important to have metrics.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I’ll tell you what is happening here. </font><font style="vertical-align: inherit;">This is Vue, its reactivity system keeps track of the value: if it changes, all dependencies that depend on this value are called. </font><font style="vertical-align: inherit;">Each line is a Vue component consisting of many things, because you can put comments on a line, comments can be dynamically loaded from the server, etc. </font><font style="vertical-align: inherit;">All this is subscribed to the Vue-store, which is also a Vue component.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you close the merge request, all, say, 20 thousand store subscriptions need to be updated when the store is updated. If the row is deleted, it must be removed from the dependencies. And then simple math: you need to look at an array of 20 thousand elements to find those that need to be removed. Let's say there are 500 such lines, and each line is several components. The result is a mathematical operation O (N), that is, O (20,000) * 500. JavaScript has been running all this time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deployment happens instantly, because adding a dependency is just a push to the array, i.e. mathematical operation O (1). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes improving the quality of the code degrades performance and other metrics. It is very important to measure them. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In summary: isolate bad code and keep track of metrics.</font></font></strong><br>
<br>
<blockquote>  legacy —  .   ,      –     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">TechLead Conf</a> — ,    .   –    ,  legacy        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Python</a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> PHP</a>.<br>
<br>
            ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">++</a>,        ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">FrontendConf</a>.          .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492984/index.html"># 00 - And a whole byte is not enough ... | Invitation to Revision Online 2020</a></li>
<li><a href="../en492990/index.html">Organization of online student education</a></li>
<li><a href="../en492994/index.html">What's New in TestMace Part 1. Cloud Sync, Updated Interface, and More</a></li>
<li><a href="../en492996/index.html">Marshaling and unmarshalling custom date formats in Go</a></li>
<li><a href="../en492998/index.html">How we got confused on freelancing for a data center and what came of it</a></li>
<li><a href="../en493002/index.html">350 people remotely: how it was</a></li>
<li><a href="../en493008/index.html">About 1C server cluster</a></li>
<li><a href="../en493010/index.html">How Quarkus Combines Imperative and Reactive Programming</a></li>
<li><a href="../en493012/index.html">Air, relays, cable out the window: how not to run into a monopolist provider in a business center</a></li>
<li><a href="../en493014/index.html">Interview with Vyacheslav Utochkin, Director of Game Development Educational Programs at the Higher School of Economics, Higher School of Economics, Higher School of Economics; 20 Questions about Game Dev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>