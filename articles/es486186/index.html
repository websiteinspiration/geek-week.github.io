<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✏️ 🤹🏾 📐 Nube catastrófica: cómo funciona 🎽 🌆 😠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 
 
 Después de las vacaciones de Año Nuevo, reiniciamos una nube resistente a desastres basada en dos sitios. Hoy le diremos cómo funciona ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nube catastrófica: cómo funciona</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/486186/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de las vacaciones de Año Nuevo, reiniciamos una nube resistente a desastres basada en dos sitios. </font><font style="vertical-align: inherit;">Hoy le diremos cómo funciona y le mostraremos qué sucede con las máquinas virtuales del cliente cuando los elementos individuales del clúster fallan y todo el sitio se cae (spoiler: todo está bien con ellos). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/no/xs/p9/noxsp98upzfesoanpuhefetyilq.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento en la nube a prueba de desastres en el sitio OST.</font></font></i><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo que hay dentro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bajo el capó del clúster se encuentran servidores Cisco UCS con hipervisor VMware ESXi, dos sistemas de almacenamiento INFINIDAT InfiniBox F2240, equipos de red Cisco Nexus y conmutadores Brocade SAN. </font><font style="vertical-align: inherit;">El clúster se divide en dos sitios: OST y NORD, es decir, en cada centro de datos un conjunto idéntico de equipos. </font><font style="vertical-align: inherit;">En realidad, esto lo hace catastrófico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dentro de una plataforma, los elementos principales también están duplicados (hosts, conmutadores SAN, tarjeta de red). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos sitios están conectados por caminos dedicados de fibra óptica, también reservados. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunas palabras sobre el almacenamiento. </font><font style="vertical-align: inherit;">La primera nube resistente a desastres que creamos en NetApp. </font><font style="vertical-align: inherit;">INFINIDAT fue elegido aquí, y he aquí por qué:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opción de replicación activa-activa. </font><font style="vertical-align: inherit;">Permite que la máquina virtual permanezca operativa incluso si uno de los sistemas de almacenamiento falla por completo. </font><font style="vertical-align: inherit;">Te contaré más sobre la replicación más adelante.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tres controladores de disco para una mayor resistencia del sistema. </font><font style="vertical-align: inherit;">Usualmente hay dos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solución lista </font><font style="vertical-align: inherit;">Nos llegó un rack ya ensamblado, que solo necesita estar conectado a la red y configurado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atento soporte técnico. </font><font style="vertical-align: inherit;">Los ingenieros de INFINIDAT analizan constantemente los registros y eventos de los sistemas de almacenamiento, instalan nuevas versiones en el firmware y ayudan con la configuración.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí hay algunas fotos de desembalaje:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ro/r1/9i/ror19i6ohplap3nzivyq9dxqaog.png"><br>
<br>
<img src="https://habrastorage.org/webt/rg/zm/of/rgzmofi67yaghzz7fziewaka3fw.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como funciona</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La nube ya es resistente dentro de sí misma. Protege al cliente de fallas individuales de hardware y software. Catastrófico ayudará a proteger contra fallas masivas dentro del mismo sitio: por ejemplo, fallas del sistema de almacenamiento (o clúster SDS, que sucede a menudo :)), errores masivos en la red de almacenamiento y más. Bueno y lo más importante: una nube de este tipo se salva cuando todo un sitio se vuelve inaccesible debido a incendios, apagones, captura de asaltantes, </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aterrizajes alienígenas.</font></font></s><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En todos estos casos, las máquinas virtuales del cliente continúan ejecutándose, y he aquí por qué.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema de clúster está diseñado para que cualquier host ESXi con máquinas virtuales cliente pueda acceder a cualquiera de los dos sistemas de almacenamiento. Si falla el almacenamiento en el sitio OST, las máquinas virtuales continuarán funcionando: los hosts en los que trabajan accederán al almacenamiento en NORD para obtener datos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/pq/0u/vupq0uycl3yelwrujymst8jqpke.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Así es como se ve el diagrama de conexión en el clúster.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Esto es posible debido al hecho de que se configura un enlace entre conmutadores entre las fábricas SAN de los dos sitios: el conmutador SAN Fabric OST SAN está conectado al conmutador SAN Fabric NORD de forma similar a los conmutadores SAN SAN Fabric B.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, para que todas estas complejidades de las fábricas SAN tengan sentido, la replicación Active-Active se configura entre los dos sistemas de almacenamiento: la información se escribe casi simultáneamente en los sistemas de almacenamiento local y remoto, RPO = 0. Resulta que en un SHD los datos originales se almacenan, en el otro, su réplica. Los datos se replican en el nivel de volumen de almacenamiento y los datos de VM (sus discos, archivo de configuración, archivo de intercambio, etc.) ya están almacenados en ellos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El host ESXi ve el volumen primario y su réplica como un único dispositivo de almacenamiento. Hay 24 rutas desde el host ESXi a cada dispositivo de disco:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12 rutas lo asocian con el almacenamiento local (rutas óptimas) y las 12 restantes con el remoto (rutas no óptimas). En una situación normal, ESXi accede a los datos en el almacenamiento local utilizando rutas "óptimas". Si este sistema de almacenamiento falla, ESXi pierde sus rutas óptimas y cambia a las "no óptimas". Así es como se ve en el diagrama. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/zu/rp/tlzurpwt1mspwdpbjeb53ydas4i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El esquema de un clúster resistente a los desastres.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Todas las redes de clientes se establecen en ambos sitios a través de una fábrica de redes común. Provider Edge (PE) se ejecuta en cada sitio, en el que se terminan las redes de clientes. Las PE se combinan en un solo grupo. Si PE falla en un sitio, todo el tráfico se redirige al segundo sitio. Gracias a esto, las máquinas virtuales del sitio sin PE permanecen disponibles en la red para el cliente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos ahora qué pasará con las máquinas virtuales del cliente en caso de varias fallas. </font><font style="vertical-align: inherit;">Comencemos con las opciones más livianas y terminemos con las más serias: el fracaso de todo el sitio. </font><font style="vertical-align: inherit;">En los ejemplos, el sitio principal será OST y la copia de seguridad, con réplicas de datos, será NORD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué le sucede a una máquina virtual cliente si ... </font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El enlace de replicación falla.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se detiene la replicación entre los sistemas de almacenamiento de los dos sitios. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESXi solo funcionará con dispositivos de disco locales (a lo largo de las rutas óptimas). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las máquinas virtuales siguen funcionando. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xd/1u/rs/xd1urscyrw5ldefaecvzg2sxsbg.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay una brecha ISL (Inter-Switch Link).</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El caso es poco probable. A menos que algún excavador loco desenterre varias rutas ópticas a la vez, que pasan por rutas independientes y son llevadas a los sitios a través de diferentes entradas. Pero de todos modos. En este caso, los hosts ESXi pierden la mitad de sus rutas y solo pueden acceder a su almacenamiento local. Se recopilan réplicas, pero los hosts no podrán acceder a ellas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las máquinas virtuales funcionan normalmente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eh/pg/p2/ehpgp21qksqs333elaz_px8hohs.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rechaza un cambio de SAN en uno de los sitios.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los hosts ESXi pierden algunas de sus rutas de almacenamiento. En este caso, los hosts en el sitio donde falló el conmutador funcionarán solo a través de su propio HBA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, las máquinas virtuales continúan funcionando normalmente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/_1/0w/vz_10wdyjuu3yp9flx0-kyiog9w.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los conmutadores SAN en uno de los sitios fallan.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Digamos que tal desastre ocurrió en el sitio OST. En este caso, los hosts ESXi en este sitio perderán todas las rutas a sus dispositivos de disco. El mecanismo estándar VMware vSphere HA entra en juego: reiniciará todas las máquinas virtuales de la plataforma OST en NORD después de un máximo de 140 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las máquinas virtuales que se ejecutan en los hosts del sitio NORD funcionan normalmente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/le/w8/yglew89bonr-aubz9dw85jxbnb0.gif"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rechaza el host ESXi en un sitio.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aquí el mecanismo vSphere HA funciona de nuevo: las máquinas virtuales de un host fallido se reinician en otros hosts, en el mismo sitio o en un sitio remoto. El tiempo de reinicio de la máquina virtual es de hasta 1 minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todos los hosts ESXi de la plataforma OST fallan, no hay opciones: las máquinas virtuales se reinician en otra. El tiempo de reinicio es el mismo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/ri/no/ijrino56s-akqtzivujr3en3ejy.gif"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rechaza el almacenamiento en el mismo sitio.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Digamos que el sistema de almacenamiento se negó en el sitio OST. Luego, los hosts OST ESXi cambian para trabajar con réplicas de almacenamiento en NORD. Una vez que el sistema de almacenamiento fallido vuelve al sistema, se produce una replicación forzada, los hosts OST ESXi volverán a ponerse en contacto con el sistema de almacenamiento local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las máquinas virtuales han estado funcionando todo este tiempo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ng/gk/vy/nggkvy-lk3dbjs-zfop2racir3u.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falla uno de los sitios.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este caso, todas las máquinas virtuales se reiniciarán en el sitio de respaldo a través del mecanismo vSphere HA. Tiempo de reinicio de VM: 140 segundos. En este caso, todas las configuraciones de red de la máquina virtual se guardarán y permanecerán disponibles para el cliente a través de la red. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reiniciar las máquinas en el sitio de copia de seguridad sin problemas, cada sitio está medio lleno. La segunda mitad es la reserva en caso de que todas las máquinas virtuales se muevan desde el segundo sitio lesionado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oa/hg/hr/oahghrsypij8je-zwym7trlj0-g.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una nube a prueba de desastres basada en dos centros de datos protege contra tales fallas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este placer no es barato porque, además de los recursos principales, necesita una reserva en el segundo sitio. </font><font style="vertical-align: inherit;">Por lo tanto, colocan los servicios críticos para el negocio en una nube de este tipo, cuyo largo tiempo de inactividad genera grandes pérdidas financieras y de reputación, o si los reguladores o los reglamentos internos de la compañía imponen requisitos de tolerancia a desastres en el sistema de información. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuentes:</font></font></b><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.infinidat.com/sites/default/files/resource-pdfs/DS-INFBOX-190331-US_0.pdf</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support.infinidat.com/hc/en-us/articles/207057109-InfiniBox-best-practices-guides</font></font></a></li>
</ol></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487948/index.html">Two-factor authentication in OpenVPN with Telegram bot</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electrónico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisión de noticias gratuitas y de código abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
<li><a href="../es486184/index.html">Cómo usar la búsqueda de manera efectiva</a></li>
<li><a href="../es486188/index.html">Presentación del sistema de copia de seguridad wal-g de PostgreSQL</a></li>
<li><a href="../es486190/index.html">Nuestra experiencia en el desarrollo de un controlador CSI en Kubernetes para Yandex.Cloud</a></li>
<li><a href="../es486192/index.html">Los estafadores cibernéticos piratean a los operadores móviles para obtener números de teléfono de suscriptores</a></li>
<li><a href="../es486194/index.html">Acerca de las copias de seguridad en Proxmox VE</a></li>
<li><a href="../es486198/index.html">Hablar es difícil. Ensayos sobre comunicación con no programadores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>