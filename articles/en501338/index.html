<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèº üòí ü§ì Inside the Python virtual machine. Part 1 üñ≤Ô∏è ü§≠ üë©üèæ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. I finally decided to figure out how the Python interpreter works. To do this, he began to study one article-book and conceived at the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Inside the Python virtual machine. Part 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501338/"><img src="https://habrastorage.org/webt/jm/9r/uc/jm9rucormi1lrcussoajjremszi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello everyone. </font><font style="vertical-align: inherit;">I finally decided to figure out how the Python interpreter works. </font><font style="vertical-align: inherit;">To do this, he began to study one article-book and conceived at the same time to translate it into Russian. </font><font style="vertical-align: inherit;">The fact is that translations do not allow you to miss an incomprehensible sentence and the quality of assimilation of the material increases).</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I apologize in advance for possible inaccuracies. </font><font style="vertical-align: inherit;">I always try to translate as correctly as possible, but one of the main problems: there is simply no mention of some terms in the Russian equivalent.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translation Note</font></font></b>
                        <div class="spoiler_text"> Python   ,  ¬´code object¬ª,  (  )     .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  </a>   .<br>
<br>
<b> </b> ‚Äî   Python,    -   ,     :   ,    ,  ( !    )  ,    ,     - (     )  .. ‚Äî    ()  -   str (,  Python3, bytes).<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Python programming language has been around for quite some time. </font><font style="vertical-align: inherit;">The development of the first version was started by Guido Van Rossum in 1989, and since then the language has grown and become one of the most popular. </font><font style="vertical-align: inherit;">Python is used in various applications: from graphical interfaces to data analysis applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The purpose of this article is to go behind the scenes of the interpreter and provide a conceptual overview of how a program written in Python is executed. </font><font style="vertical-align: inherit;">CPython will be considered in the article, because at the time of writing, it is the most popular and basic Python implementation.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python and CPython are used as synonyms in this text, but any mention of Python means CPython (the python version implemented in C). </font><font style="vertical-align: inherit;">Other implementations include PyPy (python implemented in a limited subset of Python), Jython (implementation on the Java Virtual Machine), etc.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I like to divide the execution of a Python program into two or three main steps (listed below), depending on how the interpreter is called. </font><font style="vertical-align: inherit;">These steps will be covered to varying degrees in this article:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this step involves setting up the various data structures required by the python process. </font><font style="vertical-align: inherit;">Most likely this will happen when the program is executed in non-interactive mode through the shell of the interpreter.</font></font></li>
<li><b></b> ‚Äî     , :       ,    ,       .</li>
<li><b></b> ‚Äî         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The mechanism for generating "parsing" trees, as well as abstract syntax trees (ASD), is language independent. Therefore, we will not cover this topic very much, because the methods used in Python are similar to the methods of other programming languages. On the other hand, the process of constructing symbol tables and code objects from ADS in Python is more specific, therefore, it deserves special attention. It also discusses the interpretation of compiled code objects and all other data structures. The topics covered by us will include, but are not limited to: the process of constructing symbol tables and creating code objects, Python objects, frame objects, code objects, functional objects, opcodes, interpreter loops, generators, and user classes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This material is intended for anyone interested in learning how the CPython virtual machine works. It is assumed that the user is already familiar with python and understands the basics of the language. When studying the structure of a virtual machine, we will encounter a significant amount of C-code, so it will be easier for a user who has an elementary understanding of the C language to understand the material. And so, basically, what you need to get acquainted with this material: the desire to learn more about the CPython virtual machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is an extended version of personal notes made in the study of the internal work of the interpreter. There is a lot of quality stuff in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyCon videos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , school lectures, and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this blog.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">My work would not have been completed without these fantastic sources of knowledge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the end of this book, the reader will be able to understand the intricacies of how the Python interpreter executes your program. </font><font style="vertical-align: inherit;">This includes the various stages of program execution and data structures that are critical in the program. </font><font style="vertical-align: inherit;">To begin with, we will take a bird's eye view of what happens when a trivial program is executed, when the name of the module is passed to the interpreter on the command line. </font><font style="vertical-align: inherit;">CPython executable code can be installed from source, following the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Developer's Guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This book uses the Python 3 version.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30,000-foot view</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This chapter talks about how the interpreter executes a Python program. In the following chapters, we will examine the various parts of this ‚Äúpuzzle‚Äù and provide a more detailed description of each part. Regardless of the complexity of a program written in Python, this process is always the same. The excellent explanation given by Yaniv Aknin in his </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">series of articles on Python Internal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sets the topic for our discussion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source module test.py can be executed from the command line (when passing it as an argument to the Python interpreter program in the form of $ python test.py). This is just one way to invoke the Python executable. We can also launch an interactive interpreter, execute lines of a file as code, etc. But this and other methods do not interest us. It is the transfer of the module as an argument (inside the command line) to the executable file (Figure 2.1) that best reflects the flow of various actions that are involved in the actual execution of the code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/bw/i5/tlbwi5onywd5j1xmkmyv7ni_lgm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2.1: Stream at runtime.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The python executable is a regular C program, so when it is called, processes similar to those that exist, for example, in the linux kernel or the simple hello world program, occur. </font><font style="vertical-align: inherit;">Take a minute of your time to understand: the python executable is just another program that launches your own. </font><font style="vertical-align: inherit;">Such "relationships" exist between the C language and the assembler (or llvm). </font><font style="vertical-align: inherit;">The standard initialization process (which depends on the platform where the execution takes place) starts when the python executable is called with the module name as an argument.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article assumes you are using a Unix-based operating system, so some features may vary on Windows.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> language </font><font style="vertical-align: inherit;">at startup executes all its ‚Äúmagic‚Äù of initialization - it loads libraries, checks / sets environment variables, and after that, the main method of the python executable is launched just like any other C program. Python's main executable file is located in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Programs/python.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and performs some initialization (such as making copies of program command line arguments that were passed to the module). The main function then calls the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">located in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Modules/main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It processes the initialization process of the interpreter: analyzes the command line arguments, sets flags, reads environment variables, executes hooks, randomizes hash functions, etc. Also called</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylifecycle.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which handles the initialization of interpreter and stream state data structures, are two very important data structures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examining declarations of interpreter data structures and stream states makes it clear why they are needed. The state of the interpreter and the stream are just structures with pointers to fields that contain the information necessary to execute the program. Interpreter state data is created via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (just think of this keyword in C as a type definition, although this is not entirely true). The code for this structure is shown in Listing 2.1.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> {</span>
 <span class="hljs-number">2</span> 
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">tstate_head</span>;</span>
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         PyObject *modules;
 <span class="hljs-number">7</span>         PyObject *modules_by_index;
 <span class="hljs-number">8</span>         PyObject *sysdict;
 <span class="hljs-number">9</span>         PyObject *builtins;
<span class="hljs-number">10</span>         PyObject *importlib;
<span class="hljs-number">11</span> 
<span class="hljs-number">12</span>         PyObject *codec_search_path;
<span class="hljs-number">13</span>         PyObject *codec_search_cache;
<span class="hljs-number">14</span>         PyObject *codec_error_registry;
<span class="hljs-number">15</span>         <span class="hljs-keyword">int</span> codecs_initialized;
<span class="hljs-number">16</span>         <span class="hljs-keyword">int</span> fscodec_initialized;
<span class="hljs-number">17</span> 
<span class="hljs-number">18</span>         PyObject *builtins_copy;
<span class="hljs-number">19</span>     } PyInterpreterState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code Listing 2.1: Interpreter state data structure</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Anyone who has used the Python programming language for a long time can recognize several fields mentioned in this structure (sysdict, builtins, codec).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* next</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">is a reference to another instance of the interpreter, since several Python interpreters can exist within the same process.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* tstate_head field</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indicates the main thread of execution (if the program is multi-threaded, then the interpreter is common for all threads created by the program). </font><font style="vertical-align: inherit;">We will discuss this in more detail shortly.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modules, modules_by_index, sysdict, builtins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importlib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> speak for themselves. </font><font style="vertical-align: inherit;">All of them are defined as instances of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is the root type for all objects in the Python virtual machine. </font><font style="vertical-align: inherit;">Python objects will be discussed in more detail in the following chapters.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fields related to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codec *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contain information that helps with downloading encodings. </font><font style="vertical-align: inherit;">This is very important for decoding bytes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Program execution must occur in a thread. </font><font style="vertical-align: inherit;">The state structure of the stream contains all the information that the stream needs to execute some code object. </font><font style="vertical-align: inherit;">Part of the stream data structure is shown in Listing 2.2.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> {</span>
 <span class="hljs-number">2</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">prev</span>;</span>
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         PyInterpreterState *interp;
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">frame</span> *<span class="hljs-title">frame</span>;</span>
 <span class="hljs-number">7</span>         <span class="hljs-keyword">int</span> recursion_depth;
 <span class="hljs-number">8</span>         <span class="hljs-keyword">char</span> overflowed; 
 <span class="hljs-number">9</span>                         
<span class="hljs-number">10</span>         <span class="hljs-keyword">char</span> recursion_critical; 
<span class="hljs-number">11</span>         <span class="hljs-keyword">int</span> tracing;
<span class="hljs-number">12</span>         <span class="hljs-keyword">int</span> use_tracing;
<span class="hljs-number">13</span> 
<span class="hljs-number">14</span>         Py_tracefunc c_profilefunc;
<span class="hljs-number">15</span>         Py_tracefunc c_tracefunc;
<span class="hljs-number">16</span>         PyObject *c_profileobj;
<span class="hljs-number">17</span>         PyObject *c_traceobj;
<span class="hljs-number">18</span> 
<span class="hljs-number">19</span>         PyObject *curexc_type;
<span class="hljs-number">20</span>         PyObject *curexc_value;
<span class="hljs-number">21</span>         PyObject *curexc_traceback;
<span class="hljs-number">22</span> 
<span class="hljs-number">23</span>         PyObject *exc_type;
<span class="hljs-number">24</span>         PyObject *exc_value;
<span class="hljs-number">25</span>         PyObject *exc_traceback;
<span class="hljs-number">26</span> 
<span class="hljs-number">27</span>         PyObject *dict;  <span class="hljs-comment">/* Stores per-thread state */</span>
<span class="hljs-number">28</span>         <span class="hljs-keyword">int</span> gilstate_counter;
<span class="hljs-number">29</span> 
<span class="hljs-number">30</span>         ... 
<span class="hljs-number">31</span>     } PyThreadState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 2.2: Part of the stream state data</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
structure The interpreter data structures and stream states are discussed in more detail in the following chapters. The initialization process also sets up import mechanisms as well as elementary stdio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After completing all initialization, Py_Main calls the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">(also located in the main.c module). The following is a series of function calls: PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags -&gt; PyRun_FileExFlags -&gt; PyParser_ASTFromFileObject. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyRun_SimpleFileExFlags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates the __main__ namespace in which the contents of the file will be executed. It also checks if the pyc version of the file exists (the pyc file is a simple file containing an already compiled version of the source code). If a pyc version exists, an attempt will be made to read it as a binary file, and then run it. If the pyc file is missing, then PyRun_FileExFlags is called, etc. The PyParser_ASTFromFileObject function calls </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ParseFileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which reads the contents of the module and builds parsing trees from it. Then, the created tree is passed to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ASTFromNodeObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which creates an abstract syntax tree from it.</font></font><br>
<br>
<blockquote>     ,     Py_INCREF  Py_DECREF.    ,     . CPython        :  ,      ,    Py_INCREF. ,      ,       Py_DECREF.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AST is generated when </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_mod is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> called </font><font style="vertical-align: inherit;">. This function calls </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyAST_CompileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which creates code objects from AST. Note that the bytecode generated during the PyAST_CompileObject call is passed through the simple </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peephole</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimizer </font><font style="vertical-align: inherit;">, which performs low optimization of the generated bytecode before creating code objects. The run_mod function then applies the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyEval_EvalCode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ceval.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">to the code object. This leads to another series of function calls: PyEval_EvalCode -&gt; PyEval_EvalCode -&gt; _PyEval_EvalCodeWithName -&gt; _PyEval_EvalFrameEx. The code object is passed as an argument to most of these functions in one form or another. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_PyEval_EvalFrameEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- This is a normal interpreter loop that handles the execution of code objects. However, it is called not just with the code object as an argument, but with the frame object, which has as a attribute a field that refers to the code object. This frame provides the context for the execution of the code object. In simple words: the interpreter loop continuously reads the next instruction indicated by the instruction counter from the array of instructions. Then it executes this instruction: it adds or removes objects from the value stack in the process until it empties into the array of instructions to be executed (well, or something exceptional happens that disrupts the loop).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python provides a set of functions that you can use to examine real code objects. For example, a simple program can be compiled into a code object and disassembled to obtain opcodes that are executed by the python virtual machine. This is shown in Listing 2.3.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">1</span>         &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square</span>(<span class="hljs-params">x</span>):</span>
<span class="hljs-number">2</span>         ...     <span class="hljs-keyword">return</span> x*x
<span class="hljs-number">3</span>         ... 
<span class="hljs-number">4</span> 
<span class="hljs-number">5</span>         &gt;&gt;&gt; dis(square)
<span class="hljs-number">6</span>         <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">7</span>                     <span class="hljs-number">2</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">8</span>                     <span class="hljs-number">4</span> BINARY_MULTIPLY     
<span class="hljs-number">9</span>                     <span class="hljs-number">6</span> RETURN_VALUE        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code Listing 2.3: Disassembling a function in Python The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
header file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Include/opcodes.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains a complete list of all the instructions / opcodes for the Python virtual machine. Opcode's are pretty simple. Take our example in Listing 2.3, which has a set of four instructions. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOAD_FAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> loads the value of its argument (in this case x) </font><b><font style="vertical-align: inherit;">onto the</font></b><font style="vertical-align: inherit;"> value stack. The python virtual machine is stack-based, so the values ‚Äã‚Äãfor opcode operations are ‚Äúpopped‚Äù from the stack, and the calculation results are pushed back onto the stack for further use by other opcodes. Then </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BINARY_MULTIPLY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pops two items from the stack, performs binary multiplication of both values, and pushes the result back </font><b><font style="vertical-align: inherit;">onto the</font></b><font style="vertical-align: inherit;"> stack. </font><b><font style="vertical-align: inherit;">RETURN VALUE</font></b><font style="vertical-align: inherit;"> Instruction</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retrieves a value from the stack, sets the return value for the object to this value, and exits the interpreter loop. </font><font style="vertical-align: inherit;">If you look at Listing 2.3, it‚Äôs clear that this is a pretty strong simplification. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The current explanation of the interpreter loop does not take into account a number of details, which will be discussed in subsequent chapters. </font><font style="vertical-align: inherit;">For example, here are the questions to which we did not receive an answer:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where did the values ‚Äã‚Äãloaded by the LOAD_FAST statement come from?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where do the arguments come from, which are used as part of the instructions?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How are nested function and method calls handled?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does the interpreter loop handle exceptions?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After completing all the instructions, the Py_Main function continues execution, but this time starts the cleaning process. </font><font style="vertical-align: inherit;">If </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called to perform initialization during the start of the interpreter, then </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_FinalizeEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called to perform the cleanup. </font><font style="vertical-align: inherit;">This process includes waiting for the exit from the threads, calling any exit handlers, as well as freeing up the still used memory allocated by the interpreter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, we looked at the "high level" description of the processes that occur in the Python executable when a script is run. </font><font style="vertical-align: inherit;">As noted earlier, there are many questions that remain to be answered. </font><font style="vertical-align: inherit;">In the future, we will delve into the study of the interpreter and consider in detail each of the stages. </font><font style="vertical-align: inherit;">And we will start by describing the compilation process in the next chapter.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501326/index.html">How to become a DevOps engineer in six months or even faster. Part 3. Versions</a></li>
<li><a href="../en501328/index.html">Introducing Visual Studio Codespaces: Cloud Development, Wherever You Are</a></li>
<li><a href="../en501330/index.html">Microservices in C ++. Fiction or reality?</a></li>
<li><a href="../en501332/index.html">Meetings are easy. Three daily practice tips</a></li>
<li><a href="../en501336/index.html">FOSS News No. 15 - a review of free and open source news for May 4-10, 2020</a></li>
<li><a href="../en501340/index.html">Why is Flutter winning?</a></li>
<li><a href="../en501342/index.html">Microsoft Online Certification - Field Notes</a></li>
<li><a href="../en501344/index.html">Supply ventilation combined with duct air conditioning (part 1 - electric)</a></li>
<li><a href="../en501346/index.html">Overview of the mechanical keyboard Vortex Core RGB</a></li>
<li><a href="../en501352/index.html">Kafka strikes back</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>