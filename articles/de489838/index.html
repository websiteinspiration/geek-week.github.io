<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍💻 ✂️ 💅 Nuxt Server-Side Memory Leak mit SSR (Server Side Rendering) 🛌🏿 ✋🏾 🗝️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Dieser Artikel ist ein Muss für alle, die mit Vue SSR arbeiten, insbesondere mit Nuxt . Hierbei handelt es sich um einen Speicherverlust b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nuxt Server-Side Memory Leak mit SSR (Server Side Rendering)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489838/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font><font style="vertical-align: inherit;">Dieser Artikel ist ein Muss für alle, die mit Vue SSR arbeiten, insbesondere mit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuxt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hierbei handelt es sich um einen Speicherverlust bei Verwendung von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Axios</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor einem halben Jahr hatte ich ein Projekt mit einem VueJS + Nuxt-Stack. Die Besonderheit war, dass die Nod-Server (Nuxt) ständig im Produkt starben und neue an ihrer Stelle auftauchten. </font><font style="vertical-align: inherit;">Den Grafiken und Protokollen zufolge war klar, dass der Knotenprozess 100% erreichte und mit einem Speicherfehler fehlte. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt stieg ein neuer an die Stelle des getöteten Prozesses, was ungefähr 30 Sekunden dauerte. Dies war genug, damit Benutzer einen 502-Fehler erhielten. </font><font style="vertical-align: inherit;">Offensichtlich gab es irgendwo im Code einen Speicherverlust, der gefunden werden musste.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte sofort wichtige Punkte hervorheben, da das Lesen nur eines Teils dieses Artikels möglicherweise nicht alle Ihre Fragen beantwortet:</font></font><br>
<br>
<ol>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relevanz des Themas </font></font></b> </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Axios Abfangjäger</font></font></b> </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">runInNewContext</font></font></b> </li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Relevanz des Themas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als erstes suchte ich, wie viele von uns, im Internet nach einer Lösung. Meine Anfragen sahen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ungefähr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so aus: </font><b><font style="vertical-align: inherit;">NodeJS-Speicherlecks</font></b><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuxt-Speicherlecks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuxt-Speicherlecks in der Produktion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich hat mir keines der zwanzig Probleme beim Stackoverflow geholfen, aber ich habe gelernt, wie man die Speichernutzung durch chrome: // inspect verfolgt. </font><font style="vertical-align: inherit;">Zu meiner Enttäuschung stellte ich fest, dass 90% des gesamten Speichers, der aus irgendeinem Grund nicht bereinigt wurde, einige Funktionen von Vue wie renderComponent, renderElement und andere waren.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/oo/gn/faoognc9ndcq9h5lw7omfenjq78.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Axios Interceptors</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen schnell meine Qualen auf der Suche nach einem Problem durch und gehen sofort zu der Tatsache über, dass </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">axios.interceptors</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">alles verantwortlich sind</font></a><font style="vertical-align: inherit;"> (es tut mir leid, Habr, dass ich die Schuld gefunden habe). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Machen Sie sofort eine Reservierung, dass Axios wie folgt erstellt wurde:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> baseAxios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> axios = baseAxios.create({
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,<font></font>
});<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> axios;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wie folgt an den Anwendungskontext angehängt: </font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'./index'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">context</span>) </span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(!context.axios) {<font></font>
    context.axios = axios;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach einer langen Suche nach Lecks stellte ich fest, dass der Speicher bereinigt wird, wenn Sie alle axios.interceptors deaktivieren.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist da los?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interceptor ist ein Proxy, der alle Antworten oder Anfragen abfängt und es Ihnen ermöglicht, jeden Code mit einer Antwort auszuführen (z. B. um Fehler zu behandeln) oder etwas hinzuzufügen, bevor Sie eine Anfrage global für alle Anfragen senden, und zwar an einer Stelle, praktisch, nicht wahr? </font><font style="vertical-align: inherit;">Hier ist ein Beispiel, wie es aussieht (Datei 'plugins / axios / interceptor.js')</font></font></li>
</ul><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">{ axios }</span>) </span>{<font></font>
<font></font>
  <span class="hljs-keyword">const</span> interceptor = axios.interceptors.response.use( <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> response;<font></font>
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
    <span class="hljs-comment">//-   ,  </span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<font></font>
  });<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier beginnt der Spaß. </font><font style="vertical-align: inherit;">Wir fügen die Funktion des Hinzufügens eines Interceptors über Plugins in nuxt.config.js hinzu</font></font><br>
<br>
<pre><code class="javascript hljs">  plugins: [<font></font>
    { <span class="hljs-attr">src</span>: <span class="hljs-string">'~/plugins/axios/bindContext'</span> },<font></font>
    { <span class="hljs-attr">src</span>: <span class="hljs-string">'~/plugins/axios/interceptor'</span> },<font></font>
  ]</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
und nuxt führt automatisch für jede neue Anfrage alle Plugin-Funktionen aus, führt dann nuxtServerInit und dann alles wie gewohnt aus. Das heißt, für den ersten Benutzer erstellen wir einen Interceptor auf der Serverseite, irgendwo in unseren Komponenten in asyncData oder beim Abrufen stellen wir Anforderungen, und der Interceptor funktioniert wie es sollte, dann kommt der zweite Benutzer herein und wir erstellen den zweiten Interceptor und der Code innerhalb der Funktion funktioniert zweimal! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum besseren Verständnis meiner Wörter werde ich einen Zähler zeichnen, der mit jedem Aufruf der Funktion und 5-maligem Anklopfen des Index erhöht wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ly/en/uu/lyenuuid32whlgsdqja6nz8z6s8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir können feststellen, dass 15 Aufrufe aufgetreten sind, und dies ist 1 + 2 + 3 + 4 + 5. Ich habe mir zusätzlich die Zeit genommen, den nächsten Interceptor zu erstellen, um sicherzugehen dass es Herausforderungen von denen gibt, die früher geschaffen wurden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Von der Schule an erinnern wir uns alle gut an die Formel des arithmetischen Fortschritts, und die Summe von 1 bis n kann als n * (n + 1) / 2 geschrieben werden. Es stellt sich heraus, dass unsere Funktion 1000-mal und insgesamt aufgerufen wird, wenn der 1000. Benutzer hereinkommt Dies sind bereits eine halbe Million Anrufe. Wenn die Last also mittel oder hoch ist, wundern Sie sich nicht, wenn Ihr Server abstürzt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lösung </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD. </font><font style="vertical-align: inherit;">Lösung 0 - Die Kommentare beschreiben gute Lösungen für dieses Problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lösung 1 - Verwenden Sie keine axios.interceptors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lösung Nr. 2 - Alles ist sehr einfach. Sie müssen den Abfangjäger anhand der Axios-Dokumentation selbst reinigen</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">{ axios }</span>) </span>{<font></font>
<font></font>
  <span class="hljs-keyword">const</span> interceptor = axios.interceptors.response.use( <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(process.server) {<font></font>
      axios.interceptors.response.eject(interceptor);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> response;<font></font>
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
    <span class="hljs-keyword">if</span>(process.server) {<font></font>
      axios.interceptors.response.eject(interceptor);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);<font></font>
  });<font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies muss nur auf der Serverseite erfolgen, da andernfalls auf der Clientseite nach erfolgreichem Abschluss einer ersten Anforderung die Ausführung dieses Interceptors beendet wird. </font><font style="vertical-align: inherit;">Es gibt noch eine Nuance mit der Tatsache, dass, während wir uns noch auf dem Server befinden und die Anforderungen des nächsten Benutzers verarbeiten, es jedoch möglicherweise mehrere, aber mehrere Anforderungen gibt. Mit dem Auswerfen dieses Interceptors werden in diesem Fall alle Anforderungen außer der ersten nicht durchlaufen Um unabhängig über den Moment nachzudenken, in dem Sie einen Auswurf durchführen müssen, können Sie dies am einfachsten über setTimeout tun. Nach 10 Sekunden können wir davon ausgehen, dass wir auf der Serverseite alle Anforderungen für den aktuellen Benutzer ausführen können und alle in dieser Zeit ausgeführt werden Der Abfangjäger ist weiterhin aktiv.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> runInNewContext </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine sehr lustige Option, aufgrund derer dieser Fehler nicht lokal gespielt werden kann, aber es ist sehr einfach, im Build zu spielen. </font><font style="vertical-align: inherit;">Lesen Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier darüber</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Als ich mich darauf vorbereitete, diesen Artikel zu schreiben, erstellte ich das Starter-Template-Nuxt-Projekt, um dieses Problem zu reproduzieren, und wie ich überrascht war, dass für jeden regulären Benutzer der Interceptor einmal ausgeführt wurde und nicht n. </font><font style="vertical-align: inherit;">Die Sache ist, wenn wir npm run dev schreiben - diese Option ist standardmäßig wahr und jedes Mal, wenn wir Funktionen von Plugins auf der Serverseite ausführen, ist der Kontext jedes Mal neu (offensichtlich vom Flaggennamen) und wird im Build automatisch ausgeführt false für eine bessere Leistung im Produkt, daher musste ich diese Option in nuxt.config.js deaktivieren</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-attr">render</span>: {
    <span class="hljs-attr">bundleRenderer</span>: {
      <span class="hljs-attr">runInNewContext</span>: <span class="hljs-literal">false</span>,<font></font>
    },<font></font>
  },<font></font>
</code></pre> <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fazit </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für mich ist dieses Problem sehr ernst und es lohnt sich, ihm besondere Aufmerksamkeit zu schenken. </font><font style="vertical-align: inherit;">Möglicherweise betrifft dieses Problem nicht nur Vue ssr, sondern auch andere und nicht nur Axios, sondern auch alle anderen HTTP-Clients, deren Proxys dem Interceptor ähnlich sind. </font><font style="vertical-align: inherit;">Wenn Sie Fragen haben, können Sie mir unter Telegramm </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@alexander_proydenko</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schreiben </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Der gesamte im Artikel verwendete Code kann hier auf github eingesehen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de489826/index.html">Informationen zu veränderlichen Methoden eines Math-Objekts in JavaScript</a></li>
<li><a href="../de489828/index.html">Arbeiten mit GeoJSON in Node.js: eine praktische Einführung</a></li>
<li><a href="../de489832/index.html">Künstliche Atomkügelchen: Manipulationen mit Makrocyclen</a></li>
<li><a href="../de489834/index.html">Betten Sie Ihr Smart Home-Gerät in das SmartThings-Ökosystem ein</a></li>
<li><a href="../de489836/index.html">Lidare der Zukunft: 11.000 Laser statt 128</a></li>
<li><a href="../de489840/index.html">Antriebsanatomie: Festplatten</a></li>
<li><a href="../de489844/index.html">Vergleichende Analyse einiger Java-Dekompilierer</a></li>
<li><a href="../de489848/index.html">Warum verhalten sich meine Kollegen / Mitarbeiter wie @% §?</a></li>
<li><a href="../de489850/index.html">Sicherheitswoche 09: Wer ist für die Android-Sicherheit verantwortlich?</a></li>
<li><a href="../de489852/index.html">Transparente Authentifizierung in ASP.Net Core unter Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>