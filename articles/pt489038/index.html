<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÜ üë∫ üçπ O livro "Concorr√™ncia Java na Pr√°tica" üìö üßëüèø‚Äçü§ù‚Äçüßëüèª üßòüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, habrozhiteli! Os fluxos s√£o uma parte fundamental da plataforma Java. Os processadores com v√°rios n√∫cleos s√£o comuns e o uso efetivo da simultane...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>O livro "Concorr√™ncia Java na Pr√°tica"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/489038/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/1r/ku/4r/1rku4rb0w0tevxfiae9gxkkkzse.jpeg" align="left" alt="imagem"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√°, habrozhiteli! Os fluxos s√£o uma parte fundamental da plataforma Java. Os processadores com v√°rios n√∫cleos s√£o comuns e o uso efetivo da simultaneidade tornou-se necess√°rio para criar qualquer aplicativo de alto desempenho. Uma m√°quina virtual Java aprimorada, suporte para classes de alto desempenho e um rico conjunto de componentes para tarefas de paraleliza√ß√£o foram ao mesmo tempo uma inova√ß√£o no desenvolvimento de aplicativos paralelos. No Java Concurrency in Practice, os pr√≥prios criadores da tecnologia inovadora explicam n√£o apenas como eles funcionam, mas tamb√©m falam sobre padr√µes de design. √â f√°cil criar um programa competitivo que parece funcionar. No entanto, o desenvolvimento, teste e depura√ß√£o de programas multiencadeados apresentam muitos problemas. O c√≥digo para de funcionar exatamente quando √© mais importante: sob carga pesada.No "Java Concurrency in Practice", voc√™ encontrar√° teoria e m√©todos espec√≠ficos para criar aplicativos paralelos confi√°veis, escal√°veis ‚Äã‚Äãe suportados. Os autores n√£o oferecem uma lista de APIs e mecanismos de simultaneidade; eles introduzem regras, padr√µes e modelos de design que s√£o independentes da vers√£o Java e permanecem relevantes e eficazes por muitos anos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excerto. </font><font style="vertical-align: inherit;">Seguran√ßa da linha</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode se surpreender ao saber que a programa√ß√£o competitiva est√° associada a threads ou bloqueios </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1), assim</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como a engenharia civil n√£o est√° associada a rebites e vigas em I. </font><font style="vertical-align: inherit;">Obviamente, a constru√ß√£o de pontes requer o uso correto de um grande n√∫mero de rebites e vigas em I, e o mesmo se aplica √† constru√ß√£o de programas competitivos, que exigem o uso correto de roscas e travas. </font><font style="vertical-align: inherit;">Mas estes s√£o apenas mecanismos - meios para alcan√ßar a meta. </font><font style="vertical-align: inherit;">Escrever c√≥digo seguro para threads √©, em ess√™ncia, controlar o acesso a um estado e, em particular, a um estado mut√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o estado de um objeto √© seus dados armazenados em vari√°veis ‚Äã‚Äãde estado, como inst√¢ncia e campos est√°ticos ou campos de outros objetos dependentes. O estado do hash do HashMap √© parcialmente armazenado no pr√≥prio HashMap, mas tamb√©m em muitos objetos Map.Entry. O estado de um objeto inclui qualquer dado que possa afetar seu comportamento. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1)</font></font></b>     lock  block,      ¬´¬ª,     ,  .            blocking.   lock    ¬´¬ª, ¬´  ¬ª.     lock ,  ,   ,    ¬´¬ª.  ‚Äî          .       ,          , ,         . ‚Äî . . .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√°rios threads podem acessar uma vari√°vel compartilhada, modificada - altera seu valor. De fato, estamos tentando proteger dados, n√£o c√≥digos, de acesso competitivo n√£o controlado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A cria√ß√£o de um objeto seguro para threads requer sincroniza√ß√£o para coordenar o acesso a um estado mutado, falha no cumprimento, o que pode levar √† corrup√ß√£o de dados e outras consequ√™ncias indesej√°veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sempre que mais de um thread acessa uma vari√°vel de estado e um dos threads possivelmente grava nela, todos os threads devem coordenar seu acesso a ela usando a sincroniza√ß√£o. A sincroniza√ß√£o em Java √© fornecida pela palavra-chave sincronizada, que fornece bloqueio exclusivo, bem como vari√°veis ‚Äã‚Äãvol√°teis e at√¥micas e bloqueios expl√≠citos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resista √† tenta√ß√£o de pensar que existem situa√ß√µes que n√£o requerem sincroniza√ß√£o. </font><font style="vertical-align: inherit;">O programa pode funcionar e passar nos testes, mas permanece com defeito e falha a qualquer momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se v√°rios encadeamentos acessam a mesma vari√°vel com um estado mutado sem sincroniza√ß√£o adequada, seu programa est√° com defeito. </font><font style="vertical-align: inherit;">H√° tr√™s maneiras de corrigi-lo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o compartilhe a vari√°vel state em todos os threads</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">torne a vari√°vel de estado n√£o mut√°vel;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use a sincroniza√ß√£o de estado sempre que acessar a vari√°vel de estado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As corre√ß√µes podem exigir altera√ß√µes significativas no design, por isso √© muito mais f√°cil projetar uma classe segura para threads imediatamente do que atualiz√°-la mais tarde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â dif√≠cil descobrir se v√°rios threads acessar√£o esta ou aquela vari√°vel. Felizmente, solu√ß√µes t√©cnicas orientadas a objetos que ajudam a criar classes bem organizadas e f√°ceis de manter - como encapsulamento e oculta√ß√£o de dados - tamb√©m ajudam a criar classes seguras para threads. Quanto menos encadeamentos tiverem acesso a uma vari√°vel espec√≠fica, mais f√°cil ser√° garantir a sincroniza√ß√£o e definir as condi√ß√µes sob as quais essa vari√°vel pode ser acessada. A linguagem Java n√£o o for√ßa a encapsular o estado - √© perfeitamente aceit√°vel armazenar o estado em campos p√∫blicos (mesmo campos est√°ticos p√∫blicos) ou publicar um link para um objeto que, de outra forma, √© interno - mas quanto melhor o estado do seu programa for encapsulado,mais f√°cil √© tornar o thread do programa seguro e ajudar os mantenedores a mant√™-lo dessa maneira.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao projetar classes seguras para threads, boas solu√ß√µes t√©cnicas orientadas a objetos: encapsulamento, mutabilidade e uma especifica√ß√£o clara de invariantes ser√£o seus assistentes.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se boas solu√ß√µes t√©cnicas de design orientado a objetos divergem das necessidades do desenvolvedor, vale a pena sacrificar as regras de bom design por uma quest√£o de desempenho ou compatibilidade com o c√≥digo legado. </font><font style="vertical-align: inherit;">√Äs vezes, abstra√ß√£o e encapsulamento est√£o em desacordo com o desempenho - embora n√£o com a frequ√™ncia que muitos desenvolvedores acreditam - mas a melhor pr√°tica √© tornar o c√≥digo correto primeiro e depois r√°pido. </font><font style="vertical-align: inherit;">Tente usar a otimiza√ß√£o apenas se medidas de produtividade e necessidades indicarem que voc√™ deve faz√™-lo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(2)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No c√≥digo competitivo, voc√™ deve aderir a essa pr√°tica ainda mais do que o habitual. Como os erros competitivos s√£o extremamente dif√≠ceis de reproduzir e n√£o s√£o f√°ceis de depurar, a vantagem de um pequeno ganho de desempenho em algumas ramifica√ß√µes de c√≥digo raramente usadas pode ser bastante insignificante em compara√ß√£o ao risco de o programa travar em condi√ß√µes operacionais.</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Se voc√™ decidir quebrar o encapsulamento, nem tudo estar√° perdido. Seu programa ainda pode tornar o thread seguro, mas o processo ser√° mais complicado e mais caro, e o resultado n√£o ser√° confi√°vel. O cap√≠tulo 4 descreve as condi√ß√µes sob as quais o encapsulamento de vari√°veis ‚Äã‚Äãde estado pode ser mitigado com seguran√ßa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At√© agora, usamos os termos ‚Äúthread safe class‚Äù e ‚Äúthread safe program‚Äù quase de forma intercambi√°vel. Um programa de thread safe √© constru√≠do inteiramente a partir de classes de thread safe? Opcional: um programa que consiste inteiramente de classes seguras de encadeamento pode n√£o ser seguro, e um programa seguro de encadeamento pode conter classes que n√£o s√£o seguras. Quest√µes relacionadas ao layout das classes de thread-safe tamb√©m s√£o discutidas no Cap√≠tulo 4. De qualquer forma, o conceito de uma classe de thread-safe s√≥ faz sentido se a classe encapsular seu pr√≥prio estado. O termo "seguran√ßa de encadeamento" pode ser aplicado ao c√≥digo, mas fala do estado e s√≥ pode ser aplicado √†quela matriz de c√≥digo que encapsula seu estado (pode ser um objeto ou o programa inteiro).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 </font><font style="vertical-align: inherit;">O que √© seguran√ßa de rosca?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definir a seguran√ßa da linha n√£o √© f√°cil. </font><font style="vertical-align: inherit;">Uma r√°pida pesquisa no Google oferece v√°rias op√ß√µes como estas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... podem ser chamadas a partir de v√°rios threads de programa sem intera√ß√µes indesejadas entre threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... pode ser chamado por dois ou mais threads ao mesmo tempo, sem exigir nenhuma outra a√ß√£o do chamador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dadas essas defini√ß√µes, n√£o √© surpreendente que achemos confusos a seguran√ßa dos threads! </font><font style="vertical-align: inherit;">Como distinguir uma classe de thread-safe de uma classe n√£o segura? </font><font style="vertical-align: inherit;">O que queremos dizer com a palavra "seguro"? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No centro de qualquer defini√ß√£o razo√°vel de seguran√ßa do fio est√° a no√ß√£o de corre√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A corre√ß√£o implica que uma classe esteja em conformidade com sua especifica√ß√£o. </font><font style="vertical-align: inherit;">A especifica√ß√£o define invariantes que limitam o estado de um objeto e p√≥s-condi√ß√µes que descrevem os efeitos das opera√ß√µes. </font><font style="vertical-align: inherit;">Como voc√™ sabe que as especifica√ß√µes para as classes est√£o corretas? </font><font style="vertical-align: inherit;">De jeito nenhum, mas isso n√£o nos impede de us√°-los depois que nos convencemos de que o c√≥digo funciona. </font><font style="vertical-align: inherit;">Ent√£o, vamos supor que a corre√ß√£o de thread √∫nico seja algo vis√≠vel. </font><font style="vertical-align: inherit;">Agora podemos assumir que a classe de thread-safe se comporta corretamente durante o acesso de v√°rios threads.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma classe √© segura para threads se se comportar corretamente durante o acesso de v√°rios threads, independentemente de como esses threads s√£o agendados ou intercalados pelo ambiente de trabalho e sem sincroniza√ß√£o adicional ou outra coordena√ß√£o por parte do c√≥digo de chamada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um programa multithread n√£o pode ser seguro para threads se n√£o estiver correto, mesmo em um ambiente de thread √∫nico </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se o objeto for implementado corretamente, nenhuma sequ√™ncia de opera√ß√µes - acessando m√©todos p√∫blicos e lendo ou gravando em campos p√∫blicos - deve violar seus invariantes ou p√≥s-condi√ß√µes. </font><font style="vertical-align: inherit;">Nenhum conjunto de opera√ß√µes executadas sequencialmente ou competitivamente em inst√¢ncias de uma classe segura para encadeamento pode fazer com que uma inst√¢ncia esteja em um estado inv√°lido. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3) </font></font></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o uso livre do termo corre√ß√£o incomod√°-lo aqui, voc√™ pode pensar em uma classe de thread-safe como uma classe defeituosa em um ambiente competitivo, bem como em um ambiente de thread √∫nico.</font></font></i><br>
 <br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As classes thread-safe encapsulam qualquer sincroniza√ß√£o necess√°ria e n√£o precisam de ajuda do cliente.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1.1 </font><font style="vertical-align: inherit;">Exemplo: servlet sem suporte de estado interno</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Cap√≠tulo 1, listamos as estruturas que criam threads e chamam componentes deles que voc√™ √© respons√°vel pela seguran√ßa da thread. </font><font style="vertical-align: inherit;">Agora pretendemos desenvolver um servi√ßo de fatora√ß√£o de servlet e expandir gradualmente sua funcionalidade, mantendo a seguran√ßa do encadeamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Listagem 2.1 mostra um servlet simples que descompacta um n√∫mero de uma consulta, os fatora e agrupa os resultados em resposta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 2.1. </font><font style="vertical-align: inherit;">Servlet sem suporte de estado interno</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@ThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatelessFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe StatelessFactorizer, como a maioria dos servlets, n√£o possui estado interno: n√£o cont√©m campos e n√£o se refere a campos de outras classes. </font><font style="vertical-align: inherit;">O estado para um c√°lculo espec√≠fico existe apenas em vari√°veis ‚Äã‚Äãlocais que s√£o armazenadas na pilha de fluxos e est√£o dispon√≠veis apenas para o fluxo em execu√ß√£o. </font><font style="vertical-align: inherit;">Um thread que acessa StatelessFactorizer n√£o pode afetar o resultado de outro thread fazendo o mesmo, porque esses threads n√£o compartilham o estado.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objetos sem suporte de estado interno s√£o sempre seguros para threads.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato de a maioria dos servlets poder ser implementada sem suporte interno do estado reduz significativamente a carga de segmentar os pr√≥prios servlets. </font><font style="vertical-align: inherit;">E somente quando os servlets precisam se lembrar de algo, os requisitos para a seguran√ßa de seus threads aumentam.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 </font><font style="vertical-align: inherit;">Atomicidade</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que acontece quando um item de estado √© adicionado a um objeto sem suporte interno ao estado? Suponha que desejemos adicionar um contador de visitas que mede o n√∫mero de solicita√ß√µes processadas. Voc√™ pode adicionar um campo do tipo long ao servlet e increment√°-lo com cada solicita√ß√£o, conforme mostrado em UnsafeCountingFactorizer na Listagem 2.2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 2.2. Um servlet que conta solicita√ß√µes sem a sincroniza√ß√£o necess√°ria. Isso n√£o deve ser feito.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/lj/hg/geljhgzyo9aogxu-ttztrzuawqo.jpeg" alt="imagem"></div><br>
<pre><code class="java hljs"><span class="hljs-meta">@NotThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UnsafeCountingFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> count = <span class="hljs-number">0</span>;<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> count; }<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            ++count;<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, a classe UnsafeCountingFactorizer n√£o √© segura para threads, mesmo que funcione bem em um ambiente de thread √∫nico. Como o UnsafeSequence, √© propenso a atualiza√ß√µes perdidas. Embora a contagem da opera√ß√£o de incremento ++ tenha sintaxe compacta, ela n√£o √© at√¥mica, ou seja, indivis√≠vel, mas uma sequ√™ncia de tr√™s opera√ß√µes: entrega do valor atual, adi√ß√£o de um valor a ele e grava√ß√£o do novo valor. Nas opera√ß√µes ‚Äúler, alterar, gravar‚Äù, o estado resultante √© derivado do anterior.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na fig. </font><font style="vertical-align: inherit;">1.1 √© mostrado o que pode acontecer se dois threads tentarem aumentar o contador ao mesmo tempo, sem sincroniza√ß√£o. </font><font style="vertical-align: inherit;">Se o contador for 9, devido √† coordena√ß√£o malsucedida do tempo, os dois threads ver√£o o valor 9, adicionam um a ele e configuram o valor para 10. Portanto, o contador de ocorr√™ncias come√ßar√° a ficar um para o outro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode pensar que ter um contador de ocorr√™ncias um pouco impreciso em um servi√ßo da web √© uma perda aceit√°vel, e √†s vezes √©. </font><font style="vertical-align: inherit;">Mas se o contador for usado para criar seq√º√™ncias ou identificadores exclusivos de objetos, o retorno do mesmo valor de v√°rias ativa√ß√µes poder√° levar a s√©rios problemas de integridade dos dados. </font><font style="vertical-align: inherit;">A possibilidade do aparecimento de resultados incorretos devido √† coordena√ß√£o temporal malsucedida surge em uma condi√ß√£o de corrida.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.1 </font><font style="vertical-align: inherit;">Condi√ß√µes da corrida</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe UnsafeCountingFactorizer possui v√°rias condi√ß√µes de corrida </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(4)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O tipo mais comum de condi√ß√£o de corrida √© a situa√ß√£o de "verificar e depois agir", em que uma observa√ß√£o potencialmente obsoleta √© usada para decidir o que fazer a seguir. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4)</font></font></b> <i>          (data race).   ,            .        ,    ,       ,   ,         ,      .               Java.       ,        ,             . UnsafeCountingFactorizer   .       16.</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitas vezes encontramos uma condi√ß√£o de ra√ßa na vida real. Suponha que voc√™ planeje encontrar um amigo ao meio-dia no Starbucks Caf√© na Universitetskiy Prospekt. Mas voc√™ descobrir√° que existem duas Starbucks na University Avenue. √Äs 12:10, voc√™ n√£o v√™ seu amigo no caf√© A e vai para o caf√© B, mas ele tamb√©m n√£o est√° l√°. Seu amigo est√° atrasado ou ele chegou ao caf√© A imediatamente depois que voc√™ saiu, ou ele estava no caf√© B, mas foi procur√°-lo e agora est√° a caminho do caf√© A. Vamos aceitar o √∫ltimo, ou seja, o pior cen√°rio. Agora 12:15, e voc√™s dois est√£o se perguntando se seu amigo cumpriu sua promessa. Voc√™ vai voltar para outro caf√©? Quantas vezes voc√™ vai e volta? Se voc√™ n√£o concordou com um protocolo, pode passar o dia inteiro andando pela University Avenue com euforia com cafe√≠na.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema com a abordagem ‚Äúdar um passeio e ver se ele est√° l√°‚Äù √© que um passeio pela rua entre dois caf√©s leva v√°rios minutos e, durante esse per√≠odo, o estado do sistema pode mudar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O exemplo da Starbucks ilustra a depend√™ncia do resultado na coordena√ß√£o de eventos em tempo relativo (em quanto tempo voc√™ espera por um amigo enquanto est√° em um caf√© etc.). </font><font style="vertical-align: inherit;">A observa√ß√£o de que ele n√£o est√° no caf√© A se torna potencialmente inv√°lida: assim que voc√™ sai pela porta da frente, ele pode entrar pela porta dos fundos. </font><font style="vertical-align: inherit;">A maioria das condi√ß√µes de corrida causa problemas como uma exce√ß√£o inesperada, dados sobrescritos e corrup√ß√£o de arquivos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.2 </font><font style="vertical-align: inherit;">Exemplo: condi√ß√µes de corrida na inicializa√ß√£o lenta</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um truque comum usando a abordagem "verificar e depois agir" √© a inicializa√ß√£o lenta (LazyInitRace). Seu objetivo √© adiar a inicializa√ß√£o do objeto at√© que seja necess√°rio e garantir que ele seja inicializado apenas uma vez. Na Listagem 2.3, o m√©todo getInstance verifica se o ExpensiveObject √© inicializado e retorna uma inst√¢ncia existente ou, caso contr√°rio, cria uma nova inst√¢ncia e a retorna ap√≥s manter uma refer√™ncia a ela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 2.3. A condi√ß√£o de corrida est√° na inicializa√ß√£o lenta. Isso n√£o deve ser feito.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/lj/hg/geljhgzyo9aogxu-ttztrzuawqo.jpeg" alt="imagem"></div><br>
<pre><code class="java hljs"><span class="hljs-meta">@NotThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyInitRace</span> </span>{
      <span class="hljs-keyword">private</span> ExpensiveObject instance = <span class="hljs-keyword">null</span>;<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>)<font></font>
                instance = <span class="hljs-keyword">new</span> ExpensiveObject();
            <span class="hljs-keyword">return</span> instance;<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe LazyInitRace cont√©m condi√ß√µes de corrida. Suponha que os encadeamentos A e B executem o m√©todo getInstance ao mesmo tempo. A v√™ que o campo da inst√¢ncia √© nulo e cria um novo ExpensiveObject. O segmento B tamb√©m verifica se o campo da inst√¢ncia √© o mesmo nulo. A presen√ßa de null no campo neste momento depende da coordena√ß√£o do tempo, incluindo os caprichos do planejamento e a quantidade de tempo necess√°ria para criar uma inst√¢ncia do ExpensiveObject e definir o valor no campo da inst√¢ncia. Se o campo da inst√¢ncia for nulo quando B a verificar, dois elementos de c√≥digo que chamam o m√©todo getInstance podem obter dois resultados diferentes, mesmo que o m√©todo getInstance deva sempre retornar a mesma inst√¢ncia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O contador de visitas no UnsafeCountingFactorizer tamb√©m cont√©m condi√ß√µes de corrida. A abordagem "ler, alterar, escrever" implica que, para aumentar o contador, o fluxo deve conhecer seu valor anterior e garantir que ningu√©m mais altere ou use esse valor durante o processo de atualiza√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a maioria dos erros competitivos, as condi√ß√µes da corrida nem sempre levam ao fracasso: a coordena√ß√£o tempor√°ria √© bem-sucedida. </font><font style="vertical-align: inherit;">Mas se a classe LazyInitRace for usada para instanciar o registro de todo o aplicativo, quando retornar inst√¢ncias diferentes de v√°rias ativa√ß√µes, os registros ser√£o perdidos ou as a√ß√µes receber√£o representa√ß√µes conflitantes do conjunto de objetos registrados. </font><font style="vertical-align: inherit;">Ou se a classe UnsafeSequence for usada para gerar identificadores de entidade em uma estrutura de conserva√ß√£o de dados, dois objetos diferentes poder√£o ter o mesmo identificador, violando as restri√ß√µes de identidade.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.3 </font><font style="vertical-align: inherit;">A√ß√µes compostas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LazyInitRace e UnsafeCountingFactorizer cont√™m uma sequ√™ncia de opera√ß√µes que devem ser at√¥micas. </font><font style="vertical-align: inherit;">Mas, para evitar uma condi√ß√£o de corrida, deve haver um obst√°culo para outros threads usarem a vari√°vel enquanto um segmento a modifica.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As opera√ß√µes A e B s√£o at√¥micas se, do ponto de vista do encadeamento executando a opera√ß√£o A, a opera√ß√£o B foi totalmente executada por outro encadeamento ou nem parcialmente executada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A atomicidade da opera√ß√£o de incremento no UnsafeSequence evitaria a condi√ß√£o de corrida mostrada na Fig. 1.1 As opera√ß√µes "verificar e depois agir" e "ler, alterar, escrever" devem sempre ser at√¥micas. Eles s√£o chamados de a√ß√µes compostas - sequ√™ncias de opera√ß√µes que devem ser executadas atomicamente para manter a seguran√ßa do thread. Na pr√≥xima se√ß√£o, consideraremos o bloqueio - um mecanismo incorporado ao Java que fornece atomicidade. Enquanto isso, corrigiremos o problema de outra maneira aplicando a classe segura de thread existente, conforme mostrado no Countingfactorizer na Listagem 2.4. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 2.4. Solicita√ß√µes de contagem de servlets usando AtomicLong</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@ThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountingFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong count = <span class="hljs-keyword">new</span> AtomicLong(<span class="hljs-number">0</span>);<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> count.get(); }<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            count.incrementAndGet();<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pacote java.util.concurrent.atomic cont√©m vari√°veis ‚Äã‚Äãat√¥micas para gerenciar estados de classe. Substituindo o tipo de contador de long por AtomicLong, garantimos que todas as a√ß√µes que se referem ao estado do contador sejam atomic1. Como o estado do servlet √© o estado do contador e o contador √© seguro para threads, nosso servlet se torna seguro para threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um √∫nico elemento de estado √© adicionado a uma classe que n√£o oferece suporte ao estado interno, a classe resultante ser√° protegida por thread se o estado for completamente controlado pelo objeto seguro de thread. Mas, como veremos na pr√≥xima se√ß√£o, a transi√ß√£o de uma vari√°vel de estado para a pr√≥xima n√£o ser√° t√£o simples quanto a transi√ß√£o de zero para uma.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onde for conveniente, use objetos seguros para threads existentes, como AtomicLong, para controlar o estado da sua classe. </font><font style="vertical-align: inherit;">Os poss√≠veis estados de objetos seguros para threads existentes e suas transi√ß√µes para outros estados s√£o mais f√°ceis de manter e verificar a seguran√ßa de threads do que vari√°veis ‚Äã‚Äãde estado arbitr√°rias.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬ªMais informa√ß√µes sobre o livro podem ser encontradas no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site da editora</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¬ª </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte√∫do</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¬ª </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trecho do</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
cupom Khabrozhiteley de 25% de desconto no cupom - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ap√≥s o pagamento da vers√£o impressa do livro, um livro eletr√¥nico √© enviado por e-mail.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489022/index.html">Usando RabbitMQ com MonsterMQ Parte 2</a></li>
<li><a href="../pt489024/index.html">Biblioteca Webix JavaScript atrav√©s dos olhos de um iniciante. Parte 5. Trabalhe com dados no lado do usu√°rio</a></li>
<li><a href="../pt489026/index.html">Alterar os algoritmos do Google AdSense pode levar os propriet√°rios de sites e webmasters</a></li>
<li><a href="../pt489028/index.html">Sobre trabalho remoto</a></li>
<li><a href="../pt489034/index.html">O novo aplicativo m√≥vel UIS - tormento ou salva√ß√£o para quem procura contratos p√∫blicos?</a></li>
<li><a href="../pt489040/index.html">AI do Contact Center: boa conversa com terceiros</a></li>
<li><a href="../pt489042/index.html">Grande reabertura da loja: carregamento de dados no Android usando corotina</a></li>
<li><a href="../pt489044/index.html">F√≠sica do texto. Parte 1. S√≠mbolos</a></li>
<li><a href="../pt489046/index.html">Monster Truck GAZ66 aut√¥nomo 1/16</a></li>
<li><a href="../pt489048/index.html">Log e rastreamento de consultas s√£o pr√°ticas recomendadas. Relat√≥rio Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>