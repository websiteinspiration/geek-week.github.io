<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🌾 🚉 ⚗️ DOOM Watch auf ESP32. Teil 1 ✌🏼 👩🏿‍🔬 👩‍❤️‍👨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nachdem ich die Entwicklung mit vorgefertigten ESP32-Modulen ausprobiert hatte, wollte ich etwas Kleines und Natives machen. Ich beschloss, eine Uhr z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DOOM Watch auf ESP32. Teil 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachdem ich die Entwicklung mit vorgefertigten ESP32-Modulen ausprobiert hatte, wollte ich etwas Kleines und Natives machen. </font><font style="vertical-align: inherit;">Ich beschloss, eine Uhr zu machen. </font><font style="vertical-align: inherit;">Zuerst dachte ich an den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32-PICO-D4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Da das Programm nur 4 MB Flash enthält, habe ich mich für eine Vollversion mit einer Erweiterung von bis zu 16 MB Flash und 8 MB SRAM entschieden. </font><font style="vertical-align: inherit;">Unabhängig von der Uhr können Sie das erste Doom ausführen. </font><font style="vertical-align: inherit;">Im Allgemeinen war das alles voll! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r0/tm/qh/r0tmqhwcgq1geu0iyijuroahpvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was wurde noch nicht getan oder muss verbessert werden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batterieanzeige</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Auf Schottky-Diode implementierte Ladungssperrschaltung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Antenne befindet sich nicht sehr gut auf einer anderen Schicht von ESP32</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kein Tutorial!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bw/cn/gr/bwcngruk2zywo5wuqk-zvco4toq.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durch Anzeige</font></font></h3><br>
<img width="400" src="https://habrastorage.org/webt/y-/0a/rp/y-0arpnjd4fsidh22irudjow-qg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe ein Farbdisplay auf dem ST7789-Controller mit einer Auflösung von 240 x 240 angewendet. </font><font style="vertical-align: inherit;">Es ist ziemlich kompakt und billig. </font><font style="vertical-align: inherit;">Im Netzwerk werden immer mehr Treiber und Ports angezeigt. </font><font style="vertical-align: inherit;">Zum Beispiel gibt es einen Anschluss für </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LittlevGL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber auf diesem Display befindet sich keine Schubkarre. </font><font style="vertical-align: inherit;">Ich denke, es kann gekauft und geklebt werden. </font><font style="vertical-align: inherit;">Vielleicht hat jemand Erfahrung? </font><font style="vertical-align: inherit;">Share. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe ein Board auf ST7789 entwickelt und es wurde ohne Probleme gestartet.</font></font><br>
<br>
<img width="500" src="https://habrastorage.org/webt/fw/ic/mc/fwicmcivnyq44nxvhwqpjqrlsco.jpeg"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LittlevGL esp32</font></font></b>
                        <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/15qrV2CNSoQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durch Füllen von Programmen und Debuggen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB-TO-UART BRIDGE-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konverter CP2102 </font><font style="vertical-align: inherit;">verwendet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Erstens ist es kompakt und zweitens ist der Anschlussplan sehr einfach und es werden fast keine zusätzlichen Teile benötigt.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 2: Ein 4,7-μF-Kondensator kann hinzugefügt werden, wenn andere Geräte über den On-Chip-Regler mit Strom versorgt werden.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie REGIN und VBUS an ein USB 5V-Netzteil anschließen, benötigen Sie nur einen Nebenschlusskondensator am Eingang. </font><font style="vertical-align: inherit;">Obwohl ich denke, dass es ohne es funktionieren kann. </font><font style="vertical-align: inherit;">VDD auf einem Chip ist in diesem Fall der Ausweg! </font><font style="vertical-align: inherit;">Ich habe einen Fehler gemacht und ihn an den 3,3-V-Stromkreis angeschlossen und konnte nicht verstehen, warum ich 4,65 V an der Stromversorgung habe ?! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Link in der folgenden Dokumentation enthält Optionen zum Anschließen an eine 3,3-V-Stromversorgung. </font><font style="vertical-align: inherit;">Ich denke jedoch, dass CP2102 absolut nicht mit Strom versorgt werden muss, wenn das Gerät nicht hochgeladen oder debuggt werden muss</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yy/-k/go/yy-kgo5r6igfhil55qe7zg2j7wu.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laden des Modulo-Akkus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Widerstand am LTC4054 stellt den Ladestrom ein:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/ex/5q/rdex5qbeqitjred4al5o0c267ju.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ernährung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stromversorgung über 3,7-V-Batterien mit Stabilisator HT7833. Ausgangsstrom 500mA. Es hat einen kleinen Spannungsabfall von ~ 300 mV. LD1117-3.3 hat "ein bisschen" mehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Hinweis zu den Schlussfolgerungen von VDD_SDIO. Dieser Pin-Stromversorgungsausgang beträgt 1,8 V oder 3,3 V, abhängig vom Status des IO12-Mikrocontrollers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beim Start</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . 3,3 V GPIO12 ist 0 (Standard)</font></font><br>
<blockquote>VDD_SDIO works as the power supply for the related IO, and also for an external device.<br>
<br>
When VDD_SDIO operates at 1.8 V, it can be generated from ESP32’s internal LDO. The maximum currentthis LDO can offer is 40 mA, and the output voltage range is 1.65 V~2.0 V. <br>
<br>
When the VDD_SDIO outputs 1.8 V, the value of GPIO12 should be set to 1 when the chip boots and it is recommended that users add a2 kΩ ground resistor and a 4.7 mF filter capacitor close to VDD_SDIO.<br>
<br>
When VDD_SDIO operates at 3.3 V, it is driven directly by VDD3P3_RTC through a 6Ωresistor, therefore,there will be some voltage drop from VDD3P3_RTC. <br>
<br>
When the VDD_SDIO outputs 3.3 V, the value of GPIO12 is 0 (default) when the chip boots and it is recommended that users add a 1mF capacitor close to VDD_SDIO<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist sehr praktisch, wenn Sie 1,8 V Blitz haben. </font><font style="vertical-align: inherit;">In meinem Fall habe ich diese Schlussfolgerung gezogen und meinen 3V3-Blitz und mein PSRAM an das allgemeine Netzteil angeschlossen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige ESP32-Module verwenden VDD_SDIO, daher kann ich beim Start nichts an die Peripheriegeräte von IO12 hängen. </font><font style="vertical-align: inherit;">Sie können beispielsweise eine Schaltfläche aufhängen. </font><font style="vertical-align: inherit;">In einer meiner Lösungen habe ich ein SPI-Bein an IO12 gehängt und das Modul wurde nicht gestartet. </font><font style="vertical-align: inherit;">Anscheinend hat IO12 eine Einheit von diesem SPI-Port bekommen, aber ich brauchte 0 oder umgekehrt. </font><font style="vertical-align: inherit;">Dies muss berücksichtigt werden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle zusammen:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cx/-o/ku/cx-oku_wxajemjbyrjrilqm0xpc.png" alt="Bild"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 MB PSRAM</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 MB PSRAM Upgrade Mod </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterstützung für externen RAM</font></font></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSRAM / CE (Pin 1)&gt; ESP32 GPIO 16 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SO (Pin 2)&gt; Flash DO </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SIO [2] (Pin 3)&gt; Flash WP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SI (Pin 5)&gt; Flash DI </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SCLK (Pin 6)&gt; ESP32 GPIO 17 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM SIO [3] (Pin 7)&gt; Flash HOLD </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSRAM Vcc (Pin 8)&gt; ESP32 VCC_SDIO</font></font></blockquote><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leiterplattenantenne</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kleine 2,4-GHz-Leiterplattenantenne verwendet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es befindet sich in der Eagle Autodesk-Bibliothek und nimmt einen kleinen Bereich ein. </font><font style="vertical-align: inherit;">Sie können wahrscheinlich CERAMIC DIELECTRIC ANTENNA verwenden, aber Sie müssen es kaufen, und der Preis für eine PCB-Antenne ist etwas höher. </font><font style="vertical-align: inherit;">Eine Keramikantenne ist jedoch weniger effektiv. </font><font style="vertical-align: inherit;">Jede Option </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antennenauswahl </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Kurzanleitung Richtlinien</font></a><font style="vertical-align: inherit;"> für </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Antennendesign und HF-Layout</font></a><font style="vertical-align: inherit;"> eignen sich zur Überprüfung des Konzepts.</font></font><br>
<br>
<img width="400" src="https://habrastorage.org/webt/m9/0b/lq/m90blqi_al7oqlx6cgobpazbk4c.png" alt="Bild"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen über das Anpassen der Antenne</font></font></h3><br>
<img src="https://habrastorage.org/webt/py/o-/lx/pyo-lxfj7y7lu51eltxs_f3u-mm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32-Hardware-Designrichtlinien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf Seite 7 enthalten Richtlinien für die Implementierung eines HF-Filters:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Ausgangsimpedanz der HF-Pins von ESP32 (QFN 6 * 6) und ESP32 (QFN 5 * 5) beträgt (30 + j10) Ω bzw. (35 + j10) Ω</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie zum Berechnen das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Online Smith Chart Tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Die Hauptidee ist, bei (30 + j10) zum Mittelpunkt des Kreises zu gelangen. Hierbei handelt es sich jedoch um berechnete Daten, und die tatsächliche Verwendung der Parameter kann durch die Dicke der Spuren und der Leiterplatte sowie durch die Position relativ zu anderen Komponenten der Schaltung beeinflusst werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/lw/w2/mblww2rcjw5h5otg0bwgbfoqhgw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist nicht die einzige Antennenanpassungsschaltung. Zum Beispiel ist die Anpassung auf der esp32-pic </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Karte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> etwas anders: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">esp32-pico-kit-v4_schematic </font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Smith-Diagramm und Impedanzanpassung Die</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Position der Antenne und der freie Bereich um sie herum sind ebenfalls wichtig. Wie ich bereits geschrieben habe, ist in meinem Fall die Position nicht optimal ausgewählt. Für die erste Iteration der Karte und die Überprüfung des Konzepts wird der </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2y/sk/me/2yskmeit4qo4hv0fhldmyq0xgpq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
zweite Teil der Karte selbst und der dritten Portierung von Software gewidmet sein. Vielleicht passt alles in einen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde auf dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Port </font><font style="vertical-align: inherit;">von Espressif Systems </font><font style="vertical-align: inherit;">ein bisschen </font><font style="vertical-align: inherit;">weiterkommen. </font><font style="vertical-align: inherit;">Der Port verwendet ILI9341, wir haben ST7789. </font><font style="vertical-align: inherit;">Da jedoch die Initialisierung und Ausgabe des Puffers in einer separaten Datei ausgeführt und in separate Methoden unterteilt wird, sollte die Anpassung an meine Anzeige keine großen Schwierigkeiten verursachen.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ili_init und displayTask sind für die Initialisierung der Anzeige verantwortlich</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DisplayTask ist für die Anzeige verantwortlich.</font></font></li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">displayTask</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> IRAM_ATTR <span class="hljs-title">displayTask</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
	<span class="hljs-keyword">int</span> x, i;
	<span class="hljs-keyword">int</span> idx=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> inProgress=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">static</span> <span class="hljs-keyword">uint16_t</span> *dmamem[NO_SIM_TRANS];
	<span class="hljs-keyword">spi_transaction_t</span> trans[NO_SIM_TRANS];
	<span class="hljs-keyword">spi_transaction_t</span> *rtrans;<font></font>
<font></font>
    <span class="hljs-keyword">esp_err_t</span> ret;
    <span class="hljs-keyword">spi_bus_config_t</span> buscfg={<font></font>
        .miso_io_num=<span class="hljs-number">-1</span>,<font></font>
        .mosi_io_num=PIN_NUM_MOSI,<font></font>
        .sclk_io_num=PIN_NUM_CLK,<font></font>
        .quadwp_io_num=<span class="hljs-number">-1</span>,<font></font>
        .quadhd_io_num=<span class="hljs-number">-1</span>,<font></font>
        .max_transfer_sz=(MEM_PER_TRANS*<span class="hljs-number">2</span>)+<span class="hljs-number">16</span><font></font>
    };<font></font>
    <span class="hljs-keyword">spi_device_interface_config_t</span> devcfg={<font></font>
        .clock_speed_hz=<span class="hljs-number">26000000</span>,               <span class="hljs-comment">//Clock out at 26 MHz. Yes, that's heavily overclocked.</span>
        .mode=<span class="hljs-number">0</span>,                                <span class="hljs-comment">//SPI mode 0</span>
        .spics_io_num=PIN_NUM_CS,               <span class="hljs-comment">//CS pin</span>
        .queue_size=NO_SIM_TRANS,               <span class="hljs-comment">//We want to be able to queue this many transfers</span>
        .pre_cb=ili_spi_pre_transfer_callback,  <span class="hljs-comment">//Specify pre-transfer callback to handle D/C line</span><font></font>
    };<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"*** Display task starting.\n"</span>);<font></font>
<font></font>
    <span class="hljs-comment">//Initialize the SPI bus</span>
    ret=spi_bus_initialize(HSPI_HOST, &amp;buscfg, <span class="hljs-number">1</span>);<font></font>
    assert(ret==ESP_OK);<font></font>
    <span class="hljs-comment">//Attach the LCD to the SPI bus</span><font></font>
    ret=spi_bus_add_device(HSPI_HOST, &amp;devcfg, &amp;spi);<font></font>
    assert(ret==ESP_OK);<font></font>
    <span class="hljs-comment">//Initialize the LCD</span><font></font>
    ili_init(spi);<font></font>
<font></font>
	<span class="hljs-comment">//We're going to do a fair few transfers in parallel. Set them all up.</span>
	<span class="hljs-keyword">for</span> (x=<span class="hljs-number">0</span>; x&lt;NO_SIM_TRANS; x++) {<font></font>
		dmamem[x]=pvPortMallocCaps(MEM_PER_TRANS*<span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
		assert(dmamem[x]);<font></font>
		<span class="hljs-built_in">memset</span>(&amp;trans[x], <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">spi_transaction_t</span>));<font></font>
		trans[x].length=MEM_PER_TRANS*<span class="hljs-number">2</span>;<font></font>
		trans[x].user=(<span class="hljs-keyword">void</span>*)<span class="hljs-number">1</span>;<font></font>
		trans[x].tx_buffer=&amp;dmamem[x];<font></font>
	}<font></font>
	xSemaphoreGive(dispDoneSem);<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {<font></font>
		xSemaphoreTake(dispSem, portMAX_DELAY);<font></font>
<span class="hljs-comment">//		printf("Display task: frame.\n");</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> DOUBLE_BUFFER</span>
		<span class="hljs-keyword">uint8_t</span> *myData=(<span class="hljs-keyword">uint8_t</span>*)currFbPtr;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
		send_header_start(spi, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">320</span>, <span class="hljs-number">240</span>);<font></font>
		send_header_cleanup(spi);<font></font>
		<span class="hljs-keyword">for</span> (x=<span class="hljs-number">0</span>; x&lt;<span class="hljs-number">320</span>*<span class="hljs-number">240</span>; x+=MEM_PER_TRANS) {
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> DOUBLE_BUFFER</span>
			<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;MEM_PER_TRANS; i+=<span class="hljs-number">4</span>) {
				<span class="hljs-keyword">uint32_t</span> d=currFbPtr[(x+i)/<span class="hljs-number">4</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">0</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">0</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">1</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">2</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
				dmamem[idx][i+<span class="hljs-number">3</span>]=lcdpal[(d&gt;&gt;<span class="hljs-number">24</span>)&amp;<span class="hljs-number">0xff</span>];<font></font>
			}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
			<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;MEM_PER_TRANS; i++) {<font></font>
				dmamem[idx][i]=lcdpal[myData[i]];<font></font>
			}<font></font>
			myData+=MEM_PER_TRANS;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
			trans[idx].length=MEM_PER_TRANS*<span class="hljs-number">16</span>;<font></font>
			trans[idx].user=(<span class="hljs-keyword">void</span>*)<span class="hljs-number">1</span>;<font></font>
			trans[idx].tx_buffer=dmamem[idx];<font></font>
			ret=spi_device_queue_trans(spi, &amp;trans[idx], portMAX_DELAY);<font></font>
			assert(ret==ESP_OK);<font></font>
<font></font>
			idx++;<font></font>
			<span class="hljs-keyword">if</span> (idx&gt;=NO_SIM_TRANS) idx=<span class="hljs-number">0</span>;<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (inProgress==NO_SIM_TRANS<span class="hljs-number">-1</span>) {<font></font>
				ret=spi_device_get_trans_result(spi, &amp;rtrans, portMAX_DELAY);<font></font>
				assert(ret==ESP_OK);<font></font>
			} <span class="hljs-keyword">else</span> {<font></font>
				inProgress++;<font></font>
			}<font></font>
		}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> DOUBLE_BUFFER</span><font></font>
		xSemaphoreGive(dispDoneSem);<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
		<span class="hljs-keyword">while</span>(inProgress) {<font></font>
			ret=spi_device_get_trans_result(spi, &amp;rtrans, portMAX_DELAY);<font></font>
			assert(ret==ESP_OK);<font></font>
			inProgress--;<font></font>
		}<font></font>
	}<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video Esp32-Doom schnelle Demo</font></font></b>
                        <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/Gb_JFDa0AIo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Board-Bestellung wurde an die Jlcpcb-Fabrik gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Herausforderung gestartet!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de494728/index.html">Die kostengünstigste Methode zur Automatisierung von Vorhängen</a></li>
<li><a href="../de494730/index.html">Interview mit Amusa Buminasan</a></li>
<li><a href="../de494732/index.html">Der Betreuer der beliebtesten JS-Bibliothek wurde wegen seines Verschuldens wegen eines tödlichen Unfalls zu einer Freiheitsstrafe verurteilt</a></li>
<li><a href="../de494736/index.html">Was der Blog des Herausgebers über die Trends der IT-Community aussagt</a></li>
<li><a href="../de494738/index.html">Ansible ist nichts für dich. Sergey Pechenko</a></li>
<li><a href="../de494750/index.html">Farbtheorie, Kontrast</a></li>
<li><a href="../de494754/index.html">Digitale Veranstaltungen in Moskau vom 30. März bis 5. April</a></li>
<li><a href="../de494762/index.html">50 Anwendungen für die effektive Organisation von Fernarbeit</a></li>
<li><a href="../de494766/index.html">Trends in der Kommunikationstechnologie der nahen Zukunft</a></li>
<li><a href="../de494772/index.html">Wie sich der Kampf gegen Roboteranrufe in den USA entwickelt - nach Maßgabe von Politikern und Telekommunikationsunternehmen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>