<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèª üë©üèº‚Äçüç≥ üõ¨ Packer, Terraform et Ansible: d√©ploiement du cluster Kubernetes en une heure üò´ ‚úãüèº üê•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, je m'appelle Andrey Schukin, j'aide les grandes entreprises √† migrer leurs services et syst√®mes vers le cloud CROC. En collaboration avec des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Packer, Terraform et Ansible: d√©ploiement du cluster Kubernetes en une heure</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/492616/"><img src="https://habrastorage.org/webt/0m/2c/zt/0m2cztx1saqv1v7e8a3mrliht_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour, je m'appelle Andrey Schukin, j'aide les grandes entreprises √† migrer leurs services et syst√®mes vers le cloud CROC. En collaboration avec des coll√®gues de Southbridge, qui organise des cours Kubernetes au centre de formation Slerm, nous avons r√©cemment organis√© un webinaire pour nos clients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© de prendre des documents d'une excellente conf√©rence de Pavel Selivanov et d'√©crire un article pour ceux qui commencent tout juste √† travailler avec des outils de provisioning cloud et ne savent pas par o√π commencer. Par cons√©quent, je vais parler de la pile de technologies utilis√©es dans notre formation et notre production de CROC Cloud. Parlons des approches modernes de la gestion de l'infrastructure, d'un tas de composants Packer, Terraform et Ansible, ainsi que de l'outil Kubeadm avec lequel nous allons installer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous la coupe, il y aura beaucoup de texte et de configurations. </font><font style="vertical-align: inherit;">Il y a beaucoup de mat√©riel, j'ai donc ajout√© la navigation post. </font><font style="vertical-align: inherit;">Nous avons √©galement pr√©par√© un petit r√©f√©rentiel o√π nous avons mis tout ce dont nous avions besoin pour notre d√©ploiement de formation. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne donnez pas de noms aux poulets. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les g√¢teaux au four sont plus sains que les frits. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allumons le four. </font><font style="vertical-align: inherit;">Packer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infrastructure en tant que code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lancez la </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structure du cluster </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Terraform </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Kubernetes </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository avec tous les fichiers</font></font></a><br>
 <a name="habracut"></a><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne donnez pas de noms aux poulets</font></font></h2><br>
<img src="https://habrastorage.org/webt/j0/0w/v1/j00wv1h7pcevviakk2iocfleqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreux concepts diff√©rents de gestion des infrastructures. L'un d'eux s'appelle Pets vs. Le b√©tail, c'est-√†-dire "les animaux de compagnie contre le b√©tail". Ce concept d√©crit deux approches oppos√©es de l'infrastructure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez que nous avons un chien pr√©f√©r√©. Nous prenons soin d'elle, l'emmenons chez le v√©t√©rinaire, peignons la fourrure, et en g√©n√©ral, elle est unique parmi de nombreux autres chiens.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un autre cas, nous avons un poulailler. Nous prenons √©galement soin des poulets, nourrissons, chauffons et essayons de cr√©er les conditions les plus confortables. N√©anmoins, les poulets sont une ressource plut√¥t sans visage pour nous, qui remplit sa fonction de ponte, et au mieux nous les d√©signons comme "ce noir en poudre qui picore toujours le ciment". Si le poulet cesse de pondre des ≈ìufs ou se casse la patte, il est fort probable qu'il nous fournira simplement un d√©licieux bouillon pour le d√©jeuner. En fait, nous ne nous soucions pas du sort d'un poulet en particulier, mais du poulailler dans son ensemble en tant que cha√Æne de production. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En informatique, une approche similaire a commenc√© √† √™tre appliqu√©e d√®s l'apparition des outils qui abaissaient le seuil d'entr√©e pour les ing√©nieurs et permettaient de d√©ployer et de maintenir des clusters complexes en mode enti√®rement automatique.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auparavant, nous avions un petit nombre de serveurs qui √©taient surveill√©s, r√©gl√©s manuellement et entretenus de toutes les mani√®res possibles. Lors de la surveillance, les journaux des serveurs Cthulhu, Aylith et Dagon ont clignot√©. Traditions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, la virtualisation est fermement entr√©e dans nos vies, et les noms des ≈ìuvres de Lovecraft et Star Trek ont ‚Äã‚Äãc√©d√© la place au ¬´vlg-vlt-vault01.company.ru¬ª plus utilitaire. Il y a beaucoup de serveurs, mais nous avons quand m√™me augment√© les services plus ou moins manuellement, √©liminant les probl√®mes sur chaque machine si n√©cessaire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©sormais, l'approche de la maintenance de l'infrastructure co√Øncide compl√®tement avec la programmation. </font><font style="vertical-align: inherit;">Nous ajoutons un autre niveau d'abstraction et cessons de nous soucier des n≈ìuds individuels. </font><font style="vertical-align: inherit;">Chacun a un index sans visage au lieu d'un nom, et en cas de probl√®me, la machine virtuelle tue et monte simplement √† partir de l'instantan√© de travail. </font><font style="vertical-align: inherit;">Il existe des outils qui vous permettent de mettre en ≈ìuvre cette approche. </font><font style="vertical-align: inherit;">Dans notre cas, le premier outil est le CROC Cloud, le second est Terraform.</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les g√¢teaux au four sont plus sains que frits</font></font></h2><br>
<img src="https://habrastorage.org/webt/hs/pp/oa/hsppoaujv0lhrk0u3dt6ust0rry.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la gestion des infrastructures, il existe un contraste entre les deux approches Fried vs Cuit, c'est-√†-dire ¬´frit contre cuit¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'approche de Fried implique que vous avez une image vanilla du syst√®me d'exploitation, par exemple, CentOS 7. Ensuite, apr√®s le d√©ploiement du syst√®me d'exploitation, nous utilisons le syst√®me de gestion de la configuration afin d'amener le syst√®me √† l'√©tat cible. Par exemple, en utilisant Ansible, Chef, Puppet ou SaltStack.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout fonctionne bien, surtout quand il n'y a pas beaucoup de serveurs. Lorsqu'un d√©ploiement massif est n√©cessaire, nous sommes confront√©s √† des probl√®mes de performances. Des centaines de serveurs commencent √† d√©vorer de mani√®re synchrone les ressources r√©seau, le CPU, la RAM et les IOPS dans le processus de d√©ploiement de nombreux nouveaux packages. De plus, ce processus peut √™tre retard√© assez longtemps. Bref, le circuit est absolument op√©rationnel, mais pas si int√©ressant du point de vue de la minimisation des temps d'arr√™t lors d'accidents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'approche Baked implique que vous avez des images OS pr√™tes √† l'emploi sur lesquelles vous avez d√©j√† install√© tous les packages n√©cessaires, configur√© la configuration et tout le reste. </font><font style="vertical-align: inherit;">√Ä la sortie, nous avons un mod√®le d'instantan√© abstrait, affin√© pour les performances de certaines fonctions. </font><font style="vertical-align: inherit;">Le d√©ploiement de l'infrastructure √† partir de ces images cuites prend beaucoup moins de temps et r√©duit les temps d'arr√™t au minimum. </font><font style="vertical-align: inherit;">Une id√©ologie tr√®s similaire est utilis√©e dans les images Docker multicouches, dans lesquelles personne ne se tape inutilement les mains. </font><font style="vertical-align: inherit;">Clou√© le conteneur - en a soulev√© un nouveau.</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous d√©marrons le four. </font><font style="vertical-align: inherit;">Emballeur</font></font></h2><br>
<img src="https://habrastorage.org/webt/xw/mr/im/xwmrimtkl-6qvfcrae3xo4zdf7q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre infrastructure, nous utilisons plusieurs produits Hashicorp, dont certains se sont av√©r√©s extr√™mement r√©ussis. Commen√ßons notre magie avec la pr√©paration et la cuisson d'une image √† l'aide de l'outil Packer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer utilise un mod√®le JSON, c'est-√†-dire des fichiers de mod√®le qui contiennent une description de ce qui doit √™tre obtenu en tant que machine virtuelle (VM) ¬´cuite¬ª. Apr√®s avoir cr√©√© le mod√®le, le fichier est transf√©r√© vers Packer et les autorisations n√©cessaires pour cr√©er le serveur dans le cloud sont configur√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer vous permet de g√©n√©rer des VM localement dans KVM, VirtualBox, Vagrant, AWS, GCP, Alibaba Cloud, OpenStack, etc. Il est pratique de travailler avec Packer dans le cloud CROC, car il impl√©mente des interfaces AWS, c'est-√†-dire tous les outils qui sont √©crits pour AWS, travaillez avec le CROC Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir d√©fini les mod√®les n√©cessaires, Packer l√®ve VM CROC dans le Cloud, attend qu'il d√©marre, puis le ¬´fournisseur¬ª entre dans le travail - provisioner: un utilitaire qui doit terminer la pr√©paration de l'image. </font><font style="vertical-align: inherit;">Dans notre cas, il s'agit d'Ansible, bien que Packer puisse fonctionner avec d'autres options. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la machine virtuelle est pr√™te, Packer cr√©e son image et la place dans le cloud CROC afin que d'autres machines virtuelles puissent √™tre lanc√©es √† partir de la m√™me image.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure Base.json</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au d√©but du fichier, il y a une section dans laquelle les variables sont d√©clar√©es:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"variables" : {<font></font>
 "source_ami_name": "{{env SOURCE_AMI_NAME}}",<font></font>
 "ami_name": "{{env AMI_NAME}}",<font></font>
 "instance_type": "{{env INSTANCE_TYPE}}",<font></font>
 "kubernetes_version": "{{env KUBERNETES_VERSION}}",<font></font>
 "docker_version": "{{env DOCKER_VERSION}}",<font></font>
 "subnet_id": "",<font></font>
 "availability_zone": "",<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ensemble principal de ces variables sera d√©fini √† partir du fichier settings.json. </font><font style="vertical-align: inherit;">Et ces variables qui changent fr√©quemment sont plus pratiques √† d√©finir √† partir de la console lors du d√©marrage de Packer et de la cr√©ation d'une nouvelle image. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici la section Builders:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"builders" : [<font></font>
 {<font></font>
  "type": "amazon-ebs",<font></font>
  "region": "croc",<font></font>
  "skip_region_validation": true,<font></font>
  "custom_endpoint_ec2": "https://api.cloud.croc.ru",<font></font>
  "source_ami": "",<font></font>
  "source_ami_filter": {<font></font>
   "filters": {<font></font>
    "name": "{{user `source_ami_name`}}"<font></font>
    "state": "available",<font></font>
    "virtualization-type": "kvm-virtio"<font></font>
     },<font></font>
...</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les nuages ‚Äã‚Äãcibles et la m√©thode de d√©marrage de la machine virtuelle sont d√©crits ici. Veuillez noter que dans ce cas, le type amazon-ebs est d√©clar√©, mais pour le fonctionnement de Packer avec le CROC Cloud, l'adresse correspondante dans custom_endpoint_ec2 est d√©finie. Notre infrastructure dispose d'une API qui est presque enti√®rement compatible avec Amazon Web Services, donc si vous avez des d√©veloppements pr√™ts √† l'emploi pour cette plate-forme, vous n'aurez pour la plupart √† sp√©cifier qu'un point d'entr√©e d'API personnalis√© - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.cloud.croc.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans notre exemple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de noter s√©par√©ment la section source_ami_filter. </font><font style="vertical-align: inherit;">Ici, l'image initiale de la VM est d√©finie, dans laquelle les modifications n√©cessaires seront apport√©es. </font><font style="vertical-align: inherit;">Cependant, Packer n√©cessite une AMI pour cette image, c'est-√†-dire son identifiant al√©atoire. </font><font style="vertical-align: inherit;">√âtant donn√© que cet identifiant est rarement connu √† l'avance et change √† chaque mise √† jour, l'AMI source n'est pas d√©finie comme une valeur sp√©cifique, mais comme une variable source_ami_filter. </font><font style="vertical-align: inherit;">Dans ce cas, le param√®tre d√©terminant du filtre est le nom de l'image. </font><font style="vertical-align: inherit;">Ce nom est d√©fini dans les variables via le fichier settings.json. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, les param√®tres de la VM sont d√©finis: le type d'instance, le processeur, la taille de la m√©moire, l'espace allou√©, etc. sont sp√©cifi√©s:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"instance_type": "{{user `instance_type`}}",<font></font>
"launch_block_device_mappings": [<font></font>
 {<font></font>
  "device_name": "disk1",<font></font>
  "volume_type": "io1",<font></font>
  "volume_size": "8",<font></font>
  "iops": "1000",<font></font>
  "delete_on_termination": "true"<font></font>
 }<font></font>
],</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les param√®tres de connexion √† cette machine virtuelle dans base.json:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"availability_zone": "{{user `availability_zone`}}",<font></font>
"subnet_id": "{{user `subnet_id`}}",<font></font>
"associate_public_ip_address": true,<font></font>
"ssh_username": "ec2-user",<font></font>
"ami_name": "{{user `ami_name`}}"<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de noter ici le param√®tre subnet_id. </font><font style="vertical-align: inherit;">Il doit √™tre d√©fini manuellement, car sans sp√©cifier le sous-r√©seau VM dans le CROC Cloud, il est impossible de cr√©er. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre param√®tre qui n√©cessite une pr√©paration pr√©alable est associ_public_ip_address. </font><font style="vertical-align: inherit;">Vous devez s√©lectionner une adresse IP blanche, car apr√®s avoir cr√©√© le VM Packer commencera √† appliquer les param√®tres n√©cessaires via Ansible. </font><font style="vertical-align: inherit;">Dans ce cas, Ansible se connecte √† la machine virtuelle via SSH, ce qui n√©cessite une adresse IP blanche ou un VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La derni√®re section est les Provisioners:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"provisioners": [<font></font>
 {<font></font>
  "type": "ansible",<font></font>
  "playbook_file": "playbook.yml",<font></font>
  "extra_arguments": [<font></font>
   "--extra-vars",<font></font>
   "kubernetes_version={{user `kubernetes_version`}}",<font></font>
   "--extra-vars",<font></font>
   "docker_version={{user `docker_version`}}"<font></font>
   ]<font></font>
  }<font></font>
]</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont les fournisseurs, c'est-√†-dire les utilitaires avec lesquels Packer configure le serveur. </font><font style="vertical-align: inherit;">Dans ce cas, un fournisseur de type ansible est utilis√©. </font><font style="vertical-align: inherit;">Voici le param√®tre playbook_file, qui d√©finit les r√¥les Ansible et les h√¥tes sur lesquels les r√¥les sp√©cifi√©s seront appliqu√©s. </font><font style="vertical-align: inherit;">Des options suppl√©mentaires extra_arguments sont pr√©sent√©es ci-dessous, qui, au d√©marrage d'Ansible, transmettent les versions de Kubernetes et Docker.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©paration du CROC Cloud</font></font></h3><br>
 <img src="https://habrastorage.org/webt/23/_s/uo/23_suoef0us5ia6kjgn8xteomba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de nos fichiers de configuration, nous devons faire quelques choses depuis le c√¥t√© du panneau de contr√¥le du cloud pour que toute la magie fonctionne. </font><font style="vertical-align: inherit;">Nous devons s√©lectionner une IP blanche et cr√©er un sous-r√©seau de travail, que nous utiliserons lors du d√©ploiement.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliquez sur Mettre en surbrillance l'adresse. </font><font style="vertical-align: inherit;">Packer trouvera automatiquement l'adresse IP blanche souhait√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliquez sur Cr√©er un sous-r√©seau et sp√©cifiez un sous-r√©seau et un masque. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiez l'ID de sous-r√©seau. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ins√©rez cette valeur dans le param√®tre subnet_id de la commande de d√©marrage Packer. </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/24/0w/gp/240wgpvzi8oyy6ixwzdj8cougqk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez ensuite Packer. </font><font style="vertical-align: inherit;">Il trouve l'image de la machine virtuelle d'origine, la d√©ploie dans le cloud CROC et y ex√©cute le r√¥le Ansible. </font><font style="vertical-align: inherit;">La nouvelle VM est visible dans le CROC Cloud dans la section "Instances". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/aj/ui/olajuiprqljv50bi2opn4xlqcvs.png"> <br>
 <br>
<img src="https://habrastorage.org/webt/rq/0d/ri/rq0drint5cwvddjxbd7czcyfp9a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir termin√© le travail, Packer supprime la machine virtuelle du cloud et laisse une image pr√™te √† l'emploi √† sa place, qui se trouve dans la section "Mod√®les". </font><font style="vertical-align: inherit;">L'ensemble de l'infrastructure Kubernetes sera cr√©√©e √† partir de cette image.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme mentionn√© pr√©c√©demment, le param√®tre playbook est pass√© dans les param√®tres du fournisseur Ansible. </font><font style="vertical-align: inherit;">Le fichier playbook.yml lui-m√™me ressemble √† ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">- hosts: all<font></font>
  become: true<font></font>
<font></font>
  roles:<font></font>
  | - base</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier transf√®re √† Ansible que sur tous les h√¥tes il est n√©cessaire de remplir le r√¥le de base. </font><font style="vertical-align: inherit;">S'il existe d'autres r√¥les, vous pouvez les ajouter au m√™me fichier qu'une liste. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√¥le de base vous permet d'obtenir un cluster pr√™t √† l'emploi avec une seule commande. </font><font style="vertical-align: inherit;">Le fichier main.yml montre ce que fait exactement ce r√¥le:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoute un r√©f√©rentiel Docker au mod√®le syst√®me. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoute le r√©f√©rentiel Kubernetes au mod√®le syst√®me. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installe les packages n√©cessaires. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©e un r√©pertoire pour configurer le d√©mon Docker. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure la machine en fonction du fichier de configuration daemon.json.j2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge le noyau br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inclut les options n√©cessaires pour br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprend les composants Docker et Kubelet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cute Docker dans VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cute une commande qui t√©l√©charge les images Docker n√©cessaires au fonctionnement de Kubernetes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, les packages install√©s sont d√©finis dans le fichier main.yml du r√©pertoire vars. </font><font style="vertical-align: inherit;">Dans notre cas, nous installons le package docker-ce, ainsi que les trois packages n√©cessaires au fonctionnement de Kubernetes: kubelet, kubeadm et kubectl.</font></font><br>
<br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - l'infrastructure comme code</font></font></h2><br>
<img src="https://habrastorage.org/webt/o4/um/wi/o4umwitq-qh_zpwr0thmcmejis0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform est un outil tr√®s fonctionnel de HashiCorp pour l'orchestration cloud. Il poss√®de son propre langage HCL sp√©cifique, qui est souvent utilis√© dans d'autres produits de la soci√©t√©, par exemple, dans HashiCorp Vault et Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principe de base est similaire √† tous les syst√®mes de gestion de configuration. Vous indiquez simplement l'√©tat cible dans le format souhait√© et le syst√®me calcule l'algorithme pour y parvenir. Une autre chose est que, contrairement au m√™me Ansible, qui fonctionne comme une bo√Æte noire sur les playbooks complexes, Terraform peut √©mettre un plan d'actions futures sous une forme pratique pour l'analyse. Ceci est important lors de la planification de changements d'infrastructure complexes. Apr√®s avoir planifi√© les actions n√©cessaires, ex√©cutez la commande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terraform apply</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et Terraform d√©ploiera l'infrastructure d√©crite dans les fichiers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme Packer, cet outil prend en charge AWS, GCP, Alibaba Cloud, Azure, OpenStack, VMware, etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous d√©crivons le projet</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©pertoire Terraform contient un ensemble de fichiers avec l'extension .tf. </font><font style="vertical-align: inherit;">Ces fichiers d√©crivent les composants de l'infrastructure avec lesquels nous travaillerons. </font><font style="vertical-align: inherit;">Divisez le projet en modules fonctionnels. </font><font style="vertical-align: inherit;">Une telle structure facilite le contr√¥le des versions et l'assemblage de chaque projet √† partir de blocs pratiques pr√™ts √† l'emploi. </font><font style="vertical-align: inherit;">Pour notre option, la structure suivante convient:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security_groups.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tpl</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure du fichier Main.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par le fichier main.tf, dans lequel l'acc√®s au cloud est configur√©. </font><font style="vertical-align: inherit;">En particulier, plusieurs param√®tres sont annonc√©s qui configurent Terraform pour fonctionner avec le CROC Cloud:</font></font><br>
<br>
<pre><code class="plaintext hljs">provider "aws" {<font></font>
 endpoints {<font></font>
  ec2 = "https://api.cloud.croc.ru"<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, le fichier d√©crit que Terraform doit cr√©er ind√©pendamment une cl√© priv√©e et t√©l√©charger sa partie publique sur tous les serveurs. </font><font style="vertical-align: inherit;">La cl√© priv√©e elle-m√™me est √©mise √† la fin de Terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "tls_private_key" "ssh" {<font></font>
 algorithm = "RSA"<font></font>
}<font></font>
resource "aws_key_pair" "kube" {<font></font>
 key_name = "terraform"<font></font>
 public_key = "${tls_private_key.ssh.public_key_openssh}"<font></font>
}<font></font>
output "ssh" {<font></font>
value = "${tls_private_key.ssh.private_key_pem}"<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La structure du fichier network.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce fichier d√©crit les composants r√©seau n√©cessaires pour d√©marrer la machine virtuelle:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">data "aws_availability_zones" "az" {<font></font>
 state = "available"<font></font>
}<font></font>
resource "aws_vpc" "kube" {<font></font>
 cidr_block = "${var.vpc_cidr}"<font></font>
}<font></font>
resource "aws_eip" "master" {<font></font>
 count = "1"<font></font>
 vpc = true<font></font>
}<font></font>
resource "aws_subnet" "private" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 count = "${length(data.aws_availability_zones.az.names)}"<font></font>
 cidr_block = "${var.private_subnet_cidr_list[count.index]}"<font></font>
 availability_zone = "${data.aws_availability_zones.az.names[count.index]}"<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform utilise deux types de composants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ressource - ce qui doit √™tre cr√©√©;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donn√©es - ce que vous devez obtenir.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, le param√®tre de donn√©es indique que Terraform doit recevoir les zones de disponibilit√© du cloud sp√©cifi√©, qui sont √† l'√©tat disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re ressource de param√®tre d√©crit la cr√©ation d'un cloud priv√© virtuel et le param√®tre suivant d√©crit la cr√©ation d'une adresse IP √©lastique. Pour le cluster Kubernetes, nous commandons cette adresse IP via Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans chacune des zones d'accessibilit√©, et au moment o√π CROC dispose de deux services cloud, son propre sous-r√©seau est cr√©√©. Une ressource de type aws_subnet est d√©clar√©e et l'ID de aws_vpc g√©n√©r√© est transmis dans le cadre de ce param√®tre. Mais, puisque l'ID de cette ressource est encore inconnu, nous sp√©cifions le param√®tre aws_vpc.kube.id, qui fait r√©f√©rence √† la ressource cr√©√©e et substitue la valeur du champ ID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que le nombre de sous-r√©seaux cr√©√©s est d√©termin√© par le nombre de zones de disponibilit√© du cloud et que ce nombre peut changer au fil du temps, ce param√®tre est sp√©cifi√© via la variable de longueur (data.aws_availability_zones.az.names), c'est-√†-dire la longueur de la liste des zones d'acc√®s re√ßues via le param√®tre de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux derniers param√®tres sont cidr_block (le sous-r√©seau allou√©) et la zone de disponibilit√© dans laquelle ce sous-r√©seau est cr√©√©. </font><font style="vertical-align: inherit;">Le dernier param√®tre est √©galement d√©fini via une variable qui prend une valeur dans la liste de donn√©es en fonction de l'index de la boucle d√©clar√© par </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[count.index]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure du fichier Security_groups.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les groupes de s√©curit√© sont une sorte de pare-feu pour les clouds, qui peuvent √™tre cr√©√©s non pas √† l'int√©rieur de la machine virtuelle elle-m√™me, mais par le cloud. </font><font style="vertical-align: inherit;">Dans ce cas, le pare-feu d√©crit deux r√®gles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re r√®gle cr√©e un groupe de s√©curit√© appel√© kube. </font><font style="vertical-align: inherit;">Ce groupe de s√©curit√© est n√©cessaire pour autoriser tout le trafic sortant des n≈ìuds Kubernetes, permettant aux n≈ìuds d'acc√©der librement √† Internet. </font><font style="vertical-align: inherit;">Le trafic entrant vers les n≈ìuds Kubernetes √† partir des sous-r√©seaux des n≈ìuds eux-m√™mes est √©galement autoris√©. </font><font style="vertical-align: inherit;">Ainsi, les n≈ìuds Kubernetes peuvent fonctionner entre eux sans restrictions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me r√®gle cr√©e le groupe de s√©curit√© ssh. </font><font style="vertical-align: inherit;">Il permet la connexion SSH depuis n'importe quelle adresse IP vers le port 22 de la machine virtuelle du cluster Kubernetes:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_security_group" "kube" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "kubernetes"<font></font>
 # Allow all outbound<font></font>
 egress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
 # Allow all internal<font></font>
 ingress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["${var.vpc_cidr}"]<font></font>
 }<font></font>
}<font></font>
resource "aws_security_group" "ssh" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "ssh"<font></font>
<font></font>
 # Allow all inbound<font></font>
 ingress {<font></font>
  from_port = 22<font></font>
  to_port = 22<font></font>
  protocol = "tcp"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noeud ma√Ætre. </font><font style="vertical-align: inherit;">Structure du fichier Master.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier master.tf d√©crit la cr√©ation de plusieurs mod√®les et instances. </font><font style="vertical-align: inherit;">En particulier, une instance ma√Ætre Kubernetes est en cours de cr√©ation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La variable ami d√©finit l'AMI de l'image source pour la machine virtuelle. </font><font style="vertical-align: inherit;">Ce qui suit d√©crit le type de machine virtuelle et le sous-r√©seau dans lequel elle est cr√©√©e. </font><font style="vertical-align: inherit;">Lors de la d√©finition d'un sous-r√©seau, un cycle est √† nouveau utilis√© pour cr√©er des machines virtuelles dans chaque zone de disponibilit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, les groupes de s√©curit√© utilis√©s et la cl√© sp√©cifi√©e dans le fichier main.tf sont d√©clar√©s. </font><font style="vertical-align: inherit;">Le champ user_data contient l'ex√©cution d'un ensemble de scripts cloud-init, dont les r√©sultats seront impl√©ment√©s dans la VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_instance" "master" {<font></font>
 count = "1"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"<font></font>
 disable_api_termination = false<font></font>
 instance_initiated_shutdown_behavior = "terminate"<font></font>
 source_dest_check = false<font></font>
 subnet_id = "${aws_subnet.private.*.id[count.index % length(data.aws_availability_zones.az.names)]}"<font></font>
 associate_public_ip_address = true<font></font>
 vpc_security_group_ids = [<font></font>
  "${aws_security_group.ssh.id}",<font></font>
  "${aws_security_group.kube.id}",<font></font>
 ]<font></font>
 key_name = "${aws_key_pair.kube.key_name}"<font></font>
 user_data = "${data.template_cloudinit_config.master.rendered}"<font></font>
 monitoring = "true"<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noeud ma√Ætre. </font><font style="vertical-align: inherit;">Cloud init</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud-init</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil que Canonical d√©veloppe. </font><font style="vertical-align: inherit;">Il vous permet d'ex√©cuter automatiquement dans une infrastructure cloud un certain ensemble de commandes apr√®s le d√©marrage d'une machine virtuelle. </font><font style="vertical-align: inherit;">Terraform dispose de m√©canismes pour l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int√©grer √† l'aide de mod√®les</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisqu'il est impossible de "cuire" tout ce qui est n√©cessaire dans la VM, apr√®s avoir d√©marr√©, selon son type, elle doit soit rejoindre le cluster Kubernetes soit initialiser le cluster Kubernetes. </font><font style="vertical-align: inherit;">Dans le mod√®le de fichier cloud-init appel√© master.tpl, plusieurs actions sont effectu√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Les fichiers de configuration pour Kubeadm sont enregistr√©s:</font></font><br>
<br>
<pre><code class="plaintext hljs">#cloud-config<font></font>
<font></font>
    write_files:<font></font>
    - path: etc/kubernetes/kubeadm.conf<font></font>
      owner: root:root<font></font>
      content:<font></font>
    ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Un ensemble de commandes est ex√©cut√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'adresse IP de l'assistant est √©crite dans le fichier de configuration g√©n√©r√©;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le ma√Ætre du cluster Kubernetes est initialis√© avec la commande kubeadm init;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le cluster Kubernetes, le r√©seau de calques Calico est install√© avec la commande kubectl apply.</font></font></li>
</ul><br>
 <pre><code class="plaintext hljs">runcmd:<font></font>
         - sed -i "s/CONTROL_PLANE_IP/$(curl http://169.254.169.254/latest/meta-data-local-ipv4)/g" /etc/kubernetes/kubeadm.conf<font></font>
         - kubeadm init --config /etc/kubernetes/kubeadm.conf<font></font>
         - mkdir -p $HOME/.kube<font></font>
         - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
         - sudo chown $(id -u):$(id -g) $HOME/.kube/config<font></font>
         - kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir ex√©cut√© les commandes lors du d√©marrage de la machine virtuelle, un cluster Kubernetes fonctionnel est obtenu √† partir d'un n≈ìud ma√Ætre. </font><font style="vertical-align: inherit;">Les n≈ìuds restants rejoindront ce n≈ìud ma√Ætre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noeuds ordinaires. </font><font style="vertical-align: inherit;">node.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier node.tf est similaire au fichier master.tf. </font><font style="vertical-align: inherit;">Des ressources sont √©galement cr√©√©es ici, qui dans ce cas sont appel√©es n≈ìud. </font><font style="vertical-align: inherit;">La seule diff√©rence est que le n≈ìud ma√Ætre est cr√©√© dans une seule instance, et le nombre de n≈ìuds de travail cr√©√©s est d√©fini via la variable nodes_count:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "aws_instance" "node" {<font></font>
 count = "${var.nodes_count}"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier cloud-init pour les n≈ìuds de travail ex√©cute une seule commande - kubeadm join. </font><font style="vertical-align: inherit;">Cette commande attache la machine termin√©e au cluster Kubernetes √† l'aide du jeton d'autorisation que nous envoyons.</font></font><br>
<br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lancer Terraform</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lancement, Terraform utilise plusieurs modules:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module AWS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module de mod√®le;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module TLS responsable de la g√©n√©ration des cl√©s. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces modules doivent √™tre install√©s sur la machine locale:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform init terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette commande, le r√©pertoire dans lequel se trouvent tous les fichiers n√©cessaires est indiqu√©. </font><font style="vertical-align: inherit;">Lors de l'initialisation, Terraform t√©l√©charge tous les modules sp√©cifi√©s, apr√®s quoi vous devez ex√©cuter la commande terraform plan:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform plan -var-file terraform/vars/dev.tfvars terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter qu'en plus du r√©pertoire avec les fichiers Terraform, le fichier var est indiqu√©, qui contient les valeurs des variables utilis√©es dans les fichiers Terraform. </font><font style="vertical-align: inherit;">Le r√©pertoire vars peut contenir plusieurs fichiers .tfvars, ce qui vous permet de g√©rer diff√©rents types d'infrastructures avec un seul ensemble de fichiers Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier dev.tfvars lui-m√™me contient les variables importantes suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_version (version installable de Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_ami (image AMI cr√©√©e par Packer). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir d√©fini les valeurs n√©cessaires des variables, ex√©cutez la commande terraform plan, apr√®s quoi Terraform pr√©sentera une liste d'actions n√©cessaires pour atteindre l'√©tat d√©crit dans les fichiers Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir v√©rifi√© cette liste, appliquez les modifications propos√©es: √† </font></font><br>
<br>
<code>terraform apply -auto-approve -var-file terraform/vars/dev.tfvars terraform/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
partir de la commande terraform plan, elle se distingue par la pr√©sence d'une cl√© - auto-approuver, ce qui √©limine la n√©cessit√© de confirmer les modifications apport√©es. </font><font style="vertical-align: inherit;">Vous pouvez omettre cette cl√©, mais chaque action devra ensuite √™tre confirm√©e manuellement.</font></font><br>
<br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure du cluster Kubernetes</font></font></h2><br>
<img src="https://habrastorage.org/webt/zs/i-/c3/zsi-c326-ips2acfurg_trunzhm.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cluster Kubernetes se compose d'un n≈ìud ma√Ætre qui ex√©cute des fonctions de gestion et de n≈ìuds de travail qui ex√©cutent les applications install√©es dans le cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quatre composants sont install√©s sur le n≈ìud ma√Ætre qui assurent le fonctionnement de ce syst√®me:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETCD, c'est-√†-dire la base de donn√©es Kubernetes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur API, √† travers lequel nous stockons des informations dans Kubernetes et en obtenons des informations;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaire de contr√¥leur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planificateur </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux composants suppl√©mentaires sont install√©s sur les n≈ìuds de travail:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kube-proxy (responsable de la g√©n√©ration des r√®gles de r√©seau dans le cluster Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubelet (responsable de l'envoi de la commande au d√©mon Docker pour ex√©cuter des applications dans le cluster Kubernetes). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre les n≈ìuds, le plug-in de r√©seau Calico fonctionne.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagramme de flux de travail de cluster</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oz/ew/f3/ozewf310dnhdmnx2gg4ozhzb1rc.png"><br>
,      Kubernetes    replicaset.<br>
<br>
<ol>
<li>     API-,     ETCD.        .</li>
<li>API-      .</li>
<li>Controller-manager   API-   ,    ¬´¬ª,    .</li>
<li>Scheduler       .       ETCD  API-.</li>
<li>Kubelet  API-  Docker    .</li>
<li>Docker   .</li>
<li>Kubelet   API-   ,     .</li>
</ol><br>
 ,    Kubernetes  ,      .       ,           ,     YAML-.  ,   ,    API-.       .<br>
</div></div><br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm</font></font></h2><br>
<img src="https://habrastorage.org/webt/wd/sw/cu/wdswcujzvnx4ynnrbi_ec9c1gr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dernier √©l√©ment √† mentionner est Kubeadm. </font><font style="vertical-align: inherit;">Le d√©ploiement d'un nouveau cluster Kubernetes est toujours un processus minutieux. </font><font style="vertical-align: inherit;">√Ä chaque √©tape, il existe des risques d'erreurs dues au facteur humain, et de nombreuses t√¢ches sont tout simplement tr√®s routini√®res et longues. </font><font style="vertical-align: inherit;">Par exemple, verser des certificats pour le chiffrement TLS entre les n≈ìuds et les maintenir √† jour. </font><font style="vertical-align: inherit;">C'est l√† que les utilitaires pour l'automatisation de base des mod√®les viennent √† la rescousse. </font><font style="vertical-align: inherit;">L'astuce de Kubeadm est qu'il est officiellement certifi√© pour fonctionner avec Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il vous permet de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer, configurer et ex√©cuter tous les principaux composants du cluster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g√©rer les certificats, y compris les faire pivoter et en √©crire de nouveaux;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g√©rer les versions des composants du cluster (mise √† niveau et r√©trogradation). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En m√™me temps, Kubeadm n'est pas un syst√®me de gestion de cluster Kubernetes complet, mais est une sorte de bloc de construction qui vous permet de configurer Kubernetes sur le n≈ìud sur lequel l'utilitaire Kubeadm s'ex√©cute. </font><font style="vertical-align: inherit;">Cela signifie qu'un syst√®me d'orchestration est n√©cessaire pour ex√©cuter toutes les machines virtuelles n√©cessaires, les configurer et ex√©cuter Kubeadm sur tous les n≈ìuds. </font><font style="vertical-align: inherit;">C'est √† ces fins que Terraform est utilis√©.</font></font><br>
<br>
<a name="8"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rentiel avec tous les fichiers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous mettons tous les fichiers et configurations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au m√™me endroit, afin que cela vous soit plus pratique. </font><font style="vertical-align: inherit;">Si vous n'avez pas de cloud priv√© √† port√©e de main, mais que vous souhaitez passer par toutes ces √©tapes vous-m√™me et tester le d√©ploiement dans la pratique, √©crivez-nous √† cloud@croc.ru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous vous donnerons une version de d√©monstration pour les tests et vous conseillerons sur tous les probl√®mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bient√¥t, il y aura un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveau Slurm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π vous pourrez cr√©er votre propre cluster. </font><font style="vertical-align: inherit;">Le code promo CROC a une remise de 10%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui travaillent d√©j√† avec Kubernetes, il existe un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cours avanc√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La remise est la m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chers coll√®gues, Habraparser rompt le balisage du code. </font><font style="vertical-align: inherit;">Veuillez prendre la source de GitHub √† partir du lien ci-dessus.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492600/index.html">Guide semi-scientifique pour l'h√©bergement d'un routeur WiFi</a></li>
<li><a href="../fr492604/index.html">Utilisation de View de mani√®re asynchrone √† l'aide de coroutine</a></li>
<li><a href="../fr492606/index.html">Probl√®mes li√©s √† la bo√Æte √† outils dans les grands projets</a></li>
<li><a href="../fr492608/index.html">Caract√©ristiques de livraison dans les grands projets</a></li>
<li><a href="../fr492612/index.html">Plafonnier d√©coratif Leek Celebrity</a></li>
<li><a href="../fr492628/index.html">Intervalle de confiance pour le nombre de patients atteints de coronavirus (calcul de la mortalit√©)</a></li>
<li><a href="../fr492632/index.html">Petites entreprises en quarantaine: la panique est l'ennemi de la raison</a></li>
<li><a href="../fr492636/index.html">Que signifie √™tre efficace?</a></li>
<li><a href="../fr492638/index.html">Faire √©voluer une application Redux avec des canards</a></li>
<li><a href="../fr492642/index.html">Cr√©ez une architecture √©volutive et r√©siliente avec des microservices dynamiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>