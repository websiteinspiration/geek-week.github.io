<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🏭 👨🏿‍🔬 🧔🏼 失敗したスクロールバー 🔶 🏮 🐃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近、Windowsターミナルの新しいバージョンをリリースしました。すべてうまくいきますが、スクロールバーのパフォーマンスはまだ十分とは言えませんでした。したがって、彼に小さな棒を突き刺してタンバリンを演奏する時が来ました。
 
 ユーザーは通常、新しいバージョンのアプリケーションで何をしますか？そ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>失敗したスクロールバー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、Windowsターミナルの新しいバージョンをリリースしました。</font><font style="vertical-align: inherit;">すべてうまくいきますが、スクロールバーのパフォーマンスはまだ十分とは言えませんでした。</font><font style="vertical-align: inherit;">したがって、彼に小さな棒を突き刺してタンバリンを演奏する時が来ました。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーは通常、新しいバージョンのアプリケーションで何をしますか？</font><font style="vertical-align: inherit;">そうです、テスターがやらなかったことは正確です。</font><font style="vertical-align: inherit;">そのため、意図した目的のために端末を短時間使用した後、私はそれを使ってひどいことを始めました。</font><font style="vertical-align: inherit;">よし、よし、キーボードにコーヒーをこぼしただけで、ワイプするときに誤って&lt;Enter&gt;を押し込んだ。</font><font style="vertical-align: inherit;">最後に何が起こったのか？</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、あまり印象的ではありませんが、急いで石を投げつけないでください。</font><font style="vertical-align: inherit;">右側に注意してください。</font><font style="vertical-align: inherit;">最初に彼女の何が悪いのかを理解してみてください。</font><font style="vertical-align: inherit;">ヒントのスクリーンショットは次のとおりです。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、記事のタイトルは深刻なネタバレでした。 :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、スクロールバーに問題があります。下の境界線を越えた後、何度も新しい行に移動すると、通常はスクロールバーが表示されるはずであり、上にスクロールできます。ただし、これは、何かの出力を使用してコマンドを記述するまで発生しません。ただ奇妙な行動だとしましょう。しかし、スクロールバーが機能していれば、これはそれほど重要ではなかったかもしれません... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少しテストしたところ、新しい行に切り替えてもバッファーは増えません。これはコマンドの出力のみを行います。したがって、上記の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はバッファを1行だけ増やします。このため、時間の経過とともに、特に</font><i><font style="vertical-align: inherit;">クリア</font></i><font style="vertical-align: inherit;">後に多くの履歴が失われ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に頭に浮かんだのは、アナライザーを使用して、その内容を確認することでした。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、結論は印象的なサイズなので、フィルタリングの力を利用して、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を含むものを除いてすべてをトリミングし</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たくさんのメッセージがあるとは言えませんが…さて、それではバッファに関連する何かがあるのでしょうか？</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーは失敗せず、興味深いものが見つかりました。</font><font style="vertical-align: inherit;">上記の警告を強調しました。</font><font style="vertical-align: inherit;">そこで何が悪いのか見てみましょう：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">「-」演算子の左側と右側に同じサブ式があります：bufferHeight-bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ScrollViewerの高さと、スクロールの高さを偽るために使用しているグリッドを設定する」</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というコメントが付い</font><i><font style="vertical-align: inherit;">ています。</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、スクロールの高さをシミュレートすることは良いことですが、なぜ最大で0を設定するのですか？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">目を向ける</font><font style="vertical-align: inherit;">と、コードはあまり疑わしいものではないことが明らかになりました。</font><font style="vertical-align: inherit;">誤解しないでください。変数自体を減算することはもちろん疑わしいことですが、出力にはゼロが表示されるので、害はありません。</font><font style="vertical-align: inherit;">いずれの場合も、</font><font style="vertical-align: inherit;">[ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドに</font><font style="vertical-align: inherit;">デフォルト値（1）</font><font style="vertical-align: inherit;">を指定しようとしました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクロールバーが表示されましたが、機能しません：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どちらかと言えば、&lt;Enter&gt;を30秒間クランプしました。明らかにこれは問題ではないので、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を0に</font><font style="vertical-align: inherit;">置き換える以外は、そのままにして</font><i><font style="vertical-align: inherit;">おき</font></i><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、問題の解決に特に近づいているわけではありません。デバッグに行くより良いオファーがない場合。最初は変更された行にブレークポイントを設定できましたが、それが何らかの形で役立つとは思えません。したがって、最初に、バッファーに対するビューポートのオフセットを担当するフラグメントを見つける必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカル（そしておそらく他の）スクロールバーの動作について少し。すべての出力を格納する1つの大きなバッファーがあります。それと対話するために、ある種の抽象化を使用して画面に描画します（この場合は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これら2つのプリミティブを使用すると、問題が何であるかを理解できます。新しい行に移動してもバッファは増えません。そのため、どこに行くにも足りません。したがって、問題はそれにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この当たり前の知識を武器に、私たちは英雄的なデバッグを続けます。</font><font style="vertical-align: inherit;">関数を少し歩き回った後、私はこのフラグメントに注目を集めました：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を構成した後</font><font style="vertical-align: inherit;">、さまざまなコールバック関数を構成</font><font style="vertical-align: inherit;">し、新しく作成したウィンドウに対して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">実行し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">その後、上記のラムダが呼び出されます。</font><font style="vertical-align: inherit;">バッファに何かを書き込むのは今回が初めてなので、デバッグをそこから開始することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラムダ内にブレークポイントを設定し、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を調べます</font><font style="vertical-align: inherit;">。</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、非常に重要な2つの変数、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewportができました</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。それらにブレークポイントを設定し、それらがどこで変化するかを見つけます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">確か</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">_viewport</font></i><font style="vertical-align: inherit;">を使用し</font><i><font style="vertical-align: inherit;">て</font></i><font style="vertical-align: inherit;">少し</font><i><font style="vertical-align: inherit;">ごまかし</font></i><font style="vertical-align: inherit;">て、変数自体ではなく</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トップ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドにブレークポイントを設定します</font><font style="vertical-align: inherit;">（必要なのはそれだけです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;F5&gt;をクリックすると、何も起こりません...さて、数十回&lt;Enter&gt;を押してみましょう。何も起こらなかった。どうやら、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に無謀にブレークポイントを設定しすぎた</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、予想どおり</font><i><font style="vertical-align: inherit;">_viewport</font></i><font style="vertical-align: inherit;">がバッファーの上部に残り、サイズは増加しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、コマンドを入力して頂点を更新することは理にかなっています。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その後、非常に興味深いコードを作成しました。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちがやめたところコメントを指摘しました。</font><font style="vertical-align: inherit;">フラグメントの解説を見ると、これまで以上に解決策に近いことがわかります。</font><font style="vertical-align: inherit;">表示されている部分がバッファに対してシフトされているのはこの場所であり、スクロールする機会を得ます。</font><font style="vertical-align: inherit;">動作を少し観察したところ、興味深い点に気づきました。新しい行に移動すると、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">の値は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の値と等しいため、</font><font style="vertical-align: inherit;">省略せず、何も機能しません。</font><font style="vertical-align: inherit;">また、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数にも同様の問題があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の値を</font><font style="vertical-align: inherit;">1 </font><font style="vertical-align: inherit;">増やして、</font><font style="vertical-align: inherit;">何が起こったかを見て</font><font style="vertical-align: inherit;">みましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして打ち上げの結果：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驚異！</font><font style="vertical-align: inherit;">数量を入力するとスクロールバーが動作します。</font><font style="vertical-align: inherit;">確かに、私たちが何かを紹介する瞬間まで...ファイルを示すために、gifを添付します。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやら、私たちは新しい行にいくつかの余分なジャンプを行っています。</font><font style="vertical-align: inherit;">次に、X座標を使用して遷移を制限してみましょう</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が0の</font><font style="vertical-align: inherit;">場合にのみラインをシフトし</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のフラグメント</font><font style="vertical-align: inherit;">は、カーソルの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">座標</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">シフト</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">次に、カーソル位置を更新します。</font><font style="vertical-align: inherit;">理論的には、これはうまくいくはずです...何が起こりましたか？</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、もちろん、より良いです。</font><font style="vertical-align: inherit;">ただし、出力点はシフトするがバッファはシフトしないという問題があります。</font><font style="vertical-align: inherit;">したがって、同じコマンドの2つの呼び出しが表示されます。</font><font style="vertical-align: inherit;">もちろん、自分のしていることはわかっているように見えるかもしれませんが、そうではありません。</font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、バッファの内容を確認することにしたので、デバッグを開始した時点に戻りました。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前回と同じ場所にブレークポイントを設定して、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数の内容を見始めました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">画面に表示されたものから始めましょう。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;Enter&gt;を押すと</font><font style="vertical-align: inherit;">
、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列はどうなると思います</font><font style="vertical-align: inherit;">か？</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LONG DESCRIPTION"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在表示されているバッファ全体。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファ全体ですが、最初の行はありません。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファ全体を失うわけではありませんが、最初の行はありません。</font><font style="vertical-align: inherit;">そして、これはかなりの問題です。なぜなら、私たちが歴史を失っているのはまさにこのためであり、さらに、点的にです。</font><font style="vertical-align: inherit;">これは</font><font style="vertical-align: inherit;">、新しい行に移動した後の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘルプ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力フラグメントの外観です</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
矢印で</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「LONG DESCRIPTOIN」があっ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た場所をマークしました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">多分それから1行のオフセットでバッファを上書きしますか？</font><font style="vertical-align: inherit;">これは、このコールバックがすべてのくしゃみに対して呼び出されなかった場合に機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それが呼ばれたとき、私は少なくとも3つの状況を発見しました、</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何か文字を入力すると・・・</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史をたどると、</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを実行するとき。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、コマンドを実行するとき、または&lt;Enter&gt;を入力するときにのみ、バッファーを移動する必要があることです。</font><font style="vertical-align: inherit;">他の場合では、これを行うことは悪い考えです。</font><font style="vertical-align: inherit;">そのため、何をシフトする必要があるのか​​を何らかの形で判断する必要があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="画像18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事は、PVS-Studioが私が気付いたエラーの原因となっている欠陥のあるコードをいかに巧みに発見できたかを示すための試みでした。</font><font style="vertical-align: inherit;">それ自体から変数を差し引くというトピックに関するメッセージは私に強い動機を与え、私は力強くテキストを書き始めました。</font><font style="vertical-align: inherit;">しかし、ご覧のとおり、私の喜びは時期尚早であり、すべてがはるかに複雑であることが判明しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから私はやめることにしました。</font><font style="vertical-align: inherit;">まだ2、3夜を過ごすこともできますが、私がこれを長時間実行すると、ますます問題が発生しました。</font><font style="vertical-align: inherit;">私ができることは、Windowsターミナルの開発者がこのバグを修正できるように願っています。</font><font style="vertical-align: inherit;">:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読者が研究を終えていないことに失望しなかったこと、そしてプロジェクトの内部を散歩するのが面白かったことを願っています。対価として、＃WindowsTerminalプロモーションコードを使用することをお勧めします。これにより、PVS-Studioのデモバージョンを1週間ではなく、1か月間すぐに受け取ることができます。 PVS-Studioスタティックアナライザーを実際に試したことがない場合は、これがまさにその理由です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロードページの[</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージ]フィールドに「#WindowsTerminal」と入力するだけ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、この機会を利用して、LinuxおよびmacOSで動作するバージョンのC＃アナライザーがまもなくリリースされることをお知らせします。そして今、あなたは予備テストにサインアップすることができます。</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事を英語を話す視聴者と共有したい場合は、翻訳へのリンク：Maxim Zvyagintsevを使用してください。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できなかった小さなスクロールバー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja493026/index.html">製品のテスト：カナリアデプロイメント</a></li>
<li><a href="../ja493032/index.html">5. Check Point Maestroのよくある質問（FAQ）</a></li>
<li><a href="../ja493034/index.html">COVID-19：コロナウイルス患者数の予測</a></li>
<li><a href="../ja493036/index.html">ツイストツイスト、混乱させたい：2層グラフェンの操作</a></li>
<li><a href="../ja493038/index.html">分散型チームの企業文化についてだけでなく、</a></li>
<li><a href="../ja493042/index.html">オンライン広告およびマーケティングの市場オーディエンスデータセグメント。部。1.法律の変更</a></li>
<li><a href="../ja493046/index.html">カフェのオープンを計画する方法、または施設をオープンするための独自のプランナーを書く方法</a></li>
<li><a href="../ja493050/index.html">検索は見つけるものではありません</a></li>
<li><a href="../ja493052/index.html">問題</a></li>
<li><a href="../ja493056/index.html">チェックリスト：従業員をウダレンカに送って従業員を失わないようにする方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>