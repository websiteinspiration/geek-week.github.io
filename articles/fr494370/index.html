<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🎨 🛣️ 🐰 Une architecture propre vue par un développeur Python 👰🏻 🤷🏿 👨‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Je m'appelle Eugene, je suis développeur Python. Au cours de la dernière année et demie, notre équipe a commencé à appliquer activement les pri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Une architecture propre vue par un développeur Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/494370/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! Je m'appelle Eugene, je suis développeur Python. Au cours de la dernière année et demie, notre équipe a commencé à appliquer activement les principes de l'architecture propre, en s'éloignant du modèle MVC classique. Et aujourd'hui, je parlerai de la façon dont nous en sommes arrivés là, de ce que cela nous donne et pourquoi le transfert direct d'approches d'autres PL n'est pas toujours une bonne solution.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t_/hs/tl/t_hstlzmkevavrg4y8tazjdfu4c.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python est mon principal outil de développement depuis plus de sept ans maintenant. Quand ils me demandent ce que j'aime le plus chez lui, je réponds que c'est son </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellente lisibilité</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La première connaissance a commencé par la lecture du livre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Programmer un esprit collectif»</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Je m'intéressais aux algorithmes qui y sont décrits, mais tous les exemples étaient dans un langage qui ne m'était pas encore familier à l'époque. Ce n'était pas habituel (Python n'était pas encore courant dans l'apprentissage automatique), les listes étaient souvent écrites en pseudo-code ou en utilisant des diagrammes. Mais après une brève introduction à la langue, j'ai apprécié sa concision: tout était </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">facile et clair, rien de superflu et de distrayant, seulement l'essence même du processus décrit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le principal mérite de cela est la conception étonnante de la langue, le sucre syntaxique très intuitif. </font><font style="vertical-align: inherit;">Cette expressivité a toujours été appréciée dans la communauté. </font><font style="vertical-align: inherit;">Qu'est-ce que « </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importer ça</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> », nécessairement présent sur les premières pages de tout manuel: il ressemble à un surveillant invisible, évalue constamment vos actions. </font><font style="vertical-align: inherit;">Sur les forums, il valait la peine pour un débutant d'utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CamelCase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le nom de la variable dans la liste, donc immédiatement l'angle de discussion s'est déplacé vers l'idiome du code proposé avec des références à PEP8.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La poursuite de l'élégance et le dynamisme puissant du langage ont créé de nombreuses bibliothèques avec une API vraiment délicieuse.&nbsp;</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Néanmoins, Python, bien que puissant, n'est qu'un outil qui vous permet d'écrire du code expressif et auto-documenté, mais il </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne garantit pas cela</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pas plus que la conformité PEP8. </font><font style="vertical-align: inherit;">Lorsque notre boutique en ligne apparemment simple sur Django commence à gagner de l'argent et, par conséquent, à augmenter les fonctionnalités, à un moment donné, nous réalisons que ce n'est pas si simple, et même effectuer des changements de base nécessite de plus en plus d'efforts, et plus important encore, cette tendance </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'accentue. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que s'est-il passé et quand tout s'est mal passé?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mauvais code</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mauvais code n'est pas celui qui ne suit pas PEP8 ou ne répond pas aux exigences de complexité cyclomatique. </font><font style="vertical-align: inherit;">Un mauvais code est, tout d'abord, des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dépendances incontrôlées</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ce qui conduit au fait qu'un changement à un endroit du programme entraîne des changements imprévisibles dans d'autres parties. </font><font style="vertical-align: inherit;">Nous perdons le contrôle du code; l'extension des fonctionnalités nécessite une étude détaillée du projet. </font><font style="vertical-align: inherit;">Un tel code perd de sa souplesse et, pour ainsi dire, résiste aux changements, tandis que le programme lui-même devient «fragile».&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture épurée</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'architecture choisie de l'application devrait éviter ce problème, et nous ne sommes pas les premiers à le rencontrer: il y a eu une discussion au sein de la communauté Java sur la création d'une conception d'application optimale depuis longtemps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2000, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robert Martin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (également connu sous le nom d'Oncle Bob) dans son article « </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Principles of Design and Design</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » a réuni cinq principes pour la conception d'applications OOP sous l'acronyme mémorable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOLID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ces principes ont été bien reçus par la communauté et vont bien au-delà de l'écosystème Java. Néanmoins, ils sont de nature très abstraite. Plus tard, il y a eu plusieurs tentatives pour développer une conception d'application générale basée sur les principes SOLID. Ceux-ci incluent: «Architecture hexagonale», «Ports et adaptateurs», «Architecture bulbeuse» et ils ont tous beaucoup en commun, bien que différents détails de mise en œuvre. Et en 2012, un article a été publié par le même Robert Martin, où il a proposé sa propre version intitulée « </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture propre</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ». </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c32/3a9/769/c323a9769c90f4e28a17e1d5c05ab160.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon Uncle Bob, l'architecture est avant tout « </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frontières et barrières</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> », il faut bien comprendre les besoins et limiter les interfaces logicielles afin de ne pas perdre le contrôle de l'application. Pour ce faire, le programme </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est divisé en couches</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En passant d'une couche à une autre, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seules les données</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent être transférées </font><font style="vertical-align: inherit;">(les structures simples et les </font><font style="vertical-align: inherit;">objets </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent agir comme des données </font><font style="vertical-align: inherit;">) - c'est la règle des limites. </font><font style="vertical-align: inherit;">Une autre phrase la plus fréquemment citée selon laquelle «l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application devrait crier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » signifie que l'élément principal de l'application n'est pas le cadre utilisé ou la technologie de stockage de données, mais ce que cette application fait réellement, quelle fonction elle remplit - la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logique métier de l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application . </font><font style="vertical-align: inherit;">Par conséquent, les couches n'ont pas de structure linéaire, mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont une hiérarchie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">D'où deux règles supplémentaires:</font></font><br>
 <br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La règle de priorité pour la couche intérieure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est la couche intérieure qui détermine l'interface par laquelle elle interagira avec le monde extérieur;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règle de dépendance</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Les dépendances doivent être dirigées de la couche intérieure vers l'extérieur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière règle est assez atypique dans le monde Python. </font><font style="vertical-align: inherit;">Pour appliquer un scénario de logique métier complexe, vous devez toujours accéder à des services externes (par exemple, une base de données), mais pour éviter cette dépendance, la couche de logique métier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doit elle-même déclarer l'interface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par laquelle elle interagira avec le monde extérieur. </font><font style="vertical-align: inherit;">Cette technique est appelée « </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inversion de dépendance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » (la lettre D dans SOLID) et est largement utilisée dans les langages à typage statique. </font><font style="vertical-align: inherit;">Selon Robert Martin, c'est le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal avantage de la POO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces trois règles sont l'essence même de l'architecture propre:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règle de passage des frontières;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règle de dépendance;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La règle de priorité de la couche intérieure.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les avantages de cette approche comprennent:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facilité de test</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les couches sont isolées, respectivement, elles peuvent être testées sans patch de singe, vous pouvez définir granulairement le revêtement pour différentes couches, selon le degré de leur importance;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facilité de modification des règles métier</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car toutes sont collectées en un seul endroit, ne sont pas réparties sur le projet et ne sont pas mélangées avec du code de bas niveau;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indépendance vis-à-vis des agents externes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la présence d'abstractions entre la logique métier et le monde extérieur permet dans certains cas de changer de sources externes sans affecter les couches internes. </font><font style="vertical-align: inherit;">Cela fonctionne si vous n'avez pas lié la logique métier aux fonctionnalités spécifiques des agents externes, par exemple, les transactions de base de données;</font></font></li>
<li><b> </b>,   ,     ,      .</li>
</ul><br>
<blockquote>     ,    .           .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.     «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> Clean Architecture</a>».<br>
</blockquote><br>
<h2>  Python</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une théorie, des exemples d'application pratique peuvent être trouvés dans l'article original, les rapports et le livre de Robert Martin. Ils s'appuient sur plusieurs modèles de conception courants du monde Java: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adaptateur, passerelle, interacteur, Fasade, référentiel, DTO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, qu'en est-il de Python? Comme je l'ai dit, le laconicisme est valorisé dans la communauté Python, ce qui a pris racine chez les autres est loin d'être ancré chez nous. La première fois que j'ai abordé ce sujet il y a trois ans, il n'y avait pas beaucoup de documents sur le thème de l'utilisation de l'architecture propre en Python, mais le premier lien dans Google était </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le projet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leonardo Giordani: l'auteur décrit en détail le processus de création d'une API pour un site de recherche de propriété en utilisant la méthode TDD, appliquer une architecture propre.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, malgré l'explication scrupuleuse et en suivant tous les canons de l'oncle Bob, cet exemple est plutôt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effrayant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'API du projet consiste en une méthode: obtenir une liste avec un filtre disponible. Je pense que même pour un développeur novice, le code d'un tel projet ne prendra pas plus de 15 lignes. Mais dans ce cas, il a pris six paquets. Vous pouvez vous référer à une mise en page pas entièrement réussie, et c'est vrai, mais en tout cas, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il est difficile pour quelqu'un d'expliquer l'efficacité de cette approche</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en se référant à ce projet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un problème plus grave, si vous ne lisez pas l'article et que vous commencez immédiatement à étudier le projet, il est assez difficile à comprendre. Considérez la mise en œuvre de la logique métier:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> rentomatic.response_objects <span class="hljs-keyword">import</span> response_objects <span class="hljs-keyword">as</span> res<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomListUseCase</span>(<span class="hljs-params">object</span>):</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, repo</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.repo = repo<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, request_object</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request_object:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseFailure.build_from_invalid_request_object(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request_object)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rooms = self.repo.list(filters=request_object.filters)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseSuccess(rooms)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseFailure.build_system_error(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"{}: {}"</span>.format(exc.__class__.__name__, <span class="hljs-string">"{}"</span>.format(exc)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe RoomListUseCase qui implémente la logique métier (pas très similaire à la logique métier, non?) Du projet est initialisé par l'objet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mais qu'est-ce qu'un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Bien sûr, du contexte, on peut comprendre que les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prises en </font><font style="vertical-align: inherit;">pension</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> met en </font><font style="vertical-align: inherit;">œuvre le modèle du </font><font style="vertical-align: inherit;">référentiel pour accéder aux </font><font style="vertical-align: inherit;">données, si nous regardons le corps de RoomListUseCase, nous comprenons qu'il doit avoir une méthode de liste, dont </font><font style="vertical-align: inherit;">l'entrée est une liste de filtres, ce </font><font style="vertical-align: inherit;">qui est clair à la sortie, vous devez regarder dans ResponseSuccess. Et si le scénario est plus complexe, avec plusieurs accès à la source de données? Il s'avère que vous comprenez ce qu'est le dépôt, vous ne pouvez vous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">référer qu'à la mise en œuvre</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais où est-elle située? Il se trouve dans un module séparé, qui n'est en aucun cas associé à RoomListUseCase. Ainsi, pour comprendre ce qui se passe, vous devez remonter au niveau supérieur (le niveau du framework) et voir ce qui alimente l'entrée de la classe lors de la création de l'objet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pourriez penser que j'énumère les inconvénients de la frappe dynamique, mais ce n'est pas entièrement vrai. C'est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un typage dynamique qui vous permet d'écrire du code expressif et compact</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'analogie avec les microservices vient à l'esprit, lorsque nous découpons un monolithe en microservices, la conception prend une rigidité supplémentaire, car tout peut être fait à l'intérieur du microservice (PL, frameworks, architecture), mais il doit respecter l'interface déclarée. Alors ici: quand nous avons divisé notre projet en couches,</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les relations entre les couches doivent être cohérentes avec le contrat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tandis qu'à l'intérieur de la couche, le contrat est facultatif. Sinon, vous devez garder un contexte assez large dans votre tête. Rappelez-vous, j'ai dit que le problème avec le mauvais code était les dépendances, et donc, sans interface explicite, nous glissons à nouveau là où nous voulions nous éloigner - à l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absence de relations de cause à effet explicites</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote>    <i>repo</i>     RoomListUseCase,    execute — <b>   </b>.       -    ,   ,     .     -        . ,   ,    ,  <i>repo</i>   .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, à cette époque, j'ai abandonné l'architecture propre dans un nouveau projet, en appliquant à nouveau le MVC classique. Mais, après avoir rempli le prochain lot de cônes, il est revenu sur cette idée un an plus tard, quand, enfin, nous avons commencé à lancer des services en Python 3.5+. Comme vous le savez, il a apporté </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des annotations de type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des classes de données</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Deux puissants outils de description d'interface. Sur la base de ceux-ci, j'ai esquissé un prototype du service, et le résultat était déjà bien meilleur: les couches ont cessé de s'effriter, malgré le fait qu'il y avait encore beaucoup de code, surtout lors de l'intégration avec le framework. Mais cela a suffi pour commencer à appliquer cette approche dans les petits projets. Peu à peu, des cadres ont commencé à apparaître qui se concentraient sur l'utilisation maximale des annotations de type: apistar (maintenant starlette), fondu. Le bundle pydantic / FastAPI est maintenant courant et l'intégration avec de tels frameworks est devenue beaucoup plus facile. Voici à quoi ressemblerait l'exemple ci-dessus de restomatic / services.py:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, List
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span>(<span class="hljs-params">BaseModel</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;code: str<font></font>
&nbsp;&nbsp;&nbsp;size: int<font></font>
&nbsp;&nbsp;&nbsp;price: int<font></font>
&nbsp;&nbsp;&nbsp;latitude: float<font></font>
&nbsp;&nbsp;&nbsp;longitude: float<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomFilter</span>(<span class="hljs-params">BaseModel</span>):</span>
&nbsp;&nbsp;&nbsp;code: Optional[str] = <span class="hljs-literal">None</span>
&nbsp;&nbsp;&nbsp;price_min: Optional[int] = <span class="hljs-literal">None</span>
&nbsp;&nbsp;&nbsp;price_max: Optional[int] = <span class="hljs-literal">None</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomStorage</span>:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_rooms</span>(<span class="hljs-params">self, filters: RoomFilter</span>) -&gt; List[Room]:</span> ...<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomListUseCase</span>:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, repo: RoomStorage</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.repo = repo<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_rooms</span>(<span class="hljs-params">self, filters: RoomFilter</span>) -&gt; List[Room]:</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rooms = self.repo.get_rooms(filters=filters)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> rooms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RoomListUseCase - une classe qui implémente la logique métier du projet. Vous ne devez pas faire attention au fait que tout ce que fait la méthode show_rooms est d'appeler RoomStorage (je n'ai pas trouvé cet exemple). Dans la vie réelle, il peut également y avoir un calcul de remise, un classement d'une liste basée sur des publicités, etc. Cependant, le module est autosuffisant. Si nous voulons utiliser ce scénario dans un autre projet, nous devrons implémenter RoomStorage. Et ce qui est nécessaire pour cela est clairement visible depuis le module. Contrairement à l'exemple précédent, une telle couche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est autosuffisante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et, lors d'une modification, il n'est pas nécessaire de garder à l'esprit tout le contexte. A partir de dépendances non systémiques uniquement pydantiques, eh bien, cela deviendra clair dans le plug-in du framework. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de dépendances</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, une autre façon d'améliorer la lisibilité du code, et non un contexte supplémentaire, même un développeur novice pourra comprendre ce que fait ce module. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un scénario de logique métier ne doit pas nécessairement être une classe; voici un exemple d'un scénario similaire sous la forme d'une fonction:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rool_list_use_case</span>(<span class="hljs-params">filters: RoomFilter, repo: RoomStorage</span>) -&gt; List[Room]:</span><font></font>
&nbsp;&nbsp;&nbsp;rooms = repo.get_rooms(filters=filters)<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> rooms</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le lien avec le framework:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Depends
<span class="hljs-keyword">from</span> rentomatic <span class="hljs-keyword">import</span> services, adapters<font></font>
app = FastAPI()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_use_case</span>() -&gt; services.RoomListUseCase:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> services.RoomListUseCase(adapters.MemoryStorage())<font></font>
<font></font>
<span class="hljs-meta">@app.post("/rooms", response_model=List[services.Room])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rooms</span>(<span class="hljs-params">filters: services.RoomFilter, use_case=Depends(<span class="hljs-params">get_use_case</span>)</span>):</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> use_case.show_rooms(filters)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'aide de la fonction get_use_case, FastAPI implémente le modèle d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">injection de dépendance</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous n'avons pas à nous soucier de la sérialisation des données, tout le travail est effectué par FastAPI en collaboration avec pydantic. Malheureusement, les </font><font style="vertical-align: inherit;">données ne sont pas toujours format logique métier adapté à la </font><font style="vertical-align: inherit;">diffusion en </font><font style="vertical-align: inherit;">direct dans le restaurant &lt;et, au contraire, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la logique métier ne sait pas où les données se sont - avec des </font><font style="vertical-align: inherit;">barres obliques, corps de la </font><font style="vertical-align: inherit;">demande, les </font><font style="vertical-align: inherit;">cookies, etc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans ce cas, le corps de la fonction room aura une certaine conversion des données d'entrée et de sortie, mais dans la plupart des cas, si nous travaillons avec l'API, une telle fonction proxy simple suffit.&nbsp;</font></font><br>
<br>
<blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>   , ,    ,    RoomStorage.  ,     15 ,     ,      ,         .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas intentionnellement séparé la couche de la logique métier, comme le suggère le modèle canonique de l'architecture propre. </font><font style="vertical-align: inherit;">La classe Room était censée se trouver dans la couche de région de domaine d'entité représentant la région de domaine, mais pour cet exemple, cela n'est pas nécessaire. </font><font style="vertical-align: inherit;">En combinant les couches Entity et UseCase, le projet ne cesse pas d'être une implémentation de Clean Architecture. </font><font style="vertical-align: inherit;">Robert Martin lui-même a déclaré à plusieurs reprises que le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de couches peut varier à la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fois vers le haut et vers le bas. </font><font style="vertical-align: inherit;">Dans le même temps, le projet répond aux principaux critères de l'architecture propre:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règle du</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> franchissement des frontières: les modèles pydantiques, qui sont essentiellement des DTO, </font><b><font style="vertical-align: inherit;">traversent les frontières</font></b><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règle de dépendance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la couche de logique métier est indépendante des autres couches;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La règle de priorité pour la couche interne</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : c'est la couche de logique métier qui définit l'interface (RoomStorage), à ​​travers laquelle la logique métier interagit avec le monde extérieur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, plusieurs projets de notre équipe, mis en œuvre selon l'approche décrite, travaillent sur la prod. </font><font style="vertical-align: inherit;">J'essaie d'organiser même les plus petits services de cette façon. </font><font style="vertical-align: inherit;">Il s'entraîne bien - des questions auxquelles je n'avais pas pensé avant de se poser. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, quelle est la logique métier ici? </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est loin d'être toujours évident, par exemple, si vous écrivez une sorte de proxy. </font><font style="vertical-align: inherit;">Un autre point important est d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apprendre à penser différemment.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lorsque nous obtenons une tâche, nous commençons généralement à penser aux cadres, aux services utilisés, à savoir s'il y aura un besoin d'une file d'attente où il est préférable de stocker ces données, qui peuvent être mises en cache. Dans l'approche dictant l'architecture propre, nous devons d'abord mettre en œuvre la logique métier et ensuite passer à la mise en œuvre de l'interaction avec l'infrastructure, car, selon Robert Martin, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tâche principale de l'architecture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de retarder le moment où la connexion avec tout La couche infrastructure fera partie intégrante de votre application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, je vois une perspective favorable à l'utilisation d'une architecture propre en Python. </font><font style="vertical-align: inherit;">Mais la forme sera très probablement très différente de la façon dont elle est acceptée dans d'autres PL. </font><font style="vertical-align: inherit;">Au cours des dernières années, j'ai vu une augmentation significative de l'intérêt pour le sujet de l'architecture dans la communauté. </font><font style="vertical-align: inherit;">Ainsi, lors du dernier PyCon, il y avait plusieurs rapports sur l'utilisation du DDD, et les gars des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laboratoires secs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devraient être notés séparément </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans notre entreprise, de nombreuses équipes mettent déjà en œuvre l'approche décrite à un degré ou à un autre. </font><font style="vertical-align: inherit;">Nous faisons tous la même chose, nous avons grandi, nos projets ont grandi, la communauté Python doit travailler avec cela, définir le style commun et le langage qui, par exemple, est devenu une fois pour tout Django.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494350/index.html">Sommaire des événements en ligne de mars et avril</a></li>
<li><a href="../fr494354/index.html">Connaissance et condition</a></li>
<li><a href="../fr494356/index.html">Tutoriel Linux Newbie Aircrack-ng</a></li>
<li><a href="../fr494364/index.html">GDPR: Consentement au traitement des données personnelles</a></li>
<li><a href="../fr494366/index.html">Mitaps en ligne pour toute la semaine, à partir du 27 mars (pour le dos, mobile, QA, PM et tout)</a></li>
<li><a href="../fr494372/index.html">Logiciel de vérification panrusse - une vue intérieure</a></li>
<li><a href="../fr494374/index.html">Bus électriques et leurs batteries: qu'est-ce que le titanate de lithium? (Partie 1)</a></li>
<li><a href="../fr494376/index.html">Tampon de profondeur hiérarchique</a></li>
<li><a href="../fr494380/index.html">Introduction à la gestion stratégique des produits</a></li>
<li><a href="../fr494384/index.html">Enquête fonctionnelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>