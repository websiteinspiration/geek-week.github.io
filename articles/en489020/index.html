<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèº ‚ùï üññüèª The study of one malicious ü¶à üèÜ üéä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I came across a recently malicious doc file that was sent with phishing emails. I decided that this is a good reason to practice reverse engineering a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The study of one malicious</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I came across a recently malicious doc file that was sent with phishing emails. </font><font style="vertical-align: inherit;">I decided that this is a good reason to practice reverse engineering and write something new on Habr. </font><font style="vertical-align: inherit;">Under the cat - an example of parsing a malicious macro dropper and no less malicious dlls.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sha256 from the file - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb052d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the doc file itself, on the first page there is a picture informing that this file is protected and explaining how to enable macros; there are two large tables with numbers in the file. Numbers are written in decimal form, the longest are ten-digit, there are both positive and negative. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the victim allows the execution of macros (there are those who have it enabled by default?), A chain of actions is launched, which ultimately performs the </font><i><font style="vertical-align: inherit;">updatedb_network</font></i><font style="vertical-align: inherit;"> function</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which changes the current directory to a temporary one and creates the file "icutils.dll" in it, in which it writes down the numbers from the first table in a row as 32 bit integer with a sign. </font><font style="vertical-align: inherit;">The result is the correct dll. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is imported from this dll </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And it starts with two parameters:</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call </font><font style="vertical-align: inherit;">returns False, the icutils.dll file is overwritten with data from the second table and clone is called again with the same parameters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking ahead, I‚Äôll say that the first dll is 64 bit and will not run on 32 bit systems. </font><font style="vertical-align: inherit;">Thus, the macro selects the correct binary code architecture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">has a piece of code that has no functional purpose:</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps he is here to give the appearance of useful work for those who quickly scroll through the code, see some lines in SQL and think that everything is OK? </font><font style="vertical-align: inherit;">I do not know. </font><font style="vertical-align: inherit;">Also, most functions and variables have random or non-real-name names (such as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which does not interact with the database or network). </font><font style="vertical-align: inherit;">Although there is, for example, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, which stores 4 bytes in icutil.dll. </font><font style="vertical-align: inherit;">But in any case, the presence of the </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function should immediately alert </font><font style="vertical-align: inherit;">, authors of the malware cannot arbitrarily rename it (though they can use another automatically launched function instead). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the macro functionality is more or less clear, it's time to unload the dll and proceed to their analysis.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 64 bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The list of imported functions contains the functions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (program start), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (creating a thread in </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">another</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (allocating a block of memory in </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">another</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (writing to the memory of </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">another</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process), which immediately suggests the injection of code into another process. Now let's see what exactly she does using IDA Free and Ghidra.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main entry point simply returns 1, does nothing else. The second exported function is clone, which is called by the macro and contains malicious code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The parameters with which it is called do not seem to affect anything. The application decrypts two data blocks. The first 0x78 data block with the following contents (already decrypted):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second data block is 0x1D4C long and contains executable code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, a pointer to the kernel32 module, the result of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () function, and the address of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () </font><font style="vertical-align: inherit;">function </font><font style="vertical-align: inherit;">from kernel32 are </font><font style="vertical-align: inherit;">written to the 0x90 byte structure </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the process ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ‚Äúcmd.exe‚Äù is created. Using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , two buffers are allocated in it: with RW permissions with a length of 0x108 and with RWX permissions with a length of 0x1D4C. The RW buffer copies the above data block and the aforementioned structure with a length of 0x90. The structure also writes a pointer to the decrypted data block (in the address space of the child process (cmd.exe)). In RWX, the buffer is copied ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) decrypted data block with code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then, in the cmd.exe process, a stream ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is created with an entry point at the beginning of the RWX buffer, a pointer to the RW buffer is passed as an argument. </font><font style="vertical-align: inherit;">This completes the clone function, the action continues in the cmd.exe process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, the clone function seems to be like an unattainable piece of code that imports ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) the " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WorkPolyhistor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">library </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code injected into cmd.exe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It performs the following actions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finds the addresses of the necessary functions from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (its address is obtained from the parent process)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loads </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ole32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32 libraries</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finds addresses of necessary functions in these libraries.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is interesting that for most of the functions in the code there is no function name, but only CRC32 on behalf of (all function names from the loaded library are searched until there is a function with the desired CRC32 on behalf of). </font><font style="vertical-align: inherit;">Perhaps this is protection against getting the list of imported functions by the strings utility, although it is strange that code stored in encrypted form has such protection, while the dll itself imports functions simply by name. </font><font style="vertical-align: inherit;">In total, the following functions are detected: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Loadlibrary</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalalloc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateProcessW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalfree </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Writefile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW (found by name)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Writefile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closehandle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ReadFile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetfileSize</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwDelayExecution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ole32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoInitialize (found by name)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance (found by name)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rand</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> srand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, the process using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTempPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obtains the path to the temporary directory, creates a file in it with the name 26342235.dat, where the file name is the decimal record of TickCount received from the parent process and iterates on each new attempt (i.e. if the download failed on the first attempt, then on the second attempt a file will be created with the name 26342236.dat). </font><font style="vertical-align: inherit;">After that, the wininet library is loaded and there are pointers to the following functions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle (crc32: 0xe5191d24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState (crc32: 0xf2e5fc0c)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA (crc32: 0xda16a83d)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA (crc32: 0x16505e0)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile (crc32: 0x6cc098f5)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState it</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> checks if there is a network, if not, the application calls the function at a nonexistent address and crashes (such protection against determining the address from where the payload is obtained using a machine isolated from the network. This is the only case when the application terminates abnormally, in the rest 3 attempts are made , after which cmd.exe terminates using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). If there is a network, then using the found functions, the payload is downloaded from the URL passed from the parent process (https://pastebin.com/raw/Jyujxy7z) and saved to the previously created file with the .dat extension.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, the payload is read from the .dat file, decoded (base64), decrypted using XOR with CRC32 from the URL, check that the first 2 bytes of the decrypted data are 'MZ', if so, the result is saved to a file with the same name but extension. exe</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python decryption code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function, the </font><font style="vertical-align: inherit;">saved file is launched. </font><font style="vertical-align: inherit;">If all goes well, the cmd.exe process exits using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If something went wrong (except for the lack of a network), then everything is repeated anew, a maximum of 3 attempts are made, the names of the dat and exe files are increased by 1 each time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Second dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 32 bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In it, the main malicious functionality is implemented in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It also decrypts 2 buffers. </font><font style="vertical-align: inherit;">The first buffer is 0x78 (120) bytes in size, such data is decrypted and written to it (in decrypted form):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that in the beginning is the same URL as in the x64 version. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A second buffer of size 0x4678 bytes is allocated with RWX permissions. </font><font style="vertical-align: inherit;">The code is decrypted into it, after which a function is called from it with an offset of 0x4639 from the beginning of the buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not analyze this code in detail. </font><font style="vertical-align: inherit;">He also finds functions on CRC32, launches notepad.exe, injects code there that downloads payload from the same URL on pastebin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Payload with pastebin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The decrypted payload with pastebin is a 32-bit exe file (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) I did not disassemble it in detail yet due to lack of time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, the malware impressed me rather poorly written, with a lot of errors (I do not call them here intentionally). </font><font style="vertical-align: inherit;">As if they were whipping up. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dll finds in memory functions that are later not used anywhere. </font><font style="vertical-align: inherit;">Probably this code, like a macro, is regularly rewritten by cybercriminals every time it starts to be detected by antiviruses, as a result of which such artifacts remain in the code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also interesting that in the ‚Äúdll‚Äù version of the dll that is ‚Äúdropped‚Äù onto the x64 disk, the names of the ‚Äúdangerous‚Äù imported functions are not masked (you can at least see them strings), and in the code that is decrypted in memory and does not fit on the disk, they are located on CRC32 from name, not just by name. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The pastebin payload was removed a few days later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV taken from here</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489008/index.html">Routing in complex chatbots with the Hobot framework</a></li>
<li><a href="../en489010/index.html">We share the largest in Russia layer of data on online training with projects in linguistics, personalization, peddesign, ML</a></li>
<li><a href="../en489012/index.html">Google Cloud Spanner: good, bad, evil</a></li>
<li><a href="../en489014/index.html">The book ‚ÄúPerfect Algorithm. Greedy Algorithms and Dynamic Programming ¬ª</a></li>
<li><a href="../en489016/index.html">German Gref: ‚ÄúWe tried to organize a discussion about the AGI, and not a single self-respecting scientist came to it‚Äù</a></li>
<li><a href="../en489022/index.html">Using RabbitMQ with MonsterMQ Part 2</a></li>
<li><a href="../en489024/index.html">Webix JavaScript library through the eyes of a beginner. Part 5. Work with data on the user side</a></li>
<li><a href="../en489026/index.html">Changing Google AdSense Algorithms May Lead to Site Owners and Webmasters</a></li>
<li><a href="../en489028/index.html">About remote work</a></li>
<li><a href="../en489034/index.html">The new UIS mobile app - torment or salvation for those seeking public procurement?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>