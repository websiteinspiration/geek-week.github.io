<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯПОя╕П тЭЧя╕П ЁЯМЪ рд╣рдо рд╕реНрдЯреЗрдЯрдлреНрд▓реЛ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕рдордЭрддреЗ рд╣реИрдВ ЁЯЪ┤ ЁЯПП ЁЯЧСя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╕рднреА рдХреЛ рдирдорд╕реНрдХрд╛рд░ред 
 
 рдХреБрдЫ рджрд┐рдиреЛрдВ рдкрд╣рд▓реЗ, JetBrains рдиреЗ Corutin - 1.3.6 рдХрд╛ рдПрдХ рдирдпрд╛ рд╕рдВрд╕реНрдХрд░рдг рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдерд╛ рдФрд░ рдирд╡рд╛рдЪрд╛рд░реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдкреНрд░рд╡рд╛рд╣ - StateFlow рдХреА рдирдИ рдЙрдк-рдкреНрд░рдЬ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>рд╣рдо рд╕реНрдЯреЗрдЯрдлреНрд▓реЛ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕рдордЭрддреЗ рд╣реИрдВ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501308/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рднреА рдХреЛ рдирдорд╕реНрдХрд╛рд░ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдХреБрдЫ рджрд┐рдиреЛрдВ рдкрд╣рд▓реЗ, JetBrains рдиреЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corutin - 1.3.6 рдХрд╛</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдПрдХ </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">рдирдпрд╛ рд╕рдВрд╕реНрдХрд░рдг</font></a><font style="vertical-align: inherit;"> рдЬрд╛рд░реА рдХрд┐рдпрд╛ </font><font style="vertical-align: inherit;">рдерд╛ рдФрд░ рдирд╡рд╛рдЪрд╛рд░реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдкреНрд░рд╡рд╛рд╣ - StateFlow рдХреА рдирдИ рдЙрдк-рдкреНрд░рдЬрд╛рддрд┐ рдереА, рдЬреЛ рдХрд┐ ConflatedBroadcastChannel рдХреА рдЬрдЧрд╣ рд▓реЗрддреА рд╣реИред </font><font style="vertical-align: inherit;">рдореИрдВрдиреЗ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдореЗрдВ рд╕реНрдЯреЗрдЯрдлреНрд▓реЛ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдиреЗ рдФрд░ рдЖрдВрддрд░рд┐рдХ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ред</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдПрдВрдбреНрд░реЙрдЗрдб рдХреЗ рд▓рд┐рдП рдпрд╛ рдПрдордкреАрдкреА рдореЗрдВ рд╡рд┐рдХрд╕рд┐рдд рд╣реЛрдиреЗ рдкрд░ рдХреЛрдЯрд▓рд┐рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХрдИ рд▓реЛрдЧ рдЗрди рд╢рд░реНрддреЛрдВ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реИрдВ, рдЬреЛ рдирд╣реАрдВ рд╣реИрдВ - рдпреЗ рд╕рдВрд╕реНрдерд╛рдПрдВ рдЖрд░рдПрдХреНрд╕рдЬреИрд╡рд╛ рд╕реЗ BehaviorProcessor / BehaviorSubject рдХреЗ рдХрд░реАрдмреА рдПрдирд╛рд▓реЙрдЧ рд╣реИрдВ рдФрд░ рдЬреЗрдЯрдкреИрдХ рд╕реЗ LiveData / MutableLiveDataред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
StateFlow рд╣реА рдлрд╝реНрд▓реЛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд╛ рдПрдХ рд╕рд░рд▓ рд╡рд┐рд╕реНрддрд╛рд░ рд╣реИ рдФрд░ рджреЛ рд░реВрдкреЛрдВ рдореЗрдВ рдЖрддрд╛ рд╣реИ:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StateFlow</span>&lt;<span class="hljs-type">out T</span>&gt; : <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">T</span>&gt; </span>{
    <span class="hljs-comment">/**
     * The current value of this state flow.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> value: T<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MutableStateFlow</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">StateFlow</span>&lt;<span class="hljs-type">T</span>&gt; </span>{
    <span class="hljs-comment">/**
     * The current value of this state flow.
     *
     * Setting a value that is [equal][Any.equals] to the previous one does nothing.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрд╣ рд╡рд┐рдЪрд╛рд░ LiveData / MutableLiveData рдХреЗ рд╕рдорд╛рди рд╣реИ - рдПрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдпрд╣ рдХреЗрд╡рд▓ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреЛ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рджреВрд╕рд░реЗ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрд╕реЗ рднреА рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConflatedBroadcastChannel рдХреА рддреБрд▓рдирд╛ рдореЗрдВ StateFlow рд╣рдореЗрдВ рдХреНрдпрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдПрдХ рд╕рд░рд▓ рдФрд░ рдХрдЪрд░рд╛-рдореБрдХреНрдд рдЖрдВрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрдиред </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдЖрдЗрдЯрдо рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЕрд╢рдХреНрдд рднреА рд╕рдВрднрд╡ рд╣реИред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд░реАрдб-рдУрдирд▓реА рдФрд░ рд░реАрдб-рд░рд╛рдЗрдЯ рдЗрдВрдЯрд░рдлреЗрд╕ рдореЗрдВ рдкреГрдердХреНрдХрд░рдгред </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдВрдХ рдХреА рддреБрд▓рдирд╛ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп рд╕рдорд╛рдирддрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рддрддреНрд╡реЛрдВ рдХреА рддреБрд▓рдирд╛ рдХрд░рдирд╛ред </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЕрдм рд╕реНрдЯреЗрдЯрдлреНрд▓реЛ рдХреЗ рдПрдХ рд╕рд░рд▓ рдЙрдкрдпреЛрдЧ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдПрдХ рдЕрд╢рдХреНрдд рддрддреНрд╡ рдХреЗ рд╕рд╛рде рдХрд┐рд╕реА рднреА рдкреНрд░рдХрд╛рд░ рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╡рд╛рд▓рд╛ рдПрдХ рдкреНрд░рд╛рдердорд┐рдХ рдЖрд╡рд░рдг рдмрдирд╛рдпрд╛:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateFlowRepository</span>&lt;<span class="hljs-type">T</span>&gt;</span>(initialValue: T? = <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(initialValue)<font></font>
<font></font>
    <span class="hljs-keyword">var</span> value: T?
        <span class="hljs-keyword">get</span>() = stateFlow.value
        <span class="hljs-keyword">set</span>(value) {<font></font>
            stateFlow.value = value<font></font>
        }<font></font>
<font></font>
    <span class="hljs-keyword">val</span> stream: Flow&lt;T?&gt; = stateFlow<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╣рдореЗрдВ рдбреЗрдЯрд╛ рдорд┐рд▓рддрд╛ рд╣реИ:</font></font><br>
<br>
<pre><code class="kotlin hljs">lifecycleScope.launch {<font></font>
            simpleRepo.stream.collect {<font></font>
                addData(it.toString())<font></font>
            }<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдФрд░ рд╣рдо рд╕реНрдХреНрд░реАрди рдкрд░ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рд╕рд░рд▓ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рд╕реЗ рдХреЛрдИ рд╕рдорд╕реНрдпрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдФрд░ рд╕рдм рдХреБрдЫ рдШрдбрд╝реА рдХреА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/cv/_c/pncv_c41cwncgwkfc3hd3wxzfh0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЕрдм рдЖрдЗрдП рдЕрдВрджрд░ рджреЗрдЦреЗрдВ рдФрд░ рджреЗрдЦреЗрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдореЗрд░реЗ рдЖрд╢реНрдЪрд░реНрдп рдХреЗ рд▓рд┐рдП, рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдмрд╣реБрдд рд╕рд░рд▓ рд╣реИ рдФрд░ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдХреЗрд╡рд▓ 316 рд▓рд╛рдЗрдиреЗрдВ рд▓рдЧрддреА рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ рд╕реЗ 25% рдЬрд╛рд╡рджреЛрдХреА рд╣реИрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдФрд░ рдЗрд╕рд▓рд┐рдП, рдореБрдЦреНрдп рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд░реНрдЧ StateFlowImpl рд╡рд░реНрдЧ рд╣реИ:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateFlowImpl</span>&lt;<span class="hljs-type">T</span>&gt;</span>(initialValue: Any) : SynchronizedObject(), MutableStateFlow&lt;T&gt;, FusibleFlow&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = atomic(initialValue) <span class="hljs-comment">// T | NULL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sequence = <span class="hljs-number">0</span> <span class="hljs-comment">// serializes updates, value update is in process when sequence is odd</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> slots = arrayOfNulls&lt;StateFlowSlot?&gt;(INITIAL_SIZE)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nSlots = <span class="hljs-number">0</span> <span class="hljs-comment">// number of allocated (!free) slots</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nextIndex = <span class="hljs-number">0</span> <span class="hljs-comment">// oracle for the next free slot index</span><font></font>
<font></font>
. . .<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_state</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рд╣рдорд╛рд░реЗ рд░рд╛рдЬреНрдп рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░рдорд╛рдгреБ рд▓рд┐рдВрдХред </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдиреБрдХреНрд░рдо</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдПрдХ рд╕рд╣рд╛рдпрдХ рд╕рдВрдХреЗрддрдХ, рдЬреЛ, рд╕рдорддрд╛ / рд╡рд┐рд╖рдорддрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рд░рд╛рдЬреНрдп </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реНрд▓реЙрдЯреНрд╕</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреЛ рдЕрджреНрдпрддрди рдХрд░рдиреЗ рдХреА рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">- рд╕рд░рдгреА / рдкреВрд▓ StateFlowSlotред StateFlowSlot - StateFlow рдХреЗ рд▓рд┐рдП рдкреНрд░рддреНрдпреЗрдХ "рдХрдиреЗрдХреНрд╢рди" рдХреЗ рд╕рд╣рд╛рдпрдХ рдЕрдореВрд░реНрддред </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nSlots, nextIndex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдПрдХреНрд╕реНрдЯреЗрдВрд╕рд┐рдмрд▓ рдПрд░реЗ рд╕реНрд▓реЙрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЗрд▓реНрдкрд░ рд╡реИрд░рд┐рдПрдмрд▓ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЪрд▓реЛ рдкрд╣рд▓реЗ рд╕реЗ рд╕реНрдЯреЗрдЯрдлреНрд▓реЛрд╕реНрд▓реЗрдЯ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред рд╡рд╣ рдХреЗрд╡рд▓ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИ:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = atomic&lt;Any?&gt;(<span class="hljs-literal">null</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╕реНрд▓реЙрдЯ рд░рд╛рдЬреНрдпреЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд▓рд╕ рддрд░реАрдХреЗред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдкреНрд░рддреНрдпреЗрдХ рд╕реНрд▓реЙрдЯ рд░рд╛рдЬреНрдпреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрд╢рдХреНрдд</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЛрдИ рдирд╣реАрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдкреНрд░рдпреБрдХреНрдд рдХрд▓реЗрдХреНрдЯрд░ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рдВрдмрд┐рдд рд╕реНрдерд┐рддрд┐</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдХрд▓реЗрдХреНрдЯрд░ рдХреЛ рдПрдХ рдирдпрд╛ рдорд╛рди рднреЗрдЬрдиреЗ рдХреА рдкреНрд░рддреНрдпрд╛рд╢рд╛ рдореЗрдВ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CancellableContinuationImpl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдЧрдВрддрд╡реНрдп рдХреЛ рд▓рдВрдмрд┐рдд рд╕реНрдерд┐рддрд┐ рдореЗрдВ saspended рд░рд╛рдЬреНрдп рдкрд╛рд╕, рдХрд▓реЗрдХреНрдЯрд░ рдирд┐рд▓рдВрдмрд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ Stateflow рдореЗрдВ рдПрдХ рдирдП рд░рд╛рдЬреНрдп рдореЗрдВ рдЬрдм рддрдХ рдирд╣реАрдВ рдЖрдПрдЧрд╛ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ рдХрд┐ рдЬрдм рдЖрдк рдПрдХ рдирдпрд╛ рдорд╛рди рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T
        <span class="hljs-keyword">get</span>() = NULL.unbox(_state.value)
        <span class="hljs-keyword">set</span>(value) {
            <span class="hljs-keyword">var</span> curSequence = <span class="hljs-number">0</span>
            <span class="hljs-keyword">var</span> curSlots: Array&lt;StateFlowSlot?&gt; = <span class="hljs-keyword">this</span>.slots <span class="hljs-comment">// benign race, we will not use it</span>
            <span class="hljs-keyword">val</span> newState = value ?: NULL<font></font>
            synchronized(<span class="hljs-keyword">this</span>) {
                <span class="hljs-keyword">val</span> oldState = _state.value
                <span class="hljs-keyword">if</span> (oldState == newState) <span class="hljs-keyword">return</span> <span class="hljs-comment">// Don't do anything if value is not changing</span><font></font>
                _state.value = newState<font></font>
                curSequence = sequence<font></font>
                <span class="hljs-keyword">if</span> (curSequence and <span class="hljs-number">1</span> == <span class="hljs-number">0</span>) { <span class="hljs-comment">// even sequence means quiescent state flow (no ongoing update)</span>
                    curSequence++ <span class="hljs-comment">// make it odd</span><font></font>
                    sequence = curSequence<font></font>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// update is already in process, notify it, and return</span>
                    sequence = curSequence + <span class="hljs-number">2</span> <span class="hljs-comment">// change sequence to notify, keep it odd</span>
                    <span class="hljs-keyword">return</span><font></font>
                }<font></font>
                curSlots = slots <span class="hljs-comment">// read current reference to collectors under lock</span><font></font>
            }<font></font>
            <span class="hljs-comment">/*
               Fire value updates outside of the lock to avoid deadlocks with unconfined coroutines
               Loop until we're done firing all the changes. This is sort of simple flat combining that
               ensures sequential firing of concurrent updates and avoids the storm of collector resumes
               when updates happen concurrently from many threads.
             */</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">// Benign race on element read from array</span>
                <span class="hljs-keyword">for</span> (col <span class="hljs-keyword">in</span> curSlots) {<font></font>
                    col?.makePending()<font></font>
                }<font></font>
                <span class="hljs-comment">// check if the value was updated again while we were updating the old one</span>
                synchronized(<span class="hljs-keyword">this</span>) {
                    <span class="hljs-keyword">if</span> (sequence == curSequence) { <span class="hljs-comment">// nothing changed, we are done</span>
                        sequence = curSequence + <span class="hljs-number">1</span> <span class="hljs-comment">// make sequence even again</span>
                        <span class="hljs-keyword">return</span> <span class="hljs-comment">// done</span><font></font>
                    }<font></font>
                    <span class="hljs-comment">// reread everything for the next loop under the lock</span><font></font>
                    curSequence = sequence<font></font>
                    curSlots = slots<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрд╣рд╛рдБ рдореБрдЦреНрдп рдХрд╛рд░реНрдп рдлреНрд▓реЛрдХреЛрд▓реЗрдХреНрдЯрд░ рдХреЗ рд▓рд┐рдП рд▓рдЧрд╛рддрд╛рд░ рдХреЙрд▓ рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рд╡рд╛рд╣ рд╕реЗ StateFlow рд░рд╛рдЬреНрдп рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдареАрдХ рдХрд░рдирд╛ рд╣реИред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдХрдИ рдЪрд░рдгреЛрдВ рдХреЛ рдкреНрд░рддрд┐рд╖реНрдард┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдпрд╛ рдорд╛рди рд╕реЗрдЯ рдХрд░рдирд╛ред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдиреБрдХреНрд░рдо рдорд╛рд░реНрдХрд░ рдХреЛ рд╡рд┐рд╖рдо рдорд╛рди рдкрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╣реИрдВред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">makePending () - рд╕рднреА рд╕реНрд▓реЙрдЯ рд╕реНрдЯреЗрдЯреНрд╕ (рдпрд╛рдиреА, рд╕рднреА рдХрдиреЗрдХреНрд╢рди) рдХреЛ PENDING рдореЗрдВ рд╕реЗрдЯ рдХрд░рдирд╛ - рд╣рдо рдЬрд▓реНрдж рд╣реА рдПрдХ рдирдпрд╛ рдорд╛рди рднреЗрдЬреЗрдВрдЧреЗред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓реВрдк рдЕрдиреБрдХреНрд░рдо == рдЙрддреНрд╕реБрдХрддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рднреА рдХрд╛рд░реНрдп рдкреВрд░реЗ рд╣реЛ рдЪреБрдХреЗ рд╣реИрдВ рдФрд░ рдЕрдиреБрдХреНрд░рдо рдХреЛ рдПрдХ рд╕рдо рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред</font></font></li>
</ol><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрдЧреНрд░рд╣</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
рд╡рд┐рдзрд┐ рдореЗрдВ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-keyword">val</span> slot = allocateSlot()
        <span class="hljs-keyword">var</span> prevState: Any? = <span class="hljs-literal">null</span> <span class="hljs-comment">// previously emitted T!! | NULL (null -- nothing emitted yet)</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// The loop is arranged so that it starts delivering current value without waiting first</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">// Here the coroutine could have waited for a while to be dispatched,</span>
                <span class="hljs-comment">// so we use the most recent state here to ensure the best possible conflation of stale values</span>
                <span class="hljs-keyword">val</span> newState = _state.value
                <span class="hljs-comment">// Conflate value emissions using equality</span>
                <span class="hljs-keyword">if</span> (prevState == <span class="hljs-literal">null</span> || newState != prevState) {<font></font>
                    collector.emit(NULL.unbox(newState))<font></font>
                    prevState = newState<font></font>
                }<font></font>
                <span class="hljs-comment">// Note: if awaitPending is cancelled, then it bails out of this loop and calls freeSlot</span>
                <span class="hljs-keyword">if</span> (!slot.takePending()) { <span class="hljs-comment">// try fast-path without suspending first</span>
                    slot.awaitPending() <span class="hljs-comment">// only suspend for new values when needed</span><font></font>
                }<font></font>
            }<font></font>
        } <span class="hljs-keyword">finally</span> {<font></font>
            freeSlot(slot)<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдореБрдЦреНрдп рдХрд╛рд░реНрдп рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди рднреЗрдЬрдирд╛ рдФрд░ рдирдП рдореВрд▓реНрдпреЛрдВ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдирд╛ рд╣реИ: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдПрдХ рдирдП рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрд▓реЙрдЯ рдмрдирд╛рддреЗ рд╣реИрдВ рдпрд╛ рдЙрд╕рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдЕрд╢рдХреНрдд рдпрд╛ рд░рд╛рдЬреНрдп рдкрд░рд┐рд╡рд░реНрддрди рдХреЗ рд▓рд┐рдП рд░рд╛рдЬреНрдп рдХреА рдЬрд╛рдБрдЪ рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдПрдорд┐рдЯреАрдо рдПрдХ рдирдпрд╛ рдЕрд░реНрде рд╣реИред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрд▓реЙрдЯ рддреИрдпрд╛рд░ рд╣реИрдВ (PENDING рд░рд╛рдЬреНрдп) рдФрд░ рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рд╣рдо рдирдП рдореВрд▓реНрдпреЛрдВ рдХреА рдкреНрд░рддреНрдпрд╛рд╢рд╛ рдореЗрдВ рд╕реНрд▓реЙрдЯ рдХреЛ рдирд┐рд▓рдВрдмрд┐рдд рдХрд░ рджреЗрддреЗ рд╣реИрдВред</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдпрд╣ рд╕рдм рд╣реИред </font><font style="vertical-align: inherit;">рд╣рдордиреЗ рдпрд╣ рдирд╣реАрдВ рд╕реЛрдЪрд╛ рдХрд┐ рд╕реНрд▓реЙрдЯреНрд╕ рдХрд╛ рдЖрд╡рдВрдЯрди рдФрд░ рдЙрдирдХреЗ рд░рд╛рдЬреНрдпреЛрдВ рдХрд╛ рдкрд░рд┐рд╡рд░реНрддрди рдХреИрд╕реЗ рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдореБрдЭреЗ рд▓рдЧрд╛ рдХрд┐ рдпрд╣ рд╕реНрдЯреЗрдЯрдлреНрд▓реЛ рдХреА рд╕рдордЧреНрд░ рддрд╕реНрд╡реАрд░ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдзрдиреНрдпрд╡рд╛рджред</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi501276/index.html">рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдЪреИрдирд▓ рд╕реЗ YouTube рдкреНрд▓реЗрд▓рд┐рд╕реНрдЯ рдореЗрдВ рд╣рдЬрд╛рд░реЛрдВ рдХреНрд▓рд┐рдк рдЬреЛрдбрд╝реЗрдВ</a></li>
<li><a href="../hi501282/index.html">рдХреЛрд░реЛрдирд╛рд╡рд╛рдпрд░рд╕ рджреБрд╖реНрдкреНрд░рднрд╛рд╡: рд░реЛрдмреЛрдЯ рд╣рдорд╛рд░реА рдиреМрдХрд░рд┐рдпреЛрдВ рдкрд░ рднреА рддреЗрдЬреА рд╕реЗ рдХрдмреНрдЬрд╛ рдХрд░ рд▓реЗрдВрдЧреЗ</a></li>
<li><a href="../hi501298/index.html">рдЕрдкрдиреА рдЦреБрдж рдХреА QGIS рдкреНрд▓рдЧрдЗрди рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдмрдирд╛рдирд╛</a></li>
<li><a href="../hi501302/index.html">рдХреГрдкрдпрд╛ рд╢реЛрд░ рди рдХрд░реЗрдВ</a></li>
<li><a href="../hi501306/index.html">рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреНрд░реЗрдЧрд▓ рдиреЗрдЯрд┐рд╡ рдЗрдореЗрдЬ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрд╛ рдирд┐рд░реНрдорд╛рдг</a></li>
<li><a href="../hi501310/index.html">рд╣рд╛рдЗрдбреНрд░реЛрдЬрди рдкреЗрд░реЛрдХреНрд╕рд╛рдЗрдб рдФрд░ рд░реЙрдХреЗрдЯ рдмрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ</a></li>
<li><a href="../hi501312/index.html">рдЕрд▓реНрдкрд╛рдЗрди.рдЬреЗрдПрд╕ - рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╕рд┐рдВрдЯреИрдХреНрд╕ рдХреЗ рд╕рд╛рде рд╣рд▓реНрдХреЗ рдврд╛рдВрдЪреЗ</a></li>
<li><a href="../hi501316/index.html">Microsoft рдЕрдзреНрдпрдпрди: рдХрд░реНрдордЪрд╛рд░реА рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд╡реНрдпрд╡рд╕рд╛рдп рдореЗрдВ рдХреГрддреНрд░рд┐рдо рдмреБрджреНрдзрд┐рдорддреНрддрд╛ рдХрд╛ рдкрд░рд┐рдЪрдп рджреЗрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдореБрдЦ рдХрд╛рд░рдХреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ</a></li>
<li><a href="../hi501318/index.html">рдмрд┐рд▓ рдЧреЗрдЯреНрд╕ рдХрд╛ рдЧреЛрд▓реНрдл рдХреНрд▓рдм рдкрдбрд╝реЛрд╕реА рдмрдирдиреЗ рдХреЗ рд▓рд┐рдП js рдФрд░ Google рд╢реАрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ</a></li>
<li><a href="../hi501320/index.html">$ 1 рд╕реЗ рдХрдо рдХреА BOM рд▓рд╛рдЧрдд рд╡рд╛рд▓рд╛ рдПрд▓рдИрдбреА рдбреНрд░рд╛рдЗрд╡рд░ред рдХреНрдпрд╛ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>