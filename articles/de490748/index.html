<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖ ‚úâÔ∏è üíÖ Die Aufgabe f√ºr den Entwickler oder wie wir Handscanner ohne Anbieter gescannt haben üàöÔ∏è üòç üëÇüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen. 
 
 Wir, Victor Antipov und Ilya Aleshin, werden heute √ºber unsere Erfahrungen mit USB-Ger√§ten √ºber Python PyUSB und ein wenig √ºb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Die Aufgabe f√ºr den Entwickler oder wie wir Handscanner ohne Anbieter gescannt haben</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/490748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir, Victor Antipov und Ilya Aleshin, werden heute √ºber unsere Erfahrungen mit USB-Ger√§ten √ºber Python PyUSB und ein wenig √ºber Reverse Engineering sprechen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/ux/va/j4uxvafzrna4qe-37a6miqsyg1u.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Jahr 2019 trat das Dekret der Regierung der Russischen F√∂deration Nr. 224 ‚Äû√úber die Genehmigung der Vorschriften f√ºr die Kennzeichnung von Tabakerzeugnissen durch Identifizierung und die Besonderheiten der Einf√ºhrung eines staatlichen Informationssystems zur √úberwachung des Warenverkehrs, f√ºr den eine Kennzeichnung durch Tabakerzeugnisse vorgeschrieben ist‚Äú in Kraft. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dem Dokument wird erkl√§rt, dass die Hersteller ab dem 1. Juli 2019 jede Packung Tabak kennzeichnen m√ºssen. Direktvertriebsh√§ndler sollten diese Produkte mit dem Design eines Universal Transfer Document (UPD) erhalten. Gesch√§fte wiederum m√ºssen den Verkauf von gekennzeichneten Produkten √ºber die Registrierkasse registrieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ab dem 1. Juli 2020 sind auch nicht gekennzeichnete Tabakerzeugnisse verboten. Dies bedeutet, dass alle Zigarettenpackungen mit einem speziellen Datamatrix-Barcode gekennzeichnet sein m√ºssen. Und - ein wichtiger Punkt - es stellte sich heraus, dass Datamatrix nicht gew√∂hnlich, sondern umgekehrt sein wird. Das hei√üt, kein schwarzer Code auf wei√ü, sondern umgekehrt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben unsere Scanner getestet und es stellte sich heraus, dass die meisten von ihnen neu geflasht / umgeschult werden m√ºssen, da sie sonst einfach nicht normal mit diesem Barcode arbeiten k√∂nnen. Diese Wendung der Ereignisse garantierte uns starke Kopfschmerzen, da unser Unternehmen viele Gesch√§fte hat, die √ºber ein weites Gebiet verstreut sind. Mehrere Zehntausende von Kassen - und extrem wenig Zeit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was war zu tun? </font><font style="vertical-align: inherit;">Es gibt zwei M√∂glichkeiten. </font><font style="vertical-align: inherit;">Erstens: Die Ingenieure in der Einrichtung blinken die Scanner manuell neu ein und passen sie an. </font><font style="vertical-align: inherit;">Zweitens: Wir arbeiten remote und decken vorzugsweise viele Scanner gleichzeitig in einer Iteration ab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erste Option passte nat√ºrlich nicht zu uns: Wir m√ºssten Geld f√ºr Exkursionen von Ingenieuren ausgeben, und es ist in diesem Fall schwierig, den Prozess zu kontrollieren und zu koordinieren. </font><font style="vertical-align: inherit;">Aber das Wichtigste ist, dass die Leute arbeiten, das hei√üt, wir w√ºrden m√∂glicherweise viele Fehler bekommen und h√∂chstwahrscheinlich nicht die Frist einhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zweite Option ist gut f√ºr alle, wenn nicht f√ºr eine, aber. </font><font style="vertical-align: inherit;">Einige Anbieter verf√ºgten nicht √ºber die f√ºr alle erforderlichen Betriebssysteme erforderlichen Remote-Flashing-Tools. </font><font style="vertical-align: inherit;">Und da die Fristen abgelaufen waren, musste ich mit meinem eigenen Kopf denken.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als n√§chstes werden wir beschreiben, wie wir Tools f√ºr Handscanner f√ºr das Debian 9.x-Betriebssystem entwickelt haben (wir haben alle Debian-Kassen).</font></font><br>
<br>
<h3> :   </h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sagt Victor Antipov.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Das offizielle Dienstprogramm des Anbieters funktioniert unter Windows und nur mit IE. Das Dienstprogramm kann den Scanner flashen und konfigurieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da das Zielsystem Debian ist, haben wir den USB-Redirector-Server auf dem Debian-Server und den USB-Redirector-Client unter Windows installiert. Mit den Dienstprogrammen usb-redirector wurde der Scanner vom Linux-Computer an den Windows-Computer weitergeleitet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Dienstprogramm des Windows-Anbieters hat den Scanner gesehen und sogar normal geflasht. Somit wurde die erste Schlussfolgerung gezogen: Nichts h√§ngt vom Betriebssystem ab, die Angelegenheit steht im Flashing-Protokoll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK. Auf einem Windows-Computer wurde ein Flashen gestartet, und auf einem Linux-Computer wurde ein Speicherauszug entfernt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie haben den Dump in WireShark gestopft und ... waren traurig (ich werde einen Teil der Dump-Details weglassen, sie sind nicht von Interesse). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche M√ºllkippe hat uns gezeigt:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/ut/sa/5cutsausebu86kbucq6rfksz7wu.png"><br>
<br>
<img src="https://habrastorage.org/webt/9z/ex/jo/9zexjowdglq6cjc88ln5r6tlkcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Adressen 0000-0030 sind nach Wireshark USB-Serviceinformationen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir waren an Teil 0040-0070 interessiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus einem √úbertragungsrahmen war nichts klar, au√üer MOCFT-Zeichen. Diese Symbole erwiesen sich als Symbole aus der Firmware-Datei sowie den √ºbrigen Symbolen bis zum Ende des Frames (die Firmware-Datei ist hervorgehoben): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/ls/mf/yblsmf2htqk4n-lsa3u702yy5vm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was bedeuteten die Symbole fd 3e 02 01 fe, ich pers√∂nlich hatte wie Ilya keine Ahnung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mir den n√§chsten Frame angesehen (Serviceinformationen werden hier gel√∂scht, die Firmware-Datei wird hervorgehoben): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/sr/ut/r3srutakf1ioytxspf1zurv9pww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was wurde klar? Dass die ersten beiden Bytes eine Art Konstante sind. Alle nachfolgenden Bl√∂cke best√§tigten dies, jedoch vor dem Ende des √úbertragungsblocks:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/t6/ux/j7t6uxe8auhqxaxp5azeolv5jwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Frame geriet ebenfalls in einen Stupor, da sich die Konstante √§nderte (hervorgehoben) und seltsamerweise ein Teil der Datei vorhanden war. Die Gr√∂√üe der √ºbertragenen Bytes der Datei zeigte an, dass 1024 Bytes √ºbertragen wurden. Was die restlichen Bytes bedeuteten - ich wusste es nicht noch einmal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst habe ich wie ein alter BBS-Spitzname die Standard√ºbertragungsprotokolle √ºberarbeitet. 1024 Bytes, kein Protokoll √ºbergeben. Er begann das Material zu studieren und stie√ü auf das 1K Xmodem-Protokoll. Es erlaubte die √úbertragung von 1024, jedoch mit einer Nuance: Zuerst nur 128, und nur in Abwesenheit von Fehlern erh√∂hte das Protokoll die Anzahl der √ºbertragenen Bytes. Ich hatte sofort eine √úbertragung von 1024 Bytes. Ich beschloss, die √úbertragungsprotokolle und speziell das X-Modem zu studieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab zwei Varianten des Modems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst das Format des XMODEM-Pakets mit CRC8-Unterst√ºtzung (Original XMODEM):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/dq/7w/wudq7w7yg59duxo2ok3rcng5bga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens das XMODEM-Paketformat mit CRC16-Unterst√ºtzung (XmodemCRC): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i2/cz/j3/i2czj3nd212vhlbms9uqrysd5xa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht √§hnlich aus, mit Ausnahme von SOH, </font><font style="vertical-align: inherit;">Paketnummer </font><font style="vertical-align: inherit;">und CRC und der L√§nge des Pakets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mir den Anfang des zweiten √úbertragungsblocks angesehen (und wieder die Firmware-Datei gesehen, aber mit einem Einzug von 1024 Bytes):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/lk/nb/5vlknbhbecr2d3d7uigb19dh_cg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe den bekannten Header fd 3e 02 gesehen, aber die n√§chsten zwei Bytes haben sich bereits ge√§ndert: Es war 01 fe und es wurde 02 fd. Dann habe ich bemerkt, dass der zweite Block jetzt 02 nummeriert ist und somit verstanden hat: Vor mir liegt die Nummerierung des √úbertragungsblocks. Die erste 1024-√úbertragung ist 01, die zweite 02, die dritte 03 usw. (aber nat√ºrlich hexadezimal). Aber was bedeutet der Wechsel von fe zu fd? Die Augen sahen eine Abnahme von 1, das Gehirn erinnerte daran, dass Programmierer von 0 z√§hlen, nicht von 1. Aber warum ist dann der erste Block 1 nicht 0? Ich habe die Antwort auf diese Frage nicht gefunden. Aber ich habe verstanden, wie der zweite Block betrachtet wird. Der zweite Block ist nichts anderes als FF - (minus) die Nummer des ersten Blocks. Somit wurde der zweite Block als = 02 (FF-02) = 02 FD bezeichnet. Das anschlie√üende Lesen der M√ºllkippe best√§tigte meine Vermutung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann tauchte das folgende Bild des Programms auf: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Beginn des Programms</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 02 - Start </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01 FE - √úbertragungsz√§hler </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úbertragung (34 Bl√∂cke, 1024 Bytes werden √ºbertragen) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 1024 Datenbytes (unterteilt in Bl√∂cke von 30 Bytes). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ende der √úbertragung </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Datenreste, die an 1024 Bytes ausgerichtet werden sollen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sieht der </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ee/t9/dmeet9sttaokhdirciuxag4p9y4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Block√ºbertragungs-Endrahmen aus </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">fd 25 - Signal zum Ende der Block√ºbertragung. Weiter 2f 52 - die Reste der Datei bis zu 1024 Bytes. 2f 52 ist nach dem Protokoll eine 16-Bit-CRC-Pr√ºfsumme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basierend auf dem alten Speicher habe ich ein Programm in C erstellt, das 1024 Bytes aus einer Datei gezogen und 16-Bit-CRC gelesen hat. </font><font style="vertical-align: inherit;">Der Start des Programms hat gezeigt, dass dies kein 16-Bit-CRC ist. </font><font style="vertical-align: inherit;">Wieder Stupor - f√ºr ungef√§hr drei Tage. </font><font style="vertical-align: inherit;">Die ganze Zeit habe ich versucht zu verstehen, was es sein k√∂nnte, wenn nicht eine Pr√ºfsumme. </font><font style="vertical-align: inherit;">Beim Studium englischsprachiger Websites stellte ich fest, dass das X-Modem eine eigene Pr√ºfsummenberechnung verwendet - CRC-CCITT (XModem). </font><font style="vertical-align: inherit;">Ich habe keine Implementierungen in C f√ºr diese Berechnung gefunden, aber ich habe eine Site gefunden, die diese Pr√ºfsumme online liest. </font><font style="vertical-align: inherit;">Durch das Hochladen von 1024 Bytes meiner Datei auf die Webseite zeigte mir die Site eine Pr√ºfsumme, die vollst√§ndig mit der Pr√ºfsumme aus der Datei √ºbereinstimmte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hurra! </font><font style="vertical-align: inherit;">Das letzte R√§tsel ist gel√∂st, jetzt mussten Sie Ihre eigene Firmware erstellen. </font><font style="vertical-align: inherit;">Dann √ºbertrug ich mein Wissen (und sie blieben nur in meinem Kopf) auf Ilya, die mit m√§chtigen Werkzeugen vertraut ist - Python.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmerstellung</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erz√§hlt von Ilya Aleshin. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich die entsprechenden Anweisungen erhalten hatte, war ich sehr ‚Äûgl√ºcklich‚Äú. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wo soll ich anfangen? </font><font style="vertical-align: inherit;">Von Anfang an. </font><font style="vertical-align: inherit;">ÔÅä Vom Dumping von einem USB-Anschluss. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºhren Sie USB-pcap </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://desowin.org/usbpcap/tour.html aus.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
W√§hlen Sie den Port, an den das Ger√§t angeschlossen ist, und die Datei, in der der Speicherauszug gespeichert werden soll. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/ax/xp/gaaxxp3qdqajous7didfd7gwkg8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verbinden den Scanner mit dem Computer, auf dem die native EZConfigScanning-Software f√ºr Windows installiert ist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/oo/le/olooleeirgestw3q0gzvhqvzr58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darin finden wir den Punkt, an dem Befehle an das Ger√§t gesendet werden. </font><font style="vertical-align: inherit;">Aber was ist mit den Teams? </font><font style="vertical-align: inherit;">Wo bekommt man sie? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Programm startet, wird das Ger√§t automatisch abgefragt (wir werden dies etwas sp√§ter sehen). </font><font style="vertical-align: inherit;">Und es gab Schulungs-Barcodes aus offiziellen Ausr√ºstungsdokumenten. </font><font style="vertical-align: inherit;">DEFALT. </font><font style="vertical-align: inherit;">Das ist unser Team. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/dv/gf/8vdvgfiuthogftttgzdsxym22_4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die notwendigen Daten werden empfangen. </font><font style="vertical-align: inherit;">√ñffnen Sie dump.pcap durch wireshark.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Block beim Start EZConfigScanning. Die roten Punkte sind Orte, auf die Sie achten sollten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/ju/0x/wpju0xwxz9_hgex0jnnyttjxqpa.png"><br>
<br>
<img src="https://habrastorage.org/webt/nw/6s/so/nw6ssotdpggn37qvn9kvayxhxde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich das alles zum ersten Mal sah, verlor ich den Mut. Wo man weiter graben kann, ist unklar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein bisschen Brainstorming und ... und ... Aha! In einer M√ºllhalde, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Googelte, was URB_INTERRUPT ist. Es wurde festgestellt, dass dies eine Daten√ºbertragungsmethode ist. Und es gibt 4 solcher Methoden: Kontrolle, Interrupt, isochron, Bulk. Sie k√∂nnen separat dar√ºber lesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Endpunktadressen in der USB-Ger√§teschnittstelle k√∂nnen entweder √ºber den Befehl ‚Äûlsusb ‚Äìv‚Äú oder √ºber pyusb abgerufen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt m√ºssen Sie alle Ger√§te mit dieser VID finden. Sie k√∂nnen gezielt nach VID: PID suchen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/xp/i_/fnxpi_m69b43p6yzpeoh3atps0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht aus wie das:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g0/h4/td/g0h4tdpscytduyzmj4xqe31r5s4.png"><br>
<br>
<img src="https://habrastorage.org/webt/d4/wf/5k/d4wf5k6asqr5nvofve-ntd5sm4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben also die notwendigen Informationen: P_INFO-Befehle. oder DEFALT, Adressen, an die der Befehlsendpunkt = 03 geschrieben und der Antwortendpunkt = 86 abgerufen werden soll. Es bleibt nur, die Befehle in hex zu √ºbersetzen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/io/wf/ui/iowfuid0hhvl6q6zpb9kfds3tny.png"><br>
<br>
<img src="https://habrastorage.org/webt/0p/gr/2j/0pgr2jw1u6tj5vqetitjg3g6chw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir das Ger√§t bereits gefunden haben, trennen Sie es vom Kernel ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/xy/84/jixy849fy7l81g9tenjxpf7uymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... und schreiben Sie auf den Endpunkt mit der Adresse 0x03, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qx/v0/nt/qxv0nttjmnddvekfmbnfq9vebfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... und lesen Sie dann die Antwort vom Endpunkt mit der Adresse 0x86. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kj/xn/e2/kjxne2x9ab6spmxnk2ac3bnroc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Strukturierte Antwort:</font></font><br>
<br>
<pre><code class="plaintext hljs">P_INFOfmt: 1<font></font>
mode: app<font></font>
app-present: 1<font></font>
boot-present: 1<font></font>
hw-sn: 18072B44CA<font></font>
hw-rev: 0x20<font></font>
cbl: 4<font></font>
app-sw-rev: CP000116BBA<font></font>
boot-sw-rev: CP000014BAD<font></font>
flash: 3<font></font>
app-m_name: Voyager 1450g<font></font>
boot-m_name: Voyager 1450g<font></font>
app-p_name: 1450g<font></font>
boot-p_name: 1450g<font></font>
boot-time: 16:56:02<font></font>
boot-date: Oct 16 2014<font></font>
app-time: 08:49:30<font></font>
app-date: Mar 25 2019<font></font>
app-compat: 289<font></font>
boot-compat: 288<font></font>
csum: 0x6986</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen diese Daten in dump.pcap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cr/z5/2y/crz52y_j0alhcohhokmry0bx7t8.png"><br>
<br>
<img src="https://habrastorage.org/webt/-s/np/cv/-snpcv4opok9jdsrj8thkshno_4.png"><br>
<br>
<img src="https://habrastorage.org/webt/qj/dq/zl/qjdqzlcwogon9yts12p5awr32ha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fein! Wir √ºbersetzen System-Barcodes in Hex. Alles, die Trainingsfunktionalit√§t ist fertig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was tun mit Firmware? Es scheint, dass alles gleich ist, aber es gibt eine Nuance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir einen vollst√§ndigen Speicherauszug des Flash-Prozesses entfernt hatten, verstanden wir ungef√§hr, womit wir es zu tun hatten. Hier ist ein Artikel √ºber XMODEM, der wirklich dazu beigetragen hat, zu verstehen, wie diese Kommunikation abl√§uft, wenn auch allgemein: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://microsin.net/adminstuff/others/xmodem-protocol-overview.html Ich</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> empfehle, ihn zu lesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie in den </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/o6/uj/wio6ujyvlj_bnltlngxf24k9evk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speicherauszug schauen, </font><font style="vertical-align: inherit;">k√∂nnen Sie sehen, dass die Rahmengr√∂√üe 1024 und die Gr√∂√üe der URB-Daten 64 betr√§gt. </font><font style="vertical-align: inherit;">Daher erhalten wir 1024/64 16 Zeilen in einem Block, lesen die Firmware-Datei mit 1 Zeichen und bilden einen Block. Erg√§nzung von 1 Zeile in einem Block mit Sonderzeichen fd3e02 + Blocknummer.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die n√§chsten 14 Zeilen werden mit fd25 + erg√§nzt. Mit XMODEM.calc_crc () berechnen wir die Pr√ºfsumme des gesamten Blocks (es hat viel Zeit gedauert, um zu verstehen, dass ‚ÄûFF - 1‚Äú CSUM ist), und die letzte 16. Zeile wird mit fd3e erg√§nzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass alles, die Firmware-Datei lesen, die Bl√∂cke treffen, den Scanner vom Kernel trennen und an das Ger√§t senden. </font><font style="vertical-align: inherit;">Aber nicht so einfach. </font><font style="vertical-align: inherit;">Der Scanner muss durch </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Senden von NEWAPP = '\\ xfd \\ x0a \\ x16 \\ x4e \\ x2c \\ x4e \\ x45 \\ x57 \\ x41 \\ x50 \\ x50 \\ x0d' </font><font style="vertical-align: inherit;">in den Firmware-Modus versetzt werden </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Woher kommt dieser Befehl? </font><font style="vertical-align: inherit;">Von der M√ºllkippe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/sd/nd/ausdnd16ikur6ajzdiyk9-ntklw.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aufgrund der Einschr√§nkung von 64 k√∂nnen wir jedoch nicht den gesamten Block an den Scanner senden: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/db/k6/qg/dbk6qgrapgsxiwdo9jyxqd0svwu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, der Scanner im NEWAPP-Blinkmodus akzeptiert auch kein Hex. </font><font style="vertical-align: inherit;">Daher ist es notwendig, jede Zeile bytes_array zu √ºbersetzen</font></font><br>
<br>
<pre><code class="plaintext hljs">[253, 10, 22, 78, 44, 78, 69, 87, 65, 80, 80, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und senden Sie diese Daten bereits an den Scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir bekommen die Antwort:</font></font><br>
<br>
<pre><code class="plaintext hljs">[2, 1, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie den Artikel √ºber XMODEM lesen, wird klar: Die Daten wurden akzeptiert. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/fd/gj/pofdgjvcgns7oxdeonuldkqbptg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alle Bl√∂cke √ºbertragen wurden, schlie√üen wir die √úbertragung END_TRANSFER = '\ xfd \ x01 \ x04' ab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da diese Bl√∂cke keine Informationen f√ºr normale Benutzer enthalten, wird die Firmware standardm√§√üig im versteckten Modus erstellt. </font><font style="vertical-align: inherit;">Und f√ºr alle F√§lle organisieren wir √ºber tqdm einen Fortschrittsbalken. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/18/g1/da18g1axnll2zps9qpx2s7opkha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eigentlich ist der Rest klein. </font><font style="vertical-align: inherit;">Es bleibt nur, die L√∂sung zu einem klar definierten Zeitpunkt in Skripte f√ºr die Massenreplikation zu verpacken, um den Arbeitsprozess an der Abendkasse nicht zu verlangsamen und die Protokollierung hinzuzuf√ºgen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem </font><font style="vertical-align: inherit;">wir </font><font style="vertical-align: inherit;">viel Zeit, Energie </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und Haare auf dem Kopf verbracht hatten</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , konnten wir die L√∂sungen entwickeln, die wir brauchten. Au√üerdem haben wir die Frist eingehalten. </font><font style="vertical-align: inherit;">Gleichzeitig werden die Scanner jetzt zentral neu geflasht und umgeschult. Wir steuern den gesamten Prozess klar. </font><font style="vertical-align: inherit;">Das Unternehmen sparte Zeit und Geld und wir sammelten wertvolle Erfahrungen im Reverse Engineering dieser Art von Ger√§ten.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de490736/index.html">9 klare Werkzeuge zum Lernen und Pumpen des englischen Wortschatzes</a></li>
<li><a href="../de490738/index.html">Lisk-Substitutionsprinzip</a></li>
<li><a href="../de490740/index.html">Das Defektieren von *** s ist nicht nur eine Randomisierung</a></li>
<li><a href="../de490742/index.html">Eine neue √Ñra in der Robotik hat begonnen</a></li>
<li><a href="../de490746/index.html">Bewertung in Yandex.Taxi: Ein kurzer Beitrag zu einem ernsten Thema</a></li>
<li><a href="../de490750/index.html">Mikhail Salosin. Golang Meetup. Verwenden von Go im Backend der Watch + -Anwendung</a></li>
<li><a href="../de490754/index.html">Visual Studio Code Code Editor. Die ausf√ºhrlichste Anleitung zum Einrichten und Installieren von Plugins f√ºr Anf√§nger</a></li>
<li><a href="../de490756/index.html">Stellen Sie Jenkins als Code bereit</a></li>
<li><a href="../de490758/index.html">Mathematiker haben das universelle Gesetz der Turbulenzen bewiesen</a></li>
<li><a href="../de490760/index.html">Ray Casting Visuelle Suche (RCVS). Einfacher und schneller Algorithmus zum Auffinden von 3D-Modellen mit √§hnlicher Geometrie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>