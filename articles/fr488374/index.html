<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüîß ü§¶üèø üèÑ T√©l√©gramme + 1C + Webhooks + Apache + Certificat auto-sign√© üßñüèæ üíÉüèΩ üéÖüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De nombreuses lignes sont √©crites sur l'int√©gration de Telegram et 1C. Mais nulle part je n'ai vu les instructions compl√®tes pour l'installation et la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>T√©l√©gramme + 1C + Webhooks + Apache + Certificat auto-sign√©</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488374/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De nombreuses lignes sont √©crites sur l'int√©gration de Telegram et 1C. </font><font style="vertical-align: inherit;">Mais nulle part je n'ai vu les instructions compl√®tes pour l'installation et la configuration des webhooks. </font><font style="vertical-align: inherit;">Je vais essayer de l'√©crire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tout cela, nous avons besoin (ou il sera plus correct de dire ce que j'ai utilis√©):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache 2.2.24</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenSSL (inclus avec l'installation d'Apache)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1C (avec modules de serveur Web)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propre domaine </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot cr√©√© dans Telegram (je ne d√©crirai pas sa cr√©ation, car c'est assez banal)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est suppos√© que tous les logiciels que vous avez install√©s.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons donc par obtenir un certificat. </font><font style="vertical-align: inherit;">Ouvrez la ligne de commande et ex√©cutez le code suivant:</font></font><br>
<br>
<pre><code class="bash hljs">openssl req -newkey rsa:2048 -sha256 -nodes -keyout YOURPRIVATE.key -x509 -days 365 -out YOURPUBLIC.pem -subj <span class="hljs-string">"/C=US/ST=New York/L=Brooklyn/O=Example Brooklyn Company/CN=YOURDOMAIN.EXAMPLE"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOURPRIVATE.key est la cl√© priv√©e du certificat. </font><font style="vertical-align: inherit;">Il sera utilis√© dans l' </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
apache YOURPUBLIC.pem - la cl√© publique du certificat. </font><font style="vertical-align: inherit;">Sera utilis√© lors de l'enregistrement d'un webhook </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOURDOMAIN.EXAMPLE - l'adresse de votre domaine avec un webhook. </font><font style="vertical-align: inherit;">Il doit toujours correspondre √† l'adresse du webhook !!! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir ex√©cut√© ce code, les fichiers cl√©s appara√Ætront dans le dossier openssl (j'ai ce "C: \ Program Files \ Apache Software Foundation \ Apache2.2 \ bin"). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je les ai copi√©s dans le dossier conf Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons √† la configuration d'Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai vu de nombreuses fa√ßons diff√©rentes. </font><font style="vertical-align: inherit;">Les √©l√©ments suivants ont fonctionn√© pour moi: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
les lignes suivantes ont √©t√© ajout√©es √† httpd.conf:</font></font><br>
<br>
<pre><code class="bash hljs">Listen 443 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
afin que l'Apache ¬´√©coute¬ª le port 443. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bloc &lt;IfModule ssl_module&gt; a la forme suivante:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-section">&lt;IfModule ssl_module&gt;</span>
<span class="hljs-attribute">SSLMutex</span> default
<span class="hljs-attribute">SSLSessionCache</span> none
<span class="hljs-section">&lt;/IfModule&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la toute fin, des lignes sont ajout√©es o√π j'indique le chemin vers le certificat:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">SSLEngine</span> <span class="hljs-literal">On</span>
<span class="hljs-attribute">SSLCertificateFile</span> conf/YOURPUBLIC.pem
<span class="hljs-attribute">SSLCertificateKeyFile</span> conf/YOURPRIVATE.key</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et d√©commentez la ligne: </font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup">LoadModule</span></span> ssl_module modules/mod_ssl.so </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la configuration, nous cr√©ons un service HTTP. </font><font style="vertical-align: inherit;">Ce sera lui qui r√©pondra au t√©l√©gramme et traitera ses appels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon cas, les param√®tres suivants sont sp√©cifi√©s: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nom: TGWebhuk RootURL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
r√©utilisation de session </font><font style="vertical-align: inherit;">webhook </font><font style="vertical-align: inherit;">: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne pas utiliser</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (cela ne fonctionnait pas avec le mode automatique) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dur√©e de vie: 20 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mod√®les d'URL: Tout mod√®le a √©t√© cr√©√© avec deux m√©thodes: les </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fec/3a5/73f/fec3a573f980da4642b834dba5b66f12.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e74/a19/2ef/e74a192eff11c8495c6088c7f0e8c7da.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/16c/bb0/871/16cbb087152b6a436da920423b793266.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gestionnaires de </font><font style="vertical-align: inherit;">m√©thodes GET et POST </font><font style="vertical-align: inherit;">sont cr√©√©s d√©faut. </font><font style="vertical-align: inherit;">Je vais ajouter ce qui suit au gestionnaire POST, juste pour v√©rifier la connexion:</font></font><br>
<br>
<pre><code class="1c hljs"><span class="hljs-function"><span class="hljs-keyword"></span> <span class="hljs-title">POST</span>(<span class="hljs-params"></span></span>)<font></font>
<font></font>
	(<span class="hljs-string">""</span>); <span class="hljs-comment">//chat_id</span>
	 = <span class="hljs-keyword"></span> <span class="hljs-type">HTTP</span>(<span class="hljs-number">200</span>);
	<span class="hljs-keyword"></span> ;<font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword"></span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">&amp;<span class="hljs-meta-keyword"></span></span>
<span class="hljs-function"><span class="hljs-keyword"></span> <span class="hljs-title"></span>(<span class="hljs-params"></span></span>)<font></font>
	<font></font>
		 = <span class="hljs-string">" "</span>;<font></font>
		 = <span class="hljs-string">""</span>;<span class="hljs-comment">//  telegram</span>
		 = <span class="hljs-string">"api.telegram.org"</span>;<font></font>
	     = <span class="hljs-string">"bot"</span> +  + <span class="hljs-string">"/sendMessage?chat_id="</span> + <span class="hljs-built_in"></span>(<span class="hljs-built_in"></span>(, <span class="hljs-string">"=; =; =."</span>), <span class="hljs-string">"."</span>, <span class="hljs-string">""</span>) + <span class="hljs-string">"&amp;text="</span> + ;<font></font>
   		  =  <span class="hljs-keyword"></span> <span class="hljs-type">HTTP</span>(,<span class="hljs-number">443</span>,,,,,<span class="hljs-keyword"></span> <span class="hljs-type">OpenSSL</span>());
		<span class="hljs-type"></span> = <span class="hljs-keyword"></span> <span class="hljs-type">HTTP</span>();<font></font>
		 = .(<span class="hljs-type"></span>);<font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword"></span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste √† publier la base de donn√©es et √† joindre le webhook. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La publication se fait comme toujours, il vous suffit d'ajouter des coches √† la publication du service HTTP: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c94/684/b21/c94684b2199e466765bafb47912798c1.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme derni√®re √©tape, nous attacherons notre 1C au t√©l√©gramme. </font><font style="vertical-align: inherit;">Pour cela, j'ai utilis√© une simple page html avec le code suivant:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"https://api.telegram.org/bot&lt;&gt;/setwebhook"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span><font></font>
    Select Certificate to upload:<font></font>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"certificate"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileToUpload"</span>&gt;</span>
	URL: <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span>  <span class="hljs-attr">value</span>=<span class="hljs-string">"https://&lt;YOURWEBSITE&gt;/&lt;YOUR_PHP_URL&gt;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Upload Certificate"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"submit"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le formulaire, s√©lectionnez simplement la cl√© publique et entrez le chemin d'acc√®s complet √† notre service http. </font><font style="vertical-align: inherit;">Je vous rappelle que le chemin complet vers le service ressemblera √† ceci: </font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YourDomain / BaseName / hs / ServiceName / v1</font></font></a><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Veuillez ne pas lancer le code, certaines choses sont intentionnellement effectu√©es par hardcode, car </font><font style="vertical-align: inherit;">tout cela a √©t√© fait uniquement √† des fins de d√©monstration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La publication a √©t√© √©crite parce que </font><font style="vertical-align: inherit;">Je n'ai pas trouv√© un seul exemple de travail sur l'utilisation de webhooks sur le site, √† l'exception du constructeur de bots Telegram. </font><font style="vertical-align: inherit;">Mais il est pay√© et, peut-√™tre, tout le monde n'en a pas besoin sous cette forme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'archive contient l'installation d'Apache 2.2.24 avec Openssl (pour une raison quelconque, il m'a fallu beaucoup de temps pour le trouver), un fichier html pour enregistrer un hook Web, un fichier de configuration Apache et une configuration cf avec un service http et un exemple d'envoi d'un message de test. </font><font style="vertical-align: inherit;">Le t√©l√©chargement est facultatif, car </font><font style="vertical-align: inherit;">tout le contenu est dans l'article.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488360/index.html">Mythes du Big Data et culture num√©rique</a></li>
<li><a href="../fr488362/index.html">Classification multi-tagu√©e</a></li>
<li><a href="../fr488366/index.html">Et encore une fois sur ¬´Informations de fuseau horaire incorrectes pour les fuseaux horaires russes¬ª [bogue .Net, ID: 693286]</a></li>
<li><a href="../fr488368/index.html">Ce que j'ai appris en travaillant sur mon premier projet √† grande √©chelle</a></li>
<li><a href="../fr488370/index.html">TDD pour microcontr√¥leurs. Partie 2: Comment les espions se d√©barrassent des d√©pendances</a></li>
<li><a href="../fr488376/index.html">Quand le principe "au diable tout, prenez-le et faites-le!" ne fonctionne pas: notes du procrastinateur</a></li>
<li><a href="../fr488378/index.html">En bref sur la d√©nomination dans JS</a></li>
<li><a href="../fr488380/index.html">Le d√©but le plus simple de la STM gr√¢ce √† ¬´un seul endroit¬ª</a></li>
<li><a href="../fr488382/index.html">J'ajoute un d√©lai de 3 √† 25 secondes aux sites que je visite</a></li>
<li><a href="../fr488386/index.html">Cas d'application des outils d'analyse d'anomalies de r√©seau: attaques via des plug-ins de navigateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>