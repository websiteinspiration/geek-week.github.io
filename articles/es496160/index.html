<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐅 🤘🏾 🤛🏼 Estudiamos el motor VoIP Mediastreamer2. Parte 5 🎋 😐 🧛🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Material del artículo tomado de mi canal zen .
 


 Detector de tono
 

En el último artículo, creamos un medidor de nivel de señal. En esto aprendere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Estudiamos el motor VoIP Mediastreamer2. Parte 5</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496160/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Material del artículo tomado de mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">canal zen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br>
<p><img src="https://habrastorage.org/webt/qy/mv/pc/qymvpcmoqpjjqvi424d2qr115bo.png"></p><br>
<h2 id="obnaruzhitel-tonalnogo-signala"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detector de tono</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el último </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artículo,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> creamos un medidor de nivel de señal. </font><font style="vertical-align: inherit;">En esto aprenderemos cómo detectar un tono.</font></font></p><br>
<p><img src="https://habrastorage.org/webt/61/d3/n0/61d3n01a4dbuziztcf2odnvu8yq.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En los viejos tiempos, cuando no todas las familias tenían un televisor, y la mitad de ellos cambiaban los canales con la ayuda de unos alicates, en las revisiones de la prensa técnica extranjera había noticias interesantes de que uno de los fabricantes de televisores equipaba sus dispositivos con un control remoto inalámbrico. Por los detalles se sabía que el control remoto funciona sin baterías debido al uso de un enfoque inusual: el control remoto era mecánico y era un híbrido de un instrumento musical, un metalófono y un revólver. El tambor del revólver contenía cilindros metálicos de diferentes longitudes, y cuando el golpeador golpeó uno de ellos, el cilindro comenzó a sonar a su propia frecuencia. Presumiblemente en ultrasonido. La electrónica del televisor escuchó esta señal y, habiendo determinado su frecuencia, realizó la acción correspondiente: cambiar el canal, cambiar el volumen,apagar la televisión.</font></font></p><br>
<p>        ,    . </p><a name="habracut"></a><br>
<p>  ,      .               ,       .  ,      6 ,      / ,  , / .     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">MSToneDetectorDef</span>{</span>  
     <span class="hljs-keyword">char</span> tone_name[<span class="hljs-number">8</span>];     
     <span class="hljs-keyword">int</span> frequency; <span class="hljs-comment">/**&lt;Expected frequency of the tone*/</span> 
     <span class="hljs-keyword">int</span> min_duration; <span class="hljs-comment">/**&lt;Min duration of the tone in milliseconds */</span> 
     <span class="hljs-keyword">float</span> min_amplitude; <span class="hljs-comment">/**&lt;Minimum amplitude of the tone, 1.0 corresponding to the normalized 0dbm level */</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">MSToneDetectorDef</span> <span class="hljs-title">MSToneDetectorDef</span>;</span></code></pre><br>
<p>   10  ,           .          .       MS_TONE_DETECTOR_ADD_SCAN.</p><br>
<p>      ,          ,       ,      .      <em>ms_filter_set_notify_callback()</em>.        ,     ,   ,         ( ).</p><br>
<p>        ,    ,  ,    :</p><br>
<pre><code class="cpp hljs">
<span class="hljs-comment">/** * Structure carried as argument of the MS_TONE_DETECTOR_EVENT**/</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">MSToneDetectorEvent</span>{</span> 
      <span class="hljs-keyword">char</span> tone_name[<span class="hljs-number">8</span>];       <span class="hljs-comment">/*         . */</span>
      <span class="hljs-keyword">uint64_t</span> tone_start_time;   <span class="hljs-comment">/*   ,    . */</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">MSToneDetectorEvent</span> <span class="hljs-title">MSToneDetectorEvent</span>;</span>
</code></pre><br>
<p>       .</p><br>
<p>       .</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*  mstest4.c     . */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/msfilter.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/msticker.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/dtmfgen.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/mssndcard.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/msvolume.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/mstonedetector.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">/*       
 * . */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/mseventqueue.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">/*   ,    ,   
 *       . */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tone_detected_cb</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *data, MSFilter *f, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> event_id,
        MSToneDetectorEvent *ev)</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"                       : %s\n"</span>, ev-&gt;tone_name);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    ms_init();<font></font>
<font></font>
    <span class="hljs-comment">/*   . */</span><font></font>
    MSFilter  *voidsource = ms_filter_new(MS_VOID_SOURCE_ID);<font></font>
    MSFilter  *dtmfgen = ms_filter_new(MS_DTMF_GEN_ID);<font></font>
    MSFilter  *volume = ms_filter_new(MS_VOLUME_ID);<font></font>
    MSSndCard *card_playback =<font></font>
        ms_snd_card_manager_get_default_card(ms_snd_card_manager_get());<font></font>
    MSFilter  *snd_card_write = ms_snd_card_create_writer(card_playback);<font></font>
    MSFilter  *detector = ms_filter_new(MS_TONE_DETECTOR_ID);<font></font>
<font></font>
    <span class="hljs-comment">/*      ,  
     *    .*/</span>
    ms_filter_call_method(detector, MS_TONE_DETECTOR_CLEAR_SCANS, <span class="hljs-number">0</span>);<font></font>
<font></font>
    <span class="hljs-comment">/*    - . */</span><font></font>
    MSTicker *ticker=ms_ticker_new();<font></font>
<font></font>
    <span class="hljs-comment">/*    . */</span>
    ms_filter_link(voidsource, <span class="hljs-number">0</span>, dtmfgen, <span class="hljs-number">0</span>);<font></font>
    ms_filter_link(dtmfgen, <span class="hljs-number">0</span>, volume, <span class="hljs-number">0</span>);<font></font>
    ms_filter_link(volume, <span class="hljs-number">0</span>, detector, <span class="hljs-number">0</span>);<font></font>
    ms_filter_link(detector, <span class="hljs-number">0</span>, snd_card_write, <span class="hljs-number">0</span>);<font></font>
<font></font>
    <span class="hljs-comment">/*      . */</span><font></font>
    ms_filter_set_notify_callback(detector,<font></font>
            (MSFilterNotifyFunc)tone_detected_cb, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
    <span class="hljs-comment">/*   . */</span><font></font>
    ms_ticker_attach(ticker,voidsource);<font></font>
<font></font>
    <span class="hljs-comment">/*  ,     
     *   ,   :  
     *  ,   ,   ,
     *    0,775. */</span>  
    MSToneDetectorDef  scan[<span class="hljs-number">6</span>]=<font></font>
    {<font></font>
        {<span class="hljs-string">"V+"</span>,  <span class="hljs-number">440</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}, <span class="hljs-comment">/*  " ". */</span>
        {<span class="hljs-string">"V-"</span>,  <span class="hljs-number">540</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}, <span class="hljs-comment">/*  " ". */</span>
        {<span class="hljs-string">"C+"</span>,  <span class="hljs-number">640</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}, <span class="hljs-comment">/*  "  ". */</span>
        {<span class="hljs-string">"C-"</span>,  <span class="hljs-number">740</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}, <span class="hljs-comment">/*  "  ". */</span>
        {<span class="hljs-string">"ON"</span>,  <span class="hljs-number">840</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}, <span class="hljs-comment">/*  " ". */</span>
        {<span class="hljs-string">"OFF"</span>, <span class="hljs-number">940</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0.1</span>}  <span class="hljs-comment">/*  " ". */</span><font></font>
    };<font></font>
<font></font>
    <span class="hljs-comment">/*      . */</span>
    <span class="hljs-keyword">int</span> i;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++)<font></font>
    {<font></font>
        ms_filter_call_method(detector, MS_TONE_DETECTOR_ADD_SCAN,<font></font>
                &amp;scan[i]);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/*  ,    .*/</span><font></font>
    MSDtmfGenCustomTone dtmf_cfg;<font></font>
    dtmf_cfg.tone_name[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<font></font>
    dtmf_cfg.duration = <span class="hljs-number">1000</span>;<font></font>
    dtmf_cfg.frequencies[<span class="hljs-number">0</span>] = <span class="hljs-number">440</span>;
    <span class="hljs-comment">/*    ,      0.*/</span>
    dtmf_cfg.frequencies[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<font></font>
    dtmf_cfg.amplitude = <span class="hljs-number">1.0</span>;<font></font>
    dtmf_cfg.interval = <span class="hljs-number">0.</span>;<font></font>
    dtmf_cfg.repeat_count = <span class="hljs-number">0.</span>;<font></font>
<font></font>
    <span class="hljs-comment">/*     .   
     *    . */</span>
    <span class="hljs-keyword">char</span> key=<span class="hljs-string">'9'</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  ,  .\n"</span>
        <span class="hljs-string">"    0.\n"</span>);
    <span class="hljs-keyword">while</span>(key != <span class="hljs-string">'0'</span>)<font></font>
    {<font></font>
        key = getchar();<font></font>
        <span class="hljs-keyword">if</span> ((key &gt;= <span class="hljs-number">49</span>) &amp;&amp; (key &lt;= <span class="hljs-number">54</span>))<font></font>
        {<font></font>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">" : %c\n"</span>, key);
            <span class="hljs-comment">/*      
             *   .*/</span>
            dtmf_cfg.frequencies[<span class="hljs-number">0</span>] = <span class="hljs-number">440</span> + <span class="hljs-number">100</span>*(key<span class="hljs-number">-49</span>);<font></font>
<font></font>
            <span class="hljs-comment">/*    c  . */</span><font></font>
            ms_filter_call_method(dtmfgen, MS_DTMF_GEN_PLAY_CUSTOM,<font></font>
                    (<span class="hljs-keyword">void</span>*)&amp;dtmf_cfg);<font></font>
        }<font></font>
        ms_usleep(<span class="hljs-number">20000</span>);<font></font>
    }<font></font>
}</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilamos y ejecutamos el programa. </font><font style="vertical-align: inherit;">Si todo funciona correctamente, luego de comenzar deberíamos obtener algo como esto:</font></font></p><br>
<pre><code class="cpp hljs">$ ./mstest4<font></font>
ALSA lib conf.c:<span class="hljs-number">4738</span>:(snd_config_expand) Unknown parameters <span class="hljs-number">0</span>
ALSA lib control.c:<span class="hljs-number">954</span>:(snd_ctl_open_noupdate) Invalid CTL <span class="hljs-keyword">default</span>:<span class="hljs-number">0</span>
ortp-warning-Could <span class="hljs-keyword">not</span> attach mixer to card: Invalid argument<font></font>
ALSA lib conf.c:<span class="hljs-number">4738</span>:(snd_config_expand) Unknown parameters <span class="hljs-number">0</span>
ALSA lib pcm.c:<span class="hljs-number">2266</span>:(snd_pcm_open_noupdate) Unknown PCM <span class="hljs-keyword">default</span>:<span class="hljs-number">0</span>
ALSA lib conf.c:<span class="hljs-number">4738</span>:(snd_config_expand) Unknown parameters <span class="hljs-number">0</span>
ALSA lib pcm.c:<span class="hljs-number">2266</span>:(snd_pcm_open_noupdate) Unknown PCM <span class="hljs-keyword">default</span>:<span class="hljs-number">0</span>
ortp-warning-Strange, sound card Intel <span class="hljs-number">82801</span>AA-ICH does <span class="hljs-keyword">not</span> seems to be capable of anything, retrying with plughw...<font></font>
  ,  .<font></font>
    <span class="hljs-number">0.</span>
ortp-warning-alsa_set_params: periodsize:<span class="hljs-number">256</span> Using <span class="hljs-number">256</span>
ortp-warning-alsa_set_params: period:<span class="hljs-number">8</span> Using <span class="hljs-number">8</span>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presione cualquier tecla de "1" a "6", confirmando con la tecla "Enter", debería obtener algo como este listado:</font></font></p><br>
<pre><code class="cpp hljs">
<span class="hljs-number">2</span>
 : <span class="hljs-number">2</span><font></font>
                       : V-<font></font>
<span class="hljs-number">1</span>
 : <span class="hljs-number">1</span><font></font>
                       : V+<font></font>
<span class="hljs-number">3</span>
 : <span class="hljs-number">3</span><font></font>
                       : C+<font></font>
<span class="hljs-number">4</span>
 : <span class="hljs-number">4</span><font></font>
                       : C-<font></font>
<span class="hljs-number">0</span>
$</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vemos que los tonos de comando se envían con éxito y el detector los detecta.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el próximo artículo, pasaremos a transmitir una señal de sonido a través de una red Ethernet utilizando el protocolo RTP e inmediatamente la aplicaremos en nuestro control remoto.</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496146/index.html">Lua en STM32</a></li>
<li><a href="../es496148/index.html">Patrones de diseño estructural en ES6 + en el ejemplo de Game of Thrones</a></li>
<li><a href="../es496152/index.html">Automatización de redes. Caso de la vida</a></li>
<li><a href="../es496154/index.html">Automatización de servicio al cliente: una solución integral de DeepPavlov</a></li>
<li><a href="../es496156/index.html">Cómo los sistemas de análisis de tráfico detectan tácticas de piratas informáticos por MITER ATT & CK, Parte 3</a></li>
<li><a href="../es496162/index.html">Terraform, mono repositorios y cumplimiento como código</a></li>
<li><a href="../es496164/index.html">Durante la crisis perdí mi trabajo y ahora tengo miedo de escribir código inteligente para no asustar las últimas vacantes</a></li>
<li><a href="../es496166/index.html">Doctrine ResultSetMapping con ejemplos</a></li>
<li><a href="../es496170/index.html">Estamos condenados # 1 // Udalenka en crisis y muerte de originalidad</a></li>
<li><a href="../es496174/index.html">Aumento de la demanda de análisis, equipos de productos, Amazon, Israel, Singapur, trabajo remoto, etc., se discutió mucho.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>