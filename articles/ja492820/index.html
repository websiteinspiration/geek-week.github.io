<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¦… â™¿ï¸ ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ .Net Core APIï¼šã•ã¾ã–ã¾ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ‘¨â€ğŸ¤ ğŸ§™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=".Net Coreã«ã¯çµ„ã¿è¾¼ã¿ã®ãƒ¢ãƒ‡ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãŒã‚ã‚Šã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹ã ã‘ã§ãªãã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¥åŠ›ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ãã«å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã‚’ä½¿ç”¨ã—ã¦ã€å¿…è¦ãªã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>.Net Core APIï¼šã•ã¾ã–ã¾ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492820/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.Net Coreã«ã¯çµ„ã¿è¾¼ã¿ã®ãƒ¢ãƒ‡ãƒ«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãŒã‚ã‚Šã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹ã ã‘ã§ãªãã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¥åŠ›ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã™ãã«å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã‚’ä½¿ç”¨ã—ã¦ã€å¿…è¦ãªã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚Queryã‚„Bodyã‹ã‚‰ã ã‘ã§ãªãã€ã“ã“ã‹ã‚‰ã‚‚å…¥æ‰‹ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å—ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆç§ã®å ´åˆã€base64ã«jsonãŒã‚ã‚Šã¾ã—ãŸï¼‰ã€‚RESTã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¾ãŸã¯ActionRouteã‹ã‚‰å—ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">Bindingã‚’ä½¿ç”¨ã—ã¦ã€ãã“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ç¢ºã‹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã‚«ãƒ—ã‚»ãƒ«åŒ–ã‚’è§£é™¤ã›ãšã«ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä»‹ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’åˆæœŸåŒ–ã™ã‚‹å ´åˆã¯ã€ã‚·ãƒ£ãƒ¼ãƒãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§è‡ªèº«ã¨å°†æ¥ã®ä¸–ä»£ã®ãŸã‚ã«ã€ç§ã¯ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¨ã‚·ãƒ£ãƒ¼ãƒãƒ‹ã‚ºãƒ ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æŒ‡ç¤ºã®ã‚ˆã†ãªã‚‚ã®ã‚’æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•é¡Œ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬çš„ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">HttpGet</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetSomeData</span>(<span class="hljs-params">[FromQuery[IncomeData someData</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(<span class="hljs-string">"X-Property"</span>);
    <span class="hljs-keyword">if</span> (moreData.Id == <span class="hljs-number">0</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> StatusCode(<span class="hljs-number">400</span>, <span class="hljs-string">"Nginx doesnt know your id"</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">var</span> externalData = GetFromExternalService(<span class="hljs-string">"http://myservice.com/MoreData"</span>);
    <span class="hljs-keyword">if</span> (externalData == <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> StatusCode(<span class="hljs-number">500</span>, <span class="hljs-string">"Cant connect to external service"</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">var</span> finalData = <span class="hljs-keyword">new</span> FinalData(someData, moreData, externalData);
    <span class="hljs-keyword">return</span> _myService.Handle(finalData);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®çµæœã€æ¬¡ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€è¦æ±‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã®è¦æ±‚ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®è¦æ±‚ãƒ¡ã‚½ãƒƒãƒ‰ã€ãŠã‚ˆã³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦å¡—ã‚Šã¤ã¶ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">å¿…è¦ãªãƒã‚§ãƒƒã‚¯ãŒç¢ºå®Ÿã«ãã“ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€å®Œå…¨ãªèª¿æŸ»ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éš£æ¥ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã¾ã£ãŸãåŒã˜ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ”»æ’ƒã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šå¸¸ã€ä¾‹ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«å¤šãã®ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ãŸã‚ã€çµæœã¨ã—ã¦ã€å”¯ä¸€ã®é‡è¦ãªè¡Œï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—ï¼‰ãŒã‚³ãƒ¼ãƒ‰ã®ãƒ’ãƒ¼ãƒ—ã«éš ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">å½¼ã‚’è¦‹ã¦ã€ã“ã“ã§ä¸€èˆ¬çš„ã«ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹ã«ã¯ã€ã‚ã‚‹ç¨‹åº¦ã®åŠªåŠ›ãŒå¿…è¦ã§ã™ã€‚</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å•é¡Œã®ä¸€éƒ¨ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€æœ€åˆã«æœ€çµ‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã«ã™ãã«æ¸¡ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãšã£ã¨ã‚ˆãè¦‹ãˆã¾ã™ã‚ˆã­ï¼Ÿ</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">HttpGet</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetSomeData</span>(<span class="hljs-params">[FromQuery]FinalData finalData</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">return</span> _myService.Handle(finalData);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ã‚¿ã‚¤ãƒ—MoreDataã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinder</span> : <span class="hljs-title">IModelBinder</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
        <span class="hljs-keyword">if</span> (moreData != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            bindingContext.Result = ModelBindingResult.Success(moreData);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> MoreData <span class="hljs-title">GetFromHeaderAndDecode</span>(<span class="hljs-params">IHeaderDictionary headers</span>)</span> { ... }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã«ã€FinalDataãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦ä¿®æ­£ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FinalData</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> SomeDataNumber { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> SomeDataText { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    [<span class="hljs-meta">ModelBinder(BinderType = typeof(MoreDataBinder))</span>]
    <span class="hljs-keyword">public</span> MoreData MoreData { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚‚ã†è‰¯ã„ã§ã™ãŒã€ç—”ãŒå¢—ãˆã¾ã—ãŸã€‚ç‰¹åˆ¥ãªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚Šã€ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§ãã‚Œã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ãã‚Œã¯è§£æ±ºå¯èƒ½ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BinderProviderã‚’ä½œæˆã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinderProvider</span> : <span class="hljs-title">IModelBinderProvider</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IModelBinder <span class="hljs-title">GetBinder</span>(<span class="hljs-params">ModelBinderProviderContext context</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> modelType = context.Metadata.UnderlyingOrModelType;
        <span class="hljs-keyword">if</span> (modelType == <span class="hljs-keyword">typeof</span>(MoreData))<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinderTypeModelBinder(<span class="hljs-keyword">typeof</span>(MoreDataBinder));<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã«ç™»éŒ²ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
{<font></font>
    services.AddControllers();<font></font>
    services.AddMvc(options =&gt;<font></font>
    {<font></font>
        options.ModelBinderProviders.Insert(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> MoreDataBinderProvider());<font></font>
     });<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ã€ã‚­ãƒ¥ãƒ¼ã®é †åºã§å„ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒç›®çš„ã®ã‚¿ã‚¤ãƒ—ã‚’æº€ãŸã—ã¦ã„ã‚‹å ´åˆã¯ã€ç›®çš„ã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒè¿”ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã†ã§ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒæ©Ÿèƒ½ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€MoreDataã®ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®šã™ã‚‹ãŸã³ã«ã€ãã‚ŒãŒå–å¾—ã•ã‚Œã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã®ç‰¹åˆ¥ãªå±æ€§ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ã™ã°ã‚‰ã—ã„ã§ã™ãŒã€1ã¤ã ã‘é•ã„ãŒã‚ã‚Šã¾ã™ã€‚é­”æ³•ãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ¢ãƒ‡ãƒ«ã«ã‚»ãƒƒãƒˆã‚’æŒã¤ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¿…è¦ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ã‚«ãƒ—ã‚»ãƒ«åŒ–ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</font><font style="vertical-align: inherit;">ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ã•ã¾ã–ã¾ãªå ´æ‰€ã«è»¢é€ã—ã€ãã‚Œã‚‰ãŒãã“ã§å¤‰æ›´ã•ã‚Œãªã„ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å•é¡Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒãªã„ãƒ¢ãƒ‡ãƒ«ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒæ©Ÿèƒ½ã—ãªã„ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ä½•ãŒåŸå› ã§ç§ãŸã¡ãŒè‡ªåˆ†ã§æ›¸ãã“ã¨ãŒã§ããªã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã¯RESTã‚’ä½¿ç”¨ã›ãšã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯Queryã¨Bodyã‚’ä»‹ã—ã¦ã®ã¿é€ä¿¡ã•ã‚Œã€Get </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ã¨Postã®</font><font style="vertical-align: inherit;">2ç¨®é¡ã®ã‚¯ã‚¨ãƒªã®ã¿ãŒä½¿ç”¨ã•ã‚Œ</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€REST APIã®å ´åˆã€å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã¯å°‘ã—ç•°ãªã‚Šã¾ã™ã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€èˆ¬ã«ã€ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œãªã„ã¾ã¾ã§ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åŸ‹ã‚ã‚‹ã‚ˆã†ã«ã€ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã ã‘ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€ç§ã¯èˆˆå‘³ã®ãªã„ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã®ã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¾ã™-çŒ«ã®ä¸‹ã®è¨˜äº‹ã®æœ€å¾Œã«ã‚¯ãƒ©ã‚¹ã®å®Œå…¨ãªãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã«ã€MoreDataãŒã‚¯ãƒ©ã‚¹ã®å”¯ä¸€ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</font><font style="vertical-align: inherit;">ã¯ã„ã®å ´åˆã¯ã€è‡ªåˆ†ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆhelloã€Activatorï¼‰ã€‚ãã†ã§ãªã„å ´åˆã¯ã€JsonConvertãŒå®Œå…¨ã«æ©Ÿèƒ½ã—ã€å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æŒ¿å…¥ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">NeedActivator</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
    <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name).Distinct().Count() == <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bodyã‚’ä½¿ç”¨ã—ãŸã‚¯ã‚¨ãƒªã®å ´åˆã€JsonConvertã«ã‚ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¯ç°¡å˜ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromBody(ModelBindingContext bindingContext, Type modelType)<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> StreamReader(bindingContext.HttpContext.Request.Body);
    <span class="hljs-keyword">var</span> jsonString = reader.ReadToEnd();
    <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonString, modelType);
    <span class="hljs-keyword">return</span> data;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ã‹ã—ã€ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€æ¨ªã«ãªã‚‰ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">èª°ã‹ãŒã‚‚ã£ã¨ç¾ã—ã„è§£æ±ºç­–ã‚’ææ¡ˆã§ããŸã‚‰ã†ã‚Œã—ã„ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é…åˆ—ã‚’æ¸¡ã™ã¨ã€åŒã˜åå‰ã®ã„ãã¤ã‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒå–å¾—ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ•ãƒ©ãƒƒãƒˆå‹ã¸ã®ã‚­ãƒ£ã‚¹ãƒˆã¯å½¹ç«‹ã¡ã¾ã™ãŒã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¯é…åˆ—[]ã«ä½™åˆ†ãªå¼•ç”¨ç¬¦ã‚’ä»˜ã‘ã‚‹ãŸã‚ã€æ‰‹å‹•ã§å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromQuery(ModelBindingContext bindingContext, Type modelType)<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> valuesDictionary = QueryHelpers.ParseQuery(bindingContext.HttpContext.Request.QueryString.Value);
    <span class="hljs-keyword">var</span> jsonDictionary = valuesDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value.Count &lt; <span class="hljs-number">2</span> ? pair.Value.ToString() : <span class="hljs-string">$"[<span class="hljs-subst">{pair.Value}</span>]"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> jsonStr = JsonConvert.SerializeObject(jsonDictionary).Replace(<span class="hljs-string">"\"["</span>, <span class="hljs-string">"["</span>).Replace(<span class="hljs-string">"]\""</span>, <span class="hljs-string">"]"</span>);
    <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonStr, modelType);
    <span class="hljs-keyword">return</span> data;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">è¨˜äº‹ã®å†’é ­ã§ç§ãŒè©±ã—ãŸã®ã¯ã€ã“ã®ã‚·ãƒ£ãƒ¼ãƒãƒ‹ã‚ºãƒ ã«ã¤ã„ã¦ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ç§ã¯ã“ã®è§£æ±ºç­–ã‚’</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§</font><font style="vertical-align: inherit;">è¦‹ã¤ã‘ã¾ã—</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ãŸ</font></a><font style="vertical-align: inherit;">ã€ãã‚Œã«å¯¾ã—ã¦è‘—è€…ã«æ„Ÿè¬ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ForceSetValue</span>(<span class="hljs-params">PropertyInfo propertyInfo, <span class="hljs-keyword">object</span> obj, <span class="hljs-keyword">object</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> propName = <span class="hljs-string">$"&lt;<span class="hljs-subst">{propertyInfo.Name}</span>&gt;k__BackingField"</span>;
    <span class="hljs-keyword">var</span> propFlags = BindingFlags.Instance | BindingFlags.NonPublic;<font></font>
            <font></font>
    obj.GetType().GetField(propName, propFlags)?.SetValue(obj, <span class="hljs-keyword">value</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã†ã§ã™ã­ã€ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’1å›ã®å‘¼ã³å‡ºã—ã§çµ„ã¿åˆã‚ã›ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
    <span class="hljs-keyword">if</span> (moreData == <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> modelType = bindingContext.ModelMetadata.UnderlyingOrModelType;
    <span class="hljs-keyword">if</span> (NeedActivator(modelType))<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> data = Activator.CreateInstance(modelType, moreData);<font></font>
        bindingContext.Result = ModelBindingResult.Success(data);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> model = bindingContext.HttpContext.Request.Method == <span class="hljs-string">"GET"</span><font></font>
                            ? GetModelFromQuery(bindingContext, modelType)<font></font>
                            : GetModelFromBody(bindingContext, modelType);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"  "</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> ignoreCase = StringComparison.InvariantCultureIgnoreCase;
    <span class="hljs-keyword">var</span> dataProperty = modelType.GetProperties()<font></font>
                            .FirstOrDefault(p =&gt; p.Name.Equals(<span class="hljs-keyword">typeof</span>(T).Name, ignoreCase));<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (dataProperty != <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        ForceSetValue(dataProperty, model, moreData);<font></font>
    }<font></font>
<font></font>
    bindingContext.Result = ModelBindingResult.Success(model);<font></font>
    <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BinderProviderã‚’ä¿®æ­£ã—ã¦ã€å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã«å¿œç­”ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinderProvider</span> : <span class="hljs-title">IModelBinderProvider</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IModelBinder <span class="hljs-title">GetBinder</span>(<span class="hljs-params">ModelBinderProviderContext context</span>)</span><font></font>
    {<font></font>
       <span class="hljs-keyword">var</span> modelType = context.Metadata.UnderlyingOrModelType;
       <span class="hljs-keyword">if</span> (HasDataProperty(modelType))<font></font>
       {<font></font>
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinderTypeModelBinder(<span class="hljs-keyword">typeof</span>(PrivateDataBinder&lt;MoreData&gt;));<font></font>
       }<font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">HasDataProperty</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
        <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name) .Contains(<span class="hljs-keyword">nameof</span>(MoreData));<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã‚Œã§å…¨éƒ¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¯ã€ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚ˆã‚Šã‚‚å°‘ã—è¤‡é›‘ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸãŒã€ä»Šã§ã¯ã€è¿½åŠ ã®ä½œæ¥­ãªã—ã§ã€ã™ã¹ã¦ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã€Œå¤–éƒ¨ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒã‚¤ãƒ³ãƒ‰ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒã‚¤ãƒŠã‚¹ã®ï¼š</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã¯ã€[JsonConstrustor]å±æ€§ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯ã«å®Œå…¨ã«é©åˆã—ã€ãã®çŸ¥è¦šã‚’å¦¨ã’ã¾ã›ã‚“ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã©ã“ã‹ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã§ã¯ãªãMoreDataã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ã“ã‚Œã¯åˆ¥ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ¼ãƒ ã®ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã€é­”æ³•ã®å­˜åœ¨ã‚’èªè­˜ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯äººé¡ã‚’æ•‘ã„ã¾ã™ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµæœã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®å®Œå…¨ãªãƒªã‚¹ãƒˆã¯ã“ã“ã«ã‚ã‚Šã¾ã™ï¼š</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrivateMoreDataBinder.cs</font></font></b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PrivateDataBinder</span>&lt;T&gt; : <span class="hljs-title">IModelBinder</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span><span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="bindingContext"&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
            <span class="hljs-keyword">if</span> (moreData == <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> modelType = bindingContext.ModelMetadata.UnderlyingOrModelType;
            <span class="hljs-keyword">if</span> (NeedActivator(modelType))<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> data = Activator.CreateInstance(modelType, moreData);<font></font>
                bindingContext.Result = ModelBindingResult.Success(data);<font></font>
<font></font>
                <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> model = bindingContext.HttpContext.Request.Method == <span class="hljs-string">"GET"</span><font></font>
                            ? GetModelFromQuery(bindingContext, modelType)<font></font>
                            : GetModelFromBody(bindingContext, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"  "</span>);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> ignoreCase = StringComparison.InvariantCultureIgnoreCase;
            <span class="hljs-keyword">var</span> dataProperty = modelType.GetProperties()<font></font>
                                        .FirstOrDefault(p =&gt; p.Name.Equals(<span class="hljs-keyword">typeof</span>(T).Name, ignoreCase));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (dataProperty != <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                ForceSetValue(dataProperty, model, moreData);<font></font>
            }<font></font>
<font></font>
            bindingContext.Result = ModelBindingResult.Success(model);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromQuery(ModelBindingContext bindingContext,<font></font>
                                                 Type modelType)<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> valuesDictionary = QueryHelpers.ParseQuery(bindingContext.HttpContext.Request.QueryString.Value);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> jsonDictionary = valuesDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value.Count &lt; <span class="hljs-number">2</span> ? pair.Value.ToString() : <span class="hljs-string">$"[<span class="hljs-subst">{pair.Value}</span>]"</span>);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> jsonStr = JsonConvert.SerializeObject(jsonDictionary)<font></font>
                                     .Replace(<span class="hljs-string">"\"["</span>, <span class="hljs-string">"["</span>)<font></font>
                                     .Replace(<span class="hljs-string">"]\""</span>, <span class="hljs-string">"]"</span>);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonStr, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> data;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromBody(ModelBindingContext bindingContext,<font></font>
                                                Type modelType)<font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> StreamReader(bindingContext.HttpContext.Request.Body);
            <span class="hljs-keyword">var</span> jsonString = reader.ReadToEnd();
            <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonString, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> data;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">NeedActivator</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
            <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name).Distinct().Count() == <span class="hljs-number">1</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ForceSetValue</span>(<span class="hljs-params">PropertyInfo propertyInfo, <span class="hljs-keyword">object</span> obj, <span class="hljs-keyword">object</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> propName = <span class="hljs-string">$"&lt;<span class="hljs-subst">{propertyInfo.Name}</span>&gt;k__BackingField"</span>;
            <span class="hljs-keyword">var</span> propFlags = BindingFlags.Instance | BindingFlags.NonPublic;<font></font>
            <font></font>
            obj.GetType().GetField(propName, propFlags)?.SetValue(obj, <span class="hljs-keyword">value</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> T <span class="hljs-title">GetFromHeaderAndDecode</span>(<span class="hljs-params">IHeaderDictionary headers</span>)</span> { <span class="hljs-keyword">return</span> (T)Activator.CreateInstance(<span class="hljs-keyword">typeof</span>(T), <span class="hljs-keyword">new</span> <span class="hljs-keyword">object</span>[] { <span class="hljs-string">"ok"</span> }); }<font></font>
    }<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492806/index.html">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’ãƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ ã‚„ã‚¢ãƒ—ãƒªã®åç›ŠåŒ–ã«ãƒªãƒ³ã‚¯ã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja492808/index.html">éå¸¸ç¯ã‚¹ã‚¤ãƒƒãƒä½ç½®ã‚»ãƒ³ã‚µãƒ¼</a></li>
<li><a href="../ja492810/index.html">[COVID-19]ã‚ãªãŸã®ä»•äº‹ã¯ãƒ”ãƒ¼ã‚¯ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ã“ã¨ã§ã™</a></li>
<li><a href="../ja492812/index.html">OpenVINOã§GANãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™</a></li>
<li><a href="../ja492816/index.html">IntelliJ IDEAã®ãƒ’ãƒ³ãƒˆã¨ã‚³ãƒ„ï¼š4.è¨­å®šã‚’åŒæœŸã—ã¦å…±æœ‰ã™ã‚‹</a></li>
<li><a href="../ja492822/index.html">CSSé–‹ç™ºè€…-ãªãœä¸–ç•Œã¯ãã‚Œã‚‰ã‚’å¿…è¦ã¨ã™ã‚‹ã®ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja492828/index.html">ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸä¸–ç•Œã§ç”Ÿãæ®‹ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja492830/index.html">SameSite =ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Lax-æ—¢ã«Chrome 80ã§å®‰å®šï¼ˆã¾ã èª°ã‚‚ãŒåˆ©ç”¨ã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</a></li>
<li><a href="../ja492832/index.html">i.MX6ã¨Linuxã«åŸºã¥ãç”£æ¥­ç”¨ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãŸã‚ã®IoTã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤</a></li>
<li><a href="../ja492834/index.html">LVMã¨ãƒãƒˆãƒªãƒ§ãƒ¼ã‚·ã‚«ã®å…±é€šç‚¹ã¯ä½•ã§ã™ã‹ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>