<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÆ üë©‚Äçüéì ü§¶ Display 3D graphics on the STM32F407 üëçüèº üõåüèø üçê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, older STMs have decent frequencies and RAM volumes. Well, if so, then why not run 3D-graphics on such controllers? Yes, there is nothing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Display 3D graphics on the STM32F407</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495664/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you know, older STMs have decent frequencies and RAM volumes. </font><font style="vertical-align: inherit;">Well, if so, then why not run 3D-graphics on such controllers? </font><font style="vertical-align: inherit;">Yes, there is nothing easier! </font></font><br>
<img src="https://habrastorage.org/webt/nf/t1/bd/nft1bdhrfz3ygyc1vtgsl15btny.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demo picture</font></font></i><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To display 3D graphics, I connected a 320x240 resolution display to the STM32F4Discovery board based on the STM32F407. </font><font style="vertical-align: inherit;">No, not FSMC - this board has the necessary contacts. </font><font style="vertical-align: inherit;">However, for our experiments, normal ports are enough. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The display is connected like this:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS -&gt; E12</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RST -&gt; E2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RS -&gt; E15</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WR -&gt; E14</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RD -&gt; E13</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D0 -&gt; E4</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1 -&gt; E5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D2 -&gt; E6</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D3 -&gt; E7</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D4 -&gt; E8</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D5 -&gt; E9</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D6 -&gt; E10</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D7 -&gt; E11</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The repository has classes for three different display options (IL9325, SPFD5408, HX8347D). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8r/nf/a7/8rnfa7sl3zsjrkak6hvt5g0ohbu.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appearance</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For drawing 3D-graphics, I once very long ago made some kind of fragment of the OpenGL library of the first version. This is the likeness I attached to the STM32. This library requires 6 bytes per pixel (2 per color and 4 per Z-buffer). The memory of the STM32F407 in this version is only enough for 160x120. Well, then we‚Äôll stretch the image twice vertically and horizontally. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This lesson is able to: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Texture texture with sizes that are multiples of the power of two; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Z-clipping; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Interpolation of the color of the vertices inside the face; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Lighting calculation for eight sources with attenuation adjustment from distance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The procedure for working with the library is as follows:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to initialize the library (it will allocate memory for the screen). </font><font style="vertical-align: inherit;">Then, as with OpenGL, you need to configure the projection matrix and viewport.</font></font><br>
<pre><code class="cpp hljs"> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int32_t</span> WIDTH=<span class="hljs-number">160</span>;<font></font>
 <span class="hljs-keyword">const</span> <span class="hljs-keyword">int32_t</span> HEIGHT=<span class="hljs-number">120</span>;<font></font>
 <span class="hljs-keyword">const</span> <span class="hljs-keyword">float</span> VISIBLE_ANGLE=<span class="hljs-number">60</span>;<font></font>
 <span class="hljs-keyword">const</span> <span class="hljs-keyword">float</span> NEAR_PLANE=<span class="hljs-number">1</span>;<font></font>
 <span class="hljs-keyword">const</span> <span class="hljs-keyword">float</span> FAR_PLANE=<span class="hljs-number">1000</span>;	<font></font>
 <span class="hljs-keyword">float</span> aspect=<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">float</span>&gt;(WIDTH)/<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">float</span>&gt;(HEIGHT);<font></font>
 		<font></font>
 cSGL.Init(WIDTH,HEIGHT);<font></font>
 cSGL.Perspective(VISIBLE_ANGLE,aspect,NEAR_PLANE,FAR_PLANE);<font></font>
 cSGL.SetViewport(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,WIDTH,HEIGHT);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, now you can draw, almost the same way as in OpenGL (for similar commands). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, you can specify a light source:</font></font><br>
<pre><code class="cpp hljs"> cSGL.MatrixMode(CSGL::SGL_MATRIX_MODELVIEW);<font></font>
 cSGL.LoadIdentity();<font></font>
 <span class="hljs-keyword">float</span> l0_position[]={<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>};<font></font>
 <span class="hljs-keyword">float</span> l0_ambient[]={<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>};<font></font>
 <span class="hljs-keyword">float</span> l0_diffuse[]={<span class="hljs-number">0.7</span>,<span class="hljs-number">0.7</span>,<span class="hljs-number">0.7</span>};<font></font>
 <span class="hljs-keyword">float</span> l0_specular[]={<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>};<font></font>
 <span class="hljs-keyword">float</span> l0_shininess[]={<span class="hljs-number">1</span>};<font></font>
 cSGL.Lightfv(CSGL::SGL_LIGHT0,CSGL::SGL_POSITION,l0_position);<font></font>
 cSGL.Lightfv(CSGL::SGL_LIGHT0,CSGL::SGL_AMBIENT,l0_ambient);<font></font>
 cSGL.Lightfv(CSGL::SGL_LIGHT0,CSGL::SGL_DIFFUSE,l0_diffuse);<font></font>
 cSGL.Lightfv(CSGL::SGL_LIGHT0,CSGL::SGL_SPECULAR,l0_specular);<font></font>
 cSGL.Lightfv(CSGL::SGL_LIGHT0,CSGL::SGL_SHININESS,l0_shininess);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can specify the material for the surface:</font></font><br>
<pre><code class="cpp hljs"> <span class="hljs-keyword">float</span> m0_ambient[]={<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>};<font></font>
 <span class="hljs-keyword">float</span> m0_diffuse[]={<span class="hljs-number">0.5</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.5</span>};<font></font>
 <span class="hljs-keyword">float</span> m0_specular[]={<span class="hljs-number">0.5</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.5</span>};<font></font>
 <span class="hljs-keyword">float</span> m0_emission[]={<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>,<span class="hljs-number">0.1</span>};<font></font>
 cSGL.Materialfv(CSGL::SGL_AMBIENT,m0_ambient);<font></font>
 cSGL.Materialfv(CSGL::SGL_DIFFUSE,m0_diffuse);<font></font>
 cSGL.Materialfv(CSGL::SGL_SPECULAR,m0_specular); <font></font>
 cSGL.Materialfv(CSGL::SGL_EMISSION,m0_emission); </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can enable lighting calculation cSGL.Enable (CSGL :: SGL_LIGHTING); and a specific light source cSGL.Enable (CSGL :: SGL_LIGHT0); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Illumination is equally considered for the front and rear. Moreover, I did not cut off the back edges (I rarely need it). But if you want to make it a couple of trifles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating light sources is not necessary. It is quite possible to set the color of the faces yourself using cSGL.Color3f. Color (and color parameters of the material, too) is specified normalized [0..1]; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The texture is connected with the cSGL.BindTexture command. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Please note that the library always uses texturing!</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An array of texture colors is defined as a sequence of four bytes (r, g, b, alpha) and here r, g, b, alpha are numbers from 0 to 255. Strictly speaking, it is precisely these numbers that multiply the intensity of the channels R, G, B specified by glColor3f (or calculated from light sources) when rendering. An array of texture data should be maintained for the entire time the face is displayed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conclusion of the face is as follows:</font></font><br>
<pre><code class="cpp hljs">  <font></font>
  cSGL.Begin();<font></font>
   cSGL.TexCoordf(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);	<font></font>
   cSGL.Vertex3f(x6,y6,z6);<font></font>
   cSGL.TexCoordf(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);	 <font></font>
   cSGL.Vertex3f(x4,y4,z4);<font></font>
   cSGL.TexCoordf(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);	 <font></font>
   cSGL.Vertex3f(x2,y2,z2);<font></font>
  cSGL.End();<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cSGL.Begin enables face drawing, cSGL.End ends this mode. </font><font style="vertical-align: inherit;">Inside these commands are placed the command to set the point's parameters (normal, normalized texture coordinate, normalized color of the point) and point rendering cSGL.Vertex3f. </font><font style="vertical-align: inherit;">The number of points inside begin / end can be arbitrary, and as a whole makes up the displayed convex polygon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Texturing, projection and modeling are controlled, as in OpenGL, by three matrices selected by commands</font></font><br>
<pre><code class="cpp hljs">MatrixMode(SGL_MATRIX_TEXTURE);<font></font>
MatrixMode(SGL_MATRIX_PROJECTION);<font></font>
MatrixMode(SGL_MATRIX_MODELVIEW);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Operations with these matrices are performed by commands</font></font><br>
<pre><code class="cpp hljs">LoadIdentity();<font></font>
cSGL.Rotatef(angle,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<font></font>
cSGL.Translatef(<span class="hljs-number">-0.5</span>,<span class="hljs-number">-0.5</span>,<span class="hljs-number">0</span>);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For drawing, the library uses the CGLScreenColor point class. This affects performance not for the better, but allows you to easily transfer the library between different displays and architectures. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is FPS now? For a given octahedron without one face (I took it), measurements of the duration, in fact, of drawing procedures give about 150-200 FPS. But transferring buffer ports to the display with doubling the picture significantly reduces FPS, to about 10-15 (yes, I didn‚Äôt even think about optimizing it for now). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I draw your attention to the fact that the library was not optimized in almost any place.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Her task was simply to make an understandable 3D-drawing tool with the possibility of modernization. </font><font style="vertical-align: inherit;">I believe that by optimizing it is possible to speed up the output of graphics on STM32 once again by 5-10 (for example, using FSMC, optimizing drawing and transferring data to the display). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why can such a library be useful? </font><font style="vertical-align: inherit;">Well, for example, display any indications to the user in a visual form. </font><font style="vertical-align: inherit;">For example, the orientation of a simple 3D object. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Video work:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/29ZQVLCzn70" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository for STM32 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository for Windows. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good luck in the development of the project! </font><font style="vertical-align: inherit;">:)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495644/index.html">TS Total Sight. Event collection, incident analysis, and threat response automation tool</a></li>
<li><a href="../en495646/index.html">What non-stressful podcasts to listen to on the weekend</a></li>
<li><a href="../en495658/index.html">Where to get audio for machine learning: a selection of open libraries licensed under Creative Commons</a></li>
<li><a href="../en495660/index.html">NVMe over Fiber Channel. What is it and where is it needed?</a></li>
<li><a href="../en495662/index.html">Protecting and Hacking the Xbox 360 (Part 2)</a></li>
<li><a href="../en495670/index.html">Migrating from a seamless Data Lake to a distributed Data Mesh</a></li>
<li><a href="../en495674/index.html">Exploring electromagnetic fields using an SDR receiver and OpenCV</a></li>
<li><a href="../en495676/index.html">ETL process for retrieving email data in Apache Airflow</a></li>
<li><a href="../en495678/index.html">Competition VK Sup. Track ML. 4th place. How?</a></li>
<li><a href="../en495682/index.html">API reverse for its android application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>