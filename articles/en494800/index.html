<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥ üõçÔ∏è üßëüèª‚Äçü§ù‚Äçüßëüèª Reverse engineering of Chinese USB IR transceiver protocol üßíüèæ üçß üçò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I came across a Chinese MicroUSB IR transceiver, and there was a desire to connect it to a computer with Windows. The transceiver is a very compact de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Reverse engineering of Chinese USB IR transceiver protocol</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494800/"><img src="https://habrastorage.org/webt/sg/j9/ah/sgj9ahqc4l8hihq4jzjz_uap1ia.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I came across a Chinese MicroUSB IR transceiver, and there was a desire to connect it to a computer with Windows. </font><font style="vertical-align: inherit;">The transceiver is a very compact device with a Micro USB connector. </font><font style="vertical-align: inherit;">The only "official" option to work with it is through an Android application called ZaZaRemote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When connected to a computer through an adapter, the device was defined as a HID-compatible USB device \ VID_10C4 &amp; PID_8468. </font><font style="vertical-align: inherit;">Googling by this ID did not give any results, and I had to do protocol reversal.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invalid HID</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The device class was defined as USB \ Class_03 &amp; SubClass_FF &amp; Prot_FF. </font><font style="vertical-align: inherit;">Class_03 - HID device, SubClass_FF - vendor specific. </font><font style="vertical-align: inherit;">The hidusb.sys driver was automatically installed by the system. </font><font style="vertical-align: inherit;">You can work with this driver through the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having sketched a simple little program, I was able to get various info on the device:</font></font><br>
<br>
<pre><code class="plaintext hljs">HidD_GetManufacturerString: "Tiqiaa"<font></font>
HidD_GetProductString: "Tview"<font></font>
<font></font>
HidP_GetCaps:<font></font>
  Usage 1<font></font>
  UsagePage ff00<font></font>
  InputReportByteLength 61<font></font>
  OutputReportByteLength 61<font></font>
  FeatureReportByteLength 0<font></font>
  NumberLinkCollectionNodes 1<font></font>
  NumberInputButtonCaps 0<font></font>
  NumberInputValueCaps 2<font></font>
  NumberInputDataIndices 2<font></font>
  NumberOutputButtonCaps 0<font></font>
  NumberOutputValueCaps 2<font></font>
  NumberOutputDataIndices 2<font></font>
  NumberFeatureButtonCaps 0<font></font>
  NumberFeatureValueCaps 0<font></font>
  NumberFeatureDataIndices 0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that the exchange is carried out in blocks of 61 bytes maximum, there are 2 InputValue and 2 OutputValue interfaces. </font><font style="vertical-align: inherit;">The HidP_GetValueCaps function returns more detailed information on them:</font></font><br>
<br>
<pre><code class="plaintext hljs">HidP_GetValueCaps(HidP_Input):<font></font>
    UsagePage ff00<font></font>
    ReportID fe<font></font>
    LinkUsage 1<font></font>
    LinkUsagePage ff00<font></font>
    BitSize 8<font></font>
    ReportCount 8<font></font>
<font></font>
    UsagePage ff00<font></font>
    ReportID 1<font></font>
    LinkUsage 1<font></font>
    LinkUsagePage ff00<font></font>
    BitSize 8<font></font>
    ReportCount 60<font></font>
<font></font>
HidP_GetValueCaps(HidP_Output):<font></font>
    UsagePage ff00<font></font>
    ReportID fd<font></font>
    LinkUsage 1<font></font>
    LinkUsagePage ff00<font></font>
    BitSize 8<font></font>
    ReportCount 8<font></font>
<font></font>
    UsagePage ff00<font></font>
    ReportID 2<font></font>
    LinkUsage 1<font></font>
    LinkUsagePage ff00<font></font>
    BitSize 8<font></font>
    ReportCount 60<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of this data, the most interesting are ReportID - the ID of the report (in fact, the data packet) and ReportCount - its size. </font><font style="vertical-align: inherit;">Data can be sent and received using the HidD_SetOutputReport and HidD_GetInputReport functions, respectively. </font><font style="vertical-align: inherit;">Having experimented with these functions, with different ReportID and data size, I was not able to achieve a successful exchange. </font><font style="vertical-align: inherit;">After traffic over USB using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USBPcap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I found that the data did not even try to be transmitted. </font><font style="vertical-align: inherit;">There was a suspicion that this is some kind of incorrect HID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cw/ac/pq/cwacpqavoj65lspzo1ukb2omu0m.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET_REPORT Request went unanswered</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reversing the ZaZaRemote Application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the APK file of this application, I found the library libtiqiaa_dev_usb.so. </font><font style="vertical-align: inherit;">It exports the following functions:</font></font><br>
<br>
<pre><code class="cpp hljs">Java_com_icontrol_dev_TiqiaaUsbController_usbOpen<font></font>
Java_com_icontrol_dev_TiqiaaUsbController_usbClose<font></font>
Java_com_icontrol_dev_TiqiaaUsbController_usbSendCmd<font></font>
Java_com_icontrol_dev_TiqiaaUsbController_usbSendIR<font></font>
Java_com_icontrol_dev_TiqiaaUsbController_d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Judging by the name, they realize the exchange with the device. </font><font style="vertical-align: inherit;">Fragments similar to calling virtual functions are often found in their code:</font></font><br>
<br>
<pre><code class="cpp hljs">LDR     R3, [R0]<font></font>
LDR     R3, [R3,#<span class="hljs-number">0x18</span>]<font></font>
BLX     R3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register R0 is the first argument to this function. </font><font style="vertical-align: inherit;">These functions are called only from the Java classes.dex code. </font><font style="vertical-align: inherit;">By decompiling this file, we get their type:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">usbOpen</span><span class="hljs-params">(Context context)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">usbClose</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">usbSendCmd</span><span class="hljs-params">(UsbDeviceConnection usbdeviceconnection, UsbEndpoint usbendpoint, <span class="hljs-keyword">int</span> j, <span class="hljs-keyword">int</span> k)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">usbSendIR</span><span class="hljs-params">(Context context, UsbDeviceConnection usbdeviceconnection, UsbEndpoint usbendpoint, <span class="hljs-keyword">int</span> j, <span class="hljs-keyword">byte</span> abyte0[], <span class="hljs-keyword">int</span> k)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> IControlIRData <span class="hljs-title">d</span><span class="hljs-params">(<span class="hljs-keyword">byte</span> abyte0[])</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Java code was obfuscated, but some names still survive. </font><font style="vertical-align: inherit;">In relation to this library, the obfuscator spoiled only the name of the last function, however, almost all the names in the main Java code were corrupted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having studied Java decompiled code a bit, I found the following lines:</font></font><br>
<br>
<pre><code class="java hljs">com.tiqiaa.icontrol.e.i.a(<span class="hljs-string">"DeviceHolder"</span>, (<span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"send......cmdType="</span>)).append(i1).append(<span class="hljs-string">",cmdId="</span>).append(j1).toString());
<span class="hljs-keyword">boolean</span> flag1 = a.b(i1, j1);<font></font>
<font></font>
com.tiqiaa.icontrol.e.i.d(<span class="hljs-string">"DeviceHolder"</span>, (<span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"send....................freq="</span>)).append(i1).append(<span class="hljs-string">",cmdId="</span>).append(j1).append(<span class="hljs-string">",buffer.length="</span>).append(abyte0.length).append(<span class="hljs-string">" , device = "</span>).append(a).toString());
<span class="hljs-keyword">boolean</span> flag1 = a.a(i1, abyte0, j1);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debug logs are a good friend of a reverse engineer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To call native methods from Java code, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java Native Interface</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mechanism is used </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The exported function should look like:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_ClassName_MethodName</span><span class="hljs-params">(JNIEnv *env, jobject obj, &lt;java arguments&gt;)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can set the type of functions in the IDA:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> __cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_usbOpen</span><span class="hljs-params">(JNIEnv *env, jobject obj, struct Context *context)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> __cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_usbClose</span><span class="hljs-params">(JNIEnv *env, jobject obj)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">bool</span> __cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_usbSendCmd</span><span class="hljs-params">(JNIEnv *env, jobject obj, struct UsbDeviceConnection *usbdeviceconnection, struct UsbEndpoint *usbendpoint, <span class="hljs-keyword">int</span> cmdType, <span class="hljs-keyword">int</span> cmdId)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">bool</span> __cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_usbSendIR</span><span class="hljs-params">(JNIEnv *env, jobject obj, struct Context *context, struct UsbDeviceConnection *usbdeviceconnection, struct UsbEndpoint *usbendpoint, <span class="hljs-keyword">int</span> freq, jbyte buffer, <span class="hljs-keyword">int</span> cmdId)</span></span>;
<span class="hljs-function">struct IControlIRData *__cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_d</span><span class="hljs-params">(JNIEnv *env, jobject obj, jbyteArray buffer)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the HexRays decompiler recognizes JNI calls and the code becomes much more understandable, for example, the above call is decompiled as:</font></font><br>
<br>
<pre><code class="cpp hljs">v5 = ((<span class="hljs-keyword">int</span> (*)(<span class="hljs-keyword">void</span>))(*env)-&gt;FindClass)();</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UsbSendCmd function decompilation result</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> __cdecl <span class="hljs-title">Java_com_icontrol_dev_TiqiaaUsbController_usbSendCmd</span><span class="hljs-params">(JNIEnv *env, jobject obj, struct UsbDeviceConnection *usbdeviceconnection, struct UsbEndpoint *usbendpoint, <span class="hljs-keyword">int</span> cmdType, <span class="hljs-keyword">int</span> cmdId)</span>
</span>{
  <span class="hljs-keyword">char</span> v6; <span class="hljs-comment">// r5@5</span>
  <span class="hljs-keyword">bool</span> result; <span class="hljs-comment">// r0@12</span>
  <span class="hljs-keyword">char</span> data[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [sp+8h] [bp-18h]@12</span><font></font>
<font></font>
  dword_B57C = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> ( UsbEndpoint_bulkTransfer )<font></font>
  {<font></font>
    <span class="hljs-keyword">if</span> ( usbdeviceconnection )<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ( usbendpoint )<font></font>
      {<font></font>
        <span class="hljs-keyword">switch</span> ( cmdType )<font></font>
        {<font></font>
          <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<font></font>
            v6 = <span class="hljs-string">'L'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
            v6 = <span class="hljs-string">'R'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<font></font>
            v6 = <span class="hljs-string">'H'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
            v6 = <span class="hljs-string">'O'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<font></font>
            v6 = <span class="hljs-string">'C'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<font></font>
            v6 = <span class="hljs-string">'V'</span>;
            <span class="hljs-keyword">goto</span> LABEL_12;
          <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
            v6 = <span class="hljs-string">'S'</span>;<font></font>
LABEL_12:<font></font>
            data[<span class="hljs-number">0</span>] = <span class="hljs-string">'S'</span>;<font></font>
            data[<span class="hljs-number">1</span>] = <span class="hljs-string">'T'</span>;<font></font>
            data[<span class="hljs-number">3</span>] = v6;<font></font>
            data[<span class="hljs-number">2</span>] = cmdId;<font></font>
            data[<span class="hljs-number">4</span>] = <span class="hljs-string">'E'</span>;<font></font>
            data[<span class="hljs-number">5</span>] = <span class="hljs-string">'N'</span>;<font></font>
            result = sub_3528(env, usbdeviceconnection, usbendpoint, data, <span class="hljs-number">6</span>);
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">default</span>:<font></font>
            result = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        result = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
      result = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    result = UsbEndpoint_bulkTransfer;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code is elementary, the message format is obvious: it starts with the signature "ST", then comes the byte of the command type - one of the characters {'L', 'R', 'H', 'O', 'C', 'V', 'S '}, then the cmdId byte (just an incremental identifier to match the command and the response to it) and ends with the signature "EN". </font><font style="vertical-align: inherit;">The generated message is sent by sub_3528.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Function Code sub_3528</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __cdecl <span class="hljs-title">sub_3528</span><span class="hljs-params">(JNIEnv *env, struct UsbDeviceConnection *usbdeviceconnection, struct UsbEndpoint *usbendpoint, <span class="hljs-keyword">void</span> *data, <span class="hljs-keyword">int</span> size)</span>
</span>{<font></font>
  JNIEnv v5; <span class="hljs-comment">// r1@1</span>
  JNIEnv *v6; <span class="hljs-comment">// r4@1</span>
  <span class="hljs-keyword">int</span> result; <span class="hljs-comment">// r0@2</span>
  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// r2@3</span>
  <span class="hljs-keyword">int</span> tsize; <span class="hljs-comment">// r7@5</span>
  <span class="hljs-keyword">size_t</span> fragmSize; <span class="hljs-comment">// r5@9</span>
  <span class="hljs-keyword">int</span> v11; <span class="hljs-comment">// r0@11</span>
  JNIEnv v12; <span class="hljs-comment">// r3@11</span>
  <span class="hljs-keyword">int</span> v13; <span class="hljs-comment">// r6@11</span>
  <span class="hljs-keyword">int</span> rdOffs; <span class="hljs-comment">// [sp+10h] [bp-80h]@7</span>
  <span class="hljs-keyword">int</span> v15; <span class="hljs-comment">// [sp+14h] [bp-7Ch]@15</span>
  <span class="hljs-keyword">int</span> jbyteArray; <span class="hljs-comment">// [sp+18h] [bp-78h]@1</span>
  <span class="hljs-keyword">int</span> fragmCnt; <span class="hljs-comment">// [sp+1Ch] [bp-74h]@7</span>
  <span class="hljs-keyword">char</span> *_data; <span class="hljs-comment">// [sp+28h] [bp-68h]@1</span>
  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [sp+34h] [bp-5Ch]@7</span>
  <span class="hljs-keyword">int</span> _stack_chk_guard; <span class="hljs-comment">// [sp+74h] [bp-1Ch]@1</span><font></font>
<font></font>
  _data = (<span class="hljs-keyword">char</span> *)data;<font></font>
  v5 = *env;<font></font>
  v6 = env;<font></font>
  _stack_chk_guard = ::_stack_chk_guard;<font></font>
  jbyteArray = ((<span class="hljs-keyword">int</span> (*)(<span class="hljs-keyword">void</span>))v5-&gt;NewByteArray)();
  <span class="hljs-keyword">if</span> ( jbyteArray )<font></font>
  {<font></font>
    v8 = UsbPackCounter + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> ( UsbPackCounter + <span class="hljs-number">1</span> &gt; <span class="hljs-number">15</span> )<font></font>
      v8 = <span class="hljs-number">1</span>;<font></font>
    tsize = size;<font></font>
    UsbPackCounter = v8;<font></font>
    <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">1024</span> )<font></font>
      tsize = <span class="hljs-number">1024</span>;<font></font>
    j_j_memset(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>u);<font></font>
    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>;<font></font>
    buf[<span class="hljs-number">3</span>] = (tsize / <span class="hljs-number">56</span> &amp; <span class="hljs-number">0x7F</span>)<font></font>
           + ((((tsize + <span class="hljs-number">-56</span> * (tsize / <span class="hljs-number">56</span> &amp; <span class="hljs-number">0x7F</span>)) &gt;&gt; <span class="hljs-number">31</span>) - (tsize + <span class="hljs-number">-56</span> * (tsize / <span class="hljs-number">56</span> &amp; <span class="hljs-number">0x7F</span>u))) &gt;&gt; <span class="hljs-number">31</span>);<font></font>
    rdOffs = <span class="hljs-number">0</span>;<font></font>
    fragmCnt = <span class="hljs-number">0</span>;<font></font>
    buf[<span class="hljs-number">2</span>] = UsbPackCounter;
    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ( rdOffs &gt;= tsize )
        <span class="hljs-keyword">goto</span> LABEL_25;<font></font>
      fragmCnt = (fragmCnt + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFF</span>;<font></font>
      fragmSize = tsize - rdOffs;<font></font>
      <span class="hljs-keyword">if</span> ( tsize - rdOffs &gt; <span class="hljs-number">56</span> )<font></font>
        fragmSize = <span class="hljs-number">56</span>;<font></font>
      buf[<span class="hljs-number">1</span>] = fragmSize + <span class="hljs-number">3</span>;<font></font>
      buf[<span class="hljs-number">4</span>] = fragmCnt;<font></font>
      j_j_memcpy(&amp;buf[<span class="hljs-number">5</span>], &amp;_data[rdOffs], fragmSize);<font></font>
      ((<span class="hljs-keyword">void</span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword">int</span>, _DWORD, <span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span>))(*v6)-&gt;SetByteArrayRegion)(v6, jbyteArray, <span class="hljs-number">0</span>, <span class="hljs-number">61</span>);<font></font>
      v11 = ((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *))(*v6)-&gt;ExceptionCheck)(v6);<font></font>
      v12 = *v6;<font></font>
      v13 = v11;<font></font>
      <span class="hljs-keyword">if</span> ( v11 )<font></font>
      {<font></font>
        ((<span class="hljs-keyword">void</span> (__fastcall *)(JNIEnv *))v12-&gt;ExceptionClear)(v6);<font></font>
        v13 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">goto</span> return_r6_del;<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> ( !dword_B2A4 )<font></font>
      {<font></font>
LABEL_25:<font></font>
        v13 = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">goto</span> return_r6_del;<font></font>
      }<font></font>
      v15 = ((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *))v12-&gt;CallIntMethod)(v6);
      <span class="hljs-keyword">if</span> ( ((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *))(*v6)-&gt;ExceptionCheck)(v6) )<font></font>
      {<font></font>
        ((<span class="hljs-keyword">void</span> (__fastcall *)(JNIEnv *))(*v6)-&gt;ExceptionClear)(v6);
        <span class="hljs-keyword">goto</span> return_r6_del;<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> ( v15 &lt; <span class="hljs-number">0</span> )
        <span class="hljs-keyword">break</span>;<font></font>
      rdOffs += fragmSize;<font></font>
    }<font></font>
    v13 = <span class="hljs-number">0</span>;<font></font>
return_r6_del:<font></font>
    ((<span class="hljs-keyword">void</span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword">int</span>))(*v6)-&gt;DeleteLocalRef)(v6, jbyteArray);<font></font>
    result = v13;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    ((<span class="hljs-keyword">void</span> (__fastcall *)(JNIEnv *))(*v6)-&gt;ExceptionClear)(v6);<font></font>
    result = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> ( _stack_chk_guard != ::_stack_chk_guard )<font></font>
    j_j___stack_chk_fail(result);<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This feature is a bit more complicated. </font><font style="vertical-align: inherit;">It can be seen that the maximum length of the sent message is limited to 1024 bytes. </font><font style="vertical-align: inherit;">The message is divided into fragments. </font><font style="vertical-align: inherit;">The fragment consists of 5 bytes of the header and a maximum of 56 bytes of data - a total of 61 bytes. </font><font style="vertical-align: inherit;">Header structure:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf [0] = 2 is a constant. </font><font style="vertical-align: inherit;">Remember ReportID 2? </font><font style="vertical-align: inherit;">It seems that this is it. </font><font style="vertical-align: inherit;">And ReportCount 60 - the size of the remaining data - is also the same.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf [1] = fragmSize + 3 - fragment data size + 3, ie </font><font style="vertical-align: inherit;">the size is calculated from the byte following this variable.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf [2] = UsbPackCounter is just a counter, 1..15.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The value of buf [3] calculated by the fancy expression is just the number of fragments, you can rewrite it as:</font></font><br>
<br>
<pre><code class="cpp hljs">buf[<span class="hljs-number">3</span>] = tsize / <span class="hljs-number">56</span>;
<span class="hljs-keyword">if</span> (tsize % <span class="hljs-number">56</span>) buf[<span class="hljs-number">3</span>]++;</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf [4] = fragmCnt - fragment number, 1..buf [3].</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formed fragments are sent through a call to CallIntMethod. </font><font style="vertical-align: inherit;">It has the following type:</font></font><br>
<br>
<pre><code class="cpp hljs">jint (JNICALL *CallIntMethod)(JNIEnv *env, jobject obj, jmethodID methodID, ...);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that HexRays did not manage this time - only v6 = JNIEnv * env in the arguments. </font><font style="vertical-align: inherit;">However, in the assembler code everything is in place:</font></font><br>
<br>
<pre><code class="cpp hljs">LDR     R2, [R2,#(dword_B2A4 - <span class="hljs-number">0xB284</span>)] ; jmethodID methodID</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
methodID is stored in the dword_B2A4 variable. </font><font style="vertical-align: inherit;">Let's see where it came from: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dk/gp/wb/dkgpwbmctilwd0m-woibazyihku.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recording is done in the usbOpen and usbClose functions. </font><font style="vertical-align: inherit;">Obviously, we are interested in usbOpen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The desired fragment:</font></font><br>
<br>
<pre><code class="cpp hljs">v27 = ((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *))(*v4)-&gt;GetMethodID)(<font></font>
        v4,<font></font>
        v26,<font></font>
        <span class="hljs-string">"bulkTransfer"</span>,
        <span class="hljs-string">"(Landroid/hardware/usb/UsbEndpoint;[BII)I"</span>);<font></font>
dword_B2A4 = v27;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So this is the UsbEndpoint :: bulkTransfer method. </font><font style="vertical-align: inherit;">And nothing - related to HID! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see how IR codes are transmitted - usbSendIR function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is quite large, but the area that forms the message with the team is understandable.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment of usbSendIR function</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">  buf[<span class="hljs-number">0</span>] = <span class="hljs-string">'S'</span>;<font></font>
  buf[<span class="hljs-number">1</span>] = <span class="hljs-string">'T'</span>;<font></font>
  buf[<span class="hljs-number">2</span>] = cmdId;<font></font>
  buf[<span class="hljs-number">3</span>] = <span class="hljs-string">'D'</span>;
  <span class="hljs-keyword">if</span> ( freq &gt; <span class="hljs-number">255</span> )<font></font>
  {<font></font>
    LOBYTE(v36) = <span class="hljs-number">0</span>;<font></font>
    v37 = <span class="hljs-number">-1</span>;<font></font>
    v38 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<font></font>
    {<font></font>
      v39 = (freq - IrFreqTable[v38] + ((freq - IrFreqTable[v38]) &gt;&gt; <span class="hljs-number">31</span>)) ^ ((freq - IrFreqTable[v38]) &gt;&gt; <span class="hljs-number">31</span>);
      <span class="hljs-keyword">if</span> ( v37 != <span class="hljs-number">-1</span> &amp;&amp; v39 &gt;= v37 )<font></font>
      {<font></font>
        v39 = v37;<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        LOBYTE(v36) = v38;<font></font>
        <span class="hljs-keyword">if</span> ( !v39 )
          <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> ( ++v38 == <span class="hljs-number">30</span> )
        <span class="hljs-keyword">break</span>;<font></font>
      v37 = v39;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    v36 = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(freq - <span class="hljs-number">1</span>) &lt;= <span class="hljs-number">0x1C</span> ? freq : <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  buf[<span class="hljs-number">4</span>] = v36;<font></font>
  v40 = &amp;buf[v22];<font></font>
  v40[<span class="hljs-number">5</span>] = <span class="hljs-string">'E'</span>;<font></font>
  v40[<span class="hljs-number">6</span>] = <span class="hljs-string">'N'</span>;</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As with other commands, everything starts with "ST", then cmdId and the command code 'D' follow, followed by a byte that determines the frequency - if the argument is freq&gt; 255 - it is looked up in the frequency table IrFreqTable, otherwise it is copied directly. </font><font style="vertical-align: inherit;">Then the data goes and everything ends with "EN". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function with the obfuscated name ‚Äúd‚Äù turned out to be a parser of received data.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changing the driver and working through bulkTransfer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having studied the HID API, I found out that it basically does not provide the ability to use bulkTransfer - so you have to change the driver. </font><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinUsb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver is suitable for working with this device </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having written the inf file, I changed the driver to WinUsb and tried to send commands. </font><font style="vertical-align: inherit;">Everything worked and a reaction was received from the device - in response to sending commands (via WinUsb_WritePipe) a response of a similar format came.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dump exchange with ZaZaRemote</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite previous successes, so far I have not been able to achieve the main thing - to force the device to transmit IR commands. </font><font style="vertical-align: inherit;">The application was too big and confusing and just wanted to dump USB traffic. </font><font style="vertical-align: inherit;">However, how to do this in the case of an Android application? </font><font style="vertical-align: inherit;">The entry was found as Android-x86 on VirtualBox-e. </font><font style="vertical-align: inherit;">Despite the fact that x86 is never ARM, it nevertheless allows you to run native ARM binaries through the NativeBridge mechanism. </font><font style="vertical-align: inherit;">By installing and configuring the necessary software, I was able to get this application to work in VirtualBox.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The requested permissions definitely inspire confidence in this software.</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/ak/1x/wu/ak1xwuiqoi9angwmxu7mgj5zy7k.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By launching the application and setting up USB forwarding, I was able to sniff USB traffic. </font><font style="vertical-align: inherit;">So I got a sequence of commands for initializing the reception and transmission of IR commands, as well as sample data of IR packets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that the device is capable of not only transmitting, but also receiving IR commands, but the reception worked quite so-so - from a distance of 10 cm, and then every other time.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exchange Example</font></font></b><div class="spoiler_text"><code>- :<br>
<br>
OUT:<br>
0040 02 09 01 01 01 53 54 12 56 45 4e .....ST.VEN<br>
<br>
IN:<br>
0040 01 30 07 01 01 53 54 12 56 30 01 30 30 30 30 30 .0...ST.V0.00000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 09 02 01 01 53 54 13 53 45 4e .....ST.SEN<br>
<br>
IN:<br>
0040 01 0a 08 01 01 53 54 13 53 09 45 4e 30 30 30 30 .....ST.S.EN0000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 3b 03 02 01 53 54 14 44 00 ff ff ff ff b7 7f .;...ST.D.......<br>
0050 7f 1b a3 23 a3 23 a3 69 a3 23 a3 23 a3 23 a3 23 ...#.#.i.#.#.#.#<br>
0060 a3 23 a3 69 a3 69 a3 23 a3 69 a3 69 a3 69 a3 69 .#.i.i.#.i.i.i.i<br>
0070 a3 69 a3 69 a3 23 a3 23 a3 23 a3 69 a3 .i.i.#.#.#.i.<br>
<br>
OUT:<br>
0040 02 2f 03 02 02 23 a3 23 a3 23 a3 23 a3 69 a3 69 ./...#.#.#.#.i.i<br>
0050 a3 69 a3 23 a3 69 a3 69 a3 69 a3 7f 7f 7f 7f 7f .i.#.i.i.i......<br>
0060 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 57 45 ..............WE<br>
0070 4e N<br>
<br>
IN:<br>
0040 01 0a 09 01 01 53 54 14 4f 09 45 4e 30 30 30 30 .....ST.O.EN0000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
- :<br>
<br>
OUT:<br>
0040 02 09 01 01 01 53 54 17 56 45 4e .....ST.VEN<br>
<br>
IN:<br>
0040 01 30 0c 01 01 53 54 17 56 30 01 30 30 30 30 30 .0...ST.V0.00000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 09 02 01 01 53 54 18 53 45 4e .....ST.SEN<br>
<br>
0040 01 0a 0d 01 01 53 54 18 53 09 45 4e 30 30 30 30 .....ST.S.EN0000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 09 03 01 01 53 54 19 52 45 4e .....ST.REN<br>
<br>
0040 01 0a 0e 01 01 53 54 19 52 13 45 4e 30 30 30 30 .....ST.R.EN0000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 09 04 01 01 53 54 1a 43 45 4e .....ST.CEN<br>
<br>
IN:<br>
0040 01 0a 0f 01 01 53 54 1a 43 13 45 4e 30 30 30 30 .....ST.C.EN0000<br>
0050 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 30 30 000-0000-0000-00<br>
0060 30 30 2d 30 30 30 30 30 30 30 30 30 30 30 31 09 00-000000000001.<br>
0070 45 4e ff ff ff df ff f9 ef ff df ff bf fb ff EN.............<br>
<br>
OUT:<br>
0040 02 09 05 01 01 53 54 1b 4f 45 4e .....ST.OEN<br>
<br>
IN:<br>
0040 01 3b 01 0e 01 53 54 00 44 ff ff ff ff ba 7f 7f .;...ST.D.......<br>
0050 19 a4 21 a4 21 a4 68 a4 22 a4 21 a4 22 a4 22 a4 ..!.!.h.".!.".".<br>
0060 22 a4 68 a4 68 a4 21 a4 68 a4 68 a4 68 a4 68 a4 ".h.h.!.h.h.h.h.<br>
0070 68 a4 68 a4 22 a4 22 a4 22 a4 68 a4 22 fb ff h.h.".".".h."..<br>
.....<br>
0040 01 2f 01 0e 0e 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f ./..............<br>
0050 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f ................<br>
0060 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 7f 3e 13 45 .............&gt;.E<br>
0070 4e 82 02 82 02 82 7f 7f 7f 7f 7f 7f 7f fb ff N..............<br>
</code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that the device has problems with the size of the data to send - in addition to the answer, any garbage is poured - usually what is left of the previous package. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Studying the dump and subsequent experiments made it possible to find out the functions of all the teams:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'V' - Version - request for a version - my device produces a zero GUID;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'L' - IdleMode - standby mode - in this mode, the device is located after power is supplied, or goes by this command;</font></font></li>
<li>'S' ‚Äî SendMode ‚Äî   ‚Äî     ;</li>
<li>'R' ‚Äî RecvMode ‚Äî   ‚Äî     ;</li>
<li>'D' ‚Äî Data ‚Äî    ‚Äî   ,    ‚Äî    ;</li>
<li>'O' ‚Äî Output ‚Äî    ‚Äî  ,    ‚Äî   / ;</li>
<li>'C' ‚Äî Cancel ‚Äî    ‚Äî  ,    'O';</li>
<li>'H' ‚Äî Unknown ‚Äî    .</li>
</ul><br>
<h2>   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having received a dump of control commands and IR parcels, I was able to implement full-fledged device control - receiving and transmitting an IR signal. However, in order to synthesize an arbitrary IR signal, it was necessary to determine the format in which it is encoded. To do this, I connected an IR photodetector to an oscilloscope and began to examine the signals sent. Through experimentation, I found out the encoding format: the high bit of each byte determines whether the transmitter is on or off, and the lower 7 bits determine the time. The unit of time was 16 microseconds. For example: 8A - the transmitter is turned on for 160 microseconds; 8A 05 FF 83 - 160 Œºs on, pause 80 Œºs, 2.08 ms on.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the transmitter is turned on, the LED pulsates at a frequency of ~ 36.64 kHz. </font><font style="vertical-align: inherit;">Theoretically, this frequency should be determined by the freq argument of the usbSendIR command, but experiments have shown that the device does not respond to this argument at all. </font><font style="vertical-align: inherit;">Nevertheless, my home appliances normally accepted the signals of this transceiver. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The format of the data recorded by the device in the receive mode turned out to be similar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TiqiaaUsbIr Class and IR Control</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I implemented the transceiver control in the form of a C ++ TiqiaaUsbIr class and wrote a simple CaptureIR QT program. </font><font style="vertical-align: inherit;">In addition to the functions of receiving and transmitting IR signals, I implemented the synthesis and decoding of signals using the NEC protocol. </font><font style="vertical-align: inherit;">This protocol is used, for example, in remotes of LG TVs. </font><font style="vertical-align: inherit;">I also implemented saving and loading IR signals in the original format and the LIRC format. </font><font style="vertical-align: inherit;">There was an idea to make a module for WinLirc, but it turned out to be a crooked and not fully implemented API, so I have postponed this idea for now. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sources and compiled program can be </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">downloaded here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example of using the TiqiaaUsbIr class:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; IrDev;<font></font>
TiqiaaUsbIr::EnumDevices(IrDev); <span class="hljs-comment">//  </span><font></font>
TiqiaaUsbIr Ir;<font></font>
Ir.Open(IrDev[<span class="hljs-number">0</span>].c_str()); <span class="hljs-comment">//  </span>
Ir.SendNecSignal(<span class="hljs-number">0x0408</span>); <span class="hljs-comment">//   (LG POWER)</span>
Ir.Close();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Captured power-on signal: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/fa/gt/ldfagtymdt142tfc7fitphxzglw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is synthesized: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jv/nd/-d/jvnd-d2x8nt7dcxbrh0zeoqeddi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the capture, something went wrong:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/av/j3/d4/avj3d4axzb4yovsz4phw1qsnrto.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the process of research, the USB protocol of the Tiqiaa Tview IR transceiver was completely restored, the inf file of the driver and software for working with it were written. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The considered IR transceiver is a very cheap, affordable and compact ($ 5 on Ali, dimensions 15 x 10 x 5 mm) device for controlling household appliances and studying its IR protocols. Unfortunately, controlling the frequency of the transmitter turned out to be inoperative, which in my case did not cause problems, but it is possible that there is a technique with more finicky receivers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The reception mode, due to the meager radius and low capture reliability, is unsuitable for use as a full-fledged IR receiver - a record of successful capture distances of ~ 30 cm, while the remote control is aimed exactly at the receiver, and even all focus signals are not normally captured. </font><font style="vertical-align: inherit;">However, it is useful for capturing signals and studying protocols for IR remotes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interesting IR codes for LG TVs: </font><font style="vertical-align: inherit;">
PS I am looking for information about LG AccessUSB, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">more details here</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<code>POWER 0408<br>
POWERON 04C4<br>
POWEROFF 04C5<br>
IN_STOP 04FA<br>
IN_START 04FB<br>
POWERONLY 04FE<br>
EZ_ADJUST 04FF</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488464/index.html">Webpack 5 - Asset Modules</a></li>
<li><a href="../en488468/index.html">Introducing FastAPI</a></li>
<li><a href="../en488470/index.html">Kim Dotcom: Caught, the most wanted person online. Part 4</a></li>
<li><a href="../en488472/index.html">Weekend Reading: 10 materials about audio gadgets - from Soviet car radios to noise-canceling plugs</a></li>
<li><a href="../en488474/index.html">About color, sound and ‚Äúcrowd exploration‚Äù as a separate kind of beautiful</a></li>
<li><a href="../en494804/index.html">‚ÄúSorry, I recognized ...‚Äù or recognize raspberries and controllers using the Tensorflow Object Detection API</a></li>
<li><a href="../en494806/index.html">Cyber ‚Äã‚Äãtargets 2019 as trends 2020 - hackers have changed focus</a></li>
<li><a href="../en494808/index.html">Product analyst: what does it do, how much does it make, what benefits does the business bring</a></li>
<li><a href="../en494810/index.html">Introduction to 3D: Three.js Basics</a></li>
<li><a href="../en494814/index.html">Is Slurm useful?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>