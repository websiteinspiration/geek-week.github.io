<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💡 🤘🏿 🧑🏿‍🤝‍🧑🏼 CI / CD流程更新：章鱼部署 🚓 ➖ 👨🏽‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文的第三部分是关于更新CI / CD流程。  
 
 在这个阶段，我们（至少应该）了解CI的工作方式，输入的内容，如何从中获取结果以及需要做什么才能使构建输出成为完整的项目模块并开始使用。以及已建立的章鱼（最好是LTS）。在最后一部分中，考虑了建立团队协作的过程：从代码进入存储库到可以解压缩就绪档...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CI / CD流程更新：章鱼部署</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497112/"><img src="https://habrastorage.org/webt/ll/fr/wq/llfrwqyrix6tk6l50b5sk86rqtm.png" alt="图片" align="left" width="300"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文的第三部分是关于更新CI / CD流程。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这个阶段，我们（至少应该）了解CI的工作方式，输入的内容，如何从中获取结果以及需要做什么才能使构建输出成为完整的项目模块并开始使用。以及已建立的章鱼（最好是LTS）。在最后一部分中，考虑了建立团队协作的过程：从代码进入存储库到可以解压缩就绪档案的那一刻发生的所有事情，从理论上讲，它应该可以工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想起目录：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1部分：什么，为什么不喜欢，计划，有点b。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我将这部分称为技术性的。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2部分：团队合作精神。</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3部分：章鱼部署。</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第四部分：幕后花絮。</font><font style="vertical-align: inherit;">不愉快的时刻，对未来的计划，可能是常见问题解答。</font><font style="vertical-align: inherit;">最有可能的是，它也可以称为近技术。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">章鱼：一般</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在输入端，我们有代码，在输出端，有汇编工件，所有内容在这里都清晰可见。</font><font style="vertical-align: inherit;">但是每个模块的结果都包括两个部分：一个核心包（构建本身的结果）和一个单独的包（唯一的配置和库）。</font><font style="vertical-align: inherit;">因此，为了使特定模块正常工作，我们需要以下内容：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IIS中的一个实例，该实例具有自己的池，并且在文档根目录中“查找”。</font><font style="vertical-align: inherit;">为每个模块分配一个单独的池。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档根目录中的核心软件包文件。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档根目录中的单个软件包文件。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">建议在所有这一切之前备份文档根目录的旧内容。</font><font style="vertical-align: inherit;">我们当然对自己有信心，但是人们分为两种：不备份的人和</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">备份的人</font><font style="vertical-align: inherit;">。&nbsp;</font></font></li>
<li>  ( )       ( ).    ,     ,   .</li>
<li>   ,    ,    .</li>
<li>   ,   .</li>
<li>    ()    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有那么多，但还不够。</font><font style="vertical-align: inherit;">步骤1没有问题。</font><font style="vertical-align: inherit;">章鱼有一个“部署到IIS”模板，它具有您需要的一切。</font><font style="vertical-align: inherit;">在第2步和第3步，我们将在下面详细介绍。</font><font style="vertical-align: inherit;">对于第4步，提示变量已足够，我们将从teamcity传递该变量。</font><font style="vertical-align: inherit;">步骤5是一个Powershell脚本。</font><font style="vertical-align: inherit;">他还将轮换备份。</font><font style="vertical-align: inherit;">为什么我们需要将它们全部存储起来，旧的可以删除。</font><font style="vertical-align: inherit;">步骤6也是powershell。</font><font style="vertical-align: inherit;">步骤7-完成的Slack-详细通知模板。</font><font style="vertical-align: inherit;">步骤8-再次使用powershell。</font><font style="vertical-align: inherit;">这听起来像是一个计划，所以我们将执行它。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">房客</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于步骤2和3的更多详细信息。我假设读者熟悉章鱼的部署。如果不是，那么中心上有很多很棒的文章他们可以给出基本的了解。它们在这里：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二个</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，我们具有项目，基础结构，租户，库，当前任务和设置的选项卡。必要-租户。租户一词的字面翻译是租户。在这种情况下，很可能是客户，即客户。 Oktopus告诉我们，租户可以让您一次为许多客户（租户）部署项目的不同实例。这是带有其列表的页面。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gf/u-/xr/gfu-xrcwm5ehwz023dggr3e-vhs.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，租户的使用略有不同。每个租户代表一个客户。对于租户，有机会添加将在部署后启动的项目。因此，将有一个核心项目和一个单独的项目。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个租户有两个标签：TenantRole-每个人都公用，表示使用此标签将特定类型（核心）的模块部署到所有租户，而ModName是与模块名称（单独）匹配的标签。&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k5/iu/0f/k5iu0fknzckzncis11o2y0xmkd4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从timcity接收到最后一个章鱼作为参数，从而标识当前已</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部署</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的模块（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Deploy.Env和Deploy.2</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从屏幕上可以看到，在为特定组织部署模块时，核心项目将首先启动（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy.2 teamcity步骤</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），然后是一个单独的项目（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">步骤deploy.3和deploy.4 teamcity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">每个租户都可以访问其中包含的所有项目的变量，以及租户本身的变量（收集在变量集中，并包含ModName标记）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/zs/3c/skzs3cxhjryge9jcrvu8alp2skg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;在团队中选择了部署的租户，如下所示：&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantRoleTag变量-包含TenantRole（章鱼中的租户标签名称）及其实际值；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName-章鱼中ModName标记的值。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变数</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量是项目的重要组成部分，因此需要正确构造它们。</font><font style="vertical-align: inherit;">在该项目中，章鱼变量分为三种类型：所有项目通用（在“环境”库集合中收集），每个项目单独（在项目中直接配置）以及租户直接变量（也是库集合）。</font><font style="vertical-align: inherit;">如前所述，在环境中，所有项目都具有共同点，尤其是：&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档根目录的基本路径（例如C：\ inetpub \）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本URL（例如，对于所有模块，公共域是organization.com）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问数据库（需要组织备份）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等等</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一个巨大的优点是，在每个环境中的章鱼中可能都有一个可变值。分隔可以是任何东西。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/59/qx/ag/59qxag_xyk4vlnmqwxgc9tphyuu.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，屏幕上的第3、6和7行。第3行是常见情况。所有需要部署到生产环境的东西都到了这里。第6和7行描述了非常具体的情况，例如：角色为“ CompanyWebsite”的生产环境（第6行）以及租户标签为“ orgznizationX”的生产环境。这对于标识将在其上获得软件包的服务器很有必要，因为例如对于organizationX，将分配一个单独的服务器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
项目的变量包括其他所有内容。</font><font style="vertical-align: inherit;">这是不常见的，并且针对不同的环境而有所不同，例如，模块的标准域名。</font><font style="vertical-align: inherit;">通常，它编译为＃{Tenant.ModName}。＃{BaseModuleDomain}，但是在某些情况下可能有所不同。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/19/cx/ne19cx7wbn5t0k8rctfcc53-ocq.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;图片中就是这种情况。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">频道</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仍然值得谈论渠道。</font><font style="vertical-align: inherit;">简短而快速-通道允许您设置部署逻辑。</font><font style="vertical-align: inherit;">非常简单，在官方文档中对此进行了描述，尤其是</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，只有稳定标签的发行版可以进入生产渠道等。</font><font style="vertical-align: inherit;">项目中有4个与环境一致的渠道（开发，测试，过渡，生产）。</font><font style="vertical-align: inherit;">根据预发布标签，发布会落入其中。</font><font style="vertical-align: inherit;">它以内部版本号格式teamcity表示（</font><font style="vertical-align: inherit;">有关teamcity的部分的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.General</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置）。</font><font style="vertical-align: inherit;">从TeamCity的，信道在步骤转移</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到附加命令行参数字段（--channel参数）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模式</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您在阅读有关团队合作性的文章时还没有意识到使用模板的所有优点，那么现在是时候了。建议使用足够通用的自定义步骤模板，因为如果需要进行编辑，则必须记住该步骤在哪些位置应用，单击每个类似的位置，并进行与该步骤用途相同的多次编辑。在该项目中，创建了模板以检查网站的运行状况，并将域列表发送回teamcity。简要考虑创建模板的过程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部署任何模块后，每次都需要运行一个powershell脚本。</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$url</span> = <span class="hljs-string">"<span class="hljs-variable">$scheme</span>"</span> + <span class="hljs-string">"://"</span> + <span class="hljs-string">"<span class="hljs-variable">$domain</span>"</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Requesting '<span class="hljs-variable">$url</span>'"</span>
[<span class="hljs-type">Net.ServicePointManager</span>]::SecurityProtocol = [<span class="hljs-type">Net.SecurityProtocolType</span>]::Tls12
<span class="hljs-variable">$request</span> = [<span class="hljs-type">System.Net.WebRequest</span>]::Create(<span class="hljs-variable">$url</span>)
<span class="hljs-variable">$request</span>.Timeout = <span class="hljs-variable">$timeout</span>
<span class="hljs-variable">$response</span> = <span class="hljs-variable">$request</span>.GetResponse()
<span class="hljs-variable">$response</span>.Close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该脚本接受输入方案，域和超时，之后我们认为该站点无法运行。</font><font style="vertical-align: inherit;">您可以在“库-步骤模板”中创建模板。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
输入名称，选择徽标。</font><font style="vertical-align: inherit;">接下来，配置输入参数及其默认值。</font><font style="vertical-align: inherit;">默认值也可以是指定变量的值（变量＃{HostName}的值是输入参数＃{Domain}的默认值）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sm/1b/hd/sm1bhd7tlanxkhokj5ykkwndnqy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我们对脚本进行一些修改，并将其添加为执行步骤：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/an/ae/jo/anaejohklygki3oeyvzdf9wzwf8.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成。</font><font style="vertical-align: inherit;">在输出中，我们获得了一个令人愉快的步骤模板，并且在没有工作的情况下，同事无需阅读晦涩的脚本就可以弄清楚字段值。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zn/wh/cb/znwhcbju96vpkpnojnkahezaink.png" alt="图片"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">章鱼：处理细节</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将所有项目分为几组，以模块组为例进行说明。</font><font style="vertical-align: inherit;">它包含以下项目：&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">核心;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单个模块项目。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从核心项目开始。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是概述页面：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h1/ej/l8/h1ejl8qvrwpp86te_6pls3nkkwi.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，您可以清楚地看到它们所在的内核版本。</font><font style="vertical-align: inherit;">对于版本号的混淆，我深表歉意，现在我们切换到绑定到git标签的版本控制，并且除生产外，其他地方都已在使用新的版本控制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，对于某些租户，没有定义的环境。</font><font style="vertical-align: inherit;">它们尚未创建或未预见。&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部署流程核心</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在内核交付阶段，还将执行部分服务操作，即数据库的备份（如果需要），文件的先前版本的备份，备份的轮换和内核的部署。&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mq/xe/jn/mqxejndhfnxbgb80o5bvfery-ls.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
步骤1：备份数据库。</font><font style="vertical-align: inherit;">它是可选的，并且基于在team </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">步骤</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">2中</font></a><font style="vertical-align: inherit;">从teamcity传递</font><font style="vertical-align: inherit;">到其他命令行参数字段</font><font style="vertical-align: inherit;">的变量参数的值</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">默认情况下，此变量设置为false，因为数据库备份仅应按需进行，而不应定期进行。</font><font style="vertical-align: inherit;">在团队城市中，从更改此参数开始如下所示（您需要单击“运行”按钮旁边的省略号）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ru/48/s3/ru48s3ycp-wc53-ikai6vjwzqy0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在章鱼中，其外观如下：&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/ua/xo/ecuaxoycij2hzotqmux4sjjrcmw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，没有什么异常。</font><font style="vertical-align: inherit;">zip文件的备份副本（按模板），备份轮换（脚本会低一些）以及按模板进行内核部署。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意事项：&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有重要参数均由变量设置，这使您可以在一个地方快速更改其值，而无需深入研究过程设置；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IIS池名称与实例名称和服务域名匹配（为方便起见）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在“部署IIS”步骤中，将安装“与现有绑定合并”，而不是替换。</font><font style="vertical-align: inherit;">由于除了提供服务外，我们在每个实例上仍然有很多客户端域；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">清理文档根目录（复选标记在安装前清除此目录）失败。</font><font style="vertical-align: inherit;">复制时，新文件将替换旧文件。</font><font style="vertical-align: inherit;">这样做是为了使站点在部署期间不会“崩溃”。</font><font style="vertical-align: inherit;">加载页面的延迟比终止屏幕好得多。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
备份轮换脚本：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$days</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"DaysStoreBackups"</span>]
<span class="hljs-variable">$limit</span> = (<span class="hljs-built_in">Get-Date</span>).AddDays(-<span class="hljs-variable">$days</span>)
<span class="hljs-variable">$pathDb</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"DbBackupDir"</span>]
<span class="hljs-variable">$pathFiles</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"FilesBackupDir"</span>] + <span class="hljs-string">'\'</span> + <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"HostName"</span>]<font></font>
<font></font>
<span class="hljs-comment"># Delete files older than the $limit.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathDb</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.CreationTime <span class="hljs-operator">-lt</span> <span class="hljs-variable">$limit</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span>
<span class="hljs-comment"># Delete any empty directories left behind after deleting the old files.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathDb</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$_</span>.FullName <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer }) <span class="hljs-operator">-eq</span> <span class="hljs-variable">$null</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-Recurse</span><font></font>
<font></font>
<span class="hljs-comment"># Delete files older than the $limit.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathFiles</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.CreationTime <span class="hljs-operator">-lt</span> <span class="hljs-variable">$limit</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span>
<span class="hljs-comment"># Delete any empty directories left behind after deleting the old files.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathFiles</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$_</span>.FullName <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer }) <span class="hljs-operator">-eq</span> <span class="hljs-variable">$null</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-Recurse</span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单个程序包的部署过程</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在交付单个模块程序包的阶段，将部署配置和唯一库，将文件定位和/或重命名，请求该站点（首先，很长时间以来第一次加载.net上的站点，此步骤使您可以立即执行此过程，其次，可以使您了解加载网站时是否有任何错误）。</font><font style="vertical-align: inherit;">通知也会发送到松弛状态，并且属于该模块的所有域的实际列表都将转移到teamcity。&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zh/vk/pr/zhvkprmelbx8edaxft0imsokmja.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从重要：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在部署步骤中，未清除文档根目录（新的核心程序包已经存在）；</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
步骤3，脚本。</font><font style="vertical-align: inherit;">模板的描述要高一些。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
步骤5.它也与</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">teamcity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">deploy.4</font></a><font style="vertical-align: inherit;">步骤</font><font style="vertical-align: inherit;">相关。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在章鱼中，它看起来像这样：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$baseDomain</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"HostName"</span>]
<span class="hljs-variable">$domains</span> = (<span class="hljs-built_in">Get-WebBinding</span> <span class="hljs-variable">$baseDomain</span>).bindingInformation | %{ <span class="hljs-variable">$_</span>.Split(<span class="hljs-string">':'</span>)[<span class="hljs-number">2</span>] } | <span class="hljs-built_in">Sort-Object</span> | <span class="hljs-built_in">Get-Unique</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"##teamcity[setParameter name='AllInstanceDomains' value='<span class="hljs-variable">$domains</span>']"</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"##teamcity[setParameter name='ServiceDomain' value='<span class="hljs-variable">$baseDomain</span>']"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
语法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">## teamcity ...</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许您在teamcity中设置build参数。</font><font style="vertical-align: inherit;">实际上，其中的步骤如下所示：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"All domains on instance %ServiceDomain% :"</span>
<span class="hljs-variable">$domains</span> = <span class="hljs-string">"%AllInstanceDomains%"</span>
<span class="hljs-variable">$domains</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$domains</span>.Split(<span class="hljs-string">" "</span>) | <span class="hljs-built_in">ForEach-Object</span> {<span class="hljs-string">"http://<span class="hljs-variable">$_</span>"</span>} | <span class="hljs-built_in">Out-String</span>)
<span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$domains</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Service domain: http://%ServiceDomain%"</span>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">章鱼：结果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
整个构建过程如下：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码是从特定分支（对应于环境）收集的；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组装的结果（工件）提供给章鱼，并由两部分组成：内核和单独的模块包。</font><font style="vertical-align: inherit;">这样可以有效利用磁盘空间并节省总体更新交付时间。&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个软件包的版本均由数字和预发布标签组成，该标签定义了该版本将投放的渠道和环境。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">八达通通过输入，在组织数据（租户标签），通道（预发布标签）和附加说明（数据库的可选备份）的指导下创建发布并将数据包传递到适当的服务器，还对模块的性能进行了基本检查。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就像那样。</font><font style="vertical-align: inherit;">很有可能在幕后还会有另一篇接近技术的文章。</font><font style="vertical-align: inherit;">它将包括所有未在此处输入的内容：一些细节，工作过程中的新内容以及对于决定此事的人员可能要面对的内容，项目的更正和更新，也许是常见的问题/答案。</font><font style="vertical-align: inherit;">谢谢您的关注。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN497098/index.html">我们如何在全球视频分析领域首创联合收割机的自动驾驶仪</a></li>
<li><a href="../zh-CN497100/index.html">将Jupyter发射到轨道LXD</a></li>
<li><a href="../zh-CN497106/index.html">网络模拟器教程ns-3。第1.2章</a></li>
<li><a href="../zh-CN497108/index.html">Fighting Covid-2019：伟大的转机来了</a></li>
<li><a href="../zh-CN497110/index.html">在有关游戏的视频片段中需要配音吗？</a></li>
<li><a href="../zh-CN497114/index.html">是时候填埋了</a></li>
<li><a href="../zh-CN497116/index.html">Starsky Robotics无人驾驶卡车告一段落</a></li>
<li><a href="../zh-CN497118/index.html">[预测]所有无人驾驶卡车会终结还是只有Starsky Robotics？</a></li>
<li><a href="../zh-CN497126/index.html">积压评分和优先级排序技术</a></li>
<li><a href="../zh-CN497132/index.html">#SaveFirst计划以支持具有社会意义的项目</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>