<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😝 🤫 🏂🏻 Fantastic advisory locks and where they live 👩🏿‍🔧 🧥 🌖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL has a very convenient mechanism for advisory locks , they are also advisory locks . We at Tensor use them in many places in the system, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fantastic advisory locks and where they live</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488024/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL has a very convenient </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mechanism for advisory locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , they are also </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advisory locks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We at Tensor use them in many places in the system, but few people understand in detail how exactly they work, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what problems can be obtained if mistreated</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/sc/ak/ziscak3l-89wfdsjqhytpmkjalg.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more about locks</font></font></b><div class="spoiler_text">   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    PostgreSQL</a>.</div></div><br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advantages of recommendation locks</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fundamental difference between this mechanism and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ordinary”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table / page / record level </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">locks</font></a><font style="vertical-align: inherit;"> is that there are several key features.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom ID Lock</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Normal” locks in PG are always tied to a specific database object (table, record, data page) and the process serving the connection. </font><font style="vertical-align: inherit;">Advisory locks is also a process, but instead of a real object, an abstract identifier can be set as </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bigint)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or as </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(integer, integer)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, attaching each lock to a process means that by naming it through </font></font><code>pg_terminate_backend(pid)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or correctly completing the connection from the client side, you can get rid of all the locks imposed by it.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAS Check for Lock Capture</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CAS is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare-and-Set</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , that is, the verification of the capture capability and the capture of the lock itself take place as one atomic operation, and obviously no one can “wedge” between them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, if you first make a verification request to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , look at the result, then decide whether or not to lock, then no one guarantees that between these operations no one will manage to take the object you need. </font><font style="vertical-align: inherit;">But if you use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_try_advisory_lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then you will either immediately receive this lock, or the function will simply return </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-capture without exceptions and expectations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Normal” locks exist in the model </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“If you already asked for a lock, then wait. If you did not want to wait ( </font></font><code>NOWAIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>statement_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - here's an exception "</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This approach greatly interferes within the transaction, because then you have to either implement a block </font></font><code>BEGIN-EXCEPTION-END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for processing or roll back ( </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) the transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only way to avoid this behavior is to use the design </font></font><code>SELECT ... SKIP LOCKED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that came with version 9.5. Unfortunately, with this method, the options “didn’t have anything to block” and “was, but already blocked” become indistinguishable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recommended locks caused by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> functions simply return </font></font><code>TRUE/FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not confuse </font></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">- the first function </font><b><font style="vertical-align: inherit;">will wait</font></b><font style="vertical-align: inherit;"> until it receives a lock, and the second will simply return immediately </font><font style="vertical-align: inherit;">if it is impossible to capture it "right now."</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>FALSE</code><font style="vertical-align: inherit;"></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locks within and after the transaction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I mentioned above, object locks are “attached” to the process and exist only as part of the current transaction in it. </font><font style="vertical-align: inherit;">Even just to impose - will not succeed:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> tbl;
<span class="hljs-comment">-- ERROR:  LOCK TABLE can only be used in transaction blocks</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, at the end of the transaction, all the locks imposed on it are removed. </font><font style="vertical-align: inherit;">In contrast, advisory locks were originally designed with the ability to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hold locks and outside the scope of a transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">1</span>);
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> locktype = <span class="hljs-string">'advisory'</span>;</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+--------------<font></font>
locktype           | advisory<font></font>
database           | 263911484<font></font>
relation           |<font></font>
page               |<font></font>
tuple              |<font></font>
virtualxid         |<font></font>
transactionid      |<font></font>
classid            | 0 &lt;--  int4 #1    int8<font></font>
objid              | 1 &lt;--  int4 #2    int8<font></font>
objsubid           | 1<font></font>
virtualtransaction | 416/475768<font></font>
pid                | 29264<font></font>
mode               | ExclusiveLock<font></font>
granted            | t<font></font>
fastpath           | f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But already from version 9.1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xact</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> versions of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advisory functions have appeared</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that allow you to implement the behavior of “ordinary” locks that are automatically released when the transaction that imposed them is completed.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of use in VLSI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, like any other lock, advisory serve to ensure the uniqueness of processing a resource. </font><font style="vertical-align: inherit;">In our country, such resources are usually either the entire table or a specific record of the table, which for some reason does not want to be "locked down".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worker's monoprocessing</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the need to process some data in the database is triggered by an external event, but multiprocessing is redundant or can lead to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a race condition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is reasonable to make only </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> work on this data </font><b><font style="vertical-align: inherit;">at a time</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we will try to lock with the table identifier as the first parameter and the specific application processing ID as the second:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(
  <span class="hljs-string">'processed_table'</span>::regclass::<span class="hljs-keyword">oid</span>
, <span class="hljs-number">-1</span> <span class="hljs-comment">--   worker'</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we returned </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then someone else is already holding such a lock, and specifically this process does not need to do anything, but it’s best to just end quietly. </font><font style="vertical-align: inherit;">This is how, for example, the process of dynamic </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calculation of the cost of goods in a warehouse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> works, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">in</font></a><font style="vertical-align: inherit;"> isolation for each individual client scheme.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concurrent Queue Processing</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the task is “the opposite” - we want the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tasks in some queue table to be</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processed as quickly as possible, multi-threaded, fault-tolerant, and even from different business logics (well, we lack the power of one) - for example, as our operator does on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfer of electronic reporting</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to government agencies or the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OFD service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the “processing” BLs are different servers, no mutex can be hung up anymore. It’s not safe to single out some special task-distributing process coordinator, “die” he - and everything will rise. And so it turns out that it is most efficient to distribute tasks directly at the database level, and there is such a way - in ancient times, the model was honestly spied on by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Koterov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and then creatively modified.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we impose a lock on the table ID and PK of a particular record:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  queue_table<font></font>
<span class="hljs-keyword">WHERE</span>
  pg_try_advisory_lock(<span class="hljs-string">'queue_table'</span>::regclass::<span class="hljs-keyword">oid</span>, pk_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk_id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the process will receive from the table the first record that has not yet been blocked by its competing brothers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, if PK does not consist of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(integer)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(integer, integer)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as in the same cost calculation, for example), you can impose a lock directly on this pair - it is unlikely that an intersection with the "competitor" will occur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important! </font><font style="vertical-align: inherit;">Do not forget to periodically </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">properly maintain your queue table</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exclusive Document Processing</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is used everywhere in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">document management solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Indeed, in a distributed web-system one and the same document can be opened for viewing by different users at the same time, but it can only be processed (change its state, etc.) at any time by just one.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traditional issues</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where without them! </font><font style="vertical-align: inherit;">Almost all boils down to one </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">they did not unlock what they locked</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-overlay of one advisory lock</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as they say:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If several requests for blocking are received at once, they accumulate, so </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if one resource has been blocked three times, it must be unlocked three times</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to be available in other sessions.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Put too many locks at once</font></font></h4><br>
<img src="https://habrastorage.org/webt/c-/q5/19/c-q519tdomjwjhoofqaljskvcxa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thousands of them! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read the manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> again </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both advisory and regular locks are stored in the shared memory area, the size of which is determined by the configuration parameters </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is important that this memory is sufficient, because </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otherwise the server will not be able to issue </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">any</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Thus, the number of recommended locks that a server can issue is usually limited to tens or hundreds of thousands, depending on the server configuration.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, if a situation arises when you want to impose </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">several thousand advisory locks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (even if you remove them correctly later) - think very hard where you will run when the server gets up.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leaks while filtering records</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we take the previous request and add a harmless condition such as parity check ID - </font></font><code>AND pk_id % 2 = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both conditions</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for each entry </font><font style="vertical-align: inherit;">will be checked </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">As a result, it was </font></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completed, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lock was superimposed, and then the record was filtered</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by parity. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x1/vo/jc/x1vojcx77r-yh1i_j4ygddkfqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Or an option from the manual:</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12345</span>; <span class="hljs-comment">-- ok</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">12345</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all - the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocking remains</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but we are not aware of this. </font><font style="vertical-align: inherit;">It is treated with the correct requests, in the worst case - </font></font><code>pg_advisory_unlock_all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, confused!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Classics of the genre ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Confuse </font><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">, and wonder why it works for a long time. </font><font style="vertical-align: inherit;">But because the non-try-version is </font><b><font style="vertical-align: inherit;">waiting</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Confuse </font><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">, and wonder where the lock went - and it "ended" with the transaction. </font><font style="vertical-align: inherit;">And the transaction consisted of one request, because nowhere was it "explicitly" declared, yeah.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_try_advisory_<i><b>xact</b></i>_lock</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work through pgbouncer</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a separate source of pain for many when, for the sake of performance, working with the database goes through </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer in transaction mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that two of your neighboring transactions running on the same connection to the database (which actually goes through the pgbouncer) can be executed </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in different "physical" connections</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the base side. </font><font style="vertical-align: inherit;">And they have their own locks ... Each has </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/l6/h0/ecl6h02_l0hbh4kspdrba2g0a5c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a few options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or go to work through a direct connection to the database</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or invent an algorithm so that all advisory locks are only within the transaction (xact)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for now.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488010/index.html">Domain Driven Design Tools</a></li>
<li><a href="../en488012/index.html">Parking for your cons</a></li>
<li><a href="../en488014/index.html">9. Fortinet Getting Started v6.0. Logging and Reporting</a></li>
<li><a href="../en488018/index.html">CAPTCHA, special case: we break a neural network with thirty lines of code</a></li>
<li><a href="../en488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../en488026/index.html">Jewelery, Formlabs 3D Printer and Environmental Care</a></li>
<li><a href="../en488028/index.html">How to start making a game in UE4</a></li>
<li><a href="../en488030/index.html">How to organize skins in symfony</a></li>
<li><a href="../en488034/index.html">What can be done in 48 hours? Interview with the BioHack 2019 bioinformatics hackathon winner</a></li>
<li><a href="../en488036/index.html">The domain corp.com is for sale. It is dangerous for hundreds of thousands of corporate computers running Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>