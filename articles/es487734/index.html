<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙍🏻 🔙 🏂 Acelerar Entity Framework Core 👦🏻 👩🏻‍🎤 👴🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¡No seas avaricioso!
 Al seleccionar datos, debe elegir exactamente tantos como necesite a la vez. ¡Nunca recupere todos los datos de una tabla! 
 
 I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acelerar Entity Framework Core</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487734/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡No seas avaricioso!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al seleccionar datos, debe elegir exactamente tantos como necesite a la vez. </font><font style="vertical-align: inherit;">¡Nunca recupere todos los datos de una tabla! </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrecto:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);                
<span class="hljs-comment">//    ID  ,       !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.ID, x.Name, x.ShortName }).ToList();
</code></pre> <br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctamente:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);  
<span class="hljs-comment">//     ID     !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.Name, x.ShortName }).ToList();<font></font>
ctx.FederalDistricts.Select(x =&gt; <span class="hljs-keyword">new</span> MyClass { Name = x.Name, ShortName = x.ShortName }).ToList();
</code></pre><br>
<a name="habracut"></a><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrecto:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blog.ToList(); <span class="hljs-comment">//       . ?</span>
<span class="hljs-comment">//     ?</span>
<span class="hljs-keyword">var</span> somePost = blogs.FirstOrDefault(x=&gt;x.Title.StartWidth(“Hello world!”));
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctamente:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> somePost = context.Blog.FirstOrDefault(x=&gt;x.Title.StartWidth(“Hello world!”));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La validación de datos integrada se puede realizar cuando una consulta devuelve algunos registros. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrecto:</font></font></u><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">StandardizeUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> url</span>)</span><font></font>
{<font></font>
    url = url.ToLower();<font></font>
    <span class="hljs-keyword">if</span> (!url.StartsWith(<span class="hljs-string">"http://"</span>))<font></font>
    {<font></font>
        url = <span class="hljs-keyword">string</span>.Concat(<span class="hljs-string">"http://"</span>, url);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> url;<font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctamente:</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsEnumerable().Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
 <font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; blog.Contains(<span class="hljs-string">"dotnet"</span>))<font></font>
    .OrderByDescending(blog =&gt; blog.Rating)<font></font>
    .Select(blog =&gt; <span class="hljs-keyword">new</span><font></font>
    {<font></font>
        Id = blog.BlogId,<font></font>
        Url = StandardizeUrl(blog.Url)<font></font>
    })<font></font>
    .ToList();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wow, wow, wow, cronometrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es hora de actualizar un poco su conocimiento de las técnicas LINQ.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos las diferencias entre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList </font></font></i><i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsEnumerable</font></font></i></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AsQueryable</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Así que a la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lista</font></font></i><br>
<br>
<ul>
<li>  .</li>
<li> <i>.ToList()</i>           (lazy loading),            .</li>
</ul><br>
<i>AsEnumerable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li> : <i>Func &lt;TSource, bool&gt;</i></li>
<li>          (   <b>Where/Take/Skip</b>   , ,   select * from Table1, </li>
<li>    ,    N )</li>
<li>    : <i>Linq-to-SQL + Linq-to-Object</i>.</li>
<li> <i>IEnumerable </i>          (lazy loading).</li>
</ul><br>
<i>AsQueryable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">  :</a> <pre><code class="cs hljs">AsQueryable(IEnumerable)  AsQueryable&lt;TElement&gt;(IEnumerable&lt;TElement&gt;) </code></pre><br>
</li>
<li> Expression  T-SQL (   ),         .</li>
<li>  DbSet ( Entity Framework)    AsQueryable    .</li>
<li>   ,   <b>Take(5)</b>     <b>«select top 5 * SQL»</b>   .  ,       SQL  ,     .  <i>AsQueryable()</i>   ,  <i>AsEnumerable()</i>     T-SQL      Linq  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsQueryable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si desea una consulta de base de datos que pueda mejorarse antes de ejecutarse en el lado del servidor.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ejemplo de uso de AsQueryable en el caso más simple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;EmailView&gt; <span class="hljs-title">GetEmails</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> <span class="hljs-keyword">int</span> totalRecords, Guid? deviceWorkGroupID,
                DateTime? timeStart, DateTime? timeEnd, <span class="hljs-keyword">string</span> search, <span class="hljs-keyword">int</span>? confirmStateID, <span class="hljs-keyword">int</span>? stateTypeID, <span class="hljs-keyword">int</span>? limitOffset, <span class="hljs-keyword">int</span>? limitRowCount, <span class="hljs-keyword">string</span> orderBy, <span class="hljs-keyword">bool</span> desc</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> List&lt;EmailView&gt;();<font></font>
<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> GJobEntities())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> query = db.Emails.AsQueryable();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (timeStart != <span class="hljs-literal">null</span> &amp;&amp; timeEnd != <span class="hljs-literal">null</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.Created &gt;= timeStart &amp;&amp; p.Created &lt;= timeEnd);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (stateTypeID != <span class="hljs-literal">null</span> &amp;&amp; stateTypeID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.EmailStates.OrderByDescending(x =&gt; x.AtTime).FirstOrDefault().EmailStateTypeID == stateTypeID);<font></font>
                }<font></font>
<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (confirmStateID != <span class="hljs-literal">null</span> &amp;&amp; confirmStateID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> boolValue = confirmStateID == <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<font></font>
                    query = query.Where(p =&gt; p.IsConfirmed == boolValue);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrEmpty(search))<font></font>
                {<font></font>
                    search = search.ToLower();<font></font>
                    query = query.Where(p =&gt; (p.Subject + <span class="hljs-string">" "</span> + p.CopiesEmails + <span class="hljs-string">" "</span> + p.ToEmails + <span class="hljs-string">" "</span> + p.FromEmail + <span class="hljs-string">" "</span> + p.Body)<font></font>
                                        .ToLower().Contains(search));<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (deviceWorkGroupID != Guid.Empty)<font></font>
                {<font></font>
                    query = query.Where(x =&gt; x.SCEmails.FirstOrDefault().SupportCall.Device.DeviceWorkGroupDevices.FirstOrDefault(p =&gt; p.DeviceWorkGroupID == deviceWorkGroupID) != <span class="hljs-literal">null</span>);<font></font>
                }<font></font>
<font></font>
                totalRecords = query.Count();<font></font>
                query = query.OrderByDescending(p =&gt; p.Created);<font></font>
                <span class="hljs-keyword">if</span> (limitOffset.HasValue)<font></font>
                {<font></font>
                    query = query.Skip(limitOffset.Value).Take(limitRowCount.Value);<font></font>
                }<font></font>
                <span class="hljs-keyword">var</span> items = query.ToList(); <span class="hljs-comment">//    </span><font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">new</span> EmailView<font></font>
                    {<font></font>
                        ID = item.ID,<font></font>
                        SentTime = item.SentTime,<font></font>
                        IsConfirmed = item.IsConfirmed,<font></font>
                        Number = item.Number,<font></font>
                        Subject = item.Subject,<font></font>
                        IsDeleted = item.IsDeleted,<font></font>
                        ToEmails = item.ToEmails,<font></font>
                        Created = item.Created,<font></font>
                        CopiesEmails = item.CopiesEmails,<font></font>
                        FromEmail = item.FromEmail,<font></font>
                    };<font></font>
<font></font>
                    <span class="hljs-comment">//     - </span><font></font>
<font></font>
                    r.Add(n);<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> r;<font></font>
        }<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La magia de la lectura simple.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no necesita cambiar los datos, simplemente use el </font><font style="vertical-align: inherit;">método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AsNoTracking ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muestreo lento</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.ToList();</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Búsqueda rápida (solo lectura)</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsNoTracking().ToList();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Sientes que ya te has calentado un poco? </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipos de carga de datos relacionados</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que han olvidado lo que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es la carga perezosa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carga diferida </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Carga </font><i><font style="vertical-align: inherit;">diferida)</font></i><font style="vertical-align: inherit;"> significa que los datos asociados se cargan de forma transparente desde la base de datos al acceder a la propiedad de navegación. Lee más </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y al mismo tiempo, permíteme recordarte otros tipos de datos relacionados con la carga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carga activa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carga </font><i><font style="vertical-align: inherit;">ansiosa)</font></i><font style="vertical-align: inherit;"> significa que los datos asociados se cargan desde la base de datos como parte de la solicitud inicial.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blogs = context.Blogs<font></font>
        .Include(blog =&gt; blog.Posts)<font></font>
            .ThenInclude(post =&gt; post.Author)<font></font>
                .ThenInclude(author =&gt; author.Photo)<font></font>
        .Include(blog =&gt; blog.Owner)<font></font>
            .ThenInclude(owner =&gt; owner.Photo)<font></font>
        .ToList();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Atención! </font><font style="vertical-align: inherit;">A partir de la versión EF Core 3.0.0, cada inclusión hará </font><font style="vertical-align: inherit;">que </font><font style="vertical-align: inherit;">se agregue un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adicional </font><font style="vertical-align: inherit;">a las consultas SQL generadas por los proveedores relacionales, mientras que las versiones anteriores generaron consultas SQL adicionales. </font><font style="vertical-align: inherit;">Esto puede cambiar significativamente el rendimiento de sus consultas, para bien o para mal. </font><font style="vertical-align: inherit;">En particular, las consultas LINQ con un número extremadamente grande de declaraciones de inclusión se pueden dividir en varias consultas LINQ separadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carga explícita </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carga </font><i><font style="vertical-align: inherit;">explícita)</font></i><font style="vertical-align: inherit;"> significa que los datos asociados se cargaron explícitamente desde la base de datos más tarde.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blog = context.Blogs<font></font>
        .Single(b =&gt; b.BlogId == <span class="hljs-number">1</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> goodPosts = context.Entry(blog)<font></font>
        .Collection(b =&gt; b.Posts)<font></font>
        .Query()<font></font>
        .Where(p =&gt; p.Rating &gt; <span class="hljs-number">3</span>)<font></font>
        .ToList();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jerk y avance! </font><font style="vertical-align: inherit;">¿Hacia adelante?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Listo para acelerar aún más?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para acelerar drásticamente cuando se obtienen datos complejamente estructurados e incluso anormales de una base de datos relacional, hay dos formas de hacerlo: usar vistas indexadas (1) o, mejor aún, datos previamente preparados (calculados) en una forma plana simple para mostrar (2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista indizada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el contexto de MS SQL Server</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vista indizada tiene un índice agrupado único. </font><font style="vertical-align: inherit;">Un índice agrupado único se almacena en SQL Server y se actualiza como cualquier otro índice agrupado. </font><font style="vertical-align: inherit;">Una vista indizada es más importante que las vistas estándar, que incluyen el procesamiento complejo de una gran cantidad de filas, por ejemplo, agregar una gran cantidad de datos o combinar varias filas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si a menudo se hace referencia a dichas vistas en las consultas, podemos mejorar el rendimiento creando un índice agrupado único para la vista. Para la vista estándar, el conjunto de resultados no se almacena en la base de datos; en cambio, el conjunto de resultados se calcula para cada consulta, pero en el caso de un índice agrupado, el conjunto de resultados se almacena en la base de datos de la misma manera que una tabla con un índice agrupado. Las consultas que no utilizan específicamente la vista indizada pueden incluso beneficiarse de la existencia de un índice agrupado de la vista.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La representación de un índice tiene un cierto costo en forma de productividad. Si creamos una vista indizada, cada vez que cambiamos los datos en las tablas base, SQL Server debe admitir no solo los registros de índice en estas tablas, sino también los registros de índice en la vista. En las ediciones de SQL Server para desarrolladores y empresas, el optimizador puede usar índices de vista para optimizar consultas que no especifican una vista indizada. Sin embargo, en otras ediciones de SQL Server, la consulta debe incluir una vista indizada y proporcionar una sugerencia NOEXPAND para aprovechar el índice en la vista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(2) Si necesita realizar una solicitud que requiere la visualización de más de tres niveles de tablas relacionadas en la cantidad de tres o más con </font><b><font style="vertical-align: inherit;">CRUD</font></b><font style="vertical-align: inherit;"> aumentado</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cargar, la mejor manera sería calcular periódicamente el conjunto de resultados, guardarlo en una tabla y usarlo para mostrarlo. </font><font style="vertical-align: inherit;">La tabla resultante en la que se almacenarán los datos debe tener una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clave primaria e índices en los campos de búsqueda en LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué pasa con la asincronía?</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Si! </font><font style="vertical-align: inherit;">¡Lo usamos siempre que sea posible! </font><font style="vertical-align: inherit;">Aquí hay un ejemplo:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Do</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> myTask = GetFederalDistrictsAsync ();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> myTask.Result)<font></font>
    {<font></font>
         <span class="hljs-comment">// </span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
    optionsBuilder.UseSqlServer(conn);<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.ToListAsync();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y sí, ¿has olvidado algo para aumentar la productividad? </font><font style="vertical-align: inherit;">Buum!</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.&lt;b&gt;AsNoTracking()&lt;/b&gt;.ToListAsync();</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota: el método </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se </font><font style="vertical-align: inherit;">agregó solo con fines de demostración, a fin de indicar la operatividad del método </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetFederalDistrictsAsync ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como mis colegas notaron correctamente, se necesita otro ejemplo de asincronía pura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y permítanme darlo basado en el concepto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de un componente de vista en ASP .NET Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PopularPosts</span> : <span class="hljs-title">ViewComponent</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IStatsRepository _statsRepository;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PopularPosts</span>(<span class="hljs-params">IStatsRepository statsRepository</span>)</span><font></font>
        {<font></font>
            _statsRepository = statsRepository;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
           <span class="hljs-comment">//         -</span>
            <span class="hljs-keyword">var</span> federalDistricts = <span class="hljs-keyword">await</span> _statsRepository.GetFederalDistrictsAsync(); 
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> TablePageModel()<font></font>
            {<font></font>
                FederalDistricts = federalDistricts,<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">return</span> View(model);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">// </span><font></font>
    <font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span>  -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span>
        <span class="hljs-function">IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
	<span class="hljs-comment"><span class="hljs-doctag">///</span> !!!</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><font></font>
        Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync();<font></font>
    }	<font></font>
	<font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StatsRepository</span> : <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;<font></font>
            optionsBuilder = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfigurationRoot configurationRoot;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StatsRepository</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            IConfigurationBuilder configurationBuilder = <span class="hljs-keyword">new</span> ConfigurationBuilder()<font></font>
                    .SetBasePath(Environment.CurrentDirectory)<font></font>
                    .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">true</span>, reloadOnChange: <span class="hljs-literal">true</span>);<font></font>
            configurationRoot = configurationBuilder.Build();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToListAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> ctx.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToList();<font></font>
        }<font></font>
    }<font></font>
<font></font>
   <span class="hljs-comment">//         Home\Index </span>
    &lt;div id=<span class="hljs-string">"tableContainer"</span>&gt;<font></font>
            @await Component.InvokeAsync(<span class="hljs-string">"PopularPosts"</span>)<font></font>
     &lt;/div&gt;<font></font>
  <span class="hljs-comment">//   HTML      Shared\Components\PopularPosts\Default.cshtml</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permítame recordarle cuándo se ejecutan las consultas en Entity Framework Core. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al llamar a las declaraciones de LINQ, simplemente crea una vista de consulta en la memoria. </font><font style="vertical-align: inherit;">La solicitud se envía a la base de datos solo después de procesar los resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las siguientes son las operaciones más comunes que resultan en el envío de una solicitud a la base de datos.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iterar sobre los resultados en un bucle for.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar un operador, como ToList, ToArray, Single, Count.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlace de datos de los resultados de la consulta a la interfaz de usuario.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo organizar el código de EF Core en términos de arquitectura de la aplicación?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1) Desde el punto de vista de la arquitectura de la aplicación, debe asegurarse de que el código de acceso a su base de datos esté aislado / separado en un lugar claramente definido (de forma aislada). </font><font style="vertical-align: inherit;">Esto le permite encontrar el código de la base de datos que afecta el rendimiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(2) No mezcle el código de acceso para su base de datos con otras partes de la aplicación, como la interfaz de usuario o la API. </font><font style="vertical-align: inherit;">Por lo tanto, el código de acceso a la base de datos se puede cambiar sin preocuparse por otros problemas no relacionados con la base de datos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo guardar datos correctamente y rápidamente usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveChanges</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si los registros insertados son iguales, tiene sentido usar una operación de guardar para todos los registros. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrecto</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
    <span class="hljs-comment">//   1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1);<font></font>
<font></font>
  <span class="hljs-comment">//          db.SaveChanges();</span><font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correctamente</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
   <span class="hljs-comment">//  1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1); <font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
   <span class="hljs-comment">//    N </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Siempre hay excepciones a la regla. </font><font style="vertical-align: inherit;">Si el contexto de la transacción es complejo, es decir, consta de varias operaciones independientes, puede guardar después de cada operación. </font><font style="vertical-align: inherit;">Y es aún más correcto usar el almacenamiento asíncrono en una transacción.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddDepositToHousehold</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> householdId, DepositRequestModel model</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> transaction = <span class="hljs-keyword">await</span> Context.Database.BeginTransactionAsync(IsolationLevel.Snapshot))<font></font>
    {<font></font>
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            <span class="hljs-comment">//     </span>
            <span class="hljs-keyword">var</span> deposit = <span class="hljs-keyword">this</span>.Mapper.Map&lt;Deposit&gt;(model);
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Deposits.AddAsync(deposit);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//    </span>
               <span class="hljs-keyword">var</span> debtsToPay = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Debts.Where(d =&gt; d.HouseholdId == householdId &amp;&amp; !d.IsPaid).OrderBy(d =&gt; d.DateMade).ToListAsync();<font></font>
<font></font>
            debtsToPay.ForEach(d =&gt; d.IsPaid = <span class="hljs-literal">true</span>);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//   </span>
            <span class="hljs-keyword">var</span> household = <span class="hljs-keyword">this</span>.Context.Households.FirstOrDefaultAsync(h =&gt; h.Id == householdId);<font></font>
<font></font>
            household.Balance += model.DepositAmount;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            transaction.Commit();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.Ok();<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span><font></font>
        {<font></font>
            transaction.Rollback();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.BadRequest();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disparadores, campos calculados, funciones personalizadas y EF Core</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reducir la carga en las aplicaciones que contienen EF Core, tiene sentido usar campos calculados simples y disparadores de bases de datos, pero es mejor no involucrarse, ya que la aplicación puede ser muy confusa. </font><font style="vertical-align: inherit;">¡Pero las funciones definidas por el usuario pueden ser muy útiles, especialmente durante las operaciones de recuperación!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concurrencia en EF Core</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea paralelizar todo para acelerar, luego interrumpa: EF Core no admite la ejecución de varias operaciones paralelas en una instancia del contexto. </font><font style="vertical-align: inherit;">Espere a que se complete una operación antes de comenzar la siguiente. </font><font style="vertical-align: inherit;">Para hacer esto, generalmente necesita especificar la palabra clave de espera en cada operación asincrónica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EF Core utiliza consultas asincrónicas para evitar bloquear el flujo al ejecutar una consulta en la base de datos. </font><font style="vertical-align: inherit;">Las solicitudes asincrónicas son importantes para garantizar una respuesta rápida de la interfaz de usuario en clientes gruesos. </font><font style="vertical-align: inherit;">También pueden aumentar el rendimiento en una aplicación web, donde puede liberar el hilo para manejar otras solicitudes. </font><font style="vertical-align: inherit;">Aquí hay un ejemplo:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Blog&gt;&gt; GetBlogsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.Blogs.ToListAsync();<font></font>
    }<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué sabe sobre las consultas compiladas de LINQ?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tiene una aplicación que realiza consultas estructuralmente similares repetidamente en Entity Framework, a menudo puede mejorar el rendimiento compilando la consulta una vez y ejecutándola varias veces con diferentes parámetros. Por ejemplo, una aplicación puede necesitar obtener todos los clientes en una ciudad específica; el usuario indica la ciudad en tiempo de ejecución en el formulario. LINQ to Entities admite el uso de consultas compiladas para este propósito.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de .NET Framework 4.5, las consultas LINQ se almacenan en caché automáticamente. </font><font style="vertical-align: inherit;">Sin embargo, aún puede usar consultas LINQ compiladas para reducir este costo en ejecuciones posteriores, y las consultas compiladas pueden ser más eficientes que las consultas LINQ que se almacenan en caché automáticamente. </font><font style="vertical-align: inherit;">Tenga en cuenta que las consultas LINQ to Entities que aplican el operador Enumerable.Contains a las colecciones en memoria no se almacenan en caché automáticamente. </font><font style="vertical-align: inherit;">Además, no se permite la parametrización de colecciones en memoria en consultas LINQ compiladas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muchos ejemplos se pueden encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡No hagas contextos grandes de DbContext!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, conozco a muchos de ustedes, si no a todos, de perezosos f_u__c_k__e_r__s y de toda la base de datos que coloca en un contexto, especialmente esto es típico para el enfoque de Base de datos primero. </font><font style="vertical-align: inherit;">¡Y en vano lo haces! </font><font style="vertical-align: inherit;">El siguiente es un ejemplo de cómo se puede dividir el contexto. </font><font style="vertical-align: inherit;">Por supuesto, las tablas de conexión entre contextos deberán duplicarse, esto es un signo menos. </font><font style="vertical-align: inherit;">De una forma u otra, si tiene más de 50 tablas en el contexto, es mejor pensar en dividirlo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso de agrupación de contexto (agrupación DdContext)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El significado del grupo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es permitir la reutilización de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instancias </font><b><font style="vertical-align: inherit;">DbContext</font></b><font style="vertical-align: inherit;"> del grupo, lo que en algunos casos puede conducir a un mejor rendimiento que crear una nueva instancia cada vez. </font><font style="vertical-align: inherit;">Esta es también la razón principal para crear un grupo de conexiones en ADO.NET, aunque las ganancias de rendimiento para las conexiones serán más significativas ya que las conexiones son generalmente un recurso más difícil.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Demos</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Blog</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> BlogId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Url { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BloggingContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> InstanceCount;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BloggingContext</span>(<span class="hljs-params">DbContextOptions options</span>)
            : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span>
            =&gt; Interlocked.Increment(<span class="hljs-keyword">ref</span> InstanceCount);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Blog&gt; Blogs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BlogController</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> BloggingContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BlogController</span>(<span class="hljs-params">BloggingContext context</span>)</span> =&gt; _context = context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ActionAsync</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> _context.Blogs.FirstAsync();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> ConnectionString<font></font>
            = <span class="hljs-string">@"Server=(localdb)\mssqllocaldb;Database=Demo.ContextPooling;Integrated Security=True;ConnectRetryCount=0"</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            services.AddDbContext&lt;BloggingContext&gt;(c =&gt; c.UseSqlServer(ConnectionString));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Threads = <span class="hljs-number">32</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Seconds = <span class="hljs-number">10</span>;<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> _requestsProcessed;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> serviceCollection = <span class="hljs-keyword">new</span> ServiceCollection();
            <span class="hljs-keyword">new</span> Startup().ConfigureServices(serviceCollection);
            <span class="hljs-keyword">var</span> serviceProvider = serviceCollection.BuildServiceProvider();<font></font>
<font></font>
            SetupDatabase(serviceProvider);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> stopwatch = <span class="hljs-keyword">new</span> Stopwatch();<font></font>
<font></font>
            MonitorResults(TimeSpan.FromSeconds(Seconds), stopwatch);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> Task.WhenAll(<font></font>
                Enumerable<font></font>
                    .Range(<span class="hljs-number">0</span>, Threads)<font></font>
                    .Select(_ =&gt; SimulateRequestsAsync(serviceProvider, stopwatch)));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetupDatabase</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> context = serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (context.Database.EnsureCreated())<font></font>
                {<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Dog Blog"</span>, Url = <span class="hljs-string">"http://sample.com/dogs"</span> });<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Cat Blog"</span>, Url = <span class="hljs-string">"http://sample.com/cats"</span> });<font></font>
                    context.SaveChanges();<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SimulateRequestsAsync</span>(<span class="hljs-params">IServiceProvider serviceProvider, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.IsRunning)<font></font>
            {<font></font>
                <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
                {<font></font>
                    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> BlogController(serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;()).ActionAsync();<font></font>
                }<font></font>
<font></font>
                Interlocked.Increment(<span class="hljs-keyword">ref</span> _requestsProcessed);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MonitorResults</span>(<span class="hljs-params">TimeSpan duration, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> lastInstanceCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastRequestCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastElapsed = TimeSpan.Zero;<font></font>
<font></font>
            stopwatch.Start();<font></font>
<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.Elapsed &lt; duration)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">1</span>));<font></font>
<font></font>
                <span class="hljs-keyword">var</span> instanceCount = BloggingContext.InstanceCount;
                <span class="hljs-keyword">var</span> requestCount = _requestsProcessed;
                <span class="hljs-keyword">var</span> elapsed = stopwatch.Elapsed;
                <span class="hljs-keyword">var</span> currentElapsed = elapsed - lastElapsed;
                <span class="hljs-keyword">var</span> currentRequests = requestCount - lastRequestCount;<font></font>
<font></font>
                Console.WriteLine(<font></font>
                    <span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now:HH:mm:ss.fff}</span>] "</span>
                    + <span class="hljs-string">$"Context creations/second: <span class="hljs-subst">{instanceCount - lastInstanceCount}</span> | "</span>
                    + <span class="hljs-string">$"Requests/second: <span class="hljs-subst">{Math.Round(currentRequests / currentElapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
                lastInstanceCount = instanceCount;<font></font>
                lastRequestCount = requestCount;<font></font>
                lastElapsed = elapsed;<font></font>
            }<font></font>
<font></font>
            Console.WriteLine();<font></font>
            Console.WriteLine(<span class="hljs-string">$"Total context creations: <span class="hljs-subst">{BloggingContext.InstanceCount}</span>"</span>);<font></font>
            Console.WriteLine(<font></font>
                <span class="hljs-string">$"Requests per second:     <span class="hljs-subst">{Math.Round(_requestsProcessed / stopwatch.Elapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
            stopwatch.Stop();<font></font>
        }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo evitar errores innecesarios con CRUD en EF Core?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nunca inserte cálculos en el mismo código. </font><font style="vertical-align: inherit;">Separe siempre la formación / preparación de un objeto y su inserción / actualización. </font><font style="vertical-align: inherit;">Simplemente extiéndalo por función: verificando los datos ingresados ​​por el usuario, calculando los datos preliminares necesarios, mapeando o creando un objeto, y la operación CRUD real.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué hacer cuando las cosas están realmente mal con el rendimiento de la aplicación?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cerveza definitivamente no ayudará aquí. </font><font style="vertical-align: inherit;">Pero lo que ayudará es la separación de lectura y escritura en la arquitectura de la aplicación, seguida de la asignación de estas operaciones en sockets. </font><font style="vertical-align: inherit;">Piense en usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patrón de Segregación de responsabilidad de comando y consulta (CQRS)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y también intente dividir las tablas en insertar y leer entre dos bases de datos. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Acelere las aplicaciones para usted, amigos y colegas!</font></font></i></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es487716/index.html">Perfecto SAST. Analizador</a></li>
<li><a href="../es487720/index.html">Sobre el corutinismo competitivo (usando la programación reactiva como ejemplo)</a></li>
<li><a href="../es487724/index.html">BlazingPizza: aplicación Blazor de principio a fin. Parte 2. Agregar un componente</a></li>
<li><a href="../es487728/index.html">Compilación de @Pythonetc, enero de 2020</a></li>
<li><a href="../es487730/index.html">Procesamiento natural del lenguaje. Resultados 2019 y tendencias para 2020</a></li>
<li><a href="../es487738/index.html">Esquema de animación en SCADA</a></li>
<li><a href="../es487740/index.html">Ensamblar un magnetómetro portátil</a></li>
<li><a href="../es487742/index.html">Comercio de Arbitraje (Algoritmo Bellman-Ford)</a></li>
<li><a href="../es487744/index.html">FARO presenta el escáner láser 3D FOCUS S 70</a></li>
<li><a href="../es487746/index.html">Eterno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>