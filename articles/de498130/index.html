<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏽‍🤝‍🧑🏽 🖕🏼 🗻 Erstellen Sie mit Kubernetes eine TODO-API für Golang 👨🏿‍🏫 😛 💈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen! Vor dem Start des Kurses zur Infrastrukturplattform auf Kubernetes-Basis haben wir eine Übersetzung eines weiteren interessanten ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Erstellen Sie mit Kubernetes eine TODO-API für Golang</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/498130/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen! </font><font style="vertical-align: inherit;">Vor dem Start des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurses zur Infrastrukturplattform auf Kubernetes-Basis haben wir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eine Übersetzung eines weiteren interessanten Materials vorbereitet.</font></font></b></i><br>
<br>
<hr><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dieser Artikel richtet sich an Neulinge in Kubernetes, die ein praktisches Beispiel für das Schreiben einer Golang-API zum Verwalten der TODO-Liste und das anschließende Bereitstellen auf Kubernetes verstehen möchten. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Entwickler liebt eine gute TODO-Liste, oder? </font><font style="vertical-align: inherit;">Wie könnten wir uns sonst anders organisieren? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/jy/vw/gdjyvw5u8cexjnsseoybworcx7a.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeder Entwickler liebt eine gute TODO-Anwendung, oder? </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst überprüfen wir die Liste der erforderlichen Komponenten, konfigurieren dann Kubernetes, stellen die Postgresql-Datenbank bereit und installieren ein Anwendungsframework, mit dessen Hilfe wir die Go-API in Kubernetes problemlos bereitstellen können, ohne uns auf die Details zu konzentrieren.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden zwei Endpunkte in der API erstellen - einen zum Erstellen eines neuen TODO-Datensatzes und einen zum Auswählen aller TODO-Datensätze. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der gesamte Code aus diesem Tutorial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist auf GitHub verfügbar.</font></font></a></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Liste der notwendigen Komponenten:</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lokal installierter Docker</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes führt Code in Container-Images aus, daher müssen Sie Docker auf Ihrem Computer installieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie Docker: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.docker.com</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Registrieren Sie ein Docker Hub-Konto, um Ihre Docker-Images zu speichern: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Cluster</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können entweder einen lokalen oder einen Remote-Cluster auswählen, aber welcher ist besser? </font><font style="vertical-align: inherit;">Vereinfachte Optionen wie k3d funktionieren auf jedem Computer, auf dem Docker ausgeführt werden kann, sodass für die Ausführung eines lokalen Clusters nicht mehr viel RAM erforderlich ist. </font><font style="vertical-align: inherit;">Ein Remote-Cluster kann auch eine sehr effiziente Lösung sein. Beachten Sie jedoch, dass alle Docker-Images für jede Änderung hochgeladen und hochgeladen werden müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie k3d: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/rancher/k3d</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
k3d installiert kubectl nicht (dies ist die CLI für Kubernetes). Installieren Sie es daher separat von hier: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kubernetes.io/docs/tasks/tools / install-kubectl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen Golang auch mit der IDE auf Ihrem Computer installieren. </font><font style="vertical-align: inherit;">Go ist kostenlos und kann unter dem folgenden Link für MacOS, Windows oder Linux heruntergeladen werden: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://golang.org/dl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDE</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich würde empfehlen, Visual Studio Code zu verwenden. Es ist kostenlos und enthält eine Reihe von Plugins für Go, die Sie hinzufügen können. </font><font style="vertical-align: inherit;">Einige Kollegen bevorzugen Goland von Jetbrains. </font><font style="vertical-align: inherit;">Wenn Sie ein Java-Programmierer sind, würden Sie wahrscheinlich lieber für Goland bezahlen, da dies Sie an die anderen Produkte erinnert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSCode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie einen Cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen die gesamte im vorherigen Abschnitt angegebene Software installieren.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie mit k3d einen neuen Cluster:</font></font></h4><br>
<code>k3d create</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurieren Sie kubectl so, dass es auf einen neuen Cluster verweist. </font><font style="vertical-align: inherit;">Denken Sie daran, dass mehrere Cluster von einem Computer aus verwendet werden können. Daher ist es äußerst wichtig, auf den richtigen zu verweisen:</font></font><br>
<br>
<pre><code class="go hljs">export KUBECONFIG=<span class="hljs-string">"$(k3d get-kubeconfig --name='k3s-default')"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie sicher, dass der Cluster mindestens einen Knoten hat. </font><font style="vertical-align: inherit;">Hier können Sie sehen, dass ich Kubernetes 1.17 installiert habe - eine relativ neue Version:</font></font><br>
<br>
<pre><code class="go hljs">kubectl get node<font></font>
NAME                     STATUS   ROLES    AGE   VERSION<font></font>
k3d-k3s-<span class="hljs-keyword">default</span>-server   Ready    master   <span class="hljs-number">48</span>s   v1<span class="hljs-number">.17</span><span class="hljs-number">.0</span>+k3s<span class="hljs-number">.1</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden unsere TODO-Datensätze in der Datenbanktabelle speichern, daher müssen wir sie jetzt installieren. </font><font style="vertical-align: inherit;">Postgresql ist eine beliebte relationale Datenbank, die wir mithilfe des Helm-Diagramms in einem Cluster installieren können.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren Sie Arkade</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arkade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein CLI Go, ähnlich wie "Brew" oder "Apt-Get", jedoch für Kubernetes-Anwendungen. </font><font style="vertical-align: inherit;">Es verwendet ein Helm-, Kubectl- oder CLI-Projekt, um ein Projekt oder Produkt in Ihrem Cluster zu installieren.</font></font><br>
<br>
<pre><code class="go hljs">curl -sLS https:<span class="hljs-comment">//dl.get-arkade.dev | sudo sh</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie nun Postgresql</font></font><br>
<br>
<pre><code class="go hljs">arkade install postgresql<font></font>
===================================================================== = PostgreSQL has been installed.                                    =<font></font>
=====================================================================</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie sehen auch Informationen zur Verbindungszeichenfolge und zum Starten der Postgresql-CLI über das Docker-Image im Cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können diese Informationen jederzeit mit erhalten </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden das Tabellenlayout entwerfen</font></font><br>
<br>
<pre><code class="go hljs">CREATE TABLE todo (<font></font>
 id              INT GENERATED ALWAYS AS IDENTITY,<font></font>
 description     text NOT NULL,<font></font>
 created_date    timestamp NOT NULL,<font></font>
 completed_date  timestamp NOT NULL<font></font>
);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie aus </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um die Verbindungsinformationen erneut abzurufen. </font><font style="vertical-align: inherit;">Es sollte ungefähr so ​​aussehen:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
kubectl run postgresql-client --rm --tty -i --restart=<span class="hljs-string">'Never'</span> --namespace <span class="hljs-keyword">default</span> --image docker.io/bitnami/postgresql:<span class="hljs-number">11.6</span><span class="hljs-number">.0</span>-debian<span class="hljs-number">-9</span>-r0 --env=<span class="hljs-string">"PGPASSWORD=$POSTGRES_PASSWORD"</span> --command -- psql --host postgresql -U postgres -d postgres -p <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben Sie an der Eingabeaufforderung: </font></font><code>postgres = #</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können die Tabelle erstellen, indem Sie sie in sie kopieren und dann ausführen </font></font><code>\dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um die Tabelle anzuzeigen:</font></font><br>
<br>
<pre><code class="go hljs">postgres=# \dt<font></font>
List of relations<font></font>
Schema | Name | Type  |  Owner<font></font>
--------+------+-------+----------<font></font>
public | todo | table | postgres<font></font>
(<span class="hljs-number">1</span> row)</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren Sie das Anwendungsframework</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So wie PHP-Entwickler ihren Workflow mit LAMP (Linux Apache + MySQL + PHP) und Rails-Entwickler mit einem vorbereiteten Stack beschleunigten, können Kubernetes-Entwickler Anwendungsframeworks verwenden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der PLONK-Stack steht für Prometheus, Linux, OpenFaaS, NATS und Kubernetes.</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus bietet Metriken, automatische Skalierung und Beobachtbarkeit, um den Zustand Ihres Systems zu testen, ermöglicht es ihm, auf steigende Nachfrage zu reagieren und Kosten zu senken, indem Metriken bereitgestellt werden, um Entscheidungen über die Skalierung auf Null zu treffen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obwohl Linux nicht die einzige Option zum Ausführen von Workloads in Kubernetes ist, ist es Standard und am einfachsten zu verwenden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ursprünglich stellte OpenFaaS Entwicklern tragbare Funktionen zur Verfügung, funktioniert jedoch hervorragend bei der Bereitstellung von APIs und Microservices. </font><font style="vertical-align: inherit;">Aufgrund seiner Vielseitigkeit können alle Docker-Container mit einem HTTP-Server bereitgestellt und verwaltet werden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NATS ist ein beliebtes CNCF-Projekt für Messaging und Pub / Sub. </font><font style="vertical-align: inherit;">Im PLONK-Stack bietet es die Möglichkeit, Anforderungen asynchron auszuführen und in die Warteschlange zu stellen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes ist der Grund, warum wir hier sind. </font><font style="vertical-align: inherit;">Es bietet eine skalierbare, selbstheilende und deklarative Infrastruktur. </font><font style="vertical-align: inherit;">Und wenn Sie nicht mehr Teil dieser Größe benötigen, wird die API mit OpenFaaS vereinfacht.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installieren Sie den PLONK-Stack über Arkade:</font></font><br>
<br>
<pre><code class="go hljs">arkade install openfaas</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie die Informationsnachricht und führen Sie jeden Befehl aus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren Sie faas-cli.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Holen Sie sich Ihr Passwort.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leiten Sie die OpenFaaS-Gateway-Benutzeroberfläche um (über Port 8080).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melden Sie sich über die CLI beim System an.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach wie vor können Sie mit eine Informationsnachricht erhalten </font></font><code> info openfaas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie Ihre First Go-API bereit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt verschiedene Möglichkeiten, eine Go-API mit PLONK zu erstellen. </font><font style="vertical-align: inherit;">Die erste Option besteht darin, die Docker-Datei zu verwenden und den TCP-Port, die Integritätsprüfung, den HTTP-Server usw. manuell zu ermitteln. </font><font style="vertical-align: inherit;">Dies kann mit erfolgen </font></font><code>faas-cli new --lang dockerfile API_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es gibt jedoch einen einfacheren und automatisierteren Weg. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zweite Möglichkeit besteht darin, die vom Funktionsspeicher angebotenen integrierten Vorlagen zu verwenden:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store list | grep <span class="hljs-keyword">go</span>
<span class="hljs-keyword">go</span>                       openfaas           Classic Golang template<font></font>
golang-http              openfaas-incubator Golang HTTP template<font></font>
golang-middleware        openfaas-incubator Golang Middleware template</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir eine herkömmliche HTTP-API erstellen möchten, ist die Golang-Middleware-Vorlage am besten geeignet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu Beginn des Tutorials haben Sie sich bei Ihrem Docker Hub-Konto registriert, um Ihre Docker-Bilder zu speichern. </font><font style="vertical-align: inherit;">Jede Kubernetes-Workload muss in ein Docker-Image eingebettet sein, bevor sie bereitgestellt werden kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ziehen Sie das spezielle Muster hoch:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store pull golang-middleware</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie Scaffold für Ihre API mit Golang-Middleware und Ihrem Benutzernamen im Docker Hub:</font></font><br>
<br>
<pre><code class="go hljs">export PREFIX=alexellis2<font></font>
export LANG=golang-middleware<font></font>
export API_NAME=todo<font></font>
faas-cli <span class="hljs-built_in">new</span> --lang $LANG --prefix $PREFIX $API_NAME</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie sehen zwei generierte Dateien:</font></font><br>
<br>
<ul>
<li><code>./todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - bietet eine Möglichkeit zum Konfigurieren, Bereitstellen und Installieren der Vorlage und des Namens</font></font></li>
<li><code>./todo/handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Hier schreiben Sie den Code und fügen alle anderen Dateien oder Pakete hinzu, die Sie benötigen</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns etwas bearbeiten und dann den Code erweitern.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> function
<span class="hljs-keyword">import</span> (
   <span class="hljs-string">"net/http"</span>
   <span class="hljs-string">"encoding/json"</span><font></font>
)<font></font>
<span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   Description <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {<font></font>
   todos := []Todo{}<font></font>
   todos = <span class="hljs-built_in">append</span>(todos, Todo{Description: <span class="hljs-string">"Run faas-cli up"</span>})<font></font>
   res, _ := json.Marshal(todos)<font></font>
   w.WriteHeader(http.StatusOK)<font></font>
   w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)<font></font>
   w.Write([]<span class="hljs-keyword">byte</span>(res))<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie VScode und seine Plugins nicht zum Bearbeiten und Formatieren des Codes verwenden, führen Sie ihn nach jeder Änderung aus, um sicherzustellen, dass die Datei korrekt formatiert ist.</font></font><br>
<br>
<pre><code class="go hljs">gofmt -w -s ./todo/handler.<span class="hljs-keyword">go</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie nun den Code bereit. Erstellen Sie zunächst ein neues Image, starten Sie es im Docker Hub und stellen Sie es mithilfe der OpenFaaS-API im Cluster bereit:</font></font><br>
<br>
<pre><code class="go hljs">Invoke your endpoint when ready:<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo</span><font></font>
{<font></font>
<span class="hljs-string">"description"</span>: <span class="hljs-string">"Run faas-cli up"</span>
}</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ermöglichen Sie Benutzern das Erstellen neuer TODO-Datensätze</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt können Benutzer neue Einträge in ihrer TODO-Liste erstellen. </font><font style="vertical-align: inherit;">Zuerst müssen Sie den Link oder die "Abhängigkeit" für "Gehe zur Postgresql-Bibliothek" hinzufügen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir können es mit den Verkaufsautomaten oder Go-Modulen erhalten, die in Go 1.11 eingeführt und standardmäßig in Go 1.13 installiert wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und fügen Sie das Modul hinzu, das wir für den Zugriff auf Postgresql benötigen:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">import</span> (
   <span class="hljs-string">"database/sql"</span>
   _ <span class="hljs-string">"github.com/lib/pq"</span>
...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit Go-Module Abhängigkeiten erkennen können, müssen wir etwas in der Datei deklarieren, das wir später verwenden werden. </font><font style="vertical-align: inherit;">Wenn dies nicht der Fall ist, löscht VSCode diese Zeilen beim Speichern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie dies unter den Importen in der Datei hinzu</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">var</span> db *sql.DB</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immer diese Befehle im ausführen </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ordner , in </font><font style="vertical-align: inherit;">dem er sich befindet </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und nicht auf der Stammebene c </font></font><code>todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialisieren Sie das neue Go-Modul:</font></font><br>
<br>
<pre><code class="go hljs">cd todo/<font></font>
ls<font></font>
handler.<span class="hljs-keyword">go</span><font></font>
export GO111MODULE=on<font></font>
<span class="hljs-keyword">go</span> mod init</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie nun die Datei mithilfe der pq-Bibliothek:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cat <span class="hljs-keyword">go</span>.mod<font></font>
module github.com/alexellis/todo1/todo<font></font>
<span class="hljs-keyword">go</span> <span class="hljs-number">1.13</span>
require github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was auch immer drin ist </font></font><code>go.mod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kopiere seinen Inhalt nach</font></font><code>GO_REPLACE.txt</code><br>
<br>
<pre><code class="go hljs">cat <span class="hljs-keyword">go</span>.mod &gt; GO_REPLACE.txt</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie nun sicher, dass die Assembly noch funktioniert, bevor Sie den Einfügecode hinzufügen.</font></font><br>
<br>
<pre><code class="go hljs">faas-cli build -f todo.yml --build-arg GO111MODULE=on</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Möglicherweise stellen Sie fest, dass wir jetzt </font></font><code>--build-arg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein Muster für die Verwendung von Go-Modulen melden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während der Montage sehen Sie, dass die Module nach Bedarf aus dem Internet heruntergeladen werden.</font></font><br>
<br>
<pre><code class="go hljs">Step <span class="hljs-number">16</span>/<span class="hljs-number">29</span> : RUN <span class="hljs-keyword">go</span> test ./... -cover<font></font>
---&gt; Running in <span class="hljs-number">9</span>a4017438500
<span class="hljs-keyword">go</span>: downloading github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: extracting github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: finding github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span><font></font>
?       github.com/alexellis/todo1/todo [no test files]<font></font>
Removing intermediate container <span class="hljs-number">9</span>a4017438500</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurieren von Geheimnissen für den Postgresql-Zugriff</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir können einen Verbindungspool in erstellen </font></font><code>init ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, eine Methode, die beim Programmstart nur einmal ausgeführt wird.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// init       .   ,     ,   /   /</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
       <span class="hljs-keyword">if</span> _, err := os.Stat(<span class="hljs-string">"/var/openfaas/secrets/password"</span>); err == <span class="hljs-literal">nil</span> {<font></font>
               password, _ := sdk.ReadSecret(<span class="hljs-string">"password"</span>)<font></font>
               user, _ := sdk.ReadSecret(<span class="hljs-string">"username"</span>)<font></font>
               host, _ := sdk.ReadSecret(<span class="hljs-string">"host"</span>)<font></font>
               dbName := os.Getenv(<span class="hljs-string">"postgres_db"</span>)<font></font>
               port := os.Getenv(<span class="hljs-string">"postgres_port"</span>)<font></font>
               sslmode := os.Getenv(<span class="hljs-string">"postgres_sslmode"</span>)<font></font>
               connStr := <span class="hljs-string">"postgres://"</span> + user + <span class="hljs-string">":"</span> + password + <span class="hljs-string">"@"</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/"</span> + dbName + <span class="hljs-string">"?sslmode="</span> + sslmode
<span class="hljs-keyword">var</span> err error<font></font>
               db, err = sql.Open(<span class="hljs-string">"postgres"</span>, connStr)
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
               err = db.Ping()<font></font>
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie bemerkt haben, werden einige Informationen aus dem extrahiert, was </font></font><code> os.Getenv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus der Umgebung gelesen wird. </font><font style="vertical-align: inherit;">Ich würde diese Werte als nicht vertraulich betrachten, sie sind in der Datei festgelegt </font></font><code>todo.y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Rest, wie das Passwort und der Host, die vertraulich sind, werden in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Geheimnissen aufbewahrt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können sie durch </font></font><code>faas-cli secret create</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder durch </font><font style="vertical-align: inherit;">erstellen </font></font><code>kubectl create secret generic -n openfaas-fn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zeichenfolge </font></font><code>sdk.ReadSecret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stammt aus dem OpenFaaS Cloud SDK mit folgendem Import : </font></font><code>github.com/openfaas/openfaas-cloud/sdk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es liest eine geheime Datei von der Festplatte und gibt einen Wert oder Fehler zurück. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Holen Sie sich die geheimen Werte von </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie nun für jedes Passwort wie folgt vor:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
export USERNAME=<span class="hljs-string">"postgres"</span><font></font>
export PASSWORD=$POSTGRES_PASSWORD<font></font>
export HOST=<span class="hljs-string">"postgresql.default"</span><font></font>
faas-cli secret create username --from-literal $USERNAME<font></font>
faas-cli secret create password --from-literal $PASSWORD<font></font>
faas-cli secret create host --from-literal $HOST</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie die Geheimnisse auf Verfügbarkeit und Konformität:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli secret ls<font></font>
NAME<font></font>
username<font></font>
password<font></font>
host<font></font>
# And via kubectl:<font></font>
kubectl get secret -n openfaas-fn<font></font>
NAME                  TYPE                                  DATA   AGE<font></font>
username              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
password              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
host                  Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">12</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie unsere YAML-Datei und fügen Sie Folgendes hinzu:</font></font><br>
<br>
<pre><code class="go hljs">secrets:<font></font>
   - host<font></font>
   - password<font></font>
   - username<font></font>
   environment:<font></font>
     postgres_db: postgres<font></font>
     postgres_sslmode: <span class="hljs-string">"disable"</span>
     postgres_port: <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie als Nächstes die Go-Module und führen Sie den Build erneut aus:</font></font><br>
<br>
<pre><code class="go hljs">cd todo
<span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cd ..<font></font>
faas-cli build -f todo.yml --build-arg GO111MODULE=on<font></font>
Successfully built d2c609f8f559<font></font>
Successfully tagged alexellis2/todo:latest<font></font>
Image: alexellis2/todo:latest built.<font></font>
[<span class="hljs-number">0</span>] &lt; Building todo done in <span class="hljs-number">22.50</span>s.<font></font>
[<span class="hljs-number">0</span>] Worker done.<font></font>
Total build time: <span class="hljs-number">22.50</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Assembly hat wie erwartet funktioniert. Führen Sie sie daher </font></font><code>faas-cli</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit denselben Argumenten aus, um das Image zu starten und bereitzustellen. </font><font style="vertical-align: inherit;">Wenn die Anmeldeinformationen und die SQL-Konfiguration korrekt sind, werden keine Fehler in den Protokollen angezeigt. Wenn sie jedoch falsch sind, wird der Panikcode in init () angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie die Protokolle:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z Forking - ./handler []
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stderr from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stdout from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> OperationalMode: http
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Timeouts: read: <span class="hljs-number">10</span>s, write: <span class="hljs-number">10</span>s hard: <span class="hljs-number">10</span>s.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Listening on port: <span class="hljs-number">8080</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Metrics listening on port: <span class="hljs-number">8081</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Writing lock-file to: /tmp/.lock</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während alles gut aussieht, versuchen wir jetzt, den Endpunkt aufzurufen:</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">11</span>:<span class="hljs-number">02</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">02</span> POST / - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">35</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir eine erfolgreiche Verbindung zur Datenbank hergestellt und können das Einfügen durchführen. </font><font style="vertical-align: inherit;">Woher wissen wir das? </font><font style="vertical-align: inherit;">Weil es </font></font><code>db.Ping ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einen Fehler zurückgibt, sonst hätte es eine Panik ausgelöst:</font></font><br>
<br>
<pre><code class="go hljs">err = db.Ping()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
   <span class="hljs-built_in">panic</span>(err.Error())<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Folgen Sie dem Link für weitere Details zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenbank- / SQL-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Den Einfügecode schreiben</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Code fügt eine neue Zeile in die Tabelle ein </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und verwendet eine spezielle Syntax, bei der der Wert nicht in Anführungszeichen eingeschlossen, sondern durch den Code db.Query ersetzt wird. </font><font style="vertical-align: inherit;">In den "alten Tagen" der LAMP-Programmierung war ein häufiger Fehler, der dazu führte, dass viele Systeme unsicher wurden, das Fehlen einer Bereinigung der Eingabedaten und die Verkettung von Benutzereingaben direkt in die SQL-Anweisung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie sich vor, jemand gibt eine Beschreibung ein. </font></font><code>drop table todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es würde nicht sehr lustig sein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher führen wir </font></font><code>db.Query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dann die SQL - </font><font style="vertical-align: inherit;">Anweisung übergeben verwendet </font></font><code>$1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usw. für jeden Wert, und dann können wir das Ergebnis und / oder Fehler. </font><font style="vertical-align: inherit;">Wir müssen dieses Ergebnis auch schließen, also verwenden Sie hierfür die Verzögerung.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insert</span><span class="hljs-params">(description <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> {<font></font>
       res, err := db.Query(<span class="hljs-string">`insert into todo (id, description, created_date) values (DEFAULT, $1, now());`</span>,<font></font>
               description)<font></font>
       <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
               <span class="hljs-keyword">return</span> err<font></font>
       }<font></font>
       <span class="hljs-keyword">defer</span> res.Close()
       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verbinden wir dies nun mit dem Code.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
       <span class="hljs-keyword">if</span> r.Method == http.MethodPost &amp;&amp; r.URL.Path == <span class="hljs-string">"/create"</span> {
               <span class="hljs-keyword">defer</span> r.Body.Close()<font></font>
               body, _ := ioutil.ReadAll(r.Body)<font></font>
               <span class="hljs-keyword">if</span> err := insert(<span class="hljs-keyword">string</span>(body)); err != <span class="hljs-literal">nil</span> {<font></font>
                       http.Error(w, fmt.Sprintf(<span class="hljs-string">"unable to insert todo: %s"</span>, err.Error()), http.StatusInternalServerError)<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie es uns bereitstellen und ausführen.</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli build"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli push"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli deploy"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie die API-Protokolle:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">35</span>:<span class="hljs-number">29</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">29</span> POST /create - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie den Inhalt der Tabelle mit pgsql:</font></font><br>
<br>
<pre><code class="sql hljs">export POSTGRES_PASSWORD=$(kubectl get secret <span class="hljs-comment">--namespace default postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)</span>
kubectl run postgresql-client <span class="hljs-comment">--rm --tty -i --restart='Never' --namespace default --image docker.io/bitnami/postgresql:11.6.0-debian-9-r0 --env="PGPASSWORD=$POSTGRES_PASSWORD" --command -- psql --host postgresql -U postgres -d postgres -p 5432</span>
postgres=<span class="hljs-comment"># select * from todo;</span><font></font>
id |   description   |        created_date        | completed_date<font></font>
<span class="hljs-comment">----+-----------------+----------------------------+----------------</span><font></font>
1 | faas-cli build  | 2020-03-26 14:36:03.367789 |<font></font>
2 | faas-cli push   | 2020-03-26 14:36:03.389656 |<font></font>
3 | faas-cli deploy | 2020-03-26 14:36:03.797881 |</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Herzlichen Glückwunsch, Sie haben jetzt eine TODO-API, die eingehende Anforderungen über </font></font><code>curl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder einen anderen HTTP-Client </font><font style="vertical-align: inherit;">annehmen </font><font style="vertical-align: inherit;">und in die Datenbanktabelle schreiben kann.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datensatzanforderung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen wir eine neue Funktion zum Abfragen von TODO-Datensätzen aus einer Tabelle:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
   var error err<font></font>
   var todos []Todo<font></font>
   return todos, err<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir können diese Auswahlmethode nicht benennen, da es sich um ein reserviertes Schlüsselwort für die Arbeit mit Goroutinen handelt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verbinden Sie nun die Methode mit dem Haupthandler:</font></font><br>
<br>
<pre><code class="sql hljs">} else if r.Method == http.MethodGet &amp;&amp; r.URL.Path == "/list" {<font></font>
   todos, err := selectTodos()<font></font>
   if err != nil {<font></font>
       http.Error(w, fmt.Sprintf("unable to get todos: %s", err.Error()), http.StatusInternalServerError)<font></font>
   }<font></font>
   out, _ := json.Marshal(todos)<font></font>
   w.Header().Set("Content-Type", "application/json")<font></font>
   w.Write(out)<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie die Todo-Struktur, da unser Datenschema zusätzliche Felder für Datumsangaben enthält:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   ID <span class="hljs-keyword">int</span> <span class="hljs-string">`json:"id"`</span>
   Description   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span>
   CreatedDate   *time.Time <span class="hljs-string">`json:"created_date"`</span>
   CompletedDate *time.Time <span class="hljs-string">`json:"completed_date"`</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen wir nun den </font></font><code>selectTodos()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anforderungscode </font><font style="vertical-align: inherit;">zu unserer Methode hinzu </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
       rows, getErr := db.Query(`<span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, description, created_date, completed_date <span class="hljs-keyword">from</span> todo;`)<font></font>
   if getErr != nil {<font></font>
       return []Todo{}, errors.Wrap(getErr, "unable to get from todo table")<font></font>
   }<font></font>
   todos := []Todo{}<font></font>
   defer rows.Close()<font></font>
   for rows.Next() {<font></font>
       result := Todo{}<font></font>
       scanErr := rows.Scan(&amp;result.ID, &amp;result.Description, &amp;result.CreatedDate, &amp;result.CompletedDate)<font></font>
       if scanErr != nil {<font></font>
           log.Println("scan err:", scanErr)<font></font>
       }<font></font>
       todos = append(todos, result)<font></font>
   }<font></font>
   return todos, nil<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach wie vor müssen wir das Schließen der Zeilen für die Anforderung verzögern. </font><font style="vertical-align: inherit;">Jeder Wert wird mit der Methode rows.Scan in die neue Struktur eingefügt. </font><font style="vertical-align: inherit;">Am Ende der Methode haben wir einen Teil des Todo-Inhalts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lass es uns versuchen:</font></font><br>
<br>
<pre><code class="sql hljs">faas-cli up -f todo.yml <span class="hljs-comment">--build-arg GO111MODULE=on</span>
curl http://127.0.0.1:8080/function/todo/list</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist das Ergebnis:</font></font><br>
<br>
<pre><code class="sql hljs">[<font></font>
 {<font></font>
   "id": 2,<font></font>
   "description": "faas-cli build",<font></font>
   "created_date": "2020-03-26T14:36:03.367789Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 3,<font></font>
   "description": "faas-cli push",<font></font>
   "created_date": "2020-03-26T14:36:03.389656Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 4,<font></font>
   "description": "faas-cli deploy",<font></font>
   "created_date": "2020-03-26T14:36:03.797881Z",<font></font>
   "completed_date": null<font></font>
 }<font></font>
]</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Werte zu entfernen, können wir die Strukturanmerkungen aktualisieren, indem wir Folgendes hinzufügen </font></font><code>omitempty</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="go hljs">CompletedDate *time.Time <span class="hljs-string">`json:"completed_date,omitempty"`</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um die geleistete Arbeit zusammenzufassen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind noch nicht fertig, aber dies ist ein guter Moment, um anzuhalten und zu überprüfen, was wir bisher erreicht haben. </font><font style="vertical-align: inherit;">Wir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installierte Go, Docker, Kubectl und VSCode (IDE)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitgestellte Kubernetes auf unserem lokalen Computer</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installierte Postgresql mit Arkade und Helm3</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installierte OpenFaaS und den PLONK-Stack für Kubernetes-Anwendungsentwickler</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellt die anfängliche statische REST-API mit Go und </font></font><code>golang-middleware</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der OpenFaaS-Vorlage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der TODO-API wurde die Funktion zum Einfügen hinzugefügt </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auswahlfunktion zu unserer TODO-API hinzugefügt </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das vollständige Codebeispiel, das wir bisher erstellt haben, ist in meinem GitHub-Konto verfügbar: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexellis / kubernetes-todo-go-app</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dann können wir viel mehr tun, zum Beispiel:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzufügen der Authentifizierung mithilfe eines statischen Träger-Tokens</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie eine Webseite mit einer statischen HTML- oder React-Vorlage, um eine TODO-Liste zu rendern und neue Elemente zu erstellen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzufügen von Mehrbenutzerunterstützung zur API</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und vieles mehr. </font><font style="vertical-align: inherit;">Wir könnten uns auch mit dem PLONK-Stack befassen und das Grafana-Dashboard bereitstellen, um mit der Überwachung unserer API zu beginnen und zu verstehen, wie viele Ressourcen mit dem Kubernetes-Dashboard oder dem Metrikserver (installiert mit </font></font><code>arkade install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) verwendet werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere </font><font style="vertical-align: inherit;">
Informationen zu arkade </font><font style="vertical-align: inherit;">: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://get-arkade.dev</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Besuchen Sie den OpenFaaS-Workshop, um mehr über die oben genannten Themen zu erfahren: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/openfaas/workshop/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sie können meinen Premium-Newsletter für Insider-Updates unter </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https: /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> abonnieren </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">/www.alexellis.io/</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
und auf meinem Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alex Ellis</font></font></a><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erfahren Sie mehr über den Kurs</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498120/index.html">Build Time Optimization - Teil 1</a></li>
<li><a href="../de498122/index.html">So testen Sie an einem entfernten Standort, um das Produkt und Ihr Leben nicht zu ruinieren</a></li>
<li><a href="../de498124/index.html">Telegramm für technischen Support: Tools und Fallstricke</a></li>
<li><a href="../de498126/index.html">Wie Amazon versucht, die Leute zum Kauf zu bewegen ... weniger</a></li>
<li><a href="../de498128/index.html">Problem Nr. 36: IT-Schulung - aktuelle Probleme und Herausforderungen führender Unternehmen</a></li>
<li><a href="../de498132/index.html">PostgreSQL-Rezepte: Auto-Failover und Auto-Rejoin im Docker-Schwarm</a></li>
<li><a href="../de498134/index.html">Wie kann man Code mit Symfony 5-Bundles wiederverwenden? Teil 1. Mindestbündel</a></li>
<li><a href="../de498136/index.html">Gespräch mit Polina Gurtova über die Zukunft und Gegenwart von Frontend. Die Organisatoren von DUMP 2020 stellen einige wichtige Fragen.</a></li>
<li><a href="../de498138/index.html">Leben nach dem Grundstudium: Wie ich mich entschieden habe, was ich als nächstes tun soll, wenn es bereits Hochschulbildung und Arbeit gibt</a></li>
<li><a href="../de498140/index.html">Replizieren Sie dies. Webinare Apache Ignite und GridGain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>