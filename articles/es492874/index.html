<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèΩ ‚è∞ üë®üèæ‚Äçüç≥ Optimizaci√≥n de renderizado para dispositivos m√≥viles üíë üö¶ üì¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Hola queridos lectores, amantes y profesionales de la programaci√≥n gr√°fica! Le presentamos una serie de art√≠culos dedicados a la optimizaci√≥n del ren...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimizaci√≥n de renderizado para dispositivos m√≥viles</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/playrix/blog/492874/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Hola queridos lectores, amantes y profesionales de la programaci√≥n gr√°fica! Le presentamos una serie de art√≠culos dedicados a la optimizaci√≥n del renderizado para dispositivos m√≥viles: tel√©fonos y tabletas basados ‚Äã‚Äãen iOS y Android. El ciclo constar√° de tres partes. En la primera parte, examinaremos las caracter√≠sticas de la popular </font><font style="vertical-align: inherit;">arquitectura de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mosaico de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GPU </font><font style="vertical-align: inherit;">en dispositivos m√≥viles </font><font style="vertical-align: inherit;">. En el segundo, repasaremos las principales familias de GPU presentadas en dispositivos modernos y consideraremos sus fortalezas y debilidades. En la tercera parte, nos familiarizaremos con las caracter√≠sticas de la optimizaci√≥n del sombreador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, pasemos a la primera parte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El desarrollo de tarjetas de video en computadoras de escritorio y consolas se llev√≥ a cabo en ausencia de restricciones significativas en el consumo de energ√≠a. Con la llegada de las tarjetas de video para dispositivos m√≥viles, los ingenieros se enfrentaron a la tarea de garantizar un rendimiento aceptable con resoluciones de escritorio comparables, mientras que el consumo de energ√≠a de dichas tarjetas de video deber√≠a ser 2 √≥rdenes de magnitud menor.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/51e/4fa/969/51e4fa969a3e5ede3b31064499c33226.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n se encontr√≥ en una arquitectura especial llamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tile Based Rendering (TBR)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para un programador de gr√°ficos con experiencia en desarrollo de PC, cuando se familiariza con el desarrollo m√≥vil, todo parece familiar: se utiliza una API OpenGL ES similar, la misma estructura de la tuber√≠a de gr√°ficos. Sin embargo, la arquitectura de mosaico de las GPU m√≥viles es significativamente diferente de la utilizada en las consolas de PC / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo inmediato</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Conocer las fortalezas y debilidades de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TBR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lo ayudar√° a tomar las decisiones correctas y a obtener un excelente rendimiento con Mobile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n se muestra un diagrama simplificado de una tuber√≠a gr√°fica cl√°sica utilizada en PC y consolas durante la tercera d√©cada.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/67b/5e2/28167b5e2eaa4746ebd1ed45f8aa2dfb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la etapa de procesamiento de geometr√≠a, los atributos de v√©rtice se leen desde la memoria de video de la GPU. Despu√©s de varias transformaciones </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Vertex Shader), las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> primitivas listas para renderizar en el orden original (FIFO) se pasan al rasterizador, que divide las primitivas en p√≠xeles. Despu√©s de eso, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lleva a cabo la etapa de procesamiento de fragmentos de cada p√≠xel </font><b><font style="vertical-align: inherit;">(Fragment Shader)</font></b><font style="vertical-align: inherit;"> y los valores de color obtenidos se escriben en el b√∫fer de pantalla, que tambi√©n se encuentra en la memoria de video. Una caracter√≠stica de la arquitectura tradicional del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Modo inmediato"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es la grabaci√≥n del resultado del Fragment Shader en secciones arbitrarias del b√∫fer de pantalla al procesar una sola </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llamada de dibujo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por lo tanto, para cada llamada de sorteo, se puede requerir el acceso al b√∫fer de pantalla completo. Trabajar con una gran variedad de memoria requiere un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ancho de banda de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bus apropiado ( </font><b><font style="vertical-align: inherit;">ancho de banda</font></b><font style="vertical-align: inherit;"> ) y est√° asociado con un alto consumo de energ√≠a. Por lo tanto, las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√≥viles </font><font style="vertical-align: inherit;">comenzaron a adoptar un enfoque diferente. En la arquitectura de mosaico t√≠pica de las tarjetas de video m√≥viles, la representaci√≥n se realiza en un peque√±o trozo de memoria correspondiente a la parte de la pantalla: el mosaico. El tama√±o peque√±o del mosaico (por ejemplo, 16x16 p√≠xeles para tarjetas de video Mali, 32x32 para PowerVR) le permite colocarlo directamente en el chip de la tarjeta de video, lo que hace que la velocidad de acceso sea comparable a la velocidad de acceso a los registros centrales del sombreador, es decir. muy rapido.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/7bf/c65/86d7bfc65e53739ab9be0d5ea1242c0e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, dado que las primitivas pueden caer en secciones arbitrarias del b√∫fer de pantalla, y el mosaico cubre solo una peque√±a parte, se requiri√≥ un paso adicional en la tuber√≠a de gr√°ficos. </font><font style="vertical-align: inherit;">El siguiente es un diagrama simplificado de c√≥mo funciona la tuber√≠a con la arquitectura de mosaico.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/531/ea5/00c/531ea500c507eb47558676582e20c94c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de procesar los v√©rtices y construir las primitivas, estas √∫ltimas, en lugar de enviarse a la tuber√≠a de fragmentos, caen en el llamado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aqu√≠ las primitivas se distribuyen por mosaicos, en los p√≠xeles de los cuales caen. </font><font style="vertical-align: inherit;">Despu√©s de dicha distribuci√≥n, que, por regla general, cubre todas las llamadas de extracci√≥n dirigidas a un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objeto Frame Buffer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tambi√©n conocido como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render Target</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), los mosaicos se representan secuencialmente. </font><font style="vertical-align: inherit;">Para cada mosaico, se realiza la siguiente secuencia de acciones:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga de contenido antiguo de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desde la memoria del sistema ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render de primitivas que caen en este azulejo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga de nuevo contenido de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la memoria del sistema ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ea/20b/74b/9ea20b74b9fb716af30d5e0fa4ee1b34.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cabe se√±alar que la </font><font style="vertical-align: inherit;">operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se puede considerar como una superposici√≥n adicional de la "textura de pantalla completa" sin compresi√≥n. </font><font style="vertical-align: inherit;">Si es posible, evite esta operaci√≥n, es decir </font><font style="vertical-align: inherit;">No permita que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cambie de </font><font style="vertical-align: inherit;">un lado a otro. </font><font style="vertical-align: inherit;">Si </font><font style="vertical-align: inherit;">se borra todo su contenido </font><font style="vertical-align: inherit;">antes de renderizar en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">no se realiza la operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sin embargo, para enviar la se√±al correcta al conductor, los par√°metros de dicha limpieza deben cumplir ciertos criterios:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debe estar deshabilitado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rect de tijera</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se debe permitir la grabaci√≥n en todos los canales de color y alfa.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar la </font><font style="vertical-align: inherit;">operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el b√∫fer de profundidad y la plantilla, tambi√©n deben limpiarse antes del inicio del renderizado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n es posible evitar la operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el b√∫fer de profundidad / plantilla. </font><font style="vertical-align: inherit;">Despu√©s de todo, el contenido de estos b√∫feres no se muestra de ninguna manera en la pantalla. </font><font style="vertical-align: inherit;">Antes de la operaci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glSwapBuffers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">puede llamar a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glDiscardFramebufferEXT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glInvalidateFramebuffer</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glDiscardFramebufferEXT (GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay escenarios de representaci√≥n en los que </font><font style="vertical-align: inherit;">no se requiere </font><font style="vertical-align: inherit;">la colocaci√≥n de buffers de profundidad / stencil, as√≠ como </font><font style="vertical-align: inherit;">buffers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la memoria del sistema. Por ejemplo, si el renderizado en el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con el b√∫fer de profundidad es continuo, y la informaci√≥n de profundidad del fotograma anterior no se utiliza, entonces el b√∫fer de profundidad no necesita cargarse en la memoria de mosaico antes del inicio del renderizado, o descargarse despu√©s de completar el renderizado. Por lo tanto, la memoria del sistema no se puede asignar bajo el b√∫fer de profundidad. Las API gr√°ficas modernas como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vulkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metal le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permiten establecer expl√≠citamente el modo de memoria para sus contrapartes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  &nbsp;( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTLStorageModeMemoryless</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metal, VK_IMAGE_USAGE_TRANSIENT_ATTACHMENT_BIT +</font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VK_MEMORY_PROPERTY_LAZILY_ALLOCATED_BIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vulkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De particular inter√©s es la implementaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en arquitecturas de mosaico. El b√∫fer de alta resoluci√≥n para el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no deja la memoria de mosaico al dividir el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en m√°s mosaicos. Por ejemplo, para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA 2x2, los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mosaicos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16x16</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se resolver√°n como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8x8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durante la </font><font style="vertical-align: inherit;">operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir En total, ser√° necesario procesar 4 veces m√°s fichas. Pero </font><font style="vertical-align: inherit;">no se requiere </font><font style="vertical-align: inherit;">memoria adicional para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y debido a la representaci√≥n en la memoria r√°pida de mosaico no habr√° restricciones significativas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ancho de banda.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sin embargo uso</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en arquitectura de mosaico aumenta la carga en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiler, lo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que puede afectar negativamente el rendimiento de renderizado de escenas con mucha geometr√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumiendo lo anterior, presentamos el esquema deseado de trabajar con FBO en la arquitectura de mosaico:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 1.   ,    auxFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
glColorMask(GL_TRUE, GL_TRUE, GL_TRUE, GL_TRUE);<font></font>
glDepthMask(GL_TRUE);<font></font>
<span class="hljs-comment">// glClear,     </span><font></font>
glClear(GL_COLOR_BUFFER_BIT |&nbsp;GL_DEPTH_BUFFER_BIT |&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
renderAuxFBO();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
<font></font>
<span class="hljs-comment">//   /      </span>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
<span class="hljs-comment">// 2.   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
<font></font>
glClear(...);<font></font>
<span class="hljs-comment">//   mainFBO    auxFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cambia a renderizado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auxFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en medio de la formaci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mainFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puede obtener </font><font style="vertical-align: inherit;">operaciones </font><font style="vertical-align: inherit;">innecesarias de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga y almacenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que puede aumentar significativamente el tiempo de formaci√≥n de cuadros. </font><font style="vertical-align: inherit;">En nuestra pr√°ctica, encontramos una desaceleraci√≥n en el renderizado incluso en el caso de configuraciones de FBO inactivas, es decir, </font><font style="vertical-align: inherit;">sin el render real en ellos. </font><font style="vertical-align: inherit;">Debido a la arquitectura del motor, nuestro antiguo circuito se ve√≠a as√≠:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   </span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
<span class="hljs-comment">//  auxFBO</span><font></font>
renderAuxFBO();<font></font>
<font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   mainFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de la falta de llamadas gl despu√©s de la primera instalaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mainFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en algunos dispositivos obtuvimos </font><font style="vertical-align: inherit;">operaciones </font><font style="vertical-align: inherit;">adicionales de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga y almacenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y un peor rendimiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mejorar nuestra comprensi√≥n de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobrecarga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por el uso de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intermedios </font><font style="vertical-align: inherit;">, medimos la p√©rdida de tiempo para cambiar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pantalla completa </font><font style="vertical-align: inherit;">mediante una prueba sint√©tica. La tabla muestra el tiempo dedicado a la </font><font style="vertical-align: inherit;">operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al cambiar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> varias veces </font><font style="vertical-align: inherit;">en un cuadro (se proporciona el tiempo de una de esas operaciones). </font><font style="vertical-align: inherit;">Operaci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausente debido a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glClear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es decir </font><font style="vertical-align: inherit;">Se midi√≥ un escenario m√°s favorable. </font><font style="vertical-align: inherit;">El permiso utilizado en el dispositivo contribuy√≥. </font><font style="vertical-align: inherit;">Podr√≠a corresponder m√°s o menos a la potencia de la GPU instalada. </font><font style="vertical-align: inherit;">Por lo tanto, estas cifras solo dan una idea general de cu√°n costoso es el cambio de objetivos en tarjetas de video m√≥viles de varias generaciones.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milisegundos</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milisegundos</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 320</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 512</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,74</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR G6200</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3,3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 615</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.7</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-400</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 530</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.4 0.4</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t720</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-g51</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,32</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR SXG 544</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t830</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,15</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con base en los datos obtenidos, podemos recomendar que no se usen m√°s de uno o dos interruptores FBO por cuadro, al menos para tarjetas de video m√°s antiguas. Si el juego tiene un c√≥digo separado para dispositivos Low-End, es aconsejable no usar el cambio FBO all√≠. Sin embargo, en el Low-End, el problema de reducir la resoluci√≥n a menudo se vuelve relevante. En Android, puede reducir la resoluci√≥n de representaci√≥n sin recurrir al uso de un FBO intermedio llamando a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SurfaceHolder.setFixedSize ():</font></font></b><br>
<br>
<pre><code class="java hljs">surfaceView.getHolder().setFixedSize(...)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este m√©todo no funcionar√° si el juego se procesa a trav√©s de la </font><font style="vertical-align: inherit;">aplicaci√≥n </font><font style="vertical-align: inherit;">principal de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (un esquema t√≠pico para trabajar con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Si usa la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">superficie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> se puede establecer una resoluci√≥n m√°s baja llamando a la funci√≥n nativa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ANativeWindow_setBuffersGeometry.</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_com_organization_app_AppNativeActivity_setBufferGeometry</span><span class="hljs-params">(JNIEnv *env, jobject thiz, jobject surface, jint width, jint height)</span>
</span>{<font></font>
ANativeWindow* window = ANativeWindow_fromSurface(env, surface);&nbsp;<font></font>
ANativeWindow_setBuffersGeometry(window, width, height, AHARDWAREBUFFER_FORMAT_R8G8B8X8_UNORM);&nbsp;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Java:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBufferGeometry</span><span class="hljs-params">(Surface surface, <span class="hljs-keyword">int</span> width , <span class="hljs-keyword">int</span> height )</span></span>;&nbsp;<font></font>
...<font></font>
<span class="hljs-comment">//   SurfaceHolder.Callback</span>
<span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">surfaceChanged</span><span class="hljs-params">(SurfaceHolder holder, <span class="hljs-keyword">int</span> format, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height)</span>
</span>{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setBufferGeometry(holder.getSurface(), <span class="hljs-number">768</span>, <span class="hljs-number">1366</span>); <span class="hljs-comment">/* ... */</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, mencionamos el conveniente comando ADB para controlar los b√∫feres de superficie seleccionados en Android:</font></font><br>
<br>
<pre><code class="plaintext hljs">adb shell dumpsys surfaceflinger
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede obtener una conclusi√≥n similar que le permite estimar el consumo de memoria para los b√∫feres de superficie:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/2fe/ea6/5242feea615abe186c6c3538c9d60565.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La captura de pantalla muestra el sistema resaltando 3 buffers para el triple buffering del </font><font style="vertical-align: inherit;">juego </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLSurfaceView</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (resaltado en amarillo), as√≠ como 2 buffers para la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">superficie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><font style="vertical-align: inherit;">(resaltado en rojo). </font><font style="vertical-align: inherit;">En el caso de renderizar a trav√©s de la Surface principal, que es el esquema predeterminado cuando se usa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se puede evitar la asignaci√≥n de buffers adicionales.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo por ahora. </font><font style="vertical-align: inherit;">En los siguientes art√≠culos, clasificaremos las GPU m√≥viles y analizaremos los m√©todos para optimizar los sombreadores para ellas.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492862/index.html">15 mejores consejos de ajuste de rendimiento de Oracle APEX para desarrolladores</a></li>
<li><a href="../es492864/index.html">¬øPuedo hackear un barco?</a></li>
<li><a href="../es492866/index.html">El libro "Aprendizaje autom√°tico sin palabras"</a></li>
<li><a href="../es492868/index.html">Optimizaci√≥n de cadenas en ClickHouse. Informe Yandex</a></li>
<li><a href="../es492872/index.html">C√≥mo organizar el acceso remoto y no sufrir hackers</a></li>
<li><a href="../es492878/index.html">Zapatillas geek: buscando resultados positivos en cierres temporales de oficinas</a></li>
<li><a href="../es492880/index.html">¬øQu√© debemos construir una casa inteligente?</a></li>
<li><a href="../es492884/index.html">Recibir mensajes de transmisiones de youtube + autorizaci√≥n de google en PHP</a></li>
<li><a href="../es492886/index.html">Receta de probadores de reclutamiento masivo</a></li>
<li><a href="../es492888/index.html">Por qu√© no deber√≠as usar WireGuard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>