<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜 💪🏾 🔴 Unison：在两个服务器上设置并自动执行目录的双向同步 📶 🤛🏼 ☁️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="格蒂图片/ iStockphoto的将
 
 与Linux系列板载操作系统的两台服务器同步目录的问题是可以解决的，如果你使用专门的工具更容易。让我们看看如何用 Unison做到这一点。
 
 也许您有几台服务器，并且面临着同步这些服务器上某些目录的任务。例如，您需要在每台服务器上同步/ data目录...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unison：在两个服务器上设置并自动执行目录的双向同步</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/501426/"><img src="https://habrastorage.org/webt/px/ch/pt/pxchptdqlhxiictuiik4ldo02ka.jpeg"><br>
<sup><font color="9999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">格蒂图片/ iStockphoto的将</font></font></font></sup><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
与Linux系列板载操作系统的两台服务器同步目录的问题是可以解决的，如果你使用专门的工具更容易。让我们看看如何用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unison</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">做到这一点</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也许您有几台服务器，并且面临着同步这些服务器上某些目录的任务。例如，您需要</font><font style="vertical-align: inherit;">在每台服务器上</font><font style="vertical-align: inherit;">同步</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font><font style="vertical-align: inherit;">，以便某些应用程序可以访问相关信息。或者，也许您只是需要以同步方式定期将数据从一台服务器备份到另一台服务器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unison与</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rsync</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同步实用程序类似</font><font style="vertical-align: inherit;">，但是与它不同，它支持双向同步。也就是说，它允许您同步文件的两个副本，并根据所做的更改更新每个副本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在服务器上使用Unison时，理想的是安装诸如openssh-server和ssh之类的软件包，因为出于安全原因，最好使用SSH协议来完成同步。</font><font style="vertical-align: inherit;">但是，如果您对网络的安全性有信心（例如，服务器可以在不使用密码的情况下使用SSH身份验证），则不必费心。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Unison还需要什么</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将以两个Ubuntu服务器为例（均为18.04）展示整个过程。</font><font style="vertical-align: inherit;">您可以将Unison与其他发行版一起安装和使用，但是您将需要更改安装命令，否则可以从标准存储库安装Unison（当然，您的用户必须具有sudo权限）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将使用以下服务器：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器1-192.168.1.6</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器2-192.168.1.19</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何安装Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先要注意的是安装Unison。</font><font style="vertical-align: inherit;">这应该在两个服务器上都完成。</font><font style="vertical-align: inherit;">转到两个服务器并输入命令：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install unison unison-all -y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
等待Unison安装完成并继续。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何生成和复制SSH密钥</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们仅为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成SSH密钥</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">为此，请使用以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">ssh-keygen -t rsa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当要求您输入密码时，只需按ENTER键。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生成密钥后，</font><font style="vertical-align: inherit;">使用以下命令</font><font style="vertical-align: inherit;">将其复制到</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">ssh-copy-id 192.168.1.19</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
复制密钥后，您可以直接进行业务。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何使用Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了测试目的，我们为每个服务器创建一个测试目录。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，在两台服务器上，必须更改创建目录的所有者的名称，否则Unison将无法在其中写入任何内容。</font><font style="vertical-align: inherit;">作为所有者，指定将运行Unison命令的用户：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">做同样的事情</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将一些测试文件放在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1中</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">touch /data1/{test1,test2,test3}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将目录与以下命令同步（通过在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上运行它</font><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="bash hljs">unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于您是第一次尝试同步这些根目录，因此您会收到一条警告，提示同步可能会花费一些时间（但是在我们的情况下，这不会发生，因为我们仅向目录中添加了三个最小容量的测试文件）。</font><font style="vertical-align: inherit;">如果将其作为生产的备份，那么第一次启动确实会花费一些时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所以下次再喝茶。</font><font style="vertical-align: inherit;">同时，按Enter键开始该过程。</font><font style="vertical-align: inherit;">完成此操作后，将要求您确认每个文件的同步。</font><font style="vertical-align: inherit;">完成后，输入“ y”继续。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我们仅同步三个测试文件，因此这将很快发生，并使您返回到bash shell。</font><font style="vertical-align: inherit;">要确保文件已同步，请转到</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并输入命令：</font></font><br>
<br>
<pre><code class="bash hljs">ls /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，系统将报告</font><font style="vertical-align: inherit;">我们的test1，test2和test3文件</font><font style="vertical-align: inherit;">位于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录中</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/xv/bi/puxvbivby-poqpuch07emsz7kui.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功：Unison同步了这两个目录。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何在无需用户交互的情况下启动Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我认为您不想每次启动Unison时都不断确认每个目录文件的同步。</font><font style="vertical-align: inherit;">当您同步带有大量文件的目录时，这尤其令人讨厌。</font><font style="vertical-align: inherit;">因此，需要自动化。</font><font style="vertical-align: inherit;">转到</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并输入命令：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/.unison/default.prf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
打开配置文件进行编辑时，请在其中添加两行：</font></font><br>
<br>
<pre><code class="bash hljs">auto=<span class="hljs-literal">true</span>
batch=<span class="hljs-literal">true</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后保存并关闭文件。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，Unison不会再麻烦您了。</font><font style="vertical-align: inherit;">但这还不是全部。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何为Cron Scheduler创建任务</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我认为您几乎不需要手动启动同步，因为您可能在某个地方犯了错误，或者例如没有考虑服务器上目录结构的更改。</font><font style="vertical-align: inherit;">要配置自动化，您需要为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建一个cron作业</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们创建一个脚本来开始同步：</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下应添加到此文件： </font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#!/bin/bash/</span>
unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，您需要授予脚本执行权：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod ugo+x /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用以下命令为Cron创建作业：</font></font><br>
<br>
<pre><code class="bash hljs">crontab -e</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在那之后键入：</font></font><br>
<br>
<pre><code class="bash hljs">*/5 * * * * /usr/<span class="hljs-built_in">local</span>/bin/unisonsync &amp;&gt; /dev/null</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，同步将每5分钟自动开始一次。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我已经展示了Unison可以轻松地在两个Linux服务器上同步目录。</font><font style="vertical-align: inherit;">您可以通过将文件添加到</font><font style="vertical-align: inherit;">两个服务器上</font><font style="vertical-align: inherit;">相应的测试目录</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自己验证</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">确保同步有效后，您可以在生产服务器上的战斗模式下使用它。</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为广告</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VDSina</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">始终乐于为任何任务提供可靠的服务器。</font><font style="vertical-align: inherit;">您可以选择大量用于自动安装的操作系统，可以从自己的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">映像</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装任何操作系统，也可以</font><font style="vertical-align: inherit;">在同一位置的服务器之间</font><font style="vertical-align: inherit;">使用高速</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本地网络</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501414/index.html">为Django项目配置Debian，Nginx和Gunicorn</a></li>
<li><a href="../zh-CN501416/index.html">关于WebRTC的一些知识：使用方法和实践案例</a></li>
<li><a href="../zh-CN501418/index.html">第四周马拉松：动力</a></li>
<li><a href="../zh-CN501420/index.html">在线Mitapas和YouTube节目：JUG Ru小组直播周</a></li>
<li><a href="../zh-CN501424/index.html">从Kubernetes的生活中看：我们如何将DBMS（不仅是从评论环境）删除为静态</a></li>
<li><a href="../zh-CN501430/index.html">网站内容设计和规划指南</a></li>
<li><a href="../zh-CN501432/index.html">JDBC的两种选择</a></li>
<li><a href="../zh-CN501434/index.html">安全周刊20：通过Thunderbolt入侵计算机</a></li>
<li><a href="../zh-CN501436/index.html">具有第二种错误可能性的图像上的数字识别算法</a></li>
<li><a href="../zh-CN501438/index.html">3D游戏渲染的工作原理：照明和阴影</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>