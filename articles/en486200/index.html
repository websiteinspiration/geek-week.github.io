<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ûó üò¢ ü§∂üèΩ Docker Tips: Clean Your Machine From Junk üë©‚Äçüé§ ‚ò¶Ô∏è üëàüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! I present to you the translation of the article "Docker Tips: Clean Up Your Local Machine" by Luc Juggery .
 

Today we‚Äôll talk about how...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Docker Tips: Clean Your Machine From Junk</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486200/"><img src="https://habrastorage.org/webt/yj/sm/cu/yjsmcuobxq-gpywchjtapz4n3cq.jpeg"><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font><font style="vertical-align: inherit;">I present to you the translation of the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Docker Tips: Clean Up Your Local Machine"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luc Juggery</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Today we‚Äôll talk about how Docker uses the disk space of the host machine, as well as how to free this space from junk images of unused images and containers.</font></font></p><a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/e5/um/m0/e5umm0ysiuwfrkwqddjhxlfitis.png"><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total consumption</font></font></h3><br>
<p>Docker ‚Äì  ,       .            ,     ,        .     (  -     ) Docker            .</p><br>
<p>,        .    ,     ,   ,   .   ,   ,  .</p><br>
<p>      ,         Docker‚Äô,        :</p><br>
<pre><code class="plaintext hljs">$ docker system df</code></pre><br>
<img src="https://habrastorage.org/webt/e5/um/m0/e5umm0ysiuwfrkwqddjhxlfitis.png"><br>
<p>    Docker‚Äô   :</p><br>
<ul>
<li> (images) ‚Äì   ,           ;</li>
<li> (containers) ‚Äì    ,    (     -  );</li>
<li>  (local volumes) ‚Äì   ,   ;</li>
<li>  (build cache) ‚Äì  ,     (   BuildKit,    Docker  18.09).</li>
</ul><br>
<p> ,                    (. .: ,         ).</p><br>
<h3>  </h3><br>
<p>          /var/lib/docker     ,     :</p><br>
<ul>
<li> /var/lib/docker/containers/ID_ ‚Äì            JSON-.   ,   ,         ,     .</li>
<li> /var/lib/docker/overlay2 ‚Äì   -  (overlay2 ‚Äì      Linux).        ,         .</li>
</ul><br>
<p>   ,      Docker,          .         :</p><br>
<pre><code class="plaintext hljs">$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         0          0          0B         0B<font></font>
Containers     0          0          0B         0B<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<p> - , , NGINX:</p><br>
<pre><code class="plaintext hljs">$ docker container run --name www -d -p 8000:80 nginx:1.16</code></pre><br>
<p>   :</p><br>
<ul>
<li> (images)  126 ,    NGINX,     ;</li>
<li> (containers)   2 .</li>
</ul><br>
<pre><code class="plaintext hljs">$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         1          1          126M       0B (0%)<font></font>
Containers     1          1          2B         0B (0%)<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<p>  ,     ,     .   2    ,  ,   NGINX     - 100        test.img   .</p><br>
<pre><code class="plaintext hljs">$ docker exec -ti www \<font></font>
  dd if=/dev/zero of=test.img bs=1024 count=0 seek=$[1024*100]</code></pre><br>
<p>      .  ,   (containers)   100 .</p><br>
<pre><code class="plaintext hljs">$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         1          1          126M       0B (0%)<font></font>
Containers     1          1          104.9MB    0B (0%)<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<p>,      ,      test.img.   :</p><br>
<pre><code class="plaintext hljs">$ find /var/lib/docker -type f -name test.img<font></font>
/var/lib/docker/overlay2/83f177...630078/merged/test.img<font></font>
/var/lib/docker/overlay2/83f177...630078/diff/test.img</code></pre><br>
<p>     ,   test.img     -,   overlay2.      ,    ,   ,  ,  :</p><br>
<pre><code class="plaintext hljs"># Stopping the www container<font></font>
$ docker stop www<font></font>
<font></font>
# Visualizing the impact on the disk usage<font></font>
$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         1          1          126M       0B (0%)<font></font>
Containers     1          0          104.9MB    104.9MB (100%)<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<p>    ?  ,          -.</p><br>
<p>                      - :</p><br>
<pre><code class="plaintext hljs">$ docker container prune<font></font>
WARNING! This will remove all stopped containers.<font></font>
Are you sure you want to continue? [y/N] y<font></font>
Deleted Containers:<font></font>
5e7f8e5097ace9ef5518ebf0c6fc2062ff024efb495f11ccc89df21ec9b4dcc2<font></font>
<font></font>
Total reclaimed space: 104.9MB</code></pre><br>
<p>,   104,9   .          ,           :</p><br>
<pre><code class="plaintext hljs">$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         1          0          126M       126M (100%)<font></font>
Containers     0          0          0B         0B<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<blockquote>:   ,       ,      .</blockquote><p> prune,    ,      .       ,    ,      :</p><br>
<pre><code class="plaintext hljs"># Historical command<font></font>
$ docker rm -f $(docker ps ‚Äìaq)<font></font>
<font></font>
# More recent command<font></font>
$ docker container rm -f $(docker container ls -aq)</code></pre><br>
<blockquote>  :       --rm,         ,   .</blockquote><br>
<h3>  </h3><br>
<p>           :  Ubuntu  600 ,   Microsoft .Net ‚Äì  .                 ,       .  ‚Äì   ‚Äì    ,          ,      .</p><br>
<p>   ,      :</p><br>
<ul>
<li>intermediate ,        ‚Äì     ,         ¬´¬ª ;</li>
<li>dangling  ‚Äì   intermediate ,          ‚Äì    .</li>
<li>           dangling :</li>
</ul><br>
<pre><code class="plaintext hljs">$ docker image ls -f dangling=true<font></font>
REPOSITORY  TAG      IMAGE ID         CREATED             SIZE<font></font>
none      none   21e658fe5351     12 minutes ago      71.3MB</code></pre><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">$ docker image rm $(docker image ls -f dangling=true -q)</code></pre><br>
<p>     prune:</p><br>
<pre><code class="plaintext hljs">$ docker image prune<font></font>
WARNING! This will remove all dangling images.<font></font>
Are you sure you want to continue? [y/N] y<font></font>
Deleted Images:<font></font>
deleted: sha256:143407a3cb7efa6e95761b8cd6cea25e3f41455be6d5e7cda<font></font>
deleted: sha256:738010bda9dd34896bac9bbc77b2d60addd7738ad1a95e5cc<font></font>
deleted: sha256:fa4f0194a1eb829523ecf3bad04b4a7bdce089c8361e2c347<font></font>
deleted: sha256:c5041938bcb46f78bf2f2a7f0a0df0eea74c4555097cc9197<font></font>
deleted: sha256:5945bb6e12888cf320828e0fd00728947104da82e3eb4452f<font></font>
<font></font>
Total reclaimed space: 12.9kB</code></pre><br>
<p>        (   dangling)  ,    :</p><br>
<pre><code class="plaintext hljs">$ docker image rm $(docker image ls -q)</code></pre><br>
<h3>  </h3><br>
<p> (volumes)         . ,       - ,    - .     .</p><br>
<p>   MongoDB,         ,        (      bck.json):</p><br>
<pre><code class="plaintext hljs"># Running a mongo container<font></font>
$ docker run --name db -v $PWD:/tmp -p 27017:27017 -d mongo:4.0<font></font>
<font></font>
# Importing an existing backup (from a huge bck.json file)<font></font>
$ docker exec -ti db mongoimport \<font></font>
  --db 'test' \<font></font>
  --collection 'demo' \<font></font>
  --file /tmp/bck.json \<font></font>
  --jsonArray</code></pre><br>
<p>        /var/lib/docker/volumes.      - ?    Dockerfile  MongoDB  /data/db (  MongoDB     )    (volume).</p><br>
<img src="https://habrastorage.org/webt/st/dy/t2/stdyt2fkphns_svsfoekjglamzc.png"><br>
<blockquote>  :  ,       ,   (volumes)     .</blockquote><p>    MongoDB   (    ) ,    .          ,        :</p><br>
<pre><code class="plaintext hljs">$ docker volume rm $(docker volume ls -q)</code></pre><br>
<p>         prune:</p><br>
<pre><code class="plaintext hljs">$ docker volume prune<font></font>
WARNING! This will remove all local volumes not used by at least one container.<font></font>
Are you sure you want to continue? [y/N] y<font></font>
Deleted Volumes:<font></font>
d50b6402eb75d09ec17a5f57df4ed7b520c448429f70725fc5707334e5ded4d5<font></font>
8f7a16e1cf117cdfddb6a38d1f4f02b18d21a485b49037e2670753fa34d115fc<font></font>
599c3dd48d529b2e105eec38537cd16dac1ae6f899a123e2a62ffac6168b2f5f<font></font>
...<font></font>
732e610e435c24f6acae827cd340a60ce4132387cfc512452994bc0728dd66df<font></font>
9a3f39cc8bd0f9ce54dea3421193f752bda4b8846841b6d36f8ee24358a85bae<font></font>
045a9b534259ec6c0318cb162b7b4fca75b553d4e86fc93faafd0e7c77c79799<font></font>
c6283fe9f8d2ca105d30ecaad31868410e809aba0909b3e60d68a26e92a094da<font></font>
<font></font>
Total reclaimed space: 25.82GB<font></font>
luc@saturn:~$</code></pre><br>
<h3>     </h3><br>
<p> Docker 18.09         BuildKit.       ,      .          ,    ,       .</p><br>
<p>,        Node.Js:</p><br>
<ul>
<li> index.js   HTTP ,       : </li>
<li> package.json  ,     expressjs   HTTP : </li>
</ul><br>
<pre><code class="plaintext hljs">$ cat index.js<font></font>
var express = require('express');<font></font>
var util    = require('util');<font></font>
var app = express();<font></font>
app.get('/', function(req, res) {<font></font>
  res.setHeader('Content-Type', 'text/plain');<font></font>
  res.end(util.format("%s - %s", new Date(), 'Got Request'));<font></font>
});<font></font>
app.listen(process.env.PORT || 80);</code></pre><br>
<pre><code class="plaintext hljs">$ cat package.json<font></font>
    {<font></font>
      "name": "testnode",<font></font>
      "version": "0.0.1",<font></font>
      "main": "index.js",<font></font>
      "scripts": {<font></font>
        "start": "node index.js"<font></font>
      },<font></font>
      "dependencies": {<font></font>
        "express": "^4.14.0"<font></font>
      }<font></font>
    }</code></pre><br>
<p>Dockerfile     :</p><br>
<pre><code class="plaintext hljs">FROM node:13-alpine<font></font>
COPY package.json /app/package.json<font></font>
RUN cd /app &amp;&amp; npm install<font></font>
COPY . /app/<font></font>
WORKDIR /app<font></font>
EXPOSE 80<font></font>
CMD ["npm", "start"]</code></pre><br>
<p>    ,   BuildKit:</p><br>
<pre><code class="plaintext hljs">$ docker build -t app:1.0 .</code></pre><br>
<p>     ,  ,       (node:13-alpine)    (app:1.0):</p><br>
<pre><code class="plaintext hljs">TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         2          0          109.3MB    109.3MB (100%)<font></font>
Containers     0          0          0B         0B<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    0          0          0B         0B</code></pre><br>
<p>     ,    BuildKit.        DOCKER_BUILDKIT   1:</p><br>
<pre><code class="plaintext hljs">$ DOCKER_BUILDKIT=1 docker build -t app:2.0 .</code></pre><br>
<p>     ,  ,       (buid-cache):</p><br>
<pre><code class="plaintext hljs">$ docker system df<font></font>
TYPE           TOTAL      ACTIVE     SIZE       RECLAIMABLE<font></font>
Images         2          0          109.3MB    109.3MB (100%)<font></font>
Containers     0          0          0B         0B<font></font>
Local Volumes  0          0          0B         0B<font></font>
Build Cache    11         0          8.949kB    8.949kB</code></pre><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">$ docker builder prune<font></font>
WARNING! This will remove all dangling build cache.<font></font>
Are you sure you want to continue? [y/N] y<font></font>
Deleted build cache objects:<font></font>
rffq7b06h9t09xe584rn4f91e<font></font>
ztexgsz949ci8mx8p5tzgdzhe<font></font>
3z9jeoqbbmj3eftltawvkiayi<font></font>
<font></font>
Total reclaimed space: 8.949kB</code></pre><br>
<h3> !</h3><br>
<p>,     ,  ,   .      prune.         docker,    ,   :</p><br>
<pre><code class="plaintext hljs">$ docker system prune<font></font>
WARNING! This will remove:<font></font>
  - all stopped containers<font></font>
  - all networks not used by at least one container<font></font>
  - all dangling images<font></font>
  - all dangling build cache<font></font>
<font></font>
Are you sure you want to continue? [y/N]</code></pre><br>
<p>   -        Docker,         .</p></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486200/">https://habr.com/ru/post/en486200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486188/index.html">Introducing PostgreSQL wal-g backup system</a></li>
<li><a href="../en486190/index.html">Our experience in developing a CSI driver in Kubernetes for Yandex.Cloud</a></li>
<li><a href="../en486192/index.html">Cyber ‚Äã‚Äãfraudsters hack mobile operators to get to phone numbers of subscribers</a></li>
<li><a href="../en486194/index.html">About backups in Proxmox VE</a></li>
<li><a href="../en486198/index.html">Talking is hard. Essays on Communicating with Non-Programmers</a></li>
<li><a href="../en486202/index.html">Alpine collects Docker builds under Python 50 times slower, and images 2 times heavier</a></li>
<li><a href="../en486204/index.html">Profession: System Administrator</a></li>
<li><a href="../en486206/index.html">What types of fraud have I encountered in freelance and outsourcing</a></li>
<li><a href="../en486210/index.html">2020: trends and forecasts</a></li>
<li><a href="../en486212/index.html">Delegation of the right to sign documents to a robot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>