<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💉 🧑🏼‍🤝‍🧑🏻 ⚪️ Rund um data.table 🤾🏽 👂🏽 🔹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Hinweis ist für diejenigen interessant, die die Tabellendatenverarbeitungsbibliothek für R - data.table verwenden, und freut sich möglicherweis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rund um data.table</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493132/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dieser Hinweis ist für diejenigen interessant, die die Tabellendatenverarbeitungsbibliothek für R - data.table verwenden, und freut sich möglicherweise über die Flexibilität ihrer Anwendung anhand verschiedener Beispiele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inspiriert von einem guten Beispiel eines </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kollegen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und in der Hoffnung, dass Sie seinen Artikel bereits gelesen haben, schlage ich vor, tiefer in die Optimierung von Code und Leistung basierend auf </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data.table einzusteigen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung: Woher kommt data.table?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist am besten, die Bibliothek ein wenig von weitem kennenzulernen, nämlich von den Datenstrukturen, aus denen das Objekt data.table (im Folgenden DT) erhalten werden kann.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Array</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## arrays ---------</span><font></font>
<font></font>
arrmatr &lt;- array(<span class="hljs-number">1</span>:<span class="hljs-number">20</span>, c(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">typeof</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">array</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">matrix</span>(<span class="hljs-params">arrmatr</span>)

</span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine dieser Strukturen ist ein Array ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Base :: array</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Wie in anderen Sprachen sind Arrays hier mehrdimensional. Es ist jedoch interessant, dass beispielsweise ein zweidimensionales Array beginnt, Eigenschaften von der Matrixklasse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(? Base :: matrix</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">zu erben </font><font style="vertical-align: inherit;">, und ein eindimensionales Array, das ebenfalls wichtig ist, nicht vom Vektor ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Base :: vector</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">erbt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sollte klar sein, dass die Art der Daten , die </font><font style="vertical-align: inherit;">in einer Einrichtung enthalten ist, </font><font style="vertical-align: inherit;">sollte Funktion überprüft wird </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basis :: die Typeof</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die die interne Beschreibung des Typs liefert gemäß </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dem R - </font><font style="vertical-align: inherit;">Interna</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Common Language - </font><font style="vertical-align: inherit;">Protokoll mit dem ersten Sohn assoziiert </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer Befehl zum Bestimmen der Klasse eines Objekts ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base :: class</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, gibt bei Vektoren einen Vektortyp zurück (er unterscheidet sich vom internen Namen, ermöglicht Ihnen aber auch das Verständnis des Datentyps).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liste</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus einem zweidimensionalen Array, einer Matrix, können Sie zur Liste ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Base :: list</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><b><font style="vertical-align: inherit;">wechseln</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## lists ------------------</span><font></font>
<font></font>
mylist &lt;- <span class="hljs-keyword">as</span>.list(arrmatr)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.vector(mylist)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(mylist)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall passieren mehrere Dinge gleichzeitig:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die zweite Dimension der Matrix kollabiert, dh wir erhalten sowohl eine Liste als auch einen Vektor. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Liste erbt somit von diesen Klassen. </font><font style="vertical-align: inherit;">Es ist zu beachten, dass ein einzelner (skalarer) Wert aus der Zelle des Matrixarrays dem Listenelement entspricht.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aufgrund der Tatsache, dass die Liste auch ein Vektor ist, können einige Funktionen für Vektoren darauf angewendet werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenrahmen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Über eine Liste, Matrix oder einen Vektor können Sie zum </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenrahmen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><b><font style="vertical-align: inherit;">? Base :: data.frame</font></b><font style="vertical-align: inherit;"> ) </font><b><font style="vertical-align: inherit;">wechseln</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## data.frames ------------</span><font></font>
<font></font>
df &lt;- <span class="hljs-keyword">as</span>.data.frame(arrmatr)<font></font>
df2 &lt;- <span class="hljs-keyword">as</span>.data.frame(mylist)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
df$V6 &lt;- df$V1 + df$V2<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was daran interessant ist: Der Datenrahmen erbt von der Liste! </font><font style="vertical-align: inherit;">Die Spalten des Datenrahmens sind Listenzellen. </font><font style="vertical-align: inherit;">Dies wird in Zukunft wichtig sein, wenn wir die Funktionen verwenden, die auf Listen angewendet werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datentabelle</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können erhalten DT ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Data.table :: data.table</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) von einem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenrahmen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Liste, Vektor oder eine </font><font style="vertical-align: inherit;">Matrix. </font><font style="vertical-align: inherit;">Zum Beispiel so (an Ort und Stelle).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## data.tables -----------------------</span><font></font>
library(data.table)<font></font>
<font></font>
data.table::setDT(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.frame(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.table(df)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist nützlich, dass DT wie der Datenrahmen die Eigenschaften der Liste erbt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DT und Speicher</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Gegensatz zu allen anderen Objekten in der R-Basis werden DTs als Referenz übergeben. </font><font style="vertical-align: inherit;">Wenn Sie eine Kopie in einen neuen Speicherbereich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erstellen möchten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , benötigen Sie die Funktion </font><b><font style="vertical-align: inherit;">data.table :: copy</font></b><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">oder Sie müssen eine Auswahl aus dem alten Objekt treffen.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs">df2 &lt;- df<font></font>
<font></font>
df[V1 == <span class="hljs-number">1</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
df2 &lt;- data.table::copy(df)<font></font>
<font></font>
df[V1 == <span class="hljs-number">2</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dieser Einführung geht ein Ende. </font><font style="vertical-align: inherit;">DT ist eine Fortsetzung der Entwicklung von Datenstrukturen in R, die hauptsächlich aufgrund der Erweiterung und Beschleunigung von Operationen an Objekten der Datenrahmenklasse erfolgt. </font><font style="vertical-align: inherit;">In diesem Fall bleibt die Vererbung von anderen Grundelementen erhalten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einige Beispiele für die Verwendung von data.table-Eigenschaften</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie eine Liste ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Iterieren über die Zeilen eines Datenrahmens oder DT ist keine gute Idee, da der Schleifencode in der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sprache </font><font style="vertical-align: inherit;">viel langsamer als </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist und es durchaus möglich ist, die Spalten in Spalten zu durchlaufen, die normalerweise viel kleiner sind. </font><font style="vertical-align: inherit;">Denken Sie beim Durchlaufen der Spalten daran, dass jede Spalte ein Listenelement ist, das normalerweise einen Vektor enthält. </font><font style="vertical-align: inherit;">Und Operationen an Vektoren sind in den Grundfunktionen der Sprache gut vektorisiert. </font><font style="vertical-align: inherit;">Sie können auch die für Operatoren und Vektoren spezifischen Auswahloperatoren verwenden: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">`[[`, `$`</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## operations on data.tables ------------</span><font></font>
<font></font>
<span class="hljs-comment">#using list properties</span><font></font>
<font></font>
df$<span class="hljs-string">'V1'</span>[<span class="hljs-number">1</span>]<font></font>
<font></font>
df[[<span class="hljs-string">'V1'</span>]]<font></font>
<font></font>
df[[<span class="hljs-number">1</span>]][<span class="hljs-number">1</span>]<font></font>
<font></font>
sapply(df, <span class="hljs-class"><span class="hljs-keyword">class</span>)

<span class="hljs-title">sapply</span>(<span class="hljs-params">df, function(<span class="hljs-params">x</span>) sum(<span class="hljs-params">is.na(<span class="hljs-params">x</span>)</span>)</span>)
</span></code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vektorisierung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie die Zeilen eines großen DT durchgehen müssen, ist das Schreiben einer Funktion mit Vektorisierung die beste Lösung. </font><font style="vertical-align: inherit;">Wenn es jedoch nicht funktioniert, sollte beachtet werden, dass der Zyklus </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">innerhalb des</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DT im </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> immer noch schneller </font><font style="vertical-align: inherit;">läuft, da er auf </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dem C ausgeführt wird</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir ein größeres Beispiel mit 100K-Zeilen. </font><font style="vertical-align: inherit;">Wir werden den ersten Buchstaben aus den Wörtern ziehen, die im Spaltenvektor </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">w enthalten sind</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktualisiert</font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs">library(magrittr)<font></font>
library(microbenchmark)<font></font>
<font></font>
<span class="hljs-comment">## Bigger example ----</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = sapply(seq_len(rown), function(x) paste(sample(letters, <span class="hljs-number">3</span>, replace = T), collapse = <span class="hljs-string">' '</span>))<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
<span class="hljs-comment"># vectorization</span><font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		, by = <span class="hljs-number">1</span>:nrow(dt)<font></font>
	   ]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># second</span><font></font>
<font></font>
first_l_f &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		do.call(rbind, .) %&gt;%<font></font>
		`[`(,<span class="hljs-number">1</span>)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># third</span><font></font>
<font></font>
first_l_f2 &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		unlist %&gt;%<font></font>
		matrix(nrow = <span class="hljs-number">3</span>) %&gt;%<font></font>
		`[`(<span class="hljs-number">1</span>,)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f2(w))<font></font>
		]<font></font>
})<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Lauf durchläuft die Zeilen:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einheit: Millisekunden </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [, `: =` (first_l, unlist (strsplit (w, split = "", fixed = T)) [1]), by = 1: nrow (dt)]} 439.6217 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 lq mean Median uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 451.9998 460.1593 456.2505 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">460.9147</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 621.4042 100</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der zweite Lauf, bei dem die Vektorisierung durchgeführt wird, indem die Liste in eine Matrix umgewandelt und Elemente auf einem Slice mit Index 1 aufgenommen werden </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(letzteres ist tatsächlich eine Vektorisierung)</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ich werde mich erholen: Vektorisierung auf der Ebene der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strsplit-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><font style="vertical-align: inherit;">, die einen Vektor als Eingabe verwenden kann. </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass das Umwandeln der Liste in eine Matrix viel schwieriger ist als die Vektorisierung selbst, in diesem Fall jedoch viel schneller als die nicht vektorisierte Version.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einheit: Millisekunden </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq mittlerer Median uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [, `: =` (first_l ,. (First_l_f (w)))]} 93.07916 112.1381 161.9267 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">149.6863</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 185.9893 442.5199 100</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die mittlere Beschleunigung beträgt das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dreifache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der dritte Lauf, bei dem das Schema der Transformation in eine Matrix geändert wird.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einheit: Millisekunden </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq mittlerer Median uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 {dt [, `: =` (first_l ,. (First_l_f2 (w)))]} 32.60481 34.13679 40.4544 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35.57115</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 42.11975 222.972 100</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die mittlere Beschleunigung beträgt das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13-fache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Man muss mit dieser Angelegenheit experimentieren, je mehr - desto besser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres Beispiel für die Vektorisierung, bei der es auch Text gibt, der jedoch den realen Bedingungen nahe kommt: unterschiedliche Länge von Wörtern, unterschiedliche Anzahl von Wörtern. </font><font style="vertical-align: inherit;">Es ist erforderlich, die ersten 3 Wörter zu erhalten. </font><font style="vertical-align: inherit;">So: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i_/sp/y_/i_spy_ok37lu1k5f6syb7db8kw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier funktioniert die vorherige Funktion nicht, da die Vektoren unterschiedlich lang sind und wir die Größe der Matrix festlegen. </font><font style="vertical-align: inherit;">Wiederholen Sie dies, indem Sie in das Internet eintauchen.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># fourth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
first_l_f3 &lt;- function(sd, n)<font></font>
{<font></font>
	l &lt;- strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T)<font></font>
	<font></font>
	maxl &lt;- max(lengths(l))<font></font>
	<font></font>
	sapply(l, <span class="hljs-string">"length&lt;-"</span>, maxl) %&gt;%<font></font>
		`[`(n,) %&gt;%<font></font>
		<span class="hljs-keyword">as</span>.character<font></font>
}<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
		]<font></font>
})<font></font>
<font></font>
dt[<font></font>
	, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
	]<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einheit: Millisekunden </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 expr min lq mittlerer Median</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{dt [, `: =` ((paste0 ("w_", 1: 3)), strsplit (w, split = "", fixed = T))} 851.7623 916.071 1054.5 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1035.199</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
 uq max neval </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1178.738 1356.816 100</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Skript lief mit einer Durchschnittsgeschwindigkeit von 1 Sekunde. </font><font style="vertical-align: inherit;">Nicht schlecht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein anderer, wirtschaftlicherer Weg gefunden</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kablag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">::</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># fifth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
microbenchmark({<font></font>
	<font></font>
	w_split &lt;- dt[<font></font>
		, data.table::tstrsplit(w, split = <span class="hljs-string">' '</span>, fixed = T, keep = <span class="hljs-number">1L</span>:<span class="hljs-number">3L</span>)<font></font>
		]<font></font>
	<font></font>
	dt[<font></font>
		, `:=` (<font></font>
			w_1 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">1</span>]])<font></font>
			, w_2 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">2</span>]])<font></font>
			, w_3 = <span class="hljs-keyword">as</span>.character(w_split[[<span class="hljs-number">3</span>]])<font></font>
		)<font></font>
		]<font></font>
<font></font>
})<font></font>
</code></pre><br>
</div></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Median 186, 5 mal billiger ...</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbunden durch eine Kette ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können mit DT-Objekten mithilfe der Verkettung arbeiten. </font><font style="vertical-align: inherit;">Es sieht so aus, als würde man die Klammer-Syntax rechts einfügen, tatsächlich Zucker.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># chaining</span><font></font>
<font></font>
res1 &lt;- dt[a == <span class="hljs-string">'a'</span>][sample(.N, <span class="hljs-number">100</span>)]<font></font>
<font></font>
res2 &lt;- dt[, .N, a][, N]<font></font>
<font></font>
res3 &lt;- dt[, coefficients(lm(e ~ d))[<span class="hljs-number">1</span>], a][, .(letter = a, coef = V1)]<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durch Rohre fließen ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die gleichen Vorgänge können über Rohrleitungen ausgeführt werden. Sie sehen ähnlich aus, sind jedoch funktional umfangreicher, da Sie alle Methoden verwenden können, nicht nur DT. </font><font style="vertical-align: inherit;">Wir leiten die logistischen Regressionskoeffizienten für unsere synthetischen Daten mit einer Reihe von Filtern für Dieselkraftstoff ab.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># piping</span><font></font>
<font></font>
samplpe_b &lt;- dt[a %<span class="hljs-keyword">in</span>% head(letters), sample(b, <span class="hljs-number">1</span>)]<font></font>
<font></font>
res4 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[a %<span class="hljs-keyword">in</span>% head(letters)] %&gt;%<font></font>
	.[, <font></font>
	  {<font></font>
	  	dt0 &lt;- .SD[<span class="hljs-number">1</span>:<span class="hljs-number">100</span>]<font></font>
	  	<font></font>
	  	quants &lt;- <font></font>
	  		dt0[, c] %&gt;%<font></font>
	  		quantile(seq(<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>), na.rm = T)<font></font>
	  	<font></font>
	  	.(q = quants)<font></font>
	  }<font></font>
	  , .(cond = b &gt; samplpe_b)<font></font>
	  ] %&gt;%<font></font>
	glm(<font></font>
		cond ~ q <span class="hljs-number">-1</span>
		, family = binomial(link = <span class="hljs-string">"logit"</span>)<font></font>
		, data = .<font></font>
	) %&gt;%<font></font>
	summary %&gt;%<font></font>
	.[[<span class="hljs-number">12</span>]]
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistik, maschinelles Lernen usw. in DT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können Lambda-Funktionen verwenden, aber manchmal ist es besser, sie separat zu erstellen, die gesamte Datenanalyse-Pipeline zu registrieren und sie dann im DT zu arbeiten. </font><font style="vertical-align: inherit;">Das Beispiel ist mit allen oben genannten Funktionen sowie einigen nützlichen Dingen aus dem DT-Arsenal angereichert (z. B. Zugriff auf die DT selbst innerhalb der DT durch Referenz, manchmal nicht nacheinander eingefügt, sondern zu sein).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># function</span><font></font>
<font></font>
rm(lm_preds)<font></font>
<font></font>
lm_preds &lt;- function(<font></font>
	sd, by, n<font></font>
)<font></font>
{<font></font>
	<font></font>
	<span class="hljs-keyword">if</span>(<font></font>
		n &lt; <span class="hljs-number">100</span> | <font></font>
		!by[[<span class="hljs-string">'a'</span>]] %<span class="hljs-keyword">in</span>% head(letters, <span class="hljs-number">4</span>)<font></font>
	   )<font></font>
	{<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = NA<font></font>
				, mean = NA<font></font>
				, high = NA<font></font>
				, coefs = NA<font></font>
			)<font></font>
		<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
		lmm &lt;- <font></font>
			lm(<font></font>
				d ~ c + b<font></font>
				, data = sd<font></font>
			)<font></font>
		<font></font>
		preds &lt;- <font></font>
			stats::predict.lm(<font></font>
				lmm<font></font>
				, sd<font></font>
				, interval = <span class="hljs-string">"prediction"</span><font></font>
				)<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = preds[, <span class="hljs-number">2</span>]<font></font>
				, mean = preds[, <span class="hljs-number">1</span>]<font></font>
				, high = preds[, <span class="hljs-number">3</span>]<font></font>
				, coefs = coefficients(lmm)<font></font>
			)<font></font>
	}<font></font>
<font></font>
	res<font></font>
	<font></font>
}<font></font>
<font></font>
res5 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[e &lt; <span class="hljs-number">0</span>] %&gt;%<font></font>
	.[.[, .I[b &gt; <span class="hljs-number">0</span>]]] %&gt;%<font></font>
	.[, `:=` (<font></font>
		low = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">1</span>]])<font></font>
		, mean = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">2</span>]])<font></font>
		, high = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">3</span>]])<font></font>
		, coef_c = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">1</span>])<font></font>
		, coef_b = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">2</span>])<font></font>
		, coef_int = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">3</span>])<font></font>
	)<font></font>
	, a<font></font>
	] %&gt;%<font></font>
	.[!<span class="hljs-keyword">is</span>.na(mean), -<span class="hljs-string">'e'</span>, <span class="hljs-keyword">with</span> = F]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># plot</span><font></font>
<font></font>
plo &lt;- <font></font>
	res5 %&gt;%<font></font>
	ggplot +<font></font>
	facet_wrap(~ a) +<font></font>
	geom_ribbon(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, ymin = low<font></font>
			, ymax = high<font></font>
			, fill = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">0.1</span>
		, alpha = <span class="hljs-number">0.1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = mean<font></font>
			, color = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = d<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span>
		, color = <span class="hljs-string">'black'</span><font></font>
	) +<font></font>
	theme_minimal()<font></font>
<font></font>
print(plo)<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dass ich in der Lage war, ein vollständiges, aber natürlich nicht vollständiges Bild eines Objekts wie data.table zu erstellen, beginnend mit seinen Eigenschaften in Bezug auf die Vererbung von R-Klassen und endend mit seinen eigenen Chips und seiner Umgebung aus aufgeräumten Elementen. </font><font style="vertical-align: inherit;">Ich hoffe, dies hilft Ihnen dabei, diese Bibliothek besser zu lernen und für Arbeit und </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spaß zu nutzen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fh/xl/km/fhxlkmndxsdm4gcfyiymozut1vg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danke!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Code</font></font></h3><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">## load libs ----------------</span><font></font>
<font></font>
library(data.table)<font></font>
library(ggplot2)<font></font>
library(magrittr)<font></font>
library(microbenchmark)<font></font>
<font></font>
<font></font>
<span class="hljs-comment">## arrays ---------</span><font></font>
<font></font>
arrmatr &lt;- array(<span class="hljs-number">1</span>:<span class="hljs-number">20</span>, c(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>))<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">typeof</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">array</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">matrix</span>(<span class="hljs-params">arrmatr</span>)


## <span class="hljs-title">lists</span> ------------------

<span class="hljs-title">mylist</span> &lt;- <span class="hljs-title">as</span>.<span class="hljs-title">list</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">vector</span>(<span class="hljs-params">mylist</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">list</span>(<span class="hljs-params">mylist</span>)


## <span class="hljs-title">data</span>.<span class="hljs-title">frames</span> ------------

<span class="hljs-title">df</span> &lt;- <span class="hljs-title">as</span>.<span class="hljs-title">data</span>.<span class="hljs-title">frame</span>(<span class="hljs-params">arrmatr</span>)

<span class="hljs-title">is</span>.<span class="hljs-title">list</span>(<span class="hljs-params">df</span>)

<span class="hljs-title">df</span>$<span class="hljs-title">V6</span> &lt;- <span class="hljs-title">df</span>$<span class="hljs-title">V1</span> + <span class="hljs-title">df</span>$<span class="hljs-title">V2</span>


## <span class="hljs-title">data</span>.<span class="hljs-title">tables</span> -----------------------

<span class="hljs-title">data</span>.<span class="hljs-title">table</span>:</span>:setDT(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.list(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.frame(df)<font></font>
<font></font>
<span class="hljs-keyword">is</span>.data.table(df)<font></font>
<font></font>
df2 &lt;- df<font></font>
<font></font>
df[V1 == <span class="hljs-number">1</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
df2 &lt;- data.table::copy(df)<font></font>
<font></font>
df[V1 == <span class="hljs-number">2</span>, V2 := <span class="hljs-number">999</span>]<font></font>
<font></font>
data.table::fsetdiff(df, df2)<font></font>
<font></font>
<font></font>
<span class="hljs-comment">## operations on data.tables ------------</span><font></font>
<font></font>
<span class="hljs-comment">#using list properties</span><font></font>
<font></font>
df$<span class="hljs-string">'V1'</span>[<span class="hljs-number">1</span>]<font></font>
<font></font>
df[[<span class="hljs-string">'V1'</span>]]<font></font>
<font></font>
df[[<span class="hljs-number">1</span>]][<span class="hljs-number">1</span>]<font></font>
<font></font>
sapply(df, <span class="hljs-class"><span class="hljs-keyword">class</span>)

<span class="hljs-title">sapply</span>(<span class="hljs-params">df, function(<span class="hljs-params">x</span>) sum(<span class="hljs-params">is.na(<span class="hljs-params">x</span>)</span>)</span>)


## <span class="hljs-title">Bigger</span> <span class="hljs-title">example</span> ----

<span class="hljs-title">rown</span> &lt;- 100000

<span class="hljs-title">dt</span> &lt;- 
	<span class="hljs-title">data</span>.<span class="hljs-title">table</span>(<span class="hljs-params">
		w = sapply(<span class="hljs-params">seq_len(<span class="hljs-params">rown</span>), function(<span class="hljs-params">x</span>) paste(<span class="hljs-params">sample(<span class="hljs-params">letters, <span class="hljs-number">3</span>, replace = T</span>), collapse = <span class="hljs-string">' '</span></span>)</span>)
		, a = sample(<span class="hljs-params">letters, rown, replace = T</span>)
		, b = runif(<span class="hljs-params">rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span></span>)
		, c = runif(<span class="hljs-params">rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span></span>)
		, e = rnorm(<span class="hljs-params">rown</span>)
	</span>) %&gt;%
	.[, <span class="hljs-title">d</span> :</span>= <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
<span class="hljs-comment"># vectorization</span><font></font>
<font></font>
<span class="hljs-comment"># zero - for loop</span><font></font>
<font></font>
microbenchmark({<font></font>
	<span class="hljs-keyword">for</span>(i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nrow(dt))<font></font>
		{<font></font>
		dt[<font></font>
			i<font></font>
			, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		]<font></font>
	}<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># first</span><font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := unlist(strsplit(w, split = <span class="hljs-string">' '</span>, fixed = T))[<span class="hljs-number">1</span>]<font></font>
		, by = <span class="hljs-number">1</span>:nrow(dt)<font></font>
	   ]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># second</span><font></font>
<font></font>
first_l_f &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		do.call(rbind, .) %&gt;%<font></font>
		`[`(,<span class="hljs-number">1</span>)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># third</span><font></font>
<font></font>
first_l_f2 &lt;- function(sd)<font></font>
{<font></font>
	strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T) %&gt;%<font></font>
		unlist %&gt;%<font></font>
		matrix(nrow = <span class="hljs-number">3</span>) %&gt;%<font></font>
		`[`(<span class="hljs-number">1</span>,)<font></font>
}<font></font>
<font></font>
dt[, first_l := NULL]<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, first_l := .(first_l_f2(w))<font></font>
		]<font></font>
})<font></font>
<font></font>
<span class="hljs-comment"># fourth</span><font></font>
<font></font>
rown &lt;- <span class="hljs-number">100000</span><font></font>
<font></font>
words &lt;-<font></font>
	sapply(<font></font>
		seq_len(rown)<font></font>
		, function(x){<font></font>
			nwords &lt;- rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>)<font></font>
			paste(<font></font>
				sapply(<font></font>
					seq_len(nwords)<font></font>
					, function(x){<font></font>
						paste(sample(letters, rbinom(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.5</span>), replace = T), collapse = <span class="hljs-string">''</span>)<font></font>
					}<font></font>
				)<font></font>
				, collapse = <span class="hljs-string">' '</span><font></font>
			)<font></font>
		}<font></font>
	)<font></font>
<font></font>
dt &lt;- <font></font>
	data.table(<font></font>
		w = words<font></font>
		, a = sample(letters, rown, replace = T)<font></font>
		, b = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, c = runif(rown, <span class="hljs-number">-3</span>, <span class="hljs-number">3</span>)<font></font>
		, e = rnorm(rown)<font></font>
	) %&gt;%<font></font>
	.[, d := <span class="hljs-number">1</span> + b + c + rnorm(nrow(.))]<font></font>
<font></font>
first_l_f3 &lt;- function(sd, n)<font></font>
{<font></font>
	l &lt;- strsplit(sd, split = <span class="hljs-string">' '</span>, fixed = T)<font></font>
	<font></font>
	maxl &lt;- max(lengths(l))<font></font>
	<font></font>
	sapply(l, <span class="hljs-string">"length&lt;-"</span>, maxl) %&gt;%<font></font>
		`[`(n,) %&gt;%<font></font>
		<span class="hljs-keyword">as</span>.character<font></font>
}<font></font>
<font></font>
microbenchmark({<font></font>
	dt[<font></font>
		, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
		]<font></font>
})<font></font>
<font></font>
dt[<font></font>
	, (paste0(<span class="hljs-string">'w_'</span>, <span class="hljs-number">1</span>:<span class="hljs-number">3</span>)) := lapply(<span class="hljs-number">1</span>:<span class="hljs-number">3</span>, function(x) first_l_f3(w, x))<font></font>
	]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># chaining</span><font></font>
<font></font>
res1 &lt;- dt[a == <span class="hljs-string">'a'</span>][sample(.N, <span class="hljs-number">100</span>)]<font></font>
<font></font>
res2 &lt;- dt[, .N, a][, N]<font></font>
<font></font>
res3 &lt;- dt[, coefficients(lm(e ~ d))[<span class="hljs-number">1</span>], a][, .(letter = a, coef = V1)]<font></font>
<font></font>
<span class="hljs-comment"># piping</span><font></font>
<font></font>
samplpe_b &lt;- dt[a %<span class="hljs-keyword">in</span>% head(letters), sample(b, <span class="hljs-number">1</span>)]<font></font>
<font></font>
res4 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[a %<span class="hljs-keyword">in</span>% head(letters)] %&gt;%<font></font>
	.[, <font></font>
	  {<font></font>
	  	dt0 &lt;- .SD[<span class="hljs-number">1</span>:<span class="hljs-number">100</span>]<font></font>
	  	<font></font>
	  	quants &lt;- <font></font>
	  		dt0[, c] %&gt;%<font></font>
	  		quantile(seq(<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>), na.rm = T)<font></font>
	  	<font></font>
	  	.(q = quants)<font></font>
	  }<font></font>
	  , .(cond = b &gt; samplpe_b)<font></font>
	  ] %&gt;%<font></font>
	glm(<font></font>
		cond ~ q <span class="hljs-number">-1</span>
		, family = binomial(link = <span class="hljs-string">"logit"</span>)<font></font>
		, data = .<font></font>
	) %&gt;%<font></font>
	summary %&gt;%<font></font>
	.[[<span class="hljs-number">12</span>]]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># function</span><font></font>
<font></font>
rm(lm_preds)<font></font>
<font></font>
lm_preds &lt;- function(<font></font>
	sd, by, n<font></font>
)<font></font>
{<font></font>
	<font></font>
	<span class="hljs-keyword">if</span>(<font></font>
		n &lt; <span class="hljs-number">100</span> | <font></font>
		!by[[<span class="hljs-string">'a'</span>]] %<span class="hljs-keyword">in</span>% head(letters, <span class="hljs-number">4</span>)<font></font>
	   )<font></font>
	{<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = NA<font></font>
				, mean = NA<font></font>
				, high = NA<font></font>
				, coefs = NA<font></font>
			)<font></font>
		<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
		lmm &lt;- <font></font>
			lm(<font></font>
				d ~ c + b<font></font>
				, data = sd<font></font>
			)<font></font>
		<font></font>
		preds &lt;- <font></font>
			stats::predict.lm(<font></font>
				lmm<font></font>
				, sd<font></font>
				, interval = <span class="hljs-string">"prediction"</span><font></font>
				)<font></font>
		<font></font>
		res &lt;-<font></font>
			list(<font></font>
				low = preds[, <span class="hljs-number">2</span>]<font></font>
				, mean = preds[, <span class="hljs-number">1</span>]<font></font>
				, high = preds[, <span class="hljs-number">3</span>]<font></font>
				, coefs = coefficients(lmm)<font></font>
			)<font></font>
	}<font></font>
<font></font>
	res<font></font>
	<font></font>
}<font></font>
<font></font>
res5 &lt;- <font></font>
	dt %&gt;%<font></font>
	.[e &lt; <span class="hljs-number">0</span>] %&gt;%<font></font>
	.[.[, .I[b &gt; <span class="hljs-number">0</span>]]] %&gt;%<font></font>
	.[, `:=` (<font></font>
		low = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">1</span>]])<font></font>
		, mean = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">2</span>]])<font></font>
		, high = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">3</span>]])<font></font>
		, coef_c = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">1</span>])<font></font>
		, coef_b = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">2</span>])<font></font>
		, coef_int = <span class="hljs-keyword">as</span>.numeric(lm_preds(.SD, .BY, .N)[[<span class="hljs-number">4</span>]][<span class="hljs-number">3</span>])<font></font>
	)<font></font>
	, a<font></font>
	] %&gt;%<font></font>
	.[!<span class="hljs-keyword">is</span>.na(mean), -<span class="hljs-string">'e'</span>, <span class="hljs-keyword">with</span> = F]<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># plot</span><font></font>
<font></font>
plo &lt;- <font></font>
	res5 %&gt;%<font></font>
	ggplot +<font></font>
	facet_wrap(~ a) +<font></font>
	geom_ribbon(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, ymin = low<font></font>
			, ymax = high<font></font>
			, fill = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">0.1</span>
		, alpha = <span class="hljs-number">0.1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = mean<font></font>
			, color = a<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span><font></font>
	) +<font></font>
	geom_point(<font></font>
		aes(<font></font>
			x = c * coef_c + b * coef_b + coef_int<font></font>
			, y = d<font></font>
		)<font></font>
		, size = <span class="hljs-number">1</span>
		, color = <span class="hljs-string">'black'</span><font></font>
	) +<font></font>
	theme_minimal()<font></font>
<font></font>
print(plo)<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493118/index.html">Übersicht über die Speicher-Tagging-Erweiterung (Armv8.5-A)</a></li>
<li><a href="../de493122/index.html">Büro der Banzai Games: Japan im Zentrum von Moskau</a></li>
<li><a href="../de493124/index.html">Bare-Metal-Provisioning zum Selbermachen oder automatische Servervorbereitung von Grund auf neu</a></li>
<li><a href="../de493126/index.html">Antimuster der ereignisorientierten Architektur</a></li>
<li><a href="../de493130/index.html">Warum Sie keine Angst vor Coronavirus haben sollten: Mythen und fast die Wahrheit über COVID-2019</a></li>
<li><a href="../de493136/index.html">FAST VP in Unity Storage: So funktioniert es</a></li>
<li><a href="../de493138/index.html">Sprechen Sie mit mir: Was Voice Bots heute können</a></li>
<li><a href="../de493140/index.html">Die Abenteuer von Cipollino: Quarantäne IT Quest von Flant</a></li>
<li><a href="../de493142/index.html">"Lass uns Kubernetes benutzen!" Sie haben jetzt 8 Probleme</a></li>
<li><a href="../de493146/index.html">Spannende Nebenprojekte, die Sie heute durchführen können</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>