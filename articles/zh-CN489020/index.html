<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐸 💧 🌮 一种恶意研究 🐨 📄 🤶🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我遇到了一个最近的恶意文档文件，该文件随网络钓鱼电子邮件一起发送。我认为这是练习逆向工程并在Habr上编写新东西的好理由。在猫之下-解析恶意宏删除程序和恶意dll的示例。
 
 巨集
 来自文件abb256d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>一种恶意研究</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我遇到了一个最近的恶意文档文件，该文件随网络钓鱼电子邮件一起发送。</font><font style="vertical-align: inherit;">我认为这是练习逆向工程并在Habr上编写新东西的好理由。</font><font style="vertical-align: inherit;">在猫之下-解析恶意宏删除程序和恶意dll的示例。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">巨集</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
来自文件</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb256d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sha256 </font><font style="vertical-align: inherit;">。在doc文件本身中，第一页上有一张图片，通知该文件受到保护，并说明了如何启用宏；文件中有两个带有数字的大表。数字以十进制形式编写，最长为十位数字，正负都有。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当受害者允许宏执行时（默认情况下是否启用了宏执行？），将触发一系列操作，最终执行</font><i><font style="vertical-align: inherit;">updatedb_network</font></i><font style="vertical-align: inherit;">函数</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它将当前目录更改为临时目录，并在其中创建文件“ icutils.dll”，在该文件中，它将行中第一张表中的数字记为带符号的32位整数。</font><font style="vertical-align: inherit;">结果是正确的dll。</font><font style="vertical-align: inherit;">从此dll导入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">克隆</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它以两个参数开头：</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">克隆</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">返回False，则icutils.dll文件将被第二个表中的数据覆盖，并使用相同的参数再次调用克隆。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
展望未来，我会说第一个dll是64位，并且不会在32位系统上运行。</font><font style="vertical-align: inherit;">因此，宏选择正确的二进制代码体系结构。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有趣的是，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">具有一段没有功能目的的代码：</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也许他在这里为那些快速浏览代码，看到SQL中的几行并且认为一切都还可以的人提供了有用的作品。</font><font style="vertical-align: inherit;">我不知道。</font><font style="vertical-align: inherit;">同样，大多数函数和变量具有随机或非真实名称（例如，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不与数据库或网络交互）。</font><font style="vertical-align: inherit;">尽管有例如</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">在icutil.dll中存储4个字节。</font><font style="vertical-align: inherit;">但是无论如何，</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数的存在应立即提醒</font><font style="vertical-align: inherit;">，恶意软件的作者不能随意重命名（尽管他们可以使用另一个自动启动的函数）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，宏功能或多或少很清楚，是时候卸载dll并继续进行分析了。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个dll（sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）64位。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进口功能列表所包含的功能</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（节目开始），</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（创建在一个线程</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一个</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过程），</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx来</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（在分配的存储器的块</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的另一</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过程），</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（写入的存储器</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的另一</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过程），这立即建议的代码注入到另一处理。现在，让我们看看她使用IDA Free和Ghidra到底做了什么。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主入口点仅返回1，不执行其他任何操作。第二个导出的函数是clone，它由宏调用并包含恶意代码。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用它的参数似乎没有任何影响。该应用程序解密两个数据块。具有以下内容（已解密）的第一个0x78数据块：</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个数据块的长度为0x1D4C，并包含可执行代码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，还将指向kernel32模块的指针，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（）函数</font><font style="vertical-align: inherit;">的结果以及</font><font style="vertical-align: inherit;">来自kernel32 </font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（）</font><font style="vertical-align: inherit;">函数的地址</font><font style="vertical-align: inherit;">写入0x90字节结构</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，创建进程（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）“ cmd.exe”。使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以在其中分配两个缓冲区：RW权限的长度为0x108，RWX权限的长度为0x1D4C。 RW缓冲区以0x90的长度复制上述数据块和上述结构。该结构还向解密的数据块写入一个指针（在子进程（cmd.exe）的地址空间中）。在RWX中，缓冲区被复制（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）用代码解密的数据块。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，在cmd.exe进程中，</font><font style="vertical-align: inherit;">在RWX缓冲区的开头创建带有入口点</font><font style="vertical-align: inherit;">的流（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），并将指向RW缓冲区的指针作为参数传递。</font><font style="vertical-align: inherit;">这样就完成了克隆功能，该操作在cmd.exe进程中继续。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有趣的是，克隆函数似乎就像一段无法实现的代码，它导入（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WorkPolyhistor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将代码注入到cmd.exe中</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它执行以下操作：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查找必要功能</font><font style="vertical-align: inherit;">的地址（其地址从父进程获取）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加载</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ole32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32库</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这些库中查找必要功能的地址。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有趣的是，对于代码中的大多数函数而言，没有函数名称，而仅代表CRC32（搜索已加载库中的所有函数名称，直到找到一个具有所需CRC32的函数为止）。</font><font style="vertical-align: inherit;">也许这是防止通过字符串实用工具获取导入函数列表的保护，尽管以加密形式存储的代码具有这种保护很奇怪，而dll本身只是简单地按名称导入函数。</font><font style="vertical-align: inherit;">总共检测到以下功能：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 负载库</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 全局分配</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateProcessW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 全球免费 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 写文件</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW（按名称查找）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 写文件</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 关闭手柄</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 读文件</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 获取文件大小</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwDelayExecution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ole32：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoInitialize（按名称查找）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance（按名称查找）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 兰德</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTempPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的进程</font><font style="vertical-align: inherit;">获取临时目录的路径，在其中创建文件格式为26342235.dat的文件，其中文件名是从父进程收到的TickCount的十进制记录，并在每次新尝试时进行迭代（即如果无法下载有效负载）第一次尝试，然后再次尝试，将创建一个文件名为26342236.dat的文件。</font><font style="vertical-align: inherit;">之后，将加载wininet库，并且有指向以下函数的指针：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle（crc32：0xe5191d24）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState（crc32：0xf2e5fc0c）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA（CRC32：0xda16a83d）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA（crc32：0x16505e0）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile（crc32：0x6cc098f5）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查是否存在网络-如果不存在，则应用程序调用不存在的地址并掉线（此类保护功能确定了使用与机器网络隔离的方式将peyload转换为该地址的情况，这是应用程序异常终止的唯一情况，其余部分-。进行了3次尝试，然后使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">终止cmd.exe </font><font style="vertical-align: inherit;">）。如果存在网络，则使用找到的功能，从从父进程传递的URL（https://pastebin.com/raw/Jyujxy7z）下载有效负载，并将其保存到扩展名为.dat的先前创建的文件中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，从.dat文件中读取有效负载，进行解码（base64），然后使用URL中的CRC32与XOR进行XOR解密，检查解密数据的前2个字节是否为'MZ'，如果是，则将结果保存到具有相同名称但扩展名的文件中。可执行程序</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python解密代码</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">启动保存的文件。</font><font style="vertical-align: inherit;">如果一切顺利，则使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">退出cmd.exe进程</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果出了点问题（缺少网络除外），则重新进行所有操作，最多尝试3次，dat和exe文件的名称每次都增加1。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二个dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个dll（sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）32位。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
其中，主要的恶意功能是在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能中实现的</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它还解密2个缓冲区。</font><font style="vertical-align: inherit;">第一个缓冲区的大小为0x78（120）字节，此类数据被解密并写入（以解密形式）：</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以看出，开头是与x64版本相同的URL。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大小为0x4678字节的第二个缓冲区分配有RWX权限。</font><font style="vertical-align: inherit;">将代码解密到其中，然后从缓冲区开始以0x4639的偏移量从中调用函数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我没有详细分析此代码。</font><font style="vertical-align: inherit;">他还可以在CRC32上找到功能，启动notepad.exe，在其中注入代码，然后从pastebin上的同一URL下载有效负载。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用pastebin的有效载荷</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用pastebin解密的有效负载是一个32位exe文件（sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）由于时间不足，我没有对其进行详细分解。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总的来说，该恶意软件给我留下了深刻的印象，其中包含很多错误（我在这里不故意称呼它们）。</font><font style="vertical-align: inherit;">好像他们在鞭打。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dll在内存功能中找到以后不再在任何地方使用的功能。</font><font style="vertical-align: inherit;">也许此代码就像宏一样，每次被防病毒软件检测后，都会被网络犯罪分子定期重写，其结果是这些伪像仍保留在代码中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有趣的是，在“拖放”到x64磁盘上的dll的“ dll”版本中，“危险的”导入函数的名称没有被屏蔽（您至少可以看到它们的字符串），并且在内存中解密且不适合磁盘的代码中，它们位于CRC32上。名称，而不仅仅是名称。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
几天后删除了pastebin有效负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV从这里拍摄</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN489008/index.html">使用Hobot框架在复杂的聊天机器人中进行路由</a></li>
<li><a href="../zh-CN489010/index.html">我们与语言学，个性化，peddesign，ML等项目共享俄罗斯最大的在线培训数据层</a></li>
<li><a href="../zh-CN489012/index.html">Google Cloud Spanner：好，坏，邪恶</a></li>
<li><a href="../zh-CN489014/index.html">《完美算法》一书。贪婪算法和动态规划»</a></li>
<li><a href="../zh-CN489016/index.html">德国格里夫·格里夫（German Gref）：“我们试图组织有关AGI的讨论，但没有一个自尊的科学家来参加”</a></li>
<li><a href="../zh-CN489022/index.html">将RabbitMQ与MonsterMQ结合使用第2部分</a></li>
<li><a href="../zh-CN489024/index.html">Webix JavaScript库通过初学者的眼光。第5部分。在用户端使用数据</a></li>
<li><a href="../zh-CN489026/index.html">更改Google AdSense算法可能会导致网站所有者和网站管理员</a></li>
<li><a href="../zh-CN489028/index.html">关于远程工作</a></li>
<li><a href="../zh-CN489034/index.html">新的UIS移动应用程序-为寻求公共采购的人们提供折磨还是救赎？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>