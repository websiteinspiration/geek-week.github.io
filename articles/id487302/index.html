<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ğŸ½ ğŸ•¤ ğŸ‡ğŸ» Memantau kesalahan dan kejadian di log PostgreSQL (grok_exporter) ğŸš´ğŸ¾ ğŸ‘©â€ğŸ”¬ ğŸ¤ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang, kolega dan habretchiki! Hari ini, saya ingin berbagi dengan Anda catatan kecil tentang bagaimana Anda dapat mengatur pemantauan operasi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Memantau kesalahan dan kejadian di log PostgreSQL (grok_exporter)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487302/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selamat siang, kolega dan habretchiki! </font><font style="vertical-align: inherit;">Hari ini, saya ingin berbagi dengan Anda catatan kecil tentang bagaimana Anda dapat mengatur pemantauan operasional kesalahan dan peristiwa yang muncul di log PostgreSQL menggunakan Prometheus dan pengekspor metrik grok_exporter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya harus segera mengatakan bahwa ini tentu saja kasus khusus menggunakan eksportir ini. </font><font style="vertical-align: inherit;">Jadi mengapa itu dibutuhkan dan siapa yang mungkin tertarik?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siapa yang butuh ini?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Prometheus sudah ada di infrastruktur Anda dan membuat infrastruktur terpisah untuk mengumpulkan dan menganalisis log, seperti ELK atau Greylog, mahal dan tidak praktis (jika tidak ada Prometheus, itu bukan masalah, mudah dan cepat untuk menginstal). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alat ini akan berguna tidak hanya untuk DBA, tetapi juga untuk administrator aplikasi, secara umum, untuk semua orang yang entah bagaimana bekerja dengan log aplikasi. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk dengan cepat mendapatkan informasi tentang perilaku freelance dan memiliki titik referensi tertentu untuk analisis situasi lebih lanjut.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk apa semua ini?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Log pemantauan akan memungkinkan Anda untuk memiliki gambar yang lebih lengkap dan merespons lebih cepat terhadap masalah yang muncul, baik itu: upaya otorisasi (termasuk yang tidak berhasil), berbagai kesalahan, atau peristiwa tertentu. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> daftar yang bagus di sini, dibentuk oleh kategori acara (Lihat bagian Kategori Acara Log), ini dapat digunakan untuk membuat aturan di Prometheus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengekspor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
metrik </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">grok_exporter</font></a><font style="vertical-align: inherit;"> memungkinkan </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Anda</font></a><font style="vertical-align: inherit;"> membaca data yang tidak terstruktur dari sumbernya, mengonversinya menjadi data terstruktur, sesuai aturan, dan memberikannya sebagai metrik dalam format yang dipahami Prometheus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eksportir dibuat dalam gambar plug-in di ELK </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filter-grok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang memungkinkan Anda untuk menggunakan satu set </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">templat plugins-filter-grok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebagaimana adanya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instalasi mudah dan sederhana. </font><font style="vertical-align: inherit;">Untuk melakukan ini, cukup ikuti </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tautan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan unduh versi yang Anda suka (dan ya mereka semua pra-rilis, dan versi terbaru masih dalam tahap kandidat pelepasan) dan unzip arsip yang dihasilkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya, kami mendapatkan perangkat berikut:</font></font><br>
<br>
<pre><code class="plaintext hljs">grok_exporter-1.0.0.RC3.linux-amd64<font></font>
â”œâ”€â”€ patterns<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ ruby<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ redis<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ rails<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ postgresql<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ nagios<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ mongodb<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ mcollective-patterns<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ mcollective<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ linux-syslog<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ junos<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ java<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ haproxy<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ grok-patterns<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ firewalls<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ exim<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ bro<font></font>
â”‚&nbsp;&nbsp; â”œâ”€â”€ bacula<font></font>
â”‚&nbsp;&nbsp; â””â”€â”€ aws<font></font>
â”œâ”€â”€ grok_exporter<font></font>
â””â”€â”€ example<font></font>
    â”œâ”€â”€ exim-rejected-RCPT-examples.log<font></font>
    â”œâ”€â”€ config.yml<font></font>
    â””â”€â”€ config_logstash_http_input_ipv6.yml<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dimana:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - eksportir dapat dieksekusi</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pola</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - berisi serangkaian pola</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contoh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - berisi kumpulan data uji dan contoh file konfigurasi</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk memulai eksportir, jalankan saja file yang dapat dieksekusi. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> konfigurasi </font><b><font style="vertical-align: inherit;">config.yml</font></b><font style="vertical-align: inherit;"> dicari di direktori dari mana aplikasi diluncurkan atau lokasinya ditentukan oleh opsi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-config</font></font></b></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan dan persiapan untuk pekerjaan</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h3><br>
<p>,      PostgreSQL.  :</p><br>
<ol>
<li>     grok_exporter    .    ,   pg_reload_conf. <br>
<br>
<ul>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_directory <span class="hljs-keyword">to</span> <span class="hljs-string">'/var/log/postgresql'</span>; </code></pre></li>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_mode <span class="hljs-keyword">to</span> <span class="hljs-string">'0644'</span>;</code></pre> </li>
</ul></li>
<li> log_line_prefix,  .      ,    .  : <br>
<br>
<pre><code class="sql hljs"> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_line_prefix <span class="hljs-keyword">to</span> <span class="hljs-string">'%t datname:%d,client:%h,app:%a,usename:%u,session:%c '</span>;</code></pre></li>
</ol><br>
<h3>grok_exporter</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, kita akan mengedit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pola /</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> template </font><b><font style="vertical-align: inherit;">postgresql</font></b><font style="vertical-align: inherit;"> sesuai dengan format file log kita dan menambahkan konstruksi tambahan. </font><font style="vertical-align: inherit;">Saya menekankan sekali lagi bahwa sintaks template sepenuhnya konsisten dengan yang digunakan dalam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filter-grok</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , oleh karena itu, untuk semua masalah yang berkaitan dengan sintaks, Anda dapat dan harus pergi ke dokumentasinya. </font><font style="vertical-align: inherit;">Jadi, mari kita bawa templat kita untuk PostgreSQL ke formulir (file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pola / grok-pola</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sudah berisi seperangkat besar templat dasar):</font></font><br>
<br>
<pre><code class="plaintext hljs">#     - postgresql<font></font>
PG_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND} [A-Z]{3,4}<font></font>
<font></font>
#    <font></font>
PG_ERROR_PATTERN (ERROR|WARNING|FATAL|PANIC)<font></font>
<font></font>
# log_line_prefix   - PostgreSQL<font></font>
PG_PREFIX %{PG_TIMESTAMP} datname:(%{DATA:datname})?,client:(%{DATA:client_host})?,app:(%{DATA:app_name})?,usename:(%{USER:usename})?,session:(%{DATA:session})?<font></font>
<font></font>
#    log_level     <font></font>
PG_ERROR_LEVEL %{PG_ERROR_PATTERN:log_level}:<font></font>
<font></font>
#    <font></font>
PG_EVENT_AUTH LOG:  connection authorized:<font></font>
<font></font>
#      SIGHUP,   <font></font>
PG_EVENT_RELOAD LOG:  received SIGHUP, reloading configuration files<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desain </font></font><code>()?</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda menunjukkan bahwa nilainya opsional.</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di sini, secara</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cukup rinci, dengan contoh, proses membuat file konfigurasi dijelaskan. </font><font style="vertical-align: inherit;">Di bawah ini, hanya apa yang akan digunakan yang diberikan.</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deskripsi singkat tentang file konfigurasi (dari dokumentasi)</font></font></b>
                        <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File konfigurasi adalah file dalam format YAML dan dibagi menjadi beberapa bagian:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">global yang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengaturan global -</font></font><br>
<ul>
<li><b>config_version</b> â€”   .    grok_exporter,   â‰¥ 1.0.0.RC3,   3<br>
 <b>retention_check_interval</b> â€”    .    ,   .<br>
</li>
</ul><br>
</li>
<li><b>input</b> â€”         .<br>
<br>
<ul>
<li><b>type</b> â€”   .  : file, stdin, webhook.   ,    <b>file</b>;</li>
<li><b>path|paths</b> â€” c      -(-).   ;</li>
<li><b>readall</b> â€” ,       .<br>
  <b>true</b> â€”     ,     .       Prometheus . <br>
  <b>false</b> â€”      ,        grok_exporter;</li>
<li><b>fail_on_missing_logfile</b> â€”       -.  <b>true</b> â€”    ,    ;</li>
</ul></li>
<li><b>imports</b> â€” ,   ,          .    2,    ,   <b>grok</b>.<br>
<br>
<ul>
<li><b>type</b> â€”     <b>grok_patterns</b> ()  metrics ();</li>
<li><b>file|dir</b> â€”  .          , .</li>
</ul><br>
</li>
<li><b>grok_patterns</b> â€” ,         .</li>
<li><b>metrics</b> â€”    .   â€” counter, gauge, histogram, or summary.</li>
<li><b>server</b> â€”    <br>
<br>
<pre><code class="plaintext hljs">  protocol: https<font></font>
  host: localhost<font></font>
  port: 9144<font></font>
  path: /metrics<font></font>
  cert: /path/to/cert<font></font>
  key: /path/to/key<font></font>
</code></pre><br>
 </li>
</ol><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam sintaks file konfigurasi versi ke-3, mengimpor metrik dari file individual menjadi mungkin, ini memungkinkan Anda untuk mengelompokkan metrik berdasarkan tujuan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, buat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> konfigurasi base </font><b><font style="vertical-align: inherit;">config.yml</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Di dalamnya, kita: mengatur path ke file log PostgreSQL dengan mask; </font><font style="vertical-align: inherit;">impor templat dari direktori </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pola</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan metrik dari direktori </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics.d</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font><font style="vertical-align: inherit;">kami menunjukkan dengan protokol apa dan pada port mana perlu untuk menerapkan metrik.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  config_version: 3<font></font>
  retention_check_interval: 10s<font></font>
input:<font></font>
  type: file<font></font>
  path: /var/log/postgresql/postgresql-*.log<font></font>
  readall: false<font></font>
imports:<font></font>
- type: grok_patterns<font></font>
  dir: ./patterns<font></font>
- type: metrics<font></font>
  dir: ./metrics.d<font></font>
server:<font></font>
  protocol: http<font></font>
  port: 9144<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>,   <b>metrics.d</b>      <b>postgresql.yml</b>,       .<br>
<br>
 ,       , ..       (  retention, - 2  30 )    ,    .        <b>retention_check_interval</b>.<br>
<br>
 ,  :<br>
<br>
</p><ul>
<li>       ,        ;</li>
<li>     â€”   GAUGE  COUNTER,   . ..     GAUGE,         ;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika kumulatif disetel ke true, nilai metrik dengan set label yang sama akan dijumlahkan, yang merupakan perilaku yang diharapkan. </font><font style="vertical-align: inherit;">Situasi tak terduga dapat muncul ketika, pada permintaan kedua, Anda bisa mendapatkan jumlah nilai dalam permintaan ditambah nilai sebelumnya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika kumulatif disetel ke false, jika ada metrik dengan set label yang sama, hanya nilai terakhir yang akan ditampilkan;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata banyak surat, membingungkan dan tidak bisa dipahami di beberapa tempat, tetapi saya akan mencoba untuk mengungkapkannya dalam contoh di bawah ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, kami memiliki file konfigurasi yang dapat mengembalikan empat metrik, tiga penghitung, dan satu nilai arbitrer. </font><font style="vertical-align: inherit;">Faktanya, tiga yang pertama mempertimbangkan jumlah kecocokan dari bidang templat kecocokan dengan string yang diterima dari sumber, yang keempat - menampilkan jumlah nilai.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.yaml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">#  - <font></font>
- type:   counter<font></font>
  name:   pg_grok_error_count<font></font>
  help:   Count of line error<font></font>
  match:  '%{PG_PREFIX} %{PG_ERROR_LEVEL}  %{GREEDYDATA:message}'<font></font>
  labels:<font></font>
    log_level:   '{{.log_level}}'<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
    message:     '{{.message}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_auth_succes_count<font></font>
  help:   Count of connections authorized<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_AUTH}'<font></font>
  labels:<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_reload_conf_count<font></font>
  help:   Count of call pg_reload_conf<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_RELOAD}'<font></font>
  labels:<font></font>
    session:     '{{.session}}'<font></font>
<font></font>
#   <font></font>
- type:       gauge<font></font>
  name:       pg_grok_tpm_file_size_bytes<font></font>
  help:       Size of tmp file created by time<font></font>
  match:      '%{PG_PREFIX} %{PG_EVENT_TMP_FILE}'<font></font>
  value:      '{{.size}}'<font></font>
  cumulative: true<font></font>
  retention:  5s<font></font>
  labels:<font></font>
    static:     'temp_file'<font></font>
</code></pre><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Praktek</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_error_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metrik menghitung jumlah acara ERROR, PERINGATAN, FATAL dan PANIC, sesuai dengan pola. </font><font style="vertical-align: inherit;">Ini dapat berguna untuk pemantauan dan peringatan jika terjadi keadaan darurat. </font><font style="vertical-align: inherit;">Misalnya, Anda dapat mengonfigurasi peringatan dalam kasus berikut: upaya otorisasi yang gagal, melebihi ambang jumlah kesalahan per unit waktu, atau ketika database berada dalam keadaan pemulihan setelah kegagalan, dan banyak lagi ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log Kategori Acara</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, kami akan menyiapkan lansiran tentang upaya otorisasi yang gagal. </font><font style="vertical-align: inherit;">Contoh upaya login yang gagal di file log PostgreSQL terlihat seperti ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 FATAL:  password authentication failed for user "test_user"<font></font>
2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 DETAIL:  Password does not match for user "test_user".<font></font>
        Connection matched pg_hba.conf line 86: "host    all             all             127.0.0.1/32            md5"<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam output grok_exporter, upaya otentikasi yang gagal dapat diidentifikasi oleh label </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pesan yang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> berisi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otentikasi kata sandi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> substring </font><b><font style="vertical-align: inherit;">gagal untuk ...</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
</p><pre><code class="plaintext hljs">pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="postgres",log_level="FATAL",message="password authentication failed for user "postgres"", usename="postgres"} 15<font></font>
pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="test",log_level="FATAL",message="password authentication failed for user \"test_user\"",usename="test_user"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data yang diperoleh akan membantu merumuskan aturan untuk Prometheus. </font><font style="vertical-align: inherit;">Sensitivitas dapat disesuaikan berdasarkan realitas Anda sendiri.</font></font><br>
<br>
<pre><code class="plaintext hljs">groups:<font></font>
- name: AuthAlert<font></font>
  rules:<font></font>
  - alert: AuthFail<font></font>
    expr: sum(rate(pg_grok_error_count{message=~"password authentication failed for user.*"}[1m])) by (instance) &gt; 0.1<font></font>
    for: 30s<font></font>
    labels:<font></font>
      severity: warning<font></font>
    annotations:<font></font>
      summary: Too many fail authorization for {{ $labels.instance }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_reload_conf_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demikian pula, Anda dapat melacak eksekusi perintah pg_reload_conf. </font><font style="vertical-align: inherit;">Selain itu, perlu memperhatikan daftar label, atau lebih tepatnya, fakta bahwa hanya satu label sesi yang digunakan. </font><font style="vertical-align: inherit;">Ini karena fakta bahwa acara dibuat sebagai bagian dari proses server, dan bukan sesi pengguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam file log PostgreSQL, acara ini terlihat seperti ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:20:26 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received SIGHUP, reloading configuration files
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu </font><font style="vertical-align: inherit;">dapat dilihat bahwa label yang digunakan pada contoh sebelumnya kosong. </font><font style="vertical-align: inherit;">Dalam hal ini, kami akan menggunakan pengidentifikasi sesi untuk identifikasi, dan itu tidak akan berubah sampai instance PostgreSQL dihentikan atau dimulai kembali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situasi serupa akan terjadi pada kasus serupa lainnya, misalnya, menghentikan instance:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:32:52 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received fast shutdown request<font></font>
2020-04-21 01:32:53 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  database system is shut down<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam output grok_exporter, kita mendapatkan:</font></font><br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_reload_conf_count Count of call pg_reload_conf<font></font>
# TYPE pg_grok_reload_conf_count counter<font></font>
pg_grok_reload_conf_count{session="5e9d9371.564"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aturan untuk notifikasi, tidak ada gunanya membawanya, itu akan mirip dengan yang dibahas di atas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_tpm_file_size_bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera buat reservasi bahwa contoh ini berasal dari kategori "kuda bulat dalam ruang hampa" dan diberikan lebih banyak untuk menunjukkan bagaimana Anda dapat mengubah perilaku metrik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perilaku </font><font style="vertical-align: inherit;">metrik </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengukur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat dipengaruhi dengan mengubah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retensi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font><font style="vertical-align: inherit;">parameter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kumulatif</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Memang, tidak seperti penghitung biasa, yang mempertimbangkan jumlah garis yang cocok dengan pola kecocokan, pengukur memungkinkan Anda untuk beroperasi pada data dari file log. Ternyata kami dapat mengakumulasikannya dengan menambah atau mengurangi nilai yang diperoleh, atau menggunakannya sebagai nilai yang berubah secara sewenang-wenang. Jadi, dalam kasus pertama, kita akan tertarik pada besarnya kenaikan, pada yang kedua - nilai itu sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat beberapa contoh:</font></font><br>
<br>
<ol>
<li>    ,     (<b>cumulative: true</b>).      ,    ,     .     ,  <b>retention_check_interval + retention &lt;= scrape_interval</b> â€”        Prometheus.<br>
<br>
        - PostgreSQL  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1278 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4728.0", size 46931968<font></font>
2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1279 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4729.0", size 46276608<font></font>
2020-04-21 02:51:15 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.14", size 47194112<font></font>
</code></pre><br>
,      :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
               .<br>
<br>
,       :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07
</code></pre><br>
     :      ,    .</li>
<li><p> ,       ,       (<b>retention</b>)    (<b>cumulative: true</b>)<br>
    ,  - PostgreSQL :</p><br>
<pre><code class="plaintext hljs">2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c6 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4806.0", size 46260224<font></font>
2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c5 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4805.0", size 46833664<font></font>
2020-04-21 03:03:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.15", size 47316992<font></font>
</code></pre><br>
   :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
   ,  . :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1325 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4901.0", size 46776320<font></font>
2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1324 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4900.0", size 45768704<font></font>
2020-04-21 03:10:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.18", size 47841280<font></font>
</code></pre><br>
    :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 2.80772608e+08
</code></pre><br>
          ,     .       ,    .</li>
<li>     ,   <b>cumulative</b>  <b>false</b>    ,  .<br>
<br>
  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1393 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5011.0", size 11763712<font></font>
2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1392 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5010.0", size 11501568<font></font>
2020-04-21 03:41:04 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.19", size 11911168<font></font>
</code></pre><br>
 :<br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_tpm_file_size_bytes Size of tmp file created by time<font></font>
# TYPE pg_grok_tpm_file_size_bytes gauge<font></font>
pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07<font></font>
</code></pre><br>
 ,       .  ,            .</li>
</ol><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak diragukan lagi grok_exporter adalah alat yang tepat untuk memonitor aplikasi. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk melihat "sulit untuk diakses", untuk sistem pemantauan, tempat dan memperkaya pemantauan dengan metrik (kontrol) tambahan, namun tetap cukup sederhana, fungsional dan ringan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, ini juga akan berguna bagi pengembang, karena memberikan setidaknya akses tidak langsung ke log aplikasi melalui sistem pemantauan. </font><font style="vertical-align: inherit;">Di mana Anda dapat menghubungkan metrik dari berbagai sumber. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Poin positif lainnya adalah bahwa proyek ini sedang mengembangkan dan memperoleh fungsionalitas baru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada gilirannya, saya berharap bahwa catatan singkat ini akan bermanfaat, termasuk untuk proyek itu sendiri. </font><font style="vertical-align: inherit;">Lebih banyak bintang, lebih banyak pekerjaan menyenangkan! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terimakasih untuk semua!</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id487302/">https://habr.com/ru/post/id487302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id487288/index.html">Bagaimana Atari Menantang Apple ke Lapangan PC Rumah 1980-an</a></li>
<li><a href="../id487290/index.html">Samsung secara remote memblokir Smart TV â€œabu-abuâ€ di Rusia. UPD - Pernyataan Samsung</a></li>
<li><a href="../id487294/index.html">Playwright - Microsoft Playwright dan Alat Pengujian Baru</a></li>
<li><a href="../id487296/index.html">Pengalaman membuat aplikasi web dengan Pony ORM</a></li>
<li><a href="../id487298/index.html">Dampak Ethernet pada Teknologi Jaringan pada tahun 2020</a></li>
<li><a href="../id487308/index.html">Java Records (JEP 359)</a></li>
<li><a href="../id487310/index.html">Cara menghitung model keuangan dari program loyalitas</a></li>
<li><a href="../id487314/index.html">Beban pekerja kerah putih (tentang diskriminasi dalam TI)</a></li>
<li><a href="../id487318/index.html">Pengantar otentikasi timbal balik dari layanan di Jawa dengan TLS / SSL</a></li>
<li><a href="../id487322/index.html">Visualisasi sains: ilustrasi dan infografis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>