<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👔 💪🏾 😰 マイクロサービスアーキテクチャでのSSO。Keycloakを使用しています。部品番号1 🥀 💃 🎅🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大企業では、X5 Retail Groupも例外ではありません。プロジェクトの数が増えると、ユーザー認証が必要なプロジェクトの数も増えるからです。時間の経過とともに、あるアプリケーションから別のアプリケーションへのユーザーのシームレスな移行が必要になり、単一のサーバーであるSingle-Sing-O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マイクロサービスアーキテクチャでのSSO。Keycloakを使用しています。部品番号1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/486778/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大企業では、X5 Retail Groupも例外ではありません。プロジェクトの数が増えると、ユーザー認証が必要なプロジェクトの数も増えるからです。時間の経過とともに、あるアプリケーションから別のアプリケーションへのユーザーのシームレスな移行が必要になり、単一のサーバーであるSingle-Sing-On（SSO）を使用する必要があります。しかし、ADなどの追加の属性を持たないIDプロバイダーがすでにさまざまなプロジェクトで使用されている場合はどうでしょうか。 「アイデンティティブローカー」と呼ばれるシステムのクラスが助けになります。最も機能的なのは、Keycloak、Gravitee Access管理などの代表的なものです。ほとんどの場合、使用シナリオは異なる可能性があります：マシンの相互作用、ユーザーの参加など。ソリューションは柔軟でスケーラブルな機能をサポートする必要があります。すべての要件を1つにまとめることができ、当社のこのようなソリューションはインジケーターブローカーであるKeycloakです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hm/bi/eh/hmbiehmxsfcq_cfltz8xj0mhrgc.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloakは、RedHatがサポートする認証とアクセス制御のためのオープンソース製品です。</font><font style="vertical-align: inherit;">これは、SSO-RH-SSOを使用する会社の製品の基礎です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本概念 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
決定とアプローチに取り掛かる前に、用語とプロセスのシーケンスを決定する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mm/j1/c2/mmj1c2uynwb23y5j4me13zzcrb4.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">識別</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、その識別子によってサブジェクトを認識するプロセスです（つまり、名前、ログイン、または番号を決定しています）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認証</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は認証手順です（ユーザーはパスワードで検証され、手紙は電子署名で検証され</font><font style="vertical-align: inherit;">ます）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はリソース（電子メール</font><font style="vertical-align: inherit;">など）</font><font style="vertical-align: inherit;">へのアクセスの提供です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloakアイデンティティブローカー</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、マイクロサービスアーキテクチャパターンを使用できるICで使用するために設計されたオープンソースのIDおよびアクセス管理ソリューションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloakは、シングルサインオン（SSO）、ブローカーの識別とソーシャルログイン、ユーザーフェデレーション、クライアントアダプター、管理者コンソール、アカウント管理コンソールなどの機能を提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloakでサポートされる基本機能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザベースのアプリケーションのシングルサインオンとシングルサインアウト。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenID / OAuth 2.0 / SAMLのサポート。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identity Brokering-外部OpenID ConnectまたはSAML IDプロバイダーを使用した認証。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソーシャルログイン-ユーザー識別のためのGoogle、GitHub、Facebook、Twitterのサポート。</font></font></li>
<li>User Federation –    LDAP  Active Directory     .</li>
<li>Kerberos bridge –  Kerberos     .</li>
<li>Admin Console —         Web.</li>
<li>Account Management Console –     .</li>
<li>      .</li>
<li>2FA Authentication –  TOTP/HOTP   Google Authenticator  FreeOTP.</li>
<li>Login Flows –   ,      .</li>
<li>Session Management –        .</li>
<li>Token Mappers –   ,       .</li>
<li>    realm, application  .</li>
<li>CORS Support –      CORS.</li>
<li>Service Provider Interfaces (SPI) –   SPI,      :  ,  ,     .</li>
<li>   JavaScript applications, WildFly, JBoss EAP, Fuse, Tomcat, Jetty, Spring.</li>
<li>    ,  OpenID Connect Relying Party library  SAML 2.0 Service Provider Library.</li>
<li>    plugins.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CI / CDプロセス、およびKeycloakの管理プロセスの自動化には、REST API / JAVA APIを使用できます。</font><font style="vertical-align: inherit;">ドキュメントが電子形式で提供されています：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
REST API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/rest-api/index.html</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
JAVA API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/javadocs /index.html</font></font></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンタープライズIDプロバイダー（オンプレミス）</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーフェデレーションサービスを介してユーザーを認証する機能。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8j/s9/cl/8js9cl3cx9whnsshxcel0xynpqs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パススルー認証も使用できます。ユーザーがワークステーションでKerberos（LDAPまたはAD）を使用して認証する場合、ユーザー名とパスワードを再度入力しなくても、Keycloakで自動的に認証されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーの認証と承認には、プロジェクトの初期段階で長期的な設定と統合を必要としないため、開発環境に最も適したリレーショナルDBMSを使用できます。デフォルトでは、Keycloakは組み込みのDBMSを使用して設定とユーザーデータを保存します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サポートされるDBMSのリストは広範で、MS SQL、Oracle、PostgreSQL、MariaDB、Oracleなどが含まれます。</font><font style="vertical-align: inherit;">現在最もテストされているのは、Oracle 12C Release1 RACとMariaDB 10.1.19用のGalera 3.12クラスターです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDプロバイダー-ソーシャルログイン </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソーシャルネットワークからのログインを使用することが可能です。</font><font style="vertical-align: inherit;">ユーザーを認証する機能をアクティブにするには、Keycloack管理コンソールを使用します。</font><font style="vertical-align: inherit;">アプリケーションコードを変更する必要はなく、この機能は「そのまま」使用でき、プロジェクトのどの段階でもアクティブ化できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/rj/vp/bsrjvpxnw7eojom-_bv816iwoxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーを認証するために、OpenID / SAML IDプロバイダーを使用することが可能です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KeycloakでOAuth2を使用する一般的な承認シナリオ</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認コードフロー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -サーバー側アプリケーションで使用されます。アプリケーションのソースコードとクライアントデータに外部からアクセスできないサーバーアプリケーションに適しているため、最も一般的な種類の承認アクセス許可の1つ。この場合のプロセスは、リダイレクトに基づいています。アプリケーションは、Webエージェントなどのユーザーエージェント（ユーザーエージェント）と対話して、ユーザーエージェントを通じてリダイレクトされたAPI認証コードを受信できる必要があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗黙的フロー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -モバイルまたはWebアプリケーション（ユーザーのデバイスで実行されるアプリケーション）によって使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗黙のタイプの許可許可は、クライアントのプライバシーを保証できないモバイルおよびWebアプリケーションで使用されます。</font><font style="vertical-align: inherit;">暗黙的な権限タイプもユーザーエージェントリダイレクトを使用し、アクセストークンはアプリケーションでさらに使用するためにユーザーエージェントに渡されます。</font><font style="vertical-align: inherit;">これにより、ユーザーおよびユーザーのデバイス上の他のアプリケーションがトークンを使用できるようになります。</font><font style="vertical-align: inherit;">このタイプの許可許可では、アプリケーションは認証されず、プロセス自体はリダイレクトURL（以前にサービスに登録された）に依存します。</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implicit Flowは更新トークンをサポートしていません。
</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント資格情報付与フロー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -アプリケーションがAPIにアクセスするときに使用されます。</font><font style="vertical-align: inherit;">このタイプの許可許可は、通常、サーバー間の対話で使用され、ユーザーとの直接の対話なしにバックグラウンドで実行する必要があります。</font><font style="vertical-align: inherit;">クライアント資格情報フローにより、Webサービス（機密クライアント）は、別のWebサービスを呼び出すときに認証のためにユーザーを偽装する代わりに、独自の資格情報を使用できます。</font><font style="vertical-align: inherit;">より高いレベルのセキュリティのために、呼び出し側のサービスが資格情報として（共有シークレットの代わりに）証明書を使用することが可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2仕様は</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-6749 </font></font></a> <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-8252 </font></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">RFC-6819で</font></a><font style="vertical-align: inherit;">説明されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JWTトークンとその利点</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JWT（JSON Web Token）はオープンな標準（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://tools.ietf.org/html/rfc7519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）で、パーティ間で情報をJSONオブジェクトとして安全に転送するためのコンパクトでスタンドアロンの方法を定義しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準によると、トークンはドットで区切られたbase-64形式の3つの部分で構成されています。</font><font style="vertical-align: inherit;">最初の部分はヘッダーと呼ばれ、デジタル署名を取得するためのトークンのタイプとハッシュアルゴリズムの名前が含まれています。</font><font style="vertical-align: inherit;">2番目の部分には、基本情報（ユーザー、属性など）が格納されます。</font><font style="vertical-align: inherit;">3番目の部分はデジタル署名です。</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;エンコードされたヘッダー&gt;。&lt;エンコードされたペイロード&gt;。&lt;署名&gt;</font></font></oembed><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トークンをデータベースに保存しないでください。</font><font style="vertical-align: inherit;">有効なトークンはパスワードと同等であるため、トークンを保存することは、パスワードをクリアテキストで保存することに似ています。</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセストークン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、サーバーの保護されたリソースへのアクセス権を所有者に与えるトークンです。</font><font style="vertical-align: inherit;">通常、有効期間は短く、このトークンを要求するパーティのIPアドレスなどの追加情報を運ぶことができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新トークン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、有効期限が切れた後にクライアントが新しいアクセストークンをリクエストできるようにするトークンです。</font><font style="vertical-align: inherit;">これらのトークンは通常、長期間発行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロサービスアーキテクチャでのアプリケーションの主な利点：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワンタイム認証を通じてさまざまなアプリケーションやサービスにアクセスする機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザープロファイルに多数の必須属性がない場合、自動化されたオンザフライを含め、ペイロードに追加できるデータを充実させることができます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクティブなセッションに関する情報を保存する必要はありません。サーバーアプリケーションは署名を確認するだけです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロードに属性を追加した、より柔軟なアクセス制御。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダーとペイロードにトークン署名を使用すると、ソリューション全体のセキュリティが向上します。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JWTトークン-構成</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -デフォルトでは、ヘッダーには暗号化に使用されるトークンのタイプとアルゴリズムのみが含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トークンのタイプは「typ」キーに格納されます。</font><font style="vertical-align: inherit;">「typ」キーはJWTでは無視されます。</font><font style="vertical-align: inherit;">typキーが存在する場合、この値がJWTである必要があり、このオブジェクトがJSON Web Tokenであることを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のalgキーは、トークンの暗号化に使用されるアルゴリズムを定義します。</font><font style="vertical-align: inherit;">デフォルトでは、HS256に設定する必要があります。</font><font style="vertical-align: inherit;">ヘッダーはbase64でエンコードされています。</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg"： "HS256"、 "typ"： "JWT"}</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロード（コンテンツ）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ペイロードには、検証が必要な情報が格納されます。</font><font style="vertical-align: inherit;">ペイロードの各キーは「ステートメント」と呼ばれます。</font><font style="vertical-align: inherit;">たとえば、アプリケーションは招待状（クローズドプロモーション）でのみ入力できます。</font><font style="vertical-align: inherit;">誰かを招待する場合は、招待状を送ります。</font><font style="vertical-align: inherit;">電子メールアドレスが招待を受け入れる人に属していることを確認することが重要です。そのため、このアドレスをペイロードに含めます。これのために、「電子メール」キーに保存します</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"メール"： "example@x5.ru"}
</font></font></oembed><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペイロードのキーは任意にすることができます。</font><font style="vertical-align: inherit;">ただし、いくつかの予約済みのものがあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iss（発行者）-トークンの送信元のアプリケーションを定義します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub（件名）-トークンのトピックを定義します。</font></font></li>
<li>aud (Audience) –       URI,     .     JWT   ,        —   .</li>
<li>exp (Expiration Time) — ,     .  JWT ,           . Exp       unix .</li>
<li>nbf (Not Before) —    unix ,  ,    .</li>
<li>iat (Issued At) —     ,            JWT. iat       unix .</li>
<li>Jti (JWT ID) — ,      c  .</li>
</ul><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロードは暗号化された形式で送信されないことを理解することが重要です（トークンを埋め込むことができ、暗号化されたデータを送信することは可能です）。</font><font style="vertical-align: inherit;">したがって、秘密情報を格納することは不可能です。</font><font style="vertical-align: inherit;">ヘッダーと同様に、ペイロードはbase64でエンコードされます。</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">署名</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ヘッダーとペイロードがある場合、署名を計算できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Base64エンコード：ヘッダーとペイロードが取得され、ドットを介して行に結合されます。</font><font style="vertical-align: inherit;">次に、この行と秘密鍵が、ヘッダーで指定された暗号化アルゴリズムの入力（鍵 "alg"）に送信されます。</font><font style="vertical-align: inherit;">キーは任意の文字列にすることができます。</font><font style="vertical-align: inherit;">一致するのに時間がかかるため、長い文字列が望ましいです。</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg"： "RSA1_5"、 "payload"： "A128CBC-HS256"}</font></font></oembed><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloakフェイルオーバークラスターアーキテクチャ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのプロジェクトに単一のクラスターを使用する場合、SSOのソリューションに対する要件が増加します。プロジェクトの数が少ない場合、これらの要件はすべてのプロジェクトでそれほど顕著ではありませんが、ユーザー数と統合の増加に伴い、アクセシビリティと生産性の要件が増加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単一のSSOの失敗のリスクが高まると、ソリューションアーキテクチャの要件とコンポーネントの冗長性に使用される方法が増加し、SLAが非常に厳しくなります。この点で、ソリューションの開発時または実装の初期段階では、多くの場合、プロジェクトには独自の非フォールトトレラントインフラストラクチャがあります。開発するにつれて、開発とスケーリングの可能性を築く必要があります。最も柔軟なのは、コンテナ仮想化またはハイブリッドアプローチを使用してフェイルオーバークラスタを構築することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクティブ/アクティブおよびアクティブ/パッシブクラスターで作業するには、リレーショナルデータベース内のデータの整合性を確保する必要があります。両方のデータベースノードは、異なる地理的に分散したデータセンター間で同期的に複製される必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フェイルセーフインストールの最も単純な例。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/tw/7w/xotw7wkifwb3h6nnclvnjbbe72c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単一のクラスターを使用する利点は何ですか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高可用性とパフォーマンス。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動作モードのサポート：アクティブ/アクティブ、アクティブ/パッシブ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的にスケーリングする機能-コンテナー仮想化を使用する場合。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集中管理と監視の可能性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクト内のユーザーの識別/認証/承認のための統一されたアプローチ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーの関与なしに、さまざまなプロジェクト間のより透過的な相互作用。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまなプロジェクトでJWTトークンを再利用する機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単一の信頼点。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロサービス/コンテナー仮想化を使用してプロジェクトをより迅速に起動します（追加のコンポーネントを調達して構成する必要はありません）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おそらく、ベンダーからの商用サポートの取得。 </font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターを計画する際の考慮事項</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBMS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloakは、DBMS管理システムを使用して、レルム、クライアント、ユーザーなどを保存します。MSSQL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、Oracle、MySQL、PostgreSQL </font><font style="vertical-align: inherit;">など、</font><font style="vertical-align: inherit;">幅広いDBMSがサポートされています。</font><font style="vertical-align: inherit;">Keycloakには、独自のリレーショナルデータベースが組み込まれています。</font><font style="vertical-align: inherit;">開発環境など、ロードされていない環境での使用をお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクティブ/アクティブおよびアクティブ/パッシブクラスターで動作するには、リレーショナルデータベースのデータの整合性を確保する必要があり、データベースクラスターの両方のノードがデータセンター間で同期的にレプリケートされます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散キャッシュ（Infinspan）</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターが正しく機能するには、JBoss Data Gridを使用して以下のキャッシュタイプの追加の同期が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
認証セッション-特定のユーザーの認証中にデータを保存するために使用されます。</font><font style="vertical-align: inherit;">このキャッシュからのリクエストには通常、ブラウザとKeycloakサーバーのみが含まれ、アプリケーションは含まれません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクショントークン-ユーザーが非同期で（電子メール経由で）アクションを確認する必要があるシナリオで使用されます。</font><font style="vertical-align: inherit;">たとえば、パスワードを忘れたときのストリームでは、actionTokens Infinispanキャッシュを使用して、すでに使用されている関連するアクションマーカーに関するメタデータを追跡するため、再利用できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
永続データのキャッシュと無効化-不必要なデータベースクエリを回避するために永続データをキャッシュするために使用されます。</font><font style="vertical-align: inherit;">Keycloakサーバーがデータを更新するとき、すべてのデータセンター内の他のすべてのKeycloakサーバーはこれを認識しているはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業-クラスターノードとデータセンター間で無効化メッセージを送信するためにのみ使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーセッション-ユーザーのブラウザセッションで有効なユーザーセッションに関するデータを保存するために使用されます。</font><font style="vertical-align: inherit;">キャッシュは、エンドユーザーとアプリケーションからのHTTPリクエストを処理する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブルートフォース保護-失敗したログインデータの追跡に使用されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷分散</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロードバランサーはキークロークの単一のエントリポイントであり、スティッキーセッションをサポートする必要があります。 </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション・サーバー</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは、コンポーネント間の相互作用を制御するために使用され、既存の自動化ツールと動的にスケーリングするインフラストラクチャ自動化ツールを使用して仮想化またはコンテナ化できます。</font><font style="vertical-align: inherit;">OpenShift、Kubernetes、Rancherの最も一般的なデプロイメントシナリオ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、最初の部分-理論的-は終わりました。</font><font style="vertical-align: inherit;">以下の一連の記事では、さまざまな識別プロバイダーとの統合の例と構成例について説明します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486764/index.html">Do-it-yourself Schema.org：プログラマーなしでのマイクロレイアウトのカスタマイズ</a></li>
<li><a href="../ja486766/index.html">古いファクタリング市場ですべてのトランザクションをオンラインで転送する方法は？Sberbank Factoringの経験</a></li>
<li><a href="../ja486768/index.html">Webasyst管理パネルの改訂</a></li>
<li><a href="../ja486772/index.html">燃やすが燃やすのではなく、燃やして輝く</a></li>
<li><a href="../ja486776/index.html">boto3のコード補完と型チェック</a></li>
<li><a href="../ja486780/index.html">会社のフロントエンド開発：それとは何か、それを効果的にする方法</a></li>
<li><a href="../ja486782/index.html">UI / UX-デザイン。2020年のトレンドと予測</a></li>
<li><a href="../ja486784/index.html">ルミエール兄弟は決して夢を見なかった</a></li>
<li><a href="../ja486788/index.html">ウェビナー「リモート監視と機器診断。Winnum CNCソリューションのケーススタディ»</a></li>
<li><a href="../ja486790/index.html">そして再びQbot-バンキング型トロイの木馬の新種</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>