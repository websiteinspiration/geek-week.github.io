<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê≤ üå† üèΩ Limites de CPU e acelera√ß√£o agressiva no Kubernetes üßÄ üêÆ ‚ûø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : Este conto preventivo do Omio, o agregador de viagens europeu, leva os leitores da teoria b√°sica aos cativantes meandros pr√°ticos da con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Limites de CPU e acelera√ß√£o agressiva no Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489668/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota perev.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Este conto preventivo do Omio, o agregador de viagens europeu, leva os leitores da teoria b√°sica aos cativantes meandros pr√°ticos da configura√ß√£o do Kubernetes. A familiaridade com esses casos ajuda n√£o apenas a ampliar os horizontes, mas tamb√©m a evitar problemas n√£o triviais.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/bw/jr/on/bwjronw-hyhosv46aa1d6pqldie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ j√° encontrou o fato de que o aplicativo "travou" no local, parou de responder √†s solicita√ß√µes de verifica√ß√£o de integridade e n√£o conseguiu entender o motivo desse comportamento? Uma explica√ß√£o poss√≠vel √© o limite de cota para recursos da CPU. Ele ser√° discutido neste artigo.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TL; DR: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√© altamente recomend√°vel que voc√™ desative os limites de CPU no Kubernetes (ou desative as cotas CFS no Kubelet) se estiver usando uma vers√£o do kernel Linux com um erro de cota CFS. No n√∫cleo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h√°</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um </font><font style="vertical-align: inherit;">bug </font><font style="vertical-align: inherit;">s√©rio e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conhecido</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que leva a acelera√ß√£o e atrasos excessivos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Omio, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toda a infraestrutura √© gerenciada pelo Kubernetes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Todas as nossas cargas com e sem estado funcionam exclusivamente no Kubernetes (usamos o Google Kubernetes Engine). </font><font style="vertical-align: inherit;">Nos √∫ltimos seis meses, come√ßamos a observar desacelera√ß√µes aleat√≥rias. </font><font style="vertical-align: inherit;">Os aplicativos congelam ou param de responder √†s verifica√ß√µes de integridade, perdem a conex√£o com a rede etc. </font><font style="vertical-align: inherit;">Esse comportamento h√° muito nos deixou perplexos e, finalmente, decidimos abordar o problema de perto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumo do artigo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algumas palavras sobre cont√™ineres e Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como os pedidos e limites de CPU s√£o implementados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como o limite de CPU funciona em ambientes com v√°rios n√∫cleos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como rastrear a otimiza√ß√£o da CPU;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resolvendo o problema e as nuances.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas palavras sobre cont√™ineres e Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes, de fato, √© o padr√£o moderno no mundo da infraestrutura. </font><font style="vertical-align: inherit;">Sua principal tarefa √© a orquestra√ß√£o de cont√™ineres.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recipientes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No passado, t√≠nhamos que criar artefatos como Java JARs / WARs, Python Eggs ou execut√°veis ‚Äã‚Äãpara lan√ßamento subsequente em servidores. </font><font style="vertical-align: inherit;">No entanto, para faz√™-los funcionar, eles tiveram que fazer um trabalho adicional: instalar o tempo de execu√ß√£o (Java / Python), colocar os arquivos necess√°rios nos lugares certos, garantir a compatibilidade com uma vers√£o espec√≠fica do sistema operacional, etc. </font><font style="vertical-align: inherit;">Em outras palavras, voc√™ precisava prestar muita aten√ß√£o ao gerenciamento de configura√ß√£o (que geralmente causava contendas entre desenvolvedores e administradores de sistema). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recipientes mudaram tudo.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, a imagem do cont√™iner atua como um artefato. </font><font style="vertical-align: inherit;">Ele pode ser representado como um tipo de arquivo execut√°vel estendido que cont√©m n√£o apenas um programa, mas tamb√©m um tempo de execu√ß√£o completo (Java / Python / ...), bem como os arquivos / pacotes necess√°rios pr√©-instalados e prontos para execu√ß√£o. </font><font style="vertical-align: inherit;">Os cont√™ineres podem ser implantados e executados em v√°rios servidores sem nenhuma etapa adicional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, os cont√™ineres funcionam em seu pr√≥prio ambiente de sandbox. </font><font style="vertical-align: inherit;">Eles t√™m seu pr√≥prio adaptador de rede virtual, seu pr√≥prio sistema de arquivos com acesso limitado, sua pr√≥pria hierarquia de processos, suas pr√≥prias restri√ß√µes na CPU e na mem√≥ria, etc. Tudo isso √© conseguido gra√ßas a um subsistema especial do kernel do Linux - namespaces (namespace).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como afirmado anteriormente, o Kubernetes √© uma orquestra de cont√™ineres. </font><font style="vertical-align: inherit;">Funciona da seguinte maneira: voc√™ fornece um pool de m√°quinas e diz: "Ei, Kubernetes, inicie dez inst√¢ncias do meu cont√™iner com 2 processadores e 3 GB de mem√≥ria cada e mantenha-os operacionais!" </font><font style="vertical-align: inherit;">Kubernetes cuida do resto. </font><font style="vertical-align: inherit;">Ele encontrar√° capacidades livres, lan√ßar√° cont√™ineres e os reiniciar√° se necess√°rio, lan√ßar√° uma atualiza√ß√£o ao alterar vers√µes etc. </font><font style="vertical-align: inherit;">De fato, o Kubernetes permite abstrair do componente de hardware e torna toda a variedade de sistemas adequada para implanta√ß√£o e opera√ß√£o de aplicativos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/ux/tu/hsuxtucqvih716edmdtgac_btxa.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes do ponto de vista de um simples leigo</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que s√£o solicita√ß√£o e limite no Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certo, descobrimos os cont√™ineres e o Kubernetes. Tamb√©m sabemos que v√°rios cont√™ineres podem estar na mesma m√°quina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode desenhar uma analogia com um apartamento comum. Uma sala espa√ßosa √© levada (carros / n√≥s) e arrendada a v√°rios inquilinos (cont√™ineres). Kubernetes atua como um corretor de im√≥veis. Surge a pergunta: como manter os inquilinos em conflito entre si? E se um deles, por exemplo, decide ocupar o banheiro por meio dia? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que a solicita√ß√£o e o limite entram em jogo. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU </font><b><font style="vertical-align: inherit;">√© apenas</font></b><font style="vertical-align: inherit;"> para fins de planejamento. √â algo como a "lista de desejos" de um cont√™iner e √© usada para selecionar o n√≥ mais adequado. Ao mesmo tempo, o CPU </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser comparado a uma concess√£o - assim que escolhemos um n√≥ para o cont√™iner,</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o poder√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ir al√©m dos limites estabelecidos. </font><font style="vertical-align: inherit;">E aqui surge um problema ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como solicita√ß√µes e limites s√£o implementados no Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Kubernetes usa o mecanismo de limita√ß√£o do kernel (pulando o rel√≥gio) para implementar os limites da CPU. </font><font style="vertical-align: inherit;">Se o aplicativo exceder o limite, a acelera√ß√£o √© ativada (ou seja, recebe menos ciclos da CPU). </font><font style="vertical-align: inherit;">Solicita√ß√µes e limites de mem√≥ria s√£o organizados de maneira diferente, para que sejam mais f√°ceis de detectar. </font><font style="vertical-align: inherit;">Para fazer isso, basta verificar o status do √∫ltimo rein√≠cio do pod: se √© "OOMKilled". </font><font style="vertical-align: inherit;">Com a otimiza√ß√£o da CPU, tudo n√£o √© t√£o simples, pois os K8s apenas disponibilizam m√©tricas para uso, e n√£o para cgroups.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o de CPU</font></font></h4><br>
<img src="https://habrastorage.org/webt/hh/fk/qn/hhfkqnuy5oe4tq_ubi57aeblvqe.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a solicita√ß√£o de CPU √© implementada</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Para simplificar, vejamos um processo usando um exemplo de m√°quina com CPU de 4 n√∫cleos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O K8s usa o mecanismo cgroups para controlar a aloca√ß√£o de recursos (mem√≥ria e processador). Um modelo hier√°rquico est√° dispon√≠vel para ele: um descendente herda os limites do grupo pai. Os detalhes da distribui√ß√£o s√£o armazenados no sistema de arquivos virtual ( </font></font><code>/sys/fs/cgroup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). No caso do processador, isso </font></font><code>/sys/fs/cgroup/cpu,cpuacct/*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O K8s usa o arquivo </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para alocar recursos do processador. No nosso caso, o grupo de controle raiz recebe 4096 compartilhamentos de recursos da CPU - 100% da energia dispon√≠vel do processador (1 n√∫cleo = 1024; esse √© um valor fixo). O grupo raiz distribui os recursos proporcionalmente, dependendo das quotas de descendentes prescritas em</font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e aqueles, por sua vez, fazem o mesmo com seus descendentes etc. Tipicamente Kubernetes raiz do grupo de controlo tem tr√™s n√≥ filho: </font></font><code>system.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>user.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Os dois primeiros subgrupos s√£o usados ‚Äã‚Äãpara distribuir recursos entre cargas cr√≠ticas do sistema e programas de usu√°rios fora dos K8s. O √∫ltimo - - </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© criado pelo Kubernetes para distribuir recursos entre os pods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O diagrama acima mostra que o primeiro e o segundo subgrupos receberam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1024</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compartilhamentos, com </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compartilhamentos </font><font style="vertical-align: inherit;">alocados ao subgrupo kuberpod </font><font style="vertical-align: inherit;">. Como isso √© poss√≠vel: afinal, o grupo raiz tem apenas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compartilhamentos dispon√≠veis e a soma das compartilhamentos de seus descendentes excede significativamente esse n√∫mero ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6144</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)? O fato √© que o valor faz sentido l√≥gico; portanto, o Linux Scheduler (CFS) o utiliza para alocar proporcionalmente os recursos da CPU. No nosso caso, os dois primeiros grupos recebem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">680</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a√ß√µes reais (16,6% de 4096) e o kubepod recebe as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2736</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a√ß√µes </font><font style="vertical-align: inherit;">restantes </font><font style="vertical-align: inherit;">. Em caso de inatividade, os dois primeiros grupos n√£o usar√£o os recursos alocados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, o planejador possui um mecanismo para evitar a perda de recursos da CPU n√£o utilizados. Ele transfere capacidades "inativas" para o pool global, das quais s√£o distribu√≠das entre grupos que precisam de capacidades adicionais do processador (a transfer√™ncia ocorre em lotes para evitar perdas por arredondamento). Um m√©todo semelhante se aplica a todos os descendentes de descendentes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse mecanismo garante uma distribui√ß√£o justa da energia do processador e garante que nenhum processo "roube" recursos de outros.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite de CPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar de as configura√ß√µes dos limites e solicita√ß√µes nos K8s parecerem semelhantes, sua implementa√ß√£o √© fundamentalmente diferente: esta √© a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parte mais enganosa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e menos documentada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O K8s usa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o mecanismo de cotas do CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para implementar limites. Suas configura√ß√µes s√£o especificadas nos arquivos </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no diret√≥rio cgroup (o arquivo tamb√©m est√° localizado l√° </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por outro lado </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a cota √© baseada em um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">per√≠odo de tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e n√£o na energia dispon√≠vel do processador. </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define a dura√ß√£o do per√≠odo (√©poca) - √© sempre 100.000 Œºs (100 ms). K8s tem a capacidade de alterar esse valor, mas atualmente est√° dispon√≠vel apenas na vers√£o alfa. O planejador usa a era para reiniciar as cotas usadas. Segundo arquivo</font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, define o tempo dispon√≠vel (cota) em cada √©poca. Observe que tamb√©m √© indicado em microssegundos. A cota pode exceder a dura√ß√£o da √©poca; em outras palavras, pode ser superior a 100 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejamos dois cen√°rios em m√°quinas de 16 n√∫cleos (o tipo mais comum de computadores que temos no Omio): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pt/wr/dm/ptwrdmpxueuy4p1mn7mb8vfdhyg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rio 1: 2 threads e um limite de 200 ms. Sem limita√ß√£o O </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/7f/no/i9/7fnoi9e7kz6ib6jksx2mkqmc-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cen√°rio 2: 10 flui e um limite de 200 ms. A acelera√ß√£o inicia ap√≥s 20 ms, o acesso aos recursos do processador √© reiniciado ap√≥s outros 80 ms.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Suponha que voc√™ defina o limite da CPU para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√∫cleos; O Kubernetes converter√° esse valor para 200 ms. Isso significa que o cont√™iner pode usar no m√°ximo 200 ms de tempo da CPU sem limitar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui come√ßa a divers√£o. </font><font style="vertical-align: inherit;">Como mencionado acima, a cota dispon√≠vel √© de 200 ms. </font><font style="vertical-align: inherit;">Se voc√™ tiver </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> threads </font><font style="vertical-align: inherit;">em execu√ß√£o paralela </font><font style="vertical-align: inherit;">em uma m√°quina de 12 n√∫cleos (veja a ilustra√ß√£o do cen√°rio 2), enquanto todos os outros pods estiverem inativos, a cota ser√° esgotada em apenas 20 ms (desde 10 * 20 ms = 200 ms) e todos os threads deste pod √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acelerador</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelos pr√≥ximos 80 ms. </font><font style="vertical-align: inherit;">O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug do agendador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j√° mencionado agrava a situa√ß√£o </font><font style="vertical-align: inherit;">, devido √† qual a otimiza√ß√£o excessiva ocorre e o cont√™iner n√£o consegue nem calcular a cota existente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como avaliar a otimiza√ß√£o em pods?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basta ir ao pod e correr </font></font><code>cat /sys/fs/cgroup/cpu/cpu.stat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li> <code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o n√∫mero total de per√≠odos do planejador;</font></font></li>
<li> <code>nr_throttled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de per√≠odos de estrangulamento na composi√ß√£o </font></font><code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>throttled_time</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tempo de acelera√ß√£o acumulado em nanossegundos.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/fb/kp/tp/fbkptpvc9e6c1yua63aawbropk8.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que realmente est√° acontecendo?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtemos alta acelera√ß√£o em todas as aplica√ß√µes. </font><font style="vertical-align: inherit;">√Äs vezes, √© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma vez e meia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mais forte que o calculado! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso leva a v√°rios erros - falhas de prontid√£o nas verifica√ß√µes, travamentos de cont√™iner, interrup√ß√µes na conex√£o de rede, tempos limite nas chamadas de servi√ßo. </font><font style="vertical-align: inherit;">Por fim, isso se traduz em aumento da lat√™ncia e aumento de erros.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o e consequ√™ncias</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© simples aqui. </font><font style="vertical-align: inherit;">Abandonamos os limites da CPU e come√ßamos a atualizar o kernel do SO em clusters para a vers√£o mais recente na qual o bug foi corrigido. </font><font style="vertical-align: inherit;">O n√∫mero de erros (HTTP 5xx) em nossos servi√ßos caiu imediatamente de forma significativa:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros HTTP 5xx</font></font></h3><br>
<img src="https://habrastorage.org/webt/rg/t4/wt/rgt4wttq-x7-0dz8-5pfybrk_d8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros HTTP 5xx de um servi√ßo cr√≠tico</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tempo de resposta P95</font></font></h3><br>
<img src="https://habrastorage.org/webt/xc/ds/er/xcdservm7jabpev6yly59uq_u3i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atraso de solicita√ß√£o de servi√ßo cr√≠tico, percentil 95</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custos operacionais</font></font></h3><br>
<img src="https://habrastorage.org/webt/zb/ym/nc/zbymnckdg75bfpktepdi8ex4byg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫mero de horas gastas</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual √© o problema?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conforme declarado no in√≠cio do artigo:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode fazer uma analogia com um apartamento comum ... Kubernetes atua como corretor de im√≥veis. </font><font style="vertical-align: inherit;">Mas como manter os inquilinos em conflito entre si? </font><font style="vertical-align: inherit;">E se um deles, por exemplo, decide ocupar o banheiro por meio dia?</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© a pegadinha. </font><font style="vertical-align: inherit;">Um cont√™iner negligente pode absorver todos os recursos dispon√≠veis do processador na m√°quina. </font><font style="vertical-align: inherit;">Se voc√™ tiver uma pilha de aplicativos inteligente (por exemplo, JVM, Go, Node VM estiver configurada corretamente), isso n√£o ser√° um problema: voc√™ poder√° trabalhar nessas condi√ß√µes por um longo per√≠odo de tempo. </font><font style="vertical-align: inherit;">Por√©m, se os aplicativos forem pouco otimizados ou nem otimizados ( </font></font><code>FROM java:latest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), a situa√ß√£o pode ficar fora de controle. </font><font style="vertical-align: inherit;">No Omio, automatizamos Dockerfiles b√°sicos com configura√ß√µes padr√£o adequadas para a pilha de idiomas principais, portanto n√£o havia esse problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recomendamos que voc√™ monitore as m√©tricas de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (uso, satura√ß√£o e erros), atrasos da API e taxas de erro. </font><font style="vertical-align: inherit;">Verifique se os resultados est√£o conforme o esperado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© a nossa hist√≥ria. </font><font style="vertical-align: inherit;">Os seguintes materiais ajudaram muito a entender o que est√° acontecendo:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org ‚Üí Agendador CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org ‚Üí Controle de largura de banda do CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No√ß√µes b√°sicas sobre agendamento de cont√™ineres do Linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo o que voc√™ precisa saber sobre cont√™ineres Linux, Parte I: Grupos de controle do Linux e isolamento de processos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hist√≥rias de falha do Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">pesquise</font></a><font style="vertical-align: inherit;"> por "limita√ß√£o da CPU".</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Relat√≥rio de erros do Kubernetes:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 51135: Evite definir limites de CPU para pods garantidos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 67577: as cotas do CFS podem levar a restri√ß√µes desnecess√°rias</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CFS excessivamente agressivo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ encontrou problemas semelhantes em sua pr√°tica ou tem experi√™ncia com otimiza√ß√£o em ambientes de produ√ß√£o em cont√™iner? </font><font style="vertical-align: inherit;">Compartilhe sua hist√≥ria nos coment√°rios!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS do tradutor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia tamb√©m no nosso blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escalonamento autom√°tico e gerenciamento de recursos no Kubernetes (revis√£o e relat√≥rio de v√≠deo)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o Gerenciador de CPU no Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que acontece no Kubernetes quando o kubectl run √© iniciado? </font><font style="vertical-align: inherit;">Parte 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489644/index.html">Part√≠culas macias no WebGL e OpenGL ES</a></li>
<li><a href="../pt489650/index.html">Automa√ß√£o de um jornalista. Parte 1: Tarefas e calend√°rios</a></li>
<li><a href="../pt489662/index.html">PHP Digest No. 174 (10 a 24 de fevereiro de 2020)</a></li>
<li><a href="../pt489664/index.html">NPS, transportador, computa√ß√£o autom√°tica e de novo ... corotinas</a></li>
<li><a href="../pt489666/index.html">Sobrecarga em C ++. parte II Sobrecarga do operador</a></li>
<li><a href="../pt489672/index.html">Revivemos o hexapod. Parte dois</a></li>
<li><a href="../pt489674/index.html">Angular: uma introdu√ß√£o clara ao NGRX</a></li>
<li><a href="../pt489676/index.html">Fazemos um clone do servi√ßo de entrega de comida usando Nuxt.js, GraphQL, Strapi e Stripe. Parte 1/7</a></li>
<li><a href="../pt489678/index.html">Mem√≥ria indestrut√≠vel, processos indestrut√≠veis</a></li>
<li><a href="../pt489682/index.html">Bloqueio de leitura de origem cruzada (CORB) nas extens√µes do Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>