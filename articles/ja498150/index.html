<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‼️ 😤 👨🏾‍🚀 配管工のプログラマ、または1つのリークの話とそれに対処する難しさ 🐽 🤛🏽 🚑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2月25日火曜日でした。 2月22日土曜日のバージョンの難しいリリースはすでに過去のものでした。最悪の事態はすべて遅れているように見え、トラブルを予告するものは何もなかった。しかし、監視エラーがアクセス制御サービスのコーディネータープロセスでのメモリリークについて発生したときに、一度にすべてが変更さ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>配管工のプログラマ、または1つのリークの話とそれに対処する難しさ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2月25日火曜日でした。 2月22日土曜日のバージョンの難しいリリースはすでに過去のものでした。最悪の事態はすべて遅れているように見え、トラブルを予告するものは何もなかった。しかし、監視エラーがアクセス制御サービスのコーディネータープロセスでのメモリリークについて発生したときに、一度にすべてが変更されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこから？コーディネーターのコードベースの最後の主要な変更は、2か月以上前の以前のバージョンで行われ、その後、メモリに顕著な変化はありませんでした。しかし、残念ながら、監視スケジュールは厳格でした。コーディネーターの記憶は明らかにどこかでリークし始め、大きな水たまりがサービスフロアに誇示されました。これは、配管チームがやらなければならない作業が多かったことを意味します。</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、少し脱線します。</font><font style="vertical-align: inherit;">とりわけ、VLSIを使用すると、労働時間を追跡し、</font><font style="vertical-align: inherit;">顔のモデル、指紋、またはアクセスカードごとに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">監視できます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同時に、VLSIはエンドポイントコントローラー（ロック、ターンスタイル、アクセス端末など）と通信します。</font><font style="vertical-align: inherit;">別のサービスがデバイスと通信します。</font><font style="vertical-align: inherit;">これはパッシブであり、HTTP（S）を介して実装された独自のプロトコルに基づいてアクセス制御デバイスと対話します。</font><font style="vertical-align: inherit;">これは、当社のサービスの標準スタックに基づいて記述されています。PostgreSQLデータベース、Python 3はビジネスロジックに使用され、プラットフォームのC / C ++メソッドで拡張されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なWebサービスノードは、次のプロセスで構成されています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニターはルートプロセスです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コーディネーターはモニターの子プロセスです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作業プロセス。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitorは最初のWebサービスプロセスです。</font><font style="vertical-align: inherit;">そのタスクは、fork（）を呼び出し、子コーディネータープロセスを開始して、その作業を監視することです。</font><font style="vertical-align: inherit;">コーディネーターはWebサービスのメインプロセスであり、外部デバイスからの要求を受信し、応答を送信して負荷を分散します。</font><font style="vertical-align: inherit;">コーディネーターは要求を実行のためにワークプロセスに送信し、ワークプロセスを実行して、応答を共有メモリに転送し、タスクが完了したことをコーディネーターに通知し、結果を取得できるようにします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰が責任を負い、何をすべきか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、アクセス制御サービスのコーディネーターは、Webサーバーの存在によって、当社の他のサービスのコーディネーターとは異なります。他のサービスのコーディネーターはリークなしで機能したため、構成で問題を探す必要がありました。さらに悪いことに、テストスタンドでは、新しいバージョンが長期間存在し、メモリの問題に誰も気づきませんでした。彼らはより詳しく調べ始め、記憶は1つのスタンドでのみ流れ、それでもさまざまな成功を収めていることがわかりました。つまり、問題はまだ簡単には再現できません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何をすべきか？理由を見つけるには？まず、メモリダンプを取り、分析のためにプラットフォームから専門家に送信しました。結果-ダンプには何もありません。理由も、どの方向に進むべきかについてのヒントもありません。以前のバージョンからのコーディネーターのコードの変更を確認しました-突然、ひどい編集を行いましたが、すぐに理解できませんでしたか？しかし、いいえ-コーディネーターコードにいくつかのコメントが追加されましたが、いくつかのメソッドが新しいファイルに移動しました-一般に、何も犯罪者ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは私たちのサービスのコアの開発者である同僚に目を向け始めました。彼らは自信を持って私たちの不幸に巻き込まれる可能性を否定しましたが、サービスにtracemallocモニタリングを埋め込むことを提案しました。次の修正プログラムでは、サービスを完成させ、すぐにテストし、リリースします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちは何を見ますか？私たちの記憶はすぐに流れるだけでなく、非常に速く流れます-成長は指数関数的になりました。最初のピークは悪の勢力とそれに伴う要因によるものですが、最初のピークから数時間後の2番目のピークは、このようなサービスの緊急動作で次の修正プログラムがリリースされるのを待つのに時間がかかりすぎることを明らかにしています。したがって、私たちはtracemallocの結果を取得し、サービスにパッチを適用します。少なくとも線形の増加に戻るために、編集を監視しながらロールバックします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tracemallocの結果がPythonで割り当てられたメモリで機能しているように見えましたが、今度はそれらを調べてリークの原因を見つけますが、そこにはありませんでした。収集されたデータには、監視グラフで見られた5.5 GBのピークがありません。最大使用メモリはわずか250MBであり、traceMallocでも130MBを消費します。これは部分的に説明可能です。tracemallocを使用すると、Pythonでメモリダイナミクスを確認できますが、プラットフォームで実装されているCおよびC ++パッケージでのメモリ割り当てについてはわかりません。得られたデータでは、興味深いものを見つけることができませんでした。メモリは、ストリーム、文字列、辞書などの通常のオブジェクトに受け入れ可能なボリュームで割り当てられています。通常、疑わしいものはありません。次に、データから不要なものをすべて削除し、合計メモリ消費量と時間のみを残して視覚化することにしました。視覚化は「何が起こっているのか」と「なぜ」の質問に答える助けにはなりませんでしたが、その助けを借りて、監視からのデータとの相関を見ました-つまり、どこかに間違いなく問題があり、それを探す必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その時点で、配管工チームはどこに漏れがないかを探すためのアイデアを使い果たしました。幸いにも、鳥はプラットフォームからの1つの大きな変更が発生したことを私たちに歌いました-Pythonのバージョンが3.4から3.7に変更されました。これは巨大な検索フィールドです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはインターネット上のPython 3.7でメモリリークに関連する問題を探すことにしました。それでも、Python 3.7はかなり前に公開されたため、現在の更新でのみそれに切り替えました。幸いなことに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その答え</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちの質問にはすぐに見つかった、ともあった</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プルリクエスト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題を解決するには、彼女自身がPythonの開発者によって行われた変更していました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうした？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン3.7以降、ThreadingMixInクラスの動作が変更され、Webサーバーから継承して、各リクエストを個別のスレッドで処理します。 ThreadingMixInクラスで、作成されたすべてのスレッドのエントリを配列に追加しました。このような変更により、デバイス接続を処理するクラスインスタンスは完了後に解放されず、Pythonのガベージコレクターは使用済みスレッドからメモリをクリアできません。これが、サーバーへのリクエスト数に正比例して割り当てられたメモリの線形増加につながったものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここに、大きな穴のあるPythonモジュールの陰湿なコードがあります（Python 3.5のコードは、変更前の左側、右側-3.7以降に表示されています）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理由を見つけて、リークを簡単に排除しました。継承クラスでは、古い動作を返すフラグの値を変更しました。それがすべて勝利です。</font><font style="vertical-align: inherit;">クラス変数に書き込むことなく、以前と同様にストリームが作成されますが、モニタリンググラフで快適な画像が観察されます-リークが修正されました！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
勝利後にこれについて書くのはいいことです。</font><font style="vertical-align: inherit;">Python 3.7に切り替えた後、この問題に最初に遭遇したのはおそらく私たちではありませんが、おそらく最後ではありません。</font><font style="vertical-align: inherit;">私たち自身のために、私たちは以下が必要であると結論付けました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特に他の適用された決定が私たちに依存している場合は、大きな変更の起こり得る結果を評価するために、より深刻なアプローチをとってください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pythonのバージョンの変更など、プラットフォームにグローバルな変更が発生した場合は、コードに問題がないかどうかを確認してください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">戦闘サービスだけでなくテストサービスの監視スケジュールの不審な変更に対応します。</font><font style="vertical-align: inherit;">現在のガベージコレクタにもかかわらず、Pythonにもメモリリークがあります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tracemallocなどのメモリ分析ツールは、使い方を誤ると事態が悪化する可能性があるため、注意が必要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリリークの検出には、忍耐力、忍耐力、および小さな探偵の作業が必要になるという事実に備える必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、私は緊急の配管工事に対処し、再び私たちのサービスに以前の作業能力に戻るのを助けてくれたすべての人に感謝の意を表したいと思います！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja498136/index.html">フロントエンドの未来と現在についてのポリーナグルトバとの会話。DUMP 2020主催者はいくつかの重要な質問をします。</a></li>
<li><a href="../ja498138/index.html">学部研究後の生活：高等教育と仕事がすでに存在する場合に次に何をすべきかをどのように決定したか</a></li>
<li><a href="../ja498140/index.html">これを複製します。ウェビナーApache IgniteおよびGridGain</a></li>
<li><a href="../ja498144/index.html">はじめてのBERT：イラスト付きガイド</a></li>
<li><a href="../ja498146/index.html">注意すべき6つのスマートセキュリティトレンド</a></li>
<li><a href="../ja498152/index.html">ポストグレソ21</a></li>
<li><a href="../ja498154/index.html">4月20日から26日までオンラインで無料のITイベントのカレンダー</a></li>
<li><a href="../ja498156/index.html">F＃、バイナリイメージの形態</a></li>
<li><a href="../ja498158/index.html">リモートマラソンウィーク1：職場</a></li>
<li><a href="../ja498160/index.html">Kubernetesの外部ストレージとしてのGlusterFS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>