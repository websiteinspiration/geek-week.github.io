<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîØ üçº üë®üèæ‚Äçüç≥ Nous √©crivons le firmware pour TI cc2530 sur Z-Stack 3.0 pour relais Zigbee Sonoff BASICZBR3 avec capteur ds18b20 ‚ö∞Ô∏è üéß üë®üèª‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On suppose que le lecteur a d√©j√† une connaissance initiale du langage C, conna√Æt quelque chose sur Zigbee, la puce cc2530, les m√©thodes pour le flashe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous √©crivons le firmware pour TI cc2530 sur Z-Stack 3.0 pour relais Zigbee Sonoff BASICZBR3 avec capteur ds18b20</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/495926/"><img src="https://habrastorage.org/webt/pk/k8/1r/pkk81rmgifam0ccamhmapnesahq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On suppose que le lecteur a d√©j√† une connaissance initiale du langage C, conna√Æt quelque chose sur Zigbee, la puce cc2530, les m√©thodes pour le flasher et l'utiliser, et est √©galement familier avec des projets comme zigbee2mqtt. </font><font style="vertical-align: inherit;">Sinon, pr√©parez-vous ou allez lire sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://myzigbee.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.zigbee2mqtt.io/ L'</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
article est √©crit d'abord en d√©tail, mais il est progressivement acc√©l√©r√© et ne s'arr√™te pas aux d√©tails, mais d√©crit le code du firmware fini. </font><font style="vertical-align: inherit;">Si quelqu'un n'est pas int√©ress√© par le raisonnement, ouvrez simplement les sources du firmware et lisez-les. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code source du firmware fini</font></font></a><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'approche code et d√©veloppement ne pr√©tend pas √™tre id√©ale. </font><font style="vertical-align: inherit;">"Je ne suis pas un magicien, j'apprends juste."</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objectif</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal est de comprendre comment √©crire un firmware pour Z-Stack pendant longtemps. </font><font style="vertical-align: inherit;">Par cons√©quent, j'ai d√©cid√© d'impl√©menter un firmware alternatif pour l'√©quipement fini (le relais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sonoff BASICZBR3 a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©t√© choisi comme exemple </font><font style="vertical-align: inherit;">) et d'ajouter la possibilit√© de connecter le populaire capteur de temp√©rature ds18b20. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, je voulais montrer aux d√©veloppeurs d√©butants Zigbee un exemple de d√©veloppement de firmware pour la puce TI cc2530 sur Z-Stack.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Pr√©paration</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer le d√©veloppement, vous devez t√©l√©charger et installer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Stack 3.0.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il s'agit d'un SDK pour d√©velopper un firmware avec des exemples et de la documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez √©galement t√©l√©charger et installer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IAR Embeded Workbench pour 8051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il s'agit d'un environnement de d√©veloppement avec la possibilit√© de compiler pour les puces TI cc2530. </font><font style="vertical-align: inherit;">La p√©riode d'utilisation gratuite est de 1 mois (mais le chercheur trouvera une solution). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le d√©veloppement et le d√©bogage, j'utilise CCDebugger - il permet non seulement de flasher les puces cc2531 / cc2530, mais aussi de d√©boguer l'application dans l'environnement IAR. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/aj/pr/_jajpr3cvn5q93lo6_igpenpdly.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour simplifier les exp√©riences, le prototypage et le d√©bogage que je fais sur le devboard et le module cc2530 correspondant:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/xc/cq/qlxccqkdbxnqt3pcuo8049lj0ci.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Cr√©ation d'une nouvelle application</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous cr√©ons un nouveau projet bas√© sur GenericApp. </font><font style="vertical-align: inherit;">Ceci est un exemple d'une application Z-Stack de base. </font><font style="vertical-align: inherit;">Il se trouve dans le dossier Z-Stack 3.0.2 \ Projects \ zstack \ HomeAutomation \ GenericApp. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous le copions √† proximit√© et le renommons, par exemple, en DIYRuZRT (appelons l'application pour notre appareil). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dossier CC2530DB contient des fichiers:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewd - param√®tres de projet pour C-SPY</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewp - fichier de projet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.eww - Espace de travail</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Renommez les fichiers en DIYRuZRT.eww et DIYRuZRT.ewp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'int√©rieur de tous les fichiers (y compris le dossier Source), nous changeons √©galement toutes les r√©f√©rences √† GenericApp en DIYRuZRT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrez maintenant le projet DIYRuZRT.ewp dans IAR. Nous s√©lectionnons la configuration de RouterEB et effectuons Tout reconstruire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/re/mb/fbremb-ma8rcyafhwdcj6klys9k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dossier RouterEB sera cr√©√© dans le dossier CC2530DB et le fichier DIYRuZRT.d51 appara√Ætra dans le dossier EXE - ce fichier est pratique pour flasher et d√©boguer depuis IAR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous devons flasher le firmware via SmartRF Flash Programmer, nous ferons de petits changements. Pour ce faire, dans les param√®tres du projet dans la section Lien sous l'onglet Sortie, modifiez les param√®tres du fichier de sortie et du format: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/cb/xl/r5cbxlrunrutiwxxgt-gytlwjz4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, le fichier du firmware DIYRuZRT.hex sera cr√©√© dans le dossier EXE, pratique </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour flasher √† partir d'autres outils et d'autres mani√®res</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais apr√®s avoir t√©l√©charg√© ce firmware, l'appareil ne se connecte pas au r√©seau. </font><font style="vertical-align: inherit;">Eh bien, nous comprendrons.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Un peu de terminologie</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La terminologie Zigbee comprend les concepts suivants:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Endpoint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Le point de description du p√©riph√©rique final. </font><font style="vertical-align: inherit;">Habituellement, dans les appareils simples, un point final. </font><font style="vertical-align: inherit;">Il peut y en avoir plusieurs dans des appareils multifonctions, ainsi que dans des appareils avec diff√©rents profils d'interaction (un profil - un point final).</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster (cluster)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un ensemble d'attributs et de commandes li√©s √† une seule fonction (marche / arr√™t, gradation, mesures de temp√©rature, etc.). </font><font style="vertical-align: inherit;">Le cluster indique les opportunit√©s r√©alis√©es par le point de terminaison. </font><font style="vertical-align: inherit;">Dans un point de terminaison, vous pouvez impl√©menter plusieurs clusters diff√©rents, mais pas les m√™mes.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribut (attribut)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une caract√©ristique d'un cluster dont la valeur peut √™tre lue ou √©crite. </font><font style="vertical-align: inherit;">Un cluster peut avoir de nombreux attributs.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commande</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Un message de contr√¥le que le cluster peut traiter. </font><font style="vertical-align: inherit;">Une √©quipe peut avoir des param√®tres. </font><font style="vertical-align: inherit;">Ceci est impl√©ment√© par une fonction qui est ex√©cut√©e lorsqu'une commande et des param√®tres sont re√ßus.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les types de clusters, d'attributs et de commandes sont standardis√©s dans la biblioth√®que de clusters Zigbee. </font><font style="vertical-align: inherit;">Mais les fabricants peuvent utiliser leurs propres clusters, avec leurs propres attributs et √©quipes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains producteurs pitoyables ne se soucient pas des normes et font quelque chose pour les normes. </font><font style="vertical-align: inherit;">Ensuite, vous devez vous y adapter. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">La</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
terminologie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Stack a √©galement ses propres concepts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , par exemple:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL (Operating System Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le niveau d'abstraction du syst√®me d'exploitation. </font><font style="vertical-align: inherit;">Ici, ils fonctionnent avec des t√¢ches (t√¢ches), des messages (messages), des √©v√©nements (√©v√©nements), des temporisateurs (temporisateurs) et d'autres objets.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL (Hardware Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - niveau d'abstraction de l'√©quipement. </font><font style="vertical-align: inherit;">Ici, ils fonctionnent avec des boutons (touches), des LED (leds), des interruptions (Interruption), etc.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La couche mat√©rielle assure l'isolement du code du programme et de l'√©quipement qu'il contr√¥le. </font><font style="vertical-align: inherit;">Le niveau op√©rationnel fournit des m√©canismes pour cr√©er et interagir entre les √©l√©ments d'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisation de tout cela vous attend ci-dessous et, en principe, lors du d√©veloppement du firmware.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Qu'avons-nous √† l'int√©rieur de l'application de base?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code d'application se trouve dans le dossier Source:</font></font><br>
<br>
<ul>
<li><i>OSAL_DIYRuZRT.c</i> ‚Äî    <br>
</li>
<li><i>zcl_DIYRuZRT.h</i> ‚Äî  <br>
</li>
<li><i>zcl_DIYRuZRT.c</i> ‚Äî   <br>
</li>
<li><i>zcl_DIYRuZRT_data.c</i> ‚Äî  ,   <br>
</li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le fichier principal dans lequel le tableau des gestionnaires de t√¢ches (t√¢che)&nbsp; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn tasksArr est rempli</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et la fonction d'initialisation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><b><font style="vertical-align: inherit;">impl√©ment√©e</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les autres fichiers sont n√©cessaires pour impl√©menter ces initialiseurs et gestionnaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste des gestionnaires de t√¢ches </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn tasksAr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r est remplie de r√©f√©rences de fonction. Certaines t√¢ches sont connect√©es / d√©connect√©es par les directives de compilation correspondantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez afficher et configurer les directives de compilation dans les options du compilateur de symboles d√©finis:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/tl/u6/pntlu6bioazjsoaywmdfofeloas.png"><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> pTaskEventHandlerFn tasksArr[] = {<font></font>
  macEventLoop,<font></font>
  nwk_event_loop,<font></font>
#<span class="hljs-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)<font></font>
  gp_event_loop,<font></font>
#endif  <font></font>
  Hal_ProcessEvent,<font></font>
#<span class="hljs-keyword">if</span> defined( MT_TASK )<font></font>
  MT_ProcessEvent,<font></font>
#endif<font></font>
  APS_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )<font></font>
  APSF_ProcessEvent,<font></font>
#endif<font></font>
  ZDApp_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )<font></font>
  ZDNwkMgr_event_loop,<font></font>
#endif<font></font>
  <span class="hljs-comment">//Added to include TouchLink functionality</span>
  #<span class="hljs-keyword">if</span> defined ( INTER_PAN )<font></font>
    StubAPS_ProcessEvent,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_INITIATOR )<font></font>
    touchLinkInitiator_event_loop,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink target functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_TARGET )<font></font>
    touchLinkTarget_event_loop,<font></font>
  #endif<font></font>
  zcl_event_loop,<font></font>
  bdb_event_loop,<font></font>
  zclDIYRuZRT_event_loop<font></font>
};<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la fonction de d√©marrage de l'application qui enregistre les t√¢ches </font><b><font style="vertical-align: inherit;">effectu√©es par l'</font></b><font style="vertical-align: inherit;"> application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'enregistrement des t√¢ches est effectu√© dans l'ordre et chaque t√¢che obtient son propre num√©ro. Il est important de suivre le m√™me ordre que dans le tableau </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tasksArr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , comme les gestionnaires sont appel√©s en fonction du num√©ro de t√¢che.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">osalInitTasks</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{<font></font>
  uint8 taskID = <span class="hljs-number">0</span>;<font></font>
<font></font>
  tasksEvents = (uint16 *)osal_mem_alloc( <span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt);<font></font>
  osal_memset( tasksEvents, <span class="hljs-number">0</span>, (<span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt));<font></font>
<font></font>
  macTaskInit( taskID++ );<font></font>
  nwk_init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)</span><font></font>
  gp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  Hal_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( MT_TASK )</span><font></font>
  MT_TaskInit( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  APS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )</span><font></font>
  APSF_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  ZDApp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )</span><font></font>
  ZDNwkMgr_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-comment">// Added to include TouchLink functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( INTER_PAN )</span><font></font>
  StubAPS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( BDB_TL_INITIATOR )</span><font></font>
  touchLinkInitiator_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink target functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( BDB_TL_TARGET )</span><font></font>
  touchLinkTarget_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  zcl_Init( taskID++ );<font></font>
  bdb_Init( taskID++ );<font></font>
  zclDIYRuZRT_Init( taskID );<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre application a enregistr√© le gestionnaire de fonctions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et la fonction d'initialisation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ils sont ajout√©s en dernier dans la liste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont les deux fonctions principales de notre application. L'impl√©mentation de ces fonctions se trouve dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fonction d'enregistrement de t√¢che. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le num√©ro de point final impl√©ment√© par notre application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les √©tapes d'enregistrement qui d√©crivent notre application sont ex√©cut√©es s√©quentiellement:</font></font><br>
<br>
<ul>
<li><b>bdb_RegisterSimpleDescriptor </b> ‚Äî    .    <b>SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc</b> ‚Äî    ,  , ,    .       <i>OSAL_DIYRuZRT_data.c</i><br>
</li>
<li><b>zclGeneral_RegisterCmdCallbacks </b> ‚Äî      <b>zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks</b> ‚Äî  ,       .<br>
</li>
<li><b>zcl_registerAttrList </b> ‚Äî    <b>zclAttrRec_t zclDIYRuZRT_Attrs</b> ‚Äî  ,     .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_registerForMsg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enregistre la r√©ception des messages de contr√¥le.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegisterForKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous signons notre t√¢che pour recevoir les √©v√©nements de clic de bouton.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 * SIMPLE DESCRIPTOR
 */</span>
<span class="hljs-comment">// This is the Cluster ID List and should be filled with Application</span>
<span class="hljs-comment">// specific cluster IDs.</span>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_InClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  ZCL_CLUSTER_ID_GEN_IDENTIFY,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Input Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
  <font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_INCLUSTERS   (sizeof(zclDIYRuZRT_InClusterList) / sizeof(zclDIYRuZRT_InClusterList[0]))</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_OutClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Output Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_OUTCLUSTERS  (sizeof(zclDIYRuZRT_OutClusterList) / sizeof(zclDIYRuZRT_OutClusterList[0]))</span><font></font>
<font></font>
<font></font>
SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc =<font></font>
{<font></font>
  DIYRuZRT_ENDPOINT,                  <span class="hljs-comment">//  int Endpoint;</span>
  ZCL_HA_PROFILE_ID,                     <span class="hljs-comment">//  uint16 AppProfId;</span>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Replace ZCL_HA_DEVICEID_ON_OFF_LIGHT with application specific device ID</span>
  ZCL_HA_DEVICEID_ON_OFF_LIGHT,          <span class="hljs-comment">//  uint16 AppDeviceId; </span>
  DIYRuZRT_DEVICE_VERSION,            <span class="hljs-comment">//  int   AppDevVer:4;</span>
  DIYRuZRT_FLAGS,                     <span class="hljs-comment">//  int   AppFlags:4;</span>
  ZCLDIYRuZRT_MAX_INCLUSTERS,         <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_InClusterList, <span class="hljs-comment">//  byte *pAppInClusterList;</span>
  ZCLDIYRuZRT_MAX_OUTCLUSTERS,        <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_OutClusterList <span class="hljs-comment">//  byte *pAppInClusterList;</span><font></font>
};<font></font>
</code></pre><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fonction des gestionnaires d'√©v√©nements de notre application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, les √©v√©nements syst√®me sont trait√©s en boucle:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZCL_INCOMING_MSG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les commandes de contr√¥le de p√©riph√©rique sont trait√©es dans zclDIYRuZRT_ProcessIncomingMsg.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KEY_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Les √©v√©nements de clic de bouton sont trait√©s dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_HandleKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZDO_STATE_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √©v√©nements de changement d'√©tat du r√©seau.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; SYS_EVENT_MSG )<font></font>
  {<font></font>
    <span class="hljs-keyword">while</span> ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( zclDIYRuZRT_TaskID )) )<font></font>
    {<font></font>
      <span class="hljs-keyword">switch</span> ( MSGpkt-&gt;hdr.event )<font></font>
      {<font></font>
        <span class="hljs-keyword">case</span> ZCL_INCOMING_MSG:
          <span class="hljs-comment">// Incoming ZCL Foundation command/response messages</span><font></font>
          zclDIYRuZRT_ProcessIncomingMsg( (zclIncomingMsg_t *)MSGpkt );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> KEY_CHANGE:<font></font>
          zclDIYRuZRT_HandleKeys( ((keyChange_t *)MSGpkt)-&gt;state, ((keyChange_t *)MSGpkt)-&gt;keys );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> ZDO_STATE_CHANGE:<font></font>
          zclDIYRuZRT_NwkState = (devStates_t)(MSGpkt-&gt;hdr.status);<font></font>
<font></font>
          <span class="hljs-comment">// now on the network</span>
          <span class="hljs-keyword">if</span> ( (zclDIYRuZRT_NwkState == DEV_ZB_COORD) ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_ROUTER)   ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_END_DEVICE) )<font></font>
          {<font></font>
            giGenAppScreenMode = GENERIC_MAINMODE;<font></font>
            zclDIYRuZRT_LcdDisplayUpdate();<font></font>
          }<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
<font></font>
      <span class="hljs-comment">// Release the memory</span><font></font>
      osal_msg_deallocate( (uint8 *)MSGpkt );<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vient ensuite le traitement de l'√©v√©nement sp√©cial </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui commute l'√©tat de la LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et d√©marre la minuterie sur 500m avec le m√™me √©v√©nement. </font><font style="vertical-align: inherit;">Cela d√©marre le clignotement de la LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">// toggle LED 2 state, start another timer for 500ms</span><font></font>
    HalLedSet ( HAL_LED_2, HAL_LED_MODE_TOGGLE );<font></font>
    osal_start_timerEx( zclDIYRuZRT_TaskID, DIYRuZRT_EVT_1, <span class="hljs-number">500</span> );<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_1 );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est qu'au d√©marrage du firmware, l'√©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_SW_1 se produit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et c'est en lui que le timer et l'√©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont </font><b><font style="vertical-align: inherit;">initialis√©s</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et si vous appuyez sur le bouton S2, le clignotement s'arr√™tera (ma LED reste allum√©e). </font><font style="vertical-align: inherit;">Une nouvelle pression commencera √† clignoter.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. HAL: LED et boutons</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Attendez, quelles LED et quels boutons?", Demandez-vous. </font><font style="vertical-align: inherit;">Initialement, tous les exemples de Z-stack se concentrent sur diff√©rents types de cartes de d√©bogage de la s√©rie SmartRF05 EB: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/bl/ru/tzblrurrrpoze3kghx_dd1zrume.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
j'ai une carte de d√©bogage l√©g√®rement diff√©rente et un module avec une puce. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a 2 boutons (+ reset) et 3 LEDs (+ indicateur d'alimentation) sur la carte. </font><font style="vertical-align: inherit;">Voici l'un d'eux (D2) clignotant lorsque le firmware fonctionne correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir appel√© les contacts, nous d√©terminons la correspondance des broches, diodes et boutons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1 - P10</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D2 - P11</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D3 - P14</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S2 - P20</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1 - P01</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, HAL est une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">couche d'abstraction mat√©rielle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un moyen d'abstraire de la mise en ≈ìuvre de l'√©quipement. Le code d'application utilise des macros et des fonctions qui fonctionnent avec des abstractions telles que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Button 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et la correspondance sp√©cifique des abstractions et de l'√©quipement est d√©finie s√©par√©ment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons de quel </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type de HAL_LED_2 il s'agit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et comment comprendre sur quelle broche il est suspendu. </font><i><font style="vertical-align: inherit;">En</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
recherchant, nous trouvons le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_led.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π ces constantes et la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedSet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont </font><b><font style="vertical-align: inherit;">d√©crites</font></b><font style="vertical-align: inherit;"> , o√π le num√©ro et le mode LED sont transmis. √Ä l'int√©rieur, la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><b><font style="vertical-align: inherit;">appel√©e</font></b><font style="vertical-align: inherit;"> pour allumer et √©teindre la LED, qui √† son tour ex√©cute </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont les macros d√©crites dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les macros changent en fonction de la configuration mat√©rielle. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon cas:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_OFF_LED2() &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (0); )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_ON_LED2()&nbsp; &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (1); )</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu plus haut dans le fichier se trouvent les correspondances de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_SBIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_POLARITY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">&nbsp;&nbsp;<span class="hljs-comment">/* 2 - Red */</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT &nbsp; &nbsp; &nbsp; &nbsp; P1_1</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; P1DIR</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que la LED 2 est situ√©e sur la broche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et que son niveau de commutation est √©lev√©. </font><font style="vertical-align: inherit;">Mais, √† en juger par le code, la LED devrait s'√©teindre lorsque le bouton est enfonc√©, mais avec nous, il reste allum√©. </font><font style="vertical-align: inherit;">Si dans ce fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h on</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> change:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sur le</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_LOW</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puis maintenant, la LED s'√©teint lorsque vous appuyez sur le bouton S2, comme cela devrait √™tre logique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de ne pas modifier les fichiers communs qui ne sont pas li√©s √† notre application, il vaut mieux faire autrement:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©ez une copie du fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (√† partir du </font><font style="vertical-align: inherit;">dossier </font><font style="vertical-align: inherit;">Z-Stack 3.0.2 \ Components \ hal \ target \ CC2530EB \) dans notre dossier Source et nommez-le, par exemple, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">faisons de notre copie du fichier la toute premi√®re (excluant ainsi la connexion du fichier partag√©). </font><font style="vertical-align: inherit;">Cr√©ez un fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans notre dossier Source </font><font style="vertical-align: inherit;">et √©crivez-y la ligne:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"hal_board_cfg_DIYRuZRT.h"</span></span></code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indiquer que la connexion de ce fichier est la toute premi√®re - dans les param√®tres du projet:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">$PROJ_DIR$\..\Source\preinclude.h</code></pre><br>
<img src="https://habrastorage.org/webt/jl/_f/j_/jl_fj_oy71xhwehgszprw9jhdiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons maintenant modifier les param√®tres d'√©quipement dans notre fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sans avoir √† modifier les fichiers partag√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai transf√©r√© les directives du compilateur dans le m√™me fichier preinclude.h et les ai supprim√©es dans les options du compilateur:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SECURE 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TC_LINKKEY_JOIN</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_INIT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_RESTORE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xZTOOL_P1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_TASK</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_SYS_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_MGMT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_CNF_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEGACY_LCD_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MULTICAST_ENABLED FALSE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_READ</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_WRITE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_BASIC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_IDENTIFY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_SCENES</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_GROUPS</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on retrouve la description du bouton S1 et du Joystick Center Press:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* S1 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P0_1</span><font></font>
<font></font>
<span class="hljs-comment">/* Joystick Center Press */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P2_0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_POLARITY&nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela correspond aux broches des boutons de la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons l'initialisation mat√©rielle - la macro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_INIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le m√™me fichier. </font><font style="vertical-align: inherit;">Par d√©faut, la directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_CC2530EB_REV17</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><b><font style="vertical-align: inherit;">activ√©e</font></b><font style="vertical-align: inherit;"> , nous examinons donc la variante de macro correspondante.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* ----------- Board Initialization ---------- */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined (HAL_BOARD_CC2530EB_REV17) &amp;&amp; !defined (HAL_PA_LNA) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2590) &amp;&amp; !defined (HAL_PA_LNA_SE2431L) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2592)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_BOARD_INIT()                                         \
{                                                                \
  uint16 i;                                                      \
                                                                 \
  SLEEPCMD &amp;= ~OSC_PD;                       <span class="hljs-comment">/* turn on 16MHz RC and 32MHz XOSC */</span>                \
  while (!(SLEEPSTA &amp; XOSC_STB));            <span class="hljs-comment">/* wait for 32MHz XOSC stable */</span>                     \
  asm(<span class="hljs-meta-string">"NOP"</span>);                                <span class="hljs-comment">/* chip bug workaround */</span>                            \
  for (i=0; i&lt;504; i++) asm(<span class="hljs-meta-string">"NOP"</span>);          <span class="hljs-comment">/* Require 63us delay for all revs */</span>                \
  CLKCONCMD = (CLKCONCMD_32MHZ | OSC_32KHZ); <span class="hljs-comment">/* Select 32MHz XOSC and the source for 32K clock */</span> \
  while (CLKCONSTA != (CLKCONCMD_32MHZ | OSC_32KHZ)); <span class="hljs-comment">/* Wait for the change to be effective */</span>   \
  SLEEPCMD |= OSC_PD;                        <span class="hljs-comment">/* turn off 16MHz RC */</span>                              \
                                                                 \
  <span class="hljs-comment">/* Turn on cache prefetch mode */</span>                              \
  PREFETCH_ENABLE();                                             \
                                                                 \
  HAL_TURN_OFF_LED1();                                           \
  LED1_DDR |= LED1_BV;                                           \
  HAL_TURN_OFF_LED2();                                           \
  LED2_DDR |= LED2_BV;                                           \
  HAL_TURN_OFF_LED3();                                           \
  LED3_DDR |= LED3_BV;                                           \
  HAL_TURN_OFF_LED4();                                           \
  LED4_SET_DIR();                                                \
                                                                 \
  <span class="hljs-comment">/* configure tristates */</span>                                      \
  P0INP |= PUSH2_BV;                                             \
}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est dans cette macro que les modes et registres du processeur sont initialis√©s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_DDR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et d'autres seront remplac√©s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1DIR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enregistrez ce port </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , chargez les broches du mode de fonctionnement (entr√©e ou sortie). Par cons√©quent, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_BV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est r√©gl√© sur 1 par bit de la broche correspondante (dans notre cas, 1 bit, ce qui correspond √† la broche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): les </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/ed/0y/qred0ypxdrfxxkaleymbpqmjgto.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
registres et les modes du processeur sont d√©crits dans la documentation du </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Guide de l'utilisateur du cc253x¬ª.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais il n'est nulle part visible comment les boutons sont configur√©s. Les boutons sont trait√©s de la m√™me mani√®re, mais dans un autre fichier - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il d√©finit les param√®tres des boutons et fonctions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyConfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyRead</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyPoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ces fonctions sont charg√©es d'initialiser le sous-syst√®me de travail avec les boutons et de lecture des valeurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par d√©faut, le traitement des boutons est effectu√© sur une minuterie toutes les 100 ms. </font><font style="vertical-align: inherit;">La broche P2_0 pour la configuration actuelle est affect√©e au joystick et son √©tat actuel est lu comme un clic - par cons√©quent, la minuterie de clignotement LED d√©marre.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Nous configurons nous-m√™mes l'appareil</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Changement dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT sur 1</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT_data.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_DEVICE_VERSION √† 1</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ManufacturerName sur {6, 'D', 'I', 'Y', 'R', 'u', 'Z'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ModelId sur {9, 'D', 'I', 'Y', 'R', 'u', 'Z', '_', 'R', 'T'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_DateCode sur {8, '2', '0', '2', '0', '0', '4', '0', '5'}</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que le p√©riph√©rique puisse se connecter au r√©seau sur n'importe quel canal (seulement 11 par d√©faut, sp√©cifi√© dans la directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_CHANLIST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier Tools \ f8wConfig.cfg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), vous devez sp√©cifier cette fonctionnalit√© dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h en</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modifiant la valeur de la directive. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ajoutons √©galement la directive de compilation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISABLE_GREENPOWER_BASIC_PROXY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin que le point de terminaison GREENPOWER ne soit pas cr√©√© pour notre appareil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©sactivez √©galement la prise en charge inutile de l'√©cran LCD.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DISABLE_GREENPOWER_BASIC_PROXY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEFAULT_CHANLIST 0x07FFF800&nbsp; <span class="hljs-comment">// ALL Channels</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin que notre appareil essaie automatiquement de se connecter au r√©seau, nous ajouterons la connexion au r√©seau dans le code de fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">bdb_StartCommissioning(BDB_COMMISSIONING_MODE_NWK_STEERING |<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BDB_COMMISSIONING_MODE_FINDING_BINDING);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, ex√©cutez Build, remplissez le firmware dans la puce et commencez le couplage sur le coordinateur. </font><font style="vertical-align: inherit;">Je v√©rifie le fonctionnement du r√©seau Zigbee dans ioBroker.zigbee, voici √† quoi ressemble le nouvel appareil connect√©: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/ik/ss/umikss4n4f19icobraxj-rb_tj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
super, il s'est av√©r√© qu'il </font><font style="vertical-align: inherit;">fallait </font><font style="vertical-align: inherit;">connecter l'appareil!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Nous compliquons le fonctionnement de l'appareil</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons maintenant d'adapter un peu la fonctionnalit√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le processus de connexion de l'appareil au r√©seau se fait par un appui long sur le bouton.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si l'appareil √©tait d√©j√† sur le r√©seau, un appui long l'affiche depuis le r√©seau.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appui court - change l'√©tat de la LED.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat de la LED doit √™tre conserv√© lorsque l'appareil d√©marre apr√®s une panne de courant.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour configurer mon propre traitement de bouton, j'ai cr√©√© la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> similaire √† celle du module </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais exclusivement pour mon ensemble de boutons.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    ()</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyInit</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">/*      0 */</span>
  halKeySavedKeys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  PUSH1_SEL &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    - GPIO */</span>
  PUSH1_DIR &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    -  */</span><font></font>
  <font></font>
  PUSH1_ICTL &amp;= ~(PUSH1_ICTLBIT); <span class="hljs-comment">/*      */</span>
  PUSH1_IEN &amp;= ~(PUSH1_IENBIT);   <span class="hljs-comment">/*     */</span><font></font>
  <font></font>
  PUSH2_SEL &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin function to GPIO */</span>
  PUSH2_DIR &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin direction to Input */</span><font></font>
  <font></font>
  PUSH2_ICTL &amp;= ~(PUSH2_ICTLBIT); <span class="hljs-comment">/* don't generate interrupt */</span>
  PUSH2_IEN &amp;= ~(PUSH2_IENBIT);   <span class="hljs-comment">/* Clear interrupt enable bit */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel de cette fonction a √©t√© ajout√© au </font><font style="vertical-align: inherit;">fichier de </font><font style="vertical-align: inherit;">macro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_INIT </font></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour √©viter les conflits, d√©sactivez le hal_key int√©gr√© dans le m√™me fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_KEY FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parce que </font><font style="vertical-align: inherit;">le lecteur de bouton standard est d√©sactiv√©, nous le ferons nous-m√™mes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction d'initialisation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><b><font style="vertical-align: inherit;">nous</font></b><font style="vertical-align: inherit;"> d√©marrons le temporisateur pour lire les √©tats des boutons. </font><font style="vertical-align: inherit;">La minuterie g√©n√©rera notre √©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">osal_start_reload_timer( zclDIYRuZRT_TaskID, HAL_KEY_EVENT, <span class="hljs-number">100</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans la boucle d'√©v√©nement, nous traiterons l'√©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT en</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelant la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_HalKeyPoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyPoll</span> <span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  uint8 keys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   1 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON1())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_1;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">//   2 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON2())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_2;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (keys == halKeySavedKeys)<font></font>
  {<font></font>
    <span class="hljs-comment">//  -  </span>
    <span class="hljs-keyword">return</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//        . </span><font></font>
  halKeySavedKeys = keys;<font></font>
<font></font>
  <span class="hljs-comment">//     </span><font></font>
  OnBoard_SendKeys(keys, HAL_KEY_STATE_NORMAL);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'enregistrement de l'√©tat des boutons dans la variable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">halKeySavedKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous permet de d√©terminer le moment du changement - en appuyant et en rel√¢chant les boutons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous cliquez sur le bouton, d√©marrez la minuterie pendant 5 secondes. </font><font style="vertical-align: inherit;">Si ce minuteur se d√©clenche, l'√©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_LONG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sera g√©n√©r√© </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si le bouton est rel√¢ch√©, la minuterie est r√©initialis√©e. </font><font style="vertical-align: inherit;">Dans tous les cas, si vous appuyez sur le bouton, nous changeons l'√©tat de la LED.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_HandleKeys</span><span class="hljs-params">( byte shift, byte keys )</span>
</span>{
  <span class="hljs-keyword">if</span> ( keys &amp; HAL_KEY_SW_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">//       - 5 </span>
    osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG, <span class="hljs-number">5000</span>);
    <span class="hljs-comment">//  </span>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    <span class="hljs-comment">//     </span><font></font>
    osal_stop_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, lors du traitement d'un √©v√©nement de pression longue, nous pr√™tons attention √† l'√©tat actuel du r√©seau via l'attribut de structure </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bdbAttributes.bdbNodeIsOnANetwork</font></font></b><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  DIYRuZRT_EVT_LONG</span>
  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_LONG )<font></font>
  {<font></font>
    <span class="hljs-comment">//    </span>
    <span class="hljs-comment">//      ?</span>
    <span class="hljs-keyword">if</span> ( bdbAttributes.bdbNodeIsOnANetwork )<font></font>
    {<font></font>
      <span class="hljs-comment">//  </span><font></font>
      zclDIYRuZRT_LeaveNetwork();<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <font></font>
    {<font></font>
      <span class="hljs-comment">//    </span><font></font>
      bdb_StartCommissioning(<font></font>
        BDB_COMMISSIONING_MODE_NWK_FORMATION | <font></font>
        BDB_COMMISSIONING_MODE_NWK_STEERING | <font></font>
        BDB_COMMISSIONING_MODE_FINDING_BINDING | <font></font>
        BDB_COMMISSIONING_MODE_INITIATOR_TL<font></font>
      );<font></font>
      <span class="hljs-comment">//  ,   </span>
      osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_BLINK, <span class="hljs-number">500</span>);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_LONG );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons plus loin. </font><font style="vertical-align: inherit;">L'√©tat de la LED sera enregistr√© dans une variable, dont nous enregistrerons la valeur dans la m√©moire NV. </font><font style="vertical-align: inherit;">Lorsque l'appareil d√©marre, nous lirons la valeur de la m√©moire dans une variable.</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  NVM   RELAY STATE</span>
  <span class="hljs-keyword">if</span> ( SUCCESS == osal_nv_item_init( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">1</span>, &amp;RELAY_STATE ) ) {
    <span class="hljs-comment">//   RELAY STATE  </span>
    osal_nv_read( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE );<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateRelay</span> <span class="hljs-params">( <span class="hljs-keyword">bool</span> value )</span>
</span>{
  <span class="hljs-keyword">if</span> (value) {<font></font>
    RELAY_STATE = <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    RELAY_STATE = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span>
  osal_nv_write(NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE);
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
}<font></font>
  <font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">applyRelay</span> <span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">if</span> (RELAY_STATE == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_OFF );<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_ON );<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Nous allons maintenant traiter avec Zigbee</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jusqu'√† pr√©sent, nous avons tri√© le mat√©riel - avec le bouton, nous contr√¥lons la LED. </font><font style="vertical-align: inherit;">Maintenant, nous impl√©mentons la m√™me chose via Zigbee. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour contr√¥ler le relais, il nous suffit d'utiliser notre seul point de terminaison et d'impl√©menter le cluster </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous lisons la sp√©cification de la biblioth√®que de clusters Zigbee pour le cluster </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/9z/z7/zo9zz7ccj2oyfyrxrk3mithxh0i.png"><br>
<br>
<img src="https://habrastorage.org/webt/7b/na/ek/7bnaekoi4gmleiisjwvbfw75hao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il suffit d'impl√©menter l'attribut OnOff et les commandes On, Off, Toggle. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, ajoutez la directive √† </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_ON_OFF</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la description de nos attributs zclDIYRuZRT_Attrs, nous ajoutons de nouveaux attributs de cluster:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ***  On/Off  ***</span><font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    { <span class="hljs-comment">// </span><font></font>
      ATTRID_ON_OFF,<font></font>
      ZCL_DATATYPE_BOOLEAN,<font></font>
      ACCESS_CONTROL_READ,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;RELAY_STATE<font></font>
    }<font></font>
  },<font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    {  <span class="hljs-comment">//  On/Off </span><font></font>
      ATTRID_CLUSTER_REVISION,<font></font>
      ZCL_DATATYPE_UINT16,<font></font>
      ACCESS_CONTROL_READ | ACCESS_CLIENT,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;zclDIYRuZRT_clusterRevision_all<font></font>
    }<font></font>
  },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ajoutons √©galement le cluster √† la liste des clusters de noeuds finaux entrants pris en charge </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_InClusterList</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour impl√©menter des commandes de contr√¥le, ajoutez un gestionnaire √† la table </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_CmdCallbacks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 *    ZCL 
 */</span>
<span class="hljs-keyword">static</span> zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks =<font></font>
{<font></font>
  zclDIYRuZRT_BasicResetCB,               <span class="hljs-comment">// Basic Cluster Reset command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Identify Trigger Effect command</span>
  zclDIYRuZRT_OnOffCB,                    <span class="hljs-comment">// On/Off cluster commands</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command Off with Effect</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Recall Global Scene</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Timed Off</span><font></font>
#ifdef ZCL_LEVEL_CTRL<font></font>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move to Level command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Step command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Stop command</span><font></font>
#endif<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous l'impl√©mentons:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    OnOff</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_OnOffCB</span><span class="hljs-params">(uint8 cmd)</span>
</span>{
  <span class="hljs-comment">//  ,   </span>
  <span class="hljs-comment">//    </span><font></font>
  afIncomingMSGPacket_t *pPtr = zcl_getRawAFMsg();<font></font>
  zclDIYRuZRT_DstAddr.addr.shortAddr = pPtr-&gt;srcAddr.addr.shortAddr;<font></font>
  <font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">if</span> (cmd == COMMAND_ON) {<font></font>
    updateRelay(TRUE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_OFF) {<font></font>
    updateRelay(FALSE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_TOGGLE) {<font></font>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
G√©nial, maintenant le relais peut √™tre commut√© par des commandes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rg/_b/r5/rg_br5mwpw1z8g63trgcdts2o84.png"><br>
<br>
<img src="https://habrastorage.org/webt/sc/s8/-h/scs8-heldl3hz6l7h4ia3jllscw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce n'est pas assez. </font><font style="vertical-align: inherit;">Maintenant, nous devons √©galement informer le coordinateur de l'√©tat actuel de la LED, si nous l'allumons avec le bouton. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, ajoutez la directive:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_REPORTING_DEVICE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez maintenant une fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui envoie un message d'√©tat. </font><font style="vertical-align: inherit;">Nous l'appellerons lorsque la LED est commut√©e et lorsque l'appareil d√©marre.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportOnOff</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_ON_OFF;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_BOOLEAN;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;RELAY_STATE);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_GEN_ON_OFF, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, dans les journaux, nous voyons des messages sur un changement d'√©tat de la LED.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. Connectez le capteur de temp√©rature ds18b20</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le capteur est connect√© √† n'importe quelle broche libre (dans mon cas, d√©finissez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez le code d'interrogation du capteur √† l'application. Nous interviewerons r√©guli√®rement - une fois par minute. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imm√©diatement apr√®s le sondage, le coordinateur du r√©seau vous informera de la valeur actuelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez les sp√©cifications ZCL pour l'envoi de donn√©es √† partir de capteurs de temp√©rature. Nous avons besoin d'une </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mesure de temp√©rature de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><b><font style="vertical-align: inherit;">.</font></b></font><br>
<br>
<img src="https://habrastorage.org/webt/o2/_q/8h/o2_q8h7gtgxs7cjvvz8dumonsgq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous voyons que nous devons impl√©menter 3 attributs, dont l'un repr√©sente la valeur de temp√©rature multipli√©e par 100. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous ajoutons les attributs par analogie avec le cluster </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le coordinateur sera inform√© de l'√©v√©nement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_REPORTING_EVT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que nous pr√©voyons au d√©part une fois par minute. Dans le gestionnaire d'√©v√©nements, nous appellerons</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportTemp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui lira la temp√©rature du capteur et enverra un message.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportTemp</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span><font></font>
  zclDIYRuZRT_MeasuredValue = readTemperature();<font></font>
  <font></font>
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_MS_TEMPERATURE_MEASURED_VALUE;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_INT16;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;zclDIYRuZRT_MeasuredValue);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_MS_TEMPERATURE_MEASUREMENT, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. Versez le firmware dans l'appareil</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour changer le devboard en Sonoff BASICZBR3, vous devez ajuster la correspondance des broches et boutons LED. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/fu/we/egfuweya8lj53yh-5rarbvslzvk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refaire la LED 1 sur la broche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0_7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour contr√¥ler le relais. L'inclusion est effectu√©e par un niveau √©lev√© de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTIVE_HIGH</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">Nous raccrochons le</font></b><font style="vertical-align: inherit;"> bouton </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur la broche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et la LED d'information 2 sur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous laissons le capteur de temp√©rature sur la broche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous apportons toutes ces modifications dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pour s√©lectionner une configuration, nous allons cr√©er une directive distincte </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_SONOFF</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . S'il est d√©fini, les param√®tres de Sonoff BASICZBR3 seront utilis√©s, sinon pour devboard.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> HAL_SONOFF</span>
  <span class="hljs-comment">/* 1 - P0_7  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(7)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P0_7</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P0DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_HIGH</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-comment">/* 1 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_LOW</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_1  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(1)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_1</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre param√®tre important a d√ª √™tre corrig√© - la pr√©sence de quartz "montre", car </font><font style="vertical-align: inherit;">Sur la carte Sonoff BASICZBR3, elle n'est pas soud√©e:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define HAL_CLOCK_CRYSTAL</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> OSC32K_CRYSTAL_INSTALLED FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sans ces options, le firmware ne d√©marre pas (ou plut√¥t, pas toujours). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, nous collectons le firmware et nous nous connectons au firmware.</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATTENTION!!! </font><font style="vertical-align: inherit;">D√©branchez le relais Sonoff BASICZBR3 de l'alimentation secteur avant toute connexion et firmware!</font></font></b></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous connectons le c√¢blage Sonoff BASICZBR3 avec CCDebugger, effa√ßons la puce et flasher notre firmware.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/w-/3b/bzw-3bib84ucfczt0kg_mmbajtw.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. Nous d√©marrons l'appareil dans zigbee2mqtt et ioBroker.Zigbee</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que l'appareil, nous sommes apparus dans la liste des appareils connect√©s et nous pouvons le g√©rer en envoyant des commandes, mais nous devons le faire plus correctement - avec des images et des √©tats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir un nouvel appareil dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.Zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous devez effectuer 2 √©tapes:</font></font><br>
<br>
<ol>
<li>     <b>zigbee-herdsman-converters</b>.       ,       <b>zigbee2mqtt</b>.<br>
</li>
<li>    <b>ioBroker.Zigbee</b><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les modifications peuvent √™tre effectu√©es d'abord dans les fichiers locaux, puis effectu√©es dans les r√©f√©rentiels correspondants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons l'emplacement du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquet zigbee-herdsman-converters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le ioBroker install√© (ou zigbee2mqtt). √Ä l'int√©rieur du package, nous trouvons le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devices.js </font></font></i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Koenkk/zigbee-herdsman-converters/blob/master/devices.js</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ce fichier contient des descriptions de tous les p√©riph√©riques avec lesquels </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent travailler </font><font style="vertical-align: inherit;">. On y retrouve un bloc de descriptions des appareils DIYRuZ (apr√®s 2300 lignes). Ajoutez une description du nouvel appareil √† ce bloc:</font></font><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">zigbeeModel</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">model</span>: <span class="hljs-string">'DIYRuZ_RT'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">description</span>: <span class="hljs-string">''</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">supports</span>: <span class="hljs-string">'on/off, temperature'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">fromZigbee</span>: [fz.on_off, fz.temperature],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">toZigbee</span>: [tz.on_off],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'attribut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fromZigbee,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous </font><b><font style="vertical-align: inherit;">sp√©cifions</font></b><font style="vertical-align: inherit;"> les convertisseurs qui traiteront les messages provenant de l'appareil. Nos deux postes sont standardis√©s. Le convertisseur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.on_off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traite le message d'activation / d√©sactivation et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.temperature traite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les donn√©es de temp√©rature. Le code de ces convertisseurs (situ√© dans le fichier converters / fromZigbee.js) montre comment les messages entrants sont trait√©s et que la temp√©rature est divis√©e par 100.</font></font><br>
<br>
<pre><code class="javascript hljs">   on_off: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'genOnOff'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (msg.data.hasOwnProperty(<span class="hljs-string">'onOff'</span>)) {
                <span class="hljs-keyword">const</span> property = getProperty(<span class="hljs-string">'state'</span>, msg, model);
                <span class="hljs-keyword">return</span> {[property]: msg.data[<span class="hljs-string">'onOff'</span>] === <span class="hljs-number">1</span> ? <span class="hljs-string">'ON'</span> : <span class="hljs-string">'OFF'</span>};<font></font>
            }<font></font>
        },<font></font>
    },<font></font>
</code></pre><br>
<pre><code class="javascript hljs"> temperature: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'msTemperatureMeasurement'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> temperature = <span class="hljs-built_in">parseFloat</span>(msg.data[<span class="hljs-string">'measuredValue'</span>]) / <span class="hljs-number">100.0</span>;
            <span class="hljs-keyword">return</span> {<span class="hljs-attr">temperature</span>: calibrateAndPrecisionRoundOptions(temperature, options, <span class="hljs-string">'temperature'</span>)};<font></font>
        },<font></font>
    },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'attribut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toZigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><b><font style="vertical-align: inherit;">nous sp√©cifions</font></b><font style="vertical-align: inherit;"> les convertisseurs qui traiteront nos commandes vers l'appareil. </font><font style="vertical-align: inherit;">Dans notre cas, il s'agit du convertisseur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tz.on_off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la commutation des relais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout a √©t√© ajout√© aux "convertisseurs". </font><font style="vertical-align: inherit;">Qui utilise </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - vous pouvez d√©j√† l'utiliser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et les utilisateurs d'ioBroker ajoutent toujours une description de l'appareil au </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier ioBroker.zigbee \ lib \ devices.js</font></font></i><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">models</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">icon</span>: <span class="hljs-string">'img/DIYRuZ.png'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">states</span>: [<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.state,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.temperature,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, il suffit d'indiquer exactement le m√™me mod√®le, un fichier avec une image et une liste d'√©tats. </font><font style="vertical-align: inherit;">Dans notre cas, les √©tats sont √©galement standard: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©tat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de l'√©tat du relais, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temp√©rature</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'affichage des valeurs de temp√©rature.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oz/fu/zm/ozfuzmz72p-e1lwweegnd4fv74q.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. Et ensuite?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, je n'ai pas pu comprendre tous les aspects et fonctionnalit√©s fournis par Z-Stack 3.0. </font><font style="vertical-align: inherit;">Tr√®s probablement, je n'ai m√™me pas correctement impl√©ment√© une sorte de fonctionnalit√© ou certains m√©canismes int√©gr√©s pourraient √™tre utilis√©s pour l'impl√©menter. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, la solution ci-dessus peut √™tre am√©lior√©e et d√©velopp√©e. </font><font style="vertical-align: inherit;">Voici quelques directions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je n'ai pas pu trouver rapidement de solutions pour la possibilit√© de connecter des appareils enfants via des relais. </font><font style="vertical-align: inherit;">D'autres p√©riph√©riques de routeur peuvent ex√©cuter la commande permit_join et connecter de nouveaux p√©riph√©riques par eux-m√™mes, sans avoir √† apporter le nouveau p√©riph√©rique au coordinateur. </font><font style="vertical-align: inherit;">L'appareil est repr√©sent√© par un routeur, il est correctement affich√© sur la carte du r√©seau, mais refuse d'ex√©cuter la commande ¬´permit_join¬ª. </font><font style="vertical-align: inherit;">Plus pr√©cis√©ment, la commande s'ex√©cute, mais les p√©riph√©riques ne se connectent pas via elle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En outre, n'a pas mis en ≈ìuvre un rapport correct. </font><font style="vertical-align: inherit;">Il s'agit d'un moyen de configurer la notification d'√©tat lorsque vous pouvez utiliser la commande configReport pour sp√©cifier une liste d'attributs √† envoyer et la fr√©quence de notification.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travaillez avec des groupes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitez les interruptions et impl√©mentez les boutons d'interrogation via les interruptions.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, pour les appareils suivants, vous devez g√©rer les modes d'alimentation et la cr√©ation d'appareils "en veille" sur piles.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme toujours, en plus des commentaires, je vous invite √† discuter de cela et d'autres appareils dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chat Telegram sur Zigbee</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je tiens √† exprimer ma gratitude pour le soutien et l'assistance dans le d√©veloppement de mes coll√®gues de la communaut√© Telegram chat et Zigbee:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/DJONvl</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/antstar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/Jager_f</font></font></a></li>
</ul><br>
</blockquote><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rences</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation principale est incluse dans le SDK Z-Stack 3.0.2 et est install√©e avec lui. </font><font style="vertical-align: inherit;">Mais je vais donner une partie des liens ici:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL et HAL </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TI ZIgbee Wiki</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Create New Application For SmartRF05 + CC2530 SWRA231 Version 1.1</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Z-Stack Home Sample Application User's Guide SWRU354 Version 1.3</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Z-Stack Sample Applications SWRA201 Version 1.6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Z-Stack Developer's Guide SWRA176 Version 1.12</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Z-Stack 3.0 Developer's Guide Version 1.14</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Z-Stack API SWRA195 Version 1.10</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TI CC253x User's Guide</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/formtapez/ZigUP</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zigbee Cluster Library rev 6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   DIYRuZ_RT</a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495910/index.html">Installation de ROS dans une image IMG √† carte unique Ubuntu</a></li>
<li><a href="../fr495912/index.html">Autocollants de relecture intelligente</a></li>
<li><a href="../fr495918/index.html">Comment reproduire un son r√©aliste dans les jeux informatiques et la VR et pourquoi c'est difficile</a></li>
<li><a href="../fr495920/index.html">D√©tails d'impl√©mentation du protocole de synchronisation temporelle PTPv2</a></li>
<li><a href="../fr495924/index.html">Pourquoi est-il si difficile de construire un bon mod√®le de distribution COVID-19?</a></li>
<li><a href="../fr495932/index.html">Quelle est la signification cach√©e des auteurs dans le guide SCRUM. Partie 1. √Ä propos du processus</a></li>
<li><a href="../fr495934/index.html">Gouvernance des donn√©es √† domicile</a></li>
<li><a href="../fr495938/index.html">Une s√©lection d'articles sur l'apprentissage automatique: cas, guides et √©tudes pour mars 2020</a></li>
<li><a href="../fr495942/index.html">Gagnez du temps, des nerfs et des heures de travail</a></li>
<li><a href="../fr495944/index.html">Mise √† jour du TOP50 (classement des supercalculateurs CIS): dynamique et tendances</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>