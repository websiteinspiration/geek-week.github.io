<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∂ üõÖ üéá Videollamadas con fondo virtual y herramientas de c√≥digo abierto üö¢ üèöÔ∏è üòµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ahora que muchos de nosotros estamos en cuarentena debido a COVID-19 , las videollamadas se han vuelto mucho m√°s comunes que antes. En particular, el ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Videollamadas con fondo virtual y herramientas de c√≥digo abierto</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/498458/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora que muchos de nosotros estamos en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuarentena</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debido a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COVID-19</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , las videollamadas se han vuelto mucho m√°s comunes que antes. En particular, el servicio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZOOM de </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repente se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hizo muy popular. Probablemente la caracter√≠stica de Zoom m√°s interesante es la compatibilidad con el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fondo virtual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Permite a los usuarios reemplazar interactivamente el fondo detr√°s de ellos con cualquier imagen o video.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/wf/46/1p/wf461pvjwrwmpzvkvnhyvzcf8xy.jpeg"></div></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He estado usando Zoom durante mucho tiempo en el trabajo, en reuniones de c√≥digo abierto sobre Kubernetes, generalmente usando una computadora port√°til corporativa. Ahora, en el modo de trabajo desde casa, me inclino a usar una computadora de escritorio personal m√°s potente y conveniente para resolver algunas de mis tareas de c√≥digo abierto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, Zoom solo admite un m√©todo de eliminaci√≥n de fondo conocido como " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clave de croma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " o " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pantalla verde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Para utilizar este m√©todo, es necesario que el fondo est√© representado por un color s√≥lido, idealmente verde, y est√© iluminado de manera uniforme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no tengo una pantalla verde, decid√≠ simplemente implementar mi propio sistema de eliminaci√≥n de fondo. Y esto, por supuesto, es mucho mejor que poner las cosas en orden en el apartamento, o el uso constante de una computadora port√°til de trabajo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final result√≥ que, usando componentes de c√≥digo abierto listos para usar y escribiendo solo unas pocas l√≠neas de su propio c√≥digo, puede obtener resultados muy decentes.</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leer datos de la c√°mara</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos desde el principio y respondamos la siguiente pregunta: "¬øC√≥mo obtener video de una c√°mara web que procesaremos?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como uso Linux en la computadora de mi casa (cuando no juego), decid√≠ usar los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlaces </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open CV </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Python</font></a><font style="vertical-align: inherit;"> , que ya conozco. </font><font style="vertical-align: inherit;">Adem√°s de los </font><font style="vertical-align: inherit;">enlaces </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V4L2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para leer datos de una c√°mara web, incluyen funciones b√°sicas √∫tiles de procesamiento de video. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leer un marco desde una c√°mara web en python-opencv es muy simple:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> cv2<font></font>
cap = cv2.VideoCapture(<span class="hljs-string">'/dev/video0'</span>)<font></font>
success, frame = cap.read()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mejorar los resultados al trabajar con mi c√°mara, apliqu√© la siguiente configuraci√≥n antes de capturar video de ella:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#    720p @ 60 FPS</span>
height, width = <span class="hljs-number">720</span>, <span class="hljs-number">1280</span><font></font>
cap.set(cv2.CAP_PROP_FRAME_WIDTH ,width)<font></font>
cap.set(cv2.CAP_PROP_FRAME_HEIGHT,height)<font></font>
cap.set(cv2.CAP_PROP_FPS, <span class="hljs-number">60</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que la mayor√≠a de los programas de videoconferencia limitan el video a 720p a 30 FPS o menos. </font><font style="vertical-align: inherit;">Pero, en cualquier caso, es posible que no leamos todos los cuadros. </font><font style="vertical-align: inherit;">Dichas configuraciones establecen el l√≠mite superior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ponga el mecanismo de captura de cuadros en un bucle. </font><font style="vertical-align: inherit;">¬°Ahora tenemos acceso a la transmisi√≥n de video desde la c√°mara!</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;success, frame = cap.read()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede guardar el marco para fines de prueba de la siguiente manera:</font></font><br>
<br>
<pre><code class="python hljs">cv2.imwrite(<span class="hljs-string">"test.jpg"</span>, frame)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, podemos asegurarnos de que la c√°mara est√© funcionando. </font><font style="vertical-align: inherit;">¬°Excelente!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/96c/1ea/155/96c1ea155c714c5f1c8ab70f737444f8.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espero que no estes en contra de mi barba</font></font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecci√≥n de fondo</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que tenemos acceso a la transmisi√≥n de video, pensaremos en c√≥mo detectar el fondo haciendo posible reemplazarlo al encontrarlo. Pero esta ya es una tarea bastante dif√≠cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque existe la sensaci√≥n de que los creadores de Zoom nunca hablan exactamente de c√≥mo el programa elimina el fondo, la forma en que se comporta el sistema me hace pensar en lo que podr√≠a haber hecho sin redes neuronales. Es dif√≠cil de explicar, pero los resultados se ven exactamente as√≠. Adem√°s, encontr√© un art√≠culo sobre c√≥mo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Teams</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementa el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desenfoque de fondo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilizando una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">red neuronal convolucional</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principio, crear su propia red neuronal no es tan dif√≠cil. Hay muchos art√≠culos y art√≠culos cient√≠ficos sobre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segmentaci√≥n de im√°genes.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hay muchas bibliotecas y herramientas de c√≥digo abierto. Pero necesitamos un conjunto de datos muy especializado para obtener buenos resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En particular, necesitamos muchas im√°genes que recuerden a las obtenidas de una c√°mara web, con una imagen perfecta de una persona en primer plano. Cada p√≠xel de dicha imagen debe marcarse como diferente del fondo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Construir un conjunto de datos como preparaci√≥n para entrenar una red neuronal puede no requerir mucho esfuerzo. Esto se debe al hecho de que el equipo de investigadores de Google ya ha hecho todo lo posible y ha puesto en c√≥digo abierto una red neuronal pre-entrenada para segmentar a las personas. Esta red se llama </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BodyPix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . ¬°Funciona muy bien! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BodyPix ahora solo est√° disponible en una forma adecuada para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TensorFlow.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Como resultado, es m√°s f√°cil de aplicar usando la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">body-pix-node</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para acelerar la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salida de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">red</font></a><font style="vertical-align: inherit;"> (pron√≥stico) en el navegador, es preferible usar el </font><font style="vertical-align: inherit;">backend </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebGL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero en el entorno </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backend GPU Tensorflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tenga en cuenta que esto requerir√° una tarjeta de video de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NVIDIA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que tengo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para simplificar la configuraci√≥n del proyecto, utilizaremos un peque√±o entorno en contenedores que proporciona la GPU TensorFlow y Node.js. Utiliz√°ndolo todo con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nvidia-docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- mucho m√°s f√°cil que recopilar las dependencias necesarias en su computadora usted mismo. </font><font style="vertical-align: inherit;">Para hacer esto, solo necesita Docker y los √∫ltimos controladores de gr√°ficos en su computadora. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° el contenido del archivo </font></font><code>bodypix/package.json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="json hljs">{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">"name"</span>: <span class="hljs-string">"bodypix"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">"version"</span>: <span class="hljs-string">"0.0.1"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">"dependencies"</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">"@tensorflow-models/body-pix"</span>: <span class="hljs-string">"^2.0.5"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">"@tensorflow/tfjs-node-gpu"</span>: <span class="hljs-string">"^1.7.1"</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° el archivo </font></font><code>bodypix/Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#  ,   TensorFlow GPU</span>
FROM nvcr.io/nvidia/cuda:<span class="hljs-number">10.0</span>-cudnn7-runtime-ubuntu18<span class="hljs-number">.04</span>
<span class="hljs-comment">#  node</span><font></font>
RUN apt update &amp;&amp; apt install -y curl make build-essential \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; curl -sL https://deb.nodesource.com/setup_12.x | bash - \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; apt-get -y install nodejs \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; mkdir /.npm \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; chmod <span class="hljs-number">777</span> /.npm
<span class="hljs-comment"># ,    &nbsp;</span>
<span class="hljs-comment">#   tfjs-node-gpu      GPU :(</span><font></font>
ENV TF_FORCE_GPU_ALLOW_GROWTH=true<font></font>
<span class="hljs-comment">#  node-</span><font></font>
WORKDIR /src<font></font>
COPY package.json /src/<font></font>
RUN npm install<font></font>
<span class="hljs-comment">#      </span><font></font>
COPY app.js /src/<font></font>
ENTRYPOINT node /src/app.js<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora hablemos de obtener resultados. </font><font style="vertical-align: inherit;">Pero te advierto de inmediato: ¬°no soy un experto en Node.js! </font><font style="vertical-align: inherit;">Esto es solo el resultado de mis experimentos nocturnos, as√≠ que s√© indulgente conmigo :-). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente script simple est√° ocupado procesando una imagen de m√°scara binaria enviada al servidor utilizando una solicitud HTTP POST. </font><font style="vertical-align: inherit;">Una m√°scara es una matriz bidimensional de p√≠xeles. </font><font style="vertical-align: inherit;">Los p√≠xeles representados por ceros son el fondo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° el c√≥digo del archivo </font></font><code>app.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> tf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@tensorflow/tfjs-node-gpu'</span>);
<span class="hljs-keyword">const</span> bodyPix = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@tensorflow-models/body-pix'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">async</span> (</span>) =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> net = <span class="hljs-keyword">await</span> bodyPix.load({
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">architecture</span>: <span class="hljs-string">'MobileNetV1'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">outputStride</span>: <span class="hljs-number">16</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">multiplier</span>: <span class="hljs-number">0.75</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">quantBytes</span>: <span class="hljs-number">2</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> server = http.createServer();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;server.on(<span class="hljs-string">'request'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">var</span> chunks = [];<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;req.on(<span class="hljs-string">'data'</span>, (chunk) =&gt; {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks.push(chunk);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;req.on(<span class="hljs-string">'end'</span>, <span class="hljs-keyword">async</span> () =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> image = tf.node.decodeImage(Buffer.concat(chunks));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segmentation = <span class="hljs-keyword">await</span> net.segmentPerson(image, {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">flipHorizontal</span>: <span class="hljs-literal">false</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">internalResolution</span>: <span class="hljs-string">'medium'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">segmentationThreshold</span>: <span class="hljs-number">0.7</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.writeHead(<span class="hljs-number">200</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/octet-stream'</span> });<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.write(Buffer.from(segmentation.data));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.end();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tf.dispose(image);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;server.listen(<span class="hljs-number">9000</span>);<font></font>
})();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para convertir un marco en una m√°scara, nosotros, en un script de Python, podemos usar los paquetes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">numpy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_mask</span>(<span class="hljs-params">frame, bodypix_url=<span class="hljs-string">'http://localhost:9000'</span></span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;_, data = cv2.imencode(<span class="hljs-string">".jpg"</span>, frame)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;r = requests.post(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url=bodypix_url,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data=data.tobytes(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers={<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/octet-stream'</span>})
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     numpy-</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     uint8[width * height]   0  1</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = np.frombuffer(r.content, dtype=np.uint8)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = mask.reshape((frame.shape[<span class="hljs-number">0</span>], frame.shape[<span class="hljs-number">1</span>]))
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> mask
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado es aproximadamente el siguiente.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e51/7db/e3c/e517dbe3ce6eee99d646a8e4257a627f.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°scara</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mientras hac√≠a todo esto, me encontr√© con el</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> siguiente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tweet.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5a5/c4b/4dd/5a5c4b4dda480f0fa58807ec5b89b457.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es definitivamente el mejor fondo para las videollamadas.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ahora que tenemos una m√°scara para separar el primer plano del fondo, reemplazar el fondo con algo m√°s ser√° muy simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tom√© la imagen de fondo de la rama de tweet y la cort√© para obtener una imagen de 16x9.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/900/311/537/900311537df81d74a682ddfd447a85a5.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagen de fondo</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Despu√©s de eso hice lo siguiente:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#    (     16:9)</span>
replacement_bg_raw = cv2.imread(<span class="hljs-string">"background.jpg"</span>)<font></font>
<font></font>
<span class="hljs-comment">#    ,       (width &amp; height   )</span>
width, height = <span class="hljs-number">720</span>, <span class="hljs-number">1280</span><font></font>
replacement_bg = cv2.resize(replacement_bg_raw, (width, height))<font></font>
<font></font>
<span class="hljs-comment">#     ,   </span>
inv_mask = <span class="hljs-number">1</span>-mask
<span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> range(frame.shape[<span class="hljs-number">2</span>]):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;frame[:,:,c] = frame[:,:,c]*mask + replacement_bg[:,:,c]*inv_mask<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es lo que obtuve despu√©s de eso.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/500/fbf/e3b/500fbfe3ba3753878562533ced87ed69.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resultado de reemplazar el fondo</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Obviamente, esta m√°scara no es lo suficientemente precisa, la raz√≥n de esto son las compensaciones de rendimiento que hicimos al configurar BodyPix. </font><font style="vertical-align: inherit;">En general, mientras todo parece m√°s o menos tolerante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero cuando mir√© este fondo, se me ocurri√≥ una idea.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Experimentos interesantes</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que hemos descubierto c√≥mo enmascarar, preguntaremos c√≥mo mejorar el resultado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer paso obvio es suavizar los bordes de la m√°scara. </font><font style="vertical-align: inherit;">Por ejemplo, esto se puede hacer as√≠:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post_process_mask</span>(<span class="hljs-params">mask</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.dilate(mask, np.ones((<span class="hljs-number">10</span>,<span class="hljs-number">10</span>), np.uint8) , iterations=<span class="hljs-number">1</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.erode(mask, np.ones((<span class="hljs-number">10</span>,<span class="hljs-number">10</span>), np.uint8) , iterations=<span class="hljs-number">1</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> mask
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto mejorar√° un poco la situaci√≥n, pero no hay mucho progreso. </font><font style="vertical-align: inherit;">Y un reemplazo simple es bastante aburrido. </font><font style="vertical-align: inherit;">Pero, dado que llegamos a todo esto nosotros mismos, esto significa que podemos hacer cualquier cosa con la imagen, y no solo eliminar el fondo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que estamos usando un fondo virtual de Star Wars, decid√≠ crear un efecto de holograma para hacer que la imagen sea m√°s interesante. </font><font style="vertical-align: inherit;">Esto, adem√°s, le permite suavizar el desenfoque de la m√°scara. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, actualice el c√≥digo de procesamiento posterior:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post_process_mask</span>(<span class="hljs-params">mask</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.dilate(mask, np.ones((<span class="hljs-number">10</span>,<span class="hljs-number">10</span>), np.uint8) , iterations=<span class="hljs-number">1</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.blur(mask.astype(float), (<span class="hljs-number">30</span>,<span class="hljs-number">30</span>))
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> mask
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los bordes ahora est√°n borrosos. </font><font style="vertical-align: inherit;">Esto es bueno, pero a√∫n necesitamos crear un efecto de holograma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los hologramas de Hollywood generalmente tienen las siguientes propiedades:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una imagen en color p√°lido o monocromo, como dibujada por un l√°ser brillante.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un efecto que recuerda a las l√≠neas de exploraci√≥n o algo parecido a una cuadr√≠cula, como si la imagen se mostrara en varios rayos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúEfecto fantasma‚Äù: como si la proyecci√≥n se realizara en capas o como si no se mantuviera la distancia correcta a la que deber√≠a mostrarse al crear la proyecci√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos estos efectos se pueden implementar paso a paso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, para colorear la imagen en un tono de azul, podemos usar el m√©todo </font></font><code>applyColorMap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#     -  </span><font></font>
holo = cv2.applyColorMap(frame, cv2.COLORMAP_WINTER)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, agregue una l√≠nea de barrido con un efecto que recuerde dejar en tono medio:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#    bandLength    10-30%,</span>
<span class="hljs-comment">#    bandGap.</span>
bandLength, bandGap = <span class="hljs-number">2</span>, <span class="hljs-number">3</span>
<span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(holo.shape[<span class="hljs-number">0</span>]):
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> y % (bandLength+bandGap) &lt; bandLength:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;holo[y,:,:] = holo[y,:,:] * np.random.uniform(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, implementamos el "efecto fantasma" agregando copias ponderadas desplazadas del efecto actual a la imagen:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># shift_img : https://stackoverflow.com/a/53140617</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shift_img</span>(<span class="hljs-params">img, dx, dy</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;img = np.roll(img, dy, axis=<span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;img = np.roll(img, dx, axis=<span class="hljs-number">1</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> dy&gt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:dy, :] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">elif</span> dy&lt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[dy:, :] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> dx&gt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:, :dx] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">elif</span> dx&lt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:, dx:] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> img<font></font>
<font></font>
<span class="hljs-comment">#    : holo * 0.2 + shifted_holo * 0.8 + 0</span>
holo2 = cv2.addWeighted(holo, <span class="hljs-number">0.2</span>, shift_img(holo1.copy(), <span class="hljs-number">5</span>, <span class="hljs-number">5</span>), <span class="hljs-number">0.8</span>, <span class="hljs-number">0</span>)<font></font>
holo2 = cv2.addWeighted(holo2, <span class="hljs-number">0.4</span>, shift_img(holo1.copy(), <span class="hljs-number">-5</span>, <span class="hljs-number">-5</span>), <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y finalmente, queremos mantener algunos de los colores originales, por lo que combinamos el efecto hologr√°fico con el marco original, haciendo algo similar a agregar el "efecto fantasma":</font></font><br>
<br>
<pre><code class="python hljs">holo_done = cv2.addWeighted(img, <span class="hljs-number">0.5</span>, holo2, <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve un cuadro con un efecto de holograma:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ba/bda/21c/8babda21c3f11e9fa3867faf65e14c24.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un cuadro con efecto de holograma</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Este cuadro en s√≠ se ve bastante bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora intentemos combinarlo con el fondo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/297/7b7/ce4/2977b7ce4f9efdedd6632ffb0a3ad621.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superpuesto imagen en el fondo.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hecho! </font><font style="vertical-align: inherit;">(Lo prometo, este tipo de video se ver√° m√°s interesante).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salida de video</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora debo decir que nos hemos perdido algo aqu√≠. </font><font style="vertical-align: inherit;">El hecho es que todav√≠a no podemos usar todo esto para hacer videollamadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solucionar esto, utilizaremos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyfakewebcam</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4l2loopback</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para crear una c√°mara web falsa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, planeamos conectar esta c√°mara al Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, cree un archivo de </font></font><code>fakecam/requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descripci√≥n de dependencia:</font></font><br>
<br>
<pre><code class="python hljs">numpy==<span class="hljs-number">1.18</span><span class="hljs-number">.2</span>
opencv-python==<span class="hljs-number">4.2</span><span class="hljs-number">.0</span><span class="hljs-number">.32</span>
requests==<span class="hljs-number">2.23</span><span class="hljs-number">.0</span>
pyfakewebcam==<span class="hljs-number">0.1</span><span class="hljs-number">.0</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora cree un archivo </font></font><code>fakecam/Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para la aplicaci√≥n que implemente las capacidades de una c√°mara falsa:</font></font><br>
<br>
<pre><code class="python hljs">FROM python:<span class="hljs-number">3</span>-buster
<span class="hljs-comment">#   pip</span><font></font>
RUN pip install --upgrade pip<font></font>
<span class="hljs-comment">#   opencv</span><font></font>
RUN apt-get update &amp;&amp; \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;apt-get install -y \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<span class="hljs-comment"># opencv requirements` \</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libsm6 libxext6 libxrender-dev \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`<span class="hljs-comment"># opencv video opening requirements` \</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;libv4l-dev<font></font>
<span class="hljs-comment">#    requirements.txt</span><font></font>
WORKDIR /src<font></font>
COPY requirements.txt /src/<font></font>
RUN pip install --no-cache-dir -r /src/requirements.txt<font></font>
<span class="hljs-comment">#   </span><font></font>
COPY background.jpg /data/<font></font>
<span class="hljs-comment">#     (     )</span><font></font>
COPY fake.py /src/<font></font>
ENTRYPOINT python -u fake.py<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, desde la l√≠nea de comandos, instale v4l2loopback:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt install v4l2loopback-dkms
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurar una c√°mara falsa:</font></font><br>
<br>
<pre><code class="python hljs">sudo modprobe -r v4l2loopback<font></font>
sudo modprobe v4l2loopback devices=<span class="hljs-number">1</span> video_nr=<span class="hljs-number">20</span> card_label=<span class="hljs-string">"v4l2loopback"</span> exclusive_caps=<span class="hljs-number">1</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantizar la funcionalidad de algunas aplicaciones (Chrome, Zoom), necesitamos una configuraci√≥n </font></font><code>exclusive_caps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La marca </font></font><code>card_label</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se establece solo para garantizar la conveniencia de elegir una c√°mara en las aplicaciones. </font><font style="vertical-align: inherit;">La indicaci√≥n del n√∫mero </font></font><code>video_nr=20</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lleva a la creaci√≥n del dispositivo </font></font><code>/dev/video20</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el n√∫mero correspondiente no est√° ocupado y es poco probable que est√© ocupado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora haremos cambios en el script para crear una c√°mara falsa:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># ,  ,   ,   ,  width  height</span>
fake = pyfakewebcam.FakeWebcam(<span class="hljs-string">'/dev/video20'</span>, width, height)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cabe se√±alar que pyfakewebcam espera im√°genes con canales RGB (Rojo, Verde, Azul - rojo, verde, azul), y Open CV funciona con el orden de los canales BGR (Azul, Verde, Rojo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede arreglar esto antes de generar el marco y luego enviar el marco de esta manera:</font></font><br>
<br>
<pre><code class="python hljs">frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)<font></font>
fake.schedule_frame(frame)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° el c√≥digo completo del script </font></font><code>fakecam/fake.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> pyfakewebcam<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_mask</span>(<span class="hljs-params">frame, bodypix_url=<span class="hljs-string">'http://localhost:9000'</span></span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;_, data = cv2.imencode(<span class="hljs-string">".jpg"</span>, frame)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;r = requests.post(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url=bodypix_url,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data=data.tobytes(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers={<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/octet-stream'</span>})<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = np.frombuffer(r.content, dtype=np.uint8)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = mask.reshape((frame.shape[<span class="hljs-number">0</span>], frame.shape[<span class="hljs-number">1</span>]))
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> mask<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post_process_mask</span>(<span class="hljs-params">mask</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.dilate(mask, np.ones((<span class="hljs-number">10</span>,<span class="hljs-number">10</span>), np.uint8) , iterations=<span class="hljs-number">1</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = cv2.blur(mask.astype(float), (<span class="hljs-number">30</span>,<span class="hljs-number">30</span>))
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> mask<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shift_image</span>(<span class="hljs-params">img, dx, dy</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;img = np.roll(img, dy, axis=<span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;img = np.roll(img, dx, axis=<span class="hljs-number">1</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> dy&gt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:dy, :] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">elif</span> dy&lt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[dy:, :] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> dx&gt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:, :dx] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">elif</span> dx&lt;<span class="hljs-number">0</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img[:, dx:] = <span class="hljs-number">0</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> img<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hologram_effect</span>(<span class="hljs-params">img</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;holo = cv2.applyColorMap(img, cv2.COLORMAP_WINTER)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;&nbsp;bandLength, bandGap = <span class="hljs-number">2</span>, <span class="hljs-number">3</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(holo.shape[<span class="hljs-number">0</span>]):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> y % (bandLength+bandGap) &lt; bandLength:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;holo[y,:,:] = holo[y,:,:] * np.random.uniform(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;holo_blur = cv2.addWeighted(holo, <span class="hljs-number">0.2</span>, shift_image(holo.copy(), <span class="hljs-number">5</span>, <span class="hljs-number">5</span>), <span class="hljs-number">0.8</span>, <span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;holo_blur = cv2.addWeighted(holo_blur, <span class="hljs-number">0.4</span>, shift_image(holo.copy(), <span class="hljs-number">-5</span>, <span class="hljs-number">-5</span>), <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;&nbsp;out = cv2.addWeighted(img, <span class="hljs-number">0.5</span>, holo_blur, <span class="hljs-number">0.6</span>, <span class="hljs-number">0</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> out<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_frame</span>(<span class="hljs-params">cap, background_scaled</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_, frame = cap.read()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#      (  ,   )</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#       </span>
&nbsp;&nbsp;&nbsp;&nbsp;mask = <span class="hljs-literal">None</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> mask <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask = get_mask(frame)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except</span> requests.RequestException:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="hljs-string">"mask request failed, retrying"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># -   </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;mask = post_process_mask(mask)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;frame = hologram_effect(frame)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;&nbsp;inv_mask = <span class="hljs-number">1</span>-mask
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> range(frame.shape[<span class="hljs-number">2</span>]):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frame[:,:,c] = frame[:,:,c]*mask + background_scaled[:,:,c]*inv_mask<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> frame<font></font>
<font></font>
<span class="hljs-comment">#     </span>
cap = cv2.VideoCapture(<span class="hljs-string">'/dev/video0'</span>)<font></font>
height, width = <span class="hljs-number">720</span>, <span class="hljs-number">1280</span><font></font>
cap.set(cv2.CAP_PROP_FRAME_WIDTH, width)<font></font>
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, height)<font></font>
cap.set(cv2.CAP_PROP_FPS, <span class="hljs-number">60</span>)<font></font>
<font></font>
<span class="hljs-comment">#   </span>
fake = pyfakewebcam.FakeWebcam(<span class="hljs-string">'/dev/video20'</span>, width, height)<font></font>
<font></font>
<span class="hljs-comment">#    </span>
background = cv2.imread(<span class="hljs-string">"/data/background.jpg"</span>)<font></font>
background_scaled = cv2.resize(background, (width, height))<font></font>
<font></font>
<span class="hljs-comment">#    </span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;frame = get_frame(cap, background_scaled)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    RGB-</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fake.schedule_frame(frame)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora recoge las im√°genes:</font></font><br>
<br>
<pre><code class="python hljs">docker build -t bodypix ./bodypix<font></font>
docker build -t fakecam ./fakecam<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejec√∫talos:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#  </span><font></font>
docker network create --driver bridge fakecam<font></font>
<span class="hljs-comment">#   bodypix</span><font></font>
docker run -d \<font></font>
&nbsp;&nbsp;--name=bodypix \<font></font>
&nbsp;&nbsp;--network=fakecam \<font></font>
&nbsp;&nbsp;--gpus=all --shm-size=<span class="hljs-number">1</span>g --ulimit memlock=<span class="hljs-number">-1</span> --ulimit stack=<span class="hljs-number">67108864</span> \<font></font>
&nbsp;&nbsp;bodypix<font></font>
<span class="hljs-comment">#  ,  ,      ,  ,</span>
<span class="hljs-comment">#           </span>
<span class="hljs-comment"># ,     `sudo groupadd $USER video`</span><font></font>
docker run -d \<font></font>
&nbsp;&nbsp;--name=fakecam \<font></font>
&nbsp;&nbsp;--network=fakecam \<font></font>
&nbsp;&nbsp;-p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> \<font></font>
&nbsp;&nbsp;-u <span class="hljs-string">"$$(id -u):$$(getent group video | cut -d: -f3)"</span> \<font></font>
&nbsp;&nbsp;$$(find /dev -name <span class="hljs-string">'video*'</span> -printf <span class="hljs-string">"--device %p "</span>) \<font></font>
&nbsp;&nbsp;fakecam<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo queda considerar que esto debe iniciarse antes de abrir la c√°mara cuando se trabaja con cualquier aplicaci√≥n. </font><font style="vertical-align: inherit;">Y en Zoom o en otro lugar, debe seleccionar una c√°mara </font></font><code>v4l2loopback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>/dev/video20</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay un clip que muestra los resultados de mi trabajo.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://elder.dev/posts/open-source-virtual-background/holo-demo.webm" type="video/webm"></video></div></div></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado de cambio de fondo</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ver! </font><font style="vertical-align: inherit;">¬°Llamo desde el Halc√≥n Milenario usando la pila de tecnolog√≠a de c√≥digo abierto para trabajar con la c√°mara! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que hice me gust√≥ mucho. </font><font style="vertical-align: inherit;">Y definitivamente aprovechar√© todo esto en la pr√≥xima videoconferencia. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Queridos lectores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øEst√°s planeando cambiar lo que est√° visible durante las videollamadas detr√°s de ti por algo m√°s?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498446/index.html">Preguntas de trabajo: estabilidad imaginaria, falsa devoci√≥n y posicionamiento</a></li>
<li><a href="../es498450/index.html">Redundancia MultiSim: qu√© es y c√≥mo funciona</a></li>
<li><a href="../es498452/index.html">Django: una gu√≠a r√°pida para la internacionalizaci√≥n</a></li>
<li><a href="../es498454/index.html">Historias de los desarrolladores de tus juegos favoritos acerca de lo que est√°n orgullosos</a></li>
<li><a href="../es498456/index.html">Pr√°ctica de ajuste de desplazamiento CSS</a></li>
<li><a href="../es498462/index.html">Desplazamiento infinito con pancartas, o C√≥mo hacer con tres vistas</a></li>
<li><a href="../es498466/index.html">C√≥mo los l√°seres y los sensores ayudan a mantener nerviosos a los jueces</a></li>
<li><a href="../es498472/index.html">Imagen de Docker de aplicaci√≥n de p√°gina √∫nica</a></li>
<li><a href="../es498476/index.html">Accesibilidad C√≥mo hacer que la aplicaci√≥n sea accesible para usuarios con discapacidades</a></li>
<li><a href="../es498478/index.html">¬øQu√© es Windows PowerShell y qu√© come? Parte 5: acceso a objetos externos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>