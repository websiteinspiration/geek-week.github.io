<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß‚Äçüë¶ üöª ‚õ∑Ô∏è Using the Monte Carlo Method to Create a Portfolio üó®Ô∏è üî≤ üë®‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beginning (and not only) investors often wonder how to choose the ideal ratio of assets included in the portfolio. Often (or not very, but I know abou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Using the Monte Carlo Method to Create a Portfolio</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500262/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginning (and not only) investors often wonder how to choose the ideal ratio of assets included in the portfolio. </font><font style="vertical-align: inherit;">Often (or not very, but I know about two for sure) for some brokers, this function is performed by a trading robot. </font><font style="vertical-align: inherit;">But the algorithms embedded in them are not disclosed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This post will cover how to optimize a portfolio using Python and Monte Carlo simulations. </font><font style="vertical-align: inherit;">Portfolio optimization is understood as such a ratio of weights that will satisfy one of the conditions:</font></font><br>
<a name="habracut"></a><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A portfolio with a minimum level of risk with the desired profitability;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Portfolio with maximum profitability at established risk;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Portfolio with maximum yield</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the calculation we‚Äôll take nine stocks recommended by the trading robot of one of the brokers at the beginning of January 2020 and also set the optimal weights for them in the portfolio: 'ATVI', 'BA', 'CNP', 'CMA', 'STZ', 'GPN', 'MPC', 'NEM' and 'PKI'. </font><font style="vertical-align: inherit;">For analysis, we will take stock data for the last three years.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># </span><font></font>
<font></font>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> yfinance <span class="hljs-keyword">as</span> yf
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<font></font>
<font></font>
<span class="hljs-comment">#    </span>
ticker = [<span class="hljs-string">'ATVI'</span>,<span class="hljs-string">'BA'</span>,<span class="hljs-string">'CNP'</span>,<span class="hljs-string">'CMA'</span>, <span class="hljs-string">'STZ'</span>,<span class="hljs-string">'GPN'</span>,<span class="hljs-string">'MPC'</span>,<span class="hljs-string">'NEM'</span>, <span class="hljs-string">'PKI'</span>]<font></font>
<font></font>
stock = yf.download(ticker,<span class="hljs-string">'2017-01-01'</span>, <span class="hljs-string">'2019-01-31'</span>) 
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you add up the share of all the shares included in the portfolio, then the amount should tend to one (or rather be equal). </font><font style="vertical-align: inherit;">Then, as usual, we will prepare the data for the calculations:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#    </span>
all_adj_close = stock[[<span class="hljs-string">'Adj Close'</span>]]<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
all_returns = all_adj_close.pct_change()<font></font>
<font></font>
<span class="hljs-comment">#       </span><font></font>
mean_returns = all_returns.mean()<font></font>
cov_matrix = all_returns.cov()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can calculate for the weights offered by the trading robot and find out the profitability of this portfolio for the last three years and the standard deviation. </font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#    </span>
robot = np.array([<span class="hljs-number">0.0441</span>, <span class="hljs-number">0.1030</span>, <span class="hljs-number">0.1086</span>, <span class="hljs-number">0.2070</span>, <span class="hljs-number">0.1525</span>, <span class="hljs-number">0.0714</span>, <span class="hljs-number">0.0647</span>, <span class="hljs-number">0.1828</span>, <span class="hljs-number">0.0661</span>])<font></font>
<font></font>
<span class="hljs-comment"># ,     </span><font></font>
portfolio_return_robot = np.sum(mean_returns * robot)<font></font>
portfolio_std_dev_robot = np.sqrt(np.dot(robot.T,np.dot(cov_matrix, robot)))<font></font>
sharpo_robot = portfolio_return_robot/portfolio_std_dev_robot<font></font>
<font></font>
<span class="hljs-comment">#         </span><font></font>
robot_result = np.array([portfolio_return_robot, portfolio_std_dev_robot, sharpo_robot])<font></font>
robot_result = np.array([portfolio_return_robot, portfolio_std_dev_robot, sharpo_robot])<font></font>
robot_result = np.concatenate((robot_result, robot), axis=<span class="hljs-number">0</span>)<font></font>
robot_sim_result = pd.DataFrame(robot_result, columns=[<span class="hljs-string">'Robot'</span>], index=[<span class="hljs-string">'ret'</span>,<span class="hljs-string">'stdev'</span>,<span class="hljs-string">'sharpe'</span>,ticker[<span class="hljs-number">0</span>],ticker[<span class="hljs-number">1</span>],ticker[<span class="hljs-number">2</span>],ticker[<span class="hljs-number">3</span>],ticker[<span class="hljs-number">4</span>],ticker[<span class="hljs-number">5</span>],ticker[<span class="hljs-number">6</span>],ticker[<span class="hljs-number">7</span>],ticker[<span class="hljs-number">8</span>]])<font></font>
<font></font>
print(robot_sim_result) <font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/gw/og/jr/gwogjrn9euy3uaqsgkworxncpdu.png" alt="image"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monte Carlo simulation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, a small introduction to how the Monte Carlo method is used to optimize the portfolio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, random weights are given to the shares, after which the yield and standard deviation are calculated. </font><font style="vertical-align: inherit;">The resulting values ‚Äã‚Äãare saved. </font><font style="vertical-align: inherit;">The next step is to randomly change the weights (the main thing is not to forget that their sum should be one) and everything repeats - calculating and saving the obtained value. </font><font style="vertical-align: inherit;">The number of iterations depends on the time, computer capacities for calculation, and risks that the investor is ready to accept. </font><font style="vertical-align: inherit;">This time we‚Äôll try to do 10,000 calculations to identify a portfolio with a minimum loss and a maximum Sharpe ratio.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#   </span>
num_iterations = <span class="hljs-number">10000</span>
simulation_res = np.zeros((<span class="hljs-number">4</span>+len(ticker)<span class="hljs-number">-1</span>,num_iterations))<font></font>
<font></font>
<span class="hljs-comment">#  </span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(num_iterations):
        <span class="hljs-comment">#    ,    1</span>
        weights = np.array(np.random.random(<span class="hljs-number">9</span>))<font></font>
        weights /= np.sum(weights)<font></font>
        <font></font>
        <span class="hljs-comment">#    </span><font></font>
        portfolio_return = np.sum(mean_returns * weights)<font></font>
        portfolio_std_dev = np.sqrt(np.dot(weights.T,np.dot(cov_matrix, weights)))<font></font>
        <font></font>
        <span class="hljs-comment">#     </span>
        simulation_res[<span class="hljs-number">0</span>,i] = portfolio_return<font></font>
        simulation_res[<span class="hljs-number">1</span>,i] = portfolio_std_dev<font></font>
        <font></font>
        <span class="hljs-comment">#    </span>
        simulation_res[<span class="hljs-number">2</span>,i] = simulation_res[<span class="hljs-number">0</span>,i] / simulation_res[<span class="hljs-number">1</span>,i]<font></font>
        <font></font>
        <span class="hljs-comment"># </span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(len(weights)):<font></font>
                simulation_res[j+<span class="hljs-number">3</span>,i] = weights[j]<font></font>
<font></font>
<span class="hljs-comment">#     DataFrame     .</span>
sim_frame = pd.DataFrame(simulation_res.T,columns=[<span class="hljs-string">'ret'</span>,<span class="hljs-string">'stdev'</span>,<span class="hljs-string">'sharpe'</span>,ticker[<span class="hljs-number">0</span>],ticker[<span class="hljs-number">1</span>],ticker[<span class="hljs-number">2</span>],ticker[<span class="hljs-number">3</span>],ticker[<span class="hljs-number">4</span>],ticker[<span class="hljs-number">5</span>],ticker[<span class="hljs-number">6</span>],ticker[<span class="hljs-number">7</span>],ticker[<span class="hljs-number">8</span>]])
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can calculate the portfolio with the maximum Sharpe ratio or minimum risk.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#   Sharpe Ratio</span>
max_sharpe = sim_frame.iloc[sim_frame[<span class="hljs-string">'sharpe'</span>].idxmax()]<font></font>
<font></font>
<span class="hljs-comment">#    </span>
min_std = sim_frame.iloc[sim_frame[<span class="hljs-string">'stdev'</span>].idxmin()]<font></font>
<font></font>
<span class="hljs-keyword">print</span> (<span class="hljs-string">"The portfolio for max Sharpe Ratio:\n"</span>, max_sharpe)
<span class="hljs-keyword">print</span> (<span class="hljs-string">"The portfolio for min risk:\n"</span>, min_std)
</code></pre><br>
<img src="https://habrastorage.org/webt/qv/9g/r5/qv9gr5iwannzjbvvk48jm1neknu.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/rc/u5/24/rcu524mbax3k3tsq1rfo2mpikdm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the most important idea can be obtained when you visualize the data:</font></font><br>
<br>
<pre><code class="python hljs">fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))<font></font>
<font></font>
<span class="hljs-comment">#    scatter plot        x      y</span><font></font>
<font></font>
plt.scatter(sim_frame.stdev,sim_frame.ret,c=sim_frame.sharpe,cmap=<span class="hljs-string">'RdYlBu'</span>)<font></font>
plt.xlabel(<span class="hljs-string">'Standard Deviation'</span>)<font></font>
plt.ylabel(<span class="hljs-string">'Returns'</span>)<font></font>
plt.ylim(<span class="hljs-number">0</span>,<span class="hljs-number">.0015</span>)<font></font>
plt.xlim(<span class="hljs-number">0.007</span>,<span class="hljs-number">0.012</span>)<font></font>
<font></font>
plt.scatter(max_sharpe[<span class="hljs-number">1</span>],max_sharpe[<span class="hljs-number">0</span>],marker=(<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),color=<span class="hljs-string">'r'</span>,s=<span class="hljs-number">600</span>)<font></font>
<font></font>
plt.scatter(min_std[<span class="hljs-number">1</span>],min_std[<span class="hljs-number">0</span>],marker=(<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),color=<span class="hljs-string">'b'</span>,s=<span class="hljs-number">600</span>)<font></font>
<font></font>
plt.scatter(portfolio_std_dev_robot, portfolio_return_robot,marker=(<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),color=<span class="hljs-string">'g'</span>,s=<span class="hljs-number">600</span>)<font></font>
<font></font>
plt.show()<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/cs/q-/zn/csq-znp2j7yuw6si0x5zgotoq2e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The portfolio with the maximum Sharpe ratio is shown by a red star, blue - with a minimum standard deviation and green - proposed by the robot. </font><font style="vertical-align: inherit;">As you can see, the portfolio proposed by the robot does not coincide with these indicators, but the investor is left with the choice of portfolio. </font><font style="vertical-align: inherit;">And I will try at the end of the year to return to comparing portfolios. </font><font style="vertical-align: inherit;">And now all three portfolios are in drawdown.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500252/index.html">Kaspersky Security Center - New Level</a></li>
<li><a href="../en500254/index.html">We write front-end which works. Or how to become an engineer from a developer. Part 2</a></li>
<li><a href="../en500256/index.html">Dmitry Lebedev: ‚ÄúA few years ago, I clearly understood that a little bit more and OpenStreetMap would sink‚Äù</a></li>
<li><a href="../en500258/index.html">High technology (N.-F. raskaz)</a></li>
<li><a href="../en500260/index.html">About trust</a></li>
<li><a href="../en500264/index.html">National Instruments Launches Free LabVIEW 2020 and NXG 5.0 Community Edition</a></li>
<li><a href="../en500266/index.html">Job search in Germany as a product manager and more. Part 5/5. Interviews. Test tasks. Life Hack Epilogue</a></li>
<li><a href="../en500268/index.html">Fuzzy logic and state machines against the PID controller. Beating the babies continues</a></li>
<li><a href="../en500270/index.html">Decrypt PDF417 without prompts</a></li>
<li><a href="../en500272/index.html">Why do we need DevOps in the field of ML data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>