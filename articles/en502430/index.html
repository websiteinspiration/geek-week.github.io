<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚ÄçüöÄ ü§± üç† Kubernetes best practices. Kubernetes viability test with Readiness and Liveness tests üë∂üèº üî¨ üé≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes best practices. Creating Small Containers 
 Kubernetes Best Practices. Kubernetes organization with a namespace
 
 
 
 Distributed systems ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes best practices. Kubernetes viability test with Readiness and Liveness tests</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/502430/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes best practices. Creating Small Containers </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Best Practices. Kubernetes organization with a namespace</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/2l/kw/qe/2lkwqe-zu3jhaxqfmla1cj65koq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Distributed systems can be difficult to manage due to the fact that they have many movable mutable elements, and all of them must work properly to ensure the functionality of the system. If one of the elements fails, then the system must detect, bypass and fix it, and all this must be done automatically. In this Kubernetes Best Practices series, we will learn how to configure Readiness and Liveness tests to test the viability of a Kubernetes cluster.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Health Check Health Check is an easy way to let the system know if your application instance is running or not. If an instance of your application does not work, then other services should not access it or send requests to it. Instead, the request should be sent to another instance of the application that is already running or will start later. In addition, the system should return your application to lost functionality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, Kubernetes will start sending traffic to the pod when all containers inside the hearths are running, and reload the containers when they crash. For starters, this default behavior of the system can be quite good, but you can increase the reliability of your product deployment using custom health checks.</font></font><a name="habracut"></a><br>
<br>
<img src="https://habrastorage.org/webt/ug/fr/_w/ugfr_wdknpt2o0folyontpio334.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, Kubernetes allows you to do this quite simply, so there are no excuses for ignoring such checks. Kubernetes provides two types of Health Check tests, and it‚Äôs important to understand the differences in each application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Readiness Readiness Test is designed to tell Kubernetes that your application is ready to serve traffic. Before allowing the service to send traffic to the pod, Kubernetes must verify that the availability check is successful. If the Readiness test fails, Kubernetes will stop sending traffic to the pod until the test is successful. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Liveness Viability Test tells Kubernetes whether your application is alive or dead. In the first case, Kubernetes will leave him alone, in the second, he will remove the dead pod and replace it with a new one.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's imagine a scenario in which your application needs 1 minute to ‚Äúwarm up‚Äù and run. Your service will not start working until the application fully loads and starts, although the workflow has already begun. And you will also have problems if you want to increase the scale of this deployment to several copies, because these copies should not receive traffic until they are completely ready. However, by default, Kubernetes will start sending traffic immediately after the start of processes inside the container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using the Readiness readiness test, Kubernetes will wait until the application is fully launched and only after that will allow the service to send traffic to a new copy.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3g/ol/wj/3golwjtf8e-peabrur40nlxmy08.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's imagine another scenario in which an application freezes for a long time, stopping servicing requests. Since the process continues to run, by default Kubernetes will consider that everything is in order and continue to send requests to the non-working pod. But when using Liveness, Kubernetes will detect that the application is no longer serving requests, and by default will restart a non-working pod. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-b/9z/-b/-b9z-bhznyyzrlsz9eh51nrkmmy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider how to test readiness and vitality. There are three test methods - HTTP, ommand, and TCP. You can use any of them for verification. The most common user test method is an HTTP probe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even if your application is not an HTTP server, you can still create a lightweight HTTP server inside your application to interact with the Liveness test. After that, Kubernetes will start pinging the pod, and if the HTTP response is in the range of 200 or 300 ms, it will mean that the pod is ‚Äúhealthy‚Äù. Otherwise, the module will be marked as ‚Äúunhealthy‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vo/uy/pq/vouypq-yjyxuldceusrnb7njndw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For tests using Command, Kubernetes executes the command inside your container. If the command returns with a zero exit code, then the container will be marked as healthy, otherwise, when the exit status number is from 1 to 255, the container will be marked as ‚Äúsick‚Äù. This test method is useful if you cannot or do not want to start the HTTP server, but you are able to run a command that will check the health of your application.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/68/e6/ki/68e6kiogqoollyhciz0zdvdrp0s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final verification mechanism is the TCP test. Kubernetes will try to establish a TCP connection on the specified port. If this can be done, the container is considered healthy, if not, it is not viable. This method may come in handy if you use a script in which testing with an HTTP request or command execution does not work very well. For example, the main services for checking with TCP will be gRPC or FTP.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/or/mt/wpormt0xbafznizmg8ybwgfiay8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tests can be configured in several ways with various parameters. You can specify how often they should be executed, what are the thresholds for success and failure, and how long to wait for answers. See the Readiness and Liveness test documentation for more information. However, there is one very important point in setting up the Liveness test - the initial setting of the initialDelaySeconds test delay. As I mentioned, failing this test will restart the module. Therefore, you need to make sure that testing does not start until the application is ready for use, otherwise it will start to cycle through. I recommend using P99 startup time or the average application startup time from the buffer. Do not forget to adjust this value asas the launch time of your application is getting faster or slower.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most experts will confirm that Health Check is a mandatory check for any distributed system, and Kubernetes is no exception. </font><font style="vertical-align: inherit;">Using the ‚Äúhealth‚Äù check of the services ensures reliable and uptime Kubernetes and does not make any work for users. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be continued very soon ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mxEvAPQRwhw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud-based VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502418/index.html">3D image monitor</a></li>
<li><a href="../en502420/index.html">Interesting CSS Finds in Twitter Design</a></li>
<li><a href="../en502422/index.html">60% reduction in React Native application size in a few simple steps</a></li>
<li><a href="../en502424/index.html">Stop importing whole JavaScript packages</a></li>
<li><a href="../en502428/index.html">Syntactic Goodies Julia</a></li>
<li><a href="../en502432/index.html">The digest of fresh materials from the world of the front-end for the last week No. 415 (May 11-17, 2020)</a></li>
<li><a href="../en502436/index.html">CI TeamCity - Automation of build processes of Android and UI testing</a></li>
<li><a href="../en502438/index.html">Material Python. Custom cards with OpenGL effects</a></li>
<li><a href="../en502440/index.html">Building Applications with Mediapipe</a></li>
<li><a href="../en502442/index.html">PHP Digest No. 180 (May 4 - 18, 2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>