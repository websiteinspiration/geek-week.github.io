<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗒️ 🆑 🤩 Upgrading MySQL (Percona Server) from 5.7 to 8.0 👨🏾‍⚖️ 👈🏿 👷🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Progress does not stand still, so the reasons for upgrading to the latest versions of MySQL are becoming increasingly significant. Not so long ago, in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Upgrading MySQL (Percona Server) from 5.7 to 8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Progress does not stand still, so the reasons for upgrading to the latest versions of MySQL are becoming increasingly significant. </font><font style="vertical-align: inherit;">Not so long ago, in one of our projects, it was time to upgrade cozy Percona Server 5.7 clusters to version 8. </font><font style="vertical-align: inherit;">All this happened on the Ubuntu Linux 16.04 platform. </font><font style="vertical-align: inherit;">How to perform a similar operation with minimal downtime and what problems we encountered during the upgrade - read this article.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any update of the database server is most likely connected with the migration of the database: changes in the requirements for limits on system resources and the correction of the database configurations, which must be cleared of outdated directives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before updating, we will definitely turn to the official documentation:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL 8 release notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade Guide from the MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgrade Guide from Percona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL tutorial on updating replicas and wizards</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And make an action plan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fix configuration files by removing obsolete directives.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Check compatibility with utilities.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update slave databases by installing the package </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update the wizard by putting the same package.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will analyze each item in the plan and see what can go wrong. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMPORTANT! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Galera-based MySQL cluster upgrade procedure has its own subtleties that are not described in the article. </font><font style="vertical-align: inherit;">You should not use this instruction in this case.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1: Checking Configs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In version 8, MySQL was removed </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In fact, it was </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declared obsolete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> back in version 5.7, but now it is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completely deleted</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Accordingly, it is necessary to remove the related directives. </font><font style="vertical-align: inherit;">And for caching queries, you can now use external tools - for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also outdated pro directives were found in the config </font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If in MySQL 5.7 it was possible to select the InnoDB format, then the 8th version already works </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only with the Barracuda format</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our result is the removal of the following directives:</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For verification we will use the Docker image of Percona Server. </font><font style="vertical-align: inherit;">We’ll put the server config in the directory </font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and next create the directories for data and logs. </font><font style="vertical-align: inherit;">Example percona-server configuration test:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Result: either in the Docker logs, or in the directory with the logs - depending on your configs - a file will appear in which the problem directives will be described. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is what we had:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, we still needed to deal with encodings and replace the obsolete directive </font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2: Verifying running installations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are 2 utilities in the update documentation for checking the database for compatibility. </font><font style="vertical-align: inherit;">Their use helps the administrator verify the compatibility of the existing data structure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the classic mysqlcheck utility. </font><font style="vertical-align: inherit;">Simply run:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If no problems are detected, the utility will exit with code 0: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility is available in modern versions of MySQL </font><font style="vertical-align: inherit;">(in the case of Percona, this is a package </font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). It is a replacement for the classic mysql client and combines the functions of the client, the SQL editor and MySQL administration tools. To check the server before updating, you can run the following commands through it:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here are the comments we received: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, nothing critical - just warnings about encodings </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(see below)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The overall result of the implementation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided that the update should go without problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A note on the warnings above that indicate encoding problems. </font><font style="vertical-align: inherit;">The fact is that UTF-8 in MySQL until recently was </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not a “real” UTF-8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since it only stored 3 bytes instead of 4. In MySQL 8, they finally </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decided to fix it</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the alias </font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will soon lead to encoding </font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the old ones the columns in the tables will become </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the future, the encoding </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be deleted, but not in this release. </font><font style="vertical-align: inherit;">Therefore, we decided to fix the encodings already on a working installation of the DBMS, after updating it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 3: Server Updates</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What can go wrong when there is such a chic plan? .. Well aware that the nuances always happen, we conducted the first experiment on the MySQL dev cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As already mentioned, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> highlights the issue of updating MySQL servers with replicas. The bottom line is that at first it’s worth updating all the replicas (slaves), since MySQL 8 can replicate from the version 5.7 wizard. Some difficulty lies in the fact that we use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master &lt;-&gt; master</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode when the remote master is in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read-only</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode </font><font style="vertical-align: inherit;">. That is, in fact, combat traffic enters one data center, and the second is backup. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The topology is as follows: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
upgrade should start with </font><i><font style="vertical-align: inherit;">mysql replica dc 2</font></i><font style="vertical-align: inherit;"> replicas</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and ending up with the mysql master dc 1. server. For better reliability, we stopped the virtual machines, made them snapshots, and stopped the replication with the command just before the update </font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The rest of the update looks like this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each replica restart, adding the config option 3: </font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The fact is that updating the database generates binary logs with updating system tables. </font><font style="vertical-align: inherit;">These directives guarantee that there will be no changes to the application data in the database, and information about updating the system tables will not get into the binary logs. </font><font style="vertical-align: inherit;">This will avoid problems when resuming replication.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install the package </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is important to note that in MySQL 8, you </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do not</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> need to run the command </font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after updating the server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After a successful start, restart the server again - already without the parameters that were added in the first paragraph.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We make sure that replication works successfully: we check </font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and see that the tables with counters in the application database are updated.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this looks quite simple: the dev update was successful. </font><font style="vertical-align: inherit;">Ok, you can safely plan an overnight upgrade for production.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was no sadness - we updated prod</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, porting the successful dev experience to production was not without surprises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, the update process itself begins with replicas, therefore, having encountered difficulties, we stopped work and restored the replica from the snapshot. The problem study was rescheduled the next morning. The following entries appeared in the logs:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A study of the archives of various mailing lists on Google led to the understanding that such a problem arises due to a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL bug</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Although rather it is even a utility bug </font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that MySQL has changed the way data is presented for decimal fields (int, tinyint, etc.), so another way to store them is used inside mysql-server. If your database </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was originally</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in version 5.5 or 5.1, and then you upgraded to 5.7, then you may need to produce </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some tables. Then MySQL will update the data files, transferring them to the current storage format. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also check this with the utility </font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If </font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you have 0, then the old type is used in the table - it must be done </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, if the value is 246, you already have a new type. More information about the types can be found in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this bug</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considers the second possible reason that has bypassed us - the lack of InnoDB tables in the system table </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, if they, tables, were created in version 5.1. To avoid problems during the upgrade, you can use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attached SQL script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why didn’t we have such problems on dev? The base is periodically copied there from production - thus, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tables are recreated</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, on a really working large database it will not work just to take and perform the ubiquitous one </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Percona-toolkit will help here: the pt-online-schema-change utility is excellent for the online OPTIMIZE operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The updated plan was as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimize all tables.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perform a database upgrade.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check it and at the same time find out the update time, we disabled one of the replicas, and for all the tables we ran the following command:</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The tables are updated without long locks due to the fact that the utility creates a new temporary table into which it copies the data from the main table. </font><font style="vertical-align: inherit;">At the moment when both tables are identical, the original table is locked and replaced by a new one. </font><font style="vertical-align: inherit;">In our case, a test run showed that updating all the tables would take about a day, but copying the data caused too much load on the disks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid this, at production we added an argument </font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a value of 10 </font><font style="vertical-align: inherit;">to the command </font><font style="vertical-align: inherit;">- this parameter controls the length of the wait after transferring a packet of data to a new table. </font><font style="vertical-align: inherit;">This way you can reduce the load if a really running application is demanding for response time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After performing the optimization, the update was successful.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... but not completely!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Half an hour after the update, the client came up with a problem. </font><font style="vertical-align: inherit;">The base worked very strange: periodically, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connection drops</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> began </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here's what it looked like in the monitoring: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sawtooth graph is visible in the screenshot, due to the fact that part of the threads of the MySQL server periodically fell with an error. </font><font style="vertical-align: inherit;">Errors appeared in the application:</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quick inspection of the logs revealed that the mysqld daemon could not obtain the required resources from the operating system. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">While dealing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with errors, we found in the system </font><b><font style="vertical-align: inherit;">“orphan” apparmor policy files</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These files were formed during the upgrade to MySQL 5.7 a couple of years ago and belong to the remote package. </font><font style="vertical-align: inherit;">Deleting files and restarting the apparmor service solved the problem:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any, even the simplest operation, can lead to unexpected problems. </font><font style="vertical-align: inherit;">And even having a well-thought-out plan does not always guarantee the expected result. </font><font style="vertical-align: inherit;">Now, in any update plans, our team also includes the mandatory cleaning of extra files that could appear as a result of recent actions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And with this not-so-professional graphic work, I would like to thank Percona for their great products!</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Databases and Kubernetes (review and video report)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes tips &amp; tricks: speeding up the bootstrap of large databases</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 practical stories from our SRE-everyday life</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Redis  K8s  -      </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  MongoDB  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500694/index.html">68 unsolicited tips</a></li>
<li><a href="../en500696/index.html">How running shoes are trying to adapt to the female foot</a></li>
<li><a href="../en500698/index.html">Evgeny Katyshev: “OpenStreetMap is not suitable for any information”</a></li>
<li><a href="../en500700/index.html">Support for TLS1.3 and expansion of your personal account: what has been done for the first quarter of 2020</a></li>
<li><a href="../en500704/index.html">Unicorns (Airbnb, Uber, Lyft, Careem) lay off thousands of employees amid problems during the coronavirus pandemic</a></li>
<li><a href="../en500708/index.html">Security and DBMS: what you need to remember when choosing protection tools</a></li>
<li><a href="../en500712/index.html">Digital Coronavirus - A Combination of Ransomware and Infostealer</a></li>
<li><a href="../en500718/index.html">EPAM in remote mode: how it works</a></li>
<li><a href="../en500720/index.html">New information security standards: make life more difficult for attackers</a></li>
<li><a href="../en500722/index.html">“Bake until ready”: who saves rare tape recordings in such an unusual way</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>