<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß üë©üèΩ‚Äçüé® üñïüèø CI / CD Process Update: teamcity üé´ üë®üèø‚Äçüç≥ üëßüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second article in a series about updating CI / CD processes. Up to this point, preparations were being made for setting up new tools, name...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CI / CD Process Update: teamcity</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496342/"><img src="https://habrastorage.org/webt/cu/y-/hg/cuy-hgxvywohqkg_tbyr2wn268c.png" alt="image" align="left" width="300"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the second article in a series about updating CI / CD processes. Up to this point, preparations were being made for setting up new tools, namely: planning, daily rallies, resolving disagreements, in general, all without which it would not be possible to competently build a work process. And now, all issues have been resolved, we are confident that we can continue development, and our code will not sink into the black hole with the beginning of summer.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me remind you the table of contents of the list of articles, as well as brief results of the previous part. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1: what is, why it is not like, planning, a little bash.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I would call this part near-technical. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2: teamcity. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 3: octopus deploy.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Part 4: behind the scenes. Unpleasant moments, plans for the future, possibly FAQ. Most likely, it can also be called near-technical.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We provided the customer with a proof-of-concept of a new update delivery system, identified the shortcomings of the existing system, selected the basis for the new one, made a transition plan and converted our mercurial repository to git. Also, in the previous part, we described the features of the project that will affect the entire subsequent process.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As mentioned earlier, the existing solution did not meet modern requirements. Initially, most likely, one build was configured in ccnet. The very first build with which it all started (like a big bang, yeah). Then, apparently, the person who set it all up, pressed ctrl + c, ctrl + v, corrected a couple of lines, and received a new configuration. And for all the subsequent time, this was done a sufficient number of times so that the source code on the build server took up more than 60G. And these are just the source! And there are logs, build artifacts, temporary files, and so on. Only this made me think. Looking at the old system, one could see the following: a build step was performed for each module. In fact, the same core was assembled. And this assembly was stored for each module (along with source) on the server.The build results (90% identical) were pushed into local repositories (git deployment), and also, of course, took their place. It was possible and necessary to leave this.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General settings&nbsp;</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, it is assumed that there is already a configured teamcity and octopus. </font><font style="vertical-align: inherit;">At the stage of installation and configuration, we do not stop in detail. </font><font style="vertical-align: inherit;">For convenience, we write down the url and api-token of the octopus in env teamcity, which, by the way, for the root project looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/vw/ir/savwiryxdsw8fpgrgvdzavejho0.png" alt="image"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserPassword</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are api accesses to the teamcity user (will be needed later), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.buildPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env .sourcePath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - default paths to build files and source files, respectively, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoApiKey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - token and octopus url. </font><font style="vertical-align: inherit;">They still </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.teamcityUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> added. </font><font style="vertical-align: inherit;">Well, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tt.exe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- path to the text transform utility. </font><font style="vertical-align: inherit;">This utility generates all configurations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of the third-party plugins, only Octopus Deploy integration is installed.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to overload the already huge amount of text, only those steps in which there is something worth attention will be examined in detail. </font><font style="vertical-align: inherit;">It is assumed that everything else is understandable based on the data presented and the knowledge of the reader. </font><font style="vertical-align: inherit;">In any case, if you have any questions, I will be happy to answer them.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project breakdown, versioning, names</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result was such a project scheme (as a picture, because there is a problem with displaying a multilevel list): </font></font><br>
<img src="https://habrastorage.org/webt/-4/oq/gh/-4oqghadht5sr4rdpk7f3igz5do.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will version the packages as follows: major.minor.patch, where major is so far 1, minor is the build counter from the Build configuration, patch is the build counter for the configuration Deploy (not needed for Build configuration, therefore always 0). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> old version is described here. We are redesigning it so that it is based on the git tag. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3v/kl/ov/3vklovvjqjnhwa8yg0b3lxtduns.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, here 1 is major, 95 is minor, and 1 is patch.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the new process for modules there will be one build which will then be deployed to each module. That is, the source code is stored in a single copy for each environment, the build result is also, since it is common for all modules. Unique configurations and libraries are packaged in an individual package at the deployment stage. This will effectively use disk space and reduce the delivery time of each package. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the preparation stage, there was a separate short meeting on the convention of naming configuration files. It used to be (it was just), but not always the same. In addition, the configuration name did not always contain enough information. As a result, all configuration names were as follows: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigurationType.Environment.ModName.config</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where ConfigurationType can be AppSettings, Web, etc. </font><font style="vertical-align: inherit;">Environment - development, test, staging, production. </font><font style="vertical-align: inherit;">ModName is the unique name of the module.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modules</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All Modules projects work on the same principle.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every environment has a Build configuration that:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performs nuget restore (NuGet installer, nuget restore)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generates configs (Command Line, text transform)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buildit solution (Visual studio sln)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Picks up files from env.buildPath in zip and pushes it into octopus (Octopus deploy: push packages)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Release creation (no deploy) (Octopus deploy create release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resets the patch version (powershell)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are also deploy configurations that work based on the template and do the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Picks up the configs that were generated at the build stage (step 2) (Octopus deploy push packages)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy core release (which was created in step 6 of the build) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment individual release (which was created in step 1 of the current configuration) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Displays a list of all domains for this module in the log (step for the convenience of the tester and developer). </font><font style="vertical-align: inherit;">(Powershell).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each deploy configuration, the build configuration is added to the dependency. </font><font style="vertical-align: inherit;">This makes it possible to automatically launch the build when it is deployed if it is not relevant, as well as the ability to reset the patch version. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deploy_all configuration. </font><font style="vertical-align: inherit;">In fact, this is a build chain which describes that you first need to run build if it is not relevant, and then simultaneously install all the modes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ps/ck/rqpsckl2g8rrt9voltbt082itcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's </font><font style="vertical-align: inherit;">look at </font><font style="vertical-align: inherit;">some of the steps in a bit more detail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.General settings</font></font></h3><br>
<img src="https://habrastorage.org/webt/g_/5j/b9/g_5jb95h7ei6qexbvckqd8sxs7e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From unusual only build number format. </font><font style="vertical-align: inherit;">Will be explained later.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.env</font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/nr/bx/a4nrbxt_8ol6yjuo64npqfxuota.png" alt="image"><br>
<br><font style="vertical-align: inherit;"></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
interest here are: </font><i><font style="vertical-align: inherit;">env.coreProjectName</font></i><font style="vertical-align: inherit;"> - set for the entire project. </font><font style="vertical-align: inherit;">Needed to identify the project in octopus. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.Environment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - set for the Modules subproject. </font><font style="vertical-align: inherit;">It is necessary to select the correct configs depending on the environment. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoChannel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the channel in the octopus into which the packet falls. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as </font><i><font style="vertical-align: inherit;">env.Environment</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.serviceName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of the solution. </font><font style="vertical-align: inherit;">Basically, the variable is added for ease of visualization. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantRoleTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">tenant</font></i><font style="vertical-align: inherit;"> tag in the octopus. </font><font style="vertical-align: inherit;">More details in the octopus section.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.4 </font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/da/r1/a4dar1z6_kawzfttqbuvoivu_mm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add to the archive with the name </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% env.serviceName%.% Build.number% .zip</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> files from the directory with the result of the build, excluding all configurations, and dll from the bin / native folder. </font><font style="vertical-align: inherit;">The last ones were manually added to the web server once and nobody will touch them again. </font><font style="vertical-align: inherit;">If necessary, they will also be updated manually (for this it is planned to write a separate script, but we will be honest). </font><font style="vertical-align: inherit;">This is due to the fact that these libraries are ‚Äúheld‚Äù by the IIS pool, and for a successful deployment it must be stopped and then launched, which takes some time. </font><font style="vertical-align: inherit;">By excluding these libraries from the deployment, we can skip the step of stopping the pool, which will reduce the time of the deployment, and, accordingly, downtime.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.5</font></font></h3><br>
<img src="https://habrastorage.org/webt/us/hu/zx/ushuzxwer8u3iwqnuuqpjbuoodo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think everything is clear here, except for why the Environment field is empty. </font><font style="vertical-align: inherit;">In what env the package gets, the octopus makes a decision based on the pre-release tag (configured in the channels). </font><font style="vertical-align: inherit;">This tag is contained in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.number%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the same -staging on the screen in Build.General). </font><font style="vertical-align: inherit;">So in this case it turned out to be more convenient. </font><font style="vertical-align: inherit;">It is also worth paying attention to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúShow deployment process‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> checkbox </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If it is not installed, timsity considers the build successful as soon as the octopus has begun (but not finished!) The work. </font><font style="vertical-align: inherit;">That is, if the checkbox is not installed and something went wrong at the deployment stage - without looking at the octopus interface we won‚Äôt know about it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.6</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nothing unusual, just a powershell script and information from the teamcity documentation.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$pair</span> = <span class="hljs-string">"%env.apiUserName%:%env.apiUserPassword%"</span>
<span class="hljs-variable">$encodedCreds</span> = [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::ASCII.GetBytes(<span class="hljs-variable">$pair</span>))
<span class="hljs-variable">$basicAuthValue</span> = <span class="hljs-string">"Basic <span class="hljs-variable">$encodedCreds</span>"</span>
<span class="hljs-variable">$depUri</span>=<span class="hljs-string">"%env.teamcityUrl%/app/rest/buildTypes?locator=snapshotDependency:(from:(build:(id:%teamcity.build.id%)),includeInitial:false)"</span>
<span class="hljs-comment"># Get all dependencies of main build</span>
<span class="hljs-variable">$result</span> = (<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$depUri</span>)
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$i</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$result</span>.buildTypes.buildType.Count) { <span class="hljs-variable">$buildId</span> += <span class="hljs-variable">$result</span>.buildTypes.buildType.id }
<span class="hljs-variable">$buildId</span> = <span class="hljs-variable">$buildId</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">'Module_DeployAll'</span> }
<span class="hljs-comment"># Reset all child build counters to 1. This build counters are patch versions in every build. (1.build.patch)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buildId</span>.Count; <span class="hljs-variable">$i</span>++) {
  <span class="hljs-variable">$buildCounterUri</span> = <span class="hljs-string">"%env.teamcityUrl%/httpAuth/app/rest/buildTypes/"</span>+<span class="hljs-variable">$buildId</span>[<span class="hljs-variable">$i</span>]+<span class="hljs-string">"/settings/buildNumberCounter"</span>
  <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Method</span> Put <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'accept'</span>=<span class="hljs-string">'text/plain'</span>; <span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$buildCounterUri</span> <span class="hljs-literal">-ContentType</span> <span class="hljs-string">"text/plain"</span> <span class="hljs-literal">-Body</span> <span class="hljs-number">1</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we need an api user in teamcity (env is created for him). </font><font style="vertical-align: inherit;">We log in, take all the configurations that are dependent on the Build configuration, and reset their build counter to 1. That is, in fact, for each patch version, this is an indicator of how many times the same build was deployed for a particular module. </font><font style="vertical-align: inherit;">If there is not 1, it means something went wrong with the process of deploying or working the module on the current version, and requires attention.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.General</font></font></h3><br>
<img src="https://habrastorage.org/webt/aa/lx/p4/aalxp4uzeiofjnfo0tfdx57z0cs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Version format: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.% dep.Module_Build.build.counter%.% Build.counter% -staging</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the teamcity system variable whose value corresponds to the build counter of the corresponding Build configuration (should be added to dependencies). </font><font style="vertical-align: inherit;">In fact, here 1 is the major version, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is minor, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is patch. </font><font style="vertical-align: inherit;">staging is a pre-release tag.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.Env</font></font></h3><br>
<img src="https://habrastorage.org/webt/wl/lc/sv/wllcsv3zxji40gzu-p1ef-vlgu4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When adding a new module, only the configuration for its deployment is added and the value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is </font><i><font style="vertical-align: inherit;">indicated</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All other variables are inherited from the parent projects. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantModTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">for an octopus is formed from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.2</font></font></h3><br>
<img src="https://habrastorage.org/webt/zt/yx/2q/ztyx2q7ffqxfpwxtsrrol6ojfqy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deploy core package.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Release number latest - use the latest available release for this environment. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenant tag - client / organization tag. </font><font style="vertical-align: inherit;">More details in the octopus section. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Additional cli parameters. </font><font style="vertical-align: inherit;">Here we indicate the channel in which our package will fall, as well as additional parameters. </font><font style="vertical-align: inherit;">This will also be discussed separately in the octopus section.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like Deploy.2, only an individual module package is deployed.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This step will also be described in detail below, because it receives data from octopus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configurations for the Company website and Special module are built on the same principle, and the main points in them are the same, so I do not see the point of describing them in the same detail. They are one, they do not need to be deployed many times, and in fact there is nuget restore, text transform, msbuild, octopus push, octopus create release + deploy.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Learn more about unique configurations. </font><font style="vertical-align: inherit;">For some mods, there may not be any environments (for example, staging), they must be deployed to other servers, or you must manually set the client ID (take the base config and change some fields in it using powershell). </font><font style="vertical-align: inherit;">That is, they work on the same principle as the main modules. </font><font style="vertical-align: inherit;">Their uniqueness lies in the fact that steps are added / changed for them, or the deployment server is changed and they do not fit into the template, so it takes a little longer to create them. </font><font style="vertical-align: inherit;">Fortunately, there are few of them.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teamcity: Summary</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The implementation of teamcity allowed a more optimal approach to the application assembly process. Now it takes much less time: instead of building the same code each time, we build it once. We also make better use of disk space, network traffic, and computing time. Previously, the number of packages for deployment (repositories with artifacts) was equal to the number of modules. Each package weighed approximately 100M in compressed form. Now we have the number of packages one more than the number of modules, with one package weighing about the same 100M, and the rest about 500K. Plus a more user-friendly interface, convenient logs, and most importantly - reducing the time to maintain the build system and adding configurations. Now adding a new module takes from 15 minutes to half an hour.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Separately, it should be said about the templates, since it is the standardization that allows us to save time on the creation of new configurations and their further maintenance. All configurations for interacting with octopus (deploy) are built on the basis of a single template. Firstly, it allows to unify, and therefore simplify the process. Secondly, as already mentioned, it saves time on adding new configurations: we‚Äôve connected a template, changed one variable, and that's it. And most importantly, templates simplify maintenance. All changes made to the template are inherited by configurations based on it. So, if we need to add some step to all the configurations at once, we don‚Äôt need to click them all, just add this step to the template.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturally, the teamcity setup process went hand in hand with the octopus setup. </font><font style="vertical-align: inherit;">It is simply impossible to describe in parallel in the text, since there is a great chance of confusion. </font><font style="vertical-align: inherit;">Therefore, the description has been shared, and in this part only the steps for providing CI are described. </font><font style="vertical-align: inherit;">The octopus setup process will be described in the following.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496332/index.html">Antidron: reflection of UAV and quadrocopter attacks</a></li>
<li><a href="../en496334/index.html">Dell U4919DW Review: Ultra-Wide 49-inch Curved Screen Monitor</a></li>
<li><a href="../en496336/index.html">What are smart meters for?</a></li>
<li><a href="../en496338/index.html">Crisis and that's it</a></li>
<li><a href="../en496340/index.html">We train generative-competitive network for drawing pictures on Azure ML</a></li>
<li><a href="../en496344/index.html">Is quarantine online hackathons the right time?</a></li>
<li><a href="../en496346/index.html">We add a rootkit hunter hash check into the daily script</a></li>
<li><a href="../en496348/index.html">Web Storage API Case Studies</a></li>
<li><a href="../en496350/index.html">You shall not pass! - 3D printers answer to coronavirus</a></li>
<li><a href="../en496354/index.html">Ternary computer programming: play with the emulator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>