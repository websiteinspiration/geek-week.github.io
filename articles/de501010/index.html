<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèª ‚úåüèº ‚è∞ Linux Kernel TLS und Nginx üë®üèæ‚ÄçüöÄ üéµ üêñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werde ich √ºber die Entwicklungsgeschichte und den aktuellen Stand der Technik zur Beschleunigung der Verteilung von Inhalten in TLS-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux Kernel TLS und Nginx</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501010/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Artikel werde ich √ºber die Entwicklungsgeschichte und den aktuellen Stand der Technik zur Beschleunigung der Verteilung von Inhalten in TLS-Verbindungen durch √úbertragung der Verschl√ºsselung auf den Kern des Betriebssystems sowie √ºber meinen Beitrag zur Entwicklung dieser Richtung sprechen.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bereits 2015 pr√§sentierten Randall Stewart und Scott Long von Netflix auf der AsiaBSDCon2015- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konferenz die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimierung der Verteilung verschl√ºsselter Inhalte. Die Hauptnachricht des Berichts besteht darin, die Datenverschl√ºsselung an den Kernel des Betriebssystems zu √ºbertragen, um die Anzahl der Datenkopien zwischen Kernel-Space und User-Space zu verringern und den optimierten nicht blockierenden sendfile () -Systemaufruf zu verwenden. Das Thema erwies sich als sehr vielversprechend und bereits auf der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netdev 1.2-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konferenz 2016 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">hielt</font></a><font style="vertical-align: inherit;"> Dave Watson von Facebook eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√§sentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √ºber die Notwendigkeit, TLS-Sockets im Linux-Kernel zu erstellen, und Boris Pismenny, Ilya Lesokhin und Liran Liss von Mellanox </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Pr√§sentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ºber die F√§higkeit, TLS-Hardwarebeschleunigung in Netzwerkkarten zu verwenden. </font><font style="vertical-align: inherit;">Das Thema wurde auch auf der HighLoad ++ 2017 von einem Redner von Tempesta Technologies diskutiert.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux-Kernel-Unterst√ºtzung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis all dieser Gespr√§che war das Erscheinen von Kernel TLS im Linux 4.13-Kernel (2017) mit Unterst√ºtzung f√ºr TLSv1.2 und die AES128-GCM-Verschl√ºsselung. </font><font style="vertical-align: inherit;">Anf√§nglich wurde nur die Verschl√ºsselung des ausgehenden Datenverkehrs unterst√ºtzt, die Entschl√ºsselungsunterst√ºtzung wurde sp√§ter im Linux-Kernel 4.17 (2018) angezeigt. </font><font style="vertical-align: inherit;">In Version 5.1 wurde die Unterst√ºtzung f√ºr TLSv1.3 und AES256-GCM hinzugef√ºgt, und in Version 5.2 wurde auch die AES128-CCM-Verschl√ºsselung (2019) hinzugef√ºgt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterst√ºtzung im User-Space</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In allen oben genannten Berichten wurde gesagt, dass nur die Verschl√ºsselung n√ºtzlicher Daten im Kernel platziert werden kann und alle TLS-Genehmigungen und Kontrollnachrichten im Benutzerbereich gleich verarbeitet werden m√ºssen. Und daf√ºr wurde eine modifizierte Version von OpenSSL verwendet. Zum Zeitpunkt der Ver√∂ffentlichung der Berichte im √∂ffentlichen Bereich gab es jedoch keine Informationen dar√ºber, welche √Ñnderungen an dieser bekannten Bibliothek vorgenommen werden mussten, um die Funktionalit√§t zu unterst√ºtzen. Das vielleicht einzige verf√ºgbare Beispiel f√ºr die Verwendung von Linux-Kernel-TLS war der Blog-Artikel Filippo Valsorda </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spielen mit Kernel-TLS in Linux 4.13 und Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die unmittelbar nach der Ver√∂ffentlichung des Linux 4.13-Kernels erschien. </font><font style="vertical-align: inherit;">Und obwohl es ein g√ºltiges Beispiel f√ºr den Einsatz von Technologie zeigte, brachte es kein Verst√§ndnis daf√ºr, wie die Technologie in realen Projekten eingesetzt werden kann. </font><font style="vertical-align: inherit;">Immerhin schreiben nur sehr wenige Leute einen WEB-Server f√ºr ihr Projekt selbst, normalerweise verwendet jeder bekannte und bew√§hrte Tools.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterst√ºtzung in OpenSSL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ersten Diskussionen √ºber die Technologie in OpenSSL wurden im Sommer 2017 kurz vor der Ver√∂ffentlichung des Linux 4.13-Kernels ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR 3631</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ver√∂ffentlicht, aber der Diskussionsprozess war sehr, sehr langsam, die ersten echten Kommentare erschienen im Oktober (nach der Ver√∂ffentlichung des 4.13-Kernels) und der tats√§chlichen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeitsversion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Diskussion begann im Februar 2018. Als alle Korrekturen vereinbart waren, wurde das Fenster zum Hinzuf√ºgen neuer Funktionen in OpenSSL 1.1.1 geschlossen und die Unterst√ºtzung f√ºr Kernel TLS auf die n√§chste Version verschoben. </font><font style="vertical-align: inherit;">Seitdem wurde die Kernel-TLS-RX-Unterst√ºtzung hinzugef√ºgt, und SSL_sendfile () ist ein Aufruf des entsprechenden Systemaufrufs mit einer kleinen Verarbeitung m√∂glicher Situationen im TLS-Protokoll. </font><font style="vertical-align: inherit;">Aber jetzt im Jahr 2020 ist OpenSSL 3.0 noch nicht herausgekommen, TLSv1.3 wird von der √ºberwiegenden Mehrheit der Browser unterst√ºtzt, und die AES128-GCM-Verschl√ºsselung wird aktiv durch die widerstandsf√§higere AES256-GCM ersetzt. </font><font style="vertical-align: inherit;">Also nahm ich mir die Freiheit und schickte eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pull-Anfrage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um neue Chiffren und TLSv1.3 zu unterst√ºtzen, in der Hoffnung, dass sie diese vor der neuen Ver√∂ffentlichung der Bibliothek akzeptieren w√ºrden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterst√ºtzung in WEB-Servern</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Unterst√ºtzung von Kernel-TLS in der TLS-Bibliothek reicht jedoch nicht aus. Berichten √ºber die Technologie zufolge kann durch Senden eine maximale Effizienz erzielt werden, ohne dass Daten in den Benutzerbereich kopiert werden m√ºssen - mithilfe des Systemaufrufs sendfile (). Die Serveranwendung sollte in der Lage sein, zwischen Situationen zu unterscheiden, in denen Sie sendfile () f√ºr einen Socket mit TLS verwenden k√∂nnen, und in denen Sie read () / SSL_write () auf die alte Weise lesen m√ºssen. Einige Fortschritte beim Hinzuf√ºgen von Funktionen zu Nginx wurden im April 2019 erzielt, es wurden jedoch keine √Ñnderungen am Hauptcode akzeptiert. Die Position der Entwickler ist, dass die API f√ºr diese Funktionen in OpenSSL noch nicht genehmigt ist und der im Patch vorgeschlagene Code auf verschiedenen Plattformen nicht portabel genug zu sein scheint. Um ehrlich zu sein, sieht der Code nicht nur nicht sehr gut aus, sondern enth√§lt auch Fehler, die verhindern, dass Nginx ohne zus√§tzliche Korrekturen erstellt wird.Ich konnte die Kernel-TLS-Unterst√ºtzung auf anderen Webservern √ºberhaupt nicht finden (vielleicht hat es jemand gesehen - sagen Sie es mir in den Kommentaren).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und was zu tun?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
W√§hrend die Community auf die Ver√∂ffentlichung von OpenSSL 3.0 wartet, bin ich in die andere Richtung gegangen, um Unterst√ºtzung f√ºr Kernel TLS in Nginx mit einer stabilen API zu entwickeln. </font><font style="vertical-align: inherit;">In meiner </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gem√ºtlichen Ecke von</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GitHub habe ich zwei Dinge getan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe einen </font><font style="vertical-align: inherit;">OpenSSL- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fork erstellt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und alles, was mit Kernel-TLS zu tun hat, auf die stabile Version von OpenSSL 1.1.1 (OpenSSL_1_1_1-ktls-Zweig) zur√ºckportiert. </font><font style="vertical-align: inherit;">Insbesondere, um die Funktionalit√§t unter stabilen Betriebsbedingungen des Restes der Bibliothek √ºberpr√ºfen zu k√∂nnen. </font><font style="vertical-align: inherit;">Sobald stabile Versionen verf√ºgbar sind, versuche ich, die Basis neu zu erstellen, damit die Gabel auf dem neuesten Stand ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verzweigung von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nginx erstellt, in der ich (basierend auf einem Patch von Mellanox) Unterst√ºtzung f√ºr das Aufrufen von SSL_sendfile () unter Bedingungen hinzugef√ºgt habe, unter denen dies wirklich m√∂glich ist und mit den erforderlichen SSL-Socket-√úberpr√ºfungen und der M√∂glichkeit, die Funktionalit√§t √ºber die Konfigurationsvariable zu aktivieren / deaktivieren. </font><font style="vertical-align: inherit;">Zus√§tzlich zu dieser Funktion gibt es in meiner Gabelung auch einige Patches, die die Arbeit von Nginx ein wenig optimieren und einige Fehler beheben (Master-Feature-Zweig). </font><font style="vertical-align: inherit;">Ich versuche so weit wie m√∂glich, basierend auf dem Hauptzweig des Nginx-Hauptrepos eine Neubasis zu erstellen, um die Gabel auf dem neuesten Stand zu halten.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich lade alle ein, an Tests teilzunehmen. </font><font style="vertical-align: inherit;">Kommentare und Korrekturen zum Code k√∂nnen bei Issues on GitHub ausgegeben werden. </font><font style="vertical-align: inherit;">F√ºgen Sie dem Konfigurationsskript Parameter hinzu, um diesen Nginx mit dieser OpenSSL und der enthaltenen Kernel-TLS-Unterst√ºtzung zu erstellen:</font></font><br>
<br>
<pre><code class="bash hljs">./configure --with-openssl=&lt;OpenSSL-fork-dir&gt; --with-openssl-opt=<span class="hljs-string">"enable-ktls"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Moment habe ich keine Gelegenheit, dieses Nginx + OpenSSL-Bundle unter hoher Last zu testen, um die Leistung anhand des Kommentars zum Nginx-Patch zu best√§tigen. Wenn also pl√∂tzlich jemand den Unterschied in der CPU-Auslastung bei hohen Upload-Geschwindigkeiten f√ºr Dateien messen kann, w√§re es gro√üartig, Grafiken zu erhalten und hinzuzuf√ºgen sie in einen Artikel f√ºr ein visuelles Verst√§ndnis des Effekts.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500996/index.html">So werden Sie in sechs Monaten oder noch schneller DevOps-Ingenieur. Teil 1. Einf√ºhrung</a></li>
<li><a href="../de501002/index.html">Umka: Neue statisch typisierte Skriptsprache</a></li>
<li><a href="../de501004/index.html">Tu es. Arbeit</a></li>
<li><a href="../de501006/index.html">Wir sind Freunde STM32 mit LCD-Anzeige 1604 am I2C-Bus (HAL-Bibliothek)</a></li>
<li><a href="../de501008/index.html">Dominos Pflaster</a></li>
<li><a href="../de501012/index.html">Wie ich nach einer Kindermaschine f√ºr einen Blog gesucht habe</a></li>
<li><a href="../de501016/index.html">√úber die Entwicklungstrends der Prozessorarchitektur oder warum ich an den Erfolg von Huawei auf dem Servermarkt glaube</a></li>
<li><a href="../de501018/index.html">So umgehen Sie einige Einschr√§nkungen bei der Google-√úbersetzung</a></li>
<li><a href="../de501020/index.html">So testen Sie Code mit setTimeout / setInterval unter der Haube</a></li>
<li><a href="../de501022/index.html">‚ÄûIch bin in der W√ºste‚Äú: Warum sich Selbstisolation als ernsthafter Stress f√ºr uns herausstellte und was alles dazu f√ºhrte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>