<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆘 ☃️ ✍️ Les bugs notoires et comment les éviter sur l'exemple de ClickHouse 🏟️ ⏹️ 🏔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous écrivez du code, préparez-vous aux problèmes. Ils le seront certainement, et ils devraient être attendus de tous les côtés: de votre code et d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Les bugs notoires et comment les éviter sur l'exemple de ClickHouse</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497334/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous écrivez du code, préparez-vous aux problèmes. </font><font style="vertical-align: inherit;">Ils le seront certainement, et ils devraient être attendus de tous les côtés: de votre code et de votre compilateur, du système d'exploitation et du matériel, et les utilisateurs lèvent parfois des «surprises». </font><font style="vertical-align: inherit;">Si vous avez fait évoluer le cluster aux échelles cosmiques, attendez-vous à des bogues "d'espace". </font><font style="vertical-align: inherit;">Surtout quand il s'agit de données provenant du trafic Internet.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ooBAQIe0KlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey Milovidov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) parlera des problèmes les plus ridicules, décourageants et désespérés de son expérience dans le développement et le support de ClickHouse. </font><font style="vertical-align: inherit;">Voyons comment ils ont dû être débogués et quelles mesures les développeurs devraient prendre dès le début, afin qu'il y ait moins de problèmes.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues notoires</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez écrit du code, préparez-vous immédiatement aux problèmes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreurs dans le code.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ils seront nécessaires. Mais disons que vous avez écrit le code parfait, compilé, mais des bogues apparaîtront </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le compilateur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le code ne fonctionnera pas correctement. Nous avons corrigé le compilateur, tout compilé - exécutez-le. Mais (de manière inattendue) tout fonctionne de manière incorrecte, car </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a aussi des bogues dans le noyau du système d'exploitation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il n'y a pas de bogues dans le système d'exploitation, ils seront inévitablement liés </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au matériel</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Même si vous avez écrit le code parfait qui fonctionne parfaitement sur le matériel parfait, vous rencontrerez toujours des problèmes, par exemple </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des erreurs de configuration</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il semblerait que vous ayez tout fait correctement, mais quelqu'un a fait une erreur dans le fichier de configuration, et tout ne fonctionne plus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque tous les bugs ont été corrigés, les utilisateurs le termineront, car ils utilisent constamment votre code «incorrectement». </font><font style="vertical-align: inherit;">Mais le problème n'est certainement pas dans les utilisateurs, mais dans le code: vous avez </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">écrit quelque chose de difficile à utiliser</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons ces bugs avec quelques exemples.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues de configuration</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppression de données</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le premier cas de la pratique. Heureusement, pas le mien et pas Yandex, ne vous inquiétez pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduction d'abord. L'architecture de réduction de carte d'un cluster (tel que Hadoop) se compose de plusieurs serveurs de données (nœuds de données) qui stockent les données et d'un ou plusieurs serveurs maîtres qui connaissent l'emplacement de toutes les données sur les serveurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les nœuds de données connaissent l'adresse du maître et s'y connectent. L'assistant surveille où et quelles données doivent être localisées et donne différentes commandes aux nœuds de données: «Téléchargez les données X, vous devez avoir les données Y et supprimer les données Z». Qu'est-ce qui pourrait mal se passer?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un nouveau fichier de configuration a été téléchargé sur tous les nœuds de données, ils se sont connectés par erreur au maître à partir d'un autre cluster, et non au leur. </font><font style="vertical-align: inherit;">Le maître a examiné les données dont les nœuds de données ont été informés, a décidé que les données étaient incorrectes et devaient être supprimées. </font><font style="vertical-align: inherit;">Le problème a été constaté lorsque la moitié des données ont été effacées.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/ii/6i/s8ii6igrww4j3zdjhrfyyqrl2nk.png" width="350"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bugs les plus épiques sont ceux qui conduisent à une suppression de données par inadvertance.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éviter cela est très simple. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne supprimez pas les données</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, mettez-le de côté dans un répertoire séparé ou supprimez-le avec un retard. Tout d'abord, nous transférons afin qu'ils ne soient pas visibles pour l'utilisateur, et s'il constate que quelque chose a disparu en quelques jours, nous le retournerons. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne supprimez pas les données inattendues si la cause est inconnue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Limitez par programme le début de la suppression des données inconnues: inattendu, avec des noms étranges, ou s'il y en a trop. L'administrateur remarquera que le serveur ne démarre pas et écrit un message et comprendra. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le programme effectue des actions destructrices - isoler les tests et la production au niveau du réseau</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(iptables). Par exemple, la suppression de fichiers ou l'envoi d'e-mails est une action destructrice car elle «dévorera» l'attention de quelqu'un. Mettez-y un seuil: une centaine de lettres peuvent être envoyées, et pour mille une case à cocher de sécurité, qui est réglée avant que quelque chose de terrible ne se produise. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurations</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le deuxième exemple vient déjà de ma pratique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une bonne entreprise avait en quelque sorte un étrange cluster ClickHouse. L'étrangeté était que les répliques n'étaient pas synchronisées. Lorsque le serveur a été redémarré, il n'a pas démarré et un message est apparu que toutes les données étaient incorrectes: «Il y a beaucoup de données inattendues, je ne démarre pas. Nous devons mettre le drapeau </font></font><code>force_restore_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le comprendre. "</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personne ne pouvait le comprendre dans l'entreprise - ils ont juste mis le drapeau. Dans le même temps, la moitié des données ont disparu quelque part, entraînant des graphiques avec des lacunes. Les développeurs se sont tournés vers moi, j'ai pensé qu'il se passait quelque chose d'intéressant et j'ai décidé d'enquêter. Lorsque le matin est venu quelques heures plus tard et que les oiseaux ont commencé à chanter par la fenêtre, j'ai réalisé que je ne comprenais rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur ClickHouse utilise le service ZooKeeper pour la coordination. ClickHouse stocke les données et ZooKeeper détermine sur quels serveurs les données doivent se trouver: stocke les métadonnées sur les données sur quelle réplique doit se trouver. ZooKeeper est également un cluster - il se réplique selon un très bon algorithme de consensus distribué, avec une cohérence stricte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En règle générale, ZooKeeper est composé de 3 machines, parfois 5. Dans la configuration ClickHouse, toutes les machines sont indiquées en même temps, la connexion est établie avec une machine aléatoire, interagit avec elle et ce serveur réplique toutes les demandes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-il arrivé? L'entreprise disposait de trois serveurs ZooKeeper. Mais ils ne fonctionnaient pas comme un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cluster de trois nœuds</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais comme </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trois nœuds indépendants</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - trois clusters à partir d'un nœud. One ClickHouse se connecte à un serveur et écrit des données. Les répliques souhaitent télécharger ces données, mais elles sont introuvables. Au redémarrage, le serveur se connecte à un autre ZooKeeper: il voit que les données avec lesquelles il fonctionnait auparavant sont superflues, il faut les reporter quelque part. Il ne les supprime pas, mais les transfère dans un répertoire séparé - dans ClickHouse, les données ne sont pas si facilement supprimées.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je décide de corriger la configuration de ZooKeeper. </font><font style="vertical-align: inherit;">Je renomme toutes les données et fais une demande pour des </font></font><code>ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parties des données du répertoire </font></font><code>detached/unexpeted_*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, toutes les données ont été restaurées, les répliques ont été synchronisées, il n'y a eu aucune perte, les graphiques étaient continus. </font><font style="vertical-align: inherit;">L'entreprise est satisfaite, reconnaissante, comme si elle avait déjà oublié comment tout avait mal fonctionné auparavant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont de simples bogues de configuration. </font><font style="vertical-align: inherit;">Plus de bugs seront dans le code.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs dans le code</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous écrivons du code en C ++. </font><font style="vertical-align: inherit;">Cela signifie que nous avons déjà des problèmes.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple suivant est un vrai bug de production sur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le cluster Yandex.Metrica</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2015) - une conséquence du code C ++. </font><font style="vertical-align: inherit;">Le bug était que parfois l'utilisateur au lieu de répondre à la demande recevait un message d'erreur:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Somme de contrôle ne correspond pas, données corrompues» - la somme de contrôle ne correspond pas, les données sont cassées - effrayant!</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache est devenu incohérent. </font><font style="vertical-align: inherit;">Il doit y avoir un bogue »- le cache est devenu incohérent, probablement un bogue.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code que nous avons écrit s'informe qu'il y a un bogue là-bas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"La </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">somme de contrôle ne correspond pas, les données sont corrompues</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." </font><font style="vertical-align: inherit;">Les sommes de contrôle des blocs de données compressés sont vérifiées avant d'être décompressées. </font><font style="vertical-align: inherit;">Habituellement, cette erreur apparaît lorsque les données sont cassées sur le système de fichiers. </font><font style="vertical-align: inherit;">Pour diverses raisons, certains fichiers s'avèrent être des ordures lors du redémarrage du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais voici un autre cas: j'ai lu le fichier manuellement, la somme de contrôle correspond, il n'y a pas d'erreur. </font><font style="vertical-align: inherit;">Une fois apparue, l'erreur est reproduite de manière stable sur demande répétée. </font><font style="vertical-align: inherit;">Lorsque le serveur redémarre, l'erreur disparaît pendant un certain temps, puis réapparaît de manière stable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-être que le problème est en RAM? </font><font style="vertical-align: inherit;">Une situation typique est lorsque des bits y battent. </font><font style="vertical-align: inherit;">Je regarde dans </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dmesg</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(kern.log), mais il n'y a aucune exception de vérification de la machine - ils écrivent généralement quand quelque chose ne va pas avec la RAM. Si le serveur avait battu la RAM, non seulement mon programme ne fonctionnerait pas correctement, mais tous les autres généreraient des erreurs de manière aléatoire. Cependant, il n'y a aucune autre manifestation de l'erreur. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache est devenu incohérent. Il doit y avoir un bug. "</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C'est une erreur claire dans le code, et nous écrivons en C ++ - peut-être un accès mémoire? Mais les tests sous AddressSanitizer, ThreadSanitizer, MemorySanitizer, UndefinedBehaviorSanitizer dans CI ne montrent rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-être que certains cas de test ne sont pas couverts? Je récupère le serveur avec AddressSanitizer, je l'exécute en production - il n'attrape rien. Pendant un certain temps, l'erreur est supprimée en réinitialisant un cache de marque (cache de sachet).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des règles de programmation dit: si ce n'est pas clair ce qu'est le bogue, regardez attentivement le code, en espérant y trouver quelque chose. Je l'ai fait, j'ai trouvé un bogue, l'ai corrigé - cela n'a pas aidé. Je regarde un autre endroit dans le code - il y a aussi un bug. Corrigé, encore une fois n'a pas aidé. J'en ai corrigé quelques autres, le code s'est amélioré, mais l'erreur n'a toujours pas disparu! </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cause.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Essayer de trouver un modèle par serveur, par heure, par la nature de la charge - rien n'y fait. Puis il s'est rendu compte que le problème ne se manifeste que sur l'un des clusters, et jamais sur les autres. L'erreur n'est pas reproduite si souvent, mais elle apparaît toujours sur un cluster après un redémarrage, et tout est propre sur l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est avéré que la raison en est que sur le cluster «problème», ils ont utilisé une nouvelle fonctionnalité - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les dictionnaires de cache</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ils utilisent l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allocateur de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mémoire </font><strong><font style="vertical-align: inherit;">manuscrit ArenaWithFreeLists</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous écrivons non seulement en C ++, mais nous avons également vu une sorte d'allocateurs personnalisés - nous nous condamnons deux fois aux problèmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArenaWithFreeLists est une partie de la mémoire dans laquelle la mémoire est allouée consécutivement dans des tailles divisibles par deux: 16, 32, 64 octets. </font><font style="vertical-align: inherit;">Si la mémoire est libérée, ils forment une liste liée de blocs FreeLists libres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le code.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArenaWithFreeLists</span>
{</span>
    Block * free_lists[<span class="hljs-number">16</span>] {};
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">sizeToPreviousPowerOfTwo</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">return</span> _bit_scan_reverse(size - <span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">char</span> * <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> list_idx = findFreeListIndex(size);<font></font>
        free_lists[list_idx] -&gt;...<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il utilise une fonction </font></font><code>_bit_scan_reverse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un trait de soulignement au début.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe une règle non écrite: "Si une fonction a un trait de soulignement au début, lisez la documentation une fois, et si deux, lisez-la deux fois."</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous écoutons et lisons la documentation: «int _bit_scan_reverse (int a). Définissez dst sur l'index du bit le plus élevé dans un entier 32 bits a. Si aucun bit n'est défini dans a, alors dst n'est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas défini</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . " Nous semblons avoir trouvé un problème. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En C ++, cette situation est considérée comme impossible pour le compilateur. Le compilateur peut utiliser un comportement indéfini, cette «impossibilité», comme hypothèse pour optimiser le code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compilateur ne fait rien de mal - il génère honnêtement des instructions d'assemblage </font></font><code>bsr %edi, %eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si l'opérande est nul, l'instruction a </font></font></strong><code><strong>bsr</strong></code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un comportement indéfini non pas au niveau C ++, mais au niveau CPU.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si le registre source est nul, le registre de destination ne change pas: il y avait des ordures à l'entrée, ces ordures resteront également à la sortie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le résultat dépend de l'endroit où le compilateur place cette instruction. </font><font style="vertical-align: inherit;">Parfois, une fonction avec cette instruction est en ligne, parfois non. </font><font style="vertical-align: inherit;">Dans le deuxième cas, il y aura quelque chose comme ce code:</font></font><br>
<br>
<pre><code class="cpp hljs">bsrl %edi, %eax<font></font>
retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai regardé un exemple de code similaire dans mon utilisation binaire </font></font><code>objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/6k/4f/lq6k4fg0lwpm2nhwhxbyauyjt2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après les résultats, je constate que parfois le registre source et le registre destination sont les mêmes. </font><font style="vertical-align: inherit;">S'il y avait zéro, le résultat sera également nul - tout va bien. </font><font style="vertical-align: inherit;">Mais parfois, les registres sont différents et le résultat sera des ordures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment ce bug se manifeste-t-il?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons les ordures comme index dans le tableau FreeLists. </font><font style="vertical-align: inherit;">Au lieu d'un tableau, nous allons à une adresse distante et obtenons un accès à la mémoire.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons de la chance, presque toutes les adresses à proximité sont remplies de données du cache - nous gâchons le cache. </font><font style="vertical-align: inherit;">Le cache contient des décalages de fichiers.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous lisons les fichiers avec le mauvais décalage. </font><font style="vertical-align: inherit;">Du mauvais décalage, nous obtenons la somme de contrôle. </font><font style="vertical-align: inherit;">Mais il n'y a pas de somme de contrôle, mais autre chose - cette somme de contrôle ne coïncidera pas avec les données suivantes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous obtenons l'erreur «La somme de contrôle ne correspond pas, les données sont corrompues».</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, pas les données sont corrompues, mais seulement le cache en RAM. </font><font style="vertical-align: inherit;">Nous avons été immédiatement informés de l'erreur, car nous avons vérifié les données. </font><font style="vertical-align: inherit;">L'erreur a été </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corrigée</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le 27 décembre 2015 et est allée célébrer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, le mauvais code peut au moins être corrigé. </font><font style="vertical-align: inherit;">Mais comment corriger les bugs dans le matériel?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs en fer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce ne sont même pas des bugs, mais des lois physiques - des effets inévitables. Selon les lois physiques, le fer est inévitablement buggy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture non atomique sur RAID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, nous avons créé RAID1. Il se compose de deux disques durs. Cela signifie qu'un serveur est un système distribué: les données sont écrites sur un disque dur et sur un autre. Mais que se passe-t-il si les données sont écrites sur un disque et que l'alimentation est perdue lors de l'enregistrement sur le second? Les données sur une matrice RAID1 ne seront pas cohérentes. Nous ne pourrons pas comprendre quelles données sont correctes, car nous lirons un octet ou l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez y faire face en plaçant le journal. Par exemple, dans ZFS, ce problème est résolu, mais plus à ce sujet plus tard. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourriture des bits sur disque dur et SSD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Les bits sur les disques durs et sur les SSD peuvent mal tourner comme ça. Les SSD modernes, en particulier ceux avec des cellules à plusieurs niveaux, sont conçus pour garantir que les cellules se détérioreront constamment. Les codes de correction d'erreur aident, mais parfois les cellules se détériorent tellement et tellement que même cela ne sauve pas. Des erreurs non détectées sont obtenues. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit bascule dans la RAM</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mais qu'en est-il ECC?). Dans la RAM des serveurs, les bits sont également corrompus. Il a également des codes de correction d'erreur. Lorsque des erreurs se produisent, elles sont généralement visibles à partir des messages du journal du noyau Linux dans dmesg. Lorsqu'il y a beaucoup d'erreurs, nous verrons quelque chose comme: "N millions d'erreurs de mémoire ont été corrigées." Mais les bits individuels ne seront pas remarqués et, à coup sûr, quelque chose sera bogué. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit bascule au niveau du processeur et du réseau</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a des erreurs au niveau du processeur, dans les caches de processeur et, bien sûr, lors de la transmission de données sur un réseau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment se manifestent généralement les erreurs de fer? Le ticket « </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un znode mal formé empêche ClickHouse de démarrer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » </font><font style="vertical-align: inherit;">arrive à GitHub </font><font style="vertical-align: inherit;">- les données du nœud ZooKeeper sont corrompues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ZooKeeper, nous écrivons généralement certaines métadonnées en texte brut. Il y a quelque chose qui ne va pas avec lui - " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réplique</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " est écrit très étrange. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/gk/zk/8_gkzkxlb1dzwhiph0saer-0d50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il arrive rarement qu'en raison d'un bogue dans le code, un bit change. Bien sûr, nous pouvons écrire un tel code: nous prenons le filtre Bloom, changeons le bit à certaines adresses, calculons les adresses incorrectement, changeons le mauvais bit, il tombe sur certaines données. Ca y est, maintenant ClickHouse ce n'est pas « </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réplique »</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais « </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repli </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » et tout les données est faux. Mais généralement, un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">changement d'un bit est un symptôme de problèmes de fer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous connaissez peut-être l'exemple du bitquatting. </font><font style="vertical-align: inherit;">Artyom Dinaburg a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fait une expérience</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : il y a des domaines sur Internet qui ont beaucoup de trafic, bien que les utilisateurs ne s'y rendent pas seuls. </font><font style="vertical-align: inherit;">Par exemple, un tel domaine FB-CDN.com est un CDN Facebook. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artyom a enregistré un domaine similaire (et bien d'autres), mais a changé d'un bit. </font><font style="vertical-align: inherit;">Par exemple, FA-CDN.com au lieu de FB-CDN.com. </font><font style="vertical-align: inherit;">Le domaine n'a été publié nulle part, mais le trafic y est arrivé. </font><font style="vertical-align: inherit;">Parfois, l'hôte FB-CDN a été écrit dans les en-têtes HTTP et la demande est allée à un autre hôte en raison d'erreurs de RAM sur les appareils des utilisateurs. </font><font style="vertical-align: inherit;">La RAM avec correction d'erreur n'aide pas toujours. </font><font style="vertical-align: inherit;">Parfois, il interfère même et conduit à des vulnérabilités (lire sur Rowhammer, ECCploit, RAMBleed).</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion: vérifiez toujours les données vous-même.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'écriture dans le système de fichiers, vérifiez la somme sans échec. </font><font style="vertical-align: inherit;">Lors de la transmission sur le réseau, vérifiez également le résumé - ne vous attendez pas à ce qu'il y ait des sommes de contrôle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus de bugs! ..</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesures du cluster de production</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les utilisateurs en réponse à une demande obtiennent parfois une exception: «La somme de contrôle ne correspond pas: données corrompues» - la somme de contrôle n'est pas correcte, les données sont corrompues. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/lb/wz/jylbwzqxrbk-g3hgygq4bktgdr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le message d'erreur affiche des données détaillées: quel montant de chèque était attendu, quel montant de chèque se trouve réellement dans ces données, la taille du bloc pour lequel nous vérifions le montant du chèque et le contexte d'exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons reçu le paquet sur le réseau d'un serveur, une exception est apparue - cela semble familier. </font><font style="vertical-align: inherit;">Peut-être encore en passant par la mémoire, la condition raciale ou autre chose.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette exception est apparue en 2015. Le bug a été corrigé, il n'est plus apparu. En février 2019, il est soudainement réapparu. A cette époque, j'étais à l'une des conférences, mes collègues ont traité le problème. L'erreur s'est reproduite plusieurs fois par jour sur 1000 serveurs avec ClickHouse: il n'est pas possible de collecter des statistiques sur un serveur, puis sur un autre. En même temps, il n'y avait aucune nouvelle version pour le moment. Cela n'a pas fonctionné et résolu le problème, mais après quelques jours, l'erreur elle-même a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont oublié l'erreur, et le 15 mai 2019, cela s'est répété. Nous avons continué à traiter avec elle. La première chose que j'ai faite a été de regarder tous les journaux et graphiques disponibles. Il les a étudiés toute la journée, n'a rien compris, n'a trouvé aucun schéma. Si le problème ne peut pas être reproduit, la seule option est de collecter tous les cas, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherchez les modèles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les dépendances. </font><font style="vertical-align: inherit;">Peut-être que le noyau Linux ne fonctionne pas correctement avec le processeur, enregistre ou charge de manière incorrecte les registres.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothèses et schémas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 serveurs sur 9 avec E5-2683 v4 ont échoué. Mais de l'erreur sujette, seulement environ la moitié du E5-2683 v4 est une hypothèse vide. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les erreurs ne sont généralement pas répétées</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En plus du cluster mtauxyz, où il y a en effet des données corrompues (mauvaises données sur le disque). Ceci est un autre cas, nous rejetons l'hypothèse. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'erreur ne dépend pas du noyau Linux</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - vérifiée sur différents serveurs, n'a rien trouvé. Rien d'intéressant dans kern.log, </font></font><code>machine check exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de </font><font style="vertical-align: inherit;">messages </font><font style="vertical-align: inherit;">. Dans les graphiques réseau, y compris les retransmetteurs, le processeur, les E / S, le réseau, rien d'intéressant. Tous les adaptateurs réseau sur les serveurs sur lesquels des erreurs se produisent et n'apparaissent pas sont identiques. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'y a pas de modèles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Que faire? Continuez à chercher des motifs. Deuxième essai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je regarde les serveurs de disponibilité:</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la disponibilité est élevée, les serveurs fonctionnent de manière stable</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les erreurs de segmentation et quelque chose comme ça ne l'est pas. Je me réjouis toujours quand je vois que le programme s'est écrasé avec segfault - au moins il s'est écrasé. Pire, quand il y a une erreur, ça gâche quelque chose, mais personne ne le remarque. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les erreurs sont regroupées par jour</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et se produisent en quelques jours. Dans environ 2 jours, plus apparaissent, dans certains moins, puis encore plus - il n'est pas possible de déterminer avec précision le moment de l'apparition des erreurs. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines erreurs correspondent aux packages et au montant du chèque que nous attendions.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La plupart des erreurs n'ont que deux options de package. J'ai eu de la chance car dans le message d'erreur, nous avons ajouté la valeur même de la somme de contrôle, ce qui a aidé à compiler des statistiques. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucun modèle de serveur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'où nous lisons les données. La taille du bloc compressé que nous vérifions est inférieure à un kilo-octet. Regardé les tailles d'emballage en HEX. Cela ne m'a pas été utile - la représentation binaire des tailles de paquets et des sommes de contrôle n'est pas perceptible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas corrigé l'erreur - je cherchais à nouveau des modèles. Troisième tentative. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une raison quelconque, l'erreur n'apparaît que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur l'un des clusters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - sur les troisièmes répliques du Vladimir DC (nous aimons appeler les centres de données par les noms de villes). En février 2019, une erreur est également apparue dans Vladimirs DC, mais sur une version différente de ClickHouse. Ceci est un autre argument contre l'hypothèse que nous avons écrit le mauvais code. Nous l'avons déjà réécrit trois fois de février à mai - l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur n'est probablement pas dans le code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les erreurs lors de la lecture des paquets sur le réseau -</font></font><code>while receiving packet from</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le package sur lequel l'erreur s'est produite dépend de la structure de la demande. </font><font style="vertical-align: inherit;">Pour les demandes de structure différente, une erreur sur des sommes de contrôle différentes. </font><font style="vertical-align: inherit;">Mais dans les demandes où l'erreur est sur la même somme de contrôle, les constantes diffèrent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les demandes avec une erreur, sauf une, le sont </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais à titre de comparaison, il y a une demande inhabituellement simple, et la taille du bloc compressé n'est que de 75 octets.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(ReceiveTimestamp) <span class="hljs-keyword">FROM</span> tracking_events_all 
<span class="hljs-keyword">WHERE</span> APIKey = <span class="hljs-number">1111</span> <span class="hljs-keyword">AND</span> (OperatingSystem <span class="hljs-keyword">IN</span> (<span class="hljs-string">'android'</span>, <span class="hljs-string">'ios'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous rejetons l'hypothèse d'influence </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le plus intéressant est que les serveurs affectés </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sont regroupés dans des </font><font style="vertical-align: inherit;">plages par leurs noms</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'étais fatiguée et désespérée, j'ai commencé à chercher des schémas complètement délirants. </font><font style="vertical-align: inherit;">C'est bien que je n'ai pas pu déboguer le code en utilisant la numérologie. </font><font style="vertical-align: inherit;">Mais il y avait encore des pistes.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les groupes de serveurs problématiques sont les mêmes qu'en février.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les serveurs problématiques sont situés dans certaines parties du centre de données. </font><font style="vertical-align: inherit;">À DC Vladimir, il y a ce qu'on appelle des lignes - ses différentes parties: VLA-02, VLA-03, VLA-04. </font><font style="vertical-align: inherit;">Les erreurs sont clairement regroupées: dans certaines files d'attente, c'est bon (VLA-02), dans d'autres problèmes (VLA-03, VLA-04).</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Taper le débogage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne restait plus qu'à déboguer en utilisant la méthode "lance". </font><font style="vertical-align: inherit;">Cela signifie former l'hypothèse «Que se passe-t-il si vous essayez de le faire?» </font><font style="vertical-align: inherit;">et collecter des données. </font><font style="vertical-align: inherit;">Par exemple, j'ai trouvé une </font></font><code>query_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requête simple avec une erreur </font><font style="vertical-align: inherit;">dans la table </font><font style="vertical-align: inherit;">pour laquelle la taille du paquet est </font></font><code>size of compressed block</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">très petite (= 107). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/zz/fd/cszzfdvfkob2rhon1-n_xfnqtn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai pris la demande, l'ai copiée et exécutée manuellement en utilisant clickhouse-local.</font></font><br>
<br>
<pre><code class="sql hljs">strace -f -e trace=network -s 1000 -x \<font></font>
clickhouse-local <span class="hljs-comment">--query "</span>
    <span class="hljs-keyword">SELECT</span> uniqIf(DeviceIDHash, SessionType = <span class="hljs-number">0</span>)
    <span class="hljs-keyword">FROM</span> remote(<span class="hljs-string">'127.0.0.{2,3}'</span>, mobile.generic_events)
    <span class="hljs-keyword">WHERE</span> StartDate = <span class="hljs-string">'2019-02-07'</span> <span class="hljs-keyword">AND</span> APIKey <span class="hljs-keyword">IN</span> (<span class="hljs-number">616988</span>,<span class="hljs-number">711663</span>,<span class="hljs-number">507671</span>,<span class="hljs-number">835591</span>,<span class="hljs-number">262098</span>,<span class="hljs-number">159700</span>,<span class="hljs-number">635121</span>,<span class="hljs-number">509222</span>)
        <span class="hljs-keyword">AND</span> EventType = <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> TOTALS<span class="hljs-string">" --config config.xml</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'aide de strace, j'ai reçu un instantané (vidage) de blocs sur le réseau - exactement les mêmes paquets qui sont reçus lorsque cette demande est exécutée, et je peux les étudier. Vous pouvez utiliser tcpdump pour cela, mais ce n'est pas pratique: il est difficile d'isoler une demande spécifique du trafic de production. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'aide de strace, vous pouvez tracer le serveur ClickHouse lui-même. Mais ce serveur fonctionne en production, si je fais cela, j'obtiendrai un tableau d'informations incompréhensibles. Par conséquent, j'ai lancé un programme distinct qui exécute exactement une demande. Déjà pour ce programme, je lance strace et j'obtiens ce qui a été transmis sur le réseau. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande est exécutée sans erreur - l'erreur n'est pas reproduite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . S'il était reproduit, le problème serait résolu. Par conséquent, j'ai copié les paquets dans un fichier texte et j'ai commencé manuellement à analyser le protocole.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f5/0y/-8/f50y-8qvloj4brnns-nvgydpbsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le montant du chèque était le même que prévu. </font><font style="vertical-align: inherit;">C'est exactement le paquet sur lequel parfois, à un autre moment, dans d'autres demandes, des erreurs se sont produites. </font><font style="vertical-align: inherit;">Mais jusqu'à présent, il n'y a pas eu d'erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai écrit un programme simple qui prend un paquet et vérifie le montant du chèque lors du remplacement d'un bit dans chaque octet. </font><font style="vertical-align: inherit;">Le programme a effectué un retournement de bit à chaque position possible et a lu le montant du chèque. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/fn/wr/3mfnwrp1udvm_ecrw0lnpcyoz0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai démarré le programme et j'ai constaté que si vous modifiez la valeur d'un bit, vous obtenez exactement cette somme de contrôle cassée, pour laquelle il y a une plainte</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problème matériel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il y a une erreur dans le logiciel (par exemple, en passant par la mémoire), le basculement sur un seul bit est peu probable. </font><font style="vertical-align: inherit;">Par conséquent, une nouvelle hypothèse est apparue - le problème est dans la glande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On pourrait fermer le couvercle de l'ordinateur portable et dire: "Le problème n'est pas de notre côté, mais dans le matériel, nous ne faisons pas cela." </font><font style="vertical-align: inherit;">Mais non, essayons de comprendre où est le problème: dans la RAM, sur le disque dur, dans le processeur, dans la carte réseau ou dans la RAM de la carte réseau dans l'équipement réseau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment localiser un problème matériel?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le problème est apparu et a disparu à certaines dates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveurs concernés sont regroupés par leur nom: </font></font><code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les groupes de serveurs problématiques sont les mêmes qu'en février.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les serveurs problématiques se trouvent uniquement dans certaines files d'attente du centre de données.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des questions ont été posées aux ingénieurs réseau - les données battent sur les commutateurs réseau. Il s'avère que les ingénieurs réseau ont échangé des commutateurs pour d'autres exactement à ces dates. Après une question, ils les ont remplacés par les précédents et le problème a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème est résolu, mais des questions demeurent (plus pour les ingénieurs). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi l'ECC (mémoire de correction d'erreur) n'aide-t-il pas les commutateurs réseau?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parce que le basculement de plusieurs bits peut se compenser - vous obtenez une erreur non détectée. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi les sommes de contrôle TCP ne sont-elles pas utiles?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ils sont faibles. Si un seul bit a changé dans les données, les sommes de contrôle TCP verront toujours le changement. Si deux bits ont changé, alors les changements peuvent ne pas être détectés - ils s'annulent mutuellement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un seul bit a changé dans notre package, mais l'erreur n'est pas visible. C'est parce que 2 bits ont changé dans le segment TCP: ils en ont calculé la somme de contrôle, cela a coïncidé. Mais dans un segment TCP, plus d'un paquet de notre application est localisé. Et pour l'un d'entre eux, nous considérons déjà notre somme de contrôle. Un seul bit a changé dans ce paquet. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi les sommes de contrôle Ethernet ne sont pas utiles - sont-elles plus fortes que TCP? </font></font></strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montant de contrôle Ethernet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vérifiez-résumez les données afin qu'elles ne se cassent pas pendant la transmission à travers un segment (je peux me tromper avec la terminologie, je ne suis pas ingénieur réseau). </font><font style="vertical-align: inherit;">L'équipement réseau transfère ces paquets et peut transmettre certaines données pendant le transfert. </font><font style="vertical-align: inherit;">Par conséquent, les montants des chèques sont simplement recomptés. </font><font style="vertical-align: inherit;">Nous avons vérifié - sur le fil, les paquets n'ont pas changé. </font><font style="vertical-align: inherit;">Mais s'ils battent sur le commutateur réseau lui-même, il recalculera le montant du chèque (il sera différent) et transmettra le paquet plus loin.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rien ne vous sauvera - vérifiez vous-même. </font><font style="vertical-align: inherit;">Ne vous attendez pas à ce que quelqu'un fasse cela pour vous.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les blocs de données, une somme de contrôle de 128 bits est envisagée (cette surpuissance au cas où). </font><font style="vertical-align: inherit;">Nous informons correctement l'utilisateur de l'erreur. </font><font style="vertical-align: inherit;">Les données sont transmises sur le réseau, elles sont endommagées, mais nous ne les enregistrons nulle part - toutes nos données sont en ordre, vous ne pouvez pas vous inquiéter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les données stockées dans ClickHouse restent cohérentes. </font><font style="vertical-align: inherit;">Utilisez des sommes de contrôle dans ClickHouse. </font><font style="vertical-align: inherit;">Nous aimons tellement les sommes de contrôle que nous considérons immédiatement trois options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les blocs de données compressés lors de l'écriture dans un fichier, sur le réseau.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La vérification totale est la somme des données compressées pour la vérification du rapprochement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contrôle total est la somme des données non compressées pour la vérification du rapprochement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des bogues dans les algorithmes de compression de données, c'est un cas connu. </font><font style="vertical-align: inherit;">Par conséquent, lorsque les données sont répliquées, nous considérons également la somme de contrôle totale des données compressées et la quantité totale de données non compressées.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'ayez pas peur de compter les montants des chèques, ils ne ralentissent pas.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien sûr, cela dépend de ceux et de la façon de compter. </font><font style="vertical-align: inherit;">Il y a des nuances, mais assurez-vous de considérer le montant du chèque. </font><font style="vertical-align: inherit;">Par exemple, si vous comptez à partir des données compressées, alors il y aura moins de données, elles ne ralentiront pas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Message d'erreur amélioré</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment expliquer à l'utilisateur lorsqu'il reçoit un tel message d'erreur qu'il s'agit d'un problème matériel? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t4/f6/rj/t4f6rj1mtuo38kojydfgddfh2nc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la somme de contrôle ne correspond pas, avant d'envoyer une exception, j'essaie de changer chaque bit - juste au cas où. Si la somme de contrôle converge lors du changement et qu'un bit est modifié, le problème est probablement le matériel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous pouvons détecter cette erreur, et si elle change lorsqu'un bit est changé, pourquoi ne pas le corriger? Nous pouvons le faire, mais si nous corrigeons les erreurs tout le temps, l'utilisateur ne saura pas que l'équipement est en problème. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons découvert qu'il y avait des problèmes dans les commutateurs, des personnes d'autres départements ont commencé à signaler: «Et nous avons un bit incorrectement écrit à Mongo! Et quelque chose nous est arrivé dans PostgreSQL! » C'est bien, mais il vaut mieux signaler les problèmes plus tôt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons publié une nouvelle version de diagnostic, le premier utilisateur à qui il a travaillé a écrit une semaine plus tard: "Voici le message - quel est le problème?" </font><font style="vertical-align: inherit;">Malheureusement, il ne l'a pas lu. </font><font style="vertical-align: inherit;">Mais j'ai lu et suggéré avec une probabilité de 99% que si l'erreur apparaît sur un serveur, le problème est lié au matériel. </font><font style="vertical-align: inherit;">Je laisse le pourcentage restant au cas où j'aurais mal écrit le code - cela se produit. </font><font style="vertical-align: inherit;">En conséquence, l'utilisateur a remplacé le SSD et le problème a disparu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Delirium" dans les données</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce problème intéressant et inattendu m'a inquiété. Nous avons des données Yandex.Metrica. Un simple JSON est écrit dans la base de données dans l'une des colonnes - paramètres utilisateur à partir du code JavaScript du compteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je fais une sorte de demande et le serveur ClickHouse s'est écrasé avec segfault. De la trace de la pile, j'ai réalisé quel était le problème - un nouvel engagement de nos contributeurs externes d'un autre pays. Le commit corrigé, le segfault a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je lance la même demande: </font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans ClickHouse, pour obtenir JSON, mais encore une fois, un non-sens, tout fonctionne lentement. J'obtiens JSON, et c'est 10 Mo. Je l'affiche et regarde plus attentivement: </font></font><code>{"jserrs": cannot find property of object undefind...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puis un mégaoctet de code binaire est tombé.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/ab/1g/ntab1gtbj8eialtctjq4nu-ucdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On pensait que c'était encore un passage de mémoire ou une condition de race. </font><font style="vertical-align: inherit;">Beaucoup de ces données binaires sont mauvaises, elles peuvent contenir n'importe quoi. </font><font style="vertical-align: inherit;">Si oui, je vais maintenant y trouver des mots de passe et des clés privées. </font><font style="vertical-align: inherit;">Mais je n'ai rien trouvé, j'ai donc immédiatement rejeté l'hypothèse. </font><font style="vertical-align: inherit;">C'est peut-être un bug dans mon programme sur le serveur ClickHouse? </font><font style="vertical-align: inherit;">Peut-être dans un programme qui écrit (il est également écrit en C ++) - tout d'un coup, elle place accidentellement sa mémoire de vidage dans ClickHouse? </font><font style="vertical-align: inherit;">Dans cet enfer, j'ai commencé à regarder de près les lettres et j'ai réalisé que ce n'était pas si simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chemin de l'indice</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mêmes ordures ont été enregistrées sur deux grappes, indépendamment l'une de l'autre. </font><font style="vertical-align: inherit;">Les données sont indésirables, mais elles sont valides en UTF-8. </font><font style="vertical-align: inherit;">Cet UTF-8 a des URL étranges, des noms de police et beaucoup de lettres "I" d'affilée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle est la particularité du petit «je» cyrillique? </font><font style="vertical-align: inherit;">Non, ce n'est pas Yandex. </font><font style="vertical-align: inherit;">Le fait est que dans le codage de Windows 1251, c'est le 255ème caractère. </font><font style="vertical-align: inherit;">Et sur nos serveurs Linux, personne n'utilise l'encodage Windows 1251. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'avère qu'il s'agit d'un vidage du navigateur: le code JavaScript du compteur métrique recueille les erreurs JavaScript. </font><font style="vertical-align: inherit;">Il s'est avéré que la réponse est simple: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout vient de l'utilisateur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut également en tirer des conclusions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues de partout sur Internet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Metrica collecte le trafic d'un milliard d'appareils sur Internet: navigateurs sur PC, téléphones portables, tablettes. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les ordures viendront inévitablement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : il y a des bogues dans les appareils des utilisateurs, partout de la RAM peu fiable et du matériel terrible qui surchauffe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de données stocke plus de 30 billions de lignes (pages vues). Si vous analysez les données de ce tableau, vous pouvez y trouver n'importe quoi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, il est correct de simplement filtrer ces ordures avant d’écrire dans la base de données. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas besoin d'écrire des ordures dans la base de données - elle n'aime pas ça.</font></font></b><br>
<br>
<blockquote> HighLoad++   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 133 </a>   ),       -  ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">++</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russia 2020 Online</a>. <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Badoo</a>, <b> PHP Russia 2020 Online  </b>. PHP Russia 2020 Online  13 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.<br>
<br>
          — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,     . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497324/index.html">"Comme la prunelle d'un œil ..." ou on fait un système de sécurité simple basé sur un microcontrôleur (Canny ou Arduino) et Raspberry PI</a></li>
<li><a href="../fr497326/index.html">Connectivité SSH plus sécurisée avec DNSSEC</a></li>
<li><a href="../fr497328/index.html">Un moyen facile d'apprendre une langue (n'importe laquelle)</a></li>
<li><a href="../fr497330/index.html">Bureau à distance Chrome. Assistance à distance</a></li>
<li><a href="../fr497332/index.html">Houston nous avons un problème. Échec de la conception du système</a></li>
<li><a href="../fr497336/index.html">Marques d'ordinateurs des années 90, partie 3, finale</a></li>
<li><a href="../fr497338/index.html">Qu'est-il arrivé aux transports la semaine dernière - la crise se développe</a></li>
<li><a href="../fr497340/index.html">COVID-19: comment arrêter de lire les nouvelles et commencer à analyser les données</a></li>
<li><a href="../fr497342/index.html">Navigateur à l'affût des requêtes API: création d'une communication sécurisée entre le front-end et le back-end</a></li>
<li><a href="../fr497346/index.html">Accélérez 100 fois numpy, scikit et pandas avec Rust et LLVM: entretien avec le développeur Weld</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>