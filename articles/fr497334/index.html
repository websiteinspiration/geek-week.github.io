<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜò ‚òÉÔ∏è ‚úçÔ∏è Les bugs notoires et comment les √©viter sur l'exemple de ClickHouse üèüÔ∏è ‚èπÔ∏è üèîÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous √©crivez du code, pr√©parez-vous aux probl√®mes. Ils le seront certainement, et ils devraient √™tre attendus de tous les c√¥t√©s: de votre code et d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Les bugs notoires et comment les √©viter sur l'exemple de ClickHouse</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497334/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous √©crivez du code, pr√©parez-vous aux probl√®mes. </font><font style="vertical-align: inherit;">Ils le seront certainement, et ils devraient √™tre attendus de tous les c√¥t√©s: de votre code et de votre compilateur, du syst√®me d'exploitation et du mat√©riel, et les utilisateurs l√®vent parfois des ¬´surprises¬ª. </font><font style="vertical-align: inherit;">Si vous avez fait √©voluer le cluster aux √©chelles cosmiques, attendez-vous √† des bogues "d'espace". </font><font style="vertical-align: inherit;">Surtout quand il s'agit de donn√©es provenant du trafic Internet.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ooBAQIe0KlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey Milovidov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) parlera des probl√®mes les plus ridicules, d√©courageants et d√©sesp√©r√©s de son exp√©rience dans le d√©veloppement et le support de ClickHouse. </font><font style="vertical-align: inherit;">Voyons comment ils ont d√ª √™tre d√©bogu√©s et quelles mesures les d√©veloppeurs devraient prendre d√®s le d√©but, afin qu'il y ait moins de probl√®mes.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues notoires</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez √©crit du code, pr√©parez-vous imm√©diatement aux probl√®mes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreurs dans le code.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ils seront n√©cessaires. Mais disons que vous avez √©crit le code parfait, compil√©, mais des bogues appara√Ætront </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le compilateur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le code ne fonctionnera pas correctement. Nous avons corrig√© le compilateur, tout compil√© - ex√©cutez-le. Mais (de mani√®re inattendue) tout fonctionne de mani√®re incorrecte, car </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a aussi des bogues dans le noyau du syst√®me d'exploitation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il n'y a pas de bogues dans le syst√®me d'exploitation, ils seront in√©vitablement li√©s </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au mat√©riel</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . M√™me si vous avez √©crit le code parfait qui fonctionne parfaitement sur le mat√©riel parfait, vous rencontrerez toujours des probl√®mes, par exemple </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des erreurs de configuration</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il semblerait que vous ayez tout fait correctement, mais quelqu'un a fait une erreur dans le fichier de configuration, et tout ne fonctionne plus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque tous les bugs ont √©t√© corrig√©s, les utilisateurs le termineront, car ils utilisent constamment votre code ¬´incorrectement¬ª. </font><font style="vertical-align: inherit;">Mais le probl√®me n'est certainement pas dans les utilisateurs, mais dans le code: vous avez </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©crit quelque chose de difficile √† utiliser</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons ces bugs avec quelques exemples.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues de configuration</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppression de donn√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le premier cas de la pratique. Heureusement, pas le mien et pas Yandex, ne vous inqui√©tez pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduction d'abord. L'architecture de r√©duction de carte d'un cluster (tel que Hadoop) se compose de plusieurs serveurs de donn√©es (n≈ìuds de donn√©es) qui stockent les donn√©es et d'un ou plusieurs serveurs ma√Ætres qui connaissent l'emplacement de toutes les donn√©es sur les serveurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les n≈ìuds de donn√©es connaissent l'adresse du ma√Ætre et s'y connectent. L'assistant surveille o√π et quelles donn√©es doivent √™tre localis√©es et donne diff√©rentes commandes aux n≈ìuds de donn√©es: ¬´T√©l√©chargez les donn√©es X, vous devez avoir les donn√©es Y et supprimer les donn√©es Z¬ª. Qu'est-ce qui pourrait mal se passer?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un nouveau fichier de configuration a √©t√© t√©l√©charg√© sur tous les n≈ìuds de donn√©es, ils se sont connect√©s par erreur au ma√Ætre √† partir d'un autre cluster, et non au leur. </font><font style="vertical-align: inherit;">Le ma√Ætre a examin√© les donn√©es dont les n≈ìuds de donn√©es ont √©t√© inform√©s, a d√©cid√© que les donn√©es √©taient incorrectes et devaient √™tre supprim√©es. </font><font style="vertical-align: inherit;">Le probl√®me a √©t√© constat√© lorsque la moiti√© des donn√©es ont √©t√© effac√©es.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/ii/6i/s8ii6igrww4j3zdjhrfyyqrl2nk.png" width="350"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bugs les plus √©piques sont ceux qui conduisent √† une suppression de donn√©es par inadvertance.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âviter cela est tr√®s simple. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne supprimez pas les donn√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, mettez-le de c√¥t√© dans un r√©pertoire s√©par√© ou supprimez-le avec un retard. Tout d'abord, nous transf√©rons afin qu'ils ne soient pas visibles pour l'utilisateur, et s'il constate que quelque chose a disparu en quelques jours, nous le retournerons. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne supprimez pas les donn√©es inattendues si la cause est inconnue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Limitez par programme le d√©but de la suppression des donn√©es inconnues: inattendu, avec des noms √©tranges, ou s'il y en a trop. L'administrateur remarquera que le serveur ne d√©marre pas et √©crit un message et comprendra. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le programme effectue des actions destructrices - isoler les tests et la production au niveau du r√©seau</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(iptables). Par exemple, la suppression de fichiers ou l'envoi d'e-mails est une action destructrice car elle ¬´d√©vorera¬ª l'attention de quelqu'un. Mettez-y un seuil: une centaine de lettres peuvent √™tre envoy√©es, et pour mille une case √† cocher de s√©curit√©, qui est r√©gl√©e avant que quelque chose de terrible ne se produise. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurations</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le deuxi√®me exemple vient d√©j√† de ma pratique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une bonne entreprise avait en quelque sorte un √©trange cluster ClickHouse. L'√©tranget√© √©tait que les r√©pliques n'√©taient pas synchronis√©es. Lorsque le serveur a √©t√© red√©marr√©, il n'a pas d√©marr√© et un message est apparu que toutes les donn√©es √©taient incorrectes: ¬´Il y a beaucoup de donn√©es inattendues, je ne d√©marre pas. Nous devons mettre le drapeau </font></font><code>force_restore_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le comprendre. "</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personne ne pouvait le comprendre dans l'entreprise - ils ont juste mis le drapeau. Dans le m√™me temps, la moiti√© des donn√©es ont disparu quelque part, entra√Ænant des graphiques avec des lacunes. Les d√©veloppeurs se sont tourn√©s vers moi, j'ai pens√© qu'il se passait quelque chose d'int√©ressant et j'ai d√©cid√© d'enqu√™ter. Lorsque le matin est venu quelques heures plus tard et que les oiseaux ont commenc√© √† chanter par la fen√™tre, j'ai r√©alis√© que je ne comprenais rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur ClickHouse utilise le service ZooKeeper pour la coordination. ClickHouse stocke les donn√©es et ZooKeeper d√©termine sur quels serveurs les donn√©es doivent se trouver: stocke les m√©tadonn√©es sur les donn√©es sur quelle r√©plique doit se trouver. ZooKeeper est √©galement un cluster - il se r√©plique selon un tr√®s bon algorithme de consensus distribu√©, avec une coh√©rence stricte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, ZooKeeper est compos√© de 3 machines, parfois 5. Dans la configuration ClickHouse, toutes les machines sont indiqu√©es en m√™me temps, la connexion est √©tablie avec une machine al√©atoire, interagit avec elle et ce serveur r√©plique toutes les demandes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-il arriv√©? L'entreprise disposait de trois serveurs ZooKeeper. Mais ils ne fonctionnaient pas comme un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cluster de trois n≈ìuds</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais comme </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trois n≈ìuds ind√©pendants</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - trois clusters √† partir d'un n≈ìud. One ClickHouse se connecte √† un serveur et √©crit des donn√©es. Les r√©pliques souhaitent t√©l√©charger ces donn√©es, mais elles sont introuvables. Au red√©marrage, le serveur se connecte √† un autre ZooKeeper: il voit que les donn√©es avec lesquelles il fonctionnait auparavant sont superflues, il faut les reporter quelque part. Il ne les supprime pas, mais les transf√®re dans un r√©pertoire s√©par√© - dans ClickHouse, les donn√©es ne sont pas si facilement supprim√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je d√©cide de corriger la configuration de ZooKeeper. </font><font style="vertical-align: inherit;">Je renomme toutes les donn√©es et fais une demande pour des </font></font><code>ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parties des donn√©es du r√©pertoire </font></font><code>detached/unexpeted_*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, toutes les donn√©es ont √©t√© restaur√©es, les r√©pliques ont √©t√© synchronis√©es, il n'y a eu aucune perte, les graphiques √©taient continus. </font><font style="vertical-align: inherit;">L'entreprise est satisfaite, reconnaissante, comme si elle avait d√©j√† oubli√© comment tout avait mal fonctionn√© auparavant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont de simples bogues de configuration. </font><font style="vertical-align: inherit;">Plus de bugs seront dans le code.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs dans le code</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous √©crivons du code en C ++. </font><font style="vertical-align: inherit;">Cela signifie que nous avons d√©j√† des probl√®mes.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple suivant est un vrai bug de production sur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le cluster Yandex.Metrica</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2015) - une cons√©quence du code C ++. </font><font style="vertical-align: inherit;">Le bug √©tait que parfois l'utilisateur au lieu de r√©pondre √† la demande recevait un message d'erreur:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Somme de contr√¥le ne correspond pas, donn√©es corrompues¬ª - la somme de contr√¥le ne correspond pas, les donn√©es sont cass√©es - effrayant!</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache est devenu incoh√©rent. </font><font style="vertical-align: inherit;">Il doit y avoir un bogue ¬ª- le cache est devenu incoh√©rent, probablement un bogue.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code que nous avons √©crit s'informe qu'il y a un bogue l√†-bas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"La </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">somme de contr√¥le ne correspond pas, les donn√©es sont corrompues</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." </font><font style="vertical-align: inherit;">Les sommes de contr√¥le des blocs de donn√©es compress√©s sont v√©rifi√©es avant d'√™tre d√©compress√©es. </font><font style="vertical-align: inherit;">Habituellement, cette erreur appara√Æt lorsque les donn√©es sont cass√©es sur le syst√®me de fichiers. </font><font style="vertical-align: inherit;">Pour diverses raisons, certains fichiers s'av√®rent √™tre des ordures lors du red√©marrage du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais voici un autre cas: j'ai lu le fichier manuellement, la somme de contr√¥le correspond, il n'y a pas d'erreur. </font><font style="vertical-align: inherit;">Une fois apparue, l'erreur est reproduite de mani√®re stable sur demande r√©p√©t√©e. </font><font style="vertical-align: inherit;">Lorsque le serveur red√©marre, l'erreur dispara√Æt pendant un certain temps, puis r√©appara√Æt de mani√®re stable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que le probl√®me est en RAM? </font><font style="vertical-align: inherit;">Une situation typique est lorsque des bits y battent. </font><font style="vertical-align: inherit;">Je regarde dans </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dmesg</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(kern.log), mais il n'y a aucune exception de v√©rification de la machine - ils √©crivent g√©n√©ralement quand quelque chose ne va pas avec la RAM. Si le serveur avait battu la RAM, non seulement mon programme ne fonctionnerait pas correctement, mais tous les autres g√©n√©reraient des erreurs de mani√®re al√©atoire. Cependant, il n'y a aucune autre manifestation de l'erreur. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache est devenu incoh√©rent. Il doit y avoir un bug. "</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C'est une erreur claire dans le code, et nous √©crivons en C ++ - peut-√™tre un acc√®s m√©moire? Mais les tests sous AddressSanitizer, ThreadSanitizer, MemorySanitizer, UndefinedBehaviorSanitizer dans CI ne montrent rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que certains cas de test ne sont pas couverts? Je r√©cup√®re le serveur avec AddressSanitizer, je l'ex√©cute en production - il n'attrape rien. Pendant un certain temps, l'erreur est supprim√©e en r√©initialisant un cache de marque (cache de sachet).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des r√®gles de programmation dit: si ce n'est pas clair ce qu'est le bogue, regardez attentivement le code, en esp√©rant y trouver quelque chose. Je l'ai fait, j'ai trouv√© un bogue, l'ai corrig√© - cela n'a pas aid√©. Je regarde un autre endroit dans le code - il y a aussi un bug. Corrig√©, encore une fois n'a pas aid√©. J'en ai corrig√© quelques autres, le code s'est am√©lior√©, mais l'erreur n'a toujours pas disparu! </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cause.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Essayer de trouver un mod√®le par serveur, par heure, par la nature de la charge - rien n'y fait. Puis il s'est rendu compte que le probl√®me ne se manifeste que sur l'un des clusters, et jamais sur les autres. L'erreur n'est pas reproduite si souvent, mais elle appara√Æt toujours sur un cluster apr√®s un red√©marrage, et tout est propre sur l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est av√©r√© que la raison en est que sur le cluster ¬´probl√®me¬ª, ils ont utilis√© une nouvelle fonctionnalit√© - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les dictionnaires de cache</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ils utilisent l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allocateur de</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©moire </font><strong><font style="vertical-align: inherit;">manuscrit ArenaWithFreeLists</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous √©crivons non seulement en C ++, mais nous avons √©galement vu une sorte d'allocateurs personnalis√©s - nous nous condamnons deux fois aux probl√®mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArenaWithFreeLists est une partie de la m√©moire dans laquelle la m√©moire est allou√©e cons√©cutivement dans des tailles divisibles par deux: 16, 32, 64 octets. </font><font style="vertical-align: inherit;">Si la m√©moire est lib√©r√©e, ils forment une liste li√©e de blocs FreeLists libres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le code.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArenaWithFreeLists</span>
{</span>
    Block * free_lists[<span class="hljs-number">16</span>] {};
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">sizeToPreviousPowerOfTwo</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">return</span> _bit_scan_reverse(size - <span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">char</span> * <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> list_idx = findFreeListIndex(size);<font></font>
        free_lists[list_idx] -&gt;...<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il utilise une fonction </font></font><code>_bit_scan_reverse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un trait de soulignement au d√©but.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe une r√®gle non √©crite: "Si une fonction a un trait de soulignement au d√©but, lisez la documentation une fois, et si deux, lisez-la deux fois."</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous √©coutons et lisons la documentation: ¬´int _bit_scan_reverse (int a). D√©finissez dst sur l'index du bit le plus √©lev√© dans un entier 32 bits a. Si aucun bit n'est d√©fini dans a, alors dst n'est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas d√©fini</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . " Nous semblons avoir trouv√© un probl√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En C ++, cette situation est consid√©r√©e comme impossible pour le compilateur. Le compilateur peut utiliser un comportement ind√©fini, cette ¬´impossibilit√©¬ª, comme hypoth√®se pour optimiser le code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compilateur ne fait rien de mal - il g√©n√®re honn√™tement des instructions d'assemblage </font></font><code>bsr %edi, %eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si l'op√©rande est nul, l'instruction a </font></font></strong><code><strong>bsr</strong></code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un comportement ind√©fini non pas au niveau C ++, mais au niveau CPU.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si le registre source est nul, le registre de destination ne change pas: il y avait des ordures √† l'entr√©e, ces ordures resteront √©galement √† la sortie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat d√©pend de l'endroit o√π le compilateur place cette instruction. </font><font style="vertical-align: inherit;">Parfois, une fonction avec cette instruction est en ligne, parfois non. </font><font style="vertical-align: inherit;">Dans le deuxi√®me cas, il y aura quelque chose comme ce code:</font></font><br>
<br>
<pre><code class="cpp hljs">bsrl %edi, %eax<font></font>
retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai regard√© un exemple de code similaire dans mon utilisation binaire </font></font><code>objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/6k/4f/lq6k4fg0lwpm2nhwhxbyauyjt2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'apr√®s les r√©sultats, je constate que parfois le registre source et le registre destination sont les m√™mes. </font><font style="vertical-align: inherit;">S'il y avait z√©ro, le r√©sultat sera √©galement nul - tout va bien. </font><font style="vertical-align: inherit;">Mais parfois, les registres sont diff√©rents et le r√©sultat sera des ordures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment ce bug se manifeste-t-il?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons les ordures comme index dans le tableau FreeLists. </font><font style="vertical-align: inherit;">Au lieu d'un tableau, nous allons √† une adresse distante et obtenons un acc√®s √† la m√©moire.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons de la chance, presque toutes les adresses √† proximit√© sont remplies de donn√©es du cache - nous g√¢chons le cache. </font><font style="vertical-align: inherit;">Le cache contient des d√©calages de fichiers.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous lisons les fichiers avec le mauvais d√©calage. </font><font style="vertical-align: inherit;">Du mauvais d√©calage, nous obtenons la somme de contr√¥le. </font><font style="vertical-align: inherit;">Mais il n'y a pas de somme de contr√¥le, mais autre chose - cette somme de contr√¥le ne co√Øncidera pas avec les donn√©es suivantes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous obtenons l'erreur ¬´La somme de contr√¥le ne correspond pas, les donn√©es sont corrompues¬ª.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, pas les donn√©es sont corrompues, mais seulement le cache en RAM. </font><font style="vertical-align: inherit;">Nous avons √©t√© imm√©diatement inform√©s de l'erreur, car nous avons v√©rifi√© les donn√©es. </font><font style="vertical-align: inherit;">L'erreur a √©t√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corrig√©e</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le 27 d√©cembre 2015 et est all√©e c√©l√©brer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, le mauvais code peut au moins √™tre corrig√©. </font><font style="vertical-align: inherit;">Mais comment corriger les bugs dans le mat√©riel?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs en fer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce ne sont m√™me pas des bugs, mais des lois physiques - des effets in√©vitables. Selon les lois physiques, le fer est in√©vitablement buggy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcriture non atomique sur RAID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, nous avons cr√©√© RAID1. Il se compose de deux disques durs. Cela signifie qu'un serveur est un syst√®me distribu√©: les donn√©es sont √©crites sur un disque dur et sur un autre. Mais que se passe-t-il si les donn√©es sont √©crites sur un disque et que l'alimentation est perdue lors de l'enregistrement sur le second? Les donn√©es sur une matrice RAID1 ne seront pas coh√©rentes. Nous ne pourrons pas comprendre quelles donn√©es sont correctes, car nous lirons un octet ou l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez y faire face en pla√ßant le journal. Par exemple, dans ZFS, ce probl√®me est r√©solu, mais plus √† ce sujet plus tard. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourriture des bits sur disque dur et SSD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Les bits sur les disques durs et sur les SSD peuvent mal tourner comme √ßa. Les SSD modernes, en particulier ceux avec des cellules √† plusieurs niveaux, sont con√ßus pour garantir que les cellules se d√©t√©rioreront constamment. Les codes de correction d'erreur aident, mais parfois les cellules se d√©t√©riorent tellement et tellement que m√™me cela ne sauve pas. Des erreurs non d√©tect√©es sont obtenues. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit bascule dans la RAM</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mais qu'en est-il ECC?). Dans la RAM des serveurs, les bits sont √©galement corrompus. Il a √©galement des codes de correction d'erreur. Lorsque des erreurs se produisent, elles sont g√©n√©ralement visibles √† partir des messages du journal du noyau Linux dans dmesg. Lorsqu'il y a beaucoup d'erreurs, nous verrons quelque chose comme: "N millions d'erreurs de m√©moire ont √©t√© corrig√©es." Mais les bits individuels ne seront pas remarqu√©s et, √† coup s√ªr, quelque chose sera bogu√©. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit bascule au niveau du processeur et du r√©seau</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a des erreurs au niveau du processeur, dans les caches de processeur et, bien s√ªr, lors de la transmission de donn√©es sur un r√©seau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment se manifestent g√©n√©ralement les erreurs de fer? Le ticket ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un znode mal form√© emp√™che ClickHouse de d√©marrer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font><font style="vertical-align: inherit;">arrive √† GitHub </font><font style="vertical-align: inherit;">- les donn√©es du n≈ìud ZooKeeper sont corrompues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ZooKeeper, nous √©crivons g√©n√©ralement certaines m√©tadonn√©es en texte brut. Il y a quelque chose qui ne va pas avec lui - " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©plique</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " est √©crit tr√®s √©trange. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/gk/zk/8_gkzkxlb1dzwhiph0saer-0d50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il arrive rarement qu'en raison d'un bogue dans le code, un bit change. Bien s√ªr, nous pouvons √©crire un tel code: nous prenons le filtre Bloom, changeons le bit √† certaines adresses, calculons les adresses incorrectement, changeons le mauvais bit, il tombe sur certaines donn√©es. Ca y est, maintenant ClickHouse ce n'est pas ¬´ </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©plique ¬ª</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais ¬´ </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repli </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª et tout les donn√©es est faux. Mais g√©n√©ralement, un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">changement d'un bit est un sympt√¥me de probl√®mes de fer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous connaissez peut-√™tre l'exemple du bitquatting. </font><font style="vertical-align: inherit;">Artyom Dinaburg a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fait une exp√©rience</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : il y a des domaines sur Internet qui ont beaucoup de trafic, bien que les utilisateurs ne s'y rendent pas seuls. </font><font style="vertical-align: inherit;">Par exemple, un tel domaine FB-CDN.com est un CDN Facebook. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artyom a enregistr√© un domaine similaire (et bien d'autres), mais a chang√© d'un bit. </font><font style="vertical-align: inherit;">Par exemple, FA-CDN.com au lieu de FB-CDN.com. </font><font style="vertical-align: inherit;">Le domaine n'a √©t√© publi√© nulle part, mais le trafic y est arriv√©. </font><font style="vertical-align: inherit;">Parfois, l'h√¥te FB-CDN a √©t√© √©crit dans les en-t√™tes HTTP et la demande est all√©e √† un autre h√¥te en raison d'erreurs de RAM sur les appareils des utilisateurs. </font><font style="vertical-align: inherit;">La RAM avec correction d'erreur n'aide pas toujours. </font><font style="vertical-align: inherit;">Parfois, il interf√®re m√™me et conduit √† des vuln√©rabilit√©s (lire sur Rowhammer, ECCploit, RAMBleed).</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion: v√©rifiez toujours les donn√©es vous-m√™me.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'√©criture dans le syst√®me de fichiers, v√©rifiez la somme sans √©chec. </font><font style="vertical-align: inherit;">Lors de la transmission sur le r√©seau, v√©rifiez √©galement le r√©sum√© - ne vous attendez pas √† ce qu'il y ait des sommes de contr√¥le.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus de bugs! ..</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesures du cluster de production</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les utilisateurs en r√©ponse √† une demande obtiennent parfois une exception: ¬´La somme de contr√¥le ne correspond pas: donn√©es corrompues¬ª - la somme de contr√¥le n'est pas correcte, les donn√©es sont corrompues. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/lb/wz/jylbwzqxrbk-g3hgygq4bktgdr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le message d'erreur affiche des donn√©es d√©taill√©es: quel montant de ch√®que √©tait attendu, quel montant de ch√®que se trouve r√©ellement dans ces donn√©es, la taille du bloc pour lequel nous v√©rifions le montant du ch√®que et le contexte d'exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons re√ßu le paquet sur le r√©seau d'un serveur, une exception est apparue - cela semble familier. </font><font style="vertical-align: inherit;">Peut-√™tre encore en passant par la m√©moire, la condition raciale ou autre chose.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette exception est apparue en 2015. Le bug a √©t√© corrig√©, il n'est plus apparu. En f√©vrier 2019, il est soudainement r√©apparu. A cette √©poque, j'√©tais √† l'une des conf√©rences, mes coll√®gues ont trait√© le probl√®me. L'erreur s'est reproduite plusieurs fois par jour sur 1000 serveurs avec ClickHouse: il n'est pas possible de collecter des statistiques sur un serveur, puis sur un autre. En m√™me temps, il n'y avait aucune nouvelle version pour le moment. Cela n'a pas fonctionn√© et r√©solu le probl√®me, mais apr√®s quelques jours, l'erreur elle-m√™me a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont oubli√© l'erreur, et le 15 mai 2019, cela s'est r√©p√©t√©. Nous avons continu√© √† traiter avec elle. La premi√®re chose que j'ai faite a √©t√© de regarder tous les journaux et graphiques disponibles. Il les a √©tudi√©s toute la journ√©e, n'a rien compris, n'a trouv√© aucun sch√©ma. Si le probl√®me ne peut pas √™tre reproduit, la seule option est de collecter tous les cas, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherchez les mod√®les</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les d√©pendances. </font><font style="vertical-align: inherit;">Peut-√™tre que le noyau Linux ne fonctionne pas correctement avec le processeur, enregistre ou charge de mani√®re incorrecte les registres.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypoth√®ses et sch√©mas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 serveurs sur 9 avec E5-2683 v4 ont √©chou√©. Mais de l'erreur sujette, seulement environ la moiti√© du E5-2683 v4 est une hypoth√®se vide. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les erreurs ne sont g√©n√©ralement pas r√©p√©t√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En plus du cluster mtauxyz, o√π il y a en effet des donn√©es corrompues (mauvaises donn√©es sur le disque). Ceci est un autre cas, nous rejetons l'hypoth√®se. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'erreur ne d√©pend pas du noyau Linux</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - v√©rifi√©e sur diff√©rents serveurs, n'a rien trouv√©. Rien d'int√©ressant dans kern.log, </font></font><code>machine check exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de </font><font style="vertical-align: inherit;">messages </font><font style="vertical-align: inherit;">. Dans les graphiques r√©seau, y compris les retransmetteurs, le processeur, les E / S, le r√©seau, rien d'int√©ressant. Tous les adaptateurs r√©seau sur les serveurs sur lesquels des erreurs se produisent et n'apparaissent pas sont identiques. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'y a pas de mod√®les</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Que faire? Continuez √† chercher des motifs. Deuxi√®me essai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je regarde les serveurs de disponibilit√©:</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la disponibilit√© est √©lev√©e, les serveurs fonctionnent de mani√®re stable</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les erreurs de segmentation et quelque chose comme √ßa ne l'est pas. Je me r√©jouis toujours quand je vois que le programme s'est √©cras√© avec segfault - au moins il s'est √©cras√©. Pire, quand il y a une erreur, √ßa g√¢che quelque chose, mais personne ne le remarque. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les erreurs sont regroup√©es par jour</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et se produisent en quelques jours. Dans environ 2 jours, plus apparaissent, dans certains moins, puis encore plus - il n'est pas possible de d√©terminer avec pr√©cision le moment de l'apparition des erreurs. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certaines erreurs correspondent aux packages et au montant du ch√®que que nous attendions.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La plupart des erreurs n'ont que deux options de package. J'ai eu de la chance car dans le message d'erreur, nous avons ajout√© la valeur m√™me de la somme de contr√¥le, ce qui a aid√© √† compiler des statistiques. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucun mod√®le de serveur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'o√π nous lisons les donn√©es. La taille du bloc compress√© que nous v√©rifions est inf√©rieure √† un kilo-octet. Regard√© les tailles d'emballage en HEX. Cela ne m'a pas √©t√© utile - la repr√©sentation binaire des tailles de paquets et des sommes de contr√¥le n'est pas perceptible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas corrig√© l'erreur - je cherchais √† nouveau des mod√®les. Troisi√®me tentative. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une raison quelconque, l'erreur n'appara√Æt que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur l'un des clusters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - sur les troisi√®mes r√©pliques du Vladimir DC (nous aimons appeler les centres de donn√©es par les noms de villes). En f√©vrier 2019, une erreur est √©galement apparue dans Vladimirs DC, mais sur une version diff√©rente de ClickHouse. Ceci est un autre argument contre l'hypoth√®se que nous avons √©crit le mauvais code. Nous l'avons d√©j√† r√©√©crit trois fois de f√©vrier √† mai - l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur n'est probablement pas dans le code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les erreurs lors de la lecture des paquets sur le r√©seau -</font></font><code>while receiving packet from</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le package sur lequel l'erreur s'est produite d√©pend de la structure de la demande. </font><font style="vertical-align: inherit;">Pour les demandes de structure diff√©rente, une erreur sur des sommes de contr√¥le diff√©rentes. </font><font style="vertical-align: inherit;">Mais dans les demandes o√π l'erreur est sur la m√™me somme de contr√¥le, les constantes diff√®rent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les demandes avec une erreur, sauf une, le sont </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais √† titre de comparaison, il y a une demande inhabituellement simple, et la taille du bloc compress√© n'est que de 75 octets.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(ReceiveTimestamp) <span class="hljs-keyword">FROM</span> tracking_events_all 
<span class="hljs-keyword">WHERE</span> APIKey = <span class="hljs-number">1111</span> <span class="hljs-keyword">AND</span> (OperatingSystem <span class="hljs-keyword">IN</span> (<span class="hljs-string">'android'</span>, <span class="hljs-string">'ios'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous rejetons l'hypoth√®se d'influence </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le plus int√©ressant est que les serveurs affect√©s </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sont regroup√©s dans des </font><font style="vertical-align: inherit;">plages par leurs noms</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'√©tais fatigu√©e et d√©sesp√©r√©e, j'ai commenc√© √† chercher des sch√©mas compl√®tement d√©lirants. </font><font style="vertical-align: inherit;">C'est bien que je n'ai pas pu d√©boguer le code en utilisant la num√©rologie. </font><font style="vertical-align: inherit;">Mais il y avait encore des pistes.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les groupes de serveurs probl√©matiques sont les m√™mes qu'en f√©vrier.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les serveurs probl√©matiques sont situ√©s dans certaines parties du centre de donn√©es. </font><font style="vertical-align: inherit;">√Ä DC Vladimir, il y a ce qu'on appelle des lignes - ses diff√©rentes parties: VLA-02, VLA-03, VLA-04. </font><font style="vertical-align: inherit;">Les erreurs sont clairement regroup√©es: dans certaines files d'attente, c'est bon (VLA-02), dans d'autres probl√®mes (VLA-03, VLA-04).</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Taper le d√©bogage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne restait plus qu'√† d√©boguer en utilisant la m√©thode "lance". </font><font style="vertical-align: inherit;">Cela signifie former l'hypoth√®se ¬´Que se passe-t-il si vous essayez de le faire?¬ª </font><font style="vertical-align: inherit;">et collecter des donn√©es. </font><font style="vertical-align: inherit;">Par exemple, j'ai trouv√© une </font></font><code>query_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requ√™te simple avec une erreur </font><font style="vertical-align: inherit;">dans la table </font><font style="vertical-align: inherit;">pour laquelle la taille du paquet est </font></font><code>size of compressed block</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tr√®s petite (= 107). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/zz/fd/cszzfdvfkob2rhon1-n_xfnqtn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai pris la demande, l'ai copi√©e et ex√©cut√©e manuellement en utilisant clickhouse-local.</font></font><br>
<br>
<pre><code class="sql hljs">strace -f -e trace=network -s 1000 -x \<font></font>
clickhouse-local <span class="hljs-comment">--query "</span>
    <span class="hljs-keyword">SELECT</span> uniqIf(DeviceIDHash, SessionType = <span class="hljs-number">0</span>)
    <span class="hljs-keyword">FROM</span> remote(<span class="hljs-string">'127.0.0.{2,3}'</span>, mobile.generic_events)
    <span class="hljs-keyword">WHERE</span> StartDate = <span class="hljs-string">'2019-02-07'</span> <span class="hljs-keyword">AND</span> APIKey <span class="hljs-keyword">IN</span> (<span class="hljs-number">616988</span>,<span class="hljs-number">711663</span>,<span class="hljs-number">507671</span>,<span class="hljs-number">835591</span>,<span class="hljs-number">262098</span>,<span class="hljs-number">159700</span>,<span class="hljs-number">635121</span>,<span class="hljs-number">509222</span>)
        <span class="hljs-keyword">AND</span> EventType = <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> TOTALS<span class="hljs-string">" --config config.xml</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'aide de strace, j'ai re√ßu un instantan√© (vidage) de blocs sur le r√©seau - exactement les m√™mes paquets qui sont re√ßus lorsque cette demande est ex√©cut√©e, et je peux les √©tudier. Vous pouvez utiliser tcpdump pour cela, mais ce n'est pas pratique: il est difficile d'isoler une demande sp√©cifique du trafic de production. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'aide de strace, vous pouvez tracer le serveur ClickHouse lui-m√™me. Mais ce serveur fonctionne en production, si je fais cela, j'obtiendrai un tableau d'informations incompr√©hensibles. Par cons√©quent, j'ai lanc√© un programme distinct qui ex√©cute exactement une demande. D√©j√† pour ce programme, je lance strace et j'obtiens ce qui a √©t√© transmis sur le r√©seau. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande est ex√©cut√©e sans erreur - l'erreur n'est pas reproduite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . S'il √©tait reproduit, le probl√®me serait r√©solu. Par cons√©quent, j'ai copi√© les paquets dans un fichier texte et j'ai commenc√© manuellement √† analyser le protocole.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f5/0y/-8/f50y-8qvloj4brnns-nvgydpbsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le montant du ch√®que √©tait le m√™me que pr√©vu. </font><font style="vertical-align: inherit;">C'est exactement le paquet sur lequel parfois, √† un autre moment, dans d'autres demandes, des erreurs se sont produites. </font><font style="vertical-align: inherit;">Mais jusqu'√† pr√©sent, il n'y a pas eu d'erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai √©crit un programme simple qui prend un paquet et v√©rifie le montant du ch√®que lors du remplacement d'un bit dans chaque octet. </font><font style="vertical-align: inherit;">Le programme a effectu√© un retournement de bit √† chaque position possible et a lu le montant du ch√®que. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/fn/wr/3mfnwrp1udvm_ecrw0lnpcyoz0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©marr√© le programme et j'ai constat√© que si vous modifiez la valeur d'un bit, vous obtenez exactement cette somme de contr√¥le cass√©e, pour laquelle il y a une plainte</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probl√®me mat√©riel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il y a une erreur dans le logiciel (par exemple, en passant par la m√©moire), le basculement sur un seul bit est peu probable. </font><font style="vertical-align: inherit;">Par cons√©quent, une nouvelle hypoth√®se est apparue - le probl√®me est dans la glande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On pourrait fermer le couvercle de l'ordinateur portable et dire: "Le probl√®me n'est pas de notre c√¥t√©, mais dans le mat√©riel, nous ne faisons pas cela." </font><font style="vertical-align: inherit;">Mais non, essayons de comprendre o√π est le probl√®me: dans la RAM, sur le disque dur, dans le processeur, dans la carte r√©seau ou dans la RAM de la carte r√©seau dans l'√©quipement r√©seau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment localiser un probl√®me mat√©riel?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le probl√®me est apparu et a disparu √† certaines dates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveurs concern√©s sont regroup√©s par leur nom: </font></font><code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les groupes de serveurs probl√©matiques sont les m√™mes qu'en f√©vrier.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les serveurs probl√©matiques se trouvent uniquement dans certaines files d'attente du centre de donn√©es.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des questions ont √©t√© pos√©es aux ing√©nieurs r√©seau - les donn√©es battent sur les commutateurs r√©seau. Il s'av√®re que les ing√©nieurs r√©seau ont √©chang√© des commutateurs pour d'autres exactement √† ces dates. Apr√®s une question, ils les ont remplac√©s par les pr√©c√©dents et le probl√®me a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me est r√©solu, mais des questions demeurent (plus pour les ing√©nieurs). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi l'ECC (m√©moire de correction d'erreur) n'aide-t-il pas les commutateurs r√©seau?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parce que le basculement de plusieurs bits peut se compenser - vous obtenez une erreur non d√©tect√©e. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi les sommes de contr√¥le TCP ne sont-elles pas utiles?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ils sont faibles. Si un seul bit a chang√© dans les donn√©es, les sommes de contr√¥le TCP verront toujours le changement. Si deux bits ont chang√©, alors les changements peuvent ne pas √™tre d√©tect√©s - ils s'annulent mutuellement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un seul bit a chang√© dans notre package, mais l'erreur n'est pas visible. C'est parce que 2 bits ont chang√© dans le segment TCP: ils en ont calcul√© la somme de contr√¥le, cela a co√Øncid√©. Mais dans un segment TCP, plus d'un paquet de notre application est localis√©. Et pour l'un d'entre eux, nous consid√©rons d√©j√† notre somme de contr√¥le. Un seul bit a chang√© dans ce paquet. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi les sommes de contr√¥le Ethernet ne sont pas utiles - sont-elles plus fortes que TCP? </font></font></strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montant de contr√¥le Ethernet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifiez-r√©sumez les donn√©es afin qu'elles ne se cassent pas pendant la transmission √† travers un segment (je peux me tromper avec la terminologie, je ne suis pas ing√©nieur r√©seau). </font><font style="vertical-align: inherit;">L'√©quipement r√©seau transf√®re ces paquets et peut transmettre certaines donn√©es pendant le transfert. </font><font style="vertical-align: inherit;">Par cons√©quent, les montants des ch√®ques sont simplement recompt√©s. </font><font style="vertical-align: inherit;">Nous avons v√©rifi√© - sur le fil, les paquets n'ont pas chang√©. </font><font style="vertical-align: inherit;">Mais s'ils battent sur le commutateur r√©seau lui-m√™me, il recalculera le montant du ch√®que (il sera diff√©rent) et transmettra le paquet plus loin.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rien ne vous sauvera - v√©rifiez vous-m√™me. </font><font style="vertical-align: inherit;">Ne vous attendez pas √† ce que quelqu'un fasse cela pour vous.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les blocs de donn√©es, une somme de contr√¥le de 128 bits est envisag√©e (cette surpuissance au cas o√π). </font><font style="vertical-align: inherit;">Nous informons correctement l'utilisateur de l'erreur. </font><font style="vertical-align: inherit;">Les donn√©es sont transmises sur le r√©seau, elles sont endommag√©es, mais nous ne les enregistrons nulle part - toutes nos donn√©es sont en ordre, vous ne pouvez pas vous inqui√©ter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es stock√©es dans ClickHouse restent coh√©rentes. </font><font style="vertical-align: inherit;">Utilisez des sommes de contr√¥le dans ClickHouse. </font><font style="vertical-align: inherit;">Nous aimons tellement les sommes de contr√¥le que nous consid√©rons imm√©diatement trois options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les blocs de donn√©es compress√©s lors de l'√©criture dans un fichier, sur le r√©seau.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La v√©rification totale est la somme des donn√©es compress√©es pour la v√©rification du rapprochement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contr√¥le total est la somme des donn√©es non compress√©es pour la v√©rification du rapprochement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des bogues dans les algorithmes de compression de donn√©es, c'est un cas connu. </font><font style="vertical-align: inherit;">Par cons√©quent, lorsque les donn√©es sont r√©pliqu√©es, nous consid√©rons √©galement la somme de contr√¥le totale des donn√©es compress√©es et la quantit√© totale de donn√©es non compress√©es.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'ayez pas peur de compter les montants des ch√®ques, ils ne ralentissent pas.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien s√ªr, cela d√©pend de ceux et de la fa√ßon de compter. </font><font style="vertical-align: inherit;">Il y a des nuances, mais assurez-vous de consid√©rer le montant du ch√®que. </font><font style="vertical-align: inherit;">Par exemple, si vous comptez √† partir des donn√©es compress√©es, alors il y aura moins de donn√©es, elles ne ralentiront pas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Message d'erreur am√©lior√©</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment expliquer √† l'utilisateur lorsqu'il re√ßoit un tel message d'erreur qu'il s'agit d'un probl√®me mat√©riel? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t4/f6/rj/t4f6rj1mtuo38kojydfgddfh2nc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la somme de contr√¥le ne correspond pas, avant d'envoyer une exception, j'essaie de changer chaque bit - juste au cas o√π. Si la somme de contr√¥le converge lors du changement et qu'un bit est modifi√©, le probl√®me est probablement le mat√©riel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous pouvons d√©tecter cette erreur, et si elle change lorsqu'un bit est chang√©, pourquoi ne pas le corriger? Nous pouvons le faire, mais si nous corrigeons les erreurs tout le temps, l'utilisateur ne saura pas que l'√©quipement est en probl√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons d√©couvert qu'il y avait des probl√®mes dans les commutateurs, des personnes d'autres d√©partements ont commenc√© √† signaler: ¬´Et nous avons un bit incorrectement √©crit √† Mongo! Et quelque chose nous est arriv√© dans PostgreSQL! ¬ª C'est bien, mais il vaut mieux signaler les probl√®mes plus t√¥t.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons publi√© une nouvelle version de diagnostic, le premier utilisateur √† qui il a travaill√© a √©crit une semaine plus tard: "Voici le message - quel est le probl√®me?" </font><font style="vertical-align: inherit;">Malheureusement, il ne l'a pas lu. </font><font style="vertical-align: inherit;">Mais j'ai lu et sugg√©r√© avec une probabilit√© de 99% que si l'erreur appara√Æt sur un serveur, le probl√®me est li√© au mat√©riel. </font><font style="vertical-align: inherit;">Je laisse le pourcentage restant au cas o√π j'aurais mal √©crit le code - cela se produit. </font><font style="vertical-align: inherit;">En cons√©quence, l'utilisateur a remplac√© le SSD et le probl√®me a disparu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Delirium" dans les donn√©es</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce probl√®me int√©ressant et inattendu m'a inqui√©t√©. Nous avons des donn√©es Yandex.Metrica. Un simple JSON est √©crit dans la base de donn√©es dans l'une des colonnes - param√®tres utilisateur √† partir du code JavaScript du compteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je fais une sorte de demande et le serveur ClickHouse s'est √©cras√© avec segfault. De la trace de la pile, j'ai r√©alis√© quel √©tait le probl√®me - un nouvel engagement de nos contributeurs externes d'un autre pays. Le commit corrig√©, le segfault a disparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je lance la m√™me demande: </font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans ClickHouse, pour obtenir JSON, mais encore une fois, un non-sens, tout fonctionne lentement. J'obtiens JSON, et c'est 10 Mo. Je l'affiche et regarde plus attentivement: </font></font><code>{"jserrs": cannot find property of object undefind...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puis un m√©gaoctet de code binaire est tomb√©.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/ab/1g/ntab1gtbj8eialtctjq4nu-ucdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On pensait que c'√©tait encore un passage de m√©moire ou une condition de race. </font><font style="vertical-align: inherit;">Beaucoup de ces donn√©es binaires sont mauvaises, elles peuvent contenir n'importe quoi. </font><font style="vertical-align: inherit;">Si oui, je vais maintenant y trouver des mots de passe et des cl√©s priv√©es. </font><font style="vertical-align: inherit;">Mais je n'ai rien trouv√©, j'ai donc imm√©diatement rejet√© l'hypoth√®se. </font><font style="vertical-align: inherit;">C'est peut-√™tre un bug dans mon programme sur le serveur ClickHouse? </font><font style="vertical-align: inherit;">Peut-√™tre dans un programme qui √©crit (il est √©galement √©crit en C ++) - tout d'un coup, elle place accidentellement sa m√©moire de vidage dans ClickHouse? </font><font style="vertical-align: inherit;">Dans cet enfer, j'ai commenc√© √† regarder de pr√®s les lettres et j'ai r√©alis√© que ce n'√©tait pas si simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chemin de l'indice</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les m√™mes ordures ont √©t√© enregistr√©es sur deux grappes, ind√©pendamment l'une de l'autre. </font><font style="vertical-align: inherit;">Les donn√©es sont ind√©sirables, mais elles sont valides en UTF-8. </font><font style="vertical-align: inherit;">Cet UTF-8 a des URL √©tranges, des noms de police et beaucoup de lettres "I" d'affil√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle est la particularit√© du petit ¬´je¬ª cyrillique? </font><font style="vertical-align: inherit;">Non, ce n'est pas Yandex. </font><font style="vertical-align: inherit;">Le fait est que dans le codage de Windows 1251, c'est le 255√®me caract√®re. </font><font style="vertical-align: inherit;">Et sur nos serveurs Linux, personne n'utilise l'encodage Windows 1251. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'av√®re qu'il s'agit d'un vidage du navigateur: le code JavaScript du compteur m√©trique recueille les erreurs JavaScript. </font><font style="vertical-align: inherit;">Il s'est av√©r√© que la r√©ponse est simple: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout vient de l'utilisateur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut √©galement en tirer des conclusions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bogues de partout sur Internet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Metrica collecte le trafic d'un milliard d'appareils sur Internet: navigateurs sur PC, t√©l√©phones portables, tablettes. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les ordures viendront in√©vitablement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : il y a des bogues dans les appareils des utilisateurs, partout de la RAM peu fiable et du mat√©riel terrible qui surchauffe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de donn√©es stocke plus de 30 billions de lignes (pages vues). Si vous analysez les donn√©es de ce tableau, vous pouvez y trouver n'importe quoi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, il est correct de simplement filtrer ces ordures avant d‚Äô√©crire dans la base de donn√©es. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas besoin d'√©crire des ordures dans la base de donn√©es - elle n'aime pas √ßa.</font></font></b><br>
<br>
<blockquote> HighLoad++   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 133 </a>   ),       -  ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">++</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russia 2020 Online</a>. <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Badoo</a>, <b> PHP Russia 2020 Online  </b>. PHP Russia 2020 Online  13 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.<br>
<br>
          ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,     . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497324/index.html">"Comme la prunelle d'un ≈ìil ..." ou on fait un syst√®me de s√©curit√© simple bas√© sur un microcontr√¥leur (Canny ou Arduino) et Raspberry PI</a></li>
<li><a href="../fr497326/index.html">Connectivit√© SSH plus s√©curis√©e avec DNSSEC</a></li>
<li><a href="../fr497328/index.html">Un moyen facile d'apprendre une langue (n'importe laquelle)</a></li>
<li><a href="../fr497330/index.html">Bureau √† distance Chrome. Assistance √† distance</a></li>
<li><a href="../fr497332/index.html">Houston nous avons un probl√®me. √âchec de la conception du syst√®me</a></li>
<li><a href="../fr497336/index.html">Marques d'ordinateurs des ann√©es 90, partie 3, finale</a></li>
<li><a href="../fr497338/index.html">Qu'est-il arriv√© aux transports la semaine derni√®re - la crise se d√©veloppe</a></li>
<li><a href="../fr497340/index.html">COVID-19: comment arr√™ter de lire les nouvelles et commencer √† analyser les donn√©es</a></li>
<li><a href="../fr497342/index.html">Navigateur √† l'aff√ªt des requ√™tes API: cr√©ation d'une communication s√©curis√©e entre le front-end et le back-end</a></li>
<li><a href="../fr497346/index.html">Acc√©l√©rez 100 fois numpy, scikit et pandas avec Rust et LLVM: entretien avec le d√©veloppeur Weld</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>