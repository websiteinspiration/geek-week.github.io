<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😌 🔑 🚵🏻 How to use Prometheus to detect anomalies in GitLab 🕰️ 👩🏽‍🤝‍👨🏾 🌷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the basic features of the Prometheus query language is real-time aggregation of time series . You can also use the Prometheus query language to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to use Prometheus to detect anomalies in GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the basic features of the Prometheus query language is </font><font style="vertical-align: inherit;">real-time </font><font style="vertical-align: inherit;">aggregation of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">time series</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can also use the Prometheus query language to detect anomalies in time series data.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">team has</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> translated </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">an article by the engineer of the GitLab infrastructure team</font></a><font style="vertical-align: inherit;"> , where you will find code examples that you can try on your systems.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is anomaly detection for?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are four main reasons that determine the importance of anomaly detection for GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incident Diagnostics</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : We can detect which services have gone beyond their normal scope by reducing incident detection time (MTTD) and, accordingly, offer a faster solution to the problem.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detection of performance degradation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : for example, if a regression is introduced into a service that causes it to access another service too often, we can quickly detect and fix this problem.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detection and elimination of abuse</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab provides delivery and integration mechanisms ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and hosting (GitLab Pages) and a limited number of users who can use these mechanisms.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safety</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Anomaly detection is important for detecting unusual trends in the GitLab time series.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For these and other reasons, the author of the article decided to figure out how to configure the definition of anomalies in the GitLab time series using Prometheus queries and rules.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the correct aggregation level?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, time series must be correctly aggregated. </font><font style="vertical-align: inherit;">In the example below, we used the standard http_requests_total counter to retrieve data, although many other metrics would do as well.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This test metric has several parameters: method, controller, status code (status_code), environment, plus parameters added by Prometheus itself, for example, job and instance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to choose the right level of data aggregation. </font><font style="vertical-align: inherit;">Too much, too little - all this is important for detecting anomalies. </font><font style="vertical-align: inherit;">If the data is too aggregated, there are two potential problems:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can skip the anomaly because aggregation hides problems that occur in subsets of your data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you find an anomaly, it is difficult to relate it to a separate part of your system without additional effort.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the data is not aggregated enough, this can lead to an increase in the number of false positives, as well as to incorrect interpretation of valid data as erroneous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on our experience, the most correct level of aggregation is the level of service, that is, we include the label of work (job) and environment (environment), and discard all other labels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The aggregation, which we will discuss throughout the article, includes: job - http_request, aggregation - five minutes, which is calculated on the basis of work and environment in five minutes.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the above example, it is clear that from the series http_requests_total subsets are selected in the context of work and environment, then their number is considered for five minutes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Z-score to detect anomalies</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The basic principles of statistics can be applied to detect anomalies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you know the mean and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standard deviation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the Prometheus series, then you can use any sample in the series to calculate the z-score.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Z-score is a measure of the relative spread of the observed or measured value, which shows how many </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standard deviations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> its spread relative to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">average value is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the z-score = 0 means that the z-score is identical to the average value in the dataset with the standard distribution, and the z-score = 1 means that the standard deviation = 1.0 from the average.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We assume that the basic data have a normal distribution, which means that 99.7% of the samples have a z-score from 0 to 3. The farther the z-score is from zero, the less likely it is to exist.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We apply this property to detect anomalies in the Prometheus data series:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We calculate the mean and standard deviation for the metric using data with a large sample size. </font><font style="vertical-align: inherit;">For this example, we use weekly data. </font><font style="vertical-align: inherit;">If we assume that the records are evaluated once a minute, then in a week we will have a little over 10,000 samples.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can calculate the z-score for the Prometheus query as soon as we get the mean and standard deviation for aggregation.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the statistical principles of normal distributions, suppose that any value outside the range of +3 to -3 will be an anomaly. </font><font style="vertical-align: inherit;">Accordingly, we can create a warning about such anomalies. </font><font style="vertical-align: inherit;">For example, we will receive an alert when our aggregation goes beyond this range for more than five minutes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graph of the number of requests per second to the GitLab Pages service for 48 hours. </font><font style="vertical-align: inherit;">The Z-score in the range from +3 to -3 is highlighted in green. The</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Z-score can be difficult to interpret on the graphs, since this value does not have a unit of measurement. </font><font style="vertical-align: inherit;">But the anomalies in this graph are very simple to determine. </font><font style="vertical-align: inherit;">Everything that goes beyond the green zone, which shows a corridor of values ​​with a z-score of -3 to +3, will be an anomalous value.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to do if data distribution is not normal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We assume that the distribution of data is normal. </font><font style="vertical-align: inherit;">Otherwise, our z-score will be false. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are a lot of statistical tricks to determine the normality of the data distribution, but the best way is to check that your data z-score lies in the range from -4.0 to +4.0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two Prometheus queries showing minimum and maximum z-scores:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your results are in the range from -20 to +20, this means that too much data has been used and the results are distorted. </font><font style="vertical-align: inherit;">Remember also that you must work with aggregated rows. </font><font style="vertical-align: inherit;">Metrics that do not have a normal distribution include parameters such as error rate, delay, queue lengths, and so on. </font><font style="vertical-align: inherit;">But many of these metrics will work better with fixed alert thresholds.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistical seasonality anomaly detection</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although calculating z-scores works well with the normal distribution of time-series data, there is a second method that can give even more accurate anomaly detection results. </font><font style="vertical-align: inherit;">This is the use of statistical seasonality.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seasonality is a characteristic of a time series metric when this metric undergoes regular and predictable changes that are repeated in each cycle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chart of requests per second (RPS) from Monday to Sunday for four consecutive weeks The</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
chart above illustrates the RPS (number of requests per second) for seven days - from Monday to Sunday, for four consecutive weeks. </font><font style="vertical-align: inherit;">This seven-day range is called “offset”, that is, the pattern that will be used for measurement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each week on the chart is a different color. </font><font style="vertical-align: inherit;">The seasonality of the data is indicated by the sequence in the trends indicated on the graph - every Monday morning we observe a similar increase in RPS, and in the evenings on Friday we always observe a decrease in RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using seasonality in our time series data, we can more accurately predict the occurrence of anomalies and their detection.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to use seasonality</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheus uses several different statistical mechanisms to calculate seasonality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we make a calculation, adding a growth trend for the week to the results of the previous week. The growth trend is calculated as follows: subtract the moving average for the last week from the moving average for the past week.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first iteration turns out to be somewhat “narrow” - we use the five-minute window of this week and the previous week to get our forecasts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the second iteration, we expand our coverage by taking the average of the four-hour period for the previous week and comparing it with the current week.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, if we try to predict the metric value at eight in the morning on Monday, instead of the same five-minute window the week before, we take the average value of the metric from six to ten in the morning of the previous Monday.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The request indicated 166 hours, which is two hours less than a full week (7 * 24 = 168), since we want to use a four-hour period based on the current time, so we need the offset to be two hours less than a full week.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Real RPS (yellow) and predicted (blue) in two weeks</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A comparison of the actual RPS with our forecast shows that our calculations were fairly accurate. However, this method has a drawback. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, May 1, GitLab was used less than usual on Wednesdays, as this day was a day off. Since the estimated growth trend depends on how the system was used in the previous week, our forecasts for the next week, that is, on Wednesday, May 8, gave a lower RPS than actually. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This error can be corrected by making three forecasts for three consecutive weeks before Wednesday, May 1, that is, the three previous Wednesday. The request remains the same, but the offset is adjusted.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are three forecasts on the chart for three weeks before May 8, compared with the actual RPS for Wednesday, May 8. You can see that the two forecasts are very accurate, but the forecast for the week of May 1 remains inaccurate.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In addition, we do not need three forecasts, we need one forecast. The average value is not an option, as it will be blurred by our distorted RPS data from May 1. Instead, you need to calculate the median. Prometheus does not have a median query, but we can use quantile aggregation instead of the median. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only problem is that we are trying to include three series in the aggregation, and these three series are actually the same series in three weeks. In other words, they have the same labels, so it's hard to put them together.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid confusion, we create a label called offset and use the label-replace function to add an offset to each of the three weeks. </font><font style="vertical-align: inherit;">Then in quantile aggregation we discard these labels, and this gives us an average of three.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now our forecast with a median of three aggregations has become more accurate.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Median forecast versus actual RPS</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to find out that our forecast is really accurate</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the accuracy of the forecast, we can return to the z-score. </font><font style="vertical-align: inherit;">It is used to measure the discrepancy of the sample with its forecast in standard deviations. </font><font style="vertical-align: inherit;">The larger the standard deviation from the forecast, the higher the likelihood that a particular value is an outlier.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The projected deviation range is from +1.5 to -1.5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You can change our Grafana chart to use a seasonal forecast, rather than a weekly moving average. </font><font style="vertical-align: inherit;">The range of normal values ​​for a specific time of the day is shaded in green. </font><font style="vertical-align: inherit;">Everything that goes beyond the green zone is considered an outlier. </font><font style="vertical-align: inherit;">In this case, the outlier occurred on Sunday afternoon, when our cloud provider had some network problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is good practice to use a ± 2 z-score for seasonal forecasts.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to set up alerts with Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to set up an alert for abnormal events, you can apply the fairly simple Prometheus rule, which checks whether the z-score of an indicator is in the range between +2 and -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In GitLab, we use a custom routing rule that sends an alert through Slack when it detects any anomalies, but does not contact our support team.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to detect anomalies in GitLab using Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus can be used to detect some abnormalities.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proper aggregation is the key to finding anomalies.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-scoring is effective if your data has a normal distribution.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistical seasonality is a powerful mechanism for detecting anomalies.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translated with support from </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Still useful</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple Caching Methods in GitLab CI: A Picture Guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready-made and customized GitLab CE tools in the MCS marketplace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our Telegram channel on digital transformation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499014/index.html">23 difficult questions for JavaScript interviews</a></li>
<li><a href="../en499016/index.html">Integration with ESIA for .Net: easier than it sounds</a></li>
<li><a href="../en499018/index.html">6 home sports apps</a></li>
<li><a href="../en499020/index.html">A study of one vague behavior</a></li>
<li><a href="../en499030/index.html">Monitoring MySQL performance for Grafana on isic in 20 minutes</a></li>
<li><a href="../en499034/index.html">How to roll out dangerous refactoring to prod with a million users?</a></li>
<li><a href="../en499036/index.html">Provider's work: a selection of materials on protocols, IT and network infrastructure</a></li>
<li><a href="../en499038/index.html">My experience using a vertical monitor</a></li>
<li><a href="../en499040/index.html">Read on the weekend: a selection of materials on the history of DNS, IT regulation and hardware 1cloud.ru</a></li>
<li><a href="../en499044/index.html">News from the world of OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>