<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèΩ üïµüèΩ üëäüèΩ SSL Certificate Management: From Chaos on Hundreds of Servers to a Centralized Solution ‚è´ ü§∑üèæ üó®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What can be behind the words ‚ÄúEurope's largest online school‚Äù? On the one hand, this is 1 thousand lessons per hour, 10 thousand teachers, 100 thousan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SSL Certificate Management: From Chaos on Hundreds of Servers to a Centralized Solution</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/497432/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What can be behind the words ‚ÄúEurope's largest online school‚Äù? </font><font style="vertical-align: inherit;">On the one hand, this is 1 thousand lessons per hour, 10 thousand teachers, 100 thousand students. </font><font style="vertical-align: inherit;">And for me, an infrastructure engineer, this also includes 200+ servers, hundreds of services (micro and not very), domain names from the 2nd to the 6th level. </font><font style="vertical-align: inherit;">Everywhere you need SSL and, accordingly, a certificate for it.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/ha/dd/snhaddan7851uhnwtm7fjn8zste.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the most part, we use Let's Encrypt certificates. </font><font style="vertical-align: inherit;">Their advantages are that they are free, and the receipt is fully automated. </font><font style="vertical-align: inherit;">On the other hand, they have a feature: short - only three months - validity. </font><font style="vertical-align: inherit;">Accordingly, they have to be updated frequently. </font><font style="vertical-align: inherit;">We tried to automate it somehow, but still there was a lot of manual work, and something was constantly breaking. </font><font style="vertical-align: inherit;">A year ago, we came up with a simple and reliable method for updating this pile of certificates and since then we forgot about this problem.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From one certificate on one server to hundreds in several data centers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time there was only one server. </font><font style="vertical-align: inherit;">And on it lived a certbot, which worked from under the crown. </font><font style="vertical-align: inherit;">Then one server ceased to cope with the load, so another server appeared. </font><font style="vertical-align: inherit;">And then more and more. </font><font style="vertical-align: inherit;">Each of them had its own certificates with its own unique set of names, and everywhere it was necessary to configure their updating. </font><font style="vertical-align: inherit;">Somewhere during the extension, they copied existing certificates, but forgot about the update. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to obtain a Let's Encrypt certificate, you must confirm ownership of the domain name specified in the certificate. </font><font style="vertical-align: inherit;">This is usually done with a reverse HTTP request.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/p8/vy/z3/p8vyz3i9qzoxvbfmxkev6rev8t8.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are a couple of standard difficulties we encountered as we grew:</font></font></b><br>
<br>
<ul>
<li>      :            .      . </li>
<li>     HTTP. ,  .    .   - LDAP.    - .      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In some places self-signed certificates have been used for quite some time, and this seemed like a good solution in those places where authentication is not needed - for example, for internal testing. </font><font style="vertical-align: inherit;">To prevent the browser from constantly reporting a ‚Äúsuspicious site‚Äù, you just need to add our root certificate to the list of trusted ones, and the point is in the hat. </font><font style="vertical-align: inherit;">But later difficulties arose here too. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/mb/py/frmbpydq1rypmgjuwpz54phjjaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The trouble is that in BrowserStack, which testers use, it is impossible to add a certificate to the trusted list for at least iPad, Mac, iPhone. </font><font style="vertical-align: inherit;">So testers had to put up with constantly pop-up warnings about dangerous sites.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search for a solution</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, first of all, you need to do monitoring in order to find out about certificates that are ending not when they have already ended, but a little earlier. Oh well. Monitoring is, we now know that certificates will end soon here and there. And now what i can do? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/iw/tu/asiwtuhzz_az9aqy_lfwc2vohpq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Big Ear is an old bot that won't ruin a certificate. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And let's use wildcard certificates?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's! Let's Encrypt already issues them. True, you will have to configure confirmation of domain ownership through DNS. And our DNS lives in AWS Route53. And you have to decompose the access details in AWS across all servers. And with the advent of new servers, copy all this economy there too.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, 3rd level names are covered by wildcard. And what to do with names of the 4th level and higher? We have many teams that are engaged in the development of various services. Now it is customary to divide the frontend and backend. And if the frontend gets a 3rd-level name like </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service.skyeng.ru</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the backend tries to give the name </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.service.skyeng.ru</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hmm, maybe they forbid them to continue doing this? Great idea! And what to do with dozens of existing ones? Could it be with an iron hand to drive them all into one domain name? Replace all these names of different levels with URLs like </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skyeng.ru/service</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Technically, this is an option, but how long does it take? And how can business justify the need for such actions? We have 30+ development teams, persuade everyone - it will take at least six months. And we are creating a single point of failure. Like it or not, this is a controversial decision. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What other ideas are there? ..</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Maybe one certificate can be made where we include all-all-all? And we will install it on all servers. This could be the solution to our problems, but Let's Encrypt allows you to have only 100 names in the certificate, and we already have more than one microservice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do with testers? </font><font style="vertical-align: inherit;">They didn‚Äôt come up with anything, but they constantly complain. </font><font style="vertical-align: inherit;">All bullshit except the bees. </font><font style="vertical-align: inherit;">Bees are also garbage, but there are a lot of them. </font><font style="vertical-align: inherit;">Each developer or tester is given a test server - we call them testing. </font><font style="vertical-align: inherit;">Testings are not bees, but there are already over a hundred of them. </font><font style="vertical-align: inherit;">And for each all projects are deployed. </font><font style="vertical-align: inherit;">That's all. </font><font style="vertical-align: inherit;">And if for sale you need N certificates, then there is the same amount for each testing. </font><font style="vertical-align: inherit;">So far, they are self-signed. </font><font style="vertical-align: inherit;">It would be great to replace them with real ones ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two playbooks and one source of truth</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The swan, cancer, and pike will not bring the cart anywhere. We need a single </font><font style="vertical-align: inherit;">server </font><font style="vertical-align: inherit;">control </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">center</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In our case, this is Ansible. Certbot on every server is evil. Let all certificates be stored in one place. If somewhere someone needs a certificate, then come to this place and take the latest version from the shelf. And we will make sure that certificates are always up-to-date in this store. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWS access details are also present in only one place. Accordingly, questions disappear, such as setting up AWS CLI on a new server, who has access to Route53 and the like. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All required certificates are described in one file in Ansible in YAML format:</font></font><br>
<br>
<pre><code class="plaintext hljs">    certificates:<font></font>
      - common_name: skyeng.ru<font></font>
        alt_names:<font></font>
          - *.skyeng.ru<font></font>
      - common_name: olympiad.skyeng.ru<font></font>
        alt_names:<font></font>
          - *.olympiad.skyeng.ru<font></font>
          - api.content.olympiad.skyeng.ru<font></font>
          - games.skyeng.ru<font></font>
      - common_name: skyeng.tech<font></font>
        alt_names:<font></font>
          - *.skyeng.tech<font></font>
<font></font>
      .  .  .<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One playbook is launched periodically,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> which goes through this list and does its hard work - essentially the same thing as certbot does:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates an account with Let's Encrypt Certificate Authority</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generates a private key</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generates a (not yet signed) certificate - the so-called certificate signing request</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sends a signing request</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receives a DNS challenge</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puts received records in DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sends a signing request again</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and, having finally received the signed certificate, puts it in the store.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Playbook is performed once a day. </font><font style="vertical-align: inherit;">If he could not renew any certificates for any reason - be it network problems or some errors on the side of Let's Encrypt - this is not a problem. </font><font style="vertical-align: inherit;">Will be updated next time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, when SSL is needed on some service host, you can go to this repository and get a few files from there - the simplest operation that the second playbook performs ... What certificates are needed on this host are described in the parameters of this host, in </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inventories / host_vars / server .yml</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">    certificates:<font></font>
      - common_name: skyeng.ru<font></font>
        handler: reload nginx<font></font>
      - common_name: crm.skyeng.ru<font></font>
<font></font>
      .  .  .<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the files have changed, then Ansible pulls a hook - it is typical to restart Nginx (in our case, this is the default action). </font><font style="vertical-align: inherit;">And in the same way, you can obtain certificates from other CAs that use the ACME protocol.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We had many different configurations. </font><font style="vertical-align: inherit;">Something constantly broke. </font><font style="vertical-align: inherit;">Often I had to climb servers and figure out what had fallen off again.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we have two playbooks and everything is recorded in one place. </font><font style="vertical-align: inherit;">Everything works like a clock. </font><font style="vertical-align: inherit;">Life has become more boring.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, what about testers with their testing? </font><font style="vertical-align: inherit;">Each developer or tester is given a personal test server - testing. </font><font style="vertical-align: inherit;">There are currently about 200 of them. They have names of the form </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test-y123.skyeng.link</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">123</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the testing number. </font><font style="vertical-align: inherit;">Creating and removing testing is automated. </font><font style="vertical-align: inherit;">One of the components of the action is the installation of an SSL certificate on it. </font><font style="vertical-align: inherit;">An SSL certificate is generated in advance, with names by template:</font></font><br>
<br>
<pre><code class="plaintext hljs">    ssl_cert_pattern:<font></font>
      - *<font></font>
      - *.auth<font></font>
      - *.bill<font></font>
<font></font>
      .  .  .<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only about 30 names. </font><font style="vertical-align: inherit;">So the certificate comes with names</font></font><br>
<br>
<pre><code class="plaintext hljs">    test-y123.skyeng.link<font></font>
    *.test-y123.skyeng.link<font></font>
    *.auth.test-y123.skyeng.link<font></font>
    *.bill.test-y123.skyeng.link<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the dismissal of the developer or tester, his testing is deleted. </font><font style="vertical-align: inherit;">The certificate remains ready for use. </font><font style="vertical-align: inherit;">It‚Äôs all that is stored. You yourself know where it is decomposed into hosts; you yourself know how.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository with code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It might also be interesting to read on this topic </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://nickcraver.com/blog/2017/05/22/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how Stack Overflow switched to HTTPS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hundreds of domains of different levels</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Websockets</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lots of HTTP APIs (proxy issues)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do everything and not drop performance</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have any questions, write in the comments, I will be happy to answer.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497414/index.html">Network data processing on the fly</a></li>
<li><a href="../en497416/index.html">Touch Support in JavaScript</a></li>
<li><a href="../en497420/index.html">StegoPy - LSB Steganography Tool in Python</a></li>
<li><a href="../en497422/index.html">Cisco UCS through the eyes of a cloud provider</a></li>
<li><a href="../en497428/index.html">How we learned how to divide video into scenes using clever math</a></li>
<li><a href="../en497434/index.html">Exercise bike # Self-isolation or how to calm a child in quarantine</a></li>
<li><a href="../en497436/index.html">Geeky Groving, or a basement farm</a></li>
<li><a href="../en497438/index.html">How the registrar checks the availability of a domain name on the example of REG.RU</a></li>
<li><a href="../en497440/index.html">Stupidity is worse than the Pecheneg. Registered email of Russia</a></li>
<li><a href="../en497446/index.html">Alexander Iofa: ‚ÄúLeading a large team is walking along the edge of a knife‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>