<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔍 🚚 🥟 创建机器人以遵循路线的所有阶段，或者如何使用STM32收集所有耙 ℹ️ 👰🏼 🍆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！
 
 该出版物将讨论我在创建比赛用机器人（即紧随其后的机器人）方面的经验。我将尝试说明从设计电路，订购印刷电路板到算法和程序的所有阶段。
 
 长期以来，沿线的机器人竞赛一直是初学者机器人的基本考验。几乎所有区域和国际比赛都包括这个方向，因此，制造一个机器人可以使您几乎在任何地方都可以参加...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>创建机器人以遵循路线的所有阶段，或者如何使用STM32收集所有耙</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497782/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">哈Ha！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该出版物将讨论我在创建比赛用机器人（即紧随其后的机器人）方面的经验。</font><font style="vertical-align: inherit;">我将尝试说明从设计电路，订购印刷电路板到算法和程序的所有阶段。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
长期以来，沿线的机器人竞赛一直是初学者机器人的基本考验。</font><font style="vertical-align: inherit;">几乎所有区域和国际比赛都包括这个方向，因此，制造一个机器人可以使您几乎在任何地方都可以参加。</font><font style="vertical-align: inherit;">在大学的第一年，这是LED第一次闪烁后的下一个任务。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题的提法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任何发展都始于技术任务，在我们的案例中，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robofinist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">竞赛的竞赛规则被用作TK </font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们对尺寸（不超过25x25x25厘米）和机器人重量（不超过1千克）以及轨道的形状及其宽度1.5厘米的要求感兴趣。根据轨道的复杂程度，为通过的最短时间（60秒）设置了阈值。 ）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任务很明确，我们需要一个能够在最短时间内检测到一条直线并从头到尾沿着其行驶的机器人。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念设计</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该机器人的核心是STM32F103C8T6微控制器，它使用QRE1113光学传感器读取轨道信息，并通过A3906驱动器控制引擎。为了清楚起见，每个传感器都分配有自己的LED，一旦传感器“看到”黑线，LED就会亮起，这大大简化了调试过程。作为电源，选择了电压为3.7 V的Li-po型18650电池和充电芯片LTC4054ES5。但是为了使电动机正确工作，至少需要6 V，因此，我安装了LM2577 DC-DC升压电压转换器和LM1117线性3.3 V来为逻辑部分供电。</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/aa5/0a0/ddf/aa50a0ddf75671c4ee28137f1fbf8c47.jpg" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在该谈论第一个错误了。不专心地，我混合了一对微控制器电源引脚，并且在启动时花了几个小时寻找问题，结果我不得不咬它们。然后出现的问题是，并不是所有的传感器都对线路做出反应，我的第一个反应是烧毁了微控制器，或者在最后阶段电源的断脚根本不是多余的，或者是我的触点焊接不良。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用示波器，我发现问题出在传感器本身上，在10个传感器中有4个不起作用，用新的传感器替换后，出现了以下问题-三个指示灯PB3，PB4和PA15不起作用。重写并查看了所有代码后，在推挽式，10 MHz和时钟使能的所有地方，我都无法找到非工作端口和工作端口的初始化差异。看完波形图后，我发现一个引脚被加号吸引，即使在调试模式下它也没有复位，我意识到微控制器已烧毁。在关闭数据表时，我注意到一个偶然的巧合，这些引脚用于JTAG，而我使用SWD，但是在确定情况不会恶化之后，我开始仔细研究如何禁用JTAG，这确实有所帮助（见下文）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总结一下，请在所有阶段检查正确的营养，以免以后再燃烧或其他原因使它无效。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该方案需要改进的地方</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我猜想放充电芯片，但我忘了放电，尽管它并不重要，再加上2020年我放了mini USB而不是C型。我想用微控制器来监视电池充电，但它没有任何ADC引脚了。</font><font style="vertical-align: inherit;">在选择驱动器时，我依赖于6 V和700 mA引擎的特性，但没有考虑其最大电压为9 V，但我希望使用12V。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCB设计</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，决定确定PP的大小和形状以及机器人的兼职平台。我们记得，根据规定，尺寸不得超过25x25厘米，但也值得考虑的是，在中国的工厂（PCBWay）订购软件时，尺寸超过10x10厘米的电路板价格会明显上涨。我认为尺寸的选择是显而易见的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，应考虑线宽，然后考虑最重的元素（例如电动机和电池），将传感器对称地分布（在电路板的底部）。 LED在板的另一侧与相应传感器安装在同一轴上。为了方便起见，我们在平台背面安装了电源开关和电池充电连接器。其余元素设置为更靠近中心。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
切掉木板的空边缘而不是正方形，可以获得机器人平台的完全不错的图像。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于独特元素的数量很少，因此该板非常简单。</font><font style="vertical-align: inherit;">共2层，最小轨道厚度为0.25 mm。</font><font style="vertical-align: inherit;">将主板保存为Gerber格式后，我通过选择面罩的白色将其发送到工厂，没有任何特殊问题。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/57e/f74/2c8/57ef742c8e35e324720908b0758200cc.jpg" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以及带有元素的电路板的3D视图。</font><font style="vertical-align: inherit;">实时照片将在结尾。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/37f/a8b/65d/37fa8b65d80595744c2e2436490b304e.jpg" alt="图片"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要在董事会中完成哪些工作</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我安装的某些元件太靠近电池的塑料外壳，很难焊接，甚至更难焊接。</font><font style="vertical-align: inherit;">我忘记签名编程连接器SWD，UART和引擎的引脚，因此，我不得不研究电路。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">购买零件</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开发新产品需要每单位商品最高的相对成本，您可以并且应该设法节省，但是要在合理的范围内，因此在Aliexpress上订购线传感器比在电子商店中便宜4.5倍，我为此付出了大约40％的事实无法正常工作，这是查找和修复错误的时间。</font><font style="vertical-align: inherit;">另一方面，我不想以460卢布的价格购买LM2577芯片，而带有所有捆扎带的模块的价格为100卢布。</font><font style="vertical-align: inherit;">我向阿里订购了一部分零件，另一部分是在当地商店订购的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是我估计的组件成本：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发动机和车轮-800卢布；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">电池和外壳-400卢布；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">充电器-300卢布；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微控制器和驱动器-200卢布；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稳定剂-400卢布；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">费用10单位交付2400/10 =每单位240卢布;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">线束的其余部分-150卢布。</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总计：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4650卢布的组件总成本，如果减去剩余的九块未使用板的价格，则为2490卢布。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD：我开始计算电路板和组件的安装成本以及每10个单元的成本。</font><font style="vertical-align: inherit;">价格增加到16,000卢布。</font><font style="vertical-align: inherit;">有想法如何优化，但这是另一次。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该算法实现的最简单，例如，如果直线位于右侧，则右侧引擎将开始减速，直线越靠近边缘，引擎将越慢运行，直到完全停止，而左侧引擎将以最大速度运行。试图转向线。</font><font style="vertical-align: inherit;">如果线在左侧，则情况类似。</font><font style="vertical-align: inherit;">因此，机器人试图稳定，将线路返回到中央传感器。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22b/07d/9ab/22b07d9ab0c0795c33cda8c42236e18f.jpg" alt="图片"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图片算法</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/ae3/234/6c5/ae32346c5611292cf0b7fc155317da5a.jpg" alt="图片"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b47/403/545/b47403545480435eed6c7b362dbad0bd.jpg" alt="图片"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5d8/55b/68c/5d855b68c11937aa1196d6d281c5c939.jpg" alt="图片"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/481/545/42c4815453ca35de5c6dc32570e09506.jpg" alt="图片"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/587/7ee/4db/5877ee4db1610d2aab5ace1af4cd27b3.jpg" alt="图片"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还必须提供其他情况，例如，如果所有传感器都检测到一条线，则最有可能意味着我们正在穿越交叉路口，并且最有可能需要进一步前进。</font><font style="vertical-align: inherit;">或者，如果只有极限传感器检测到该线，则我们到达终点线，我们需要停车。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程式设计</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这个阶段，您需要铃鼓并敲打它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Atollic True Studio中编写仅使用CMSIS和FreeRTOS。花了半个星期启动FreeRTOS，按照说明进行了所有操作，但是在编译过程中发现了错误，修复了1，1，63出现了，或者没有错误，但是控制器崩溃了。在某个时候，我意识到我的手...达到了前所未有的高度，是时候考虑我在做什么和在做什么了。多亏社区的同志，我才开始朝着正确的方向进行挖掘，并从许多重新绘制的资源中发现了一些对我有帮助的资源（请参阅下文）。结果，我设法击败了FreeRTOS，到目前为止，我将它的使用率为0％，因为我将所有内容都塞进了一项任务中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视频</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文章</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对我的帮助最大</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
计时系统，在这里我仍然不确定它是否可以正常工作。通过PLL将系统频率调整为48 MHz之后，我在MCO的脚下看到了24 MHz（/ 2），没有，我看到了一个22-25 MHz的信号，正像一个正弦信号。同时，我在FreeRTOS配置中设置48 MHz，并将延迟设置为500 ms并运行它，看到我的500 ms变为300，经过所有可能的设置，并注意到只有当从内部发生器时钟到8 MHz时，我才达到目标500 ms，并且频率值FreeRTOS配置完全不受影响，设置为1 Hz和48 GHz。我决定返回48 MHz并以300 ms工作，此后我不小心重启了True Studio，并且按我的想法工作得非常好，从一开始我就已经指出了所有文件路径。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如上所述，JTAG和LED的问题在</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">此处</font></a><font style="vertical-align: inherit;">找到了解决方案</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您只需要禁用它即可释放对PB3，PB4和PA15引脚的访问权限。</font></font><br>
<br>
<pre><code class="cpp hljs">AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该项目的结构大致如下：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">很多代码</font></font></b>
                        <div class="spoiler_text">1.   ;<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{						<span class="hljs-comment">// Quartz 16 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLXTPRE;	<span class="hljs-comment">// PLLXTPRE set divider (/2) = 8 MHz</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_HSEON;			<span class="hljs-comment">// On HSE</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_HSERDY)) {<font></font>
	};<font></font>
<font></font>
	RCC-&gt;CFGR |= (RCC_CFGR_PLLMULL6);     <span class="hljs-comment">// Setup PLLMULL set multiplier (x6) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_PLLSRC;		<span class="hljs-comment">// PLLSRC set HSE</span><font></font>
<font></font>
	RCC-&gt;CR |= RCC_CR_PLLON;			<span class="hljs-comment">// ON PLL</span>
	<span class="hljs-keyword">while</span> (!(RCC-&gt;CR &amp; RCC_CR_PLLRDY)) {<font></font>
	};<font></font>
<font></font>
	FLASH-&gt;ACR &amp;= ~FLASH_ACR_LATENCY;	<span class="hljs-comment">// Setup FLASH</span><font></font>
	FLASH-&gt;ACR |= FLASH_ACR_LATENCY_1;<font></font>
<font></font>
	RCC-&gt;CFGR |= RCC_CFGR_HPRE_DIV1; 	<span class="hljs-comment">// Set not divider (AHB) = 48 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE1_DIV2; 	<span class="hljs-comment">// Set divider (/2) (APB1) = 24 MHz</span>
	RCC-&gt;CFGR |= RCC_CFGR_PPRE2_DIV1; 	<span class="hljs-comment">// Set not divider (APB2) = 48 MHz</span><font></font>
<font></font>
	RCC-&gt;CFGR &amp;= ~RCC_CFGR_SW; 		<span class="hljs-comment">// Setup SW, select PLL</span><font></font>
	RCC-&gt;CFGR |= RCC_CFGR_SW_PLL;<font></font>
<font></font>
<span class="hljs-comment">//	RCC-&gt;CFGR |= RCC_CFGR_MCO_SYSCLK;</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
2.  ,      ,     ,      Push Pull;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">GPIO_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB2ENR |=	(RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN); <span class="hljs-comment">// Enable clock portA, portB and Alternative function</span><font></font>
<font></font>
	AFIO-&gt;MAPR |= AFIO_MAPR_SWJ_CFG_JTAGDISABLE;	<span class="hljs-comment">// Disable JTAG for pins B3,B4 and A15</span><font></font>
<font></font>
	<span class="hljs-comment">//---------------LED: (B3 to B9; A11, A12, A15); Output mode: Push Pull, max 10 MHz---------------//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE3_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup B3 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE4_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup B4 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE5_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup B5 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE6_0;<font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup B6 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRL |= GPIO_CRL_MODE7_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);	<span class="hljs-comment">// Setup B7 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF9 | GPIO_CRH_MODE9);	<span class="hljs-comment">// Setup B8 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |= GPIO_CRH_MODE9_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF11 | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup A11 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE11_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);	<span class="hljs-comment">// Setup A12 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE12_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF15 | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup A15 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE15_0;<font></font>
<font></font>
	<span class="hljs-comment">//--Motors: (A8 to A10; B12 to B15); Output and input (B12, B13) mode: Alternative function, PWM - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12);		<span class="hljs-comment">// Setup B12 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13);		<span class="hljs-comment">// Setup B13 pins analog input</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF14   | GPIO_CRH_MODE14);	<span class="hljs-comment">// Setup B14 pins PP, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  GPIO_CRH_MODE14_0;<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF15   | GPIO_CRH_MODE15);	<span class="hljs-comment">// Setup B15 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF15_1 | GPIO_CRH_MODE15_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF8 | GPIO_CRH_MODE8);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE8_0;<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF9    | GPIO_CRH_MODE9);		<span class="hljs-comment">// Setup A9 pins PP, AF, 10MHz</span><font></font>
	GPIOA-&gt;CRH |=  (GPIO_CRH_CNF9_1  | GPIO_CRH_MODE9_0);<font></font>
<font></font>
	GPIOA-&gt;CRH &amp;= ~(GPIO_CRH_CNF10 | GPIO_CRH_MODE10);		<span class="hljs-comment">// Setup A10 pins PP, 10MHz</span><font></font>
	GPIOA-&gt;CRH |= GPIO_CRH_MODE10_0;<font></font>
<font></font>
	<span class="hljs-comment">//--UART3: (B10 - TX; B11 - RX); Output mode: Alternative function, UART - Push Pull, max 10 MHz--//</span><font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF10   | GPIO_CRH_MODE10);	<span class="hljs-comment">// Setup B10 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF10_1 | GPIO_CRH_MODE10_0);<font></font>
<font></font>
	GPIOB-&gt;CRH &amp;= ~(GPIO_CRH_CNF11   | GPIO_CRH_MODE11);	<span class="hljs-comment">// Setup B11 pins PP, AF, 10MHz</span><font></font>
	GPIOB-&gt;CRH |=  (GPIO_CRH_CNF11_1 | GPIO_CRH_MODE11_0);<font></font>
<font></font>
	<span class="hljs-comment">//--Optical sensors: (B0, B1, A0 - A7); Input mode: Analog--//</span><font></font>
<font></font>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup B0 pins analog input</span>
	GPIOB-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup B1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0);	<span class="hljs-comment">// Setup A0 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);	<span class="hljs-comment">// Setup A1 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF2 | GPIO_CRL_MODE2);	<span class="hljs-comment">// Setup A2 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF3 | GPIO_CRL_MODE3);	<span class="hljs-comment">// Setup A3 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4);	<span class="hljs-comment">// Setup A4 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5);	<span class="hljs-comment">// Setup A5 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6);	<span class="hljs-comment">// Setup A6 pins analog input</span>
	GPIOA-&gt;CRL &amp;= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7);	<span class="hljs-comment">// Setup A7 pins analog input</span><font></font>
<font></font>
}<font></font>
</code></pre><br>
3.       DMA,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>;<br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ADC_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	 RCC-&gt;AHBENR |= RCC_AHBENR_DMA1EN;<font></font>
	 DMA1_Channel1-&gt;CPAR = (<span class="hljs-keyword">uint32_t</span>) &amp;ADC1-&gt;DR;		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CMAR = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>) adc_buf;   	<span class="hljs-comment">//    </span><font></font>
<font></font>
	 DMA1_Channel1-&gt;CNDTR = <span class="hljs-number">10</span>;			  				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;			   		<span class="hljs-comment">//   </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MSIZE_0;		  		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_PSIZE_0;		 		<span class="hljs-comment">//   16 bit</span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_MINC;			  	<span class="hljs-comment">// memory increment mode</span><font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_CIRC;<font></font>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_TCIE;				<span class="hljs-comment">//    </span>
	 DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;				  	<span class="hljs-comment">//  </span>
	 NVIC_SetPriority(DMA1_Channel1_IRQn, <span class="hljs-number">10</span>);<font></font>
	 NVIC_EnableIRQ(DMA1_Channel1_IRQn);<font></font>
<font></font>
	 RCC-&gt;CFGR &amp;= ~RCC_CFGR_ADCPRE;<font></font>
	 RCC-&gt;CFGR |= RCC_CFGR_ADCPRE_DIV8;<font></font>
	 RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN;<font></font>
<font></font>
	 ADC1-&gt;SQR3 = <span class="hljs-number">0</span>;			<span class="hljs-comment">// 1</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 2     </span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 3</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 4</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">20</span>;		<span class="hljs-comment">// 5</span>
	 ADC1-&gt;SQR3 |= <span class="hljs-number">5</span> &lt;&lt; <span class="hljs-number">25</span>;		<span class="hljs-comment">// 6</span>
	 ADC1-&gt;SQR2 = <span class="hljs-number">6</span>;			<span class="hljs-comment">// 7</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">7</span> &lt;&lt; <span class="hljs-number">5</span>;		<span class="hljs-comment">// 8</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">10</span>;		<span class="hljs-comment">// 9</span>
	 ADC1-&gt;SQR2 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">15</span>;		<span class="hljs-comment">// 10</span><font></font>
<font></font>
	 ADC1-&gt;CR2 = ADC_CR2_EXTSEL_0 | ADC_CR2_EXTSEL_1 | ADC_CR2_EXTSEL_2<font></font>
	 | ADC_CR2_EXTTRIG;<font></font>
	 ADC1-&gt;SMPR1 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//   </span>
	 ADC1-&gt;SMPR2 = <span class="hljs-number">0</span>;					 		<span class="hljs-comment">//</span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 0,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">1</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 1,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">2</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 2,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">3</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 3,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">4</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 4,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">5</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 5,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">6</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 6,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">7</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 7,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">8</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 8,   6 </span>
	 ADC1-&gt;SMPR2 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">9</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 9,   6 </span>
	 ADC1-&gt;SMPR1 |= (<span class="hljs-keyword">uint32_t</span>) (<span class="hljs-number">6</span> &lt;&lt; (<span class="hljs-number">0</span> * <span class="hljs-number">3</span>)); 	<span class="hljs-comment">// 10,   6 </span><font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_RSTCAL;<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_RSTCAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_CAL;<font></font>
<font></font>
	 <span class="hljs-keyword">while</span> ((ADC1-&gt;CR2 &amp; ADC_CR2_RSTCAL) == ADC_CR2_CAL) {<font></font>
	 }<font></font>
<font></font>
	 ADC1-&gt;SQR1 |= <span class="hljs-number">9</span> &lt;&lt; <span class="hljs-number">20</span>;						<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR1 |= ADC_CR1_SCAN;					<span class="hljs-comment">//  </span>
	 ADC1-&gt;CR2 |= ADC_CR2_DMA;				  	<span class="hljs-comment">// DMA on</span>
	 <span class="hljs-comment">// ADC1-&gt;CR2 |= ADC_CR2_CONT;</span><font></font>
<font></font>
	 <span class="hljs-comment">//  ADC1-&gt;CR2 |= ADC_CR2_SWSTART;</span><font></font>
	 ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
<font></font>
}<font></font>
</code></pre><br>
4.        ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM1_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	<span class="hljs-comment">/*************** Enable TIM1 (CH1) ***************/</span><font></font>
	RCC-&gt;APB2ENR |= RCC_APB2ENR_TIM1EN;<font></font>
	TIM1-&gt;CCER = <span class="hljs-number">0</span>;										<span class="hljs-comment">//  CCER ( )</span>
	TIM1-&gt;ARR = <span class="hljs-number">1000</span>; 									<span class="hljs-comment">//  ,     </span>
	TIM1-&gt;PSC = <span class="hljs-number">48</span> - <span class="hljs-number">1</span>;                					<span class="hljs-comment">// </span>
	TIM1-&gt;BDTR |= TIM_BDTR_MOE;     					<span class="hljs-comment">//     </span><font></font>
<font></font>
	TIM1-&gt;CCR2 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR1 |= TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= (TIM_CCER_CC2P |TIM_CCER_CC2E); 		<span class="hljs-comment">//        </span>
														<span class="hljs-comment">//   -   3</span>
	TIM1-&gt;CCR3 = <span class="hljs-number">0</span>; 									<span class="hljs-comment">//       (  0  TIM1-&gt;ARR)</span>
	TIM1-&gt;CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2; <span class="hljs-comment">//     </span>
	TIM1-&gt;CCER |= TIM_CCER_CC3NE; 						<span class="hljs-comment">//        </span><font></font>
	TIM1-&gt;CCER &amp;= ~TIM_CCER_CC3NP;<font></font>
<font></font>
	TIM1-&gt;CR1 |= TIM_CR1_CEN;<font></font>
}<font></font>
</code></pre><br>
5.  UART  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>     ;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC-&gt;APB1ENR |= RCC_APB1ENR_USART3EN;<font></font>
<font></font>
	USART3-&gt;BRR = <span class="hljs-number">0xD0</span>;						<span class="hljs-comment">// Speed = 115200; (24 000 000 + (115200 / 2)) / 115200 = 208 -&gt; 0xD0</span><font></font>
<font></font>
	USART3-&gt;CR1 |= USART_CR1_TE | USART_CR1_RE | USART_CR1_UE;<font></font>
<font></font>
<span class="hljs-comment">//	USART3-&gt;CR1 |= USART_CR1_RXNEIE;</span>
<span class="hljs-comment">//	NVIC_EnableIRQ(USART3_IRQn);</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send</span><span class="hljs-params">(<span class="hljs-keyword">char</span> chr)</span> </span>{
	<span class="hljs-keyword">while</span> (!(USART3-&gt;SR &amp; USART_SR_TC))<font></font>
		;<font></font>
	USART3-&gt;DR = chr;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_String</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* str)</span> </span>{
	<span class="hljs-keyword">uint8_t</span> i = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (str[i])<font></font>
		UART3_Send(str[i++]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UART3_Send_Number_Float</span><span class="hljs-params">(<span class="hljs-keyword">float</span> data)</span></span>{<font></font>
<font></font>
	<span class="hljs-keyword">char</span> str[<span class="hljs-number">100</span>];<font></font>
<font></font>
	<span class="hljs-keyword">char</span> *tmpSign = (data &lt; <span class="hljs-number">0</span>) ? <span class="hljs-string">"-"</span> : <span class="hljs-string">""</span>;
	<span class="hljs-keyword">float</span> tmpVal = (data &lt; <span class="hljs-number">0</span>) ? -data : data;<font></font>
<font></font>
	<span class="hljs-keyword">int</span> tmpInt1 = tmpVal;                  <span class="hljs-comment">// Get the integer (678).</span>
	<span class="hljs-keyword">float</span> tmpFrac = tmpVal - tmpInt1;      <span class="hljs-comment">// Get fraction (0.0123).</span>
	<span class="hljs-keyword">int</span> tmpInt2 = trunc(tmpFrac * <span class="hljs-number">10</span>);  <span class="hljs-comment">// Turn into integer (123).	int tmpInt2 = trunc(tmpFrac * 10000)</span><font></font>
<font></font>
	<span class="hljs-comment">// Print as parts, note that you need 0-padding for fractional bit.</span><font></font>
<font></font>
	<span class="hljs-built_in">sprintf</span> (str, <span class="hljs-string">"%s%d.%01d"</span>, tmpSign, tmpInt1, tmpInt2);<font></font>
<font></font>
	UART3_Send_String(str);<font></font>
}<font></font>
</code></pre><br>
6.     FreeRtos config<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*
 * FreeRTOS Kernel V10.3.1
 * Copyright (C) 2020 Amazon.com, Inc. or its affiliates.  All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * http://www.FreeRTOS.org
 * http://aws.amazon.com/freertos
 *
 * 1 tab == 4 spaces!
 */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> FREERTOS_CONFIG_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREERTOS_CONFIG_H</span><font></font>
<font></font>
<span class="hljs-comment">/* Library includes. */</span>
<span class="hljs-comment">//#include "stm32f10x_lib.h"</span>
<span class="hljs-comment">/*-----------------------------------------------------------
 * Application specific definitions.
 *
 * These definitions should be adjusted for your particular hardware and
 * application requirements.
 *
 * THESE PARAMETERS ARE DESCRIBED WITHIN THE 'CONFIGURATION' SECTION OF THE
 * FreeRTOS API DOCUMENTATION AVAILABLE ON THE FreeRTOS.org WEB SITE. 
 *
 * See http://www.freertos.org/a00110.html
 *----------------------------------------------------------*/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler		<span class="hljs-comment">// fix problem</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortPendSVHandler PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vPortSVCHandler SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xPortSysTickHandler SysTick_Handler</span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_PREEMPTION		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_IDLE_HOOK			0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TICK_HOOK			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configCPU_CLOCK_HZ			( ( unsigned long ) 48000000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTICK_RATE_HZ			( ( TickType_t ) 1000 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_PRIORITIES		( 5 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMINIMAL_STACK_SIZE	( ( unsigned short ) 32 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configTOTAL_HEAP_SIZE		( ( size_t ) ( 17 * 1024 ) )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_TASK_NAME_LEN		( 16 )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_TRACE_FACILITY	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_16_BIT_TICKS		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configIDLE_SHOULD_YIELD		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_MUTEXES			1</span><font></font>
<font></font>
<span class="hljs-comment">/* Co-routine definitions. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configUSE_CO_ROUTINES 		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_CO_ROUTINE_PRIORITIES ( 2 )</span><font></font>
<font></font>
<span class="hljs-comment">/* Set the following definitions to 1 to include the API function, or zero
 to exclude the API function. */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskPrioritySet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_uxTaskPriorityGet		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelete				1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskCleanUpResources	0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskSuspend			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelayUntil			1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDE_vTaskDelay				1</span><font></font>
<font></font>
<span class="hljs-comment">/* This is the raw value as per the Cortex-M3 NVIC.  Values can be 255
 (lowest) to 0 (1?) (highest). */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configKERNEL_INTERRUPT_PRIORITY 		255</span>
<span class="hljs-comment">/* !!!! configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to zero !!!!
 See http://www.FreeRTOS.org/RTOS-Cortex-M3-M4.html. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY 	191 <span class="hljs-comment">/* equivalent to 0xb0, or priority 11. */</span></span><font></font>
<font></font>
<span class="hljs-comment">/* This is the value being used as per the ST library which permits 16
 priority values, 0 to 15.  This must correspond to the
 configKERNEL_INTERRUPT_PRIORITY setting.  Here 15 corresponds to the lowest
 NVIC value of 255. */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configLIBRARY_KERNEL_INTERRUPT_PRIORITY	15</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* FREERTOS_CONFIG_H */</span></span><font></font>
<font></font>
</code></pre><br>
7.    main;<br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"main.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//define      typedef enum :)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorLeft		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MotorRight		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveBack		0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MoveForward		1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MaxSpeedMotor	1000</span><font></font>
<font></font>
<span class="hljs-keyword">uint16_t</span> adc_buf[<span class="hljs-number">10</span>];				<span class="hljs-comment">// Buffer DMA ADC sensors</span>
<span class="hljs-keyword">uint16_t</span> SensWhiteOrBlack[<span class="hljs-number">10</span>];		<span class="hljs-comment">// Buffer sensors white or black</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	RCC_Init();<font></font>
	GPIO_Init();<font></font>
	TIM1_Init();<font></font>
	UART3_Init();<font></font>
	ADC_Init();<font></font>
<font></font>
	xTaskCreate(vTaskUART2, <span class="hljs-string">"UART"</span>, <span class="hljs-number">512</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
	xTaskCreate(vTaskConvADC, <span class="hljs-string">"ADC"</span>, <span class="hljs-number">128</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	UART3_Send_String(<span class="hljs-string">"Start program\r\n"</span>);<font></font>
<font></font>
	GPIOA-&gt;BSRR |= GPIO_BSRR_BS10;	<span class="hljs-comment">// Motor enable</span><font></font>
<font></font>
	vTaskStartScheduler();<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">/*************************************Tasks***************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskUART2</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
<span class="hljs-comment">//-------------------Read sensors from buff DMA ADC, and print to UART3-------------//</span><font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (adc_buf[i] &lt;= <span class="hljs-number">300</span>)		<span class="hljs-comment">// value sens is white</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">0</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">0</span>;<font></font>
			} <span class="hljs-keyword">else</span>						<span class="hljs-comment">// else value sens is black</span><font></font>
			{<font></font>
				IndicatorLED(i, <span class="hljs-number">1</span>);<font></font>
				SensWhiteOrBlack[i] = <span class="hljs-number">1</span>;<font></font>
			}<font></font>
<font></font>
<span class="hljs-comment">//			UART3_Send_Number_Float(SensWhiteOrBlack[i]);</span>
<span class="hljs-comment">//			UART3_Send_String("\t");</span><font></font>
		}<font></font>
<span class="hljs-comment">///		UART3_Send_String("\r\n");</span><font></font>
<font></font>
<span class="hljs-comment">//-----------------------------------------Move-----------------------------------------//</span><font></font>
<font></font>
<font></font>
		<span class="hljs-comment">//----Normal mode----//</span>
		<span class="hljs-keyword">float</span> devMotorLeft  = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">float</span> devMotorRight = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">uint32_t</span> flagSizeBuf = <span class="hljs-number">0</span>;<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">6</span>; i &lt;= <span class="hljs-number">9</span>; i++)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">6</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">7</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">8</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">9</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorRight = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">5</span>; i &gt;= <span class="hljs-number">0</span>; i--)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span>(SensWhiteOrBlack[i])<font></font>
			{<font></font>
				flagSizeBuf = <span class="hljs-number">1</span>;<font></font>
<font></font>
				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">3</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.75</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">2</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.5</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.25</span>;<font></font>
				}<font></font>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span> &amp;&amp; SensWhiteOrBlack[i] == <span class="hljs-number">1</span>)<font></font>
				{<font></font>
					devMotorLeft = <span class="hljs-number">0.0</span>;<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">if</span>(!flagSizeBuf)<font></font>
		{<font></font>
			devMotorLeft  = <span class="hljs-number">0</span>;<font></font>
			devMotorRight = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
<font></font>
		Motor(MotorRight, (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorRight), MoveForward);<font></font>
		Motor(MotorLeft,  (<span class="hljs-keyword">int32_t</span>)(MaxSpeedMotor * (<span class="hljs-keyword">float</span>)devMotorLeft),  MoveForward);<font></font>
<font></font>
<font></font>
<span class="hljs-comment">/*
		if (adc_buf[0] &gt; 1000)
		{
			Motor(MotorLeft, 500, MoveBack);
		}
		else if (adc_buf[0] &lt;= 1000)
		{
			Motor(MotorLeft, 0, MoveForward);
		}

		if (adc_buf[9] &gt; 1000)
		{
			Motor(MotorRight, 500, MoveBack);//Motor(0, 500, 1);	MotorRight	MoveBack
		}
		else if (adc_buf[9] &lt;= 1000)
		{
			Motor(MotorRight, 0, MoveForward);
		}
*/</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">50</span>);<font></font>
	}<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vTaskConvADC</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *argument)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
<font></font>
		<span class="hljs-comment">// just void :)</span><font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">5000</span>);<font></font>
	}<font></font>
<font></font>
}<font></font>
<span class="hljs-comment">/**********************************Function*************************************/</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IndicatorLED</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> number, <span class="hljs-keyword">uint32_t</span> status)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">0</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR9;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">1</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">2</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR7;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">3</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR6;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">4</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR5;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">5</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR4;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BS3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">6</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOB-&gt;BSRR |= GPIO_BSRR_BR3;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">7</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR15;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">8</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR12;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">0</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BS11;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (number == <span class="hljs-number">9</span> &amp;&amp; status == <span class="hljs-number">1</span>) {<font></font>
		GPIOA-&gt;BSRR |= GPIO_BSRR_BR11;<font></font>
	}<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">Motor</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> which, <span class="hljs-keyword">int32_t</span> speed, <span class="hljs-keyword">int32_t</span> turn)</span> </span>{<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (which == <span class="hljs-number">0</span>)	<span class="hljs-comment">//Right motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\t"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR3 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">0</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BS14;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR3 = <span class="hljs-number">0</span>;<font></font>
			GPIOB-&gt;BSRR |= GPIO_BSRR_BR14;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (which == <span class="hljs-number">1</span>)	<span class="hljs-comment">//left motor</span><font></font>
	{<font></font>
		UART3_Send_Number_Float(speed);<font></font>
		UART3_Send_String(<span class="hljs-string">"\r\n"</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (speed &gt; <span class="hljs-number">0</span> &amp;&amp; speed &lt;= <span class="hljs-number">1000</span>)<font></font>
		{<font></font>
			TIM1-&gt;CCR2 = speed;<font></font>
			<span class="hljs-keyword">if</span> (turn == <span class="hljs-number">1</span>) 	<span class="hljs-comment">// back</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span>			<span class="hljs-comment">//forward</span><font></font>
			{<font></font>
				GPIOA-&gt;BSRR |= GPIO_BSRR_BR8;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>		<span class="hljs-comment">//disable motor</span><font></font>
		{<font></font>
			TIM1-&gt;CCR2 = <span class="hljs-number">0</span>;<font></font>
			GPIOA-&gt;BSRR |= GPIO_BSRR_BS8;<font></font>
<font></font>
		}<font></font>
<font></font>
	}<font></font>
<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*************************************IRQ***************************************/</span>
<span class="hljs-comment">/*
 void USART2_IRQHandler(void) {

 if (USART2-&gt;SR &amp; USART_CR1_RXNEIE) {

 USART2-&gt;SR &amp;= ~USART_CR1_RXNEIE;

 if (USART2-&gt;DR == '0') {
 UART2_Send_String("OFF\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BS13;
 } else if (USART2-&gt;DR == '1') {
 UART2_Send_String("ON\r\n");
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 } else if (USART2-&gt;DR == '2') {
 uint16_t d0 = ADC1-&gt;DR;
 float Vdd = 1.2 * 4069 / d0;
 UART2_Send(Vdd);
 GPIOC-&gt;BSRR = GPIO_BSRR_BR13;
 }
 }
 }
 */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DMA1_Channel1_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
<font></font>
	DMA1-&gt;IFCR = DMA_IFCR_CGIF1 | DMA_IFCR_CTCIF1;	<span class="hljs-comment">// clear DMA interrupt flags</span>
	DMA1_Channel1-&gt;CCR &amp;= ~DMA_CCR_EN;					<span class="hljs-comment">//  </span>
	<span class="hljs-comment">/*
	 * Code
	 */</span>
	DMA1_Channel1-&gt;CCR |= DMA_CCR_EN;			   <span class="hljs-comment">//  </span><font></font>
	ADC1-&gt;CR2 |= ADC_CR2_ADON;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聊一点</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这个项目已经按照我的计划执行了好几年，并且一直被推迟，但是现在它真的得出了合乎逻辑的结论，我很高兴完成这一点，我希望将其部分开放并作为另一个平台/构造函数出售，如果可能的话，那么相扑手的机器人不远，其他人会去。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有写文章的计划，但是参与比赛需要它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我差点忘了这张照片，有些部件还没到，比赛的截止日期是明天，所以我不得不使用DIY来达到最佳效果。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">机器人照片</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/961/400/6f6961400a8062733354fd8ac85b41a0.jpg" alt="image"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个迷你测试视频</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hk-FURUHLvc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN497764/index.html">如何准备游戏以移植到PC和控制台</a></li>
<li><a href="../zh-CN497768/index.html">消毒自动化</a></li>
<li><a href="../zh-CN497770/index.html">PyCaret简介：一个开放的低代码Python机器学习库</a></li>
<li><a href="../zh-CN497772/index.html">Wargaming的开发-与平台负责人Maxim Baryshnikov会晤（第二部分）</a></li>
<li><a href="../zh-CN497780/index.html">在拉丁美洲的三年时间：我如何去做梦，然后在完全“重置”之后返回</a></li>
<li><a href="../zh-CN497784/index.html">HiDC解决方案，用于基于华为企业设备构建数据中心的现代化ICT基础架构</a></li>
<li><a href="../zh-CN497786/index.html">现在是一个穿靴子的鞋匠，或者我们如何获得自己的风格指南</a></li>
<li><a href="../zh-CN497788/index.html">面向设计师的十大Chrome扩展程序</a></li>
<li><a href="../zh-CN497790/index.html">我们邀请您参加DINS QA晚会：谈论邮递员和测试覆盖率评估方法</a></li>
<li><a href="../zh-CN497792/index.html">新手股票投资者的工具：测试访问权限，启动费率，交易终端</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>