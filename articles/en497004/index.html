<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèº ‚òÇÔ∏è ‚úäüèª Discard activation (TRIM) on Linux for SSD üîå üíò üèà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modern data storage devices such as SSDs need the TRA command of the ATA interface, and for this, the OS based on the Linux kernel provides two contro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Discard activation (TRIM) on Linux for SSD</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497004/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modern data storage devices such as SSDs need the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRA command of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the ATA interface, and for this, the OS based on the Linux kernel provides two control methods at the file system level:</font></font></p><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discard</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - installed as an option to mount the file system. </font><font style="vertical-align: inherit;">Allows the Linux kernel to immediately send the TRIM command to the device as soon as the file system reports it.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fstrim</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a utility that is launched manually or on schedule as an OS service, sends a list of deleted blocks from the FS to clean them on the device.</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To enable </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fstrim, it is</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enough to activate the service </font></font><code>fstrim.service</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in systemd, but instead of a service that will hang in memory, it is better to use a timer </font></font><code>fstrim.timer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will start the weekly TRIM.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service activation example:</font></font></p><br>
<pre><code class="bash hljs"><span class="hljs-comment"># ,     :</span>
systemctl <span class="hljs-built_in">enable</span> fstrim.service &amp;&amp; \<font></font>
systemctl start fstrim.service &amp;&amp; \<font></font>
systemctl status fstrim.service</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But these measures are not enough if your file systems reside on LVM volumes and LVM in LUKS </font></font><del><code>  ,   ,   </code></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font></p><br>
 <img src="https://habrastorage.org/webt/mj/mg/m4/mjmgm4als5_xrsxbrjwrdy4fmhm.png" title="Created at http://www.draw.io"><br>
<a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first thing to do is verify that the SATA controller is in AHCI mode and not IDE, otherwise TRIM will not work:</font></font></p><br>
<pre><code class="bash hljs">sudo hdparm -I /dev/sda | grep TRIM<font></font>
    *    Data Set Management TRIM supported (<span class="hljs-built_in">limit</span> 8 blocks)<font></font>
    *    Deterministic <span class="hljs-built_in">read</span> ZEROs after TRIM</code></pre><br>
<p>    <code>TRIM supported</code>,   SATA    AHCI        BIOS  UEFI.</p><br>
<p>,  <code>discard</code>  :</p><br>
<ul>
<li>   (    )</li>
<li>    ‚Äî <code>/etc/fstab</code></li>
<li>  cryptsetup ‚Äî <code>/etc/crypttab</code></li>
<li>  LVM ‚Äî <code>/etc/lvm/lvm.conf</code></li>
<li>   ‚Äî <code>/boot/grub/grub.cfg</code></li>
</ul><br>
<p>    .      Arch Linux   ,             Linux.</p><br>
<h1 id="discard-v-superbloke-ext4">discard   EXT4</h1><br>
<p>  <code>/etc/fstab</code>     <code>discard</code>         <code>defaults</code>,           .      EXT4.          ,          SATA          -     <code>/etc/fstab</code>.</p><br>
<p>   <code>discard</code>       EXT4.     :</p><br>
<pre><code class="bash hljs">sudo tune2fs -o discard /dev/mapper/vg1-lvroot<font></font>
sudo tune2fs -o discard /dev/mapper/vg1-lvhome<font></font>
sudo tune2fs -o discard /dev/mapper/vg1-lvvar</code></pre><br>
<p>      <code>tune2fs</code>.  <code>/dev/mapper/vg1-lvroot</code>  ,     EXT4   LVM:</p><br>
<pre><code class="plaintext hljs">sudo tune2fs -l /dev/mapper/vg1-lvroot | grep options</code></pre><br>
<h1 id="discard-v-fstab">discard  fstab</h1><br>
<p>      SSD  ,      <code>discard</code>   <code>/etc/fstab</code>   ,      EXT4,        .</p><br>
<p>,  <code>discard</code>    swap :</p><br>
<pre><code class="bash hljs"><span class="hljs-comment"># /dev/mapper/vg1-lvroot</span><font></font>
UUID=e86ab458-341d-4f59-8344-0271d2c363e8    /            ext4    rw,noatime,discard   0 0<font></font>
<span class="hljs-comment"># /dev/mapper/vg1-lvvar</span><font></font>
UUID=44b31816-1193-4dc1-9f58-f70df2250e1a    /var         ext4    rw,noatime,discard   0 0<font></font>
<span class="hljs-comment"># /dev/mapper/vg1-lvhome</span><font></font>
UUID=372bc9ae-b581-49a4-abed-ca9f3b67edb6    /home        ext4    rw,noatime,discard   0 0<font></font>
<span class="hljs-comment"># /dev/sda1</span><font></font>
UUID=0BE5-60FB                               /boot/efi    vfat    rw,relatime,discard,...,errors=remount-ro   0 0<font></font>
<span class="hljs-comment"># /dev/mapper/vg1-lvswap</span>
UUID=cf67ae1e-3a17-4e5e-ac58-ef23725d2359    none         swap    defaults,discard,pri=-2   0 0</code></pre><br>
<h1 id="discard-na-lvm">discard  LVM</h1><br>
<p>   <code>/etc/lvm/lvm.conf</code>    <code>issue_discards</code>    <code>1</code>:</p><br>
<pre><code class="nginx hljs"><span class="hljs-section">devices</span> {
  <span class="hljs-attribute">issue_discards</span> = <span class="hljs-number">1</span>
}</code></pre><br>
<p> ,        TRIM          ,     TRIM       , ,     lvremove, lvreduce  ..</p><br>
<h1 id="discard-dlya-zashifrovannogo-root-razdela">discard   root-</h1><br>
<p>,     <code>discard</code>   ,       (  ,    . .)            ,       <code>crypttab</code>:</p><br>
<blockquote><strong>WARNING</strong>: This command can have a negative security impact because it can make filesystem-level operations visible on the physical device. For example, information leaking filesystem type, used space, etc. may be extractable from the physical device if the discarded blocks can be located later. If in doubt, do not use it.</blockquote><p>                  ,     .   ,   ,            ,                ,     ,       ?       ,     ?  ?      :)</p><br>
 <img src="https://habrastorage.org/webt/mj/mg/m4/mjmgm4als5_xrsxbrjwrdy4fmhm.png" title="Created at http://www.draw.io"><br>
<br>
<p>        ,      ""   LUKS.  TRIM     ,      <code>cryptsetup</code>'   <code>--allow-discards</code>       <code>/etc/crypttab</code>   ,     ,        <code>/etc/crypttab</code>,   root-                .</p><br>
<p>              <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">initramfs</a>,      <code>initramfs</code>      <code>grub</code>   Linux.</p><br>
<p>  <code>allow-discards</code>    <code>/etc/default/grub</code>   <code>cryptdevice</code>     <code>GRUB_CMDLINE_LINUX</code>.</p><br>
<p>  :</p><br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string">"cryptdevice=UUID=3c121aac-ead9-4d57-88be-c1199acf72f0:cryptlvm"</span></code></pre><br>
<p> :</p><br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string">"cryptdevice=UUID=3c121aac-ead9-4d57-88be-c1199acf72f0:cryptlvm:allow-discards"</span></code></pre><br>
<p>   ""  grub':</p><br>
<pre><code class="bash hljs">sudo grub-mkconfig -o /boot/grub/grub.cfg</code></pre><br>
<p> ,     <code>initramfs</code>    <code>encrypt</code>       <code>cryptsetup</code>      <code>lvm2</code>:</p><br>
<pre><code class="bash hljs">cat /etc/mkinitcpio.conf | grep ^HOOKS<font></font>
<font></font>
HOOKS=(base udev autodetect keyboard keymap consolefont modconf block encrypt lvm2 resume filesystems)</code></pre><br>
<p>    <code>grub</code>      .</p><br>
<h1 id="discard-dlya-drugih-zashifrovannyh-razdelov-ustroystva">discard     </h1><br>
 <img src="https://habrastorage.org/webt/xt/ee/zv/xteezvcpvjmdq0mdanqsaocbyle.png" title="Created at http://www.draw.io"><br>
<br>
<p>    ,  <code>/home</code>        LUKS.   ,     <code>discard</code>    <code>/etc/crypttab</code>        <code>/etc/fstab</code>.</p><br>
<p>         : <code>man crypttab</code></p><br>
<h1 id="proverka-trim"> TRIM</h1><br>
<p>  :</p><br>
<pre><code class="bash hljs">lsblk --discard<font></font>
<font></font>
NAME             DISC-ALN DISC-GRAN DISC-MAX DISC-ZERO<font></font>
sda                     0      512B       2G         0<font></font>
‚îú‚îÄsda1                  0      512B       2G         0<font></font>
‚îî‚îÄsda2                  0      512B       2G         0<font></font>
  ‚îî‚îÄcryptlvm            0        0B       0B         0<font></font>
      ‚îú‚îÄvg1-lvroot      0        0B       0B         0<font></font>
      ‚îú‚îÄvg1-lvvar       0        0B       0B         0<font></font>
      ‚îú‚îÄvg1-lvswap      0        0B       0B         0<font></font>
      ‚îî‚îÄvg1-lvhome      0        0B       0B         0</code></pre><br>
<p>       <code>DISC-GRAN</code> (discard granularity)  <code>DISC-MAX</code> (discard max bytes),  TRIM <strong> </strong>.</p><br>
<p>      TRIM:</p><br>
<pre><code class="bash hljs">sudo fstrim -v /<font></font>
<font></font>
/: 7,4 GiB (7906193408 bytes) trimmed</code></pre><br>
<p>    ,  TRIM .    TRIM      :</p><br>
<pre><code class="bash hljs">lsblk --discard<font></font>
<font></font>
NAME             DISC-ALN DISC-GRAN DISC-MAX DISC-ZERO<font></font>
sda                     0      512B       2G         0<font></font>
‚îú‚îÄsda1                  0      512B       2G         0<font></font>
‚îî‚îÄsda2                  0      512B       2G         0<font></font>
  ‚îî‚îÄcryptlvm            0      512B       2G         0<font></font>
    ‚îú‚îÄvg1-lvroot        0      512B       2G         0<font></font>
    ‚îú‚îÄvg1-lvvar         0      512B       2G         0<font></font>
    ‚îú‚îÄvg1-lvswap        0      512B       2G         0<font></font>
    ‚îî‚îÄvg1-lvhome        0      512B       2G         0</code></pre><br>
<p> <code>DISC-GRAN</code>  <code>512B</code>       SSD  512 bytes.     TRIM      ,    .        :</p><br>
<pre><code class="bash hljs">sudo cryptsetup status cryptlvm<font></font>
<font></font>
/dev/mapper/cryptlvm is active and is <span class="hljs-keyword">in</span> use.
<span class="hljs-built_in">type</span>:    LUKS1<font></font>
cipher:  aes-xts-plain64<font></font>
keysize: 512 bits<font></font>
key location: dm-crypt<font></font>
device:  /dev/sda2<font></font>
sector size:  512<font></font>
offset:  4096 sectors<font></font>
size:    487806976 sectors<font></font>
mode:    <span class="hljs-built_in">read</span>/write</code></pre><br>
<pre><code class="bash hljs">sudo hdparm -I /dev/sda | grep -i <span class="hljs-string">"sector size"</span><font></font>
<font></font>
      Logical  Sector size:                   512 bytes<font></font>
      Physical Sector size:                   512 bytes</code></pre><br>
<pre><code class="bash hljs">sudo smartctl -a /dev/sda | grep -i <span class="hljs-string">"sector size"</span><font></font>
<font></font>
Sector Size:      512 bytes logical/physical</code></pre><br>
<p>  !</p><br>
<hr><br>
<p>UPDATE 14.04.2020 14:20:       .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">AAngstrom</a>      .<br>
UPDATE 23.04.2020 22:00:  ,   ""  ,         .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">vitaliy2</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496992/index.html">Full support for popular Docker Registry implementations in werf</a></li>
<li><a href="../en496994/index.html">The book "Grokking Bitcoin technology"</a></li>
<li><a href="../en496996/index.html">Features of data-driven in petrochemicals</a></li>
<li><a href="../en496998/index.html">How untrained brains destroy the world in the era of coronavirus</a></li>
<li><a href="../en497000/index.html">Power Automate VS Logic Apps. Features Logic Apps</a></li>
<li><a href="../en497006/index.html">MITM attacks from Dom.ru</a></li>
<li><a href="../en497008/index.html">We write in PostgreSQL on a sublight: 1 host, 1 day, 1TB</a></li>
<li><a href="../en497010/index.html">Investing in periods of market downturn: 3 strategies for behavior on the stock exchange</a></li>
<li><a href="../en497014/index.html">Who are you, QA engineer or tester?</a></li>
<li><a href="../en497016/index.html">April 13th Java Digest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>