<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëü üëµüèæ üë®‚Äçüëß‚Äçüë¶ Graphiques 3D sur le STM32F103 üì• üë©üèΩ‚Äçü§ù‚Äçüë®üèæ üë®üèΩ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une courte histoire sur la fa√ßon de pousser le non modifiable et d'afficher des graphiques tridimensionnels en temps r√©el √† l'aide d'un contr√¥leur qui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Graphiques 3D sur le STM32F103</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496046/"><img src="https://habrastorage.org/getpro/habr/post_images/7e5/cf8/e1c/7e5cf8e1c0fbc2ee47c87c71d72e865f.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une courte histoire sur la fa√ßon de pousser le non modifiable et d'afficher des graphiques tridimensionnels en temps r√©el √† l'aide d'un contr√¥leur qui n'a ni vitesse ni m√©moire pour cela.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2017 (√† en juger par la date de modification du fichier), j'ai d√©cid√© de passer des contr√¥leurs AVR √† des STM32 plus puissants. Naturellement, le premier contr√¥leur √©tait le F103, largement diffus√©. Il n'est pas moins naturel que l'utilisation de cartes de d√©bogage standard ait √©t√© rejet√©e au profit de la fabrication √† partir de z√©ro selon ses besoins. Curieusement, il n'y avait presque pas de jambages (sauf que l'UART1 devrait √™tre amen√© √† un connecteur normal et non b√©quill√© par le c√¢blage).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport √† l'AVR, les caract√©ristiques de la pierre sont assez d√©centes: horloge √† 72 MHz (en pratique, vous pouvez overclocker √† 100 MHz, voire plus, mais uniquement √† vos risques et p√©rils!), 20 Ko de RAM et 64 Ko de flash. De plus, une tonne de p√©riph√©riques, lors de l'utilisation dont le principal probl√®me est de ne pas avoir peur de cette abondance et de r√©aliser que vous n'avez pas besoin de pelleter les dix registres pour commencer, il suffit de d√©finir trois bits dans les bons. Au moins jusqu'√† ce que vous vouliez quelque chose d'√©trange.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la premi√®re euphorie de la possession d'un tel pouvoir est pass√©e, un d√©sir a surgi de sonder ses limites. Comme exemple efficace, j'ai choisi le calcul de graphiques en trois dimensions avec toutes ces matrices, l'√©clairage, les mod√®les polygonaux et un Z-buffer avec un affichage 320x240 sur le contr√¥leur ili9341. Les deux probl√®mes les plus √©vidents √† r√©soudre sont la vitesse et le volume. Une taille d'√©cran de 320x240 √† 16 bits par couleur donne 150 Ko par image. Mais la RAM totale que nous avons n'est que de 20 Ko ... Et ces 150 Ko doivent √™tre transf√©r√©s √† l'√©cran au moins 10 fois par seconde, c'est-√†-dire que le taux de change devrait √™tre d'au moins 1,5 Mo / s ou 12 Mo / s, ce qui ressemble d√©j√† √† une charge importante sur le c≈ìur. Heureusement, dans ce contr√¥leur, il existe un module RAP (acc√®s direct √† la m√©moire, alias Direct Memory Access, DMA), qui vous permet de ne pas charger le noyau avec des op√©rations de transfusion de vide en vide.Autrement dit, vous pouvez pr√©parer le tampon, dire au module ¬´ici vous avez le tampon de donn√©es, travaillez!¬ª, Et √† ce moment pr√©parer les donn√©es pour le prochain transfert. Et en tenant compte de la capacit√© de l'√©cran √† recevoir des donn√©es dans un flux, l'algorithme suivant √©merge: le tampon avant est mis en √©vidence, √† partir duquel le DMA transf√®re les donn√©es √† l'√©cran, le tampon arri√®re dans lequel le rendu a lieu et le tampon Z utilis√© pour la d√©coupe en profondeur. Les tampons sont une seule ligne (ou colonne, peu importe) de l'affichage. Et au lieu de 150 Ko, nous n'avons besoin que de 1920 octets (320 pixels par ligne * 3 tampons * 2 octets par point), ce qui tient parfaitement en m√©moire. Le deuxi√®me hack est bas√© sur le fait que le calcul des matrices de transformation et des coordonn√©es des sommets ne peut pas √™tre effectu√© pour chaque ligne, sinon l'image sera d√©form√©e de la mani√®re la plus bizarre et sa vitesse est d√©savantageuse. Au lieu de cela, des calculs "externes",c'est-√†-dire que la multiplication des matrices de transformation et leur application aux sommets sont recalcul√©es sur chaque image, puis converties en une repr√©sentation interm√©diaire, qui est optimis√©e pour le rendu en une image 320x1.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour des raisons de hooligan, la biblioth√®que ressemblera √† OpenGL de l'ext√©rieur. Comme dans l'OpenGL d'origine, le rendu commence par la formation de la matrice de transformation - la suppression de glLoadIdentity () cr√©e l'unit√© de matrice actuelle, puis un ensemble de transformations glRotateXY (...), glTranslate (...), chacune √©tant multipli√©e par la matrice actuelle. √âtant donn√© que ces calculs ne seront effectu√©s qu'une fois par image, il n'y a pas d'exigences particuli√®res de vitesse, vous pouvez le faire avec des flotteurs simples, sans perversions avec des nombres √† virgule fixe. La matrice elle-m√™me est un tableau de float [4] [4], mapp√© sur un tableau unidimensionnel de float [16] - en fait, cette m√©thode est g√©n√©ralement utilis√©e pour les tableaux dynamiques, mais vous pouvez tirer un petit avantage des statiques. Un autre hack standard: au lieu de calculer constamment les sinus et les cosinus, qui sont nombreux dans les matrices de rotation,comptez-les √† l'avance et √©crivez-les sur la tablette. Pour ce faire, divisez le cercle complet en 256 parties, calculez la valeur du sinus pour chacune et transf√©rez-la dans le tableau sin_table []. Eh bien, n'importe qui de l'√©cole peut obtenir le cosinus du sinus. Il convient de noter que les fonctions de rotation prennent un angle non pas en radians, mais en fractions de tour complet, apr√®s r√©duction √† la plage [0 ... 255]. Cependant, des fonctions ¬´honn√™tes¬ª ont √©t√© mises en ≈ìuvre pour effectuer la conversion de l'angle en lobes sous le capot.effectuer la conversion de l'angle en lobes sous le capot.effectuer la conversion de l'angle en lobes sous le capot.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la matrice est pr√™te, vous pouvez commencer √† dessiner les primitives. En g√©n√©ral, dans les graphiques en trois dimensions, il existe trois types de primitives - un point, une ligne et un triangle. Mais si nous nous int√©ressons aux mod√®les polygonaux, il ne faut s'int√©resser qu'au triangle. Son "rendu" se produit dans la fonction glDrawTriangle () ou glDrawTriangleV (). Le mot ¬´rendu¬ª est plac√© entre guillemets car aucun rendu ne se produit √† ce stade. Nous multiplions simplement tous les points de la primitive par la matrice de transformation, puis nous en extrayons les formules analytiques des ar√™tes y = ky * x + par, ce qui nous permet de trouver les intersections des trois ar√™tes du triangle avec la ligne de sortie actuelle. Nous en √©cartons un, car il ne repose pas sur l'intervalle entre les sommets, mais sur sa continuation.Autrement dit, pour dessiner un cadre, il vous suffit de parcourir toutes les lignes et pour chaque peinture la zone entre les points d'intersection. Mais si vous appliquez cet algorithme de front, chaque primitive chevauchera celles qui ont √©t√© dessin√©es pr√©c√©demment. Nous devons consid√©rer la coordonn√©e Z (profondeur) afin que les triangles se croisent magnifiquement. Au lieu d'imprimer simplement point par point, nous consid√©rerons sa coordonn√©e Z et, en comparaison avec la coordonn√©e Z stock√©e dans le tampon de profondeur, soit en sortie (en mettant √† jour le tampon Z) soit en l'ignorant. Et pour calculer la coordonn√©e Z de chaque point de la ligne qui nous int√©resse, nous utilisons la m√™me formule de ligne droite z = kz * y + bz calcul√©e par les deux m√™mes points d'intersection avec des bords. Par cons√©quent, l'objet du triangle "semi-fini" struct glTriangle se compose de trois coordonn√©es X des sommets (il n'y a aucun sens √† stocker les coordonn√©es Y et Z, elles seront calcul√©es) et k,b coefficients directs, eh bien, couleur au tas. Ici, contrairement au calcul des matrices de transformation, la vitesse est critique, nous utilisons donc d√©j√† des nombres √† virgule fixe. De plus, si pour le terme b, la m√™me pr√©cision est suffisante que pour les coordonn√©es (2 octets), alors la pr√©cision du facteur k, plus grande est la meilleure, on prend donc 4 octets. Mais pas un flottant, car travailler avec des entiers est encore plus rapide, m√™me avec la m√™me taille.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, en appelant un groupe de glDrawTriangle (), nous avons pr√©par√© un tableau de triangles semi-finis. Dans mon impl√©mentation, les triangles sont d√©duits un √† la fois par des appels de fonction explicites. En fait, il serait logique d'avoir un tableau de triangles avec les adresses des sommets, mais ici j'ai d√©cid√© de ne pas compliquer. Quoi qu'il en soit, la fonction de rendu est √©crite par des robots et peu leur importe de remplir un tableau constant ou d'√©crire trois cents appels identiques. Il est temps de traduire les produits semi-finis des triangles en une belle image √† l'√©cran. Pour ce faire, la fonction glSwapBuffers () est appel√©e. Comme d√©crit ci-dessus, il parcourt les lignes de l'affichage, recherche chaque point d'intersection avec tous les triangles et dessine des segments en fonction du filtrage par profondeur. Apr√®s avoir rendu chaque ligne, vous devez envoyer cette ligne √† l'√©cran. Pour ce faire, DMA est lanc√©, ce qui indique l'adresse de la cha√Æne et sa taille.En attendant, DMA fonctionne, vous pouvez basculer vers un autre tampon et afficher la ligne suivante. L'essentiel est de ne pas oublier d'attendre la fin du transfert si vous avez soudainement termin√© le rendu plus t√¥t. Pour visualiser le rapport des vitesses, j'ai ajout√© l'inclusion d'une LED rouge apr√®s la fin du rendu et √©teinte apr√®s la fin de l'attente DMA. Il s'av√®re quelque chose comme PWM, qui ajuste la luminosit√© en fonction de la latence. Th√©oriquement, au lieu d'une attente ¬´stupide¬ª, des interruptions DMA pourraient √™tre utilis√©es, mais je ne pourrais pas les utiliser, et l'algorithme serait devenu beaucoup plus compliqu√©. Pour un programme de d√©monstration, c'est redondant.Pour visualiser le rapport des vitesses, j'ai ajout√© l'inclusion d'une LED rouge apr√®s la fin du rendu et √©teinte apr√®s la fin de l'attente DMA. Il s'av√®re quelque chose comme PWM, qui ajuste la luminosit√© en fonction de la latence. Th√©oriquement, au lieu d'une attente ¬´stupide¬ª, des interruptions DMA pourraient √™tre utilis√©es, mais je ne pourrais pas les utiliser, et l'algorithme serait devenu beaucoup plus compliqu√©. Pour un programme de d√©monstration, c'est redondant.Pour visualiser le rapport des vitesses, j'ai ajout√© l'inclusion d'une LED rouge apr√®s la fin du rendu et √©teinte apr√®s la fin de l'attente DMA. Il s'av√®re quelque chose comme PWM, qui ajuste la luminosit√© en fonction de la latence. Th√©oriquement, au lieu d'une attente ¬´stupide¬ª, des interruptions DMA pourraient √™tre utilis√©es, mais je ne pourrais pas les utiliser, et l'algorithme serait devenu beaucoup plus compliqu√©. Pour un programme de d√©monstration, c'est redondant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat des proc√©dures ci-dessus a √©t√© une image tournante de trois plans qui se croisent de couleurs diff√©rentes, et avec une vitesse assez d√©cente: la luminosit√© de la LED rouge est assez √©lev√©e, ce qui indique une grande marge dans les performances du noyau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, si le noyau est inactif, vous devez le charger. Et nous le chargerons avec de meilleurs mod√®les. Cependant, n'oubliez pas que la m√©moire est encore tr√®s limit√©e, donc le contr√¥leur ne tirera pas trop de polygones physiquement. Le calcul le plus simple a montr√© qu'apr√®s soustraction de la m√©moire sur le tampon de ligne et autres, il y avait une place pour 378 triangles. Comme la pratique l'a montr√©, les mod√®les de l'ancien mais int√©ressant jeu gothique sont parfaits pour cette taille. En fait, les mod√®les d'un serpent et d'une mouche de sang ont √©t√© retir√©s de l√† (et d√©j√† au moment de la r√©daction de cet article et d'un glocoor, affichant sur KDPV), apr√®s quoi le contr√¥leur a manqu√© de m√©moire flash. Mais les mod√®les de jeux ne sont pas destin√©s √† √™tre utilis√©s par un microcontr√¥leur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disons qu'ils contiennent des animations, des textures et similaires, ce qui ne nous est pas utile et ne tient pas en m√©moire. Heureusement, Blender permet non seulement de les enregistrer dans * .obj, ce qui est plus adapt√© √† l'analyse, mais √©galement de r√©duire le nombre de polygones si n√©cessaire. De plus, √† l'aide d'un simple programme auto-√©crit obj2arr * .obj, les fichiers sont tri√©s en coordonn√©es, √† partir desquelles un fichier * .h est ensuite form√© pour une inclusion directe dans le firmware.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pour l'instant, les mod√®les ressemblent √† de simples taches boucl√©es. Sur le mod√®le de test, cela ne nous a pas d√©rang√©s, car tous les visages ont √©t√© peints dans leurs propres couleurs, mais ne prescrivent pas les m√™mes couleurs √† chaque polygone du mod√®le. Non, vous pouvez, bien s√ªr, peindre une mouche dans des couleurs al√©atoires, mais elle aura l'air assez √† l'improviste, j'ai v√©rifi√©. Surtout lorsque les couleurs changent √©galement sur chaque image ... Au lieu de cela, appliquez une autre goutte de magie vectorielle et ajoutez de l'√©clairage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le calcul de l'√©clairage dans sa version primitive consiste √† calculer le produit scalaire de la normale et de la direction de la source lumineuse, puis √† multiplier par la couleur ¬´native¬ª du visage.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant trois mod√®les - deux du jeu et un test, √† partir duquel nous avons commenc√©. Pour les commuter, nous utiliserons l'un des deux boutons soud√©s sur la carte. En m√™me temps, vous pouvez ajouter un contr√¥le sur le processeur. Nous avons d√©j√† un contr√¥le - une LED rouge associ√©e √† la latence DMA. Et la deuxi√®me, verte, LED, nous clignotera √† chaque mise √† jour de trame - afin que nous puissions estimer la fr√©quence d'images. Pour l'≈ìil nu, c'√©tait environ 15 fps.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/afyTgpuA6sc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, je suis satisfait du r√©sultat: c'est bien d'impl√©menter quelque chose qui est fondamentalement impossible √† r√©soudre de front. </font><font style="vertical-align: inherit;">Bien s√ªr, il reste encore beaucoup √† optimiser et √† am√©liorer, mais cela ne sert √† rien. </font><font style="vertical-align: inherit;">Objectivement, le contr√¥leur pour les graphiques en trois dimensions est faible, et ce n'est m√™me pas la vitesse, mais plut√¥t la RAM. </font><font style="vertical-align: inherit;">Cependant, comme tout √©chantillon de demoscene, ce projet est pr√©cieux non pas par le r√©sultat, mais par le processus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si quelqu'un est soudain int√©ress√©, le code source est disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496036/index.html">Open source: infrastructure de test CI / CD et Avito pour Android</a></li>
<li><a href="../fr496038/index.html">Bilirubine - la mol√©cule responsable de l'ict√®re</a></li>
<li><a href="../fr496040/index.html">10 Lifehacks zen</a></li>
<li><a href="../fr496042/index.html">Habr, je ne vous informerai pas des erreurs sur votre site</a></li>
<li><a href="../fr496044/index.html">Lancement de vaisseaux spatiaux et ... m√©t√©o dans les r√©gions</a></li>
<li><a href="../fr496050/index.html">Des tigres et des lions contractent un coronavirus √† New York</a></li>
<li><a href="../fr496052/index.html">Comment une entreprise de services peut-elle √©viter des amendes √† un client? Quelques avantages √©vidents de l'automatisation des processus</a></li>
<li><a href="../fr496056/index.html">Num√©rique: comment les chiffres et les termes nous trompent</a></li>
<li><a href="../fr496058/index.html">Pourquoi est-il n√©cessaire de combiner des robots agricoles, quelles sont les difficult√©s et comment nous l'avons fait en deux ans</a></li>
<li><a href="../fr496080/index.html">Cr√©ation d'interactions IA simples avec des objets d'environnement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>