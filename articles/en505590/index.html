<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïò üë®üèº üêøÔ∏è How GPU computing literally saved me at work. Python example ü¶Ä üç¶ üò®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 Today we touch on the most relevant topic - Python for working with the GPU. The author considers an example, trivial in its monstros...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How GPU computing literally saved me at work. Python example</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/505590/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we touch on the most relevant topic - Python for working with the GPU. </font><font style="vertical-align: inherit;">The author considers an example, trivial in its monstrosity, and demonstrates the solution, accompanying it with extensive listings. </font><font style="vertical-align: inherit;">Enjoy reading!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/mv/xr/xbmvxrrximpm1_fchk6fsi9v5fg.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
None of us, in one form or another, have bypassed the recent hype around GPU computing. Before you read further, I‚Äôll explain: I am not a GPU expert. My journey in the GPU world is just beginning. But today this technology has reached such power that, armed with it, you can solve a whole lot of problems. I was assigned a task at work, the machine spent hours on it, and no progress was visible. But, as soon as I took up the GPU - and the problem began to be solved in seconds. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The task, which approximately took 2 days to complete, I was able to solve in just 20 seconds</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the following sections, I will describe this task in detail. </font><font style="vertical-align: inherit;">We will also discuss how and when to use the GPU to solve any such problems. </font><font style="vertical-align: inherit;">So, we read carefully - believe me, you will not regret it. </font><font style="vertical-align: inherit;">First, we will delve into the details of the task, then get comfortable with the GPU and, finally, use the GPU to solve this problem. </font><font style="vertical-align: inherit;">I will use the Python </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nvidia Volta V100 16GB GPU GPU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Detailed description of the task</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the retail sector, you often have to look for similar or closest objects. </font><font style="vertical-align: inherit;">I was given a list of positions, each of which was represented by k latent attributes. </font><font style="vertical-align: inherit;">So, I was instructed to find the top 3 most similar positions to each of the positions in the list. </font><font style="vertical-align: inherit;">The metric of similarity in this problem was chosen cosine similarity. </font><font style="vertical-align: inherit;">This is what my data looked like. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s1/02/if/s102ifuqgnhoe_pv81htzopsye4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
List of data items with 64 latent characteristics </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task complexity</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was given a list in which there were about 10‚Åµ positions. </font><font style="vertical-align: inherit;">Searching for the 3 most similar positions for each of them would require checking the cosine similarity with each and every element in the list. </font><font style="vertical-align: inherit;">It would turn out n * k operations, where n is the number of positions, and k are the attributes for each position. </font><font style="vertical-align: inherit;">It would be necessary to obtain the scalar product of this position from each of the remaining positions in the list.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_3_similar_items</span>(<span class="hljs-params">X,mindex</span>):</span> <span class="hljs-comment"># X   ,    -3 ,       'mindex'</span>
    SMALL = <span class="hljs-number">-9999.0</span> <span class="hljs-comment">#   ,         ( )</span>
    first_best_val = SMALL <span class="hljs-comment">#         </span>
    first_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    second_best_val = SMALL <span class="hljs-comment">#        </span>
    second_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    third_best_val = SMALL <span class="hljs-comment">#        </span>
    third_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(n): <span class="hljs-comment">#  n-  </span>
            <span class="hljs-keyword">if</span>(mindex==j):
                <span class="hljs-keyword">continue</span>
            tmp = np.dot(X[mindex],X[j])/(np.sqrt(np.sum(np.square(X[mindex]))) * np.sqrt(np.sum(np.square(X[j])))) <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val):<font></font>
                third_best_val = second_best_val<font></font>
                third_best_index = second_best_index<font></font>
                second_best_val = first_best_val<font></font>
                second_best_index = first_best_index<font></font>
                first_best_val = tmp<font></font>
                first_best_index = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val):<font></font>
                third_best_val = second_best_val<font></font>
                third_best_index = second_best_index<font></font>
                second_best_val = tmp<font></font>
                second_best_index = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val):<font></font>
                third_best_val = tmp<font></font>
                third_best_index = j<font></font>
    <span class="hljs-keyword">return</span> first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index <span class="hljs-comment">#   </span></code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code for finding three positions that are as similar as possible to the</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Now, when you find the top 3 similar for all positions in the list, the complexity is multiplied by another n. </font><font style="vertical-align: inherit;">The final complexity is O (n * n * k) = O (n¬≤k).</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_3_similar_all_items</span>(<span class="hljs-params">X</span>):</span> <span class="hljs-comment"># X   ,      3     </span>
    SMALL = <span class="hljs-number">-9999.99</span> <span class="hljs-comment">#   ,         ( )</span>
    first_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    first_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    second_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    second_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    third_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    third_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):
        <span class="hljs-comment"># Initialisation</span><font></font>
        first_best_val[i] = SMALL<font></font>
        first_best_index[i] = <span class="hljs-number">-1</span><font></font>
        second_best_val[i] = SMALL<font></font>
        second_best_index[i] = <span class="hljs-number">-1</span><font></font>
        third_best_val[i] = SMALL<font></font>
        third_best_index[i] = <span class="hljs-number">-1</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(n):
            <span class="hljs-keyword">if</span>(i==j):
                <span class="hljs-keyword">continue</span>
            tmp = np.dot(X[i],X[j])/(np.sqrt(np.sum(np.square(X[i]))) * np.sqrt(np.sum(np.square(X[j])))) <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val[i]):<font></font>
                third_best_val[i] = second_best_val[i]<font></font>
                third_best_index[i] = second_best_index[i]<font></font>
                second_best_val[i] = first_best_val[i]<font></font>
                second_best_index[i] = first_best_index[i]<font></font>
                first_best_val[i] = tmp<font></font>
                first_best_index[i] = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val[i]):<font></font>
                third_best_val[i] = second_best_val[i]<font></font>
                third_best_index[i] = second_best_index[i]<font></font>
                second_best_val[i] = tmp<font></font>
                second_best_index[i] = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val[i]):<font></font>
                third_best_val[i] = tmp<font></font>
                third_best_index[i] = j<font></font>
    <span class="hljs-keyword">return</span> first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index <span class="hljs-comment">#   </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code for finding the three most similar positions for each position in the </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test run and time evaluation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I ran the code, trying to find the 3 most similar positions from a subset containing n = 10¬≥ positions with k = 64. It took about 17 to complete this task with Python seconds at an average speed of 3.7 * 10‚Å∂ operations per second. </font><font style="vertical-align: inherit;">The code has been well optimized using Numpy operations and arrays. </font><font style="vertical-align: inherit;">I note that all these operations are sequentially performed on the CPU.</font></font><br>
<br>
<pre><code class="python hljs">%time first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index = top_3_similar_all_items(X)</code></pre><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run for n = 10¬≥ positions</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/z7/fr/p9/z7frp96r6jga71hy_eh5kqc6soo.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Conclusion: the time it took for n = 10¬≥ positions </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, I increased the test subset to n = 10‚Å¥ positions. Since the complexity is O (n¬≤k), the execution time has increased 100 times (since n has increased 10 times). It took 1700 seconds to complete the code = 28.33 minutes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1t/hz/we/1thzweestkdve12ggxihgenaisu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conclusion: the time it took to process n = 10‚Å¥ positions </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we come to the most important one: estimating the time it takes to process a full list of 10‚Åµ positions. Counting, we see that the time complexity again increases by 100 times, since the time complexity of the algorithm is O (n¬≤k). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estimated time = 1700 * 100 seconds = 2834 minutes = 47.2 hours ~ 2 days. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh my God! So long!!!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You probably already realize that I actually managed to do everything very quickly, using the power of the GPU. </font><font style="vertical-align: inherit;">In fact, the time gain when using a GPU is simply shocking. </font><font style="vertical-align: inherit;">I‚Äôll leave the numbers for a snack, but for now I suggest you get acquainted with the world of GPU.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comparison of CPU and GPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Central Processing Unit (CPU), in essence, is the brain of any computing device: it executes the instructions written in the program, performing control, logical operations, as well as input / output operations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
True, modern CPUs still do not have many cores, and the basic structure and purpose of the CPU - the processing of complex calculations - in essence, have not changed. </font><font style="vertical-align: inherit;">In fact, the CPU is best suited to solve problems involving parsing or interpreting the complex logic contained in the code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In turn, the graphic processor (GPU) has smaller logical cores, which, however, are much larger (we are talking about arithmetic logic devices (ALU), control elements and cache memory), which are designed with the expectation of parallel processing as a whole identical and relatively simple operations.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dv/rj/_r/dvrj_rfbqkiabwugkvilkoka3oo.png"><br>
 <blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The GPU has more arithmetic logic units (ALUs) than a typical CPU, so the ability to process simple operations in parallel has been enhanced</font></font></blockquote><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure: Compare CPU and GPU ~ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image Source</font></font></a></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. When to use GPU computing </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The CPU is better suited for complex linear tasks. Despite the fact that the CPU cores are more powerful, GPUs allow you to more efficiently and quickly process tasks related to AI, machine learning and deep learning. The GPU handles workloads by parallelizing similar operations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚Äãoperations from the point of view of the GPU: take, for example, the operation of finding a word in a document. It can be done sequentially, sorting out one by one all the words in the document, either in parallel, that is, line by line, or with a search for a specific word. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚Äãoperations from the point of view of the CPU - there are such operations, for example, the calculation of the Fibonacci series, which cannot be parallelized. After all, you can find the next number only after you calculate the previous two. Such operations are best suited for the CPU.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In turn, operations such as matrix addition and multiplication are easily performed using the GPU, since most of these operations in matrix cells are independent of each other, are similar in nature, and therefore can be parallelized.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Briefly about CUDA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CUDA is a parallel computing platform and API model created by Nvidia. Using this API, you can use a processor that supports CUDA graphics for a wide range of calculations. This approach is called GPGPU (non-specialized computing on GPUs). Here they are described in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more detail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NUMBA</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Numba is a freeware JIT compiler that translates a subset of Python and NumPy into fast machine code using LLVM, this is done using the llvmlite package in Python. This package offers a number of options for parallelizing Python code for the CPU and GPU, while minimal changes are often enough in the code itself. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See more</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working with the processor</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nvidia Volta V100 16GB GPU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I used the Numba library. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architectural Details ~ Streams, Blocks, and Grids</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
CUDA organizes parallel computing using abstractions such as streams, blocks, and grids. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : A CUDA stream is an assigned chain of instructions coming / current to the CUDA core (in fact, it's just a pipeline). On the fly, up to 32 threads can exist on the same CUDA core (in this case, all links of this pipeline are filled). This is the execution of the kernel with the given index. Each thread uses its index to access the elements in the array in such a way that the entire set of available threads processes the entire set of data together. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Block</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: This is a thread group. Not much can be said about the execution of threads within a block: they can be executed either sequentially or in parallel, or without any particular order. You can coordinate threads, for example, using a function </font></font><code>_syncthreads()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that forces a thread to stop at a certain point in the kernel and wait until all other threads in the same block also reach the same point. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : This is a group of blocks. There is no synchronization between the blocks. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fu/q_/rm/fuq_rmemxkfpo8o9wkx4es362s8.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CUDA: threads, blocks, grids ~ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
But where exactly are threads, blocks and grids executed? In the case of Nvidia‚Äôs G80 GPU architecture, the calculations are apparently distributed as follows: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grid ‚Üí GPU: The entire grid is processed by a single GPU processor.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Block ‚Üí MP: The GPU processor is organized as a collection of multiprocessors, where each multiprocessor is responsible for processing one or more blocks in the grid. </font><font style="vertical-align: inherit;">One block is never divided between several MPs. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stream ‚Üí PP: Each MP is further subdivided into stream processors (PP), and each PP processes one or more threads in a block. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I borrowed some material from this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellently written article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I recommend reading it carefully.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. A simple program for adding arrays in Python using the GPU</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I said at the very beginning, the essence of this article is to help a wide audience understand the power of the GPU and gain an intuitive understanding of how to use the GPU to solve everyday tasks. Before you start writing code for the GPU, you may have to do some preliminary research. To do this, let's take an example of a program for adding arrays. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we have two arrays, 'a' and 'b' of size 'n'. We want to generate an array 'c' such that each element of array c is the sum of elements with the same indices from the arrays 'a' and 'b'. But in this case, to solve the problem, we will not use sequential calculations, but parallel ones that are done using the GPU.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will launch n threads / cores. The index under which each specific thread works can be derived from the following formula: </font></font><br>
<br>
<code>index = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of a two-dimensional matrix, the index contains two components that mean a row and a column, which can be displayed as follows: </font><font style="vertical-align: inherit;">
We also have to determine the number of threads per block, say, tpb blocks per grid, say bpg. We will use standard numbers for them. </font><font style="vertical-align: inherit;">
It is important to note another important concept here: when any calculations have to be performed on the GPU, the corresponding data must be transferred to the global memory of the GPU, and the results of the calculations can then be transferred back to the host. These operations are performed using the </font><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">functions </font><font style="vertical-align: inherit;">provided in the Python Numba library.</font></font><br>
<br>
<code>row = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x<br>
col = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>cuda.to_device()</code><font style="vertical-align: inherit;"></font><code>copy_to_host()</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below are the implementations of this solution for both the CPU and GPU. </font><font style="vertical-align: inherit;">See both listings for the difference.</font></font><br>
<br>
<pre><code class="python hljs">c = np.zeroes(n)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):<font></font>
    c[i] = a[i] + b[i]<font></font>
<span class="hljs-keyword">return</span> c</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential implementation for CPU.</font></font></i><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> cuda <span class="hljs-comment">#  Nvidia    GPU </span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np <font></font>
<font></font>
<span class="hljs-meta">@cuda.jit('void(float32[:], float32[:], float32[:])') #  Cuda </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cuda_addition</span>(<span class="hljs-params">a,b,c</span>):</span>
    <span class="hljs-string">"""     ."""</span>
    i = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">if</span> i &gt; c.size:
        <span class="hljs-keyword">return</span>
    c[i] = a[i]+b[i] <span class="hljs-comment">#Perform the addition</span><font></font>
 <font></font>
<span class="hljs-comment">#   </span><font></font>
device = cuda.get_current_device()<font></font>
<font></font>
<span class="hljs-comment">#     </span>
d_a = cuda.to_device(a)  <span class="hljs-comment">#      GPU</span>
d_b = cuda.to_device(b)  <span class="hljs-comment">#      GPU</span><font></font>
d_c = cuda.device_array_like(a)<font></font>
<font></font>
tpb = device.WARP_SIZE       <span class="hljs-comment">#blocksize     ,   = 32</span>
bpg = int(np.ceil((n)/tpb))  <span class="hljs-comment">#   </span><font></font>
<font></font>
cuda_addition[bpg, tpb](d_a, d_b, d_c) <span class="hljs-comment">#  </span><font></font>
<font></font>
<span class="hljs-comment">#      </span><font></font>
c = d_c.copy_to_host()<font></font>
print(c)<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallel implementation for GPU </font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Finding the 3 most similar positions for each position in the list using the GPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having thoroughly studied theory and practice, we return to the original task: to find the top 3 similar positions for each position in the list using GPU calculations. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the main idea is that we have n positions, and we will start n threads. </font><font style="vertical-align: inherit;">Each thread will work in parallel with the others and independently of them, calculating the 3 most similar positions for each position in the list. </font><font style="vertical-align: inherit;">Each position will be responsible for one thread.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> cuda <span class="hljs-comment"># Nvidia's GPU Library</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np 
<span class="hljs-keyword">import</span> math <span class="hljs-comment">#  , ,   , Numpy    GPU</span>
<span class="hljs-keyword">import</span> random<font></font>
<font></font>
<span class="hljs-comment">#                   </span>
<span class="hljs-meta">@cuda.jit('void(float32[:,:],float32[:],int32[:],float32[:],int32[:],float32[:],int32[:])') # CUDA Just-in-time Compiler</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cuda_dist</span>(<span class="hljs-params">X,first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index</span>):</span>
    <span class="hljs-string">"""     ."""</span>
    <span class="hljs-comment">#    </span><font></font>
    row = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x;<font></font>
    <span class="hljs-keyword">if</span> ((row &gt;= n)): <span class="hljs-comment">#      </span>
        <span class="hljs-keyword">return</span>
    first_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    first_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    second_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    second_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    third_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    third_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):
        <span class="hljs-keyword">if</span>(i==row): <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">continue</span>
        <span class="hljs-comment">#     ,        numpy   GPU</span>
        tmp = <span class="hljs-number">0.0</span>
        magnitude1 = <span class="hljs-number">0.0</span>
        magnitude2 = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(k):<font></font>
            tmp += X[row,j] * X[i,j]<font></font>
            magnitude1 += (X[row,j]* X[row,j])<font></font>
            magnitude2 += (X[i,j]* X[i,j])<font></font>
        tmp /= (math.sqrt(magnitude1)*math.sqrt(magnitude2)) <span class="hljs-comment">#    Dot_product(a,b) = a.b/(|a|*|b|)</span>
        <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val[row]):<font></font>
            third_best_val[row] = second_best_val[row]<font></font>
            third_best_index[row] = second_best_index[row]<font></font>
            second_best_val[row] = first_best_val[row]<font></font>
            second_best_index[row] = first_best_index[row]<font></font>
            first_best_val[row] = tmp<font></font>
            first_best_index[row] = i<font></font>
        <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val[row]):<font></font>
            third_best_val[row] = second_best_val[row]<font></font>
            third_best_index[row] = second_best_index[row]<font></font>
            second_best_val[row] = tmp<font></font>
            second_best_index[row] = i<font></font>
        <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val[row]):<font></font>
            third_best_val[row] = tmp<font></font>
            third_best_index[row] = i<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
device = cuda.get_current_device()<font></font>
<font></font>
d_x = cuda.to_device(X)<font></font>
d_first_val = cuda.device_array_like(first_val)<font></font>
d_first_index = cuda.device_array_like(first_index)<font></font>
d_second_val = cuda.device_array_like(second_val)<font></font>
d_second_index = cuda.device_array_like(second_index)<font></font>
d_third_val = cuda.device_array_like(third_val)<font></font>
d_third_index = cuda.device_array_like(third_index)<font></font>
<font></font>
<font></font>
tpb = device.WARP_SIZE       <span class="hljs-comment"># blocksize     </span>
bpg = int(np.ceil((n)/tpb))  <span class="hljs-comment">#   </span><font></font>
<font></font>
%time cuda_dist[bpg,tpb](d_x,d_first_val,d_first_index,d_second_val,d_second_index,d_third_val,d_third_index) <span class="hljs-comment">#  </span><font></font>
<font></font>
<span class="hljs-comment">#      </span><font></font>
first_val = d_first_val.copy_to_host()<font></font>
<span class="hljs-keyword">print</span> (first_val[:<span class="hljs-number">10</span>]) <span class="hljs-comment">#  10 </span>
<span class="hljs-comment">#      </span><font></font>
first_index = d_first_index.copy_to_host()<font></font>
<span class="hljs-keyword">print</span> (first_index[:<span class="hljs-number">10</span>]) <span class="hljs-comment">#  10 </span>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation for the GPU ~ Code for finding the 3 positions most similar to the given </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">time</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
spent The total time spent by the GPU to find the top 3 similar positions for each position in the list was 481 ms (0.5 seconds). </font><font style="vertical-align: inherit;">It took another 20 seconds to copy data from the device to the host and from the host to the device.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Conclusion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task, the solution of which on the CPU would take about 2 days, on the GPU was solved in 20.5 seconds. </font><font style="vertical-align: inherit;">This was possible only due to the nature of the task. </font><font style="vertical-align: inherit;">The search for the 3 most similar positions for 'A' does not depend on the search for the 3 most similar positions for 'B'. </font><font style="vertical-align: inherit;">We took advantage of this fact and applied the parallelism provided by the GPU to speed up the process. </font><font style="vertical-align: inherit;">The example also illustrates what types of tasks are most conveniently solved with the help of a powerful GPU.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Acknowledgments</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This study was performed on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Walmart Labs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MLP (machine learning platform) </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Thanks to Ayush Kumar for helping streamline the workflow.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505558/index.html">Amazon DeepLens Deep Learning Camera. Unpacking, connecting and deploying a project</a></li>
<li><a href="../en505560/index.html">The second set for a product management program at the CS center: what students say</a></li>
<li><a href="../en505568/index.html">Transferring files using pipes and other little things on Delphi</a></li>
<li><a href="../en505574/index.html">Reinforced learning through competitive neural networks</a></li>
<li><a href="../en505580/index.html">Using spreadsheets and computing software for Newsvendor modeling</a></li>
<li><a href="../en505592/index.html">Programming for BK0010 using Android</a></li>
<li><a href="../en505594/index.html">How to turn a site visitor into a client: a guide on creating lead forms</a></li>
<li><a href="../en505604/index.html">Addiction vulnerability</a></li>
<li><a href="../en505608/index.html">Vuex - solve an old dispute with new methods</a></li>
<li><a href="../en505612/index.html">MK-61: history, emulation, device</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>