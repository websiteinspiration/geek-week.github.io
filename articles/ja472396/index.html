<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎰 👩🏿‍⚖️ 🌑 Columnstoreで4秒で世界一周（パート1） 👼🏼 🥄 😎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、レポートの速度を上げることを検討します。レポートとは、集計関数を使用するデータベースへのクエリを意味します。また、人間と機械の両方で、レポートの作成とサポートに費やされたリソースに関連する問題についても触れます。
 
 例では、52,608,000レコードを含むデータセットを使用します...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Columnstoreで4秒で世界一周（パート1）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472396/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、レポートの速度を上げることを検討します。レポートとは、集計関数を使用するデータベースへのクエリを意味します。また、人間と機械の両方で、レポートの作成とサポートに費やされたリソースに関連する問題についても触れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例では、52,608,000レコードを含むデータセットを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複雑ではない分析の準備の例を使用して、弱いコンピュータでも、それほど努力することなく「まともな」量のデータを分析するための優れたツールに変えることができることを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複雑な実験を設定していないので、通常のテーブルは分析クエリの適切なソースではないことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リーダーが略語OLTPとOLAPを簡単に解読できる場合は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">列ストア</font></a><font style="vertical-align: inherit;">セクションに直接移動することをお</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">勧めし</font></a><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを操作する2つのアプローチ</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは簡単に説明します。</font><font style="vertical-align: inherit;">このトピックに関する十分な情報がインターネット上にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、最高レベルでは、データを処理するためのアプローチはOLTPとOLAPの2つしかありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OLTP-インスタントトランザクション処理として変換できます。</font><font style="vertical-align: inherit;">実際、私たちは少量のデータで機能する短いトランザクションのオンライン処理について話しています。</font><font style="vertical-align: inherit;">たとえば、注文の記録、更新、削除などです。</font><font style="vertical-align: inherit;">ほとんどの場合、注文は非常に少量のデータであり、その処理中に、最新のRDBMSによって課される長いロックを恐れることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OLAP-一度に多数のトランザクションの分析処理として変換できます。</font><font style="vertical-align: inherit;">ほとんどの場合、レポートは特定のセクションの統合された集計値を生成するため、どのレポートもこの特定のアプローチを使用します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それぞれのアプローチには独自のテクノロジーがあります。</font><font style="vertical-align: inherit;">たとえば、OLTPの場合はPostgreSQL、OLAPの場合はMicrosoft SQL Server Analysis Servicesです。</font><font style="vertical-align: inherit;">PostgresSQLはデータをテーブルに格納するためによく知られたフォーマットを使用しますが、OLAPのためにいくつかの異なるフォーマットが発明されました。</font><font style="vertical-align: inherit;">これらは、多次元テーブル、キーと値のペアで満たされたバケット、および私のお気に入りの列ストアです。</font><font style="vertical-align: inherit;">後者については、以下で詳しく説明します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ2つのアプローチが必要なのですか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データウェアハウスは、遅かれ早かれ2種類の負荷に直面します。非常に少量のデータの頻繁な読み取り（もちろん、書き込みと更新も）とまれな読み取りですが、非常に大量のデータです。実際、これは、たとえばレジや頭の活動です。一日中稼働するキャッシュデスクは、データの小さなチャンクでストレージを満たしますが、1日の終わりに、ビジネスが順調に進んでいる場合、蓄積されたボリュームは印象的なサイズに達します。次に、1日の終わりにマネージャーは、興行収入が1日あたりにどれだけ稼いだかを知りたいと考えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、OLTPにはテーブルとインデックスがあります。これら2つのツールは、興行活動をすべての詳細とともに記録するのに最適です。インデックスを使用すると、以前に記録した注文をすばやく検索できるため、注文の変更は簡単です。しかし、リーダーのニーズを満たすためには、1日に蓄積されるデータの全体量を考慮する必要があります。また、原則として、マネージャーはすべての注文のすべての詳細を必要とするわけではありません。彼が本当に知る必要があるのは、興行収入が一般的にどれだけのお金を稼いだかということです。切符売り場がどこにあるか、昼休みがあるとき、誰が働いたかなどは関係ありません。その場合、OLAPが存在するため、システムは質問に答えることができます。つまり、各注文とそのすべての詳細を順番に読み取ることなく、会社が全体としてどれだけの収益を上げているかということです。 OLAPは同じテーブルとインデックスを使用できますか？何とOLTP？答えはノーです、少なくともそうすべきではありません。まず、OLAPはテーブルに記録されたすべての詳細を必要としないためです。この問題は、2次元テーブル以外の形式でデータを保存することで解決されます。第2に、分析された情報は多くの場合、さまざまなテーブルに分散しており、自己結合の関連付けなど、複数の関連付けが必要になります。この問題を解決するために、原則として特別なデータベーススキーマを開発します。このスキームは、OLAPロード用に最適化されているだけでなく、OLTPロード用の通常の正規化スキームにも最適化されています。さまざまなテーブルに分散しているため、自己結合結合を含む複数の結合が必要です。この問題を解決するために、原則として特別なデータベーススキーマを開発します。このスキームは、OLAPロード用に最適化されているだけでなく、OLTPロード用の通常の正規化スキームにも最適化されています。さまざまなテーブルに分散しているため、自己結合結合を含む複数の結合が必要です。この問題を解決するために、原則として特別なデータベーススキーマを開発します。このスキームは、OLAPロード用に最適化されているだけでなく、OLTPロード用の通常の正規化スキームにも最適化されています。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OLAPがOLTPスキームを使用するとどうなるか</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、このセクションを導入したのは、この記事がそのような資料のフォーマットに関する私自身の要件を明確に満たすようにするためです。</font><font style="vertical-align: inherit;">問題、解決策、結論。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ分析にOLTPスキームを使用することの欠点をいくつか挙げます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスが多すぎます。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの場合、レポートをサポートするために特別なインデックスを作成する必要があります。</font><font style="vertical-align: inherit;">これらのインデックスは、OLAPデータストレージスキームを実装します。</font><font style="vertical-align: inherit;">それらはアプリケーションのOLTP部分では使用されませんが、アプリケーションに負荷をかけているため、継続的なサポートが必要であり、ディスク領域を占有します。</font></font></i> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み取られたデータの量が必要な量を超えています。 </font></font></li>
<li>   .<br>
<br>
<i>  ,   ,         .       .   —   ,       .     —   . ..        ,    ,            .         OLAP    . </i> </li>
<li>  .<br>
<br>
<i>.. OLTP    OLAP     ,     OLTP   .</i> </li>
<li> ,   .<br>
<br>
<i>   ,     ,       .  .</i> </li>
<li>  .<br>
<br>
<i>      ,    ,    ,   ,           . </i> </li>
<li>  .<br>
<br>
<i>  ,    «»    .      .  ,   OLAP   ,     OLTP,  OLAP     .</i> </li>
</ul> <br>
<b><a name="cs"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列ストア</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
この記事では、列ストアのストレージ形式に焦点を当てますが、低レベルの詳細はありません。上記の他のフォーマットも注目に値しますが、これは別の記事のトピックです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、列ストア形式は約30年前から知られていますが、RDBMSでは最近まで実装されていませんでした。 columnstoreの本質は、データが行ではなく列に格納されることです。それら。 1ページ（すべて既知の8 KB）では、サーバーは1つのフィールドのデータのみを記録します。テーブルの各フィールドについても同様です。これは、追加情報を読む必要がないようにするために必要です。 10個のフィールドを持つテーブルと、SELECTステートメントで指定されたフィールドが1つだけのクエリを想像してみましょう。行ベースの形式で保存された通常のテーブルである場合、サーバーは10個のフィールドすべてを読み取るように強制されますが、1つだけを返します。サーバーが必要以上に9倍の情報を読み取ったことがわかります。列ストアはこの問題を完全に解決します。ストレージ形式では、順序付けされた1つのフィールドのみを読み取ることができます。これはすべて、RDBMSのストレージユニットがページであるために発生します。それら。サーバーは常に少なくとも1つのページの書き込みと読み取りを行います。唯一の問題は、その上に存在するフィールドの数です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Columnstoreが実際に役立つ方法</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに答えるには正確な数が必要です。</font><font style="vertical-align: inherit;">それらを取得しましょう。</font><font style="vertical-align: inherit;">しかし、どの数字が正確な画像を与えることができますか？</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスク容量。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリのパフォーマンス。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォールトトレランス。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装の容易さ。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者が新しい構造で作業するために必要な新しいスキルは何ですか。</font></font></li>
</ol> <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスクスペース</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単なテーブルを作成し、データを入力して、必要なスペースを確認してみましょう。 </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">table</span> cstore_table <font></font>
( <font></font>
  trd <span class="hljs-type">date</span>, <font></font>
  org <span class="hljs-type">int</span>, <font></font>
  op <span class="hljs-type">int</span>, <font></font>
  it <span class="hljs-type">int</span>, <font></font>
  wh <span class="hljs-type">int</span>, <font></font>
  m1 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m2 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m3 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m4 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m5 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <font></font>
) <font></font>
<span class="hljs-keyword">server</span> cstore_server 
<span class="hljs-keyword">options</span>(compression <span class="hljs-string">'pglz'</span>); </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気付きのように、外部テーブルを作成しました。</font><font style="vertical-align: inherit;">実際のところ、PostgreSQLには組み込みの列ストアサポートがありません。</font><font style="vertical-align: inherit;">しかし、PostgreSQLには拡張のための強力なシステムがあります。</font><font style="vertical-align: inherit;">それらの1つは、列ストアテーブルの作成を可能にします。</font><font style="vertical-align: inherit;">記事の最後にあるリンク。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pglz-PostgreSQLの組み込みアルゴリズムを使用してデータを圧縮する必要があることを拡張機能に通知します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trd-トランザクション時間。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">op、it、wh —分析セクションまたは測定。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m1、m2、m3、m4、m5-数値インジケーターまたはメジャー。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「まともな」量のデータを挿入して、ディスクにどれだけのスペースが必要かを見てみましょう。</font><font style="vertical-align: inherit;">同時に、インサートのパフォーマンスをチェックします。</font><font style="vertical-align: inherit;">なぜなら </font><font style="vertical-align: inherit;">私は自宅のラップトップで実験を行いましたが、データ量は少し有機的です。</font><font style="vertical-align: inherit;">また、さらに良いのは、ゲストOSのFedora 30を実行しているHDDを使用することです。OSホスト-Windows 10 Home Edition。</font><font style="vertical-align: inherit;">プロセッサーIntel Core7。ゲストOSは4 GBのRAMを受け取りました。</font><font style="vertical-align: inherit;">PostgreSQLバージョン-x86_64-pc-linux-gnu上のPostgreSQL 10.10、gcc（GCC）9.1.1 20190503（Red Hat 9.1.1-1）、64ビットでコンパイル。</font><font style="vertical-align: inherit;">レコード数52 608 000のデータセットを実験します。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>) 
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> cstore_table 
<span class="hljs-keyword">select</span>  
  <span class="hljs-string">'2010-01-01'</span>::<span class="hljs-type">date</span> + make_interval(days =&gt; d) <span class="hljs-keyword">as</span> trd <font></font>
  , op <font></font>
  , org <font></font>
  , wh <font></font>
  , it <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m1 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m2 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m3 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m4 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m5 
<span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> op 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> org 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> wh 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">4000</span>) <span class="hljs-keyword">as</span> it 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1095</span>) <span class="hljs-keyword">as</span> d; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです</font></font><br>
<blockquote>Insert on cstore_table (cost=0.01..24902714242540.01 rows=1000000000000000 width=150) (actual time=119560.456..119560.456 rows=0 loops=1) <br>
----&gt; Nested Loop (cost=0.01..24902714242540.01 rows=1000000000000000 width=150) (actual time=1.823..22339.976 rows=52608000 loops=1) <br>
----------&gt; Function Scan on generate_series d (cost=0.00..10.00 rows=1000 width=4) (actual time=0.151..2.198 rows=1096 loops=1) <br>
----------&gt; Materialize (cost=0.01..27284555030.01 rows=1000000000000 width=16) (actual time=0.002..3.196 rows=48000 loops=1096) <br>
----------------&gt; Nested Loop (cost=0.01..17401742530.01 rows=1000000000000 width=16) (actual time=1.461..15.072 rows=48000 loops=1) <br>
----------------------&gt; Function Scan on generate_series it (cost=0.00..10.00 rows=1000 width=4) (actual time=1.159..2.007 rows=4000 loops=1) <br>
----------------------&gt; Materialize (cost=0.01..26312333.01 rows=1000000000 width=12) (actual time=0.000..0.001 rows=12 loops=4000) <br>
----------------------------&gt; Nested Loop (cost=0.01..16429520.01 rows=1000000000 width=12) (actual time=0.257..0.485 rows=12 loops=1) <br>
----------------------------------&gt; Function Scan on generate_series wh (cost=0.00..10.00 rows=1000 width=4) (actual time=0.046..0.049 rows=3 loops=1) <br>
----------------------------------&gt; Materialize (cost=0.01..28917.01 rows=1000000 width=8) (actual time=0.070..0.139 rows=4 loops=3) <br>
---------------------------------------&gt; Nested Loop (cost=0.01..20010.01 rows=1000000 width=8) (actual time=0.173..0.366 rows=4 loops=1) <br>
-------------------------------------------&gt; Function Scan on generate_series op (cost=0.00..10.00 rows=1000 width=4) (actual time=0.076..0.079 rows=2 loops=1) <br>
---------------------------------------------&gt; Function Scan on generate_series org (cost=0.00..10.00 rows=1000 width=4) (actual time=0.043..0.047 rows=2 loops=2) <br>
Planning time: 0.439 ms <br>
Execution time: 119692.051 ms</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計実行時間-1.994867517分</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。データセット作成時間-22.339976秒</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。挿入時間-1.620341333分</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL関数を使用して、占有されているディスク領域を評価できませんでした。</font><font style="vertical-align: inherit;">理由は不明ですが、0を表示しています。おそらくこれが外部テーブルの標準的な動作です。</font><font style="vertical-align: inherit;">このファイルマネージャに使用されます。</font><font style="vertical-align: inherit;">したがって、占有されているディスク容量は226.2 Mbです。</font><font style="vertical-align: inherit;">多かれ少なかれ評価するために、通常のテーブルと比較してみましょう。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>) 
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> rbstore_table <span class="hljs-keyword">as</span>  
<span class="hljs-keyword">select</span>  
  <span class="hljs-string">'2010-01-01'</span>::<span class="hljs-type">date</span> + make_interval(days =&gt; d) <span class="hljs-keyword">as</span> trd <font></font>
  , op <font></font>
  , org <font></font>
  , wh <font></font>
  , it <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m1 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m2 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m3 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m4 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m5 
<span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> op 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> org 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> wh 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">4000</span>) <span class="hljs-keyword">as</span> it 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1095</span>) <span class="hljs-keyword">as</span> d; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです</font></font><br>
<blockquote>Nested Loop (cost=0.01..22402714242540.01 rows=1000000000000000 width=44) (actual time=0.585..23781.942 rows=52608000 loops=1) <br>
---&gt; Function Scan on generate_series d (cost=0.00..10.00 rows=1000 width=4) (actual time=0.091..2.130 rows=1096 loops=1) <br>
---&gt; Materialize (cost=0.01..27284555030.01 rows=1000000000000 width=16) (actual time=0.001..3.574 rows=48000 loops=1096) <br>
----------&gt; Nested Loop (cost=0.01..17401742530.01 rows=1000000000000 width=16) (actual time=0.489..14.044 rows=48000 loops=1) <br>
----------------&gt; Function Scan on generate_series it (cost=0.00..10.00 rows=1000 width=4) (actual time=0.477..1.352 rows=4000 loops=1) <br>
----------------&gt; Materialize (cost=0.01..26312333.01 rows=1000000000 width=12) (actual time=0.000..0.001 rows=12 loops=4000) <br>
----------------------&gt; Nested Loop (cost=0.01..16429520.01 rows=1000000000 width=12) (actual time=0.010..0.019 rows=12 loops=1) <br>
----------------------------&gt; Function Scan on generate_series wh (cost=0.00..10.00 rows=1000 width=4) (actual time=0.003..0.003 rows=3 loops=1) <br>
----------------------------&gt; Materialize (cost=0.01..28917.01 rows=1000000 width=8) (actual time=0.002..0.004 rows=4 loops=3) <br>
----------------------------------&gt; Nested Loop (cost=0.01..20010.01 rows=1000000 width=8) (actual time=0.006..0.009 rows=4 loops=1) <br>
----------------------------------------&gt; Function Scan on generate_series op (cost=0.00..10.00 rows=1000 width=4) (actual time=0.002..0.002 rows=2 loops=1) <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
----------------------------------------&gt; generate_series orgの関数スキャン（コスト= 0.00 ..10.00行= 1000幅= 4）（実際の時間= 0.001..0.001行= 2ループ= 2）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間：0.569ミリ</font><font style="vertical-align: inherit;">秒</font><font style="vertical-align: inherit;">実行時間：378883.989ミリ秒</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この計画の実施に費やされた時間は、私たちにとって興味がありません。</font><font style="vertical-align: inherit;">実際には、そのような挿入は想定されていません。</font><font style="vertical-align: inherit;">このテーブルが占めるディスク容量に関心があります。</font><font style="vertical-align: inherit;">システム機能の要求を満たしたため、3.75 GBを受け取りました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、cstore_table-226 MB、rbstore_table-3.75 GB。</font><font style="vertical-align: inherit;">16.99回の違いは驚くべきものですが、主にデータの分布が原因で、本番環境で同じ違いが得られるとは考えられません。</font><font style="vertical-align: inherit;">原則として、この差は小さく、約5倍になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、少し待ってください。分析目的で行ベースの形式の生データを使用する人はいません。たとえば、レポート用にインデックス付きデータを使用しようとします。そして、 「生」のデータは常に存在するため、サイズをインデックスのサイズと比較する必要があります。少なくとも1つのインデックスを作成しましょう。日付フィールドと操作のタイプのインデックス-trd + opとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、2つのフィールドのみにインデックスを付けました。インデックスのサイズは1583 MBで、cstore_tableよりもはるかに大きくなっています。ただし、原則として、OLAPロードには1つのインデックスから遠く離れている必要があります。ここで、cstore_tableに追加のインデックスを付ける必要がないことに注意してください。このテーブルは、クエリをカバーするインデックスとして機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のすべてから、簡単な結論を出すことができます-列ストアテーブルを使用すると、使用されるディスク領域の量を減らすことができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリのパフォーマンス</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンスを評価するために、特定のタイプの操作の特定の月の要約データを返すクエリを実行してみましょう。 </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span><font></font>
  sum(m1)<font></font>
<span class="hljs-keyword">from</span> cstore_table 
<span class="hljs-keyword">where</span> 
  trd = <span class="hljs-string">'2011-01-01'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです </font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集計（コスト= 793602.69..793602.70行= 1幅= 32）（実際の時間= 79.708..79.708行= 1ループ= 1）- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファー：共有ヒット= 44226 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---&gt; </font><font style="vertical-align: inherit;">cstore_tableの</font><font style="vertical-align: inherit;">外部スキャン（コスト= 0.00 ..793544.70行= 23197幅= 5）（実際の時間= 23.209..76.628行= 24000ループ= 1）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------フィルター：（（trd = '2011-01-01' ::日付） AND（OP = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィルターによって除去--------行：26000 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-------- CSTOREファイル：の/ var / libに/ pgsqlの/ 10 /データ/ cstore_fdw / 16417分の14028 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- ------ CStoreファイルサイズ：120818897 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------バッファー：共有ヒット= 44226 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：0.165 ms </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間：79.887 ms</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> rbstore_table 
<span class="hljs-keyword">where</span> 
  trd = <span class="hljs-string">'2011-01-01'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです </font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集約（コスト= 40053.80..40053.81行= 1幅= 8）（実際の時間= 389.183..389.183行= 1ループ= 1）- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファー：共有読み取り= 545 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---&gt; rbstore_tableでtrd_op_ixを使用したインデックススキャン（コスト= 0.56..39996.70行= 22841幅= 4）（実際の時間= 55.955..385.283行= 24000ループ= 1）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------インデックス条件：（（trd = '2011-01-01 00： 00:00 '::タイムゾーンなしのタイムスタンプ）AND（op = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------バッファー：共有読み取り= 545 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：112.175ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間：389.219ミリ秒</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">389.219ミリ秒vs 79.887ミリ秒 </font><font style="vertical-align: inherit;">ここでは、比較的少量の列ストアデータでも、テーブルが行ベースのテーブルのインデックスよりも大幅に高速であることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを変更して、2011年全体のユニットを取得してみましょう。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> cstore_table 
<span class="hljs-keyword">where</span> 
  trd <span class="hljs-keyword">between</span> <span class="hljs-string">'2011-01-01'</span> <span class="hljs-keyword">and</span> <span class="hljs-string">'2011-12-31'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです </font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集計（コスト= 946625.58..946625.59行= 1幅= 32）（実際の時間= 3123.604..3123.604行= 1ループ= 1）- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファー：共有ヒット= 44226 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---&gt; </font><font style="vertical-align: inherit;">cstore_tableの</font><font style="vertical-align: inherit;">外部スキャン（コスト= 0.00 ..925064.70行= 8624349幅= 5）（実際の時間= 21.728..2100.665行= 8760000ループ= 1）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------フィルター：（（trd&gt; = '2011-01-01' ::日付）AND（trd &lt;= '2011-12-31' :: date）AND（op = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------フィルターによって削除された行：8760000 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-------- CStoreファイル：/ var / lib / pgsql / 10 / data / cstore_fdw / 14028/16411 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-------- CStoreファイルサイズ：120818897 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------バッファー：共有ヒット= 44226 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：0.212 ms </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間： 3123.960ミリ秒</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> rbstore_table 
<span class="hljs-keyword">where</span> 
  trd <span class="hljs-keyword">between</span> <span class="hljs-string">'2011-01-01'</span> <span class="hljs-keyword">and</span> <span class="hljs-string">'2011-12-31'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実施計画は次のとおりです </font></font><br>
<blockquote>Finalize Aggregate (cost=885214.33..885214.34 rows=1 width=8) (actual time=98512.560..98512.560 rows=1 loops=1) <br>
--Buffers: shared hit=2565 read=489099 <br>
---&gt; Gather (cost=885214.12..885214.33 rows=2 width=8) (actual time=98427.034..98523.194 rows=3 loops=1) <br>
--------Workers Planned: 2 <br>
--------Workers Launched: 2 <br>
--------Buffers: shared hit=2565 read=489099 <br>
---------&gt; Partial Aggregate (cost=884214.12..884214.13 rows=1 width=8) (actual time=97907.608..97907.608 rows=1 loops=3) <br>
--------------Buffers: shared hit=2565 read=489099 <br>
---------------&gt; Parallel Seq Scan on rbstore_table (cost=0.00..875264.00 rows=3580047 width=4) (actual time=40820.004..97405.250 rows=2920000 loops=3) <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------------フィルター：（（trd&gt; = '2011-01-01 00:00:00' ::タイムゾーンなしのタイムスタンプ）AND（trd &lt;= '2011-12-31 00:00:00' ::タイムゾーンなしのタイムスタンプ）AND（op = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------------------行が削除されましたフィルター別：14616000 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--------------------バッファー：共有ヒット= 2565読み取り= 489099 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：7.899ミリ秒</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間：98523.278ミリ秒</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98523.278 ms vs 3123.960 ms </font><font style="vertical-align: inherit;">おそらく部分的なインデックスが役立つかもしれませんが、リスクを冒さず、既製の値が格納される適切なrow_based構造を作成することをお勧めします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動集計</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手動集計に適した構造は、事前計算された値を含む通常のrow_basedテーブルです。たとえば、2011に関連する操作タイプが1のレコードが含まれている場合がありますが、フィールドm1、m2、m3、m4、m5には、これらの分析セクションの集計値が正確に格納されます。したがって、十分な集合とインデックスのセットがあると、分析クエリは前例のないパフォーマンスを獲得します。興味深いことに、Microsoft SQL Server Analysis Servicesには、事前に計算された値の数と深さを構成できる特別なウィザードがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このソリューションには次の利点があります。</font></font><br>
<br>
<ul>
<li>  . <br>
<br>
<i>     «   ».     ,            .<br>
<br>
     ,     .   .   ,    «»  .</i></li>
<li>    .<br>
<br>
<i>   .       ,      ,   .</i></li>
<li> .<br>
<br>
<i>         ,     ,          .</i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">難易度のテスト。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは、単体テストと手動テストの両方について話しています。</font><font style="vertical-align: inherit;">読者は、マルチスレッドエラーの識別は簡単な作業ではないことを説明すべきではないと思います。</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なディスク容量の増加。</font></font><br>
<br>
</li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列ストアの実際の使用</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで再び理論に突入し、分析データとは何かという問題をより詳細に分析する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
企業の平均的な責任者を務めます。</font><font style="vertical-align: inherit;">原則として、彼/彼女は2つのグローバルな質問について心配しています：「現在の状況はどうですか？」</font><font style="vertical-align: inherit;">そして「最近何が変わったのか？」。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「現時点での状況はどうですか」という質問に答えるために、履歴データは絶対に必要ありません。</font><font style="vertical-align: inherit;">それら。</font><font style="vertical-align: inherit;">1か月前の状況に関係なく。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指を離さないようにするために、よく質問されます。</font><font style="vertical-align: inherit;">このタイプのデータ分析は運用と呼ばれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「最近何が変わったのか」という質問に答えるには、履歴データが必要です。さらに、原則として、分析は同じ時間間隔で実行されます。たとえば、1か月は1か月、1年ごとなどと比較されます。もちろん、システムはユーザーが任意の期間を比較する機能を制限するべきではありませんが、そのようなケースはまれであると認識されなければなりません。閉鎖された年を閉鎖されていない半分と比較することはほとんど意味がありません。比較分析の際立った特徴は、運用ほど頻繁に必要とされないことです。このタイプの分析を履歴と呼びます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、運用分析は迅速に行う必要があります。したがって、それは性能に高い要求を課します。歴史的分析のために、そのような要件を提唱することはできません。ただし、履歴分析のパフォーマンスは非常に高いレベルに留まるはずです。少なくとも、分析システム自体は競争力を維持するためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、2種類の分析に従って、運用データと履歴の2種類の分析データを区別できます。ユーザーの側から見ると、彼が現在作業している特定のデータに気付かないはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの考慮事項から、データベースサーバーでは、テーブルを個別のセクションに分割する可能性が出てきました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
列ストアに関しては、行ベースの形式と列ストア形式のセクションを混在させることができます。</font><font style="vertical-align: inherit;">運用分析データは頻繁に変更される可能性があり、列ストア形式での格納が妨げられます。</font><font style="vertical-align: inherit;">また、運用データはあまり発生しないため、行ベースの形式で格納できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
履歴データは変更されません。</font><font style="vertical-align: inherit;">このデータはたくさんあるため、列ストア形式の方が適しています。</font><font style="vertical-align: inherit;">列ストアソースでの太字のクエリのパフォーマンスは、行ベースのソースよりも高いことを思い出してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のすべての例を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下に、メインの倉庫テーブルを作成し、運用および履歴分析のセクションを添付します。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> warehouse <font></font>
( <font></font>
  trd <span class="hljs-type">date</span>, <font></font>
  org <span class="hljs-type">int</span>, <font></font>
  op <span class="hljs-type">int</span>, <font></font>
  it <span class="hljs-type">int</span>, <font></font>
  wh <span class="hljs-type">int</span>, <font></font>
  m1 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m2 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m3 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m4 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m5 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <font></font>
) <font></font>
<span class="hljs-keyword">partition by range</span>(trd); <font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">foreign</span> <span class="hljs-keyword">table</span> historycal_data <font></font>
( <font></font>
  trd <span class="hljs-type">date</span>, <font></font>
  org <span class="hljs-type">int</span>, <font></font>
  op <span class="hljs-type">int</span>, <font></font>
  it <span class="hljs-type">int</span>, <font></font>
  wh <span class="hljs-type">int</span>, <font></font>
  m1 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m2 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m3 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m4 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>), <font></font>
  m5 <span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <font></font>
) <font></font>
<span class="hljs-keyword">server</span> cstore_server 
<span class="hljs-keyword">options</span>(compression <span class="hljs-string">'pglz'</span>); <font></font>
 <font></font>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> historycal_data 
<span class="hljs-keyword">select</span>  
  <span class="hljs-string">'2010-01-01'</span>::<span class="hljs-type">date</span> + make_interval(days =&gt; d) <span class="hljs-keyword">as</span> trd <font></font>
  , op <font></font>
  , org <font></font>
  , wh <font></font>
  , it <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m1 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m2 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m3 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m4 <font></font>
  , <span class="hljs-number">100</span> <span class="hljs-keyword">as</span> m5 
<span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> op 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> org 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> wh 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">4000</span>) <span class="hljs-keyword">as</span> it 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">0</span>, (<span class="hljs-number">1095</span> - <span class="hljs-number">31</span>)) <span class="hljs-keyword">as</span> d; <font></font>
 <font></font>
<span class="hljs-keyword">analyze</span> historycal_data; <font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> operational_data <span class="hljs-keyword">as</span> 
<span class="hljs-keyword">select</span>  
  (<span class="hljs-string">'2012-12-01'</span>::<span class="hljs-type">date</span> + make_interval(days =&gt; d))::<span class="hljs-type">date</span> <span class="hljs-keyword">as</span> trd <font></font>
  , op <font></font>
  , org <font></font>
  , wh <font></font>
  , it <font></font>
  , <span class="hljs-number">100</span>::<span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> m1 <font></font>
  , <span class="hljs-number">100</span>::<span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> m2 <font></font>
  , <span class="hljs-number">100</span>::<span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> m3 <font></font>
  , <span class="hljs-number">100</span>::<span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> m4 <font></font>
  , <span class="hljs-number">100</span>::<span class="hljs-type">numeric</span>(<span class="hljs-number">32</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> m5 
<span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> op 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> org 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> wh 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">4000</span>) <span class="hljs-keyword">as</span> it 
<span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> generate_series(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>) <span class="hljs-keyword">as</span> d; <font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span> trd_op_ix <span class="hljs-keyword">on</span> operational_data (trd, op); <font></font>
<font></font>
<span class="hljs-keyword">analyze</span> operational_data; <font></font>
<font></font>
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> warehouse <span class="hljs-keyword">attach partition</span> operational_data <span class="hljs-keyword">for</span> <span class="hljs-keyword">values</span> <span class="hljs-keyword">from</span> (<span class="hljs-string">'2012-12-01'</span>) <span class="hljs-keyword">to</span> (<span class="hljs-string">'2112-01-01'</span>); <font></font>
<font></font>
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> warehouse <span class="hljs-keyword">attach partition</span> historycal_data <span class="hljs-keyword">for</span> <span class="hljs-keyword">values</span> <span class="hljs-keyword">from</span> (<span class="hljs-string">'2010-01-01'</span>) <span class="hljs-keyword">to</span> (<span class="hljs-string">'2012-12-01'</span>); </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべて準備ができています。</font><font style="vertical-align: inherit;">いくつかのレポートを注文してみましょう。</font><font style="vertical-align: inherit;">まず、当月の1日分のデータを注文します。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> warehouse 
<span class="hljs-keyword">where</span> 
  trd = <span class="hljs-string">'2012-12-01'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; 
</code></pre><br>
<blockquote>Aggregate (cost=15203.37..15203.38 rows=1 width=32) (actual time=17.320..17.320 rows=1 loops=1) <br>
--Buffers: shared hit=3 read=515 <br>
---&gt; Append (cost=532.59..15140.89 rows=24991 width=5) (actual time=1.924..13.838 rows=24000 loops=1) <br>
-------Buffers: shared hit=3 read=515 <br>
---------&gt; Bitmap Heap Scan on operational_data (cost=532.59..15140.89 rows=24991 width=5) (actual time=1.924..11.992 rows=24000 loops=1) <br>
---------------Recheck Cond: ((trd = '2012-12-01'::date) AND (op = 1)) <br>
---------------Heap Blocks: exact=449 <br>
---------------Buffers: shared hit=3 read=515 <br>
----------------&gt; Bitmap Index Scan on trd_op_ix (cost=0.00..526.34 rows=24991 width=0) (actual time=1.877..1.877 rows=24000 loops=1) <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------------インデックス条件：（（trd = '2012-12-01' :: date）AND（op = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---- -----------------バッファ：共有ヒット= 2読み取り= 67 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：0.388 ms </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間：100.941 ms</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ここでは、2012年全体のデータを注文します。トランザクション数は8,784,000です。 </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> warehouse 
<span class="hljs-keyword">where</span> 
  trd <span class="hljs-keyword">between</span> <span class="hljs-string">'2012-01-01'</span> <span class="hljs-keyword">and</span> <span class="hljs-string">'2012-12-31'</span> 
  <span class="hljs-keyword">and</span> 
  op = <span class="hljs-number">1</span>; 
</code></pre><blockquote>Aggregate (cost=960685.82..960685.83 rows=1 width=32) (actual time=4124.681..4124.681 rows=1 loops=1) <br>
--Buffers: shared hit=45591 read=11282 <br>
---&gt; Append (cost=0.00..938846.60 rows=8735687 width=5) (actual time=66.581..3036.394 rows=8784000 loops=1) <br>
---------Buffers: shared hit=45591 read=11282 <br>
----------&gt; Foreign Scan on historycal_data (cost=0.00..898899.60 rows=7994117 width=5) (actual time=66.579..2193.801 rows=8040000 loops=1) <br>
---------------Filter: ((trd &gt;= '2012-01-01'::date) AND (trd &lt;= '2012-12-31'::date) AND (op = 1)) <br>
---------------Rows Removed by Filter: 8040000 <br>
---------------CStore File: /var/lib/pgsql/10/data/cstore_fdw/14028/16448 <br>
---------------CStore File Size: 117401470 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------バッファー：共有ヒット= 42966 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
----------&gt; </font><font style="vertical-align: inherit;">Operational_dataのシーケンス</font><font style="vertical-align: inherit;">スキャン（コスト= 0.00..39947.00行= 741570幅= 5） （実際の時間= 0.019..284.824行= 744000ループ= 1）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------フィルター：（（trd&gt; = '2012-01-01' ::日付）AND（ trd &lt;= '2012-12-31' :: date）AND（op = 1））</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------フィルターによって削除された行：744000 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-------- -------バッファ：共有ヒット= 2625読み取り= 11282 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画時間：0.256 ms </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行時間：4125.239 ms</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 最後に、ユーザーが、たとえば悪意なく、システム内のすべてのトランザクションに関するレポートを注文したい場合に何が起こるかを見てみましょう。このトランザクションには52 608 000があります。 </font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">explain</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span>, <span class="hljs-keyword">buffers</span>) 
<span class="hljs-keyword">select</span>  <font></font>
  sum(m1) <font></font>
<span class="hljs-keyword">from</span> warehouse</code></pre><br>
<blockquote>Aggregate (cost=672940.20..672940.21 rows=1 width=32) (actual time=15907.886..15907.886 rows=1 loops=1) <br>
--Buffers: shared hit=17075 read=11154 <br>
---&gt; Append (cost=0.00..541420.20 rows=52608000 width=5) (actual time=0.192..9115.144 rows=52608000 loops=1) <br>
---------Buffers: shared hit=17075 read=11154 <br>
----------&gt; Foreign Scan on historycal_data (cost=0.00..512633.20 rows=51120000 width=5) (actual time=0.191..5376.449 rows=51120000 loops=1) <br>
---------------CStore File: /var/lib/pgsql/10/data/cstore_fdw/14028/16448 <br>
---------------CStore File Size: 117401470 <br>
---------------Buffers: shared hit=14322 <br>
----------&gt; Seq Scan on operational_data (cost=0.00..28787.00 rows=1488000 width=5) (actual time=0.032..246.978 rows=1488000 loops=1) <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
---------------バッファー：共有ヒット= 2753読み取り= 11154 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間：0.157 ms実行時間：15908.096 ms</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何も起こらなかったかのように、私はまだ私の記事を書いていることに注意してください。</font><font style="vertical-align: inherit;">HDDと4 GB RAMを搭載したそれほど強力でないラップトップを再起動する必要すらありませんでした。</font><font style="vertical-align: inherit;">リソース消費の問題については、より慎重な調査が必要ですが。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">耐障害性 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部分的には、この記事の執筆時点でフォールトトレランスがテストされています。</font><font style="vertical-align: inherit;">私のラップトップは生きており、通常、通常の作業以外に、作業の遅延に気づきませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォールトトレランスの問題を詳細に解決する時間がなかったという事実を読者に許してもらいますが、問題の拡張にはフォールトトレランスがあると言えます-バックアップは可能です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装のしやすさ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局のところ、データを列ストア形式で格納するテーブルを作成する場合、圧縮アルゴリズム以外のオプションはありません。</font><font style="vertical-align: inherit;">圧縮自体は絶対に必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォーマット自体は特定の構造を持っています。</font><font style="vertical-align: inherit;">適切なパラメータを設定することで、分析クエリの特定の高速化を実現したり、情報圧縮の程度を調整したりできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上で示したように、列ストアテーブルを作成するのは面倒ではありません。</font><font style="vertical-align: inherit;">拡張機能は、40のPostgreSQLデータ型で機能します。</font><font style="vertical-align: inherit;">ウェビナーはPostgreSQLでサポートされているすべてのタイプについて話しました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者が新しい構造で作業するために必要な新しいスキル</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL開発者は、列ストアテーブルに対するクエリを作成するために特別なスキルを必要としません。</font><font style="vertical-align: inherit;">このようなテーブルは、通常の行ベースのテーブルのように、すべてのクエリで表示されます。</font><font style="vertical-align: inherit;">ただし、これはクエリの最適化の必要性を排除するものではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、列ストアストレージ形式のテーブルがどのように役立つかを説明しました。</font><font style="vertical-align: inherit;">これにより、ディスク容量と高性能の分析クエリが節約されます。</font><font style="vertical-align: inherit;">テーブルを簡単に操作できるため、本格的な分析データウェアハウスの作成コストが自動的に削減されます。</font><font style="vertical-align: inherit;">その使用は、複雑でデバッグが難しいアルゴリズムの開発を必要としません。</font><font style="vertical-align: inherit;">テストが簡素化されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の実験が楽観論を鼓舞するという事実にもかかわらず、多くの問題が解決されていません。</font><font style="vertical-align: inherit;">たとえば、列ストアテーブルが他のテーブルを結合するときに生成されるクエリプラン。</font><font style="vertical-align: inherit;">次のパートでもこの仕事を続けたいと思います。</font><font style="vertical-align: inherit;">部品の数は、cstore_fdwが多かれ少なかれ実際のデータでどのように動作するかに依存します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加資料へのリンク </font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">githubロードマップcstore_fdwの</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">cstore_fdw </font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cstore_fdwの</font></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">概要</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472384/index.html">開発者の観点から見たAndroidのアップデート</a></li>
<li><a href="../ja472386/index.html">ZIO＆Cats Effect：成功した同盟</a></li>
<li><a href="../ja472388/index.html">ウォルマートがアマゾンの価格戦争を宣言</a></li>
<li><a href="../ja472392/index.html">オーディオカセットの上昇、下降、および可能な復帰-神話に対処し、状況の概要を説明します</a></li>
<li><a href="../ja472394/index.html">オフショアの石油およびガスに対する人工知能の影響の評価</a></li>
<li><a href="../ja472402/index.html">RTMPビデオ通話ストリーミング</a></li>
<li><a href="../ja472404/index.html">2D衝突計算：Gilbert-Johnson-Kirtiアルゴリズム</a></li>
<li><a href="../ja472406/index.html">ピザの配達中にデータセンターを拡張する</a></li>
<li><a href="../ja472410/index.html">利用可能なカラーシステムの設計</a></li>
<li><a href="../ja472412/index.html">システムアナリストと製品の測定基準-振るが、混ぜない？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>