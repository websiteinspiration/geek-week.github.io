<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👌🏼 🙅🏼 🍺 Speeding up charts using OffscreenCanvas 👩🏾‍🏭 📚 👩🏿‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chart rendering can seriously impact the browser. Especially when it comes to outputting a multitude of elements representing diagrams in the interfac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Speeding up charts using OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chart rendering can seriously impact the browser. </font><font style="vertical-align: inherit;">Especially when it comes to outputting a multitude of elements representing diagrams in the interface of a complex application. </font><font style="vertical-align: inherit;">You can try to improve the situation using the interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the level of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> which browsers are gradually growing. </font><font style="vertical-align: inherit;">It allows, using a web-worker, to shift to it the tasks of forming an image displayed in a visible element </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
The article, the translation of which we are publishing today, is devoted to the use of the interface </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here we will talk about why this interface might be needed, about what really can be expected from its use, and about what difficulties may arise when working with it.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why pay attention to OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code involved in the rendering of the diagram may itself have sufficiently high computational complexity. In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">many places,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can find detailed stories about how to output smooth animation and to ensure convenient user interaction with the page, it is necessary that the rendering of one frame fits within about 10 ms, which allows you to reach 60 frames per second. If the calculations required to output one frame take more than 10 ms, this will result in noticeable "slowdowns" of the page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When displaying diagrams, however, the situation is aggravated by the following:</font></font><br>
<br>
<ul>
<li>        —   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( —   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These problems are ideal candidates for a classic optimization approach called divide and conquer. In this case, we are talking about the distribution of computing load across multiple threads. However, before the appearance of the interface, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all the rendering code needed to be executed in the main thread. The only way this code could use the APIs it needed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From a technical point of view, “heavy” calculations could be output to a web worker thread earlier. But, since the calls responsible for rendering had to be made from the main stream, this required the use of complex message exchange schemes between the worker stream and the main stream in the chart output code. Moreover, this approach often gave only a slight performance gain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Specification</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gives us a mechanism for transferring surface control to display element graphics </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a web worker. </font><font style="vertical-align: inherit;">This specification is currently supported by Chrome and Edge browsers (after Edge has been migrated to Chromium). </font><font style="vertical-align: inherit;">It is expected that in Firefox support </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will appear within six months. </font><font style="vertical-align: inherit;">If we talk about Safari, it is still unknown whether support for this technology is planned in this browser.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chart output using OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of a chart that displays 100,000 multi-colored dots</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In order to better assess the potential advantages and disadvantages</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, let's look at an example of the output of the “heavy” diagram shown in the previous figure.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we query </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the element </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the new method </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then we call the method </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, doing this to send a message to the worker containing a link to </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is very important that here, as the second argument, you need to use </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This allows you to make the owner of this object worker, which will allow him to manage alone </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considering that the sizes were </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">originally inherited from the attributes </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">element </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it is our responsibility to keep these values ​​up to date when the element is resized </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Here we use the event </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will give us the opportunity, in agreement with </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, to convey to the worker information about the new dimensions of the element </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to simplify the example, we will use components from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">. This is a set of auxiliary components that either aggregate d3 components or complement their functionality. You </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can </font><font style="vertical-align: inherit;">work with </font><font style="vertical-align: inherit;">without d3fc-components. All that will be discussed can be done using exclusively standard JavaScript features.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to the code from the file </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In this example, for the sake of a real increase in rendering performance, we are going to use WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we receive a message containing a property </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we assume that the message came from the main thread. Next, we get the </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">context </font><font style="vertical-align: inherit;">from the element </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and pass it to the component </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then we call the component </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, passing it the data ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which we want to render using it (below we will talk about where the corresponding variables </font><font style="vertical-align: inherit;">came from </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, we check the properties </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which came in the message, and use them to set the dimensions </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewing area of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. The link </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is not used directly. The fact is that the message contains either a property </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or properties </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The remaining worker code is responsible for setting up the rendering of what we want to output. </font><font style="vertical-align: inherit;">There is nothing special here, so if all of this is familiar to you, you can immediately proceed to the next section in which we discuss performance.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we create a dataset containing the coordinates of points randomly distributed around the origin x / y, and adjust the scaling. </font><font style="vertical-align: inherit;">We do not set the range of x and y values ​​using the method </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since the WebGL series are displayed in full size of the element </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the normalized coordinates of the device).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we set up a series of points using </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Then we configure the appropriate means of access that allow you to read data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, we define our own equality checking function, which is designed to ensure that the component does not transmit </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUs at each rendering. </font><font style="vertical-align: inherit;">We must express this explicitly, because even if we know that we will not modify this data, the component cannot know about it without performing a resource-intensive “dirty” check.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code allows you to colorize the chart. </font><font style="vertical-align: inherit;">We use the index of the point in the data set to select a suitable color from </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then convert it to the required format and use it to decorate the output point.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that the points are colored, all that remains is to animate the chart. Due to this, we will need a constant method call </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This, in addition, will create some load on the system. We simulate the increase and decrease chart scale using </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to modify the properties </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">every frame. Here, time-dependent values ​​are applied and calculated so that the scale of the chart changes smoothly. In addition, we modify the message header so that a method is called to start the rendering cycle </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and so that we do not have to directly call </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for this example to work, it remains only to import the necessary libraries into the worker. </font><font style="vertical-align: inherit;">We use for this </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and also, so as not to use the tools for building projects, we use a list of dependencies compiled manually. </font><font style="vertical-align: inherit;">Unfortunately, we can’t just download the complete d3 / d3fc builds, since they are DOM dependent, and what they need in the worker is not available. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ The full code for this example can be found on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OffscreenCanvas and performance</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Animation in our project works thanks to the use </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of a worker. This allows the worker to render pages even when the main thread is busy with other things. If you look at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">page</font></a><font style="vertical-align: inherit;"> described in the previous section and click on the button </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you can pay attention to the fact that when the message box is displayed, the update of the timestamp information stops. The main thread is blocked, but the chart animation does not stop.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project Window</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We could organize a rendering initiated by receiving messages from the main stream. For example, such events could be sent when a user interacts with a chart or when receiving fresh data over the network. But with this approach, if the main thread is busy with something and no messages are received in the worker, the rendering will stop.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuous rendering of the chart in conditions when nothing happens on it is a great way to annoy the user with a buzzing fan and low battery. As a result, it turns out that in the real world, the decision on how to divide responsibilities between the main thread and the worker thread depends on whether the worker can render something useful when he does not receive messages about a change in the situation from the main thread.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we talk about the transfer of messages between threads, it should be noted that here we applied a very simple approach. Honestly, we need to transmit very few messages between threads, so I would rather call our approach a consequence of pragmatism, not laziness. But if we talk about real applications, it can be noted that the message transfer scheme between the flows will become more complicated if the user’s interaction with the diagram and updating the visualized data will depend on them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can use the standard </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> interface to create separate message channels between the main thread and the worker </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thread.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Each of these channels can be used for a specific category of messages, which makes it easier to process messages. As an alternative to standard mechanisms, third-party libraries like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can act </font><font style="vertical-align: inherit;">. This library hides low-level details behind a high-level interface using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proxy objects</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another interesting feature of our example, which becomes clearly visible in retrospect, is the fact that it takes into account the fact that GPU resources, like other system resources, are far from endless. Translation of rendering into a worker allows the main thread to solve other problems. But the browser, anyway, needs to use the GPU to render the DOM and what was generated by the means </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the worker consumes all the GPU resources, then the main application window will experience performance problems, regardless of where the rendering is performed. Pay attention to how the speed of updating the timestamp in the example decreases as the number of displayed points increases. If you have a powerful graphics card, then you may have to increase the number of points transmitted to the page in the query string. To do this, you can use a value that exceeds the maximum value of 100000, specified using one of the links on the example page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be noted that here we did not explore the secret world </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of context attributes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Such a study could help us to increase the productivity of the solution. </font><font style="vertical-align: inherit;">However, I did not do this by doing so because of the low level of support for these attributes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we talk about rendering using </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the attribute looks most interesting here </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It, where it is supported, and taking into account some restrictions, allows you to get rid of synchronization between the event loop and the rendering loop that is executed in the worker. </font><font style="vertical-align: inherit;">This minimizes the delay in updating the image. </font><font style="vertical-align: inherit;">Details about this can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gives developers the opportunity to improve chart rendering performance, but using it requires a thoughtful approach. </font><font style="vertical-align: inherit;">Using it, you need to consider the following:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is an</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> example code, and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is its working version. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dear readers! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Have you used OffscreenCanvas to speed up the display of graphics on web pages?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496950/index.html">Design is design, not the beauty of pictures.</a></li>
<li><a href="../en496952/index.html">Qualcomm QCC3020 - the rise of Chinese TWS headphones</a></li>
<li><a href="../en496954/index.html">Development at Wargaming - meeting with Maxim Baryshnikov, Head of Platform (Part I)</a></li>
<li><a href="../en496956/index.html">Why did asynchronous web servers appear?</a></li>
<li><a href="../en496958/index.html">Interesting CSS finds in the new Facebook design</a></li>
<li><a href="../en496962/index.html">How to tidy up an overloaded server?</a></li>
<li><a href="../en496964/index.html">IBM Weekly Seminars - April 2020</a></li>
<li><a href="../en496966/index.html">CSS LCH colors</a></li>
<li><a href="../en496968/index.html">4 actions unforgivable for the leader during COVID-19</a></li>
<li><a href="../en496972/index.html">Food Safety Trends 2020. Free Online Mitap April 21</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>