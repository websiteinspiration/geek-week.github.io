<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äç‚öñÔ∏è üë©üèΩ üç∫ Comment utiliser Prometheus pour d√©tecter des anomalies dans GitLab üåó üë©üèø‚Äçüîß üå≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'une des caract√©ristiques de base du langage de requ√™te Prometheus est l' agr√©gation en temps r√©el des s√©ries chronologiques . Vous pouvez √©galement ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment utiliser Prometheus pour d√©tecter des anomalies dans GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des caract√©ristiques de base du langage de requ√™te Prometheus est </font><font style="vertical-align: inherit;">l' </font><font style="vertical-align: inherit;">agr√©gation en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps r√©el des s√©ries chronologiques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous pouvez √©galement utiliser le langage de requ√™te Prometheus pour d√©tecter les anomalies dans les donn√©es de s√©ries chronologiques.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©quipe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduit </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">un article de l'ing√©nieur de l'√©quipe d'infrastructure GitLab</font></a><font style="vertical-align: inherit;"> , o√π vous trouverez des exemples de code que vous pouvez essayer sur vos syst√®mes.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä quoi sert la d√©tection des anomalies?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe quatre raisons principales qui d√©terminent l'importance de la d√©tection d'anomalies pour GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagnostic des incidents</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : nous pouvons d√©tecter les services qui ont d√©pass√© leur port√©e normale en r√©duisant le temps de d√©tection des incidents (MTTD) et, en cons√©quence, offrir une solution plus rapide au probl√®me.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©tection de la d√©gradation des performances</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : par exemple, si une r√©gression est introduite dans un service qui lui fait acc√©der trop souvent √† un autre service, nous pouvons rapidement d√©tecter et r√©soudre ce probl√®me.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©tection et √©limination des abus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab fournit des m√©canismes de livraison et d'int√©gration ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et d'h√©bergement (GitLab Pages) et un nombre limit√© d'utilisateurs qui peuvent utiliser ces m√©canismes.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©curit√©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la d√©tection des anomalies est importante pour d√©tecter les tendances inhabituelles dans la s√©rie chronologique GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ces raisons et d'autres, l'auteur de l'article a d√©cid√© de comprendre comment configurer la d√©finition des anomalies dans la s√©rie temporelle GitLab √† l'aide des requ√™tes et des r√®gles de Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quel est le niveau d'agr√©gation correct?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, les s√©ries chronologiques doivent √™tre correctement agr√©g√©es. </font><font style="vertical-align: inherit;">Dans l'exemple ci-dessous, nous avons utilis√© le compteur http_requests_total standard pour r√©cup√©rer des donn√©es, bien que de nombreuses autres mesures le fassent √©galement.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette mesure de test comporte plusieurs param√®tres: m√©thode, contr√¥leur, code d'√©tat (code_√©tat), environnement, ainsi que des param√®tres ajout√©s par Prometheus lui-m√™me, par exemple, travail et instance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant choisir le bon niveau d'agr√©gation de donn√©es. </font><font style="vertical-align: inherit;">Trop, trop peu - tout cela est important pour d√©tecter les anomalies. </font><font style="vertical-align: inherit;">Si les donn√©es sont trop agr√©g√©es, il y a deux probl√®mes potentiels:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez ignorer l'anomalie car l'agr√©gation masque les probl√®mes qui se produisent dans des sous-ensembles de vos donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous trouvez une anomalie, il est difficile de la relier √† une partie distincte de votre syst√®me sans effort suppl√©mentaire.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les donn√©es ne sont pas suffisamment agr√©g√©es, cela peut conduire √† une augmentation du nombre de faux positifs, ainsi qu'√† une interpr√©tation incorrecte des donn√©es valides comme erron√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'apr√®s notre exp√©rience, le niveau d'agr√©gation le plus correct est le niveau de service, c'est-√†-dire que nous incluons l'√©tiquette de travail (travail) et d'environnement (environnement) et rejetons toutes les autres √©tiquettes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'agr√©gation, dont nous parlerons tout au long de l'article, comprend: travail - http_request, agr√©gation - cinq minutes, qui est calcul√© sur la base du travail et de l'environnement en cinq minutes.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'apr√®s l'exemple ci-dessus, il est clair que dans la s√©rie http_requests_total, les sous-ensembles sont s√©lectionn√©s dans le contexte du travail et de l'environnement, puis leur nombre est consid√©r√© pendant cinq minutes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation du score Z pour d√©tecter les anomalies</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les principes de base des statistiques peuvent √™tre appliqu√©s pour d√©tecter des anomalies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous connaissez la moyenne et l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©cart type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la s√©rie Prometheus, vous pouvez utiliser n'importe quel √©chantillon de la s√©rie pour calculer le z-score.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un Z-score est une mesure de l'√©cart relatif de la valeur observ√©e ou mesur√©e, qui montre combien d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©carts-types</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son √©cart par rapport √† la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeur moyenne est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le score z = 0 signifie que le score z est identique √† la valeur moyenne dans l'ensemble de donn√©es avec la distribution standard, et le score z = 1 signifie que l'√©cart type = 1,0 de la moyenne.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supposons que les donn√©es de base ont une distribution normale, ce qui signifie que 99,7% des √©chantillons ont un score z de 0 √† 3. Plus le score z est √©loign√© de z√©ro, moins il est probable qu'il existe.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appliquons cette propri√©t√© pour d√©tecter les anomalies dans la s√©rie de donn√©es Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous calculons la moyenne et l'√©cart type de la m√©trique √† l'aide de donn√©es avec un √©chantillon de grande taille. </font><font style="vertical-align: inherit;">Pour cet exemple, nous utilisons des donn√©es hebdomadaires. </font><font style="vertical-align: inherit;">Si nous supposons que les enregistrements sont √©valu√©s une fois par minute, alors dans une semaine, nous aurons un peu plus de 10 000 √©chantillons.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous pouvons calculer le z-score pour la requ√™te Prometheus d√®s que nous obtenons la moyenne et l'√©cart-type pour l'agr√©gation.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base des principes statistiques des distributions normales, supposons que toute valeur en dehors de la plage de +3 √† -3 sera une anomalie. </font><font style="vertical-align: inherit;">En cons√©quence, nous pouvons cr√©er un avertissement concernant de telles anomalies. </font><font style="vertical-align: inherit;">Par exemple, nous recevrons une alerte lorsque notre agr√©gation d√©passe cette plage pendant plus de cinq minutes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphique du nombre de requ√™tes par seconde au service GitLab Pages pendant 48 heures. </font><font style="vertical-align: inherit;">Le score Z compris entre +3 et -3 est surlign√© en vert. Le</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
score Z peut √™tre difficile √† interpr√©ter sur les graphiques, car cette valeur n'a pas d'unit√© de mesure. </font><font style="vertical-align: inherit;">Mais les anomalies de ce graphique sont tr√®s simples √† d√©terminer. </font><font style="vertical-align: inherit;">Tout ce qui va au-del√† de la zone verte, qui montre un couloir de valeurs avec un z-score de -3 √† +3, sera une valeur anormale.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que faire si la distribution des donn√©es n'est pas normale</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supposons que la distribution des donn√©es est normale. </font><font style="vertical-align: inherit;">Sinon, notre z-score sera faux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreuses astuces statistiques pour d√©terminer la normalit√© de la distribution des donn√©es, mais le meilleur moyen est de v√©rifier que le score z de vos donn√©es se situe dans la plage de -4,0 √† +4,0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux requ√™tes Prometheus montrant les scores z minimum et maximum:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vos r√©sultats sont compris entre -20 et +20, cela signifie que trop de donn√©es ont √©t√© utilis√©es et les r√©sultats sont d√©form√©s. </font><font style="vertical-align: inherit;">N'oubliez pas √©galement que vous devez travailler avec des lignes agr√©g√©es. </font><font style="vertical-align: inherit;">Les mesures qui n'ont pas de distribution normale incluent des param√®tres tels que le taux d'erreur, le retard, la longueur des files d'attente, etc. </font><font style="vertical-align: inherit;">Mais bon nombre de ces mesures fonctionneront mieux avec des seuils d'alerte fixes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©tection statistique d'anomalies saisonni√®res</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que le calcul des scores z fonctionne bien avec la distribution normale des donn√©es de s√©ries chronologiques, il existe une deuxi√®me m√©thode qui peut donner des r√©sultats de d√©tection d'anomalies encore plus pr√©cis. </font><font style="vertical-align: inherit;">C'est l'utilisation de la saisonnalit√© statistique.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La saisonnalit√© est une caract√©ristique d'une m√©trique de s√©rie chronologique lorsque cette m√©trique subit des changements r√©guliers et pr√©visibles qui se r√©p√®tent √† chaque cycle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphique des demandes par seconde (RPS) du lundi au dimanche pendant quatre semaines cons√©cutives Le</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
graphique ci-dessus illustre le RPS (nombre de demandes par seconde) pendant sept jours - du lundi au dimanche, pendant quatre semaines cons√©cutives. </font><font style="vertical-align: inherit;">Cette plage de sept jours est appel√©e ¬´d√©calage¬ª, c'est-√†-dire le motif qui sera utilis√© pour la mesure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque semaine sur le graphique est d'une couleur diff√©rente. </font><font style="vertical-align: inherit;">La saisonnalit√© des donn√©es est indiqu√©e par la s√©quence des tendances indiqu√©es sur le graphique - chaque lundi matin, nous observons une augmentation similaire du RPS, et le soir, le vendredi, nous observons toujours une diminution du RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant la saisonnalit√© dans nos donn√©es de s√©ries chronologiques, nous pouvons pr√©dire avec plus de pr√©cision l'occurrence des anomalies et leur d√©tection.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment utiliser la saisonnalit√©</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prom√©th√©e utilise plusieurs m√©canismes statistiques diff√©rents pour calculer la saisonnalit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous faisons un calcul, en ajoutant une tendance de croissance pour la semaine aux r√©sultats de la semaine pr√©c√©dente. La tendance de croissance est calcul√©e comme suit: soustrayez la moyenne mobile de la semaine derni√®re de la moyenne mobile de la semaine derni√®re.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re it√©ration s'av√®re quelque peu ¬´√©troite¬ª - nous utilisons la fen√™tre de cinq minutes de cette semaine et de la semaine pr√©c√©dente pour obtenir nos pr√©visions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la deuxi√®me it√©ration, nous √©largissons notre couverture en prenant la moyenne de la p√©riode de quatre heures pour la semaine pr√©c√©dente et en la comparant avec la semaine en cours.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, si nous essayons de pr√©dire la valeur m√©trique √† huit heures du matin le lundi, au lieu de la m√™me fen√™tre de cinq minutes la semaine pr√©c√©dente, nous prenons la valeur moyenne de la mesure de six √† dix le matin du lundi pr√©c√©dent.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La demande indiquait 166 heures, soit deux heures de moins qu'une semaine compl√®te (7 * 24 = 168), car nous voulons utiliser une p√©riode de quatre heures en fonction de l'heure actuelle, nous avons donc besoin que le d√©calage soit de deux heures inf√©rieur √† une semaine compl√®te.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS r√©el (jaune) et pr√©vu (bleu) dans deux semaines</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Une comparaison du RPS r√©el avec nos pr√©visions montre que nos calculs √©taient assez pr√©cis. Cependant, cette m√©thode pr√©sente un inconv√©nient. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le 1er mai, GitLab a √©t√© utilis√© moins que d'habitude le mercredi, car ce jour √©tait un jour de cong√©. √âtant donn√© que la tendance de croissance estim√©e d√©pend de la fa√ßon dont le syst√®me a √©t√© utilis√© la semaine pr√©c√©dente, nos pr√©visions pour la semaine prochaine, c'est-√†-dire le mercredi 8 mai, ont donn√© un RPS inf√©rieur √† la r√©alit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette erreur peut √™tre corrig√©e en faisant trois pr√©visions pour trois semaines cons√©cutives avant le mercredi 1er mai, c'est-√†-dire les trois mercredi pr√©c√©dent. La demande reste la m√™me, mais le d√©calage est ajust√©.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a trois pr√©visions sur le graphique pour trois semaines avant le 8 mai, par rapport au RPS r√©el du mercredi 8 mai. Vous pouvez voir que les deux pr√©visions sont tr√®s pr√©cises, mais les pr√©visions pour la semaine du 1er mai restent inexactes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
De plus, nous n'avons pas besoin de trois pr√©visions, nous avons besoin d'une seule pr√©vision. La valeur moyenne n'est pas une option, car elle sera floue par nos donn√©es RPS d√©form√©es du 1er mai. Au lieu de cela, vous devez calculer la m√©diane. Prom√©th√©e n'a pas de requ√™te m√©diane, mais nous pouvons utiliser l'agr√©gation quantile au lieu de la m√©diane. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le seul probl√®me est que nous essayons d'inclure trois s√©ries dans l'agr√©gation, et ces trois s√©ries sont en fait la m√™me s√©rie en trois semaines. En d'autres termes, ils ont les m√™mes √©tiquettes, il est donc difficile de les assembler.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour √©viter toute confusion, nous cr√©ons une √©tiquette appel√©e d√©calage et utilisons la fonction de remplacement d'√©tiquette pour ajouter un d√©calage √† chacune des trois semaines. </font><font style="vertical-align: inherit;">Ensuite, dans l'agr√©gation quantile, nous rejetons ces √©tiquettes, ce qui nous donne une moyenne de trois.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nos pr√©visions avec une m√©diane de trois agr√©gations sont devenues plus pr√©cises.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©vision m√©diane par rapport au RPS r√©el</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment savoir si nos pr√©visions sont vraiment pr√©cises</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour v√©rifier l'exactitude des pr√©visions, nous pouvons revenir au z-score. </font><font style="vertical-align: inherit;">Il est utilis√© pour mesurer l'√©cart de l'√©chantillon avec sa pr√©vision en √©carts-types. </font><font style="vertical-align: inherit;">Plus l'√©cart-type est important par rapport √† la pr√©vision, plus la probabilit√© qu'une valeur particuli√®re soit une valeur aberrante est √©lev√©e.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La plage d'√©cart projet√©e est de +1,5 √† -1,5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous pouvez modifier notre graphique Grafana pour utiliser une pr√©vision saisonni√®re, plut√¥t qu'une moyenne mobile hebdomadaire. </font><font style="vertical-align: inherit;">La plage de valeurs normales pour une heure sp√©cifique de la journ√©e est ombr√©e en vert. </font><font style="vertical-align: inherit;">Tout ce qui d√©passe la zone verte est consid√©r√© comme une valeur aberrante. </font><font style="vertical-align: inherit;">Dans ce cas, la valeur aberrante s'est produite dimanche apr√®s-midi, lorsque notre fournisseur de cloud a eu des probl√®mes de r√©seau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est recommand√© d'utiliser un score z ¬± 2 pour les pr√©visions saisonni√®res.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment configurer des alertes avec Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez configurer une alerte pour les √©v√©nements anormaux, vous pouvez appliquer la r√®gle assez simple de Prom√©th√©e, qui v√©rifie si le score z d'un indicateur est compris entre +2 et -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans GitLab, nous utilisons une r√®gle de routage personnalis√©e qui envoie une alerte via Slack lorsqu'il d√©tecte des anomalies, mais ne contacte pas notre √©quipe d'assistance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment d√©tecter les anomalies dans GitLab en utilisant Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prom√©th√©e peut √™tre utilis√© pour d√©tecter certaines anomalies.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une bonne agr√©gation est la cl√© pour trouver des anomalies.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le score Z est efficace si vos donn√©es ont une distribution normale.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La saisonnalit√© statistique est un puissant m√©canisme de d√©tection des anomalies.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduit avec le support de </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toujours utile</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©thodes de mise en cache simples dans GitLab CI: un guide d'images</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils GitLab CE pr√™ts √† l'emploi et personnalis√©s sur le march√© MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre cha√Æne Telegram sur la transformation num√©rique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499014/index.html">23 questions difficiles pour les interviews JavaScript</a></li>
<li><a href="../fr499016/index.html">Int√©gration avec ESIA pour .Net: plus simple qu'il n'y para√Æt</a></li>
<li><a href="../fr499018/index.html">6 applications de sport √† domicile</a></li>
<li><a href="../fr499020/index.html">Une √©tude d'un comportement vague</a></li>
<li><a href="../fr499030/index.html">Surveillance des performances de MySQL pour Grafana sur isic en 20 minutes</a></li>
<li><a href="../fr499034/index.html">Comment d√©ployer un refactoring dangereux pour produire avec un million d'utilisateurs?</a></li>
<li><a href="../fr499036/index.html">Travail du prestataire: une s√©lection de supports sur les protocoles, les infrastructures informatiques et r√©seau</a></li>
<li><a href="../fr499038/index.html">Mon exp√©rience avec un moniteur vertical</a></li>
<li><a href="../fr499040/index.html">Lire le week-end: une s√©lection de documents sur l'histoire du DNS, de la r√©glementation informatique et du mat√©riel 1cloud.ru</a></li>
<li><a href="../fr499044/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>