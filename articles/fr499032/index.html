<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍⚖️ 👩🏽 🍺 Comment utiliser Prometheus pour détecter des anomalies dans GitLab 🌗 👩🏿‍🔧 🌭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'une des caractéristiques de base du langage de requête Prometheus est l' agrégation en temps réel des séries chronologiques . Vous pouvez également ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment utiliser Prometheus pour détecter des anomalies dans GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des caractéristiques de base du langage de requête Prometheus est </font><font style="vertical-align: inherit;">l' </font><font style="vertical-align: inherit;">agrégation en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps réel des séries chronologiques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous pouvez également utiliser le langage de requête Prometheus pour détecter les anomalies dans les données de séries chronologiques.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'équipe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduit </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">un article de l'ingénieur de l'équipe d'infrastructure GitLab</font></a><font style="vertical-align: inherit;"> , où vous trouverez des exemples de code que vous pouvez essayer sur vos systèmes.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi sert la détection des anomalies?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe quatre raisons principales qui déterminent l'importance de la détection d'anomalies pour GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagnostic des incidents</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : nous pouvons détecter les services qui ont dépassé leur portée normale en réduisant le temps de détection des incidents (MTTD) et, en conséquence, offrir une solution plus rapide au problème.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Détection de la dégradation des performances</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : par exemple, si une régression est introduite dans un service qui lui fait accéder trop souvent à un autre service, nous pouvons rapidement détecter et résoudre ce problème.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Détection et élimination des abus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab fournit des mécanismes de livraison et d'intégration ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et d'hébergement (GitLab Pages) et un nombre limité d'utilisateurs qui peuvent utiliser ces mécanismes.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sécurité</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la détection des anomalies est importante pour détecter les tendances inhabituelles dans la série chronologique GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ces raisons et d'autres, l'auteur de l'article a décidé de comprendre comment configurer la définition des anomalies dans la série temporelle GitLab à l'aide des requêtes et des règles de Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quel est le niveau d'agrégation correct?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, les séries chronologiques doivent être correctement agrégées. </font><font style="vertical-align: inherit;">Dans l'exemple ci-dessous, nous avons utilisé le compteur http_requests_total standard pour récupérer des données, bien que de nombreuses autres mesures le fassent également.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette mesure de test comporte plusieurs paramètres: méthode, contrôleur, code d'état (code_état), environnement, ainsi que des paramètres ajoutés par Prometheus lui-même, par exemple, travail et instance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant choisir le bon niveau d'agrégation de données. </font><font style="vertical-align: inherit;">Trop, trop peu - tout cela est important pour détecter les anomalies. </font><font style="vertical-align: inherit;">Si les données sont trop agrégées, il y a deux problèmes potentiels:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez ignorer l'anomalie car l'agrégation masque les problèmes qui se produisent dans des sous-ensembles de vos données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous trouvez une anomalie, il est difficile de la relier à une partie distincte de votre système sans effort supplémentaire.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les données ne sont pas suffisamment agrégées, cela peut conduire à une augmentation du nombre de faux positifs, ainsi qu'à une interprétation incorrecte des données valides comme erronées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après notre expérience, le niveau d'agrégation le plus correct est le niveau de service, c'est-à-dire que nous incluons l'étiquette de travail (travail) et d'environnement (environnement) et rejetons toutes les autres étiquettes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'agrégation, dont nous parlerons tout au long de l'article, comprend: travail - http_request, agrégation - cinq minutes, qui est calculé sur la base du travail et de l'environnement en cinq minutes.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après l'exemple ci-dessus, il est clair que dans la série http_requests_total, les sous-ensembles sont sélectionnés dans le contexte du travail et de l'environnement, puis leur nombre est considéré pendant cinq minutes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation du score Z pour détecter les anomalies</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les principes de base des statistiques peuvent être appliqués pour détecter des anomalies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous connaissez la moyenne et l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">écart type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la série Prometheus, vous pouvez utiliser n'importe quel échantillon de la série pour calculer le z-score.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un Z-score est une mesure de l'écart relatif de la valeur observée ou mesurée, qui montre combien d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">écarts-types</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son écart par rapport à la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeur moyenne est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le score z = 0 signifie que le score z est identique à la valeur moyenne dans l'ensemble de données avec la distribution standard, et le score z = 1 signifie que l'écart type = 1,0 de la moyenne.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supposons que les données de base ont une distribution normale, ce qui signifie que 99,7% des échantillons ont un score z de 0 à 3. Plus le score z est éloigné de zéro, moins il est probable qu'il existe.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appliquons cette propriété pour détecter les anomalies dans la série de données Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous calculons la moyenne et l'écart type de la métrique à l'aide de données avec un échantillon de grande taille. </font><font style="vertical-align: inherit;">Pour cet exemple, nous utilisons des données hebdomadaires. </font><font style="vertical-align: inherit;">Si nous supposons que les enregistrements sont évalués une fois par minute, alors dans une semaine, nous aurons un peu plus de 10 000 échantillons.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous pouvons calculer le z-score pour la requête Prometheus dès que nous obtenons la moyenne et l'écart-type pour l'agrégation.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base des principes statistiques des distributions normales, supposons que toute valeur en dehors de la plage de +3 à -3 sera une anomalie. </font><font style="vertical-align: inherit;">En conséquence, nous pouvons créer un avertissement concernant de telles anomalies. </font><font style="vertical-align: inherit;">Par exemple, nous recevrons une alerte lorsque notre agrégation dépasse cette plage pendant plus de cinq minutes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphique du nombre de requêtes par seconde au service GitLab Pages pendant 48 heures. </font><font style="vertical-align: inherit;">Le score Z compris entre +3 et -3 est surligné en vert. Le</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
score Z peut être difficile à interpréter sur les graphiques, car cette valeur n'a pas d'unité de mesure. </font><font style="vertical-align: inherit;">Mais les anomalies de ce graphique sont très simples à déterminer. </font><font style="vertical-align: inherit;">Tout ce qui va au-delà de la zone verte, qui montre un couloir de valeurs avec un z-score de -3 à +3, sera une valeur anormale.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que faire si la distribution des données n'est pas normale</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supposons que la distribution des données est normale. </font><font style="vertical-align: inherit;">Sinon, notre z-score sera faux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreuses astuces statistiques pour déterminer la normalité de la distribution des données, mais le meilleur moyen est de vérifier que le score z de vos données se situe dans la plage de -4,0 à +4,0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux requêtes Prometheus montrant les scores z minimum et maximum:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vos résultats sont compris entre -20 et +20, cela signifie que trop de données ont été utilisées et les résultats sont déformés. </font><font style="vertical-align: inherit;">N'oubliez pas également que vous devez travailler avec des lignes agrégées. </font><font style="vertical-align: inherit;">Les mesures qui n'ont pas de distribution normale incluent des paramètres tels que le taux d'erreur, le retard, la longueur des files d'attente, etc. </font><font style="vertical-align: inherit;">Mais bon nombre de ces mesures fonctionneront mieux avec des seuils d'alerte fixes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Détection statistique d'anomalies saisonnières</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que le calcul des scores z fonctionne bien avec la distribution normale des données de séries chronologiques, il existe une deuxième méthode qui peut donner des résultats de détection d'anomalies encore plus précis. </font><font style="vertical-align: inherit;">C'est l'utilisation de la saisonnalité statistique.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La saisonnalité est une caractéristique d'une métrique de série chronologique lorsque cette métrique subit des changements réguliers et prévisibles qui se répètent à chaque cycle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphique des demandes par seconde (RPS) du lundi au dimanche pendant quatre semaines consécutives Le</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
graphique ci-dessus illustre le RPS (nombre de demandes par seconde) pendant sept jours - du lundi au dimanche, pendant quatre semaines consécutives. </font><font style="vertical-align: inherit;">Cette plage de sept jours est appelée «décalage», c'est-à-dire le motif qui sera utilisé pour la mesure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque semaine sur le graphique est d'une couleur différente. </font><font style="vertical-align: inherit;">La saisonnalité des données est indiquée par la séquence des tendances indiquées sur le graphique - chaque lundi matin, nous observons une augmentation similaire du RPS, et le soir, le vendredi, nous observons toujours une diminution du RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant la saisonnalité dans nos données de séries chronologiques, nous pouvons prédire avec plus de précision l'occurrence des anomalies et leur détection.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment utiliser la saisonnalité</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prométhée utilise plusieurs mécanismes statistiques différents pour calculer la saisonnalité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous faisons un calcul, en ajoutant une tendance de croissance pour la semaine aux résultats de la semaine précédente. La tendance de croissance est calculée comme suit: soustrayez la moyenne mobile de la semaine dernière de la moyenne mobile de la semaine dernière.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première itération s'avère quelque peu «étroite» - nous utilisons la fenêtre de cinq minutes de cette semaine et de la semaine précédente pour obtenir nos prévisions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la deuxième itération, nous élargissons notre couverture en prenant la moyenne de la période de quatre heures pour la semaine précédente et en la comparant avec la semaine en cours.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, si nous essayons de prédire la valeur métrique à huit heures du matin le lundi, au lieu de la même fenêtre de cinq minutes la semaine précédente, nous prenons la valeur moyenne de la mesure de six à dix le matin du lundi précédent.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La demande indiquait 166 heures, soit deux heures de moins qu'une semaine complète (7 * 24 = 168), car nous voulons utiliser une période de quatre heures en fonction de l'heure actuelle, nous avons donc besoin que le décalage soit de deux heures inférieur à une semaine complète.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS réel (jaune) et prévu (bleu) dans deux semaines</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Une comparaison du RPS réel avec nos prévisions montre que nos calculs étaient assez précis. Cependant, cette méthode présente un inconvénient. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le 1er mai, GitLab a été utilisé moins que d'habitude le mercredi, car ce jour était un jour de congé. Étant donné que la tendance de croissance estimée dépend de la façon dont le système a été utilisé la semaine précédente, nos prévisions pour la semaine prochaine, c'est-à-dire le mercredi 8 mai, ont donné un RPS inférieur à la réalité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette erreur peut être corrigée en faisant trois prévisions pour trois semaines consécutives avant le mercredi 1er mai, c'est-à-dire les trois mercredi précédent. La demande reste la même, mais le décalage est ajusté.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a trois prévisions sur le graphique pour trois semaines avant le 8 mai, par rapport au RPS réel du mercredi 8 mai. Vous pouvez voir que les deux prévisions sont très précises, mais les prévisions pour la semaine du 1er mai restent inexactes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
De plus, nous n'avons pas besoin de trois prévisions, nous avons besoin d'une seule prévision. La valeur moyenne n'est pas une option, car elle sera floue par nos données RPS déformées du 1er mai. Au lieu de cela, vous devez calculer la médiane. Prométhée n'a pas de requête médiane, mais nous pouvons utiliser l'agrégation quantile au lieu de la médiane. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le seul problème est que nous essayons d'inclure trois séries dans l'agrégation, et ces trois séries sont en fait la même série en trois semaines. En d'autres termes, ils ont les mêmes étiquettes, il est donc difficile de les assembler.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour éviter toute confusion, nous créons une étiquette appelée décalage et utilisons la fonction de remplacement d'étiquette pour ajouter un décalage à chacune des trois semaines. </font><font style="vertical-align: inherit;">Ensuite, dans l'agrégation quantile, nous rejetons ces étiquettes, ce qui nous donne une moyenne de trois.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nos prévisions avec une médiane de trois agrégations sont devenues plus précises.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prévision médiane par rapport au RPS réel</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment savoir si nos prévisions sont vraiment précises</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérifier l'exactitude des prévisions, nous pouvons revenir au z-score. </font><font style="vertical-align: inherit;">Il est utilisé pour mesurer l'écart de l'échantillon avec sa prévision en écarts-types. </font><font style="vertical-align: inherit;">Plus l'écart-type est important par rapport à la prévision, plus la probabilité qu'une valeur particulière soit une valeur aberrante est élevée.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La plage d'écart projetée est de +1,5 à -1,5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous pouvez modifier notre graphique Grafana pour utiliser une prévision saisonnière, plutôt qu'une moyenne mobile hebdomadaire. </font><font style="vertical-align: inherit;">La plage de valeurs normales pour une heure spécifique de la journée est ombrée en vert. </font><font style="vertical-align: inherit;">Tout ce qui dépasse la zone verte est considéré comme une valeur aberrante. </font><font style="vertical-align: inherit;">Dans ce cas, la valeur aberrante s'est produite dimanche après-midi, lorsque notre fournisseur de cloud a eu des problèmes de réseau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est recommandé d'utiliser un score z ± 2 pour les prévisions saisonnières.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment configurer des alertes avec Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez configurer une alerte pour les événements anormaux, vous pouvez appliquer la règle assez simple de Prométhée, qui vérifie si le score z d'un indicateur est compris entre +2 et -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans GitLab, nous utilisons une règle de routage personnalisée qui envoie une alerte via Slack lorsqu'il détecte des anomalies, mais ne contacte pas notre équipe d'assistance.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment détecter les anomalies dans GitLab en utilisant Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prométhée peut être utilisé pour détecter certaines anomalies.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une bonne agrégation est la clé pour trouver des anomalies.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le score Z est efficace si vos données ont une distribution normale.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La saisonnalité statistique est un puissant mécanisme de détection des anomalies.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduit avec le support de </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toujours utile</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthodes de mise en cache simples dans GitLab CI: un guide d'images</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils GitLab CE prêts à l'emploi et personnalisés sur le marché MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre chaîne Telegram sur la transformation numérique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499014/index.html">23 questions difficiles pour les interviews JavaScript</a></li>
<li><a href="../fr499016/index.html">Intégration avec ESIA pour .Net: plus simple qu'il n'y paraît</a></li>
<li><a href="../fr499018/index.html">6 applications de sport à domicile</a></li>
<li><a href="../fr499020/index.html">Une étude d'un comportement vague</a></li>
<li><a href="../fr499030/index.html">Surveillance des performances de MySQL pour Grafana sur isic en 20 minutes</a></li>
<li><a href="../fr499034/index.html">Comment déployer un refactoring dangereux pour produire avec un million d'utilisateurs?</a></li>
<li><a href="../fr499036/index.html">Travail du prestataire: une sélection de supports sur les protocoles, les infrastructures informatiques et réseau</a></li>
<li><a href="../fr499038/index.html">Mon expérience avec un moniteur vertical</a></li>
<li><a href="../fr499040/index.html">Lire le week-end: une sélection de documents sur l'histoire du DNS, de la réglementation informatique et du matériel 1cloud.ru</a></li>
<li><a href="../fr499044/index.html">Nouvelles du monde d'OpenStreetMap n ° 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>