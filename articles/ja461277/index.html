<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥣 😃 🧑🏻‍🤝‍🧑🏻 無料のSQLIndexManagerツールの概要 🍈 🚐 🌏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ご存知のように、インデックスはDBMSで重要な役割を果たし、必要なレコードをすばやく検索します。したがって、タイムリーにサービスを提供することが非常に重要です。分析と最適化については、インターネットを含め、非常に多くの資料が書かれています。たとえば、この出版物におけるこのトピックの最近のレビューが行...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>無料のSQLIndexManagerツールの概要</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461277/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご存知のように、インデックスはDBMSで重要な役割を果たし、必要なレコードをすばやく検索します。</font><font style="vertical-align: inherit;">したがって、タイムリーにサービスを提供することが非常に重要です。</font><font style="vertical-align: inherit;">分析と最適化については、インターネットを含め、非常に多くの資料が書かれています。</font><font style="vertical-align: inherit;">たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この出版物</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">におけるこのトピックの最近のレビュー</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が行われました</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これには有料と無料の両方のソリューションがあります。</font><font style="vertical-align: inherit;">たとえば</font><font style="vertical-align: inherit;">、適応インデックス最適化手法に基づく</font><font style="vertical-align: inherit;">ターンキー</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、以下</font><font style="vertical-align: inherit;">によって作成され</font><font style="vertical-align: inherit;">た無料の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLIndexManager</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティを考えます</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アラン・デントン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLIndexManagerと他の多くの類似物との主な技術的な違いは、作者自身が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作ったもの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ記事で、プロジェクトとこのソフトウェアソリューションを使用する可能性について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このユーティリティについて</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">議論して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間の経過とともに、ほとんどのコメントとバグが修正されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、SQLIndexManagerユーティリティ自体に移りましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションはVisual Studio 2017のC＃.NET Framework 4.5で記述されており、フォームにDevExpressを使用</font><font style="vertical-align: inherit;">
します。次のようになります。</font><font style="vertical-align: inherit;">
すべてのリクエストは次のファイルで生成されます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/i0/wo/do/i0wodozvszemgmmash24snfzrgk.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/xc/mf/ac/xcmfacmb7wxiz5pfvg5m2ybyet4.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリエンジン</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ServerInfo</font></font></li>
</ol><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/ya/ox/fo/yaoxfojk1yhfujv5nhu8wxfjx64.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースに接続してDBMSにリクエストを送信すると、アプリケーションは次のように署名されます。</font></font><br>
<br>
<pre><code class="1c hljs">ApplicationName=”SQLIndexManager”</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動すると、接続を追加するためのモーダルウィンドウが開きます。</font><font style="vertical-align: inherit;">
ここでは、ローカルネットワーク経由で利用できるMS SQL Serverのすべてのインスタンスの完全なリストのロードはここでは機能しません。</font><font style="vertical-align: inherit;">
メインメニューの左端のボタンを使用して接続を追加することもできます。</font><font style="vertical-align: inherit;">
次に、次のDBMSクエリが起動されます。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/77/kw/uh/77kwuhjmxnartbvfvmpnk8fpi7k.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/id/l0/w_/idl0w_a4afakmyqmegzbrbomksc.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBMS情報の取得</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> ProductLevel  = SERVERPROPERTY(<span class="hljs-string">'ProductLevel'</span>)<font></font>
     , <span class="hljs-keyword">Edition</span>       = SERVERPROPERTY(<span class="hljs-string">'Edition'</span>)<font></font>
     , ServerVersion = SERVERPROPERTY(<span class="hljs-string">'ProductVersion'</span>)<font></font>
     , IsSysAdmin    = <span class="hljs-keyword">CAST</span>(IS_SRVROLEMEMBER(<span class="hljs-string">'sysadmin'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIT</span>)
</code></pre><br>
</div></div></li>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能なデータベースとその簡単なプロパティのリストを取得する</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> DatabaseName = t.[<span class="hljs-keyword">name</span>]<font></font>
     , d.DataSize<font></font>
     , DataUsedSize  = <span class="hljs-keyword">CAST</span>(<span class="hljs-literal">NULL</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIGINT</span>)<font></font>
     , d.LogSize<font></font>
     , LogUsedSize   = <span class="hljs-keyword">CAST</span>(<span class="hljs-literal">NULL</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIGINT</span>)<font></font>
     , RecoveryModel = t.recovery_model_desc<font></font>
     , LogReuseWait  = t.log_reuse_wait_desc<font></font>
<span class="hljs-keyword">FROM</span> sys.databases t <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> [database_id]<font></font>
         , DataSize = <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> [<span class="hljs-keyword">type</span>] = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">CAST</span>(<span class="hljs-keyword">size</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIGINT</span>) <span class="hljs-keyword">END</span>)<font></font>
         , LogSize  = <span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> [<span class="hljs-keyword">type</span>] = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-keyword">CAST</span>(<span class="hljs-keyword">size</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIGINT</span>) <span class="hljs-keyword">END</span>)
    <span class="hljs-keyword">FROM</span> sys.master_files <span class="hljs-keyword">WITH</span>(NOLOCK)
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> [database_id]<font></font>
) d <span class="hljs-keyword">ON</span> d.[database_id] = t.[database_id]
<span class="hljs-keyword">WHERE</span> t.[state] = <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> t.[database_id] != <span class="hljs-number">2</span>
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">ISNULL</span>(HAS_DBACCESS(t.[<span class="hljs-keyword">name</span>]), <span class="hljs-number">1</span>) = <span class="hljs-number">1</span>
</code></pre><br>
</div></div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のスクリプトを実行すると、MS SQL Serverの選択したインスタンスのデータベースに関する簡単な情報を含むウィンドウ</font><font style="vertical-align: inherit;">
が表示されます。拡張情報は権限に基づいて表示されることに注意してください。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">sysadmin</font></a><font style="vertical-align: inherit;">がある場合は</font><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">sys.master_filesビュー</font></a><font style="vertical-align: inherit;">からデータを選択できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そのような権利がない場合は、リクエストが遅くならないように、返されるデータが少なくなります。</font><font style="vertical-align: inherit;">
ここで、目的のデータベースを選択し、「OK」ボタンをクリックする必要があります。</font><font style="vertical-align: inherit;">
次に、選択したデータベースごとに次のスクリプトを実行して、インデックスのステータスを分析します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/bc/fy/gz/bcfygzsztslx32ll82uxflshfhi.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスステータス分析</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @Fragmentation <span class="hljs-built_in">float</span>=<span class="hljs-number">15</span>;
<span class="hljs-keyword">declare</span> @MinIndexSize <span class="hljs-built_in">bigint</span>=<span class="hljs-number">768</span>;
<span class="hljs-keyword">declare</span> @MaxIndexSize <span class="hljs-built_in">bigint</span>=<span class="hljs-number">1048576</span>;
<span class="hljs-keyword">declare</span> @PreDescribeSize <span class="hljs-built_in">bigint</span>=<span class="hljs-number">32768</span>;<font></font>
<font></font>
<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>
<span class="hljs-keyword">SET</span> ARITHABORT <span class="hljs-keyword">ON</span>
<span class="hljs-keyword">SET</span> NUMERIC_ROUNDABORT <span class="hljs-keyword">OFF</span><font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#AllocationUnits'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#AllocationUnits</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#AllocationUnits (</span>
      ContainerID   <span class="hljs-built_in">BIGINT</span> PRIMARY <span class="hljs-keyword">KEY</span>
    , ReservedPages <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , UsedPages     <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#AllocationUnits (ContainerID, ReservedPages, UsedPages)</span>
<span class="hljs-keyword">SELECT</span> [container_id]<font></font>
     , <span class="hljs-keyword">SUM</span>([total_pages])<font></font>
     , <span class="hljs-keyword">SUM</span>([used_pages])
<span class="hljs-keyword">FROM</span> sys.allocation_units <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> [container_id]
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>([total_pages]) <span class="hljs-keyword">BETWEEN</span> @MinIndexSize <span class="hljs-keyword">AND</span> @MaxIndexSize<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#ExcludeList'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#ExcludeList</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#ExcludeList (ID INT PRIMARY KEY)</span><font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#ExcludeList</span>
<span class="hljs-keyword">SELECT</span> [object_id]
<span class="hljs-keyword">FROM</span> sys.objects <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> [<span class="hljs-keyword">type</span>] <span class="hljs-keyword">IN</span> (<span class="hljs-string">'V'</span>, <span class="hljs-string">'U'</span>)
    <span class="hljs-keyword">AND</span> ( [is_ms_shipped] = <span class="hljs-number">1</span> )<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Partitions'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Partitions</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> [object_id]<font></font>
     , [index_id]<font></font>
     , [partition_id]<font></font>
     , [partition_number]<font></font>
     , [<span class="hljs-keyword">rows</span>]<font></font>
     , [data_compression]<font></font>
<span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Partitions</span>
<span class="hljs-keyword">FROM</span> sys.partitions <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> [object_id] &gt; <span class="hljs-number">255</span>
    <span class="hljs-keyword">AND</span> [<span class="hljs-keyword">rows</span>] &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> [object_id] <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#ExcludeList)</span><font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Indexes'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Indexes</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Indexes (</span>
      ObjectID         <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexID          <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexName        SYSNAME <span class="hljs-literal">NULL</span>
    , PagesCount       <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , UnusedPagesCount <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , PartitionNumber  <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , RowsCount        <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , <span class="hljs-keyword">IndexType</span>        <span class="hljs-built_in">TINYINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsAllowPageLocks <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , DataSpaceID      <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , DataCompression  <span class="hljs-built_in">TINYINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsUnique         <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsPK             <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , FillFactorValue  <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsFiltered       <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, IndexID, PartitionNumber)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Indexes</span>
<span class="hljs-keyword">SELECT</span> ObjectID         = i.[object_id]<font></font>
     , IndexID          = i.index_id<font></font>
     , IndexName        = i.[<span class="hljs-keyword">name</span>]<font></font>
     , PagesCount       = a.ReservedPages<font></font>
     , UnusedPagesCount = <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">ABS</span>(a.ReservedPages - a.UsedPages) &gt; <span class="hljs-number">32</span> <span class="hljs-keyword">THEN</span> a.ReservedPages - a.UsedPages <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span><font></font>
     , PartitionNumber  = p.[partition_number]<font></font>
     , RowsCount        = <span class="hljs-keyword">ISNULL</span>(p.[<span class="hljs-keyword">rows</span>], <span class="hljs-number">0</span>)<font></font>
     , <span class="hljs-keyword">IndexType</span>        = i.[<span class="hljs-keyword">type</span>]<font></font>
     , IsAllowPageLocks = i.[allow_page_locks]<font></font>
     , DataSpaceID      = i.[data_space_id]<font></font>
     , DataCompression  = p.[data_compression]<font></font>
     , IsUnique         = i.[is_unique]<font></font>
     , IsPK             = i.[is_primary_key]<font></font>
     , FillFactorValue  = i.[fill_factor]<font></font>
     , IsFiltered       = i.[has_filter]<font></font>
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">#AllocationUnits a</span>
<span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Partitions p ON a.ContainerID = p.[partition_id]</span>
<span class="hljs-keyword">JOIN</span> sys.indexes i <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> i.[object_id] = p.[object_id] <span class="hljs-keyword">AND</span> p.[index_id] = i.[index_id] 
<span class="hljs-keyword">WHERE</span> i.[<span class="hljs-keyword">type</span>] <span class="hljs-keyword">IN</span> (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    <span class="hljs-keyword">AND</span> i.[object_id] &gt; <span class="hljs-number">255</span><font></font>
<font></font>
<span class="hljs-keyword">DECLARE</span> @files <span class="hljs-keyword">TABLE</span> (<span class="hljs-keyword">ID</span> <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> @files
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> [data_space_id]
<span class="hljs-keyword">FROM</span> sys.database_files <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> [state] != <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> [<span class="hljs-keyword">type</span>] = <span class="hljs-number">0</span><font></font>
<font></font>
<span class="hljs-keyword">IF</span> @@ROWCOUNT &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">BEGIN</span><font></font>
<font></font>
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> i
    <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes i</span>
    <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> sys.destination_data_spaces dds <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> i.DataSpaceID = dds.[partition_scheme_id] <span class="hljs-keyword">AND</span> i.PartitionNumber = dds.[destination_id]
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">ISNULL</span>(dds.[data_space_id], i.DataSpaceID) <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> @files)<font></font>
<font></font>
<span class="hljs-keyword">END</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">DECLARE</span> @DBID   <span class="hljs-built_in">INT</span><font></font>
      , @DBNAME SYSNAME<font></font>
<font></font>
<span class="hljs-keyword">SET</span> @DBNAME = DB_NAME()
<span class="hljs-keyword">SELECT</span> @DBID = [database_id]
<span class="hljs-keyword">FROM</span> sys.databases <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> [<span class="hljs-keyword">name</span>] = @DBNAME<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Fragmentation'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Fragmentation</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Fragmentation (</span>
      ObjectID         <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexID          <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , PartitionNumber  <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , Fragmentation    <span class="hljs-built_in">FLOAT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, IndexID, PartitionNumber)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Fragmentation (ObjectID, IndexID, PartitionNumber, Fragmentation)</span>
<span class="hljs-keyword">SELECT</span> i.ObjectID<font></font>
     , i.IndexID<font></font>
     , i.PartitionNumber<font></font>
     , r.[avg_fragmentation_in_percent]<font></font>
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes i</span>
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">APPLY</span> sys.dm_db_index_physical_stats(@DBID, i.ObjectID, i.IndexID, i.PartitionNumber, <span class="hljs-string">'LIMITED'</span>) r
<span class="hljs-keyword">WHERE</span> i.PagesCount &lt;= @PreDescribeSize
    <span class="hljs-keyword">AND</span> r.[index_level] = <span class="hljs-number">0</span>
    <span class="hljs-keyword">AND</span> r.[alloc_unit_type_desc] = <span class="hljs-string">'IN_ROW_DATA'</span>
    <span class="hljs-keyword">AND</span> i.IndexType <span class="hljs-keyword">IN</span> (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Columns'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Columns</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Columns (</span>
      ObjectID     <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , ColumnID     <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , ColumnName   SYSNAME <span class="hljs-literal">NULL</span>
    , SystemTypeID <span class="hljs-built_in">TINYINT</span> <span class="hljs-literal">NULL</span>
    , IsSparse     <span class="hljs-built_in">BIT</span>
    , IsColumnSet  <span class="hljs-built_in">BIT</span>
    , <span class="hljs-keyword">MaxLen</span>       <span class="hljs-built_in">INT</span>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, ColumnID)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Columns</span>
<span class="hljs-keyword">SELECT</span> ObjectID     = [object_id]<font></font>
     , ColumnID     = [column_id]<font></font>
     , ColumnName   = [<span class="hljs-keyword">name</span>]<font></font>
     , SystemTypeID = [system_type_id]<font></font>
     , IsSparse     = [is_sparse]<font></font>
     , IsColumnSet  = [is_column_set]<font></font>
     , <span class="hljs-keyword">MaxLen</span>       = [max_length]
<span class="hljs-keyword">FROM</span> sys.columns <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> [object_id] <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> i.ObjectID <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes i)</span><font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#IndexColumns'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#IndexColumns</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#IndexColumns (</span>
      ObjectID   <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexID    <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , OrderID    <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , ColumnID   <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsIncluded <span class="hljs-built_in">BIT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, IndexID, ColumnID)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#IndexColumns</span>
<span class="hljs-keyword">SELECT</span> ObjectID   = [object_id]<font></font>
     , IndexID    = [index_id]<font></font>
     , OrderID    = <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> [is_included_column] = <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> [key_ordinal] <span class="hljs-keyword">ELSE</span> [index_column_id] <span class="hljs-keyword">END</span><font></font>
     , ColumnID   = [column_id]<font></font>
     , IsIncluded = <span class="hljs-keyword">ISNULL</span>([is_included_column], <span class="hljs-number">0</span>)
<span class="hljs-keyword">FROM</span> sys.index_columns ic <span class="hljs-keyword">WITH</span>(NOLOCK)
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span>(
        <span class="hljs-keyword">SELECT</span> *
        <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes i</span>
        <span class="hljs-keyword">WHERE</span> i.ObjectID = ic.[object_id]
            <span class="hljs-keyword">AND</span> i.IndexID = ic.[index_id]
            <span class="hljs-keyword">AND</span> i.IndexType <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<font></font>
    )<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Lob'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Lob</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Lob (</span>
      ObjectID    <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexID     <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IsLobLegacy <span class="hljs-built_in">BIT</span>
    , IsLob       <span class="hljs-built_in">BIT</span>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, IndexID)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Lob (ObjectID, IndexID, IsLobLegacy, IsLob)</span>
<span class="hljs-keyword">SELECT</span> c.ObjectID<font></font>
     , IndexID     = <span class="hljs-keyword">ISNULL</span>(i.IndexID, <span class="hljs-number">1</span>)<font></font>
     , IsLobLegacy = <span class="hljs-keyword">MAX</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> c.SystemTypeID <span class="hljs-keyword">IN</span> (<span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">99</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>)<font></font>
     , IsLob       = <span class="hljs-number">0</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Columns c</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#IndexColumns i ON c.ObjectID = i.ObjectID AND c.ColumnID = i.ColumnID</span>
<span class="hljs-keyword">WHERE</span> c.SystemTypeID <span class="hljs-keyword">IN</span> (<span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">99</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c.ObjectID<font></font>
       , i.IndexID<font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#Sparse'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Sparse</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#Sparse (ObjectID INT PRIMARY KEY)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#Sparse</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> ObjectID
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Columns</span>
<span class="hljs-keyword">WHERE</span> IsSparse = <span class="hljs-number">1</span>
    <span class="hljs-keyword">OR</span> IsColumnSet = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-keyword">IF</span> OBJECT_ID(<span class="hljs-string">'tempdb.dbo.#AggColumns'</span>) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#AggColumns</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">#AggColumns (</span>
      ObjectID        <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexID         <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
    , IndexColumns    <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>)<font></font>
    , IncludedColumns <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>)<font></font>
    , PRIMARY <span class="hljs-keyword">KEY</span> (ObjectID, IndexID)<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">#AggColumns</span>
<span class="hljs-keyword">SELECT</span> t.ObjectID<font></font>
     , t.IndexID<font></font>
     , IndexColumns = <span class="hljs-keyword">STUFF</span>((
            <span class="hljs-keyword">SELECT</span> <span class="hljs-string">', ['</span> + c.ColumnName + <span class="hljs-string">']'</span>
            <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#IndexColumns i</span>
            <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Columns c ON i.ObjectID = c.ObjectID AND i.ColumnID = c.ColumnID</span>
            <span class="hljs-keyword">WHERE</span> i.ObjectID = t.ObjectID
                <span class="hljs-keyword">AND</span> i.IndexID = t.IndexID
                <span class="hljs-keyword">AND</span> i.IsIncluded = <span class="hljs-number">0</span>
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> i.OrderID
        <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">XML</span> <span class="hljs-keyword">PATH</span>(<span class="hljs-string">''</span>), <span class="hljs-keyword">TYPE</span>).value(<span class="hljs-string">'(./text())[1]'</span>, <span class="hljs-string">'NVARCHAR(MAX)'</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">''</span>)<font></font>
     , IncludedColumns = <span class="hljs-keyword">STUFF</span>((
            <span class="hljs-keyword">SELECT</span> <span class="hljs-string">', ['</span> + c.ColumnName + <span class="hljs-string">']'</span>
            <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#IndexColumns i</span>
            <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Columns c ON i.ObjectID = c.ObjectID AND i.ColumnID = c.ColumnID</span>
            <span class="hljs-keyword">WHERE</span> i.ObjectID = t.ObjectID
                <span class="hljs-keyword">AND</span> i.IndexID = t.IndexID
                <span class="hljs-keyword">AND</span> i.IsIncluded = <span class="hljs-number">1</span>
            <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> i.OrderID
        <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">XML</span> <span class="hljs-keyword">PATH</span>(<span class="hljs-string">''</span>), <span class="hljs-keyword">TYPE</span>).value(<span class="hljs-string">'(./text())[1]'</span>, <span class="hljs-string">'NVARCHAR(MAX)'</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">''</span>)
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> ObjectID, IndexID
    <span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes</span>
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">IndexType</span> <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<font></font>
) t<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> i.ObjectID<font></font>
     , i.IndexID<font></font>
     , i.IndexName<font></font>
     , ObjectName       = o.[<span class="hljs-keyword">name</span>]<font></font>
     , SchemaName       = s.[<span class="hljs-keyword">name</span>]<font></font>
     , i.PagesCount<font></font>
     , i.UnusedPagesCount<font></font>
     , i.PartitionNumber<font></font>
     , i.RowsCount<font></font>
     , i.IndexType<font></font>
     , i.IsAllowPageLocks<font></font>
     , u.TotalWrites<font></font>
     , u.TotalReads<font></font>
     , u.TotalSeeks<font></font>
     , u.TotalScans<font></font>
     , u.TotalLookups<font></font>
     , u.LastUsage<font></font>
     , i.DataCompression<font></font>
     , f.Fragmentation<font></font>
     , IndexStats       = STATS_DATE(i.ObjectID, i.IndexID)<font></font>
     , IsLobLegacy      = <span class="hljs-keyword">ISNULL</span>(lob.IsLobLegacy, <span class="hljs-number">0</span>)<font></font>
     , IsLob            = <span class="hljs-keyword">ISNULL</span>(lob.IsLob, <span class="hljs-number">0</span>)<font></font>
     , IsSparse         = <span class="hljs-keyword">CAST</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> p.ObjectID <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIT</span>)<font></font>
     , IsPartitioned    = <span class="hljs-keyword">CAST</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> dds.[data_space_id] <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-built_in">BIT</span>)<font></font>
     , FileGroupName    = fg.[<span class="hljs-keyword">name</span>]<font></font>
     , i.IsUnique<font></font>
     , i.IsPK<font></font>
     , i.FillFactorValue<font></font>
     , i.IsFiltered<font></font>
     , a.IndexColumns<font></font>
     , a.IncludedColumns<font></font>
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">#Indexes i</span>
<span class="hljs-keyword">JOIN</span> sys.objects o <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> o.[object_id] = i.ObjectID
<span class="hljs-keyword">JOIN</span> sys.schemas s <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> s.[schema_id] = o.[schema_id]
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#AggColumns a ON a.ObjectID = i.ObjectID AND a.IndexID = i.IndexID</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Sparse p ON p.ObjectID = i.ObjectID</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Fragmentation f ON f.ObjectID = i.ObjectID AND f.IndexID = i.IndexID AND f.PartitionNumber = i.PartitionNumber</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> ObjectID      = [object_id]<font></font>
         , IndexID       = [index_id]<font></font>
         , TotalWrites   = <span class="hljs-keyword">NULLIF</span>([user_updates], <span class="hljs-number">0</span>)<font></font>
         , TotalReads    = <span class="hljs-keyword">NULLIF</span>([user_seeks] + [user_scans] + [user_lookups], <span class="hljs-number">0</span>)<font></font>
         , TotalSeeks    = <span class="hljs-keyword">NULLIF</span>([user_seeks], <span class="hljs-number">0</span>)<font></font>
         , TotalScans    = <span class="hljs-keyword">NULLIF</span>([user_scans], <span class="hljs-number">0</span>)<font></font>
         , TotalLookups  = <span class="hljs-keyword">NULLIF</span>([user_lookups], <span class="hljs-number">0</span>)<font></font>
         , LastUsage     = (<font></font>
                                <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">MAX</span>(dt)
                                <span class="hljs-keyword">FROM</span> (
                                    <span class="hljs-keyword">VALUES</span> ([last_user_seek])<font></font>
                                         , ([last_user_scan])<font></font>
                                         , ([last_user_lookup])<font></font>
                                         , ([last_user_update])<font></font>
                                ) t(dt)<font></font>
                           )<font></font>
    <span class="hljs-keyword">FROM</span> sys.dm_db_index_usage_stats <span class="hljs-keyword">WITH</span>(NOLOCK)
    <span class="hljs-keyword">WHERE</span> [database_id] = @DBID<font></font>
) u <span class="hljs-keyword">ON</span> i.ObjectID = u.ObjectID <span class="hljs-keyword">AND</span> i.IndexID = u.IndexID
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-comment">#Lob lob ON lob.ObjectID = i.ObjectID AND lob.IndexID = i.IndexID</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> sys.destination_data_spaces dds <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> i.DataSpaceID = dds.[partition_scheme_id] <span class="hljs-keyword">AND</span> i.PartitionNumber = dds.[destination_id]
<span class="hljs-keyword">JOIN</span> sys.filegroups fg <span class="hljs-keyword">WITH</span>(NOLOCK) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ISNULL</span>(dds.[data_space_id], i.DataSpaceID) = fg.[data_space_id] 
<span class="hljs-keyword">WHERE</span> o.[<span class="hljs-keyword">type</span>] <span class="hljs-keyword">IN</span> (<span class="hljs-string">'V'</span>, <span class="hljs-string">'U'</span>)
    <span class="hljs-keyword">AND</span> (<font></font>
            f.Fragmentation &gt;= @Fragmentation<font></font>
        <span class="hljs-keyword">OR</span><font></font>
            i.PagesCount &gt; @PreDescribeSize<font></font>
        <span class="hljs-keyword">OR</span>
            i.IndexType <span class="hljs-keyword">IN</span> (<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)<font></font>
    )<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリ自体からわかるように、一時テーブルがよく使用されます。</font><font style="vertical-align: inherit;">これは、再コンパイルが行われないようにするためです。大規模なスキームの場合、テーブル変数を使用した挿入は1つのストリームでのみ可能であるため、データを挿入するときにプランを並列で生成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のスクリプトを実行すると、インデックステーブルを含むウィンドウ</font><font style="vertical-align: inherit;">
が表示されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ここでは、次のような他の詳細情報も表示できます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/yd/rl/oh/ydrlohqwbtggc8n8equratfkkr0.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクション数</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後の呼び出しの日時</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">圧縮</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルグループ</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
など</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
の列自身がカスタマイズすることができます：</font><font style="vertical-align: inherit;">
修正列のセルでは、最適化の間に実行されるアクションを選択することができます。また、スキャンが完了すると、選択した設定に基づいてデフォルトのアクションが選択されます</font><font style="vertical-align: inherit;">
。処理に必要なインデックスを選択する必要</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">あります。</font><font style="vertical-align: inherit;">
メインメニューを使用して、スクリプトを保存できます（同じボタンでインデックスの最適化プロセスを開始します）：</font><font style="vertical-align: inherit;">
異なる形式でテーブルを保存します（同じボタンでインデックスの分析と最適化の詳細設定を開く</font><font style="vertical-align: inherit;">
ことができ</font><font style="vertical-align: inherit;">ます）：</font><font style="vertical-align: inherit;">3番目のボタンをクリックして情報を更新することもできます拡大鏡の横のメインメニューで左。</font><font style="vertical-align: inherit;">
拡大鏡の付いたボタンを使用すると、検討するデータベースを選択できます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/7z/qw/jf/7zqwjfox2zagl5ox0oji648jnta.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/yp/c9/o2/ypc9o2ooiylu7n0pw7zbdo97tbi.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/tt/tu/fn/tttufnve3kmo_siz_d0ahcxfew8.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/tt/8w/gv/tt8wgvpzqx1cl0a1qvkdfxf1ffm.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、完全なヘルプシステムはありません。</font><font style="vertical-align: inherit;">したがって、「？」</font><font style="vertical-align: inherit;">ソフトウェア製品に関する基本情報を含むモーダルウィンドウが表示されるだけです。</font><font style="vertical-align: inherit;">
上記のすべてに加えて、メインメニューに検索バーがあります。</font><font style="vertical-align: inherit;">
インデックス最適化プロセスを開始する</font><font style="vertical-align: inherit;">
と、ウィンドウの下部で実行されたアクションのログを確認できます。</font><font style="vertical-align: inherit;">
詳細な分析と最適化の最適化のウィンドウで、より細かいインデックスを設定できますオプション：</font><b><font style="vertical-align: inherit;">アプリケーションの提案：</font></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/e5/p_/mq/e5p_mqbcsumjihbb3qnwurxyqdk.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/bm/1c/nn/bm1cnnxagvohdo3a4qtprhvpqbe.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/qn/xa/en/qnxaenzm91ifrvoc2l0aipezq5o.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/wc/aq/zs/wcaqzsz72m6dbuwe3bv1fxqm_3k.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/kc/6x/gp/kc6xgpndlhe19ueeehpobprsomc.jpeg"></a><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスだけでなくさまざまな方法で統計を選択的に更新することを可能にします（完全に更新または部分的に）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースだけでなく別のサーバーも選択できるようにします（これは、MS SQL Serverのインスタンスが多数ある場合に非常に便利です）</font></font></li>
<li>         ,     PowerShell,   , , : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">dbatools.io/commands</a></li>
<li>          ,         MS SQL Server    </li>
<li> .2  4            MS SQL Server,    </li>
<li>    (  ,    ,      )</li>
<li>  SQLIndexManager     MS SQL Server,      , ,  : SQLIndexManager for MS SQL Server</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションのすべての部分をGUIから個別のモジュールに削除し、それらを.NET Core 2.1に書き換えます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
執筆時点では、願いの第6条が積極的に開発されており、完全かつ類似の複製の検索という形ですでにサポートがあります。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/zk/bw/d3/zkbwd3hem7xtdtj_5yuqhctasac.jpeg"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出典</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適応インデックス最適化法</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLIndexManagerユーティリティ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLIndexManagerユーティリティの技術的な概要</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLIndexManagerユーティリティに関する議論</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLインデックスマネージャー-SQL ServerおよびAzureでのインデックスメンテナンス用の無料のGUIツール</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Serverインデックスの分析と最適化</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461265/index.html">マイクロコントローラー向けプロジェクトでのオペレーティングシステムの使用の乱用について</a></li>
<li><a href="../ja461267/index.html">チップパッケージング向けの新しいIntelテクノロジー</a></li>
<li><a href="../ja461269/index.html">pwnable.kr 08での問題解決は脚であり、10はシェルショックです。ARMアセンブラ。Bashの脆弱性</a></li>
<li><a href="../ja461271/index.html">2019年にモバイルアプリケーションを宣伝する方法：4つの実用的な方法+便利なツール</a></li>
<li><a href="../ja461273/index.html">貪欲なアプローチとスロットマシン。プログラミング選手権のMLトラックのタスクの分析</a></li>
<li><a href="../ja461279/index.html">GolangとgRPCでシンプルなマイクロサービスを作成し、Dockerを使用してコンテナー化する方法</a></li>
<li><a href="../ja461281/index.html">Red Hat（RHEL / CentOS）7のchroot環境でBIND DNSサーバーをセットアップするためのチュートリアル</a></li>
<li><a href="../ja461283/index.html">ソフトウェアアーキテクチャとシステム設計：全体像とリソースガイド</a></li>
<li><a href="../ja461285/index.html">5つの主要なサンプリングアルゴリズム</a></li>
<li><a href="../ja461287/index.html">ヒューリスティックとミューテーションに基づいた戦術ゲームで巧妙なAIを開発する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>