<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå≠ üßíüèæ üßú Tipps und Tricks von Kubernetes: Anmutige Laufzeitfunktionen zum Herunterfahren in NGINX und PHP-FPM üê• üßëüèæ‚Äçü§ù‚Äçüßëüèª ‚ùÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eine typische Bedingung f√ºr die Implementierung von CI / CD in Kubernetes: Die Anwendung muss in der Lage sein, neue Clientanforderungen nicht mehr zu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tipps und Tricks von Kubernetes: Anmutige Laufzeitfunktionen zum Herunterfahren in NGINX und PHP-FPM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine typische Bedingung f√ºr die Implementierung von CI / CD in Kubernetes: Die Anwendung muss in der Lage sein, neue Clientanforderungen nicht mehr zu akzeptieren, bevor vorhandene angehalten und vor allem erfolgreich abgeschlossen werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ry/ef/karyefzfd99wtpxne9r_o73wies.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch die Einhaltung dieser Bedingung k√∂nnen Sie w√§hrend der Bereitstellung keine Ausfallzeiten erzielen. </font><font style="vertical-align: inherit;">Selbst wenn Sie sehr beliebte Bundles (wie NGINX und PHP-FPM) verwenden, k√∂nnen Schwierigkeiten auftreten, die bei jeder Bereitstellung zu einer Vielzahl von Fehlern f√ºhren ...</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theorie. </font><font style="vertical-align: inherit;">Wie Pod lebt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diesen Artikel bereits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausf√ºhrlich √ºber den Pod-Lebenszyklus ver√∂ffentlicht </font><font style="vertical-align: inherit;">. Im Zusammenhang mit diesem Thema interessiert uns Folgendes: In dem Moment, in dem der Pod in den Status " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beenden"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wechselt, werden keine neuen Anforderungen mehr an ihn gesendet (der Pod </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus der Liste der Endpunkte f√ºr den Dienst entfernt). Um Ausfallzeiten w√§hrend der Bereitstellung zu vermeiden, reicht es unsererseits aus, das Problem des korrekten Stopps der Anwendung zu l√∂sen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sollte auch beachtet werden, dass die Kulanzfrist standardm√§√üig </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 Sekunden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> betr√§gt </font><font style="vertical-align: inherit;">: Danach wird der Pod beendet und die Anwendung sollte es schaffen, alle Anforderungen vor dieser Frist zu verarbeiten. </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Obwohl jede Anforderung, die l√§nger als 5-10 Sekunden ausgef√ºhrt wird, bereits problematisch ist und ein ordnungsgem√§√ües Herunterfahren ihm nicht mehr hilft ...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Um besser zu verstehen, was passiert, wenn der Pod seine Arbeit beendet, reicht es aus, das folgende Schema zu studieren: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/pt/ou/zxptou-qe7zxqgab6pszsdo5vlk.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A1, B1 - √Ñnderungen vornehmen Status von Sub </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A2: Senden von SIGTERM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B2 - Entfernen des Pods von Endpunkten </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B3 - Abrufen von √Ñnderungen (Endpunktliste wurde ge√§ndert) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B4 - Aktualisieren der iptables-Regeln</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hinweis: Das Entfernen des Endpunkt-Pods und das Senden von SIGTERM erfolgt nicht nacheinander, sondern parallel. Aufgrund der Tatsache, dass Ingress nicht sofort eine aktualisierte Liste der Endpunkte erh√§lt, werden neue Anforderungen von Clients an den Pod gesendet, was zu 500 Fehlern beim Beenden des Pods f√ºhrt</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(wir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ºbersetzten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausf√ºhrlichere Material zu diesem Thema </font><font style="vertical-align: inherit;">)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sie m√ºssen dieses Problem auf folgende Weise l√∂sen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Senden Sie die Header der Verbindung: Antwort schlie√üen (wenn es sich um eine HTTP-Anwendung handelt).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn es keine M√∂glichkeit gibt, √Ñnderungen am Code vorzunehmen, beschreibt der Artikel eine L√∂sung, mit der Sie Anforderungen bis zum Ende des Kulanzzeitraums verarbeiten k√∂nnen.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theorie. </font><font style="vertical-align: inherit;">Wie NGINX und PHP-FPM ihre Prozesse beenden</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit NGINX, da damit alles mehr oder weniger offensichtlich ist. </font><font style="vertical-align: inherit;">Eingebettet in die Theorie erfahren wir, dass NGINX einen Master-Prozess und mehrere "Worker" hat - dies sind untergeordnete Prozesse, die Client-Anforderungen verarbeiten. </font><font style="vertical-align: inherit;">Eine praktische Funktion wird bereitgestellt: Verwenden des Befehls zum </font></font><code>nginx -s &lt;SIGNAL&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beenden von Prozessen entweder im Schnellabschaltmodus oder im ordnungsgem√§√üen Herunterfahren. </font><font style="vertical-align: inherit;">Offensichtlich interessieren wir uns genau f√ºr die letztere Option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann ist alles einfach: Sie m√ºssen dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preStop-Hook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Befehl</font></a><font style="vertical-align: inherit;"> hinzuf√ºgen, der </font><font style="vertical-align: inherit;">ein Signal f√ºr ein </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">ordnungsgem√§√ües</font></a><font style="vertical-align: inherit;"> Herunterfahren sendet. </font><font style="vertical-align: inherit;">Dies kann in der Bereitstellung im Containerblock erfolgen:</font></font><br>
<br>
<pre><code class="plaintext hljs">       lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /usr/sbin/nginx<font></font>
              - -s<font></font>
              - quit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dem Moment, in dem der Pod seine Arbeit in den NGINX-Containerprotokollen abgeschlossen hat, sehen wir Folgendes:</font></font><br>
<br>
<pre><code class="plaintext hljs">2018/01/25 13:58:31 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down<font></font>
2018/01/25 13:58:31 [notice] 11#11: gracefully shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und das bedeutet, was wir brauchen: NGINX wartet auf den Abschluss von Abfragen und beendet dann den Prozess. </font><font style="vertical-align: inherit;">Im Folgenden wird jedoch ein h√§ufiges Problem erl√§utert, aufgrund dessen der </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorgang </font><font style="vertical-align: inherit;">selbst bei einem Befehl </font><font style="vertical-align: inherit;">nicht ordnungsgem√§√ü abgeschlossen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und zu diesem Zeitpunkt sind wir mit NGINX fertig: Zumindest k√∂nnen Sie anhand der Protokolle verstehen, dass alles so funktioniert, wie es sollte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist mit PHP-FPM? </font><font style="vertical-align: inherit;">Wie geht es mit dem ordnungsgem√§√üen Herunterfahren um? </font><font style="vertical-align: inherit;">Lass es uns richtig machen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Fall von PHP-FPM etwas weniger Informationen. </font><font style="vertical-align: inherit;">Wenn Sie sich auf das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offizielle Handbuch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu PHP-FPM konzentrieren, werden Sie dar√ºber informiert, dass die folgenden POSIX-Signale empfangen werden:</font></font><br>
<br>
<ol>
<li> <code>SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- schnelles Herunterfahren;</font></font></li>
<li> <code>SIGQUIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - anmutiges Herunterfahren (was wir brauchen).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Rest der Signale in diesem Problem ist nicht erforderlich, daher wird ihre Analyse weggelassen. </font><font style="vertical-align: inherit;">Um den Vorgang korrekt abzuschlie√üen, m√ºssen Sie den folgenden PreStop-Hook schreiben:</font></font><br>
<br>
<pre><code class="plaintext hljs">        lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /bin/kill<font></font>
              - -SIGQUIT<font></font>
              - "1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf den ersten Blick ist dies alles, was erforderlich ist, um in beiden Containern ein ordnungsgem√§√ües Herunterfahren durchzuf√ºhren. </font><font style="vertical-align: inherit;">Die Aufgabe ist jedoch komplizierter als es scheint. </font><font style="vertical-align: inherit;">Als N√§chstes untersuchten wir zwei F√§lle, in denen das ordnungsgem√§√üe Herunterfahren nicht funktionierte und eine kurzfristige Unzug√§nglichkeit des Projekts w√§hrend der Bereitstellung verursachte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trainieren. </font><font style="vertical-align: inherit;">M√∂gliche Probleme beim ordnungsgem√§√üen Herunterfahren</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuallererst ist es n√ºtzlich, sich daran zu erinnern: Neben der Ausf√ºhrung des Befehls </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gibt es noch einen weiteren Schritt, auf den Sie achten sollten. Wir hatten ein Problem, als NGINX anstelle eines SIGQUIT-Signals trotzdem SIGTERM sendete, aufgrund dessen die Anforderungen nicht korrekt abgeschlossen wurden. √Ñhnliche F√§lle finden Sie beispielsweise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Leider konnten wir keinen konkreten Grund f√ºr dieses Verhalten feststellen: Es gab einen Verdacht auf die NGINX-Version, der jedoch nicht best√§tigt wurde. Die Symptomatik war, dass in den Protokollen des NGINX-Containers die Meldungen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"offener Socket Nr. 10 in Verbindung 5"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beobachtet wurden </font><font style="vertical-align: inherit;">, wonach der Pod gestoppt wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir k√∂nnen ein solches Problem beispielsweise anhand der Antworten auf den von uns ben√∂tigten Eingang beobachten: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/sz/ip/umszip1dlpudotn2dstg17qfnzs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statuscode-Anzeigen zum Zeitpunkt der Bereitstellung</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall erhalten wir nur den 503-Fehlercode von Ingress selbst: Er kann nicht auf den NGINX-Container zugreifen, da er nicht mehr verf√ºgbar ist. </font><font style="vertical-align: inherit;">Wenn Sie sich die Protokolle des Containers mit NGINX ansehen, enthalten sie Folgendes:</font></font><br>
<br>
<pre><code class="plaintext hljs">[alert] 13939#0: *154 open socket #3 left in connection 16<font></font>
[alert] 13939#0: *168 open socket #6 left in connection 13</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem √Ñndern des Stoppsignals beginnt der Container korrekt zu stoppen: Dies wird durch die Tatsache best√§tigt, dass ein 503-Fehler nicht mehr beobachtet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie auf ein √§hnliches Problem sto√üen, ist es sinnvoll herauszufinden, welches Stoppsignal im Container verwendet wird und wie der preStop-Hook genau aussieht. </font><font style="vertical-align: inherit;">Es ist m√∂glich, dass der Grund genau darin liegt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM ... und mehr</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem mit PHP-FPM wird trivial beschrieben: Es wartet nicht auf den Abschluss untergeordneter Prozesse, sondern beendet diese, wodurch w√§hrend der Bereitstellung und anderer Vorg√§nge 502 Fehler auftreten. Seit 2005 gab es auf bugs.php.net (zum Beispiel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">mehrere Fehlermeldungen </font><font style="vertical-align: inherit;">, die dieses Problem beschreiben. Aber Sie werden wahrscheinlich nichts in den Protokollen sehen: PHP-FPM wird den Abschluss seines Prozesses ohne Fehler oder Benachrichtigungen von Drittanbietern bekannt geben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sollte klargestellt werden, dass das Problem selbst in geringerem oder gr√∂√üerem Ma√üe von der Anwendung selbst abh√§ngt und beispielsweise nicht bei der √úberwachung auftritt. Wenn Sie immer noch darauf sto√üen, f√§llt Ihnen eine einfache Problemumgehung ein: F√ºgen Sie einen PreStop-Hook mit hinzu</font></font><code>sleep(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Auf diese Weise k√∂nnen Sie alle vorherigen Anforderungen ausf√ºhren (wir akzeptieren keine neuen, da sich der Pod </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bereits</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Status " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beenden" befindet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Nach 30 Sekunden endet der Pod selbst mit einem Signal </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellt sich heraus, dass </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Container folgenderma√üen aussehen wird:</font></font><br>
<br>
<pre><code class="plaintext hljs">    lifecycle:<font></font>
      preStop:<font></font>
        exec:<font></font>
          command:<font></font>
          - /bin/sleep<font></font>
          - "30"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aufgrund der 30-Sekunden-Anzeige </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird </font><font style="vertical-align: inherit;">die Bereitstellungszeit </font><font style="vertical-align: inherit;">jedoch </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erheblich verl√§ngert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da jeder Pod f√ºr </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mindestens</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30 Sekunden beendet wird, was schlecht ist. Was kann man damit machen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenden wir uns an die Partei, die f√ºr die direkte Ausf√ºhrung des Antrags verantwortlich ist. In unserem Fall ist dies </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standardm√§√üig die Ausf√ºhrung seiner untergeordneten Prozesse nicht √ºberwacht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Der Master-Prozess wird sofort beendet. Dieses Verhalten kann mithilfe einer Anweisung ge√§ndert werden </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die Zeitlimits f√ºr das Warten auf Signale vom Master durch untergeordnete Prozesse festlegt. Wenn Sie den Wert auf 20 Sekunden festlegen, werden die meisten im Container ausgef√ºhrten Anforderungen abgedeckt, und nach deren Abschluss wird der Master-Prozess gestoppt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Wissen werden wir zu unserem letzten Problem zur√ºckkehren. Wie bereits erw√§hnt, ist Kubernetes keine monolithische Plattform: Die Interaktion zwischen den verschiedenen Komponenten dauert einige Zeit. Dies gilt insbesondere dann, wenn wir die Arbeit von Ingresss und anderen verwandten Komponenten betrachten, da aufgrund einer solchen Verz√∂gerung zum Zeitpunkt der Bereitstellung leicht 500 Fehler auftreten k√∂nnen. Beispielsweise kann ein Fehler in der Phase des Sendens einer Anforderung an den Upstream auftreten, aber die ‚ÄûZeitverz√∂gerung‚Äú der Interaktion zwischen Komponenten ist eher kurz - weniger als eine Sekunde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher kann </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in Verbindung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit der bereits erw√§hnten Richtlinie </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die folgende Konstruktion verwendet werden f√ºr </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">lifecycle:<font></font>
  preStop:<font></font>
    exec:<font></font>
      command: ["/bin/bash","-c","/bin/sleep 1; kill -QUIT 1"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall kompensieren wir die Verz√∂gerung durch das Team </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und erh√∂hen die Bereitstellungszeit nicht wesentlich: Gibt es einen sp√ºrbaren Unterschied zwischen 30 Sekunden und eins? .. Tats√§chlich wird die ‚ÄûHauptaufgabe‚Äú erledigt </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aber </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Falle einer Verz√∂gerung nur als ‚ÄûSicherheitsnetz‚Äú verwendet. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">betreffen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> das </font><b><font style="vertical-align: inherit;">beschriebene Verhalten und die entsprechende Problemumgehung nicht nur PHP-FPM</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Eine √§hnliche Situation kann auf die eine oder andere Weise auftreten, wenn andere Sprachen / Frameworks verwendet werden. </font><font style="vertical-align: inherit;">Wenn Sie das ordnungsgem√§√üe Herunterfahren nicht auf andere Weise beheben k√∂nnen, z. B. den Code neu schreiben, damit die Anwendung die Abschlusssignale korrekt verarbeitet, k√∂nnen Sie die beschriebene Methode verwenden. </font><font style="vertical-align: inherit;">Es ist vielleicht nicht das Sch√∂nste, aber es funktioniert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trainieren. </font><font style="vertical-align: inherit;">Laden Sie Tests, um die Pod-Leistung zu √ºberpr√ºfen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lasttests sind eine M√∂glichkeit, die Funktionsweise des Containers zu √ºberpr√ºfen, da Sie mit diesem Verfahren den tats√§chlichen Kampfbedingungen n√§her kommen, wenn Benutzer die Site besuchen. Sie k√∂nnen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank verwenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um die oben genannten Empfehlungen zu testen </font><font style="vertical-align: inherit;">: Es deckt alle unsere Anforderungen perfekt ab. Das Folgende sind Tipps und Tricks zum Testen mit einem klaren - dank der Grafiken von Grafana und Yandex.Tank selbst - ein Beispiel aus unserer Erfahrung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Wichtigste dabei ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, stufenweise nach √Ñnderungen zu suchen.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. F√ºhren Sie nach dem Hinzuf√ºgen eines neuen Fixes den Test aus und pr√ºfen Sie, ob sich die Ergebnisse im Vergleich zum vorherigen Start ge√§ndert haben. Andernfalls ist es schwierig, ineffektive L√∂sungen zu identifizieren, und in Zukunft k√∂nnen Sie nur noch Schaden anrichten (z. B. die Bereitstellungszeit verl√§ngern). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine weitere Einschr√§nkung: Sehen Sie sich die Protokolle des Containers w√§hrend seiner Beendigung an. Werden dort ordnungsgem√§√üe Informationen zum Herunterfahren aufgezeichnet? Gibt es Fehler in den Protokollen beim Zugriff auf andere Ressourcen (z. B. einen benachbarten PHP-FPM-Container)? Fehler der Anwendung selbst (wie im oben beschriebenen Fall von NGINX)? Ich hoffe, dass die einleitenden Informationen aus diesem Artikel dazu beitragen, besser zu verstehen, was mit dem Container w√§hrend seiner Beendigung passiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Testlauf fand also ohne </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und ohne zus√§tzliche Anweisungen f√ºr den Anwendungsserver statt (</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in PHP-FPM). Der Zweck dieses Tests war es, die ungef√§hre Anzahl von Fehlern zu identifizieren (und ob sie √ºberhaupt existieren). Aus zus√§tzlichen Informationen sollte auch bekannt sein, dass die durchschnittliche Bereitstellungszeit jedes Herdes etwa 5 bis 10 Sekunden bis zum Zustand der vollst√§ndigen Bereitschaft betrug. Die Ergebnisse lauten wie folgt: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/yw/ap/ceywapg8q2kpztr-zdslhjy8brm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Yandex.Tank-Informationsfenster, das zum Zeitpunkt der Bereitstellung auftrat und durchschnittlich bis zu 5 Sekunden dauerte, ist ein Spritzer von 502 Fehlern sichtbar. Vermutlich wurden dadurch die vorhandenen Anforderungen an den alten Pod beendet, als dieser beendet wurde. Danach traten 503 Fehler auf, die das Ergebnis eines gestoppten NGINX-Containers waren, der ebenfalls aufgrund des Backends getrennt wurde (aufgrund dessen Ingress keine Verbindung herstellen konnte). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen wie</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in PHP-FPM hilft uns, auf den Abschluss untergeordneter Prozesse zu warten, d. h. </font><font style="vertical-align: inherit;">Beheben Sie solche Fehler. </font><font style="vertical-align: inherit;">Wiederholte Bereitstellung mit dieser Anweisung: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/8g/0c/t58g0cs5b6umhjkmvlhjktbkio0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
W√§hrend der Bereitstellung der 500er treten keine Fehler mehr auf! </font><font style="vertical-align: inherit;">Die Bereitstellung ist erfolgreich, das ordnungsgem√§√üe Herunterfahren funktioniert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es lohnt sich jedoch, sich an den Moment mit Ingress-Containern zu erinnern, einem kleinen Prozentsatz von Fehlern, die aufgrund einer Zeitverz√∂gerung auftreten k√∂nnen. </font><font style="vertical-align: inherit;">Um sie zu vermeiden, m√ºssen Sie die Konstruktion hinzuf√ºgen </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Bereitstellung wiederholen. </font><font style="vertical-align: inherit;">In unserem speziellen Fall waren jedoch keine √Ñnderungen sichtbar (wieder keine Fehler).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr den korrekten Abschluss des Prozesses erwarten wir von der Anwendung das folgende Verhalten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warten Sie einige Sekunden und akzeptieren Sie dann keine neuen Verbindungen mehr.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warten Sie, bis alle Anforderungen abgeschlossen sind, und schlie√üen Sie alle Keepalive-Verbindungen, die keine Anforderungen ausf√ºhren.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schlie√üen Sie Ihren Prozess ab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es k√∂nnen jedoch nicht alle Anwendungen auf diese Weise funktionieren. </font><font style="vertical-align: inherit;">Eine L√∂sung f√ºr das Problem in der Realit√§t von Kubernetes ist:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hinzuf√ºgen eines Pre-Stop-Hakens, der einige Sekunden wartet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Studieren Sie die Konfigurationsdatei unseres Backends auf die relevanten Parameter.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das NGINX-Beispiel l√§sst uns verstehen, dass selbst eine Anwendung, die Signale zum Abschluss zun√§chst korrekt verarbeiten muss, dies m√∂glicherweise nicht tut. Daher ist es wichtig, w√§hrend der Bereitstellung der Anwendung auf 500 Fehler zu pr√ºfen. Au√üerdem k√∂nnen Sie das Problem umfassender betrachten und sich nicht auf einen separaten Pod oder Container konzentrieren, sondern die gesamte Infrastruktur als Ganzes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Tank kann als Testwerkzeug in Verbindung mit jedem √úberwachungssystem verwendet werden (in unserem Fall wurden Daten von Grafana mit einem Backend in Form von Prometheus f√ºr den Test verwendet). Probleme mit dem ordnungsgem√§√üen Herunterfahren sind unter schweren Lasten, die der Benchmark erzeugen kann, deutlich sichtbar, und die √úberwachung hilft, die Situation w√§hrend oder nach dem Test genauer zu analysieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antwort auf das Feedback zum Artikel: Es ist erw√§hnenswert, dass die Probleme und L√∂sungen hier in Bezug auf NGINX Ingress beschrieben werden. </font><font style="vertical-align: inherit;">F√ºr andere F√§lle gibt es andere L√∂sungen, die wir m√∂glicherweise in den folgenden Materialien des Zyklus ber√ºcksichtigen werden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andere aus dem K8s Tipps &amp; Tricks-Zyklus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalisierte Fehlerseiten in NGINX Ingress</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úber die Zuweisung von Knoten und die Belastung der Webanwendung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zugang zu Dev-Sites</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beschleunigen Sie den Bootstrap gro√üer Datenbanken.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de489984/index.html">AMA √ºber udalenka: fragen - wir antworten</a></li>
<li><a href="../de489986/index.html">Power Stage Designer-Dienstprogramm - Power Electronics Developer Tool</a></li>
<li><a href="../de489988/index.html">"Legen Sie Ihre H√§nde in die Luft!": Ein Mono-Review der Playme TIO S Dashcam</a></li>
<li><a href="../de489990/index.html">Wie hat Service Desk eine Servicefirma gerettet oder was ist, wenn Ihr Unternehmen w√§chst?</a></li>
<li><a href="../de489992/index.html">Korrigieren Sie das Herunterfahren des Pods im Kubernetes-Cluster</a></li>
<li><a href="../de489998/index.html">11. Fortinet Erste Schritte v6.0. Lizenzierung</a></li>
<li><a href="../de490002/index.html">Wie man GraphQL auf Kotlin und Micronaut erstellt und einen einzigen Zugriffspunkt auf die API mehrerer Mikrodienste erstellt</a></li>
<li><a href="../de490006/index.html">Ausbildungsprogramm f√ºr technische Spezifikationen</a></li>
<li><a href="../de490010/index.html">Pr√ºfung des Typensystems zur √úberpr√ºfung der Richtigkeit von Musik</a></li>
<li><a href="../de490012/index.html">Warnungen und Speicherfehler, wie geht man damit um?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>