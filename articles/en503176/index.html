<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõ üõèÔ∏è üö≤ Implementation of an algorithm for determining the width of an object using an ultrasonic rangefinder and encoders in RobotC language üìâ üòæ üë®üèΩ‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 
 Today I would like to share an implementation of the algorithm for determining the width of an object using an ultrasonic rangefinder an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementation of an algorithm for determining the width of an object using an ultrasonic rangefinder and encoders in RobotC language</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503176/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good day! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today I would like to share an implementation of the algorithm for determining the width of an object using an ultrasonic rangefinder and encoders in the RobotC programming language (using the VEX EDR platform).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prehistory</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, I was offered to conduct a master class on solving interesting problems using the RobotC programming language. </font><font style="vertical-align: inherit;">During the master class, I considered the task of determining the width of the object, the implementation of the algorithm of which I want to share in this publication.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elemental base</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an experimental training ground, I used the Robot Virtual Worlds environment for the VEX platform, the virtual robot model VEX Launcher, virtual models of VRC Turning Point competition elements (Figure 1) and the simplest mathematical formulas (for determining the length of a chord in a circle with a known central angle). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/17/tx/x-/17txx-doqjqt3baxzodq7lefbmm.png" alt="image"><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Virtual training ground with a robot</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Determining the diameter of the ball using only an ultrasonic rangefinder and encoders mounted on the robot</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theoretical basis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To determine the width of the object, I used the concept of a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">radiation pattern</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Figure 2). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8m/1x/qw/8m1xqw4-9xx-e_hrazmepq8zdpq.png" alt="image"><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2.</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sensitivity and directional pattern of the ultrasonic range finder </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In essence, it was necessary to determine the angle formed when turning from the extreme right position to the extreme left position between the tangents at the extreme points of the diagram. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider Figure 3. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/pq/5j/ympq5j8yf8hlcecpz8j-kbvxjfa.png" alt="image"><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Algorithm geometry </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will search </font><font style="vertical-align: inherit;">for the </font><font style="vertical-align: inherit;">central angle of the arc based on the relationship between the radius of the angle and the arc of rotation of the robot. </font><font style="vertical-align: inherit;">The final width value will correspond to the m - chord of the arc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Input parameters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As input parameters, I have selected: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dist = 100 mm (the distance at which the robot stops to measure, the parameter is selected based on the presence of other objects around the object that may fall into the field of view of the sensor and interfere with the measurement)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d_wheel = 102 mm (diameter of the wheel of the robot)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d_ball = 102 mm (actual ball diameter)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An error was determined as the output parameter of this task, which will indicate the accuracy of our method and the selected parameters: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error = abs (d_ball_exper - d_ball)</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Program Operation Algorithm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following stages of the algorithm were identified.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Movement to the object.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotate to the far right point of an object.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotate to the far left point of the object.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculation of the angle using readings taken from encoders.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error calculation.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RobotC implementation of the algorithm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we need to initialize the standard configuration of the virtual robot:</font></font><br>
<br>
<pre><code class="plaintext hljs">#pragma config(StandardModel, "VEX Launchbot")</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We implement a function that will be responsible for turning the robot to the far right and / or extreme left position. </font><font style="vertical-align: inherit;">The function returns the encoder after a rotation, which will be used in further calculations:</font></font><br>
<br>
<pre><code class="1c hljs">int turn_to_over_object(int leftSpeed, int rightSpeed, int distance, bool need_object, bool left_side)<font></font>
{<font></font>
if(need_object == true)<font></font>
{<font></font>
if(left_side == true)<font></font>
{<font></font>
while(SensorValue[sonarSensor] &gt; distance)<font></font>
{<font></font>
setMultipleMotors(-leftSpeed, leftMotor,frontLeftMotor);<font></font>
setMultipleMotors(rightSpeed, rightMotor,frontRightMotor);<font></font>
}<font></font>
}<font></font>
else<font></font>
{<font></font>
while(SensorValue[sonarSensor] &gt; distance)<font></font>
{<font></font>
setMultipleMotors(leftSpeed, leftMotor,frontLeftMotor);<font></font>
setMultipleMotors(-rightSpeed, rightMotor,frontRightMotor);<font></font>
}<font></font>
}<font></font>
}<font></font>
else<font></font>
{<font></font>
if(left_side == true)<font></font>
{<font></font>
while(SensorValue[sonarSensor] &lt; (distance + <span class="hljs-number">1</span>))<font></font>
{<font></font>
setMultipleMotors(-leftSpeed, leftMotor,frontLeftMotor);<font></font>
setMultipleMotors(rightSpeed, rightMotor,frontRightMotor);<font></font>
}<font></font>
}<font></font>
else<font></font>
{<font></font>
while(SensorValue[sonarSensor] &lt; (distance + <span class="hljs-number">1</span>))<font></font>
{<font></font>
setMultipleMotors(leftSpeed, leftMotor,frontLeftMotor);<font></font>
setMultipleMotors(-rightSpeed, rightMotor,frontRightMotor);<font></font>
}<font></font>
}<font></font>
}<font></font>
<font></font>
return getMotorEncoder(leftMotor);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a closer look at the function arguments:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leftSpeed ‚Äã‚Äã- left drive speed </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rightSpeed ‚Äã‚Äã- right drive speed </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rightSpeed ‚Äã‚Äã- right drive speed </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">distance - distance to the object where the robot stopped</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">need_object - movement mode: True, if an object is needed in the sensor field of view, False if an object is needed</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left_side - direction of rotation of the robot. </font><font style="vertical-align: inherit;">True - turn left, False - turn right</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the value need_object = True, the robot will rotate until the object is at a distance from the robot (in our case, 100 mm). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the value need_object = False, the robot will rotate until the object is at a distance (distance + 1) from the robot. The unit parameter in total affects the final accuracy of determining the absence of an object in the field of view of the sensor (it is possible to improve the program by taking this parameter into function arguments). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's write the main body of the program:</font></font><br>
<br>
<pre><code class="plaintext hljs">task main()<font></font>
{<font></font>
int d_ball = 10.2; //sm<font></font>
int d_wheel = 10.2;<font></font>
<font></font>
int dist = 10; //sm<font></font>
//  <font></font>
setMotor(armMotor, -50);<font></font>
wait(1);<font></font>
<font></font>
while(SensorValue[sonarSensor] &gt; 10)<font></font>
{<font></font>
setMultipleMotors(50, leftMotor, rightMotor, frontLeftMotor, frontRightMotor);<font></font>
}<font></font>
stopAllMotors();<font></font>
int enc = 0;<font></font>
enc = turn_to_over_object(50, 50, dist, false, false);<font></font>
enc = turn_to_over_object(50, 50, dist, true, true);<font></font>
resetMotorEncoder(leftMotor);<font></font>
enc = turn_to_over_object(50, 50, dist, false, true);<font></font>
stopAllMotors();<font></font>
<font></font>
float teta = abs(enc) * PI * d_wheel * d_wheel / (dist * 627);<font></font>
float d_ball_exper = 2 * dist * sin(teta / 2);<font></font>
	<font></font>
float error = abs(d_ball_exper - d_ball);<font></font>
while(1)<font></font>
{<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first while loop runs until the robot reaches the specified distance to the object. Next, we need to call the function written above one by one in order to measure the encoder reading between the rightmost and leftmost positions (note that before measuring it is necessary to reset the encoder to zero). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get the angle formula, I was guided by the following formulas: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - enc = N * 627, where </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;N is the number of revolutions of the wheel, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;enc is the encoder reading, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;627 is the encoder resolution =&gt; express N; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - S = N * l, where </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;l is the length of the wheel, l = PI * d_wheel * d_wheel =&gt; substitute N and l =&gt; S = enc * PI * d_wheel * d_wheel / 627; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - on the other hand, S = dist * teta, where</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;S is the magnitude of the arc that the robot turned, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;teta is the desired central angle; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - based on the above data, we express teta =&gt; teta = enc * PI * d_wheel * d_wheel / (627 * dist) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To find the chord equal to the desired diameter of the ball, we use the formula: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;d_ball_exper = 2 * dist * sin (teta / 2) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The endless while loop at the end of the program is necessary in order to see the received values ‚Äã‚Äãin the debugger.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary data</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following values ‚Äã‚Äãof the ball diameter and errors were obtained on the virtual field: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;d_ball_exper = 10.6 cm </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;error = 0.4 cm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the obtained method for measuring the width gives a small error value, which is acceptable for the accuracy class of the sensors used. </font><font style="vertical-align: inherit;">The error value can be reduced by selecting the value of the dist parameter (for example, starting a cycle with the robot moving back with a certain step that changes to dist) or using the PID controller, which will reduce the influence of the inertia of the robot on the final value of the encoder during braking.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prospects</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, I will consider other methods for using robot sensors to determine environmental parameters.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503154/index.html">Future Scenario for Stack Overflow</a></li>
<li><a href="../en503156/index.html">Railway stations of Russia can be equipped with Russian thermal imagers; in appearance they are very similar to Chinese</a></li>
<li><a href="../en503158/index.html">Artificial intelligence paints a picture by itself, really by itself - without learning from examples of other paintings</a></li>
<li><a href="../en503164/index.html">Gambling advertising: Google policy brief</a></li>
<li><a href="../en503172/index.html">C #: Introducing Source Code Generators</a></li>
<li><a href="../en503178/index.html">Apple Mac and fancy devices. LTO, SAS, Fiber Channel, eSATA</a></li>
<li><a href="../en503182/index.html">"I am the first blind developer in my company." Part 1</a></li>
<li><a href="../en503184/index.html">We invite you to the online meeting Zabbix</a></li>
<li><a href="../en503192/index.html">oVirt in 2 hours. Part 4. Basic operations</a></li>
<li><a href="../en503194/index.html">ISA does not forgive mistakes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>