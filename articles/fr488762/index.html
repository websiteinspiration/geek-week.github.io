<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😴 🌤️ 🧤 Programmation asynchrone élégante avec des promesses 🙏🏼 🙍🏻 🧑🏿‍🤝‍🧑🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour mes amis! 
 
 Les promesses (promesses) sont une fonctionnalité relativement nouvelle de JavaScript qui vous permet de retarder l'exécution d'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programmation asynchrone élégante avec des promesses</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488762/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour mes amis! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses (promesses) sont une fonctionnalité relativement nouvelle de JavaScript qui vous permet de retarder l'exécution d'une action jusqu'à la fin de l'action précédente ou de répondre à l'exécution infructueuse de l'action. </font><font style="vertical-align: inherit;">Cela contribue à la bonne détermination de la séquence des opérations asynchrones. </font><font style="vertical-align: inherit;">Cet article explique comment fonctionnent les promesses, comment elles sont utilisées dans l'API Web et comment vous pouvez écrire votre propre promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conditions: connaissances de base en informatique, connaissance des bases de JS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objectif: comprendre quelles sont les promesses et comment elles sont utilisées.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelles sont les promesses?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons brièvement passé en revue les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promesses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le premier article du cours, ici nous les examinerons plus en détail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En substance, une promesse est un objet qui représente un état intermédiaire d'une opération - elle «promet» que le résultat sera rendu à l'avenir. On ne sait pas exactement quand l'opération sera terminée et quand le résultat sera retourné, mais il y a une garantie que lorsque l'opération sera terminée, votre code fera quelque chose avec le résultat ou traitera correctement l'erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En règle générale, le temps qu'une opération asynchrone prend (pas trop longtemps!) Nous intéresse moins que la possibilité d'une réponse immédiate à son achèvement. Et, bien sûr, il est bon de savoir que le reste du code n'est pas bloqué.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des promesses les plus courantes sont les API Web qui renvoient des promesses. Regardons une application de chat vidéo hypothétique. L'application dispose d'une fenêtre avec une liste d'amis de l'utilisateur, en cliquant sur le bouton à côté du nom (ou avatar) de l'utilisateur démarre un appel vidéo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire de boutons appelle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUserMedia ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour accéder à la caméra et au microphone de l'utilisateur. À partir du moment où getUserMedia () contacte l'utilisateur pour obtenir une autorisation (pour utiliser des appareils, quel appareil utiliser si l'utilisateur dispose de plusieurs microphones ou caméras, seul un appel vocal, entre autres), getUserMedia () attend non seulement la décision de l'utilisateur, mais aussi la libération appareils s'ils sont en cours d'utilisation. De plus, l'utilisateur peut ne pas répondre immédiatement. Tout cela peut entraîner des retards importants dans le temps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une demande d'autorisation d'utiliser des périphériques est effectuée à partir du thread principal, le navigateur est bloqué jusqu'à ce que getUserMedia () soit terminé. C'est inadmissible. Sans promesses, tout dans le navigateur devient «non cliquable» jusqu'à ce que l'utilisateur donne la permission d'utiliser le microphone et la caméra. Par conséquent, au lieu d'attendre la décision d'un utilisateur et de renvoyer un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaStream</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour un flux créé à partir de sources (caméra et microphone), getUserMedia () renvoie une promesse que MediaStream traite dès qu'il est disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de l'application de chat vidéo peut ressembler à ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span> <span class="hljs-title">CallButton</span>(<span class="hljs-params">evt</span>)</span>{<font></font>
    setStatusMessage(<span class="hljs-string">'Calling...'</span>)<font></font>
    navigator.mediaDevices.getUserMedia({<span class="hljs-attr">video</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>})<font></font>
    .then(<span class="hljs-function"><span class="hljs-params">chatStream</span> =&gt;</span> {<font></font>
        selfViewElem.srcObject = chatStream<font></font>
        chatStream.getTracks().forEach(<span class="hljs-function"><span class="hljs-params">track</span> =&gt;</span> myPeerConnection.addTrack(track, chatStream))<font></font>
        setStatusMessage(<span class="hljs-string">'Connected'</span>)<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {<font></font>
        setStatusMessage(<span class="hljs-string">'Failed to connect'</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction commence par appeler setStatusMessage (), affichant le message 'Calling ...', qui sert d'indicateur qu'une tentative est en cours pour effectuer un appel. Ensuite, getUserMedia () est appelé, demandant un flux contenant des pistes vidéo et audio. Une fois le flux formé, un élément vidéo est installé pour afficher le flux de la caméra appelé `` auto-vue '', des pistes audio sont ajoutées à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTCPeerConnection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est une connexion à un autre utilisateur. Après cela, le statut est mis à jour sur «Connecté». </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si getUserMedia () échoue, le bloc catch est lancé. Il utilise setStatusMessage () pour afficher un message d'erreur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que l'appel à getUserMedia () est renvoyé même si le flux vidéo n'a pas encore été reçu. </font><font style="vertical-align: inherit;">Même si la fonction handleCallButton () renvoyait le contrôle au code qui l'appelait, dès que getUserMedia () terminait l'exécution, elle appelait le gestionnaire. </font><font style="vertical-align: inherit;">Jusqu'à ce que l'application «comprenne» que la diffusion a commencé, getUserMedia () sera en mode veille. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: vous pouvez en savoir plus à ce sujet dans l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Signaux et appels vidéo»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cet article fournit un code plus complet que celui que nous avons utilisé dans l'exemple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problème des fonctions de rappel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre pourquoi les promesses sont une bonne solution, il est utile de regarder l'ancienne façon d'écrire des rappels pour voir quels étaient leurs problèmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, pensez à commander une pizza. </font><font style="vertical-align: inherit;">Une commande de pizza réussie se compose de plusieurs étapes qui doivent être effectuées dans l'ordre, l'une après l'autre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisissez la garniture. </font><font style="vertical-align: inherit;">Cela peut prendre un certain temps si vous y pensez longtemps, et échouer si vous changez d'avis et commandez un curry.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous passons une commande. </font><font style="vertical-align: inherit;">La cuisson de la pizza prend un certain temps et peut échouer si le restaurant manque des ingrédients nécessaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous obtenons une pizza et mangeons. </font><font style="vertical-align: inherit;">La réception de la pizza peut échouer si, par exemple, nous ne pouvons pas payer la commande.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un pseudocode à l'ancienne utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des fonctions de rappel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pourrait ressembler à ceci:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{<font></font>
    placeOrder(toppings, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{<font></font>
        collectOrder(order, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
            eatPizza(pizza)<font></font>
        }, failureCallback)<font></font>
    }, failureCallback)<font></font>
}, failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel code est difficile à lire et à maintenir (il est souvent appelé «l'enfer des rappels» ou «l'enfer des rappels»). </font><font style="vertical-align: inherit;">La fonction failureCallback () doit être appelée à chaque niveau d'imbrication. </font><font style="vertical-align: inherit;">Il y a d'autres problèmes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons des promesses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses rendent le code plus propre, plus facile à comprendre et à prendre en charge. </font><font style="vertical-align: inherit;">Si nous réécrivons le pseudocode à l'aide de promesses asynchrones, nous obtenons ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{
    <span class="hljs-keyword">return</span> placeOrder(toppings)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{
    <span class="hljs-keyword">return</span> collectOrder(order)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
    eatPizza(pizza)<font></font>
})<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est beaucoup mieux - nous voyons ce qui se passe, nous utilisons un bloc .catch () pour gérer toutes les erreurs, la fonction ne bloque pas le flux principal (afin que nous puissions jouer à des jeux vidéo en attendant la pizza), chaque opération est garantie d'être effectuée une fois la précédente terminée. </font><font style="vertical-align: inherit;">Puisque chaque promesse renvoie une promesse, nous pouvons utiliser la chaîne .then. </font><font style="vertical-align: inherit;">Super, non? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant les fonctions fléchées, le pseudo-code peut être encore simplifié:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span><font></font>
    placeOrder(toppings)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span><font></font>
    collectOrder(order)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span><font></font>
    eatPizza(pizza)     <font></font>
)<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou même comme ça:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span> placeOrder(toppings))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> collectOrder(order))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span> eatPizza(pizza))<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela fonctionne car () =&gt; x est identique à () =&gt; {return x}. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez même le faire (puisque les fonctions passent simplement des paramètres, nous n'avons pas besoin de superposition):</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings().then(placeOrder).then(collectOrder).then(eatPizza).catch(failureCallback)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel code est plus difficile à lire et ne peut pas être utilisé avec des constructions plus complexes qu'en pseudocode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: le pseudo-code peut toujours être amélioré en utilisant async / wait, qui sera discuté dans un prochain article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la base, les promesses sont similaires aux auditeurs d'événements, mais avec quelques différences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une promesse n'est tenue qu'une seule fois (succès ou échec). </font><font style="vertical-align: inherit;">Il ne peut pas être exécuté deux fois ou passer de la réussite à l'échec ou vice versa une fois l'opération terminée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la promesse est terminée et que nous ajoutons une fonction de rappel pour traiter son résultat, cette fonction sera appelée, malgré le fait que l'événement se soit produit avant l'ajout de la fonction.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Syntaxe de base des promesses: un exemple réel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de connaître les promesses car de nombreuses API Web les utilisent dans des fonctions qui exécutent des tâches potentiellement complexes. Travailler avec les technologies Web modernes implique l'utilisation de promesses. Plus tard, nous apprendrons à rédiger nos propres promesses, mais pour l'instant, regardons quelques exemples simples qui peuvent être trouvés dans l'API Web. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier exemple, nous utilisons la méthode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fetch ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour obtenir l'image du réseau, la méthode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blob ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour convertir le contenu du corps de réponse en un objet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et afficher cet objet à l'intérieur de l'élément </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;img&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cet exemple est très similaire à l'exemple du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premier article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais nous le ferons un peu différemment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: l'exemple suivant ne fonctionnera pas si vous l'exécutez simplement à partir d'un fichier (c'est-à-dire en utilisant file: // URL). Vous devez l'exécuter via un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur local</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou utiliser des solutions en ligne telles que les </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">pages </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glitch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Tout d'abord, téléchargez le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code HTML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que nous recevrons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Ajoutez l'élément </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;script&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à la fin de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;body&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. À l'intérieur de l'élément &lt;script&gt;, ajoutez la ligne suivante:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise = fetch(<span class="hljs-string">'coffee.jpg'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode fetch (), qui prend l'URL de l'image comme paramètre, est utilisée pour obtenir l'image du réseau. En tant que deuxième paramètre, nous pouvons spécifier un objet avec des paramètres, mais pour l'instant nous nous limiterons à une option simple. Nous stockons la promesse retournée par fetch () dans la variable de promesse. Comme indiqué précédemment, une promesse est un objet qui représente un état intermédiaire - le nom officiel d'un état donné est en attente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Pour travailler avec le résultat de la réussite de la promesse (dans notre cas, lorsque la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réponse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> revient </font><font style="vertical-align: inherit;">), nous appelons la méthode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.then ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La fonction de rappel à l'intérieur du bloc .then () (souvent appelé exécuteur) n'est lancée que lorsque la promesse se termine avec succès et que l'objet Response est renvoyé - ils disent que la promesse est terminée (remplie, remplie). </font><font style="vertical-align: inherit;">La réponse est transmise en tant que paramètre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Le fonctionnement du bloc .then () est similaire au fonctionnement de l'écouteur d'événement AddEventListener (). </font><font style="vertical-align: inherit;">Il n'est déclenché qu'après que l'événement se soit produit (après avoir rempli la promesse). </font><font style="vertical-align: inherit;">La différence entre les deux est que .then () ne peut être appelé qu'une seule fois, tandis que l'écouteur est conçu pour plusieurs appels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir reçu la réponse, nous appelons la méthode blob () pour convertir la réponse en un objet Blob. </font><font style="vertical-align: inherit;">Cela ressemble à ceci:</font></font><br>
<br>
<pre><code class="javascript hljs">response =&gt; response.blob()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... qui est une courte entrée pour:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>)</span>{
    <span class="hljs-keyword">return</span> response.blob()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK, assez de mots. </font><font style="vertical-align: inherit;">Ajoutez ce qui suit après la première ligne:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise2 = promise.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Chaque appel à .then () crée une nouvelle promesse. </font><font style="vertical-align: inherit;">Ceci est très utile: puisque blob () retourne également une promesse, nous pouvons traiter l'objet Blob en appelant .then () sur la deuxième promesse. </font><font style="vertical-align: inherit;">Étant donné que nous voulons faire quelque chose de plus compliqué que d'appeler la méthode et de renvoyer le résultat, nous devons encapsuler le corps de la fonction entre accolades (sinon, une exception sera levée): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez ce qui suit à la fin du code:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise3 = promise2.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Complétons le corps de la fonction d'exécution. </font><font style="vertical-align: inherit;">Ajoutez les lignes suivantes aux accolades:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
<span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image.src = objectURL<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous appelons la méthode URL.createObjectURL (), en la passant comme paramètre Blob, qui a renvoyé la deuxième promesse. </font><font style="vertical-align: inherit;">Nous obtenons un lien vers l'objet. </font><font style="vertical-align: inherit;">Ensuite, nous créons un élément &lt;img&gt;, définissons l'attribut src avec la valeur du lien d'objet et l'ajoutons au DOM pour que l'image apparaisse sur la page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous enregistrez le code HTML et le chargez dans un navigateur, vous verrez que l'image s'affiche comme prévu. </font><font style="vertical-align: inherit;">Bon travail! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Vous avez probablement remarqué que ces exemples sont quelque peu artificiels. </font><font style="vertical-align: inherit;">Vous pouvez vous passer des méthodes fetch () et blob () et affecter l'URL &lt;img&gt; correspondante, coffee.jpg. </font><font style="vertical-align: inherit;">Nous sommes allés de cette façon pour démontrer le travail avec les promesses avec un exemple simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réponse d'échec</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons oublié quelque chose - nous n'avons pas de gestionnaire d'erreurs au cas où l'une des promesses échouerait (sera rejetée). </font><font style="vertical-align: inherit;">Nous pouvons ajouter un gestionnaire d'erreurs en utilisant la méthode .catch (). </font><font style="vertical-align: inherit;">Faisons cela:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> errorCase = promise3.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour voir cela en action, spécifiez la mauvaise URL de l'image et rechargez la page. </font><font style="vertical-align: inherit;">Un message d'erreur apparaîtra dans la console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, si nous n'ajoutons pas le bloc .catch (), un message d'erreur sera également affiché dans la console. </font><font style="vertical-align: inherit;">Cependant .catch () nous permet de gérer les erreurs comme nous le voulons. </font><font style="vertical-align: inherit;">Dans une application réelle, votre bloc .catch () peut essayer de reprendre l'image ou afficher l'image par défaut, ou demander à l'utilisateur de sélectionner une autre image ou de faire autre chose. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Regardez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fusion de blocs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, l'approche que nous avons utilisée pour écrire le code n'est pas optimale. </font><font style="vertical-align: inherit;">Nous avons délibérément choisi cette voie pour que vous puissiez comprendre ce qui se passe à chaque étape. </font><font style="vertical-align: inherit;">Comme indiqué précédemment, nous pouvons combiner des blocs .then () (et des blocs .catch ()). </font><font style="vertical-align: inherit;">Notre code peut être réécrit comme suit (voir aussi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple-fetch-chained.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur GitHub):</font></font><br>
<br>
<pre><code class="javascript hljs">fetch(<span class="hljs-string">'coffee.jpg'</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())<font></font>
.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {
    <span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
    <span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
    image.src = objectURL<font></font>
    <span class="hljs-built_in">document</span>.body.appendChild(image)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas que la valeur renvoyée par la promesse est transmise en tant que paramètre au prochain exécuteur de fonction du bloc .then (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Les blocs .then () /. Catch () dans promesses sont des équivalents asynchrones du bloc synchrone try ... catch. </font><font style="vertical-align: inherit;">N'oubliez pas: synchrone try ... catch ne fonctionnera pas en code asynchrone.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promesse de conclusion terminologique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faisons le point et rédigeons un petit guide que vous pourrez utiliser à l'avenir. </font><font style="vertical-align: inherit;">Pour consolider les connaissances, nous vous recommandons de lire la section précédente plusieurs fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Lorsque la promesse est créée, ils disent qu'elle est dans un état d'attente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Lorsque la promesse est retournée, ils disent qu'elle a été réalisée (résolue):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Une promesse accomplie avec succès est appelée tenue. </font><font style="vertical-align: inherit;">Il renvoie la valeur qui peut être obtenue via la chaîne à partir de .then () à la fin de la promesse. </font><font style="vertical-align: inherit;">La fonction d'exécution dans le bloc .then () contient la valeur renvoyée par la promesse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Une promesse non remplie est appelée rejetée. </font><font style="vertical-align: inherit;">Il renvoie la raison, le message d'erreur qui a conduit au rejet de la promesse. </font><font style="vertical-align: inherit;">Cette raison peut être obtenue via le bloc .catch () à la fin de la promesse.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécutez le code après plusieurs promesses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons appris les bases de l'utilisation des promesses. Voyons maintenant des fonctionnalités plus avancées. La chaîne de .then () est très bien, mais que se passe-t-il si nous voulons appeler plusieurs blocs de promesses un par un? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez le faire en utilisant la méthode standard Promise.all (). Cette méthode prend un tableau de promesses comme paramètre et renvoie une nouvelle promesse lorsque toutes les promesses du tableau sont remplies. Cela ressemble à ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([a,b,c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
        ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si toutes les promesses sont remplies, l'exécuteur de tableau du bloc .then () sera passé en paramètre. Si au moins une des promesses n'est pas tenue, le bloc entier sera rejeté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut être très utile. Imaginez que nous recevions des informations pour remplir dynamiquement l'interface utilisateur avec du contenu sur notre page. Dans de nombreux cas, il est plus raisonnable de recevoir toutes les informations et de les afficher sur la page plus tard que d'afficher les informations en plusieurs parties. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons un autre exemple: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Téléchargez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un modèle de page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et placez la balise &lt;script&gt; avant la balise de fermeture &lt;/body&gt;. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Téléchargez les fichiers sources ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coffee.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tea.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">description.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ou remplacez-les par les vôtres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Dans le script, nous définissons d'abord une fonction qui renvoie les promesses que nous transmettons à Promise.all (). </font><font style="vertical-align: inherit;">Cela sera facile à faire si nous exécutons Promise.all () après avoir terminé les trois opérations fetch (). </font><font style="vertical-align: inherit;">Nous pouvons faire ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> a = fetch(url1)
<span class="hljs-keyword">let</span> b = fetch(url2)
<span class="hljs-keyword">let</span> c = fetch(url3)<font></font>
<font></font>
<span class="hljs-built_in">Promise</span>.all([a, b, c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
    ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la promesse est remplie, la variable «values» contiendra trois objets Response, un pour chaque opération fetch () terminée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous ne voulons pas cela. </font><font style="vertical-align: inherit;">Cela n'a pas d'importance pour nous lorsque les opérations fetch () sont terminées. </font><font style="vertical-align: inherit;">Ce que nous voulons vraiment, ce sont les données chargées. </font><font style="vertical-align: inherit;">Cela signifie que nous voulons exécuter le bloc Promise.all () après avoir reçu un blob valide représentant des images et des chaînes de texte valides. </font><font style="vertical-align: inherit;">Nous pouvons écrire une fonction qui fait cela; </font><font style="vertical-align: inherit;">ajoutez ce qui suit à votre élément &lt;script&gt;:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation '</span> + e.message)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble un peu compliqué, alors passons en revue le code étape par étape: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Tout d'abord, nous déclarons une fonction et lui transmettons l'URL et le type du fichier résultant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. La structure de la fonction est similaire à celle que nous avons vue dans le premier exemple - nous appelons la fonction fetch () pour obtenir le fichier à une URL spécifique, puis transférons le fichier vers une autre promesse qui retourne le corps de réponse décodé (lecture). </font><font style="vertical-align: inherit;">Dans l'exemple précédent, c'était toujours la méthode blob (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Il y a deux différences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premièrement, la deuxième promesse de retour dépend du type de valeur. </font><font style="vertical-align: inherit;">Dans la fonction d'exécution, nous utilisons l'instruction if ... else if pour renvoyer la promesse en fonction du type de fichier que nous devons décoder (dans ce cas, nous choisissons entre blob et texte, mais l'exemple peut être facilement étendu pour fonctionner avec d'autres types).</font></font></li>
<li>-,     «return»   fetch().       ,     (..   ,  blob()  text(),  ,  ,   ).  ,  return     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. À la fin, nous appelons la méthode .catch () pour gérer les erreurs qui peuvent se produire dans les promesses du tableau passé à .all (). Si l'une des promesses est rejetée, le bloc de capture nous fera savoir quelle promesse était le problème. Le bloc .all () s'exécutera toujours, mais il n'affichera pas les résultats pour lesquels il y a eu des erreurs. Si vous souhaitez que .all () soit rejeté, ajoutez un bloc .catch () à la fin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code à l'intérieur de la fonction est asynchrone et basé sur des promesses, donc la fonction entière fonctionne comme une promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ensuite, nous appelons notre fonction trois fois pour démarrer le processus de réception et de décodage des images et du texte, et mettons chacune des promesses dans une variable. Ajoutez ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> coffee = fetchAndDecode(<span class="hljs-string">'coffee.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> tea = fetchAndDecode(<span class="hljs-string">'tea.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> description = fetchAndDecode(<span class="hljs-string">'description.txt'</span>, <span class="hljs-string">'text'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Ensuite, nous déclarons un bloc Promise.all () pour exécuter du code uniquement après que les trois promesses ont été remplies. </font><font style="vertical-align: inherit;">Ajoutez un bloc avec une fonction d'exécuteur vide à l'intérieur de .then ():</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([coffee, tea, description]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir que cela prend un tableau de promesses comme paramètre. </font><font style="vertical-align: inherit;">L'entrepreneur ne commencera que lorsque les trois promesses auront été tenues; </font><font style="vertical-align: inherit;">lorsque cela se produit, le résultat de chaque promesse (le corps de réponse décodé) sera placé dans un tableau, cela peut être représenté comme [résultats du café, résultats du thé, résultats de la description]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Enfin, ajoutez ce qui suit à l'exécuteur (ici, nous utilisons un code synchrone assez simple pour mettre les résultats dans des variables (création d'objets URL à partir de blob) et afficher des images et du texte sur la page):</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">console</span>.log(values)
<span class="hljs-comment">//       </span>
<span class="hljs-keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="hljs-number">0</span>])
<span class="hljs-keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="hljs-number">1</span>])
<span class="hljs-keyword">let</span> descText = values[<span class="hljs-number">2</span>]<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> image1 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)
<span class="hljs-keyword">let</span> image2 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image1.src = objectURL1<font></font>
image2.src = objectURL2<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image1)
<span class="hljs-built_in">document</span>.body.appendChild(image2)<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> para = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'p'</span>)<font></font>
para.textContent = descText<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(para)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enregistrez les modifications et rechargez la page. Vous devriez voir que tous les composants de l'interface utilisateur se chargent, bien que cela ne semble pas très attrayant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. Si vous rencontrez des difficultés, vous pouvez comparer votre version du code avec la nôtre - voici une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. Afin d'améliorer ce code, vous pouvez parcourir les éléments affichés, les recevoir et les décoder, puis parcourir les résultats dans Promise.all (), en lançant différentes fonctions pour afficher chaque résultat en fonction de son type. Cela vous permettra de travailler avec n'importe quel nombre d'éléments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, vous pouvez déterminer le type du fichier résultant sans avoir à spécifier explicitement la propriété type. Cela, par exemple, peut être fait avec</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">response.headers.get ('content-type')</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour vérifier </font><font style="vertical-align: inherit;">l'en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tête </font><font style="vertical-align: inherit;">HTTP Protocol </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Content-Type</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exécutez le code après avoir rempli / rejeté la promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Souvent, vous devrez peut-être exécuter du code une fois la promesse terminée, qu'elle ait été exécutée ou rejetée. </font><font style="vertical-align: inherit;">Auparavant, nous devions inclure le même code dans le bloc .then () et le bloc .catch (), par exemple:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
    runFinalCode()<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les navigateurs modernes, la méthode .finally () est disponible, ce qui vous permet d'exécuter le code une fois la promesse terminée, ce qui évite la répétition et rend le code plus élégant. </font><font style="vertical-align: inherit;">Le code de l'exemple précédent peut être réécrit comme suit:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
})<font></font>
.finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir l'utilisation de cette approche avec un exemple réel - la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démonstration en direct promise-finally.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Cela fonctionne de la même manière que Promise.all () de l'exemple précédent, sauf que nous ajoutons enfin () à la fin de la chaîne dans la fonction fetchAndDecode ():</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`There has been a problem with your fetch operation for resource "<span class="hljs-subst">${url}</span>": <span class="hljs-subst">${e.message}</span>`</span>)<font></font>
    }).finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`fetch attempt for "<span class="hljs-subst">${url}</span>" finished.`</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous recevrons un message indiquant la fin de chaque tentative d'obtention du fichier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">then () / catch () / finally () est l'équivalent asynchrone de synchrone try () / catch () / finally ().</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rédiger votre propre promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La bonne nouvelle est que vous savez déjà comment procéder. </font><font style="vertical-align: inherit;">Lorsque vous combinez plusieurs promesses avec .then () ou les combinez pour fournir des fonctionnalités spécifiques, vous créez vos propres fonctions asynchrones et basées sur les promesses. </font><font style="vertical-align: inherit;">Prenons par exemple notre fonction fetchAndDecode () de l'exemple précédent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La combinaison de diverses API basées sur des promesses pour créer des fonctionnalités spécifiques est la façon la plus courante de travailler avec des promesses, ce qui montre la flexibilité et la puissance des API modernes. </font><font style="vertical-align: inherit;">Cependant, il existe un autre moyen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promesse du constructeur ()</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez créer votre propre promesse à l'aide du constructeur Promise (). Cela peut être nécessaire dans une situation où vous avez du code de l'ancienne API asynchrone que vous devez «surdimensionner». Ceci est fait afin de pouvoir travailler simultanément à la fois avec du code, des bibliothèques ou des «frameworks» existants et anciens, et avec un nouveau code basé sur des promesses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons un exemple simple - ici, nous encapsulons l'appel setTimeout () dans une promesse - cela démarrera la fonction en 2 secondes, qui remplira la promesse (en utilisant l'appel resolver () passé) avec la chaîne «Success!».</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
        resolve(<span class="hljs-string">'Success!'</span>)<font></font>
    }, <span class="hljs-number">2000</span>)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
resolver () et rejeter () sont des fonctions appelées à remplir ou à rejeter une nouvelle promesse. </font><font style="vertical-align: inherit;">Dans ce cas, la promesse est remplie avec la chaîne "Success!". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous appelez cette promesse, vous pouvez y ajouter un bloc .then () pour continuer à travailler avec la ligne «Success!». </font><font style="vertical-align: inherit;">Nous pouvons donc sortir une ligne dans le message:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise<font></font>
.then(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {<font></font>
    alert(message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ou alors:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise.then(alert)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple donné n'est pas très flexible - la promesse ne peut être remplie qu'avec une simple ligne, nous n'avons pas de gestionnaire d'erreur - rejette () (en fait, setTimeout () n'a pas besoin d'un gestionnaire d'erreur, donc dans ce cas, cela n'a pas d'importance). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Pourquoi résoudre () plutôt que réaliser ()? </font><font style="vertical-align: inherit;">Pour le moment, la réponse est la suivante: c'est difficile à expliquer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous travaillons avec un rejet d'une promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons créer une promesse rejetée en utilisant la méthode rejeter () - tout comme resolver (), rejeter () prend une valeur simple, mais contrairement à resolver (), la valeur simple n'est pas le résultat, mais la raison du rejet, c'est-à-dire </font><font style="vertical-align: inherit;">une erreur transmise au bloc .catch (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Développons l'exemple précédent en ajoutant une condition de rejet d'une promesse, ainsi que la possibilité de recevoir des messages autres qu'un message de réussite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenez l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemple précédent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et réécrivez-le comme ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timeoutPromise</span>(<span class="hljs-params">message, interval</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span>(message === <span class="hljs-string">''</span> || <span class="hljs-keyword">typeof</span> message !== <span class="hljs-string">'string'</span>){<font></font>
            reject(<span class="hljs-string">'Message is empty or not a string'</span>)<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(interval &lt; <span class="hljs-number">0</span> || <span class="hljs-keyword">typeof</span> interval !== number){<font></font>
            reject(<span class="hljs-string">'Interval is negative or not a number'</span>)<font></font>
        } <span class="hljs-keyword">else</span>{<font></font>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
                resolve(message)<font></font>
            }, interval)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous passons deux arguments à la fonction - message et intervalle (temporisation). </font><font style="vertical-align: inherit;">Dans une fonction, nous retournons un objet Promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le constructeur Promise, nous effectuons plusieurs vérifications en utilisant les structures if ... else:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, nous vérifions le message. </font><font style="vertical-align: inherit;">S'il est vide ou n'est pas une chaîne, nous rejetons la promesse et signalons une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxièmement, nous vérifions le délai. </font><font style="vertical-align: inherit;">S'il s'agit d'un nombre négatif ou non, nous rejetons également la promesse et signalons une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, si les deux arguments sont OK, affichez le message après un certain temps (intervalle) à l'aide de setTimeout ().</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque timeoutPromise () renvoie une promesse, nous pouvons y ajouter .then (), .catch (), etc. pour améliorer sa fonctionnalité. </font><font style="vertical-align: inherit;">Faisons cela:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise(<span class="hljs-string">'Hello there!'</span>, <span class="hljs-number">1000</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {<font></font>
    alert(message)<font></font>
}).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error: '</span> + e)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir enregistré les modifications et exécuté le code, vous verrez un message après une seconde. </font><font style="vertical-align: inherit;">Essayez maintenant de passer une chaîne vide comme message ou un nombre négatif comme intervalle. </font><font style="vertical-align: inherit;">Vous verrez un message d'erreur à la suite du rejet de la promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Vous pouvez trouver notre version de cet exemple sur GitHub - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">custom-promise2.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple plus réaliste.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple que nous avons examiné facilite la compréhension du concept, mais il n'est pas vraiment asynchrone. L'asynchronie dans l'exemple est simulée à l'aide de setTimeout (), bien qu'elle montre encore l'utilité des promesses pour la création de fonctions avec un flux de travail raisonnable, une bonne gestion des erreurs, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple d'une application asynchrone utile qui utilise le constructeur Promise () est la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bibliothèque idb (IndexedDB with usability)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jake Archibald. </font><font style="vertical-align: inherit;">Cette bibliothèque vous permet d'utiliser l'API IndexedDB (basée sur les fonctions de rappel d'API pour le stockage et la récupération de données côté client), écrite dans l'ancien style, avec des promesses. </font><font style="vertical-align: inherit;">Si vous regardez le fichier de bibliothèque principal, vous verrez qu'il utilise les mêmes techniques que nous avons examinées ci-dessus. </font><font style="vertical-align: inherit;">Le code suivant convertit le modèle de requête de base utilisé par de nombreuses méthodes IndexedDB en un modèle compatible avec les promesses:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promisifyRequest</span>(<span class="hljs-params">request</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{<font></font>
        request.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            resolve(request.result)<font></font>
        }<font></font>
<font></font>
        request.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            reject(request.error)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ajoute quelques gestionnaires d'événements qui remplissent ou rejettent la promesse, selon le cas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque la demande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aboutit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le gestionnaire onsuccess remplit la promesse avec le résultat de la demande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque la demande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">échoue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le gestionnaire onerror rejette la promesse avec l'erreur de la demande.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses sont un excellent moyen de créer des applications asynchrones lorsque nous ne savons pas quelle valeur la fonction renverra ni combien de temps cela prendra. Ils vous permettent de travailler avec une séquence d'opérations asynchrones sans utiliser de fonctions de rappel profondément imbriquées, et ils prennent en charge le style de gestion des erreurs de l'instruction try ... catch synchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses sont prises en charge par tous les navigateurs modernes. La seule exception est Opera Mini et IE11 et ses versions antérieures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous avons considéré loin de toutes les caractéristiques des promesses, seules les plus intéressantes et utiles. Vous apprendrez à connaître d'autres fonctionnalités et techniques si vous souhaitez en savoir plus sur les promesses.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des API Web modernes sont basées sur des promesses, donc les promesses doivent être connues. </font><font style="vertical-align: inherit;">Parmi ces API Web, nous pouvons nommer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web Audio API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Media Capture and Streams</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. Les promesses deviendront de plus en plus populaires, donc leur étude et leur compréhension sont une étape importante vers la maîtrise du JavaScript moderne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voir également </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Erreurs courantes dans les promesses JavaScript que tout le monde devrait connaître»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci de votre attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La critique constructive est la bienvenue.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488750/index.html">Promenade des dinosaures: deux grands ordinateurs du XXe siècle</a></li>
<li><a href="../fr488752/index.html">Golang + Phaser3 = MMORPG - Nous jetons les bases de la génération sans fin du monde</a></li>
<li><a href="../fr488754/index.html">Tout à la fois: vérification automatique de la taille du lot</a></li>
<li><a href="../fr488756/index.html">Comment travailler avec l'API Google Sheets (Google Sheets API v4) dans R en utilisant le nouveau package googlesheets4</a></li>
<li><a href="../fr488758/index.html">Conférence DEFCON 27. Reconnaissance des escroqueries sur Internet</a></li>
<li><a href="../fr488766/index.html">Art et technologie: Université du Massachusetts à Lowell</a></li>
<li><a href="../fr488768/index.html">Enfer sanglant, ou Comment jurer en anglais pour être confondu avec une personne cultivée</a></li>
<li><a href="../fr488776/index.html">Améliorations de l'accessibilité dans Visual Studio 2019 pour Mac</a></li>
<li><a href="../fr488778/index.html">Structures de données: une liste qui peut tout faire *</a></li>
<li><a href="../fr488780/index.html">Mozilla a perdu dans la guerre des navigateurs, mais croit toujours qu'il pourrait sauver Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>