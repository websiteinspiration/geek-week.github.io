<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò¥ üå§Ô∏è üß§ Programmation asynchrone √©l√©gante avec des promesses üôèüèº üôçüèª üßëüèø‚Äçü§ù‚Äçüßëüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour mes amis! 
 
 Les promesses (promesses) sont une fonctionnalit√© relativement nouvelle de JavaScript qui vous permet de retarder l'ex√©cution d'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programmation asynchrone √©l√©gante avec des promesses</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488762/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour mes amis! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses (promesses) sont une fonctionnalit√© relativement nouvelle de JavaScript qui vous permet de retarder l'ex√©cution d'une action jusqu'√† la fin de l'action pr√©c√©dente ou de r√©pondre √† l'ex√©cution infructueuse de l'action. </font><font style="vertical-align: inherit;">Cela contribue √† la bonne d√©termination de la s√©quence des op√©rations asynchrones. </font><font style="vertical-align: inherit;">Cet article explique comment fonctionnent les promesses, comment elles sont utilis√©es dans l'API Web et comment vous pouvez √©crire votre propre promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conditions: connaissances de base en informatique, connaissance des bases de JS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objectif: comprendre quelles sont les promesses et comment elles sont utilis√©es.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelles sont les promesses?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons bri√®vement pass√© en revue les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promesses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le premier article du cours, ici nous les examinerons plus en d√©tail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En substance, une promesse est un objet qui repr√©sente un √©tat interm√©diaire d'une op√©ration - elle ¬´promet¬ª que le r√©sultat sera rendu √† l'avenir. On ne sait pas exactement quand l'op√©ration sera termin√©e et quand le r√©sultat sera retourn√©, mais il y a une garantie que lorsque l'op√©ration sera termin√©e, votre code fera quelque chose avec le r√©sultat ou traitera correctement l'erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, le temps qu'une op√©ration asynchrone prend (pas trop longtemps!) Nous int√©resse moins que la possibilit√© d'une r√©ponse imm√©diate √† son ach√®vement. Et, bien s√ªr, il est bon de savoir que le reste du code n'est pas bloqu√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des promesses les plus courantes sont les API Web qui renvoient des promesses. Regardons une application de chat vid√©o hypoth√©tique. L'application dispose d'une fen√™tre avec une liste d'amis de l'utilisateur, en cliquant sur le bouton √† c√¥t√© du nom (ou avatar) de l'utilisateur d√©marre un appel vid√©o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire de boutons appelle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUserMedia ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour acc√©der √† la cam√©ra et au microphone de l'utilisateur. √Ä partir du moment o√π getUserMedia () contacte l'utilisateur pour obtenir une autorisation (pour utiliser des appareils, quel appareil utiliser si l'utilisateur dispose de plusieurs microphones ou cam√©ras, seul un appel vocal, entre autres), getUserMedia () attend non seulement la d√©cision de l'utilisateur, mais aussi la lib√©ration appareils s'ils sont en cours d'utilisation. De plus, l'utilisateur peut ne pas r√©pondre imm√©diatement. Tout cela peut entra√Æner des retards importants dans le temps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une demande d'autorisation d'utiliser des p√©riph√©riques est effectu√©e √† partir du thread principal, le navigateur est bloqu√© jusqu'√† ce que getUserMedia () soit termin√©. C'est inadmissible. Sans promesses, tout dans le navigateur devient ¬´non cliquable¬ª jusqu'√† ce que l'utilisateur donne la permission d'utiliser le microphone et la cam√©ra. Par cons√©quent, au lieu d'attendre la d√©cision d'un utilisateur et de renvoyer un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaStream</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour un flux cr√©√© √† partir de sources (cam√©ra et microphone), getUserMedia () renvoie une promesse que MediaStream traite d√®s qu'il est disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de l'application de chat vid√©o peut ressembler √† ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span> <span class="hljs-title">CallButton</span>(<span class="hljs-params">evt</span>)</span>{<font></font>
    setStatusMessage(<span class="hljs-string">'Calling...'</span>)<font></font>
    navigator.mediaDevices.getUserMedia({<span class="hljs-attr">video</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>})<font></font>
    .then(<span class="hljs-function"><span class="hljs-params">chatStream</span> =&gt;</span> {<font></font>
        selfViewElem.srcObject = chatStream<font></font>
        chatStream.getTracks().forEach(<span class="hljs-function"><span class="hljs-params">track</span> =&gt;</span> myPeerConnection.addTrack(track, chatStream))<font></font>
        setStatusMessage(<span class="hljs-string">'Connected'</span>)<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {<font></font>
        setStatusMessage(<span class="hljs-string">'Failed to connect'</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction commence par appeler setStatusMessage (), affichant le message 'Calling ...', qui sert d'indicateur qu'une tentative est en cours pour effectuer un appel. Ensuite, getUserMedia () est appel√©, demandant un flux contenant des pistes vid√©o et audio. Une fois le flux form√©, un √©l√©ment vid√©o est install√© pour afficher le flux de la cam√©ra appel√© `` auto-vue '', des pistes audio sont ajout√©es √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTCPeerConnection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est une connexion √† un autre utilisateur. Apr√®s cela, le statut est mis √† jour sur ¬´Connect√©¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si getUserMedia () √©choue, le bloc catch est lanc√©. Il utilise setStatusMessage () pour afficher un message d'erreur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que l'appel √† getUserMedia () est renvoy√© m√™me si le flux vid√©o n'a pas encore √©t√© re√ßu. </font><font style="vertical-align: inherit;">M√™me si la fonction handleCallButton () renvoyait le contr√¥le au code qui l'appelait, d√®s que getUserMedia () terminait l'ex√©cution, elle appelait le gestionnaire. </font><font style="vertical-align: inherit;">Jusqu'√† ce que l'application ¬´comprenne¬ª que la diffusion a commenc√©, getUserMedia () sera en mode veille. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: vous pouvez en savoir plus √† ce sujet dans l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Signaux et appels vid√©o¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cet article fournit un code plus complet que celui que nous avons utilis√© dans l'exemple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probl√®me des fonctions de rappel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre pourquoi les promesses sont une bonne solution, il est utile de regarder l'ancienne fa√ßon d'√©crire des rappels pour voir quels √©taient leurs probl√®mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, pensez √† commander une pizza. </font><font style="vertical-align: inherit;">Une commande de pizza r√©ussie se compose de plusieurs √©tapes qui doivent √™tre effectu√©es dans l'ordre, l'une apr√®s l'autre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisissez la garniture. </font><font style="vertical-align: inherit;">Cela peut prendre un certain temps si vous y pensez longtemps, et √©chouer si vous changez d'avis et commandez un curry.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous passons une commande. </font><font style="vertical-align: inherit;">La cuisson de la pizza prend un certain temps et peut √©chouer si le restaurant manque des ingr√©dients n√©cessaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous obtenons une pizza et mangeons. </font><font style="vertical-align: inherit;">La r√©ception de la pizza peut √©chouer si, par exemple, nous ne pouvons pas payer la commande.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un pseudocode √† l'ancienne utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des fonctions de rappel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pourrait ressembler √† ceci:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{<font></font>
    placeOrder(toppings, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{<font></font>
        collectOrder(order, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
            eatPizza(pizza)<font></font>
        }, failureCallback)<font></font>
    }, failureCallback)<font></font>
}, failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel code est difficile √† lire et √† maintenir (il est souvent appel√© ¬´l'enfer des rappels¬ª ou ¬´l'enfer des rappels¬ª). </font><font style="vertical-align: inherit;">La fonction failureCallback () doit √™tre appel√©e √† chaque niveau d'imbrication. </font><font style="vertical-align: inherit;">Il y a d'autres probl√®mes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons des promesses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses rendent le code plus propre, plus facile √† comprendre et √† prendre en charge. </font><font style="vertical-align: inherit;">Si nous r√©√©crivons le pseudocode √† l'aide de promesses asynchrones, nous obtenons ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{
    <span class="hljs-keyword">return</span> placeOrder(toppings)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{
    <span class="hljs-keyword">return</span> collectOrder(order)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
    eatPizza(pizza)<font></font>
})<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est beaucoup mieux - nous voyons ce qui se passe, nous utilisons un bloc .catch () pour g√©rer toutes les erreurs, la fonction ne bloque pas le flux principal (afin que nous puissions jouer √† des jeux vid√©o en attendant la pizza), chaque op√©ration est garantie d'√™tre effectu√©e une fois la pr√©c√©dente termin√©e. </font><font style="vertical-align: inherit;">Puisque chaque promesse renvoie une promesse, nous pouvons utiliser la cha√Æne .then. </font><font style="vertical-align: inherit;">Super, non? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant les fonctions fl√©ch√©es, le pseudo-code peut √™tre encore simplifi√©:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span><font></font>
    placeOrder(toppings)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span><font></font>
    collectOrder(order)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span><font></font>
    eatPizza(pizza)     <font></font>
)<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou m√™me comme √ßa:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span> placeOrder(toppings))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> collectOrder(order))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span> eatPizza(pizza))<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela fonctionne car () =&gt; x est identique √† () =&gt; {return x}. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez m√™me le faire (puisque les fonctions passent simplement des param√®tres, nous n'avons pas besoin de superposition):</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings().then(placeOrder).then(collectOrder).then(eatPizza).catch(failureCallback)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel code est plus difficile √† lire et ne peut pas √™tre utilis√© avec des constructions plus complexes qu'en pseudocode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: le pseudo-code peut toujours √™tre am√©lior√© en utilisant async / wait, qui sera discut√© dans un prochain article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la base, les promesses sont similaires aux auditeurs d'√©v√©nements, mais avec quelques diff√©rences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une promesse n'est tenue qu'une seule fois (succ√®s ou √©chec). </font><font style="vertical-align: inherit;">Il ne peut pas √™tre ex√©cut√© deux fois ou passer de la r√©ussite √† l'√©chec ou vice versa une fois l'op√©ration termin√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la promesse est termin√©e et que nous ajoutons une fonction de rappel pour traiter son r√©sultat, cette fonction sera appel√©e, malgr√© le fait que l'√©v√©nement se soit produit avant l'ajout de la fonction.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Syntaxe de base des promesses: un exemple r√©el</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de conna√Ætre les promesses car de nombreuses API Web les utilisent dans des fonctions qui ex√©cutent des t√¢ches potentiellement complexes. Travailler avec les technologies Web modernes implique l'utilisation de promesses. Plus tard, nous apprendrons √† r√©diger nos propres promesses, mais pour l'instant, regardons quelques exemples simples qui peuvent √™tre trouv√©s dans l'API Web. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier exemple, nous utilisons la m√©thode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fetch ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour obtenir l'image du r√©seau, la m√©thode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blob ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour convertir le contenu du corps de r√©ponse en un objet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et afficher cet objet √† l'int√©rieur de l'√©l√©ment </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;img&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cet exemple est tr√®s similaire √† l'exemple du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premier article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais nous le ferons un peu diff√©remment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque: l'exemple suivant ne fonctionnera pas si vous l'ex√©cutez simplement √† partir d'un fichier (c'est-√†-dire en utilisant file: // URL). Vous devez l'ex√©cuter via un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur local</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou utiliser des solutions en ligne telles que les </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">pages </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glitch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Tout d'abord, t√©l√©chargez le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code HTML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que nous recevrons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Ajoutez l'√©l√©ment </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;script&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† la fin de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;body&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. √Ä l'int√©rieur de l'√©l√©ment &lt;script&gt;, ajoutez la ligne suivante:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise = fetch(<span class="hljs-string">'coffee.jpg'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode fetch (), qui prend l'URL de l'image comme param√®tre, est utilis√©e pour obtenir l'image du r√©seau. En tant que deuxi√®me param√®tre, nous pouvons sp√©cifier un objet avec des param√®tres, mais pour l'instant nous nous limiterons √† une option simple. Nous stockons la promesse retourn√©e par fetch () dans la variable de promesse. Comme indiqu√© pr√©c√©demment, une promesse est un objet qui repr√©sente un √©tat interm√©diaire - le nom officiel d'un √©tat donn√© est en attente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Pour travailler avec le r√©sultat de la r√©ussite de la promesse (dans notre cas, lorsque la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©ponse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> revient </font><font style="vertical-align: inherit;">), nous appelons la m√©thode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.then ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La fonction de rappel √† l'int√©rieur du bloc .then () (souvent appel√© ex√©cuteur) n'est lanc√©e que lorsque la promesse se termine avec succ√®s et que l'objet Response est renvoy√© - ils disent que la promesse est termin√©e (remplie, remplie). </font><font style="vertical-align: inherit;">La r√©ponse est transmise en tant que param√®tre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Le fonctionnement du bloc .then () est similaire au fonctionnement de l'√©couteur d'√©v√©nement AddEventListener (). </font><font style="vertical-align: inherit;">Il n'est d√©clench√© qu'apr√®s que l'√©v√©nement se soit produit (apr√®s avoir rempli la promesse). </font><font style="vertical-align: inherit;">La diff√©rence entre les deux est que .then () ne peut √™tre appel√© qu'une seule fois, tandis que l'√©couteur est con√ßu pour plusieurs appels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir re√ßu la r√©ponse, nous appelons la m√©thode blob () pour convertir la r√©ponse en un objet Blob. </font><font style="vertical-align: inherit;">Cela ressemble √† ceci:</font></font><br>
<br>
<pre><code class="javascript hljs">response =&gt; response.blob()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... qui est une courte entr√©e pour:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>)</span>{
    <span class="hljs-keyword">return</span> response.blob()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK, assez de mots. </font><font style="vertical-align: inherit;">Ajoutez ce qui suit apr√®s la premi√®re ligne:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise2 = promise.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Chaque appel √† .then () cr√©e une nouvelle promesse. </font><font style="vertical-align: inherit;">Ceci est tr√®s utile: puisque blob () retourne √©galement une promesse, nous pouvons traiter l'objet Blob en appelant .then () sur la deuxi√®me promesse. </font><font style="vertical-align: inherit;">√âtant donn√© que nous voulons faire quelque chose de plus compliqu√© que d'appeler la m√©thode et de renvoyer le r√©sultat, nous devons encapsuler le corps de la fonction entre accolades (sinon, une exception sera lev√©e): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez ce qui suit √† la fin du code:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise3 = promise2.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Compl√©tons le corps de la fonction d'ex√©cution. </font><font style="vertical-align: inherit;">Ajoutez les lignes suivantes aux accolades:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
<span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image.src = objectURL<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous appelons la m√©thode URL.createObjectURL (), en la passant comme param√®tre Blob, qui a renvoy√© la deuxi√®me promesse. </font><font style="vertical-align: inherit;">Nous obtenons un lien vers l'objet. </font><font style="vertical-align: inherit;">Ensuite, nous cr√©ons un √©l√©ment &lt;img&gt;, d√©finissons l'attribut src avec la valeur du lien d'objet et l'ajoutons au DOM pour que l'image apparaisse sur la page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous enregistrez le code HTML et le chargez dans un navigateur, vous verrez que l'image s'affiche comme pr√©vu. </font><font style="vertical-align: inherit;">Bon travail! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Vous avez probablement remarqu√© que ces exemples sont quelque peu artificiels. </font><font style="vertical-align: inherit;">Vous pouvez vous passer des m√©thodes fetch () et blob () et affecter l'URL &lt;img&gt; correspondante, coffee.jpg. </font><font style="vertical-align: inherit;">Nous sommes all√©s de cette fa√ßon pour d√©montrer le travail avec les promesses avec un exemple simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©ponse d'√©chec</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons oubli√© quelque chose - nous n'avons pas de gestionnaire d'erreurs au cas o√π l'une des promesses √©chouerait (sera rejet√©e). </font><font style="vertical-align: inherit;">Nous pouvons ajouter un gestionnaire d'erreurs en utilisant la m√©thode .catch (). </font><font style="vertical-align: inherit;">Faisons cela:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> errorCase = promise3.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour voir cela en action, sp√©cifiez la mauvaise URL de l'image et rechargez la page. </font><font style="vertical-align: inherit;">Un message d'erreur appara√Ætra dans la console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, si nous n'ajoutons pas le bloc .catch (), un message d'erreur sera √©galement affich√© dans la console. </font><font style="vertical-align: inherit;">Cependant .catch () nous permet de g√©rer les erreurs comme nous le voulons. </font><font style="vertical-align: inherit;">Dans une application r√©elle, votre bloc .catch () peut essayer de reprendre l'image ou afficher l'image par d√©faut, ou demander √† l'utilisateur de s√©lectionner une autre image ou de faire autre chose. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Regardez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©mo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fusion de blocs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, l'approche que nous avons utilis√©e pour √©crire le code n'est pas optimale. </font><font style="vertical-align: inherit;">Nous avons d√©lib√©r√©ment choisi cette voie pour que vous puissiez comprendre ce qui se passe √† chaque √©tape. </font><font style="vertical-align: inherit;">Comme indiqu√© pr√©c√©demment, nous pouvons combiner des blocs .then () (et des blocs .catch ()). </font><font style="vertical-align: inherit;">Notre code peut √™tre r√©√©crit comme suit (voir aussi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple-fetch-chained.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur GitHub):</font></font><br>
<br>
<pre><code class="javascript hljs">fetch(<span class="hljs-string">'coffee.jpg'</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())<font></font>
.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {
    <span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
    <span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
    image.src = objectURL<font></font>
    <span class="hljs-built_in">document</span>.body.appendChild(image)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas que la valeur renvoy√©e par la promesse est transmise en tant que param√®tre au prochain ex√©cuteur de fonction du bloc .then (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Les blocs .then () /. Catch () dans promesses sont des √©quivalents asynchrones du bloc synchrone try ... catch. </font><font style="vertical-align: inherit;">N'oubliez pas: synchrone try ... catch ne fonctionnera pas en code asynchrone.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promesse de conclusion terminologique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faisons le point et r√©digeons un petit guide que vous pourrez utiliser √† l'avenir. </font><font style="vertical-align: inherit;">Pour consolider les connaissances, nous vous recommandons de lire la section pr√©c√©dente plusieurs fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Lorsque la promesse est cr√©√©e, ils disent qu'elle est dans un √©tat d'attente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Lorsque la promesse est retourn√©e, ils disent qu'elle a √©t√© r√©alis√©e (r√©solue):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Une promesse accomplie avec succ√®s est appel√©e tenue. </font><font style="vertical-align: inherit;">Il renvoie la valeur qui peut √™tre obtenue via la cha√Æne √† partir de .then () √† la fin de la promesse. </font><font style="vertical-align: inherit;">La fonction d'ex√©cution dans le bloc .then () contient la valeur renvoy√©e par la promesse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Une promesse non remplie est appel√©e rejet√©e. </font><font style="vertical-align: inherit;">Il renvoie la raison, le message d'erreur qui a conduit au rejet de la promesse. </font><font style="vertical-align: inherit;">Cette raison peut √™tre obtenue via le bloc .catch () √† la fin de la promesse.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez le code apr√®s plusieurs promesses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons appris les bases de l'utilisation des promesses. Voyons maintenant des fonctionnalit√©s plus avanc√©es. La cha√Æne de .then () est tr√®s bien, mais que se passe-t-il si nous voulons appeler plusieurs blocs de promesses un par un? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez le faire en utilisant la m√©thode standard Promise.all (). Cette m√©thode prend un tableau de promesses comme param√®tre et renvoie une nouvelle promesse lorsque toutes les promesses du tableau sont remplies. Cela ressemble √† ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([a,b,c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
        ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si toutes les promesses sont remplies, l'ex√©cuteur de tableau du bloc .then () sera pass√© en param√®tre. Si au moins une des promesses n'est pas tenue, le bloc entier sera rejet√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut √™tre tr√®s utile. Imaginez que nous recevions des informations pour remplir dynamiquement l'interface utilisateur avec du contenu sur notre page. Dans de nombreux cas, il est plus raisonnable de recevoir toutes les informations et de les afficher sur la page plus tard que d'afficher les informations en plusieurs parties. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons un autre exemple: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. T√©l√©chargez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un mod√®le de page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et placez la balise &lt;script&gt; avant la balise de fermeture &lt;/body&gt;. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. T√©l√©chargez les fichiers sources ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coffee.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tea.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">description.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ou remplacez-les par les v√¥tres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Dans le script, nous d√©finissons d'abord une fonction qui renvoie les promesses que nous transmettons √† Promise.all (). </font><font style="vertical-align: inherit;">Cela sera facile √† faire si nous ex√©cutons Promise.all () apr√®s avoir termin√© les trois op√©rations fetch (). </font><font style="vertical-align: inherit;">Nous pouvons faire ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> a = fetch(url1)
<span class="hljs-keyword">let</span> b = fetch(url2)
<span class="hljs-keyword">let</span> c = fetch(url3)<font></font>
<font></font>
<span class="hljs-built_in">Promise</span>.all([a, b, c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
    ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la promesse est remplie, la variable ¬´values¬ª contiendra trois objets Response, un pour chaque op√©ration fetch () termin√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous ne voulons pas cela. </font><font style="vertical-align: inherit;">Cela n'a pas d'importance pour nous lorsque les op√©rations fetch () sont termin√©es. </font><font style="vertical-align: inherit;">Ce que nous voulons vraiment, ce sont les donn√©es charg√©es. </font><font style="vertical-align: inherit;">Cela signifie que nous voulons ex√©cuter le bloc Promise.all () apr√®s avoir re√ßu un blob valide repr√©sentant des images et des cha√Ænes de texte valides. </font><font style="vertical-align: inherit;">Nous pouvons √©crire une fonction qui fait cela; </font><font style="vertical-align: inherit;">ajoutez ce qui suit √† votre √©l√©ment &lt;script&gt;:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation '</span> + e.message)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble un peu compliqu√©, alors passons en revue le code √©tape par √©tape: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Tout d'abord, nous d√©clarons une fonction et lui transmettons l'URL et le type du fichier r√©sultant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. La structure de la fonction est similaire √† celle que nous avons vue dans le premier exemple - nous appelons la fonction fetch () pour obtenir le fichier √† une URL sp√©cifique, puis transf√©rons le fichier vers une autre promesse qui retourne le corps de r√©ponse d√©cod√© (lecture). </font><font style="vertical-align: inherit;">Dans l'exemple pr√©c√©dent, c'√©tait toujours la m√©thode blob (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Il y a deux diff√©rences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premi√®rement, la deuxi√®me promesse de retour d√©pend du type de valeur. </font><font style="vertical-align: inherit;">Dans la fonction d'ex√©cution, nous utilisons l'instruction if ... else if pour renvoyer la promesse en fonction du type de fichier que nous devons d√©coder (dans ce cas, nous choisissons entre blob et texte, mais l'exemple peut √™tre facilement √©tendu pour fonctionner avec d'autres types).</font></font></li>
<li>-,     ¬´return¬ª   fetch().       ,     (..   ,  blob()  text(),  ,  ,   ).  ,  return     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. √Ä la fin, nous appelons la m√©thode .catch () pour g√©rer les erreurs qui peuvent se produire dans les promesses du tableau pass√© √† .all (). Si l'une des promesses est rejet√©e, le bloc de capture nous fera savoir quelle promesse √©tait le probl√®me. Le bloc .all () s'ex√©cutera toujours, mais il n'affichera pas les r√©sultats pour lesquels il y a eu des erreurs. Si vous souhaitez que .all () soit rejet√©, ajoutez un bloc .catch () √† la fin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code √† l'int√©rieur de la fonction est asynchrone et bas√© sur des promesses, donc la fonction enti√®re fonctionne comme une promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ensuite, nous appelons notre fonction trois fois pour d√©marrer le processus de r√©ception et de d√©codage des images et du texte, et mettons chacune des promesses dans une variable. Ajoutez ce qui suit:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> coffee = fetchAndDecode(<span class="hljs-string">'coffee.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> tea = fetchAndDecode(<span class="hljs-string">'tea.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> description = fetchAndDecode(<span class="hljs-string">'description.txt'</span>, <span class="hljs-string">'text'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Ensuite, nous d√©clarons un bloc Promise.all () pour ex√©cuter du code uniquement apr√®s que les trois promesses ont √©t√© remplies. </font><font style="vertical-align: inherit;">Ajoutez un bloc avec une fonction d'ex√©cuteur vide √† l'int√©rieur de .then ():</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([coffee, tea, description]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir que cela prend un tableau de promesses comme param√®tre. </font><font style="vertical-align: inherit;">L'entrepreneur ne commencera que lorsque les trois promesses auront √©t√© tenues; </font><font style="vertical-align: inherit;">lorsque cela se produit, le r√©sultat de chaque promesse (le corps de r√©ponse d√©cod√©) sera plac√© dans un tableau, cela peut √™tre repr√©sent√© comme [r√©sultats du caf√©, r√©sultats du th√©, r√©sultats de la description]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Enfin, ajoutez ce qui suit √† l'ex√©cuteur (ici, nous utilisons un code synchrone assez simple pour mettre les r√©sultats dans des variables (cr√©ation d'objets URL √† partir de blob) et afficher des images et du texte sur la page):</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">console</span>.log(values)
<span class="hljs-comment">//       </span>
<span class="hljs-keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="hljs-number">0</span>])
<span class="hljs-keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="hljs-number">1</span>])
<span class="hljs-keyword">let</span> descText = values[<span class="hljs-number">2</span>]<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> image1 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)
<span class="hljs-keyword">let</span> image2 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image1.src = objectURL1<font></font>
image2.src = objectURL2<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image1)
<span class="hljs-built_in">document</span>.body.appendChild(image2)<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> para = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'p'</span>)<font></font>
para.textContent = descText<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(para)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enregistrez les modifications et rechargez la page. Vous devriez voir que tous les composants de l'interface utilisateur se chargent, bien que cela ne semble pas tr√®s attrayant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. Si vous rencontrez des difficult√©s, vous pouvez comparer votre version du code avec la n√¥tre - voici une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©mo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. Afin d'am√©liorer ce code, vous pouvez parcourir les √©l√©ments affich√©s, les recevoir et les d√©coder, puis parcourir les r√©sultats dans Promise.all (), en lan√ßant diff√©rentes fonctions pour afficher chaque r√©sultat en fonction de son type. Cela vous permettra de travailler avec n'importe quel nombre d'√©l√©ments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, vous pouvez d√©terminer le type du fichier r√©sultant sans avoir √† sp√©cifier explicitement la propri√©t√© type. Cela, par exemple, peut √™tre fait avec</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">response.headers.get ('content-type')</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour v√©rifier </font><font style="vertical-align: inherit;">l'en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√™te </font><font style="vertical-align: inherit;">HTTP Protocol </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Content-Type</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez le code apr√®s avoir rempli / rejet√© la promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Souvent, vous devrez peut-√™tre ex√©cuter du code une fois la promesse termin√©e, qu'elle ait √©t√© ex√©cut√©e ou rejet√©e. </font><font style="vertical-align: inherit;">Auparavant, nous devions inclure le m√™me code dans le bloc .then () et le bloc .catch (), par exemple:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
    runFinalCode()<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les navigateurs modernes, la m√©thode .finally () est disponible, ce qui vous permet d'ex√©cuter le code une fois la promesse termin√©e, ce qui √©vite la r√©p√©tition et rend le code plus √©l√©gant. </font><font style="vertical-align: inherit;">Le code de l'exemple pr√©c√©dent peut √™tre r√©√©crit comme suit:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
})<font></font>
.finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir l'utilisation de cette approche avec un exemple r√©el - la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©monstration en direct promise-finally.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Cela fonctionne de la m√™me mani√®re que Promise.all () de l'exemple pr√©c√©dent, sauf que nous ajoutons enfin () √† la fin de la cha√Æne dans la fonction fetchAndDecode ():</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`There has been a problem with your fetch operation for resource "<span class="hljs-subst">${url}</span>": <span class="hljs-subst">${e.message}</span>`</span>)<font></font>
    }).finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`fetch attempt for "<span class="hljs-subst">${url}</span>" finished.`</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous recevrons un message indiquant la fin de chaque tentative d'obtention du fichier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">then () / catch () / finally () est l'√©quivalent asynchrone de synchrone try () / catch () / finally ().</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©diger votre propre promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La bonne nouvelle est que vous savez d√©j√† comment proc√©der. </font><font style="vertical-align: inherit;">Lorsque vous combinez plusieurs promesses avec .then () ou les combinez pour fournir des fonctionnalit√©s sp√©cifiques, vous cr√©ez vos propres fonctions asynchrones et bas√©es sur les promesses. </font><font style="vertical-align: inherit;">Prenons par exemple notre fonction fetchAndDecode () de l'exemple pr√©c√©dent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La combinaison de diverses API bas√©es sur des promesses pour cr√©er des fonctionnalit√©s sp√©cifiques est la fa√ßon la plus courante de travailler avec des promesses, ce qui montre la flexibilit√© et la puissance des API modernes. </font><font style="vertical-align: inherit;">Cependant, il existe un autre moyen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promesse du constructeur ()</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez cr√©er votre propre promesse √† l'aide du constructeur Promise (). Cela peut √™tre n√©cessaire dans une situation o√π vous avez du code de l'ancienne API asynchrone que vous devez ¬´surdimensionner¬ª. Ceci est fait afin de pouvoir travailler simultan√©ment √† la fois avec du code, des biblioth√®ques ou des ¬´frameworks¬ª existants et anciens, et avec un nouveau code bas√© sur des promesses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons un exemple simple - ici, nous encapsulons l'appel setTimeout () dans une promesse - cela d√©marrera la fonction en 2 secondes, qui remplira la promesse (en utilisant l'appel resolver () pass√©) avec la cha√Æne ¬´Success!¬ª.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
        resolve(<span class="hljs-string">'Success!'</span>)<font></font>
    }, <span class="hljs-number">2000</span>)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
resolver () et rejeter () sont des fonctions appel√©es √† remplir ou √† rejeter une nouvelle promesse. </font><font style="vertical-align: inherit;">Dans ce cas, la promesse est remplie avec la cha√Æne "Success!". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous appelez cette promesse, vous pouvez y ajouter un bloc .then () pour continuer √† travailler avec la ligne ¬´Success!¬ª. </font><font style="vertical-align: inherit;">Nous pouvons donc sortir une ligne dans le message:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise<font></font>
.then(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {<font></font>
    alert(message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ou alors:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise.then(alert)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©mo en direct</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple donn√© n'est pas tr√®s flexible - la promesse ne peut √™tre remplie qu'avec une simple ligne, nous n'avons pas de gestionnaire d'erreur - rejette () (en fait, setTimeout () n'a pas besoin d'un gestionnaire d'erreur, donc dans ce cas, cela n'a pas d'importance). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Pourquoi r√©soudre () plut√¥t que r√©aliser ()? </font><font style="vertical-align: inherit;">Pour le moment, la r√©ponse est la suivante: c'est difficile √† expliquer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous travaillons avec un rejet d'une promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons cr√©er une promesse rejet√©e en utilisant la m√©thode rejeter () - tout comme resolver (), rejeter () prend une valeur simple, mais contrairement √† resolver (), la valeur simple n'est pas le r√©sultat, mais la raison du rejet, c'est-√†-dire </font><font style="vertical-align: inherit;">une erreur transmise au bloc .catch (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©veloppons l'exemple pr√©c√©dent en ajoutant une condition de rejet d'une promesse, ainsi que la possibilit√© de recevoir des messages autres qu'un message de r√©ussite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenez l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemple pr√©c√©dent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et r√©√©crivez-le comme ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timeoutPromise</span>(<span class="hljs-params">message, interval</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span>(message === <span class="hljs-string">''</span> || <span class="hljs-keyword">typeof</span> message !== <span class="hljs-string">'string'</span>){<font></font>
            reject(<span class="hljs-string">'Message is empty or not a string'</span>)<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(interval &lt; <span class="hljs-number">0</span> || <span class="hljs-keyword">typeof</span> interval !== number){<font></font>
            reject(<span class="hljs-string">'Interval is negative or not a number'</span>)<font></font>
        } <span class="hljs-keyword">else</span>{<font></font>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
                resolve(message)<font></font>
            }, interval)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous passons deux arguments √† la fonction - message et intervalle (temporisation). </font><font style="vertical-align: inherit;">Dans une fonction, nous retournons un objet Promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le constructeur Promise, nous effectuons plusieurs v√©rifications en utilisant les structures if ... else:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, nous v√©rifions le message. </font><font style="vertical-align: inherit;">S'il est vide ou n'est pas une cha√Æne, nous rejetons la promesse et signalons une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, nous v√©rifions le d√©lai. </font><font style="vertical-align: inherit;">S'il s'agit d'un nombre n√©gatif ou non, nous rejetons √©galement la promesse et signalons une erreur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, si les deux arguments sont OK, affichez le message apr√®s un certain temps (intervalle) √† l'aide de setTimeout ().</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque timeoutPromise () renvoie une promesse, nous pouvons y ajouter .then (), .catch (), etc. pour am√©liorer sa fonctionnalit√©. </font><font style="vertical-align: inherit;">Faisons cela:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise(<span class="hljs-string">'Hello there!'</span>, <span class="hljs-number">1000</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {<font></font>
    alert(message)<font></font>
}).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error: '</span> + e)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir enregistr√© les modifications et ex√©cut√© le code, vous verrez un message apr√®s une seconde. </font><font style="vertical-align: inherit;">Essayez maintenant de passer une cha√Æne vide comme message ou un nombre n√©gatif comme intervalle. </font><font style="vertical-align: inherit;">Vous verrez un message d'erreur √† la suite du rejet de la promesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Vous pouvez trouver notre version de cet exemple sur GitHub - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">custom-promise2.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple plus r√©aliste.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple que nous avons examin√© facilite la compr√©hension du concept, mais il n'est pas vraiment asynchrone. L'asynchronie dans l'exemple est simul√©e √† l'aide de setTimeout (), bien qu'elle montre encore l'utilit√© des promesses pour la cr√©ation de fonctions avec un flux de travail raisonnable, une bonne gestion des erreurs, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple d'une application asynchrone utile qui utilise le constructeur Promise () est la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioth√®que idb (IndexedDB with usability)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jake Archibald. </font><font style="vertical-align: inherit;">Cette biblioth√®que vous permet d'utiliser l'API IndexedDB (bas√©e sur les fonctions de rappel d'API pour le stockage et la r√©cup√©ration de donn√©es c√¥t√© client), √©crite dans l'ancien style, avec des promesses. </font><font style="vertical-align: inherit;">Si vous regardez le fichier de biblioth√®que principal, vous verrez qu'il utilise les m√™mes techniques que nous avons examin√©es ci-dessus. </font><font style="vertical-align: inherit;">Le code suivant convertit le mod√®le de requ√™te de base utilis√© par de nombreuses m√©thodes IndexedDB en un mod√®le compatible avec les promesses:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promisifyRequest</span>(<span class="hljs-params">request</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{<font></font>
        request.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            resolve(request.result)<font></font>
        }<font></font>
<font></font>
        request.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            reject(request.error)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ajoute quelques gestionnaires d'√©v√©nements qui remplissent ou rejettent la promesse, selon le cas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque la demande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aboutit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le gestionnaire onsuccess remplit la promesse avec le r√©sultat de la demande.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque la demande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©choue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le gestionnaire onerror rejette la promesse avec l'erreur de la demande.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses sont un excellent moyen de cr√©er des applications asynchrones lorsque nous ne savons pas quelle valeur la fonction renverra ni combien de temps cela prendra. Ils vous permettent de travailler avec une s√©quence d'op√©rations asynchrones sans utiliser de fonctions de rappel profond√©ment imbriqu√©es, et ils prennent en charge le style de gestion des erreurs de l'instruction try ... catch synchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les promesses sont prises en charge par tous les navigateurs modernes. La seule exception est Opera Mini et IE11 et ses versions ant√©rieures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous avons consid√©r√© loin de toutes les caract√©ristiques des promesses, seules les plus int√©ressantes et utiles. Vous apprendrez √† conna√Ætre d'autres fonctionnalit√©s et techniques si vous souhaitez en savoir plus sur les promesses.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des API Web modernes sont bas√©es sur des promesses, donc les promesses doivent √™tre connues. </font><font style="vertical-align: inherit;">Parmi ces API Web, nous pouvons nommer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web Audio API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Media Capture and Streams</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. Les promesses deviendront de plus en plus populaires, donc leur √©tude et leur compr√©hension sont une √©tape importante vers la ma√Ætrise du JavaScript moderne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voir √©galement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Erreurs courantes dans les promesses JavaScript que tout le monde devrait conna√Ætre¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci de votre attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La critique constructive est la bienvenue.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488750/index.html">Promenade des dinosaures: deux grands ordinateurs du XXe si√®cle</a></li>
<li><a href="../fr488752/index.html">Golang + Phaser3 = MMORPG - Nous jetons les bases de la g√©n√©ration sans fin du monde</a></li>
<li><a href="../fr488754/index.html">Tout √† la fois: v√©rification automatique de la taille du lot</a></li>
<li><a href="../fr488756/index.html">Comment travailler avec l'API Google Sheets (Google Sheets API v4) dans R en utilisant le nouveau package googlesheets4</a></li>
<li><a href="../fr488758/index.html">Conf√©rence DEFCON 27. Reconnaissance des escroqueries sur Internet</a></li>
<li><a href="../fr488766/index.html">Art et technologie: Universit√© du Massachusetts √† Lowell</a></li>
<li><a href="../fr488768/index.html">Enfer sanglant, ou Comment jurer en anglais pour √™tre confondu avec une personne cultiv√©e</a></li>
<li><a href="../fr488776/index.html">Am√©liorations de l'accessibilit√© dans Visual Studio 2019 pour Mac</a></li>
<li><a href="../fr488778/index.html">Structures de donn√©es: une liste qui peut tout faire *</a></li>
<li><a href="../fr488780/index.html">Mozilla a perdu dans la guerre des navigateurs, mais croit toujours qu'il pourrait sauver Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>