<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ä ü§µüèø üëµüèΩ Using RabbitMQ with MonsterMQ Part 1 üëåüèº üàÇÔ∏è üòô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is intended for those who are not familiar with queues and RabbitMQ yet. Those who already know how to work with RabbitMQ and only want t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Using RabbitMQ with MonsterMQ Part 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488850/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article is intended for those who are not familiar with queues and RabbitMQ yet. </font><font style="vertical-align: inherit;">Those who already know how to work with RabbitMQ and only want to explore the possibilities that MonsterMQ provides, I recommend visiting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the project page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on github.com, where the description describes in detail how you can use MonsterMQ without describing the basics of working with RabbitMQ. </font><font style="vertical-align: inherit;">The rest of this article will cover the basics of how RabbitMQ works with MonsterMQ.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RabbitMQ is a message broker. It receives, stores and forwards messages to its customers. Clients senders and recipients of messages can serve, for example, applications written in PHP. Communication between the client and RabbitMQ occurs according to certain rules called AMQP (Advanced Message Queuing Protocol). For example, communication between your browser and the web server on which this article is located also follows certain rules, they are called HTTP (HyperText Transfer Protocol) - a hypertext transfer protocol. Both HTTP and AMQP are client-server protocols, that is, they mean the presence of a client and a server. RabbitMQ is an AMQP server, and MonsterMQ is a library that allows you to quickly write an AMQP client in PHP, which will communicate with the AMQP server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMQP and RabbitMQ use the following terms: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Producing - means to send messages, Producer (supplier) - the one who sends messages. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/093/98a/3af/09398a3afdf46d8e58c6c2f253037017.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consuming - means to receive messages. </font><font style="vertical-align: inherit;">Consumer - the one who receives messages. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/918/3b0/d5e/9183b0d5e55eccdd919dee359a50d776.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queue is the queue. </font><font style="vertical-align: inherit;">Before reaching the consumer and after it was sent by the supplier, the message is stored in a queue inside RabbitMQ. </font><font style="vertical-align: inherit;">The queue is a buffer that stores messages. </font><font style="vertical-align: inherit;">Many providers can send messages in one queue, and many consumers can read messages from one queue. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9d5/99c/8b9/9d599c8b96684a7a58e2aec05e6416b4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that the provider, consumer and broker do not have to be on the same host, on the contrary they are usually located on different.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello world</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later in this article, we will write two programs in PHP using the MonsterMQ library, one of which will send messages, and the other will receive and output them to the console. </font><font style="vertical-align: inherit;">In the figure below, ‚ÄúP‚Äù is the provider, ‚ÄúC‚Äù is the consumer, red boxes are the queue that is the message buffer (each box is the message). </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2d8/ca1/fc0/2d8ca1fc0dce6c0c23e4524148027680.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Image taken from the official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For further work, we need to install MonsterMQ, to do this, enter the following command in the console:</font></font><br>
<br>
<pre><code class="bash hljs">composer require goootlib/monster-mq:dev-master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(More about installing MonsterMQ can be found on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the project page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on github.com) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will install MonsterMQ in the current folder.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Departure</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will call our sender </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the recipient </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receive.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The sender will join the server and send the message. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To join the server, write the following code in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $producer = \MonsterMQ\Client\Producer();<font></font>
<font></font>
   $producer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $producer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this code, we join RabbitMQ running on a local server on a standard port. </font><font style="vertical-align: inherit;">Specify other ip-address and port if RabbitMQ is running on your other address. </font><font style="vertical-align: inherit;">After the connection, we also call the logIn () method, which starts the session with the standard login and password. </font><font style="vertical-align: inherit;">If you have an account with a different username and password configured in RabbitMQ, specify them here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To send a message, we must declare the queue in which it will first be placed. </font><font style="vertical-align: inherit;">After the queue is announced, we can send a message:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $producer = \MonsterMQ\Client\Producer();<font></font>
<font></font>
   $producer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $producer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'test-queue'</span>)-&gt;declare();<font></font>
   $producer-&gt;publish(<span class="hljs-string">'my-message'</span>, <span class="hljs-string">'test-queue'</span>);<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The queue declaration is idempotent, that is, it will not create and will not change the queue, if it already exists. </font><font style="vertical-align: inherit;">After we complete the session and join.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $producer = \MonsterMQ\Client\Producer();<font></font>
<font></font>
   $producer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $producer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'test-queue'</span>)-&gt;declare();<font></font>
   $producer-&gt;publish(<span class="hljs-string">'Test message'</span>, <span class="hljs-string">'test-queue'</span>);<font></font>
<font></font>
   $producer-&gt;disconnect();<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive message</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unlike the sender, the recipient will remain running in order to listen to incoming messages. </font><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receive.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code, </font><b><font style="vertical-align: inherit;">you</font></b><font style="vertical-align: inherit;"> first need to do the same as in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $consumer-&gt;queue(<span class="hljs-string">'test-queue'</span>)-&gt;declare();<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receive.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we also declare our queue, this is so that the recipient declares the queue if it is started before the sender. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to tell the server that we want to receive a message from it, as well as to start a cycle that will wait and process incoming messages, we will write the following code:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $consumer-&gt;queue(<span class="hljs-string">'test-queue'</span>)-&gt;declare();<font></font>
<font></font>
   $consumer-&gt;consume(<span class="hljs-string">'test-queue'</span>);<font></font>
<font></font>
   $consumer-&gt;wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$message, $channelNumber</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$consumer</span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"Message - {$message} received on channel {$channelNumber}"</span>;<font></font>
   });<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can run both scripts as the recipient:</font></font><br>
<br>
<pre><code class="bash hljs">php receive.php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
so sender:</font></font><br>
<br>
<pre><code class="bash hljs">php send.php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The recipient will output to the console the message that he will receive from RabbitMQ (which in turn will receive it from send.php) and the channel number used. </font><font style="vertical-align: inherit;">It will continue to be executed until you close the terminal, or until you stop executing it by pressing Ctrl + C. </font><font style="vertical-align: inherit;">By launching the sender in another terminal, you can observe how messages are delivered to the recipient and displayed in the console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to see which, at the moment, RabbitMQ contains queues and how many messages are in them, you can do this as a privileged user using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rabbitmqctl</font></font></b><br>
<pre><code class="bash hljs">sudo rabbitmqctl list_queues</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On windows do not use sudo</font></font><br>
<pre><code class="bash hljs">rabbitmqctl.bat list_queues</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are ready to move on to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">next part of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> our lessons.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488836/index.html">Some aspects of working with Dictionary when developing loaded applications</a></li>
<li><a href="../en488842/index.html">Catch an electron: observing a process that takes a quintillionth of a second</a></li>
<li><a href="../en488844/index.html">Borders for border guards: US court has established rules for checking devices - discuss the situation</a></li>
<li><a href="../en488846/index.html">Postgresso 19</a></li>
<li><a href="../en488848/index.html">CTO all startup</a></li>
<li><a href="../en488852/index.html">Configuring the loss function for a neural network based on seismic data</a></li>
<li><a href="../en488854/index.html">10. Fortinet Getting Started v6.0. Escort</a></li>
<li><a href="../en488856/index.html">Well CRM and CRM. Everything is easier than you think.</a></li>
<li><a href="../en488860/index.html">Import substitution and shipbuilding</a></li>
<li><a href="../en488866/index.html">Validating Images with Gitlab CI / CD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>