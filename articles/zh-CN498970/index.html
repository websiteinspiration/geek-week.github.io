<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏼 👩‍💼 👨‍👩‍👦‍👦 Kubernetes ConfigMaps：要知道的细节 🌛 🤫 😨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注意：这不是完整的指南文章，而是对已经在Kubernetes中使用ConfigMap或只是准备其应用程序以供使用的那些人的提醒/提示。
 
 
 
 背景：从rsync到... Kubernetes
 之前发生什么事了？在“经典管理”时代，最简单的版本是将配置文件放置在应用程序的旁边（如果需要，也可...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps：要知道的细节</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：这不是完整的指南文章，而是对已经在Kubernetes中使用ConfigMap或只是准备其应用程序以供使用的那些人的提醒/提示。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景：从rsync到... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之前发生什么事了？在“经典管理”时代，最简单的版本是将配置文件放置在应用程序的旁边（如果需要，也可以放置在存储库中）。很简单：我们为代码和配置一起制作基本交付（CD）。甚至有条件的rsync实现都可以称为CD的雏形。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随着基础架构的发展，不同的环境（开发/阶段/生产）需要不同的配置。对应用程序进行了培训，以了解使用哪个配置，并将它们作为启动参数或环境中设置的环境变量传递。随着这样有用的Chef / Puppet / Ansible的出现，更多的CD变得更加复杂。角色出现在服务器上，环境不再在不同的地方描述-我们来到IaC（即代码基础架构）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来是什么？如果有可能看到Kubernetes本身的关键优势，甚至需要修改应用程序使其在这种环境下工作，那么迁移就发生了。顺便说一句，我期望在架构的构造上有细微的差别和差异，但是当我设法应付主要部分时，我得到了期待已久的在K8s中运行的应用程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到达这里后，我们仍然可以使用在应用程序旁边的存储库中准备的配置，或者将ENV传递给容器。</font><font style="vertical-align: inherit;">但是，除了这些方法之外，还可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这个K8s原语允许您在配置中使用Go模板，即 </font><font style="vertical-align: inherit;">呈现它们就像HTML页面一样，并在更改配置时重新加载应用程序而无需重新启动。</font><font style="vertical-align: inherit;">有了ConfigMap，不再需要为不同的环境保留3个以上的配置并跟踪每个环境的相关性。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到ConfigMap的一般介绍</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在本文中，我将重点介绍与它们合作的一些功能。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单的ConfigMap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes中的配置是什么样的？</font><font style="vertical-align: inherit;">他们从模板中得到了什么？</font><font style="vertical-align: inherit;">例如，这是从Helm图表部署的应用程序的普通ConfigMap：</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此处的值替换为</font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并将</font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从文件中获取</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">为什么确切地来自</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">Go模板引擎如何工作？</font><font style="vertical-align: inherit;">我们已经在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更详细地讨论了这些细节</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该呼叫</font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有助于从地图中选择必要的路线：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，您可以同时使用配置的特定行和整个片段。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，ConfigMap可能像这样：</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...以及</font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-以下内容：</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这里涉及的</font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是环境的名称。</font><font style="vertical-align: inherit;">在部署期间替换此值，可以使用不同的内容呈现ConfigMap。</font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里需要，因为 </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回一个列表，其第一个元素包含所需的值。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当有很多配置时</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一个ConfigMap可以包含多个配置文件：</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您甚至可以分别挂载每个配置：</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...或使用目录一次获取所有配置：</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果在部署期间更改部署资源的描述，Kubernetes将创建一个新的ReplicaSet，将旧的ReplicaSet减少到0，并将新的ReplicaSet增加到指定的副本数。</font><font style="vertical-align: inherit;">（对于部署策略而言确实如此</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此类操作将导致使用新的描述重新创建Pod。</font><font style="vertical-align: inherit;">例如：有一个图像</font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但变为- </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">而且，我们对部署的描述中所做的更改完全没有关系：主要的是，这导致重新创建了copySet（以及结果是pod）。</font><font style="vertical-align: inherit;">在这种情况下，新版本的应用程序中的配置文件的新版本会自动挂载，不会有问题。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap更改响应</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果ConfigMap发生更改，则可以遵循四个事件方案。</font><font style="vertical-align: inherit;">考虑他们：</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap’,   Deployment,   pod  ,   —        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod’   / pod’.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将更详细地分析。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">场景1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">纠正了ConfigMap吗？</font><font style="vertical-align: inherit;">该应用程序将不会重新启动。</font><font style="vertical-align: inherit;">在进行安装的情况下，</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">除非手动重启吊舱</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">否则不会进行任何更改。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切都很简单：Kubernetes将ConfigMap挂载到特定版本资源的pod中。</font><font style="vertical-align: inherit;">由于已安装</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此不再提供对配置的其他“影响”。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方案2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不重新创建Pod便无法更新文件吗？</font><font style="vertical-align: inherit;">好的，我们在Deployment中有6个副本，因此我们可以轮流手动进行所有操作</font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">然后，在创建新容器时，它们将“拾取”新版本的ConfigMap。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
厌倦了手动执行此类操作？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm提示和技巧中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述了此问题的解决方案</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，</font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅将呈现的注释配置</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">哈希值写入</font><font style="vertical-align: inherit;">pod（</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">模板中</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注释是任意键值字段，您可以在其中存储值。</font><font style="vertical-align: inherit;">如果将它们注册到</font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将来的Pod </font><font style="vertical-align: inherit;">模板中</font><font style="vertical-align: inherit;">，则这些字段将属于ReplicaSet和Pod本身。</font><font style="vertical-align: inherit;">Kubernetes将注意到pod模板已更改（因为sha256配置已更改）并且将启动</font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中除此注释外没有其他更改。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，我们保存了相同版本的Deployment的应用程序和描述，并且实际上只是触发了pod的自动重新创建-类似于我们手动完成操作</font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但已经“正确”地进行了操作：自动并使用</font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方案4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也许应用程序已经知道如何监视配置中的更改并自动重新加载？</font><font style="vertical-align: inherit;">这是ConfigMaps的一个重要功能... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Kubernetes中，如果使用config进行安装</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则在重启pod之前，它不会被更新</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（请参见上面讨论的前三个方案）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，如果将ConfigMap挂载为不带的目录，</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">则容器内将存在一个目录，其中包含更新的配置，而无需重新启动pod。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有其他一些要记住的功能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容器内部的此类更新的配置文件会有所延迟。</font><font style="vertical-align: inherit;">这是由于文件未完全挂载，而是Kubernetes对象挂载。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">里面的文件是一个符号链接。</font><font style="vertical-align: inherit;">范例</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有</font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录挂载时</font><font style="vertical-align: inherit;">会发生什么</font><font style="vertical-align: inherit;">？</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新配置（通过deploy或</font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），等待2分钟（apiserver缓存时间），然后瞧：</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意Kubernetes创建的目录中更改的时间戳。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变更追踪</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，一个简单的示例，说明如何监视配置中的更改。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将使用这样的Go应用程序</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...使用这样的配置添加它：</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果运行，日志将为：</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们将这个应用程序安装在Kubernetes中，并将ConfigMap配置而不是映像中的文件安装在pod中。</font><font style="vertical-align: inherit;">在GitHub上</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">准备</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">了Helm图表</font></a><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">示例</font></a><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并仅更改ConfigMap：</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，更新集群中的Helm图表，如下所示：</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
会发生什么？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应用程序v1和v2无法重新启动，因为 </font><font style="vertical-align: inherit;">对于他们来说，部署没有任何变化-他们仍然欢迎Alice。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v3应用程序重新启动，重新读取配置，并向Bob致意。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4应用程序未重新启动。</font><font style="vertical-align: inherit;">由于ConfigMap是作为目录挂载的，因此可以注意到配置中的更改，并且可以即时更改配置，而无需重新启动Pod。</font><font style="vertical-align: inherit;">是的，应用程序在我们的简单示例中注意到了更改-请参阅来自</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的事件消息</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看如何在更成人的项目（也就是“真实”项目）中解决类似情况（跟踪ConfigMap的更改）</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还记得本文中的所有上述内容对于Kubernetes（</font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">中的Secret'ov也是适用的</font><font style="vertical-align: inherit;">：它们与ConfigMap如此相似并非没有道理……</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奖金！</font><font style="vertical-align: inherit;">第三方解决方案</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您对跟踪配置中的更改感兴趣，则已经有现成的实用程序可用于此：</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果文件已更改，则发送HTTP请求。</font><font style="vertical-align: inherit;">开发人员还计划教SIGHUP发送，但是从2019年10月开始缺乏提交使这些计划成为问题;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">监视ConfigMap / Secrets并对其关联的资源执行滚动升级（如其作者所说）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用附带的现有应用程序的容器启动此类应用程序将很方便。</font><font style="vertical-align: inherit;">但是，如果您知道Kubernetes / ConfigMap和配置的功能不是``实时''（通过</font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">编辑</font><font style="vertical-align: inherit;">，而是仅作为部署的一部分...那么这些实用程序的功能似乎是多余的，即 </font><font style="vertical-align: inherit;">复制基本功能。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随着Kubernetes中ConfigMap的出现，配置进入了下一轮开发：模板引擎的使用为它们带来了与HTML页面呈现相当的灵活性。</font><font style="vertical-align: inherit;">幸运的是，这种复杂性并没有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取代</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现有的解决方案，而是成为其</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">补充</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，对于认为新功能多余的管理员（甚至是开发人员），仍然可以使用好的旧文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于已经使用ConfigMap或仅查看ConfigMap的用户，本文简要概述了它们的本质和使用的细微差别。</font><font style="vertical-align: inherit;">如果您对这个主题有自己的提示和技巧-我会很高兴在评论中看到。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另请参阅我们的博客：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将应用程序移植到Kubernetes时的本地文件</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   Kubernetes  Helm:    </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN498944/index.html">狗，还是不做镜子的电报</a></li>
<li><a href="../zh-CN498948/index.html">龙的时间。与难题的自我隔离</a></li>
<li><a href="../zh-CN498952/index.html">我们邀请DINS JS EVENING：我们正在谈论面向方面的编程和Vuejs 3 composition API框架</a></li>
<li><a href="../zh-CN498958/index.html">错误不是UIAlertController</a></li>
<li><a href="../zh-CN498962/index.html">关于多任务：受控制的窗口</a></li>
<li><a href="../zh-CN498974/index.html">冠状病毒：不安全的危险幻想</a></li>
<li><a href="../zh-CN498976/index.html">.NET 5.0预览版3简介</a></li>
<li><a href="../zh-CN498978/index.html">使用Graylog和NLog从C＃应用程序收集日志。个人经验</a></li>
<li><a href="../zh-CN498982/index.html">Dreamcast的软盘</a></li>
<li><a href="../zh-CN498984/index.html">隐形学校：隐形游戏中的5种小工具</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>