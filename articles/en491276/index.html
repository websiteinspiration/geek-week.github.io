<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåú üòù üôÜüèª How I circumvented the ban on Messages API through the Vkontakte documentation üôèüèΩ ‚è≥ ‚óΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to the entire Habro community. For me, this first article is written under a certain euphoria, so please do not judge this article too strictly ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How I circumvented the ban on Messages API through the Vkontakte documentation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491276/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello to the entire Habro community. </font><font style="vertical-align: inherit;">For me, this first article is written under a certain euphoria, so please do not judge this article too strictly for the literary part. </font><font style="vertical-align: inherit;">But well, fewer words and get down to business.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it all began</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We all know that VC has an API, and I‚Äôm sure that most people tried to use it for their own purposes. </font><font style="vertical-align: inherit;">Personally, I have a lot of projects related to it: pieces of 5 powerful bots, compiling large-scale datasets from group posts, etc. </font><font style="vertical-align: inherit;">And it is not surprising that my friends asked me a couple of times to download songs from the attachments of the dialogue, photos, or save the text of correspondence with some person in a separate file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But once the ‚Äúit‚Äù came, and from that moment the implementation of such small requests ceased to be a trivial task: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c41/913/d6c/c41913d6cfb47f8acff5c3145502c4e5.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, a couple of days ago, to get rid of this problem once and for all, I decided to write my wrapper via http requests, pretending to be a regular user, so that have the same powerful tool as the official API for the messages section.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's get down to business</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, I started with authorization. </font><font style="vertical-align: inherit;">Armed with the https sniffer and Firefox, I was able to go through all the ‚Äústeps‚Äù of authorization and get the final cookies. </font><font style="vertical-align: inherit;">From now on, it only remained to understand how queries were made. </font><font style="vertical-align: inherit;">It was found that most of the data is received by a POST request from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://vk.com/wkview.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , just the parameters for different situations change each time. </font><font style="vertical-align: inherit;">I managed to write functions for pumping out absolutely all types of investments, but we will not go into details of this, because at one moment everything changed dramatically.</font></font><br>
<blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link to the file for receiving authorization cookies (I wrote it only for two-factor authentication, since it costs most people)</font></font></a></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unexpected discovery</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was working on a laptop when a friend came up to me and asked what I was doing. Since I couldn‚Äôt explain to him the whole problem quickly on my fingers, I opened the official documentation on the messages section, and was stunned when I saw what is under the main description of these ‚Äúforbidden‚Äù methods: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e14/077/91c/e1407791c9c79301b94f9f73c58fe5dd.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, you understand me correctly, I'm not the first just see this opportunity. I used it many times with other methods, but I couldn‚Äôt even think that the function ‚Äúsample request‚Äù would remain with the methods of the messages section. And even stronger was my surprise when I scrambled the traffic. These were just ordinary API requests, only on the site, which only slightly different parameter names in the web form and had some kind of hash-ID.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/39d/68c/a1b/39d68ca1b65fec086d6f3be18578ef91.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a few minutes, I realized that the hash-ID is just a string located in the data-hash attribute of the button tag, and after a couple of minutes I was already trying hard to implement emulation of ‚Äútest requests‚Äù and did not fully believe that it would work. </font><font style="vertical-align: inherit;">After all, for sure these requests have some kind of limit on the number or something like that. </font><font style="vertical-align: inherit;">But what was my surprise when this script in 30 lines (not counting the receipt of cookies), which was written on my knees, was able to pump out a half thousand pictures from the dialogue attachments in 4 minutes.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2f8/d30/555/2f8d3055586c0d8a63f6898c1173319e.jpg" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I apply the used code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> requests, pickle, re, json<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'cookies_vk_auth.pickle'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> handle:<font></font>
    cookies_final = pickle.load(handle)<font></font>
<font></font>
session = requests.Session()<font></font>
peer_id = int(input(<span class="hljs-string">'  :  '</span>))<font></font>
<font></font>
response = session.get(<span class="hljs-string">f'https://vk.com/dev/messages.getHistoryAttachments'</span>, cookies=cookies_final)<font></font>
hash_data =  re.findall(<span class="hljs-string">r'data-hash="(\S*)"'</span>, response.text)[<span class="hljs-number">0</span>]<font></font>
<font></font>
session = requests.Session()<font></font>
response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)<font></font>
<font></font>
count=<span class="hljs-number">20</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">200</span>):<font></font>
    response_json = json.loads(json.loads(response.text[<span class="hljs-number">4</span>:])[<span class="hljs-string">'payload'</span>][<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])[<span class="hljs-string">'response'</span>][<span class="hljs-string">'items'</span>]<font></font>
<font></font>
    <span class="hljs-keyword">for</span> photo <span class="hljs-keyword">in</span> response_json:<font></font>
        ph = photo[<span class="hljs-string">'attachment'</span>][<span class="hljs-string">'photo'</span>][<span class="hljs-string">'sizes'</span>][<span class="hljs-number">-1</span>][<span class="hljs-string">'url'</span>]<font></font>
        r = session.get(ph, timeout=<span class="hljs-number">10</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">with</span> open(<span class="hljs-string">f'D://dev/'</span>+str(ph.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">-1</span>]), <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
                f.write(r.content)<font></font>
<font></font>
    m_id = photo[<span class="hljs-string">'message_id'</span>]<font></font>
    response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_start_from=<span class="hljs-subst">{m_id}</span>&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was so impressed that at this point I decided to cool down and try to implement some other method (all of a sudden I was just mistaken). </font><font style="vertical-align: inherit;">I took up the History method and the result was similar. </font><font style="vertical-align: inherit;">Only I had to set a delay of 0.1 seconds so that the server did not give an error about too many requests. </font><font style="vertical-align: inherit;">(If someone repeats, please remember that when changing the method you also need to change the url to the documentation, where hash-data comes from). </font><font style="vertical-align: inherit;">That is, this method really made it possible to access the messages section through official documentation, using only the password and user login. </font><font style="vertical-align: inherit;">For reliability, I tried to do the same steps on another account and got the same result.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, I think, everyone has already realized that this is a breach in the protection of our personal data, which has been hanging in the documentation for a year and it is not known how many people have already used it. </font><font style="vertical-align: inherit;">Moreover, this gap is very large, and it needs to be closed soon. </font><font style="vertical-align: inherit;">And in order to prove once again that this should not work this way, I will quote the VK developers themselves:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you plan to start developing a messenger, after February 15, 2019, you will need to get test access in Support, which implies the work of the methods of the Messages section with the keys of the administrators of your Standalone application.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, even to obtain a token of an internal application that will have access to the user's correspondence, you need a personal permission from VK, let alone access with a regular password and login. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My personal opinion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The prohibition of the messages section did not bring any fundamental changes to the security of users. </font><font style="vertical-align: inherit;">He just designated the border and cut off a group of "under-hackers" who, without even understanding what they were doing, could gain full access to the data. </font><font style="vertical-align: inherit;">For the rest of the people, more experienced in programming, gaining access to correspondence is just a matter of time. </font><font style="vertical-align: inherit;">And in the first part of the article, I proved by my own example, having created a program for pumping out attachments, that the emergence of a library that can pretend to be a user is not far off. </font><font style="vertical-align: inherit;">Maybe I myself will bring it to the end, and VK developers need to be prepared for this and come up with ways to recognize too suspicious user activity if the privacy of our data is really important for them.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><div class="spoiler_text">       ,      )     ,       .<br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491262/index.html">An eye for an eye. Biometrics Issues</a></li>
<li><a href="../en491264/index.html">Introduction to SSD. Part 4. Physical</a></li>
<li><a href="../en491266/index.html">SurfingAttack: compromising smartphones with sound assistants [+ video]</a></li>
<li><a href="../en491268/index.html">Monte Carlo Methods for Markov Chains (MCMC). Introduction</a></li>
<li><a href="../en491272/index.html">Website development in pascal (backend)</a></li>
<li><a href="../en491278/index.html">CLRium # 7: Reports, Practice, Mentors</a></li>
<li><a href="../en491280/index.html">The story of how I developed a programming language</a></li>
<li><a href="../en491282/index.html">How to increase team productivity (and reduce errors) using rallies</a></li>
<li><a href="../en491284/index.html">Analysis: what is fundamental analysis</a></li>
<li><a href="../en491286/index.html">IPv6 only networks in US government</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>