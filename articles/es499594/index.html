<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äç‚öñÔ∏è üê° üëáüèª C√≥mo limitar la frecuencia de las solicitudes en HAProxy: instrucciones paso a paso üîò „äóÔ∏è üë©üèø‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El autor explica c√≥mo implementar en el l√≠mite de velocidad de consulta HAProxy (limitaci√≥n de velocidad) con ciertas direcciones IP. El equipo de Mai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥mo limitar la frecuencia de las solicitudes en HAProxy: instrucciones paso a paso</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499594/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/000/ebc/00e/000ebc00ecfca624add0621c731f2405.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El autor explica c√≥mo implementar en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√≠mite de velocidad de consulta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HAProxy </font><font style="vertical-align: inherit;">(limitaci√≥n de velocidad) con ciertas direcciones IP. El equipo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tradujo su art√≠culo; esperamos que con √©l no tenga que gastar tanto tiempo y esfuerzo en ello como lo tuvo que gastar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hecho es que este es uno de los m√©todos m√°s populares para proteger un servidor de ataques DoS, pero es dif√≠cil encontrar instrucciones claras en Internet sobre c√≥mo configurarlo espec√≠ficamente. Por prueba y error, el autor oblig√≥ a HAProxy a limitar la frecuencia de las solicitudes en una lista de direcciones IP, que se actualiza en tiempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No se requieren conocimientos previos para configurar HAProxy, ya que todos los pasos necesarios se describen a continuaci√≥n.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo abierto y HAProxy gratuito es un equilibrador de carga y un servidor proxy muy accesibles. </font><font style="vertical-align: inherit;">En los √∫ltimos a√±os, se ha vuelto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muy popular</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque proporciona un alto rendimiento con un m√≠nimo de recursos. </font><font style="vertical-align: inherit;">A diferencia de los programas alternativos, la versi√≥n sin fines de lucro de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy Community Edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ofrece suficientes funciones para un equilibrio de carga confiable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, este programa es bastante dif√≠cil de entender. </font><font style="vertical-align: inherit;">Sin embargo, ella tiene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√©cnica muy meticulosa y detallada </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El autor dice que esta es la documentaci√≥n m√°s detallada entre todos los programas de c√≥digo abierto que ha usado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, aqu√≠ hay una gu√≠a paso a paso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar un equilibrador de carga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ahorrar tiempo y no distraerse con la configuraci√≥n de la infraestructura, tome las im√°genes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Compose</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e inicie r√°pidamente los componentes principales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera tarea es elevar la instancia de trabajo del equilibrador de carga HAProxy con varios servidores de fondo de Apache.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clonar el repositorio</font></font></h4><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> git@github.com:stargazer/haproxy-ratelimiter.git<font></font>
$ <span class="hljs-built_in">cd</span> haproxy-ratelimiter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede mirar </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con los par√°metros de instalaci√≥n. Su discusi√≥n est√° m√°s all√° del alcance de este art√≠culo, as√≠ que centr√©monos en el hecho de que crearon una instancia de HAProxy en funcionamiento llamada </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos servidores de fondo </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para configurar HAProxy, inicialmente usaremos el archivo </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego cambiaremos a </font></font><code>haproxy-ratelimiting.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para simplificar, el archivo de configuraci√≥n se ha </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reducido al m√≠nimo y se ha eliminado el exceso. Ve√°moslo:</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
use_backend api<font></font>
<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La secci√≥n </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura HAProxy para escuchar en el puerto 80 y reenviar todas las solicitudes al grupo de servidores en el servidor </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CATEGORY </font></font><code>backend api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especifica el grupo de </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">back- </font><font style="vertical-align: inherit;">end </font><font style="vertical-align: inherit;">con dos servidores de fondo </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y las </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">direcciones correspondientes. </font><font style="vertical-align: inherit;">El servidor para atender cada solicitud entrante se selecciona mediante el algoritmo de equilibrio de carga </font></font><code>roundrobin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es decir, de hecho, los dos servidores disponibles se utilizan a su vez.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos a lanzar los tres contenedores.</font></font></h4><br>
<pre><code class="bash hljs">$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos un contenedor </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que redirige las solicitudes a dos servidores </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">backend </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Recibiremos una respuesta de uno de ellos si ingresamos en la barra de direcciones </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es interesante actualizar la p√°gina varias veces y ver los registros </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 09 +0000] "GET / HTTP / 1.1" 200 45</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Ene / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, dos servidores </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procesan las solicitudes a su vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos una instancia de HAProxy con una configuraci√≥n de equilibrio de carga muy simple, y tenemos una idea de c√≥mo funciona.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar un l√≠mite en el n√∫mero de solicitudes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para establecer un l√≠mite en el n√∫mero de solicitudes al equilibrador de carga, debe modificar el archivo de configuraci√≥n en la instancia de HAProxy. </font><font style="vertical-align: inherit;">Aseg√∫rese de que el contenedor </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use el archivo de configuraci√≥n </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simplemente modifique el Dockerfile para reemplazar el archivo de configuraci√≥n.</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM haproxy:1.7<font></font>
COPY haproxy-ratelimiter.cfg /usr/local/etc/haproxy/haproxy.cfg</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer l√≠mites</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los ajustes se registran en el archivo de configuraci√≥n </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Estudiemoslo cuidadosamente.</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80<font></font>
<font></font>
backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxy ofrece un conjunto de primitivas de bajo nivel que proporcionan m√°s flexibilidad y son adecuadas para una variedad de casos de uso. </font><font style="vertical-align: inherit;">Sus contadores a menudo me recuerdan el registro acumulativo (sumador) en la CPU. </font><font style="vertical-align: inherit;">Almacenan resultados intermedios, toman diferentes sem√°nticas como entrada, pero al final son solo n√∫meros. </font><font style="vertical-align: inherit;">Para entender todo bien, tiene sentido comenzar desde el final del archivo de configuraci√≥n.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesa </font></font><code>Abuse</code></h4><br>
<pre><code class="plaintext hljs">backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ configuramos un backend ficticio llamado </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">("abuso"). </font><font style="vertical-align: inherit;">Ficticio, porque se usa solo para la tabla fija, a la que el resto de la configuraci√≥n puede referirse por su nombre </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Una tabla fija es una tabla almacenada en la memoria del proceso, donde para cada registro puede determinar la duraci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestra mesa tiene las siguientes caracter√≠sticas:</font></font><br>
<br>
<ul>
<li><code>type ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Las solicitudes se guardan en la tabla mediante la direcci√≥n IP como clave. </font><font style="vertical-align: inherit;">Por lo tanto, las solicitudes de la misma direcci√≥n IP se referir√°n al mismo registro. </font><font style="vertical-align: inherit;">Esencialmente, esto significa que estamos rastreando direcciones IP y datos relacionados.</font></font><br>
</li>
<li><code>size 100K</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La tabla contiene un m√°ximo de 100 mil registros.</font></font><br>
</li>
<li><code>expire 30m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: El per√≠odo de retenci√≥n de registros es de 30 minutos de inactividad.</font></font><br>
</li>
<li><code>store gpc0,http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: El contador </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el n√∫mero de solicitudes de direcci√≥n IP de los √∫ltimos 10 segundos se </font><font style="vertical-align: inherit;">almacenan con entradas </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Con la ayuda, realizaremos </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un seguimiento de cu√°ntas veces se detecta la direcci√≥n IP en los abusos. </font><font style="vertical-align: inherit;">De hecho, un valor de contador positivo significa que la direcci√≥n IP ya est√° marcada como sospechosa. </font><font style="vertical-align: inherit;">Llamemos a este contador </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, la tabla le </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite rastrear si la direcci√≥n IP est√° marcada como sospechosa, as√≠ como la frecuencia actual de solicitudes de esta direcci√≥n. </font><font style="vertical-align: inherit;">Por lo tanto, tenemos un historial de registros, as√≠ como informaci√≥n en tiempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora pasemos a la secci√≥n </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y veamos qu√© hay de nuevo all√≠.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funciones y reglas de ACL</font></font></h4><br>
<pre><code class="plaintext hljs">frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las listas de control de acceso (ACL) son declaraciones de funciones que se invocan solo cuando se establece la regla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo m√°s de cerca a las tres entradas de ACL. </font><font style="vertical-align: inherit;">Tenga en cuenta que todos hacen referencia expl√≠cita a una tabla </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que usa direcciones IP como clave, por lo que cada funci√≥n se aplica a la direcci√≥n IP de solicitud:</font></font><br>
<br>
<ul>
<li><code>acl is_abuse src_http_req_rate(Abuse) ge 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La funci√≥n </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresa </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la frecuencia de solicitud actual es mayor o igual a diez.</font></font><br>
</li>
<li><code>acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La funci√≥n </font></font><code>inc_abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresa </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el valor del incremento es </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mayor que cero. </font><font style="vertical-align: inherit;">Como el valor inicial </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es cero, esta funci√≥n siempre regresa </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En otras palabras, aumenta el valor </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, esencialmente indicando abuso de esta direcci√≥n IP.</font></font><br>
</li>
<li><code>acl abuse_cnt src_get_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La funci√≥n </font></font><code>abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresa </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el valor es </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mayor que cero. </font><font style="vertical-align: inherit;">En otras palabras, dice que si esta direcci√≥n IP ya ha sido detectada en abusos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se mencion√≥ anteriormente, las ACL son simplemente declaraciones, es decir, declaraciones de funciones. </font><font style="vertical-align: inherit;">No se aplican a las solicitudes entrantes hasta que se active alguna regla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tiene sentido mirar las reglas definidas en la misma secci√≥n </font></font><code>frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Las reglas se aplican a cada solicitud entrante una por una, y ejecutan las funciones desde la ACL que acabamos de definir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu√© hace cada regla:</font></font><br>
<br>
<ul>
<li><code>tcp-request connection track-sc0 src table Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Agrega una consulta a la tabla </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como la clave es la direcci√≥n IP en la tabla, esta regla se agrega a la lista de direcciones IP.</font></font><br>
</li>
<li><code>tcp-request connection reject if abuse_cnt</code>:   TCP-,  IP-    ,     abuse.  ,   TCP-   IP-.<br>
</li>
<li><code>http-request deny if abuse_cnt</code>:  ,  IP-    .        IP-,      abuse.<br>
</li>
<li><code>http-request deny if is_abuse inc_abuse_cnt</code>:  ,  <code>is_abuse</code>  <code>inc_abuse_cnt</code>   <code>True</code>.  ,    ,    IP-        ,    IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esencia, presentamos dos tipos de comprobaciones: en tiempo real y en la lista negra del historial de consultas. </font><font style="vertical-align: inherit;">La segunda regla rechaza todas las conexiones TCP nuevas si la direcci√≥n IP se ha notado en abusos. </font><font style="vertical-align: inherit;">La tercera regla proh√≠be el servicio de solicitudes HTTP para una direcci√≥n IP de la lista negra, independientemente de la frecuencia actual de solicitudes de esta direcci√≥n. </font><font style="vertical-align: inherit;">La cuarta regla asegura que las solicitudes HTTP de una direcci√≥n IP sean rechazadas en el mismo momento tan pronto como se supere el umbral para la frecuencia de la solicitud. </font><font style="vertical-align: inherit;">Por lo tanto, la segunda regla funciona principalmente en nuevas conexiones TCP, la tercera y la cuarta en conexiones ya establecidas, la primera es una verificaci√≥n hist√≥rica y la segunda una verificaci√≥n en tiempo real.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Probemos el filtro en acci√≥n!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora podemos ensamblar y lanzar nuestros contenedores nuevamente.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo docker-compose down<font></font>
$ sudo docker-compose build<font></font>
$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El equilibrador de carga debe comenzar antes que los dos servidores de fondo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dirijamos nuestro navegador a </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si actualizamos r√°pidamente la p√°gina una docena de veces, superaremos el umbral de diez solicitudes en un intervalo de diez segundos, y nuestras solicitudes ser√°n rechazadas. </font><font style="vertical-align: inherit;">Si continuamos actualizando la p√°gina, las nuevas solicitudes ser√°n rechazadas inmediatamente, incluso antes de que se establezca la conexi√≥n TCP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preguntas</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© el l√≠mite de diez solicitudes por cada diez segundos?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tabla </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determina </font></font><code>http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es decir, la frecuencia de las solicitudes se mide en una ventana de diez segundos. </font><font style="vertical-align: inherit;">Una funci√≥n </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la ACL regresa </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a una tasa de solicitud de ‚â•10 dentro del intervalo especificado. </font><font style="vertical-align: inherit;">Por lo tanto, el abuso se considera la frecuencia de solicitudes de diez o m√°s solicitudes en diez segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo, por ejemplo, decidimos establecer un l√≠mite bajo para que sea m√°s f√°cil verificar el funcionamiento del limitador.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°l es la diferencia entre las reglas de conexi√≥n http-request y tcp-request?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://cbonte.github.io/haproxy-dconv/1.7/configuration.html&amp;usg=ALkJrhgsCV43Lcd24j8380oYhkCNEYeupw#4.2-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-request: la instrucci√≥n http-request define un conjunto de reglas que se aplican en la capa de red 7 [modelo OSI]</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tcp-request connection: realizar una acci√≥n en una conexi√≥n entrante dependiendo de una condici√≥n en la capa de red 4</font></font></i></blockquote><br>
<h3>  HTTP-,        TCP-?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que las solicitudes HTTP al servidor env√≠an m√∫ltiples conexiones TCP desde la misma direcci√≥n IP. </font><font style="vertical-align: inherit;">La frecuencia de las solicitudes HTTP superar√° r√°pidamente los umbrales. </font><font style="vertical-align: inherit;">Es entonces cuando entra en vigor la cuarta regla, que descarta las solicitudes y pone en la lista negra la direcci√≥n IP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora es completamente posible que las conexiones HTTP desde la misma direcci√≥n IP permanezcan abiertas (ver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conexi√≥n HTTP persistente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), y la frecuencia de las solicitudes HTTP ha ca√≠do por debajo de un valor umbral. </font><font style="vertical-align: inherit;">La tercera regla garantiza el bloqueo continuo de las solicitudes HTTP, ya que se </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activa en esta IP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora suponga que despu√©s de unos minutos la misma IP intenta establecer conexiones TCP. </font><font style="vertical-align: inherit;">Se descartan de inmediato, porque se aplica la segunda regla: ve la direcci√≥n IP etiquetada e inmediatamente descarta la conexi√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, puede ser dif√≠cil comprender la limitaci√≥n de la velocidad de procesamiento de solicitudes utilizando HAProxy. </font><font style="vertical-align: inherit;">Para hacer todo bien, necesita un pensamiento bastante "de bajo nivel" y una serie de acciones poco intuitivas. </font><font style="vertical-align: inherit;">La documentaci√≥n en esta parte es probablemente demasiado t√©cnica y adolece de la ausencia de ejemplos b√°sicos. </font><font style="vertical-align: inherit;">Esperamos que esta gu√≠a compense la deficiencia y muestre la direcci√≥n a todos los que quieran tomar este camino. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© m√°s leer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo se implementa la arquitectura tolerante a fallas en la plataforma Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los 10 mejores trucos y consejos de Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestro canal de Telegram sobre transformaci√≥n digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499582/index.html">Modelo Predator-Prey en Node.js</a></li>
<li><a href="../es499584/index.html">Monitor t√°ctil industrial FPM-215W</a></li>
<li><a href="../es499586/index.html">C√≥mo pensar a trav√©s de la navegaci√≥n en aplicaciones m√≥viles</a></li>
<li><a href="../es499588/index.html">Autenticaci√≥n en .NET Core gRpc con JWT</a></li>
<li><a href="../es499592/index.html">AI: complementando el mundo de ma√±ana</a></li>
<li><a href="../es499598/index.html">¬°Y iremos hacia el norte! ¬øSer√° posible ahorrar en el enfriamiento de los centros de datos debido al clima?</a></li>
<li><a href="../es499600/index.html">C√≥mo trabajar juntos, trabajando separados</a></li>
<li><a href="../es499602/index.html">Mover una conferencia en l√≠nea: InnerSource Commons Summit Experience</a></li>
<li><a href="../es499604/index.html">4 argumentos para convencer a un director de comprar un UPS en una peque√±a empresa</a></li>
<li><a href="../es499606/index.html">Software de videoconferencia: Skype, Hangouts y Zoom Half-Blood</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>