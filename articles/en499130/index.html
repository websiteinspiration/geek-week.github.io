<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëî üç™ üßòüèΩ BlockAdBlock Advertising Anti-Blocking Reverse Engineering üëßüèº üïäÔ∏è ü•ù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you use ad blockers, you might encounter BlockAdBlock . This script detects your blocker and does not allow it to the site until you disable it. Bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>BlockAdBlock Advertising Anti-Blocking Reverse Engineering</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499130/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you use ad blockers, you might encounter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BlockAdBlock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This script detects your blocker and does not allow it to the site until you disable it. </font><font style="vertical-align: inherit;">But I wondered how it works. </font><font style="vertical-align: inherit;">How does anti-blocker detect blockers? </font><font style="vertical-align: inherit;">And how do blockers react to this and how do they block anti-blockers?</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">History of reverse engineering</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing I did was look at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">their site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">BlockAdBlock offers a configurator with settings: the wait interval and how the warning will look, generating different </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versions of the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This made me think of versions. </font><font style="vertical-align: inherit;">What if he could not see one version, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at once? </font><font style="vertical-align: inherit;">So I did. </font><font style="vertical-align: inherit;">I went back in time using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wayback Machine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After that, I downloaded all versions of BlockAdBlock and hashed them.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">List of all versions of BlockAdBlock, with sha1sum</font></font></h4><br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6d5eafab2ca816ccd049ad8f796358c0a7a43cf3 20151007203811.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
065b4aa813b219abbce76ad20a3216b3481b11bb 20151113115955.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d5dec97a775b2e563f3e4359e4f8f1c3645ba0e5 20160121132336.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8add06cbb79bc25114bd7a2083067ceea9fbb354 20160318193101.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8add06cbb79bc25114bd7a2083067ceea9fbb354 20160319042810.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8add06cbb79bc25114bd7a2083067ceea9fbb354 20160331051645.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8add06cbb79bc25114bd7a2083067ceea9fbb354 20160406061855.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8add06cbb79bc25114bd7a2083067ceea9fbb354 20160408025028.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
555637904dc9e4bfc6f08bdcae92f0ba0f443ebf 20160415083215.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20161120215354.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170525201720.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170606090847.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170703211338.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170707211652.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170813090718.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20170915094808.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171005180631.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171019162109.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171109101135.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171127113945.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171211042454.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20171227031408.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20180202000800.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20180412213253.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20180419060636.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20180530223228.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20180815042610.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20181029233809.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20181122190948.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20181122205748.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20190324081812.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20190420155244.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20190424200651.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20190903121933.js</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d8986247cad3bbc2dd92c3a2a06ac1540da6b286 20200112084838.js</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">six</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> versions differ from each other, and the last of them refers to 2016, although some sites still use BlockAdBlock. </font><font style="vertical-align: inherit;">This is great, because it will be enough for us to reverse engineer the only version, and then reverse the diffs. </font><font style="vertical-align: inherit;">Spoiler: we will see the development of ideas and even the remnants of debugging code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">posted</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all the versions </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">on GitHub</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If you want to look at diffs, then in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each commit is a new version.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unpacking</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The script code is not minified, but packed by a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS-packer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from Dean Edwards with cosmetic changes and without any modification of the logic </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup></a><a name="1_1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">eval</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p, a, c, k, e, d</span>) </span>{<font></font>
    e = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
        <span class="hljs-keyword">return</span> (c &lt; a ? <span class="hljs-string">''</span> : e(<span class="hljs-built_in">parseInt</span>(c / a))) + ((c = c % a) &gt; <span class="hljs-number">35</span> ? <span class="hljs-built_in">String</span>.fromCharCode(c + <span class="hljs-number">29</span>) : c.toString(<span class="hljs-number">36</span>))<font></font>
    };<font></font>
    <span class="hljs-keyword">if</span> (!<span class="hljs-string">''</span>.replace(<span class="hljs-regexp">/^/</span>, <span class="hljs-built_in">String</span>)) {
        <span class="hljs-keyword">while</span> (c--) {<font></font>
            d[e(c)] = k[c] || e(c)<font></font>
        }<font></font>
        k = [<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
            <span class="hljs-keyword">return</span> d[e]<font></font>
        }];<font></font>
        e = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">'\\w+'</span><font></font>
        };<font></font>
        c = <span class="hljs-number">1</span><font></font>
    };<font></font>
    <span class="hljs-keyword">while</span> (c--) {
        <span class="hljs-keyword">if</span> (k[c]) {<font></font>
            p = p.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'\\b'</span> + e(c) + <span class="hljs-string">'\\b'</span>, <span class="hljs-string">'g'</span>), k[c])<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> p<font></font>
}(<span class="hljs-string">'0.1("2 3 4 5 6 7 8\'d. 9, h? a b c d e f g");i j=\'a\'+\'k\'+\'e\'+\'l\'+\'n\'+\'m\'+\'e\';'</span>,<span class="hljs-number">24</span>,<span class="hljs-number">24</span>,
<span class="hljs-string">'console|log|This|code|will|get|unpacked|then|eval|Cool||||||||huh|let|you|w|s||o'</span>.split(<span class="hljs-string">'|'</span>),<span class="hljs-number">0</span>,{}))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, this is not a problem for us. </font><font style="vertical-align: inherit;">The weakness of the packer is that all code during unpacking is passed to </font></font><code>eval()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If we replace </font></font><code>eval()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with something like </font></font><code>console.log()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then we suddenly get all the source code, and the packer is defeated </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup></a><a name="2_2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having done this for each version, we can examine each of them and see what functions were added there over time.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v1:? </font><font style="vertical-align: inherit;">- November 2015: initial script</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let's start with a study </font></font><code>20151007203811.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">published around November 2015 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup></a><a name="3_3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Although this first version does not block blockers very well, it allows you to evaluate the BlockAdBlock architecture without the garbage that has accumulated over the years.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In three sentences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BlockAdBlock is a closure that returns an object with three functions:</font></font><br>
<ul>
<li><code>bab()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sets the bait and calls a check </font></font><code>check</code> <br>
</li>
<li><code>check()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> checks if the blocker has blocked the bait, causing </font></font><code>arm</code><br>
</li>
<li><code>arm()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> overlay</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The entry point </font></font><code>bab()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then starts after a specified amount of time.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three functions are generated with arguments that are set in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the BlockAdBlock configurator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code is built around a closure assigned to a global object with a random name.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> randomID = <span class="hljs-string">''</span>,<font></font>
    e = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">12</span>; i++) randomID += <font></font>
    e.charAt(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * e.length));
<span class="hljs-keyword">var</span> setTimeoutDelay = <span class="hljs-number">7</span>; <span class="hljs-comment">// Delay after which to call BlockAdBlock</span>
<span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>] = ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The author provided for thorough randomization to circumvent static blocking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then returns an object with three functions: </font></font><code>bab</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>arm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>] = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> eid = ...<font></font>
    return {<font></font>
        <span class="hljs-attr">bab</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">check, passed_eid</span>) </span>{},
        <span class="hljs-attr">check</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">checkPredicate, unused</span>) </span>{},
        <span class="hljs-attr">arm</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}<font></font>
    }<font></font>
})();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are my own names. </font><font style="vertical-align: inherit;">All variables are minified, and some are specially obfuscated. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The entry point is </font></font><code>bab()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">called through </font></font><code>setTimeout()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">setTimeout(<span class="hljs-string">'window[\'\' + randomID + \'\'] \
.bab(window[\'\' + randomID + \'\'].check, \
     window[\'\' + randomID + \'\'].bab_elementid)'</span>, setTimeoutDelay * <span class="hljs-number">1000</span>)</code></pre><br>
<code>bab_elementid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not used in any version of the code. </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">passed as a string. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A closure has external variables. </font><font style="vertical-align: inherit;">Two of them are used to save state in a script:</font></font><br>
<br>
<ul>
<li><code>adblockDetected</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equal to 1 if an ad blocker is detected.</font></font><br>
</li>
<li><code>nagMode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- This is a configuration option. </font><font style="vertical-align: inherit;">If it is installed, then the script does not block access to the page, but only turns on you once.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other variables for controlling appearance and behavior are set in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> eid = <span class="hljs-string">' ad_box'</span>, <span class="hljs-comment">// Name of the bait.</span>
    __u1 = <span class="hljs-number">1</span>, <span class="hljs-comment">// Unused.</span><font></font>
<font></font>
    <span class="hljs-comment">// Colors for the blockadblock prompt.</span>
    overlayColor = <span class="hljs-string">'#EEEEEE'</span>,<font></font>
    textColor = <span class="hljs-string">'#777777'</span>,<font></font>
    buttonBackgroundColor = <span class="hljs-string">'#adb8ff'</span>,<font></font>
    buttonColor = <span class="hljs-string">'#FFFFFF'</span>,<font></font>
<font></font>
    __u2 = <span class="hljs-string">''</span>, <span class="hljs-comment">// Unused.</span><font></font>
<font></font>
    <span class="hljs-comment">// Text to display when the blockadblock prompt is shown.</span>
    welcomeText = <span class="hljs-string">'Sorry for the interruption...'</span>,<font></font>
    primaryText = <span class="hljs-string">'It looks like you\'re using an ad blocker. That\'s okay.  Who doesn\'t?'</span>,<font></font>
    subtextText = <span class="hljs-string">'But without advertising-income, we can\'t keep making this site awesome.'</span>,<font></font>
    buttonText = <span class="hljs-string">'I understand, I have disabled my ad blocker.  Let me in!'</span>,<font></font>
<font></font>
    <span class="hljs-comment">// If 1, adblock was detected.</span>
    adblockDetected = <span class="hljs-number">0</span>,
    <span class="hljs-comment">// If 1, BlockAdBlock will only nag the visitor once, rather than block access.</span>
    nagMode = <span class="hljs-number">0</span>,<font></font>
<font></font>
    <span class="hljs-comment">// The blockadblock domain, reversed.</span>
    bab_domain = <span class="hljs-string">'moc.kcolbdakcolb'</span>;</code></pre><br>
<code>bab_domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set here in an attempt to obfuscate the BlockAdBlock domain.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bab: create a decoy banner</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main method of working with BlockAdBlock is to create ‚Äúbait‚Äù or ‚Äúbait‚Äù from advertising elements that look like real banners. </font><font style="vertical-align: inherit;">He then checks to see if their blocker has blocked. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This creates a decoy: a fake div that pretends to be an ad but is hidden from view.</font></font><br>
<br>
<pre><code class="javascript hljs">bab: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">check, passed_eid</span>) </span>{
    <span class="hljs-comment">// Wait for the document to be ready.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">document</span>.body == <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">return</span><font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">var</span> delay = <span class="hljs-string">'0.1'</span>, <font></font>
        passed_eid = eid ? eid : <span class="hljs-string">'banner_ad'</span>,<font></font>
        bait = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'DIV'</span>);<font></font>
        <font></font>
    bait.id = passed_eid;<font></font>
    bait.style.position = <span class="hljs-string">'absolute'</span>;<font></font>
    bait.style.left = <span class="hljs-string">'-999px'</span>;<font></font>
    bait.appendChild(<span class="hljs-built_in">document</span>.createTextNode(<span class="hljs-string">' '</span>));
    <span class="hljs-built_in">document</span>.body.appendChild(bait);<font></font>
    ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparently, it is </font></font><code>passed_eid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intended to configure the identifier of the bait, but it is not used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, it is checked whether the bait has been removed by the ad unit.</font></font><br>
<br>
<pre><code class="javascript hljs">    ...<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (bait) {<font></font>
            check((bait.clientHeight == <span class="hljs-number">0</span>), delay);<font></font>
            check((bait.clientWidth == <span class="hljs-number">0</span>), delay);<font></font>
            check((bait.display == <span class="hljs-string">'hidden'</span>), delay);<font></font>
            check((bait.visibility == <span class="hljs-string">'none'</span>), delay);<font></font>
            check((bait.opacity == <span class="hljs-number">0</span>), delay);<font></font>
            check((bait.left &lt; <span class="hljs-number">1000</span>), delay);<font></font>
            check((bait.top &lt; <span class="hljs-number">1000</span>), delay)<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            check(<span class="hljs-literal">true</span>, delay)<font></font>
        }<font></font>
    }, <span class="hljs-number">125</span>)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the bait no longer exists, then the element is deleted (and we start the overlay). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will work if it </font></font><code>Predicate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns a value </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and it starts </font></font><code>arm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">check: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">checkPredicate, unused</span>) </span>{
    <span class="hljs-keyword">if</span> ((checkPredicate) &amp;&amp; (adblockDetected == <span class="hljs-number">0</span>)) {<font></font>
        adblockDetected = <span class="hljs-number">1</span>;
        <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].arm()<font></font>
    } <span class="hljs-keyword">else</span> {}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the test is </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">triggered several times, as shown above, it is </font></font><code>adblockDetected</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set to the first correct test in order to avoid repeated tripping </font></font><code>arm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grunt mode</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The script has a function called ‚Äúnag mode‚Äù: in this mode, BlockAdBlock will only say once to disable the ad blocker, but will not block you every time you visit. </font><font style="vertical-align: inherit;">This is done by setting the item </font></font><code>localStorage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the first visit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we could install this element ourselves, could we disable the lock forever? </font><font style="vertical-align: inherit;">Unfortunately, BlockAdBlock checks in advance whether the script was configured for nag mode, so this method will not work when it works in default mode, that is, with access lock.</font></font><br>
<br>
<pre><code class="javascript hljs">arm: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (nagMode == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">var</span> babNag = sessionStorage.getItem(<span class="hljs-string">'babn'</span>);
        <span class="hljs-keyword">if</span> (babNag &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// Stop the script.</span>
        } <span class="hljs-keyword">else</span> {<font></font>
            sessionStorage.setItem(<span class="hljs-string">'babn'</span>, (<span class="hljs-built_in">Math</span>.random() + <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>)<font></font>
        }<font></font>
    };<font></font>
    ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, it is </font></font><code>nagMode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installed in the configurator, and by default it is equal </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BlockAdBlock version 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ad blockers use so-called filters: lines of code that can block network requests and hide elements on the page. By creating bait elements, BlockAdBlock specifically launches these filters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this simple defense, BlockAdBlock is effective against all major ad blockers such as uBlock Origin, AdBlock Plus and Ghostery. To counter this, we must write our own filter, which is activated only on sites that run BlockAdBlock. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing filters for a blocker is a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bit complicated. We need </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a content filter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that blocks elements on the page generated after loading. Since the bait has an identifier </font></font><code>banner_ad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we create an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exception to hide elements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marked </font></font><code>#@#</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for all elements </font></font><code>#</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with an identifier </font></font><code>banner_ad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and put it in the list of user filters of our blocker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result is the following:</font></font><br>
<br>
<pre><code class="javascript hljs">localhost#@# #banner_ad</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have localhost here for demonstration, you can replace it with your URL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This successfully deactivates BlockAdBlock. </font><font style="vertical-align: inherit;">The solution may seem simple, but it has long been working successfully in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Anti-AdBlock-Killer filter list</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 2 (November 2015 - January 2016): several improvements</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difference v1 / v2</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bait Creation: Less Bugs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a subtle mistake in the first version of creating the bait: the created div has no content, so a div is generated with a height of 0 and a width of 0. Later, the code checks to see if the div is deleted by checking its height and width. </font><font style="vertical-align: inherit;">But since it had zero height, BlockAdBlock always worked </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></sup></a><a name="4_4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The error of an empty div is fixed.</font></font><br>
<br>
<pre><code class="javascript hljs">bab: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">...</span>) </span>{<font></font>
    bait = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'DIV'</span>);<font></font>
    ...<font></font>
    bait.appendChild(<span class="hljs-built_in">document</span>.createTextNode(<span class="hljs-string">'√Ç '</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A child div is created with some content.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blocker Detection Through Fake Graphic Banners</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this method, we create a fake image with a random name on </font></font><code>doubleclick.net</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ad blockers will block the image, thinking it is an ad banner. </font><font style="vertical-align: inherit;">But this does not require any changes to our filter.</font></font><br>
<br>
<pre><code class="javascript hljs">bab: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">...</span>) </span>{<font></font>
    bait = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'DIV'</span>);<font></font>
    bait.innerHTML = <span class="hljs-string">'&lt;img src="http://doubleclick.net/'</span> + randomStr() + <span class="hljs-string">'.jpg"&gt;'</span>;<font></font>
    ...</code></pre><br>
<code>randomStr()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generates a string of arbitrary length. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another notable difference was the use of a timer </font></font><code>setInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead of a simple one-time check to see if a trigger is installed. </font><font style="vertical-align: inherit;">He re-checks whether the graphic banner is displayed and if its attribute is not changed </font></font><code>src</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, checking the contents of the bait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
New </font></font><code>setInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and check for image availability:</font></font><br>
<br>
<pre><code class="javascript hljs">    ...<font></font>
    checkCallback = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (bait) {<font></font>
            check((bait.clientHeight == <span class="hljs-number">0</span>), delay);<font></font>
            check((bait.clientWidth == <span class="hljs-number">0</span>), delay);<font></font>
            check((bait.display == <span class="hljs-string">'hidden'</span>), delay);<font></font>
            check((bait.visibility == <span class="hljs-string">'none'</span>), delay);<font></font>
            check((bait.opacity == <span class="hljs-number">0</span>), delay);
            <span class="hljs-keyword">try</span> {<font></font>
                check((<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'banner_ad'</span>).innerHTML.indexOf(<span class="hljs-string">'click'</span>) == <span class="hljs-number">-1</span>), delay)<font></font>
            } <span class="hljs-keyword">catch</span> (e) {}<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            check(<span class="hljs-literal">true</span>, delay)<font></font>
        }<font></font>
    }, <span class="hljs-number">1000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why </font></font><code>indexof ('click')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Because the source of the image </font></font><code>src="doubleclick.net/abcdefg.jpg"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and we check whether the fragment of the string is preserved </font></font><code>click</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 3 (November 2015 - March 2016): generalized bait</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difference v2 / v3</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bait Creation: Randomized Identifiers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only change in this version, although significant, is the appearance of randomized identifiers for the bait. </font><font style="vertical-align: inherit;">The new identifier is taken from the list of identifiers when loading the page and is used for the bait, which is now placed in the middle of the page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A long list of random identifiers demonstrates a good knowledge of the subject area.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> baitIDs = [
  <span class="hljs-string">"ad-left"</span>,
  <span class="hljs-string">"adBannerWrap"</span>,
  <span class="hljs-string">"ad-frame"</span>,
  <span class="hljs-string">"ad-header"</span>,
  <span class="hljs-string">"ad-img"</span>,
  <span class="hljs-string">"ad-inner"</span>,
  <span class="hljs-string">"ad-label"</span>,
  <span class="hljs-string">"ad-lb"</span>,
  <span class="hljs-string">"ad-footer"</span>,
  <span class="hljs-string">"ad-container"</span>,
  <span class="hljs-string">"ad-container-1"</span>,
  <span class="hljs-string">"ad-container-2"</span>,
  <span class="hljs-string">"Ad300x145"</span>,
  <span class="hljs-string">"Ad300x250"</span>,
  <span class="hljs-string">"Ad728x90"</span>,
  <span class="hljs-string">"AdArea"</span>,
  <span class="hljs-string">"AdFrame1"</span>,
  <span class="hljs-string">"AdFrame2"</span>,
  <span class="hljs-string">"AdFrame3"</span>,
  <span class="hljs-string">"AdFrame4"</span>,
  <span class="hljs-string">"AdLayer1"</span>,
  <span class="hljs-string">"AdLayer2"</span>,
  <span class="hljs-string">"Ads_google_01"</span>,
  <span class="hljs-string">"Ads_google_02"</span>,
  <span class="hljs-string">"Ads_google_03"</span>,
  <span class="hljs-string">"Ads_google_04"</span>,
  <span class="hljs-string">"DivAd"</span>,
  <span class="hljs-string">"DivAd1"</span>,
  <span class="hljs-string">"DivAd2"</span>,
  <span class="hljs-string">"DivAd3"</span>,
  <span class="hljs-string">"DivAdA"</span>,
  <span class="hljs-string">"DivAdB"</span>,
  <span class="hljs-string">"DivAdC"</span>,
  <span class="hljs-string">"AdImage"</span>,
  <span class="hljs-string">"AdDiv"</span>,
  <span class="hljs-string">"AdBox160"</span>,
  <span class="hljs-string">"AdContainer"</span>,
  <span class="hljs-string">"glinkswrapper"</span>,
  <span class="hljs-string">"adTeaser"</span>,
  <span class="hljs-string">"banner_ad"</span>,
  <span class="hljs-string">"adBanner"</span>,
  <span class="hljs-string">"adbanner"</span>,
  <span class="hljs-string">"adAd"</span>,
  <span class="hljs-string">"bannerad"</span>,
  <span class="hljs-string">" ad_box"</span>,
  <span class="hljs-string">" ad_channel"</span>,
  <span class="hljs-string">" adserver"</span>,
  <span class="hljs-string">" bannerid"</span>,
  <span class="hljs-string">"adslot"</span>,
  <span class="hljs-string">"popupad"</span>,
  <span class="hljs-string">"adsense"</span>,
  <span class="hljs-string">"google_ad"</span>,
  <span class="hljs-string">"outbrain-paid"</span>,
  <span class="hljs-string">"sponsored_link"</span>
];</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Random ID Generation</font></font></h4><br>
<pre><code class="javascript hljs">    randomBaitID = baitIDs[ <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * baitIDs.length) ],<font></font>
    ...<font></font>
    var passed_eid = randomBaitID;<font></font>
    bait = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'DIV'</span>);    <font></font>
    bait.id = passed_eid;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since this works on every boot, the identifier will be different every time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BlockAdBlock, third to last version</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BlockAdBlock exploits the blind spot of ad blockers: if a filter skips all of the above identifiers, then it will also skip real ads. Thus, BlockAdBlock </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forces the ad blocker to render itself useless</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In blockers, we can execute arbitrary scripts before loading the page. You can try to remove the BlockAdBlock object in advance. But for this we need the name of the BlockAdBlock object, which is randomized each time it starts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
uBlock Origin took a different approach. Since the code is executed by a function </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we can define our own function </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will block execution if we find BlockAdBlock. In JS, an object is capable of this </font></font><code>Proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: you can replace any property and method in any object.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be circumvented by not passing the initial BlockAdBlock payload through </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but using it directly, so we also proxy the entry point: the call </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Since it is </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">passed by a string, not a function, we check this string. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementation in uBlock Origin ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> signatures = [<font></font>
    [ <span class="hljs-string">'blockadblock'</span> ],<font></font>
    [ <span class="hljs-string">'babasbm'</span> ],<font></font>
    [ <span class="hljs-regexp">/getItem\('babn'\)/</span> ],<font></font>
    [<font></font>
        <span class="hljs-string">'getElementById'</span>,
        <span class="hljs-string">'String.fromCharCode'</span>,
        <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span>,
        <span class="hljs-string">'charAt'</span>,
        <span class="hljs-string">'DOMContentLoaded'</span>,
        <span class="hljs-string">'AdBlock'</span>,
        <span class="hljs-string">'addEventListener'</span>,
        <span class="hljs-string">'doScroll'</span>,
        <span class="hljs-string">'fromCharCode'</span>,
        <span class="hljs-string">'&lt;&lt;2|r&gt;&gt;4'</span>,
        <span class="hljs-string">'sessionStorage'</span>,
        <span class="hljs-string">'clientWidth'</span>,
        <span class="hljs-string">'localStorage'</span>,
        <span class="hljs-string">'Math'</span>,
        <span class="hljs-string">'random'</span><font></font>
    ],<font></font>
];<font></font>
<span class="hljs-keyword">const</span> check = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-comment">// check for signature </span>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Signature List: Defining Code Templates. </font><font style="vertical-align: inherit;">The function </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checks the string after </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for compliance with these patterns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proxy the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> functions </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">window</span>.eval = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>(<span class="hljs-built_in">window</span>.eval, {
    <span class="hljs-attr">apply</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target, thisArg, args</span>) </span>{
        <span class="hljs-keyword">const</span> a = args[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span> || !check(a) ) {
            <span class="hljs-keyword">return</span> target.apply(thisArg, args);<font></font>
        } <font></font>
        <span class="hljs-comment">// BAB detected: clean up.</span>
        <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">document</span>.body ) {
            <span class="hljs-built_in">document</span>.body.style.removeProperty(<span class="hljs-string">'visibility'</span>);<font></font>
        }<font></font>
        <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'babasbmsgx'</span>);
        <span class="hljs-keyword">if</span> ( el ) {<font></font>
            el.parentNode.removeChild(el);<font></font>
        }<font></font>
    }<font></font>
});<font></font>
<span class="hljs-built_in">window</span>.setTimeout = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>(<span class="hljs-built_in">window</span>.setTimeout, {
    <span class="hljs-attr">apply</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target, thisArg, args</span>) </span>{
        <span class="hljs-keyword">const</span> a = args[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// Check that the passed string is not the BAB entrypoint.</span>
        <span class="hljs-keyword">if</span> (
            <span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'string'</span> ||
            <span class="hljs-regexp">/\.bab_elementid.$/</span>.test(a) === <span class="hljs-literal">false</span><font></font>
        ) {<font></font>
            <span class="hljs-keyword">return</span> target.apply(thisArg, args);<font></font>
        }<font></font>
    }<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we are now using a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scriptlet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a special custom code fragment executed by the blocker, the filter changes a bit:</font></font><br>
<br>
<pre><code class="javascript hljs">localhost## +js(nobab)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It does not start by default on all sites for performance reasons, so you need to assign it to each site using a script.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 4 (January 2016 - April 2016): experimental functions</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difference v3 / v4</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The described method for blocking anti-blockers was developed in January 2016, according to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history of uBlock Origin commits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and has not changed conceptually since its inception. </font><font style="vertical-align: inherit;">BlockAdBlock never tried to get around this filter by changing its architecture. </font><font style="vertical-align: inherit;">Instead, he continued to develop new features. </font><font style="vertical-align: inherit;">And when we go to the BlockAdBlock page, we see an interesting tab: ‚ÄúDo you need more anti-blocking power?‚Äù </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rs/0m/ea/rs0meawjau7ljt0-m6viiwoo4cq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although these protective methods are available only through a special tab, they are included in all scripts and are executed through variables with the corresponding names. </font><font style="vertical-align: inherit;">The fourth version implements two methods:</font></font><br>
<br>
<ul>
<li><code>aDefOne</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ‚ÄúSpecific protection for adsense sites‚Äù</font></font><br>
</li>
<li><code>aDefTwo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ‚ÄúSpecial security feature‚Äù</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Random debug comments</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before saying goodbye to you, I must mention one more thing. </font><font style="vertical-align: inherit;">In the process of reverse engineering, one function caught my attention: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debugging </font></font><code>console.log()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">right in the code!</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">consolelog</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-comment">// "Dev mode" check: developpers of BAB must set window.consolelog to 1.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.consolelog == <span class="hljs-number">1</span>) {
        <span class="hljs-built_in">console</span>.log(e)<font></font>
    }<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is only done if global </font></font><code>consolelog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for example, is set </font></font><code>window.consolelog = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debug comments are only available in this version. </font><font style="vertical-align: inherit;">If I had not reversed all versions, I would never have noticed them. </font><font style="vertical-align: inherit;">They provide valuable information on how the code works.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced Security: AdSense</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All of these special protection methods are encoded in </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, not in </font></font><code>arm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as the architecture suggests. </font><font style="vertical-align: inherit;">Perhaps a new developer who is not familiar with the code base has begun working on the product. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If AdSense is active on the page, then we check for ads. </font><font style="vertical-align: inherit;">If they disappeared due to a blocker, BlockAdBlock is activated.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"></span>) </span>{<font></font>
    ...<font></font>
    var q = <span class="hljs-string">'ins.adsbygoogle'</span>,
        <span class="hljs-comment">// Selects all Google ads in the document.</span>
        adsbygoogleQuery = <span class="hljs-built_in">document</span>.querySelector(q);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((adsbygoogleQuery) &amp;&amp; (adblockDetected == <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// Ads are not blocked, since the bait ad is still there,</span>
        <span class="hljs-comment">// and adblockDetected hasn't been set</span>
        <span class="hljs-keyword">if</span> (aDefOne == <span class="hljs-string">'yes'</span>) {<font></font>
            consolelog(<span class="hljs-string">'case2: standard bait says ads are NOT blocked.'</span>);
            <span class="hljs-keyword">var</span> adsbygoogle = <span class="hljs-string">'//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'</span>;
            <span class="hljs-keyword">if</span> (scriptExists(adsbygoogle)) {<font></font>
                consolelog(<span class="hljs-string">'case2: And Adsense pre-exists.'</span>);
                <span class="hljs-keyword">if</span> (adsbygoogleQuery.innerHTML.replace(<span class="hljs-regexp">/\s/g</span>, <span class="hljs-string">''</span>).length == <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// The ad's content was cleared, so...</span>
                    consolelog(<span class="hljs-string">'case2: Ads are blocked.'</span>);
                    <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].arm()<font></font>
                }<font></font>
            }<font></font>
        };<font></font>
        adblockDetected = <span class="hljs-number">1</span><font></font>
    }<font></font>
    ...</code></pre><br>
<code>scriptExists</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checks the entire page for a script with a given URL. </font><font style="vertical-align: inherit;">In this case, the AdSense </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;">5</font></sup></a><font style="vertical-align: inherit;"> script</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"></font></sup></a><a name="5_5"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The URL of the script is compared with all the scripts on the page. </font><font style="vertical-align: inherit;">For some reason, the URL is truncated to 15 characters.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scriptExists</span>(<span class="hljs-params">href</span>) </span>{
    <span class="hljs-keyword">if</span> (href) href = href.substr(href.length - <span class="hljs-number">15</span>);
    <span class="hljs-keyword">var</span> scripts = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'script'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = scripts.length; i--;) {
        <span class="hljs-keyword">var</span> src = <span class="hljs-built_in">String</span>(scripts[i].src);
        <span class="hljs-keyword">if</span> (src) src = src.substr(src.length - <span class="hljs-number">15</span>);
        <span class="hljs-keyword">if</span> (src === href) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><font></font>
    };<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
};</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced Protection: Special Element</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unlike the first, this method is accompanied by a disclaimer: "Please test after installation to ensure compatibility with your site." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This special protection works only if a blocker is not found and there is no AdSense script on the page. </font><font style="vertical-align: inherit;">Here is the relevant code snippet </font></font><code>check</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs">check: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">checkPredicate, unused</span>) </span>{
    <span class="hljs-keyword">if</span> ((checkPredicate) &amp;&amp; (adblockDetected == <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// Adblocker detected, arm</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> q = <span class="hljs-string">'ins.adsbygoogle'</span>,<font></font>
            adsbygoogleQuery = <span class="hljs-built_in">document</span>.querySelector(q);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((adsbygoogleQuery) &amp;&amp; (adblockDetected == <span class="hljs-number">0</span>)) {
            <span class="hljs-keyword">if</span> (aDefOne == <span class="hljs-string">'yes'</span>) {
                <span class="hljs-comment">// Special defense one: AdSense defense (see above)</span><font></font>
            };<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (adblockDetected == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span> (aDefTwo == <span class="hljs-string">'yes'</span>) {
                    <span class="hljs-comment">// Special defense two: Special element defense</span><font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method assumes that site owners use only AdSense: if an AdSense script does not exist, then something is wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why was there a warning? </font><font style="vertical-align: inherit;">This method attempts to enable the AdSense script. </font><font style="vertical-align: inherit;">If it does not load, then most likely the blocker blocked the network request, therefore BlockAdBlock is triggered. </font><font style="vertical-align: inherit;">But this can ruin some sites, hence the warning. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If AdSense has not loaded, the overlay starts.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (aDefTwo == <span class="hljs-string">'yes'</span>) {
    <span class="hljs-comment">/* Add Google ad code to head.
        If it errors, the adblocker must have blocked the connection. */</span>
    <span class="hljs-keyword">var</span> googleAdCode = <span class="hljs-string">'//static.doubleclick.net/instream/ad_status.js'</span>;<font></font>
    consolelog(<span class="hljs-string">'case3: standard bait says ads are NOT blocked. Maybe ???\
      No Adsense is found. Attempting to add Google ad code to head...'</span>);
    <span class="hljs-keyword">var</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);<font></font>
    script.setAttribute(<span class="hljs-string">'type'</span>, <span class="hljs-string">'text/javascript'</span>);<font></font>
    script.setAttribute(<span class="hljs-string">'src'</span>, googleAdCode);<font></font>
    script.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].arm()<font></font>
    };<font></font>
    adblockDetected = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (!scriptExists(googleAdCode)) {
        <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'head'</span>)[<span class="hljs-number">0</span>].appendChild(script)<font></font>
    };<font></font>
    adsbygoogleQuery = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].check = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a failure occurs at the network level, it works </font></font><code>onerror</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as if an ad blocker were working. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indeed, most ad blockers respond to this and block the request. </font><font style="vertical-align: inherit;">But there is one blocker that I have not mentioned yet. </font><font style="vertical-align: inherit;">Talk about the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brave browser</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brave Browser Response</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, we have been studying how anti-blocking is detected in uBlock Origin. </font><font style="vertical-align: inherit;">And it works, only a specific filter is required for each site where BlockAdBlock is installed. </font><font style="vertical-align: inherit;">The Brave browser is impressive in that it detects and bypasses BlockAdBlock of all versions without any necessary action on the part of the user. </font><font style="vertical-align: inherit;">To do this, he fakes the request directly at the network layer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></sup></a><a name="6_6"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of blocking the request, </font></font><code>ad_status.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it skips it, but </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loads fake Google Ads 0 bytes in size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This tricky trick fools BlockAdBlock, because it </font></font><code>onerror</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only works if the network request fails.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/45/s7/2e45s7wv2nv9licuzwesiao2tkm.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 5 (March 2016 - November 2016)</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difference v4 / v5</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced protection: spam favicons</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only change in this version is that the second extended protection was rewritten, although it still adheres to the same basic principle: checking network requests that will be blocked by the blocker. </font><font style="vertical-align: inherit;">But now favicons are loading instead of AdSense. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Brave evades this attack in the same way. </font><font style="vertical-align: inherit;">It does not block requests, but creates fake 1 √ó 1 images.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (aDefTwo == <span class="hljs-string">'yes'</span>) {
    <span class="hljs-keyword">if</span> (! <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].ranAlready) {/
        <span class="hljs-keyword">var</span> favicons = [
            <span class="hljs-string">"//www.google.com/adsense/start/images/favicon.ico"</span>,
            <span class="hljs-string">"//www.gstatic.com/adx/doubleclick.ico"</span>,
            <span class="hljs-string">"//advertising.yahoo.com/favicon.ico"</span>,
            <span class="hljs-string">"//ads.twitter.com/favicon.ico"</span>,
            <span class="hljs-string">"//www.doubleclickbygoogle.com/favicon.ico"</span><font></font>
            ],<font></font>
            len = favicons.length,<font></font>
            img = favicons[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * len)],<font></font>
        ...<font></font>
        baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>); <span class="hljs-comment">// creates bait images</span>
        <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> Image();<font></font>
        m.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
            baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>);<font></font>
            c.src = imgCopy;<font></font>
            baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>)<font></font>
        };<font></font>
        c.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
            adblockDetected = <span class="hljs-number">1</span>;<font></font>
            baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">3</span>) + <span class="hljs-number">1</span>);
            <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].arm()<font></font>
        };<font></font>
        m.src = img;<font></font>
        baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">3</span>) + <span class="hljs-number">1</span>);
        <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].ranAlready = <span class="hljs-literal">true</span><font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function </font></font><code>baitImages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be called frequently, with a random number of images, to bypass static blockers.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 6 (April 2016 - November 2016): Brave lock</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source Code </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difference v5 / v6</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
BlockAdBlock methods, although simple at first glance, gradually became more complex and more efficient. </font><font style="vertical-align: inherit;">But the last undefeated enemy remained: the Brave browser.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced Protection: Defining a Fake Favoricon</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why did BlockAdBlock switch from trying to load a script to load images (favicons)? </font><font style="vertical-align: inherit;">The answer is in the code that is added to the protection through spam favicons, and which is activated against the protection of Brave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Checking the response for a fake image:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (aDefTwo == <span class="hljs-string">'yes'</span>) {<font></font>
    baitImages(<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">3</span>) + <span class="hljs-number">1</span>);
    <span class="hljs-comment">// earlier favicon code...</span>
    <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> Image();
    <span class="hljs-keyword">if</span> ((aDefThree % <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) {<font></font>
        m.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> ((m.width &lt; <span class="hljs-number">8</span>) &amp;&amp; (m.width &gt; <span class="hljs-number">0</span>)) {
                <span class="hljs-built_in">window</span>[<span class="hljs-string">''</span> + randomID + <span class="hljs-string">''</span>].arm()<font></font>
            }<font></font>
        }<font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the favicon size is less than 8 √ó 8, then this is probably a fake from the Brave browser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this trick, BlockAdBlock bypasses the disguise of Brave and other blockers who run this code (most, like uBlock Origin, block it first). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this update, around the end of November 2016, BlockAdBlock disappeared from the Internet. </font><font style="vertical-align: inherit;">Although their ‚Äúadvanced security methods‚Äù work, they have never been activated for most users. </font><font style="vertical-align: inherit;">This was the last update. </font><font style="vertical-align: inherit;">The last post on Twitter and on the site was published somewhere at the end of 2017. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the legacy of BlockAdBlock lives on. </font><font style="vertical-align: inherit;">Although it‚Äôs trivial to block it these days, this script is still used by some modern sites.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Who will win the arms race between ad blockers and anti-blockers that block ad blockers? Only time will tell. As the arms race develops, anti-blockers will have to use more sophisticated methods and special code, as the evolution of BlockAdBlock shows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the other hand, blockers have the advantage of stable systems and powerful filtering tools through filter lists, as well as access to JavaScript. With such a system, it is enough for one person to understand how to defeat the enemy - and update the filter list with new sites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By analyzing the evolution of BlockAdBlock, as well as the various responses of ad blockers, we were able to paint a picture of a small war between BlockAdBlock and blockers. In the process, we learned what methods are used in hostilities.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My reverse engineering code is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">published on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Thank you for reading.</font></font><br>
<br>
<hr><br>
<a name="1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. If you want to get an idea of ‚Äã‚Äãhow this works, try pasting the example below into the JS console, and then look at the code. </font><font style="vertical-align: inherit;">If you are interested in his inner workings, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here is the source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ô∏é </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a><br>
<br>
<a name="2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Do not believe? </font><font style="vertical-align: inherit;">Try changing </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the first line. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[to return]</font></font></a><br>
<br>
<a name="3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. The timestamp says </font></font><code>201510</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so maybe October. </font><font style="vertical-align: inherit;">But we do not know when the script changed. </font><font style="vertical-align: inherit;">All we know:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2015-10, one version was saved: </font></font><code>20151007203811.js</code><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2015-11 there is a new version: </font></font><code>20151113115955.js</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As far as we know, the script could be changed the day before the second timestamp. </font><font style="vertical-align: inherit;">Thus, I conservatively approach dating. </font><font style="vertical-align: inherit;">Ô∏é </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a><br>
<br>
<a name="4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. During the correction of this error tests were developed for v1. </font><font style="vertical-align: inherit;">Ô∏é </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a><br>
<br>
<a name="5"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Thanks to McStroyer on Reddit, who drew attention to this. </font><font style="vertical-align: inherit;">Ô∏é </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a><br>
<br>
<a name="6"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. The Brave ad blocker component is open, so we can look at the source code to get an idea of ‚Äã‚Äãhow it works.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResourceTypeToString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">evaluates which resource is being intercepted.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Brave ad blocker in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShouldStartRequest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> checks </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to see if the captured resource matches the blocking rule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If appropriate, it returns a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fake resource</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> based on an earlier type of resource and reports a ‚Äúsuccessful‚Äù request.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fran√ßois Marie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for pointing out the source code for Brave. </font><font style="vertical-align: inherit;">Ô∏é </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499118/index.html">How to create a viral video</a></li>
<li><a href="../en499120/index.html">[Bookmark] CSS: Using Indentation and Indentation</a></li>
<li><a href="../en499122/index.html">How to set up work in ever-changing conditions: Aktion's free anti-crisis courses</a></li>
<li><a href="../en499126/index.html">Developer Heart: Sony PlayStation 1 Devkits</a></li>
<li><a href="../en499128/index.html">Introducing the Latest Preview Version of Windows Terminal - 0.11</a></li>
<li><a href="../en499134/index.html">4 steps to increase LTV product through user communication</a></li>
<li><a href="../en499136/index.html">#BeeFree, or ... Beeline - you could not resist?</a></li>
<li><a href="../en499138/index.html">Topological sorting</a></li>
<li><a href="../en499140/index.html">Generation under control: how to curb powerful language models</a></li>
<li><a href="../en499146/index.html">An easy way to protect your Mikrotik from attacks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>