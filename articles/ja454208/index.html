<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👎 😅 🏡 RISC-Vを最初から 🎅🏻 🍚 👩🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、RISC-Vアーキテクチャーとそのエコシステムのプリズムを通じて、さまざまな低レベルの概念（コンパイルとレイアウト、プリミティブランタイム、アセンブラなど）を探索します。私自身はウェブデベロッパーですが、仕事では何もしませんが、とても興味深いです。ここから記事が始まりました。低レベルの...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>RISC-Vを最初から</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454208/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、RISC-Vアーキテクチャーとそのエコシステムのプリズムを通じて、さまざまな低レベルの概念（コンパイルとレイアウト、プリミティブランタイム、アセンブラなど）を探索します。</font><font style="vertical-align: inherit;">私自身はウェブデベロッパーですが、仕事では何もしませんが、とても興味深いです。ここから記事が始まりました。</font><font style="vertical-align: inherit;">低レベルの混乱の深みへのこの忙しい旅に参加してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、RISC-Vとこのアーキテクチャの重要性について少し説明し、RISC-Vツールチェーンを設定して、エミュレートされたRISC-Vハードウェア上で簡単なCプログラムを実行します。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font></font></h1><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-Vとは何ですか？</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QEMUおよびRISC-Vツールの構成</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちはRISC-V！</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素朴なアプローチ</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーテンを上げる-v</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックを検索</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイアウト</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">やめる！</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンマータイム！</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイム！</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグしますが、実際に</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次は何ですか？</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに</font></font></a></li>
</ol><br>
<a name="1"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-Vとは何ですか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RISC-Vは無料の命令セットアーキテクチャです。このプロジェクトは2010年にカリフォルニア大学バークレー校で始まりました。その成功において重要な役割を果たしたのは、コードのオープン性と使用の自由でした。これは、他の多くのアーキテクチャとは非常に異なっていました。 ARMの場合：互換性のあるプロセッサを作成するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100万ドルから1000万ドルの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前払い料金</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">と、売上に対して0.5〜2％のロイヤリティを支払う必要があり</font></a><font style="vertical-align: inherit;">ます。 ARMや他のプロセッサのライセンスを支払うことができない新興企業、学術研究者、そして（明らかに）オープンソースコミュニティにとって、無料でオープンなモデルはRISC-Vを魅力的なオプションにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RISC-Vの人気の急速な成長は見過ごされませんでした。 ARM </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がサイトを立ち上げ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-V（サイトは既に閉鎖されています）よりも優れているとされるARMの利点を強調するために（かなり失敗して）試みた人。</font><font style="vertical-align: inherit;">RISC-Vプロジェクトは</font><font style="vertical-align: inherit;">、Google、Nvidia、Western Digitalを含む</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの大企業</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によってサポートされ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">てい</font></a><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<a name="2"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QEMUおよびRISC-Vツールの構成</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
環境をセットアップするまで、RISC-Vプロセッサでコードを実行することはできません。</font><font style="vertical-align: inherit;">幸い、これには物理RISC-Vプロセッサは必要ありませんが、代わりに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qemuを使用してください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご使用のオペレーティングシステムの指示</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に従ってインストールし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">私はMacOSを持っているので、コマンドを1つ入力するだけです。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># also available via MacPorts - `sudo port install qemu`</span>
brew install qemu</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
便利なこと</font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数台の機械が稼働可能な状態</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">付属し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ています</font></a><font style="vertical-align: inherit;">（オプションを参照</font></font><code>qemu-system-riscv32 -machine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenOCD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for RISC-VおよびRISC-Vツールを</font><font style="vertical-align: inherit;">インストールし</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
既製のRISC-V OpenOCDおよびRISC-Vツールのアセンブリを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロードし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルを任意のディレクトリに抽出します</font></font><code>~/usys/riscv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">今後の使用のために覚えておいてください。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p ~/usys/riscv
<span class="hljs-built_in">cd</span> ~/Downloads<font></font>
cp openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv<font></font>
cp riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv<font></font>
<span class="hljs-built_in">cd</span> ~/usys/riscv<font></font>
tar -xvf openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz<font></font>
tar -xvf riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
環境変数</font></font><code>RISCV_OPENOCD_PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">設定し</font></font><code>RISCV_PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、他のプログラムがツールチェーンを見つけられるようにします。</font><font style="vertical-align: inherit;">これは、OSとシェルによって異なる場合があります</font></font><code>~/.zshenv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ファイルへのパスを追加しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># I put these two exports directly in my ~/.zshenv file - you may have to do something else.</span>
<span class="hljs-built_in">export</span> RISCV_OPENOCD_PATH=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/usys/riscv/openocd-&lt;date&gt;-&lt;version&gt;"</span>
<span class="hljs-built_in">export</span> RISCV_PATH=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;"</span>
<span class="hljs-comment"># Reload .zshenv with our new environment variables.  Restarting your shell will have a similar effect.</span>
<span class="hljs-built_in">source</span> ~/.zshenv</code></pre><br><font style="vertical-align: inherit;"></font><code>/usr/local/bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この実行可能ファイルのシンボリックリンクを</font><font style="vertical-align: inherit;">
作成して、への</font><font style="vertical-align: inherit;">絶対パスを指定せずにいつでも実行できるようにします</font></font><code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># Symbolically link our gcc executable into /usr/local/bin.  Repeat this process for any other executables you want to quickly access.</span>
ln -s ~/usys/riscv/riscv64-unknown-elf-gcc-8.2.0-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc /usr/<span class="hljs-built_in">local</span>/bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほら、実用的なRISC-Vツールキットがあります。</font><font style="vertical-align: inherit;">など、私たちのすべての実行可能ファイル、</font></font><code>riscv64-unknown-elf-gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>riscv64-unknown-elf-gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>riscv64-unknown-elf-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などがでています</font></font><code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="3"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちはRISC-V！</font></font></h1><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2019年5月26日パッチ：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、RISC-V QEMUのバグが原因で、QEMUの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freedom-e-sdk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 'hello world'プログラムが機能しなくなりました。</font><font style="vertical-align: inherit;">この問題を解決するパッチがリリースされましたが、現時点では、このセクションをスキップしてください。</font><font style="vertical-align: inherit;">このプログラムは、この記事の後続のセクションでは必要ありません。</font><font style="vertical-align: inherit;">バグを修正した後、状況を追跡して記事を更新します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このコメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を参照してください</font><font style="vertical-align: inherit;">。</font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツールを設定したら、簡単なRISC-Vプログラムを実行してみましょう。</font><font style="vertical-align: inherit;">SiFive </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freedom-e-sdk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリの</font><font style="vertical-align: inherit;">クローン作成から始めましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~/wherever/you/want/to/<span class="hljs-built_in">clone</span>/this<font></font>
git <span class="hljs-built_in">clone</span> --recursive https://github.com/sifive/freedom<span class="hljs-_">-e</span>-sdk.git
<span class="hljs-built_in">cd</span> freedom<span class="hljs-_">-e</span>-sdk</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伝統的に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リポジトリの「Hello、world」プログラムから始めましょう</font></font><code>freedom-e-sdk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちは、</font></font><code>Makefile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグモードでこのプログラムをコンパイルするために</font><font style="vertical-align: inherit;">用意されている既製の</font><font style="vertical-align: inherit;">プログラムを使用します。</font></font><br>
<br>
<pre><code class="bash hljs">make PROGRAM=hello TARGET=sifive-hifive1 CONFIGURATION=debug software</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QEMUで実行します。</font></font><br>
<br>
<pre><code class="bash hljs">qemu-system-riscv32 -nographic -machine sifive_e -kernel software/hello/debug/hello.elf<font></font>
Hello, World!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは素晴らしいスタートです。</font><font style="vertical-align: inherit;">から他の例を実行できます</font></font><code>freedom-e-sdk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その後、Cで独自のプログラムを記述してデバッグします。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素朴なアプローチ</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの数値を無限に加算する単純なプログラムから始めましょう。</font></font><br>
<br>
<pre><code class="cpp hljs">cat add.<span class="hljs-function">c
<span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> a = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">int</span> b = <span class="hljs-number">12</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">int</span> c = a + b;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプログラムを実行したいのですが、最初にRISC-Vプロセッサ用にコンパイルする必要があります。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># -O0 to disable all optimizations. Without this, GCC might optimize </span>
<span class="hljs-comment"># away our infinite addition since the result 'c' is never used.</span>
<span class="hljs-comment"># -g to tell GCC to preserve debug info in our executable.</span>
riscv64-unknown-elf-gcc add.c -O0 -g</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここ</font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ファイルが作成され</font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">この</font><font style="vertical-align: inherit;">デフォルトの</font><font style="vertical-align: inherit;">名前</font><font style="vertical-align: inherit;">は実行可能ファイルを示します。</font><font style="vertical-align: inherit;">ここでこのファイルを実行します</font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># -machine tells QEMU which among our list of available machines we want to</span>
<span class="hljs-comment"># run our executable against.  Run qemu-system-riscv64 -machine help to list</span>
<span class="hljs-comment"># all available machines.</span>
<span class="hljs-comment"># -m is the amount of memory to allocate to our virtual machine.</span>
<span class="hljs-comment"># -gdb tcp::1234 tells QEMU to also start a GDB server on localhost:1234 where</span>
<span class="hljs-comment"># TCP is the means of communication.</span>
<span class="hljs-comment"># -kernel tells QEMU what we're looking to run, even if our executable isn't </span>
<span class="hljs-comment"># exactly a "kernel".</span>
qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</code></pre><br><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">元々お届け</font></a></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">
た車を選びました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
プログラムがQEMU内でGDBサーバーを</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">実行さ</font><font style="vertical-align: inherit;">れるようになったので、別のターミナルからRISC-V GDBクライアントを使用して</font><font style="vertical-align: inherit;">プログラム</font><font style="vertical-align: inherit;">に接続します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a> <code>riscv-qemu</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>localhost:1234</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># --tui gives us a (t)extual (ui) for our GDB session.</span>
<span class="hljs-comment"># While we can start GDB without any arguments, specifying 'a.out' tells GDB </span>
<span class="hljs-comment"># to load debug symbols from that file for the newly created session.</span>
riscv64-unknown-elf-gdb --tui a.out</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして私たちはGDBの中にいます！</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このGDBは「--host = x86_64-apple-darwin17.7.0 --target = riscv64-unknown-elf」として構成されました。</font><font style="vertical-align: inherit;">│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成の詳細を表示するには、「show configuration」と入力します。</font><font style="vertical-align: inherit;">│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バグ報告の手順については、こちらをご覧ください│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;http://www.gnu.org/software/gdb/bugs/&gt;。</font><font style="vertical-align: inherit;">│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GDBのマニュアルやその他のドキュメントリソースは、次のURLでオンラインで入手できます。│</font></font><font></font>
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.                                                 │<font></font>
                                                                                                      │<font></font>
For help, type "help".                                                                                │<font></font>
Type "apropos word" to search for commands related to "word"...                                       │<font></font>
Reading symbols from a.out...                                                                         │<font></font>
(gdb) </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GDB </font></font><code>run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行可能ファイルに対して</font><font style="vertical-align: inherit;">コマンドを実行してみることができ</font><font style="vertical-align: inherit;">ます</font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、現時点では、これは明らかな理由で機能しません。</font><font style="vertical-align: inherit;">プログラムはとしてコンパイルした</font></font><code>riscv64-unknown-elf-gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ので、ホストはアーキテクチャ上で動作するはず</font></font><code>riscv64</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、解決策があります！</font><font style="vertical-align: inherit;">この状況は、GDBのクライアント/サーバーモデルが存在する主な理由の1つです。</font><font style="vertical-align: inherit;">実行可能ファイル</font></font><code>riscv64-unknown-elf-gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">取得</font><font style="vertical-align: inherit;">して、ホストで起動する代わりに、リモートターゲット（GDBサーバー）を指定することができます。</font><font style="vertical-align: inherit;">覚えていると思いますが</font></font><code>riscv-qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、GDBサーバーをで起動して起動するように指定しました</font></font><code>localhost:1234</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このサーバーに接続するだけです：</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（gdb）ターゲットリモート：1234│</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1234を使用したリモートデバッグ：</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、いくつかのブレークポイントを設定できます。</font></font><br>
<br>
<pre><code class="bash hljs">(gdb) b main<font></font>
Breakpoint 1 at 0x1018e: file add.c, line 2.<font></font>
(gdb) b 5 <span class="hljs-comment"># this is the line within the forever-while loop. int c = a + b;</span>
Breakpoint 2 at 0x1019a: file add.c, line 5.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後</font><font style="vertical-align: inherit;">に、ブレークポイントに到達するまで</font><font style="vertical-align: inherit;">GDB </font></font><code>continue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（省略されたcommand </font></font><code>c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">指定</font><font style="vertical-align: inherit;">します。</font></font><br>
<br>
<pre><code class="bash hljs">(gdb) c<font></font>
        Continuing.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスが決して終了しないことにすぐに気づくでしょう。</font><font style="vertical-align: inherit;">これは奇妙なことです...ブレークポイントにすぐに到達すべきではありません</font></font><code>b 5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か？</font><font style="vertical-align: inherit;">どうした？</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a53/834/210/a538342106336ef7ed1b8f9e53a47f48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここにいくつかの問題があります：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストUIがソースを見つけることができません。</font><font style="vertical-align: inherit;">インターフェイスには、コードと近くのブレークポイントが表示されます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GDBは現在の実行行（</font></font><code>L??</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">認識せず</font><font style="vertical-align: inherit;">、カウンター0x0（</font></font><code>PC: 0x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を表示します</font><font style="vertical-align: inherit;">。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入力行の一部のテキスト。完全な形式では次のようになります。 </font></font><code>0x0000000000000000 in ?? ()</code></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブレークポイントに到達できないという事実と合わせて、これらの指標は次のことを示し</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">います。</font><font style="vertical-align: inherit;">しかし、何ですか？</font></font><br>
<br>
<a name="5"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーテンを上げる-v</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が起こっているのかを理解するには、一歩下がって、内部の単純なCプログラムが実際にどのように機能するかについて話す必要があります。関数</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は単純な加算を行いますが、それは本当に何ですか？なぜそれが呼び出されるべき</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ではありません</font></font><code>origin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か</font></font><code>begin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？規約によれば、すべての実行可能ファイルはfunction </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">実行を開始しますが、</font><font style="vertical-align: inherit;">この動作を提供する魔法は何ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの質問に答えるために、GCCチームをフラグで繰り返して、</font></font><code>-v</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際に何が起こっているかについてのより詳細な出力を取得しましょう。</font></font><br>
<br>
<pre><code class="bash hljs">riscv64-unknown-elf-gcc add.c -O0 -g -v</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力は大きいため、リスト全体を表示することはしません。</font><font style="vertical-align: inherit;">GCCは正式にはコンパイラーですが、デフォルトでコンパイルされることにも注意してください（コンパイルとアセンブリーのみに制限するには、フラグを指定する必要があります</font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">どうしてそれが重要ですか？</font><font style="vertical-align: inherit;">さて、詳細な出力のスニペットを見てください</font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃実際の `gcc -v`コマンドはフルパスを出力しますが、それらはかなりです</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃長いので、これらの変数が存在するふりをします。</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃$ RV_GCC_BIN_PATH = / Users / twilcock / usys / riscv / riscv64-unknown-elf-gcc- &lt;date&gt;-&lt;version&gt; / bin /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃$ RV_GCC_LIB_PATH = $ RV_GCC_BIN_PATH /../ lib / gcc / riscv64-unknown-elf / 8.2.0</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
$ RV_GCC_BIN_PATH /../ libexec / gcc / riscv64-unknown-elf / 8.2.0 / collect2 \</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...切り捨てられました... </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  $ RV_GCC_LIB_PATH /../../../../ riscv64-unknown-elf / lib / rv64imafdc / lp64d / crt0.o \ </font></font><font></font>
  $RV_GCC_LIB_PATH/riscv64-unknown-elf/8.2.0/rv64imafdc/lp64d/crtbegin.o \<font></font>
  -lgcc --start-group -lc -lgloss --end-group -lgcc \ <font></font>
  $RV_GCC_LIB_PATH/rv64imafdc/lp64d/crtend.o<font></font>
  ...truncated...<font></font>
COLLECT_GCC_OPTIONS='-O0' '-g' '-v' '-march=rv64imafdc' '-mabi=lp64d'</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
省略形でもこれは多いので、説明させていただきます。最初の行は、</font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムを実行し</font></font><code>collect2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、引数を渡し</font></font><code>crt0.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>crtbegin.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして</font></font><code>crtend.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>-lgcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font><font style="vertical-align: inherit;">フラグ</font></font><code>--start-group</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 collect2の説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で読むことができ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。つまり、collect2は起動時にさまざまな初期化関数を編成し、1つ以上のパスでレイアウトを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、GCCは</font></font><code>crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">して</font><font style="vertical-align: inherit;">いくつかのファイル</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">コンパイルします</font><font style="vertical-align: inherit;">。ご想像のとおり、これ</font></font><code>crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は「Cランタイム」を意味します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、誰もが何を意図しているのかを詳しく説明していますが</font></font><code>crt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要なことを実行するものに</font><font style="vertical-align: inherit;">興味があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「この[crt0]オブジェクトには</font></font><code>_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プログラムのブートストラップを示す</font><font style="vertical-align: inherit;">文字</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">含まれている必要</font><font style="vertical-align: inherit;">があります。」</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「ブートストラップ」の本質はプラットフォームによって異なりますが、通常、スタックフレームの設定、コマンドライン引数の受け渡し、の呼び出しなどの重要なタスクが含まれます</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">はい、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようやく</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">質問の答えが見つかりました</font></font><code>_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。主な機能の</font><font style="vertical-align: inherit;">正確な</font><font style="vertical-align: inherit;">原因は</font><font style="vertical-align: inherit;">何</font><font style="vertical-align: inherit;">ですか。</font></font><br>
<br>
<a name="6"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックを検索</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぞなぞを1つ解決しましたが、これによってどのようにして元の目標に近づくことができ</font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ますか？</font><font style="vertical-align: inherit;">単純なCプログラムを実行するの</font><font style="vertical-align: inherit;">ですか？</font><font style="vertical-align: inherit;">それでもいくつかの問題を解決する必要が</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あります。</font><font style="vertical-align: inherit;">最初の問題は</font><font style="vertical-align: inherit;">、スタックの構成</font><font style="vertical-align: inherit;">方法に関連してい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記で見たように、</font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトはlayout </font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">デフォルトパラメータは、いくつかの要因に基づいて選択されます。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造に対応する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ターゲットトリプレット</font></a></font><code>machine-vendor-operatingsystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちはそれを持っている</font></font><code>riscv64-unknown-elf</code><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ターゲットアーキテクチャ </font></font><code>rv64imafdc</code><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ターゲットABI、 </font></font><code>lp64d</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、すべてが正常に機能しますが、すべてのRISC-Vプロセッサに対しては機能しません。</font><font style="vertical-align: inherit;">前述したように、タスクの1つは</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;スタックを構成することです。</font><font style="vertical-align: inherit;">しかし、彼は私たちのCPU（</font></font><code>-machine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">スタックがどこにあるべきか正確に知りませんか</font><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">彼は私たちの助けなしにそれを行うことはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チーム</font></font><code>qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では車を使いました</font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">さいわい、</font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシン情報をダンプ</font></font><code>dtb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（デバイスツリーblob）</font><font style="vertical-align: inherit;">に簡単にダンプでき</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># Go to the ~/usys/riscv folder we created before and create a new dir </span>
<span class="hljs-comment"># for our machine information.</span>
<span class="hljs-built_in">cd</span> ~/usys/riscv &amp;&amp; mkdir machines
<span class="hljs-built_in">cd</span> machines<font></font>
<font></font>
<span class="hljs-comment"># Use qemu to dump info about the 'virt' machine in dtb (device tree blob) </span>
<span class="hljs-comment"># format.</span>
<span class="hljs-comment"># The data in this file represents hardware components of a given </span>
<span class="hljs-comment"># machine / device / board.</span>
qemu-system-riscv64 -machine virt -machine dumpdtb=riscv64-virt.dtb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dtbデータは基本的にバイナリ形式であるため、読みにくいですが</font></font><code>dtc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ファイルをより読みやすい形式に変換できる</font><font style="vertical-align: inherit;">コマンドラインユーティリティ</font><font style="vertical-align: inherit;">（デバイスツリーコンパイラ）があります。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># I'm running MacOS, so I use Homebrew to install this. If you're</span>
<span class="hljs-comment"># running another OS you may need to do something else.</span><font></font>
brew install dtc<font></font>
<span class="hljs-comment"># Convert our .dtb into a human-readable .dts (device tree source) file.</span>
dtc -I dtb -O dts -o riscv64-virt.dts riscv64-virt.dtb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力ファイル</font></font><code>riscv64-virt.dts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ここには、</font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能なプロセッサコアの数、UARTなどのさまざまな周辺デバイスのメモリの場所、内部メモリ（RAM）の場所</font><font style="vertical-align: inherit;">に関する多くの興味深い情報が表示さ</font><font style="vertical-align: inherit;">れます。スタックはこのメモリにあるはずなので、次で探しましょう</font></font><code>grep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">grep memory riscv64-virt.dts -A 3<font></font>
        memory@80000000 {<font></font>
                device_type = <span class="hljs-string">"memory"</span>;<font></font>
                reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;<font></font>
        };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、このノードには</font></font><code>device_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">として</font><font style="vertical-align: inherit;">「メモリ」</font><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ます。どうやら、探していたものが見つかりました。内部の値から、</font></font><code>reg = &lt;...&gt; ;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリバンクの開始位置とその長さを判別できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devicetree仕様、私たちは、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構文がいることがわかり</font></font><code>reg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;ペアの任意の数です</font></font><code>(base_address, length)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ただし、</font></font><code>reg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4つの意味があります。奇妙なことですが、1つのメモリバンクに対して2つの値で十分ではありませんか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仕様devicetree（検索機能</font></font><code>reg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）から</font></font><code>&lt;u32&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、アドレスと長さの</font><font style="vertical-align: inherit;">セルの数は</font><font style="vertical-align: inherit;">、プロパティ</font></font><code>#address-cells</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>#size-cells</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親ノード（またはノード自体）</font><font style="vertical-align: inherit;">によって決定される</font><font style="vertical-align: inherit;">ことがわかり</font><font style="vertical-align: inherit;">ます。これらの値はメモリノードで指定されておらず、親メモリノードは単にファイルのルートです。これらの値を調べてみましょう。</font></font><br>
<br>
<pre><code class="plaintext hljs">head -n8 riscv64-virt.dts<font></font>
/dts-v1/;<font></font>
<font></font>
/ {<font></font>
        #address-cells = &lt;0x02&gt;;<font></font>
        #size-cells = &lt;0x02&gt;;<font></font>
        compatible = "riscv-virtio";<font></font>
        model = "riscv-virtio,qemu";</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アドレスと長さの両方に2つの32ビット値が必要であることがわかります。</font><font style="vertical-align: inherit;">これは、値を</font></font><code>reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用する</font></font><code> 0x00 + 0x80000000 (0x80000000)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">、メモリが開始</font><font style="vertical-align: inherit;">して</font></font><code>0x00 + 0x8000000 (0x8000000)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイト</font><font style="vertical-align: inherit;">を占める</font><font style="vertical-align: inherit;">、つまり</font></font><code>0x88000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">128メガバイトに対応</font><font style="vertical-align: inherit;">するアドレスで終了</font><font style="vertical-align: inherit;">することを意味します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="7"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイアウト</font></font></h1><br><font style="vertical-align: inherit;"></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">
を使用</font></font><code>dtc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、virt仮想マシンにRAMアドレスを見つけました。また</font><font style="vertical-align: inherit;">、必要に応じてスタックを調整しなく</font><font style="vertical-align: inherit;">ても</font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、デフォルト</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">何が</font><font style="vertical-align: inherit;">コンパイルされる</font><font style="vertical-align: inherit;">かがわかり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。しかし、この情報を使用して最終的にプログラムを実行およびデバッグする方法を教えてください。</font><font style="vertical-align: inherit;">私たちは満足していない</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ので</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、1つの明白なオプションがあります。それは、独自のコードを記述して、単純なプログラムをコンパイルした後に出てきたオブジェクトファイルにリンクすることです。私たちは</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、スタックの最上部が適切に初期化するために開始する場所を知っている必要があります。値をに</font></font><code>0x80000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直接</font><font style="vertical-align: inherit;">ハードコードすることもできます</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、これは、将来必要になる可能性のある変更を考慮した、あまり適切なソリューションではありません。次のようなエミュレータで別のCPUを使用したい場合</font></font><code>sifive_e</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の特性とは？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、私たちがこの質問をするのは最初ではなく、優れた解決策はすでに存在しています。</font><font style="vertical-align: inherit;">GNUリンカーを</font></font><code>ld</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用すると</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私たちからアクセス可能な</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">文字を定義できます</font></a></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なるプロセッサに適し</font><font style="vertical-align: inherit;">た文字を定義できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自のリンカーファイルを最初から作成するのではなく、デフォルトのスクリプトを使用</font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、追加の文字をサポートするように少し変更するの</font><font style="vertical-align: inherit;">が理にかなっています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リンカースクリプトとは何ですか？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=http://www.scoberlin.de/content/media/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに良い説明があります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンカスクリプトの主な目的は、入力と出力でファイルセクションがどのように一致するかを記述し、出力ファイルのメモリのレイアウトを制御することです。</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを知って、デフォルトのリンカースクリプト</font></font><code>riscv64-unknown-elf-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を新しいファイルに</font><font style="vertical-align: inherit;">コピーしましょう</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~/usys/riscv
<span class="hljs-comment"># Make a new dir for custom linker scripts out RISC-V CPUs may require.</span>
mkdir ld &amp;&amp; <span class="hljs-built_in">cd</span> ld
<span class="hljs-comment"># Copy the default linker script into riscv64-virt.ld</span>
riscv64-unknown-elf-ld --verbose &gt; riscv64-virt.ld</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルには、</font><font style="vertical-align: inherit;">この記事で説明しきれないほど</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深い情報が含まれています。</font><font style="vertical-align: inherit;">詳細なキー配信に</font></font><code>--Verbose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、バージョン情報</font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、サポートされているアーキテクチャなどが</font><font style="vertical-align: inherit;">含まれ</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これはすべて知っておくと役に立ちますが、そのような構文はリンカースクリプトでは許可されていないため、テキストエディターを開いて、ファイルから不要なものをすべて削除します。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vim riscv64-virt.ld</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃上記をすべて削除し、=============行を含めます</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GNU ld（GNU Binutils）2.32</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  サポートされるエミュレーション：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   elf64lriscv</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   elf32lriscv</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
内部リンカースクリプトを使用：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
===================================================</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ * -z combrelocのスクリプト：relocセクションの結合と並べ替え* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ * Copyright（C）2014-2019 Free Software Foundation、Inc.</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   このスクリプトのコピーと配布、変更ありまたはなし</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   著作権が提供されていれば、著作権使用料なしでいかなる媒体でも許可されます</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   通知とこの通知は保持されます。</font><font style="vertical-align: inherit;">* /</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OUTPUT_FORMAT（ "elf64-littleriscv"、 "elf64-littleriscv"、</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
	      "elf64-littleriscv"）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...残りのリンカスクリプト...</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">実行して、</font><font style="vertical-align: inherit;">手動で配置する場所を決定します</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">で始まる行を見つけます</font></font><code>OUTPUT_ARCH(riscv)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これはファイルの先頭にあり、その下にコマンドを追加します</font></font><code>MEMORY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">OUTPUT_ARCH(riscv)<font></font>
/* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */<font></font>
MEMORY<font></font>
{<font></font>
   /* qemu-system-risc64 virt machine */<font></font>
   RAM (rwx)  : ORIGIN = 0x80000000, LENGTH = 128M <font></font>
}<font></font>
/* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */<font></font>
ENTRY(_start)</code></pre><br><font style="vertical-align: inherit;"></font><code>RAM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み取り（</font></font><code>r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、書き込み（</font></font><code>w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、および実行可能コードの保存（</font></font><code>x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が</font><font style="vertical-align: inherit;">許可さ</font><font style="vertical-align: inherit;">
れている名前</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">メモリブロックを作成しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すばらしい</font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。RISC-V </font><font style="vertical-align: inherit;">マシンの仕様に一致するメモリレイアウトを特定しました</font><font style="vertical-align: inherit;">。これで使用できます。スタックをメモリに配置します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シンボルを定義する必要があります</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リンカースクリプト（</font></font><code>riscv64-virt.ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）をテキストエディターで</font><font style="vertical-align: inherit;">開き</font><font style="vertical-align: inherit;">、数行を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">SECTIONS<font></font>
{<font></font>
  /* Read-only sections, merged into text segment: */<font></font>
  PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x10000));<font></font>
  . = SEGMENT_START("text-segment", 0x10000) + SIZEOF_HEADERS;<font></font>
  /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */<font></font>
  PROVIDE(__stack_top = ORIGIN(RAM) + LENGTH(RAM));<font></font>
  /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */<font></font>
  .interp         : { *(.interp) }<font></font>
  .note.gnu.build-id  : { *(.note.gnu.build-id) }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、PROVIDEコマンド</font></a></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て定義</font><font style="vertical-align: inherit;">し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">てい</font></a><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">シンボルは、このスクリプトに関連付けられているすべてのプログラムからアクセスできます（プログラム自体が名前自体で何かを決定しないと仮定した場合</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">値</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をに</font><font style="vertical-align: inherit;">設定します</font></font><code>ORIGIN(RAM)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この値は</font><font style="vertical-align: inherit;">、128メガバイト（</font><font style="vertical-align: inherit;">バイト）</font><font style="vertical-align: inherit;">である</font></font><code>0x80000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus </font></font><code>LENGTH(RAM)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">等しいことがわかっています</font></font><code>0x8000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、に</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定した</font><font style="vertical-align: inherit;">ことを意味します</font></font><code>0x88000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡潔にするために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンカーファイル全体をリストしませんが、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここで</font></a><font style="vertical-align: inherit;">表示できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="8"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">やめる！</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンマータイム！</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイム！</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、Cランタイムを作成するために必要なすべてのものが揃いました。実際、これはかなり単純なタスクです。ここにファイル全体を示します</font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">.section .init, "ax"<font></font>
.global _start<font></font>
_start:<font></font>
    .cfi_startproc<font></font>
    .cfi_undefined ra<font></font>
    .option push<font></font>
    .option norelax<font></font>
    la gp, __global_pointer$<font></font>
    .option pop<font></font>
    la sp, __stack_top<font></font>
    add s0, sp, zero<font></font>
    jal zero, main<font></font>
    .cfi_endproc<font></font>
    .end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐにピリオドで始まる多数の行を引き付けます。アセンブラ用のファイルです</font></font><code>as</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ドットのある行は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブラディレクティブ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ば</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">、アセンブラに情報を提供します。これは、次のような命令アセンブラRISC-Vのように、実行可能なコードではない</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>add</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルを1行ずつ見ていきましょう。さまざまな標準RISC-Vレジスタを使用するため</font><font style="vertical-align: inherit;">、すべてのレジスタとその目的について説明</font><font style="vertical-align: inherit;">している</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この表を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">確認してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">.section .init, "ax"</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNUアセンブラの「as」マニュアル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">
記載され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">いるように</font><font style="vertical-align: inherit;">、この行はアセンブラに、</font></font><code>.init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り当てられ</font><font style="vertical-align: inherit;">ているセクション</font><font style="vertical-align: inherit;">（</font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）と実行可能ファイル（</font></font><code>x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">次のコードを挿入するように指示しています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このセクションは</font><font style="vertical-align: inherit;">、オペレーティングシステム内でコードを実行するための</font><font style="vertical-align: inherit;">もう1つの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な規則</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">私たちはOSのない純粋なハードウェアで作業するので、私たちの場合、そのような指示は絶対に必要ではないかもしれませんが、いずれにしてもこれは良い習慣です。</font></font><br>
<br>
<pre><code class="plaintext hljs">.global _start<font></font>
_start:</code></pre><br>
<code>.global</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の文字をで使用できるようにし</font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これがない</font></font><code>ENTRY(_start)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、リンカスクリプトの</font><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">が</font></font><code>_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行可能ファイルへのエントリポイントとして</font><font style="vertical-align: inherit;">シンボル</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指す</font><font style="vertical-align: inherit;">ため、リンクは機能しません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次の行は、文字の定義を開始することをアセンブラーに通知しています</font></font><code>_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">_start:<font></font>
  .cfi_startproc<font></font>
  .cfi_undefined ra<font></font>
  ...other stuff...<font></font>
  .cfi_endproc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのディレクティブ</font><font style="vertical-align: inherit;">は、フレームの構造とその処理方法について</font></font><code>.cfi</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通知します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ディレクティブは</font></font><code>.cfi_startproc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どちらも</font></font><code>.cfi_endproc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の開始と終了を通知し、</font><font style="vertical-align: inherit;">起動前に</font></font><code>.cfi_undefined ra</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスタに</font><font style="vertical-align: inherit;">含まれる値に</font><font style="vertical-align: inherit;">レジスタ</font></font><code>ra</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を復元</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ないように</font></a><font style="vertical-align: inherit;">アセンブラに指示し</font></font><code>_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="plaintext hljs">.option push<font></font>
.option norelax<font></font>
la gp, __global_pointer$<font></font>
.option pop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのディレクティブは</font></font><code>.option</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、特定のオプションセットを適用する必要がある場合に、コードに従ってアセンブラの動作を変更します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは</font></font></a><font style="vertical-align: inherit;"></font><code>.option</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このセグメントで</font><font style="vertical-align: inherit;">の使用が重要</font><font style="vertical-align: inherit;">である</font><font style="vertical-align: inherit;">理由を詳しく説明します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...シーケンスのアドレス指定をGPに比べてより短いシーケンスに緩和する可能性があるため、GPの初期ロードは弱められてはならず、次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">.option push<font></font>
.option norelax<font></font>
la gp, __global_pointer$<font></font>
.option pop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リラックスした後、次のコードを取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">auipc gp, %pcrel_hi(__global_pointer$)<font></font>
addi gp, gp, %pcrel_lo(__global_pointer$)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単純な代わりに：</font></font><br>
<br>
<pre><code class="plaintext hljs">addi gp, gp, 0</code></pre></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、私たちの最後の部分</font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">_start:<font></font>
  ...other stuff...<font></font>
  la sp, __stack_top<font></font>
  add s0, sp, zero<font></font>
  jal zero, main<font></font>
  .cfi_endproc<font></font>
  .end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、作成に苦労し</font><font style="vertical-align: inherit;">たシンボル</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">最終的に使用でき</font><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">疑似命令</font></font></a> <code>la</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（アドレスのロード）は、値</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をレジスタ</font></font><code>sp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（スタックポインタ）に</font><font style="vertical-align: inherit;">ロードし</font><font style="vertical-align: inherit;">、プログラムの残りの部分で使用できるように設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font></font><code>add s0, sp, zero</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、レジスタ</font></font><code>sp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>zero</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（実際には</font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0へのハード参照を持つ</font><font style="vertical-align: inherit;">レジスタ）の値を追加し</font><font style="vertical-align: inherit;">、結果をレジスタに格納し</font></font><code>s0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これは、</font><font style="vertical-align: inherit;">いくつかの点で珍しい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特殊レジスター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">まず、これは「永続レジスタ」です。つまり、関数が呼び出されたときに保存されます。</font><font style="vertical-align: inherit;">第二に、</font></font><code>s0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレームポインタとして機能する場合があります。これにより、各関数はスタック上の小さなスペースを呼び出して、この関数に渡されるパラメータを保持します。関数呼び出しがスタックポインターとフレームポインターでどのように機能するかは、別の記事に簡単に当てることができる非常に興味深いトピックですが、今のところ、ランタイムでフレームポインターを初期化することが重要であることを理解してください</font></font><code>s0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、指示が表示され</font></font><code>jal zero, main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。ここで</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、トランジションとレイアウト（ジャンプとリンク）を意味します。命令は、の形式のオペランドを期待しています</font></font><code>jal rd (destination register), offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の命令の値（レジスタ</font></font><code>pc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ 4）を</font><font style="vertical-align: inherit;">機能的にに</font><font style="vertical-align: inherit;">書き込み、</font></font><code>rd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスタ</font></font><code>pc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を現在の値</font></font><code>pc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">文字拡張</font></a><font style="vertical-align: inherit;">付きのオフセットアドレスに設定します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このアドレスを効果的に「呼び出す」。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のよう</font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、リテラル値0に密接にバインドされており、書き込むことはできません。したがって、</font></font><code>zero</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-Vアセンブラーがレジスターとして解釈</font><font style="vertical-align: inherit;">する宛先レジスターとしてレジスターを使用するのは奇妙に思えるかもしれません</font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。結局、これはへの無条件の移行を意味し</font></font><code>offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。他のアーキテクチャでは無条件の移行のための明示的な指示があるので、なぜこれを行うのですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この奇妙なパターン</font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、実際にはスマートな最適化です。新しい各命令のサポートは、プロセッサのコストの増加と、その結果の増加を意味します。したがって、ISAは単純であるほど優れています。</font><font style="vertical-align: inherit;">RISC-Vアーキテクチャは、</font><font style="vertical-align: inherit;">2つの命令</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>unconditional jump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">命令空間を汚染する代わりに、</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および無条件ジャンプはを通じてサポートされ</font></font><code>jal zero, main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RISC-Vにはこのような最適化が多数あり、そのほとんどがいわゆる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">疑似命令の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式をとってい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">アセンブラは、それらを実際のハードウェア命令に変換する方法を知っています。</font><font style="vertical-align: inherit;">たとえば、</font></font><code>j offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-Vアセンブラは、</font><font style="vertical-align: inherit;">無条件</font><font style="vertical-align: inherit;">ジャンプの</font><font style="vertical-align: inherit;">疑似</font><font style="vertical-align: inherit;">命令をに変換し</font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">正式にサポートされている疑似</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なリストについて</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">は、RISC-V仕様（バージョン2.2）を</font></a><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">_start:<font></font>
  ...other stuff...<font></font>
  jal zero, main<font></font>
  .cfi_endproc<font></font>
  .end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の行は</font></font><code>.end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ファイルの終わりを示す</font><font style="vertical-align: inherit;">アセンブラディレクティブ</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<a name="9"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグしますが、実際に</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RISC-Vプロセッサで簡単なCプログラムをデバッグしようとすると、多くの問題が解決しました。</font><font style="vertical-align: inherit;">まず、</font><font style="vertical-align: inherit;">RISC-V </font><font style="vertical-align: inherit;">仮想マシンでメモリ</font><font style="vertical-align: inherit;">を使用</font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して</font></font><code>dtc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見つけました</font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に、この情報を使用して、リンカーのデフォルトスクリプトのバージョンでのメモリ割り当てを手動で制御した</font></font><code>riscv64-unknown-elf-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、シンボルを正確に特定できました</font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に、このシンボルを独自のバージョンで使用</font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、スタックとグローバルポインターをセットアップし、最後に関数を呼び出しました</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これで目標を達成し、GDBで簡単なプログラムのデバッグを開始できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、Cプログラム自体を思い出してください。</font></font><br>
<br>
<pre><code class="cpp hljs">cat add.<span class="hljs-function">c
<span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> a = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">int</span> b = <span class="hljs-number">12</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">int</span> c = a + b;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイルとリンク：</font></font><br>
<br>
<pre><code class="bash hljs">riscv64-unknown-elf-gcc -g -ffreestanding -O0 -Wl,--gc-sections -nostartfiles -nostdlib -nodefaultlibs -Wl,-T,riscv64-virt.ld crt0.s add.c</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは前回よりもはるかに多くのフラグを示したので、これまでに説明していないフラグを調べてみましょう。</font></font><br>
<br>
<code>-ffreestanding</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準ライブラリが存在しない可能性があることをコンパイラに通知</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するため、その必須の可用性について仮定を行う必要はありません。 （オペレーティングシステムの）ホストでアプリケーションを起動する場合、このパラメーターは不要ですが、この場合は必須ではないため、この情報をコンパイラーに通知することが重要です。</font></font><br>
<br>
<code>-Wl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;-リンカーに渡すフラグのコンマ区切りリスト（</font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。ここでは、</font></font><code>--gc-sections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ガベージコレクションセクション」を意味し</font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リンク後に使用されていないセクションを削除するように指示されます。フラグ</font></font><code>-nostartfiles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>-nostdlib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>-nodefaultlibs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準システム・スタートアップ・ファイルを処理しないようにリンカに伝える（例えば、デフォルト</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、システムstdlibの標準実装および標準システムのデフォルトのリンクライブラリ。</font><font style="vertical-align: inherit;">独自のスクリプト</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とリンカーがあるため、デフォルト値がユーザー設定と競合しないように、これらのフラグを渡すことが重要です。</font></font><br>
<br>
<code>-T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンカースクリプトへのパスを示します。これは、私たちの場合は単純</font></font><code>riscv64-virt.ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">最後に、我々は、コンパイルコンパイルおよび構成したいというファイルを示しています</font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>add.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以前と同様に、結果はと呼ばれる完全で準備ができた実行ファイルです</font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、まったく新しい実行可能ファイルを</font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の場所で</font><font style="vertical-align: inherit;">実行し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># -S freezes execution of our executable (-kernel) until we explicitly tell </span>
<span class="hljs-comment"># it to start with a 'continue' or 'c' from our gdb client</span>
qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -S -kernel a.out</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでを実行</font><font style="vertical-align: inherit;">し、最後の引数で指定して、の</font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグシンボルを読み込むことを忘れないで</font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ください。</font></font><br>
<br>
<pre><code class="bash hljs">riscv64-unknown-elf-gdb --tui a.out<font></font>
<font></font>
GNU gdb (GDB) 8.2.90.20190228-git<font></font>
Copyright (C) 2019 Free Software Foundation, Inc.<font></font>
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;<font></font>
This is free software: you are free to change and redistribute it.<font></font>
There is NO WARRANTY, to the extent permitted by law.<font></font>
Type <span class="hljs-string">"show copying"</span> and <span class="hljs-string">"show warranty"</span> <span class="hljs-keyword">for</span> details.<font></font>
This GDB was configured as <span class="hljs-string">"--host=x86_64-apple-darwin17.7.0 --target=riscv64-unknown-elf"</span>.<font></font>
Type <span class="hljs-string">"show configuration"</span> <span class="hljs-keyword">for</span> configuration details.<font></font>
For bug reporting instructions, please see:<font></font>
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.<font></font>
Find the GDB manual and other documentation resources online at:<font></font>
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.<font></font>
<font></font>
For <span class="hljs-built_in">help</span>, <span class="hljs-built_in">type</span> <span class="hljs-string">"help"</span>.<font></font>
Type <span class="hljs-string">"apropos word"</span> to search <span class="hljs-keyword">for</span> commands related to <span class="hljs-string">"word"</span>...<font></font>
Reading symbols from a.out...<font></font>
(gdb)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font><font style="vertical-align: inherit;">、コマンドの一部として</font><font style="vertical-align: inherit;">起動</font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したサーバーに</font><font style="vertical-align: inherit;">クライアント</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">接続します</font><font style="vertical-align: inherit;">。</font></font><code>gdb</code><font style="vertical-align: inherit;"></font><code>qemu</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">(gdb) target remote :1234                                                                             │<font></font>
Remote debugging using :1234</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインにブレークポイントを設定します。</font></font><br>
<br>
<pre><code class="bash hljs">(gdb) b main<font></font>
Breakpoint 1 at 0x8000001e: file add.c, line 2.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、プログラムの実行を開始します。</font></font><br>
<br>
<pre><code class="bash hljs">(gdb) c<font></font>
Continuing.<font></font>
<font></font>
Breakpoint 1, main () at add.c:2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与えられた出力から、2行目のブレークポイントに正常に到達したことは明らかです。</font><font style="vertical-align: inherit;">これはテキストインターフェイスにも表示され、最終的には正しい行</font></font><code>L</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、値</font></font><code>PC:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><code>L2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><code>PC:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;-があり</font></font><code>0x8000001e</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">記事のようにすべてを実行した場合、出力は次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/bd8/aa9/78d/bd8aa978df4289f584b5c422cdb6e44c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これからは、</font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常どおりに</font><font style="vertical-align: inherit;">使用できます。</font></font><code>-s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の命令に移動し</font></font><code>info all-registers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て、プログラムの実行中にレジスター内の値を確認するなどです。お試しください... 、これのためにたくさん働いた！</font></font><br>
<br>
<a name="10"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次は何ですか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日、私たちは多くのことを達成しました、そして、私は願っています、多くのことを学びました！</font><font style="vertical-align: inherit;">この記事とその後の記事について正式な計画を立てたことは一度もありませんでした。</font><font style="vertical-align: inherit;">したがって、次に何が起こるかわかりません。</font><font style="vertical-align: inherit;">私は特に命令の深い没頭が好きだった</font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ので、次の記事では、ここで得られた知識を基礎として取り上げますが</font></font><code>add.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、純粋なRISC-Vアセンブラのプログラムに</font><font style="vertical-align: inherit;">置き換え</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">何か見たいことや質問がある場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チケットを開い</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読んでくれてありがとう！</font><font style="vertical-align: inherit;">次の記事で会いたいです！</font></font><br>
<br>
<a name="11"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事が気に入って詳細を知りたい場合は、CppCon2018カンファレンスのMatt Godboltの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Bits Between Bits：How we Get into main（）」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というタイトルのプレゼンテーションをご覧ください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">彼女は私たちがここにいるのとは少し異なる方法でトピックに取り組みます。</font><font style="vertical-align: inherit;">本当に良い講義です、ぜひご覧ください！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454190/index.html">スマートフォンが盗まれた場合に行う必要のないこと</a></li>
<li><a href="../ja454196/index.html">ドローンの例を使用した電子機器の3Dプリント：ワイヤーとボードは不要になりました</a></li>
<li><a href="../ja454198/index.html">IDEAでマルチモジュールGradle SpringBoot + Angularプロジェクトを作成する</a></li>
<li><a href="../ja454204/index.html">行動クロールは万能薬ではありませんか？</a></li>
<li><a href="../ja454206/index.html">PHDays 9：AI CTF解析</a></li>
<li><a href="../ja454210/index.html">忘れられたenchantjs +新しい1C-Bitrix =顧客の動機付けのためのゲーム</a></li>
<li><a href="../ja454214/index.html">ほとんどすべてのソフトウェアが嫌い</a></li>
<li><a href="../ja454216/index.html">すべての変更が順序とチャンスの混合であるという証拠が見つかりました</a></li>
<li><a href="../ja454220/index.html">2桁温度計</a></li>
<li><a href="../ja454222/index.html">PCIe 1.0-2.0バスを備えた古いサーバーのディスクサブシステムのアップグレード</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>