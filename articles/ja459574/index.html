<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¾â€ğŸ”¬ ğŸ‘© â–«ï¸ Linuxåå‰ç©ºé–“ã®è©³ç´°ã€ãƒ‘ãƒ¼ãƒˆ2 ğŸ’‡ğŸ¿ ğŸ˜† ğŸ–</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã§å‰ã®éƒ¨åˆ†ã€ç§ãŸã¡ã¯ã€åå‰ç©ºé–“ã®æµ·ã«ã€ãã‚ŒãŒå˜é›¢ã•ã‚ŒUTSåå‰ç©ºé–“ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã§ã—ãŸã©ã®ã‚ˆã†ã«ç°¡å˜ã«åŒã˜æ™‚é–“ã®ã“ãã‚Šã§ç§ãŸã¡ã®ã¤ã¾å…ˆã‚’æµ¸ã—ã¾ã—ãŸã€‚ã“ã®æŠ•ç¨¿ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
 

ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®ä¸­ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã¯ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linuxåå‰ç©ºé–“ã®è©³ç´°ã€ãƒ‘ãƒ¼ãƒˆ2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459574/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰ã®éƒ¨åˆ†ã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç§ãŸã¡ã¯ã€åå‰ç©ºé–“ã®æµ·ã«ã€ãã‚ŒãŒå˜é›¢ã•ã‚ŒUTSåå‰ç©ºé–“ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã§ã—ãŸã©ã®ã‚ˆã†ã«ç°¡å˜ã«åŒã˜æ™‚é–“ã®ã“ãã‚Šã§ç§ãŸã¡ã®ã¤ã¾å…ˆã‚’æµ¸ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã“ã®æŠ•ç¨¿ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®ä¸­ã§ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã®è­˜åˆ¥å­ã‚’åˆ†é›¢ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®æŠ•ç¨¿ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ã‚°ãƒ«ãƒ¼ãƒ—IDã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆãã‚Œãã‚ŒUIDã¨GIDï¼‰ã«ã®ã¿ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚„ãã®ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å®Ÿè¡Œã™ã‚‹ä¸Šã§åŸºæœ¬çš„ãªå½¹å‰²ã‚’æœãŸã™ãŸã‚ã§ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxã§ã¯ã€ã“ã‚Œã‚‰ã®IDã¯ã€ã‚·ã‚¹ãƒ†ãƒ å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è­˜åˆ¥ã™ã‚‹å˜ãªã‚‹æ•´æ•°ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹æ“ä½œã¨ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„æ“ä½œ/ãƒªã‚½ãƒ¼ã‚¹ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã€ãã‚Œãã‚Œã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ—ãƒ­ã‚»ã‚¹ãŒå®³ã‚’åŠã¼ã™èƒ½åŠ›ã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIDã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚</font></font><a name="habracut"></a></p><br>
<h2 id="user-namespaces"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“</font></font></h2><br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã®æ©Ÿèƒ½ã‚’èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ã£ãŸãåŒã˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚°ãƒ«ãƒ¼ãƒ—IDã«ã‚‚é©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã€ã“ã®æŠ•ç¨¿ã®å¾ŒåŠã§èª¬æ˜ã—ã¾ã™ã€‚</font></font></em></blockquote><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã®è­˜åˆ¥å­ã®ç‹¬è‡ªã®ã‚³ãƒ”ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã«ã€åˆ†é›¢ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ãŒç¾åœ¨å±ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã«å¿œã˜ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ¥ã®IDã‚»ãƒƒãƒˆã«é–¢é€£ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°</font><font style="vertical-align: inherit;">ã€åå‰ç©ºé–“ãƒ¦ãƒ¼ã‚¶ãƒ¼</font><strong><font style="vertical-align: inherit;">Pã®</font></strong><font style="vertical-align: inherit;">ï¼ˆUID 0ï¼‰</font></font><code>$pid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«ã‚ˆã£ã¦</font><font style="vertical-align: inherit;">ãƒ—ãƒ­ã‚»ã‚¹</font><font style="vertical-align: inherit;">ãŒå®Ÿè¡Œã•</font><font style="vertical-align: inherit;">ã‚Œã€åˆ¥ã®åå‰ç©ºé–“ãƒ¦ãƒ¼ã‚¶ãƒ¼</font><strong><font style="vertical-align: inherit;">Q</font></strong><font style="vertical-align: inherit;">ã«åˆ‡ã‚Šæ›¿ãˆãŸå¾Œ</font><font style="vertical-align: inherit;">ã€çªç„¶</font><font style="vertical-align: inherit;">ï¼ˆUID 13ï¼‰</font><font style="vertical-align: inherit;">ã‹ã‚‰å®Ÿè¡ŒãŒç¶šè¡Œ</font><font style="vertical-align: inherit;">ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><code>root</code><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><code>proxy</code><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p><br>
<p>User spaces   !  ,    namespace ()        ,      ,   ,         â€¦ (    32  ).    namespace <strong>C</strong>, Linux   User namespace  <strong>P</strong>,  <strong>C</strong>,    <strong>C</strong>       .    user namespaces    ,     . ,      ,      ,      ( , ) namespace. ,      -  ,   user namespace,      ,    user namespace    .</p><br>
<blockquote><em>         P$  C$   ,        <strong>P</strong>   <strong>C</strong> user namespace .</em></blockquote><br>
<h2 id="mappingi-user-id"> User ID</h2><br>
<p>User namespace,  ,      ,   ID   ID  user namespace â€”       ID ,   .  ,    :</p><br>
<pre><code class="bash hljs">P$ whoami<font></font>
iffy<font></font>
P$ id<font></font>
uid=1000(iffy) gid=1000(iffy)</code></pre><br>
<p>         <code>unshare</code> ( <code>-U</code>     user namespace):</p><br>
<pre><code class="bash hljs">P$ whoami<font></font>
iffy<font></font>
P$ unshare -U bash<font></font>
<span class="hljs-comment">#    ,     user namespace</span><font></font>
C$ whoami<font></font>
nobody<font></font>
C$ id<font></font>
uid=65534(nobody) gid=65534(nogroup) <font></font>
C$ ls -l my_file<font></font>
-rw-r--r-- 1 nobody nogroup 0 May 18 16:00 my_file</code></pre><br>
<p>, ? ,        <strong>C</strong>,    nobody?    ,   <strong>C</strong>   user namespace,      ID.  , ,   ,    <code>iffy</code>,  <code>nobody</code> â€”   .   ,  ,     ,   .      (  )  ID   â€”      ,  <code>nobody</code>     <code>nogroup</code>.</p><br>
<p>,  UID   user namespace  ,  <strong> user ID</strong>.        ID   user namespace  ID   namespace   user namespace     UID (      GID  group ID).</p><br>
<p>    ,     <code>unshare</code> . ,   user namespaces    ,    Linux      <code>nobody</code>.    ,      -       . ,      (, <code>setuid</code>),     UID,  .   !   <em>--</em>, Linux        <code>/proc</code>  <code>/proc/$pid/uid_map</code> ( <code>/proc/$pid/gid_map</code>  GID),  <code>$pid</code> â€” ID .       <em>map-</em></p><br>
<h2 id="map-fayly">Map-</h2><br>
<p>Map- â€”    .  ? , ,      ,     ,    ,    . , map- <code>/proc/$pid/uid_maps</code>    UID'  user namespace,    <code>$pid</code>, UID'  user namespace  . ,  , ,    <strong>X</strong>,    ,     <strong>Y</strong>,         map  .</p><br>
<p> ,  <strong>X</strong>,  UID map- <code>/proc/$pid/uid_map</code>,   .      UID'  user namespace <strong>C</strong>  <code>$pid</code>,   UID   namespace.</p><br>
<p>    <code>$fromID $toID $length</code>, :</p><br>
<ul>
<li><code>$fromID</code>   UID   user namespace  <code>$pid</code></li>
<li><code>$lenght</code> â€”   .</li>
<li> <code>$toID</code>     <strong>X</strong>.  <strong>X</strong>   user namespace <strong>U</strong>,  <code>$toID</code> â€”   UID   <strong>U</strong>,    <code>$fromID</code>.    <code>$toID</code> â€”   UID   <strong>P</strong> â€”  user namespace  <strong>C</strong>.</li>
</ul><br>
<p>,     <code>/proc/1409/uid_map</code>      <code>15 22 5</code>,  UID'  15  19  user namespace  <code>1409</code>   UID' 22-26  user namespace  .</p><br>
<p>  ,      <code>/proc/$$/uid_map</code> ( map-  ,    user namespace,    )   <code>15 22 5</code>,  UID' c 15  19  user namespace <strong>C</strong>   UID' c 22  26   <strong>C</strong> user namespace.</p><br>
<p>  :</p><br>
<pre><code class="bash hljs">P$ <span class="hljs-built_in">echo</span> $$<font></font>
1442<font></font>
<span class="hljs-comment">#   user namespace...</span>
C$ <span class="hljs-built_in">echo</span> $$<font></font>
1409<font></font>
<span class="hljs-comment"># C      ,    </span><font></font>
C$ cat /proc/1409/uid_map<font></font>
<span class="hljs-comment"># </span>
<span class="hljs-comment">#   namespace P     </span>
<span class="hljs-comment"># UIDs    UID   </span><font></font>
P$ cat /proc/1442/uid_map<font></font>
         0          0 4294967295<font></font>
<span class="hljs-comment"># UIDs  0  4294967294  P </span>
<span class="hljs-comment">#  4294967295 -  ID no user -  C.</span><font></font>
C$ cat /proc/1409/uid_map<font></font>
         0 4294967295 4294967295</code></pre><br>
<p>,     ,       ,       :</p><br>
<ol>
<li>  user namespace     map-.</li>
<li>UID 4294967295         <code>root</code> user namespace. Linux   UID ,   <strong> user ID</strong>.</li>
</ol><br>
<h2 id="napisanie-uid-map-faylov"> UID Map </h2><br>
<p>     user namespace <strong>C</strong>,       ,     map-   ,   <strong>C</strong> (         ).      Linux  :</p><br>
<ol>
<li> UID'   ,     user namespace <strong>C</strong>.</li>
<li> UID's   user namespace  UID'  <strong>C</strong>.</li>
</ol><br>
<p>,     user namespace <strong>P</strong>    map-     <strong>C</strong>:</p><br>
<pre><code class="plaintext hljs">0 1000 1<font></font>
3    0 1</code></pre><br>
<p>    Linux, :</p><br>
<ol>
<li>    <strong>C</strong>,  UID',    ,  UID' <code>0</code>  <code>3</code>. ,   <code>setuid(9)</code>    -  <em> id </em>.</li>
<li>UID' <code>1000</code>  <code>0</code>  <strong>P</strong>  UID' <code>0</code>  <code>3</code>  <strong>C</strong>. ,  ,   UID <code>1000</code>  <strong>P</strong>,   <strong>C</strong>,  ,     UID  <code>root</code> <code>0</code>.</li>
</ol><br>
<h2 id="vladelec-prostranstv-imyon-i-privilegii">    </h2><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>  ,           . User namespaces    .   ,      ,    <em></em>   .</p><br>
<p> ,    user namespace <strong>N</strong>, Linux   user namespace <strong>P</strong> ,  <strong>N</strong>, <em></em> namespace <strong>N</strong>.  <strong>P</strong>              <code>clone</code>, Linux ,  <strong>P</strong>         .</p><br>
<p>    ,  ,      ,   user namespace,    UID ,      user namespace,    user namespace. , ,  <strong>P</strong>   user namespace  <strong>C</strong>,  <strong>P</strong>  <strong>C</strong>   network namespace <strong>M</strong>  <strong>N</strong> .         ,   <strong>M</strong>,         <strong>N</strong>.</p><br>
<p>        ,      <code>sudo</code>      <code>unshare</code>  <code>isolate</code>,        user namespace. , <code>unshare -u bash</code>  <code>sudo</code>,  <code>unshare -Uu bash</code> â€”  :</p><br>
<pre><code class="bash hljs"><span class="hljs-comment"># UID 1000 --      user namespace P.</span><font></font>
P$ id<font></font>
uid=1000(iffy) gid=1000(iffy)<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># network namespace.</span>
P$ ip link add <span class="hljs-built_in">type</span> veth<font></font>
RTNETLINK answers: Operation not permitted<font></font>
<span class="hljs-comment">#     ,    </span>
<span class="hljs-comment">#  user  network namespace</span>
P$ unshare -nU bash <span class="hljs-comment"># :  sudo</span>
C$ ip link add <span class="hljs-built_in">type</span> veth<font></font>
RTNETLINK answers: Operation not permitted<font></font>
<span class="hljs-comment"># ,  . , </span>
<span class="hljs-comment"># UID 0 (root)    , </span>
<span class="hljs-comment">#     nobody.   .</span>
C$ <span class="hljs-built_in">echo</span> $$<font></font>
13294<font></font>
<span class="hljs-comment">#   P,   UID 1000  P  UID 0  C</span>
P$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"0 1000 1"</span> &gt; /proc/13294/uid_map
<span class="hljs-comment">#   ?</span><font></font>
C$ id<font></font>
uid=0(root) gid=65534(nogroup)<font></font>
C$ ip link add <span class="hljs-built_in">type</span> veth
<span class="hljs-comment"># !</span></code></pre><br>
<blockquote><em> ,         ,   <code>isolate</code>    <code>root</code>   user namespace,    Mount  Network namespace.       ,  ,      .</em></blockquote><br>
<h2 id="kak-razreshayutsya-id">  ID</h2><br>
<p>    ,     <code>1000</code>    <code>root</code>.  ,     . ,    <em></em> ID:    <em></em>,     <code>root</code>  , Linux ,  <code>root</code> â€”    â€”   UID <code>1000</code> (  ).     ,   ,    user namespace ( network namespace  <strong>C</strong>),      <code>root</code>,  ( , network namespace  <strong>P</strong>) â€” .      ,   <code>1000</code>   .</p><br>
<p> ,     user namespace  ,    â€” ,   â€”  UID   user namespace    ID    user namespace         .     , ,    ID ,       <code>ls -l my_file</code>. UID  <code>my_file</code>    user namespace      ID ( nobody,    -   )   .</p><br>
<h2 id="gruppovye-id"> ID</h2><br>
<p>    root  <strong>C</strong>,        <code>nogroup</code>    ID .          <code>/proc/$pid/gid_map</code>.      ,      <code>setgroups</code> (   ,       <code>CAP_SETGID</code> capability  <strong>P</strong>,      ,        ),  "deny"   <code>proc/$pid/setgroups</code>:</p><br>
<pre><code class="bash hljs"><span class="hljs-comment">#  13294 -- pid  unshared </span><font></font>
C$ id<font></font>
uid=0(root) gid=65534(nogroup)<font></font>
P$ <span class="hljs-built_in">echo</span> deny &gt; /proc/13294/setgroups<font></font>
P$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"0 1000 1"</span> &gt; /proc/13294/gid_map
<span class="hljs-comment">#  group ID  </span><font></font>
C$ id<font></font>
uid=0(root) gid=0(root)</code></pre><br>
<h2 id="realizaciya"></h2><br>
<blockquote><em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</em></blockquote><p>   ,   ,    user namespaces,    . ,    ,       â€”   ,    .   ,   :</p><br>
<ol>
<li>      user namespace.</li>
<li>  UID  GID map-  .</li>
<li>      .</li>
</ol><br>
<p><code>1</code>     <code>CLONE_NEWUSER</code>     <code>clone</code>.</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> clone_flags = SIGCHLD | CLONE_NEWUTS | CLONE_NEWUSER;</code></pre><br>
<p> <code>2</code>    <code>prepare_user_ns</code>,       <code>1000</code>   <code>root</code>.</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare_userns</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pid)</span>
</span>{
    <span class="hljs-keyword">char</span> path[<span class="hljs-number">100</span>];
    <span class="hljs-keyword">char</span> line[<span class="hljs-number">100</span>];<font></font>
<font></font>
    <span class="hljs-keyword">int</span> uid = <span class="hljs-number">1000</span>;<font></font>
<font></font>
    <span class="hljs-built_in">sprintf</span>(path, <span class="hljs-string">"/proc/%d/uid_map"</span>, pid);
    <span class="hljs-built_in">sprintf</span>(line, <span class="hljs-string">"0 %d 1\n"</span>, uid);<font></font>
    write_file(path, line);<font></font>
<font></font>
    <span class="hljs-built_in">sprintf</span>(path, <span class="hljs-string">"/proc/%d/setgroups"</span>, pid);
    <span class="hljs-built_in">sprintf</span>(line, <span class="hljs-string">"deny"</span>);<font></font>
    write_file(path, line);<font></font>
<font></font>
    <span class="hljs-built_in">sprintf</span>(path, <span class="hljs-string">"/proc/%d/gid_map"</span>, pid);
    <span class="hljs-built_in">sprintf</span>(line, <span class="hljs-string">"0 %d 1\n"</span>, uid);<font></font>
    write_file(path, line);<font></font>
}</code></pre><br>
<p>        user namespace   ,      .</p><br>
<pre><code class="cpp hljs">    ...
    <span class="hljs-comment">//      .</span>
    <span class="hljs-keyword">int</span> pipe = params.fd[<span class="hljs-number">1</span>];<font></font>
<font></font>
    <span class="hljs-comment">//      namespace ...</span><font></font>
    prepare_userns(cmd_pid);<font></font>
<font></font>
    <span class="hljs-comment">//   ,     .</span>
    ...</code></pre><br>
<p>  <code>3</code>    <code>cmd_exec</code>,  ,        <code>1000</code>,      (,  root  <code>0</code>  user namespace   â€”   <code>1000</code>):</p><br>
<pre><code class="cpp hljs">    ...
    <span class="hljs-comment">//   ' '   .</span>
    await_setup(params-&gt;fd[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setgid(<span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<font></font>
      die(<span class="hljs-string">"Failed to setgid: %m\n"</span>);
    <span class="hljs-keyword">if</span> (setuid(<span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<font></font>
      die(<span class="hljs-string">"Failed to setuid: %m\n"</span>);<font></font>
    ...</code></pre><br>
<p>  ! <code>isolate</code>      user namespace.</p><br>
<pre><code class="bash hljs">$ ./isolate sh<font></font>
===========sh============<font></font>
$ id<font></font>
uid=0(root) gid=0(root)</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®æŠ•ç¨¿ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åå‰ç©ºé–“ã®æ©Ÿèƒ½ã«é–¢ã™ã‚‹è©³ç´°ãŒã‹ãªã‚Šã‚ã‚Šã¾ã—ãŸãŒã€çµå±€ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®šã¯æ¯”è¼ƒçš„ç°¡å˜ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã§ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¬¡ã®æŠ•ç¨¿ã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ã€…ã¯ä½¿ç”¨ã—ã¦ç§ãŸã¡è‡ªèº«ã®ãƒã‚¦ãƒ³ãƒˆåå‰ç©ºé–“ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚’æ¤œè¨ã—ã¾ã™</font></font><code>isolate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆèƒŒå¾Œã«ã‚ã‚‹ç§˜å¯†ã‚’æ˜ã‚‰ã‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘½ä»¤</font></font></a> <code>FROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‹ã‚‰ã®</font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">ãã“ã§ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é©åˆ‡ã«æ§‹æˆã™ã‚‹ãŸã‚ã«ã€Linuxã‚’ã‚‚ã†å°‘ã—æ”¯æ´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459560/index.html">ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã®æ©Ÿèƒ½ï¼šãƒŸãƒ£ãƒ³ãƒãƒ¼ã®æ—¢è£½ã®ã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆ50æ—¥ï¼‰</a></li>
<li><a href="../ja459562/index.html">å¾®åˆ†å¯èƒ½ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</a></li>
<li><a href="../ja459564/index.html">é–‹ç™ºè€…ãŒãƒ“ã‚¸ãƒã‚¹ã«ã¤ã„ã¦çŸ¥ã£ã¦ãŠãã¹ãã“ã¨</a></li>
<li><a href="../ja459568/index.html">æœ€æ–°ã®ITã«ãŠã‘ã‚‹ç¸¦æ›¸ã</a></li>
<li><a href="../ja459570/index.html">Beelineã¯Googleãƒœãƒƒãƒˆã«åºƒå‘Šã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ä¸å¹¸ãªãƒœãƒƒãƒˆ</a></li>
<li><a href="../ja459576/index.html">ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã«ã¨ã£ã¦ä¾¿åˆ©ãªGoogle Chromeæ‹¡å¼µæ©Ÿèƒ½</a></li>
<li><a href="../ja459578/index.html">å…¬å…±éƒ¨é–€ã‚ªãƒ¼ãƒ—ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </a></li>
<li><a href="../ja459580/index.html">ä»®æƒ³é›»è©±ã‚·ã‚¹ãƒ†ãƒ </a></li>
<li><a href="../ja459582/index.html">æ¦‚è¦ï¼šãƒ­ã‚·ã‚¢ã‹ã‚‰ã‚¢ãƒ¡ãƒªã‚«ä¼æ¥­ã®æ ªå¼ã‚’è³¼å…¥ã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja459584/index.html">Steve Wozniakã¨ã„ã†ç´ æ™´ã‚‰ã—ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>