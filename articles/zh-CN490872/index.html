<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏌️ 💢 🤚 三重奏-人的异步编程 🔫 ℹ️ 💓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Python有一个Trio库-异步编程库。
 认识Trio对于从事Asyncio工作的人们来说主要是有趣的，因为它是一个很好的选择，它使您能够解决Asyncio无法处理的一些问题。在这篇评论中，我们将考虑Trio是什么以及它具有什么功能。
 
 对于刚开始异步编程的人，我建议阅读有关异步和同步的简短...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>三重奏-人的异步编程</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/barsgroup/blog/490872/"><img src="https://habrastorage.org/webt/m7/0o/ye/m70oyejwkcwdk32csx1mq2wprao.jpeg" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python有一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库-异步编程库。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
认识Trio对于从事Asyncio工作的人们来说主要是有趣的，因为它是一个很好的选择，它使您能够解决Asyncio无法处理的一些问题。</font><font style="vertical-align: inherit;">在这篇评论中，我们将考虑Trio是什么以及它具有什么功能。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于刚开始异步编程的人，我建议阅读有关异步和同步的简短介绍。 </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同步与异步 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同步编程中，</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有操作都是按顺序执行的，并且只有在完成前一个任务后才能启动新任务。</font><font style="vertical-align: inherit;">但是，它的“痛点”之一是，如果其中一个线程在很长时间内一直在执行任务，则整个程序可能会冻结。</font><font style="vertical-align: inherit;">有些任务不需要计算能力，但会占用处理器时间，可以通过控制另一个线程来更合理地使用这些任务。</font><font style="vertical-align: inherit;">在同步编程中，无法暂停当前任务以完成其后的任务。</font><b><font style="vertical-align: inherit;">异步的作用</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？必须区分真实异步和输入输出异步。在我们的例子中，我们正在谈论异步输入输出。全球范围内-为了节省时间并更有效地利用生产设施。异步允许您绕过线程的问题区域。在异步输入输出中，当前线程将不等待某个外部事件的执行，而是将控制权交给另一个线程。因此，实际上一次只执行一个线程。拥有控制权的线程进入队列，等待控制权返回。也许到那时，预期的外部事件将发生，并且有可能继续工作。这将允许您在任务之间切换，以最大程度地减少时间浪费。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们可以回到什么</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASYNCIO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。此库</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件循环</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（事件循环）的操作，其中包括任务队列和循环本身。该周期控制任务的执行，即，它从队列中提取任务并确定将要发生的事情。例如，它可能正在处理I / O任务。即，事件循环选择任务，注册并在适当的时间开始其处理。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">协程</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是特殊的函数，可以将对此任务的控制权返回到事件循环，即将其返回到队列。这些协程必须通过一系列事件精确启动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也有</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">期货</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-存储任务执行的当前结果的对象。</font><font style="vertical-align: inherit;">这可能是有关任务尚未处理或已经获得结果的信息；</font><font style="vertical-align: inherit;">否则可能会有例外。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，Asyncio库是众所周知的，但是它具有Trio可以关闭的许多缺点。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三重奏</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据该库的作者</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nathaniel Smith的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">说法</font><font style="vertical-align: inherit;">，在开发Trio时，他试图为开发人员创建一个轻便且易于使用的工具，该工具将提供最简单的异步输入/输出和错误处理。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trio的一个重要功能是异步上下文管理，而Asyncio则没有。</font><font style="vertical-align: inherit;">为此，作者在Trio中创建了所谓的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“苗圃”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（护理）-取消区域负责一组线程的原子性（连续性）。关键思想是，如果在“托儿所”中某个协程失败，那么“托儿所”中的所有流程将成功完成或取消。无论如何，结果都是正确的。并且只有当所有协程都完成后，退出函数后，开发人员自己才决定如何进行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也就是说，“孩子们的”允许您阻止继续进行错误处理，这可能导致以下事实：要么一切都会“下降”，要么结果将是错误的结果。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这正是Asyncio可能发生的情况，因为在Asyncio中，即使发生错误，该过程也不会停止。</font><font style="vertical-align: inherit;">在这种情况下，首先，开发人员将不知道发生错误时确切发生了什么，其次，处理将继续。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例子 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考虑两个竞争功能的最简单示例：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
loop = asyncio.get_event_loop()<font></font>
bundle = asyncio.wait([<font></font>
    loop.create_task(foo1()),<font></font>
    loop.create_task(foo2()),<font></font>
])<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    loop.run_until_complete(bundle)<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    loop.close()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三重奏</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:<font></font>
        nursery.start_soon(foo1)<font></font>
        nursery.start_soon(foo2)<font></font>
<font></font>
trio.run(root)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这两种情况下，结果都是相同的：</font></font><br>
<br>
<pre><code class="python hljs">foo1: <font></font>
foo2: <font></font>
foo2: <font></font>
foo1: </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从结构上讲，此示例中的Asyncio和Trio代码相似。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明显的区别是Trio不需要显式完成事件循环。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考虑一个更生动的例子。</font><font style="vertical-align: inherit;">让我们调用Web服务以获得时间戳。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于Asyncio，我们将另外使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session, i))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS)<font></font>
        ]<font></font>
        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于Trio，我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
            nursery.start_soon(foo, i)<font></font>
<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
trio.run(root)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这两种情况下，我们都会得到类似</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">0</span> | <span class="hljs-number">1543837647522</span> (  <span class="hljs-number">0.11855053901672363</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543837647535</span> (  <span class="hljs-number">0.1389765739440918</span>)
<span class="hljs-number">3</span> | <span class="hljs-number">1543837647527</span> (  <span class="hljs-number">0.13904547691345215</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543837647557</span> (  <span class="hljs-number">0.1591191291809082</span>)
<span class="hljs-number">1</span> | <span class="hljs-number">1543837647607</span> (  <span class="hljs-number">0.2100353240966797</span>)<font></font>
  <span class="hljs-number">0.2102828025817871</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好。</font><font style="vertical-align: inherit;">想象一下，在执行协程之一期间</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，Asyncio </font><font style="vertical-align: inherit;">发生了错误</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-number">1</span> | <span class="hljs-number">1543839060815</span> (  <span class="hljs-number">0.10857725143432617</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839060844</span> (  <span class="hljs-number">0.10372781753540039</span>)
<span class="hljs-number">5</span> | <span class="hljs-number">1543839060843</span> (  <span class="hljs-number">0.10734415054321289</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543839060874</span> (  <span class="hljs-number">0.13985681533813477</span>)<font></font>
  <span class="hljs-number">0.15044045448303223</span><font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
三人组</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-number">4</span> | <span class="hljs-number">1543839223372</span> (  <span class="hljs-number">0.13524699211120605</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839223379</span> (  <span class="hljs-number">0.13848185539245605</span>)<font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">28</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<font></font>
    trio.run(root)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">1337</span>, <span class="hljs-keyword">in</span> run
    <span class="hljs-keyword">raise</span> runner.main_task_outcome.error<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">23</span>, <span class="hljs-keyword">in</span> root<font></font>
    nursery.start_soon(foo, i)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">397</span>, <span class="hljs-keyword">in</span> __aexit__
    <span class="hljs-keyword">raise</span> combined_error_from_nursery<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">15</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以清楚地看到，在Trio中，错误发生后，“取消区域”立即起作用，并且四个不包含错误的任务中的两个被异常终止。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Asyncio中，所有任务都已完成，然后才出现引用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在给定的示例中，这并不重要，但让我们想象一下，任务以一种或另一种方式相互依赖，并且任务集必须具有原子属性。在这种情况下，对错误的及时响应变得更加重要。当然，您可以使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await asyncio.wait（任务，return_when = FIRST_EXCEPTION）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但是您必须记住正确完成打开的任务。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是另一个示例：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设协程同时访问多个相似的Web服务，并且收到的第一个响应很重要。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> FIRST_COMPLETED
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()
        <span class="hljs-keyword">return</span> content.get(<span class="hljs-string">"time"</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, MAX_CLIENTS + <span class="hljs-number">1</span>)<font></font>
        ]<font></font>
        done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=FIRST_COMPLETED)<font></font>
        print(done.pop().result())<font></font>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> pending:<font></font>
            future.cancel()<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">except</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切都非常简单。</font><font style="vertical-align: inherit;">唯一的要求是记住要完成尚未完成的任务。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Trio中，执行类似的操作要困难一些，但几乎不可能立即使“尾巴”不可见：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, send_channel, nursery</span>):</span>
    response = <span class="hljs-keyword">await</span> session.request(<span class="hljs-string">'GET'</span>, url=URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel:<font></font>
        send_channel.send_nowait(content.get(<span class="hljs-string">"time"</span>))<font></font>
    nursery.cancel_scope.cancel()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    send_channel, receive_channel = trio.open_memory_channel(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel, receive_channel:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asks.Session() <span class="hljs-keyword">as</span> session:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
                    nursery.start_soon(foo, session, send_channel.clone(), nursery)<font></font>
<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receive_channel:<font></font>
            x = <span class="hljs-keyword">await</span> receive_channel.receive()<font></font>
            print(x)<font></font>
<font></font>
trio.run(root)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nursery.cancel_scope.cancel（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -完成的第一个协程将在撤消区域调用一个函数，该函数将取消所有其他任务，因此无需单独担心它。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
的确，为了将协程执行的结果传递给引起它的函数，您将必须启动一个通信通道。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
希望这篇比较评论能对Trio的主要功能有所了解。</font><font style="vertical-align: inherit;">谢谢大家！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN490850/index.html">帮助编译器帮助您</a></li>
<li><a href="../zh-CN490852/index.html">详细介绍SpinLaunch-航天工业中最热衷的秘密</a></li>
<li><a href="../zh-CN490854/index.html">使用AI对物品进行分类的仓库机器人已准备就绪</a></li>
<li><a href="../zh-CN490856/index.html">汽车地牢大师</a></li>
<li><a href="../zh-CN490862/index.html">LetsEncrypt计划由于软件错误而吊销其证书</a></li>
<li><a href="../zh-CN490874/index.html">故意实施远程工作：如何在不雇用任何人的情况下使结果翻倍</a></li>
<li><a href="../zh-CN490876/index.html">我们为什么要筋疲力尽？</a></li>
<li><a href="../zh-CN490882/index.html">修复Docker下的问题。看来，GIT与它有什么关系？</a></li>
<li><a href="../zh-CN490884/index.html">DEFCON会议27.您的车是我的车。第1部分</a></li>
<li><a href="../zh-CN490888/index.html">为梦幻般的女人选择礼物</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>