<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒï¸ ğŸ’¢ ğŸ¤š ä¸‰é‡å¥-äººçš„å¼‚æ­¥ç¼–ç¨‹ ğŸ”« â„¹ï¸ ğŸ’“</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pythonæœ‰ä¸€ä¸ªTrioåº“-å¼‚æ­¥ç¼–ç¨‹åº“ã€‚
 è®¤è¯†Trioå¯¹äºä»äº‹Asyncioå·¥ä½œçš„äººä»¬æ¥è¯´ä¸»è¦æ˜¯æœ‰è¶£çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå®ƒä½¿æ‚¨èƒ½å¤Ÿè§£å†³Asyncioæ— æ³•å¤„ç†çš„ä¸€äº›é—®é¢˜ã€‚åœ¨è¿™ç¯‡è¯„è®ºä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘Trioæ˜¯ä»€ä¹ˆä»¥åŠå®ƒå…·æœ‰ä»€ä¹ˆåŠŸèƒ½ã€‚
 
 å¯¹äºåˆšå¼€å§‹å¼‚æ­¥ç¼–ç¨‹çš„äººï¼Œæˆ‘å»ºè®®é˜…è¯»æœ‰å…³å¼‚æ­¥å’ŒåŒæ­¥çš„ç®€çŸ­...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ä¸‰é‡å¥-äººçš„å¼‚æ­¥ç¼–ç¨‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/barsgroup/blog/490872/"><img src="https://habrastorage.org/webt/m7/0o/ye/m70oyejwkcwdk32csx1mq2wprao.jpeg" alt="å›¾ç‰‡"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonæœ‰ä¸€ä¸ª</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åº“-å¼‚æ­¥ç¼–ç¨‹åº“ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®¤è¯†Trioå¯¹äºä»äº‹Asyncioå·¥ä½œçš„äººä»¬æ¥è¯´ä¸»è¦æ˜¯æœ‰è¶£çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå®ƒä½¿æ‚¨èƒ½å¤Ÿè§£å†³Asyncioæ— æ³•å¤„ç†çš„ä¸€äº›é—®é¢˜ã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™ç¯‡è¯„è®ºä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘Trioæ˜¯ä»€ä¹ˆä»¥åŠå®ƒå…·æœ‰ä»€ä¹ˆåŠŸèƒ½ã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºåˆšå¼€å§‹å¼‚æ­¥ç¼–ç¨‹çš„äººï¼Œæˆ‘å»ºè®®é˜…è¯»æœ‰å…³å¼‚æ­¥å’ŒåŒæ­¥çš„ç®€çŸ­ä»‹ç»ã€‚ </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒæ­¥ä¸å¼‚æ­¥ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒæ­¥ç¼–ç¨‹ä¸­ï¼Œ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€æœ‰æ“ä½œéƒ½æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨å®Œæˆå‰ä¸€ä¸ªä»»åŠ¡åæ‰èƒ½å¯åŠ¨æ–°ä»»åŠ¡ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå®ƒçš„â€œç—›ç‚¹â€ä¹‹ä¸€æ˜¯ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹åœ¨å¾ˆé•¿æ—¶é—´å†…ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™æ•´ä¸ªç¨‹åºå¯èƒ½ä¼šå†»ç»“ã€‚</font><font style="vertical-align: inherit;">æœ‰äº›ä»»åŠ¡ä¸éœ€è¦è®¡ç®—èƒ½åŠ›ï¼Œä½†ä¼šå ç”¨å¤„ç†å™¨æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å¦ä¸€ä¸ªçº¿ç¨‹æ¥æ›´åˆç†åœ°ä½¿ç”¨è¿™äº›ä»»åŠ¡ã€‚</font><font style="vertical-align: inherit;">åœ¨åŒæ­¥ç¼–ç¨‹ä¸­ï¼Œæ— æ³•æš‚åœå½“å‰ä»»åŠ¡ä»¥å®Œæˆå…¶åçš„ä»»åŠ¡ã€‚</font><b><font style="vertical-align: inherit;">å¼‚æ­¥çš„ä½œç”¨</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»€ä¹ˆï¼Ÿ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Ÿå¿…é¡»åŒºåˆ†çœŸå®å¼‚æ­¥å’Œè¾“å…¥è¾“å‡ºå¼‚æ­¥ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨è°ˆè®ºå¼‚æ­¥è¾“å…¥è¾“å‡ºã€‚å…¨çƒèŒƒå›´å†…-ä¸ºäº†èŠ‚çœæ—¶é—´å¹¶æ›´æœ‰æ•ˆåœ°åˆ©ç”¨ç”Ÿäº§è®¾æ–½ã€‚å¼‚æ­¥å…è®¸æ‚¨ç»•è¿‡çº¿ç¨‹çš„é—®é¢˜åŒºåŸŸã€‚åœ¨å¼‚æ­¥è¾“å…¥è¾“å‡ºä¸­ï¼Œå½“å‰çº¿ç¨‹å°†ä¸ç­‰å¾…æŸä¸ªå¤–éƒ¨äº‹ä»¶çš„æ‰§è¡Œï¼Œè€Œæ˜¯å°†æ§åˆ¶æƒäº¤ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚å› æ­¤ï¼Œå®é™…ä¸Šä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚æ‹¥æœ‰æ§åˆ¶æƒçš„çº¿ç¨‹è¿›å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æ§åˆ¶æƒè¿”å›ã€‚ä¹Ÿè®¸åˆ°é‚£æ—¶ï¼Œé¢„æœŸçš„å¤–éƒ¨äº‹ä»¶å°†å‘ç”Ÿï¼Œå¹¶ä¸”æœ‰å¯èƒ½ç»§ç»­å·¥ä½œã€‚è¿™å°†å…è®¸æ‚¨åœ¨ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä»¥æœ€å¤§ç¨‹åº¦åœ°å‡å°‘æ—¶é—´æµªè´¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨æˆ‘ä»¬å¯ä»¥å›åˆ°ä»€ä¹ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASYNCIO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æ­¤åº“</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹ä»¶å¾ªç¯</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰çš„æ“ä½œï¼Œå…¶ä¸­åŒ…æ‹¬ä»»åŠ¡é˜Ÿåˆ—å’Œå¾ªç¯æœ¬èº«ã€‚è¯¥å‘¨æœŸæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œï¼Œå³ï¼Œå®ƒä»é˜Ÿåˆ—ä¸­æå–ä»»åŠ¡å¹¶ç¡®å®šå°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½æ­£åœ¨å¤„ç†I / Oä»»åŠ¡ã€‚å³ï¼Œäº‹ä»¶å¾ªç¯é€‰æ‹©ä»»åŠ¡ï¼Œæ³¨å†Œå¹¶åœ¨é€‚å½“çš„æ—¶é—´å¼€å§‹å…¶å¤„ç†ã€‚</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åç¨‹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯ç‰¹æ®Šçš„å‡½æ•°ï¼Œå¯ä»¥å°†å¯¹æ­¤ä»»åŠ¡çš„æ§åˆ¶æƒè¿”å›åˆ°äº‹ä»¶å¾ªç¯ï¼Œå³å°†å…¶è¿”å›åˆ°é˜Ÿåˆ—ã€‚è¿™äº›åç¨‹å¿…é¡»é€šè¿‡ä¸€ç³»åˆ—äº‹ä»¶ç²¾ç¡®å¯åŠ¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¹Ÿæœ‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœŸè´§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-å­˜å‚¨ä»»åŠ¡æ‰§è¡Œçš„å½“å‰ç»“æœçš„å¯¹è±¡ã€‚</font><font style="vertical-align: inherit;">è¿™å¯èƒ½æ˜¯æœ‰å…³ä»»åŠ¡å°šæœªå¤„ç†æˆ–å·²ç»è·å¾—ç»“æœçš„ä¿¡æ¯ï¼›</font><font style="vertical-align: inherit;">å¦åˆ™å¯èƒ½ä¼šæœ‰ä¾‹å¤–ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šå¸¸ï¼ŒAsyncioåº“æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ï¼Œä½†æ˜¯å®ƒå…·æœ‰Trioå¯ä»¥å…³é—­çš„è®¸å¤šç¼ºç‚¹ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‰é‡å¥</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ ¹æ®è¯¥åº“çš„ä½œè€…</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nathaniel Smithçš„</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯´æ³•</font><font style="vertical-align: inherit;">ï¼Œåœ¨å¼€å‘Trioæ—¶ï¼Œä»–è¯•å›¾ä¸ºå¼€å‘äººå‘˜åˆ›å»ºä¸€ä¸ªè½»ä¾¿ä¸”æ˜“äºä½¿ç”¨çš„å·¥å…·ï¼Œè¯¥å·¥å…·å°†æä¾›æœ€ç®€å•çš„å¼‚æ­¥è¾“å…¥/è¾“å‡ºå’Œé”™è¯¯å¤„ç†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trioçš„ä¸€ä¸ªé‡è¦åŠŸèƒ½æ˜¯å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œè€ŒAsyncioåˆ™æ²¡æœ‰ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œä½œè€…åœ¨Trioä¸­åˆ›å»ºäº†æ‰€è°“çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œè‹—åœƒâ€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆæŠ¤ç†ï¼‰-å–æ¶ˆåŒºåŸŸè´Ÿè´£ä¸€ç»„çº¿ç¨‹çš„åŸå­æ€§ï¼ˆè¿ç»­æ€§ï¼‰ã€‚å…³é”®æ€æƒ³æ˜¯ï¼Œå¦‚æœåœ¨â€œæ‰˜å„¿æ‰€â€ä¸­æŸä¸ªåç¨‹å¤±è´¥ï¼Œé‚£ä¹ˆâ€œæ‰˜å„¿æ‰€â€ä¸­çš„æ‰€æœ‰æµç¨‹å°†æˆåŠŸå®Œæˆæˆ–å–æ¶ˆã€‚æ— è®ºå¦‚ä½•ï¼Œç»“æœéƒ½æ˜¯æ­£ç¡®çš„ã€‚å¹¶ä¸”åªæœ‰å½“æ‰€æœ‰åç¨‹éƒ½å®Œæˆåï¼Œé€€å‡ºå‡½æ•°åï¼Œå¼€å‘äººå‘˜è‡ªå·±æ‰å†³å®šå¦‚ä½•è¿›è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œå­©å­ä»¬çš„â€å…è®¸æ‚¨é˜»æ­¢ç»§ç»­è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»¥ä¸‹äº‹å®ï¼šè¦ä¹ˆä¸€åˆ‡éƒ½ä¼šâ€œä¸‹é™â€ï¼Œè¦ä¹ˆç»“æœå°†æ˜¯é”™è¯¯çš„ç»“æœã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ­£æ˜¯Asyncioå¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼Œå› ä¸ºåœ¨Asyncioä¸­ï¼Œå³ä½¿å‘ç”Ÿé”™è¯¯ï¼Œè¯¥è¿‡ç¨‹ä¹Ÿä¸ä¼šåœæ­¢ã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆï¼Œå¼€å‘äººå‘˜å°†ä¸çŸ¥é“å‘ç”Ÿé”™è¯¯æ—¶ç¡®åˆ‡å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå…¶æ¬¡ï¼Œå¤„ç†å°†ç»§ç»­ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹å­ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è€ƒè™‘ä¸¤ä¸ªç«äº‰åŠŸèƒ½çš„æœ€ç®€å•ç¤ºä¾‹ï¼š</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
loop = asyncio.get_event_loop()<font></font>
bundle = asyncio.wait([<font></font>
    loop.create_task(foo1()),<font></font>
    loop.create_task(foo2()),<font></font>
])<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    loop.run_until_complete(bundle)<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    loop.close()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‰é‡å¥</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:<font></font>
        nursery.start_soon(foo1)<font></font>
        nursery.start_soon(foo2)<font></font>
<font></font>
trio.run(root)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œç»“æœéƒ½æ˜¯ç›¸åŒçš„ï¼š</font></font><br>
<br>
<pre><code class="python hljs">foo1: <font></font>
foo2: <font></font>
foo2: <font></font>
foo1: </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»ç»“æ„ä¸Šè®²ï¼Œæ­¤ç¤ºä¾‹ä¸­çš„Asyncioå’ŒTrioä»£ç ç›¸ä¼¼ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ˜æ˜¾çš„åŒºåˆ«æ˜¯Trioä¸éœ€è¦æ˜¾å¼å®Œæˆäº‹ä»¶å¾ªç¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è€ƒè™‘ä¸€ä¸ªæ›´ç”ŸåŠ¨çš„ä¾‹å­ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬è°ƒç”¨WebæœåŠ¡ä»¥è·å¾—æ—¶é—´æˆ³ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºAsyncioï¼Œæˆ‘ä»¬å°†å¦å¤–ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session, i))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS)<font></font>
        ]<font></font>
        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºTrioï¼Œæˆ‘ä»¬ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
            nursery.start_soon(foo, i)<font></font>
<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
trio.run(root)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šå¾—åˆ°ç±»ä¼¼</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">0</span> | <span class="hljs-number">1543837647522</span> (  <span class="hljs-number">0.11855053901672363</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543837647535</span> (  <span class="hljs-number">0.1389765739440918</span>)
<span class="hljs-number">3</span> | <span class="hljs-number">1543837647527</span> (  <span class="hljs-number">0.13904547691345215</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543837647557</span> (  <span class="hljs-number">0.1591191291809082</span>)
<span class="hljs-number">1</span> | <span class="hljs-number">1543837647607</span> (  <span class="hljs-number">0.2100353240966797</span>)<font></font>
  <span class="hljs-number">0.2102828025817871</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½ã€‚</font><font style="vertical-align: inherit;">æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨æ‰§è¡Œåç¨‹ä¹‹ä¸€æœŸé—´</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ŒAsyncio </font><font style="vertical-align: inherit;">å‘ç”Ÿäº†é”™è¯¯</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-number">1</span> | <span class="hljs-number">1543839060815</span> (  <span class="hljs-number">0.10857725143432617</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839060844</span> (  <span class="hljs-number">0.10372781753540039</span>)
<span class="hljs-number">5</span> | <span class="hljs-number">1543839060843</span> (  <span class="hljs-number">0.10734415054321289</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543839060874</span> (  <span class="hljs-number">0.13985681533813477</span>)<font></font>
  <span class="hljs-number">0.15044045448303223</span><font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸‰äººç»„</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-number">4</span> | <span class="hljs-number">1543839223372</span> (  <span class="hljs-number">0.13524699211120605</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839223379</span> (  <span class="hljs-number">0.13848185539245605</span>)<font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">28</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<font></font>
    trio.run(root)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">1337</span>, <span class="hljs-keyword">in</span> run
    <span class="hljs-keyword">raise</span> runner.main_task_outcome.error<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">23</span>, <span class="hljs-keyword">in</span> root<font></font>
    nursery.start_soon(foo, i)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">397</span>, <span class="hljs-keyword">in</span> __aexit__
    <span class="hljs-keyword">raise</span> combined_error_from_nursery<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">15</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œåœ¨Trioä¸­ï¼Œé”™è¯¯å‘ç”Ÿåï¼Œâ€œå–æ¶ˆåŒºåŸŸâ€ç«‹å³èµ·ä½œç”¨ï¼Œå¹¶ä¸”å››ä¸ªä¸åŒ…å«é”™è¯¯çš„ä»»åŠ¡ä¸­çš„ä¸¤ä¸ªè¢«å¼‚å¸¸ç»ˆæ­¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨Asyncioä¸­ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œç„¶åæ‰å‡ºç°å¼•ç”¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ç»™å®šçš„ç¤ºä¾‹ä¸­ï¼Œè¿™å¹¶ä¸é‡è¦ï¼Œä½†è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œä»»åŠ¡ä»¥ä¸€ç§æˆ–å¦ä¸€ç§æ–¹å¼ç›¸äº’ä¾èµ–ï¼Œå¹¶ä¸”ä»»åŠ¡é›†å¿…é¡»å…·æœ‰åŸå­å±æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹é”™è¯¯çš„åŠæ—¶å“åº”å˜å¾—æ›´åŠ é‡è¦ã€‚å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await asyncio.waitï¼ˆä»»åŠ¡ï¼Œreturn_when = FIRST_EXCEPTIONï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä½†æ˜¯æ‚¨å¿…é¡»è®°ä½æ­£ç¡®å®Œæˆæ‰“å¼€çš„ä»»åŠ¡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ˜¯å¦ä¸€ä¸ªç¤ºä¾‹ï¼š</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‡è®¾åç¨‹åŒæ—¶è®¿é—®å¤šä¸ªç›¸ä¼¼çš„WebæœåŠ¡ï¼Œå¹¶ä¸”æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå“åº”å¾ˆé‡è¦ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> FIRST_COMPLETED
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()
        <span class="hljs-keyword">return</span> content.get(<span class="hljs-string">"time"</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, MAX_CLIENTS + <span class="hljs-number">1</span>)<font></font>
        ]<font></font>
        done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=FIRST_COMPLETED)<font></font>
        print(done.pop().result())<font></font>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> pending:<font></font>
            future.cancel()<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">except</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€åˆ‡éƒ½éå¸¸ç®€å•ã€‚</font><font style="vertical-align: inherit;">å”¯ä¸€çš„è¦æ±‚æ˜¯è®°ä½è¦å®Œæˆå°šæœªå®Œæˆçš„ä»»åŠ¡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨Trioä¸­ï¼Œæ‰§è¡Œç±»ä¼¼çš„æ“ä½œè¦å›°éš¾ä¸€äº›ï¼Œä½†å‡ ä¹ä¸å¯èƒ½ç«‹å³ä½¿â€œå°¾å·´â€ä¸å¯è§ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, send_channel, nursery</span>):</span>
    response = <span class="hljs-keyword">await</span> session.request(<span class="hljs-string">'GET'</span>, url=URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel:<font></font>
        send_channel.send_nowait(content.get(<span class="hljs-string">"time"</span>))<font></font>
    nursery.cancel_scope.cancel()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    send_channel, receive_channel = trio.open_memory_channel(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel, receive_channel:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asks.Session() <span class="hljs-keyword">as</span> session:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
                    nursery.start_soon(foo, session, send_channel.clone(), nursery)<font></font>
<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receive_channel:<font></font>
            x = <span class="hljs-keyword">await</span> receive_channel.receive()<font></font>
            print(x)<font></font>
<font></font>
trio.run(root)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nursery.cancel_scope.cancelï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -å®Œæˆçš„ç¬¬ä¸€ä¸ªåç¨‹å°†åœ¨æ’¤æ¶ˆåŒºåŸŸè°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†å–æ¶ˆæ‰€æœ‰å…¶ä»–ä»»åŠ¡ï¼Œå› æ­¤æ— éœ€å•ç‹¬æ‹…å¿ƒå®ƒã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çš„ç¡®ï¼Œä¸ºäº†å°†åç¨‹æ‰§è¡Œçš„ç»“æœä¼ é€’ç»™å¼•èµ·å®ƒçš„å‡½æ•°ï¼Œæ‚¨å°†å¿…é¡»å¯åŠ¨ä¸€ä¸ªé€šä¿¡é€šé“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¸Œæœ›è¿™ç¯‡æ¯”è¾ƒè¯„è®ºèƒ½å¯¹Trioçš„ä¸»è¦åŠŸèƒ½æœ‰æ‰€äº†è§£ã€‚</font><font style="vertical-align: inherit;">è°¢è°¢å¤§å®¶ï¼</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN490850/index.html">å¸®åŠ©ç¼–è¯‘å™¨å¸®åŠ©æ‚¨</a></li>
<li><a href="../zh-CN490852/index.html">è¯¦ç»†ä»‹ç»SpinLaunch-èˆªå¤©å·¥ä¸šä¸­æœ€çƒ­è¡·çš„ç§˜å¯†</a></li>
<li><a href="../zh-CN490854/index.html">ä½¿ç”¨AIå¯¹ç‰©å“è¿›è¡Œåˆ†ç±»çš„ä»“åº“æœºå™¨äººå·²å‡†å¤‡å°±ç»ª</a></li>
<li><a href="../zh-CN490856/index.html">æ±½è½¦åœ°ç‰¢å¤§å¸ˆ</a></li>
<li><a href="../zh-CN490862/index.html">LetsEncryptè®¡åˆ’ç”±äºè½¯ä»¶é”™è¯¯è€ŒåŠé”€å…¶è¯ä¹¦</a></li>
<li><a href="../zh-CN490874/index.html">æ•…æ„å®æ–½è¿œç¨‹å·¥ä½œï¼šå¦‚ä½•åœ¨ä¸é›‡ç”¨ä»»ä½•äººçš„æƒ…å†µä¸‹ä½¿ç»“æœç¿»å€</a></li>
<li><a href="../zh-CN490876/index.html">æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç­‹ç–²åŠ›å°½ï¼Ÿ</a></li>
<li><a href="../zh-CN490882/index.html">ä¿®å¤Dockerä¸‹çš„é—®é¢˜ã€‚çœ‹æ¥ï¼ŒGITä¸å®ƒæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</a></li>
<li><a href="../zh-CN490884/index.html">DEFCONä¼šè®®27.æ‚¨çš„è½¦æ˜¯æˆ‘çš„è½¦ã€‚ç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN490888/index.html">ä¸ºæ¢¦å¹»èˆ¬çš„å¥³äººé€‰æ‹©ç¤¼ç‰©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>