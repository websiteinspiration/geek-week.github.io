<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇🏾 👀 🤫 Kami bekerja dengan sensor CO Detector Xiaomi ClearGrass Air Detector secara lokal, tanpa server Cina 🙏🏽 🌾 💈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Untuk waktu yang lama saya berencana untuk memperkenalkan sensor karbon dioksida CO₂ di otomatisasi rumah. Dari segi harga / kualitas / fungsi / penam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kami bekerja dengan sensor CO Detector Xiaomi ClearGrass Air Detector secara lokal, tanpa server Cina</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493220/"><img src="https://habrastorage.org/webt/hn/ly/y5/hnlyy5b88_sljyfalw7vhvutvpk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk waktu yang lama saya berencana untuk memperkenalkan sensor karbon dioksida CO₂ di otomatisasi rumah. </font><font style="vertical-align: inherit;">Dari segi harga / kualitas / fungsi / penampilan, Xiaomi ClearGrass Air Detector ternyata menjadi yang terbaik untuk saya. </font><font style="vertical-align: inherit;">Penganalisa kualitas udara mengandung sensor:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CO₂</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tVOC (senyawa organik yang mudah menguap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PM2.5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suhu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kelembaban</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClearGrass memiliki layar berkualitas tinggi dengan sudut pandang besar dan baterai selama 6 jam masa pakai baterai. </font><font style="vertical-align: inherit;">Harga di wilayah $ 130 untuk perangkat semacam itu menerjemahkannya ke dalam segmen must-have! </font><font style="vertical-align: inherit;">Ulasan bagus bisa dibaca di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysku.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alat analisis dapat ditambahkan ke aplikasi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qingping +</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atau </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MiHome asli</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dalam kedua kasus data melewati server Cina, yang pasti tidak cocok untuk saya. </font><font style="vertical-align: inherit;">Saya memutuskan untuk mencari cara mendapatkan data dari sensor secara lokal tanpa menggunakan server jarak jauh pihak ketiga.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Pelajari traffic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Langkah pertama adalah melihat bagaimana ClearGrass mentransfer data ke aplikasi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ qingping</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ClearGrass terhubung ke Internet melalui Wi-Fi. </font><font style="vertical-align: inherit;">Untuk mendengarkan lalu lintas, saya menaikkan titik akses pada Raspberry Pi Wi-Fi dan mulai tcpdump untuk mengumpulkan informasi:</font></font><br>
<br>
<pre><code class="bash hljs">sudo tcpdump -i wlan0 -vv -s0 -X -n port 1883 -s 65535 -w cleargrass.pcap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analisis lalu lintas menunjukkan bahwa ClearGrass mengakses sekitar 5 alamat IP yang berbeda, dan pada 154.8.191.174 ia mentransmisikan </font><font style="vertical-align: inherit;">data kualitas udara yang </font><font style="vertical-align: inherit;">tidak dienkripsi menggunakan protokol </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x5/6f/2t/x56f2t0busaoxisazagrv-sgsxe.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Kami membungkus lalu lintas dari ClearGrass di Raspberry Pi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah bereksperimen sedikit dengan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptables,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saya sampai pada aturan ini:</font></font><br>
<br>
<pre><code class="bash hljs">sudo iptables -i wlan0 -t nat -A PREROUTING -s 192.168.115.19 -j REDIRECT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bunyinya seperti ini: "Semua lalu lintas baru pada antarmuka wlan0 dari 192.168.115.19 (IP ClearGrass) harus dialihkan secara lokal." </font><font style="vertical-align: inherit;">Saya bukan ahli besar iptables, jadi saya akan senang dengan saran dan perbaikan. </font><font style="vertical-align: inherit;">Ada minus dalam aturan ini, jika penganalisis sudah terhubung ke Raspberry Pi, maka lalu lintas tidak akan dialihkan. </font><font style="vertical-align: inherit;">Pertama, Anda perlu menjalankan aturan dan hanya kemudian menghubungkan ClearGrass ke Raspberry Pi melalui Wi-Fi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya, setelah mengambil makelar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mosquitto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MQTT </font><font style="vertical-align: inherit;">di Raspberry Pi, saya melihat bahwa penganalisa mengirimkan data kualitas udara sekali dalam satu menit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. MQTT nano-broker di JS untuk otomatisasi rumah Z-Way</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai server otomatisasi rumah, saya menggunakan Z-Way, yang mendukung banyak perangkat Z-Wave dan kemampuan untuk menulis skrip dalam JS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/51/e5/bs/51e5bsz8q3zogjrys3rpah6tcx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya untuk Z-Way tidak ada broker MQTT di JS (tidak seperti sistem berdasarkan node.js), jadi saya memutuskan untuk menulis broker minimal yang hanya menerima data dari analisa ini dan tidak dapat melakukan hal lain. </font><font style="vertical-align: inherit;">Tanpa membaca dokumentasi secara khusus, saya melihat komunikasi antara penganalisa dan mosquitto dan menyusun urutan berikut:</font></font><br>
<br>
<pre><code class="bash hljs">MQTT PROTOCOL<font></font>
<font></font>
Connect Command (sensor -&gt; broker)<font></font>
	0x10 - Connect Command<font></font>
<font></font>
Connect Ack (broker -&gt; sensor)<font></font>
	0x20 - Connect Ack<font></font>
	0x02 - Len 2<font></font>
	0x00<font></font>
	0x00 - Connection Accepted<font></font>
<font></font>
Subscribe Request (sensor -&gt; broker)<font></font>
	0x82 - 0b1000 0010; 0b1000 - Subscribe Request<font></font>
<font></font>
Subscribe Ack (broker -&gt; sensor)<font></font>
	0x90 - 0b1001 0000; 0b1001 - Subscribe Ack<font></font>
	0x03 - Len 3<font></font>
	0x00<font></font>
	0x08 - Message identifier 8<font></font>
	0x00 - Fire and Forget<font></font>
<font></font>
Ping Request (sensor -&gt; broker)<font></font>
	0xC0 - Ping Request<font></font>
	0x00 - Len 0<font></font>
<font></font>
Ping Response (broker -&gt; sensor)<font></font>
	0xD0 - Ping Response<font></font>
	0x00 - Len 0<font></font>
<font></font>
Publish Message (sensor -&gt; broker)<font></font>
	0x30 - Publish Message<font></font>
	0x96<font></font>
	0x04 - Len 534</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, lahirlah skrip JS sederhana:</font></font><br>
<br>
<pre><code class="javascript hljs">mqttSocket.reusable();<font></font>
mqttSocket.bind(<span class="hljs-number">1883</span>);<font></font>
mqttSocket.onrecv = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, host, port</span>) </span>{
	<span class="hljs-keyword">var</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(data);<font></font>
<font></font>
	<span class="hljs-keyword">switch</span>(arr[<span class="hljs-number">0</span>]) {
		<span class="hljs-comment">// PING</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0xC0</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT PING RESPONSE"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0xD0</span>, <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// CONNECT</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x10</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT CONNECT ACK"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0x20</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// SUBSCRIBE</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x82</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT SUBSCRIBE ACK"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0x90</span>, <span class="hljs-number">0x03</span>, arr[<span class="hljs-number">2</span>], arr[<span class="hljs-number">3</span>], <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// PUBLISH</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x30</span>:
			<span class="hljs-keyword">var</span> sensorPayload = self.getPayload(arr);
			<span class="hljs-keyword">var</span> sensorMessage = sensorPayload.substr(sensorPayload.indexOf(<span class="hljs-string">'{'</span>), sensorPayload.lastIndexOf(<span class="hljs-string">'}'</span>));
			<span class="hljs-keyword">var</span> sensorObj = <span class="hljs-built_in">JSON</span>.parse(sensorMessage);
			<span class="hljs-built_in">console</span>.logJS(<span class="hljs-string">"---------- MQTT MESSAGE:"</span>, sensorObj);
			<span class="hljs-built_in">console</span>.logJS(<span class="hljs-string">"---------- CO2: "</span>, sensorObj.data.co2);<font></font>
			self.vDevCO2.set(<span class="hljs-string">"metrics:level"</span>, sensorObj.data.co2);
			<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
};<font></font>
mqttSocket.listen();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentu saja, sementara banyak yang tidak diperhitungkan, misalnya, dalam satu premis, baik PING dan MESSAGE mungkin datang, tetapi saya akan melewatkan beberapa di antaranya. </font><font style="vertical-align: inherit;">Mungkin di masa depan saya akan menggunakan basis kode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aedes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk membuat broker MQTT untuk Z-Way. </font><font style="vertical-align: inherit;">Dan saat ini, tujuannya adalah kesempatan mendasar untuk mendapatkan data kualitas udara lokal dari penganalisa Xiaomi ClearGrass Air Detector dan tujuan ini tercapai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di masa depan saya ingin menginstal versi Z-Wave dari nafas TION S3 dan mengendalikannya berdasarkan data dari ClearGrass.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id493202/index.html">RBK.money telah merilis pemrosesan pembayaran open-source pertama di dunia - menciptakan masa depan bersama</a></li>
<li><a href="../id493204/index.html">Alexey Komissarov tentang Digital Breakthrough 2020</a></li>
<li><a href="../id493206/index.html">Beberapa contoh mengirim permintaan ke server</a></li>
<li><a href="../id493208/index.html">Pencetakan 3D dengan photopolymer dalam hitungan detik</a></li>
<li><a href="../id493210/index.html">Pencetakan 3D perlindungan pandemi</a></li>
<li><a href="../id493222/index.html">Coronavirus dan industri TI - apa yang terjadi sekarang dan apa yang dapat diharapkan dalam waktu dekat</a></li>
<li><a href="../id493224/index.html">Bagaimana saya menyiarkan seminar dan para siswa bahkan berbicara kepada saya</a></li>
<li><a href="../id493226/index.html">Cara membaca dan memperbaiki 100.000 baris kode per minggu</a></li>
<li><a href="../id493230/index.html">Google PageSpeed ​​Insights baru yang diberdayakan oleh Lighthouse 6 (beta): periksa kinerja situs Anda</a></li>
<li><a href="../id493232/index.html">Sejarah pekerjaan saya di Open Product LLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>