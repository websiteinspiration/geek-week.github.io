<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏾 🧓🏽 👃🏾 FFmpeg libav手册 ✊🏽 🧔🏿 👝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="很久以来，我一直在搜寻一本可以使用类似FFmpeg的库libav的书（该库的名称代表lib rary a udio v ideo）。找到一本教科书“ 如何编写视频播放器并适合少于一千行。”不幸的是，那里的信息已经过时，所以我不得不自己创建一个手册。
 
 大多数代码将使用C语言，但是请放心：您将轻松...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FFmpeg libav手册</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/edison/blog/495614/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><div style="text-align:center;"><img width="779" height="232" src="https://habrastorage.org/webt/yn/ed/vp/ynedvpoyntkab2ppkqxuqtrbwma.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
很久</font><b><font style="vertical-align: inherit;">以来</font></b><font style="vertical-align: inherit;">，我一直在搜寻一本可以使用</font><b><font style="vertical-align: inherit;">类似</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的库</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libav的书</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（该</font><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">的名称代表</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rary </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> udio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。找到一本教科书“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何编写视频播放器并适合少于一千行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。”不幸的是，那里的信息已经过时，所以我不得不自己创建一个手册。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大多数代码将使用C语言，但是请放心：您将轻松理解所有内容，并可以用自己喜欢的语言来应用它。 FFmpeg libav与许多语言（包括Python和Go）有很多绑定。但是，即使您的语言不具有直接兼容性，您仍然</font><font style="vertical-align: inherit;">可以</font><font style="vertical-align: inherit;">通过</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffi进行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">附加</font><font style="vertical-align: inherit;">（这是一个示例，其中包含</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从视频，音频，编解码器和容器的简短内容入手。</font><font style="vertical-align: inherit;">然后，我们继续使用FFmpeg命令行进入速成课程，最后编写代码。</font><font style="vertical-align: inherit;">随意直接进入“学习FFmpeg libav的棘手路径”部分。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有一种观点（不仅是我的观点）认为，流媒体互联网视频已经从传统电视中夺取了接力棒。</font><font style="vertical-align: inherit;">尽管如此，FFmpeg libav绝对值得探索。</font></font><a name="menu"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视频就是您所看到的！</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">音频就是您所听到的！</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编解码器-数据压缩</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容器是存储音频/视频的便捷方式</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg命令行</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg 101命令行工具</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视频基本操作</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转码</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多路复用</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换中</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换中</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奖励：自适应流</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">超越</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   FFmpeg libav</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 0 —  «Hello World»</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FFmpeg libav </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">, </a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 1 —    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 2 — </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 3 — </a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></li>
</ul></li>
</ul></li>
</ul><a name="intro"></a><a name="video"></a><a name="habracut"></a><blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="EDISON软件-网络开发"><img align="left" width="153" height="75" src="https://habrastorage.org/webt/w0/zl/to/w0zltoxvysbr0yeinstkfvw1wbg.png" alt="EDISON软件-网络开发"></a><br clear="right">
     EDISON.<br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  ,  </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   </a>.<br>
<br>
     ! ;-)</blockquote><img align="right" width="210" height="280" src="https://habrastorage.org/webt/5k/lz/nu/5klznusfiwgawobmtbcrpdboscw.jpeg"><br clear="left">
<h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">↑</a></h2><br>
<h3> —  ,   ! <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">↑</a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果以给定的频率（例如每秒24张图像）更改图像序列，则会产生运动的错觉。</font><font style="vertical-align: inherit;">这是视频的主要思想：一系列以给定速度运动的图像（帧）。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1886年插图。</font></font></i><br>
<br>
<a name="audio"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">音频就是您所听到的！</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管无声视频会引起各种各样的感觉，但是添加声音会极大地增加乐趣。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
声音是在空气或任何其他传输介质（例如气体，液体或固体）中传播的振动波。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在数字音频系统中，麦克风将声音转换为模拟电信号。</font><font style="vertical-align: inherit;">然后，</font><font style="vertical-align: inherit;">通常使用脉冲编码调制（</font><b><font style="vertical-align: inherit;">PCM</font></b><font style="vertical-align: inherit;">）的</font><font style="vertical-align: inherit;">模数转换器（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">将模拟信号转换为数字信号。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<div style="text-align:center;"><img width="640" height="220" src="https://habrastorage.org/webt/eu/gb/_m/eugb_mwqa5x5yctawseum7qdtss.png"></div><br>
<a name="codec"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编解码器-数据压缩</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
编解码器是一种压缩或解压缩数字音频/视频的电子电路或软件。</font><font style="vertical-align: inherit;">它将原始（未压缩的）数字音频/视频转换为压缩格式（反之亦然）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果我们决定将数百万个图像打包到一个文件中并称为电影，那么我们可以获得一个巨大的文件。</font><font style="vertical-align: inherit;">我们来计算</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一下</font><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">假设我们创建了一个分辨率为1080×1920（高×宽）的视频。</font><font style="vertical-align: inherit;">我们每个像素花费3个字节（屏幕上的最小点）进行颜色编码（24位颜色，这提供了</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16,777,216种</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不同的颜色）。</font><font style="vertical-align: inherit;">该视频以每秒24帧的速度工作，总持续时间为30分钟。</font></font><br>
<br>
<pre><code class="cpp hljs">toppf = <span class="hljs-number">1080</span> * <span class="hljs-number">1920</span> <span class="hljs-comment">//    </span>
cpp = <span class="hljs-number">3</span> <span class="hljs-comment">//  </span>
tis = <span class="hljs-number">30</span> * <span class="hljs-number">60</span> <span class="hljs-comment">//   </span>
fps = <span class="hljs-number">24</span> <span class="hljs-comment">//   </span><font></font>
<font></font>
required_storage = tis * fps * toppf * cpp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此视频大约需要250.28 GB的内存，即1.11 Gb / s！</font><font style="vertical-align: inherit;">这就是为什么您必须使用编解码器。</font></font><br>
<br>
<a name="container"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容器是存储音频/视频的便捷方式</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
容器（包装器）格式是图元文件格式，其规范描述了各种数据和元数据元素如何在计算机文件中共存。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个包含所有流（主要是音频和视频），提供同步，包含公共元数据（例如标题，分辨率）等的单个文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，文件格式由其扩展名确定：例如，video.webm最有可能是使用webm容器的视频。</font></font><br>
<br>
<div style="text-align:center;"><img width="621" height="328" src="https://habrastorage.org/webt/ay/du/qa/ayduqaajbhuh59tah4vdgcu2sj0.png"></div><br>
<a name="command_line"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令行FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独立的跨平台解决方案，用于记录，转换和流传输音频/视频。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于使用多媒体，我们有一个了不起的工具-名为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的库</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">即使您没有在程序代码中使用它，您仍然会使用它（您使用的是Chrome吗？）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该库具有一个控制台程序，用于输入一个名为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的命令行</font><font style="vertical-align: inherit;">（与库本身的名称相反，用小写字母表示）。</font><font style="vertical-align: inherit;">这是一个简单而强大的二进制文件。</font><font style="vertical-align: inherit;">例如，您只需输入以下命令即可将mp4转换为avi：</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg -i input.mp4 output.avi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们只是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新混合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -从一个容器转换为另一个容器。</font><font style="vertical-align: inherit;">从技术上讲，FFmpeg也可以转码，但稍后会介绍更多。</font></font><br>
<br>
<a name="101"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令行工具FFmpeg 101 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg拥有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中所有内容都完美地解释了其工作原理。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从原理上讲，FFmpeg命令行程序希望使用以下参数格式来完成其工作- </font></font><code><b>ffmpeg {1} {2} -i {3} {4} {5}</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{1}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -全局参数</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{2}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -输入文件的参数</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{3}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -传入URL </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{4}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -输出文件</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{5}的参数</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -传出URL </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部分{2}，{3}，{4}，{5}指定所需数量的参数。</font><font style="vertical-align: inherit;">使用示例更容易理解传递参数的格式：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：按引用的文件重300 MB</font></font></b><br>
<br>
<pre><code class="bash hljs">$ wget -O bunny_1080p_60fps.mp4 http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4<font></font>
<font></font>
$ ffmpeg \<font></font>
-y \ <span class="hljs-comment">#  </span>
-c: libfdk_aac -c: v libx264 \ <span class="hljs-comment">#  </span>
-i bunny_1080p_60fps.mp4 \ <span class="hljs-comment">#  URL</span>
-c: v libvpx-vp9 -c: libvorbis \ <span class="hljs-comment">#  </span>
bunny_1080p_60fps_vp9.webm <span class="hljs-comment">#  URL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此命令获取包含两个流（使用aac编解码器编码的音频和使用h264编解码器编码的视频）的传入mp4文件，并将其转换为webm，同时还更改音频和视频编解码器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果简化上述命令，则应考虑FFmpeg代替您接受默认值。</font><font style="vertical-align: inherit;">例如，如果您只是键入</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i input.avi output.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它使用哪个音频/视频编解码器创建output.mp4？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werner Robitz编写了</font><font style="vertical-align: inherit;">用于使用FFmpeg读取/执行</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">编码和编辑</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指南</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="operations"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本视频操作</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在处理音频/视频时，我们通常会执行许多与多媒体相关的任务。</font></font><br>
<br>
<a name="transcoding"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转码（转码）</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<br>
<div style="text-align:center;"><img width="494" height="225" src="https://habrastorage.org/webt/uf/fl/cr/ufflcrik3ha4z6tt5axevtdfv9u.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它是什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将流或音频或视频（或同时转换）从一种编解码器转换到另一种编解码器的过程。</font><font style="vertical-align: inherit;">文件格式（容器）不变。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">碰巧某些设备（电视，智能手机，控制台等）不支持音频/视频格式X，但支持音频/视频格式Y。或者，较新的编解码器是可取的，因为它们提供了更好的压缩率。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么样？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，将视频H264（AVC）转换为H265（HEVC）：</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c:v libx265 \<font></font>
bunny_1080p_60fps_h265.mp4</code></pre><br>
<a name="transmuxing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">复用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="492" height="231" src="https://habrastorage.org/webt/es/vp/gm/esvpgmlkjcj38alzp2sbrdckpne.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它是什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从一种格式（容器）转换为另一种格式。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">碰巧某些设备（电视，智能手机，控制台等）不支持X文件格式，但支持Y文件格式；或者，较新的容器（与旧的容器不同）提供了现代必需的功能。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么样？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将mp4转换为webm：</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c copy \ <span class="hljs-comment"># just saying to ffmpeg to skip encoding</span>
bunny_1080p_60fps.webm</code></pre><br>
<a name="transrating"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="437" height="235" src="https://habrastorage.org/webt/ev/hx/cp/evhxcp7a6y5fkjjq9s53hyfs3iq.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它是什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更改数据速率或创建另一个视图。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户既可以在低功率智能手机上的2G网络上观看视频，也可以在4K电视上通过光纤互联网连接观看视频。</font><font style="vertical-align: inherit;">因此，您应该提供多个选项来播放具有不同数据速率的同一视频。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么样？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以3856K和2000K之间的比特率播放。</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-minrate 964K -maxrate 3856K -bufsize 2000K \<font></font>
bunny_1080p_60fps_transrating_964_3856.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，转换与重新校准一起完成。</font><font style="vertical-align: inherit;">Werner Robitz写了另</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一篇</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于速度控制FFmpeg的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">强制性文章</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="transsizing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换（重新校准）</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="515" height="277" src="https://habrastorage.org/webt/gj/c2/4k/gjc24kcqli3iwwdkzbb70pbue-k.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它是什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分辨率变化。</font><font style="vertical-align: inherit;">如上所述，转换通常与转换同时进行。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出于与转换相同的原因。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么样？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将1080的分辨率降低到480：</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-vf scale=480:-1 \<font></font>
bunny_1080p_60fps_transsizing_480.mp4</code></pre><br>
<a name="bonus"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奖励：自适应流</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="750" height="134" src="https://habrastorage.org/webt/3z/az/lg/3zazlgpe3wjx3zvvhapi0z3ur68.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它是什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建许多权限（比特率）并将媒体分成多个部分，然后通过http协议进行传输。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了什么？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了提供灵活的多媒体，即使在廉价的智能手机上，甚至在4K等离子上也可以观看，因此可以轻松缩放和部署它（但这会增加延迟）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么样？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用DASH创建响应式WebM：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># video streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 160x90 -b:v 250k -keyint_min 150 -g 150 -an -f webm -dash 1 video_160x90_250k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 320x180 -b:v 500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_320x180_500k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 750k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_750k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 1000k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_1000k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 1280x720 -b:v 1500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_1280x720_1500k.webm<font></font>
<font></font>
<span class="hljs-comment"># audio streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:a libvorbis -b:a 128k -vn -f webm -dash 1 audio_128k.webm<font></font>
<font></font>
<span class="hljs-comment"># the DASH manifest</span><font></font>
$ ffmpeg \<font></font>
 -f webm_dash_manifest -i video_160x90_250k.webm \<font></font>
 -f webm_dash_manifest -i video_320x180_500k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_750k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_1000k.webm \<font></font>
 -f webm_dash_manifest -i video_1280x720_500k.webm \<font></font>
 -f webm_dash_manifest -i audio_128k.webm \<font></font>
 -c copy -map 0 -map 1 -map 2 -map 3 -map 4 -map 5 \<font></font>
 -f webm_dash_manifest \<font></font>
 -adaptation_sets <span class="hljs-string">"id=0,streams=0,1,2,3,4 id=1,streams=5"</span> \<font></font>
 manifest.mpd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS：我从</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用DASH播放Adaptive WebM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">说明中</font></a><font style="vertical-align: inherit;">提取了此示例</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="beyond"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">超越</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg没有其他用途。</font><font style="vertical-align: inherit;">我将它与</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iMovie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结合</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">来创建/编辑一些YouTube视频。</font><font style="vertical-align: inherit;">而且，当然，没有什么可以阻止您专业地使用它。</font></font><br>
<br>
<a name="hard_way"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学习FFmpeg libav的棘手路径</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过听觉和视觉可以时不时地感到惊奇吗？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生物学家大卫·罗伯·琼斯</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg作为用于对多媒体文件执行重要操作的命令行工具非常有用。</font><font style="vertical-align: inherit;">也许它也可以在程序中使用？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg由几个库组成，这些库可以集成到我们自己的程序中。</font><font style="vertical-align: inherit;">通常，当您安装FFmpeg时，所有这些库都会自动安装。</font><font style="vertical-align: inherit;">我将这些库的集合称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本节的标题是对Zed Shaw的系列《</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学习</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">棘手之路》的</font></a><font style="vertical-align: inherit;">致敬</font><font style="vertical-align: inherit;">，尤其是他的书《学习C的棘手之路》。</font></font><br>
<br>
<a name="chapter_0"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第0章-简单的世界你好</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello World中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您真的不会欢迎使用控制台语言的世界。</font><font style="vertical-align: inherit;">而是打印有关视频的以下信息：格式（容器），持续时间，分辨率，音频通道，最后，解密一些帧并将其保存为图像文件。</font></font><br>
<br>
<a name="architecture"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav体系结构</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是在开始编写代码之前，让我们看一下FFmpeg libav架构的总体工作方式以及其组件如何与其他组件交互。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是视频解码过程的示意图：</font></font><br>
<div style="text-align:center;"><img width="750" height="424" src="https://habrastorage.org/webt/ej/1d/ek/ej1deksvwwqdctppaujla5v5tog.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，将媒体文件加载到名为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的组件中</font><font style="vertical-align: inherit;">（视频容器也是一种格式）。实际上，它不能完全下载整个文件：通常只读取标头。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下载完</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们容器</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><b><font style="vertical-align: inherit;">最小标头后</font></b><font style="vertical-align: inherit;">，就可以访问其流（它们可以表示为基本音频和视频数据）。每个流都将在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组件中可用</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设我们的视频有两个流：使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编解码器编码的音频</font><font style="vertical-align: inherit;">和使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H264编解码器</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">编码的视频</font><font style="vertical-align: inherit;">。我们可以从每个流中提取称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据包的数据</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已加载到称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组件中</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据包内部的数据仍被编码（压缩），要解码数据包，我们需要将其传递给特定的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec将</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它们解码为一个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其结果是该组件为我们提供了未压缩的帧。</font><font style="vertical-align: inherit;">请注意，音频和视频流的术语和过程相同。</font></font><br>
<br>
<a name="requirements"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于有时在编译或运行示例时会遇到问题，因此我们将</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用作开发/运行时环境。</font><font style="vertical-align: inherit;">我们还将使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">带有一只大兔子</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">视频</font></a><font style="vertical-align: inherit;">，因此，如果您在本地计算机上没有</font><font style="vertical-align: inherit;">该</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">视频</font></a><font style="vertical-align: inherit;">，只需在控制台中运行命令</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make fetch_small_bunny_video即可</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="code"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，代码</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">给我看一个可执行代码的例子，兄弟：</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_hello</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将省略一些细节，但是请不要担心：源代码</font><font style="vertical-align: inherit;">在github </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上可用</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组件分配内存，该组件</font><font style="vertical-align: inherit;">将包含有关格式（容器）的信息。</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *pFormatContext = avformat_alloc_context();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们将打开文件，读取其标题，并</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最少的格式信息</font><font style="vertical-align: inherit;">填充</font><b><font style="vertical-align: inherit;">AVFormatContext</font></b><font style="vertical-align: inherit;">（请注意，编解码器通常不会打开）。</font><font style="vertical-align: inherit;">为此，请使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_open_input</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它需要</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，一个文件名和两个可选参数：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVInputFormat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（如果传递NULL，则FFmpeg将确定格式）和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVDictionary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（这是解复用器选项）。</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_open_input(&amp;pFormatContext, filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您还可以打印格式名称和介质的持续时间：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Format %s, duration %lld us"</span>, pFormatContext-&gt;iformat-&gt;long_name, pFormatContext-&gt;duration);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要访问流，我们需要从媒体读取数据。</font><font style="vertical-align: inherit;">这是通过</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_find_stream_info</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数完成的</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">现在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; nb_streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将包含线程数，而</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt;流[i]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将使我们</font><font style="vertical-align: inherit;">连续执行第</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">个流（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_find_stream_info(pFormatContext,  <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们遍历所有线程的循环：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pFormatContext-&gt;nb_streams; i++) {
  <span class="hljs-comment">//</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于每个流，我们将保存</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecParameters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它描述了第</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">个流</font><font style="vertical-align: inherit;">使用的编解码器的属性</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecParameters *pLocalCodecParameters = pFormatContext-&gt;streams[i]-&gt;codecpar;</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用编解码器的属性，我们可以通过请求</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_decoder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数找到相应的解码器，</font><font style="vertical-align: inherit;">还可以找到已注册的解码器以获取编解码器标识符，并返回</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个知道如何对流进行编码和解码的组件：</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec *pLocalCodec = avcodec_find_decoder(pLocalCodecParameters-&gt;codec_id);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们可以打印编解码器信息：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// specific for video and audio</span>
<span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Video Codec: resolution %d x %d"</span>, pLocalCodecParameters-&gt;width, pLocalCodecParameters-&gt;height);<font></font>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Audio Codec: %d channels, sample rate %d"</span>, pLocalCodecParameters-&gt;channels, pLocalCodecParameters-&gt;sample_rate);<font></font>
}<font></font>
<span class="hljs-comment">// general</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\tCodec %s ID %d bit_rate %lld"</span>, pLocalCodec-&gt;long_name, pLocalCodec-&gt;id, pCodecParameters-&gt;bit_rate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用编解码器，我们为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配了内存</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">内存</font><font style="vertical-align: inherit;">将包含我们解码/编码过程的上下文。</font><font style="vertical-align: inherit;">但是，然后您需要使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CODEC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数填充此编解码器上下文</font><font style="vertical-align: inherit;">-我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_to_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行此操作</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
填写编解码器上下文后，您需要打开编解码器。</font><font style="vertical-align: inherit;">我们</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">，然后可以使用它：</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecContext *pCodecContext = avcodec_alloc_context3(pCodec);<font></font>
avcodec_parameters_to_context(pCodecContext, pCodecParameters);<font></font>
avcodec_open2(pCodecContext, pCodec, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们将从流中读取数据包并将其解码为帧，但是首先我们需要为两个组件（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">分配内存</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">AVPacket *pPacket = av_packet_alloc();<font></font>
AVFrame *pFrame = av_frame_alloc();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数的流中获取</font><font style="vertical-align: inherit;">我们的包：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(av_read_frame(pFormatContext, pPacket) &gt;= <span class="hljs-number">0</span>) {
  <span class="hljs-comment">//...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们将使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数通过编解码器上下文将原始数据包（压缩帧）发送到解码器</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_send_packet(pCodecContext, pPacket);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数通过相同的编解码器上下文从解码器获取原始数据帧（未压缩的帧）</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_receive_frame(pCodecContext, pFrame);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们可以打印帧号，PTS，DTS，帧类型等：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(
    <span class="hljs-string">"Frame %c (%d) pts %d dts %d key_frame %d [coded_picture_number %d, display_picture_number %d]"</span>,<font></font>
    av_get_picture_type_char(pFrame-&gt;pict_type),<font></font>
    pCodecContext-&gt;frame_number,<font></font>
    pFrame-&gt;pts,<font></font>
    pFrame-&gt;pkt_dts,<font></font>
    pFrame-&gt;key_frame,<font></font>
    pFrame-&gt;coded_picture_number,<font></font>
    pFrame-&gt;display_picture_number<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，我们可以将解码后的帧保存为简单的灰度图像。</font><font style="vertical-align: inherit;">这个过程非常简单：我们将使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFrame-&gt; data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中索引与颜色空间</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关联</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">只需选择0（Y）保存我们的灰度图像：</font></font><br>
<br>
<pre><code class="cpp hljs">save_gray_frame(pFrame-&gt;data[<span class="hljs-number">0</span>], pFrame-&gt;linesize[<span class="hljs-number">0</span>], pFrame-&gt;width, pFrame-&gt;height, frame_filename);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save_gray_frame</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> wrap, <span class="hljs-keyword">int</span> xsize, <span class="hljs-keyword">int</span> ysize, <span class="hljs-keyword">char</span> *filename)</span>
</span>{<font></font>
    FILE *f;<font></font>
    <span class="hljs-keyword">int</span> i;<font></font>
    f = fopen(filename,<span class="hljs-string">"w"</span>);
    <span class="hljs-comment">// writing the minimal required header for a pgm file format</span>
    <span class="hljs-comment">// portable graymap format -&gt; https://en.wikipedia.org/wiki/Netpbm_format#PGM_example</span>
    <span class="hljs-built_in">fprintf</span>(f, <span class="hljs-string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="hljs-number">255</span>);<font></font>
<font></font>
    <span class="hljs-comment">// writing line by line</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ysize; i++)<font></font>
        fwrite(buf + i * wrap, <span class="hljs-number">1</span>, xsize, f);<font></font>
    fclose(f);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
瞧！</font><font style="vertical-align: inherit;">现在我们有一个2MB的灰度图像：</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="413" src="https://habrastorage.org/webt/gk/tf/i9/gktfi9xb3ylqmmzu927uc7aon9w.png"></div><br>
<a name="chapter_1"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1章-同步音频和视频</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参与其中是年轻的JS开发人员编写新的MSE视频播放器。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在开始编写转码代码之前，让我们谈谈同步或视频播放器如何找到合适的时间播放帧。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在上一个示例中，我们保存了几帧：</font></font><br>
<img width="194" height="110" src="https://habrastorage.org/webt/gj/yz/7h/gjyz7h4agcr6n2hdkmt9w9ko5ho.png"> <img width="194" height="110" src="https://habrastorage.org/webt/is/cl/yy/isclyy5ckz1_4w2mepv4msr2dba.png"> <img width="194" height="110" src="https://habrastorage.org/webt/7z/tr/mu/7ztrmukulalxo5qihbly0cpm_5w.png"> <img width="194" height="110" src="https://habrastorage.org/webt/u3/q8/pq/u3q8pqb2qxhroy1ycatplyeveco.png"> <img width="194" height="110" src="https://habrastorage.org/webt/uu/lh/ih/uulhihectxop1sphmmss_ipvfpc.png"> <img width="194" height="110" src="https://habrastorage.org/webt/9x/ss/bm/9xssbmfyxzra5frtcob9dirkxt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设计视频播放器时，我们需要以一定的速度播放每一帧，否则，由于播放速度太快或太慢，很难欣赏到视频。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们需要定义一些逻辑来平滑播放每个帧。在这方面，每一帧具有时间表示标志（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -从</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resentation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">吨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IME </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小号</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">夯实），这是在可变考虑越来越多的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是一个有理数（分母称为时间标度</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-timescale</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）除以</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帧频</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过示例更容易理解。</font><font style="vertical-align: inherit;">让我们模拟一些场景。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 60/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/60000，</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将增加时</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标/ fps = 1000</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此</font><font style="vertical-align: inherit;">每帧</font><font style="vertical-align: inherit;">的实际</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font><font style="vertical-align: inherit;">可以是（假设从0开始）：</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
几乎相同的情况，但</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间比例</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等于1/60：</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.050</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 25/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/75，</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">都会增加时</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标/ fps = 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font><font style="vertical-align: inherit;">可以是：</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.04</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">6</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.08</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">9</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.12</span><font></font>
...<font></font>
frame=<span class="hljs-number">24</span>, PTS = <span class="hljs-number">72</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.96</span><font></font>
...<font></font>
frame=<span class="hljs-number">4064</span>, PTS = <span class="hljs-number">12192</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">162.56</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，随着</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们可以找到一种方法来保持同步的声音可视化此</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或与系统时钟。</font><font style="vertical-align: inherit;">FFmpeg libav通过其API提供此信息：</font></font><br>
<br>
<pre><code class="cpp hljs">fps = AVStream-&gt;avg_frame_rate<font></font>
tbr = AVStream-&gt;r_frame_rate<font></font>
tbn = AVStream-&gt;time_base</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出于好奇，我们保存的帧以</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺序发送</font><font style="vertical-align: inherit;">（帧：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1、6、4、2、3、5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），但以</font><b><font style="vertical-align: inherit;">PTS</font></b><font style="vertical-align: inherit;">顺序重现</font><font style="vertical-align: inherit;">（帧：1、2、3、4、5）。</font><font style="vertical-align: inherit;">另请注意</font><font style="vertical-align: inherit;">，与</font><b><font style="vertical-align: inherit;">P</font></b><font style="vertical-align: inherit;">或</font><b><font style="vertical-align: inherit;">I</font></b><font style="vertical-align: inherit;">帧</font><font style="vertical-align: inherit;">相比，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帧</font><font style="vertical-align: inherit;">便宜多少</font><font style="vertical-align: inherit;">：</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs">LOG: AVStream-&gt;r_frame_rate <span class="hljs-number">60</span>/<span class="hljs-number">1</span>
LOG: AVStream-&gt;time_base <span class="hljs-number">1</span>/<span class="hljs-number">60000</span><font></font>
...<font></font>
LOG: Frame <span class="hljs-number">1</span> (type=I, size=<span class="hljs-number">153797</span> bytes) pts <span class="hljs-number">6000</span> key_frame <span class="hljs-number">1</span> [DTS <span class="hljs-number">0</span>]<font></font>
LOG: Frame <span class="hljs-number">2</span> (type=B, size=<span class="hljs-number">8117</span> bytes) pts <span class="hljs-number">7000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">3</span>]<font></font>
LOG: Frame <span class="hljs-number">3</span> (type=B, size=<span class="hljs-number">8226</span> bytes) pts <span class="hljs-number">8000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">4</span>]<font></font>
LOG: Frame <span class="hljs-number">4</span> (type=B, size=<span class="hljs-number">17699</span> bytes) pts <span class="hljs-number">9000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">2</span>]<font></font>
LOG: Frame <span class="hljs-number">5</span> (type=B, size=<span class="hljs-number">6253</span> bytes) pts <span class="hljs-number">10000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">5</span>]<font></font>
LOG: Frame <span class="hljs-number">6</span> (type=P, size=<span class="hljs-number">34992</span> bytes) pts <span class="hljs-number">11000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">1</span>]</code></pre><br>
<a name="chapter_2"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2章-重新复用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重新复用（重新排列，重新混合）-从一种格式（容器）到另一种格式的过渡。</font><font style="vertical-align: inherit;">例如，我们可以使用FFmpeg轻松地将MPEG-4视频替换为MPEG-TS：</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MP4文件将被多路分解，而该文件将不会被解码或编码（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-c copy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），最后，我们得到了mpegts文件。</font><font style="vertical-align: inherit;">如果您未指定</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-f</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">格式</font><font style="vertical-align: inherit;">，则ffmpeg将尝试根据文件扩展名猜测它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg或libav的一般用法遵循以下模式/架构或工作流程：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">协议级别</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -接受输入数据（例如文件，但也可以是rtmp或HTTP下载）</font></font></li>
<li><b> </b> —  , ,  ,   </li>
<li><b> </b> —       </li>
<li><b> </b> —         (,  ),  </li>
<li>…        :</li>
<li><b> </b> —  (    )  </li>
<li><b> </b> —  ( )   ( )</li>
<li><b> </b> — , ,      (   , ,    )</li>
</ul><br>
<img src="https://habrastorage.org/webt/u6/x4/g3/u6x4g3oijeetm1lpdvxnjo9hwls.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（此图强烈地受到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leixiaohua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slhck的启发</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
现在让我们使用libav创建一个示例，以提供与执行此命令时相同的效果：</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将从输入（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）中</font><font style="vertical-align: inherit;">读取</font><font style="vertical-align: inherit;">并将其更改为另一个输出（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *input_format_context = <span class="hljs-literal">NULL</span>;<font></font>
AVFormatContext *output_format_context = <span class="hljs-literal">NULL</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，我们首先分配内存并打开输入格式。</font><font style="vertical-align: inherit;">对于这种特定情况，我们将打开输入文件并为输出文件分配内存：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> ((ret = avformat_open_input(&amp;input_format_context, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open input file '%s'"</span>, in_filename);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<span class="hljs-keyword">if</span> ((ret = avformat_find_stream_info(input_format_context, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to retrieve input stream information"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<font></font>
avformat_alloc_output_context2(&amp;output_format_context, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);
<span class="hljs-keyword">if</span> (!output_format_context) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create output context\n"</span>);<font></font>
  ret = AVERROR_UNKNOWN;<font></font>
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将仅对视频，音频和字幕流进行多路复用。</font><font style="vertical-align: inherit;">因此，我们确定将在索引数组中使用哪些流：</font></font><br>
<br>
<pre><code class="cpp hljs">number_of_streams = input_format_context-&gt;nb_streams;<font></font>
streams_list = av_mallocz_array(number_of_streams, <span class="hljs-keyword">sizeof</span>(*streams_list));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分配必要的内存后，我们需要立即遍历所有流，并需要针对每个流使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数在输出格式的上下文中创建一个新的输出流</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">请注意，我们标记了所有非视频，音频或字幕的流，以便我们可以跳过它们。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; input_format_context-&gt;nb_streams; i++) {<font></font>
  AVStream *out_stream;<font></font>
  AVStream *in_stream = input_format_context-&gt;streams[i];<font></font>
  AVCodecParameters *in_codecpar = in_stream-&gt;codecpar;<font></font>
  <span class="hljs-keyword">if</span> (in_codecpar-&gt;codec_type != AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) {<font></font>
    streams_list[i] = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  streams_list[i] = stream_index++;<font></font>
  out_stream = avformat_new_stream(output_format_context, <span class="hljs-literal">NULL</span>);
  <span class="hljs-keyword">if</span> (!out_stream) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed allocating output stream\n"</span>);<font></font>
    ret = AVERROR_UNKNOWN;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to copy codec parameters\n"</span>);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在创建输出文件：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (!(output_format_context-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) {<font></font>
  ret = avio_open(&amp;output_format_context-&gt;pb, out_filename, AVIO_FLAG_WRITE);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open output file '%s'"</span>, out_filename);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}<font></font>
<font></font>
ret = avformat_write_header(output_format_context, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error occurred when opening output file\n"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您可以逐包将流从输入复制到输出流。</font><font style="vertical-align: inherit;">只要有包（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font><font style="vertical-align: inherit;">这种情况就会循环发生</font><font style="vertical-align: inherit;">，对于每个包，您都需要重新计算</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">才能最终将它们（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）写入输出格式的上下文中。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
  AVStream *in_stream, *out_stream;<font></font>
  ret = av_read_frame(input_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">break</span>;<font></font>
  in_stream  = input_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-keyword">if</span> (packet.stream_index &gt;= number_of_streams || streams_list[packet.stream_index] &lt; <span class="hljs-number">0</span>) {<font></font>
    av_packet_unref(&amp;packet);<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  packet.stream_index = streams_list[packet.stream_index];<font></font>
  out_stream = output_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-comment">/* copy packet */</span><font></font>
  packet.pts = av_rescale_q_rnd(packet.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.dts = av_rescale_q_rnd(packet.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.duration = av_rescale_q(packet.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);<font></font>
  <span class="hljs-comment">// https://ffmpeg.org/doxygen/trunk/structAVPacket.html#ab5793d8195cf4789dfb3913b7a693903</span>
  packet.pos = <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">//https://ffmpeg.org/doxygen/trunk/group__lavf__encoding.html#ga37352ed2c63493c38219d935e71db6c1</span><font></font>
  ret = av_interleaved_write_frame(output_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error muxing packet\n"</span>);
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  av_packet_unref(&amp;packet);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要完成此操作，我们需要使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_write_trailer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数将流预告片写入输出媒体文件</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">av_write_trailer(output_format_context);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们准备测试代码。</font><font style="vertical-align: inherit;">第一个测试是将格式（视频容器）从MP4转换为MPEG-TS视频文件。</font><font style="vertical-align: inherit;">基本上，我们创建命令行ffmpeg input.mp4 -c来使用libav复制output.ts。</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有用！</font><font style="vertical-align: inherit;">不相信我 ？！</font><font style="vertical-align: inherit;">用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffprobe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">ffprobe -i remuxed_small_bunny_1080p_60fps.ts<font></font>
<font></font>
Input <span class="hljs-comment">#0, mpegts, from 'remuxed_small_bunny_1080p_60fps.ts':</span><font></font>
  Duration: 00:00:10.03, start: 0.000000, bitrate: 2751 kb/s<font></font>
  Program 1<font></font>
    Metadata:<font></font>
      service_name    : Service01<font></font>
      service_provider: FFmpeg<font></font>
    Stream <span class="hljs-comment">#0:0[0x100]: Video: h264 (High) ([27][0][0][0] / 0x001B), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 60 fps, 60 tbr, 90k tbn, 120 tbc</span>
    Stream <span class="hljs-comment">#0:1[0x101]: Audio: ac3 ([129][0][0][0] / 0x0081), 48000 Hz, 5.1(side), fltp, 320 kb/s</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总结一下我们所做的事情，现在我们可以回到关于libav如何工作的原始想法。</font><font style="vertical-align: inherit;">但是我们错过了编解码器的一部分，该部分显示在图中。</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="415" src="https://habrastorage.org/webt/_i/vz/yw/_ivzywrkd4le_hfwqyf-7hhrcb8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完成本章之前，我想展示一下复用过程中如此重要的部分，您可以在其中将参数传递给复用器。</font><font style="vertical-align: inherit;">假设您要提供MPEG-DASH格式，那么您需要使用分段的mp4（有时称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fmp4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）而不是MPEG-TS或普通的MPEG-4。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用命令行很容易：</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i non_fragmented.mp4 -movflags frag_keyframe+empty_moov+default_base_moof fragmented.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在libav版本中，几乎就是这样，我们在复制包之前就在写输出头时简单地传递了选项：</font></font><br>
<br>
<pre><code class="cpp hljs">AVDictionary* opts = <span class="hljs-literal">NULL</span>;<font></font>
av_dict_set(&amp;opts, <span class="hljs-string">"movflags"</span>, <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>, <span class="hljs-number">0</span>);<font></font>
ret = avformat_write_header(output_format_context, &amp;opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们可以生成这个片段化的mp4文件：</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_fragmented_mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为确保一切正常，您可以使用令人惊叹的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpac / mp4box.js工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网站或</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://mp4parser.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来查看差异-首先下载mp4。</font></font><br>
<br>
<img align="left" width="212" height="81" src="https://habrastorage.org/webt/x5/hw/9u/x5hw9uxcdgvl36yvns8hkquzlca.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，它有一个不可分割的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块</font><font style="vertical-align: inherit;">-这是视频和音频帧所在的位置。</font><font style="vertical-align: inherit;">现在下载片段化的mp4，以了解它如何扩展mdat块：</font></font><br>
<br>
<img align="left" width="184" height="140" src="https://habrastorage.org/webt/pu/bv/mm/pubvmm5ogancxewrdxfgdth1d34.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><a name="chapter_3"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3章-转码</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">给我看代码和执行：</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_transcoding</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将跳过一些细节，但是请不要担心：源代码</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在github上找到。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本章中，我们将创建一个用C编写的极简代码转换器，它可以使用FFmpeg libav库（尤其是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavcodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavformat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavutil）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将视频从H264转换为</font><b><font style="vertical-align: inherit;">H265</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="396" src="https://habrastorage.org/webt/pw/zj/ys/pwzjys-eok7ggnpkztlv7n60njm.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是媒体文件格式的抽象，即 </font><font style="vertical-align: inherit;">对于容器（MKV，MP4，Webm，TS），</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代表给定格式的每种数据类型（例如：音频，视频，字幕，元数据）</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是从</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接收的压缩数据的片段</font><font style="vertical-align: inherit;">，可以使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec对其</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行解码</font><font style="vertical-align: inherit;">（例如：av1，h264，vp9，hevc）生成称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原始数据</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="cahpter_3_transmuxing"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">复用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从简单的转换开始，然后加载输入文件。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Allocate an AVFormatContext</span><font></font>
avfc = avformat_alloc_context();<font></font>
<span class="hljs-comment">// Open an input stream and read the header.</span>
avformat_open_input(avfc, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
<span class="hljs-comment">// Read packets of a media file to get stream information.</span>
avformat_find_stream_info(avfc, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在配置解码器。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将使我们能够访问</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有组件</font><font style="vertical-align: inherit;">，对于每个</font><font style="vertical-align: inherit;">组件</font><font style="vertical-align: inherit;">，我们都可以获取其</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并创建特定的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。最后，我们可以打开此编解码器进行解码。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含媒体配置数据，例如数据速率，帧速率，采样率，通道，音</font><b><font style="vertical-align: inherit;">高等</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; avfc-&gt;nb_streams; i++) {<font></font>
  AVStream *avs = avfc-&gt;streams[i];<font></font>
  AVCodec *avc = avcodec_find_decoder(avs-&gt;codecpar-&gt;codec_id);<font></font>
  AVCodecContext *avcc = avcodec_alloc_context3(*avc);<font></font>
  avcodec_parameters_to_context(*avcc, avs-&gt;codecpar);<font></font>
  avcodec_open2(*avcc, *avc, <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您还需要准备输出媒体文件以进行转换。</font><font style="vertical-align: inherit;">首先，为输出</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配内存</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以输出格式创建每个流。</font><font style="vertical-align: inherit;">要正确打包流，请从解码器复制编解码器参数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设置标志</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV_CODEC_FLAG_GLOBAL_HEADER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，告诉编码器他可以使用全局头，最后打开输出文件进行写入并保存头：</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_alloc_output_context2(&amp;encoder_avfc, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);<font></font>
<font></font>
AVStream *avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_copy(avs-&gt;codecpar, decoder_avs-&gt;codecpar);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (encoder_avfc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<font></font>
  encoder_avfc-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<font></font>
<font></font>
avio_open(&amp;encoder_avfc-&gt;pb, encoder-&gt;filename, AVIO_FLAG_WRITE);<font></font>
avformat_write_header(encoder-&gt;avfc, &amp;muxer_opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们</font><font style="vertical-align: inherit;">从解码器</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获取AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，调整时间戳并将数据包正确写入输出文件。</font><font style="vertical-align: inherit;">尽管</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">报告“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write frame</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”，我们还是保存了程序包。</font><font style="vertical-align: inherit;">我们通过将流预告片写入文件来完成排列过程。</font></font><br>
<br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span>(av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>) {<font></font>
  av_packet_rescale_ts(input_packet, decoder_video_avs-&gt;time_base, encoder_video_avs-&gt;time_base);<font></font>
  av_interleaved_write_frame(*avfc, input_packet) &lt; <span class="hljs-number">0</span>));<font></font>
}<font></font>
<font></font>
av_write_trailer(encoder_avfc);</code></pre><br>
<a name="cahpter_3_transcoding"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转码</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在上一节中，有一个简单的转换程序，现在我们将添加对文件进行编码的功能，尤其是将视频从</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换</font><font style="vertical-align: inherit;">为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265的功能</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
准备好解码器之后，但在组织输出媒体文件之前，请配置编码器。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建视频</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV流</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的编码器</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec中</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的名称</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libx265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_encoder_by_name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基础上，创建</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_alloc_context3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编解码器</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置代码转换会话的基本属性并...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...打开编解码器并将参数从上下文复制到流（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_from_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVRational input_framerate = av_guess_frame_rate(decoder_avfc, decoder_video_avs, <span class="hljs-literal">NULL</span>);<font></font>
AVStream *video_avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
<span class="hljs-keyword">char</span> *codec_name = <span class="hljs-string">"libx265"</span>;
<span class="hljs-keyword">char</span> *codec_priv_key = <span class="hljs-string">"x265-params"</span>;
<span class="hljs-comment">// we're going to use internal options for the x265</span>
<span class="hljs-comment">// it disables the scene change detection and fix then</span>
<span class="hljs-comment">// GOP on 60 frames.</span>
<span class="hljs-keyword">char</span> *codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
AVCodec *video_avc = avcodec_find_encoder_by_name(codec_name);<font></font>
AVCodecContext *video_avcc = avcodec_alloc_context3(video_avc);<font></font>
<span class="hljs-comment">// encoder codec params</span>
av_opt_set(sc-&gt;video_avcc-&gt;priv_data, codec_priv_key, codec_priv_value, <span class="hljs-number">0</span>);<font></font>
video_avcc-&gt;height = decoder_ctx-&gt;height;<font></font>
video_avcc-&gt;width = decoder_ctx-&gt;width;<font></font>
video_avcc-&gt;pix_fmt = video_avc-&gt;pix_fmts[<span class="hljs-number">0</span>];
<span class="hljs-comment">// control rate</span>
video_avcc-&gt;bit_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_buffer_size = <span class="hljs-number">4</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_max_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_min_rate = <span class="hljs-number">2.5</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;
<span class="hljs-comment">// time base</span><font></font>
video_avcc-&gt;time_base = av_inv_q(input_framerate);<font></font>
video_avs-&gt;time_base = sc-&gt;video_avcc-&gt;time_base;<font></font>
<font></font>
avcodec_open2(sc-&gt;video_avcc, sc-&gt;video_avc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_from_context(sc-&gt;video_avs-&gt;codecpar, sc-&gt;video_avcc);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必须扩展解码周期以对视频流进行转码：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将一个空的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发送</font><b><font style="vertical-align: inherit;">到</font></b><font style="vertical-align: inherit;">解码器（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获取</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未压缩的</font><b><font style="vertical-align: inherit;">AVFrame</font></b><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们开始重新编码原始帧。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们发送原始帧（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们基于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编解码器</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）进行</font><font style="vertical-align: inherit;">压缩</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置时间戳（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_packet_rescale_ts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们写入输出文件（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span> (av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_packet(decoder_video_avcc, input_packet);
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_frame(decoder_video_avcc, input_frame);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
      encode(encoder_avfc, decoder_video_avs, encoder_video_avs, decoder_video_avcc, input_packet-&gt;stream_index);<font></font>
    }<font></font>
    av_frame_unref(input_frame);<font></font>
  }<font></font>
  av_packet_unref(input_packet);<font></font>
}<font></font>
av_write_trailer(encoder_avfc);<font></font>
<font></font>
<span class="hljs-comment">// used function</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">encode</span><span class="hljs-params">(AVFormatContext *avfc, AVStream *dec_video_avs, AVStream *enc_video_avs, AVCodecContext video_avcc <span class="hljs-keyword">int</span> index)</span> </span>{<font></font>
  AVPacket *output_packet = av_packet_alloc();<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_frame(video_avcc, input_frame);<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_packet(video_avcc, output_packet);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    output_packet-&gt;stream_index = index;<font></font>
    output_packet-&gt;duration = enc_video_avs-&gt;time_base.den / enc_video_avs-&gt;time_base.num / dec_video_avs-&gt;avg_frame_rate.num * dec_video_avs-&gt;avg_frame_rate.den;<font></font>
<font></font>
    av_packet_rescale_ts(output_packet, dec_video_avs-&gt;time_base, enc_video_avs-&gt;time_base);<font></font>
    response = av_interleaved_write_frame(avfc, output_packet);<font></font>
  }<font></font>
  av_packet_unref(output_packet);<font></font>
  av_packet_free(&amp;output_packet);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将媒体流从</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换</font><font style="vertical-align: inherit;">为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">正如预期的那样，h265媒体文件的版本小于h264，而该程序有很多机会：</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">/*
   * H264 -&gt; H265
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx265"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x265-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - fragmented MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.muxer_opt_key = <span class="hljs-string">"movflags"</span>;<font></font>
  sp.muxer_opt_value = <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; AAC
   * MP4 - MPEG-TS
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">0</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.audio_codec = <span class="hljs-string">"aac"</span>;<font></font>
  sp.output_extension = <span class="hljs-string">".ts"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/* WIP :P  -&gt; it's not playing on VLC, the final bit rate is huge
   * H264 -&gt; VP9
   * Audio -&gt; Vorbis
   * MP4 - WebM
   */</span>
  <span class="hljs-comment">//StreamingParams sp = {0};</span>
  <span class="hljs-comment">//sp.copy_audio = 0;</span>
  <span class="hljs-comment">//sp.copy_video = 0;</span>
  <span class="hljs-comment">//sp.video_codec = "libvpx-vp9";</span>
  <span class="hljs-comment">//sp.audio_codec = "libvorbis";</span>
  <span class="hljs-comment">//sp.output_extension = ".webm";</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
坦白地说，它比起初看起来要复杂一些。</font><font style="vertical-align: inherit;">我必须选择FFmpeg命令行源代码并进行了大量测试。</font><font style="vertical-align: inherit;">可能我错过了某些地方，因为我必须</font><font style="vertical-align: inherit;">为</font><b><font style="vertical-align: inherit;">h264</font></b><font style="vertical-align: inherit;">使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force-cfr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且仍然弹出一些警告消息，例如，帧类型（5）被强制更改为帧类型（3）。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">爱迪生博客上的翻译：</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/fr/yz/q7/fryzq72v0ik0irt2q4orchflxvs.jpeg"></a></td>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/jv/3k/-f/jv3k-f5vi9drztohsh-e0t-puru.jpeg"></a></td>
</tr>
<tr>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
收入超过十亿美元的</font><font style="vertical-align: inherit;">前50大游戏特许经营权</font></font></a></th>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  Airbnb ?<br>
[: ]</a></th>
</tr>
</tbody></table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN495604/index.html">Symfony 4 + Twig的临时本地化</a></li>
<li><a href="../zh-CN495606/index.html">“社会监督。” 得分1：0，对我们有利</a></li>
<li><a href="../zh-CN495608/index.html">[Infographic]人类历史中大流行病的可视化</a></li>
<li><a href="../zh-CN495610/index.html">为什么未来不适合Python</a></li>
<li><a href="../zh-CN495612/index.html">Airbnb能否在冠状病毒中存活？[剧透：是的]</a></li>
<li><a href="../zh-CN495618/index.html">隔离会导致损失。如何不隔离地生活？</a></li>
<li><a href="../zh-CN495620/index.html">在Jabra Panacast组装了一个视频会议收割机，办公室和家庭的利弊</a></li>
<li><a href="../zh-CN495622/index.html">数字双空调系统（SLE）飞机</a></li>
<li><a href="../zh-CN495624/index.html">为什么Xbox Series X将成为2020年的主要购买</a></li>
<li><a href="../zh-CN495634/index.html">人人皆知：为什么员工是企业信息安全的主要威胁以及如何应对</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>