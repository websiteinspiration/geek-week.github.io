<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✌️ 🚐 👨🏻‍🚀 Hemat banyak uang untuk volume besar di PostgreSQL 🌭 ♿️ 🙇🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Melanjutkan topik rekaman aliran besar data, yang diangkat oleh artikel sebelumnya tentang partisi , dalam hal ini kami mempertimbangkan cara-cara di ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hemat banyak uang untuk volume besar di PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498292/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melanjutkan topik rekaman aliran besar data, yang diangkat oleh </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel sebelumnya tentang partisi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dalam hal ini kami mempertimbangkan cara-cara di mana Anda dapat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengurangi ukuran "fisik" yang disimpan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam PostgreSQL, dan pengaruhnya terhadap kinerja server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini tentang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengaturan TOAST dan perataan data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">"Rata-rata", metode ini akan menghemat tidak terlalu banyak sumber daya, tetapi tanpa modifikasi pada kode aplikasi.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cj/c-/lx/cjc-lxht8brbyy9xif_sicdwk70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, pengalaman kami ternyata sangat produktif dalam hal ini, karena repositori dari hampir semua pemantauan pada dasarnya bersifat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambahan-hanya</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam hal data yang direkam. </font><font style="vertical-align: inherit;">Dan jika Anda tertarik bagaimana Anda bisa mengajarkan database untuk menulis ke disk, bukannya </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200MB / s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> setengahnya - saya minta potongan.</font></font><br>
<a name="habracut"></a><br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rahasia Kecil Data Besar</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menurut profil </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">layanan kami</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ia secara teratur menerima </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paket teks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari log </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan karena </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kompleks VLSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang databasenya kami pantau, adalah produk multikomponen dengan struktur data yang kompleks, pertanyaan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mencapai kinerja maksimum</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diperoleh dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"multi-volume" dengan logika algoritmik yang kompleks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jadi volume setiap instance individu dari permintaan atau rencana eksekusi yang dihasilkan dalam log yang datang kepada kami ternyata “rata-rata” cukup besar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat struktur dari salah satu tabel di mana kita menulis data "mentah" - yaitu, inilah teks asli dari entri log:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> rawdata_orig(<font></font>
  pack <span class="hljs-comment">-- PK</span>
    <span class="hljs-keyword">uuid</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, recno <span class="hljs-comment">-- PK</span>
    <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, dt <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">data</span> <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">text</span>
, PRIMARY <span class="hljs-keyword">KEY</span>(pack, recno)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Piring yang khas (sudah dipartisi, tentu saja, karena itu merupakan templat bagian), di mana yang paling penting adalah teks. Terkadang cukup produktif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ingat bahwa ukuran "fisik" dari satu rekaman di PG tidak dapat menempati lebih dari satu halaman data, tetapi ukuran "logis" adalah masalah yang sama sekali berbeda. Untuk menulis nilai volume (varchar / teks / bytea) ke dalam bidang, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">teknologi TOAST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> digunakan </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL menggunakan ukuran halaman tetap (biasanya 8 KB), dan tidak mengizinkan tupel untuk menjangkau beberapa halaman. </font><font style="vertical-align: inherit;">Oleh karena itu, tidak mungkin untuk secara langsung menyimpan nilai bidang yang sangat besar. </font><font style="vertical-align: inherit;">Untuk mengatasi batasan ini, nilai bidang yang besar dikompresi dan / atau dipecah menjadi beberapa garis fisik. </font><font style="vertical-align: inherit;">Ini terjadi tanpa disadari oleh pengguna dan sedikit memengaruhi sebagian besar kode server. </font><font style="vertical-align: inherit;">Metode ini dikenal sebagai TOAST ...</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan, untuk setiap tabel dengan bidang "berpotensi besar" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tabel berpasangan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> secara otomatis </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">dibuat dengan "mengiris" dari</font></a><font style="vertical-align: inherit;"> setiap catatan "besar" di segmen 2KB:</font></font><br>
<br>
<pre><code class="sql hljs">TOAST(<font></font>
  chunk_id<font></font>
    integer<font></font>
, chunk_seq<font></font>
    integer<font></font>
, chunk_data<font></font>
    bytea<font></font>
, PRIMARY KEY(chunk_id, chunk_seq)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artinya, jika kita harus menulis baris dengan nilai "besar" </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka catatan nyata akan terjadi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak hanya di tabel utama dan PK-nya, tetapi juga di TOAST dan PK-nya</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangi efek TOAST</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi sebagian besar catatan di sini masih tidak begitu besar, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mereka harus muat dalam 8KB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - bagaimana Anda menghemat ini? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini atribut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>STORAGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di kolom tabel </font><font style="vertical-align: inherit;">datang ke bantuan kami </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIPERPANJANGKAN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memungkinkan kompresi dan penyimpanan terpisah. </font><font style="vertical-align: inherit;">Ini adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opsi standar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk sebagian besar tipe data yang kompatibel TOAST. </font><font style="vertical-align: inherit;">Pertama, upaya dilakukan untuk melakukan kompresi, kemudian disimpan di luar tabel jika barisnya masih terlalu besar.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAIN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memungkinkan kompresi, tetapi tidak memisahkan penyimpanan. </font><font style="vertical-align: inherit;">(Pada kenyataannya, penyimpanan terpisah, akan dilakukan untuk kolom seperti itu, tetapi hanya </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebagai upaya terakhir</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ketika tidak ada cara lain untuk mengurangi baris sehingga cocok pada halaman.)</font></font></li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faktanya, ini adalah persis apa yang kita butuhkan untuk teks - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peras sebanyak mungkin, dan bahkan jika itu tidak cocok sama sekali - masukkan ke dalam TOAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Anda dapat melakukan ini secara langsung "on the fly", dengan satu perintah:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawdata_orig <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">SET</span> <span class="hljs-keyword">STORAGE</span> <span class="hljs-keyword">MAIN</span>;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara mengevaluasi efeknya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena aliran data berubah setiap hari, kami tidak dapat membandingkan angka absolut, tetapi secara relatif, semakin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kecil proporsi yang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami catat di TOAST, semakin baik. </font><font style="vertical-align: inherit;">Tetapi ada bahaya - semakin kita memiliki volume "fisik" dari setiap catatan individu, indeks itu "lebih luas", karena kita harus membahas lebih banyak halaman data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebelum perubahan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (39%)<font></font>
TOAST = 54GB (57%)<font></font>
PK    =  4GB ( 4%)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setelah perubahan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (67%)<font></font>
TOAST = 16GB (29%)<font></font>
PK    =  2GB ( 4%)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan, kami </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mulai menulis di TOAST 2 kali lebih jarang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang tidak hanya memuat disk, tetapi juga CPU:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jc/te/dr/jctedr4gcninasuw54qer9qu_8u.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bp/lj/wr/bpljwrysoy42rtnu3ds0btue7ka.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya perhatikan bahwa kami juga mulai "membaca" disk lebih sedikit, tidak hanya "menulis" - karena ketika Anda memasukkan catatan ke beberapa tabel, Anda juga harus "mengurangi" bagian dari pohon dari masing-masing indeks untuk menentukan posisi masa depan di dalamnya.</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siapa di PostgreSQL 11 hidup dengan baik</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah memutakhirkan ke PG11, kami memutuskan untuk melanjutkan "tuning" TOAST dan memperhatikan bahwa mulai dengan versi ini, parameter menjadi tersedia untuk konfigurasi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>toast_tuple_target</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode pemrosesan TOAST dipicu hanya ketika nilai baris yang akan disimpan dalam tabel lebih besar dari TOAST_TUPLE_THRESHOLD byte (biasanya 2 Kb). </font><font style="vertical-align: inherit;">Kode TOAST akan memampatkan dan / atau memindahkan nilai bidang dari tabel hingga nilai baris kurang dari TOAST_TUPLE_TARGET byte (variabel, biasanya 2 KB juga) atau menjadi tidak mungkin untuk mengurangi ukuran.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memutuskan bahwa data yang biasanya kami miliki adalah "sangat pendek" atau segera "sangat panjang", jadi kami memutuskan untuk membatasi diri pada nilai serendah mungkin:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawplan_orig <span class="hljs-keyword">SET</span> (toast_tuple_target = <span class="hljs-number">128</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat bagaimana pengaturan baru mempengaruhi pemuatan disk setelah migrasi:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/cz/k7/ppczk7f8qj9cu_hixtltdk_wvo4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak buruk! </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Line-up</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rata-rata </font><b><font style="vertical-align: inherit;">ke disk menurun</font></b><font style="vertical-align: inherit;"> sekitar 1,5 kali, dan "hunian" disk - sebesar 20 persen! </font><font style="vertical-align: inherit;">Tapi mungkin ini entah bagaimana mempengaruhi CPU?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xa/vj/sq/xavjsqger1hmawiiidzngvzcff0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setidaknya, itu tidak menjadi lebih buruk. </font><font style="vertical-align: inherit;">Meskipun, sulit untuk menilai apakah volume seperti itu masih tidak dapat menaikkan rata-rata beban CPU di atas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dari perubahan posisi, jumlah ... berubah!</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda ketahui, satu sen menghemat rubel, dan dengan volume penyimpanan kami sekitar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10TB / bulan,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bahkan optimasi kecil dapat memberikan keuntungan yang baik. Oleh karena itu, kami menarik perhatian pada struktur fisik data kami - bagaimana tepatnya </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"bidang" diletakkan di dalam catatan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> setiap tabel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena karena </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penyelarasan data,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ini secara langsung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mempengaruhi volume yang dihasilkan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Banyak arsitektur menyediakan penyelarasan data melintasi batas-batas kata mesin. </font><font style="vertical-align: inherit;">Misalnya, pada sistem 32-bit x86, bilangan bulat (tipe bilangan bulat, menempati 4 byte) akan disejajarkan di perbatasan kata 4-byte, serta angka floating-point presisi ganda (tipe presisi ganda, 8 byte). </font><font style="vertical-align: inherit;">Dan pada sistem 64-bit, nilai ganda akan disejajarkan di perbatasan kata 8-byte. </font><font style="vertical-align: inherit;">Ini adalah alasan lain ketidakcocokan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena perataan, ukuran baris tabel tergantung pada urutan bidang. </font><font style="vertical-align: inherit;">Biasanya efek ini tidak terlalu terlihat, tetapi dalam beberapa kasus dapat menyebabkan peningkatan ukuran yang signifikan. </font><font style="vertical-align: inherit;">Misalnya, jika Anda menempatkan bidang tipe char (1) dan integer dicampur, di antara mereka, sebagai aturan, 3 byte akan sia-sia.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mulai dengan model sintetis:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span>
, <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span><font></font>
));<font></font>
<span class="hljs-comment">-- 48 </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span>
, <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span><font></font>
));<font></font>
<span class="hljs-comment">-- 46 </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari mana asal pasangan byte ekstra dalam kasus pertama? </font><font style="vertical-align: inherit;">Semuanya sederhana - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smallint 2-byte selaras dengan batas 4-byte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebelum bidang berikutnya, dan ketika itu adalah yang terakhir, tidak ada dan tidak perlu untuk menyelaraskannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara teori, semuanya baik-baik saja dan Anda dapat mengatur ulang bidang yang Anda inginkan. </font><font style="vertical-align: inherit;">Mari kita periksa data nyata pada contoh salah satu tabel, bagian harian yang membutuhkan 10-15GB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Struktur sumber:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190220<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  dt date,</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-20'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian setelah mengubah urutan kolom adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bidang yang sama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> persis </font><b><font style="vertical-align: inherit;">, hanya urutannya yang berbeda</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190221<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  dt date NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-21'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volume total bagian ditentukan oleh jumlah "fakta" dan hanya bergantung pada proses eksternal, jadi kami membagi ukuran tumpukan ( </font></font><code>pg_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dengan jumlah catatan di dalamnya - yaitu, kami mendapatkan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ukuran rata</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">rata dari catatan tersimpan aktual</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jx/6e/im/jx6eimznnvdqtrzp6aohdvxluzs.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minus 6% dari volume</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , luar biasa! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi semuanya, tentu saja, tidak begitu cerah - karena </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam indeks kita tidak dapat mengubah urutan bidang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan karena itu "secara umum" ( </font></font><code>pg_total_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/az/3m/6z/az3m6zsyv47wtawrbk_tdmwdpfg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... setelah semua, mereka </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menghemat 1,5% di sini</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tanpa mengubah satu baris kode. </font><font style="vertical-align: inherit;">Ya ya!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gb/dr/ps/gbdrpsonli0eclk4ozdjjtofnda.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya perhatikan bahwa pengaturan bidang di atas bukan fakta yang paling optimal. </font><font style="vertical-align: inherit;">Karena beberapa blok bidang tidak ingin "dihancurkan" karena alasan estetika - misalnya, pasangan </font></font><code>(pack, recno)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang merupakan PK untuk tabel ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, definisi pengaturan bidang "minimum" adalah tugas "lengkap" yang cukup sederhana. </font><font style="vertical-align: inherit;">Karena itu, Anda bisa mendapatkan hasil pada data Anda lebih baik daripada kami - coba saja!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498280/index.html">Kisah burung Dodo dari genus Phoenix. Kejatuhan Besar Dodo ADALAH</a></li>
<li><a href="../id498282/index.html">[instruksi] Membuat akun dan situs di platform Google Site</a></li>
<li><a href="../id498284/index.html">Cara mengoptimalkan belajar bahasa Inggris</a></li>
<li><a href="../id498288/index.html">Kota Anda membutuhkan bus metro</a></li>
<li><a href="../id498290/index.html">Hidrologi prosedural: simulasi dinamis sungai dan danau</a></li>
<li><a href="../id498294/index.html">Deteksi Objek Kenali dan aturankan. Bagian 1</a></li>
<li><a href="../id498296/index.html">Desain di tingkat sistem. Bagian 1. Dari ide ke sistem</a></li>
<li><a href="../id498298/index.html">Perusahaan menggunakan karunia bug untuk membeli keheningan peretas</a></li>
<li><a href="../id498300/index.html">Blitz.Engine: Sistem Aset</a></li>
<li><a href="../id498302/index.html">Lisensi Lanjutan ILO. Mengapa itu dibutuhkan saat ini?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>