<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📮 👩🏽‍🤝‍👨🏼 🚐 Sternchen und Versand in Telegramm / Slack / E-Mail verpasst 🕟 🤛🏽 👋🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gibt ein Callcenter. Es gibt Asterisk / FreePBX mit konfigurierten Warteschlangen. Es gibt Agenten, die Anrufe bedienen sollten. Aber es gibt so vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sternchen und Versand in Telegramm / Slack / E-Mail verpasst</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492728/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt ein Callcenter. </font><font style="vertical-align: inherit;">Es gibt Asterisk / FreePBX mit konfigurierten Warteschlangen. </font><font style="vertical-align: inherit;">Es gibt Agenten, die Anrufe bedienen sollten. </font><font style="vertical-align: inherit;">Aber es gibt so viele potenzielle Kunden und es gibt so wenige Agenten, dass die ersteren die letzteren in keiner Weise erreichen können - sie hängen, sie hängen eine Minute in der Schlange und sie schalten sich aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber aus irgendeinem Grund haben sie angerufen! </font><font style="vertical-align: inherit;">Vielleicht wollen sie Geld in die Firma bringen? </font><font style="vertical-align: inherit;">Versuchen wir, anhand des FreePBX-Beispiels sowohl Kunden als auch deren Geld zurückzugeben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den Warteschlangeneinstellungen können Sie das Failover-Ziel angeben - wohin der Anruf gesendet werden soll, wenn die Warteschlange voll ist, die Zeitüberschreitung abgelaufen ist usw. Es kommt jedoch häufig vor, dass der Anrufer die Verbindung trennt, bevor er zum Failover-Ziel umgeleitet werden kann. Sie wissen nie, dass die Verbindung unterbrochen wurde. Für solche Fälle gibt es keine fertige Lösung. Deshalb gehen wir unter den Schnitt und schreiben Ihre eigenen - mit dem Senden einer Warnung an Telegramm / Slack / E-Mail / woanders.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und das erste, was wir verstehen müssen, ist, wie FreePBX Warteschlangenprotokolle schreibt. </font><font style="vertical-align: inherit;">Im einfachsten Fall ist dies die Textdatei / var / log / asterisk / queue_log. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher wird ein regelmäßiger Anruf vom Teilnehmer 8964467XXXXX in das Protokoll geschrieben, der 302221XXXX anrief und sich in Zeile 603 an der ersten Position befindet, die Agent Girl 8 Sekunden später beantwortete. </font><font style="vertical-align: inherit;">Sie sprachen 133 Sekunden und der Abonnent war der erste, der auflegte - jeder würde so höfliche Manager haben!</font></font><br>
<br>
<pre><code class="bash hljs">1584318765|1584318747.89449|603|NONE|DID|302221<font></font>
1584318765|1584318747.89449|603|NONE|ENTERQUEUE||8964467|1<font></font>
1584318774|1584318747.89449|603|Agent Girl|CONNECT|9|1584318765.89450|8<font></font>
1584318907|1584318747.89449|603|Agent Girl|COMPLETECALLER|9|133|1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier ist eine etwas andere Geschichte, als ein Teilnehmer 8996453XXXXX 302257XXXXX anrief, 10 Sekunden in Zeile Nr. 210 an der ersten Position hing und die Verbindung trennte. </font><font style="vertical-align: inherit;">Ich habe nicht einmal das Sprachmenü gehört!</font></font><br>
<br>
<pre><code class="bash hljs">1581728710|1581728690.59367|210|NONE|DID|302257<font></font>
1581728710|1581728690.59367|210|NONE|ENTERQUEUE||8996453|1<font></font>
1581728720|1581728690.59367|210|NONE|ABANDON|1|1|10</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist über ihn, wir werden in den Boten schreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu müssen wir das Auftreten des ABANDON-Ereignisses in der Protokolldatei abfangen. </font><font style="vertical-align: inherit;">Ich habe lange gerätselt, wie das geht, aber dann bin ich ganz zufällig auf ein wunderbares Werkzeug </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestoßen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">MONIT</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In unserem Fall wird das Warteschlangenprotokoll überwacht, und sobald die Zeile "ABANDON" darin angezeigt wird, wird das Skript zur Verarbeitung dieses Ereignisses aufgerufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie dazu nach der Installation des Pakets folgendermaßen vor:</font></font><br>
<br>
<pre><code class="bash hljs">yum install monit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Richten Sie es ein - erstellen Sie die Datei /etc/monit.d/queue_log und schreiben Sie buchstäblich drei Zeilen hinein:</font></font><br>
<br>
<pre><code class="bash hljs">check file queue_log with path /var/<span class="hljs-built_in">log</span>/asterisk/queue_log
    <span class="hljs-keyword">if</span> content = <span class="hljs-string">"ABANDON"</span> <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">exec</span> <span class="hljs-string">"/var/lib/asterisk/agi-bin/qlogevent.sh <span class="hljs-variable">$EVENT</span>"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn also das Wort "ABANDON" im Warteschlangenprotokoll erscheint, das uns auffordert, den Abonnenten vorzeitig zu trennen, wird das Skript /var/lib/asterisk/agi-bin/qlogevent.sh mit dem Parameter $ EVENT aufgerufen, was nichts anderes als vollständig ist die Zeile, in der dieses Wort erschien. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist einfach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt beginnt nicht mehr Schach - Sie müssen darüber nachdenken. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die an das Skript übergebene Zeile enthält keine Informationen zur Nummer des Anrufers:</font></font><br>
<br>
<pre><code class="bash hljs">1581728720|1581728690.59367|210|NONE|ABANDON|1|1|10</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es enthält nur den Zeitstempel (1581728720), eine eindeutige Anruf-ID (1581728690.59367), eine Warteschlangennummer (210), das Ereignis selbst und einige andere nicht wesentliche Parameter. </font><font style="vertical-align: inherit;">Jene. </font><font style="vertical-align: inherit;">Wir müssen selbst nach der Teilnehmernummer suchen. </font><font style="vertical-align: inherit;">Und auf welche Weise? </font><font style="vertical-align: inherit;">Und es ist sehr einfach, weil wir eine UID eines Anrufs haben! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenden wir uns noch einmal dem Protokoll dieses Anrufs zu, insbesondere der Zeile, in der der Teilnehmer in die Warteschlange fällt:</font></font><br>
<br>
<pre><code class="bash hljs">1581728710|1581728690.59367|210|NONE|ENTERQUEUE||8996453|1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Ereignis „ENTERQUEUE“ auftritt, ist einer der Parameter die benötigte Teilnehmernummer. </font><font style="vertical-align: inherit;">Wir können diese Zeile nur in der Datei queue_log finden. </font><font style="vertical-align: inherit;">Genau das macht das Bash-Skript, das MONIT sorgfältig für uns aufgerufen hat:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#MONIT_DESCRITION - ,      .</span>
<span class="hljs-comment"># timestamp    - ( №1).</span>
timedate=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f1 | cut -d\: -f2 | gawk <span class="hljs-string">'{print strftime("%d.%m.%Y %H:%M:%S",$0);}'</span>)
<span class="hljs-comment"># UID ( №2)</span>
call_id=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f2)
<span class="hljs-comment">#   ( №3)</span>
qnum=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f3)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
<span class="hljs-keyword">case</span> <span class="hljs-variable">$qnum</span> <span class="hljs-keyword">in</span><font></font>
    210)<font></font>
        qname=<span class="hljs-string">" 1"</span><font></font>
        ;;<font></font>
    220)<font></font>
        qname=<span class="hljs-string">" 2"</span><font></font>
        ;;<font></font>
<span class="hljs-keyword">esac</span><font></font>
<font></font>
<span class="hljs-comment">#      UID,     ENTERQUEUE</span>
str=$(grep <span class="hljs-string">"|<span class="hljs-variable">$call_id</span>|<span class="hljs-variable">$qnum</span>|.*|ENTERQUEUE"</span> /var/<span class="hljs-built_in">log</span>/asterisk/queue_log)
<span class="hljs-comment">#      ( №7)</span>
caller_id=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$str</span> | cut -d\| -f7)
<span class="hljs-comment">#     ( №1)</span>
time_enter=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$str</span> | cut -d\| -f1)
<span class="hljs-comment">#     ( №1   ABANDON)</span>
time_abandon=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f1 | cut -d\: -f2)
<span class="hljs-comment"># </span>
data=<span class="hljs-string">" <span class="hljs-variable">$caller_id</span> <span class="hljs-variable">$timedate</span>   <span class="hljs-variable">$qname</span>,       <span class="hljs-subst">$(($time_abandon-$time_enter)</span>) ."</span>
<span class="hljs-comment">#    /.     Slack.</span>
/usr/bin/curl -X POST -H <span class="hljs-string">'Content-type: application/json'</span> --data <span class="hljs-string">'{"text":"'</span><span class="hljs-string">"<span class="hljs-variable">$data</span>"</span><span class="hljs-string">'"}'</span> <span class="hljs-string">"https://hooks.slack.com/services/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eigentlich ist das alles! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stimmt, es gibt einen Vorfall - MONIT, der alles und jeden überwachen soll, und selbst muss überwacht werden, weil </font><font style="vertical-align: inherit;">fällt regelmäßig.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de492714/index.html">Effektive Arbeit von zu Hause aus: allgemein und persönlich</a></li>
<li><a href="../de492718/index.html">Sicherheit durch Benutzereinschränkung oder Erstellen einer Sicherheitsanfälligkeit</a></li>
<li><a href="../de492720/index.html">Diskussion: Projektdateidienst</a></li>
<li><a href="../de492724/index.html">Björn Straustrup beantwortet die Top 5 C ++ - Fragen mit Stapelüberlauf</a></li>
<li><a href="../de492726/index.html">OS Sivelkiriya: Softwareentwicklungsprozess</a></li>
<li><a href="../de492730/index.html">US-Verteidigungsministerium: Ethik für KI und unbemannte Fahrzeuge</a></li>
<li><a href="../de492742/index.html">Visualisieren Sie Node JS-Anwendungsdaten mit Prometheus + Grafana</a></li>
<li><a href="../de492744/index.html">Welches System wird am lautesten sein und welches wird "absolute" Stille geben: zwei interessante wissenschaftliche Projekte</a></li>
<li><a href="../de492746/index.html">Wie vermeide ich Programmierverbrechen? Integrator-Tipps</a></li>
<li><a href="../de492748/index.html">Beruf DevOps-Ingenieur: Eine Ansicht des Systemadministrators</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>