<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø üôâ üßëüèΩ‚Äçü§ù‚Äçüßëüèº Satellite and Ansible Tower Integration üë®üèº‚Äçü§ù‚Äçüë®üèª üçë üå∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using Red Hat Satellite and Red Hat Ansible Automation Platform? Starting with Satellite 6.3, they can be integrated with each other so that Dynamic I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Satellite and Ansible Tower Integration</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/491138/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Red Hat Satellite and Red Hat Ansible Automation Platform? Starting with Satellite 6.3, they can be integrated with each other so that Dynamic Inventory in Ansible Tower pulls up host lists from Satellite. In addition, if the RHEL hosts are initialized using Satellite (meaning provisioning), then Ansible Tower can be integrated into this process so that it automatically runs configuration scripts on the new hosts. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/4o/so/qq4oso9wx_wxkl81ha7aiy1b18a.jpeg" width="100%"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this post, we will look at how to configure Dynamic Inventory in Ansible Tower so that it pulls up the hosts from Satellite, and we will show how to use it with examples. In addition, we‚Äôll show you how to organize an automatic call to Ansible Tower after initializing a new host from Satellite.</font></font><br>
<a name="habracut"></a><br>
<h3> 1.    Inventory.  Satellite,       Dynamic Inventory  Ansible Tower</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Ansible Tower to have access to the list of hosts, host groups, and other related information, it needs an account in Satellite. This entry has enough minimal permissions, so we will create a new role in Satellite, give it only the permissions necessary for Ansible Tower, and then create a new account and assign it this role. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satellite 6.6 and later already has an Ansible Tower Inventory Reader role ready for this, so you can skip the steps below to create a role. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Satellite 6.3-6.5, the role will have to be created by hand. To do this, go to the Satellite web interface, go to the Administer screen, select Roles and click Create Role. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this role </font><b><font style="vertical-align: inherit;">ansible_tower_integration_role</font></b><font style="vertical-align: inherit;"> and set </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locations and Organizations</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for it </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oc/oy/ey/ocoyeyrceo04wboamjmzv_2nnf0.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Click Submit to create the role. After that, click on her name and go to the Filters tab. Click the green New Filter button and add the following filters, one at a time: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resource Type: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Host</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Permission: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view_hosts</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Resource Type: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Host Group</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Permission: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view_hostgroups</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Resource Type: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fact value</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Permission: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view_facts</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As a result, the following filters should have a role:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cc/ia/r-/cciar-m-0-bz63n2lrijzatkbrg.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have created a role. Now we‚Äôll start a new user in Satellite, for which we go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menu </font><font style="vertical-align: inherit;">, select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Users</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create User</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this user </font><b><font style="vertical-align: inherit;">ansible_integration</font></b><font style="vertical-align: inherit;"> , change the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authorized by</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INTERNAL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and set the password. Then on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locations and Organizations</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tabs, </font><font style="vertical-align: inherit;">select the appropriate locations / organizations. Finally, go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tab </font><font style="vertical-align: inherit;">and assign this user the newly created </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ansible_tower_integration_role</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> role </font><font style="vertical-align: inherit;">(if you have Satellite 6.3 - 6.5) or the built-in </font><b><font style="vertical-align: inherit;">Ansible Tower Inventory Reader</font></b><font style="vertical-align: inherit;"> role</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Satellite 6.6 and higher). </font><font style="vertical-align: inherit;">Finally, click Submit to create an account for this user.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customize Ansible Tower</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to the Ansible Tower web interface and go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Credentials</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> screen </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Click the green </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ (Add)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">to create a new Credential entry. </font><font style="vertical-align: inherit;">We call it </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satellite_integration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and in the Credential Type we specify </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Red Hat Satellite 6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Then we enter the URL (in our case Satellite 6), as well as the username (in our case </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ansible_integration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and the password is the one that we set in Satellite above:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/xd/ws/ybxdws81uadmggdncbl_icg-ig8.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inventories</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> screen </font><font style="vertical-align: inherit;">, click the green </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ (Add)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">and select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inventory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specify satellite_inventory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the name </font><font style="vertical-align: inherit;">and click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to create an inventory. After that, go to the Sources tab of the newly created inventory and click the green </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ (Add)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">. We use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satellite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the source name </font><font style="vertical-align: inherit;">, and specify the source type as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Red Hat Satellite 6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the Credential field, specify </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satellite_integration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which was created in the previous step. Turn on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overwrite checkbox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overwrite Variables</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update on Launch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Update Options control group (you can learn more about these options using the question marks on the right). </font><font style="vertical-align: inherit;">In addition, in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache Timeout (Seconds)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field, </font><font style="vertical-align: inherit;">enter 90 and click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0n/_2/0j/0n_20jc394t3fh9vkxz00cqda3w.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, without leaving the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tab </font><font style="vertical-align: inherit;">, click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start sync process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> icon </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gz/ys/um/gzysumhr2fghwc0l-xymeofs7cu.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We wait until the icon turns green - this signals a successful completion of synchronization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can go to the Hosts tab and see the data that has been pulled from the Satellite:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/4_/qk/ne4_qk5ne8ohsfx3iriwkkdfbvm.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also look at the Groups tab:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oj/sw/af/ojswafnsedywlukqweh3oib_hgu.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, synchronization not only pulled up the host lists from Satellite, but also divided them into groups according to the corresponding content views in Satellite, host groups, lifecycle environments, locations and organizations. </font><font style="vertical-align: inherit;">This grouping can be used to target Ansible scripts on target hosts, and this is a very powerful thing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you select a host on the Hosts tab, we will see that between Satellite and Ansible Tower a lot of auxiliary information about the host is synchronized, which is presented in the form of variables. </font><font style="vertical-align: inherit;">These variables can then be used in Ansible scripts:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/la/6o/fw/la6ofwr3cf91cfxktzok_0eoy7c.png"></div><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Dynamic Inventory Tied to Satellite</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we synchronized Satellite and Ansible Tower. Now we will consider how to use it in practice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way is to use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satellite_inventory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the Inventory source in the Ansible Tower Template. If the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hosts: all</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option is specified in the script </font><font style="vertical-align: inherit;">, the script will be run on all Satellite hosts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A more advanced option is to use automatically created inventory groups in scripts (how they are created - see above), in other words, specify the desired host group in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hosts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> line </font><font style="vertical-align: inherit;">. For example, as in this scenario where the screen package is installed:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
- name: Install screen package<font></font>
  hosts: "foreman_hostgroup_rhel6"<font></font>
  tasks:<font></font>
  - yum:<font></font>
      name: screen<font></font>
      state: installed<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we have registered </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hosts: foreman_hostgroup_rhel6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , thereby indicating the list of hosts forming the rhel6 host group in the Satellite. </font><font style="vertical-align: inherit;">Accordingly, the script will be executed only on these hosts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, in the script, you can specify in the hosts line those variables that Ansible Tower receives during synchronization with Satellite. </font><font style="vertical-align: inherit;">For example, you can do this:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
- name: Install screen package<font></font>
  hosts: "{{ hosts_var }}"<font></font>
  tasks:<font></font>
  - yum:<font></font>
      name: screen<font></font>
      state: installed<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we will be able to change the job template in Ansible Tower on the fly, indicating one of the inventory groups through an external variable.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jr/fe/iu/jrfeiulsq6wqesxwt-e1njpt2mm.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, the template will only run on hosts that are members of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rhel7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> group </font><font style="vertical-align: inherit;">in Satellite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, the job template can be configured so that at startup it will ask the user for the value of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hosts_var</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">(and at the same time display the available inventory groups in the form of comments):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ad/lh/gl/adlhglvneyz5ettasl8vh1z_mag.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The screen above illustrates the situation when, when the template is launched, the user is prompted to enter the name of the Satellite inventory group on whose hosts you want to run the script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, you can use the host variables pulled from Satellite during synchronization. </font><font style="vertical-align: inherit;">For example, here's what a script looks like showing how to reference these variables:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
- name: Show Satellite variables<font></font>
  hosts: all<font></font>
  tasks:<font></font>
  - name: Show subscription_status<font></font>
    debug:<font></font>
      msg: &gt;<font></font>
        Subscription Status: {{ foreman.subscription_status_label }}<font></font>
  - name: Show Errata Counts<font></font>
    debug:<font></font>
      msg: &gt;<font></font>
        Bug fixes: {{ foreman.content_facet_attributes.errata_counts.bugfix }},<font></font>
        Security: {{ foreman.content_facet_attributes.errata_counts.security }},<font></font>
        Enhancement: {{ foreman.content_facet_attributes.errata_counts.enhancement }},<font></font>
        Total: {{ foreman.content_facet_attributes.errata_counts.total }}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you run this script in Ansible Tower, it will show the values ‚Äã‚Äãof the variables:</font></font><br>
 <br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/la/3o/ub/la3oubu_3gdoc2o_tvxhuqycyko.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And of course, these variables can be used in conditional constructions when, so that tasks are launched only under certain conditions. </font><font style="vertical-align: inherit;">For example, if the host does not have security patches, or when the host subscription is invalid.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Red Hat Satellite and Red Hat Ansible themselves are very powerful tools, and their integration provides tangible synergy. </font><font style="vertical-align: inherit;">Above, we showed how to make Satellite a data source for Dynamic Inventory in Ansible and use it in practice.</font></font><br>
‚ÄÉ<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2. Autoconfiguration of new hosts through provisioning callback</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to many other features, Satellite is also able to initialize hosts, in other words, perform provisioning. Ansible Tower, in turn, is designed to configure hosts. Integration allows you to make sure that after the initialization of a new RHEL host by means of Satellite, Ansible Tower will automatically connect to this host and run the corresponding configuration script on it. Obviously, such a scheme saves a lot of time for system administrators, helping them to respond more quickly to the needs of the organization.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be noted that this scheme only works if several conditions are met. </font><font style="vertical-align: inherit;">First, Satellite should be used as a Dynamic Inventory data source in Ansible Tower (we covered this issue in the previous part). </font><font style="vertical-align: inherit;">Secondly, host initialization should not only be done through Satellite, but also work through the host group mechanism (for more details, see the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provisioning Guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below we show how to configure Satellite and Ansible Tower so that after initializing the host, it will automatically run the Ansible configuration script.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overview</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IT automation tools, such as Ansible Tower, usually fall into one of two categories: some work by the push method, others by the pull method. In push systems to which Ansible Tower belongs, the automation server initiates a connection to the host. In pull systems, the initiator is the host, which itself communicates with the automation server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, with automatic scripting on new hosts, a mixed scheme is used. The newly initialized host contacts the automation server with a request to ‚Äúcall back‚Äù to it and configure. After that, the automation server connects to this host and runs the configuration script requested by the host on it. Therefore, in Ansible Tower this mechanism is called provisioning callback, which can be translated as ‚Äúinitialization callback‚Äù.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To show why provisioning callback is needed at all, consider the following situation: we have a certain host configuration script that runs daily at midnight. Let's say at 8 a.m. we are initializing several new servers at once through Satellite. At the same time, Satellite is used as a Dynamic Inventory data source in Ansible Tower, so the created hosts automatically fall into Ansible. However, the next launch of the automation script will take place only at midnight, that is, after 16 hours. Obviously, this is far from ideal, and I would like the script to run immediately after the initialization of the new host. For this purpose provisioning callback is also thought up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, provisioning callback is configured and works as follows:</font></font><br>
<br>
<ol>
<li>  Ansible Tower   credential        root,  Satellite           . Tower    ,            .</li>
<li>   Job Template  Ansible Tower   provisioning callback.       URL     Host Config Key,        Ansible. </li>
<li> Satellite      ,       provisioning callback   Ansible Tower,  : URL-  Ansible Tower,  Host Config Key    Ansible.</li>
<li>      Satellite     /etc/systemd/system/ansible-callback.service (  RHEL 7  8;   RHEL 6  ).         provisioning callback   Ansible Tower,  ,     (URL-, Host Config Key   ).</li>
<li>Ansible Tower       Host Config Key.   , Tower       ,      root,    Job Template.   ,      .</li>
</ol><br>
<h4> Ansible Tower  Provisioning Callback</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start by creating a configuration script on the Ansible Tower server that changes the contents of / etc / motd, creates some kind of user, and installs a specific package. </font><font style="vertical-align: inherit;">Then we will use this script to configure new hosts immediately after they are initialized. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In real life, automation scripts are most likely stored in some version control system, but for simplicity, we assume that they lie directly on the Ansible Tower server. </font><font style="vertical-align: inherit;">Therefore, we enter the Ansible Tower server via SSH and create the directory / var / lib / awx / projects / provision for them by running the following command:</font></font><br>
<br>
<pre><code class="plaintext hljs"># mkdir /var/lib/awx/projects/provision
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we create our script in this directory, call it provision.yaml and write the following contents into it:</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Provision new host<font></font>
<font></font>
  hosts: all<font></font>
<font></font>
  tasks:<font></font>
<font></font>
  - name: Set content in /etc/motd <font></font>
<font></font>
    copy:<font></font>
<font></font>
      content: Authorized use only!<font></font>
<font></font>
      dest: /etc/motd<font></font>
<font></font>
      mode: 644<font></font>
<font></font>
      owner: root<font></font>
<font></font>
      group: root<font></font>
<font></font>
<font></font>
  - name: Create brian user account<font></font>
<font></font>
    user:<font></font>
<font></font>
      name: brian<font></font>
<font></font>
      uid: 10000<font></font>
<font></font>
      state: present<font></font>
<font></font>
<font></font>
  - name: Install tmux package<font></font>
<font></font>
    yum:<font></font>
<font></font>
      name: tmux<font></font>
<font></font>
      state: present<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to the Tower web interface and go to the Credentials screen. </font><font style="vertical-align: inherit;">We click the button with the green plus sign to create a new credential record, give it the name provisioning_root, and also set the Credential Type as Machine. </font><font style="vertical-align: inherit;">In the Username field, write root, and in the Password field, specify the password that is specified in Satellite for use on the new hosts of the corresponding host group in Satellite (its name can be found in the Satellite web interface on the Operating System tab). </font><font style="vertical-align: inherit;">Using this entry, Ansible Tower will be able to log in to new hosts created during initialization via Satellite.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zf/b7/lb/zfb7lbondu4unvzqe-h5ex-2e54.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, in the Ansible Tower interface, go to the Projects screen and click the green plus sign to create a new project. </font><font style="vertical-align: inherit;">Call it provision, change SCM Type to Manual, and specify provision as the Playbook Directory:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/aq/ib/ybaqibhcd2nlts3ysjwzfphdr8w.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then, in the Ansible Tower interface, go to the Templates screen, click the green plus sign to create a new Job Template. </font><font style="vertical-align: inherit;">We will call it provision, in the Inventory field we will write Satellite, in the Project field - provision, in the Playbook field - provision.yaml, and in the Credential field - provisioning_root. </font><font style="vertical-align: inherit;">In addition, you need to enable the Allow Provisioning Callbacks checkbox and click the magic wand icon to the right of the Host Config Key field to generate a secret key. </font><font style="vertical-align: inherit;">This key is needed in order to request a provisioning callback could not be anyone, but only someone who knows the Host Config Key. </font><font style="vertical-align: inherit;">Without the correct key, the Ansible Tower server simply will not respond to the request.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/lo/f6/mxlof6mxbd8ny0f0wursfzhqdzy.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to remember for the future the value of the Host Config Key, as well as the Template ID, which can be found from the URL of this Job Template: </font></font><br>
<br>
<pre><code class="plaintext hljs">https://tower.example.com/#/templates/job_template/11
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, the ID is 11. </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Satellite for Provisioning Callback</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to the satellite web interface, go to the Configure screen and click Host Groups. </font><font style="vertical-align: inherit;">We select the existing host group, which is used when initializing new hosts, in our example, this is RHEL 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the host group editing screen, go to the Parameters tab and create 4 new parameters: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ansible_host_config_key - here we enter Host Config Key from our Ansible Tower Template. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ansible_job_template_id - here we write the Template ID, which we previously found out from the template URL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ansible_tower_fqdn is the fully qualified domain name of the Ansible Tower server. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ansible_tower_provisioning - set true.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/th/ji/m8/thjim8rh06qhbq_gdwhxfc4jlue.png"></div><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check how everything works</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now initialize the new host from Satellite and verify that the provisioning callback works and automatically runs our script on that host. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the Satellite web interface, go to the Hosts screen, click Create Host and verify that the group for which we just created 4 new parameters is used, that is, the RHEL 8 group.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xt/mn/yc/xtmnycjplympck_rrh4lag9l2ts.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the host initialization is complete, we need to make sure that the template on it has been successfully launched. </font><font style="vertical-align: inherit;">To do this, go to the Templates screen in the Ansible Tower web interface, look for our template in the list and see if the leftmost square of its indicator turns green:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lk/g2/o-/lkg2o-kj5rtuuotxnvyhnxrcr3e.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We click this green box to see the launch details, which in our case was successful. </font><font style="vertical-align: inherit;">Please note that this task has a limit (Limit) - the launch of only new hosts that are created during initialization. </font><font style="vertical-align: inherit;">Well, this is not surprising, since the provisioning callback mechanism only runs the template on those hosts that request it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aa/ll/t1/aallt1qykw1g_z9t_hmsujmtqby.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's go to the newly created host and check if it matches what is written in the script:</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# rpm -qa | grep tmux<font></font>
tmux-2.7-1.el8.x86_64<font></font>
<font></font>
[root@provision-test-rhel8 ~]# id brian<font></font>
uid=10000(brian) gid=10000(brian) groups=10000(brian)<font></font>
<font></font>
[root@provision-test-rhel8 ~]# cat /etc/motd<font></font>
Authorized use only!<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troubleshooting</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the Ansible Tower template does not start automatically on a new host initialized via Satellite, there are a few things to check. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step is to find out if the Ansible Tower received a request for a provisioning callback, how the script ran and whether it started at all. To do this, in the Tower interface, go to the Templates screen and look at the color of the indicator next to the template name: green - the launch was successful, red - the launch failed.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gc/ra/id/gcraidlrqdznksnzfsryp80qbwk.png"></div><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the box is red, then we click it and look for additional information to understand why the launch failed (these can be both syntax errors in the script and other problems). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the square is green, then we click and look anyway, since the task could report successful execution, but it did not actually start on our host. For example, if the hosts line in the script indicates specific hosts and groups, but does not include the hosts created during initialization, the task will report success, but the additional information will say ‚Äúskipping: no hosts matched‚Äù.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the indicator square is neither green nor red, then you need to start by checking the parameters of the host group in Satellite. Make sure the Ansible Tower server URL, Host Config Key, and template ID are correctly specified there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, go to the newly initialized host and check that there is a file /etc/systemd/system/ansible-callback.service (on RHEL 7 or 8 systems) or a file /root/ansible_provisioning_call.sh (RHEL 6). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the file does not exist, verify that the ansible_tower_provisioning parameter is set to true for this host group, and that the initialization patterns on the Satellite server have not been changed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the file /etc/systemd/system/ansible-callback.service is present on the host, then open it and look for the URL where the provisioning callback request is sent:</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# cat /etc/systemd/system/ansible-callback.service<font></font>
[Unit]<font></font>
Description=Provisioning callback to Ansible Tower<font></font>
Wants=network-online.target<font></font>
After=network-online.target<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/usr/bin/curl -k -s --data "host_config_key=aa5ebe82-491c-4fbb-bd36-a6657549451e" https://tower.example.com/api/v2/job_templates/11/callback/<font></font>
ExecStartPost=/usr/bin/systemctl disable ansible-callback<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can run curl and manually duplicate the commands specified in this file to manually initiate a provisioning callback:</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# /usr/bin/curl -k -s --data "host_config_key=aa5ebe82-491c-4fbb-bd36-a6657549451e" https://tower.example.com/api/v2/job_templates/11/callback/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If an invalid Host Config Key is specified, we will receive the following error message:</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# /usr/bin/curl -k -s --data "host_config_key=wrong-key-here" https://tower.example.com/api/v2/job_templates/11/callback/<font></font>
<font></font>
{"detail":"You do not have permission to perform this action."}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the Template ID is incorrectly specified (here - 43 instead of 11), then the answer will be as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# /usr/bin/curl -k -s --data "host_config_key=wrong-key-here" https://tower.example.com/api/v2/job_templates/43/callback/<font></font>
<font></font>
{"detail":"Not found."}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also disable silent (-s) mode in the curl command so that it displays errors related to resolving the host name, as in the example below, where we replaced the correct name ansible.example.com with the incorrect ansible-tower.example.com :</font></font><br>
<br>
<pre><code class="plaintext hljs">[root@provision-test-rhel8 ~]# /usr/bin/curl -k  --data "host_config_key=wrong-key-here" https://ansible-tower.example.com/api/v2/job_templates/11/callback/<font></font>
<font></font>
curl: (6) Could not resolve host: ansible-tower.example.com<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, when finding out the cause of the error, the /var/log/tower/tower.log file on the Ansible Tower server may come in handy. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, this file records the use of an invalid Host Config Key:</font></font><br>
<br>
<pre><code class="plaintext hljs">2019-11-19 23:19:17,371 WARNING  awx.api.generics status 403 received by user AnonymousUser attempting to access /api/v2/job_templates/11/callback/ from 192.168.0.138
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This also fixes the use of an invalid Template ID:</font></font><br>
<br>
<pre><code class="plaintext hljs">2019-11-19 23:19:49,093 WARNING  awx.api.generics status 404 received by user AnonymousUser attempting to access /api/v2/job_templates/43/callback/ from 192.168.0.138<font></font>
<font></font>
2019-11-19 23:19:49,095 WARNING  django.request Not Found: /api/v2/job_templates/43/callback/<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The integration of Satellite and Ansible Tower can greatly optimize the initialization and configuration of new hosts, which saves a lot of time for system administrators, helping them to respond more quickly to the needs of the organization. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On March 24, from 11:00 to 12:30 Red Hat will hold a webinar ‚ÄúWhat You Need to Know About Automation: Basic Ansible Skills‚Äù</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Automation is a topic approaching in popularity and the number of requests for digital transformation. We will tell you about our view of automation - along with Ansible and Ansible Tower - and this will be the basic information that will open you the door to the brave new world of declarative automation tools.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this webinar, you will understand the basic Ansible entities, such as playbook, inventory, module. </font><font style="vertical-align: inherit;">Together with you, we will master the basic YAML syntax so that you can write your own scripts. </font><font style="vertical-align: inherit;">It will also consider launching scripts and escalating privileges. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, you will get a basic set of skills that will allow you to successfully study documentation and other literature without the constant feeling that you are missing something. </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and come!</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491122/index.html">Forensic analysis of HiSuite backups</a></li>
<li><a href="../en491130/index.html">Vue Features to Remember</a></li>
<li><a href="../en491132/index.html">When the bloom filter does not fit</a></li>
<li><a href="../en491134/index.html">5 stages of inevitability of adoption of ISO / IEC 27001 certification. Negation</a></li>
<li><a href="../en491136/index.html">Projecting content in Angular or lost ng-content documentation</a></li>
<li><a href="../en491146/index.html">UML for developers</a></li>
<li><a href="../en491150/index.html">How I hacked scammers, or just the insides of phishing panels</a></li>
<li><a href="../en491154/index.html">Course search: how to build a learning path</a></li>
<li><a href="../en491156/index.html">Measurable Empathy: Predicting Sympathy for Brain MRI</a></li>
<li><a href="../en491162/index.html">PostgreSQL Antipatterns: a tale about iterative refinement of the search by name, or ‚ÄúOptimization back and forth‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>