<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â‰ï¸ â„¹ï¸ â™¦ï¸ Harken Sie auf dem Weg, um am Leben zu bleiben ğŸ‘©ğŸ¼â€ğŸ¤ ğŸ‘ğŸ¾ ğŸ’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Steigerung der AktivitÃ¤t des Datenaustauschs zwischen Mikrodiensten ist hÃ¤ufig ein Problem in der Architektur moderner IT-LÃ¶sungen. DrÃ¼cken Sie da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Harken Sie auf dem Weg, um am Leben zu bleiben</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495308/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Steigerung der AktivitÃ¤t des Datenaustauschs zwischen Mikrodiensten ist hÃ¤ufig ein Problem in der Architektur moderner IT-LÃ¶sungen. </font><font style="vertical-align: inherit;">DrÃ¼cken Sie das Maximum und Ã¼berleben Sie um jeden Preis - eine ernsthafte Herausforderung fÃ¼r jede Entwicklung. </font><font style="vertical-align: inherit;">Daher ist die Suche nach optimalen LÃ¶sungen ein ununterbrochener Prozess. </font><font style="vertical-align: inherit;">Der Artikel beschreibt kurz die Probleme, die bei der Verwendung hoch geladener http-Anforderungen auftreten kÃ¶nnen, und MÃ¶glichkeiten, diese zu umgehen.</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Geschichte beginnt mit einem Fehler. Irgendwie haben wir Lasttests durchgefÃ¼hrt, deren Hauptelement die AusfÃ¼hrung einer groÃŸen Anzahl kurzer http-Anfragen war. Ein Client, der unter </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcore 2.2</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geschrieben wurde, </font><em><font style="vertical-align: inherit;">lÃ¶st</font></em><font style="vertical-align: inherit;"> ab einem bestimmten Zeitpunkt eine </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Net.Sockets.SocketException aus: Adresse, die bereits verwendet wird</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es wurde schnell klar, dass die Ports keine Zeit hatten, sich auf dem Client freizugeben, und irgendwann wurde dem System verweigert, einen neuen zu Ã¶ffnen. Wenn wir nun zum Code gehen, bestand das Problem darin, den alten Ansatz mit der </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HttpWebRequest-</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Klasse </font><font style="vertical-align: inherit;">und </font><em><font style="vertical-align: inherit;">-Konstruktion zu</font></em><font style="vertical-align: inherit;"> verwenden:</font></font></p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> request = WebRequest.CreateHttp(uri);
<span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> resp = request.GetResponse()){ â€¦ }</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es scheint, dass wir die Ressource freigeben, und der Port sollte rechtzeitig freigegeben werden. </font><font style="vertical-align: inherit;">Allerdings </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netstat</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> signalisiert einen raschen Anstieg der Zahl der Ports in TIME_WAIT Zustand. </font><font style="vertical-align: inherit;">Dieser Status bedeutet, auf das SchlieÃŸen der Verbindung zu warten (und mÃ¶glicherweise verlorene Daten zu empfangen). </font><font style="vertical-align: inherit;">Infolgedessen kann der Port 1-2 Minuten lang darin sein. </font><font style="vertical-align: inherit;">Dieses Problem wird in vielen Artikeln ausfÃ¼hrlich behandelt ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probleme mit der Warteschlange TIME_WAIT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verlauf Ã¼ber TIME_WAIT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Dies bedeutet jedoch, dass </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dotnet</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> â€ehrlichâ€œ versucht, die Verbindung zu schlieÃŸen, und dies geschieht bereits durch den Fehler der Timeout-Einstellungen im System.</font></font></p><br>
<h3 id="pochemu-tak-proishodit-i-kak-s-etim-borotsya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum passiert das und wie geht man damit um?</font></font></h3><br>
<p>    <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">keep-alive</a></em>.     .      ,     .  <em>msdn</em>,  <em>KeepAlive</em>  <em>HttpWebRequest</em>    <em>true</em>.      <em>HttpWebRequest</em> Â«Â» ,    ,      .   , <em>HttpWebRequest</em>        Â«Connection: keep-aliveÂ»,       <em>HTTP/1.1</em>. ,   ,    KeepAlive.   HttpWebRequest.KeepAlive = false,      Â«Connection: closeÂ».  ,        .      nginx   . </p><br>
<p>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> request = WebRequest.CreateHttp(uri);<font></font>
  request.KeepAlive = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> resp = <span class="hljs-keyword">await</span> request.GetResponseAsync();
  <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> sr = <span class="hljs-keyword">new</span> StreamReader(resp.GetResponseStream()))<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> content = sr.ReadToEnd();<font></font>
  }<font></font>
}</code></pre><br>
<p>      ,    ( 1000   )        .       CLOSE_WAIT, LAST_ACK.  -   ,       .     ,    Â«Â»   .</p><br>
<h3 id="zakryvat-nelzya-pereispolzovat"> , </h3><br>
<p>,    ,   .      <em>keep-alive</em>    <em>HttpClient</em>.            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://docs.microsoft.com/ru-ru/dotnet/api/system.net.http." rel="nofollow"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.</p><br>
<p>    ,  ,   ?   keep-alive        nginx:</p><br>
<ul>
<li>keepalive_timeout â€“   (  15)</li>
<li>keepalive_requests â€“       (  100)</li>
</ul><br>
<p>    <em>netstat</em>  <em>wireshark</em>,            .   <em>keepalive_requests</em>    (&gt; 1000)  ,     .</p><br>
<h3 id="vyvod"></h3><br>
<p>  <strong> </strong> http    ,     .       .         ,       ,     <em>keep-alive</em>.  <em>keep-alive</em>          ,            .</p><br>
<p>     :</p><br>
<ul>
<li>RunHttpClient â€“   HttpClient  "Connection: keep-alive" </li>
<li>RunHttpClientClosed â€“   HttpClient  "Connection: closed"</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed - verwendet den Klassen-HttpWebRequest-Modus "Verbindung: geschlossen"</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Nginx-Server wird mit den folgenden Parametern konfiguriert: </font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keepalive_timeout 60s;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keepalive_requests 100000;</font></font></li>
</ul><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methode</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N.</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Werbungen</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bedeuten</font></font></th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Runhttpclient</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">963,3 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3,857,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunHttpClientClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.612,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Runhttpclient</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.573,9 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">37.947,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunHttpClientClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16.112,9 ms</font></font></td>
</tr>
</tbody>
</table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495294/index.html">Makros fÃ¼r einen Pythonisten. Yandex-Bericht</a></li>
<li><a href="../de495296/index.html">Forensik, SQL-Injection und leidende Katze: Analyse der Aufgabe Nr. 3 der Online-Phase NeoQUEST-2020</a></li>
<li><a href="../de495298/index.html">Bewerten Sie die Optionen von Monte Carlo Clojure</a></li>
<li><a href="../de495302/index.html">So steigern Sie den Umsatz in einem Online-Shop in 4 Monaten um das 2,5-fache - ein Argument fÃ¼r SEO-Werbung</a></li>
<li><a href="../de495304/index.html">VerjÃ¼ngung menschlicher Zellen aufgrund ihrer Neuprogrammierung</a></li>
<li><a href="../de495310/index.html">Elektronischer Durchgang: Biometrie und Multiformat</a></li>
<li><a href="../de495312/index.html">Perimeter-Sicherheit - die Zukunft ist jetzt</a></li>
<li><a href="../de495314/index.html">Wie kann man Fehlinformationen filtern, wenn sie aus offiziellen Quellen stammen?</a></li>
<li><a href="../de495330/index.html">Verdiente PopularitÃ¤t in Zahlen</a></li>
<li><a href="../de495332/index.html">Quartett 9: Allegro | Typoskript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>