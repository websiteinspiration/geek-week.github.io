<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛳️ 👋🏻 👩🏽‍⚖️ Was ist MagicString und sind diese Linien so magisch? 🎸 🧑🏽‍🤝‍🧑🏼 🙋🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MagicString ist eine wenig bekannte Bibliothek. Trotzdem löst es eines der dringendsten Probleme - das Ändern des Quellcodes anhand seiner Struktur (A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Was ist MagicString und sind diese Linien so magisch?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502760/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagicString ist eine wenig bekannte Bibliothek. </font><font style="vertical-align: inherit;">Trotzdem löst es eines der dringendsten Probleme - das Ändern des Quellcodes anhand seiner Struktur (AST - Abstract Syntax Tree). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel erfahren wir, was MagicString ist und ob diese Zeilen wirklich „magisch“ sind. </font><font style="vertical-align: inherit;">Dies wird uns helfen, den nächsten Artikel zu verstehen, in dem ich erklären werde, wie wir es geschafft haben, Angular-Dokumentation so schnell zu übersetzen, und wie es bei der Erstellung eines universellen Übersetzers sowohl für Markdown als auch für Dateien eines anderen Formats helfen wird.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/vs/2s/tevs2snderlng8i4ucqdjp6q2t8.jpeg"><br>
<br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor 2 Wochen habe ich die russischsprachige Dokumentation von Angular ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angle24.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) veröffentlicht. Während dieser Zeit wurden 35 Probleme mit Korrekturen im Text und 2 Pull-Anfragen hinzugefügt. Ich bezweifelte aufrichtig, dass das System, in dem Sie den Text auswählen, eine Übersetzung anbieten und automatisch auf GitHub ausgeben, funktioniert. Aber Crowdsourcing funktioniert! :) Mehr dazu erfahren Sie in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diesem Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der Veröffentlichung war eine der am häufigsten gestellten Fragen: „Warum?“. Die Frage ist absolut richtig, aber um sie zu beantworten, müssen Sie zuerst verstehen, was MagicString ist, wie es funktioniert und wie es nützlich ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, wir haben einen einfachen Quellcode:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wollen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ersetzen </font><font style="vertical-align: inherit;">. Die einfachste Lösung besteht darin, const durch var durch den üblichen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String.prototype.replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu ersetzen </font><font style="vertical-align: inherit;">. Und für diese Aufgabe ist dies höchstwahrscheinlich die richtigste Lösung. Aber was ist, wenn wir const nur im globalen Bereich durch var ersetzen müssen? Aber nicht innerhalb von Funktionen ersetzen? Sie können sich natürlich eine komplexere Regelmäßigkeit einfallen lassen oder kniffligen Code schreiben, aber es gibt eine skalierbarere und flexiblere Möglichkeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir können die Parser verwenden, um AST - Abstract Syntax Tree zu erhalten. Wenn Sie daran interessiert sind, was AST ist, gehen Sie zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astexplorer.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Im Wesentlichen handelt es sich um einen Baum, der die Struktur Ihres Codes genau anzeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ferner hat jeder der Knoten in diesem AST einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Indizes , </font><font style="vertical-align: inherit;">die die Positionen dieser Elemente in dem Quellcode. Wenn wir diese Koordinaten kennen und die Struktur des Dokuments zur Hand haben, können wir komplexe Ersetzungen und Permutationen vornehmen, indem wir die Struktur des Dokuments beibehalten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/ox/o-/sroxo-of0k9wyxj-e8zdd-3rebe.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Regel erfolgt das Ersetzen mithilfe des </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Besuchermusterdesigns</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und mehrerer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helfer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die sich normalerweise in einer einzigen Bibliothek befinden, die als „Transformator-API“ bezeichnet werden kann. Jeder Parser hat eine eigene "Transformator-API". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solche Bibliotheken sind sehr einfach zu bedienen, haben jedoch mehrere Probleme. Eine davon ist die Leistung.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da jeder (nun ja, fast jeder) Knoten im AST-Baum Koordinaten enthält, müssen wir beim Ändern eines Knotens häufig die Koordinaten für den Rest des Baums aktualisieren. Hier können Sie argumentieren, dass Sie mit ein wenig Blut auskommen können - aktualisieren Sie die Koordinaten nicht überall, sondern rendern Sie den AST einfach zurück zum Text basierend auf der Struktur. Es gibt jedoch ein Problem: Sie verlieren sofort die Formatierung des Originaltextes, was unserer Aufgabe widerspricht - const in der vorhandenen Zeile durch var zu ersetzen. Tatsächlich erhalten wir eine neue Zeile mit einer neuen Formatierung. Und wenn dies für eine kleine Zeile kein Problem ist, stellen Sie sich eine Datei mit 1000 Zeilen vor, in der sich die Formatierung vollständig geändert hat, weil </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var ersetzt wurde</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das klingt nicht sehr gut.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/f4/0c/9cf40cjrgwepibssksrrwry2dw8.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier kommt die Magie von MagicString. Ich erfuhr zuerst von ihrer Existenz aus dem Rich Harris-Projekt, das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Butternut genannt wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Butternut ist ein JavaScript-Minifier. Butternutt soll </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3-mal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schneller als UglifyJS </font><font style="vertical-align: inherit;">und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-15-mal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schneller als Babili sein </font><font style="vertical-align: inherit;">. Ich werde weitermachen und sagen, dass das Projekt vor mindestens 3 Jahren mit einem Kupferbecken bedeckt war. Aber selbst dann war ich fasziniert von dem Geheimnis seiner Leistung. Es war ein MagicString. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werfen wir einen Blick auf die Arbeit mit MagicString:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> MagicString = <span class="hljs-built_in">require</span>( <span class="hljs-string">'magic-string'</span> );
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> MagicString( <span class="hljs-string">'const a = 1; const b = 2;'</span> );<font></font>
<font></font>
s.overwrite( <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'var'</span> );<font></font>
s.toString(); <span class="hljs-comment">// 'var a = 1; const b = 2;'</span><font></font>
<font></font>
<span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Algorithmus von MagicString ist sehr einfach: Wir wickeln die ursprüngliche Zeichenfolge in ein Objekt ein, in dem wir die Änderungen nicht direkt auf die Zeichenfolge anwenden, sondern die Koordinaten und die erforderlichen Schritte in ein Array für die Zukunft einfügen. </font><font style="vertical-align: inherit;">Und nur wenn jemand die resultierende Zeile erhalten möchte, beginnen wir 1 zu 1, um die akkumulierten Operationen auszuführen. </font><font style="vertical-align: inherit;">Z.B:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben const durch var ersetzt, beginnend bei Index 0 und endend bei Index 5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir wissen, dass alle nachfolgenden Ersetzungen einen Index von weniger als 2 haben müssen (var kleiner als const um 2 Zeichen, eine Zeile kürzer)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir aktualisieren die Koordinaten aller Operationen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir wenden die folgende Operation usw. an.</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/fy/us/kz/fyuskzc54fgvtkxeuwbldzpp2xq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles sieht ziemlich einfach aus. Aber warum ist MagicString schneller? Die Antwort ist ganz einfach: Die Anzahl der Operationen, die wir an unserem Baum ausführen, ist viel geringer als die Anzahl der AST-Knoten. Ganz zu schweigen von der für den AST benötigten Speichermenge und der Tatsache, dass Tree Traversal (Reisen durch einen Baum) keine freie Operation ist, sondern O (n + m)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b8/5b/jw/b85bjw9enaiibwd0vo3mbmbk198.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wenn ich bereit bin, eine zusätzliche halbe Stunde zu warten? Und hier kommt das zweite Plus von MagicString. Jeder Parser erfindet eine eigene API zur Transformation. Und das ist immer noch sehr gut, wenn es eine solche API gibt (nicht jeder Parser stellt sie bereit), sehr oft bleibt uns die Möglichkeit, den Quelltext normalerweise mit AST zu ersetzen. MagicString ist jedoch eine einzige universelle API zum Ändern der Quellzeichenfolge. Es spielt keine Rolle, welchen Parser oder welche Kombination von Parsern Sie verwendet haben. Mit MagicString können Sie mit jedem AST gleich gut arbeiten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/63/7v/jf/637vjfnual-mzplhm5ligr1u3bs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, Sie interessieren sich für MagicString. Im nächsten Artikel werde ich über den doppelten MagicString sprechen und wie man einen universellen Übersetzer für Markdown-Dokumente erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abonnieren Sie meinen Telegrammkanal </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@obenjiro_notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obenjiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um die folgenden Artikel zum Thema und viele andere interessante Dinge nicht zu verpassen.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502740/index.html">Wie desinfiziert man Flugzeuge im Zeitalter von Covid-19?</a></li>
<li><a href="../de502742/index.html">Wir laden Sie zu DINS DevOps EVENING (online) ein: der Entwicklung von Prometheus und Zabbix und der Verarbeitung von Nginx-Protokollen in ClickHouse</a></li>
<li><a href="../de502744/index.html">10 großartige Github-Entwickler-Repositorys (Teil 2)</a></li>
<li><a href="../de502746/index.html">Produktivität und Motivation aus der Ferne: Russische IT-Unternehmen teilen zwei Monate Erfahrung isoliert</a></li>
<li><a href="../de502752/index.html">3 Fallen, in die Anfänger Data Scientists fallen</a></li>
<li><a href="../de502762/index.html">Verschiedene Möglichkeiten, Daten an Angular-Komponenten zu übergeben</a></li>
<li><a href="../de502768/index.html">Der Titel dieses Artikels wurde von einem Computer erfunden.</a></li>
<li><a href="../de502770/index.html">Wir enthüllen ProLock: Analyse der Aktionen der neuen Ransomware-Betreiber mithilfe der MITRE ATT & CK-Matrix</a></li>
<li><a href="../de502772/index.html">So erstellen Sie einen PostgreSQL-Server in Google Cloud Platform SQL</a></li>
<li><a href="../de502782/index.html">Joel Spolsky: Abstraktionsstufe für Entwickler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>