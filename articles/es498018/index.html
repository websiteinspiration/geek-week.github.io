<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèª üéâ üëâ An√°lisis en l√≠nea en la arquitectura de microservicios: ayuda y sugerencia Postgres FDW Ã∂ –∏ Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂–∏Ã∂—Ç –∏—åÃ∂ üâê üëß ‚ô•Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La arquitectura de microservicios, como todo en este mundo, tiene sus ventajas y desventajas. Algunos procesos con √©l se vuelven m√°s f√°ciles, otros m√°...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>An√°lisis en l√≠nea en la arquitectura de microservicios: ayuda y sugerencia Postgres FDW Ã∂ –∏ Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂–∏Ã∂—Ç –∏—åÃ∂</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La arquitectura de microservicios, como todo en este mundo, tiene sus ventajas y desventajas. Algunos procesos con √©l se vuelven m√°s f√°ciles, otros m√°s complicados. Y en aras de la velocidad de cambio y una mejor escalabilidad, se deben hacer sacrificios. Una de ellas es la complicaci√≥n de la anal√≠tica. Si en un monolito todos los an√°lisis operativos pueden reducirse a consultas SQL para una r√©plica anal√≠tica, entonces, en una arquitectura multiservicio, cada servicio tiene su propia base y parece que no se puede prescindir de una consulta (¬øo se puede prescindir de ella?). Para aquellos que est√©n interesados ‚Äã‚Äãen c√≥mo resolvimos el problema de la anal√≠tica operativa en nuestra empresa y c√≥mo aprendimos a vivir con esta soluci√≥n, bienvenidos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi nombre es Pavel Sivash, en DomKlik trabajo en un equipo responsable de mantener el almac√©n de datos anal√≠ticos. Convencionalmente, nuestras actividades pueden atribuirse a la fecha de ingenier√≠a, pero, de hecho, el rango de tareas es mucho m√°s amplio. Existen est√°ndares ETL / ELT para ingenier√≠a de fecha, soporte y adaptaci√≥n de herramientas para el an√°lisis de datos y el desarrollo de sus propias herramientas. En particular, para los informes operativos, decidimos "fingir" que tenemos un monolito y darles a los analistas una base en la que tendr√°n todos los datos que necesitan.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, consideramos diferentes opciones. Fue posible construir un repositorio completo; incluso lo intentamos, pero para ser honesto, no pudimos hacer suficientes cambios frecuentes en la l√≥gica con un proceso bastante lento de construir un repositorio y realizar cambios en √©l (si alguien tuvo √©xito, escriba en los comentarios c√≥mo). Se podr√≠a decir a los analistas: "Chicos, aprendan Python e ir a se√±ales anal√≠ticas", pero este es un requisito adicional para la contrataci√≥n de personal, y parec√≠a que esto deber√≠a evitarse si es posible. Decidimos intentar usar la tecnolog√≠a FDW (Foreign Data Wrapper): de hecho, este es el dblink est√°ndar, que est√° en el est√°ndar SQL, pero con su interfaz mucho m√°s conveniente. Sobre la base de eso, tomamos una decisi√≥n, que finalmente se calm√≥, nos detuvimos. Sus detalles son objeto de un art√≠culo separado, o tal vez no uno,porque quiero hablar mucho: desde la sincronizaci√≥n de esquemas de bases de datos hasta el control de acceso y el anonimato de datos personales. Tambi√©n debe hacer una reserva de que esta soluci√≥n no sustituye a bases de datos anal√≠ticas y repositorios reales, solo resuelve un problema espec√≠fico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nivel superior se ve as√≠:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe una base de datos PostgreSQL, donde los usuarios pueden almacenar sus datos de trabajo, y lo m√°s importante, las r√©plicas anal√≠ticas de todos los servicios est√°n conectadas a esta base de datos a trav√©s de FDW. </font><font style="vertical-align: inherit;">Esto hace posible escribir una consulta en varias bases de datos, sin importar cu√°l sea: PostgreSQL, MySQL, MongoDB u otra cosa (archivo, API, si de repente no hay un contenedor adecuado, puede escribir el suyo). </font><font style="vertical-align: inherit;">Bueno, todo parece estar super! </font><font style="vertical-align: inherit;">¬øEstamos en desacuerdo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todo terminara tan r√°pido y simplemente, entonces, probablemente, no habr√≠a habido ning√∫n art√≠culo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante comprender claramente c√≥mo postgres maneja las solicitudes a servidores remotos. </font><font style="vertical-align: inherit;">Esto parece l√≥gico, pero a menudo no le prestan atenci√≥n: postgres divide la solicitud en partes que se realizan en servidores remotos de forma independiente, recopila estos datos y los c√°lculos finales se llevan a cabo por s√≠ mismos, por lo que la velocidad de la solicitud depender√° en gran medida de c√≥mo se escriba. </font><font style="vertical-align: inherit;">Tambi√©n debe tenerse en cuenta: cuando los datos provienen de un servidor remoto, ya no tienen √≠ndices, no hay nada que pueda ayudar al planificador, por lo tanto, solo nosotros podemos ayudarlo y sugerirlo. </font><font style="vertical-align: inherit;">Y me gustar√≠a contarles m√°s sobre eso.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitud simple y plan con ella</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mostrar c√≥mo Postgres ejecuta una consulta en una tabla de 6 millones de filas en un servidor remoto, veamos un plan simple.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El uso de la instrucci√≥n VERBOSE le permite ver la solicitud que se enviar√° al servidor remoto y los resultados que recibiremos para su posterior procesamiento (l√≠nea RemoteSQL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vayamos un poco m√°s all√° y agreguemos varios filtros a nuestra consulta: uno por el </font><font style="vertical-align: inherit;">campo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">booleano</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uno por la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marca</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><b><font style="vertical-align: inherit;">tiempo</font></b><font style="vertical-align: inherit;"> en el intervalo y uno por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ es donde se encuentra el momento al que debe prestar atenci√≥n al escribir consultas. </font><font style="vertical-align: inherit;">Los filtros no se transfirieron al servidor remoto, lo que significa que para ejecutarlo, el postgres extiende los 6 millones de l√≠neas, solo para filtrarlo localmente m√°s tarde (l√≠nea de filtro) y realizar la agregaci√≥n. </font><font style="vertical-align: inherit;">La clave del √©xito es escribir una solicitud para que los filtros se transfieran a la m√°quina remota, y recibamos y agreguemos solo las filas necesarias.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eso es algo booleanshit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con los campos booleanos, todo es simple. </font><font style="vertical-align: inherit;">En la solicitud original, el problema se debi√≥ a la declaraci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si lo reemplazamos con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , obtenemos el siguiente resultado:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, el filtro vol√≥ a un servidor remoto y el tiempo de ejecuci√≥n se redujo de 27 a 19 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena se√±alar que el operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> difiere del operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en que puede funcionar con el valor Nulo. </font><font style="vertical-align: inherit;">Esto significa que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es Verdadero</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el filtro dejar√° Falso y Nulo, mientras que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = Verdadero</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solo dejar√° Falso. </font><font style="vertical-align: inherit;">Por lo tanto, al reemplazar el </font><font style="vertical-align: inherit;">operador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se deben pasar dos condiciones con el operador OR al filtro, por ejemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE (col! = True) OR (col es nulo)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con booleano resuelto, sigue adelante. </font><font style="vertical-align: inherit;">Mientras tanto, devuelva el filtro por valor booleano a su forma original, para considerar independientemente el efecto de otros cambios.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marca de tiempo? </font><font style="vertical-align: inherit;">hz</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, a menudo hay que experimentar c√≥mo escribir una consulta que involucra servidores remotos, y solo entonces buscar una explicaci√≥n de por qu√© sucede esto. Se puede encontrar muy poca informaci√≥n sobre esto en Internet. Entonces, en experimentos, descubrimos que el filtro por una fecha fija vuela al servidor remoto con una explosi√≥n, pero cuando queremos establecer la fecha din√°micamente, por ejemplo, now () o CURRENT_DATE, esto no sucede. En nuestro ejemplo, agregamos un filtro para que la columna created_at contenga datos exactamente de 1 mes en el pasado (ENTRE CURRENT_DATE - INTERVAL '7 month' AND CURRENT_DATE - INTERVAL '6 month'). ¬øQu√© hemos hecho en este caso?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le pedimos al planificador que calcule la fecha en la subconsulta por adelantado y que pase la variable preparada al filtro. </font><font style="vertical-align: inherit;">Y esta pista nos dio un excelente resultado, ¬°la consulta se volvi√≥ casi 6 veces m√°s r√°pida! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuevamente, es importante tener cuidado aqu√≠: el tipo de datos en la subconsulta debe ser el mismo que el campo para el que estamos filtrando, de lo contrario, el planificador decidir√° que dado que los tipos son diferentes y primero debe obtener todos los datos y filtrarlos localmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devuelva el filtro por fecha a su valor original.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Freddy vs. </font><font style="vertical-align: inherit;">Jsonb</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, los campos booleanos y las fechas ya han acelerado nuestra consulta, pero hab√≠a un tipo de datos m√°s. </font><font style="vertical-align: inherit;">La batalla con el filtrado, francamente, todav√≠a no ha terminado, aunque hay √©xitos. </font><font style="vertical-align: inherit;">Entonces, as√≠ es como logramos pasar el filtro por </font><font style="vertical-align: inherit;">campo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al servidor remoto.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En lugar de filtrar operadores, debe usar el operador de tener un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en otro. </font><font style="vertical-align: inherit;">7 segundos en lugar de los 29 iniciales. Hasta ahora, esta es la √∫nica opci√≥n exitosa de transferir filtros a trav√©s de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a un servidor remoto, pero es importante tener en cuenta una limitaci√≥n: utilizamos la versi√≥n de base de datos 9.6, sin embargo, planeamos completar las √∫ltimas pruebas y pasar a la versi√≥n 12 a finales de abril. </font><font style="vertical-align: inherit;">A medida que actualicemos, escribiremos c√≥mo afect√≥, porque hay muchos cambios para los cuales hay muchas esperanzas: json_path, nuevo comportamiento CTE, push down (existente desde la versi√≥n 10). </font><font style="vertical-align: inherit;">Me gustar√≠a probarlo pronto.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acabar con √©l</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificamos c√≥mo cada cambio afecta la velocidad de la solicitud individualmente. </font><font style="vertical-align: inherit;">Ahora veamos qu√© sucede cuando los tres filtros se escriben correctamente.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, la solicitud parece m√°s complicada, es un tablero forzado, pero la velocidad de ejecuci√≥n es de 2 segundos, ¬°que es m√°s de 10 veces m√°s r√°pida! </font><font style="vertical-align: inherit;">Y estamos hablando de una consulta simple en un conjunto de datos relativamente peque√±o. </font><font style="vertical-align: inherit;">En solicitudes reales, recibimos un crecimiento de varios cientos de veces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir: si usa PostgreSQL con FDW, compruebe siempre que todos los filtros se env√≠an al servidor remoto, y estar√° contento ... Al menos hasta que llegue a las uniones entre tablas de diferentes servidores. </font><font style="vertical-align: inherit;">Pero esta es la historia para otro art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Gracias por la atenci√≥n! </font><font style="vertical-align: inherit;">Estar√© encantado de escuchar preguntas, comentarios e historias sobre su experiencia en los comentarios.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498002/index.html">Gu√≠a de bolsillo para el Z3</a></li>
<li><a href="../es498004/index.html">Estaci√≥n de trabajo en un contenedor acoplable</a></li>
<li><a href="../es498006/index.html">Elegir un abogado de patentes</a></li>
<li><a href="../es498012/index.html">Mikrotik RouterOS en Docker con Qemu</a></li>
<li><a href="../es498014/index.html">PyDERASN: como agregu√© soporte para big data</a></li>
<li><a href="../es498020/index.html">Aproximadamente un indicador aplicable para la evaluaci√≥n visual de las funciones de r√°pido crecimiento.</a></li>
<li><a href="../es498022/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 341 (del 13 al 19 de abril)</a></li>
<li><a href="../es498024/index.html">Construyendo ciudades con un clic del mouse con Houdini y Python</a></li>
<li><a href="../es498026/index.html">FOSS News No. 12 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 13 al 19 de abril de 2020</a></li>
<li><a href="../es498028/index.html">Simulaci√≥n de la pandemia de Python COVID-19</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>