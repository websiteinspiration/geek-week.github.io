<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèø ü§ô üö£üèΩ What is MagicString and are these lines so magical? üõçÔ∏è üè∞ üåé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MagicString is a little-known library. Despite this, it solves one of the most pressing problems - changing the source code using its structure (AST -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>What is MagicString and are these lines so magical?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502760/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagicString is a little-known library. </font><font style="vertical-align: inherit;">Despite this, it solves one of the most pressing problems - changing the source code using its structure (AST - abstract syntax tree). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article we will learn what MagicString is and whether these lines are really ‚Äúmagic‚Äù. </font><font style="vertical-align: inherit;">This will help us understand the next article in which I will explain how we managed to translate Angular documentation so quickly, and how it will help with the creation of a universal translator for both Markdown and files of any other format.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/vs/2s/tevs2snderlng8i4ucqdjp6q2t8.jpeg"><br>
<br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 weeks ago I released the Russian-language documentation of Angular ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angular24.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). During this time, 35 issues were added with corrections in the text and 2 pull request. I sincerely doubted that the system in which you select the text, offer a translation and automatically issue on GitHub will work. But crowdsourcing works! :) You can learn more about this from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the release, one of the most asked questions was: ‚ÄúWhy?‚Äù. The question is absolutely correct, but in order to answer it, you must first understand what MagicString is, how it works and how it is useful. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we have a simple source code:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We want to replace </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The simplest solution is to replace const with var with the usual </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String.prototype.replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And for this task, this is most likely the most correct solution. But what if we need to replace const with var only in the global scope? But do not replace them inside functions? You can, of course, come up with a more complex regularity or write tricky code, but there is a more scalable and flexible way. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can use the parsers to get AST - Abstract Syntax Tree. If you are interested in what AST is, then go to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astexplorer.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In essence, it is a tree that accurately displays the structure of your code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, each of the Nodes in this AST has a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">end</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indexes indicating the positions of these elements in the source code. Knowing these coordinates and having at hand the structure of the document, we can make complex replacements and permutations with preserving the structure of the document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/ox/o-/sroxo-of0k9wyxj-e8zdd-3rebe.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually, replacement is done using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visitor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern design </font><font style="vertical-align: inherit;">and several </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helpers</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which usually wrap </font><i><font style="vertical-align: inherit;">themselves</font></i><font style="vertical-align: inherit;"> in a single library, which can be called the ‚Äútransformer API". Each parser has its own "transformer API". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such libraries are very easy to use, but they have several problems. One of them is performance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since each (well, almost every) Node in the AST tree contains coordinates, when changing 1 node we often need to update the coordinates for the rest of the tree. Here you can argue that you can do with a little blood - do not update the coordinates everywhere, but simply render the AST back to the text based on the structure. But there is 1 problem: you will immediately lose the formatting of the original text, which contradicts our task - to replace const with var in the existing line. In fact, we get a new line with a new formatting. And if this is not a problem for a small line, imagine a file of 1000 lines in which the formatting has completely changed due to replacing </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . That doesn't sound very good.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/f4/0c/9cf40cjrgwepibssksrrwry2dw8.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here comes the magic of MagicString. I first learned of their existence from the Rich Harris project, which was called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">butternut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Butternut is a JavaScript minifier. Butternutt was claimed to be </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 times</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> faster than UglifyJS </font><font style="vertical-align: inherit;">and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-15 times</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> faster than Babili </font><font style="vertical-align: inherit;">. I‚Äôll run ahead and say that the project was covered with a copper basin at least 3 years ago. But even then, I was intrigued by the secret of its performance. It was a MagicString. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a look at working with MagicString:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> MagicString = <span class="hljs-built_in">require</span>( <span class="hljs-string">'magic-string'</span> );
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> MagicString( <span class="hljs-string">'const a = 1; const b = 2;'</span> );<font></font>
<font></font>
s.overwrite( <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'var'</span> );<font></font>
s.toString(); <span class="hljs-comment">// 'var a = 1; const b = 2;'</span><font></font>
<font></font>
<span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm of MagicString is very simple: we wrap the original string in an object in which we do not directly apply the changes to the string, but put the coordinates and what needs to be done into an array for the future. </font><font style="vertical-align: inherit;">And only when someone wants to get the resulting row, we begin 1 to 1 to perform the accumulated operations. </font><font style="vertical-align: inherit;">For example:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We replaced const with var, starting at index 0 and ending at index 5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We know that all subsequent replacements must have index less than 2 (var less than const by 2 characters, a line shorter)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We update the coordinates of all operations</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We apply the following operation, etc.</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/fy/us/kz/fyuskzc54fgvtkxeuwbldzpp2xq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything looks pretty simple. But why is MagicString faster? The answer is quite simple: the number of operations that we perform on our tree is much less than the number of AST nodes. Not to mention the amount of memory needed for the AST and the fact that Tree Traversal (traveling through a tree) is not a free operation, but O (n + m)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b8/5b/jw/b85bjw9enaiibwd0vo3mbmbk198.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if I am ready to wait an extra half hour? And here comes the second plus of MagicString. Each parser invents its own API for transformation. And this is still very good, if there is such an API (not every parser provides it), very often we are left without the ability to normally replace the source text using AST. But MagicString is a single universal API for changing the source string. It doesn't matter which parser or combination of parsers you used. With MagicString, you can work equally well with any AST. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/63/7v/jf/637vjfnual-mzplhm5ligr1u3bs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope you are interested in MagicString. In the next article I will talk about the double MagicString and how to make a universal translator of Markdown documents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subscribe to my Telegram channel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@obenjiro_notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obenjiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so as not to miss the following articles on the topic and many other interesting things.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502740/index.html">How to disinfect aircraft in the era of covid-19?</a></li>
<li><a href="../en502742/index.html">We invite you to DINS DevOps EVENING (online): the evolution of Prometheus and Zabbix and the processing of Nginx logs in ClickHouse</a></li>
<li><a href="../en502744/index.html">10 Great Github Developer Repositories (Part 2)</a></li>
<li><a href="../en502746/index.html">Productivity and motivation at a distance: Russian IT companies share 2 months of experience in isolation</a></li>
<li><a href="../en502752/index.html">3 traps that beginners Data Scientists fall into</a></li>
<li><a href="../en502762/index.html">Different ways to pass data to Angular components</a></li>
<li><a href="../en502768/index.html">The title of this article was invented by a computer.</a></li>
<li><a href="../en502770/index.html">We reveal ProLock: analysis of the actions of the new ransomware operators using the MITER ATT & CK matrix</a></li>
<li><a href="../en502772/index.html">How to create a PostgreSQL server on Google Cloud Platform SQL</a></li>
<li><a href="../en502782/index.html">Joel Spolsky: Abstraction Level for Developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>