<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöØ üßïüèΩ ü§† Escalando pruebas de Android en Odnoklassniki üêñ üéÄ üï§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Hola! Mi nombre es Roman Ivanitsky, trabajo en el equipo de automatizaci√≥n de pruebas de Odnoklassniki. OK es un gran servicio con m√°s de 70 millones...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Escalando pruebas de Android en Odnoklassniki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Hola! Mi nombre es Roman Ivanitsky, trabajo en el equipo de automatizaci√≥n de pruebas de Odnoklassniki. OK es un gran servicio con m√°s de 70 millones de usuarios. Si hablamos de dispositivos m√≥viles, la mayor√≠a usa OK.RU en tel√©fonos inteligentes con Android. Por esta raz√≥n, nos tomamos muy en serio la prueba de nuestra aplicaci√≥n de Android. En este art√≠culo contar√© la historia del desarrollo de las pruebas automatizadas en nuestra empresa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012, Odnoklassniki, la compa√±√≠a est√° experimentando un aumento activo en el n√∫mero de usuarios y un aumento en el n√∫mero de funciones de usuario. </font><font style="vertical-align: inherit;">Para satisfacer los objetivos del negocio, era necesario acortar el ciclo de lanzamiento, pero esto se vio obstaculizado por el hecho de que todas las funcionalidades se probaron manualmente. </font><font style="vertical-align: inherit;">La soluci√≥n a este problema vino por s√≠ sola: necesitamos pruebas autom√°ticas. </font><font style="vertical-align: inherit;">Por lo tanto, en 2012 en Odnoklassniki apareci√≥ un equipo de automatizaci√≥n de pruebas, y el primer paso fue comenzar a escribir pruebas.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de historia</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las primeras pruebas autom√°ticas en Odnoklassniki se escribieron en Selenium, para su lanzamiento plantearon Jenkins, Selenium Grid con Selenium Hub y un conjunto de Selenium Node. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soluci√≥n r√°pida, inicio r√°pido, beneficio r√°pido: perfecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el tiempo, el n√∫mero de pruebas aument√≥ y aparecieron servicios auxiliares, por ejemplo, servicios de lanzamiento, servicio de informes, servicio de datos de prueba. A finales de 2014, tuvimos mil pruebas que se ejecutaron en unos quince o veinte minutos. Esto no nos conven√≠a, ya que estaba claro que el n√∫mero de pruebas aumentar√≠a, y con ello aumentar√≠a el tiempo necesario para ejecutarlas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ese momento, la infraestructura de prueba automatizada se ve√≠a as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, con una cantidad de Nodo de selenio mayor o igual a 200, el Hub no pudo hacer frente a la carga. </font><font style="vertical-align: inherit;">Ahora este problema ya ha sido estudiado, y es por eso que aparecieron herramientas como Zalenium o el Selenoid favorito de todos. </font><font style="vertical-align: inherit;">Pero en 2014 no hab√≠a una soluci√≥n est√°ndar, por lo que decidimos hacer la nuestra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Defini√≥ los requisitos m√≠nimos que debe cumplir el servicio:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escalabilidad. </font><font style="vertical-align: inherit;">No queremos depender de las limitaciones del Selenium Hub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estabilidad. </font><font style="vertical-align: inherit;">En 2014, el Selenium Hub no era famoso por su funcionamiento estable.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tolerancia a fallos. </font><font style="vertical-align: inherit;">Necesitamos la capacidad de continuar el proceso de prueba en caso de falla del centro de datos o de cualquiera de los servidores.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, apareci√≥ nuestra soluci√≥n para escalar Selenium Grid, que constaba de un coordinador y gestores de nodos, aparentemente muy similar al Selenium Grid est√°ndar, pero con sus propias caracter√≠sticas. </font><font style="vertical-align: inherit;">Estas caracter√≠sticas se discutir√°n m√°s a fondo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coordinador</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, es un agente de recursos (los recursos se entienden como navegadores). Tiene una API externa a trav√©s de la cual las pruebas env√≠an solicitudes de recursos. Estas consultas se guardan en la base de datos como tareas a ejecutar. El coordinador sabe todo acerca de la configuraci√≥n de nuestro cl√∫ster: qu√© administradores de nodos existen, qu√© tipos de recursos pueden proporcionar estos administradores de nodos, la cantidad total de recursos, cu√°ntos recursos est√°n involucrados actualmente en las tareas. Al mismo tiempo, supervisa los recursos: actividad, estabilidad y, en cuyo caso, notifica a los responsables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una caracter√≠stica del coordinador es que integra a todos los administradores de nodos en las llamadas granjas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve la granja. Se utiliza m√°s de la mitad de los recursos y todos los nodos en l√≠nea:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n puede mostrar los nodos fuera de l√≠nea o ingresarlos en rotaci√≥n en un cierto porcentaje, esto es necesario si es necesario reducir la carga en un nodo en particular. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada granja se puede combinar con otras en una unidad l√≥gica, que llamamos servicio. Al mismo tiempo, se puede incluir una granja en varios servicios diferentes. En primer lugar, permite establecer l√≠mites y priorizar los recursos utilizados por cada servicio espec√≠fico. En segundo lugar, le permite administrar f√°cilmente la configuraci√≥n: tenemos la capacidad de agregar el n√∫mero de administradores de nodos en el servicio sobre la marcha, o viceversa, eliminarlos de la granja para poder interactuar con estos administradores de nodos, por ejemplo, configurar o actualizar, etc. .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La API del coordinador es bastante simple: es posible solicitar al servicio la cantidad actual de recursos utilizados, obtener su l√≠mite e iniciar o detener alg√∫n recurso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administrador de nodos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es un servicio que puede hacer dos cosas bien: recibir tareas del coordinador y lanzar algunos recursos a pedido. </font><font style="vertical-align: inherit;">De forma predeterminada, est√° dise√±ado para que cada lanzamiento del recurso est√© aislado, es decir, ninguno de los lanzamientos anteriores puede afectar el lanzamiento de pruebas posteriores. </font><font style="vertical-align: inherit;">Como respuesta, el coordinador usa un grupo de hosts y un conjunto de puertos elevados. </font><font style="vertical-align: inherit;">Por ejemplo, el host en el que se lanz√≥ el servidor Selenium y su puerto. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el host, se ve as√≠: el servicio Node Manager se est√° ejecutando y administra todo el ciclo de vida de los recursos. </font><font style="vertical-align: inherit;">Levanta los navegadores, los completa, se asegura de que no se olviden de cerrar. </font><font style="vertical-align: inherit;">Para garantizar el aislamiento mutuo, todo esto sucede en nombre del usuario del servicio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interacci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prueba interact√∫a con la infraestructura descrita anteriormente de la siguiente manera: se dirige al coordinador con una solicitud de los recursos necesarios, el coordinador guarda esta tarea por requerir ejecuci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El administrador del nodo, a su vez, recurre al coordinador de tareas. Habiendo recibido la tarea, comienza el recurso. Despu√©s de eso, env√≠a el resultado del lanzamiento al coordinador, los inicios fallidos tambi√©n se informan al coordinador. La prueba recibe el resultado de la solicitud de recursos y, si tiene √©xito, comienza a trabajar directamente con el recurso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las ventajas de este enfoque son reducir la carga sobre el coordinador al obtener la capacidad de trabajar directamente con el recurso. Contras: la necesidad de implementar la l√≥gica de interacci√≥n con el coordinador dentro de los marcos de prueba, pero para nosotros esto es aceptable.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy podemos ejecutar m√°s de 800 navegadores en paralelo en tres centros de datos. </font><font style="vertical-align: inherit;">Para el coordinador, este no es el l√≠mite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tolerancia a fallas se garantiza mediante el lanzamiento de varias instancias de coordinador que se encuentran detr√°s del firewall de DNS en diferentes centros de datos. </font><font style="vertical-align: inherit;">Esto garantiza el acceso a la instancia de trabajo en caso de un problema con el centro de datos o el servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtuvimos una soluci√≥n que cumpli√≥ con todos los requisitos establecidos inicialmente. </font><font style="vertical-align: inherit;">Ha estado operando constantemente desde 2015 y ha demostrado su efectividad.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Androide</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se trata de probar en Android, generalmente hay dos enfoques principales. El primero es usar WebDriver: as√≠ es como funcionan Selendroid y Appium. El segundo, al trabajar con herramientas nativas, implement√≥ Robotium, UI Automator o Espresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las similitudes fundamentales entre estos enfoques son obtener el dispositivo y obtener el navegador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchas m√°s diferencias, la principal es la necesidad de instalar el APK probado, con el que tomaremos artefactos en forma de registros, capturas de pantalla, etc. y tambi√©n, el hecho de que las pruebas se llevan a cabo en el dispositivo en s√≠, y no en el CI.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2015, Odnoklassniki comenz√≥ a cubrir su aplicaci√≥n de Android con autotest. Seleccionamos una m√°quina Linux, conectamos un dispositivo real a trav√©s de USB y comenzamos a escribir pruebas en Robotium. Esta soluci√≥n simple le permiti√≥ obtener resultados r√°pidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pas√≥ el tiempo, aument√≥ la cantidad de pruebas y la cantidad de dispositivos. Para resolver las tareas de administraci√≥n, se cre√≥ Device Manager, un contenedor sobre </font><font style="vertical-align: inherit;">comandos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Android Debug Bridge), que permite que la interfaz http api los ejecute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve√≠a la primera API para Device Manager: con su ayuda, podr√≠a obtener una lista de dispositivos, instalar / desinstalar APK, ejecutar pruebas y obtener resultados.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, notamos que los resultados de la prueba se degradan al inicio en el servidor ADB al que est√° conectado m√°s de un dispositivo. La soluci√≥n que nos ayud√≥ a mejorar la estabilidad se encontr√≥ al aislar cada servidor ADB con Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La granja est√° lista: puede conectar tel√©fonos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muchos est√°n familiarizados con esta imagen. Escuch√© que si est√°s involucrado en granjas de Android, est√°s como en el infierno todos los d√≠as.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un emulador de Android vino en nuestra ayuda. Su uso se debi√≥ a dos factores: en primer lugar, en ese momento ya hab√≠a alcanzado el nivel de estabilidad necesario y, en segundo lugar, no ten√≠amos ninguna caracter√≠stica que dependiera espec√≠ficamente del hierro en nuestras pruebas. Adem√°s, este emulador se proyect√≥ bien en la infraestructura existente en ese momento. El siguiente paso fue ense√±arle al administrador del Nodo a lanzar nuevos tipos de recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© se requiere para ejecutar el emulador de Android? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, necesita un SDK de Android con un conjunto de utilidades. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, debe crear AVD (dispositivo virtual Android): as√≠ es como se organizar√° su emulador de Android: qu√© arquitectura tendr√°, cu√°ntos n√∫cleos usar√°, si los servicios de Google estar√°n disponibles, etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, debe seleccionar el nombre del AVD creado, establecer los par√°metros, por ejemplo, transferir el puerto en el que se iniciar√° ADB e iniciar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, existe una peculiaridad en dicho esquema: el sistema le permite ejecutar solo un emulador de instancia en un AVD espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n a este problema fue crear un AVD b√°sico, que se almacen√≥ en la memoria, esto hizo posible copiarlo en otro lugar. </font><font style="vertical-align: inherit;">Durante el lanzamiento del emulador de Android, el AVD base se copi√≥ a un directorio temporal asignado a la memoria, despu√©s de lo cual comenz√≥. </font><font style="vertical-align: inherit;">Tal esquema funcion√≥ r√°pidamente, pero fue engorroso. </font><font style="vertical-align: inherit;">Hasta la fecha, este problema se ha resuelto con la opci√≥n de solo lectura, que le permite ejecutar emuladores de Android en cantidades ilimitadas desde un AVD</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actuaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En base a los resultados de trabajar con AVD, desarrollamos varias recomendaciones internas:</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cuanto a las im√°genes de Docker para probar en Android, quiero resaltar Agoda y Selenoid, utilizan al m√°ximo las capacidades de los emuladores de Android. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diferencia entre ellos es que en el Selenoid predeterminado tienen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Agoda y el emulador "limpio". Adem√°s, Selenoid tiene m√°s apoyo de la comunidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A finales de 2018, se cre√≥ CloudNode-Manager, se pone en contacto con el coordinador, recibe tareas y se inicia utilizando comandos en la nube. En lugar de m√°quinas de hierro, este servicio utiliza los recursos de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una nube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la propia nube privada de Odnoklassniki.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logramos escalar al ense√±ar a DeviceManager c√≥mo trabajar con el Coordinador. Para hacer esto, tuve que cambiar la API del administrador de dispositivos para agregar la capacidad de solicitar un tipo de dispositivo (virtual / real). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es lo que sucede si intenta ejecutar ADB Install en 250 emuladores desde una sola m√°quina. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los asistentes reaccionaron inmediatamente a esto y comenzaron un incidente: la m√°quina carg√≥ la interfaz de red gigabit con tr√°fico saliente. Esta complejidad se resolvi√≥ aumentando el rendimiento en el servidor. No puedo decir que este problema nos haya causado muchos problemas, pero no debes olvidarlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parecer√≠a que el √©xito es el Devicemanager, coordinador, escalamiento. Podemos ejecutar pruebas en toda la granja. En principio, podemos ejecutarlos en cada solicitud de extracci√≥n, y el desarrollador recibir√° r√°pidamente comentarios.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no todo es tan color de rosa. Es posible que haya notado que hasta ahora no se ha dicho nada sobre la calidad de las pruebas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve√≠an nuestros lanzamientos. Y lo m√°s interesante es que entre los lanzamientos podr√≠an caerse pruebas completamente diferentes. Estas fueron ca√≠das inestables. Y ni yo, ni los desarrolladores, ni los evaluadores confiamos en estos resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo lidiamos con este problema? Simplemente copiaron todo, desde Robotium a Espresso, y se volvi√≥ bueno ... En realidad, no. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver este problema, no solo reescribimos todo en Espresso, sino que tambi√©n comenzamos a usar la API para todo tipo de acciones, como subir fotos, crear publicaciones, agregar a amigos, etc., </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iniciamos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una sesi√≥n r√°pidamente, usamos </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">diplinks</font></a><font style="vertical-align: inherit;"> que te permit√≠an ir directamente a la pantalla deseada y, por supuesto, analizamos todos los casos de prueba.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora las ejecuciones de prueba se ven as√≠: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puede notar que las pruebas rojas permanecen, pero es importante recordar que estas son pruebas de punta a punta que se ejecutan en producci√≥n. Tenemos un l√≠mite en el n√∫mero de pruebas que pueden caer en la rama principal de la aplicaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos pruebas estables y escalado. Sin embargo, la infraestructura de prueba todav√≠a est√° muy vinculada a las pruebas. Al mismo tiempo, debido a la expectativa de pruebas de extremo a extremo, CI est√° ocupado y otros ensamblados pueden hacer cola, esperando agentes libres. Adem√°s, no existe un esquema claro para trabajar con inicios paralelos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las razones mencionadas anteriormente se convirtieron en el √≠mpetu para el desarrollo de QueueRunner, un servicio que le permite ejecutar pruebas de forma asincr√≥nica sin bloquear el CI. </font><font style="vertical-align: inherit;">Para trabajar, necesita un APK de prueba y prueba, as√≠ como un conjunto de pruebas. </font><font style="vertical-align: inherit;">Una vez recibidos los datos necesarios, podr√° organizar corridas en la cola, asignando y liberando los recursos necesarios. </font><font style="vertical-align: inherit;">QueueRunner descarga los resultados de la ejecuci√≥n a Jira y Stash, y tambi√©n los env√≠a por correo y en el messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner tiene un flujo de prueba: monitorea el ciclo de vida de la prueba. </font><font style="vertical-align: inherit;">El flujo predeterminado que usamos ahora consta de cinco pasos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dispositivo receptor </font><font style="vertical-align: inherit;">En este punto, el Administrador de dispositivos solicita a trav√©s del coordinador un dispositivo real o virtual.</font></font></li>
<li> .        APK  ,    ‚Äì  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, cinco pasos simples son el ciclo de vida completo de la prueba en nuestro servicio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© beneficios nos dio QueueRunner? En primer lugar, utiliza todos los recursos posibles al m√°ximo: se puede escalar a toda la granja y obtener resultados r√°pidamente. En segundo lugar, con la bonificaci√≥n, tuvimos la oportunidad de controlar la secuencia de pruebas. Por ejemplo, podemos ejecutar las pruebas m√°s largas o problem√°ticas al principio y as√≠ reducir el tiempo que lleva esperar a que se ejecuten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner tambi√©n le permite hacer retransmisiones inteligentes. Almacenamos todos los datos en la base de datos, por lo que en cualquier momento podemos ver el historial de la prueba. Por ejemplo, es posible observar la proporci√≥n de pases exitosos y no exitosos de la prueba y decidir si, en principio, vale la pena reiniciar la prueba.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner y Devicemanager nos han dado la capacidad de adaptarnos a la cantidad de recursos. Ahora podemos escalar a toda la granja, gracias al uso de emuladores, es decir, un n√∫mero casi ilimitado de dispositivos virtuales nos dio la oportunidad de ejecutar muchas m√°s pruebas, pero si por alguna raz√≥n los recursos no est√°n disponibles, el servicio esperar√° a que regresen y no habr√° p√©rdida de lanzamientos. Usamos solo los recursos disponibles para nosotros, en consecuencia, despu√©s de alg√∫n tiempo los resultados a√∫n se obtendr√°n y, al mismo tiempo, el CI no se bloquear√°. Y lo m√°s importante, la infraestructura de prueba y las pruebas ahora est√°n separadas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, para ejecutar pruebas en Android, solo necesita darnos un APK de prueba y una lista de pruebas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hemos recorrido un largo camino desde la granja Selenium en m√°quinas virtuales hasta el lanzamiento de pruebas de Android en la nube. </font><font style="vertical-align: inherit;">Sin embargo, este camino a√∫n no se ha completado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proceso de desarrollo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos c√≥mo se relaciona la infraestructura de prueba con el proceso de desarrollo y c√≥mo lo ven los probadores y desarrolladores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro equipo de Android utiliza el GitFlow est√°ndar: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cada funci√≥n tiene su propia rama. El desarrollo principal tiene lugar en la rama de desarrollo. Un desarrollador que decide crear una nueva s√∫per caracter√≠stica comienza su desarrollo en su propia rama, mientras que otros desarrolladores pueden trabajar en otras ramas en paralelo. Cuando un desarrollador considera que el c√≥digo idealmente bello y mejor del mundo est√° listo y necesita implementarse a los usuarios lo m√°s r√°pido posible, hace una solicitud de extracci√≥n en el desarrollo, la unidad se ensambla autom√°ticamente, se ejecutan pruebas unitarias y pruebas de componentes. Simult√°neamente, los APK se ensamblan, se env√≠an a QueueRunner y se ejecutan pruebas de extremo a extremo. Despu√©s de eso, los resultados de las pruebas en ejecuci√≥n llegan al desarrollador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, existe una alta probabilidad de que despu√©s de la creaci√≥n de la rama de caracter√≠sticas en desarrollo, haya muchas confirmaciones. </font><font style="vertical-align: inherit;">Esto significa que el desarrollo puede no ser lo que sol√≠a ser. </font><font style="vertical-align: inherit;">Por lo tanto, la fusi√≥n previa ocurre primero: fusionamos el desarrollo en la rama de caracter√≠sticas actual, y es en este estado prematuro que construimos, pruebas unitarias, pruebas de componentes, de extremo a extremo, y en base a estos resultados, hacemos un informe. </font><font style="vertical-align: inherit;">Por lo tanto, entendemos cu√°n funcional es la caracter√≠stica en la versi√≥n actual de desarrollo y, si todo est√° bien, se env√≠a a los usuarios.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ven los informes de Stash: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nuestro bot primero escribe que las pruebas han comenzado, y cuando pasan, actualiza el mensaje y agrega cu√°ntos han pasado, cu√°ntos han ca√≠do, cu√°ntos errores conocidos y cu√°ntas pruebas escamosas. Escribe lo mismo en Jira y agrega un enlace a una comparaci√≥n de lanzamientos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve la comparaci√≥n de los dos lanzamientos: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aqu√≠ se compara la ejecuci√≥n actual en la rama de caracter√≠sticas con la √∫ltima ejecuci√≥n en el desarrollo. Contiene informaci√≥n sobre el n√∫mero de pruebas ejecutadas, problemas de coincidencia, pruebas descartadas y pruebas inestables de Flaky que estaban en un estado y cambiaron a otro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cae al menos una prueba unitaria o m√°s de un umbral de pruebas de extremo a extremo, se bloquear√° la fusi√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender si las pruebas caen de manera estable, comparamos los hash de los rastros de las ca√≠das, antes de que se eliminen preliminarmente los d√≠gitos, solo quedan los n√∫meros de l√≠nea. </font><font style="vertical-align: inherit;">Si los hashes coinciden, entonces esta es la misma ca√≠da, si son diferentes, entonces lo m√°s probable es que las ca√≠das sean diferentes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, implementamos una soluci√≥n estable y tolerante a fallas que se adapta bien a nuestra infraestructura. </font><font style="vertical-align: inherit;">Luego, la infraestructura resultante se adapt√≥ para las pruebas de Android. </font><font style="vertical-align: inherit;">Nos ayud√≥ en esto el Administrador de dispositivos, que nos ayuda a trabajar tanto con dispositivos reales como virtuales, as√≠ como con QueueRunner, que nos ayud√≥ a separar la infraestructura y las pruebas, y no bloquear CI durante la duraci√≥n de las pruebas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parec√≠a el tiempo de prueba de una semana en 2016, de cincuenta minutos o m√°s. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve ahora: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
este gr√°fico muestra las ejecuciones que tuvieron lugar durante 2 horas de un d√≠a h√°bil promedio. </font><font style="vertical-align: inherit;">El tiempo de ejecuci√≥n se redujo a un m√°ximo de 15 minutos, el n√∫mero de carreras aument√≥ notablemente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es497700/index.html">Mitaps semanales en l√≠nea sobre respaldo y DevOps, seguridad y robots desde el 17 de abril</a></li>
<li><a href="../es497702/index.html">Cinco tendencias en el almacenamiento de datos a las que debe prestar atenci√≥n en 2020</a></li>
<li><a href="../es497708/index.html">Te invitamos a una serie de seminarios web de Fujitsu en abril y mayo.</a></li>
<li><a href="../es497714/index.html">C√≥mo proteger procesos y extensiones de kernel en macOS</a></li>
<li><a href="../es497724/index.html">Preparaci√≥n de un servidor para publicar una aplicaci√≥n web en Python</a></li>
<li><a href="../es497728/index.html">Los peligros de "quemar" chips</a></li>
<li><a href="../es497730/index.html">BDD conveniente: SpecFlow + TFS</a></li>
<li><a href="../es497736/index.html">Revisi√≥n de 10 nuevos motores de combusti√≥n interna.</a></li>
<li><a href="../es497738/index.html">Ponte a prueba en Swift: un rompecabezas para los amantes de los rompecabezas</a></li>
<li><a href="../es497740/index.html">Los fabricantes de autom√≥viles admiten que es mucho tiempo antes de que los veh√≠culos no tripulados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>