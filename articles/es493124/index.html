<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⤵️ 🤞🏻 😙 Aprovisionamiento de metal desnudo hágalo usted mismo o preparación automática del servidor desde cero 📵 👞 👽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, soy Denis y una de mis áreas de actividad es el desarrollo de soluciones de infraestructura en X5. Hoy me gustaría compartir con ustedes sobre c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Aprovisionamiento de metal desnudo hágalo usted mismo o preparación automática del servidor desde cero</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/493124/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola, soy Denis y una de mis áreas de actividad es el desarrollo de soluciones de infraestructura en X5. </font><font style="vertical-align: inherit;">Hoy me gustaría compartir con ustedes sobre cómo pueden implementar un sistema automatizado de preparación del servidor basado en herramientas disponibles públicamente. </font><font style="vertical-align: inherit;">En mi opinión, esta es una solución interesante, simple y flexible.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/aj/wx/csajwx5dsd-sdlngyst-pfrollu.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por preparación se entiende: hacer desde un nuevo servidor listo para usar, un servidor totalmente configurado con SO </font><font style="vertical-align: inherit;">Linux o con el hipervisor ESXi (la conversión del servidor de Windows no se trata en este artículo). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Términos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidores: servidores que deben configurarse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidor de instalación: el servidor principal que proporciona todo el proceso de preparación a través de la red.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué necesitas automatización?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que hay un problema: preparar en masa el servidor desde cero, en el pico: 30 por día. </font><font style="vertical-align: inherit;">Servidores de diferentes fabricantes y modelos, se pueden instalar diferentes sistemas operativos en ellos, un hipervisor puede o no existir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qué operaciones se incluyen en el proceso de configuración (sin automatización):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conecte el teclado, el mouse, el monitor al servidor;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurar BIOS, RAID, IPMI;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualizar el firmware del componente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementar una imagen del sistema de archivos (o instalar un hipervisor y copiar máquinas virtuales);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota. </font><font style="vertical-align: inherit;">Alternativamente, es posible implementar el sistema operativo a través de la instalación con un archivo de respuesta automática. </font><font style="vertical-align: inherit;">Pero esto no se discutirá en el artículo. </font><font style="vertical-align: inherit;">Aunque verá a continuación que agregar esta funcionalidad es fácil.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurar los parámetros del sistema operativo (nombre de host, IP, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con este enfoque, la misma configuración se realiza secuencialmente en cada servidor. </font><font style="vertical-align: inherit;">La efectividad de tal trabajo es muy baja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La esencia de la automatización es excluir la participación humana del proceso de preparación del servidor. </font><font style="vertical-align: inherit;">Cuanto más se pueda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a la automatización, el tiempo de inactividad entre operaciones se reduce y se hace posible preparar varios servidores al mismo tiempo. </font><font style="vertical-align: inherit;">La probabilidad de errores debidos al factor humano también se reduce considerablemente.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g7/ic/x1/g7icx1q3tb0yanpntf9jmw8n4p4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo se configuran los servidores automáticamente?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analizaremos todos los pasos en detalle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tiene un servidor Linux que utiliza como servidor de instalación PXE. </font><font style="vertical-align: inherit;">Los servicios están instalados y configurados en él: DHCP, TFTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, cargamos el servidor (que necesita ser configurado) por PXE. </font><font style="vertical-align: inherit;">Recordemos cómo funciona:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servidor seleccionado para arrancar a través de la red.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servidor carga el PXE-ROM de la tarjeta de red y se pone en contacto con el servidor de instalación a través de DHCP para obtener la dirección de red.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El DHCP del servidor de instalación proporciona la dirección, así como las instrucciones para su posterior descarga a través de PXE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servidor descarga el gestor de arranque de red desde el servidor de instalación a través de PXE; la descarga adicional se realiza de acuerdo con el archivo de configuración de PXE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La descarga se realiza en función de los parámetros recibidos (kernel, initramfs, puntos de montaje, imagen de squashfs, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota. </font><font style="vertical-align: inherit;">Este artículo describe el arranque PXE a través del modo BIOS. </font><font style="vertical-align: inherit;">Actualmente, los fabricantes están introduciendo activamente el modo de arranque UEFI. </font><font style="vertical-align: inherit;">Para PXE, la diferencia estará en la configuración del servidor DHCP y la presencia de un gestor de arranque adicional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere un ejemplo de configuración del servidor PXE (menú pxelinux). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Archivo pxelinux.cfg / default:</font></font><br>
<br>
<pre><code class="plaintext hljs">default menu.c32<font></font>
prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
LABEL InstallServer Menu<font></font>
	MENU LABEL InstallServer<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/installserver<font></font>
LABEL VMware Menu<font></font>
	MENU LABEL VMware ESXi Install<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/vmware<font></font>
LABEL toolkit //   <font></font>
	MENU LABEL Linux Scripting Toolkits<font></font>
	MENU default<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/toolkit //    </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Archivo pxelinux.cfg / toolkit:</font></font><br>
<br>
<pre><code class="plaintext hljs">prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
label mainmenu<font></font>
    menu label ^Return to Main Menu<font></font>
    kernel menu.c32<font></font>
    append pxelinux.cfg/default<font></font>
label x5toolkit-auto //   —  <font></font>
        menu label x5 toolkit autoinstall<font></font>
        menu default<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tk-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=master-install.sh CMDIS2=”…”<font></font>
label x5toolkit-shell //   - <font></font>
        menu label x5 toolkit shell<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tkcustom-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=/bin/bash CMDIS2=”…”</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El kernel y initramfs en esta etapa son una imagen de Linux intermedia, con la ayuda de la cual se llevará a cabo la preparación básica y la configuración del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, el gestor de arranque pasa muchos parámetros al núcleo. </font><font style="vertical-align: inherit;">Algunos de estos parámetros son utilizados por el núcleo mismo. </font><font style="vertical-align: inherit;">Y podemos usar algunos para nuestros propios fines. </font><font style="vertical-align: inherit;">Esto se describirá más adelante, pero por ahora puede recordar que todos los parámetros pasados ​​estarán disponibles en la imagen de Linux intermedia a través de / proc / cmdline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Dónde conseguirlos, el kernel y initramfs? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como base, puede elegir cualquier distribución de Linux. </font><font style="vertical-align: inherit;">A qué prestamos atención al elegir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la imagen de arranque debe ser universal (controladores disponibles, la capacidad de instalar utilidades adicionales);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muy probablemente, initramfs necesitará ser personalizado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Cómo se hace esto en nuestra solución para X5? Elegimos CentOS 7 como base. Hagamos el siguiente truco: preparar la estructura de la imagen futura, empaquetarla en el archivo y crear initramfs, dentro de la cual estará nuestro archivo del sistema de archivos. Al cargar la imagen, el archivo se desplegará en la sección tmpfs creada. Por lo tanto, obtenemos una imagen live-linux mínima pero completa con todas las utilidades necesarias, que consta de solo dos archivos: vmkernel e initramfs.</font></font><br>
<br>
<pre><code class="plaintext hljs"># : <font></font>
<font></font>
mkdir -p /tftpboot/toolkit/CustomTK/rootfs /tftpboot/toolkit/CustomTK/initramfs/bin<font></font>
<font></font>
# :<font></font>
<font></font>
yum groups -y install "Minimal Install" --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y install nfs-utils mariadb ntpdate mtools syslinux mdadm tbb libgomp efibootmgr dosfstools net-tools pciutils openssl make ipmitool OpenIPMI-modalias rng-tools --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y remove biosdevname --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
<font></font>
#  initramfs:<font></font>
<font></font>
wget https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-x86_64 -O /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
chmod a+x /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
cp /tftpboot/toolkit/CustomTK/rootfs/boot/vmlinuz-3.10.0-957.el7.x86_64 /tftpboot/toolkit/tkcustom-kernel<font></font>
<font></font>
#  /tftpboot/toolkit/CustomTK/initramfs/init (  ):<font></font>
<font></font>
#!/bin/busybox sh<font></font>
/bin/busybox --install /bin<font></font>
mkdir -p /dev /proc /sys /var/run /newroot<font></font>
mount -t proc proc /proc<font></font>
mount -o mode=0755 -t devtmpfs devtmpfs /dev<font></font>
mkdir -p /dev/pts /dev/shm /dev/mapper /dev/vc<font></font>
mount -t devpts -o gid=5,mode=620 devpts /dev/pts<font></font>
mount -t sysfs sysfs /sys<font></font>
mount -t tmpfs -o size=4000m tmpfs /newroot<font></font>
echo -n "Extracting rootfs... "<font></font>
xz -d -c -f rootfs.tar.xz | tar -x -f - -C /newroot<font></font>
echo "done"<font></font>
mkdir -p /newroot/dev /newroot/proc /newroot/sys<font></font>
mount --move /sys  /newroot/sys<font></font>
mount --move /proc /newroot/proc<font></font>
mount --move /dev  /newroot/dev<font></font>
exec switch_root /newroot /sbin/init<font></font>
<font></font>
#  rootfs  initramfs:<font></font>
<font></font>
cd /tftpboot/toolkit/CustomTK/rootfs<font></font>
tar cJf /tftpboot/toolkit/CustomTK/initramfs/rootfs.tar.xz --exclude ./proc --exclude ./sys --exclude ./dev .<font></font>
cd /tftpboot/toolkit/CustomTK/initramfs<font></font>
find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; /tftpboot/toolkit/tkcustom-initramfs-new.gz</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hemos especificado un kernel e initramfs que deben cargarse. </font><font style="vertical-align: inherit;">Como resultado, en esta etapa, descargando la imagen intermedia de Linux a través de PXE, obtenemos la consola del sistema operativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Genial, pero ahora necesitamos transferir el control a nuestra "automatización". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede hacer así. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que, después de cargar la imagen, planeamos transferir el control al script mount.sh. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluimos el script mount.sh en ejecución automática. </font><font style="vertical-align: inherit;">Para hacer esto, necesita modificar initramfs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descomprimir initramfs (si usamos la versión anterior de initramfs, esto no es obligatorio)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incluir en el código de inicio que analizará los parámetros pasados ​​a través de / proc / cmdline y continuará transfiriendo el control;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquete initramfs.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota. En el caso del kit de herramientas X5, el control de arranque se transfiere al script </font></font><code>/opt/x5/toolkit/bin/hook.sh   override.conf  getty tty1 (ExecStart=…) </code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
, por lo que se carga la imagen, en la que el script mount.sh comienza al inicio. A continuación, el script mount.sh en el proceso de análisis analiza los parámetros pasados ​​(script_cmd =) y lanza el programa / script necesario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = master-install.sh</font></font><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = / bin / bash</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/w9/xc/8b/w9xc8b87fob_jooqjazqiyyiccm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aquí en el lado izquierdo está el menú PXE , a la derecha está el esquema de transferencia de control.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la transferencia de control, lo descubrimos. </font><font style="vertical-align: inherit;">Dependiendo de la elección del menú PXE, se inicia el script de autoajuste o la consola de depuración. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso de la configuración automática, se montan los directorios necesarios del servidor de instalación, en los que hay:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guiones;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plantillas BIOS / UEFI guardadas de varios servidores;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firmware;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilidades para servidores;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">troncos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación, el script mount.sh transfiere el control al script master-install.sh desde el directorio de scripts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El árbol de guiones (el orden de su lanzamiento) se ve más o menos así:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instalación maestra</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciones compartidas (funciones comunes)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">info (salida de información)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modelos (configuración de parámetros de instalación basados ​​en el modelo del servidor)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepare_utils (instalando las utilidades necesarias)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwupdate (actualización de firmware)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diag (diagnóstico elemental)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biosconf (configuración BIOS / UEFI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clockfix (establecer la hora en la placa base)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">srmconf (configuración de la interfaz remota)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raidconf (configuración de volúmenes lógicos)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
uno de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinstalación (transferencia de control al instalador del sistema operativo o hipervisor, por ejemplo ESXi)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instalación combinada (inicio directo de desempaquetar la imagen)</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora sabemos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cómo arrancar el servidor a través de PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cómo transferir el control a tu propio script.</font></font></li>
</ul></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuemos. </font><font style="vertical-align: inherit;">Los siguientes problemas se han vuelto relevantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo identificar el servidor que estamos preparando?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué utilidades y cómo configurar el servidor?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo obtener la configuración de un servidor específico?</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo identificar el servidor que estamos preparando?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es simple - DMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">dmidecode –s system-product-name<font></font>
dmidecode –s system-manufacturer<font></font>
dmidecode –s system-serial-number</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tiene todo lo que necesita: un proveedor, un modelo, un número de serie. </font><font style="vertical-align: inherit;">Si no está seguro de que esta información se presente en todos los servidores, puede identificarlos por dirección MAC. </font><font style="vertical-align: inherit;">O de ambas maneras al mismo tiempo si los proveedores de servidores son diferentes y en algunos modelos la información del número de serie simplemente no está disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Según la información recibida, se montan las carpetas de red del servidor de instalación y se carga todo lo necesario (utilidades, firmware, etc.).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué utilidades y cómo configurar el servidor?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daré utilidades para Linux para algunos fabricantes. </font><font style="vertical-align: inherit;">Todas las utilidades están disponibles en los sitios web oficiales de los proveedores. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xx/xh/3f/xxxh3f0pg48elgtr8qn9r_wjp4q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el firmware, creo que todo está claro. </font><font style="vertical-align: inherit;">Por lo general, vienen en ejecutables empaquetados. </font><font style="vertical-align: inherit;">El archivo ejecutable controla el proceso de actualización del firmware e informa un código de retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El BIOS y el IPMI generalmente se configuran a través de plantillas. </font><font style="vertical-align: inherit;">Si es necesario, la plantilla se puede editar antes de cargar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las utilidades RAID para algunos proveedores también pueden configurarse de acuerdo con la plantilla. </font><font style="vertical-align: inherit;">Si este no es el caso, tendrá que escribir un script de configuración. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El procedimiento para configurar RAID suele ser el siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitamos la configuración actual.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si ya hay arreglos lógicos, lo borramos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observamos qué discos físicos están presentes y cuántos de ellos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crea una nueva matriz lógica. </font><font style="vertical-align: inherit;">Interrumpimos el proceso en caso de error.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo obtener la configuración de un servidor específico?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que todas las configuraciones del servidor se almacenan en el servidor de instalación. </font><font style="vertical-align: inherit;">En este caso, para responder a nuestra pregunta, primero debe decidir: cómo transferir la configuración al servidor de instalación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, es bastante posible hacerlo con archivos de texto. </font><font style="vertical-align: inherit;">(En el futuro, puede usar un archivo de texto como una forma de respaldo para transferir la configuración). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede "compartir" un archivo de texto en el servidor de instalación. </font><font style="vertical-align: inherit;">Y agréguelo al script mount.sh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las líneas, por ejemplo, se verán así: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;número de serie&gt; &lt;nombre del host&gt; &lt;subred&gt; El </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ingeniero transferirá estas líneas al archivo desde su máquina de trabajo. </font><font style="vertical-align: inherit;">Y luego, al configurar el servidor, los parámetros para un servidor específico se leerán del archivo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, en el futuro, es mejor usar la base de datos para almacenar la configuración, los estados y los registros de instalación del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, una base de datos no puede funcionar, y tendrá que crear una parte del cliente, con la ayuda de la cual se transferirá la configuración a la base de datos. Esto es más difícil de implementar que un archivo de texto, pero en realidad no es tan difícil como parece. La versión mínima del cliente, que simplemente transferirá datos a la base de datos, es bastante factible de escribir usted mismo. En el futuro, será posible mejorar el programa del cliente también en modo libre (informes, impresión de etiquetas, envío de notificaciones, etc., lo que se le ocurra). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de realizar una solicitud específica a la base de datos e indicar el número de serie del servidor, obtenemos los parámetros necesarios para configurar el servidor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, no necesitamos inventar bloqueos para acceso simultáneo, como es el caso de un archivo de texto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos escribir el registro de configuración en todas las etapas de la base de datos y controlar el proceso de instalación a través de eventos y marcas de las etapas de preparación. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora sabemos cómo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cargar el servidor a través de PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transferir el control a nuestro script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificar el servidor que se preparará por número de serie;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurar el servidor con las utilidades apropiadas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transferir configuraciones a la base de datos del servidor de instalación utilizando la parte del cliente.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descubrí cómo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el servidor instalado recibe la configuración necesaria de la base de datos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo el progreso de la preparación se registra en la base de datos (registros, eventos, indicadores de etapa).</font></font></li>
</ul></b><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué pasa con los diferentes tipos de software que se instalan? </font><font style="vertical-align: inherit;">¿Cómo instalar un hipervisor, copiar una VM y configurar todo esto?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso de implementar una imagen del sistema de archivos (linux) en el hardware, todo es bastante simple:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Después de configurar todos los componentes del servidor, implemente la imagen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instale el gestor de arranque grub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacemos chroot y configuramos todo lo necesario.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo transferir el control al instalador del sistema operativo (usando ESXi como ejemplo).</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizamos la transferencia de control de nuestro script al instalador del hipervisor utilizando el archivo de respuesta automática (kickstart):</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eliminar las particiones actuales en el disco.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crea una partición de 500 MB.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo marcamos como arranque.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formatear en FAT32.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiamos los archivos de instalación de ESXi a la raíz.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalar syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copie syslinux.cfg a / syslinux /</font></font></li>
</ul><br>
<pre><code class="plaintext hljs">default esxi<font></font>
prompt 1<font></font>
timeout 50<font></font>
label esxi<font></font>
kernel mboot.c32<font></font>
append -c boot.cfg</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copie mboot.c32 a / syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En boot.cfg debe haber kernelopt = ks = ftp: // &lt;IP del servidor de instalación&gt; /ks_esxi.cfg</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reinicia el servidor.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de reiniciar el servidor, el instalador de ESXi se iniciará desde su disco duro. </font><font style="vertical-align: inherit;">Todos los archivos de instalación necesarios se cargarán en la memoria y comenzará la instalación de ESXi, de acuerdo con el archivo de respuesta automática especificado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí hay algunas líneas del archivo de respuesta automática ks_esxi.cfg:</font></font><br>
<br>
<pre><code class="plaintext hljs">%firstboot --interpreter=busybox<font></font>
…<font></font>
#   <font></font>
<font></font>
SYSSN=$(esxcli hardware platform get | grep Serial | awk -F " " '{print $3}')<font></font>
<font></font>
#  IP<font></font>
<font></font>
IPADDRT=$(esxcli network ip interface ipv4 get | grep vmk0 | awk -F " " '{print $2}')<font></font>
LAST_OCTET=$(echo $IPADDRT | awk -F'.' '{print $4}')<font></font>
<font></font>
#  NFS -<font></font>
<font></font>
esxcli storage nfs add -H is -s /srv/nfs_share -v nfsshare1<font></font>
<font></font>
#    ssh,   ssh-<font></font>
<font></font>
mv /etc/ssh /etc/ssh.tmp<font></font>
cp -R /vmfs/volumes/nfsshare1/ssh /etc/<font></font>
chmod go-r /etc/ssh/ssh_host_rsa_key<font></font>
<font></font>
#  ovftool,    ,    <font></font>
<font></font>
cp -R /vmfs/volumes/nfsshare1/ovftool /vmfs/volumes/datastore1/<font></font>
<font></font>
#  <font></font>
<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM1 /vmfs/volumes/nfsshare1/VM_T/VM1.ova vi://root:esxi_password@127.0.0.1<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM2 /vmfs/volumes/nfsshare1/VM_T/VM2.ova vi://root:esxi_password@127.0.0.1<font></font>
<font></font>
#      <font></font>
<font></font>
ssh root@is "mysql -h'192.168.0.1' -D'servers' -u'user' -p'secretpassword' -e \"SELECT ... WHERE servers.serial='$SYSSN'\"" | grep -v ^$ | sed 's/NULL//g' &gt; /tmp/servers<font></font>
...<font></font>
#    <font></font>
<font></font>
echo '#!/bin/sh' &gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip interface ipv4 set -i=vmk0 -t=static --ipv4=$IPADDR --netmask=$S_SUB || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip route ipv4 add -g=$S_GW -n=default || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
chmod a+x /vmfs/volumes/datastore1/netconf.sh<font></font>
<font></font>
#   guestinfo.esxihost.id,     <font></font>
<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM1/VM1.vmx<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM2/VM2.vmx<font></font>
...<font></font>
#    <font></font>
<font></font>
SYSNAME=$(esxcli hardware platform get | grep Product | sed 's/Product Name://' | sed 's/^\ *//')<font></font>
UUID=$(vim-cmd hostsvc/hostsummary | grep uuid | sed 's/\ //g;s/,$//' | sed 's/^uuid="//;s/"$//')<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"UPDATE servers ... SET ... WHERE servers.serial='$SYSSN'\""<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"INSERT INTO events ...\""<font></font>
<font></font>
#   SSH<font></font>
<font></font>
rm -rf /etc/ssh<font></font>
mv /etc/ssh.tmp /etc/ssh<font></font>
<font></font>
#    <font></font>
<font></font>
esxcli system hostname set --fqdn=esx-${G_NICK}.x5.ru<font></font>
/vmfs/volumes/datastore1/netconf.sh<font></font>
reboot<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta etapa, se instala y configura un hipervisor, se copian las máquinas virtuales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Cómo configurar máquinas virtuales ahora? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hicimos trampa un poco: durante la instalación configuramos el parámetro guestinfo.esxihost.id = "$ SYSSN" en el archivo VM1.vmx, indicando el número de serie del servidor físico en él. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, después de comenzar, la máquina virtual (con el paquete vmware-tools instalado) puede acceder a este parámetro:</font></font><br>
<br>
<pre><code class="plaintext hljs">ESXI_SN=$(vmtoolsd --cmd "info-get guestinfo.esxihost.id")</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, la VM podrá identificarse (conoce el número de serie del host físico), realizar una solicitud a la base de datos del servidor de instalación y obtener los parámetros que deben configurarse. </font><font style="vertical-align: inherit;">Todo esto se ejecuta en un script que debe iniciarse automáticamente cuando se inicia guestos vm (pero una vez: RunOnce). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora sabemos cómo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cargar el servidor a través de PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transferir el control a nuestro script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificar el servidor que se preparará por número de serie;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurar el servidor con las utilidades apropiadas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transferir configuraciones a la base de datos del servidor de instalación utilizando la parte del cliente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure varios tipos de PO, incluida la implementación del hipervisor esxi y la configuración de máquinas virtuales (y todo de forma automática).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descubrí cómo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el servidor instalado recibe la configuración necesaria de la base de datos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo el progreso de la preparación se registra en la base de datos (registros, eventos, indicadores de etapa).</font></font></li>
</ul></b><br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En pocas palabras:</font></font></b></u><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
creo que la singularidad de esta solución radica en su flexibilidad, simplicidad, sus capacidades y versatilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por favor escribe en los comentarios lo que piensas.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es493112/index.html">Cómo comenzar un nuevo negocio en 6 meses en lugar de 3 años</a></li>
<li><a href="../es493114/index.html">Cómo el ingeniero de datos observó los datos</a></li>
<li><a href="../es493116/index.html">"¡Más interactividad!" o ¿Cómo fue TeamLead Conf 2020?</a></li>
<li><a href="../es493118/index.html">Descripción general de la extensión de etiquetado de memoria (Armv8.5-A)</a></li>
<li><a href="../es493122/index.html">Oficina de Banzai Games: Japón en el centro de Moscú</a></li>
<li><a href="../es493126/index.html">Antipatrones de arquitectura orientada a eventos</a></li>
<li><a href="../es493130/index.html">Почему не стоит бояться коронавируса: мифы и почти правда о COVID-2019</a></li>
<li><a href="../es493132/index.html">Alrededor de data.table</a></li>
<li><a href="../es493136/index.html">FAST VP en Unity Storage: cómo funciona</a></li>
<li><a href="../es493138/index.html">Háblame: qué pueden hacer los bots de voz hoy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>