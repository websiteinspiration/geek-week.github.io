<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöë ü•î üôã ProxySQL - a tool for demultiplexing connections üëâüèΩ ü§∂üèø üë®üèΩ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Alexander Yakovlev, I work for Citimobil and operate. Today I will tell you about a very interesting ProxySQL product - it is a high...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ProxySQL - a tool for demultiplexing connections</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/501730/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, my name is Alexander Yakovlev, I work for Citimobil and operate. </font><font style="vertical-align: inherit;">Today I will tell you about a very interesting ProxySQL product - it is a high-performance MySQL Proxy that can do a lot of things - catch and kill requests by mask, with it you can search for sql injection, duplicate the load and much more. </font><font style="vertical-align: inherit;">I will talk about our experience with him.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sooner or later, any large IT project, the development of which began with a pair of servers, will encounter the situation described below. Imagine that the project initially had only one database - the master server. Gradually, a bunch of slaves were added to it. Then they introduced sharding. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And one fine day, the load suddenly increases 10 times. For example, because your main competitor has fallen, and customers have rushed to you. At this point, it seems to you that you can simply scale the load by adding web servers. But after you have done this, an unpleasant situation arises.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the example of one wizard. Let's say you have 50 web servers and on every 200 php-fpm processes. Then 50 * 200 connections will arrive at the master, and at that 50 * 200 / number of slaves will come to each slave (if, of course, roundrobin is configured in haproxy) - see the picture below. Of course, 10 thousand connections to the master is a lot, but still bearable, and if there are 200 web sites, the number of connections will be even more, and one connection = one thread. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was in this bottleneck that we ran into. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7b2/bb3/e2b/7b2bb3e2b3ff265076397aece6d0da81.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we began to argue: the connection to the wizard is always installed in the code, but is it necessary for all fpm processes? Probably not. We noticed that a large number of persist-connections to the master simply hang in slips. And they decided that we need demultiplexing.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/df8/8e7/595/df88e75958437543e14e00a08603a7b8.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we drew attention to a product called ProxySQL. It works like a normal reverse proxy: connections are established to it, and it redistributes traffic according to certain rules specified in the configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We installed ProxySQL on all of our web servers, and in the application configuration we specified that the call to the master database is performed at the address 127.0.0.1. If before 200 FPM workers on each web server meant 200 connections to the master base from this machine, now the situation has changed. These 200 connections come in ProxySQL, and 50-70 go out at different times. That is, ProxySQL can reuse existing connections.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to demultiplexing, we reduced the number of connections by 3-10 times on all masters, see the current connections graph of one of the masters below. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/87b/285/e02/87b285e02729e752ccf931994d4253e6.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to ProxySQL, we got rid of the above bottleneck. But this is not the only workflow that we have improved with this tool. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have not yet completed the second process, but are very close to completion. Using ProxySQL, we plan to duplicate the real load in the test environment. This is necessary to check new features with combat traffic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How will this be implemented? The application goes to ProxySQL, and it sends traffic along two routes: to the battle databases for the application to function, and to the test environment to check for new features under load.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The feature of ProxySQL is that there is its config, which in our case is rolled out through puppet (for puppet there is a ProxySQL module), but there is also the concept of the runtime zone, in order to make a change (add server, add user, delete server and user ), you do not need the usual restart / reload., Everything is done through the ProxySQL console, for example like this.</font></font><br>
<br>
<pre><code class="plaintext hljs">mysql -ulogin -ppassword -h 127.0.0.1 -P6032 -e "INSERT INTO mysql_users(username,password,default_hostgroup) VALUES ('sm_username','pass',1);;LOAD MYSQL USERS TO RUNTIME;SAVE MYSQL USERS TO DISK;"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In more detail, of course, in the official documentation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proxysql.com/documentation</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Thank you for your attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our config, with which we solved the problem described above, see below. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our config</font></font><br>
<br>
<pre><code class="plaintext hljs">datadir="/var/lib/proxysql"<font></font>
<font></font>
admin_variables=<font></font>
{<font></font>
    admin_credentials="user:pass"<font></font>
    mysql_ifaces="0.0.0.0:6032"<font></font>
    refresh_interval=2000<font></font>
    web_enabled=true<font></font>
    web_port=6080<font></font>
    stats_credentials="stats:admin"<font></font>
}<font></font>
<font></font>
mysql_variables =<font></font>
{<font></font>
    threads = 1000<font></font>
    max_connections = 2000<font></font>
    default_query_delay= 0<font></font>
    default_query_timeout=1<font></font>
    have_compress=true<font></font>
    poll_timeout=2000<font></font>
    interfaces="0.0.0.0:6033;/tmp/proxysql.sock"<font></font>
    default_schema="information_schema"<font></font>
    stacksize=1048576<font></font>
    server_version="5.7.22"<font></font>
    connect_timeout_server=10000<font></font>
    monitor_history=60000<font></font>
    monitor_connect_interval=200000<font></font>
    monitor_ping_interval=200000<font></font>
    ping_interval_server_msec=5000<font></font>
    ping_timeout_server=200<font></font>
    commands_stats=true<font></font>
    sessions_sort=true<font></font>
    monitor_username="root"<font></font>
    monitor_password="password"<font></font>
    monitor_galera_healthcheck_interval=200<font></font>
    monitor_galera_healthcheck_timeout=80<font></font>
}<font></font>
<font></font>
mysql_servers =<font></font>
(<font></font>
  {<font></font>
    address = "ip_real_mysql_server",<font></font>
    port = 3306,<font></font>
    max_connections = 10000,<font></font>
    host_group = 1,<font></font>
  })<font></font>
mysql_users =<font></font>
(<font></font>
  {<font></font>
    username = "user",<font></font>
    password = "pass",<font></font>
    default_hostgroup = 1,<font></font>
    transaction_persistent = 0,<font></font>
    active = 1,<font></font>
  })<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501712/index.html">Talking about tests: some stories and a survey</a></li>
<li><a href="../en501714/index.html">School 42 as the main answer to IT life, the programming universe and all that</a></li>
<li><a href="../en501716/index.html">Challenge accepted or what tasks do Lamoda engineers solve</a></li>
<li><a href="../en501722/index.html">Comet - PHP framework for fast REST APIs</a></li>
<li><a href="../en501724/index.html">Working with cookies in pure JavaScript without a headache</a></li>
<li><a href="../en501734/index.html">[Geektimes-style] Our tech future: predictions from experts</a></li>
<li><a href="../en501736/index.html">How we switched to udalenka six months ago due to chopped optics</a></li>
<li><a href="../en501738/index.html">May 13th Java Digest</a></li>
<li><a href="../en501742/index.html">Transport on May 13: uiiii, we took the second place in terms of the number of patients, it‚Äôs time to remove the restrictions</a></li>
<li><a href="../en501744/index.html">The designer is not the one who paints beautifully, this is the one who helps the business understand the user</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>