<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚢 🧗 🤲🏿 WAL-G: Pencadangan dan Pemulihan Basis Data PostgreSQL 👩🏾‍✈️ 🛕 💈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sudah lama diketahui bahwa membuat cadangan di SQL dumps (menggunakan pg_dump atau pg_dumpall ) bukan ide yang baik. Untuk mencadangkan PostgreSQL, le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: Pencadangan dan Pemulihan Basis Data PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sudah lama diketahui bahwa membuat cadangan di SQL dumps (menggunakan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atau </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) bukan ide yang baik. Untuk mencadangkan PostgreSQL, lebih baik menggunakan perintah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang membuat salinan biner dari log WAL. Tetapi ketika Anda mulai mempelajari seluruh proses menciptakan cadangan dan pemulihan, Anda akan memahami bahwa Anda perlu menulis setidaknya beberapa becak agar semua ini berhasil dan tidak menyebabkan Anda sakit baik dari atas maupun dari bawah. Untuk mengurangi penderitaan, WAL-G dikembangkan. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah alat yang ditulis dalam Go untuk mencadangkan dan memulihkan database PostgreSQL ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan yang lebih baru, MySQL / MariaDB, MongoDB, dan FoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Ini mendukung bekerja dengan penyimpanan Amazon S3 (dan analog, misalnya, Yandex Object Storage), serta Google Cloud Storage, Azure Storage, Swift Object Storage, dan hanya dengan sistem file. </font><font style="vertical-align: inherit;">Seluruh pengaturan direduksi menjadi langkah-langkah sederhana, tetapi karena fakta bahwa artikel tentang itu tersebar di Internet, tidak ada manual cara-lengkap yang akan mencakup semua langkah dari dan ke (ada beberapa posting di Habré, tetapi banyak poin yang hilang di sana).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="backup postgresql"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel ini ditulis terutama untuk mensistematisasikan pengetahuan Anda. </font><font style="vertical-align: inherit;">Saya bukan seorang DBA dan dapat diekspresikan dalam bahasa pengembangan filistin di suatu tempat, jadi koreksi apa pun dipersilahkan! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara terpisah, saya perhatikan bahwa semua yang berikut ini relevan dan diverifikasi untuk PostgreSQL 12.3 di Ubuntu 18.04, semua perintah harus dieksekusi sebagai pengguna istimewa.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat penulisan ini, versi stabil WAL-G adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v0.2.15 (Maret 2020)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kami akan menggunakannya ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tetapi jika Anda ingin membuatnya sendiri dari cabang master, maka repositori github memiliki semua instruksi untuk ini</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Untuk mengunduh dan menginstal yang perlu Anda lakukan:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah itu, Anda harus mengkonfigurasi WAL-G, dan kemudian PostgreSQL.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan WAL-G</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai contoh penyimpanan cadangan, Amazon S3 akan digunakan ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">karena lebih dekat ke server saya dan penggunaannya sangat murah</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Untuk mengatasinya, Anda memerlukan "ember s3" dan kunci akses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua artikel sebelumnya tentang WAL-G menggunakan konfigurasi menggunakan variabel lingkungan, tetapi dari rilis ini pengaturan dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file .walg.json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di direktori home pengguna postgres. </font><font style="vertical-align: inherit;">Untuk membuatnya, jalankan skrip bash berikut:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan menjelaskan sedikit dalam semua hal:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - jalur ke S3-bucket tempat cadangan akan dituangkan (Anda dapat keduanya di root dan di folder);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> –    S3 (<i>      –     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> –     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> –  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> –  «»     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - jalur ke direktori dengan data basis data Anda ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat mengetahuinya dengan menjalankan perintah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - koneksi ke database, dengan cadangan lokal lebih baik melakukannya melalui unix-socket, seperti dalam contoh ini.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter lain dapat ditemukan dalam dokumentasi: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penyiapan postgreSQL</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agar pengarsip di dalam database mengunggah log WAL ke cloud dan memulihkannya (jika perlu), Anda perlu mengatur beberapa parameter dalam file konfigurasi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hanya untuk memulai, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda perlu memastikan</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bahwa tidak ada pengaturan di bawah ini yang diatur ke nilai lain, sehingga ketika Anda me-restart konfigurasi, DBMS tidak jatuh. </font><font style="vertical-align: inherit;">Anda dapat menambahkan parameter ini menggunakan:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> “archive_timeout=60” &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deskripsi parameter yang akan ditetapkan:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - berapa banyak informasi yang harus ditulis ke majalah WAL, "replika" - untuk menulis semuanya;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aktifkan pengunduhan log WAL menggunakan perintah dari parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - perintah untuk mengarsipkan log WAL yang lengkap;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pengarsipan log dilakukan hanya ketika selesai, tetapi jika server Anda sedikit mengubah / menambahkan data ke database, masuk akal untuk menetapkan batas dalam hitungan detik di sini, setelah itu perintah pengarsipan akan dipaksa ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saya harus menulis intensif ke database setiap detik, oleh karena itu Saya menolak untuk mengatur parameter ini dalam produksi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - perintah untuk mengembalikan log WAL dari cadangan; itu akan digunakan jika perubahan database terakhir tidak ada dalam "full backup" (cadangan dasar).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat membaca lebih lanjut tentang semua parameter ini dalam terjemahan dokumentasi resmi: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyiapkan jadwal cadangan</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suka atau tidak, tetapi cron adalah cara paling nyaman untuk memulai. </font><font style="vertical-align: inherit;">Inilah yang akan kami konfigurasikan untuk membuat cadangan. </font><font style="vertical-align: inherit;">Mari kita mulai dengan perintah untuk membuat cadangan penuh: di wal-g, ini adalah argumen untuk menjalankan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tapi pertama-tama, lebih baik untuk mengeksekusi perintah ini secara manual dari pengguna postgres untuk memastikan semuanya baik-baik saja (dan tidak ada kesalahan akses):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argumen awal menunjukkan jalur ke direktori data - saya mengingatkan Anda bahwa Anda dapat mengenalinya dengan menjalankan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika semuanya berjalan lancar dan data diunggah ke repositori S3, maka Anda dapat mengonfigurasi peluncuran berkala di crontab:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam contoh ini, proses pencadangan dimulai setiap hari pada pukul 4:15 pagi.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hapus cadangan lama</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemungkinan besar, Anda tidak perlu menyimpan sepenuhnya semua cadangan dari era Mesozoikum, sehingga akan berguna untuk "membersihkan" penyimpanan Anda secara berkala (baik "cadangan penuh" dan log WAL). </font><font style="vertical-align: inherit;">Kami akan melakukan semuanya juga melalui tugas cron:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron akan melakukan tugas ini setiap hari pada pukul 6:30 pagi, menghapus semuanya (cadangan penuh, delta, dan WAL) kecuali salinan selama 10 hari terakhir, tetapi akan meninggalkan setidaknya satu cadangan </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebelum</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tanggal yang ditentukan sehingga setiap titik </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setelah</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tanggal masuk ke dalam PITR .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pulihkan dari cadangan</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bukan rahasia lagi bahwa jaminan basis yang sehat adalah pemulihan berkala dan verifikasi integritas data di dalamnya. Bagaimana memulihkan menggunakan WAL-G - Saya akan memberi tahu di bagian ini, dan kita akan membicarakan tentang cek nanti. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara terpisah, perlu dicatat</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bahwa untuk pemulihan di lingkungan pengujian (semua yang bukan produksi) - Anda harus menggunakan akun Read Only di S3, agar tidak secara tidak sengaja menimpa cadangan. Dalam kasus WAL-G, Anda perlu mengatur pengguna S3 hak-hak berikut dalam Kebijakan Grup ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Efek: Izinkan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dan, tentu saja, jangan lupa untuk mengatur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di file pengaturan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.conf sebelumnya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehingga basis tes Anda tidak ingin membuat cadangan dengan tenang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemulihan dilakukan dengan sedikit gerakan tangan dengan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penghapusan semua data PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (termasuk pengguna), jadi harap sangat berhati-hati saat Anda menjalankan perintah berikut.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagi mereka yang ingin memeriksa proses pemulihan - sepotong kecil bash-magic disiapkan di bawah ini, sehingga jika terjadi masalah dalam pemulihan - skrip crash dengan kode keluar yang tidak nol. </font><font style="vertical-align: inherit;">Dalam contoh ini, 120 pemeriksaan dilakukan dengan batas waktu 5 detik (hanya 10 menit untuk memulihkan) untuk mengetahui apakah file sinyal telah dihapus (ini berarti pemulihan berhasil):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah pemulihan berhasil, jangan lupa untuk memulai kembali semua proses (pgbouncer / monit, dll.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifikasi data setelah pemulihan</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pastikan untuk memeriksa integritas database setelah pemulihan, sehingga tidak ada situasi dengan cadangan yang terpukul / bengkok. </font><font style="vertical-align: inherit;">Dan lebih baik melakukan ini dengan setiap arsip yang dibuat, tetapi di mana dan bagaimana tergantung pada imajinasi Anda (Anda dapat meningkatkan server individual setiap jam atau menjalankan tes di CI). </font><font style="vertical-align: inherit;">Tapi setidaknya - Anda perlu memeriksa data dan indeks dalam database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memeriksa data, cukup menjalankannya melalui dump, tetapi lebih baik ketika membuat database Anda mengaktifkan checksum ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checksum data</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memeriksa indeks - ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modul amcheck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kami akan mengambil kueri sql untuk itu dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tes WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan membangun sedikit logika di sekitar:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       – )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep’ </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meringkas</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mengucapkan terima kasih kepada Andrei Borodin atas bantuannya dalam menyiapkan publikasi dan terima kasih khusus atas kontribusinya terhadap pengembangan WAL-G! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada catatan ini berakhir. </font><font style="vertical-align: inherit;">Saya harap saya dapat menyampaikan kemudahan pengaturan dan potensi besar untuk menggunakan alat ini di perusahaan Anda. </font><font style="vertical-align: inherit;">Saya mendengar banyak tentang WAL-G, tetapi saya tidak punya cukup waktu untuk duduk dan mencari tahu. </font><font style="vertical-align: inherit;">Dan setelah saya memperkenalkannya di rumah, artikel ini keluar dari saya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara terpisah, perlu dicatat bahwa WAL-G juga dapat bekerja dengan DBMS berikut:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan dilihat dari komitmen - beberapa diharapkan!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id506594/index.html">Redis Praktik Terbaik, Bagian 3</a></li>
<li><a href="../id506598/index.html">Microsoft: Rust является 'лучшим шансом' в отрасли программирования безопасных систем</a></li>
<li><a href="../id506600/index.html">Kontrak untuk pengembangan situs dalam hal manajemen proyek (teori + sampel)</a></li>
<li><a href="../id506604/index.html">Konkurensi dan Efisiensi: Python vs FSM</a></li>
<li><a href="../id506606/index.html">Pencipta clicker PIXI.js</a></li>
<li><a href="../id506612/index.html">Cara meningkatkan kelengkapan kursus online besar-besaran</a></li>
<li><a href="../id506620/index.html">Berpikir kreatif: apa itu, bagaimana mengukur dan meningkatkan potensi Anda</a></li>
<li><a href="../id506624/index.html">Berita FOSS No. 20 - ulasan berita gratis dan sumber terbuka untuk 8-14 Juni 2020</a></li>
<li><a href="../id506626/index.html">Kamailio SBC atau bukan SBC?</a></li>
<li><a href="../id506628/index.html">Intisari materi menarik untuk pengembang seluler # 348 (pada 8-14 Juni)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>