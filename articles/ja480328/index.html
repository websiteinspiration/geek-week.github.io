<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📍 🧝🏻 🧒🏽 PyTorchとC ++の友達を作る方法。TorchScriptの使用 👼🏿 🍊 🧖🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="約1年前、PyTorchの開発者たちは、数行のコードと数回のマウスのクリックを使用してC ++システムに埋め込むことができるPythonのパイプラインから疎外されたソリューションを作成できるツールであるTorchScriptコミュニティを導入しました。以下に、その使用経験を共有し、このパスで遭遇する...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PyTorchとC ++の友達を作る方法。TorchScriptの使用</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ods/blog/480328/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">約1年前、PyTorchの開発者たちは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数行</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のコードと数回のマウスのクリックを使用してC ++システムに埋め込むことができるPythonのパイプラインから疎外されたソリューションを作成できるツールである</font><strong><font style="vertical-align: inherit;">TorchScript</font></strong><font style="vertical-align: inherit;">コミュニティを導入し</font><strong><font style="vertical-align: inherit;">ました</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以下に、その使用経験を共有し、このパスで遭遇する落とし穴について説明します。</font><font style="vertical-align: inherit;">MLの研究は通常Ubuntuで行われますが、最終的な解決策は（突然！）多くの場合「Windows」で必要になるため、Windowsでのプロジェクトの実装には特に注意を払います。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデルとそのモデルを使用するC ++プロジェクトをエクスポートするためのサンプルコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">リポジトリにあります</font></a><font style="vertical-align: inherit;">。</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/3k/u1/ub/3ku1ubmzigl3j016ezncczdonqm.jpeg"></a></p><a name="habracut"></a><br>
<a name="continue"></a><br>
<p> PyTorch  .         PyTorch  ,     ++,    ,      .</p><br>
<p>TorchScript   PyTorch  1.0     .            ,       1.3       :     ,      .     .</p><br>
<p>  TorchScript    (   Python)  - ,        ,   Python  PyTorch,             C++.        DLL    70MB ( Windows)    CPU  300MB  GPU . TorchScript    PyTorch     python.     ,   OpenCV  NumPy,  .  ,     NumPy    PyTorch.</p><br>
<h2 id="konvertiruem-payplayn-na-pytorch-model-na-torchscript">   PyTorch   TorchScript</h2><br>
<p>TorchScript       Python    : tracing  scripting (  ).  ? , , ,     ...</p><br>
<p><img src="https://habrastorage.org/webt/lh/xp/ww/lhxpwwynynljq2_sxj35jhpp9yc.jpeg"></p><br>
<p>               :  .  ,  .       ,   .</p><br>
<p>   .     (   ),        ,  PyTorch        ,       .  —  :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torchvision<font></font>
model = torchvision.models.resnet34(pretrained = <span class="hljs-literal">True</span>)<font></font>
model.eval()<font></font>
sample = torch.rand(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<font></font>
scripted_model = torch.jit.trace(model, sample)</code></pre><br>
<p>      ScriptModule.   </p><br>
<pre><code class="python hljs">scripted_model.save(<span class="hljs-string">'my_script.pth'</span>)</code></pre><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  C++</a> (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)     Python   :</p><br>
<div class="spoiler"><b class="spoiler_title">   Python,   </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">from</span> torchvision.transforms <span class="hljs-keyword">import</span> Compose, ToTensor, Normalize<font></font>
transforms = Compose([ToTensor(), Normalize(mean=[<span class="hljs-number">0.485</span>, <span class="hljs-number">0.456</span>, <span class="hljs-number">0.406</span>], std=[<span class="hljs-number">0.229</span>, <span class="hljs-number">0.224</span>, <span class="hljs-number">0.225</span>])])<font></font>
img = cv2.resize(cv2.imread(<span class="hljs-string">'pics/cat.jpg'</span>), (<span class="hljs-number">224</span>,<span class="hljs-number">224</span>))<font></font>
img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<font></font>
x = transforms(img).unsqueeze(<span class="hljs-number">0</span>) <span class="hljs-comment"># add batch dimension</span><font></font>
<font></font>
scripted_model = torch.jit.load(<span class="hljs-string">'my_script.pth'</span>)<font></font>
y = scripted_model(x)<font></font>
<font></font>
print(y[<span class="hljs-number">0</span>].argmax(), y[<span class="hljs-number">0</span>][y[<span class="hljs-number">0</span>].argmax()])</code></pre><br>
<pre><code class="plaintext hljs">tensor(282) tensor(12.8130, grad_fn=&lt;SelectBackward&gt;)</code></pre></div></div><br>
<p>  <code>ScriptModule</code>   ,    <code>nn.Module</code>.</p><br>
<p>      <code>nn.Module</code>   (      <code>torch._C.Function</code>).</p><br>
<p>  (tracing)   :       ,    .       :        ,     :</p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_abs</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">if</span> x.max() &gt;= <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> x
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> -x<font></font>
my_abs_traced = torch.jit.trace(my_abs, torch.tensor(<span class="hljs-number">0</span>))<font></font>
print(my_abs_traced(torch.tensor(<span class="hljs-number">1</span>)), my_abs_traced(torch.tensor(<span class="hljs-number">-1</span>)))</code></pre><br>
<pre><code class="plaintext hljs">c:\miniconda3\lib\site-packages\ipykernel_launcher.py:2: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs!<font></font>
<font></font>
tensor(1) tensor(-1)</code></pre><br>
<p>! ,   ,    , ? ,          (TracerWarning).      .</p><br>
<p>       — scripting:</p><br>
<pre><code class="python hljs">my_abs_script = torch.jit.script(my_abs)<font></font>
print(my_abs_script(torch.tensor(<span class="hljs-number">1</span>)), my_abs_script(torch.tensor(<span class="hljs-number">-1</span>)))</code></pre><br>
<pre><code class="plaintext hljs">tensor(1) tensor(1)</code></pre><br>
<p>,   ! Scripting     Python       .      <code>ScriptModule</code> ( )  <code>torch._C.Function</code>( ).  ,  , !    :   TorchScript  ,    Python.      ,      — <code>Tensor</code>. , ,   </p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_func</span>(<span class="hljs-params">x</span>):</span>
    y = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> x.max() &gt; <span class="hljs-number">0</span>:<font></font>
        y = x<font></font>
    <span class="hljs-keyword">return</span> y<font></font>
my_func = torch.jit.script(my_func)</code></pre><br>
<p>  .</p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="plaintext hljs">RuntimeError                              Traceback (most recent call last)<font></font>
<font></font>
&lt;ipython-input-9-25414183a687&gt; in &lt;module&gt;()<font></font>
----&gt; 1 my_func = torch.jit.script(my_func)<font></font>
<font></font>
d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb)<font></font>
   1224         if _rcb is None:<font></font>
   1225             _rcb = _gen_rcb(obj, _frames_up)<font></font>
-&gt; 1226         fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj))<font></font>
   1227         # Forward docstrings<font></font>
   1228         fn.__doc__ = obj.__doc__<font></font>
<font></font>
RuntimeError: <font></font>
Variable 'y' previously has type None but is now being assigned to a value of type Tensor<font></font>
:<font></font>
at &lt;ipython-input-8-75677614fca6&gt;:4:8<font></font>
def my_func(x):<font></font>
    y = None<font></font>
    if x.max() &gt; 0:<font></font>
        y = x<font></font>
        ~ &lt;--- HERE<font></font>
    return y</code></pre></div></div><br>
<p>, ,      <code>torch.jit.script</code>,        .</p><br>
<p>      :</p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_func</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">if</span> x.max() &gt; <span class="hljs-number">0</span>:<font></font>
        y = <span class="hljs-number">1.25</span>
    <span class="hljs-keyword">else</span>:<font></font>
        y = <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> y<font></font>
my_func = torch.jit.script(my_func)</code></pre><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">RuntimeError                              Traceback (most recent call last)<font></font>
<font></font>
&lt;ipython-input-10-0a5f18586763&gt; in &lt;module&gt;()<font></font>
      5         y = 0<font></font>
      6     return y<font></font>
----&gt; 7 my_func = torch.jit.script(my_func)<font></font>
<font></font>
d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in script(obj, optimize, _frames_up, _rcb)<font></font>
   1224         if _rcb is None:<font></font>
   1225             _rcb = _gen_rcb(obj, _frames_up)<font></font>
-&gt; 1226         fn = torch._C._jit_script_compile(qualified_name, ast, _rcb, get_default_args(obj))<font></font>
   1227         # Forward docstrings<font></font>
   1228         fn.__doc__ = obj.__doc__<font></font>
<font></font>
d:\programming\3rd_party\pytorch\pytorch_ovod_1.3.0a0_de394b6\torch\jit\__init__.py in _rcb(name)<font></font>
   1240         # closure rcb fails<font></font>
   1241         result = closure_rcb(name)<font></font>
-&gt; 1242         if result:<font></font>
   1243             return result<font></font>
   1244         return stack_rcb(name)<font></font>
<font></font>
RuntimeError: bool value of Tensor with more than one value is ambiguous</code></pre></div></div><br>
<p>     <code>0</code>,  <code>0.</code>,       ! , ,   !</p><br>
<p>     ,       python,         TorchScript.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.  ,  rocket science          .     ,    <code>torchvision</code>,     ,  " "      .</p><br>
<p> ,    : ,   — ,     — :</p><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModule</span>(<span class="hljs-params">torch.nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
        super(MyModule, self).__init__()<font></font>
        self.resnet = torchvision.models.resnet34(pretrained = <span class="hljs-literal">True</span>)
        <span class="hljs-comment">#       torch.jit.script(my_module)</span>
        <span class="hljs-comment">#    -   resnet34.</span>
        <span class="hljs-comment">#     self.resnet  ScriptModule.</span>
        self.resnet.eval() <span class="hljs-comment"># NB:     !  -  !</span>
        self.resnet = torch.jit.trace(self.resnet, torch.rand((<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">224</span>,<span class="hljs-number">224</span>),<font></font>
                                      dtype=torch.float))<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span>
        <span class="hljs-keyword">if</span> x.shape[<span class="hljs-number">2</span>] &lt; <span class="hljs-number">224</span> <span class="hljs-keyword">or</span> x.shape[<span class="hljs-number">3</span>] &lt; <span class="hljs-number">224</span>:
            <span class="hljs-keyword">return</span> torch.tensor(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> self.resnet(x)<font></font>
my_module = MyModule()<font></font>
my_module = torch.jit.script(my_module)</code></pre><br>
<p>    ,   ,   ,  ,       .    . ,       ONNX,    .        TorchScript,  ,    ,   !    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   torch.onnx</a>.</p><br>
<p>  ,  PyTorch     TorchScript   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  <code>torch.jit</code>.  ,        <code>torch.jit.trace</code>  <code>torch.jit.script</code>   ,     .       .</p><br>
<h2 id="anchorcppanchorvklyuchaem-model-v-proekt-na-c"><a name="cpp"></a>     C++</h2><br>
<p> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>    " 2 ,    <code>torch.ones</code>".    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>,      OpenCV        ,  ,    .</p><br>
<p>       c  ResNet34     DeepLabV3.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> jupyter </a>.</p><br>
<p>   <code>torchlib</code>.     :</p><br>
<ol>
<li>     PyTorch,    <code>pip install</code>,       Python: <code>&lt;Miniconda3&gt;\Lib\site-packages\torch</code>;</li>
<li>   PyTorch   ,   : <code>&lt;My Pytorch repo&gt;\build\lib.win-amd64-3.6\torch</code>;</li>
<li>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">pytorch.org</a>  ,  Language = C++,   .</li>
</ol><br>
<p>  C++  . :</p><br>
<ol>
<li>  <br>
<pre><code class="plaintext hljs">#include &lt;torch/script.h&gt;</code></pre></li>
<li> <br>
<pre><code class="plaintext hljs">torch::jit::script::Module module = torch::jit::load("../resnet34_infer.pth");</code></pre></li>
<li> <br>
<pre><code class="plaintext hljs">torch::Tensor tensor = torch::from_blob(img.data, { img.rows, img.cols, 3 }, torch::kByte);</code></pre></li>
<li>  <code>forward</code>   <br>
<pre><code class="plaintext hljs">auto output = module.forward( { tensor } )</code></pre></li>
<li>   .   ,   ,   . ,           ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a> ,    . ,        float:<br>
<pre><code class="plaintext hljs">float* data = static_cast&lt;float*&gt;(output.toTensor().data_ptr());</code></pre></li>
<li>   .       <code>with torch.no_grad()</code>,            .  ,      ,       ++:<br>
<pre><code class="plaintext hljs">torch::NoGradGuard no_grad;</code></pre></li>
</ol><br>
<p>     CMake,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.      Visual Studio   ,    .     :</p><br>
<ol>
<li>   Visual Studio 2017.      .</li>
<li>   v14.11  v141 ( <code>"VC++ 2017 version 15.4 v14.11 toolset"</code>   VS).</li>
<li>   <code>x64</code>.</li>
<li> <code>General → Platform Toolset</code>  <code>v141(Visual Studio 2017)</code></li>
<li> <code>C/C++ → General → Additional Include Directories</code>  <code>&lt;libtorch dir&gt;\include</code></li>
<li> <code>Linker → General → Additional Library Directories</code>  <code>&lt;libtorch dir&gt;\lib</code></li>
<li> <code>Linker → Input → Additional Dependencies</code>  <code>torch.lib; c10.lib</code>.   ,     <code>caffe2.lib</code>,   GPU   -  <code>&lt;libtorch dir&gt;\lib</code>,          . ,   .</li>
<li> ,    <code>C/C++ → Language → Conformance Mode</code> = <code>No</code>,     .</li>
</ol><br>
<p>        <code>__cplusplus</code>.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>  /Zc:__cplusplus</code></a>        <code>ivalue.h</code>.</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   (   TorchLib,    OpenCV  CUDA)   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">props </a>,            . , ,  .</p><br>
<h2 id="anchortipsanchorchto-eschyo-sleduet-imet-v-vidu"><a name="tips"></a>     </h2><br>
<p>      ,    .    ,   ,     PyTorch,   Python,  TorchScript.   ,    .    ,  ,      .</p><br>
<p><img src="https://habrastorage.org/webt/iv/xy/q-/ivxyq-lqqw8s1aqd_cy4t4uwj5i.jpeg"></p><br>
<ul>
<li> ,   ,    Tensor.   - ( )    ,    ,  MyPy-style type annotations,  :</li>
</ul><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calc_letter_statistics</span>(<span class="hljs-params">self, cls_preds: List[Tensor], cls_thresh: float</span>)-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></code></pre><br>
<p> : </p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calc_letter_statistics</span>(<span class="hljs-params">self, cls_preds, cls_thresh</span>):</span>
    <span class="hljs-comment"># type: (List[Tensor], float)-&gt;Tuple[int, Tuple[Tensor, Tensor, Tensor]]</span></code></pre><br>
<ul>
<li>    ,    ,   .    <code>x=[]; for ...: x.append(y)</code>  , ..    <code>[]</code>    ,     .     , :</li>
</ul><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List<font></font>
x: List[float] = []</code></pre><br>
<p> ( "")</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> Tensor
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict, Tuple, List<font></font>
x: Dict[int: Tuple[float, List[Tensor], List[List[int]]]] = {}</code></pre><br>
<ul>
<li>      ,       TorchScript. ,  , , </li>
</ul><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> typing<font></font>
x: typing.List[torch.Tensor] = []</code></pre><br>
<p>     <em>Unknown type constructor typing.List</em></p><br>
<ul>
<li>   ,    :</li>
</ul><br>
<pre><code class="python hljs">x = <span class="hljs-literal">None</span>
<span class="hljs-keyword">if</span> smth:<font></font>
    x = torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])</code></pre><br>
<p>   .     Tensor (,    ,  ):</p><br>
<pre><code class="python hljs">x = torch.tensor(<span class="hljs-number">0</span>)
<span class="hljs-keyword">if</span> smth:<font></font>
    x = torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])</code></pre><br>
<p>   ,     .    :</p><br>
<pre><code class="python hljs">x: Optional[Tensor] = <span class="hljs-literal">None</span>
<span class="hljs-keyword">if</span> smth:<font></font>
    x = torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])</code></pre><br>
<p>     <code>x</code> ,   , ,  ,  : <em>Expected a value of type 'Tensor' for argument 'x' but instead found type 'Optional[Tensor]'.</em></p><br>
<ul>
<li><p>     , , <code>x=0.</code>   <code>x=0</code>  ..,   <code>x</code>    <code>float</code>.</p><br>
</li>
<li><p> -      <code>x = torch.Tensor(...)</code>,              <code>x = torch.tensor(...)</code>.    : <em>Unknown builtin op: aten::Tensor. Here are some suggestions: aten::tensor</em>.  ,  ,   ,  ,   . , ,     .</p><br>
</li>
<li><p>     ,   <code>torch.jit.script</code>.   -       , , <code>math.pow</code>,      <code>import math</code>.      ,   :     <code>@torch.jit.script</code>,       ,    ScriptModule.      <em>undefined value math</em>      ,  ,  ,   <code>math</code>.</p><br>
</li>
<li><p> -      <code>my_tensor[my_tensor &lt; 10] = 0</code>  ,       :</p><br>
<pre><code class="plaintext hljs">*aten::index_put_(Tensor(a!) self, Tensor?[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):*  <font></font>
*Expected a value of type 'Tensor' for argument 'values' but instead found type 'int'.*  <font></font>
*aten::index_put_(Tensor(a!) self, Tensor[] indices, Tensor values, bool accumulate=False) -&gt; (Tensor(a!)):*  <font></font>
*Expected a value of type 'List[Tensor]' for argument 'indices' but instead found type 'List[Optional[Tensor]]'.*  </code></pre><br>
<p>   —     : <code>my_tensor[my_tensor &lt; 10] = torch.tensor(0.).to(my_tensor.device)</code>.    )    <code>my_tensor</code>    (   — float)  )  <code>.to(my_tensor.device)</code>.   ,  ,         GPU   ,       <em>CUDA error: an illegal memory access was encountered</em>,       !</p><br>
</li>
<li><p> ,    <code>nn.Module</code> , ,   torchvision   "  " (  ,  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>).    Dropout     train mode,    ,       .    <code>model.eval()</code>    .</p><br>
</li>
<li><p>       ,  nn.Module — </p><br>
</li>
<li><p>        </p><br>
</li>
</ul><br>
<pre><code class="python hljs">cls_thresh = <span class="hljs-number">0.3</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModule</span>(<span class="hljs-params">torch.nn.Module</span>):</span><font></font>
    ...<font></font>
    x = r &lt; cls_thresh<font></font>
    ...</code></pre><br>
<p>      <em>python value of type 'float' cannot be used as a value</em>.      :</p><br>
<pre><code class="python hljs">cls_thresh = <span class="hljs-number">0.3</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModule</span>(<span class="hljs-params">torch.nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
        ...<font></font>
        self.cls_thresh = cls_thresh<font></font>
        ...<font></font>
        x = r &lt; self.cls_thresh<font></font>
        ...</code></pre><br>
<ul>
<li>   ,        :</li>
</ul><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FPN</span>(<span class="hljs-params">nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, block, num_blocks, num_layers =<span class="hljs-number">5</span></span>):</span><font></font>
        ...<font></font>
        self.num_layers = num_layers<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span><font></font>
        ...<font></font>
        <span class="hljs-keyword">return</span> (p3, p4, p5, p6, p7)[:self.num_layers]</code></pre><br>
<p>     <em>tuple slice indices must be integer constants</em>.  ,   num_layers —     :</p><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FPN</span>(<span class="hljs-params">nn.Module</span>):</span><font></font>
    num_layers: torch.jit.Final[int]<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, block, num_blocks, num_layers =<span class="hljs-number">5</span></span>):</span>
<span class="hljs-meta">... </span>       </code></pre><br>
<ul>
<li>   ,     ,      :</li>
</ul><br>
<pre><code class="python hljs">xx1 = x1.clamp(min=x1[i])</code></pre><br>
<p>    <em><code>Expected a value of type 'Optional[number]' for argument 'min' but instead found type 'Tensor'.</code></em>. ,        :</p><br>
<pre><code class="python hljs">xx1 = x1.clamp(min=x1[i].item())</code></pre><br>
<p>     .  -       TorchScript   ,         (    ),   .       :</p><br>
<ul>
<li>     </li>
</ul><br>
<pre><code class="plaintext hljs">tensor_a.to(tensor_b.device)</code></pre><br>
<p>,    ,          .      ,     <code>nn.Module</code>   <code>Parameter</code>.         ,     <code>torch.jit.load</code>.</p><br>
<h2 id="epilog"></h2><br>
<p> , ,  .  TorchScript              ,  -  .        ,     ,  ,     ,   PyTorch   ,     .</p><br>
<p><img src="https://habrastorage.org/webt/v0/3m/qt/v03mqtayxdfh5be4ut3nrr0c86q.jpeg"></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja480316/index.html">wifiモジュールの消費を10倍以上削減する方法</a></li>
<li><a href="../ja480318/index.html">モスクワのデベロッパー向けの今後の無料イベントの選択＃3（12月16〜24日）</a></li>
<li><a href="../ja480320/index.html">ロシアでのONYXの10年間-この間、テクノロジー、読者、市場はどのように変化したか</a></li>
<li><a href="../ja480324/index.html">CPythonでの文字列型の実装</a></li>
<li><a href="../ja480326/index.html">F5 Networks Corporationは、NGINXの現在の状況について顧客に通知する手紙を顧客に送信します</a></li>
<li><a href="../ja480330/index.html">理想的な従業員評価ツール</a></li>
<li><a href="../ja480332/index.html">モスクワ市下院における2019ブロックチェーン投票データの分析</a></li>
<li><a href="../ja480334/index.html">QtQML /クイック相関パネル</a></li>
<li><a href="../ja480338/index.html">3Dゲームレンダリングのしくみ：ラスタライズとレイトレーシング</a></li>
<li><a href="../ja480340/index.html">私は無能なマネージャーに反対し、彼は昇進しました</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>