<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç° üßíüèΩ üîÆ En pocas palabras: mejores pr√°cticas as√≠ncronas / esperadas en .NET üíé üë©üèº‚Äçü§ù‚Äçüë®üèø üìò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En previsi√≥n del comienzo del curso, "C # Developer" prepar√≥ una traducci√≥n de material interesante.
 
 
 
 Async / Await - Introducci√≥n
 La construcc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>En pocas palabras: mejores pr√°cticas as√≠ncronas / esperadas en .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/488082/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En previsi√≥n del comienzo del curso, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"C # Developer"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prepar√≥ una traducci√≥n de material interesante.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/6f/io/l8/6fiol8vwkg-r8ja-3zurutnz-ci.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async / Await - Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La construcci√≥n del lenguaje Async / Await ha existido desde C # versi√≥n 5.0 (2012) y r√°pidamente se convirti√≥ en uno de los pilares de la programaci√≥n moderna .NET: cualquier desarrollador de C # que se precie deber√≠a usarlo para mejorar el rendimiento de la aplicaci√≥n, la capacidad de respuesta general y la legibilidad del c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Async / Await hace que la introducci√≥n de c√≥digo asincr√≥nico sea enga√±osamente simple y elimina la necesidad de que el programador comprenda los detalles de su procesamiento, pero ¬øcu√°ntos de nosotros sabemos realmente c√≥mo funciona y cu√°les son las ventajas y desventajas de este m√©todo? </font><font style="vertical-align: inherit;">Hay mucha informaci√≥n √∫til, pero est√° fragmentada, as√≠ que decid√≠ escribir este art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, entonces, profundicemos en el tema.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°quina de estado (IAsyncStateMachine)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que debe saber es que, cada vez que tiene un m√©todo o funci√≥n con Async / Await, el compilador convierte su m√©todo en una clase generada que implementa la interfaz IAsyncStateMachine. Esta clase es responsable de mantener el estado de su m√©todo durante el ciclo de vida de una operaci√≥n asincr√≥nica: encapsula todas las variables de su m√©todo en forma de campos y divide su c√≥digo en secciones que se ejecutan durante las transiciones de la m√°quina de estados entre estados, para que el hilo pueda abandonar el m√©todo y cuando volver√°, el estado no cambiar√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ejemplo, aqu√≠ hay una definici√≥n de clase muy simple con dos m√©todos asincr√≥nicos: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
usar System.Threading.Tasks;</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System.Diagnostics;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AsyncAwait</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncAwait</span><font></font>
    {<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">int</span> myVariable = <span class="hljs-number">0</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After First Await"</span>);<font></font>
            myVariable = <span class="hljs-number">1</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After Second Await"</span>);<font></font>
            myVariable = <span class="hljs-number">2</span>;<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DummyAsyncMethod</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-comment">// </span><font></font>
        }<font></font>
<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una clase con dos m√©todos asincr√≥nicos</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Si observamos el c√≥digo generado durante el ensamblaje, veremos algo como esto: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/xe/63/qoxe63foidhmllsdwfi78tdhrsm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que tenemos 2 nuevas clases internas generadas para nosotros, una para cada m√©todo asincr√≥nico. Estas clases contienen una m√°quina de estado para cada uno de nuestros m√©todos asincr√≥nicos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, despu√©s de estudiar el c√≥digo descompilado </font></font><code><code>&lt;AsyncAwaitExample&gt;</code></code><code> d__0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, notaremos que nuestra variable interna </font></font><code>¬´myVariable¬ª</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ahora </font><font style="vertical-align: inherit;">es </font><font style="vertical-align: inherit;">un campo de clase: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/_m/qj/gd_mqjxvsjfw9-_zfd7740n42ua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tambi√©n podemos ver otros campos de clase utilizados internamente para mantener el estado </font></font><code>IAsyncStateMachine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La m√°quina de estados pasa por estados utilizando el m√©todo</font></font><code>MoveNext()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de hecho, un gran interruptor. </font><font style="vertical-align: inherit;">Observe c√≥mo el m√©todo contin√∫a en diferentes secciones despu√©s de cada una de las llamadas asincr√≥nicas (con la etiqueta de continuaci√≥n anterior). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/li/ea/kmlieahswg0ebqn3db5nctfzsti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso significa que la elegancia as√≠ncrona / espera tiene un precio. </font><font style="vertical-align: inherit;">El uso de async / await en realidad agrega algo de complejidad (de la que puede no ser consciente). </font><font style="vertical-align: inherit;">En la l√≥gica del lado del servidor, esto puede no ser cr√≠tico, pero en particular al programar aplicaciones m√≥viles que tienen en cuenta cada ciclo de memoria de CPU y KB, debe tener esto en cuenta, ya que la cantidad de sobrecarga puede aumentar r√°pidamente. </font><font style="vertical-align: inherit;">M√°s adelante en este art√≠culo, discutiremos las mejores pr√°cticas para usar Async / Await solo cuando sea necesario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para una explicaci√≥n bastante instructiva de la m√°quina de estado, mira este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video en YouTube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cu√°ndo usar Async / Await</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generalmente hay dos escenarios en los que Async / Await es la soluci√≥n correcta.</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajo relacionado con E / S</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : su c√≥digo esperar√° algo, como datos de una base de datos, leer un archivo, llamar a un servicio web. </font><font style="vertical-align: inherit;">En este caso, debe usar Async / Await, no la Biblioteca de tareas paralelas.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajo relacionado con la CPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : su c√≥digo realizar√° c√°lculos complejos. </font><font style="vertical-align: inherit;">En este caso, debe usar Async / Await, pero debe comenzar a trabajar en otro hilo usando Task.Run. </font><font style="vertical-align: inherit;">Tambi√©n puede considerar el uso de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la Biblioteca paralela de tareas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As√≠ncrono todo el camino</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando comience a trabajar con m√©todos asincr√≥nicos, notar√° r√°pidamente que la naturaleza asincr√≥nica del c√≥digo comienza a extenderse hacia arriba y hacia abajo en su jerarqu√≠a de llamadas; esto significa que tambi√©n debe hacer que su c√≥digo de llamada sea asincr√≥nico, y as√≠ sucesivamente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede tener la tentaci√≥n de "detener" esto bloqueando el c√≥digo usando Task.Result o Task.Wait, convirtiendo una peque√±a parte de la aplicaci√≥n y envolvi√©ndola en una API s√≠ncrona para que el resto de la aplicaci√≥n est√© aislada de los cambios. Desafortunadamente, esta es una receta para crear puntos muertos dif√≠ciles de rastrear.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mejor soluci√≥n a este problema es permitir que el c√≥digo as√≠ncrono crezca en la base de c√≥digo de forma natural. </font><font style="vertical-align: inherit;">Si sigue esta decisi√≥n, ver√° la extensi√≥n del c√≥digo asincr√≥nico a su punto de entrada, generalmente un controlador de eventos o una acci√≥n de controlador. </font><font style="vertical-align: inherit;">¬°R√≠ndete a la asincron√≠a sin dejar rastro! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s informaci√≥n en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el m√©todo se declara as√≠ncrono, ¬°aseg√∫rese de que est√© esperando!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como discutimos, cuando el compilador encuentra un m√©todo as√≠ncrono, convierte este m√©todo en una m√°quina de estados. </font><font style="vertical-align: inherit;">Si su c√≥digo no tiene en espera en su cuerpo, el compilador generar√° una advertencia, pero la m√°quina de estado, sin embargo, se crear√°, agregando una sobrecarga innecesaria para una operaci√≥n que nunca se completar√°.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evitar vac√≠o as√≠ncrono</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El vac√≠o as√≠ncrono es algo que realmente deber√≠a evitarse. </font><font style="vertical-align: inherit;">Establezca una regla para usar Tarea as√≠ncrona en lugar de anulaci√≥n as√≠ncrona.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El vac√≠o as√≠ncrono y los m√©todos de tareas as√≠ncronas</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hay varias razones para esto, que incluyen:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las excepciones lanzadas en el m√©todo vac√≠o as√≠ncrono no se pueden detectar fuera de este m√©todo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></li>
</ul><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando se lanza una excepci√≥n desde la Tarea as√≠ncrona o el </font><font style="vertical-align: inherit;">m√©todo de </font><font style="vertical-align: inherit;">Tarea as√≠ncrona </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, esta excepci√≥n se captura y se coloca en el objeto Tarea. </font><font style="vertical-align: inherit;">Cuando se utilizan m√©todos de vac√≠o as√≠ncrono, no hay ning√∫n objeto de tarea, por lo que cualquier excepci√≥n lanzada desde el m√©todo de vac√≠o as√≠ncrono se invocar√° directamente en el SynchronizationContext, que estaba activo cuando se ejecut√≥ el m√©todo de vac√≠o as√≠ncrono. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere el siguiente ejemplo. </font><font style="vertical-align: inherit;">El bloque de captura nunca ser√° alcanzado.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThisWillNotCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        AsyncVoidMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span>(Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//     </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las excepciones lanzadas en el m√©todo de vac√≠o as√≠ncrono no se pueden detectar fuera de este m√©todo.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Compare con este c√≥digo, donde en lugar de vac√≠o an√≠mico tenemos una tarea as√≠ncrona. </font><font style="vertical-align: inherit;">En este caso, la captura ser√° accesible.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ThisWillCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-keyword">await</span> AsyncTaskMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//    </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La excepci√≥n se detecta y se coloca en el objeto Tarea.</font></font></i><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los m√©todos anulados as√≠ncronos pueden causar efectos secundarios no deseados si la persona que llama no espera que sean as√≠ncronos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : si su m√©todo asincr√≥nico no devuelve nada, use la Tarea asincr√≥nica (sin una " </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" para la Tarea) como el tipo de retorno.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©todos de vac√≠o as√≠ncrono </font><b><font style="vertical-align: inherit;">son muy dif√≠ciles de probar</font></b><font style="vertical-align: inherit;"> : debido a las diferencias en el manejo y dise√±o de errores, es dif√≠cil escribir pruebas unitarias que llamen m√©todos de vac√≠o as√≠ncrono. </font><font style="vertical-align: inherit;">Prueba as√≠ncrona MSTest s√≥lo funciona para m√©todos asincr√≥nicos que devuelven una tarea o tareas </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una excepci√≥n a esta pr√°ctica son los controladores de eventos as√≠ncronos. </font><font style="vertical-align: inherit;">Pero incluso en este caso, se recomienda minimizar el c√≥digo escrito en el propio controlador; espere un m√©todo de tarea as√≠ncrono que contenga l√≥gica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s informaci√≥n en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefiere la tarea de devoluci√≥n en lugar de esperar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ya se discuti√≥, cada vez que declara un m√©todo como as√≠ncrono, el compilador crea una clase de m√°quina de estado que en realidad envuelve la l√≥gica de su m√©todo. Esto agrega cierta sobrecarga que puede acumularse, especialmente para dispositivos m√≥viles, donde tenemos l√≠mites de recursos m√°s estrictos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A veces, un m√©todo no tiene que ser as√≠ncrono, pero devuelve la Tarea </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y permite que el otro lado lo maneje en consecuencia. Si la √∫ltima oraci√≥n de su c√≥digo es un retorno en espera, deber√≠a considerar refactorizarlo para que el tipo de retorno del m√©todo sea la Tarea </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(en lugar de async T). </font><font style="vertical-align: inherit;">Debido a esto, evita generar una m√°quina de estado, lo que hace que su c√≥digo sea m√°s flexible. </font><font style="vertical-align: inherit;">El √∫nico caso que realmente queremos esperar es cuando hacemos algo con el resultado de la tarea as√≠ncrona en la continuaci√≥n del m√©todo.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">AsyncTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//  !</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">//await -   ,  await  </span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> GetData();<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">JustTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//!</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">// Task</span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefiera la tarea de devoluci√≥n en lugar de la espera de devoluci√≥n</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tenga en cuenta que si no tenemos la espera y, en su lugar, devolvemos la Tarea </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la devoluci√≥n se produce de inmediato, por lo que si el c√≥digo est√° dentro de un bloque try / catch, no se detectar√° la excepci√≥n. </font><font style="vertical-align: inherit;">Del mismo modo, si el c√≥digo est√° dentro del bloque de uso, eliminar√° inmediatamente el objeto. </font><font style="vertical-align: inherit;">Ver el siguiente consejo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No envuelva la tarea de retorno dentro de try..catch {} o usando bloques {}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea de retorno puede causar un comportamiento indefinido cuando se usa dentro de un bloque try..catch (nunca se detectar√° una excepci√≥n lanzada por el m√©todo asincr√≥nico) o dentro de un bloque de uso, porque la tarea se devolver√° de inmediato. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesita ajustar su c√≥digo asincr√≥nico en un intento ... capturar o usar un bloque, use return waitit en su lugar.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskExceptionNotCaught</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">try</span><font></font>
   {<font></font>
       <span class="hljs-comment">// ...</span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
   }<font></font>
   <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
<font></font>
   {<font></font>
       <span class="hljs-comment">//     </span><font></font>
<font></font>
       Debug.WriteLine(ex.Message);<font></font>
       <span class="hljs-keyword">throw</span>;<font></font>
   }<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskUsingProblem</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> resource = GetResource())<font></font>
   {<font></font>
<font></font>
       <span class="hljs-comment">// ...  ,     , ,    </span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData(resource);<font></font>
   }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No envuelva la tarea de devoluci√≥n dentro de bloques </font></font><code>try..catch{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o</font></font><code>using{}</code></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s informaci√≥n en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hilo sobre desbordamiento de pila.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evite usar </font></font><code>.Wait()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>.Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- use en su lugar</font></font><code>GetAwaiter().GetResult()</code></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necesita bloquear la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espera de que se complete la tarea asincr√≥nica, use </font></font><code>GetAwaiter().GetResult().</code> <code>Wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agregue cualquier excepci√≥n </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que complica el manejo de errores. </font><font style="vertical-align: inherit;">La ventaja </font></font><code>GetAwaiter().GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es que en su lugar devuelve la excepci√≥n habitual </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetAwaiterGetResultExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">// ,    ,     AggregateException  </span><font></font>
<font></font>
   <span class="hljs-keyword">string</span> data = GetData().Result;<font></font>
<font></font>
   <span class="hljs-comment">// ,   ,      </span><font></font>
<font></font>
   data = GetData().GetAwaiter().GetResult();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesita bloquear la espera de que se complete la tarea asincr√≥nica, use la </font></font><code>GetAwaiter().GetResult().</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
informaci√≥n M√°s en este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el m√©todo es as√≠ncrono, agregue el sufijo as√≠ncrono a su nombre</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es la convenci√≥n utilizada en .NET para distinguir m√°s f√°cilmente entre los m√©todos s√≠ncronos y as√≠ncronos (con la excepci√≥n de los controladores de eventos o los m√©todos de controlador web, pero a√∫n as√≠ su c√≥digo no deber√≠a invocarlos expl√≠citamente).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los m√©todos de biblioteca asincr√≥nica deben usar Task.ConfigureAwait (false) para mejorar el rendimiento</font></font></h3><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.NET Framework tiene el concepto de un "contexto de sincronizaci√≥n", que es una forma de "volver a donde estaba antes". Cada vez que una Tarea est√° esperando, captura el contexto de sincronizaci√≥n actual antes de esperar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de completar la tarea </font></font><code>.Post()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">se llama al m√©todo de </font><font style="vertical-align: inherit;">contexto de sincronizaci√≥n, que reanuda el trabajo desde donde estaba antes. Esto es √∫til para volver al hilo de la interfaz de usuario o para volver al mismo contexto ASP.NET, etc.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al escribir el c√≥digo de la biblioteca, rara vez necesita volver al contexto en el que se encontraba antes. Cuando se utiliza Task.ConfigureAwait (false), el c√≥digo ya no intenta reanudarse desde donde estaba antes, sino que, si es posible, el c√≥digo sale en el hilo que complet√≥ la tarea, lo que evita el cambio de contexto. Esto mejora ligeramente el rendimiento y puede ayudar a evitar puntos muertos.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ConfigureAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//   ConfigureAwait(false)   .</span><font></font>
<font></font>
   <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">await</span> GetData().ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, use ConfigureAwait (falso) para los procesos del servidor y el c√≥digo de la biblioteca. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es especialmente importante cuando el m√©todo de la biblioteca se llama una gran cantidad de veces, para una mejor capacidad de respuesta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, use ConfigureAwait (false) para los procesos del servidor en general. No nos importa qu√© hilo se use para continuar, a diferencia de las aplicaciones en las que necesitamos volver al hilo de la interfaz de usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora ... En ASP.NET Core, Microsoft ha eliminado el SynchronizationContext, por lo que te√≥ricamente no necesita eso. Pero si escribe c√≥digo de biblioteca que podr√≠a reutilizarse en otras aplicaciones (por ejemplo, la aplicaci√≥n de interfaz de usuario, ASP.NET heredado, formularios de Xamarin), esto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sigue siendo la mejor pr√°ctica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para una buena explicaci√≥n de este concepto, vea </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informe de progreso de tarea asincr√≥nica</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un caso de uso bastante com√∫n para los m√©todos asincr√≥nicos es trabajar en segundo plano, liberar el hilo de la interfaz de usuario para otras tareas y mantener la capacidad de respuesta. En este escenario, es posible que desee informar el progreso a la interfaz de usuario para que el usuario pueda monitorear el progreso del proceso e interactuar con la operaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver este problema com√∫n, .NET proporciona la interfaz IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que proporciona el m√©todo Report </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que es invocado por una tarea asincr√≥nica para informar el progreso al llamante. Esta interfaz se acepta como un par√°metro del m√©todo asincr√≥nico: la persona que llama debe proporcionar un objeto que implemente esta interfaz.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.NET proporciona Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la implementaci√≥n predeterminada de IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que en realidad se recomienda, ya que maneja toda la l√≥gica de bajo nivel asociada con guardar y restaurar el contexto de sincronizaci√≥n. Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambi√©n proporciona un evento Action </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font><font style="vertical-align: inherit;">y una devoluci√≥n de llamada </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ambas llamadas cuando una tarea informa sobre el progreso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juntos, IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proporcionan una manera f√°cil de transferir informaci√≥n de progreso de una tarea en segundo plano a un subproceso de interfaz de usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede ser un valor simple, como un int o un objeto que proporciona informaci√≥n de progreso contextual, como el porcentaje de finalizaci√≥n, una descripci√≥n de cadena de la operaci√≥n actual, ETA, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere con qu√© frecuencia informa el progreso. </font><font style="vertical-align: inherit;">Dependiendo de la operaci√≥n que est√© realizando, es posible que sus informes de c√≥digo progresen varias veces por segundo, lo que puede provocar que la interfaz de usuario sea menos receptiva. </font><font style="vertical-align: inherit;">En tal escenario, se recomienda informar el progreso a intervalos m√°s grandes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s informaci√≥n en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el blog oficial de Microsoft .NET.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cancelar tareas asincr√≥nicas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro caso de uso com√∫n para tareas en segundo plano es la capacidad de cancelar la ejecuci√≥n. </font><font style="vertical-align: inherit;">.NET proporciona la clase CancellationToken. </font><font style="vertical-align: inherit;">El m√©todo asincr√≥nico recibe el objeto CancellationToken, que luego es compartido por el c√≥digo de la parte llamante y el m√©todo asincr√≥nico, proporcionando as√≠ un mecanismo para la se√±alizaci√≥n de la cancelaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso m√°s com√∫n, la cancelaci√≥n se produce de la siguiente manera:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La persona que llama crea un objeto CancellationTokenSource.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La persona que llama llama a la API asincr√≥nica cancelada y pasa CancellationToken desde CancellationTokenSource (CancellationTokenSource.Token).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La persona que llama solicita una cancelaci√≥n utilizando el objeto CancellationTokenSource (CancellationTokenSource.Cancel ()).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tarea confirma la cancelaci√≥n y se cancela a s√≠ misma, generalmente utilizando el m√©todo CancellationToken.ThrowIfCancellationRequested.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que para que este mecanismo funcione, deber√° escribir c√≥digo para verificar las cancelaciones solicitadas a intervalos regulares (es decir, en cada iteraci√≥n de su c√≥digo o en un punto de interrupci√≥n natural en la l√≥gica). </font><font style="vertical-align: inherit;">Idealmente, despu√©s de una solicitud de cancelaci√≥n, la tarea asincr√≥nica debe cancelarse lo m√°s r√°pido posible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deber√≠a considerar el uso de deshacer para todos los m√©todos que pueden tardar mucho tiempo en completarse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s informaci√≥n en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el blog oficial de Microsoft .NET.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informe de progreso y cancelaci√≥n - Ejemplo</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> System.Windows.Forms;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">TestAsyncAwait</span><font></font>
{<font></font>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span> : <span class="hljs-title">Form</span><font></font>
   {<font></font>
       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span>(<span class="hljs-params"></span>)</span><font></font>
       {<font></font>
           InitializeComponent();<font></font>
       }<font></font>
<font></font>
       CancellationTokenSource _cts = <span class="hljs-keyword">new</span> CancellationTokenSource();<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnRunAsync_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-comment">//   .</span><font></font>
<font></font>
            &lt;<span class="hljs-keyword">int</span>&gt;   ,          ,   ,    , ETA  . .<font></font>
<font></font>
           <span class="hljs-keyword">var</span> progressIndicator = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-keyword">int</span>&gt;(ReportProgress);<font></font>
<font></font>
           <span class="hljs-keyword">try</span><font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">//   ,         </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> AsyncMethod(progressIndicator, _cts.Token);<font></font>
<font></font>
           }<font></font>
<font></font>
           <span class="hljs-keyword">catch</span> (OperationCanceledException ex)<font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">// </span><font></font>
<font></font>
               lblProgress.Text = <span class="hljs-string">"Cancelled"</span>;<font></font>
           }<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnCancel_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
          <span class="hljs-comment">// </span><font></font>
           _cts.Cancel();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReportProgress</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
<font></font>
       {<font></font>
           <span class="hljs-comment">//    </span><font></font>
<font></font>
           lblProgress.Text = <span class="hljs-keyword">value</span>.ToString();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncMethod</span>(<span class="hljs-params">IProgress&lt;<span class="hljs-keyword">int</span>&gt; progress, CancellationToken ct</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<font></font>
<font></font>
           {<font></font>
              <span class="hljs-comment">//   ,     </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (ct != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   ct.ThrowIfCancellationRequested();<font></font>
<font></font>
               }<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (progress != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   progress.Report(i);<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando por un per√≠odo de tiempo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesita esperar un momento (por ejemplo, intente nuevamente verificar la disponibilidad del recurso), aseg√∫rese de usar Task.Delay - nunca use Thread.Sleep en este escenario.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando a que se completen varias tareas asincr√≥nicas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use Task.WaitAny para esperar la finalizaci√≥n de cualquier tarea. </font><font style="vertical-align: inherit;">Use Task.WaitAll para esperar a que se completen todas las tareas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øTengo que apresurarme para cambiar a C # 7 u 8? </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reg√≠strese para un seminario web gratuito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para discutir este tema.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es488060/index.html">Backblaze - estad√≠sticas del disco duro 2019</a></li>
<li><a href="../es488062/index.html">Dynamics 365 y Power Platform Meetup en Lamoda - Informe</a></li>
<li><a href="../es488064/index.html">Siete razones por las que Linux</a></li>
<li><a href="../es488072/index.html">¬øEs Koin Dependency Injection o Service Locator?</a></li>
<li><a href="../es488078/index.html">Mi bot para la Copa Rusa AI 2019</a></li>
<li><a href="../es488088/index.html">C√≥mo interact√∫a Habr con los organismos estatales y otros solicitantes. Informe de transparencia para todos los a√±os.</a></li>
<li><a href="../es488092/index.html">Hackathons C√≥mo aprovechar al m√°ximo y sobrevivir</a></li>
<li><a href="../es488096/index.html">400g. Vista desde el lado de la transmisi√≥n. ZR / ZR +</a></li>
<li><a href="../es488098/index.html">C√≥mo crear un proyecto Django a partir de una plantilla</a></li>
<li><a href="../es488102/index.html">La relaci√≥n entre C # y C #: REST, gRPC y todo lo dem√°s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>