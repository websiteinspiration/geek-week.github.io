<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💜 ㊗️ 👊🏻 STM32 Parte 1: Lo básico 🍵 🎷 🙎🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No puede confiar en el código que no escribió completamente usted mismo. - Ken ThompsonQuizás mi cita favorita. Fue ella quien se convirtió en la razó...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Parte 1: Lo básico</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490474/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No puede confiar en el código que no escribió completamente usted mismo. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ken Thompson</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quizás mi cita favorita. Fue ella quien se convirtió en la razón por la que decidí sumergirme en las profundidades de la madriguera del conejo. Comencé mi viaje al mundo de la programación hace muy poco, solo pasó un mes y decidí escribir artículos para consolidar el material. Todo comenzó con una tarea simple, sincronizar las lámparas en su estudio fotográfico usando Arduina. El problema se resolvió, pero ya no entré al estudio fotográfico, no hay tiempo. Desde ese momento, decidí participar a fondo en la programación de microcontroladores. Arduin, aunque atractivo en su simplicidad, no me gustó la plataforma. La elección recayó en la empresa ST y sus productos populares. En ese momento, todavía no tenía idea de cuál era la diferencia, pero como consumidor típico comparé la velocidad del "procesador" y la cantidad de memoria, me compré una placa impresionante con una pantalla STM32F746NG: Discovery.Extrañaré los momentos de desesperación y voy directo al grano.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inmerso en la imagen de un programador, leí mucho, estudié, experimenté. </font><font style="vertical-align: inherit;">Y como ya describí anteriormente, quería estudiar bien, eso es todo. </font><font style="vertical-align: inherit;">Y para esto establecí una meta, no ninguna solución preparada, solo la mía. </font><font style="vertical-align: inherit;">Y si todo salió bien para mí, entonces tendrás éxito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lista de todo lo que necesitas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16+ </font><font style="vertical-align: inherit;">máquina virtual </font><font style="vertical-align: inherit;">o lo que sea</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilador de </font><b><font style="vertical-align: inherit;">brazo</font></b><font style="vertical-align: inherit;"> : descárguelo en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads</font></font></a> </li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depurador y programador de </font><b><font style="vertical-align: inherit;">openocd</font></b><font style="vertical-align: inherit;"> : no podrá descargar desde el enlace, recopilamos de las fuentes, se adjuntan las instrucciones</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/openocd/code openocd</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Editor de texto a tu gusto</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de que todo esté instalado y ensamblado, ¡podemos proceder al primer proyecto! </font><font style="vertical-align: inherit;">Y no, ni siquiera es una bombilla parpadeante. </font><font style="vertical-align: inherit;">Para empezar, debemos profundizar en el proceso de inicialización del propio micropocillo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que necesitamos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linker.ld</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init.c</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con el último párrafo Init.c. </font><font style="vertical-align: inherit;">En primer lugar, nuestro mk debe cargar la dirección "puntero de pila" es un puntero a la dirección de memoria que se utiliza para las instrucciones PUSH y POP. </font><font style="vertical-align: inherit;">Le recomiendo que estudie detenidamente estas dos instrucciones, ya que no explicaré en detalle todas las instrucciones. </font><font style="vertical-align: inherit;">Cómo implementar esto, ver abajo.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos este ejemplo. </font><font style="vertical-align: inherit;">Extern significa que el símbolo es externo, y declaramos este símbolo en el archivo Linker.ld, volveremos a él un poco más tarde.</font></font><br>
<br>
<pre><code class="cpp hljs"> __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Aquí usamos un atributo que le dice al compilador que coloque la matriz en la sección isr_vector y que incluso si no la usamos en el código, aún debe incluirse en el programa. Y su primer elemento será ese mismo puntero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos por qué es esta matriz y con qué se comerá. A diferencia de un procesador convencional, la arquitectura micron en el brazo inicia la ejecución cuando no es desde la dirección cero, sino desde la dirección apuntada por el puntero en esta matriz, todo es complicado. Además, el primer puntero en esta matriz siempre apunta al comienzo de la pila, pero el segundo ya apunta al comienzo de nuestro código. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daré un ejemplo. se da que la pila comienza con 0x20010000 y el código del programa es 0x0800008. entonces la matriz se puede escribir como</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {
    <span class="hljs-number">0x20010000</span>,
    <span class="hljs-number">0x08000008</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, el controlador primero inicializa la pila y luego considera la dirección de la primera instrucción y la carga en el registro del contador del programa. Ahora lo más importante, dependiendo del modelo, estos números pueden ser diferentes, pero con el ejemplo de stm32f7 puedo decir con confianza que esta matriz debería estar en la memoria en la dirección 0x08000000. Es desde esta dirección que mk comenzará su trabajo después de encender o reiniciar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora nos detendremos y prestaremos atención a cómo poner esta matriz en la sección que necesitamos. Esto se hace mediante "ld" o enlazador. Este programa recopila todo nuestro programa y el script Linker.ld se usa para esto. Doy un ejemplo y lo analizo más a fondo.</font></font><br>
<br>
<pre><code class="plaintext hljs">MEMORY{<font></font>
	ROM_AXIM (rx) : ORIGIN = 0x08000000, LENGTH = 1M<font></font>
	RAM_DTCM (rwx): ORIGIN = 0x20000000, LENGTH = 64K<font></font>
}<font></font>
<font></font>
_estack = LENGTH(RAM_DTCM) + ORIGIN(RAM_DTCM);<font></font>
<font></font>
SECTIONS{<font></font>
	.isr_vector : {<font></font>
	KEEP(*(.isr_vector))<font></font>
	} &gt;ROM_AXIM&lt;/code&gt;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qué pasa aquí. MEMORY define secciones de memoria y SECTIONS define secciones. aquí vemos nuestro _stack y el hecho de que es igual a la suma del comienzo de la memoria y su longitud, es decir, el final de nuestra memoria. La sección .isr_vector en la que ponemos nuestra matriz también está definida. </font></font><code>&gt;ROM_AXIM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al final de nuestra sección significa que esta sección debe colocarse en la sección de memoria que comienza con 0x08000000 según lo requerido por nuestras micras. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ponemos la matriz donde es necesario, ahora necesitamos algún tipo de instrucción para que nuestro micron funcione. Aquí está el init.c aumentado:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencioné anteriormente, la segunda dirección debe ser un puntero a la primera función o instrucción. </font><font style="vertical-align: inherit;">Y nuevamente, los atributos, pero todo es simple, la función no devuelve ningún valor y sigue cualquier ABI en la entrada, es decir, desnudo “desnudo”. </font><font style="vertical-align: inherit;">En tales funciones, se empuja el ensamblador habitual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora es el momento de compilar nuestro código y ver qué hay debajo del capó. </font><font style="vertical-align: inherit;">No tocaremos el Makefile por ahora.</font></font><br>
<br>
<pre><code class="bash hljs">arm-none-eabi-gcc -c init.c -o init.o -mthumb</code></pre><br>
<pre><code class="bash hljs">arm-none-eabi-gcc -TLinker.ld -o prog.elf init.o -Wl,--gc-sections -nostartfiles -nodefaultlibs -nostdlib</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aquí vemos muchas cosas incomprensibles. </font><font style="vertical-align: inherit;">en orden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-mthumb compila para armv7, que usa solo instrucciones de pulgar </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TLinker.ld especifica el script del vinculador. </font><font style="vertical-align: inherit;">de forma predeterminada, se compila para su ejecución en el entorno Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Wl, - gc-secciones -nostartfiles -nodefaultlibs -nostdlib elimina todas las bibliotecas estándar, los archivos de inicialización del entorno C y todas las demás bibliotecas auxiliares, como las matemáticas.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, no tiene sentido cargar esto en micras. </font><font style="vertical-align: inherit;">Pero tiene sentido ver y estudiar el binario.</font></font><br>
<br>
<pre><code class="bash hljs">objcopy -O ihex prog.elf prog.bin</code></pre><br>
<pre><code class="bash hljs">hexdump prog.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego veremos la conclusión. </font><font style="vertical-align: inherit;">"00000000: 00 01 00 02 09 00 00 08" que simbolizará nuestro éxito. </font><font style="vertical-align: inherit;">Este es mi primer artículo y no pude revelar completamente todo el material y la esencia, por lo que en el siguiente describiré los mecanismos con más detalle y nosotros, los amigos, podremos ir a un programa que no parpadeará, sino que configurará el reloj del procesador y los buses.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490462/index.html">Monopolismo de servicios y neutralidad de la red: las bayas estarán por delante</a></li>
<li><a href="../es490464/index.html">Sobre un intento fallido de fuerza bruta de derechos de autor o 68 mil millones de canciones que no cambiarán nada</a></li>
<li><a href="../es490466/index.html">Hoja de ruta de disciplinas matemáticas para el aprendizaje automático, parte 2 (probabilidades)</a></li>
<li><a href="../es490470/index.html">OWASP Moscú 2020/1</a></li>
<li><a href="../es490472/index.html">Mientras escribía una criptomoneda semi descentralizada en PHP. (Parte 1 - Coleccionar bibliotecas)</a></li>
<li><a href="../es490476/index.html">Sensor inalámbrico para abrir y cerrar con funcionalidad avanzada</a></li>
<li><a href="../es490478/index.html">Estación de soldadura DIY DIY v2</a></li>
<li><a href="../es490480/index.html">O Tiling-wm en 2 palabras</a></li>
<li><a href="../es490484/index.html">Administrar sensores domésticos inteligentes con el Asistente de Google</a></li>
<li><a href="../es490490/index.html">Lectura de fin de semana: 10 materiales sobre los efectos del sonido en la salud, desde "higiene de ruido" hasta buen sueño y GTD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>