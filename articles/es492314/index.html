<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßóüèæ ü§µüèº üî° Hogar inteligente: construya gr√°ficos de agua y electricidad en Home Assistant üêé üêí üà∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cada vez que recibo una factura por electricidad y agua, me pregunto: ¬ømi familia realmente consume tanto? Bueno, s√≠, el ba√±o tiene suelo radiante y u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hogar inteligente: construya gr√°ficos de agua y electricidad en Home Assistant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wj/lf/i3/wjlfi38qar57vvhqgpwuzdalerw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada vez que recibo una factura por electricidad y agua, me pregunto: ¬ømi familia realmente consume tanto? Bueno, s√≠, el ba√±o tiene suelo radiante y una caldera, pero no se alimentan constantemente. Tambi√©n parece que ahorramos agua (aunque tambi√©n nos encantan las salpicaduras en el ba√±o). Hace unos a√±os, ya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conect√© medidores de agua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">electricidad</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a una casa inteligente, pero esto se atasc√≥ en esto. Hands lleg√≥ al an√°lisis del consumo solo ahora, sobre el que, de hecho, se trata este art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recientemente cambi√© a Home Assistant como un sistema de casa inteligente. Una de las razones era solo la oportunidad de organizar la recopilaci√≥n de una gran cantidad de datos con la posibilidad de construir convenientemente varios tipos de gr√°ficos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La informaci√≥n descrita en este art√≠culo no es nueva, todas estas cosas con diferentes salsas ya se han descrito en Internet. </font><font style="vertical-align: inherit;">Pero cada art√≠culo, como regla, describe solo un enfoque o aspecto. </font><font style="vertical-align: inherit;">Tuve que comparar todos estos enfoques y elegir el m√°s adecuado yo mismo. </font><font style="vertical-align: inherit;">El art√≠culo a√∫n no proporciona informaci√≥n completa sobre la recopilaci√≥n de datos, pero es una especie de sinopsis de c√≥mo lo hice. </font><font style="vertical-align: inherit;">De modo que las cr√≠ticas constructivas y las sugerencias de mejora son bienvenidas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulaci√≥n del problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el objetivo del ejercicio de hoy es obtener hermosos gr√°ficos del consumo de agua y electricidad:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada hora durante 2 d√≠as.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diariamente por 2 semanas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(opcional) semanal y mensual</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ es donde nos esperan algunas dificultades:</font></font><br>
<br>
<ul>
<li>  ,  ,  .         . <br>
<br>
  ,     ,     .  home assistant,  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">mini-graph-card</a>,     :<br>
<br>
<ul>
<li>        (     ,         )</li>
<li>       (   ,      )</li>
</ul></li>
<li> ,  home assistant        SQLite <s>( , ,    MySQL  Postgres)</s>,        . , ,               json   <br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"old_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"aafc8ca305ba4e49ad4c97f0eddd8893"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}, <span class="hljs-attr">"new_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"0de64b8af6f14bb9a419dcf3b200ef56"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}}</code></pre><br>
     (    ,    ),         .      SDM220      10-15 ,         8.      ,      . ..         100-200  .      ,      (    home assistant  raspberry PI),            .</li>
<li>  ,      .           <s> </s>   .           (RS232/RS485/Modbus/Zigbee)   .<br>
<br>
         (    ),      X -  .            .         ,        . , ,        home assistant,          ,             (  home assistant).</li>
</ul><br>
<h2> 1</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, veamos qu√© se proporciona al asistente de casa de inmediato. Medir el consumo durante un per√≠odo es una funcionalidad muy demandada. Por supuesto, se realiz√≥ hace mucho tiempo en forma de un componente especializado: utility_meter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La esencia del componente es que en su interior inicia la variable current_accumulated_value y la restablece despu√©s de un per√≠odo espec√≠fico (hora / semana / mes). El componente mismo monitorea la variable entrante (el valor de alg√∫n tipo de sensor), se suscribe a los cambios en el valor en s√≠ mismo: solo obtiene el resultado final. Esto se describe en unas pocas l√≠neas en el archivo de configuraci√≥n.</font></font><br>
<br>
<pre><code class="python hljs">utility_meter:<font></font>
  water_cold_hour_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: hourly<font></font>
  water_cold_day_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: daily<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ sensor.water_meter_cold es el valor actual del contador en litros, que obtengo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directamente de la pieza de hierro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por mqtt. El dise√±o crea 2 sensores nuevos water_cold_hour_um y water_cold_day_um, que acumulan lecturas por hora y por d√≠a, restableci√©ndolos despu√©s de un per√≠odo. Aqu√≠ hay un gr√°fico de bater√≠a de media hora. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/u3/fk/leu3fkbgddojjis_lmcawt6gcv4.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de gr√°fico horario y diario para la interfaz de usuario de lovelace se ve as√≠:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, el problema de este enfoque radica en este algoritmo. Como mencion√©, para cada valor de entrada (la lectura actual del medidor para cada litro siguiente), se genera 1kb de registro en la base de datos. Cada medidor de servicios tambi√©n genera un nuevo valor, que tambi√©n se suma a la base de datos. Si quiero recopilar lecturas por hora / d√≠a / semana / mes, y para varios elevadores de agua, e incluso agregar un mont√≥n de medidores el√©ctricos, esta ser√° una gran cantidad de datos. Bueno, m√°s precisamente, no hay muchos datos, pero dado que el asistente dom√©stico escribe en la base de datos un mont√≥n de informaci√≥n adicional, el tama√±o de la base de datos crecer√° a pasos agigantados. Me temo incluso estimar el tama√±o de la base para gr√°ficos semanales y mensuales.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, el medidor de utilidad por s√≠ solo no resuelve la tarea. </font><font style="vertical-align: inherit;">El gr√°fico de valores que da el medidor de utilidad es una funci√≥n monot√≥nicamente creciente que se restablece a 0 cada hora. </font><font style="vertical-align: inherit;">Necesitamos una tabla de consumo f√°cil de usar, cu√°ntos litros se consumieron durante el per√≠odo. </font><font style="vertical-align: inherit;">El componente est√°ndar de historial gr√°fico no sabe c√≥mo hacer esto, pero el componente externo de minitarjeta gr√°fica puede ayudarnos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es el c√≥digo de tarjeta para lovelace-UI:</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_hour_um<font></font>
        group_by: hour<font></font>
        hours_to_show: <span class="hljs-number">48</span>
        name: <span class="hljs-string">"Hourly water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">1</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de las configuraciones est√°ndar como el nombre del sensor, el tipo de gr√°fico, el color (no me gust√≥ la naranja est√°ndar), es importante tener en cuenta 3 configuraciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_by: hour: el gr√°fico se generar√° con las columnas alineadas al comienzo de la hora</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points_per_hour: 1 - una barra por cada hora</font></font></li>
<li>  , aggregate_func: max ‚Äî       .         </li>
</ul><br>
<img src="https://habrastorage.org/webt/yj/du/c7/yjduc7nhxnq18qvcityd_ul91y0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No preste atenci√≥n a una serie de columnas a la izquierda; este es el comportamiento est√°ndar de un componente si no hay datos. Y no hab√≠a datos: solo activ√© la recopilaci√≥n de datos del medidor de utilidad hace solo un par de horas solo por el bien de este art√≠culo (hablar√© sobre mi enfoque actual un poco m√°s adelante). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta imagen, quer√≠a mostrar que a veces la visualizaci√≥n de datos incluso funciona, y las barras realmente reflejan los valores correctos. Pero eso no es todo. La columna seleccionada para el intervalo de 11 a 12 de la ma√±ana, por alguna raz√≥n, muestra 19 litros, aunque en el gr√°fico con dientes un poco m√°s alto para el mismo per√≠odo vemos un consumo de 62 litros del mismo sensor. O un insecto o las manos est√°n torcidas. Pero no entiendo por qu√© se rompieron los datos de la derecha: el consumo all√≠ era normal, lo que tambi√©n es visible en el horario de los dientes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, no pude lograr la credibilidad de este enfoque: el gr√°fico casi siempre muestra alg√∫n tipo de herej√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mismo c√≥digo para el sensor de d√≠a.</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_day_um<font></font>
        group_by: interval<font></font>
        hours_to_show: <span class="hljs-number">360</span>
        name: <span class="hljs-string">"Daily water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">0.0416666666</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que el par√°metro group_by est√° establecido en intervalo, y el par√°metro points_per_hour rige todo. </font><font style="vertical-align: inherit;">Y este es otro problema de este componente: points_per_hour funciona bien en gr√°ficos en una hora o menos, pero asqueroso a grandes intervalos. </font><font style="vertical-align: inherit;">Entonces, para obtener una columna en un d√≠a, tuve que ingresar el valor 1/24 = 0.04166666. </font><font style="vertical-align: inherit;">No estoy hablando de gr√°ficos semanales y mensuales.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfoque 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo descubriendo al asistente de casa, me encontr√© con este video aqu√≠:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-0HrYFCRH0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un amigo recopila datos de consumo de varios tipos de puntos de venta de Xiaomi. Su tarea es un poco m√°s f√°cil: solo muestra el valor del consumo para hoy, ayer y para el mes. No se requieren horarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dejemos de lado la discusi√≥n sobre la integraci√≥n manual de los valores de potencia instant√°neos: ya escrib√≠ sobre la "precisi√≥n" de este enfoque. No est√° claro por qu√© no us√≥ los valores de consumo acumulados, que ya se recogen en el mismo punto de venta. En mi opini√≥n, la integraci√≥n dentro de la pieza de hierro funcionar√° mejor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Del video tomamos la idea de calcular manualmente el consumo para el per√≠odo. El campesino solo cuenta los valores para hoy y ayer, pero iremos m√°s all√° e intentaremos dibujar un gr√°fico. La esencia del m√©todo propuesto en mi caso es la siguiente.</font></font><br>
<br>
<ul>
<li>  ___,      </li>
<li>     (   )          .         ‚Äî    ,         . </li>
<li>  ‚Äú‚Äù  ___     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esto se puede hacer a </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trav√©s de w ... a</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trav√©s del asistente del hogar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendr√° que escribir m√°s c√≥digo que en el enfoque anterior. </font><font style="vertical-align: inherit;">Para comenzar, obtengamos estas mismas "variables". </font><font style="vertical-align: inherit;">Fuera de la caja, no tenemos la entidad "variable", pero puede usar los servicios del agente mqtt. </font><font style="vertical-align: inherit;">Enviaremos valores con el indicador retener = verdadero all√≠; esto guardar√° el valor dentro del corredor, y puede extraerlo en cualquier momento, incluso cuando el asistente de inicio se reinicie. </font><font style="vertical-align: inherit;">Hice contadores de horas y d√≠as de inmediato.</font></font><br>
<br>
<pre><code class="python hljs">- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour"</span><font></font>
  name: water_hour<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
  name: water_hour_begin<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day"</span><font></font>
  name: water_day<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
  name: water_day_begin<font></font>
  unit_of_measurement: l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda la magia ocurre en la automatizaci√≥n, que se ejecuta cada hora y cada noche, respectivamente.</font></font><br>
<br>
<pre><code class="python hljs">- id: water_new_hour<font></font>
  alias: water_new_hour<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time_pattern<font></font>
      minutes: <span class="hljs-number">0</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_hour_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true<font></font>
<font></font>
- id: water_new_day<font></font>
  alias: water_new_day<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time<font></font>
      at: <span class="hljs-string">"00:00:00"</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_day_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambas automatizaciones realizan 2 acciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El valor para el intervalo se calcula como la diferencia entre el valor inicial y el final</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizar el valor base para el pr√≥ximo intervalo</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La gr√°fica en este caso se resuelve mediante el gr√°fico de historia habitual:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ve as√≠: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/nn/ah/rpnnahsspezbcydtjmhlu6kb53w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en principio, esto ya es lo que necesita. </font><font style="vertical-align: inherit;">La ventaja de este m√©todo es que los datos se generan una vez por intervalo. </font><font style="vertical-align: inherit;">Aquellos. </font><font style="vertical-align: inherit;">solo 24 entradas por d√≠a para el gr√°fico horario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, esto todav√≠a no resuelve el problema general de una base en crecimiento. </font><font style="vertical-align: inherit;">Si quiero un horario de consumo mensual, tendr√© que almacenar datos durante al menos un a√±o. </font><font style="vertical-align: inherit;">Y dado que el asistente dom√©stico proporciona solo una configuraci√≥n para la duraci√≥n del almacenamiento de toda la base de datos, esto significa que TODOS los datos del sistema deber√°n almacenarse durante todo un a√±o. </font><font style="vertical-align: inherit;">Por ejemplo, durante un a√±o consumo 200 metros c√∫bicos de agua, lo que significa que hay 200,000 registros en la base de datos. </font><font style="vertical-align: inherit;">Y si tiene en cuenta otros sensores, la figura se vuelve indecente en absoluto.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfoque 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afortunadamente, las personas inteligentes ya han resuelto este problema escribiendo la base de datos InfluxDB. Esta base de datos est√° especialmente optimizada para almacenar datos basados ‚Äã‚Äãen el tiempo y es ideal para almacenar valores de diferentes sensores. El sistema tambi√©n proporciona un lenguaje de consulta similar a SQL que le permite seleccionar valores de la base de datos y luego agregarlos de varias maneras. Finalmente, se pueden almacenar diferentes datos en diferentes momentos. Por ejemplo, las lecturas que cambian con frecuencia, como la temperatura o la humedad, se pueden almacenar durante solo un par de semanas, mientras que las lecturas diarias del consumo de agua se pueden almacenar durante todo un a√±o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de InfluxDB, las personas inteligentes tambi√©n inventaron Grafana, un sistema de gr√°ficos basado en datos de InfluxDB. </font><font style="vertical-align: inherit;">Grafana puede dibujar diferentes tipos de gr√°ficos, personalizarlos en detalle y, lo que es m√°s importante, estos gr√°ficos se pueden "pegar" en el asistente de inicio de Lovelace-UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insp√≠rate </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los art√≠culos describen en detalle el proceso de instalaci√≥n y conexi√≥n de InfluxDB y Grafana al asistente dom√©stico. </font><font style="vertical-align: inherit;">Me enfocar√© en resolver mi problema espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, antes que nada, comencemos a sumar el valor del contador en influxDB. </font><font style="vertical-align: inherit;">Una parte de la configuraci√≥n del asistente para el hogar (en este ejemplo, me divertir√© no solo con agua fr√≠a, sino tambi√©n con agua caliente):</font></font><br>
<br>
<pre><code class="python hljs">influxdb:<font></font>
  host: localhost<font></font>
  max_retries: <span class="hljs-number">3</span><font></font>
  default_measurement: state<font></font>
  database: homeassistant<font></font>
  include:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desactive el almacenamiento de los mismos datos en la base de datos interna del asistente dom√©stico para no volver a inflarlos:</font></font><br>
<br>
<pre><code class="python hljs">recorder:<font></font>
  purge_keep_days: <span class="hljs-number">10</span>
  purge_interval: <span class="hljs-number">1</span><font></font>
  exclude:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora vamos a la consola InfluxDB y configuramos nuestra base de datos. En particular, debe configurar cu√°nto tiempo se almacenar√°n estos o esos datos. Esto est√° regulado por el llamado pol√≠tica de retenci√≥n: es similar a las bases de datos dentro de la base de datos principal, y cada base de datos interna tiene su propia configuraci√≥n. Por defecto, todos los datos se almacenan en una pol√≠tica de retenci√≥n llamada autogen, estos datos se almacenar√°n durante una semana. Me gustar√≠a que los datos por hora se almacenen durante un mes, los semanales durante un a√±o y los mensuales nunca deber√≠an eliminarse en absoluto. Crear una pol√≠tica de retenci√≥n adecuada</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"month"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">30</span>d <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"year"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">52</span>w <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"infinite"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> INF <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, de hecho, el truco principal es la agregaci√≥n de datos mediante consultas continuas. </font><font style="vertical-align: inherit;">Este es un mecanismo que inicia autom√°ticamente una consulta a intervalos espec√≠ficos, agrega datos para esta consulta y agrega el resultado a un nuevo valor. </font><font style="vertical-align: inherit;">Veamos un ejemplo (escribo en una columna para facilitar la lectura, pero de hecho tuve que ingresar este comando en una l√≠nea)</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> CONTINUOUS <span class="hljs-keyword">QUERY</span> cq_water_hourly <span class="hljs-keyword">ON</span> homeassistant 
<span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span> 
  <span class="hljs-keyword">INTO</span> homeassistant.month.water_meter_hour 
  <span class="hljs-keyword">FROM</span> homeassistant.autogen.l 
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id fill(previous) 
<span class="hljs-keyword">END</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este comando:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crea una consulta continua llamada cq_water_cold_hourly en la base de datos de homeassistant</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La solicitud se ejecutar√° cada hora (tiempo (1h))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La solicitud recuperar√° todos los datos de la medici√≥n 'a homeassistant.autogen.l (litros), incluidas las lecturas de agua fr√≠a y caliente</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los datos agregados se agrupar√°n por entity_id, que crear√° valores separados para agua fr√≠a y caliente.</font></font></li>
<li>               ,      max(value) </li>
<li>     homeassistant.month.water_meter_hour,  month   retention policy     .               entity_id     value</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por la noche o cuando no hay nadie en casa, no hay consumo de agua y, en consecuencia, tampoco hay nuevas entradas en homeassistant.autogen.l. Para evitar valores perdidos en consultas regulares, puede usar el relleno (anterior). Esto obligar√° a InfluxDB a usar el valor de la √∫ltima hora. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, la consulta continua tiene una peculiaridad: el truco de relleno (anterior) no funciona y los registros simplemente no se crean. Adem√°s, este es un problema insuperable que se ha </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discutido durante m√°s de un a√±o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Trataremos este problema m√°s tarde y dejaremos que el relleno (anterior) en consulta continua sea: no interfiere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu√© sucedi√≥ (por supuesto, debe esperar un par de horas):</font></font><br>
<br>
<pre><code class="python hljs">&gt; select * <span class="hljs-keyword">from</span> homeassistant.month.water_meter_hour group by entity_id<font></font>
...<font></font>
name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 value<font></font>
----                 -----<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370511</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370513</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370527</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370605</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370635</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370699</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370761</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370767</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370810</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370818</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370827</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370849</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370921</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que los valores en la base de datos se almacenan en UTC, por lo tanto, en esta lista difieren en 3 horas: los valores para las 7 a.m. en la salida InfluxDB corresponden a los valores para las 10 a.m. en los gr√°ficos anteriores. </font><font style="vertical-align: inherit;">Tambi√©n tenga en cuenta que entre las 2 y las 5 de la ma√±ana simplemente no hay registros: esta es la misma caracter√≠stica de la consulta continua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, el valor agregado tambi√©n es una secuencia mon√≥tonamente creciente, solo los registros son menos frecuentes, una vez por hora. </font><font style="vertical-align: inherit;">Pero esto no es un problema: podemos escribir otra consulta que produzca los datos correctos para el gr√°fico.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">difference</span>(<span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>)) 
<span class="hljs-keyword">FROM</span> homeassistant.month.water_meter_hour 
<span class="hljs-keyword">WHERE</span> entity_id=<span class="hljs-string">'water_meter_cold'</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-keyword">now</span>() <span class="hljs-number">-24</span>h 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id <font></font>
fill(previous)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descifrar√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la base de datos homeassistant.month.water_meter_hour, extraemos los datos de entity_id = 'water_meter_cold' para el √∫ltimo d√≠a (hora&gt; = ahora () -24h). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mencion√© en la secuencia homeassistant.month.water_meter_hour, pueden faltar algunas entradas. </font><font style="vertical-align: inherit;">Regeneraremos estos datos ejecutando una consulta con el tiempo GROUP BY (1h). </font><font style="vertical-align: inherit;">Este tiempo de relleno (anterior) funcionar√° seg√∫n sea necesario, generando los datos faltantes (la funci√≥n tomar√° el valor anterior)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo m√°s importante en esta solicitud es la funci√≥n de diferencia, que calcular√° la diferencia entre las marcas por hora. </font><font style="vertical-align: inherit;">Por s√≠ solo, no funciona y requiere una funci√≥n agregada. </font><font style="vertical-align: inherit;">Deje que sea el max () utilizado antes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado de la ejecuci√≥n se ve as√≠</font></font><br>
<br>
<pre><code class="python hljs">name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 difference<font></font>
----                 ----------<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">2</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T03:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T04:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">14</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">78</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">30</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">64</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">62</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">6</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">43</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">8</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">9</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">22</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">72</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De 2 a 5 de la ma√±ana (UTC) no hubo consumo. </font><font style="vertical-align: inherit;">Sin embargo, la consulta devolver√° el mismo valor de consumo debido al relleno (anterior), y la funci√≥n de diferencia restar√° este valor de s√≠ misma y obtendr√° 0 en la salida, que en realidad es necesaria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo √∫nico que queda es construir un horario. </font><font style="vertical-align: inherit;">Para hacer esto, abra Grafana, abra algunos paneles existentes (o cree un nuevo), cree un nuevo panel. </font><font style="vertical-align: inherit;">La configuraci√≥n del gr√°fico ser√° as√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/q0/c8/uxq0c834j1eq4h7ey4qazk4cc7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mostrar√© datos sobre agua fr√≠a y caliente en un gr√°fico. </font><font style="vertical-align: inherit;">La solicitud es exactamente la misma que describ√≠ anteriormente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los par√°metros de visualizaci√≥n se configuran de la siguiente manera. </font><font style="vertical-align: inherit;">Tendr√© un gr√°fico con l√≠neas, que va por las escaleras. </font><font style="vertical-align: inherit;">Explicar√© el par√°metro Stack justo debajo. </font><font style="vertical-align: inherit;">Hay un par de opciones de visualizaci√≥n m√°s abajo, pero no son tan interesantes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/rd/5x/bird5xpaysckqtigczjerbp5mti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para agregar el horario recibido al asistente de hogar que necesita:</font></font><br>
<br>
<ul>
<li>    . -         </li>
<li>     ,    share</li>
<li>      embed</li>
<li>  current time range ‚Äî       URL </li>
<li>  .     light</li>
<li>  URL    lovelace-UI</li>
</ul><br>
<pre><code class="python hljs">      - type: iframe<font></font>
        id: graf_water_hourly<font></font>
        url: <span class="hljs-string">"http://192.168.10.200:3000/d-solo/rZARemQWk/water?orgId=1&amp;panelId=2&amp;from=now-2d&amp;to=now&amp;theme=light"</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que el intervalo de tiempo (√∫ltimos 2 d√≠as) se establece aqu√≠, y no en la configuraci√≥n del tablero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El gr√°fico se ve as√≠. No he usado agua caliente en los √∫ltimos 2 d√≠as, por lo que solo se dibuja un gr√°fico de agua fr√≠a. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/e7/hk/mse7hkckiwjjm_b5ppli9dakd2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No decid√≠ por m√≠ mismo qu√© horario me gusta m√°s, una l√≠nea de paso o barras reales. Por lo tanto, simplemente dar√© un ejemplo de un gr√°fico de consumo diario, solo que esta vez en columnas. Las solicitudes se crean de la misma manera que se describe anteriormente. Los par√°metros de visualizaci√≥n son los siguientes: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/se/jt/nssejtoburugxcldedjuj0cvywm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este gr√°fico se ve as√≠: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zd/yl/hj/zdylhjfnrdonlnkezr3n4dlwdwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, sobre el par√°metro Stack. En este gr√°fico, se dibuja una columna de agua fr√≠a encima de una columna de agua caliente. La altura total corresponde al consumo total de agua fr√≠a y caliente para el per√≠odo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los gr√°ficos mostrados son din√°micos. Puede pasar el mouse sobre un punto de inter√©s y ver los detalles y el valor en un punto espec√≠fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, un par de cucharas de alquitr√°n no pudieron. En el gr√°fico de barras (en contraste con el gr√°fico con l√≠neas de paso), la mitad de la barra no est√° en el medio del d√≠a, sino a las 00:00. Aquellos. la mitad izquierda de la columna se dibuja en lugar del d√≠a anterior. Entonces, los gr√°ficos para el s√°bado y el domingo se dibujan un poco a la izquierda que la zona azulada. Hasta que descubr√≠ c√≥mo ganarlo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro problema es la incapacidad de trabajar correctamente a intervalos mensuales. </font><font style="vertical-align: inherit;">El hecho es que la duraci√≥n de la hora / d√≠a / semana es fija, pero la duraci√≥n del mes es diferente cada vez. </font><font style="vertical-align: inherit;">InfluxDB solo puede funcionar a intervalos regulares. </font><font style="vertical-align: inherit;">Hasta ahora, mi cerebro era suficiente para establecer un intervalo fijo de 30 d√≠as. </font><font style="vertical-align: inherit;">S√≠, el gr√°fico flotar√° un poco durante el a√±o y las columnas no se corresponder√°n exactamente con los meses. </font><font style="vertical-align: inherit;">Pero dado que esto es interesante para m√≠ simplemente como un dispositivo de visualizaci√≥n, entonces estoy de acuerdo con eso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veo al menos dos soluciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puntuaci√≥n en horarios mensuales y l√≠mite semanal. </font><font style="vertical-align: inherit;">52 bares semanales para el a√±o se ven bastante bien</font></font></li>
<li>     ‚Ññ2,       .     .          ‚Äî    .</li>
</ul><br>
<br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No s√© por qu√©, pero estoy trabajando en ese tipo de gr√°ficos. Muestran que la vida est√° en pleno apogeo y que todo est√° cambiando. Ayer fue mucho, hoy no es suficiente, ma√±ana ser√° otra cosa. Queda por trabajar con los hogares en el tema del consumo. Pero incluso con los apetitos actuales, solo una cifra grande e incomprensible en el pago ya se est√° convirtiendo en una imagen bastante clara del consumo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de los casi 20 a√±os de carrera como programador, pr√°cticamente no me cruc√© con las bases de datos. Por lo tanto, la instalaci√≥n de una base de datos externa parec√≠a algo tan abstruso e incomprensible. Todo cambi√≥ con el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo mencionado anteriormente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : result√≥ que arruinar una herramienta adecuada se realiza en un par de clics, y con una herramienta especializada la tarea de graficar se vuelve un poco m√°s f√°cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el titular, mencion√© el consumo de electricidad. </font><font style="vertical-align: inherit;">Lamentablemente, por el momento no puedo dar un solo gr√°fico. </font><font style="vertical-align: inherit;">Un contador SDM120 est√° muerto y el otro tiene errores al acceder a trav√©s de Modbus. </font><font style="vertical-align: inherit;">Sin embargo, esto no afecta el tema de este art√≠culo: los gr√°ficos se construir√°n de la misma manera que para el agua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo, cit√© los enfoques que prob√© yo mismo. </font><font style="vertical-align: inherit;">Seguramente hay algunas otras formas de organizar la recopilaci√≥n y visualizaci√≥n de datos que no conozco. </font><font style="vertical-align: inherit;">Cu√©ntamelo en los comentarios, ser√° muy interesante para m√≠. </font><font style="vertical-align: inherit;">Estar√© encantado de cr√≠ticas constructivas y nuevas ideas. </font><font style="vertical-align: inherit;">Espero que el material presentado tambi√©n ayude a alguien.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492298/index.html">Pol√≠gonos Otro Mundo: PC IBM</a></li>
<li><a href="../es492302/index.html">Soporte inteligente con tel√©fonos inteligentes para probadores: un proyecto de inicio del acelerador de la Universidad ITMO</a></li>
<li><a href="../es492306/index.html">Lidars en CES</a></li>
<li><a href="../es492308/index.html">Las neuronas y su modelado.</a></li>
<li><a href="../es492312/index.html">Avro serializaci√≥n en Kafka</a></li>
<li><a href="../es492318/index.html">C√≥mo afecta el coronavirus a la industria de TI</a></li>
<li><a href="../es492320/index.html">Covid-19, su sociedad y usted en t√©rminos de ciencia de datos</a></li>
<li><a href="../es492322/index.html">Raspberry Pi + Fedora (aarch64) = punto de acceso Wi-Fi (o un enrutador de frambuesa con un sombrero azul)</a></li>
<li><a href="../es492326/index.html">An√°lisis de la popularidad de los videos de YouTube de los participantes de Eurovisi√≥n 2020</a></li>
<li><a href="../es492328/index.html">Integraci√≥n continua e implementaci√≥n de aplicaciones de escritorio con GitHub Actions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>