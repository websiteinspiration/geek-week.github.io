<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✈️ 🐫 🚑 マイクロコントローラー（stm32）のプロジェクトにLuaインタープリターを組み込みます 🤾🏾 👇🏾 👍🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="かなり大きなアプリケーションでは、プロジェクトの重要な部分はビジネスロジックです。プログラムのこの部分をコンピューターでデバッグし、それをマイクロコントローラーのプロジェクトに埋め込むと便利です。この部分は、デバッグなしで意図したとおりに実行されることが期待されます（理想的なケース）。
 
 マイク...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マイクロコントローラー（stm32）のプロジェクトにLuaインタープリターを組み込みます</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459602/"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
かなり大きなアプリケーションでは、プロジェクトの重要な部分はビジネスロジックです。</font><font style="vertical-align: inherit;">プログラムのこの部分をコンピューターでデバッグし、それをマイクロコントローラーのプロジェクトに埋め込むと便利です。この部分は、デバッグなしで意図したとおりに実行されることが期待されます（理想的なケース）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロコントローラー用のほとんどのプログラムはC / C ++で記述されているため、これらの目的には通常、抽象クラスが使用され、低レベルのエンティティへのインターフェイスを提供します（プロジェクトがCのみを使用して記述されている場合、関数ポインター構造がよく使用されます）。このアプローチは、鉄を介して必要なレベルの抽象化を提供しますが、プロジェクトを絶えず再コンパイルして、その後、マイクロコントローラーの不揮発性メモリを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きな</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ファームウェア</font></a><font style="vertical-align: inherit;">ファイルでプログラミングする必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、別の方法があります。デバイス自体でビジネスロジックをリアルタイムでデバッグしたり、マイクロコントローラーファームウェアにこのコードを含めなくても、外部メモリから直接作業スクリプトを読み込んだりできるスクリプト言語を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はスクリプト言語としてLuaを選択しました。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜルア？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロコントローラーのプロジェクトに埋め込むことができるいくつかのスクリプト言語があります。いくつかの単純なBASICのような、PyMite、Pawn ...それぞれに長所と短所がありますが、その説明はこの記事で説明する問題のリストには含まれていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特にluaの良い点について簡単に説明すると、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Luaの60分」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という記事に記載されています</font><font style="vertical-align: inherit;">。この記事は私に多くのインスピレーションを与えてくれました。この問題をより詳細に研究するために、言語Robert著者のJeruzalimsky「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programming in Lua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font><font style="vertical-align: inherit;">の公式ガイドブックを読みました</font><font style="vertical-align: inherit;">（公式のロシア語翻訳で入手可能）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eLuaプロジェクトについても触れたいと思います。</font><font style="vertical-align: inherit;">私の場合、マイクロコントローラの周辺機器とデバイスボード上にあるその他の必要な周辺機器の両方とやり取りするための既製のソフトウェア低レベル層がすでにあります。</font><font style="vertical-align: inherit;">したがって、私はこのプロジェクトを検討しませんでした（Luaコアをマイクロコントローラーの周辺に接続するためのレイヤーを提供することが認識されているため）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaが組み込まれるプロジェクトについて</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伝統的に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サンドボックスプロジェクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は実験のフィールドの品質として使用されます</font><font style="vertical-align: inherit;">（以下で説明する必要なすべての改善を含む、すでに統合されたluaを使用したコミットへのリンク）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトは、1 MBの不揮発性と192 KBのRAMを備えたstm32f405rgt6マイクロコントローラーに基づいています（現在、合計容量が128 KBの古い2ブロックが使用されています）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトには、ハードウェア周辺機器インフラストラクチャをサポートするFreeRTOSリアルタイムオペレーティングシステムがあります。</font><font style="vertical-align: inherit;">タスク、セマフォ、およびその他のFreeRTOSオブジェクトのすべてのメモリは、リンク段階で静的に割り当てられます（RAMの.bss領域にあります）。</font><font style="vertical-align: inherit;">すべてのFreeRTOSエンティティ（セマフォ、キュー、タスクスタックなど）は、クラスのプライベート領域にあるグローバルオブジェクトの一部です。</font><font style="vertical-align: inherit;">ただし、FreeRTOSヒープは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの関数に必要</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">をサポートするために割り当てられており、これを使用して再定義されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MicroSD（FatFS）カード、およびデバッグUART（115200、8N1）を操作するための上げられたAPIがあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaをプロジェクトの一部として使用するロジックについて</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックをデバッグする目的で、コマンドはUARTを介して送信され、（別のオブジェクトとして）完成した行（文字「\ n」+ 0ターミネーターで終わる）にパックされ、lua-machineに送信されると想定されます。</font><font style="vertical-align: inherit;">実行に失敗した場合は、printfを使用して出力します（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はプロジェクトに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">関与</font></a><font style="vertical-align: inherit;">して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">い</font></a><font style="vertical-align: inherit;">たため</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">ロジックがデバッグされると、microSDカード（この記事の資料には含まれていません）のファイルから最終的なビジネスロジックファイルをダウンロードできます。</font><font style="vertical-align: inherit;">また、Luaのデバッグを目的として、マシンは個別のFreeRTOSスレッド内で実行されます（将来、デバッグ対象のビジネスロジックスクリプトごとに個別のスレッドが割り当てられ、その環境で実行されます）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトにluaサブモジュールを含める</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github上のプロジェクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">公式ミラーが</font></a><font style="vertical-align: inherit;"> luaライブラリのソースとして使用されます</font><font style="vertical-align: inherit;">（私のプロジェクトもそこに投稿されているため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式サイト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から直接ソースを使用できます</font><font style="vertical-align: inherit;">）。プロジェクトには、サブモジュールをプロジェクトの一部としてアセンブルするための確立されたシステムがあり、サブモジュールごとに個別のCMakeListがあるため、</font><font style="vertical-align: inherit;">このフォークとCMakeListを含めて、単一のビルドスタイルを維持する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のサブモジュール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、次のサブモジュールコンパイルフラグ（</font><font style="vertical-align: inherit;">メインプロジェクトの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブモジュール構成ファイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から取得）を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">、luaリポジトリのソースを静的ライブラリとして構築します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">SET</span>(C_COMPILER_FLAGS <span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span>)
<span class="hljs-keyword">SET</span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用するプロセッサの仕様のフラグ（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルートCMakeListsで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定</font><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">SET</span>(HARDWARE_FLAGS<font></font>
        -mthumb;<font></font>
        -mcpu=cortex-m4;<font></font>
        -mfloat-abi=hard;<font></font>
        -mfpu=fpv4-sp-d16;)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルートCMakeListsがdouble値を使用できないようにする定義を指定する必要があることに注意することが重要です（マイクロコントローラーはdoubleのハードウェアサポートがないため、floatのみです）。</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">add_definitions</span>(-DLUA_32BITS)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、それはこのライブラリをアセンブルする必要性についてリンカに通知し、最終的なプロジェクトのレイアウトに結果を含めるためだけに残っています：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトをluaライブラリーにリンクするためのCMakeListsプロット</font></font></b><div class="spoiler_text"><pre><code class="cmake hljs"><span class="hljs-keyword">add_subdirectory</span>(<span class="hljs-variable">${CMAKE_SOURCE_DIR}</span>/bsp/submodules/module_lua)<font></font>
...<font></font>
<span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">${PROJECT_NAME}</span>.elf PUBLIC
        <span class="hljs-comment"># -Wl,--start-group      </span>
        <span class="hljs-comment">#      .</span>
        <span class="hljs-comment">#  Lua    ,     </span>
        <span class="hljs-comment">#  .</span>
        <span class="hljs-string">"-Wl,--start-group"</span><font></font>
       ..._...<font></font>
        MODULE_LUA<font></font>
       ..._...<font></font>
        <span class="hljs-string">"-Wl,--end-group"</span>)</code></pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリを操作するための関数の定義</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lua自体はメモリで動作しないため、この責任はユーザーに移されます。ただし、バンドルされた</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lauxlib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ</font><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そこ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から</font><i><font style="vertical-align: inherit;">luaL_newstate</font></i><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">を使用する場合、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l_alloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は</font><font style="vertical-align: inherit;">メモリシステムとして</font><i><font style="vertical-align: inherit;">バインドさ</font></i><font style="vertical-align: inherit;">れます。次のように定義されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">l_alloc</span> <span class="hljs-params">(<span class="hljs-keyword">void</span> *ud, <span class="hljs-keyword">void</span> *ptr, <span class="hljs-keyword">size_t</span> osize, <span class="hljs-keyword">size_t</span> nsize)</span> </span>{<font></font>
  (<span class="hljs-keyword">void</span>)ud; (<span class="hljs-keyword">void</span>)osize;  <span class="hljs-comment">/* not used */</span>
  <span class="hljs-keyword">if</span> (nsize == <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">free</span>(ptr);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">realloc</span>(ptr, nsize);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の冒頭で述べたように、プロジェクトはすでに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc関数</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を</font><font style="vertical-align: inherit;">オーバーライドして</font><font style="vertical-align: inherit;">いますが、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数はありません</font><font style="vertical-align: inherit;">。これを修正する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FreeRTOSヒープを操作するための標準的なメカニズムでは、プロジェクトで使用されるheap_4.cファイルには、以前に割り当てられたメモリブロックのサイズを変更する機能がありません。この点で、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freeに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基づい</font><font style="vertical-align: inherit;">て実装する</font><font style="vertical-align: inherit;">必要が</font><font style="vertical-align: inherit;">あり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来、メモリ割り当てスキームを（別のheap_x.cファイルを使用して）変更できるようになるため、現在のスキーム（heap_4.c）の内部を使用せずに、より高レベルのアドインを作成することにしました。効果は低いですが。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メソッドを考慮することは重要です</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、古いブロック（存在する場合）を削除して新しいブロックを作成するだけでなく、古いブロックから新しいブロックにデータを移動します。さらに、古いブロックに新しいブロックよりも多くのデータがある場合、新しいブロックは古いブロックでいっぱいになり、残りのデータは破棄されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この事実が考慮されていない場合、マシンはそのようなスクリプトを " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a = 3 \ n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">という行から3回実行でき</font><font style="vertical-align: inherit;">、その後ハードフォールトに陥ります。この問題は、ハードフォールトハンドラー内のレジスターの残差イメージを調査した後に解決できます。インタープリターコードとそのライブラリーの腸内のテーブルを拡張しようとした後にクラッシュが発生したことがわかります。 「</font><i><font style="vertical-align: inherit;">印刷」テストの</font></i><font style="vertical-align: inherit;">ようなスクリプトを呼び出す場合</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"、動作はファームウェアファイルのアセンブル方法によって異なります（つまり、動作は定義されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古いブロックから新しいブロックにデータをコピーするには、古いブロックのサイズを知る必要があります。FreeRTOSheap_4.c（他のように）ヒープを操作するためのメソッドを提供するファイル）は、このためのAPIを提供しないので、自分で追加する必要があります</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。vPortFree</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を</font><i><font style="vertical-align: inherit;">ベース</font></i><font style="vertical-align: inherit;">として、</font><font style="vertical-align: inherit;">その機能を次の形式に切り取りました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPortGetSizeBlock関数コード</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vPortGetSizeBlock</span> <span class="hljs-params">(<span class="hljs-keyword">void</span> *pv)</span> </span>{
    <span class="hljs-keyword">uint8_t</span> *puc = (<span class="hljs-keyword">uint8_t</span> *)pv;<font></font>
    BlockLink_t *pxLink;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pv != <span class="hljs-literal">NULL</span>) {<font></font>
        puc -= xHeapStructSize;<font></font>
        pxLink = (BlockLink_t *)puc;<font></font>
        configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number">0</span>);<font></font>
        configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal">NULL</span>);
        <span class="hljs-keyword">return</span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今では小さく、</font><i><font style="vertical-align: inherit;">malloc</font></i><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">free</font></i><font style="vertical-align: inherit;">、および</font><i><font style="vertical-align: inherit;">vPortGetSizeBlockに</font></i><font style="vertical-align: inherit;">基づいて</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">書き込み</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc、free、およびvPortGetSizeBlockに基づいて実装コードを再割り当てします</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">realloc</span> <span class="hljs-params">(<span class="hljs-keyword">void</span> *ptr, <span class="hljs-keyword">size_t</span> new_size)</span> </span>{
    <span class="hljs-keyword">if</span> (ptr == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(new_size);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">void</span>* p = <span class="hljs-built_in">malloc</span>(new_size);
    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> p;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">size_t</span> old_size = vPortGetSizeBlock(ptr);
    <span class="hljs-keyword">size_t</span> cpy_len = (new_size &lt; old_size)?new_size:old_size;
    <span class="hljs-built_in">memcpy</span>(p, ptr, cpy_len);
    <span class="hljs-built_in">free</span>(ptr);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> p;<font></font>
}</code></pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stdoutを使用するためのサポートを追加する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
公式の説明からわかるように、luaインタープリター自体はI / Oを処理できません。</font><font style="vertical-align: inherit;">これらの目的のために、標準ライブラリの1つが接続されています。</font><font style="vertical-align: inherit;">出力には</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stdout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリームを使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">標準ライブラリ</font><font style="vertical-align: inherit;">の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">luaopen_io</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は、ストリームへの接続を担当します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">printf</font></a><font style="vertical-align: inherit;">とは異なり</font><font style="vertical-align: inherit;">）</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stdoutでの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作業をサポート</font><font style="vertical-align: inherit;">するには、</font><i><font style="vertical-align: inherit;">fwrite</font></i><font style="vertical-align: inherit;">関数をオーバーライドする必要があります</font><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">前の記事で</font></a><font style="vertical-align: inherit;">説明した関数に基づいて再定義しました</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fwrite関数</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">fwrite</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">size_t</span> count, FILE *stream)</span> </span>{<font></font>
    stream = stream;<font></font>
    <span class="hljs-keyword">size_t</span> len = size * count;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *s = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*&gt;(buf);<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
        <span class="hljs-keyword">if</span> (_write_char((s[i])) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> len;<font></font>
}</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その定義</font><font style="vertical-align: inherit;">がないと、lua </font><font style="vertical-align: inherit;">の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">印刷</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font><font style="vertical-align: inherit;">は正常に実行されますが、出力はありません。</font><font style="vertical-align: inherit;">さらに、マシンのLuaスタックにエラーはありません（正式に関数が正常に実行されたため）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数に加えて、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fflush</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数が必要になります</font><font style="vertical-align: inherit;">（対話モードが機能するには、これ</font><i><font style="vertical-align: inherit;">については</font></i><font style="vertical-align: inherit;">後で</font><i><font style="vertical-align: inherit;">説明し</font></i><font style="vertical-align: inherit;">ます）。</font><font style="vertical-align: inherit;">この関数はオーバーライドできないため、少し異なる名前を付ける必要があります。</font><font style="vertical-align: inherit;">この関数は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwrite</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の</font><i><font style="vertical-align: inherit;">簡略</font></i><font style="vertical-align: inherit;">版であり、</font><font style="vertical-align: inherit;">現在バッファーにあるものを、その後のクリーニング（追加のキャリッジ転送なし）で送信するためのものです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mc_fflush関数</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">mc_fflush</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">uint32_t</span> len = buf_p;<font></font>
    buf_p = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (uart_1.tx(tx_buf, len, <span class="hljs-number">100</span>) != mc_interfaces::res::ok) {<font></font>
        errno = EIO;<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアルポートから文字列を取得する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
luaマシンの文字列を取得するために、私は単純なuart-terminalクラスを作成することにしました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアルポートでバイトごとにデータを受信します（割り込み中）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受信したバイトをキューに追加し、ストリームはそこから受信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイトストリームで、これが改行でない場合は、到着した形式で送り返されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">改行が到着した場合（ ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '）、2バイトの端末改行が送信されます（ " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ n \ r</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応答を送信した後、到着したバイトのハンドラー（行レイアウトオブジェクト）が呼び出されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字削除キーの押下を制御します（ターミナルウィンドウからサービス文字が削除されないようにします）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースへのリンク：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UARTクラスのインターフェースは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART基本クラスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uart_terminalクラス</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの一部としてクラスオブジェクトを作成し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このオブジェクトが正しく機能するためには、割り込みからFreeRTOS関数を操作するために、許容範囲内のUART割り込みに優先度を割り当てる必要があることに注意してください。</font><font style="vertical-align: inherit;">そうしないと、デバッグが難しい興味深いエラーが発生する可能性があります。</font><font style="vertical-align: inherit;">現在の例</font><font style="vertical-align: inherit;">では、割り込みに関する次のオプション</font><font style="vertical-align: inherit;">が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeRTOSConfig.h</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルに</font><font style="vertical-align: inherit;">設定さ</font><font style="vertical-align: inherit;">れています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeRTOSConfig.hの設定</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configPRIO_BITS 4</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configKERNEL_INTERRUPT_PRIORITY 0XF0</span>
<span class="hljs-comment">//   FreeRTOS API  </span>
<span class="hljs-comment">//   0x8 - 0xF.</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクト自体では、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nvic</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス</font><i><font style="vertical-align: inherit;">オブジェクト</font></i><font style="vertical-align: inherit;">は0x9割り込みの優先度を設定します。これは有効範囲に含まれます（nvicクラスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">てい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaマシンのストリング形成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
uart_terminalオブジェクトから受信したバイトは、単純なクラスserial_cliのインスタンスに転送されます。これは、文字列を編集してlua-machineが実行されるスレッドに直接転送するための最小限のインターフェースを提供します（コールバック関数を呼び出すことにより）。</font><font style="vertical-align: inherit;">文字 '\ r'を受け入れると、コールバック関数が呼び出されます。</font><font style="vertical-align: inherit;">この関数は、ラインをそれ自体にコピーし、コントロールを「解放」する必要があります（呼び出し中に新しいバイトの受信がブロックされるため、これは正しく優先順位付けされたストリームと十分に低いUART速度の問題ではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースへのリンク：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> serial_cli記述ファイル</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの一部としてクラスオブジェクトを作成し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクラスは、255文字より長い文字列は無効であると見なして破棄することに注意することが重要です。</font><font style="vertical-align: inherit;">これは意図的なものです。これは、luaインタープリターを使用すると、ブロックの終わりを待って行ごとに構成を入力できるためです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列をLuaインタープリターに渡し、その実行</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luaインタープリター自体は、ブロックコードを1行ずつ受け入れる方法がわからないため、ブロック全体を単独で実行します。ただし、コンピューターにLuaをインストールし、インタープリターをインタラクティブモードで実行すると、入力が対応する表記で行ごとに実行され、ブロックがまだ完了していないことがわかります。対話モードは標準パッケージで提供されるものなので、そのコードを見ることができます。これは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lua.c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルにあります</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doREPL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">とそれが使用するすべてのものに</font><font style="vertical-align: inherit;">興味があり</font><font style="vertical-align: inherit;">ます。自転車を思い付かないようにするために、プロジェクトでインタラクティブモードの関数を取得するために、このコードを別のクラスに</font><i><font style="vertical-align: inherit;">移植し</font></i><font style="vertical-align: inherit;">ました。これには、元の関数の名前で</font><i><font style="vertical-align: inherit;">lua_repl</font></i><font style="vertical-align: inherit;">という名前を付け</font><i><font style="vertical-align: inherit;">まし</font></i><font style="vertical-align: inherit;">た</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、printfを使用して情報をコンソールに出力し、パブリック</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add_lua_string</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">を使用して、上記のserial_cliクラスのオブジェクトから取得した文字列を追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参照：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスの説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lua_repl </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font><font style="vertical-align: inherit;">;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じデバイス内でいくつかのインタラクティブモードを指定する必要がないため、クラスはシングルトンマイヤーズパターンに従って作成されます。クラスlua_replのオブジェクトは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でクラスserial_cliのオブジェクトからデータを受け取ります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトにはグローバルオブジェクトの初期化とサービスのための統合システムがすでにあるので、クラスlua_replのオブジェクトへのポインターは、グローバルクラス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレーヤー:: base </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hereの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトに渡され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">player ::基本</font></a><font style="vertical-align: inherit;">クラスのオブジェクトの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここで</font></a><font style="vertical-align: inherit;">宣言され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。これはmainからも呼び出され</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">）では、</font><i><font style="vertical-align: inherit;">init</font></i><font style="vertical-align: inherit;">メソッドが呼び出されます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeRTOS 3のタスク優先度を持つクラスlua_replのオブジェクト（プロジェクトでは、1〜4のタスク優先度を割り当てることができます。1が最低の優先度で、4が最高です）。</font><font style="vertical-align: inherit;">初期化が成功すると、グローバルクラスがFreeRTOSスケジューラを開始し、インタラクティブモードがその作業を開始します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移植の問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、マシンのLuaポートで発生した問題のリストです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数に値を割り当てるための2-3の単一行スクリプトが実行され、すべてがハードフォールトに分類されます</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題はreallocメソッドにありました。</font><font style="vertical-align: inherit;">ブロックを再選択するだけでなく、（上記のように）古いブロックの内容をコピーすることも必要です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値を出力しようとすると、インタープリターがハードフォールトに陥る</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題を検出することはすでにより困難でしたが、結局、snprintfが印刷に使用されていることがわかりました。</font><font style="vertical-align: inherit;">luaは値をdouble（またはこの場合はfloat）で格納するため、浮動小数点サポートを備えたprintf（およびその派生物）が必要です（printfの複雑さについては</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で書き</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不揮発性（フラッシュ）メモリの要件</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luaマシンをプロジェクトに統合するために割り当てる必要がある不揮発性（フラッシュ）メモリの量を判断するために行った測定の一部を次に示します。</font><font style="vertical-align: inherit;">コンパイルはgcc-arm-none-eabi-8-2018-q4-majorを使用して実行されました。</font><font style="vertical-align: inherit;">Lua 5.4のバージョンが使用されました。</font><font style="vertical-align: inherit;">以下の測定では、「Luaなし」という語句は、インタープリターを含まず、そのインタープリターとそのライブラリーとの相互作用の方法、およびプロジェクト内のlua_replクラスのオブジェクトを意味します。</font><font style="vertical-align: inherit;">すべての低レベルエンティティ（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwrite</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数のオーバーライドを含む</font><font style="vertical-align: inherit;">）はプロジェクトに残ります。</font><font style="vertical-align: inherit;">FreeRTOSヒープサイズは1024 * 25バイトです。</font><font style="vertical-align: inherit;">残りはグローバルプロジェクトエンティティによって占められています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果の要約表は次のとおりです（すべてのサイズはバイト単位）。</font></font><br>
<table border="1">
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドオプション</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルアなし</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コアのみ</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaとベースライブラリ</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリbase、コルーチン、テーブル、文字列を含むLua</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">luaL_openlibs</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0 -g3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">103028</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">220924</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">236124</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">262652</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">308372</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1 -g3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">74940</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">144732</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">156916</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">174452</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">213068</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Os -g0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">71172</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">134228</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">145756</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">161428</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">198400</font></font></td>
</tr>
</tbody></table><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM要件</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAMの消費量はタスクに完全に依存するため、異なるライブラリセットを使用してマシンをオンにした直後に、消費されたメモリの概要表を示します（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">print（collectgarbage（ "count"）* 1024</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドで表示され</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">）。</font></font><br>
<table border="1">
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用されるRAM</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaとベースライブラリ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4809</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリbase、コルーチン、テーブル、文字列を含むLua</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6407</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">luaL_openlibs</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12769</font></font></td>
</tr>
</tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのライブラリを使用する場合、必要なRAMのサイズは以前のセットと比較して大幅に増加します。</font><font style="vertical-align: inherit;">ただし、アプリケーションのかなりの部分で使用する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、Luaマシンが実行されるタスクスタックにも4 kbが割り当てられます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに使用</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトでマシンを完全に使用するには、プロジェクトのハードウェアまたはサービスオブジェクトのビジネスロジックコードが必要とするすべてのインターフェースをさらに記述する必要があります。</font><font style="vertical-align: inherit;">ただし、これは別の記事のトピックです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、Luaマシンをマイクロコントローラーのプロジェクトに接続する方法と、ターミナルのコマンドラインから直接ビジネスロジックを試すことができる本格的なインタラクティブインタープリターを起動する方法について説明しました。</font><font style="vertical-align: inherit;">さらに、マイクロコントローラーのハードウェアの要件は、Luaマシンのさまざまな構成で考慮されました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459590/index.html">Wavesブロックチェーン上の分散型オープンソースアフィリエイトプログラム</a></li>
<li><a href="../ja459592/index.html">すべてを試した人のための3つの時間管理のヒント。</a></li>
<li><a href="../ja459594/index.html">ノート間の読み取り：音楽内のデータ転送システム</a></li>
<li><a href="../ja459596/index.html">iOSダイジェスト9（6月28日-7月11日）</a></li>
<li><a href="../ja459598/index.html">SELinuxのよくある質問（FAQ）</a></li>
<li><a href="../ja459604/index.html">電報-ボット| フルメニュー</a></li>
<li><a href="../ja459606/index.html">分散型ソーシャルネットワーク</a></li>
<li><a href="../ja459610/index.html">これらの危険なルーター：最近のネットワーク機器の最も大規模なハッキングと保護方法</a></li>
<li><a href="../ja459612/index.html">クアルコムが20年近く連続してモバイル業界を席巻した方法</a></li>
<li><a href="../ja459614/index.html">ロボット鴨が水田をかき立てる</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>