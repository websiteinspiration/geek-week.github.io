<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄüèæ üßïüèΩ ‚èπÔ∏è WAL-G: PostgreSQL Database Backups and Recovery üëá ‚òëÔ∏è üõÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has long been known that making backups in SQL dumps (using pg_dump or pg_dumpall ) is not a good idea. To back up PostgreSQL, it is better to use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: PostgreSQL Database Backups and Recovery</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It has long been known that making backups in SQL dumps (using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is not a good idea. To back up PostgreSQL, it is better to use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">, which makes a binary copy of WAL logs. But when you begin to study the whole process of creating a backup and restoration, you will understand that you need to write at least a couple of tricycles so that all this works and does not cause you pain both from above and from below. In order to alleviate suffering, WAL-G was developed. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a tool written in Go for backing up and restoring PostgreSQL databases ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and more recently, MySQL / MariaDB, MongoDB, and FoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">It supports working with Amazon S3 storages (and analogues, for example, Yandex Object Storage), as well as Google Cloud Storage, Azure Storage, Swift Object Storage and just with the file system. </font><font style="vertical-align: inherit;">The whole setup is reduced to simple steps, but due to the fact that articles about it are scattered on the Internet, there is no complete how-to manual that would include all the steps from and to (there are several posts on Habr√©, but many points are missing there).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="postgresql backup"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is written primarily to systematize your knowledge. </font><font style="vertical-align: inherit;">I am not a DBA and somewhere I can express it in a philistine-developmental language, so any corrections are welcome! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separately, I note that all of the following is relevant and verified for PostgreSQL 12.3 on Ubuntu 18.04, all commands must be executed as a privileged user.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the time of this writing, the stable version of WAL-G is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v0.2.15 (March 2020)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We will use it ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">but if you want to assemble it yourself from the master branch, then the github repository has all the instructions for this</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">To download and install you need to do:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, you must first configure WAL-G, and then PostgreSQL itself.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G Setup</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For an example of backup storage, Amazon S3 will be used ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">because it is closer to my servers and its use is very cheap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">To work with it, you need an ‚Äús3 bucket‚Äù and access keys. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All previous articles about WAL-G used configuration using environment variables, but from this release the settings can be located in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.walg.json file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the postgres user home directory. </font><font style="vertical-align: inherit;">To create it, execute the following bash script:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will explain a little in all respects:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the path to your S3-bucket where backups will be poured (you can both in the root and in the folder);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> ‚Äì    S3 (<i>      ‚Äì     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> ‚Äì     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> ‚Äì  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> ‚Äì  ¬´¬ª     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the path to the directory with the data of your database ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can find out by running the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;"> command</font></i><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - connection to the database, with a local backup it is better to do it through unix-socket, as in this example.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other parameters can be found in the documentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL setup</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the archiver inside the database to upload WAL logs to the cloud and recover from them (if necessary), you need to set several parameters in the configuration file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Just to get started, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you need to make sure</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that none of the settings below are set to any other values, so that when you restart the configuration, the DBMS does not fall. </font><font style="vertical-align: inherit;">You can add these parameters using:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> ‚Äúarchive_timeout=60‚Äù &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Description of the parameters to be set:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - how much information to write to WAL magazines, "replica" - to write everything;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enable the download of WAL logs using the command from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - command to archive the completed WAL log;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - archiving of logs is done only when it is completed, but if your server changes / adds data to the database a little, it makes sense to set a limit in seconds here, after which the archiving command will be forced ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have an intensive write to the database every second, therefore I refused to set this parameter in production</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a command to restore a WAL log from a backup, it will be used if the last database changes are missing in the ‚Äúfull backup‚Äù (base backup).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can read more about all these parameters in the translation of the official documentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up a backup schedule</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like it or not, but cron is the most convenient way to start. </font><font style="vertical-align: inherit;">This is what we will configure for creating backups. </font><font style="vertical-align: inherit;">Let's start with the command to create a full backup: in wal-g, this is the argument to run </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But first, it‚Äôs better to execute this command manually from the postgres user to make sure that everything is fine (and there aren‚Äôt any access errors):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The start arguments indicate the path to the data directory - I remind you that you can recognize it by running </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything went smoothly and the data was uploaded to the S3 repository, then you can configure periodic launch in crontab:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, the backup process starts every day at 4:15 in the morning.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete old backups</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most likely, you do not need to store absolutely all backups from the Mesozoic era, so it will be useful to periodically "clean up" your storage (both "full backups" and WAL logs). </font><font style="vertical-align: inherit;">We will do it all also through the cron task:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron will perform this task every day at 6:30 in the morning, deleting everything (full backups, deltas and WALs) except copies for the last 10 days, but will leave at least one backup </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">before the</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specified date so that any point </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after the</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> date falls into PITR .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restore from backup</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is no secret that the guarantee of a healthy base is periodic recovery and verification of data integrity inside. How to recover using WAL-G - I will tell in this section, and we'll talk about checks later. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separately, it is worth noting</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that for recovery on a test environment (all that is not production) - you need to use Read Only account in S3, so as not to accidentally overwrite backups. In the case of WAL-G, you need to set the S3 user the following rights in Group Policy ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect: Allow</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And, of course, do not forget to set </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font><i><font style="vertical-align: inherit;">postgresql.conf</font></i><font style="vertical-align: inherit;"> settings file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beforehand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that your test base does not want to backup quietly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recovery is performed by a slight movement of the hand with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deletion of all PostgreSQL data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (including users), so please be extremely careful when you run the following commands.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who want to check the recovery process - a small piece of bash-magic is prepared below, so that in case of problems in recovery - the script crashes with a non-zero exit code. </font><font style="vertical-align: inherit;">In this example, 120 checks are done with a timeout of 5 seconds (only 10 minutes to recover) to find out if the signal file was deleted (this will mean that the recovery was successful):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a successful recovery, do not forget to start all processes back (pgbouncer / monit, etc.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data verification after recovery</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Be sure to check the integrity of the database after recovery, so that there is no situation with a broken / crooked backup. </font><font style="vertical-align: inherit;">And it‚Äôs better to do this with each archive created, but where and how depends on your imagination (you can raise individual servers on an hourly basis or run a test in CI). </font><font style="vertical-align: inherit;">But at least - you need to check the data and indexes in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the data, it is enough to run them through the dump, but it is better that when creating the database, you have </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data checksums</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enabled </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For checking indices - there is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an amcheck module</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we will take the sql query for it from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G tests</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and build a little logic around:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       ‚Äì )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep‚Äô </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summarizing</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I express gratitude to Andrei Borodin for help in preparing the publication and special thanks for his contribution to the development of WAL-G! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On this note came to an end. </font><font style="vertical-align: inherit;">I hope that I was able to convey the ease of setup and the huge potential for using this tool in your company. </font><font style="vertical-align: inherit;">I heard a lot about WAL-G, but I didn‚Äôt have enough time to sit down and figure it out. </font><font style="vertical-align: inherit;">And after I introduced it at home, this article came out of me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Separately, it is worth noting that WAL-G can also work with the following DBMSs:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And judging by the commits - a few more are expected!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506594/index.html">Redis Best Practices, Part 3</a></li>
<li><a href="../en506598/index.html">Microsoft: Rust is the 'Best Chance' in the Safe Systems Programming Industry</a></li>
<li><a href="../en506600/index.html">The contract for the development of the site in terms of project management (theory + sample)</a></li>
<li><a href="../en506604/index.html">Concurrency and Efficiency: Python vs FSM</a></li>
<li><a href="../en506606/index.html">PIXI.js clicker creation</a></li>
<li><a href="../en506612/index.html">How to increase the completeness of massive online courses</a></li>
<li><a href="../en506620/index.html">Creative thinking: what it is, how to measure and increase your potential</a></li>
<li><a href="../en506624/index.html">FOSS News No. 20 - review of free and open source news for June 8-14, 2020</a></li>
<li><a href="../en506626/index.html">Kamailio SBC or not SBC?</a></li>
<li><a href="../en506628/index.html">The digest of interesting materials for the mobile # 348 developer (on June 8 - 14)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>