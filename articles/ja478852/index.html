<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💏 🐥 🧔🏾 OpenShiftのGitOpsの概要 👊🏻 🕤 🧔🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今日は、GitOpsの原理とモデル、およびこれらのモデルがOpenShiftプラットフォームでどのように実装されるかについて説明します。このトピックのオンラインガイドは、こちらから入手できます。
 
 
 
 つまり、GitOpsは、Gitプルリクエストを使用してインフラストラクチャとアプリケーショ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>OpenShiftのGitOpsの概要</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/478852/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日は、GitOpsの原理とモデル、およびこれらのモデルがOpenShiftプラットフォームでどのように実装されるかについて説明します。このトピックのオンラインガイドは、こちらから入手でき</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/g4/vk/skg4vkilbd51gs_dk6vk3-emy2o.jpeg" width="100%"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、GitOpsは、Gitプルリクエストを使用してインフラストラクチャとアプリケーション構成を管理するための実用的な方法のセットです。 GitOps内のGitリポジトリは、システムの状態に関する単一の情報源と見なされ、この状態の変更は完全に監視および監査されます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitOpsでの変更追跡のアイデアは決して新しいものではありません。このアプローチは、アプリケーションのソースコードを操作するときに、ほぼどこでも使用されてきました。</font><font style="vertical-align: inherit;">GitOpsは、インフラストラクチャとアプリケーションの構成を管理するときに同様の機能（レビューチェック、プルリクエスト、タグなど）を実装するだけで、ソースコード管理の場合と同様の利点を提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitOpsの場合、学術的な定義や承認された一連のルールはありません。このプラクティスの基礎となっている一連の原則のみです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムの宣言的な説明は、Gitリポジトリ（構成、監視など）に格納されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態の変更はプルリクエストを通じて行われます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行中のシステムの状態は、Gitプッシュリクエストを使用してリポジトリ内のデータと整合されます。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOpsの原則</font></font></h3><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム定義はソースコードとして記述されています。</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システム構成はコードと見なされるため、Gitリポジトリに保存して自動的にバージョン管理することができます。これは唯一の信頼できる情報源として機能します。</font><font style="vertical-align: inherit;">このアプローチにより、システムへの変更のロールアウトとロールバックが容易になります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムの望ましい状態と構成がGitで設定およびバージョン管理されている</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムの望ましい状態をGitに保存してバージョン管理することで、システムとアプリケーションへの変更を簡単にロールバックおよびロールバックできるようになります。</font><font style="vertical-align: inherit;">Gitのセキュリティメカニズムを使用して、コードの所有権を制御し、その信頼性を検証することもできます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成の変更は、プルクエリを使用して自動的に適用できます。</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gitプルリクエストを使用すると、リポジトリ内の構成に変更を適用する方法を簡単に制御できます。</font><font style="vertical-align: inherit;">たとえば、検証のために他のチームメンバーに送信したり、CIテストを実行したり</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、管理者権限を左右に与える必要はありません。</font><font style="vertical-align: inherit;">構成の変更をコミットするには、ユーザーはこれらの構成が保存されているGitリポジトリで十分な権限を持っています。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制御されていない構成ドリフトのトラブルシューティング</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムの望ましい状態がGitリポジトリーに保管されている場合、システムの現在の状態がその望ましい状態に対応することを制御するソフトウェアのみを見つけることができます。</font><font style="vertical-align: inherit;">そうでない場合、このソフトウェアは-設定に応じて-独自に矛盾を修正するか、構成のドリフトを通知する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShiftのGitOpsモデル</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター上のリソース調整</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このモデルによると、クラスターには、Gitリポジトリー内のKubernetesリソース（YAMLファイル）を実際のクラスターリソースと比較するコントローラーがあります。</font><font style="vertical-align: inherit;">不一致がある場合、コントローラは通知を送信し、場合によっては不整合を解消するための対策を講じます。</font><font style="vertical-align: inherit;">このGitOpsモデルは、Anthos Config ManagementとWeaveworks Fluxで使用されています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lh/c9/p2/lhc9p2tphyarqpe6jrsh10fgo7e.png"></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部リソース調整（プッシュ）</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このモデルは、「Gitリポジトリ-Kubernetesクラスター」のペアでリソースを同期するコントローラーが1つ以上ある場合、前のモデルのバリエーションと考えることができます。</font><font style="vertical-align: inherit;">ここでの違いは、各管理対象クラスターに独自のコントローラーが必要ないことです。</font><font style="vertical-align: inherit;">「Git-k8sクラスター」のペアは、多くの場合、コントローラーが同期を実行する方法を記述できるCRD記述（カスタムリソース定義）として定義されます。</font><font style="vertical-align: inherit;">このモデルでは、コントローラーはCRDで指定されたGitリポジトリーを、CRDでも定義されているKubernetesクラスターのリソースと比較し、比較結果に基づいて対応するアクションを実行します。</font><font style="vertical-align: inherit;">特に、このようなGitOpsモデルはArgoCDで使用されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zw/51/ip/zw51ipo5hqcn8ccnc8vfqkqbc88.png"></div><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShiftプラットフォームのGitOps</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチクラスターKubernetesインフラストラクチャ管理</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesの普及とマルチクラウド戦略とエッジコンピューティングの人気の高まりとともに、顧客あたりのOpenShiftクラスターの平均数も増加しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ペリフェラルコンピューティングを使用する場合、1人の顧客のクラスターを数百または数千にも展開できます。</font><font style="vertical-align: inherit;">その結果、彼はパブリッククラウドとオンプレミスでいくつかの独立した、または調整されたOpenShiftクラスターを管理することを余儀なくされました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、特に次のような多くの問題を解決する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターが同じ状態（構成、監視、ストレージなど）であることを制御するには</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既知の状態に従ってクラスターを再作成（または復元）します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既知の状態に従って新しいクラスターを作成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のOpenShiftクラスター間で変更をプルします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のOpenShiftクラスターへの変更をロールバックします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パターン化された構成を異なる環境にリンクします。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション構成</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションは、ライフサイクル中に、多くの場合、クラスター（開発、ステージなど）のチェーンを通過してから、本番クラスターに移行します。</font><font style="vertical-align: inherit;">さらに、可用性とスケーラビリティの要件により、お客様は多くの場合、アプリケーションを複数のオンプレミスクラスターまたはパブリッククラウドプラットフォームの複数のリージョンにデプロイします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、以下の問題を解決する必要があります。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター（開発、ステージなど）間のアプリケーション（バイナリー、構成など）の移動を確認します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のOpenShiftクラスターのアプリケーション（バイナリー、構成など）の変更をプルします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションの変更を以前の既知の状態のレベルにロールバックします。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShift GitOpsの使用シナリオ </font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Gitリポジトリから変更を適用する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスター管理者は、OpenShiftクラスター構成をGitリポジトリーに保管し、それらを自動的に適用して新しいクラスターを作成し、余分な労力なしでGitリポジトリーに保管されている既知の状態と同じ状態にすることができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.シークレットマネージャーと同期する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、OpenShiftシークレットオブジェクトをVaultなどの適切なソフトウェアと同期させて、特別に作成されたツールを使用してオブジェクトを管理することも役立ちます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.ドリフト構成の制御</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenShift GitOpsが実際の構成とリポジトリーで指定された構成との不一致を検出して警告し、ドリフトに迅速に対応できる場合にのみ、管理者が有利になります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.構成ドリフト通知</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者が自分で適切な対策をすばやく講じるために、ドリフト構成についてすばやく知りたい場合に便利です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.ドリフト時の構成の手動同期</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、ドリフト構成の場合にOpenShiftクラスターをGitリポジトリーと同期して、クラスターを以前の既知の状態にすばやく戻すことができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.ドリフト構成の自動同期</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、ドリフトが検出されたときにリポジトリと自動的に同期するようにOpenShiftクラスターを構成することもできるため、クラスター構成は常にGitの構成と一致します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.複数のクラスター-1つのリポジトリ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、1つのGitリポジトリにいくつかの異なるOpenShiftクラスターの設定を保存し、必要に応じてそれらを選択的に適用できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.クラスター構成の階層（継承）</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、リポジトリー内のクラスター構成の階層を設定できます（継承を使用して、ステージ、製品、アプリポートフォリオなど）。</font><font style="vertical-align: inherit;">つまり、1つまたは複数のクラスターに構成を適用する方法を決定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、管理者がGitリポジトリで階層「プロダクションクラスター（製品）→システムXのクラスター→システムXのプロダクションクラスター」を定義した場合、次の構成がシステムXのプロダクションクラスターに適用されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての本番クラスターに共通の構成。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターシステムXの構成。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムXの本番クラスターの構成。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.パターンと構成のオーバーライド</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、継承された構成とその値のセットをオーバーライドして、例えば、それらが適用される特定のクラスターの構成を微調整できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.構成、アプリケーション構成の選択的なinclude'yおよびexclude'y</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者は、特定の特性を持つクラスターに特定の構成を適用する、または適用しないための条件を設定できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.パターンのサポート</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者は、特定の各アプリケーションに最も適した形式を使用するために、アプリケーションリソースを決定する方法（Helm Chart、純粋なKubernetes yamlなど）を選択すると便利です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShiftプラットフォーム上のGitOpsツール</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Argocd</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArgoCDは、External Resource Reconcileモデルを実装し、クラスターとGitリポジトリ間の関係を1対多の方法で調整するための集中型UIを提供します。</font><font style="vertical-align: inherit;">このプログラムの欠点は、ArgoCDが動作していないときにアプリケーションを管理できないことです。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式サイト</font></font></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラックス</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FluxはOn-Cluster Resource Reconcileモデルを実装しているため、弱点である定義リポジトリの集中管理はありません。</font><font style="vertical-align: inherit;">一方、一元化されていないため、1つのクラスターで障害が発生しても、アプリケーションを管理する機能は維持されます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式サイト</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShiftにArgoCDをインストールする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArgoCDは優れたコマンドラインインターフェイスとWebコンソールを提供しているため、ここではFluxやその他の代替手段を検討しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenShift 4プラットフォームにArgoCDをデプロイするには、クラスター管理者として次の手順に従います。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShiftプラットフォームでのArgoCDコンポーネントのデプロイ</font></font></h4><br>
<pre><code class="plaintext hljs"># Create a new namespace for ArgoCD components<font></font>
oc create namespace argocd<font></font>
# Apply the ArgoCD Install Manifest<font></font>
oc -n argocd apply -f https://raw.githubusercontent.com/argoproj/argo-cd/v1.2.2/manifests/install.yaml<font></font>
# Get the ArgoCD Server password<font></font>
ARGOCD_SERVER_PASSWORD=$(oc -n argocd get pod -l "app.kubernetes.io/name=argocd-server" -o jsonpath='{.items[*].metadata.name}')</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenShift Routeから見えるArgoCDサーバーの改良</font></font></h4><br>
<pre><code class="plaintext hljs"># Patch ArgoCD Server so no TLS is configured on the server (--insecure)<font></font>
PATCH='{"spec":{"template":{"spec":{"$setElementOrder/containers":[{"name":"argocd-server"}],"containers":[{"command":["argocd-server","--insecure","--staticassets","/shared/app"],"name":"argocd-server"}]}}}}'<font></font>
oc -n argocd patch deployment argocd-server -p $PATCH<font></font>
# Expose the ArgoCD Server using an Edge OpenShift Route so TLS is used for incoming connections<font></font>
oc -n argocd create route edge argocd-server --service=argocd-server --port=http --insecure-policy=Redirect</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ArgoCD Cliツールの導入</font></font></h4><br>
<pre><code class="plaintext hljs"># Download the argocd binary, place it under /usr/local/bin and give it execution permissions<font></font>
curl -L https://github.com/argoproj/argo-cd/releases/download/v1.2.2/argocd-linux-amd64 -o /usr/local/bin/argocd<font></font>
chmod +x /usr/local/bin/argocd</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理パスワードの変更ArgoCDサーバー</font></font></h4><br>
<pre><code class="plaintext hljs"># Get ArgoCD Server Route Hostname<font></font>
ARGOCD_ROUTE=$(oc -n argocd get route argocd-server -o jsonpath='{.spec.host}')<font></font>
# Login with the current admin password<font></font>
argocd --insecure --grpc-web login ${ARGOCD_ROUTE}:443 --username admin --password ${ARGOCD_SERVER_PASSWORD}<font></font>
# Update admin's password<font></font>
argocd --insecure --grpc-web --server ${ARGOCD_ROUTE}:443 account update-password --current-password ${ARGOCD_SERVER_PASSWORD} --new-password</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの手順を完了すると、ArgoCD WebUI WebコンソールまたはArgoCD Cliコマンドラインツールを使用してArgoCDサーバーを操作できます。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://blog.openshift.com/is-it-too-late-to-integrate-gitops/</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOps-それは遅すぎることはありません</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 「列車が出発しました」-これは、何かをする機会が失われたときの状況について彼らが言うことです。 OpenShiftの場合、この新しいクールなプラットフォームの使用をすぐに開始したいという願望は、ルート、デプロイメント、およびその他のOpenShiftオブジェクトの管理とメンテナンスで、まさにそのような状況を作り出します。しかし、チャンスは常に完全に逃されていますか？</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">GitOps</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
に関する一連の記事を続けて</font><font style="vertical-align: inherit;">、今日は手動で作成したアプリケーションとそのリソースを、GitOpsツールキットがすべてを制御する特定のプロセスに変換する方法を示します。これを行うには、まず手でhttpdアプリケーションをデプロイします。以下のスクリーンショットは、名前空間、デプロイメント、サービスを作成し、このサービスを公開してルートを作成する方法を示しています。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">oc create -f https://raw.githubusercontent.com/openshift/federation-dev/master/labs/lab-4-assets/namespace.yaml<font></font>
oc create -f https://raw.githubusercontent.com/openshift/federation-dev/master/labs/lab-4-assets/deployment.yaml<font></font>
oc create -f https://raw.githubusercontent.com/openshift/federation-dev/master/labs/lab-4-assets/service.yaml<font></font>
oc expose svc/httpd -n simple-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、手動で作成したアプリケーションがあります。</font><font style="vertical-align: inherit;">現在は、可用性を失うことなく、GitOpsの制御下で転送する必要があります。</font><font style="vertical-align: inherit;">つまり、これは次のようになります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードのGitリポジトリを作成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在のオブジェクトをエクスポートし、Gitリポジトリにロードします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOpsツールキットを選択してデプロイします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このツールキットにリポジトリを追加します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOpsツールキットでアプリケーションを定義します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOpsツールキットを使用してアプリケーションの試用を実行します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitOpsツールキットを使用してオブジェクトを同期します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトのプルーニングと自動同期をオンにします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">述べたように</font><font style="vertical-align: inherit;">、GitOpsには、Kubernetesクラスター内のすべてのオブジェクトに関する情報の唯一のソース、つまりGitリポジトリがあります。さらに、組織がすでにGitリポジトリを使用しているという前提から進めます。パブリックまたはプライベートにすることができますが、Kubernetesクラスターで使用できる必要があります。これは、アプリケーションコードの場合と同じリポジトリでも、展開専用に作成された別のリポジトリでもかまいません。シークレットオブジェクト、ルート、その他の機密性の高いものが格納されるため、リポジトリには厳密な権限を付与することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、GitHubに新しいパブリックリポジトリを作成します。ブログポストという名前を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトのYAMLファイルがローカルまたはGitに保存されていない場合は、ocまたはkubectlバイナリを使用する必要があります。</font><font style="vertical-align: inherit;">以下のスクリーンショットでは、名前空間、デプロイメント、サービス、ルートのYAMLをリクエストしています。</font><font style="vertical-align: inherit;">その前に、新しく作成したリポジトリのクローンを作成し、cdコマンドでそこに移動しました。</font></font><br>
<br>
<pre><code class="plaintext hljs">oc get namespace simple-app -o yaml --export &gt; namespace.yaml<font></font>
oc get deployment httpd -o yaml -n simple-app --export &gt; deployment.yaml<font></font>
oc get service httpd -o yaml -n simple-app --export &gt; service.yaml<font></font>
oc get route httpd -o yaml -n simple-app --export &gt; route.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argo CDが同期できないフィールドを削除するようにdeployment.yamlファイルを修正します。</font></font><br>
<br>
<pre><code class="plaintext hljs">sed -i '/\sgeneration: .*/d' deployment.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ルートを変更する必要があります。</font><font style="vertical-align: inherit;">最初に複数行の変数を設定してから、ingress：nullをこの変数の内容に置き換えます。</font></font><br>
<br>
<pre><code class="plaintext hljs">export ROUTE="  ingress:\\                                                            <font></font>
    - conditions:\\<font></font>
        - status: 'True'\\<font></font>
          type: Admitted"<font></font>
<font></font>
sed -i "s/  ingress: null/$ROUTE/g" route.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、ファイルを見つけました。Gitリポジトリに保存する必要があります。</font><font style="vertical-align: inherit;">その後、このリポジトリが唯一の情報源となり、オブジェクトへの手動による変更は厳しく禁止する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">git commit -am ‘initial commit of objects’<font></font>
git push origin master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ArgoCDがすでに展開されていることを前提としています（その方法については、前の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">投稿を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">したがって、Argo CDに、この例のアプリケーションコードを含む、作成したリポジトリを追加します。</font><font style="vertical-align: inherit;">以前に作成した正確なリポジトリを指定していることを確認してください。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd repo add https://github.com/cooktheryan/blogpost</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、アプリケーションを作成します。</font><font style="vertical-align: inherit;">アプリケーションは値を設定して、GitOpsツールキットが、使用するリポジトリとパス、オブジェクトを管理するために必要なOpenShift、リポジトリの特定のブランチが必要かどうか、リソースを自動同期するかどうかを理解できるようにします。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd app create --project default \<font></font>
--name simple-app --repo https://github.com/cooktheryan/blogpost.git \<font></font>
--path . --dest-server https://kubernetes.default.svc \<font></font>
--dest-namespace simple-app --revision master --sync-policy none</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argo CDでアプリケーションが指定されると、このツールキットは、リポジトリー内の定義に準拠しているかどうか、既にデプロイされているオブジェクトのチェックを開始します。</font><font style="vertical-align: inherit;">この例では、自動同期とクリーンアップが無効になっているため、要素はまだ変更されていません。</font><font style="vertical-align: inherit;">ArgoCDによってラベルタグが付けられていないため、Argo CDインターフェースでは、アプリケーションのステータスは「同期外れ」（同期されていません）になります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、少し後で同期を開始すると、オブジェクトの再デプロイメントは実行されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、テスト実行を実行して、ファイルにエラーがないことを確認します。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd app sync simple-app --dry-run</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーがない場合は、同期に進むことができます。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd app sync simple-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションでargocd getコマンドを実行すると、アプリケーションのステータスがHealthyまたはSyncedに変わったことがわかります。</font><font style="vertical-align: inherit;">これは、Gitリポジトリ内のすべてのリソースが、すでにデプロイされているリソースに対応することを意味します。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd app get simple-app<font></font>
Name:               simple-app<font></font>
Project:            default<font></font>
Server:             https://kubernetes.default.svc<font></font>
Namespace:          simple-app<font></font>
URL:                https://argocd-server-route-argocd.apps.example.com/applications/simple-app<font></font>
Repo:               https://github.com/cooktheryan/blogpost.git<font></font>
Target:             master<font></font>
Path:               .<font></font>
Sync Policy:        &lt;none&gt;<font></font>
Sync Status:        Synced to master (60e1678)<font></font>
Health Status:      Healthy<font></font>
...   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、自動同期とクリーンアップをオンにして、手動で何も作成されないようにし、リポジトリでオブジェクトが作成または更新されるたびにデプロイメントが実行されるようにすることができます。</font></font><br>
<br>
<pre><code class="plaintext hljs">argocd app set simple-app --sync-policy automated --auto-prune</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、当初はGitOpsをまったく使用していなかったアプリケーションをGitOpsの制御に移行することに成功しました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478840/index.html">マーケットプレイスの作成はどこから始まりますか。二部</a></li>
<li><a href="../ja478844/index.html">ITへの恐れと嫌悪</a></li>
<li><a href="../ja478846/index.html">systemd、インタラクティブスクリプトおよびタイマー</a></li>
<li><a href="../ja478848/index.html">デジタル写真の進化</a></li>
<li><a href="../ja478850/index.html">CSSグリッドの命名</a></li>
<li><a href="../ja478854/index.html">Webサーバーの戦い。パート1-現実から切り離されたHTTP：</a></li>
<li><a href="../ja478856/index.html">SD-WAN-2020年の最近の傾向と予測</a></li>
<li><a href="../ja478858/index.html">XHProf Adminでのプロファイリングセッションの比較</a></li>
<li><a href="../ja478862/index.html">Yandex.Marketでのフロントエンドテストの仕組みと、毎週のリリースを拒否する理由</a></li>
<li><a href="../ja478866/index.html">Meet Space-JetBrainsの新製品</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>