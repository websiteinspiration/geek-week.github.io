<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🌾 👩🏽‍🎤 🏍️ Notre expérience dans le développement d'un pilote CSI dans Kubernetes pour Yandex.Cloud 🧘🏼 🍥 🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous sommes heureux d'annoncer que Flant reconstitue sa contribution aux outils Open Source pour Kubernetes en publiant une version alpha du pilote CS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Notre expérience dans le développement d'un pilote CSI dans Kubernetes pour Yandex.Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/486190/"><img src="https://habrastorage.org/webt/1y/to/tn/1ytotnf73zepbwfalhzoropf9qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes heureux d'annoncer que Flant reconstitue sa contribution aux outils Open Source pour Kubernetes en publiant une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version alpha du pilote CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Container Storage Interface) pour Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avant de passer aux détails de l'implémentation, nous répondrons à la question de savoir pourquoi cela est nécessaire lorsque Yandex dispose déjà du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service Managed Service pour Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi est-ce?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au sein de notre entreprise, dès le début de l'exploitation de Kubernetes en production (c'est-à-dire depuis plusieurs années), notre propre outil (deckhouse) se développe, que nous prévoyons d'ailleurs de mettre à disposition sous forme de projet Open Source dans un avenir proche. Avec son aide, nous configurons et configurons uniformément tous nos clusters, et pour le moment, il y en a plus de 100 sur les configurations matérielles les plus diverses et dans tous les services cloud disponibles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les clusters utilisant deckhouse disposent de tous les composants nécessaires au travail: équilibreurs, surveillance avec des graphiques, des mesures et des alertes pratiques, authentification des utilisateurs via des fournisseurs externes pour accéder à tous les tableaux de bord, etc. </font><font style="vertical-align: inherit;">Cela n'a pas de sens de mettre un tel cluster «gonflé» dans une solution gérée, car cela est souvent impossible ou entraînera la nécessité de désactiver la moitié des composants. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : C'est notre expérience, et c'est assez spécifique. </font><font style="vertical-align: inherit;">En aucun cas, nous ne prétendons que tout le monde devrait s'engager indépendamment dans le déploiement du cluster Kubernetes au lieu d'utiliser des solutions prêtes à l'emploi. </font><font style="vertical-align: inherit;">Soit dit en passant, nous n'avons aucune expérience réelle dans l'utilisation de Kubernetes de Yandex et nous ne donnerons aucune évaluation de ce service dans cet article.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est quoi et pour qui?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc déjà parlé de l'approche moderne du stockage dans Kubernetes: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonctionne </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">CSI</font></a><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment la communauté est venue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à cette approche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actuellement, de nombreux grands fournisseurs de services cloud ont développé des pilotes pour utiliser leurs disques cloud en tant que volume persistant dans Kubernetes. Si le fournisseur n'a pas un tel pilote, mais en même temps toutes les fonctions nécessaires sont fournies via l'API, alors rien n'empêche le pilote de mettre en œuvre ses propres ressources. Et c'est arrivé avec Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme base de développement, nous avons pris le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pilote CSI pour le cloud DigitalOcean</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et quelques idées du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pilote pour GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car l'interaction avec l'API de ces clouds (Google et Yandex) présente un certain nombre de similitudes. En particulier, l'API et</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoient un objet </font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour suivre l'état des opérations longues (par exemple, créer un nouveau disque). </font><font style="vertical-align: inherit;">Pour interagir avec l'API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">SDK Yandex.Cloud Go est utilisé</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le résultat du travail effectué est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publié sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et peut être utile à ceux qui, pour une raison quelconque, utilisent leur propre installation de Kubernetes sur des machines virtuelles Yandex.Cloud (mais pas un cluster géré prêt à l'emploi) et souhaitent utiliser (commander) des disques via CSI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la mise en oeuvre</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Principales caractéristiques</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actuellement, le pilote prend en charge les fonctions suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ordonner les disques dans toutes les zones du cluster en fonction de la topologie des nœuds du cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Retrait des disques précédemment commandés;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redimensionnement hors ligne pour les disques (Yandex. Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne prend pas en charge l'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> augmentation des disques montés sur une machine virtuelle). </font><font style="vertical-align: inherit;">Pour savoir comment modifier le pilote afin de redimensionner le plus indolore possible, voir ci-dessous.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'avenir, il est prévu de mettre en œuvre la prise en charge de la création et de la suppression de disques d'instantanés.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La principale difficulté et son dépassement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le manque de capacité à étendre les disques en temps réel dans l'API Yandex.Cloud est une limitation qui complique l'opération de redimensionnement pour PV (Volume persistant): dans ce cas, il est nécessaire que le pod de l'application qui utilise le disque soit arrêté, ce qui peut provoquer un simple applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la spécification CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si le contrôleur CSI signale qu'il ne peut redimensionner les disques que «hors ligne» ( </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), le processus d'augmentation du disque devrait se dérouler comme suit:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le plugin n'a qu'une </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité d'expansion et que le volume est actuellement publié ou disponible sur un nœud, alors </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DOIT être appelé UNIQUEMENT après:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le plugin a une </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité de </font><font style="vertical-align: inherit;">contrôleur </font><font style="vertical-align: inherit;">et </font></font><code>ControllerUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a été appelé avec succès.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OU SINON</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le plugin n'a PAS de </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité de </font><font style="vertical-align: inherit;">contrôleur </font><font style="vertical-align: inherit;">, le plugin a la </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité de </font><font style="vertical-align: inherit;">nœud </font><font style="vertical-align: inherit;">et </font></font><code>NodeUnstageVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'est terminé avec succès.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OU SINON</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le plugin n'a PAS de </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité de </font><font style="vertical-align: inherit;">contrôleur </font><font style="vertical-align: inherit;">, ni de </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacité de </font><font style="vertical-align: inherit;">nœud </font><font style="vertical-align: inherit;">, et </font></font><code>NodeUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'est terminé avec succès.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En substance, cela signifie la nécessité de déconnecter le disque de la machine virtuelle avant de l'augmenter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, malheureusement, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise en œuvre de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la spécification CSI via side-car ne répond pas à ces exigences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le sidecar-container </font></font><code>csi-attacher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui devrait être responsable de la présence de l'espace nécessaire entre les montages, cette fonctionnalité n'est tout simplement pas implémentée avec un redimensionnement hors ligne. </font><font style="vertical-align: inherit;">Une discussion à ce sujet a été lancée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'un sidecar container dans ce contexte? </font><font style="vertical-align: inherit;">Le plugin CSI lui-même n'interagit pas avec l'API Kubernetes, mais répond uniquement aux appels gRPC que les conteneurs side-car lui envoient. </font><font style="vertical-align: inherit;">Ces derniers sont </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">développés par</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la communauté Kubernetes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas (plugin CSI), l'opération pour augmenter le disque est la suivante:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous recevons un appel gRPC </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous essayons d'augmenter le disque dans l'API, mais nous obtenons une erreur concernant l'impossibilité d'effectuer l'opération, car le disque est monté;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous enregistrons l'identifiant du disque dans une carte contenant les disques pour lesquels vous devez effectuer une opération d'augmentation. </font><font style="vertical-align: inherit;">Par souci de concision, nous appellerons cette carte </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimez manuellement le module qui utilise le disque. </font><font style="vertical-align: inherit;">Kubernetes le redémarrera. </font><font style="vertical-align: inherit;">Afin que le disque n'ait pas le temps de monter ( </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) avant la fin de l'opération d'augmentation lors de la tentative de montage, nous vérifions que ce disque est toujours en place </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et renvoyons une erreur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le pilote CSI tente de réexécuter l'opération de redimensionnement. </font><font style="vertical-align: inherit;">Si l'opération a réussi, supprimez le disque de </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parce que </font><font style="vertical-align: inherit;">l'identifiant du disque manque </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réussit, le disque est monté, le pod démarre.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble assez simple, mais comme toujours, il y a des pièges. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le redimensionneur externe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est impliqué dans l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">expansion du</font></a><font style="vertical-align: inherit;"> disque </font><font style="vertical-align: inherit;">qui, en cas d'erreur pendant l'opération, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise une file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">attente</font></a><font style="vertical-align: inherit;"> avec une augmentation exponentielle du délai d'expiration jusqu'à 1000 secondes:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DefaultControllerRateLimiter</span><span class="hljs-params">()</span> <span class="hljs-title">RateLimiter</span></span> {
  <span class="hljs-keyword">return</span> NewMaxOfRateLimiter(<font></font>
  NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">1000</span>*time.Second),
  <span class="hljs-comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
  &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(<span class="hljs-number">10</span>), <span class="hljs-number">100</span>)},<font></font>
  )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut conduire périodiquement au fait que l'opération d'augmentation du disque est étirée pendant plus de 15 minutes et, par conséquent, à l'inaccessibilité du pod correspondant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La seule option qui nous a permis de réduire le temps d'immobilisation potentiel assez facilement et sans douleur était d'utiliser notre version de redimensionnement externe avec un délai maximum de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 secondes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
 <br>
<pre><code class="go hljs">workqueue.NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">5</span>*time.Second)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas jugé nécessaire de lancer d'urgence une discussion et de corriger le redimensionneur externe, car les disques de redimensionnement hors ligne sont un atavisme qui disparaîtra bientôt de tous les fournisseurs de cloud.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment commencer à utiliser?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le pilote est pris en charge dans Kubernetes version 1.15 et supérieure. </font><font style="vertical-align: inherit;">Pour que le conducteur fonctionne, les conditions suivantes doivent être remplies:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'indicateur est </font></font><code>--allow-privileged</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">défini sur la valeur </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du serveur API et du kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inclus </font></font><code>--feature-gates=VolumeSnapshotDataSource=true,KubeletPluginsWatcher=true,CSINodeInfo=true,CSIDriverRegistry=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le serveur API et le kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le montage de propagation ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propagation du montage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) doit être inclus dans le cluster. </font><font style="vertical-align: inherit;">Lors de l'utilisation de Docker, le démon doit être configuré pour que les montages partagés soient autorisés.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les étapes nécessaires à l'installation elle-même sont </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décrites dans le fichier README</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'installation est la création d'objets dans Kubernetes à partir de manifestes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que le pilote fonctionne, vous aurez besoin des éléments suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indiquez l'identifiant du répertoire du catalogue Yandex.Cloud ( </font></font><code>folder-id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">dans le manifeste </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voir la documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour interagir avec l'API Yandex.Cloud dans le pilote CSI, un compte de service est utilisé. </font><font style="vertical-align: inherit;">Dans le manifeste secret, vous devez transmettre les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clés autorisées</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au compte de service. </font><font style="vertical-align: inherit;">La documentation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décrit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comment créer un compte de service et obtenir les clés.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">essayez</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -le et nous serons heureux de recevoir des commentaires et de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveaux problèmes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si vous rencontrez des problèmes!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un soutien supplémentaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous tenons à noter que nous avons implémenté ce pilote CSI non pas par un grand désir d'avoir du plaisir à écrire des applications sur Go, mais en raison du besoin urgent au sein de l'entreprise. </font><font style="vertical-align: inherit;">Il ne semble pas conseillé de prendre en charge notre propre implémentation.Par conséquent, si Yandex montre de l'intérêt et décide de continuer à prendre en charge le pilote, nous transférerons volontiers le référentiel à leur disposition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, probablement, Yandex dans le cluster géré Kubernetes a sa propre implémentation du pilote CSI, qui peut être publié en Open Source. </font><font style="vertical-align: inherit;">Cette option de développement nous semble également favorable - la communauté pourra utiliser le pilote éprouvé du prestataire de services et non d'une société tierce.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> Kubernetes CCM (Cloud Controller Manager)  .</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     Kubernetes:  Flexvolume  CSI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> Container Storage Interface ( Kubernetes   )</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> Kubernetes-   ?  addon-operator</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   Kubernetes (   )</a>».</li>
</ul></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486178/index.html">FOSS News No. 1 - revue des nouvelles gratuites et open source du 27 janvier au 2 février 2020</a></li>
<li><a href="../fr486180/index.html">Conseils et sources pour créer des applications sans serveur</a></li>
<li><a href="../fr486184/index.html">Comment utiliser efficacement la recherche</a></li>
<li><a href="../fr486186/index.html">Nuage catastrophique: comment cela fonctionne</a></li>
<li><a href="../fr486188/index.html">Présentation du système de sauvegarde PostgreSQL wal-g</a></li>
<li><a href="../fr486192/index.html">Les cyber fraudeurs piratent les opérateurs mobiles pour accéder aux numéros de téléphone des abonnés</a></li>
<li><a href="../fr486194/index.html">À propos des sauvegardes dans Proxmox VE</a></li>
<li><a href="../fr486198/index.html">Parler est difficile. Essais sur la communication avec les non-programmeurs</a></li>
<li><a href="../fr486200/index.html">Conseils Docker: nettoyez votre machine des déchets indésirables</a></li>
<li><a href="../fr486202/index.html">Alpine recueille les versions Docker sous Python 50 fois plus lentement et les images 2 fois plus lourdes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>