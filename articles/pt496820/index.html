<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèª üêøÔ∏è üë• Armadilhas da Terraform üíø üë∂üèæ üë®‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vamos destacar v√°rias armadilhas, incluindo aquelas relacionadas a loops, instru√ß√µes if e t√©cnicas de implanta√ß√£o, bem como quest√µes mais gerais que d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Armadilhas da Terraform</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/496820/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/9d/ou/9e/9dou9eb8rwq6zzcphuthymczj4a.jpeg" alt="imagem"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos destacar v√°rias armadilhas, incluindo aquelas relacionadas a loops, instru√ß√µes if e t√©cnicas de implanta√ß√£o, bem como quest√µes mais gerais que dizem respeito √† Terraform como um todo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os par√¢metros count e for_each t√™m limita√ß√µes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restri√ß√µes de implanta√ß√£o de tempo de inatividade zero</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at√© um bom plano pode falhar;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a refatora√ß√£o pode ter seus truques;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a consist√™ncia diferida √© consistente ... com o diferimento.</font></font></li>
</ul><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os par√¢metros count e for_each t√™m limita√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos exemplos deste cap√≠tulo, o par√¢metro count e a express√£o for_each s√£o usados ‚Äã‚Äãativamente em loops e l√≥gica condicional. </font><font style="vertical-align: inherit;">Eles t√™m um bom desempenho, mas t√™m duas limita√ß√µes importantes que voc√™ precisa conhecer.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em count e for_each, nenhuma vari√°vel de sa√≠da de recurso pode ser referenciada.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">count e for_each n√£o podem ser usados ‚Äã‚Äãna configura√ß√£o do m√≥dulo.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Count e for_each n√£o podem fazer refer√™ncia a nenhuma vari√°vel de sa√≠da de um recurso</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que voc√™ precisa implantar v√°rios servidores EC2 e, por algum motivo, n√£o deseja usar o ASG. </font><font style="vertical-align: inherit;">Seu c√≥digo pode ser assim:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"example_1"</span> {<font></font>
   count             = <span class="hljs-number">3</span>
   ami                = <span class="hljs-string">"ami-0c55b159cbfafe1f0"</span>
   instance_type = <span class="hljs-string">"t2.micro"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos consider√°-los por sua vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o par√¢metro count recebe um valor est√°tico, esse c√≥digo funciona sem problemas: quando voc√™ executa o comando apply, ele cria tr√™s servidores EC2. Mas se voc√™ deseja implantar um servidor em cada zona de disponibilidade (zona de disponibilidade ou AZ) na regi√£o atual da AWS? Voc√™ pode fazer com que seu c√≥digo carregue a lista de zonas da fonte de dados aws_availability_zones e depois percorra cada uma delas e crie um servidor EC2 nela usando o par√¢metro count e acessando a matriz por √≠ndice:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"example_2"</span> {<font></font>
   count                   = length(data.aws_availability_zones.all.names)<font></font>
   availability_zone   = data.aws_availability_zones.all.names[count.index]<font></font>
   ami                     = <span class="hljs-string">"ami-0c55b159cbfafe1f0"</span>
   instance_type       = <span class="hljs-string">"t2.micro"</span><font></font>
}<font></font>
<font></font>
data <span class="hljs-string">"aws_availability_zones"</span> <span class="hljs-string">"all"</span> {}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse c√≥digo tamb√©m funcionar√° bem, pois o par√¢metro count pode fazer refer√™ncia a fontes de dados sem problemas. </font><font style="vertical-align: inherit;">Mas o que acontece se o n√∫mero de servidores que voc√™ precisa criar depender da sa√≠da de algum recurso? </font><font style="vertical-align: inherit;">Para demonstrar isso, a maneira mais f√°cil √© usar o recurso random_integer, que, como voc√™ pode imaginar pelo nome, retorna um n√∫mero inteiro aleat√≥rio:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"random_integer"</span> <span class="hljs-string">"num_instances"</span> {<font></font>
  min = <span class="hljs-number">1</span>
  max = <span class="hljs-number">3</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo gera um n√∫mero aleat√≥rio de 1 a 3. Vamos ver o que acontece se tentarmos usar a sa√≠da do resultado desse recurso no par√¢metro count do recurso aws_instance:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"example_3"</span> {<font></font>
   count             = random_integer.num_instances.result<font></font>
   ami                = <span class="hljs-string">"ami-0c55b159cbfafe1f0"</span>
   instance_type = <span class="hljs-string">"t2.micro"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ executar o plano de terraform para esse c√≥digo, receber√° o seguinte erro:</font></font><br>
<br>
<pre><code class="java hljs">Error: Invalid count argument<font></font>
<font></font>
   on main.tf line <span class="hljs-number">30</span>, in resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"example_3"</span>:
   <span class="hljs-number">30</span>: count = random_integer.num_instances.result<font></font>
<font></font>
The <span class="hljs-string">"count"</span> value depends on resource attributes that cannot be determined until apply, so Terraform cannot predict how many instances will be created. To work around <span class="hljs-keyword">this</span>, use the -target argument to first apply only the resources that the count depends on.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Terraform exige que a contagem e o for_cada sejam computados durante a fase de planejamento, antes que quaisquer recursos sejam criados ou modificados. </font><font style="vertical-align: inherit;">Isso significa que count e for_each podem se referir a literais, vari√°veis, fontes de dados e at√© listas de recursos (desde que seu comprimento possa ser determinado durante o planejamento), mas n√£o √†s vari√°veis ‚Äã‚Äãde sa√≠da calculadas do recurso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">count e for_each n√£o podem ser usados ‚Äã‚Äãna configura√ß√£o do m√≥dulo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum momento, voc√™ pode tentar adicionar o par√¢metro count √† configura√ß√£o do m√≥dulo:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">module</span> <span class="hljs-string">"count_example"</span> {<font></font>
     source = <span class="hljs-string">"../../../../modules/services/webserver-cluster"</span><font></font>
<font></font>
     count = <span class="hljs-number">3</span><font></font>
<font></font>
     cluster_name = <span class="hljs-string">"terraform-up-and-running-example"</span>
     server_port = <span class="hljs-number">8080</span>
     instance_type = <span class="hljs-string">"t2.micro"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse c√≥digo tenta usar count dentro do m√≥dulo para criar tr√™s c√≥pias do recurso cluster de servidor da web. </font><font style="vertical-align: inherit;">Ou talvez voc√™ queira tornar a conex√£o do m√≥dulo opcional, dependendo de alguma condi√ß√£o booleana, atribuindo seu par√¢metro de contagem a 0. Esse c√≥digo parecer√° bastante razo√°vel, mas como resultado da execu√ß√£o do plano de terraform, voc√™ receber√° o seguinte erro:</font></font><br>
<br>
<pre><code class="java hljs">Error: Reserved argument name in <span class="hljs-keyword">module</span> block<font></font>
<font></font>
   on main.tf line <span class="hljs-number">13</span>, in <span class="hljs-keyword">module</span> <span class="hljs-string">"count_example"</span>:
   <span class="hljs-number">13</span>: count = <span class="hljs-number">3</span><font></font>
<font></font>
The name <span class="hljs-string">"count"</span> is reserved <span class="hljs-keyword">for</span> use in a future version of Terraform.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, no momento em que o Terraform 0.12.6 foi lan√ßado, o uso de count ou for_each no recurso do m√≥dulo n√£o era suportado. </font><font style="vertical-align: inherit;">De acordo com as notas de vers√£o do Terraform 0.12 (http://bit.ly/3257bv4), a HashiCorp planeja adicionar esse recurso no futuro, portanto, dependendo de quando voc√™ ler este livro, ele poder√° j√° estar dispon√≠vel. </font><font style="vertical-align: inherit;">Para ter certeza, consulte o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registro de altera√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Terraform aqui</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usar o bloco create_before_destroy em combina√ß√£o com o ASG √© uma excelente solu√ß√£o para organizar implanta√ß√µes com tempo de inatividade zero, exceto por uma nuance: as regras de dimensionamento autom√°tico n√£o s√£o suportadas. Ou, para ser mais preciso, isso redefine o tamanho do ASG de volta para min_size cada vez que √© implantado, o que pode ser um problema se voc√™ usar regras de dimensionamento autom√°tico para aumentar o n√∫mero de servidores em execu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, o m√≥dulo webserver-cluster cont√©m um par de recursos aws_autoscaling_schedule, que √†s 9 horas aumentam o n√∫mero de servidores no cluster de dois para dez. Se voc√™ implantar, digamos, √†s 11h, o novo ASG n√£o inicializar√° com dez, mas apenas com dois servidores, e permanecer√° nesse estado at√© as 9h do dia seguinte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa limita√ß√£o pode ser contornada de v√°rias maneiras.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Altere o par√¢metro de recorr√™ncia em aws_autoscaling_schedule de 0 9 * * * ("execute √†s 9h") para algo como 0-59 9-17 * * * ("execute a cada minuto das 9h √†s 17h"). </font><font style="vertical-align: inherit;">Se o ASG j√° tiver dez servidores, a re-execu√ß√£o dessa regra de escala autom√°tica n√£o mudar√° nada, e √© disso que precisamos. </font><font style="vertical-align: inherit;">Mas se o grupo ASG tiver sido implantado recentemente, essa regra garantir√° que em um minuto o n√∫mero de seus servidores chegue a dez. </font><font style="vertical-align: inherit;">Essa n√£o √© uma abordagem totalmente elegante, e grandes saltos de dez para dois servidores e vice-versa tamb√©m podem causar problemas aos usu√°rios.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um script personalizado que use a API da AWS para determinar o n√∫mero de servidores ativos no ASG, chame-o usando uma fonte de dados externa (consulte a se√ß√£o "Fonte de dados externa" na p√°gina 248) e defina o par√¢metro de capacidade desejada do grupo ASG para o valor retornado por este script. </font><font style="vertical-align: inherit;">Assim, cada nova inst√¢ncia ASG sempre ser√° executada com a mesma capacidade que o antigo c√≥digo Terraform e complica sua manuten√ß√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, idealmente, o Terraform deveria ter suporte embutido para implanta√ß√µes com tempo de inatividade zero, mas a partir de maio de 2019, a equipe da HashiCorp n√£o planejava adicionar essa funcionalidade (os </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">detalhes est√£o aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O plano correto pode ser implementado sem √™xito.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, quando voc√™ executa o comando plan, obt√©m um plano de implanta√ß√£o completamente correto, mas o comando apply retorna um erro. </font><font style="vertical-align: inherit;">Por exemplo, tente adicionar o recurso aws_iam_user com o mesmo nome que voc√™ usou para o usu√°rio do IAM que voc√™ criou anteriormente no cap√≠tulo 2:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_iam_user"</span> <span class="hljs-string">"existing_user"</span> {<font></font>
   #       IAM,<font></font>
   #      terraform <span class="hljs-keyword">import</span>
   name = <span class="hljs-string">"yevgeniy.brikman"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, se voc√™ executar o comando plan, o Terraform exibir√° √† primeira vista um plano de implanta√ß√£o bastante razo√°vel:</font></font><br>
<br>
<pre><code class="java hljs">Terraform will perform the following actions:<font></font>
<font></font>
   # aws_iam_user.existing_user will be created<font></font>
   + resource <span class="hljs-string">"aws_iam_user"</span> <span class="hljs-string">"existing_user"</span> {<font></font>
         + arn                  = (known after apply)<font></font>
         + force_destroy   = <span class="hljs-keyword">false</span><font></font>
         + id                    = (known after apply)<font></font>
         + name               = <span class="hljs-string">"yevgeniy.brikman"</span>
         + path                 = <span class="hljs-string">"/"</span><font></font>
         + unique_id         = (known after apply)<font></font>
      }<font></font>
<font></font>
Plan: <span class="hljs-number">1</span> to add, <span class="hljs-number">0</span> to change, <span class="hljs-number">0</span> to destroy.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ executar o comando apply, obt√©m o seguinte erro:</font></font><br>
<br>
<pre><code class="java hljs">Error: Error creating IAM User yevgeniy.brikman: EntityAlreadyExists:<font></font>
User with name yevgeniy.brikman already exists.<font></font>
<font></font>
   on main.tf line <span class="hljs-number">10</span>, in resource <span class="hljs-string">"aws_iam_user"</span> <span class="hljs-string">"existing_user"</span>:
   <span class="hljs-number">10</span>: resource <span class="hljs-string">"aws_iam_user"</span> <span class="hljs-string">"existing_user"</span> {</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema, √© claro, √© que um usu√°rio do IAM com esse nome j√° existe. E isso pode acontecer n√£o apenas com usu√°rios do IAM, mas tamb√©m com quase qualquer recurso. √â poss√≠vel que algu√©m tenha criado esse recurso manualmente ou usando a linha de comando, mas seja como for, os identificadores correspondentes levam a conflitos. H√° muitos sabores nesse erro que geralmente surpreendem os iniciantes do Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponto principal √© que o comando do plano de terraform considera apenas os recursos especificados no arquivo de status do Terraform. Se os recursos forem criados de alguma outra maneira (por exemplo, manualmente, clicando no console da AWS), eles n√£o entrar√£o no arquivo de status e, portanto, o Terraform n√£o os levar√° em considera√ß√£o ao executar o comando plan. Como resultado, o plano correto √† primeira vista n√£o ter√° √™xito.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duas li√ß√µes podem ser aprendidas com isso.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ j√° come√ßou a trabalhar com o Terraform, n√£o use mais nada. </font><font style="vertical-align: inherit;">Se parte da sua infraestrutura for gerenciada usando o Terraform, voc√™ n√£o poder√° mais modific√°-la manualmente. </font><font style="vertical-align: inherit;">Caso contr√°rio, voc√™ n√£o apenas corre o risco de obter erros estranhos do Terraform, mas tamb√©m nega os muitos benef√≠cios do IaC, pois o c√≥digo n√£o ser√° mais uma representa√ß√£o precisa da sua infraestrutura.</font></font></li>
<li>     - ,   import.     Terraform    ,          terraform import.  Terraform  ,    .  import   .        .    ,      : _. ( aws_iam_user.existing_user).   ‚Äî   ,   . ,   ID  aws_iam_user    (, yevgeniy.brikman),  ID  aws_instance    EC2 ( i-190e22e5). ,   ,       .<br>
<br>
   import,    aws_iam_user,       Terraform    IAM   2 (,  yevgeniy.brikman    ):<br>
<br>
<pre><code class="plaintext hljs">$ terraform import aws_iam_user.existing_user yevgeniy.brikman</code></pre><br>
Terraform   API AWS,     IAM           aws_iam_user.existing_user    Terraform.       plan Terraform  ,   IAM  ,        .<br>
<br>
 , ,       ,      Terraform,              .       ,  Terraforming (http://terraforming.dtan4.net/),        AWS   .<br>
<br>
<h3>    </h3><br>
<i></i> ‚Äî    ,      ,     .  ,     ,     .  ‚Äî   ,    . ,     Terraform     IaC,      ,      ¬´ ¬ª  ,    .<br>
<br>
,    ‚Äî       .  IDE               .        ,     ,   Terraform      ,       .<br>
<br>
 ,   webserver-cluster    cluster_name:<br>
<br>
<pre><code class="java hljs">variable <span class="hljs-string">"cluster_name"</span> {<font></font>
   description = <span class="hljs-string">"The name to use for all the cluster resources"</span><font></font>
   type          = string<font></font>
}</code></pre><br>
,            foo.        bar.     ,    -      .<br>
<br>
  ,   webserver-cluster   cluster_name    ,   name     ALB:<br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb"</span> <span class="hljs-string">"example"</span> {<font></font>
   name                    = <span class="hljs-keyword">var</span>.cluster_name<font></font>
   load_balancer_type = <span class="hljs-string">"application"</span>
   subnets = data.aws_subnet_ids.<span class="hljs-keyword">default</span>.ids<font></font>
   security_groups      = [aws_security_group.alb.id]<font></font>
}</code></pre><br>
   name  - , Terraform          .      ALB,                    -.   ,    ,       ,      .<br>
<br>
   ,    ,    Terraform.      aws_security_group   webserver-cluster:<br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"instance"</span> {<font></font>
  # (...)<font></font>
}</code></pre><br>
    instance. ,            (  )  cluster_instance:<br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"cluster_instance"</span> {<font></font>
   # (...)<font></font>
}</code></pre><br>
   ? :   .<br>
<br>
Terraform  ID      . , iam_user     IAM  AWS,  aws_instance ‚Äî  ID  AWS EC2.     (,  instance  cluster_instance,     aws_security_group),  Terraform    ,        .    , Terraform       ,          .<br>
<br>
   ,       .<br>
<br>
<ul>
<li>   plan.      .         ,  Terraform   , ,  ,   .</li>
<li>,   .     ,  ,       .   ,     create_before_destroy.      ,   :          apply,           apply  .</li>
<li>    .     ,    (,  aws_security_group  instance  cluster_instance),          ,       Terraform.      ‚Äî     terraform state.       terraform state mv,    :<br>
<br>
<pre><code class="plaintext hljs">terraform state mv &lt;ORIGINAL_REFERENCE&gt; &lt;NEW_REFERENCE&gt;</code></pre><br>
ORIGINAL_REFERENCE ‚Äî  ,       ,  NEW_REFERENCE ‚Äî  ,     . ,    aws_security_group  instance  cluster_instance    :<br>
<br>
<pre><code class="java hljs">$ terraform state mv \<font></font>
   aws_security_group.instance \<font></font>
   aws_security_group.cluster_instance</code></pre><br>
   Terraform,  ,     aws_security_group.instance,      aws_security_group.cluster_instance.        terraform plan    , ,    .</li>
</ul><br>
<ul>
<li>   .    .    , Terraform        .      ,        ,      .    plan      create_before_destroy.</li>
</ul><br>
<h3>  ‚Ä¶  </h3><br>
API   ,   AWS,     .  ,       ,     .   ,          ;   ,         ,        API-.<br>
<br>
,  ,    API-  AWS     EC2. API  ¬´¬ª  (201 Created)  ,     .        ,     ,     AWS     ,  ,    .  ,      ,      ,    (404 Not Found).   ,      EC2      AWS,     ,    .<br>
<br>
    API         ,         .  , AWS SDK       ,   Terraform       6813 (https://github.com/hashicorp/terraform/issues/6813):<br>
<br>
<pre><code class="java hljs">$ terraform apply<font></font>
aws_subnet.<span class="hljs-keyword">private</span>-persistence<span class="hljs-number">.2</span>: InvalidSubnetID.NotFound:<font></font>
The subnet ID <span class="hljs-string">'subnet-xxxxxxx'</span> does not exist</code></pre><br>
 ,    (, )       -  ( ID    ),  Terraform    .     ( 6813)  ,        ,    Terraform     .  ,        .    terraform apply   ,         .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´Terraform:    ¬ª</a>.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496804/index.html">Instalando e configurando o Docker no Windows Subsystem Linux (WSL)</a></li>
<li><a href="../pt496810/index.html">An√°lise Financeira Geral em Python (Parte 3)</a></li>
<li><a href="../pt496812/index.html">Zoom - neglig√™ncia banal ou espionagem direcionada?</a></li>
<li><a href="../pt496816/index.html">Voc√™ pode sentir o candidato, ele est√° vivo?</a></li>
<li><a href="../pt496818/index.html">Centenas de milhares de rotas por segundo por n√∫cleo. Experi√™ncia Yandex.Routing</a></li>
<li><a href="../pt496822/index.html">Como as startups nos Estados Unidos morrem devido ao coronav√≠rus</a></li>
<li><a href="../pt496824/index.html">Seu ambiente de trabalho n√≥rdico</a></li>
<li><a href="../pt496826/index.html">Milh√µes de sprites a mais de 120 fps</a></li>
<li><a href="../pt496828/index.html">Onde encontrar freelancers que ser√£o divertidos? (Spoiler: n√£o funciona)</a></li>
<li><a href="../pt496830/index.html">O que √© Comunica√ß√£o Emergente e por que voc√™ precisa saber</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>