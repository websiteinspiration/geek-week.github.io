<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèöÔ∏è üñäÔ∏è üÜô Novo frontend do Odnoklassniki: iniciando o React em Java. parte II üëµüèæ üßñüèª üë®üèø‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos a hist√≥ria de como, dentro do Odnoklassniki, usando o GraalVM, conseguimos fazer amizade com Java e JavaScript e come√ßamos a migrar para u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Novo frontend do Odnoklassniki: iniciando o React em Java. parte II</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/486810/"><img src="https://habrastorage.org/webt/sz/_g/7x/sz_g7xhw5t9siczpovdjhzzsgru.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuamos a hist√≥ria de como, dentro do Odnoklassniki, usando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVM,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conseguimos fazer amizade com Java e JavaScript e come√ßamos a migrar para um sistema enorme com muito c√≥digo legado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na segunda parte do artigo, falaremos em detalhes sobre o lan√ßamento, a montagem e a integra√ß√£o de aplicativos na nova pilha, abordaremos as especificidades de seus trabalhos no cliente e no servidor, al√©m de discutirmos as dificuldades encontradas no caminho e descreveremos solu√ß√µes para ajud√°-los a superar . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ n√£o leu a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeira parte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu recomendo fazer isso. </font><font style="vertical-align: inherit;">A partir disso, voc√™ aprender√° sobre a hist√≥ria do front-end em Odnoklassniki e se familiarizar com seus recursos hist√≥ricos, percorrer√° o caminho de encontrar uma solu√ß√£o para os problemas que se acumularam em nossos 13 anos de projeto e, no final, mergulhar√° nos recursos t√©cnicos da implementa√ß√£o do servidor da decis√£o que tomamos.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o da interface do usu√°rio</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escrever o c√≥digo da interface do usu√°rio, escolhemos as ferramentas mais avan√ßadas: Reaja junto com MobX, CSS Modules, ESLint, TypeScript, Lerna. </font><font style="vertical-align: inherit;">Tudo isso √© coletado usando o Webpack.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ed/tp/gx/edtpgxyuy6rxy4nvalwn_dhhkva.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura de aplicativos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como foi escrito na parte anterior deste artigo, para implementar a migra√ß√£o gradual, inseriremos novos componentes no site em elementos DOM com nomes personalizados que funcionar√£o dentro da nova pilha da interface do usu√°rio, enquanto no restante do site parecer√° um elemento DOM com sua API. O conte√∫do desses elementos pode ser renderizado no servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que √© isso? L√° dentro, h√° um aplicativo MVC moderno, bacana e moderno, executando o React e fornecendo a API DOM padr√£o externa: atributos, m√©todos neste elemento DOM e eventos.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fg/um/dw/fgumdwotb43klsvwwtlvx4x1bd4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para executar esses componentes, desenvolvemos um mecanismo especial. O que ele est√° fazendo? Inicialmente, inicializa o aplicativo de acordo com sua descri√ß√£o. Em segundo lugar, vincula o componente ao n√≥ DOM espec√≠fico no qual √© iniciado. Tamb√©m existem dois mecanismos (para o cliente e o servidor) que podem encontrar e renderizar esses componentes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/dg/wz/lndgwzg5ggcfgsnnsfdnrdmue8u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que isso √© necess√°rio? O fato √© que, quando todo o site √© criado no React, geralmente o componente do site √© renderizado no elemento raiz da p√°gina, e esse componente n√£o importa o que est√° fora, mas apenas o que est√° dentro √© interessante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, tudo √© mais complicado: v√°rias aplica√ß√µes precisam da oportunidade de dizer √† nossa p√°gina no site "Eu sou, e algo est√° mudando em mim". Por exemplo, o calend√°rio precisa lan√ßar um evento em que o usu√°rio clicou no bot√£o, e a data foi alterada ou fora dela, voc√™ precisa da capacidade para que, dentro do calend√°rio, voc√™ possa alterar a data. Para isso, o mecanismo de aplicativo implementa fachadas na funcionalidade b√°sica do aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao entregar um componente para um cliente, √© necess√°rio que o mecanismo do site antigo possa iniciar esse componente. Para fazer isso, durante a constru√ß√£o, as informa√ß√µes necess√°rias para seu lan√ßamento s√£o coletadas.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
        <span class="hljs-attr">"bundleName"</span>: <span class="hljs-string">"events-calendar"</span>,
        <span class="hljs-attr">"js"</span>: <span class="hljs-string">"events-calendar-h4h5m.js"</span>,
        <span class="hljs-attr">"css"</span>: <span class="hljs-string">"events-calendar-h4h5m.css"</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Marcadores especiais s√£o adicionados aos atributos da tag do componente, que dizem que esse aplicativo √© de um novo tipo, seu c√≥digo pode ser obtido de um arquivo JS espec√≠fico. </font><font style="vertical-align: inherit;">Ao mesmo tempo, possui seus pr√≥prios atributos necess√°rios para inicializar esse componente: eles formam o estado inicial do componente na loja.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">events-calendar</span>	<span class="hljs-attr">data-module</span>=<span class="hljs-string">"react-loader"</span>
			<span class="hljs-attr">data-bundle</span>=<span class="hljs-string">"events-calendar.js"</span>
			<span class="hljs-attr">date</span>=<span class="hljs-string">".."</span>
			<span class="hljs-attr">marks</span>=<span class="hljs-string">"[{..}]"</span>
			‚Ä¶
/&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reidrata√ß√£o, n√£o √© uma convers√£o do estado do aplicativo usado, mas atributos, que permitem economizar no tr√°fego. </font><font style="vertical-align: inherit;">Eles v√™m em uma forma normalizada e, em regra, s√£o menores que o armazenamento que o aplicativo cria. </font><font style="vertical-align: inherit;">Ao mesmo tempo, o tempo para recriar a loja a partir dos atributos no cliente √© curto, portanto eles geralmente podem ser negligenciados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, para o calend√°rio, os atributos t√™m apenas uma data destacada e a loja j√° possui uma matriz com informa√ß√µes completas para o m√™s. </font><font style="vertical-align: inherit;">Obviamente, n√£o faz sentido transferi-lo do servidor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como executar o c√≥digo?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O conceito foi testado em fun√ß√µes simples que fornecem uma linha para o servidor ou escrevem innerHTML para o cliente. Mas no c√≥digo real existem m√≥dulos e TypeScript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem solu√ß√µes padr√£o para o cliente, por exemplo, coletando c√≥digo usando o Webpack, que processa tudo e o fornece ao cliente na forma de um pacote configur√°vel. E o que fazer para o servidor ao usar o GraalVM?</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/sr/f7/yn/srf7ynd8airmxgybkgu4wnpe82c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos considerar duas op√ß√µes. A primeira √© digitar TypeScript em JavaScript, como acontece no Node.js. Infelizmente, esta op√ß√£o n√£o funciona em nossa configura√ß√£o quando o JavaScript √© o idioma do convidado no GraalVM. Nesse caso, o JavaScript n√£o possui um sistema modular nem assincronia. Porque a modularidade e o trabalho com assincronia fornecem um tempo de execu√ß√£o espec√≠fico: NodeJS ou um navegador. E, no nosso caso, o servidor possui JavaScript que s√≥ pode executar c√≥digo de forma s√≠ncrona.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda op√ß√£o - voc√™ pode simplesmente executar no c√≥digo do servidor a partir dos mesmos arquivos que foram coletados para o cliente. E esta op√ß√£o funciona. Mas h√° um problema que o servidor precisa de outras implementa√ß√µes para v√°rios m√©todos. Por exemplo, a fun√ß√£o renderToString () ser√° chamada no servidor para renderizar o componente e ReactDOM.render () no cliente. Ou outro exemplo do artigo anterior: para obter textos e configura√ß√µes no servidor, a fun√ß√£o que Java fornece ser√° chamada e, no cliente, ser√° uma implementa√ß√£o em JS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como solu√ß√£o para esse problema, voc√™ pode usar aliases do Webpack. Eles permitem que voc√™ crie duas implementa√ß√µes da classe que precisamos: para o cliente e o servidor. Em seguida, nos arquivos de configura√ß√£o do cliente e servidor, especifique a implementa√ß√£o apropriada.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/rb/0o/carb0o0rvb1q0pw8eerxnsy4ova.jpeg"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas dois arquivos de configura√ß√£o s√£o dois assemblies. </font><font style="vertical-align: inherit;">Cada vez, coletar tudo separadamente para o servidor e para o cliente √© longo e dif√≠cil no suporte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ precisa criar essa configura√ß√£o para que tudo seja coletado de uma s√≥ vez.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do Webpack para executar JS no servidor e cliente</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para encontrar uma solu√ß√£o para esse problema, vamos ver em quais partes o projeto consiste: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zh/mi/e9/zhmie9o6zghd5vgeyd10pjonffq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, o projeto possui tempo de execu√ß√£o de terceiros (fornecedores), o mesmo para o cliente e o servidor. </font><font style="vertical-align: inherit;">Quase nunca muda. </font><font style="vertical-align: inherit;">O Rantime pode ser fornecido ao usu√°rio e ele ser√° armazenado em cache no cliente at√© atualizarmos a vers√£o da biblioteca de terceiros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, existe o nosso tempo de execu√ß√£o (core), que garante o lan√ßamento do aplicativo. </font><font style="vertical-align: inherit;">Possui m√©todos com diferentes implementa√ß√µes para o cliente e o servidor. </font><font style="vertical-align: inherit;">Por exemplo, obtendo textos de localiza√ß√£o, configura√ß√µes e assim por diante. </font><font style="vertical-align: inherit;">Esse tempo de execu√ß√£o tamb√©m muda com pouca frequ√™ncia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em terceiro lugar, h√° um c√≥digo de componente. </font><font style="vertical-align: inherit;">√â o mesmo para o cliente e o servidor, o que permite depurar o c√≥digo do aplicativo no navegador sem iniciar o servidor. </font><font style="vertical-align: inherit;">Se algo der errado no cliente, voc√™ poder√° ver os erros no console do navegador, lembre-se de tudo e verifique se n√£o haver√° erros ao iniciar no servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No total, s√£o obtidas tr√™s partes que precisam ser montadas. </font><font style="vertical-align: inherit;">N√≥s queremos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure separadamente a montagem de cada pe√ßa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coloque as depend√™ncias entre eles para que cada parte n√£o caia no que est√° na outra.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Colete tudo de uma s√≥ vez.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como descrever separadamente as partes em que a montagem ser√° composta? </font><font style="vertical-align: inherit;">H√° uma configura√ß√£o multiconfigurada no webpack: voc√™ simplesmente distribui uma matriz de exporta√ß√µes dos m√≥dulos inclu√≠dos em cada parte.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = [{
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./vendors.js'</span>,<font></font>
}, {<font></font>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./core.js'</span><font></font>
}, {<font></font>
 <span class="hljs-attr">entry</span>: <span class="hljs-string">'./app.js'</span><font></font>
}];<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo ficaria bem, mas em cada uma dessas partes o c√≥digo dos m√≥dulos dos quais essa parte depende ser√° duplicado: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/am/ax/utamaxl7z4op6x8iivfcmufn7ec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, no conjunto b√°sico de plugins do webpack, h√° o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DllPlugin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que permite obter uma lista dos m√≥dulos inclu√≠dos para cada pe√ßa montada. Por exemplo, para fornecedor, voc√™ pode descobrir quais m√≥dulos espec√≠ficos est√£o inclu√≠dos nesta parte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao construir outra parte, por exemplo, bibliotecas principais, podemos dizer que elas dependem da parte do fornecedor. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/nv/lu/el/nvluelzxzvy_5oofujylu4wmufk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, durante a montagem do webpack, o DllPlugin ver√° o n√∫cleo, dependendo de alguma biblioteca que j√° esteja no fornecedor, e n√£o o adicionar√° ao n√∫cleo, mas simplesmente colocar√° um link para ele.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, tr√™s pe√ßas s√£o montadas por vez e dependem uma da outra. </font><font style="vertical-align: inherit;">Quando o primeiro aplicativo √© baixado para o cliente, o tempo de execu√ß√£o e as bibliotecas principais s√£o salvas no cache do navegador. </font><font style="vertical-align: inherit;">E como o Odnoklassniki √© um site, a guia com a qual o usu√°rio pode abrir "para sempre", a exclus√£o ocorrer√° muito raramente. </font><font style="vertical-align: inherit;">Na maioria dos casos, com os lan√ßamentos de novas vers√µes do site, apenas o c√≥digo do aplicativo ser√° atualizado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entrega de Recursos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere o problema pelo exemplo de trabalho com textos localizados armazenados em um banco de dados separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se anteriormente, em algum lugar do servidor, voc√™ precisava de texto no componente, poderia chamar a fun√ß√£o para obter o texto.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    : { pkg.getText('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obter texto no servidor n√£o √© dif√≠cil, porque o aplicativo do servidor pode fazer uma solicita√ß√£o r√°pida ao banco de dados ou at√© armazenar em cache todos os textos na mem√≥ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como obter textos em componentes em uma rea√ß√£o que s√£o renderizados em um servidor no GraalVM? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conforme discutido na primeira parte do artigo, no contexto JS, voc√™ pode adicionar m√©todos ao objeto global que deseja acessar do JavaScript. </font><font style="vertical-align: inherit;">Decidiu-se criar uma classe com todos os m√©todos dispon√≠veis para JavaScript.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerMethods</span> </span>{<font></font>
    ‚Ä¶<font></font>
    <font></font>
    <span class="hljs-comment">/**
     *     
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getText</span><span class="hljs-params">(String pkg, String key)</span> </span>{<font></font>
        ‚Ä¶<font></font>
    }<font></font>
    <font></font>
    ‚Ä¶<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, coloque uma inst√¢ncia dessa classe no contexto global do JavaScript:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//     Java   </span>
js.putMember(<span class="hljs-string">"serverMethods"</span>, serverMethods);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, do JavaScript na implementa√ß√£o do servidor, simplesmente chamamos a fun√ß√£o:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getText</span>(<span class="hljs-params">pkg: string, key: string</span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> global.serverMethods.getText(pkg, key);<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, essa ser√° uma chamada de fun√ß√£o em Java que retornar√° o texto solicitado. Intera√ß√£o s√≠ncrona direta e sem chamadas HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, no cliente, leva muito tempo para revisar o HTTP e receber textos para cada chamada para a fun√ß√£o de inser√ß√£o de texto nos componentes. Voc√™ pode fazer o pr√©-download de todos os textos para o cliente, mas apenas os textos pesam dezenas de megabytes e existem outros tipos de recursos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lg/6e/ij/lg6eijxb_rvzshqiyih2gyuvy5a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O usu√°rio se cansar√° de esperar at√© que tudo seja baixado antes de iniciar o aplicativo. Portanto, este m√©todo n√£o √© adequado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gostaria de receber apenas os textos necess√°rios em uma aplica√ß√£o espec√≠fica. Nossos textos s√£o divididos em pacotes. Portanto, voc√™ pode coletar os pacotes necess√°rios para o aplicativo e baix√°-los junto com o pacote. Quando o aplicativo iniciar, todos os textos j√° estar√£o no cache do cliente.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como descobrir quais textos um aplicativo precisa? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entramos em um acordo de que pacotes de textos no c√≥digo s√£o obtidos chamando a fun√ß√£o l10n (), na qual o nome do pacote √© transmitido SOMENTE na forma de uma string literal:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    { pkg.getLMsg('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s escrevemos um plugin webpack que, analisando a √°rvore AST da √°rvore de c√≥digos de componentes, localiza todas as chamadas para a fun√ß√£o l10n () e coleta nomes de pacotes dos argumentos. </font><font style="vertical-align: inherit;">Da mesma forma, o plug-in coleta informa√ß√µes sobre outros tipos de recursos necess√°rios ao aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na sa√≠da ap√≥s a montagem para cada aplicativo, obtemos uma configura√ß√£o com seus recursos:</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
       <span class="hljs-attr">"pkg"</span>:  [
           <span class="hljs-string">"calendar"</span>,
           <span class="hljs-string">"dates"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"cfg"</span>:  [
           <span class="hljs-string">"config1"</span>,
           <span class="hljs-string">"config2"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"bundleName"</span>:  <span class="hljs-string">"events-calendar"</span>,
       <span class="hljs-attr">"js"</span>:  <span class="hljs-string">"events-calendar.js"</span>,
       <span class="hljs-attr">"css"</span>:  <span class="hljs-string">"events-calendar.css"</span>,<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, √© claro, n√£o devemos esquecer a atualiza√ß√£o dos textos. </font><font style="vertical-align: inherit;">Como no servidor, todos os textos est√£o sempre atualizados e o cliente precisa de um mecanismo de atualiza√ß√£o de cache separado, por exemplo, observador ou push.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo antigo em novo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com uma transi√ß√£o suave, surge o problema de reutilizar o c√≥digo antigo em novos componentes, porque existem componentes grandes e complexos (por exemplo, um reprodutor de v√≠deo), reescri√ß√µes que levar√£o muito tempo e voc√™ precisar√° us√°-los agora na nova pilha. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/pg/te/jzpgtesmq75odhrqyvbg2grbw9u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais s√£o os problemas?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O site antigo e os novos aplicativos React t√™m ciclos de vida completamente diferentes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ colar o c√≥digo da amostra antiga no aplicativo React, esse c√≥digo n√£o ser√° iniciado, porque o React n√£o sabe como ativ√°-lo. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devido a diferentes ciclos de vida, o React e o mecanismo antigo podem tentar modificar simultaneamente o conte√∫do do c√≥digo antigo, o que pode causar efeitos colaterais desagrad√°veis. </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver esses problemas, uma classe base comum foi alocada para componentes contendo c√≥digo antigo. </font><font style="vertical-align: inherit;">A classe permite que os herdeiros coordenem os ciclos de vida dos aplicativos React e de estilo antigo.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-attr">ref</span>: React.RefObject&lt;HTMLElement&gt; = React.createRef();<font></font>
<font></font>
    componentDidMount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.activate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    componentWillUnmount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.deactivate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    shouldComponentUpdate() {<font></font>
        <span class="hljs-comment">// React     , </span>
        <span class="hljs-comment">//   React-. </span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    render() {<font></font>
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.ref}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
        );<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe permite que voc√™ crie trechos de c√≥digo que funcionam da maneira antiga ou destrua, enquanto n√£o haver√° intera√ß√£o simult√¢nea com eles. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cole o c√≥digo antigo no servidor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na pr√°tica, h√° a necessidade de componentes de wrapper (por exemplo, pop-ups), cujo conte√∫do pode ser qualquer, incluindo aqueles criados usando tecnologias antigas. </font><font style="vertical-align: inherit;">Voc√™ precisa descobrir como incorporar qualquer c√≥digo no servidor dentro desses componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um artigo anterior, falamos sobre o uso de atributos para passar par√¢metros para novos componentes no cliente e no servidor.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span> <span class="hljs-attr">users</span>=<span class="hljs-string">"[1,2,3]"</span> /&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora ainda queremos inserir um peda√ßo de marca√ß√£o l√°, o que em sentido n√£o √© um atributo. </font><font style="vertical-align: inherit;">Para isso, decidiu-se usar um sistema de slots.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ui:part</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>old component<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ui:part</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver no exemplo acima, dentro do c√≥digo do componente do aplicativo legal, √© descrito um slot de c√≥digo antigo contendo componentes antigos. </font><font style="vertical-align: inherit;">Em seguida, dentro do componente react, o local em que voc√™ deseja colar o conte√∫do deste slot √© indicado:</font></font><br>
<br>
<pre><code class="javascript hljs">render() {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UiPart</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mecanismo do servidor renderiza esse componente de rea√ß√£o e enquadra o conte√∫do do slot na tag &lt;ui-part&gt;, atribuindo o atributo data-part-id = "old-code" a ele. </font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a renderiza√ß√£o do servidor de JS no GraalVM n√£o couber no tempo limite, fazemos o fallback da renderiza√ß√£o do cliente. </font><font style="vertical-align: inherit;">Para fazer isso, o mecanismo no servidor fornece apenas slots, enquadrando-os na tag template, para que o navegador n√£o interaja com seu c√≥digo.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que est√° acontecendo no cliente? </font><font style="vertical-align: inherit;">O mecanismo do cliente simplesmente varre o c√≥digo do componente, coleta as tags &lt;ui-part&gt;, recebe seu conte√∫do como seq√º√™ncias de caracteres e as passa para a fun√ß√£o de renderiza√ß√£o junto com o restante dos par√¢metros.</font></font><br>
 <br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> tagName = <span class="hljs-string">'cool-app'</span>;
<span class="hljs-keyword">var</span> reactComponent = components[tagName];<font></font>
reactComponent.render({<font></font>
       <span class="hljs-attr">tagName</span>: tagName,
       <span class="hljs-attr">attrs</span>: attrs,
       <span class="hljs-attr">parts</span>: parts,
       <span class="hljs-attr">node</span>: element<font></font>
});<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo do componente que insere os slots no local desejado √© o seguinte: </font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UiPart</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">IProps</span>&gt; </span>{<font></font>
<font></font>
	render() {<font></font>
		<span class="hljs-keyword">const</span> id = <span class="hljs-keyword">this</span>.props.id;
		<span class="hljs-keyword">const</span> parts = <span class="hljs-keyword">this</span>.props.parts;<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (!parts.hasOwnProperty(id)) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">return</span> React.createElement(<span class="hljs-string">'ui-part'</span>, {
			<span class="hljs-string">'data-part-id'</span>: id,
			<span class="hljs-attr">ref</span>: <span class="hljs-keyword">this</span>.ref,
			<span class="hljs-attr">dangerouslySetInnerHTML</span>: { <span class="hljs-attr">__html</span>: parts[id] }<font></font>
		});<font></font>
	}<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, √© herdado da classe OldCodeBase, que resolve os problemas de intera√ß√£o entre a pilha antiga e a nova. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ge/cc/a3/gecca3dlxac9crp48u9pvoyc4vs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode escrever um pop-up e preench√™-lo usando a nova pilha ou solicita√ß√£o do servidor usando a abordagem antiga. </font><font style="vertical-align: inherit;">Nesse caso, os componentes funcionar√£o corretamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso permite migrar gradualmente os componentes do site para uma nova pilha. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apenas esse foi um dos principais requisitos para o novo frontend.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo mundo est√° se perguntando o qu√£o r√°pido o GraalVM funciona. </font><font style="vertical-align: inherit;">Os desenvolvedores do Odnoklassniki realizaram v√°rios testes com os aplicativos React. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma fun√ß√£o simples que retorna uma string ap√≥s o aquecimento leva cerca de 1 microssegundo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Componentes (novamente ap√≥s o aquecimento) - de 0,5 a 6 milissegundos, dependendo do tamanho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O GraalVM acelera mais lentamente que o V8. </font><font style="vertical-align: inherit;">Mas, durante o per√≠odo de aquecimento, a situa√ß√£o √© suavizada gra√ßas ao fallback da renderiza√ß√£o do cliente. </font><font style="vertical-align: inherit;">Como existem muitos usu√°rios, a m√°quina virtual esquenta rapidamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que voc√™ conseguiu fazer</font></font></h3><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execute o JavaScript no servidor no mundo Java dos Classmates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie c√≥digo isom√≥rfico para a interface do usu√°rio.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use uma pilha moderna que todos os fornecedores de front-end conhecem.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie uma plataforma comum e uma abordagem √∫nica para escrever a interface do usu√°rio.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicie uma transi√ß√£o suave sem complicar a opera√ß√£o e sem diminuir a renderiza√ß√£o do servidor.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esperamos que as experi√™ncias e exemplos do Odnoklassniki sejam √∫teis para voc√™ e voc√™ os encontrar√° para usar em seu trabalho.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486798/index.html">Existe um GameDev em Sakhalin? Fim</a></li>
<li><a href="../pt486800/index.html">Cassandra. Como n√£o morrer se voc√™ conhece apenas Oracle</a></li>
<li><a href="../pt486802/index.html">As pessoas conhecem os sistemas de recomenda√ß√£o. Fatora√ß√£o</a></li>
<li><a href="../pt486804/index.html">Inform√°tica em Sa√∫de Global: Tecnologias em Nuvem</a></li>
<li><a href="../pt486808/index.html">Teste de gravidez eletr√¥nico em uma farm√°cia: como funciona</a></li>
<li><a href="../pt486814/index.html">Zabbix: a topologia de rede √© clara e autom√°tica</a></li>
<li><a href="../pt486818/index.html">Portando o Quake para o iPod Classic</a></li>
<li><a href="../pt486820/index.html">70 perguntas da entrevista sobre Javascript</a></li>
<li><a href="../pt486822/index.html">[Pelas docas] Flutter. Parte 4. Para desenvolvedores web</a></li>
<li><a href="../pt486824/index.html">Maus conselhos ao trabalhar com a ANTLR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>