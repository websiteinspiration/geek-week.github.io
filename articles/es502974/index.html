<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíî „ÄΩÔ∏è üçò Implementaciones de C # en C # .NET üëéüèª üôÅ ü•ß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! En previsi√≥n del inicio del curso "C # ASP.NET Core Developer" , preparamos una traducci√≥n de material interesante sobre la implementaci√≥n ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementaciones de C # en C # .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/502974/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font><font style="vertical-align: inherit;">En previsi√≥n del inicio del curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"C # ASP.NET Core Developer"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , preparamos una traducci√≥n de material interesante sobre la implementaci√≥n de la memoria cach√© en C #. </font><font style="vertical-align: inherit;">Disfruta leyendo.</font></font></b></i><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los patrones m√°s utilizados en el desarrollo de software es el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento en cach√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es un concepto simple y, al mismo tiempo, muy efectivo. La idea es reutilizar los resultados de las operaciones realizadas. Despu√©s de una operaci√≥n que lleva mucho tiempo, guardamos el resultado en nuestro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenedor de cach√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La pr√≥xima vez que necesitemos este resultado, lo extraeremos del contenedor de cach√©, en lugar de tener que realizar una operaci√≥n laboriosa nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, para obtener un avatar de usuario, es posible que deba solicitarlo desde la base de datos. En lugar de ejecutar la solicitud con cada llamada, almacenaremos este avatar en el cach√©, extray√©ndolo de la memoria cada vez que lo necesite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El almacenamiento en cach√© es excelente para los datos que cambian con poca frecuencia. </font><font style="vertical-align: inherit;">O, idealmente, nunca cambian. </font><font style="vertical-align: inherit;">Los datos que cambian constantemente, por ejemplo, la hora actual, no deben almacenarse en cach√©, de lo contrario corre el riesgo de obtener resultados incorrectos.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cach√© local, cach√© local persistente y cach√© distribuida</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay 3 tipos de cach√©s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La memoria cach√© en memoria se usa para casos en los que solo necesita implementar la memoria cach√© en un proceso. </font><font style="vertical-align: inherit;">Cuando un proceso muere, el cach√© muere con √©l. </font><font style="vertical-align: inherit;">Si est√° ejecutando el mismo proceso en varios servidores, tendr√° un cach√© separado para cada servidor.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cach√© en proceso persistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : esto es cuando realiza una copia de seguridad del cach√© fuera de la memoria del proceso. </font><font style="vertical-align: inherit;">Se puede ubicar en un archivo o en una base de datos. </font><font style="vertical-align: inherit;">Es m√°s complejo que el cach√© en la memoria, pero si el proceso se reinicia, el cach√© no se vac√≠a. </font><font style="vertical-align: inherit;">Se adapta mejor a los casos en los que obtener un elemento almacenado en cach√© es costoso y su proceso tiende a reiniciarse con frecuencia.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cach√© distribuida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es cuando necesita una cach√© compartida para varias m√°quinas. </font><font style="vertical-align: inherit;">Por lo general, estos son varios servidores. </font><font style="vertical-align: inherit;">El cach√© distribuido se almacena en un servicio externo. </font><font style="vertical-align: inherit;">Esto significa que si un servidor ha retenido un elemento de cach√©, otros servidores tambi√©n pueden usarlo. </font><font style="vertical-align: inherit;">Servicios como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son excelentes para esto.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hablaremos sobre el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cach√© local</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n primitiva</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos creando una implementaci√≥n de cach√© muy simple en C #:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NaiveCache</span>&lt;TItem&gt;<font></font>
{<font></font>
    Dictionary&lt;<span class="hljs-keyword">object</span>, TItem&gt; _cache = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">object</span>, TItem&gt;();<font></font>
 <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TItem <span class="hljs-title">GetOrCreate</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> key, Func&lt;TItem&gt; createItem</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (!_cache.ContainsKey(key))<font></font>
        {<font></font>
            _cache[key] = createItem();<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> _cache[key];<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizando:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> _avatarCache = <span class="hljs-keyword">new</span> NaiveCache&lt;<span class="hljs-keyword">byte</span>[]&gt;();
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">var</span> myAvatar = _avatarCache.GetOrCreate(userId, () =&gt; _database.GetAvatar(userId));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo simple resuelve un problema importante. Para obtener un avatar de usuario, solo la primera solicitud ser√° la solicitud real de la base de datos. Los datos de avatar ( </font></font><code>byte []</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) por el resultado de la solicitud se almacenan en la memoria del proceso. Todas las solicitudes de avatar posteriores lo recuperar√°n de la memoria, ahorrando tiempo y recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, como la mayor√≠a de las cosas en programaci√≥n, las cosas no son tan simples. La implementaci√≥n anterior no es una buena soluci√≥n por varias razones. Por un lado, esta implementaci√≥n no es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segura para subprocesos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cuando se usa desde m√∫ltiples hilos, pueden ocurrir excepciones. Adem√°s, los elementos en cach√© permanecer√°n en la memoria para siempre, lo que en realidad es muy malo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es por eso que debemos eliminar elementos del cach√©:</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un cach√© puede comenzar a ocupar mucha memoria, lo que en √∫ltima instancia conduce a excepciones debido a su escasez y bloqueos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El alto consumo de memoria puede conducir a la presi√≥n de la memoria (tambi√©n conocida como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presi√≥n GC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">En este estado, el recolector de basura funciona mucho m√°s de lo que deber√≠a, lo que reduce el rendimiento.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es posible que sea necesario actualizar el cach√© cuando cambien los datos. </font><font style="vertical-align: inherit;">Nuestra infraestructura de almacenamiento en cach√© debe ser compatible con esta caracter√≠stica.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver estos problemas existen en el marco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de las pol√≠ticas de desplazamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tambi√©n conocido como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la eliminaci√≥n de la pol√≠tica - Pol√≠ticas de desalojo / eliminaci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Estas son las reglas para eliminar elementos del cach√© de acuerdo con la l√≥gica dada. </font><font style="vertical-align: inherit;">Entre las pol√≠ticas de eliminaci√≥n comunes se encuentran las siguientes:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una pol√≠tica de caducidad absoluta</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que elimina un elemento del cach√© despu√©s de un per√≠odo de tiempo fijo, pase lo que pase.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una pol√≠tica de caducidad deslizante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que elimina un elemento de la memoria cach√© si no se ha accedido a √©l durante un cierto per√≠odo de tiempo. </font><font style="vertical-align: inherit;">Es decir, si configuro el tiempo de caducidad en 1 minuto, el elemento permanecer√° en el cach√© mientras lo uso cada 30 segundos. </font><font style="vertical-align: inherit;">Si no lo uso durante m√°s de un minuto, el elemento se eliminar√°.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pol√≠tica de l√≠mite de tama√±o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que limitar√° el tama√±o de la memoria cach√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que hemos descubierto todo lo que necesitamos, pasemos a mejores soluciones.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejores soluciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mi gran decepci√≥n como blogger, Microsoft ya ha creado una maravillosa implementaci√≥n de cach√©. </font><font style="vertical-align: inherit;">Esto me priv√≥ del placer de crear una implementaci√≥n similar por m√≠ mismo, pero al menos la redacci√≥n de este art√≠culo tambi√©n es menor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mostrar√© una soluci√≥n de Microsoft, c√≥mo usarla de manera efectiva y luego c√≥mo mejorarla para algunos escenarios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.Caching / MemoryCache vs Microsoft.Extensions.Caching.Memory</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft tiene 2 soluciones, 2 paquetes diferentes de almacenamiento en cach√© de NuGet. </font><font style="vertical-align: inherit;">Ambos son geniales. </font><font style="vertical-align: inherit;">Seg√∫n las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendaciones de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microsoft, es preferible utilizarlo </font></font><code>Microsoft.Extensions.Caching.Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ya que se integra mejor con Asp. </font><font style="vertical-align: inherit;">NET Core. </font><font style="vertical-align: inherit;">Se puede </font><font style="vertical-align: inherit;">integrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√°cilmente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el mecanismo de inyecci√≥n de dependencia de Asp .NET Core. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay un ejemplo simple con </font></font><code>Microsoft.Extensions.Caching.Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SimpleMemoryCache</span>&lt;TItem&gt;<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> MemoryCache _cache = <span class="hljs-keyword">new</span> MemoryCache(<span class="hljs-keyword">new</span> MemoryCacheOptions());<font></font>
 <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TItem <span class="hljs-title">GetOrCreate</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> key, Func&lt;TItem&gt; createItem</span>)</span><font></font>
    {<font></font>
        TItem cacheEntry;<font></font>
        <span class="hljs-keyword">if</span> (!_cache.TryGetValue(key, <span class="hljs-keyword">out</span> cacheEntry)) <span class="hljs-comment">//    .</span><font></font>
        {<font></font>
            <span class="hljs-comment">//    ,   .</span><font></font>
            cacheEntry = createItem();<font></font>
            <font></font>
            <span class="hljs-comment">//    . </span><font></font>
            _cache.Set(key, cacheEntry);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> cacheEntry;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizando:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> _avatarCache = <span class="hljs-keyword">new</span> SimpleMemoryCache&lt;<span class="hljs-keyword">byte</span>[]&gt;();
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">var</span> myAvatar = _avatarCache.GetOrCreate(userId, () =&gt; _database.GetAvatar(userId));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me recuerda mucho al m√≠o </font></font><code>NaiveCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces, ¬øqu√© ha cambiado? </font><font style="vertical-align: inherit;">Bueno, en primer lugar, es una </font><font style="vertical-align: inherit;">implementaci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segura para subprocesos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Puede llamarlo de manera segura desde m√∫ltiples hilos a la vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En segundo lugar, </font></font><code>MemoryCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene en cuenta todas las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pol√≠ticas de exclusi√≥n de las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que hablamos anteriormente. </font><font style="vertical-align: inherit;">Aqu√≠ hay un ejemplo: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMemoryCache con pol√≠ticas de preferencia:</font></font></b><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MemoryCacheWithPolicy</span>&lt;TItem&gt;<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> MemoryCache _cache = <span class="hljs-keyword">new</span> MemoryCache(<span class="hljs-keyword">new</span> MemoryCacheOptions()<font></font>
    {<font></font>
        SizeLimit = <span class="hljs-number">1024</span><font></font>
    });<font></font>
 <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TItem <span class="hljs-title">GetOrCreate</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> key, Func&lt;TItem&gt; createItem</span>)</span><font></font>
    {<font></font>
        TItem cacheEntry;<font></font>
        <span class="hljs-keyword">if</span> (!_cache.TryGetValue(key, <span class="hljs-keyword">out</span> cacheEntry))<span class="hljs-comment">//    .</span><font></font>
        {<font></font>
            <span class="hljs-comment">//    ,   . </span><font></font>
            cacheEntry = createItem();<font></font>
 <font></font>
            <span class="hljs-keyword">var</span> cacheEntryOptions = <span class="hljs-keyword">new</span> MemoryCacheEntryOptions()<font></font>
         	.SetSize(<span class="hljs-number">1</span>)<span class="hljs-comment">// </span>
         	<span class="hljs-comment">//        (  )</span><font></font>
                .SetPriority(CacheItemPriority.High)<font></font>
                <span class="hljs-comment">//       ,    .</span>
                 .SetSlidingExpiration(TimeSpan.FromSeconds(<span class="hljs-number">2</span>))
                <span class="hljs-comment">//       ,    .</span>
                .SetAbsoluteExpiration(TimeSpan.FromSeconds(<span class="hljs-number">10</span>));<font></font>
 <font></font>
            <span class="hljs-comment">//    .</span><font></font>
            _cache.Set(key, cacheEntry, cacheEntryOptions);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> cacheEntry;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analicemos los nuevos elementos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MemoryCacheOptions ha sido agregado </font></font><code>SizeLimit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto agrega una pol√≠tica de l√≠mite de tama√±o a nuestro contenedor de cach√©. </font><font style="vertical-align: inherit;">El cach√© no tiene un mecanismo para medir el tama√±o de los registros. </font><font style="vertical-align: inherit;">Por lo tanto, necesitamos establecer el tama√±o de cada entrada de cach√©. </font><font style="vertical-align: inherit;">En este caso, cada vez que establecemos el tama√±o en 1 con </font></font><code>SetSize(1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto significa que nuestro cach√© tendr√° un l√≠mite de 1024 elementos.</font></font></li>
<li>     ,      ?       <code>.SetPriority (CacheItemPriority.High)</code>.   : <b>Low (), Normal (), High ()</b>  <b>NeverRemove (  )</b>.</li>
<li><code>SetSlidingExpiration(TimeSpan.FromSeconds(2))</code>  <b>   </b>  2 .  ,         2 ,   .</li>
<li><code>SetAbsoluteExpiration(TimeSpan.FromSeconds(10))</code>  <b>   </b>  10 .  ,       10 ,      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de las opciones del ejemplo, tambi√©n puede establecer un delegado </font></font><code>RegisterPostEvictionCallback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que se llamar√° cuando se elimine el elemento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una gama bastante amplia de funciones, pero, sin embargo, debemos pensar si hay algo m√°s que agregar. </font><font style="vertical-align: inherit;">En realidad hay un par de cosas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas y caracter√≠sticas faltantes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay varias partes importantes que faltan en esta implementaci√≥n.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si bien puede establecer un l√≠mite de tama√±o, el almacenamiento en cach√© en realidad no controla la presi√≥n de la memoria. </font><font style="vertical-align: inherit;">Si monitoreamos, podr√≠amos endurecer la pol√≠tica con alta presi√≥n y debilitar la pol√≠tica con baja.</font></font></li>
<li>         ,      .     . , ,    ,        10 .      2    ,  ,     ( ),       .</li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Respecto al primer problema de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presi√≥n sobre gc: es posible controlar la presi√≥n sobre gc por varios m√©todos y heur√≠sticas. </font><font style="vertical-align: inherit;">Esta publicaci√≥n no trata sobre esto, pero puede leer mi art√≠culo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Encontrar, corregir y prevenir p√©rdidas de memoria en C # .NET: 8 mejores pr√°cticas"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para conocer algunos m√©todos √∫tiles. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El segundo problema es m√°s f√°cil de resolver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En realidad, aqu√≠ hay una implementaci√≥n </font></font><code>MemoryCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que lo resuelve por completo:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WaitToFinishMemoryCache</span>&lt;TItem&gt;<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> MemoryCache _cache = <span class="hljs-keyword">new</span> MemoryCache(<span class="hljs-keyword">new</span> MemoryCacheOptions());
    <span class="hljs-keyword">private</span> ConcurrentDictionary&lt;<span class="hljs-keyword">object</span>, SemaphoreSlim&gt; _locks = <span class="hljs-keyword">new</span> ConcurrentDictionary&lt;<span class="hljs-keyword">object</span>, SemaphoreSlim&gt;();<font></font>
 <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;TItem&gt; <span class="hljs-title">GetOrCreate</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> key, Func&lt;Task&lt;TItem&gt;&gt; createItem</span>)</span><font></font>
    {<font></font>
        TItem cacheEntry;<font></font>
 <font></font>
        <span class="hljs-keyword">if</span> (!_cache.TryGetValue(key, <span class="hljs-keyword">out</span> cacheEntry))<span class="hljs-comment">//    .</span><font></font>
        {<font></font>
            SemaphoreSlim mylock = _locks.GetOrAdd(key, k =&gt; <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>));<font></font>
 <font></font>
            <span class="hljs-keyword">await</span> mylock.WaitAsync();
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (!_cache.TryGetValue(key, <span class="hljs-keyword">out</span> cacheEntry))<font></font>
                {<font></font>
                    <span class="hljs-comment">//    ,   .</span>
                    cacheEntry = <span class="hljs-keyword">await</span> createItem();<font></font>
                    _cache.Set(key, cacheEntry);<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">finally</span><font></font>
            {<font></font>
                mylock.Release();<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> cacheEntry;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizando:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> _avatarCache = <span class="hljs-keyword">new</span> WaitToFinishMemoryCache&lt;<span class="hljs-keyword">byte</span>[]&gt;();
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">var</span> myAvatar =
<span class="hljs-keyword">await</span> _avatarCache.GetOrCreate(userId, <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> _database.GetAvatar(userId));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta implementaci√≥n, cuando intente obtener un elemento, si el mismo elemento ya est√° en proceso de ser creado por otro hilo, esperar√° hasta que se complete el primer hilo. </font><font style="vertical-align: inherit;">Luego obtendr√° un elemento ya almacenado en cach√© creado por otro hilo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lisis de c√≥digo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta implementaci√≥n bloquea la creaci√≥n de un elemento. </font><font style="vertical-align: inherit;">El bloqueo ocurre en una llave. </font><font style="vertical-align: inherit;">Por ejemplo, si estamos esperando el avatar de Alexey, a√∫n podemos obtener los valores en cach√© de Zhenya o Barbara en otro hilo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El diccionario </font></font><code>_locks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacena todas las cerraduras. </font><font style="vertical-align: inherit;">Los bloqueos regulares no funcionan </font></font><code>async/await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por lo que debemos usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SemaphoreSlim</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay 2 comprobaciones para verificar si el valor ya est√° almacenado en cach√© si </font></font><code>(!_Cache.TryGetValue(key, out cacheEntry))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El que est√° en la cerradura es el que proporciona la √∫nica creaci√≥n del elemento. </font><font style="vertical-align: inherit;">Uno que est√° fuera de la cerradura, para la optimizaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cu√°ndo usar </font></font><code>WaitToFinishMemoryCache</code></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta implementaci√≥n obviamente tiene algunos gastos generales. </font><font style="vertical-align: inherit;">Veamos cuando es relevante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usar </font></font><code>WaitToFinishMemoryCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando el tiempo de creaci√≥n de un elemento tiene alg√∫n valor, y desea minimizar el n√∫mero de creaciones tanto como sea posible.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando el tiempo para crear un art√≠culo es muy largo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando un elemento debe crearse una vez para cada clave.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No usar </font></font><code>WaitToFinishMemoryCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hay peligro de que varios subprocesos obtengan acceso al mismo elemento de cach√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No est√° categ√≥ricamente en contra de crear elementos m√°s de una vez. </font><font style="vertical-align: inherit;">Por ejemplo, si una consulta adicional a la base de datos no afecta mucho a nada.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El almacenamiento en cach√© es un patr√≥n muy poderoso. </font><font style="vertical-align: inherit;">Y tambi√©n es peligroso y tiene sus peligros. </font><font style="vertical-align: inherit;">Cach√© demasiado y puede causar presi√≥n sobre el GC. </font><font style="vertical-align: inherit;">Cach√© muy poco y puede causar problemas de rendimiento. </font><font style="vertical-align: inherit;">Tambi√©n hay almacenamiento en cach√© distribuido, que representa un mundo completamente nuevo para explorar. </font><font style="vertical-align: inherit;">Este es el desarrollo de software, siempre hay algo nuevo que se puede dominar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que hayas disfrutado este art√≠culo. </font><font style="vertical-align: inherit;">Si est√° interesado en la gesti√≥n de la memoria, mi pr√≥ximo art√≠culo se centrar√° en los peligros de la presi√≥n sobre el GC y c√≥mo evitarlo, as√≠ que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reg√≠strese</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Disfruta tu codificaci√≥n.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprende m√°s sobre el curso.</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502954/index.html">Muestra 5 plataformas webinar m√°s</a></li>
<li><a href="../es502962/index.html">Por qu√© no volveremos a la oficina (un vistazo al trabajo remoto despu√©s de 2 meses)</a></li>
<li><a href="../es502964/index.html">Matiz financiero en el acuerdo de proyecto del proyecto de TI</a></li>
<li><a href="../es502968/index.html">Conceptos b√°sicos de Data Vault</a></li>
<li><a href="../es502972/index.html">SD Express: SD 8.0 y PCIe 4.0 est√°ndar. ¬øQu√© es esto y por qu√©?</a></li>
<li><a href="../es502978/index.html">Esquema de color sin la ayuda de un dise√±ador.</a></li>
<li><a href="../es502980/index.html">ENT y trama en juegos sin trama en el ejemplo de Throne: Kingdom at War</a></li>
<li><a href="../es502984/index.html">¬øC√≥mo elegir un psic√≥logo / psicoterapeuta?</a></li>
<li><a href="../es502986/index.html">F #, aumentando el contraste de la imagen alineando los histogramas</a></li>
<li><a href="../es502988/index.html">Experto en negocios y programaci√≥n. Combinar no se puede compartir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>