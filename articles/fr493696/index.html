<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéä üç≥ üöü Acc√©l√©ration du sous-syst√®me de disque Kemu Qemu sous Linux ‚õπÔ∏è üé≥ üë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parfois, j'assume diverses t√¢ches pour configurer des serveurs. Il y a quelque temps, le propri√©taire d'une petite soci√©t√© d'h√©bergement m'a abord√© av...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acc√©l√©ration du sous-syst√®me de disque Kemu Qemu sous Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/493696/"><img src="https://habrastorage.org/webt/gx/ub/i1/gxubi1ucfhq7jujnimizriacaqa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, j'assume diverses t√¢ches pour configurer des serveurs. </font><font style="vertical-align: inherit;">Il y a quelque temps, le propri√©taire d'une petite soci√©t√© d'h√©bergement m'a abord√© avec un probl√®me int√©ressant. </font><font style="vertical-align: inherit;">Il aimerait ex√©cuter des machines virtuelles Windows sous KVM sur ses serveurs, o√π Ubuntu 18.04 √©tait d√©j√† install√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, ses tests ont montr√© que le syst√®me de disques KVM √©tait d√©cemment en retard par rapport aux indicateurs qu'il avait sous Hyper-V. </font><font style="vertical-align: inherit;">Il voulait lib√©rer qemu sur ses serveurs Ubuntu pour √©viter d'acheter des licences de serveur Windows co√ªteuses (la version gratuite de Microsoft Hyper-V Server n'a pas fonctionn√© en raison de ses limites).</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0. Disposition</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les tests, nous avons utilis√© le SSD Samsung 970 Pro 1 To. </font><font style="vertical-align: inherit;">Le client a v√©rifi√© les r√©sultats du travail dans CrystalDiskMark, donc plus loin dans l'article tous les graphiques de celui-ci.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10 LTSC</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Processeur </font><font style="vertical-align: inherit;">Hyper-V </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">2</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/h_/-8/n1/h_-8n1bwsgaovljitrm1wztowbi.png"></td>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La premi√®re √©tape consistait √† am√©liorer les performances d'E / S al√©atoires. </font><font style="vertical-align: inherit;">Ce type de charge est typique des machines virtuelles, en particulier celles qui utilisent diverses bases de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu (16.04 LTS et 18.04) utilise toujours la version 2.11 de qemu. </font><font style="vertical-align: inherit;">Par cons√©quent, certains des derniers pains qemu ne sont pas pris en compte dans cet article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons d√©cid√© que nous devons √©viter de lier le fer √† une machine virtuelle, car cela complique la portabilit√© des machines virtuelles, de sorte que les options de lancement de SSD / disques physiques / partitions dans des machines virtuelles ont √©t√© jug√©es ind√©sirables.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä propos de la taille du fichier de test pour CrystalDiskMark</font></font></b><div class="spoiler_text">   ,          100  4.   ,         :   ,    .<br>
<br>
,        ,  Windows       .    100  4    ,     40  .<br>
<br>
       ,      ,         100-1.         4.<br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Nous utilisons des volumes LVM, pas des fichiers pour stocker des disques de machine virtuelle.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La logique est la suivante. Le fichier avec le disque virtuel est stock√© dans le syst√®me de fichiers Linux, NTFS est situ√© √† l'int√©rieur du fichier lui-m√™me. Chaque syst√®me de fichiers consomme des ressources pendant les op√©rations sur disque. Par cons√©quent, plus la profondeur de la poup√©e est petite, plus l'entr√©e / sortie est rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons des fichiers qcow2, leur nom signifie ¬´Qemu Copy-On-Write¬ª et, en fait, ils ont leur propre table de traduction √† l'int√©rieur qui est responsable des blocs occup√©s, de ceux qui ne le sont pas et de l'emplacement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La couche LVM consomme beaucoup moins de ressources processeur que le syst√®me de fichiers. L'une des raisons √† cela est que les blocs qu'il contient sont beaucoup plus volumineux qu'un bloc de syst√®me de fichiers typique (4 Ko). Plus le bloc (√©tendue) est important sur le p√©riph√©rique LVM physique, plus les E / S se produisent rapidement et moins la fragmentation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais m√™me pour les SSD, les E / S al√©atoires sont beaucoup plus lentes que les s√©ries. Par cons√©quent, lors de la cr√©ation du groupe de volumes, nous sp√©cifierons une tr√®s large √©tendue: 256 Mo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lecture √† l'avance sur un volume logique doit √™tre d√©sactiv√©e, car il d√©pense des E / S sans gagner, car maintenant, personne ne d√©fragmente les disques dans Windows sur des SSD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LVM est assez pratique √† utiliser pour h√©berger des machines virtuelles. Les volumes LVM sont facilement portables entre les disques physiques; il existe des instantan√©s et un redimensionnement en ligne. De plus, virt-manager (libvirt) peut cr√©er des volumes logiques pr√™ts √† l'emploi pour les disques de machines virtuelles √† partir du groupe Volume.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La capacit√© de cr√©er des volumes minces semble √©galement attrayante, mais √©tant donn√© qu'un volume mince est une couche suppl√©mentaire d'abstraction, il est √©vident que cela d√©gradera les performances d'E / S. </font><font style="vertical-align: inherit;">De plus, libvirt n'a pas de m√©thode √©l√©gante pour cr√©er automatiquement des disques pour des machines virtuelles dans un pool l√©ger.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#    SSD    (volume group)</span><font></font>
pvcreate /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    win    (extent) 256.</span><font></font>
vgcreate -s 256M win_pool /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    vm1.    C</span><font></font>
lvcreate -n vm1 -L 100G win_pool<font></font>
<font></font>
<span class="hljs-comment">#      (read ahead)</span><font></font>
lvchange -r none /dev/win_pool/vm1<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Volume mince en tant que disque et / ou param√®tres de volume logique pour les instantan√©s</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez utiliser un pool l√©ger dans lequel vous allez cr√©er des volumes l√©gers, il est logique de d√©finir la taille de bloc du pool sur 4 Mo, ce qui est beaucoup plus important que la taille par d√©faut de 64 Ko. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui entra√Ænera un travail plus rapide de cette couche d'abstraction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le m√©canisme d'instantan√© dans LVM fonctionne presque sur le m√™me code que les volumes l√©gers, donc les param√®tres seront les m√™mes pour augmenter la vitesse de l'instantan√©.</font></font><br>
<br>
<pre><code class="bash hljs">lvcreate -c 4m -L 300G -T -Zn win_pool/thin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'option </font></font><code>-Zn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©sactive le remplacement du bloc avec des z√©ros lors de la mise en √©vidence, ce qui augmente la vitesse de travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Param√®tres pour lvm.conf ou un fichier similaire (par exemple lvmlocal.conf):</font></font><br>
<br>
<pre><code class="bash hljs">thin_pool_chunk_size = 4096<font></font>
thin_pool_zero = n</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez d√©terminer la taille optimale du bloc en effectuant le test avec la commande suivante, en choisissant la valeur </font></font><code>--blocksize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">fio --name=randwrite --filename=/dev/nvme0n1p9 --size=10G --ioengine=libaio --iodepth=1 --buffered=0 --direct=1 --rw=randwrite --blocksize=4m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez afficher la taille actuelle du bloc avec la commande:</font></font><br>
<br>
<pre><code class="bash hljs">lvs -ao name,chunksize</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. L'augmentation du nombre de processeurs logiques allou√©s √† chaque machine virtuelle KVM am√©liore les performances du disque</font></font></h4><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/rk/d5/pp/rkd5pphdlwmwx0ykk_mszbtcxjc.png"></td>
<td><img src="https://habrastorage.org/webt/o6/0s/u-/o60su-evqzflfsjh4v0wl7ih8sa.png"></td>
<td><img src="https://habrastorage.org/webt/gv/0x/jf/gv0xjf7ky6xkidam9duclsztowo.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est clair que presque personne n'allouera 10 processeurs √† la machine virtuelle, mais il √©tait int√©ressant de regarder le cas extr√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela d√©pend d√©j√† du nombre de processeurs gratuits. </font><font style="vertical-align: inherit;">√Ä mon avis, il n'est pas opportun d'en allouer plus de 4. </font><font style="vertical-align: inherit;">Avec un nombre de threads √©gal √† 8, nous avons obtenu les performances de lecture et d'√©criture al√©atoires maximales. </font><font style="vertical-align: inherit;">Il s'agit d'une sp√©cificit√© de CrystalDiskMark 6.0.2, dans laquelle le deuxi√®me test effectue 8 threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'o√π nous pouvons conclure qu'il est bon d'avoir un processeur logique pour chaque t√¢che qui utilise activement IO.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Nous utilisons d'√©normes pages de m√©moire √† acc√®s al√©atoire (√©normes pages) pour √©viter la d√©gradation des performances due √† la fragmentation de la RAM</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce package peut √™tre utile lorsque nous avons besoin de diverses informations sur les pages g√©antes pendant le fonctionnement.</font></font><br>
<br>
<pre><code class="bash hljs">apt install hugepages</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifier </font></font><code>/etc/default/grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string">"default_hugepagesz=1GB hugepagesz=1G hugepages=64"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, 64 Go de m√©moire ont √©t√© allou√©s √† toutes les machines virtuelles sous forme de pages g√©antes. </font><font style="vertical-align: inherit;">Dans votre cas, il peut y avoir moins / plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appliquons ces param√®tres √† GRUB afin que la prochaine fois que le syst√®me d√©marre, ils deviennent actifs:</font></font><br>
<br>
<pre><code class="bash hljs">grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modification de la configuration de la machine virtuelle:</font></font><br>
<br>
<pre><code class="bash hljs">virsh edit vm_name</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajouter:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">memoryBacking</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">hugepages</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">memoryBacking</span>&gt;</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Ajoutez un flux d√©di√© √† chaque machine virtuelle pour servir les E / S</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez ajouter ce qui est mis en √©vidence en gras. </font><font style="vertical-align: inherit;">Nous utilisons </font></font><code>virsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comme dans le paragraphe pr√©c√©dent.</font></font><br>
<br>
<blockquote><b>&lt;iothreads&gt;1&lt;/iothreads&gt;</b><br>
<br>
&lt;disk type='block' device='disk'&gt;<br>
&lt;driver name='qemu' type='raw' cache='none' io='threads' <b>iothread='1'</b>/&gt;<br>
&lt;source dev='/dev/win/terminal'/&gt;<br>
&lt;target dev='vda' bus='virtio'/&gt;<br>
&lt;boot order='2'/&gt;<br>
&lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;<br>
&lt;/disk&gt;</blockquote><br>
<br>
<h4>4.1.       writeback</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour acc√©l√©rer l'√©criture accidentelle sur le disque, mais avec un risque accru de perte de donn√©es, vous pouvez utiliser </font></font><code>cache=writeback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le paragraphe pr√©c√©dent. </font><font style="vertical-align: inherit;">Il ne peut √™tre utilis√© que s'il existe une grande confiance dans la qualit√© et la sauvegarde de l'alimentation et en pr√©sence de sauvegardes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Param√®tres du sous-syst√®me de disque dans Virt Manager</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bus de disque: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
format de stockage </font><font style="vertical-align: inherit;">VirtIO </font><font style="vertical-align: inherit;">: brut </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mode cache: √©criture </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
diff√©r√©e Mode IO: threads</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1. </font><font style="vertical-align: inherit;">Configuration d'un sous-syst√®me de disque via un fichier de configuration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qemu 2.11 (qui est actuellement utilis√© par Ubuntu) prend en charge deux types de p√©riph√©riques virtuels de disque: virtio-blk et virtio-scsi. </font><font style="vertical-align: inherit;">Lorsque sp√©cifi√© dans Virt Manager </font></font><code>Disk bus: VirtIO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cela signifie utiliser le p√©riph√©rique virtio-blk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans tous les cas, virtio-blk est meilleur en vitesse, malgr√© le fait que dans la version test√©e de qemu il ne supportait toujours pas TRIM, contrairement √† virtio-scsi (il le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supporte d√©j√†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> depuis la version 5.x </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du point de vue de la vitesse d'E / S disque, virtio-scsi n'a de sens que dans des cas exotiques, par exemple, lorsque vous devez connecter des centaines de disques √† une machine virtuelle.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Pendant l'installation de Windows, installez le pilote VirtIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinon, le disque ne sera pas disponible pour le syst√®me d'exploitation. </font><font style="vertical-align: inherit;">Pour ce faire, utilisez l'image du pilote, que nous pr√©-connectons √† la machine virtuelle.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. R√©sultats apr√®s avoir appliqu√© tous les ajustements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le tweak 4.1 n'a pas √©t√© utilis√©, car je n'√©tais pas s√ªr de la fiabilit√© de l'alimentation du client.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Processeur </font><font style="vertical-align: inherit;">Hyper-V </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">4</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez comprendre que ces r√©sultats ont une certaine convention, car chaque fois que vous d√©marrez CrystalDiskMark, les valeurs sont l√©g√®rement diff√©rentes.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM pr√™t √† l'emploi </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM apr√®s ajustements </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons qu'il a √©t√© possible d'acc√©l√©rer consid√©rablement le travail du sous-syst√®me de disque en qemu (kvm) avec le m√™me nombre de c≈ìurs. </font><font style="vertical-align: inherit;">L'√©criture a √©t√© acc√©l√©r√©e en moyenne de 58% et la lecture de 25%. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âl√©ments cl√©s de r√©ussite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : utilisation de volumes LVM au lieu de fichiers qcow2, d'E / S s√©par√©es et de pages g√©antes. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dirigez les erreurs constat√©es vers le PM. </font><font style="vertical-align: inherit;">J'augmente le karma pour cela.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS vhost-user-blk et vhost-user-nvme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des exp√©riences, Qemu 2.12 et la version 3 ont √©galement √©t√© compil√©s. </font><font style="vertical-align: inherit;">L'option vhost-user-blk pour un disque a √©t√© test√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fin de compte, cela a fonctionn√© pire que virtio-blk.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">vhost-user-blk </font><font style="vertical-align: inherit;">4</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">virtio-blk </font><font style="vertical-align: inherit;">4</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/x_/zw/04/x_zw04o-k8gq4so3yvyp66ddyga.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour utiliser vhost-user-nvme, il √©tait n√©cessaire de patcher qemu, cette option compliquait la mise √† jour automatique des serveurs en production, elle n'a donc pas √©t√© test√©e.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS SPDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intel a con√ßu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce cadre</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour atteindre des indicateurs de performances exceptionnels pour les syst√®mes de disques des machines virtuelles qui devraient fonctionner sur ses processeurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que spdk fonctionne correctement, ils passent par de nombreuses astuces - ils lui allouent des noyaux s√©par√©s, placent les noyaux spdk et de machine virtuelle dans un socket. Chargez la machine virtuelle dans un bloc de m√©moire contigu. Si vous appliquez de telles mesures √† virtio-blk normal, cela fonctionnera √©galement plus rapidement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPDK est capable de fonctionner en 3 modes: vhost-user-scsi, vhost-user-blk et vhost-user-nvme. Le deuxi√®me mode est uniquement disponible dans qemu √† partir de la 2.12, qui n'est pas encore disponible dans ubuntu. Le mode vhost-user-nvme est g√©n√©ralement m√©ga-exp√©rimental - vous devez patcher qemu pour cela. Actuellement, seule l'√©mulation scsi fonctionne et elle est lente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une autre limitation s√©rieuse pour le mode vhost-user-scsi - spdk ne peut pas √™tre amor√ßable.</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assurez-vous que l'option bootindex = 2 Qemu est donn√©e au p√©riph√©rique vhost-user-scsi-pci.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les enregistrements sont d√©finis lorsqu'ils utilisent leur pilote pour partager des SSD sur plusieurs appareils et les transmettre en tant que vhost-user-nvme. </font><font style="vertical-align: inherit;">L'approche perceuse de fer ne nous convenait pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'impression √©tait qu'il √©tait normal d'utiliser SPDK uniquement avec leur impl√©mentation de disques logiques (ce qui est compl√®tement diff√©rent du LVM standard). </font><font style="vertical-align: inherit;">Il s'agit d'un v√©lo fait maison avec ses photos et son clonage. </font><font style="vertical-align: inherit;">Les √©quipes sont toutes diff√©rentes de LVM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La difficult√© de configurer le SPDK, le support et la portabilit√© des machines virtuelles, ainsi que la connexion aux processeurs Intel, se sont d√©tourn√©s de son utilisation.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remerciements</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merci pour l'image </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TripletConcept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il est pr√©f√©rable de le regarder en taille r√©elle dans une fen√™tre s√©par√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir la permission de partager des documents de travail -</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">st_neon</font></font></a></i><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez commander une machine virtuelle avec SSD aupr√®s de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUVDS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour le coupon ci-dessous. </font><b><i><font style="vertical-align: inherit;">Dirigez les erreurs constat√©es vers le PM. </font></i></b><b><i><font style="vertical-align: inherit;">J'augmente le karma pour cela.</font></i></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a><br>
<br>
<b><i><font style="vertical-align: inherit;"></font></i></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493680/index.html">10 astuces pour ne pas fusionner konfu en ligne</a></li>
<li><a href="../fr493686/index.html">L'origine myst√©rieuse du jeu de soci√©t√© sur le piratage des codes Mastermind</a></li>
<li><a href="../fr493688/index.html">Nous rendons Microsoft Teams gratuits - restez en contact avec vos coll√®gues en ces temps difficiles</a></li>
<li><a href="../fr493690/index.html">20 conseils pour le pilote DJI Mavic Mini pour prot√©ger votre drone contre les accidents et les pertes</a></li>
<li><a href="../fr493692/index.html">Structures de donn√©es th√©oriques et leur application en JavaScript. P1. Des couples</a></li>
<li><a href="../fr493700/index.html">Utilisation de logiciels malveillants dans Azure pour acc√©der aux locataires Microsoft 365</a></li>
<li><a href="../fr493702/index.html">Transition massive vers le travail √† distance: probl√®mes techniques et menaces pour la s√©curit√©</a></li>
<li><a href="../fr493704/index.html">Utiliser TypeScript en JavaScript sans √©crire TypeScript</a></li>
<li><a href="../fr493706/index.html">Connaissez votre ennemi: cr√©ez une porte d√©rob√©e Node.js</a></li>
<li><a href="../fr493708/index.html">Anatomie de ma grappe Kubernetes maison</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>