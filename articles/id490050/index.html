<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï£ ‚úíÔ∏è üëêüèæ Streaming data kolom menggunakan Apache Arrow ü•¢ üßöüèº üë©üèº‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Terjemahan artikel disiapkan khusus untuk siswa kursus Data Engineer .
 
 
 
 Selama beberapa minggu terakhir, Nong Li dan saya telah menambahkan form...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Streaming data kolom menggunakan Apache Arrow</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/490050/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terjemahan artikel disiapkan khusus untuk siswa kursus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Engineer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/6b/3m/kz/6b3mkzihfzscol1hedy_gppa2f0.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama beberapa minggu terakhir, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nong Li dan saya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> telah menambahkan </font><font style="vertical-align: inherit;">format streaming biner </font><font style="vertical-align: inherit;">ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache Arrow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , melengkapi format file akses / IPC acak yang ada. </font><font style="vertical-align: inherit;">Kami memiliki implementasi di Java dan C ++ dan Python bindings. </font><font style="vertical-align: inherit;">Dalam artikel ini saya akan memberi tahu Anda bagaimana formatnya bekerja dan menunjukkan bagaimana Anda dapat mencapai throughput data yang sangat tinggi untuk panda DataFrame.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streaming data kolom</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Pertanyaan umum yang saya dapatkan dari pengguna Arrow adalah pertanyaan tentang mahalnya biaya memindahkan set besar data tabular dari format berorientasi baris atau berorientasi baris ke format kolom. Untuk dataset multi-gigabyte, mentransposisi dalam memori atau pada disk bisa menjadi tugas yang luar biasa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk streaming data, terlepas dari apakah data sumbernya berupa string atau kolom, satu opsi adalah mengirim paket kecil string, yang masing-masing di dalamnya berisi tata letak kolom. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di Apache Arrow, kumpulan array kolom dalam memori yang mewakili potongan tabel disebut kumpulan rekaman. Untuk mewakili struktur data tunggal dari tabel logis, beberapa paket rekaman dapat dirakit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam format file "akses acak" yang ada, kami merekam metadata yang berisi tata letak tabel dan lokasi blok di akhir file, yang memungkinkan Anda untuk dengan sangat murah memilih paket rekaman atau kolom apa pun dari kumpulan data. </font><font style="vertical-align: inherit;">Dalam format streaming, kami mengirim serangkaian pesan: skema, dan kemudian satu paket rekaman atau lebih. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format berbeda terlihat seperti yang ditunjukkan pada gambar ini:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/kd/jq/ofkdjqyesvfqkmj92jntxjuqani.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streaming PyArrow: Aplikasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Untuk menunjukkan kepada Anda bagaimana ini bekerja, saya akan membuat dataset contoh yang mewakili potongan stream tunggal:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">import</span> time
<span class="hljs-attribute">import</span> numpy as np
<span class="hljs-attribute">import</span> pandas as pd
<span class="hljs-attribute">import</span> pyarrow as pa<font></font>
<font></font>
<span class="hljs-attribute">def</span> generate_data(total_size, ncols):
    <span class="hljs-attribute">nrows</span> = int(total_size / ncols / np.dtype('float<span class="hljs-number">64</span>').itemsize)
    <span class="hljs-attribute">return</span> pd.DataFrame({<font></font>
        '<span class="hljs-attribute">c</span>' + str(i): np.random.randn(nrows)
        <span class="hljs-attribute">for</span> i in range(ncols)<font></font>
    })	</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sekarang, misalkan kita ingin merekam 1 GB data yang terdiri dari potongan masing-masing 1 MB, dengan total 1024 potongan. </font><font style="vertical-align: inherit;">Pertama, mari kita buat frame data 1 MB pertama dengan 16 kolom:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">KILOBYTE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>
<span class="hljs-attribute">MEGABYTE</span> = KILOBYTE * KILOBYTE
<span class="hljs-attribute">DATA_SIZE</span> = <span class="hljs-number">1024</span> * MEGABYTE
<span class="hljs-attribute">NCOLS</span> = <span class="hljs-number">16</span><font></font>
<font></font>
<span class="hljs-attribute">df</span> = generate_data(MEGABYTE, NCOLS)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Lalu saya mengubahnya menjadi </font></font><code>pyarrow.RecordBatch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">batch</span> = pa.RecordBatch.from_pandas(df)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sekarang saya akan membuat aliran output yang akan menulis ke RAM dan membuat </font></font><code>StreamWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">sink</span> = pa.InMemoryOutputStream()
<span class="hljs-attribute">stream_writer</span> = pa.StreamWriter(sink, batch.schema)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Lalu kita menulis 1024 potongan, yang pada akhirnya akan membuat kumpulan data 1GB:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">for</span> i in range(DATA_SIZE // MEGABYTE):
    <span class="hljs-attribute">stream_writer</span>.write_batch(batch)</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Karena kami menulis dalam RAM, kami bisa mendapatkan seluruh aliran dalam satu buffer:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">In</span><span class="hljs-meta"> [13]: source = sink.get_result()

In [14]: source
Out[14]: &lt;pyarrow.io.Buffer at 0x7f2df7118f80&gt;

In [15]: source.size
Out[15]: 1074750744</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Karena data ini ada dalam memori, membacakan paket rekaman Arrow adalah operasi tanpa salinan. </font><font style="vertical-align: inherit;">Saya membuka StreamReader, membaca data </font></font><code>pyarrow.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan kemudian mengubahnya menjadi </font></font><code>DataFrame pandas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">In</span><span class="hljs-meta"> [16]: reader = pa.StreamReader(source)

In [17]: table = reader.read_all()

In [18]: table
Out[18]: &lt;pyarrow.table.Table at 0x7fae8281f6f0&gt;

In [19]: df = table.to_pandas()

In [20]: df.memory_usage().sum()
Out[20]: 1073741904</span></code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Semua ini, tentu saja, baik, tetapi Anda mungkin memiliki pertanyaan. </font><font style="vertical-align: inherit;">Seberapa cepat ini terjadi? </font><font style="vertical-align: inherit;">Bagaimana ukuran chunk memengaruhi kinerja mendapatkan panda DataFrame?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinerja Streaming</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ketika ukuran potongan streaming berkurang, biaya merekonstruksi kolom DataFrame kontinu dalam panda meningkat karena skema akses cache yang tidak efisien. Ada juga beberapa overhead dari bekerja dengan struktur dan array data C ++ dan buffer memori mereka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk 1 MB, seperti yang disebutkan di atas, pada laptop saya (Quad-core Xeon E3-1505M) ternyata:</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">In</span><span class="hljs-meta"> [20]: %timeit pa.StreamReader(source).read_all().to_pandas()
10 loops, best of 3: 129 ms per loop</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ternyata bandwidth efektif adalah 7,75 Gb / s untuk memulihkan DataFrame 1Gb dari 1024 potongan masing-masing 1MB. </font><font style="vertical-align: inherit;">Apa yang terjadi jika kita menggunakan bongkahan yang lebih besar atau lebih kecil? </font><font style="vertical-align: inherit;">Berikut adalah hasilnya: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_2/qz/4j/_2qz4j7k7keun29itu0bx-cnklw.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Kinerja turun secara signifikan dari 256 ribu ke 64 ribu potongan. </font><font style="vertical-align: inherit;">Saya terkejut bahwa potongan 1 MB diproses lebih cepat dari 16 MB. </font><font style="vertical-align: inherit;">Adalah bermanfaat untuk melakukan studi yang lebih menyeluruh dan memahami apakah ini adalah distribusi normal atau jika ada sesuatu yang memengaruhinya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam implementasi format saat ini, data pada prinsipnya tidak dikompres, oleh karena itu ukuran dalam memori dan kabel kira-kira sama. </font><font style="vertical-align: inherit;">Di masa depan, kompresi dapat menjadi opsi tambahan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Streaming data kolom dapat menjadi cara yang efektif untuk mentransfer set data besar ke alat analisis kolom, seperti panda, menggunakan potongan kecil. </font><font style="vertical-align: inherit;">Layanan data yang menggunakan penyimpanan berorientasi garis dapat mentransfer dan mengubah potongan data kecil yang lebih nyaman untuk cache L2 dan L3 prosesor Anda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode lengkap</font></font><br>
<br>
<pre><code class="apache hljs"><span class="hljs-attribute">import</span> time
<span class="hljs-attribute">import</span> numpy as np
<span class="hljs-attribute">import</span> pandas as pd
<span class="hljs-attribute">import</span> pyarrow as pa<font></font>
<font></font>
<span class="hljs-attribute">def</span> generate_data(total_size, ncols):
    <span class="hljs-attribute">nrows</span> = total_size / ncols / np.dtype('float<span class="hljs-number">64</span>').itemsize
    <span class="hljs-attribute">return</span> pd.DataFrame({<font></font>
        '<span class="hljs-attribute">c</span>' + str(i): np.random.randn(nrows)
        <span class="hljs-attribute">for</span> i in range(ncols)<font></font>
    })<font></font>
<font></font>
<span class="hljs-attribute">KILOBYTE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>
<span class="hljs-attribute">MEGABYTE</span> = KILOBYTE * KILOBYTE
<span class="hljs-attribute">DATA_SIZE</span> = <span class="hljs-number">1024</span> * MEGABYTE
<span class="hljs-attribute">NCOLS</span> = <span class="hljs-number">16</span><font></font>
<font></font>
<span class="hljs-attribute">def</span> get_timing(f, niter):
    <span class="hljs-attribute">start</span> = time.clock_gettime(time.CLOCK_REALTIME)
    <span class="hljs-attribute">for</span> i in range(niter):
        <span class="hljs-attribute">f</span>()
    <span class="hljs-attribute">return</span> (time.clock_gettime(time.CLOCK_REALTIME) - start) / NITER<font></font>
<font></font>
<span class="hljs-attribute">def</span> read_as_dataframe(klass, source):
    <span class="hljs-attribute">reader</span> = klass(source)
    <span class="hljs-attribute">table</span> = reader.read_all()
    <span class="hljs-attribute">return</span> table.to_pandas()
<span class="hljs-attribute">NITER</span> = <span class="hljs-number">5</span>
<span class="hljs-attribute">results</span> =<span class="hljs-meta"> []</span><font></font>
<font></font>
<span class="hljs-attribute">CHUNKSIZES</span> =<span class="hljs-meta"> [16 * KILOBYTE, 64 * KILOBYTE, 256 * KILOBYTE, MEGABYTE, 16 * MEGABYTE]</span><font></font>
<font></font>
<span class="hljs-attribute">for</span> chunksize in CHUNKSIZES:
    <span class="hljs-attribute">nchunks</span> = DATA_SIZE // chunksize
    <span class="hljs-attribute">batch</span> = pa.RecordBatch.from_pandas(generate_data(chunksize, NCOLS))<font></font>
<font></font>
    <span class="hljs-attribute">sink</span> = pa.InMemoryOutputStream()
    <span class="hljs-attribute">stream_writer</span> = pa.StreamWriter(sink, batch.schema)<font></font>
<font></font>
    <span class="hljs-attribute">for</span> i in range(nchunks):
        <span class="hljs-attribute">stream_writer</span>.write_batch(batch)<font></font>
<font></font>
    <span class="hljs-attribute">source</span> = sink.get_result()<font></font>
<font></font>
    <span class="hljs-attribute">elapsed</span> = get_timing(lambda: read_as_dataframe(pa.StreamReader, source), NITER)<font></font>
<font></font>
    <span class="hljs-attribute">result</span> = (chunksize, elapsed)
    <span class="hljs-attribute">print</span>(result)
    <span class="hljs-attribute">results</span>.append(result)</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id490034/index.html">Pertemuan ML REPA di Raffeisenbank: terus siaran</a></li>
<li><a href="../id490040/index.html">Python-Seledri di Windows dengan pengelolaan Docker</a></li>
<li><a href="../id490042/index.html">Studi Positive Technologies: 7 dari 8 lembaga keuangan dapat memasuki jaringan dari Internet</a></li>
<li><a href="../id490044/index.html">Implementasi CRM melalui mata pelanggan</a></li>
<li><a href="../id490046/index.html">NDA untuk pengembangan - klausa "residual" dan cara-cara lain untuk melindungi diri Anda</a></li>
<li><a href="../id490052/index.html">Aplikasi iOS dapat mencuri data dari clipboard perangkat + survei pemantauan ancaman MacOS</a></li>
<li><a href="../id490056/index.html">Black Box: lupakan tentang logging</a></li>
<li><a href="../id490060/index.html">Grafik pencarian pengetahuan: membangun dari berbagai sumber</a></li>
<li><a href="../id490066/index.html">Dari Cina ke Kutub Selatan: Menggabungkan kekuatan untuk memecahkan teka-teki massa neutrino</a></li>
<li><a href="../id490068/index.html">Pemalsuan keacakan dan transformasi dengan menyortir urutan pseudo-acak</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>