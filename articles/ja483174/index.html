<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•¸ï¸ ğŸ’’ ğŸš ãƒãƒ«ãƒãƒ”ã‚¢ã‚³ãƒã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’éŒ²éŸ³ãŠã‚ˆã³è»¢é€ã™ã‚‹ â˜”ï¸ ğŸ™ğŸ½ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã‚“ã«ã¡ã¯ã€è¦ªæ„›ãªã‚‹èª­è€…ï¼å°‘ã—å‰ã«ã€éŒ²éŸ³ã—ãŸéŸ³ã‚’éŒ²éŸ³ã—ã¦ãƒ‡ãƒã‚¤ã‚¹é–“ã§è»¢é€ã™ã‚‹ã“ã¨ã‚’è©¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚éŒ²éŸ³ã•ã‚ŒãŸéŸ³å£°ã‚’é€ä¿¡ã™ã‚‹æ‰‹æ®µã¨ã—ã¦ã€MultipeerConnectivityãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ãã®æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚
 
 ã¾ãšã€ã‚µã‚¦ãƒ³ãƒ‰ã®éŒ²éŸ³ã¨å†ç”Ÿã«2ã¤ã®ãƒ‡ãƒã‚¤ã‚¹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒãƒ«ãƒãƒ”ã‚¢ã‚³ãƒã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’éŒ²éŸ³ãŠã‚ˆã³è»¢é€ã™ã‚‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483174/"><img src="https://habrastorage.org/webt/eg/ah/sa/egahsainzphs5fo7hefrl3dlptm.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚“ã«ã¡ã¯ã€è¦ªæ„›ãªã‚‹èª­è€…ï¼</font><font style="vertical-align: inherit;">å°‘ã—å‰ã«ã€éŒ²éŸ³ã—ãŸéŸ³ã‚’éŒ²éŸ³ã—ã¦ãƒ‡ãƒã‚¤ã‚¹é–“ã§è»¢é€ã™ã‚‹ã“ã¨ã‚’è©¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">éŒ²éŸ³ã•ã‚ŒãŸéŸ³å£°ã‚’é€ä¿¡ã™ã‚‹æ‰‹æ®µã¨ã—ã¦ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MultipeerConnectivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒé¸æŠã•ã‚Œã¾ã—ãŸ</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã§ã¯ã€ãã®æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãšã€ã‚µã‚¦ãƒ³ãƒ‰ã®éŒ²éŸ³ã¨å†ç”Ÿã«2ã¤ã®ãƒ‡ãƒã‚¤ã‚¹ãŒå¿…è¦ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªéŒ²éŸ³</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®éŒ²éŸ³ã«ã¯ã€é€šå¸¸ã®</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVAudioEngine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVAudioMixerNode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŒ</font><b><font style="vertical-align: inherit;">ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</font></b><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFoundation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§æä¾›ã•ã‚Œ</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
éŸ³å£°éŒ²éŸ³ã®ä¾‹ï¼š</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recorder</span> </span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> engine = <span class="hljs-type">AVAudioEngine</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> mixer = <span class="hljs-type">AVAudioMixerNode</span>()<font></font>
    <font></font>
    <span class="hljs-keyword">var</span> onRecordedAction: ((<span class="hljs-type">Data</span>) -&gt; <span class="hljs-type">Void</span>)?<font></font>
    <font></font>
    <span class="hljs-keyword">init</span>() {<font></font>
        setupAudioSession()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupAudioSession</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">let</span> audioSession = <span class="hljs-type">AVAudioSession</span>.sharedInstance()
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> audioSession.setCategory(.record)
            <span class="hljs-keyword">try</span> audioSession.setMode(.measurement)
            <span class="hljs-keyword">try</span> audioSession.setActive(<span class="hljs-literal">true</span>)<font></font>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">debugPrint</span>(error.localizedDescription)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startRecording</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">let</span> input = engine.inputNode
        <span class="hljs-keyword">let</span> inputFormat = input.outputFormat(forBus: <span class="hljs-number">0</span>)<font></font>
        engine.attach(mixer)<font></font>
        engine.connect(input, to: mixer, format: inputFormat)<font></font>
        mixer.installTap(onBus: <span class="hljs-number">0</span>, bufferSize: <span class="hljs-number">1024</span>, format: mixer.outputFormat(forBus: <span class="hljs-number">0</span>)) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] buffer, <span class="hljs-number">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span>?.onRecordedAction?(buffer.data)<font></font>
        }<font></font>
        engine.prepare()<font></font>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> engine.start()<font></font>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">debugPrint</span>(error.localizedDescription)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stopRecording</span><span class="hljs-params">()</span></span> {<font></font>
        engine.stop()<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬çš„ã«ã€ç•°å¸¸ãªã“ã¨ã¯ä½•ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒŸã‚­ã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€onRecodedActioné–¢æ•°ã«é€ä¿¡ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">éŒ²éŸ³ã—ãŸéŸ³å£°ã‚’ã•ã‚‰ã«è»¢é€ã™ã‚‹ã«ã¯ã€éŸ³å£°ã‚’ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã®ãŸã‚ã€æ¬¡ã®æ‹¡å¼µã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚</font><b><font style="vertical-align: inherit;">PCMBuffer</font></b><font style="vertical-align: inherit;">ã‚’</font><b><font style="vertical-align: inherit;">Data</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ã«å¤‰æ›ã™ã‚‹ä¾‹</font><font style="vertical-align: inherit;">ï¼š</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">AVAudioPCMBuffer</span> </span>{
    <span class="hljs-keyword">var</span> data: <span class="hljs-type">Data</span> {
        <span class="hljs-keyword">let</span> channels = <span class="hljs-type">UnsafeBufferPointer</span>(start: floatChannelData, <span class="hljs-built_in">count</span>: <span class="hljs-number">1</span>)
        <span class="hljs-keyword">let</span> data = <span class="hljs-type">Data</span>(bytes: channels[<span class="hljs-number">0</span>], <span class="hljs-built_in">count</span>: <span class="hljs-type">Int</span>(frameCapacity * format.streamDescription.pointee.mBytesPerFrame))
        <span class="hljs-keyword">return</span> data<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å—ä¿¡ã—ãŸéŸ³å£°ã‚’å†ç”Ÿã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å†ç”Ÿã™ã‚‹ã®ã§ã€çµæœã¯è¤‡é›‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç°¡å˜ã«è¨€ã†ã¨ã€ãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã‚¨ãƒ³ã‚¸ãƒ³ã«å‰²ã‚Šå½“ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCMBufferã«</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤‰æ›ã—ã¦æˆ»ã—</font><font style="vertical-align: inherit;">ã€å†ç”Ÿã®ãŸã‚ã«ãƒãƒ¼ãƒ‰ã«æ¸¡ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å†ç”Ÿä¾‹ï¼š</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Player</span> </span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> engine = <span class="hljs-type">AVAudioEngine</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> playerNode = <span class="hljs-type">AVAudioPlayerNode</span>()<font></font>
    <font></font>
    <span class="hljs-keyword">init</span>() {<font></font>
        setupAudioSession()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupAudioSession</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">let</span> audioSession = <span class="hljs-type">AVAudioSession</span>.sharedInstance()
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> audioSession.setCategory(.playback)
            <span class="hljs-keyword">try</span> audioSession.setActive(<span class="hljs-literal">true</span>)<font></font>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">debugPrint</span>(error.localizedDescription)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupPlayer</span><span class="hljs-params">(buffer: AVAudioPCMBuffer)</span></span> {<font></font>
        engine.attach(playerNode)<font></font>
        engine.connect(playerNode, to: engine.mainMixerNode, format: buffer.format)<font></font>
        engine.prepare()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">tryStartEngine</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> engine.start()<font></font>
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">debugPrint</span>(error.localizedDescription)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addPacket</span><span class="hljs-params">(packet: Data)</span></span> {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> format = <span class="hljs-type">AVAudioFormat</span>.common, <span class="hljs-keyword">let</span> buffer = packet.pcmBuffer(format: format) <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">debugPrint</span>(<span class="hljs-string">"Cannot convert buffer from Data"</span>)
            <span class="hljs-keyword">return</span><font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> !engine.isRunning {<font></font>
            setupPlayer(buffer: buffer)<font></font>
            tryStartEngine()<font></font>
            playerNode.play()<font></font>
        }<font></font>
        playerNode.volume = <span class="hljs-number">1</span>
        playerNode.scheduleBuffer(buffer, completionHandler: <span class="hljs-literal">nil</span>)<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¿»è¨³ã™ã‚‹ä¾‹æ‹¡å¼µ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«èƒŒã‚’</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCMBuffer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ç§ãŸã¡ã®</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVAudioFormat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å†ç”Ÿã—ã¾ã™ï¼š</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">Data</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pcmBuffer</span><span class="hljs-params">(format: AVAudioFormat)</span></span> -&gt; <span class="hljs-type">AVAudioPCMBuffer?</span> {
        <span class="hljs-keyword">let</span> streamDesc = format.streamDescription.pointee
        <span class="hljs-keyword">let</span> frameCapacity = <span class="hljs-type">UInt32</span>(<span class="hljs-built_in">count</span>) / streamDesc.mBytesPerFrame
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> buffer = <span class="hljs-type">AVAudioPCMBuffer</span>(pcmFormat: format, frameCapacity: frameCapacity) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }<font></font>
        buffer.frameLength = buffer.frameCapacity<font></font>
        <span class="hljs-keyword">let</span> audioBuffer = buffer.audioBufferList.pointee.mBuffers<font></font>
        withUnsafeBytes { addr <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> baseAddress = addr.baseAddress <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span><font></font>
            }<font></font>
            audioBuffer.mData?.copyMemory(from: baseAddress, byteCount: <span class="hljs-type">Int</span>(audioBuffer.mDataByteSize))<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> buffer<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">AVAudioFormat</span> </span>{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> common = <span class="hljs-type">AVAudioFormat</span>(commonFormat: .pcmFormatFloat32, sampleRate: <span class="hljs-number">44100</span>, channels: <span class="hljs-number">1</span>, interleaved: <span class="hljs-literal">false</span>)<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŒ²éŸ³ã—ãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã«è»¢é€ã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã«ã€æœ€ã‚‚é‡è¦ãªã“ã¨ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MultipeerConnectivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦éŒ²éŸ³ã•ã‚ŒãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã«è»¢é€ã™ã‚‹ã“ã¨ã«ã¤ã„ã¦</font><b><font style="vertical-align: inherit;">èª¬æ˜ã—</font></b><font style="vertical-align: inherit;">ã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCPeerID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</font><font style="vertical-align: inherit;">ï¼ˆãƒ‡ãƒã‚¤ã‚¹ã‚’æ±ºå®šã—ã¾ã™ï¼‰ã¨ã‚¯ãƒ©ã‚¹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCNearbyServiceAdvertiser</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠã‚ˆã³</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCNearbyServiceBrowserã®</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</font><font style="vertical-align: inherit;">ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</font><font style="vertical-align: inherit;">ã€‚ã“ã‚Œã‚‰ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã®æ¤œç´¢ã«ä½¿ç”¨ã•ã‚Œã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ãŒç§ãŸã¡ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ˆä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ¥ç¶šè¦æ±‚ã‚‚å—ã‘å…¥ã‚Œã‚‹ï¼‰ã€‚ã¾ãŸã€éŒ²éŸ³ã•ã‚ŒãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’é€ä¿¡ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‚’ã€Œæ“ä½œã€ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ã‚¯ãƒ©ã‚¹ã®ä¾‹ï¼š</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Constants</span> </span>{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> serviceType = <span class="hljs-string">"bn-radio"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> timeOut: <span class="hljs-type">Double</span> = <span class="hljs-number">10</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Connectivity</span>: <span class="hljs-title">NSObject</span> </span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> advertiser: <span class="hljs-type">MCNearbyServiceAdvertiser?</span> = <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> browser: <span class="hljs-type">MCNearbyServiceBrowser?</span> = <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> peerID: <span class="hljs-type">MCPeerID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> session: <span class="hljs-type">MCSession</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> invitationHandler: ((<span class="hljs-type">Bool</span>, <span class="hljs-type">MCSession</span>) -&gt; <span class="hljs-type">Void</span>)? = <span class="hljs-literal">nil</span><font></font>
    <font></font>
    <span class="hljs-keyword">var</span> onDeviceFoundedAction: ((<span class="hljs-type">MCPeerID</span>) -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onDeviceLostedAction: ((<span class="hljs-type">MCPeerID</span>) -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onInviteAction: ((<span class="hljs-type">MCPeerID</span>) -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onConnectingAction: (() -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onConnectedAction: (() -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onDisconnectedAction: (() -&gt; <span class="hljs-type">Void</span>)?
    <span class="hljs-keyword">var</span> onPacketReceivedAction: ((<span class="hljs-type">Data</span>) -&gt; <span class="hljs-type">Void</span>)?<font></font>
    <font></font>
    <span class="hljs-keyword">init</span>(deviceID: <span class="hljs-type">String</span>) {<font></font>
        peerID = <span class="hljs-type">MCPeerID</span>(displayName: deviceID)<font></font>
        session = <span class="hljs-type">MCSession</span>(peer: peerID, securityIdentity: <span class="hljs-literal">nil</span>, encryptionPreference: .<span class="hljs-keyword">none</span>)
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<font></font>
        session.delegate = <span class="hljs-keyword">self</span><font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startHosting</span><span class="hljs-params">()</span></span> {<font></font>
        advertiser = <span class="hljs-type">MCNearbyServiceAdvertiser</span>(peer: peerID, discoveryInfo: <span class="hljs-literal">nil</span>, serviceType: <span class="hljs-type">Constants</span>.serviceType)<font></font>
        advertiser?.delegate = <span class="hljs-keyword">self</span><font></font>
        advertiser?.startAdvertisingPeer()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findHost</span><span class="hljs-params">()</span></span> {<font></font>
        browser = <span class="hljs-type">MCNearbyServiceBrowser</span>(peer: peerID, serviceType: <span class="hljs-type">Constants</span>.serviceType)<font></font>
        browser?.delegate = <span class="hljs-keyword">self</span><font></font>
        browser?.startBrowsingForPeers()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {<font></font>
        advertiser?.stopAdvertisingPeer()<font></font>
        browser?.stopBrowsingForPeers()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">invite</span><span class="hljs-params">(peerID: MCPeerID)</span></span> {<font></font>
        browser?.invitePeer(peerID, to: session, withContext: <span class="hljs-literal">nil</span>, timeout: <span class="hljs-type">Constants</span>.timeOut)<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleInvitation</span><span class="hljs-params">(isAccepted: Bool)</span></span> {<font></font>
        invitationHandler?(isAccepted, session)<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">send</span><span class="hljs-params">(data: Data)</span></span> {
        <span class="hljs-keyword">try</span>? <span class="hljs-keyword">self</span>.session.send(data, toPeers: session.connectedPeers, with: .unreliable)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">Connectivity</span>: <span class="hljs-title">MCSessionDelegate</span> </span>{<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, peer peerID: MCPeerID, didChange state: MCSessionState)</span></span> {
        <span class="hljs-keyword">switch</span> state {
        <span class="hljs-keyword">case</span> .connecting:<font></font>
            onConnectingAction?()<font></font>
        <span class="hljs-keyword">case</span> .connected:<font></font>
            onConnectedAction?()<font></font>
        <span class="hljs-keyword">case</span> .notConnected:<font></font>
            onDisconnectedAction?()<font></font>
        @unknown <span class="hljs-keyword">default</span>:
            <span class="hljs-built_in">debugPrint</span>(<span class="hljs-string">"Error during session state changed on: \(state)"</span>)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, didReceive data: Data, fromPeer peerID: MCPeerID)</span></span> {<font></font>
        onPacketReceivedAction?(data)<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, didReceive stream: InputStream, withName streamName: String, fromPeer peerID: MCPeerID)</span></span> {<font></font>
        <font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, didStartReceivingResourceWithName resourceName: String, fromPeer peerID: MCPeerID, with progress: Progress)</span></span> {<font></font>
        <font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, didFinishReceivingResourceWithName resourceName: String, fromPeer peerID: MCPeerID, at localURL: URL?, withError error: Error?)</span></span> {<font></font>
        <font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">session</span><span class="hljs-params">(<span class="hljs-number">_</span> session: MCSession, didReceiveCertificate certificate: [<span class="hljs-keyword">Any</span>]?, fromPeer peerID: MCPeerID, certificateHandler: @escaping <span class="hljs-params">(Bool)</span></span></span> -&gt; <span class="hljs-type">Void</span>) {<font></font>
        certificateHandler(<span class="hljs-literal">true</span>)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">Connectivity</span>: <span class="hljs-title">MCNearbyServiceAdvertiserDelegate</span> </span>{<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">advertiser</span><span class="hljs-params">(<span class="hljs-number">_</span> advertiser: MCNearbyServiceAdvertiser, didReceiveInvitationFromPeer peerID: MCPeerID, withContext context: Data?, invitationHandler: @escaping <span class="hljs-params">(Bool, MCSession?)</span></span></span> -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">self</span>.invitationHandler = invitationHandler<font></font>
        onInviteAction?(peerID)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">Connectivity</span>: <span class="hljs-title">MCNearbyServiceBrowserDelegate</span> </span>{<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">browser</span><span class="hljs-params">(<span class="hljs-number">_</span> browser: MCNearbyServiceBrowser, foundPeer peerID: MCPeerID, withDiscoveryInfo info: [String : String]?)</span></span> {<font></font>
        onDeviceFoundedAction?(peerID)<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">browser</span><span class="hljs-params">(<span class="hljs-number">_</span> browser: MCNearbyServiceBrowser, lostPeer peerID: MCPeerID)</span></span> {<font></font>
        onDeviceLostedAction?(peerID)<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¾‹ã«ç¤ºã™ã‚ˆã†ã«ã€ç§ã®æ„è¦‹ã§ã¯ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã®æœ¬è³ªã¯ååˆ†ã§ã‚ã‚‹ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„ã“ã¨ã«ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">åˆ¥ã®æ–¹æ³•ã§å®Ÿè£…ã§ãã‚‹ã‚‚ã®ãŒã‚ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™ãŒã€ã“ã®å ´åˆã¯å¿…è¦ãªæ–¹æ³•ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚</font><b><font style="vertical-align: inherit;">MultipeerConnectivity</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ã®ä½¿ç”¨ä¸­</font><font style="vertical-align: inherit;">ã«ã€æ¥ç¶šã®è·é›¢ãªã©ã€ã„ãã¤ã‹ã®å¦å®šçš„ãªå´é¢ãŒæ˜ã‚‰ã‹ã«ãªã£ãŸãŸã‚ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã«ä¼¼ãŸã‚‚ã®ã‚’ç¶™ç¶šçš„ã«é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ã“ã®ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483156/index.html">çŒ«ã‚’è¶³å…ƒã«</a></li>
<li><a href="../ja483160/index.html">ã‚¹ãƒšãƒ¼ã‚¹2020ï¼šç«æ˜Ÿã€è¡›æ˜Ÿã¨æ–°ã—ã„ãƒ­ã‚±ãƒƒãƒˆã®æ˜Ÿåº§</a></li>
<li><a href="../ja483166/index.html">ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è‡ªå‹•æ¤œå‡º</a></li>
<li><a href="../ja483168/index.html">å†™çœŸã‚’æ¼«ç”»ã«ã™ã‚‹ãƒœãƒƒãƒˆã®ä½œã‚Šæ–¹ã€‚äºŒéƒ¨ã€‚ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</a></li>
<li><a href="../ja483170/index.html">ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ‘ãƒ¼ãƒˆ2ï¼‰ï¼šã€Œåˆ©ç›Šã€ã‚’åˆ†å‰²</a></li>
<li><a href="../ja483176/index.html">Messengerãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ‘ãƒ¼ãƒˆ1ï¼‰ï¼šãƒ™ãƒ¼ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¨­è¨ˆã—ã¾ã™</a></li>
<li><a href="../ja483182/index.html">Array.reduceï¼ˆï¼‰ã‚’ä½¿ç”¨ã™ã‚‹5ã¤ã®èˆˆå‘³æ·±ã„æ–¹æ³•ï¼ˆãŠã‚ˆã³1ã¤ã®é€€å±ˆãªæ–¹æ³•ï¼‰</a></li>
<li><a href="../ja483184/index.html">TensorFlow 2ã¸ã®è‡ªå‹•ã‚³ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a></li>
<li><a href="../ja483190/index.html">3CXãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆã®å›ç­”ï¼šä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰3CX v16ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a></li>
<li><a href="../ja483194/index.html">æ‰‹æ•°æ–™ã®ãŸã‚ã®ãƒœãƒƒãƒˆã€‚æ–°ã—ã„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã§ã‚µãƒƒã‚«ãƒ¼ã«è¡Œã</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>