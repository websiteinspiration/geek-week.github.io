<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗯️ 🎏 👩🏿‍🤝‍👩🏻 スケルトンキーマルウェア分析 🤟🏻 👰 👩🏼‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="記事の翻訳は、特にリバースエンジニアリングコースの学生のために準備されました。
 
 
 
 概要
 Dell SecureWorks Counter Threat Unit（CTU）の研究者たちは、単一要素（パスワードのみ）認証を実装するActive Directory（AD）システムで認証をバイ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>スケルトンキーマルウェア分析</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/481778/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事の翻訳は、特に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リバースエンジニアリング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの学生のために準備されました</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/9z/ro/zu/9zrozu-bzodywtxpi3u8jgmsgog.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dell SecureWorks Counter Threat Unit（CTU）の研究者たちは、単一要素（パスワードのみ）認証を実装するActive Directory（AD）システムで認証をバイパスするマルウェアを発見しました。攻撃者は、任意のユーザーとして認証に任意のパスワードを使用できます。このマルウェアは「スケルトンキー」（ユニバーサルキー）と呼ばれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CTUの研究者は、単一要素認証を使用してWebメールとVPNにアクセスするクライアントネットワーク上でスケルトンキーを発見し、リモートアクセスサービスへの妨害されないアクセスを攻撃者に与えました。スケルトンキーは、被害者のADドメインコントローラーのメモリにパッチとして展開され、攻撃者が任意のユーザーとして認証され、正規のユーザーは通常どおり認証を続行できます。スケルトンキー認証のバイパスにより、物理アクセス攻撃者は、侵害されたADドメインコントローラー上のユーザーを認証するシステムにログインしてロックを解除することもできます。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
公開の時点で知られている唯一のスケルトンキーサンプルには永続性がありませんでした-ドメインコントローラーを再起動するときに再展開する必要があります。 CTUの研究者は、ドメインコントローラーで他のマルウェアが検出されなかったため、攻撃者が正常に認証できないことに基づいてのみ再起動を特定できると疑っています。再起動から8時間から8日の間、攻撃者は被害者のネットワークに既に展開されている他のリモートアクセスマルウェアを使用して、スケルトンキーをドメインコントローラーに再展開しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スケルトンキーの展開には、ドメイン管理者の資格情報が必要です。</font><font style="vertical-align: inherit;">CTUの研究者は、攻撃者がミッションクリティカルなサーバー、管理者のワークステーション、およびターゲットドメインコントローラーから盗んだ資格情報を使用してスケルトンキーを展開するのを監視しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当初、CTUの研究者は、侵害されたネットワークでole64.dllと呼ばれるスケルトンキーのサンプルを観察しました（表1を参照）。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意味または説明</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル名</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ole64.dll</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">md5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bf45086e6334f647fda33576e2a05826</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sha1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5083b17ccc50dd0557dfc544f84e2ab55d6acd92</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイル時間</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2014-02-19 09:31:29</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配備された</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要に応じて（通常、マルウェアを使用してダウンロードされ、使用後に削除されます）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルサイズ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">49664バイト</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクション</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.text、.rdata、.data、.pdata、.rsrc、.reloc</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き出す</font></font></td>
<td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ii（パッチをインストール）</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uu（パッチを削除）</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dllentrypoint（デフォルトのdllエントリポイント）</font></font></p></td>
</tr>
</tbody></table></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表1.スケルトンキーのサンプル</font></font><code>ole64.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この調査では</font></font><code>ole64.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、CTUの研究</font></font><code>msuta64.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">者が被害者のネットワークの「中間ホスト」に</font><font style="vertical-align: inherit;">古いバージョン</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">見つけました</font><font style="vertical-align: inherit;">（表2を参照）。</font><font style="vertical-align: inherit;">中間ホストとは、以前に悪意のあるリモートアクセスマルウェアによって侵害されたシステムです。</font><font style="vertical-align: inherit;">このオプションには、Skeleton Key開発者がパッチプロセスに関連するメモリアドレスを監視できるようにする追加のデバッグオペレーターが含まれています。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意味または説明</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル名</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msuta64.dll</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">md5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">66da7ed621149975f6e643b4f9886cfd</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sha1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ad61e8daeeba43e442514b177a1b41ad4b7c6727</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイル時間</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2012-09-20 08:07:12</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配備された</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2013-09-29 07:58:16</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルサイズ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50688バイト</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクション</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.text、.rdata、.data、.pdata、.rsrc、.reloc</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き出す</font></font></td>
<td><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ii（パッチをインストール）</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uu（パッチを削除）</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dllentrypoint（デフォルトのdllエントリポイント）</font></font></p></td>
</tr>
</tbody></table></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表2サンプルスケルトンキー</font></font><code>msuta64.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
攻撃者は次のアルゴリズムを使用して、スケルトンキーを64ビットDLLファイルとして展開しました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被害者のネットワーク上のステージングホストのステージングディレクトリにSkeleton Key DLLファイルをダウンロードします。</font><font style="vertical-align: inherit;">CTUの研究者は、Skeleton Key DLLファイルに関連する3つのファイル名、ole64.dll、ole.dllおよびmsuta64.dllを観察しました。</font><font style="vertical-align: inherit;">Windowsシステムには正規のole32.dllファイルが含まれていますが、このマルウェアには関連していません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">盗まれたドメイン管理者の資格情報のリストを使用して、ドメインコントローラの管理リソースにアクセスしてみます。</font></font></li>
<li>      ,                 ,      :<br>
<br>
<ul>
<li>      </li>
<li>   </li>
<li>  </li>
<li>     ,   DLL- Skeleton Key  C:\WINDOWS\system32\    .</li>
</ul></li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PsExec </a>   DLL- Skeleton Key        rundll32. ,  ,   - NTLM,     .   Skeleton Key      ,     <code>NTLM: psexec -accepteula \\% TARGET-DC% rundll32 &lt;  DLL&gt; ii &lt;  NTLM&gt;</code></li>
<li>  DLL Skeleton Key  C:\WINDOWS\system32\    .</li>
<li>  DLL Skeleton Key      .</li>
<li>   Skeleton Key    «net use»    AD  ,    NTLM.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CTUの研究者は、攻撃者のグループが複数の組織にスケルトンキーを配備したことを示唆する埋め込みパスワードパターンを発見しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーティリティによって生成されたWindowsイベントについて警告することにより、Windows環境でPsExecの使用を検出できます。ターゲットドメインコントローラーで監視される次のイベント識別子は、サービスをインストールし、サービスを開始および停止するPsExecツールを登録します。これらのイベントはPsExecが使用されるたびに生成されるため、イベントが悪意のあるものか正当なものかを判断するには、イベントの追加分析が必要です。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADドメインコントローラーでの予期しないPSEXESVCサービスインストールイベント（イベントコード7045）：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ名</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：システム</font></font><br>
 <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：サービスコントロールマネージャー</font></font><br>
 <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サマリー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：システムにサービスがインストールされています。</font></font><br>
 <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスファイル名</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
 <code>%SystemRoot%\PSEXESVC.exe</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADドメインコントローラーでの予期しないPSEXESVCサービスの開始/停止イベント（イベントコード7036）：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログ名</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：システム</font></font><br>
 <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：サービスコントロールマネージャーの</font></font><br>
 <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「PSEXESVCサービスは動作しています。」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「PSEXESVCは停止状態に移行しました。」</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行状態のスケルトンキーとして、次のタスクを実行する必要があります。</font></font><br>
<br>
<ol>
<li>      64-  Windows.     32-  Windows   Windows Server,   Windows Server 2012 (6.2).<br>
<br>
<ul>
<li>6.1 (Windows 2008 R2)</li>
<li>6.0 (Windows Server 2008)</li>
<li>5.2 (Windows 2003 R2)</li>
</ul></li>
<li>  SeDebugPrivilege,               (LSASS).        AD,     .</li>
<li>  ,     LSASS.</li>
<li>      ,   :<br>
<br>
<ul>
<li>CDLocateCSystem —   <code>cryptdll.dll</code></li>
<li>SamIRetrieveMultiplePrimaryCredentials —   <code>samsrv.dll</code></li>
<li>SamIRetrievePrimaryCredentials —   <code>samsrv.dll</code></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順1の互換性チェックで設定したグローバル変数を使用して、特定のOSの設定を行います。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenProcess関数を使用して、LSASSプロセスハンドルを取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSASSプロセスのメモリを編集およびパッチするために必要なメモリ領域を予約して割り当てます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーティングシステムに基づくパッチ関連機能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CDLocateCSystem（Windowsのすべての互換バージョン）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SamIRetrieveMultiplePrimaryCredentials（Windows 2008 R2（6.1）のみ）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SamIRetrievePrimaryCredentials（Windows 2008 R2（6.1）を除くWindowsのすべての互換バージョン）</font></font></li>
</ul></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各関数を修正するには：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualProtectEx関数を呼び出して、必要なメモリ割り当て（PAGE_EXECUTE_READWRITE、0x40）への書き込みを許可するようにメモリ保護を変更します。</font><font style="vertical-align: inherit;">この手順では、メモリ内の関数コードを更新できます。</font></font></li>
<li>  WriteProcessMemory,      ,      .        .</li>
<li>   ,  VirtualProtectEx     .   ,         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッチ適用後、攻撃者はデプロイメント中に構成されたスケルトンキーパスワードを使用して、任意のドメインユーザーとしてログインできます。</font><font style="vertical-align: inherit;">正当なユーザーは、自分のパスワードを使用してログインできます。</font><font style="vertical-align: inherit;">この認証バイパスは、WebメールやVPNなどの一方向AD認証を使用するすべてのサービスに適用されます。また、攻撃者が侵害されたシステムに物理的にアクセスして、キーボードに埋め込まれたパスワードを入力することでコンピューターのロックを解除することもできます。</font></font><br>
<br>
<h4><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドメインレプリケーションの問題との関連付けの可能性</font></font></i></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪意のあるコードSkeleton Keyはネットワークトラフィックを送信しないため、ネットワークベースの検出が無効になります。ただし、このマルウェアは、感染を示す可能性のあるドメインレプリケーションの問題に関係しています。 CTUの研究者によって検出されたスケルトンキーマルウェアの各展開後すぐに、ドメインコントローラーは、Microsoftサポートでは説明または解決できない複製の問題に遭遇し、最終的にはそれらを解決するために再起動が必要でした。マルウェアには永続化メカニズムがないため、これらの再起動によりスケルトンキー認証のバイパスが削除されました。図では図1は、これらの再起動のタイムラインと、その後の侵入者によるパスワードの盗難、横方向の拡張とSkeleton Keyの展開を示しています。再配置は通常、再起動後数時間または数日以内に発生しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/jp/fz/qojpfzr6gcqy84wv_hl9f4xjnk4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図1. CTUの研究者によって観察された展開と再起動の関係、2014年4〜7月（出典：Dell SecureWorks）</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対策</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪意のあるコードSkeleton Keyは認証をバイパスし、ネットワークトラフィックを生成しません。</font><font style="vertical-align: inherit;">その結果、ネットワーク侵入検知および防止システム（IDS / IPS）はこの脅威を検出しません。</font><font style="vertical-align: inherit;">ただし、CTUの研究者は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">付録A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">YARAの署名を書き留めて</font><font style="vertical-align: inherit;">、Skeleton Key DLLと、それがLSASSプロセスメモリに入力するコードを発見しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脅威指標</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表3の脅威インジケーターを使用して、Skeleton Keyマルウェアに関連するアクティビティを検出できます。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インジケータ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">66da7ed621149975f6e643b4f9886cfd</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">md5ハッシュ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケルトンキーパッチmsuta64.dll</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ad61e8daeeba43e442514b177a1b41ad4b7c6727</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sha1ハッシュ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケルトンキーパッチmsuta64.dll</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bf45086e6334f647fda33576e2a05826</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">md5ハッシュ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケルトンキーパッチole64.dl</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5083b17ccc50dd0557dfc544f84e2ab55d6acd92</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sha1ハッシュ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケルトンキーパッチole64.dl</font></font></td>
</tr>
</tbody></table></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表3.スケルトンキーのインジケーター。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CTUリサーチチームは、次のスケルトンキーセキュリティ機能を実装することを組織に推奨しています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPNやリモート電子メールを含むすべてのリモートアクセスソリューションの多要素認証では、攻撃者は単一要素認証や盗まれた静的資格情報を使用した認証をバイパスできません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワークステーションおよびサーバー（ADドメインコントローラーを含む）のプロセス作成監査ログは、スケルトンキーの展開を検出できます。</font><font style="vertical-align: inherit;">特に、組織は次の成果物を探す必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予期しないPsExec.exeプロセスとPsExec "-accepteula"コマンドライン引数の使用</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予期しないrundll32.exeプロセス</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTLMハッシュコードと同様の引数を処理します（0〜9の数字とAF文字を含む32文字）</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADドメインコントローラーでWindowsサービスマネージャーイベントを監視すると、PSEXESVC PsExecサービスの予期しないサービスインストールイベント（イベントコード7045）と開始/停止イベント（イベントコード7036）を検出できます。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">付録A-YARA署名 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のYARAシグネチャは、おそらくスケルトンキーを含む、疑わしいファイルまたはActive Directoryドメインコントローラのメモリダンプをスキャンすることにより、システム内のスケルトンキーの存在を検出します。</font></font><br>
<br>
<pre><code class="bash hljs">rule skeleton_key_patcher<font></font>
{<font></font>
strings:<font></font>
       <span class="hljs-variable">$target_process</span> = <span class="hljs-string">"lsass.exe"</span> wide
       <span class="hljs-variable">$dll1</span> = <span class="hljs-string">"cryptdll.dll"</span>
       <span class="hljs-variable">$dll2</span> = <span class="hljs-string">"samsrv.dll"</span><font></font>
<font></font>
       <span class="hljs-variable">$name</span> = <span class="hljs-string">"HookDC.dll"</span><font></font>
<font></font>
       <span class="hljs-variable">$patched1</span> = <span class="hljs-string">"CDLocateCSystem"</span>
       <span class="hljs-variable">$patched2</span> = <span class="hljs-string">"SamIRetrievePrimaryCredentials"</span>
       <span class="hljs-variable">$patched3</span> = <span class="hljs-string">"SamIRetrieveMultiplePrimaryCredentials"</span><font></font>
<font></font>
condition:<font></font>
       all of them<font></font>
}<font></font>
<font></font>
<font></font>
rule skeleton_key_injected_code<font></font>
{<font></font>
strings:<font></font>
       <span class="hljs-variable">$injected</span> = { 33 C0 85 C9 0F 95 C0 48 8B 8C 24 40 01 00 00 48 33 CC E8 4D 02 00 <font></font>
	   00 48 81 C4 58 01 00 00 C3 }<font></font>
	   <font></font>
	   <span class="hljs-variable">$patch_CDLocateCSystem</span> = { 48 89 5C 24 08 48 89 74 24 10 57 48 83 EC 20 48 8B FA <font></font>
	   8B F1 E8 ?? ?? ?? ?? 48 8B D7 8B CE 48 8B D8 FF 50 10 44 8B D8 85 C0 0F 88 A5 00 <font></font>
	   00 00 48 85 FF 0F 84 9C 00 00 00 83 FE 17 0F 85 93 00 00 00 48 8B 07 48 85 C0 0F <font></font>
	   84 84 00 00 00 48 83 BB 48 01 00 00 00 75 73 48 89 83 48 01 00 00 33 D2 }<font></font>
	   <font></font>
	   <span class="hljs-variable">$patch_SamIRetrievePrimaryCredential</span> = { 48 89 5C 24 08 48 89 6C 24 10 48 89 74 <font></font>
	   24 18 57 48 83 EC 20 49 8B F9 49 8B F0 48 8B DA 48 8B E9 48 85 D2 74 2A 48 8B 42 <font></font>
	   08 48 85 C0 74 21 66 83 3A 26 75 1B 66 83 38 4B 75 15 66 83 78 0E 73 75 0E 66 83 <font></font>
	   78 1E 4B 75 07 B8 A1 02 00 C0 EB 14 E8 ?? ?? ?? ?? 4C 8B CF 4C 8B C6 48 8B D3 48 <font></font>
	   8B CD FF 50 18 48 8B 5C 24 30 48 8B 6C 24 38 48 8B 74 24 40 48 83 C4 20 5F C3 }<font></font>
	   <font></font>
	   <span class="hljs-variable">$patch_SamIRetrieveMultiplePrimaryCredential</span>  = { 48 89 5C 24 08 48 89 6C 24 10 <font></font>
	   48 89 74 24 18 57 48 83 EC 20 41 8B F9 49 8B D8 8B F2 8B E9 4D 85 C0 74 2B 49 8B <font></font>
	   40 08 48 85 C0 74 22 66 41 83 38 26 75 1B 66 83 38 4B 75 15 66 83 78 0E 73 75 0E <font></font>
	   66 83 78 1E 4B 75 07 B8 A1 02 00 C0 EB 12 E8 ?? ?? ?? ?? 44 8B CF 4C 8B C3 8B D6 <font></font>
	   8B CD FF 50 20 48 8B 5C 24 30 48 8B 6C 24 38 48 8B 74 24 40 48 83 C4 20 5F C3 }<font></font>
<font></font>
condition:<font></font>
       any of them<font></font>
}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja481768/index.html">1CでWebKitを扱います。たとえば、UT 11.4のマネージフォームへのTinyMCEの統合です。</a></li>
<li><a href="../ja481770/index.html">コンピュータープログラミングのパイオニアであるトニーブラッカーが94歳で亡くなる</a></li>
<li><a href="../ja481772/index.html">VonmoTradeの実験。パート2：注文。タイプ、処理機能</a></li>
<li><a href="../ja481774/index.html">セキュリティクリブ：仮想パッチ</a></li>
<li><a href="../ja481776/index.html">5Gとクラウドゲームサービス-モスクワでの動作をテストする</a></li>
<li><a href="../ja481780/index.html">MyOfficeには200以上の新機能があります</a></li>
<li><a href="../ja481782/index.html">Pythonトランスレータの問題と言語の再考について</a></li>
<li><a href="../ja481784/index.html">カフカが実現した方法</a></li>
<li><a href="../ja481786/index.html">GoogleがPHP IMAP拡張を埋める</a></li>
<li><a href="../ja481788/index.html">実際の業界の問題を解決するための分析（子豚などの節約）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>