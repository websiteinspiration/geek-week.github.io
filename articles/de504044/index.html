<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò¢Ô∏è ‚èÆÔ∏è üòï Verwalten Sie hochverf√ºgbare PostgreSQL-Cluster mit Patroni. A. Klyukin, A. Kukushkin üçõ üåü üë±üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Transkript des Berichts / Tutorials "Verwalten hochverf√ºgbarer PostgreSQL-Cluster mit Patroni". A. Klyukin, A. Kukushkin
 

Patroni ist eine Python-An...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Verwalten Sie hochverf√ºgbare PostgreSQL-Cluster mit Patroni. A. Klyukin, A. Kukushkin</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504044/"><p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transkript des Berichts / Tutorials "Verwalten hochverf√ºgbarer PostgreSQL-Cluster mit Patroni". </font><font style="vertical-align: inherit;">A. Klyukin, A. Kukushkin</font></font></strong></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist eine Python-Anwendung zum Erstellen von leicht </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">zug√§nglichen</font></a><font style="vertical-align: inherit;"> PostgreSQL-Clustern basierend auf Streaming-Replikation. Es wird von Unternehmen wie Red Hat, IBM Compose, Zalando und vielen anderen verwendet. Mit seiner Hilfe k√∂nnen Sie das System von den Master- und Slave-Knoten (Prim√§r - Replikat) in einen leicht zug√§nglichen Cluster verwandeln, der die automatische Steuerung (Umschaltung) und die Notumschaltung (Failover) unterst√ºtzt. Patroni erleichtert das Hinzuf√ºgen neuer Replikate zu einem vorhandenen Cluster, unterst√ºtzt dynamische PostgreSQL-Konfigurations√§nderungen gleichzeitig auf allen Knoten des Clusters und viele andere Funktionen wie synchrone Replikation, benutzerdefinierte Aktionen beim Knotenwechsel, REST-API, die M√∂glichkeit, benutzerdefinierte Befehle zum Erstellen eines Replikats anstelle von pg_basebackup auszuf√ºhren, Interaktion mit Kubernetes etc.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Sch√ºler der Meisterklasse lernen detailliert, wie Patroni funktioniert, erwerben praktische F√§higkeiten zum Aufbau leicht zug√§nglicher Cluster, lernen verschiedene zus√§tzliche Funktionen kennen und nehmen an der Diagnose von Problemen teil. </font><font style="vertical-align: inherit;">Folgende Themen werden behandelt:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Umfang: Welche HA-Aufgaben werden von Patroni erfolgreich gel√∂st?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architektur√ºberpr√ºfung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen eines Testclusters</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patronictl Dienstprogramm</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL-Konfigurations√§nderung f√ºr von Patroni verwalteten Cluster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API-√úberwachung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kundenwechselans√§tze</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zus√§tzliche Funktionen: manuelles Umschalten, geplanter Neustart, Pausenmodus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichtung der synchronen Replikation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erweiterbarkeit und Vielseitigkeit</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h√§ufige Fehler und ihre Diagnose</font></font></li>
</ul><br>
<p><img src="https://habrastorage.org/webt/9r/y9/td/9ry9tdadana91ykli7oyies025e.png"></p><a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lMPYerAYEVs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am Ende gibt es eine Umfrage: "In wie viele Beitr√§ge sollte das Tutorial unterteilt werden? Bitte abstimmen."</font></font></strong></p><br>
<p>( ) !  ,      tutorial  Patroni.   .   ‚Äì .    Zalando    .      Patroni.         ,      . ,  ,  ,     ,   failover     Patroni.       -  , , ,       . </p><br>
<pre><code class="bash hljs"><span class="hljs-comment">#     -      git, vagrant  virtual box.</span>
<span class="hljs-comment"># Vagrant     https://www.vagrantup.com        . Virtualbox: https://www.vagrantup.com</span>
<span class="hljs-comment">#   Vagrant  Virtualbox  :</span>
$ git <span class="hljs-built_in">clone</span> https://github.com/alexeyklyukin/patroni-training<font></font>
$ <span class="hljs-built_in">cd</span> patroni-training<font></font>
$ vagrant up<font></font>
$ vagrant ssh<font></font>
$ sudo -iu postgres<font></font>
$ <span class="hljs-built_in">cd</span> patroni<font></font>
$ ls<font></font>
postgres0.yml postgres1.yml postgres2.yml </code></pre><br>
<p>      vagrant‚Äô.           ,   ,    (    ,            ),     vagrant       GitHub,   ,  vagrantfile.    vagrant up  vagrant ssh.     ,     etcd,    Postgres     Patroni.        ,   . </p><br>
<p>           ,   .     ,        ,    , ,   .       .       ,      ,   ,      Patroni.</p><br>
<p>Patroni    ,       postgres-.           ,   failover.   Zalando    .   Patroni  ,         postgres-.          . </p><br>
<p><img src="https://habrastorage.org/webt/kd/tt/d6/kdttd6__ondn3-hlmj-v05c2nx4.png"></p><br>
<p>( )  .    ,   ,    .       failover.  ,    ,        .  ,    .</p><br>
<p>    Patroni,     ,    ,       . </p><br>
<p>   ,      Patroni.    ,       .   ,  Patroni  ,   .</p><br>
<p>   ,   ,    Patroni  ,    .</p><br>
<p>      Patroni    ,     .  ,  failover,  callback .</p><br>
<p>     ,     -. </p><br>
<p>     Patroni.  ,    failover  .   ,        Patroni.     .</p><br>
<p>          ,    Patroni.    ,  Patroni   , , ,      point in time recovery     .</p><br>
<p>       ,    ,   Patroni  GitHub.  ,           .</p><br>
<p>    .       Patroni     failover.</p><br>
<p><img src="https://habrastorage.org/webt/c8/eu/ei/c8eueiz4wymnpj-98c2q_my6zxq.png"></p><br>
<p>( ) !         Patroni,       High Availability,   ,   Postgres . </p><br>
<p>-    -  .    -  ,         .    ,      ,    Postgres.  ,    ,     DRDB  LVM.</p><br>
<p> ,      ,  ,  Corosync, PaceMaker.     .        .   PaceMaker  ,      .    ,    ,   .   -  -   .    ,  ,    ,   ,  . </p><br>
<p>   ,    ‚Äì      . ,     Postgres  10- .      trigger-based    ,  , . </p><br>
<p>      .     , ,  ,     ,    .     -  , ,  , .   -  , , . .   () . </p><br>
<p> ,  2009-   Postgres 9.0,      .       . ,  ,    High Availability    . </p><br>
<p> ,    multi-master‚Äô     ,       .       .         BDR  bucardo.     ,   .   BDR,  bucardo    .        .       -    .           .    ,           . ,     .       ,    .     High Availability    .</p><br>
<p><img src="https://habrastorage.org/webt/a2/-m/qu/a2-mquwe0wno-pr3zgak_eu36m8.png"></p><br>
<p>    ?           .      ,     standby    ,  -    . </p><br>
<p>        ,          major versions.</p><br>
<p><img src="https://habrastorage.org/webt/0w/yg/gu/0wygguw136eip96xykdphcuptzo.png"></p><br>
<p>   :   ,    primary.   standby ,       .  - ,      .   ,   ,    standby   . </p><br>
<p>    .     .   -   . . .       ,     .    ,  ,  standby -  , , .   ? </p><br>
<p><img src="https://habrastorage.org/webt/b-/ys/hc/b-yshchkomkz3jnwcpizdh2gqca.png"></p><br>
<p>    .   split-brain .</p><br>
<p><img src="https://habrastorage.org/webt/zz/kn/xi/zzknxipqso0j0wxly5xl1orb3sk.png"></p><br>
<p>       .       standby      -  . </p><br>
<p><img src="https://habrastorage.org/webt/gt/ay/gq/gtaygqfzzwhz9mcggzhuc1ncd7k.png"></p><br>
<p>,   ,      ? -,        .     .      , , .       failover.   ,  ,   .    ,      ,  ,   , ?      .     .      .</p><br>
<p><img src="https://habrastorage.org/webt/nl/pb/an/nlpbanb-wdsxaebegkummf_-1zm.png"></p><br>
<p>   .   ,    standby     .  ,   ,      ,     standby.  ,   ,      .      standby   .        split-brained.</p><br>
<p><img src="https://habrastorage.org/webt/hi/wb/_a/hiwb_amspck39sslsigum6viske.png"></p><br>
<p>               .      ,       ,   . </p><br>
<p>       .      ,    primary ,        .    ‚Äì  .      ?  ,     ,   ,       ,      . </p><br>
<p>(:     )</p><br>
<p>,       .  ,  ,  STONITH. - ‚Äì   ¬´    ¬ª. </p><br>
<p>Quorum        .  -   ,       .          . </p><br>
<p>    Watchdog.   ,   ,      ,     . ,  -   Patroni,  Watchdog         .     ,       Postgres    .</p><br>
<p><img src="https://habrastorage.org/webt/2_/4c/v-/2_4cv-4pkab2l0_gqbd1gh3w_-g.png">      ,       ¬´Compose¬ª. Compose   IBM.    .   ,      Postgres      daemon`a,     instance Postgres.            -  ,      lock,       .     lock' ,      . </p><br>
<p> Bot   .       ,    Postgres     ,        ,    .</p><br>
<p><img src="https://habrastorage.org/webt/0d/s1/wo/0ds1wopvu6zmofkog52ui6wj7pg.png"></p><br>
<p> ,     .       ,    .      etcd     .          30 .  ,      ttl.    ,     .</p><br>
<p><img src="https://habrastorage.org/webt/dd/_s/dt/dd_sdtqflk0gut5yem6n1v9tzow.png"></p><br>
<p>   -    ,      .      ,    . </p><br>
<p><img src="https://habrastorage.org/webt/mg/hi/q4/mghiq4hyekctuwpo_iryzt2kvng.png"></p><br>
<p>      ,   ,  etcd.      .</p><br>
<p><img src="https://habrastorage.org/webt/pr/et/pw/pretpwglksflgordoxujhpcim5a.png"></p><br>
<p>   ?       ,    .      -  ,       .     .      WAL  .  ,           ,    ,      wal_position  100,      . . .          etcd.</p><br>
<p><img src="https://habrastorage.org/webt/y9/mq/ql/y9mqql1jdegdzfqu0uejhhdbqsy.png"></p><br>
<p>   etcd?  ,       . . .     ,   ,  ,       ,    .</p><br>
<p>     ,   C ,     ,   B  . </p><br>
<p><img src="https://habrastorage.org/webt/ik/rp/d0/ikrpd0fphoi27mo8pxqwoiht-js.png"></p><br>
<p>    ,   C   ,   promote  Postgres.   B   ,        A,  ,    C. </p><br>
<p><img src="https://habrastorage.org/webt/dn/nw/4u/dnnw4ukojeqyah-6mqujn6x6dy8.png"></p><br>
<p>   etcd. , ,      -,  Patroni      distributed consistency store,  ,  Etcd, Consul, Zookeeper.       Kybernetes API.</p><br>
<p>Etcd    RAFT.          ,    . </p><br>
<p>         ,  etcd    leader election,    ,     ,             ,           .</p><br>
<p><img src="https://habrastorage.org/webt/e0/dh/5f/e0dh5fn6ugwm4ntmp1aacfzuqxo.png"></p><br>
<p>Patroni    . Patroni   Python.        Zalando,          .     ,  .  .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Cybertec</a>.    ,    Postages.       Patroni   .</p><br>
<p><img src="https://habrastorage.org/webt/s9/ye/1k/s9ye1k6csleid97hiy-ytegebhw.png"></p><br>
<p>( )     ,     Patroni . ,       ,      ,     High Availability . </p><br>
<p><img src="https://habrastorage.org/webt/cg/er/qb/cgerqbhaccosc_y8lyxxkwgqe6g.png"></p><br>
<p>      .    ,   .       ,        vagrant.      .     <code>vagrant ssh</code> ,    <code>sudo -iu postgres</code>     Patroni.</p><br>
<p>       High Availability Patroni .</p><br>
<p> Patroni ‚Äì   .    vagrant‚Äô   etcd.     ,      instance etcd.  production , ,  ,    instance etcd,     etcd  ,         .    ,     . , ,    etcd  production.   ,  High Availability  , Patroni     . </p><br>
<p>     Postgres,     Patroni.      yml-.     yml-?     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">GitHub</a>,  Patroni ‚Äì  open source ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">GitHub</a>            yml-.      ,   ,    . . .    <code>git clone https://github.com/zalando/patroni.git</code>,        ,     Python   .         .</p><br>
<p><img src="https://habrastorage.org/webt/uw/c6/ov/uwc6ovm1ucsiqritm2v9ywsijne.png"></p><br>
<p><strong>C 26:33  dem.</strong></p><br>
<p>  .   Postgres.     Patroni.   .   <code>patroni postgres0.yml</code>.      Patroni. ,     Patroni.</p><br>
<p><strong>  Patroni ,      .   -,   initdb</strong>. Initdb .    initdb.    ,     .  ,     ,  lock, . .    ,   .     : ¬´lock owner: postgresql0; I om postgresql0¬ª, . . ,   ,    . </p><br>
<p>       .   <code>patroni postgres1.yml</code>.     ?    etcd-. ,    .     .   etcd     ,   .   ,   initdb   ,   pg_basebackup.   Postgres,     .      . </p><br>
<p>   .      Postgres.    Postgres .     .    ,      WAL-.  ,       .</p><br>
<p>  ?   ,  , Patroni  .   ,  <strong>Patroni      </strong>.  Postgres        ,      . <strong>  ,            - ,        wal-,       .       ,    wal-,     .    .      .</strong> </p><br>
<p>     Postgres    ,    . <strong>. .      ,           Postgres  wal- .      ,         .</strong> </p><br>
<p><strong>     ,      ,   ,    wal-  .    .    ,      .   Patroni     .      ,       ,               .</strong> </p><br>
<p>  ?  ,     ,   Patroni    .   Patroni    ,  .         . </p><br>
<p>   .   ,    .     Patroni,    Postgres.        ¬´postgres1¬ª,  postgres1 ‚Äì    .        ,  Patroni -   .      .      .  ,   lock  postgresql0,   potstresql1, . .  ‚Äì  ,  ‚Äì ,    lock,     .        promote,      ,    lock.   Patroni    .        ,   , . .   ,    ,   ,   Patroni ,   . </p><br>
<p>      ?  .    ?  python-etcd.    .      .     patroni-training,    vagrant.   <code>pip install python-etcd</code>.     etcd  Patroni.    ,      Patroni,   . Patroni  etcd   . </p><br>
<p><img src="https://habrastorage.org/webt/ea/ov/5j/eaov5jy1o1xi21m1wkbir8od5pc.png"></p><br>
<p>   ?   ,   Patronictl. Patronictl    Patroni.         . </p><br>
<p>   ?     .   Patroni   ¬´patronictl¬ª,     .       .      .   ,    , . . ¬´list¬ª.</p><br>
<p>   ?     .      ,    ¬´postgresql0¬ª  ¬´postgresql1¬ª,  ,   .   ,   .  ,     .  ,    .     Postgres, . . Postgres    .   (Lag) ‚Äì      ,         .    ,   ,      .     ,  Patroni         Patronictl   .   ,      ,       .</p><br>
<p>,    ,      failover.         Patroni.</p><br>
<p><img src="https://habrastorage.org/webt/l1/pt/zy/l1ptzygc-ewprtdrllawk_d9_m4.png"></p><br>
<p>    ?   ,  Patroni   failover.  .  switchover,  failover. Switchover ‚Äì   ,        -  .   ,  failover (   ‚Äì  ) ‚Äì       ,        -  .   ,  Patroni .</p><br>
<p>     failover.     ?     Patroni  .   Patroni  .    ¬´kill Patroni¬ª,      ¬´kill Patroni¬ª,     Postgres.    ctrl+Z, . .   Patroni  background ,   . </p><br>
<p>   .   .   ¬´ctrl+Z¬ª    .   .</p><br>
<p>   ?      .      ?      Patroni   .    etcd   .    .       ‚Äì   30 .     ¬´ttl¬ª.   .      .        Patroni.     8 ,  10 ,  .      ,    ,   ,      failover.          ,  30 .</p><br>
<p>  ?    .   ?     warning  . Patroni  ¬´request failed¬ª, . .    GET request.   ? Patroni ,  lock‚Äôa  etcd  .     .  lock , Patroni       .     : ¬´ ‚Äì ?¬ª.     ,  Patroni   wal‚Äô, . .      .</p><br>
<p><img src="https://habrastorage.org/webt/nr/l4/z7/nrl4z7ir1s-zl164ymunxse9_aq.png"></p><br>
<p>  ,   .     .      : ¬´  ?¬ª.      ,     Patroni  .   ,   ,      promotion, . .    .  : promoted self to leader by acquiring session lock.</p><br>
<p>:   Patroni  ?</p><br>
<p>:        ,    .     . </p><br>
<p>,    ,    .     promotion.</p><br>
<p>:    etcd       Patroni?</p><br>
<p>: <strong> ,    .  Etcd   ‚Äì    ,    ,     ,    .</strong>    ‚Äì  .      etcd , . .   ,  Patroni .  ,     .     ,     Postgres,        etcd.   -  ,       etcd. </p><br>
<p>          etcd,   Patroni,   Postgres,      . </p><br>
<p>  etcd ,     ‚Äì    ,     .    etcd     Postgres,   etcd  -   .     etcd  ,    . </p><br>
<p>:    etcd,  network partition, . .      ?</p><br>
<p>:  network partition.  etcd   ,    . <strong>    ,     ,       . , ,          .</strong>     ,    ,     .           . </p><br>
<p>   ,     ,    promotion.      .  ,   ,     lock,   postgres1   . </p><br>
<p>      .  ,   postgres0 ,   Patroni?   Patroni,  Postgres   .  Postgres      .</p><br>
<p>   ,     ,  ,   -   .   Postgres    ,    split-brain, . .    . </p><br>
<p>.     ,   promotion   .      ,      ,       Patroni. </p><br>
<p>       - .  ,   split-brain.    ,  Patroni     split-brain.</p><br>
<p><img src="https://habrastorage.org/webt/tg/f4/u0/tgf4u0hckk2qi0vsl-jdk3locik.png"></p><br>
<p>    ?    .   ,   ¬´split-brain¬ª.      Postgres.      .   .</p><br>
<p>   .    .    Patroni,     .    ‚Äì   .   Patroni,   ,   .  ,  . </p><br>
<p><img src="https://habrastorage.org/webt/tn/tu/z4/tntuz4vgg2l2ohyejorgiz_ewu8.png"></p><br>
<p><strong>  ,   ‚Äì   ,    .    ?   demoting Postgres  ,  . . .   Postgres ‚Äì  immediate shutdown     .  Postgres  immediate shutdown.</strong>     shutdown, . .     ,    .       .        ,   demoting, . .   promotion,      lock‚Äô.      Postgres.</p><br>
<p>  crash recovery,   immediate shutdown ‚Äì      .    pg_rewind. Pg_rewind    ,      .    crash recovery mode  single user.   ,     single user  .    pg_rewind,   Patroni ,         ,   promotion. </p><br>
<p>. .    crash recovery.   ,      wal-.    wal- .   ,   split-brain,    ‚Äì ,      ,     <code>create table split-brain</code>.      pg_rewind. </p><br>
<p>  pg_rewind?    Postgres,             ,      .     ,       ,     promotion.</p><br>
<p>    .    ¬´running pg_rewind from postgresql1¬ª. Pg_rewind ,   split-brain,         . ,    rewind,  ‚Äì done.     ,      .  ,   ‚Äì postgresql1,   ‚Äì postgresql0. . .     , ,   ,   split-brain (split-brain ,     Patroni,      Patroni,   split-brain   ),        . . . Patroni    ,   .        ,   pg_rewind     . </p><br>
<p><img src="https://habrastorage.org/webt/xb/eg/uw/xbeguwdlzwmoxn-zxhghafrzh9y.png">         Patronictl.      ,    ,       postgreslq1.    postgresql0,   postgresql1. , , postgresql0    ,   ,   .     .     failover  ,  Patroni     .</p><br>
<p>:    ,    ?</p><br>
<p>:    . . .      ,      ,        .       .  split-brain,   .   Patroni ‚Äì   split-brains,    . </p><br>
<p>   .      . . . -        .   ,    .     Patroni.      .        ,         . </p><br>
<p>     ?   etcd.  ,       .       etcdctl.    ,     etcd.     Consul, ZooKeeper  Kubernetes.  . </p><br>
<p>Etcd ‚Äì   -.    - .      - .   ,      ,         , . .  postgresql0   porsgresql1.     initialize,    ,        ,      ,     . . .    ,    -  ,    .      initialize      ,    . </p><br>
<p><img src="https://habrastorage.org/webt/xy/qd/ht/xyqdhtdyw7rcwg6om5sj6hughhi.png"></p><br>
<p>     ,      .     .      ,     members/postgresql1.  json,      . </p><br>
<p> ,   url,        Postgres.   api_url, . . url,   Patroni,    promotion,      Patroni ‚Äì    .     .     Patroni   ,      .    .       xlog‚Äô  wal‚Äô   , . .        wal-.       timeline.</p><br>
<p>     .  history.   ,   timeline history,   ,    promotion  ,  ,      .    .    ,   promotion. . .      ,    failover.</p><br>
<p><img src="https://habrastorage.org/webt/7s/1h/sm/7s1hsmcsrrbn1ybdlonhkx9eyds.png"></p><br>
<p>   ,  .   ,       Postgres.</p><br>
<p><img src="https://habrastorage.org/webt/8x/em/yi/8xemyilikqbe-jexiupdnwatrmi.png"></p><br>
<p>      ?      .    .  , ,          postgresql.conf   autosystem  ,    ,         .    ,          ,   - ,       .             ,      shared_buffers  max_connections  .       .</p><br>
<p>   ?  ,   ,   maintenance_work_mem  work_mem,     Postgres  ,           .</p><br>
<p>    Patronictl.  .  ‚Äì edit-config.    .     .</p><br>
<p>    ?      ¬´maintenance_work_mem¬ª  work_mem.    Postgres,  parameters.   .    ‚Äì 128 MB.</p><br>
<p>   .  Patroni  ,   ,  ,      ?  ,     .</p><br>
<p><img src="https://habrastorage.org/webt/lc/h0/ky/lch0kyhp98vthk5r_miicnrlwjc.png"></p><br>
<p>     ,     .   .  ,    SIGHUP.  ,   Postgres   .   SIGHUP   maintenance_work_memory   ,    128 MB.</p><br>
<p>         .   SIGHUP       128 MB.</p><br>
<p>. .               .  , Patroni  reloading  . . .         . Patroni      .</p><br>
<p>Patronictl     .     . </p><br>
<p>     .   maintenance_work_mem  ,   .</p><br>
<p><img src="https://habrastorage.org/webt/ss/66/is/ss66isleswrs0ty53mp62gv7wiu.png"></p><br>
<p>  ,  ,    ,     .      edit-config.   maintenance_work_memory    ¬´max_connections¬ª.     ?    ,     postgres-.       ,  max_connections,       ,      . </p><br>
<p>Max_connection     ,   . </p><br>
<p> max_connection     ‚Äì 101.  ,  .     . Max_connection ,  101.  ,   .   ,     .     - ?       ,     . </p><br>
<p>?      ,   Postgres. <strong>Patroni       .</strong>  ,    ,  ,    , .      : ¬´    production     ?¬ª.    Patroni  .</p><br>
<p><img src="https://habrastorage.org/webt/bn/0o/bg/bn0obgrdjej5egekdzez1s6q5tq.png"></p><br>
<p>      ,     ?      Patroni.    REST API.  Patroni  REST API,        ,    ,    etcd.</p><br>
<p>    .     ?  ,  ‚Äì  .     .     ,  ,   ?  ,       ¬´pending_restart¬ª    ¬´true¬ª. . . pending_restart ‚Äì   .     .    ¬´true¬ª.        ,   ,  ,     ,   ,   .</p><br>
<p><img src="https://habrastorage.org/webt/4p/iy/zg/4piyzgqwzoheljcu5upkiuztb2m.png"></p><br>
<p>    ,     .   ,    .   ,         .      .   ? </p><br>
<p><img src="https://habrastorage.org/webt/ee/li/db/eelidb_tmxx5oqtasc3alclmzwy.png"></p><br>
<p>   Patronictl list  ,    . Patronictl  ,      .    ? </p><br>
<p><img src="https://habrastorage.org/webt/sl/mn/wk/slmnwk3xfysrkgng9gaajlfnqnc.png"></p><br>
<p>     Patronictl, . .  Patroni    ¬´patronictl restart¬ª.      ,  ,     .    .   ,       , . .  postgresql1  postgresql2.  production      ,     failover,   . </p><br>
<p>   .</p><br>
<p>      ,        .     ?   ,   .       , . .   .    ,   . </p><br>
<p><img src="https://habrastorage.org/webt/gj/qv/np/gjqvnptjqi5yiatv78-6rd1lmwm.png"></p><br>
<p>   ‚Äì       max_connections  .            ¬´show max_connections¬ª.  ‚Äì 101.    .  101. (:     ,      max_connections  100) . .   max_connections.   Patroni    .   .</p><br>
<p>     ,      .   max_connections      ,  max_connections  .     max_connections  ,   ,        ,       .   Patroni      . Patroni   .</p><br>
<p>. .   ,    ,  max_connections    ,  . Patroni ,  Postgres        max_connections. </p><br>
<p>        .        . Batman ‚Äì   .     ,        .     -  . </p><br>
<p><img src="https://habrastorage.org/webt/2m/dt/dh/2mdtdh_liwnasrb6c0yf8n6m_tk.png"></p><br>
<p>Patroni  ,      ,  -   .</p><br>
<p>        Patroni. . .     Postgres,   Patroni   ,   yml.         : ¬´    ,         promotion?¬ª.</p><br>
<p>    ttl, . .      etcd    .        ttl    . </p><br>
<p><img src="https://habrastorage.org/webt/e5/3-/y9/e53-y9mjs8uzixopsvkyyjjd-es.png"></p><br>
<p>    ,   Patroni.  Patroni    ,      ,    - ,  , ,  . ,  ,  failover. </p><br>
<p><img src="https://habrastorage.org/webt/x4/jz/e1/x4jze19exm0-zmoqhdak09w7evw.png"></p><br>
<p>     ,  .     . ,   ,   ¬´loop_wait¬ª. . .     ,     . </p><br>
<p> ,   loop_wait ,  ttl? Patroni .   ,   ,   ,   .   promotion -  .        . . .   ,     . </p><br>
<p>   ,  ttl   ,  loop_wait.        ,    Patroni   etcd,     ¬´demoting¬ª,       etcd  ,   ,   .       retry_timeout. </p><br>
<p>,  : ttl     ,  loop_wait + 2  retry_timeout.    ,   loop_wait,  retry_timeout    ttl.</p><br>
<p><img src="https://habrastorage.org/webt/0m/qg/et/0mqgetymplufhcqmv5njqxrxxha.png"></p><br>
<p>    ?     . . .   loop_wait  , ttl   .   loop_wait  10 ,  ttl  5.        ,  Patroni  . ,  .</p><br>
<p>  ¬´patronictl edit-config¬ª   ttl  5 , loop_wait  10 .     ,   . </p><br>
<p><img src="https://habrastorage.org/webt/i5/es/ev/i5esev4zn3ijs5h9rmr7c_4_w9i.png"></p><br>
<p>  .     ,   watchdog‚Äô,    Patroni, ,   .     watchdog,       ,       .     ?  ,              . </p><br>
<p>Postgres   .   ¬´acquired session lock as a leader¬ª.  ?   Patroni ,   , Patroni    .    ,         .      .    , .      ,     ,    .        .      .       .</p><br>
<p><img src="https://habrastorage.org/webt/29/ut/u5/29utu58nzmedpvrs66hvrhw4dwu.png"></p><br>
<p>  ,    .     ,               .      . . .       ,      REST API   ,   ,     .   ,      promotion.    . </p><br>
<p>    etcd   .  ,     . ,   ¬´following a different leader¬ª, . .   .    etcd   ,       , . .    .    . . .    ,    .   ,      . </p><br>
<p><img src="https://habrastorage.org/webt/t0/uj/_e/t0uj_efdmpl80vtifrg8noahhmc.png"></p><br>
<p> ,    ,          ,     .       .    ,      , . .       .    ,          .      ,    , . .    ,  ttl  ,  loop_wait + retry_timeout *2. </p><br>
<p>   :    ,        ,     ttl.     ttl,      ,    , . .   loop_wait .     ,     . </p><br>
<p>,  , retry_timeout   .     ,     .    retry_timeout    -   etcd,  Patroni  demoting  .   -,      , , ,  ttl  60 ,        ,  switches .   30     .     -,      . </p><br>
<p><img src="https://habrastorage.org/webt/xd/dl/pw/xddlpwbop5fex-jzdnikcwyrn_w.png"></p><br>
<p>       Patroni.  ,   .     Patroni.      bootstrap .   bootstrap       ttl  loop_wait,   retry_timeout,   .     ,     Postgres.</p><br>
<p>   bootstrap ?        etcd,     bootstrap    etcd.         .  , ttl, loop_wait.   .     ,  ,      etcd      .</p><br>
<p> ,  PostgreSQL     ¬´use_pg_rewind¬ª,    ,     pg_rewind.   Patroni,    Postgres.      Postgres.        , . .   .       .         ,   . </p><br>
<p>   ,    ,    bootstrap   Patroni,    .           Patronictl, . .      etcd. Patronictl     . </p><br>
<p>. .     ,  ,    etcd         ,              bootstrap,       ,         .     . </p><br>
<p>  ?       Postgres?       . </p><br>
<p>   ‚Äì     patroni.yaml.     bootstrap.  ,     ,      PostgreSQL.    PostgreSQL  ,   ,     . . .     Patroni    -     .        . ,           , ,      16 B ,      MB,       4 B shared buffers,    1 B.              shared buffers. . .    ‚Äì    Patroni   .    bootstrap,     . </p><br>
<p><img src="https://habrastorage.org/webt/ex/d3/hp/exd3hpzco7txdtfngfeavfb2gve.png"></p><br>
<p>  .       etcd.  etcd     config.    . </p><br>
<p><code>etcdctl ls / service/batman/config</code></p><br>
<p>      .     ,     etcd .   Patroni.yaml, . .         -  .     production,  ,   ,     - . </p><br>
<p>      -   Postgres.      alter system   -.</p><br>
<p>    .   ,      etcd .     ,     bootstrap,    .   ,     retry_timeout,      Postgres.      etcd -   postgresql parameters.  ,    ,  Patroni   ,    Patroni,    . </p><br>
<p> patronictl   ,    .     ,    json,  patronictl  yml,       ‚Äì .    json  ‚Äì   . </p><br>
<p>      etcd.        patroni.yaml,     ,   etcd . . . work_mem  etcd  16 MB,  patroni.yaml   12 MB. Patroni.yaml   .    ? Patroni  postgres‚Äô  ,   12 MB.      Alter System,   , . . patroni.yaml    etcd.</p><br>
<p>. . , , postgresql.conf,   Patroni  ,   .   postgresql.conf.   ,   .      .        ,       .    Patroni. </p><br>
<p>     include ‚Äòpostgresql.base.conf‚Äô.     . </p><br>
<p>  base    .     Patroni  ‚Äì ,   base ,  - , . . ,      Git, ,    . </p><br>
<p>  Patroni?    postgresql.conf    postgresql.base.conf.  ,    postgres .      postgresql.conf,       ,     etcd   .      postgresql.base.conf. </p><br>
<p>   ?          alter system.    ,      base.conf     .     alter system  - ,   ,   ,      .      ,    ,   Patronictl edit-config ,       maintenance_woke_mem  shared_buffers.         .</p><br>
<p><img src="https://habrastorage.org/webt/wi/vn/om/wivnom1psquqoqpqyk7ya7eixck.png"></p><br>
<p>    ,     . . .       config.      patroni.yaml. <strong>    patroni.yaml   ,      ,   config,      ,  .</strong>    alter system,       .     -   alter system,    , , max_connections,  Patroni        pending_restart.</p><br>
<p> alter system   max_connections .</p><br>
<p>, .  . Shares_buffers.</p><br>
<p>    , . .       .  ,          .     max_connections, max_locks_per_transaction, wal_level. Wal_revel    wal    .    ,       .     wal‚Äô .</p><br>
<p> Patroni     .     ,  logical.</p><br>
<p>   Patroni?    Postgres       .          .       Patroni.        Patronictl edit-config    . <strong> ,   ,          ,     ,        .</strong></p><br>
<p><img src="https://habrastorage.org/webt/tw/3o/zt/tw3oztojnuut1vo5vpk-uhvhtaw.png"></p><br>
<p>    Patroni     REST API,   .   ,          . </p><br>
<p><img src="https://habrastorage.org/webt/rq/9q/ax/rq9qaxwl0xehhpf7hrxdbpgmba8.png"></p><br>
<p>    Patroni     endpoints  REST API.    ‚Äì     ,    GET requests.  ,  options ,     . </p><br>
<p>   ?    <code>200 K</code>,   ,      . PostgreSQL      recovery      . </p><br>
<p>   <code>200 OK</code>   ,      ,       read-only    ,     Postgres . . .  Postgres    ,   -,    503. </p><br>
<p>,    .      ,   endpoint <code>/master</code>    503.</p><br>
<p>    Patroni.  ,         . . .     json-,      xlog‚Äô,  Postgres  -   . ,        .    ,  Patroni    200. </p><br>
<p>     endpoint      <code>/config</code>.  ,     ,        Patronicrl.         .</p><br>
<p>Patroni   <code>/switchover</code>  <code>/failover</code>. Switchover,    ,    . . .    ,     ,   -   ,         -  ,     , ,    -  . ,      ,      . </p><br>
<p>Patroni   REST API   Postgres.      <code>/restart</code> endpoint.</p><br>
<p> Patroni   . . .    ,       pg_rewind   .        .  , wal‚Äô  ,  ,  -.    ‚Äì    <code>/reinitialize</code>, . .  Postgres,  -   base_backup.</p><br>
<p>    endpoints   Patronictl     . </p><br>
<p><img src="https://habrastorage.org/webt/lk/qc/1d/lkqc1ddn9hhhtrq0scphxhnpm7g.png"></p><br>
<p>   Patroni endpoint  ?  json-.    database_system_identifier.    ,    ,     .    ,    ,    .  batman.   ,    Postgres . </p><br>
<p>      .  ,     . </p><br>
<p>  server_version    Postgres.    ‚Äì    10.0.   ,    Postgres  .</p><br>
<p><img src="https://habrastorage.org/webt/yh/sd/_i/yhsd_iquj8j56wwdmwp47jcjgqq.png"></p><br>
<p>      .  ,   ‚Äì ,  ,   timeline ‚Äì 2. </p><br>
<p> xlog   -,        ,   xlog‚Äô    ,    . </p><br>
<p> timestamp ‚Äì null.  replayed_timestamp ‚Äì null?        ,     . ,       ,      ,  timestamp    . </p><br>
<p>  replayed_timestamp -   ,  received  300 . ?    ?    ,    ,   .     ,  received_timestamp  ,  replayed_timestamp. , ,  ,   . </p><br>
<p><img src="https://habrastorage.org/webt/in/vd/kf/invdkfb06acp3z3tdgeoildxqpg.png"></p><br>
<p>   endpoints      Postgres,    Patroni.</p><br>
<p><img src="https://habrastorage.org/webt/pl/od/lc/plodlc5ny1-ljgyyn09k48utf90.png"></p><br>
<p>       endpoints  ,      ,   -   .</p><br>
<p>HAProxy      . HAProxy     ,     ,  ‚Äì     ?    200,   503.   , .     HAProxy    ,    ,   .       . </p><br>
<p>     ? ,     -       IP   -,      IP.    DNS,        IP   -  . </p><br>
<p> Patroni    -  .   shell script. Patroni      . ,    Postgres,   ,    on _start,   Postgres   ,    on_stop.  on_reload, on_restart ‚Äì   .</p><br>
<p>On_role_change ‚Äì   . ,    ,   . . . Patroni  pg_ctl promote.      Patroni  ,    on_role_change.  , ,    IP   ,   . </p><br>
<p>     ?     ,         .   IP .    HAProxy ‚Äì   .          HAProxy     ,  .     .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">confd</a>.     ,     etcd,   ZooKeeper     .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/zalando/patroni/blob/master/extras/confd/conf.d/haproxy.toml</a> </p><br>
<p>         ,    ,     etcd - . . .      ,      confd     .     ,        reload, . .      HAProxy.</p><br>
<p>  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">template</a>  HAProxy.    max_connections,  -    .      ,       .</p><br>
<p>  ?      ¬´on-marked-down shutdown-sessions¬ª.   ?   ,        200,     503     ,  HAProxy      .           ,   ,     .     ,  Postgres       - .     .  HAProxy   .        ,   HAProxy   health checks  . </p><br>
<p>      ?        confd,    config  PgBouncer.     ,   PgBouncer      .     ,      ,   failover ,       . PgBouncer    . </p><br>
<p>   Postgres 10-        connection string.     read-write  libpq      .   ,     ,     .   read only   -.</p><br>
<p><img src="https://habrastorage.org/webt/uf/b6/__/ufb6__0otqmelwhrrvffpp_exig.png"></p><br>
<p>     callbacks.   ,       -. </p><br>
<p><img src="https://habrastorage.org/webt/gr/03/xk/gr03xkwzwf7_bpzzzgmetslsdau.png"></p><br>
<p>   callbacks ,    service_ip ( ip),      . </p><br>
<p>          promotion  ,     service_ip.           .       .  ,     ,       .</p><br>
<p>     , -,  callback , -, ,    . . .     ,      on_role_change.   scope ‚Äì   . </p><br>
<p><img src="https://habrastorage.org/webt/6r/5o/z6/6r5oz6d5pnrmbuqgj5cigzw21zy.png"></p><br>
<p>    callbacks?           .     ,    -.  callback    ,      ,     ,  callback,    . , ,        -,      ,    IP     -  ,     .    issue,     . </p><br>
<p><img src="https://habrastorage.org/webt/sj/__/iu/sj__iumh-c3y3fjgt3hqmogp59y.png"></p><br>
<p>     ?    ,       -  -    ,        ?</p><br>
<p>      tags.      Patroni   .      .        etcd,         .      . </p><br>
<p>  ,      ,      nofailover  true.    false.</p><br>
<p>     noloadbalance.    read only,  noloadbalance   HAProxy ,     ,       503,  ,       true.</p><br>
<p>   .   clonefrom.    ,       basebackup.   , pg_basebackup       ,     .     -  ,  ,  ,      . ,      ,       ,   .  -        clonefrom,  Patroni basebackup   .      ,         -  . </p><br>
<p>           .   ,   -    -.    .    ,     ,     .          nosync.</p><br>
<p><strong> Patroni     .</strong>       ,   -   . <strong>    ?        -.     - .</strong>         -  ,     ,         . . .           ‚Äì    .  ,      . </p><br>
<p>Replicatefrom   ,        .    ?   Patroni  replication-.      replication-  -  ,    ,     . . .      ,     ,  - ,     ,     ,     .</p><br>
<p>   replication-?    ,    wal-,     ,  Postgres   -    . </p><br>
<p>   ,        Patroni        etcd.</p><br>
<p><img src="https://habrastorage.org/webt/fp/zz/ok/fpzzokpadkejcnljdtjwrblntha.png"></p><br>
<p>     .      postges2.yml .      ,      postgres1. , postgres1  replication-  postgres2    . </p><br>
<p><img src="https://habrastorage.org/webt/qu/8p/uk/qu8pukrnygvjo_rhba-a-xqqoku.png"></p><br>
<p>    switchover  failover?    failover   ? </p><br>
<p>Switchover ‚Äì   . . .          .</p><br>
<p>Failover ‚Äì     ,     . </p><br>
<p><img src="https://habrastorage.org/webt/we/eo/_h/weeo_h6ifljt9icio6vtzfyiacg.png"></p><br>
<p>  failover    .       ,     ?    ,     .      etcd    xlog‚Äô.    .  , -,   .   10 MB,    ,          .    ,  lag  ,  10 MB   ,       .        ,   ,     .         manual failover.    -  ,      , . .    ,     . </p><br>
<p>Switchover           , . .   Patroni.   ,  switchover   ,           .    ,   ,  Patroni   ,   ‚Äì   -      . ..    Postgres, Patroni      ,   ‚Äì      .   ,  switchover   .     ,       . </p><br>
<p><img src="https://habrastorage.org/webt/dt/eu/gd/dteugd2ibeltdzyl_zg79uojusw.png"></p><br>
<p>    switchover.</p><br>
<p>. .      switchover.        .         ,      . </p><br>
<p>    .    ,    .     ,    ,        . </p><br>
<p>   switchover.      ,    : patronictl switchover batman.     batman.     ,   Patronictl  ,   etcd.</p><br>
<p>   postgres1.   ‚Äì enter, . .    .     .     .    ,    .      ,     , . .            Postgres.</p><br>
<p>Switchover    .  ,      switchover,        . </p><br>
<p>   .       . . .   ,     ,    .     ,    , ,      Postgres.    -  4    ‚Äì   switchover,         ,     Patroni.       AWS.    ,      ,        ,     .</p><br>
<p>,  150     ‚Äì     .   Patroni   .</p><br>
<p>   ¬´¬ª,  ,   .  Patronictl   .   ‚Äì     ?      postgresql0       postresql1.  : ¬´?¬ª.  ,  .  ,  .</p><br>
<p><img src="https://habrastorage.org/webt/r6/fk/kc/r6fkkcj_4kk54kuhul1jaybz8ry.png"></p><br>
<p>   <code>patronictl list batman</code>.        . . .    ¬´switchover¬ª,   ¬´Successfully failed over to "postgresql0"¬ª, . .    postgresql0.    ,  postgresql0 ‚Äì  .     . . .   ,      real only.         . </p><br>
<p>   ,      stopped    running.      . </p><br>
<p>        Patroni.     ?   .     lock‚Äô.      .  ,          ,       . </p><br>
<p>   ,    .  promote .       .  , ,  -  ,      ,   switchover  . . .  ,   .     switchover,      switchover,    .    switchover   ,      . </p><br>
<p>       ,    ,        ,       .  ,    ,          .        .  manual failover: demoting myself.</p><br>
<p>    .    Patroni API  Patronictl   .     switchover    High Availability, . . Patroni      ,   demoting,  ,        . . .  .      switchover,        ,    ,     .   4   Patroni  ,  , - ,     ,     .</p><br>
<p>  ,    demoting.   ,   .    ‚Äì     pg_rewind.     pg_rewind      clean shutdown. </p><br>
<p><img src="https://habrastorage.org/webt/t5/2r/sy/t52rsy4nl7f8hdxpk0banbvayfs.png"></p><br>
<p>     ?      .     .    ,     switchover.         .     ,     switchover, Patroni     .   ,    , Patroni  switchover.     Patronictl  ,   switchover,     -    .    .  ,    ,      switchover.</p><br>
<p><img src="https://habrastorage.org/webt/no/yx/do/noyxdoqmisywfbkrxgftdjct0-y.png"></p><br>
<p>       Postgres.    ?       <code>pg_ctl ‚Äìd data directory restart</code>.</p><br>
<p>     .    ‚Äì ,         promote.  ,    ,   ,     Postgres.</p><br>
<p>       Postgres ‚Äì    ,   ,     Postgres.</p><br>
<p>. .      ,    ,    ¬´restart¬ª.  restart‚Äô    .     .  restart‚Äô   ,     ,     . </p><br>
<p>       scheduled restart.   ,    Postgres  ,        ,     ,    ,      .    ,  scheduled failover.  ,  ,    restart  - .    Patroni     restart.     patronictl list,     ,    . </p><br>
<p><img src="https://habrastorage.org/webt/rl/qq/du/rlqqduizq9nszj1jn-aomaokcws.png"></p><br>
<p>   ,  Patroni  .  ,    Patronictl failover, . .  restart  ,    ,   .   ,   restart .   restart ,   ,   restart,   .   ,  restart ,  ,  Patroni,    ,    .    lock    ,     restart.</p><br>
<p>      -  Postgres    <code>pg_ctrl</code>,  Patroni  .        . </p><br>
<p><img src="https://habrastorage.org/webt/qc/kl/hw/qcklhw6p2vofbg3-esmskewdo1a.png"></p><br>
<p>      GitLab     ,   GitLab      ? </p><br>
<p>   ,      .     ,  ,                . </p><br>
<p>  ,      .    . Pg_basebackup       - - .   - .     -  .  , game over. ,  ,   -    ‚Äì     ,    ,    . </p><br>
<p>  Patroni   ¬´reinit¬ª,     ,   . . .   ¬´reinit¬ª,    ,  . Patroni    ,      .  ,  .    .      ,  Postgres,  Postgres ,   ,         ,    .       running. </p><br>
<p> ,    ¬´patronictl reinit cluster¬ª     ? Reinit   . Reinit ,             Postgres   ,      switchover - ,        .          . </p><br>
<p><img src="https://habrastorage.org/webt/zx/hp/ls/zxhplscf0axpwefurjdqkjg70mk.png"></p><br>
<p>   .       ?    Patroni,   postgres-.   failover.   ,     - .</p><br>
<p>      .      ,  Patroni   failover,    -    postgres-, ,  -  .  ,   ‚Äì     ,  Patroni .   ,       . </p><br>
<p>     .      Patronictl  .       . . .  ,      .    ,  ,      etcd   .    loop_wait.</p><br>
<p>      failover.      ,       , . .    -           promote.</p><br>
<p>    ‚Äì      etcd,    etcd       -.     ,   .</p><br>
<p>   ‚Äì     ,    -  etcd.</p><br>
<p>    .     .     etcd.      read-only         ,  ,  etcd  .      ,   ,      . </p><br>
<p>  ,    Patroni,  Patroni  Postgres,    ,    Patroni     promote       multi-.    Patroni    . </p><br>
<p>  ,    Patroni,  postgres-        . </p><br>
<p>    Postgres  Patroni    ,  Patroni    .       .  ,  -   Postgres,   ,   .       Postgres,  -  ,    .     Postgres . Patroni   .</p><br>
<p>,        ,          etcd,  etcd, , . </p><br>
<p> ,          . . .        ,         ,   basebackup  . </p><br>
<p>         failover. . .    ,   ,     ,  Patroni         ,   . . . switchover ,   ,      . </p><br>
<p><img src="https://habrastorage.org/webt/no/fb/cc/nofbccfyu_bvd-1vkybv6ftn9pe.png"></p><br>
<p>    .    ¬´pause¬ª.   b,     ,         .     ,   ,     .       - .   wait   ,    .    ,    ¬´list¬ª  ,    ¬´   ¬ª,   ,    . </p><br>
<p>   Patroni      ,   ,     ,    .</p><br>
<p>       .    ,  Patroni   ,    .</p><br>
<p><img src="https://habrastorage.org/webt/rf/bc/sc/rfbcscv6fvx_n-qkt8cq00etj6c.png">     promote   ,   . . .              .     ,        ¬´pg_ctl posgresql1 promote¬ª.</p><br>
<p>  ? Patroni     .      .       . ,   multi-,      .     split-brain.   split-brain   .  Patroni    .          promote.</p><br>
<p>    ? Patroni  ,      ,  lock‚Äô   . . .      etcd  ,   ,    etcd   ,     .   ,     ,       lock‚Äô.</p><br>
<p><img src="https://habrastorage.org/webt/xz/oa/tu/xzoatuwrx2o8_bhw7vcee42e5au.png"></p><br>
<p>        lock‚Äô,          REST API  ,    ,      503.     lock‚Äô   200.  503?               ,       ,    REST API  .         REST API   ,     503. , ,  , ,    503.   ,  ,     . </p><br>
<p><img src="https://habrastorage.org/webt/2z/d6/ht/2zd6htmnwryrz5f2cbykp35dtti.png"></p><br>
<p> ,    split-brain ,    lock‚Äô,       ?      immediate shutdown, . . Patroni  ,      ,     .  immediate shutdown. Postgres   .    , Patroni   pg_rewind  ,   ,   ,     . </p><br>
<p>      pg_rewind.      standby,  secondary.            . . . Patroni   split-brain,    . </p><br>
<p><img src="https://habrastorage.org/webt/et/8r/yf/et8ryfuv5ovqrrhkicgp35736e8.png"></p><br>
<p>    .      .    Patroni      .  true  false.</p><br>
<p>     .   ? Patroni  ,     ,   .      ¬´synchronous standby name¬ª.   Postgres.       synchronous standby name, . .     .</p><br>
<p>   Patroni    failover    ,  .   ,       ,          ,   ,  Patroni     failover  -  ,  . </p><br>
<p>     ? ,      .  -  ,  ,   - .      Patroni?    Patroni        .    .        .</p><br>
<p> ,     ,   -   nosync,         ,     , Patroni      . </p><br>
<p>      .    .   ,         . . .      ,  ,       ,   . </p><br>
<p>   ,    ,     ,     ,       .    Patroni   .     synchronous_mode_strict, . .    .</p><br>
<p>   ,        .      ,    ,       ,       . </p><br>
<p>        .    ,   Postgres   ,       . <strong>      ‚Äì           .</strong> . .       ,     .      ,          . </p><br>
<p>     ¬´synchronous commit¬ª,       , . . <code>setting synchronous_commit to local</code>, . .     .        ,      .        ,         ,       .      . </p><br>
<p>   ,    ? ,    .      GitHub,     .   ,       . ,  , Quorum   ,   10-. </p><br>
<p><img src="https://habrastorage.org/webt/ib/m6/j0/ibm6j0hc4mpyv_hplheqh2gfqfu.png"></p><br>
<p>  ,   .    . . .    .     ‚Äì   .   <code>synchronous_mode: true</code>.      false  .   ‚Äì   . </p><br>
<p><img src="https://habrastorage.org/webt/ep/um/in/epuminrursburo6e17nh_d-bnr0.png"></p><br>
<p>  ,     .    ,    lock.    .      ,   .    ,   ,   ,      .  Patroni ,   ¬´synchronous_standby_names¬ª.      Postgres,     ,    postgresql1.  Postgres ,  postgresql1    standby.</p><br>
<p>      .      patronictl list.         ,   .     synchronous standby.      ,      . </p><br>
<p><img src="https://habrastorage.org/webt/cl/iq/j-/cliqj-ue61ky2fisxf_cnp76c1w.png"></p><br>
<p>         endpoint,   200  ,      .    .  ,  endpoint   200.   ?           ,    . . .   .      select    .   ,   select   ,   . </p><br>
<p>     endpoint,      -  ,       ,    .        endpoint  ,        ,      . </p><br>
<p>    async endpoint,   200 ,    .      async   . ,  ,     503,     . </p><br>
<p>      .    <code>synchronous_mode: false</code>.      .      ,     .      list,   ,    .     async endpoint,    200.     sync endpoint,    503. . .  ,   . </p><br>
<p>   ,     Patroni.</p><br>
<p>  : ¬´ ,    standby?¬ª. ,      ,   .     :  synchronous_mode,   synchronous_mode_strict. Strict     ,      .    ,     ,       .      , . .  ,   .  ,         ,    , Patroni    . </p><br>
<p><img src="https://habrastorage.org/webt/pq/o-/yf/pqo-yfvenyzozf0jz5dkbcjn96w.png"></p><br>
<p>Patroni      .        ,        ,    -   ,     .     ?</p><br>
<p><img src="https://habrastorage.org/webt/gk/o4/jd/gko4jd-zwhfdwljfdkd6vclp4n0.png"></p><br>
<p> ,     ,   basebackup,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/wal-e/wal-e</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">wal-g</a>).        ,    ,  - ,    wal-e.</p><br>
<p><strong>     ,   .</strong>  , Patroni      - ,  Patroni    ,     -  .      create_replica_method.  . </p><br>
<p>, Patroni          ,   .       wal_e.   wal_e     .      ,    ,      .  ,    yml,         . </p><br>
<p><img src="https://habrastorage.org/webt/k-/fb/h4/k-fbh4myoyrtrkgwt5nsp2yp9ho.png"></p><br>
<p>   ?     . ,     ,  <code>no_master</code>.  ,        ,     . </p><br>
<p>   ?   -  ,      .    .           .     Patroni. Patroni  ,        . </p><br>
<p><img src="https://habrastorage.org/webt/ic/42/9n/ic429n3-gfs2mqvne6_zt-v1ezi.png"></p><br>
<p> ,      .  wal-  basebackup,   pg_dump.</p><br>
<p>   .      ‚Äì   .       .         . . .    wale_restore. , Patroni    .  wale_restrore.     ,   ,      .  - ,      .  connstring,       .    ?       ,     , ,  WAL  .     ,               basebackup. . .,  ,    .</p><br>
<p>    <code>no_master</code>. Envdir ‚Äî  ,       wal_e. , retries.        . </p><br>
<p><img src="https://habrastorage.org/webt/kr/gz/0b/krgz0bmjh6h8iquxaq31kqjaoo4.png"></p><br>
<p>, ,         0,     ,       .     ,  Patroni     .    ,      .        . </p><br>
<p><img src="https://habrastorage.org/webt/p1/sy/pb/p1sypblrftya3jniszsfbhhqc8q.png"></p><br>
<p> ,      , Patroni     initdb.</p><br>
<p><img src="https://habrastorage.org/webt/ac/bh/o6/acbho6u97wtnqt7yj6jal-j5zce.png"></p><br>
<p>   ,       -  .       production      - .       . </p><br>
<p><img src="https://habrastorage.org/webt/hx/rz/oq/hxrzoqcb5lvwa0gsudmadlm4xn4.png"></p><br>
<p>     custom bootstrap.     ,  custom replica,  create method, . .      -    . . .    command.    ‚Äì    s3.</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">point in time recovery</a>. . .  ,      -  .  -   .   ,   . ,    ,    s3 - ,     recovery target timeline.</p><br>
<p> ,        s3, Patroni  recovery.conf   .  , , ,    timeline   promote   ,     recovery target timeline,   promote    , . .     target timeline, . . - . </p><br>
<p><img src="https://habrastorage.org/webt/on/wa/2u/onwa2ugxr5jex-sezbejhbmltx0.png"></p><br>
<p>  ,   , Patroni  Postgres. Postgres   wal‚Äô  -  ,  s3   .   -   promote.   Patroni  post_bootstrap script.    ?       - , -  .   ,    ,   . </p><br>
<p> initdb     . . .     -   initdb. ,  trust ,      localhost.</p><br>
<p>      ,    instance Patroni   . . .   bootstrap      .     ,   .     -   bootstrap  ,  Patroni  initialize       .    ,      . </p><br>
<p><img src="https://habrastorage.org/webt/a6/5-/8_/a65-8_jlonrx9sqqbkmsnxomqsy.png"></p><br>
<p> ,    post_bootstrap . ,   pg_stat_statements extension    temlate1.    ?    -         pg_stat_statements.   .     extension  ,     superuser,        superuser‚Äô.        . </p><br>
<p><img src="https://habrastorage.org/webt/49/ll/pw/49llpwu96-5nbbyfcmlvhki9hdk.png"></p><br>
<p>     Patroni.    . -,   ,     , . .   ,      <code>scope</code>  .    batman.</p><br>
<p><code>Namespace</code> ‚Äì     ,    etcd       .   ‚Äì  ,    .    Patroni,     -.   ,  namespace       . </p><br>
<p>   -   <code>REST API</code>  Patroni    .      Patroni    etcd,     bootstrap,       Postgres, <code>watchdog</code>  <code>tags</code>.</p><br>
<p><img src="https://habrastorage.org/webt/iv/sf/hu/ivsfhu0gcvtuv_lge5icxh5otee.png"></p><br>
<p> restapi  ,     API            .     SSL    authentication.</p><br>
<p><img src="https://habrastorage.org/webt/py/it/be/pyitbebr3tvacgxa1o_u1fg9khc.png"></p><br>
<p>    DCS ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">etcd</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Consul</a>,   .    ,   ,   .  ,  ,  ,  -   .   . </p><br>
<p><img src="https://habrastorage.org/webt/sd/z3/my/sdz3myj1_qciosbfnzdusy25xqw.png"></p><br>
<p> ZooKeeper   ,    ,    .   ZooKeeper      . Exhibitor    , ,  ,      . </p><br>
<p><img src="https://habrastorage.org/webt/st/ew/4s/stew4somxs_5u8xcwwjw6apf-0u.png"></p><br>
<p> Bootstrap        . , ,    Bootstrap     ,    . </p><br>
<p><img src="https://habrastorage.org/webt/us/o4/tx/uso4txlctp_hs_pzprhhne_1zqg.png"></p><br>
<p> bootstrap_method    .</p><br>
<p><img src="https://habrastorage.org/webt/ij/qx/qn/ijqxqntwyfuhr4sryhv63tkozeo.png"></p><br>
<p>   .    listen_address  connect_address. Listen_address ‚Äì   Postgres  .  Connect_address ‚Äì   ,   etcd ,     .    . </p><br>
<p>    ‚Äì  authentication. , Patroni     superuser     .         ,    . </p><br>
<p>     -    Postgres  . </p><br>
<p><img src="https://habrastorage.org/webt/c8/mi/po/c8mipo4_a-6vslifu5oab5gfgly.png"></p><br>
<p> callback  replica_method  .</p><br>
<p><img src="https://habrastorage.org/webt/_n/ys/1c/_nys1cboufw4a80l96bz1qjjtki.png"></p><br>
<p>    ,      .  ,     .     <code>safety_margin</code>.  : ¬´,  5   ,      ,   ¬ª. . .   ,    -.</p><br>
<p>  tags     . </p><br>
<p><img src="https://habrastorage.org/webt/sh/ng/ov/shngov_lztkjdf8m356xdjxevuw.png"></p><br>
<p>        yml-.   environment.      . </p><br>
<p>        environment variables.   Patroni configuration.    ,    environment variables    .  ,   -  config   ,     . </p><br>
<p><img src="https://habrastorage.org/webt/cq/wa/v1/cqwav19yvy4grbrtt9_oclnbe5i.png"></p><br>
<p> troubleshooting ‚Äì       , . </p><br>
<p>     ,       .    ,        .</p><br>
<p><img src="https://habrastorage.org/webt/-y/e7/yy/-ye7yyp-pqolqepejnsmeyphwdy.png"></p><br>
<p>. .     etcd,  etcd     - ,         ,      etcd,     .        ,   ,  etcd   .      . </p><br>
<p><img src="https://habrastorage.org/webt/0f/nd/dx/0fnddxjuzkwdwvztofz7p0uz8xk.png"></p><br>
<p>    .   Debian.       postgres, pg_ctl       path.     Patroni. Patroni       .   <code>subprocess. call</code>, . .    .  ,    <code>pg_ctl</code>. , ,       ,        Postgres.</p><br>
<p>    .        ,  <code>bindir</code>.     ,     .      path ,     Postgres.</p><br>
<p><img src="https://habrastorage.org/webt/1u/im/pn/1uimpnltsa1_palzffh10py-kem.png"></p><br>
<p>      ,  Patroni     .     ,    ,   .     ( 10 )    ,    ,    .      . </p><br>
<p><img src="https://habrastorage.org/webt/et/7q/et/et7qetwp_7rvjqf9wks-dnmwpoe.png"></p><br>
<p>    initdb  Patronictl.yml.       . ,     ¬´data-checksums¬ª,    checksums,     ,   .     initdb ,  <code>--data-checksums</code>.  <code>--data-checksums: true</code>,  <code>- data-checksums</code>. Patroni, ,      .     <code>- data-checksums: true</code>,    ,  ,   data-checksums   .  initdb  ,      Patroni  ,      . </p><br>
<p><img src="https://habrastorage.org/webt/em/n9/wq/emn9wqptv8nj2t0ognfiljy-sfw.png"></p><br>
<p>   . Yaml ‚Äì  ,      . . .      yaml,   yaml.    yaml  , . .   yaml  ,    Python,  .     ,  yaml    ,           . </p><br>
<p>  ,    ?  ,   .       ,     .   .</p><br>
<p>,    - ,    yaml  ,     production.</p><br>
<p><img src="https://habrastorage.org/webt/oz/c_/ko/ozc_koaemcm7hgk9wsb1a8oivtu.png"></p><br>
<p>   .    Debian   Ubuntu  Postgres,       initdb  . , -,   . </p><br>
<p> ,       ,    initdb,      ?    ,  initdb,      .   postgres-      ,        ,     ,     initdb . </p><br>
<p>     Patroni   ,  Patroni   ¬´ ¬ª.    ,    ,       ,    .      .     .     ,     ,         .   ,    ,   reinit      . </p><br>
<p>  .   Debian,      -,    -      . </p><br>
<p><img src="https://habrastorage.org/webt/v2/q7/7t/v2q77tyz_j_wpzlvscfnscabc_a.png"></p><br>
<p>  . </p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Patroni</a>.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">GitHub</a>.  open source .      issue.        issue.    ,    . </p><br>
<p>   Patroni.     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://patroni.readthedocs.io</a>.    .    - ,   .     .  ,   Patroni   .      . ,   Kubernetes,      ,         .</p><br>
<p>  docker-,     Postgres  Patroni   .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Spilo</a>.     GitHub  open source,      Zalando  ,   Postgres.          . </p><br>
<p>:</p><br>
<p>(<em>    ,   </em>)</p><br>
<p>:    patroni  kubernetes?</p><br>
<p>:  Kubernetes   Patroni  Spilo.     postgres-.   open source . </p><br>
<p>:    OpenShift?</p><br>
<p>:  . ,  ,   Red Hat    .    OpenShift,   OpenShift  ,    ,   Red Hat.  ,  . </p><br>
<p>:   ,  standby.     Patroni   standby,   ?</p><br>
<p>: ,  .   ,    Patroni  ,      .        ,   standby.       .      production,    -, ,  laptop‚Äô, . </p><br>
<p>,  ,   .     .   -    ,    standby.    Patroni  ,    .   ,    ZooKeeper   .    Patroni  . , Patroni ,     .         Patroni.     .</p><br>
<p>:    bootstrap   S3,    ?</p><br>
<p>:       wal-e,  - . . .   .     ,    . </p><br>
<p>     ,     S3   Amazon,    ,  ‚Äì ,     .     S3,     Amazon,     . </p><br>
<p>:   Postgres     pg_ctl,    -   ? </p><br>
<p>: Patroni  Postgres    . ,    Patroni  Postgres.       ,  Patroni   Postgres‚Äô, . .  Patroni   . </p><br>
<p>: ¬´    Postgres  Patroni?¬ª.</p><br>
<p>: ,   .  ?</p><br>
<p>:   Patroni  Postgres   ?</p><br>
<p>: ,       Patroni   .  Patroni   Postgres.   ,    . ,  ,  . , ,     postmaster,     Postgres.  ,       Postgres,      Patroni .       .     ‚Äì      Patroni. </p><br>
<p>:     ,    ?</p><br>
<p>:  -    ,  Patroni -    ,    ,    . </p><br>
<p>:       ,      ?</p><br>
<p>: Patroni       ,           ,        .    ,       . . .   ,  ,    . </p><br>
<p>:    Patroni     ? </p><br>
<p>: , . Patroni    - .       .  ,    .     .    Patroni  ,    .      , . .     .  docker-,  spilo,   spilo  Postgres Patroni.  Patroni ‚Äì  ,    . </p><br>
<p>:    Haproxy?</p><br>
<p>:  ‚Äì   .         .         . ,   ,  HAProxy   ,  ,   .      HAProxy,   HAProxy     .    Postgres. O ,   TCP proxy.    postgres-,       Postgres.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504032/index.html">Transport am 27. Mai</a></li>
<li><a href="../de504034/index.html">Elektrischer Becher. Wir bauen einen verr√ºckten Elektroroller / Elektrofahrrad. Reflexionen</a></li>
<li><a href="../de504036/index.html">Unerwartete HTTP-Header</a></li>
<li><a href="../de504038/index.html">Wir hatten 5 Sprachen in einem Team, Legacy-Monolithen, zu viele AWS-Kosten und zu wenig statische Analysetools</a></li>
<li><a href="../de504042/index.html">√úber die Qualit√§t des Leitungswassers geben Sie das Wort (UMFRAGE) ein</a></li>
<li><a href="../de504048/index.html">Heben Sie Ihre Hand oder russisches √úbersetzungsroulette</a></li>
<li><a href="../de504050/index.html">Was ist gut und was ist schlecht. Entwicklerkarriere mit den Augen seines F√ºhrers</a></li>
<li><a href="../de504054/index.html">Wir stellen einen Arcade-Automaten mit einem Geldscheinpr√ºfer und einem M√ºnzpr√ºfer her</a></li>
<li><a href="../de504056/index.html">Informationen zum Ansehen eines Films in englischer Sprache mit Untertiteln, zum Vereinfachen mit zweisprachigen Untertiteln und zum zweisprachigen Untertitel</a></li>
<li><a href="../de504058/index.html">Als h√§tten wir keine Blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>