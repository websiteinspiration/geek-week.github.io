<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🌾 🧚🏼 👨🏼‍🎤 Skalieren von Android-Tests bei Odnoklassniki 🥐 🏺 🧖🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! Mein Name ist Roman Ivanitsky, ich arbeite im Testautomatisierungsteam von Odnoklassniki. OK ist ein riesiger Dienst mit über 70 Millionen Benu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Skalieren von Android-Tests bei Odnoklassniki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hallo! Mein Name ist Roman Ivanitsky, ich arbeite im Testautomatisierungsteam von Odnoklassniki. OK ist ein riesiger Dienst mit über 70 Millionen Benutzern. Wenn wir über mobile Geräte sprechen, verwendet die Mehrheit OK.RU auf Smartphones mit Android. Aus diesem Grund nehmen wir unsere Android-Anwendung sehr ernst. In diesem Artikel werde ich die Geschichte der Entwicklung automatisierter Tests in unserem Unternehmen erzählen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012, Odnoklassniki, verzeichnet das Unternehmen eine aktive Zunahme der Anzahl der Benutzer und eine Zunahme der Anzahl der Benutzerfunktionen. </font><font style="vertical-align: inherit;">Um die Geschäftsziele zu erreichen, musste der Freigabezyklus verkürzt werden. Dies wurde jedoch durch die Tatsache behindert, dass alle Funktionen manuell getestet wurden. </font><font style="vertical-align: inherit;">Die Lösung für dieses Problem kam von selbst - wir brauchen Autotests. </font><font style="vertical-align: inherit;">So erschien 2012 in Odnoklassniki ein Testautomatisierungsteam, und der erste Schritt bestand darin, mit dem Schreiben von Tests zu beginnen.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Geschichte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ersten Autotests in Odnoklassniki wurden in Selenium geschrieben. Für ihren Start wurden Jenkins, Selenium Grid mit Selenium Hub und eine Reihe von Seleniumknoten angehoben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schnelle Lösung, schneller Start, schneller Gewinn - perfekt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Laufe der Zeit nahm die Anzahl der Tests zu, und es wurden Hilfsdienste angezeigt, z. B. Startdienste, Berichtsdienst, Testdatendienst. Bis Ende 2014 hatten wir tausend Tests, die in etwa fünfzehn bis zwanzig Minuten durchgeführt wurden. Dies passte nicht zu uns, da klar war, dass die Anzahl der Tests zunehmen würde und damit die Zeit, die für deren Durchführung benötigt wurde, zunehmen würde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt sah die automatisierte Testinfrastruktur folgendermaßen aus:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit einer Menge an Seleniumknoten größer oder gleich 200 konnte der Hub die Last jedoch nicht bewältigen. </font><font style="vertical-align: inherit;">Jetzt wurde dieses Problem bereits untersucht, und deshalb tauchten Werkzeuge wie Zalenium oder jedermanns Lieblings-Selenoid auf. </font><font style="vertical-align: inherit;">Da es 2014 keine Standardlösung gab, haben wir uns entschlossen, unsere eigene zu machen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definierte die Mindestanforderungen, die der Service erfüllen muss:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skalierbarkeit. </font><font style="vertical-align: inherit;">Wir möchten uns nicht auf die Einschränkungen des Selenium Hub verlassen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stabilität. </font><font style="vertical-align: inherit;">Im Jahr 2014 war der Selenium Hub nicht für seinen stabilen Betrieb bekannt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlertoleranz. </font><font style="vertical-align: inherit;">Wir benötigen die Fähigkeit, den Testprozess im Falle eines Ausfalls des Rechenzentrums oder eines der Server fortzusetzen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So erschien unsere Lösung zur Skalierung des Selenium-Gitters, bestehend aus einem Koordinator und Knoten-Managern, äußerlich dem Standard-Selenium-Gitter sehr ähnlich, jedoch mit eigenen Merkmalen. </font><font style="vertical-align: inherit;">Diese Funktionen werden weiter erläutert.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koordinator</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich handelt es sich um einen Ressourcenbroker (Ressourcen werden als Browser verstanden). Es verfügt über eine externe API, über die Tests Ressourcenanforderungen senden. Diese Abfragen werden als auszuführende Aufgaben in der Datenbank gespeichert. Der Koordinator weiß alles über die Konfiguration unseres Clusters - welche Knotenmanager existieren, welche Arten von Ressourcen diese Knotenmanager bereitstellen können, die Gesamtzahl der Ressourcen, wie viele Ressourcen derzeit an Aufgaben beteiligt sind. Gleichzeitig überwacht er die Ressourcen - Aktivität, Stabilität und benachrichtigt in diesem Fall die Verantwortlichen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Merkmal des Koordinators ist, dass er alle Knotenmanager in sogenannte Farmen integriert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die Farm aus. Mehr als die Hälfte der Ressourcen wird verwendet, und alle Knoten sind online:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können Knoten auch offline anzeigen oder um einen bestimmten Prozentsatz in Rotation versetzen. Dies ist erforderlich, wenn die Belastung eines bestimmten Knotens verringert werden muss. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Farm kann mit anderen in einer logischen Einheit kombiniert werden, die wir als Service bezeichnen. Gleichzeitig kann eine Farm in mehreren verschiedenen Diensten enthalten sein. Erstens ist es möglich, Grenzwerte festzulegen und die von den einzelnen Diensten verwendeten Ressourcen zu priorisieren. Zweitens können Sie die Konfiguration einfach verwalten. Wir haben die Möglichkeit, die Anzahl der Knotenmanager im Dienst im laufenden Betrieb hinzuzufügen oder sie umgekehrt aus der Farm zu entfernen, um mit diesen Knotenmanagern interagieren zu können, z. B. zu konfigurieren oder zu aktualisieren usw. .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die API des Koordinators ist recht einfach: Es ist möglich, den Dienst für die aktuell verwendete Ressourcenmenge anzufordern, sein Limit zu ermitteln und eine Ressource zu starten oder zu stoppen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Knotenmanager</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist ein Dienst, der zwei Dinge gut kann - Aufgaben vom Koordinator erhalten und einige Ressourcen bei Bedarf starten. </font><font style="vertical-align: inherit;">Standardmäßig ist es so konzipiert, dass jeder Start der Ressource isoliert ist, dh, keiner der vorherigen Starts kann den Start nachfolgender Tests beeinflussen. </font><font style="vertical-align: inherit;">Als Antwort verwendet der Koordinator eine Reihe von Hosts und eine Reihe von erhöhten Ports. </font><font style="vertical-align: inherit;">Zum Beispiel der Host, auf dem der Selenium-Server gestartet wurde, und sein Port. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem Host sieht es folgendermaßen aus: Der Node Manager-Dienst wird ausgeführt und verwaltet den gesamten Ressourcenlebenszyklus. </font><font style="vertical-align: inherit;">Er nimmt Browser in die Hand, vervollständigt sie und stellt sicher, dass das Schließen nicht vergessen wird. </font><font style="vertical-align: inherit;">Um die Isolation voneinander zu gewährleisten, geschieht dies alles im Auftrag des Dienstnutzers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaktion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Test interagiert mit der oben beschriebenen Infrastruktur wie folgt: Er adressiert den Koordinator mit einer Anfrage nach den erforderlichen Ressourcen, der Koordinator speichert diese Aufgabe als ausführungsbedürftig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Knotenmanager wendet sich wiederum an den Aufgabenkoordinator. Nachdem er die Aufgabe erhalten hat, startet er die Ressource. Danach sendet er das Ergebnis des Starts an den Koordinator. Fehlgeschlagene Starts werden ebenfalls an den Koordinator gemeldet. Der Test empfängt das Ergebnis der Ressourcenanforderung und beginnt bei Erfolg direkt mit der Ressource zu arbeiten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Vorteile dieses Ansatzes bestehen darin, die Belastung des Koordinators zu verringern, indem die Fähigkeit erlangt wird, direkt mit der Ressource zu arbeiten. Nachteile - die Notwendigkeit, die Logik der Interaktion mit dem Koordinator innerhalb der Testrahmen zu implementieren, aber für uns ist dies akzeptabel.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute können wir in drei Rechenzentren mehr als 800 Browser parallel ausführen. </font><font style="vertical-align: inherit;">Für den Koordinator ist dies nicht die Grenze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Fehlertoleranz wird durch den Start mehrerer Koordinatorinstanzen sichergestellt, die in verschiedenen Rechenzentren hinter der DNS-Firewall aufgelöst werden. </font><font style="vertical-align: inherit;">Dies garantiert den Zugriff auf die Arbeitsinstanz bei Problemen mit dem Rechenzentrum oder dem Server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir eine Lösung erhalten, die alle ursprünglich festgelegten Anforderungen erfüllt. </font><font style="vertical-align: inherit;">Es ist seit 2015 stetig in Betrieb und hat seine Wirksamkeit bewiesen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn es um das Testen auf Android geht, gibt es normalerweise zwei Hauptansätze. Das erste ist die Verwendung von WebDriver - so funktionieren Selendroid und Appium. Die zweite - bei der Arbeit mit nativen Tools - implementierte Robotium, UI Automator oder Espresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die grundlegenden Ähnlichkeiten zwischen diesen Ansätzen bestehen darin, das Gerät und den Browser zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viel mehr Unterschiede, der wichtigste ist die Notwendigkeit, die getestete APK zu installieren, mit der wir Artefakte in Form von Protokollen, Screenshots usw. aufnehmen. und auch die Tatsache, dass die Tests am Gerät selbst und nicht am CI durchgeführt werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Jahr 2015 begann Odnoklassniki, seine Android-Anwendung mit Autotests zu versehen. Wir haben einen Linux-Computer ausgewählt, ein echtes Gerät über USB angeschlossen und Tests auf Robotium geschrieben. Mit dieser einfachen Lösung konnten Sie schnell Ergebnisse erzielen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zeit verging, die Anzahl der Tests und die Anzahl der Geräte nahmen zu. Zur Lösung von Verwaltungsaufgaben wurde der Geräte-Manager erstellt - ein Wrapper-over- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb-Befehl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Android Debug Bridge), mit dem die http-API-Schnittstelle diese ausführen kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sah die erste API für den Geräte-Manager aus - mit ihrer Hilfe konnten Sie eine Liste der Geräte abrufen, APKs installieren / deinstallieren, Tests ausführen und Ergebnisse abrufen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben jedoch festgestellt, dass sich die Testergebnisse beim Start auf dem ADB-Server verschlechtern, an den mehr als ein Gerät angeschlossen ist. Die Lösung, die uns geholfen hat, die Stabilität zu verbessern, bestand darin, jeden ADB-Server mit Docker zu isolieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Farm ist fertig - Sie können Telefone anschließen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viele kennen dieses Bild. Ich habe gehört, wenn Sie in Android-Farmen tätig sind, sind Sie jeden Tag wie in der Hölle.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Android-Emulator kam uns zu Hilfe. Seine Verwendung war auf zwei Faktoren zurückzuführen: Erstens hatte es zu diesem Zeitpunkt bereits das erforderliche Stabilitätsniveau erreicht, und zweitens hatten wir in unseren Tests keine Merkmale, die spezifisch vom Eisen abhängen würden. Darüber hinaus wurde dieser Emulator zu diesem Zeitpunkt gut auf die vorhandene Infrastruktur projiziert. Der nächste Schritt bestand darin, dem Knotenmanager beizubringen, neue Arten von Ressourcen zu starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist erforderlich, um den Android-Emulator auszuführen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst benötigen Sie ein Android SDK mit einer Reihe von Dienstprogrammen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann müssen Sie AVD - Android Virtual Device - erstellen. So wird Ihr Android-Emulator organisiert - welche Architektur wird er haben, wie viele Kerne wird er verwenden, ob Google-Dienste verfügbar sein werden usw.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach müssen Sie den Namen der erstellten AVD auswählen, die Parameter festlegen, z. B. den Port übertragen, an dem ADB gestartet wird, und starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein solches Schema weist jedoch eine Besonderheit auf: Mit dem System können Sie nur einen Instanzemulator auf einer bestimmten AVD ausführen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Lösung für dieses Problem bestand darin, eine grundlegende AVD zu erstellen, die im Speicher gespeichert war. Dadurch war es möglich, sie an eine andere Stelle zu kopieren. </font><font style="vertical-align: inherit;">Während des Starts des Android-Emulators wurde die Basis-AVD in ein temporäres Verzeichnis kopiert, das dem Speicher zugeordnet ist, und anschließend gestartet. </font><font style="vertical-align: inherit;">Ein solches Schema funktionierte schnell, war aber umständlich. </font><font style="vertical-align: inherit;">Bisher wurde dieses Problem durch die schreibgeschützte Option behoben, mit der Sie Android-Emulatoren in unbegrenzten Mengen von einer AVD ausführen können</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basierend auf den Ergebnissen der Zusammenarbeit mit AVD haben wir mehrere interne Empfehlungen entwickelt:</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was die Docker-Images zum Testen auf Android betrifft, möchte ich Agoda und Selenoid hervorheben, sie nutzen die Fähigkeiten von Android-Emulatoren maximal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Unterschied zwischen ihnen ist, dass in der Standardeinstellung Selenoid </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Agoda und den verwendeten "sauberen" Emulator haben. Darüber hinaus hat Selenoid mehr Community-Unterstützung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ende 2018 wurde CloudNode-Manager erstellt, der den Koordinator kontaktiert, Aufgaben empfängt und über Befehle in der Cloud gestartet wird. Anstelle von Eisenmaschinen nutzt dieser Service die Ressourcen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Odnoklassnikis eigene private Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben es geschafft, eine Skalierung zu erreichen, indem wir DeviceManager beigebracht haben, wie man mit dem Koordinator arbeitet. Dazu musste ich die Geräte-Manager-API ändern, um die Möglichkeit hinzuzufügen, einen Gerätetyp (virtuell / real) anzufordern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies passiert, wenn Sie versuchen, ADB Install auf 250 Emulatoren von einem einzelnen Computer aus auszuführen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Mitarbeiter reagierten sofort darauf und starteten einen Vorfall - der Computer lud die Gigabit-Netzwerkschnittstelle mit ausgehendem Datenverkehr. Diese Komplexität wurde durch Erhöhen des Durchsatzes auf dem Server behoben. Ich kann nicht sagen, dass dieses Problem uns viel Ärger bereitet hat, aber Sie sollten es nicht vergessen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass Erfolg der Devicemanager, Koordinator, Skalierung ist. Wir können Tests auf der gesamten Farm durchführen. Im Prinzip können wir sie bei jeder Pull-Anfrage ausführen, und der Entwickler erhält schnell Feedback.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber nicht alles ist so rosig. Möglicherweise haben Sie bemerkt, dass bisher nichts über die Qualität der Tests gesagt wurde. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sahen unsere Starts aus. Und das Interessanteste ist, dass zwischen den Starts völlig unterschiedliche Tests fallen könnten. Dies waren instabile Stürze. Und weder ich noch die Entwickler noch die Tester vertrauten diesen Ergebnissen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sind wir mit diesem Problem umgegangen? Sie haben einfach alles von Robotium bis Espresso kopiert und es wurde gut ... Eigentlich nein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dieses Problem zu lösen, haben wir nicht nur alles auf Espresso neu geschrieben, sondern auch die API für alle Arten von Aktionen wie das Hochladen von Fotos, das Erstellen von Posts, das Hinzufügen zu Freunden usw. verwendet. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uns </font><font style="vertical-align: inherit;">schnell </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">angemeldet</font></a><font style="vertical-align: inherit;"> und </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Diplinks verwendet</font></a><font style="vertical-align: inherit;"> , mit denen Sie direkt zum gewünschten Bildschirm gelangen können und natürlich haben wir alle Testfälle analysiert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt sehen die Testläufe folgendermaßen aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Möglicherweise stellen Sie fest, dass die roten Tests erhalten bleiben. Beachten Sie jedoch, dass es sich um End-to-End-Tests handelt, die in der Produktion ausgeführt werden. Wir haben eine Begrenzung für die Anzahl der Tests, die in den Hauptzweig der Anwendung fallen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir stabile Tests und Skalierungen. Die Testinfrastruktur ist jedoch immer noch stark an die Tests gebunden. Gleichzeitig ist CI aufgrund der Erwartung von End-to-End-Tests beschäftigt, und andere Assemblys können anstehen und auf freie Agenten warten. Darüber hinaus gibt es kein klares Schema für die Arbeit mit parallelen Starts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die oben genannten Gründe wurden zum Anstoß für die Entwicklung von QueueRunner - einem Dienst, mit dem Sie Tests asynchron ausführen können, ohne das CI zu blockieren. </font><font style="vertical-align: inherit;">Um zu arbeiten, benötigt er einen Test und Test APK sowie eine Reihe von Tests. </font><font style="vertical-align: inherit;">Nachdem er die erforderlichen Daten erhalten hat, kann er Laufläufe in der Warteschlange organisieren und die erforderlichen Ressourcen zuweisen und freigeben. </font><font style="vertical-align: inherit;">QueueRunner lädt die Ergebnisse des Laufs zu Jira und Stash herunter und sendet sie auch per Post und im Messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner verfügt über einen Testablauf - es überwacht den Lebenszyklus des Tests. </font><font style="vertical-align: inherit;">Der Standardablauf, den wir jetzt verwenden, besteht aus fünf Schritten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfangsgerät. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt fordert der Geräteverwalter über den Koordinator ein reales oder virtuelles Gerät an.</font></font></li>
<li> .        APK  ,    –  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen bilden fünf einfache Schritte den gesamten Testlebenszyklus in unserem Service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche Vorteile hat uns QueueRunner gebracht? Erstens werden alle möglichen Ressourcen maximal genutzt - es kann auf die gesamte Farm skaliert werden und schnell Ergebnisse erzielen. Zweitens hatten wir mit dem Bonus die Möglichkeit, die Reihenfolge der Tests zu steuern. Zum Beispiel können wir die längsten oder problematischsten Tests zu Beginn ausführen und so die Wartezeit auf ihre Ausführung verkürzen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit QueueRunner können Sie auch intelligente Retrays erstellen. Wir speichern alle Daten in der Datenbank, sodass wir jederzeit den Verlauf des Tests sehen können. Zum Beispiel ist es möglich, das Verhältnis von erfolgreichen und nicht erfolgreichen Testdurchläufen zu betrachten und zu entscheiden, ob es sich im Prinzip lohnt, den Test neu zu starten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner und Devicemanager haben uns die Möglichkeit gegeben, uns an die Menge der Ressourcen anzupassen. Dank der Verwendung von Emulatoren können wir jetzt auf die gesamte Farm skalieren, dh eine nahezu unbegrenzte Anzahl virtueller Geräte gab uns die Möglichkeit, viel mehr Tests durchzuführen. Wenn die Ressourcen jedoch aus irgendeinem Grund nicht verfügbar sind, wartet der Dienst auf ihre Rückkehr und es kommt zu keinem Verlust von Starts. Dementsprechend verwenden wir nur die uns zur Verfügung stehenden Ressourcen. Nach einiger Zeit werden die Ergebnisse immer noch erhalten und gleichzeitig wird das CI nicht blockiert. Und am wichtigsten ist, dass die Testinfrastruktur und die Tests jetzt getrennt sind. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Tests auf Android ausführen zu können, müssen Sie uns nur noch eine Test-APK und eine Liste mit Tests geben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben einen langen Weg von der Selenium-Farm auf virtuellen Maschinen bis zum Start von Android-Tests in der Cloud zurückgelegt. </font><font style="vertical-align: inherit;">Dieser Pfad wurde jedoch noch nicht abgeschlossen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklungsprozess</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, wie die Testinfrastruktur mit dem Entwicklungsprozess zusammenhängt und wie Tester und Entwickler dies sehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Android-Team verwendet den Standard-GitFlow: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Funktion hat einen eigenen Zweig. Die Hauptentwicklung findet in der Entwicklungsbranche statt. Ein Entwickler, der sich entscheidet, ein neues Super-Feature zu erstellen, beginnt seine Entwicklung in einem eigenen Zweig, während andere Entwickler parallel in anderen Zweigen arbeiten können. Wenn ein Entwickler der Meinung ist, dass der ideal schöne, beste Code der Welt fertig ist und so schnell wie möglich für die Benutzer bereitgestellt werden muss, stellt er bei der Entwicklung eine Pull-Anfrage, das Gerät wird automatisch zusammengebaut, Komponententests und Komponententests werden ausgeführt. Gleichzeitig werden die APKs zusammengestellt, an QueueRunner gesendet und End-to-End-Tests ausgeführt. Danach kommen die Ergebnisse der Ausführung der Tests zum Entwickler.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es besteht jedoch eine hohe Wahrscheinlichkeit, dass nach der Erstellung des in Entwicklung befindlichen Feature-Zweigs viele Commits aufgetreten sind. </font><font style="vertical-align: inherit;">Dies bedeutet, dass die Entwicklung möglicherweise nicht mehr so ​​ist, wie sie früher war. </font><font style="vertical-align: inherit;">Daher erfolgt die Vorzusammenführung zuerst - wir führen die Entwicklung zum aktuellen Feature-Zweig zusammen, und in diesem vorzeitigen Zustand erstellen wir Unit-Tests, Komponententests, End-to-End, und basierend auf diesen Ergebnissen erstellen wir einen Bericht. </font><font style="vertical-align: inherit;">Daher verstehen wir, wie funktional die Funktion in der aktuellen Version von Develop ist, und wenn alles in Ordnung ist, wird sie an Benutzer gesendet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berichterstattung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die Stash-Berichterstellung aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Bot schreibt zuerst, dass die Tests gestartet wurden, und wenn sie bestanden werden, aktualisiert er die Nachricht und fügt hinzu, wie viele bestanden haben, wie viele gefallen sind, wie viele bekannte Fehler und wie viele Flaky-Tests. Er schreibt dasselbe in Jira und fügt einen Link zu einem Vergleich der Starts hinzu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht der Vergleich der beiden Starts aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier wird der aktuelle Lauf im Feature-Zweig mit dem letzten Lauf in der Entwicklung verglichen. Es enthält Informationen über die Anzahl der ausgeführten Tests, Übereinstimmungsprobleme, abgebrochene Tests und instabile Flaky-Tests, die sich in einem Zustand befanden und in einen anderen gewechselt wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn mindestens ein Komponententest oder mehr als ein Schwellenwert für End-to-End-Tests abfällt, wird die Zusammenführung blockiert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, ob die Tests stabil fallen, vergleichen wir die Hashes der Spuren der Stürze, bevor sie vorab von den Ziffern befreit werden, bleiben nur die Zeilennummern übrig. </font><font style="vertical-align: inherit;">Wenn die Hashes übereinstimmen, ist dies der gleiche Fall. Wenn sie unterschiedlich sind, sind die Stürze höchstwahrscheinlich unterschiedlich.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir eine stabile, fehlertolerante Lösung implementiert, die sich gut an unsere Infrastruktur anpassen lässt. </font><font style="vertical-align: inherit;">Dann wurde die resultierende Infrastruktur für Android-Tests angepasst. </font><font style="vertical-align: inherit;">Dabei haben uns der Geräte-Manager unterstützt, der uns hilft, sowohl mit realen als auch mit virtuellen Geräten zu arbeiten, sowie QueueRunner, der uns dabei half, die Infrastruktur und die Tests zu trennen und CI für die Dauer der Tests nicht zu blockieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sah aus wie die Testlaufzeit für eine Woche im Jahr 2016 - von fünfzig Minuten oder länger. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht es jetzt aus: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Grafik zeigt die Läufe, die über 2 Stunden eines durchschnittlichen Geschäftstages stattgefunden haben. </font><font style="vertical-align: inherit;">Die Laufzeit wurde auf maximal 15 Minuten reduziert, die Anzahl der Läufe deutlich erhöht.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de497700/index.html">Wöchentliche Online-Mitaps zu Backing und DevOps, Sicherheit und Robotern ab dem 17. April</a></li>
<li><a href="../de497702/index.html">Fünf Trends in der Datenspeicherung, auf die Sie 2020 achten sollten</a></li>
<li><a href="../de497708/index.html">Wir laden Sie zu einer Reihe von Fujitsu-Webinaren im April und Mai ein</a></li>
<li><a href="../de497714/index.html">So schützen Sie Prozesse und Kernel-Erweiterungen unter macOS</a></li>
<li><a href="../de497724/index.html">Vorbereiten eines Servers für die Veröffentlichung einer Web-App in Python</a></li>
<li><a href="../de497728/index.html">Die Gefahren des "Verbrennens" von Chips</a></li>
<li><a href="../de497730/index.html">Praktische BDD: SpecFlow + TFS</a></li>
<li><a href="../de497736/index.html">Überprüfung von 10 neuen Verbrennungsmotoren</a></li>
<li><a href="../de497738/index.html">Testen Sie sich in Swift: ein Puzzle für Puzzle-Liebhaber</a></li>
<li><a href="../de497740/index.html">Autohersteller geben zu, dass es sehr lange dauert, bis unbemannte Fahrzeuge vollständig unbemannt sind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>