<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüåæ üßöüèº üë®üèº‚Äçüé§ Skalieren von Android-Tests bei Odnoklassniki ü•ê üè∫ üßñüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! Mein Name ist Roman Ivanitsky, ich arbeite im Testautomatisierungsteam von Odnoklassniki. OK ist ein riesiger Dienst mit √ºber 70 Millionen Benu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Skalieren von Android-Tests bei Odnoklassniki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hallo! Mein Name ist Roman Ivanitsky, ich arbeite im Testautomatisierungsteam von Odnoklassniki. OK ist ein riesiger Dienst mit √ºber 70 Millionen Benutzern. Wenn wir √ºber mobile Ger√§te sprechen, verwendet die Mehrheit OK.RU auf Smartphones mit Android. Aus diesem Grund nehmen wir unsere Android-Anwendung sehr ernst. In diesem Artikel werde ich die Geschichte der Entwicklung automatisierter Tests in unserem Unternehmen erz√§hlen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012, Odnoklassniki, verzeichnet das Unternehmen eine aktive Zunahme der Anzahl der Benutzer und eine Zunahme der Anzahl der Benutzerfunktionen. </font><font style="vertical-align: inherit;">Um die Gesch√§ftsziele zu erreichen, musste der Freigabezyklus verk√ºrzt werden. Dies wurde jedoch durch die Tatsache behindert, dass alle Funktionen manuell getestet wurden. </font><font style="vertical-align: inherit;">Die L√∂sung f√ºr dieses Problem kam von selbst - wir brauchen Autotests. </font><font style="vertical-align: inherit;">So erschien 2012 in Odnoklassniki ein Testautomatisierungsteam, und der erste Schritt bestand darin, mit dem Schreiben von Tests zu beginnen.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Geschichte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ersten Autotests in Odnoklassniki wurden in Selenium geschrieben. F√ºr ihren Start wurden Jenkins, Selenium Grid mit Selenium Hub und eine Reihe von Seleniumknoten angehoben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schnelle L√∂sung, schneller Start, schneller Gewinn - perfekt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Laufe der Zeit nahm die Anzahl der Tests zu, und es wurden Hilfsdienste angezeigt, z. B. Startdienste, Berichtsdienst, Testdatendienst. Bis Ende 2014 hatten wir tausend Tests, die in etwa f√ºnfzehn bis zwanzig Minuten durchgef√ºhrt wurden. Dies passte nicht zu uns, da klar war, dass die Anzahl der Tests zunehmen w√ºrde und damit die Zeit, die f√ºr deren Durchf√ºhrung ben√∂tigt wurde, zunehmen w√ºrde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt sah die automatisierte Testinfrastruktur folgenderma√üen aus:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit einer Menge an Seleniumknoten gr√∂√üer oder gleich 200 konnte der Hub die Last jedoch nicht bew√§ltigen. </font><font style="vertical-align: inherit;">Jetzt wurde dieses Problem bereits untersucht, und deshalb tauchten Werkzeuge wie Zalenium oder jedermanns Lieblings-Selenoid auf. </font><font style="vertical-align: inherit;">Da es 2014 keine Standardl√∂sung gab, haben wir uns entschlossen, unsere eigene zu machen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definierte die Mindestanforderungen, die der Service erf√ºllen muss:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skalierbarkeit. </font><font style="vertical-align: inherit;">Wir m√∂chten uns nicht auf die Einschr√§nkungen des Selenium Hub verlassen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stabilit√§t. </font><font style="vertical-align: inherit;">Im Jahr 2014 war der Selenium Hub nicht f√ºr seinen stabilen Betrieb bekannt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlertoleranz. </font><font style="vertical-align: inherit;">Wir ben√∂tigen die F√§higkeit, den Testprozess im Falle eines Ausfalls des Rechenzentrums oder eines der Server fortzusetzen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So erschien unsere L√∂sung zur Skalierung des Selenium-Gitters, bestehend aus einem Koordinator und Knoten-Managern, √§u√üerlich dem Standard-Selenium-Gitter sehr √§hnlich, jedoch mit eigenen Merkmalen. </font><font style="vertical-align: inherit;">Diese Funktionen werden weiter erl√§utert.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koordinator</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tats√§chlich handelt es sich um einen Ressourcenbroker (Ressourcen werden als Browser verstanden). Es verf√ºgt √ºber eine externe API, √ºber die Tests Ressourcenanforderungen senden. Diese Abfragen werden als auszuf√ºhrende Aufgaben in der Datenbank gespeichert. Der Koordinator wei√ü alles √ºber die Konfiguration unseres Clusters - welche Knotenmanager existieren, welche Arten von Ressourcen diese Knotenmanager bereitstellen k√∂nnen, die Gesamtzahl der Ressourcen, wie viele Ressourcen derzeit an Aufgaben beteiligt sind. Gleichzeitig √ºberwacht er die Ressourcen - Aktivit√§t, Stabilit√§t und benachrichtigt in diesem Fall die Verantwortlichen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Merkmal des Koordinators ist, dass er alle Knotenmanager in sogenannte Farmen integriert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die Farm aus. Mehr als die H√§lfte der Ressourcen wird verwendet, und alle Knoten sind online:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen Knoten auch offline anzeigen oder um einen bestimmten Prozentsatz in Rotation versetzen. Dies ist erforderlich, wenn die Belastung eines bestimmten Knotens verringert werden muss. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Farm kann mit anderen in einer logischen Einheit kombiniert werden, die wir als Service bezeichnen. Gleichzeitig kann eine Farm in mehreren verschiedenen Diensten enthalten sein. Erstens ist es m√∂glich, Grenzwerte festzulegen und die von den einzelnen Diensten verwendeten Ressourcen zu priorisieren. Zweitens k√∂nnen Sie die Konfiguration einfach verwalten. Wir haben die M√∂glichkeit, die Anzahl der Knotenmanager im Dienst im laufenden Betrieb hinzuzuf√ºgen oder sie umgekehrt aus der Farm zu entfernen, um mit diesen Knotenmanagern interagieren zu k√∂nnen, z. B. zu konfigurieren oder zu aktualisieren usw. .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die API des Koordinators ist recht einfach: Es ist m√∂glich, den Dienst f√ºr die aktuell verwendete Ressourcenmenge anzufordern, sein Limit zu ermitteln und eine Ressource zu starten oder zu stoppen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Knotenmanager</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist ein Dienst, der zwei Dinge gut kann - Aufgaben vom Koordinator erhalten und einige Ressourcen bei Bedarf starten. </font><font style="vertical-align: inherit;">Standardm√§√üig ist es so konzipiert, dass jeder Start der Ressource isoliert ist, dh, keiner der vorherigen Starts kann den Start nachfolgender Tests beeinflussen. </font><font style="vertical-align: inherit;">Als Antwort verwendet der Koordinator eine Reihe von Hosts und eine Reihe von erh√∂hten Ports. </font><font style="vertical-align: inherit;">Zum Beispiel der Host, auf dem der Selenium-Server gestartet wurde, und sein Port. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem Host sieht es folgenderma√üen aus: Der Node Manager-Dienst wird ausgef√ºhrt und verwaltet den gesamten Ressourcenlebenszyklus. </font><font style="vertical-align: inherit;">Er nimmt Browser in die Hand, vervollst√§ndigt sie und stellt sicher, dass das Schlie√üen nicht vergessen wird. </font><font style="vertical-align: inherit;">Um die Isolation voneinander zu gew√§hrleisten, geschieht dies alles im Auftrag des Dienstnutzers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaktion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Test interagiert mit der oben beschriebenen Infrastruktur wie folgt: Er adressiert den Koordinator mit einer Anfrage nach den erforderlichen Ressourcen, der Koordinator speichert diese Aufgabe als ausf√ºhrungsbed√ºrftig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Knotenmanager wendet sich wiederum an den Aufgabenkoordinator. Nachdem er die Aufgabe erhalten hat, startet er die Ressource. Danach sendet er das Ergebnis des Starts an den Koordinator. Fehlgeschlagene Starts werden ebenfalls an den Koordinator gemeldet. Der Test empf√§ngt das Ergebnis der Ressourcenanforderung und beginnt bei Erfolg direkt mit der Ressource zu arbeiten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Vorteile dieses Ansatzes bestehen darin, die Belastung des Koordinators zu verringern, indem die F√§higkeit erlangt wird, direkt mit der Ressource zu arbeiten. Nachteile - die Notwendigkeit, die Logik der Interaktion mit dem Koordinator innerhalb der Testrahmen zu implementieren, aber f√ºr uns ist dies akzeptabel.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute k√∂nnen wir in drei Rechenzentren mehr als 800 Browser parallel ausf√ºhren. </font><font style="vertical-align: inherit;">F√ºr den Koordinator ist dies nicht die Grenze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Fehlertoleranz wird durch den Start mehrerer Koordinatorinstanzen sichergestellt, die in verschiedenen Rechenzentren hinter der DNS-Firewall aufgel√∂st werden. </font><font style="vertical-align: inherit;">Dies garantiert den Zugriff auf die Arbeitsinstanz bei Problemen mit dem Rechenzentrum oder dem Server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir eine L√∂sung erhalten, die alle urspr√ºnglich festgelegten Anforderungen erf√ºllt. </font><font style="vertical-align: inherit;">Es ist seit 2015 stetig in Betrieb und hat seine Wirksamkeit bewiesen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn es um das Testen auf Android geht, gibt es normalerweise zwei Hauptans√§tze. Das erste ist die Verwendung von WebDriver - so funktionieren Selendroid und Appium. Die zweite - bei der Arbeit mit nativen Tools - implementierte Robotium, UI Automator oder Espresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die grundlegenden √Ñhnlichkeiten zwischen diesen Ans√§tzen bestehen darin, das Ger√§t und den Browser zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viel mehr Unterschiede, der wichtigste ist die Notwendigkeit, die getestete APK zu installieren, mit der wir Artefakte in Form von Protokollen, Screenshots usw. aufnehmen. und auch die Tatsache, dass die Tests am Ger√§t selbst und nicht am CI durchgef√ºhrt werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Jahr 2015 begann Odnoklassniki, seine Android-Anwendung mit Autotests zu versehen. Wir haben einen Linux-Computer ausgew√§hlt, ein echtes Ger√§t √ºber USB angeschlossen und Tests auf Robotium geschrieben. Mit dieser einfachen L√∂sung konnten Sie schnell Ergebnisse erzielen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zeit verging, die Anzahl der Tests und die Anzahl der Ger√§te nahmen zu. Zur L√∂sung von Verwaltungsaufgaben wurde der Ger√§te-Manager erstellt - ein Wrapper-over- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb-Befehl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Android Debug Bridge), mit dem die http-API-Schnittstelle diese ausf√ºhren kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sah die erste API f√ºr den Ger√§te-Manager aus - mit ihrer Hilfe konnten Sie eine Liste der Ger√§te abrufen, APKs installieren / deinstallieren, Tests ausf√ºhren und Ergebnisse abrufen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben jedoch festgestellt, dass sich die Testergebnisse beim Start auf dem ADB-Server verschlechtern, an den mehr als ein Ger√§t angeschlossen ist. Die L√∂sung, die uns geholfen hat, die Stabilit√§t zu verbessern, bestand darin, jeden ADB-Server mit Docker zu isolieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Farm ist fertig - Sie k√∂nnen Telefone anschlie√üen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viele kennen dieses Bild. Ich habe geh√∂rt, wenn Sie in Android-Farmen t√§tig sind, sind Sie jeden Tag wie in der H√∂lle.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Android-Emulator kam uns zu Hilfe. Seine Verwendung war auf zwei Faktoren zur√ºckzuf√ºhren: Erstens hatte es zu diesem Zeitpunkt bereits das erforderliche Stabilit√§tsniveau erreicht, und zweitens hatten wir in unseren Tests keine Merkmale, die spezifisch vom Eisen abh√§ngen w√ºrden. Dar√ºber hinaus wurde dieser Emulator zu diesem Zeitpunkt gut auf die vorhandene Infrastruktur projiziert. Der n√§chste Schritt bestand darin, dem Knotenmanager beizubringen, neue Arten von Ressourcen zu starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist erforderlich, um den Android-Emulator auszuf√ºhren? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst ben√∂tigen Sie ein Android SDK mit einer Reihe von Dienstprogrammen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann m√ºssen Sie AVD - Android Virtual Device - erstellen. So wird Ihr Android-Emulator organisiert - welche Architektur wird er haben, wie viele Kerne wird er verwenden, ob Google-Dienste verf√ºgbar sein werden usw.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach m√ºssen Sie den Namen der erstellten AVD ausw√§hlen, die Parameter festlegen, z. B. den Port √ºbertragen, an dem ADB gestartet wird, und starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein solches Schema weist jedoch eine Besonderheit auf: Mit dem System k√∂nnen Sie nur einen Instanzemulator auf einer bestimmten AVD ausf√ºhren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die L√∂sung f√ºr dieses Problem bestand darin, eine grundlegende AVD zu erstellen, die im Speicher gespeichert war. Dadurch war es m√∂glich, sie an eine andere Stelle zu kopieren. </font><font style="vertical-align: inherit;">W√§hrend des Starts des Android-Emulators wurde die Basis-AVD in ein tempor√§res Verzeichnis kopiert, das dem Speicher zugeordnet ist, und anschlie√üend gestartet. </font><font style="vertical-align: inherit;">Ein solches Schema funktionierte schnell, war aber umst√§ndlich. </font><font style="vertical-align: inherit;">Bisher wurde dieses Problem durch die schreibgesch√ºtzte Option behoben, mit der Sie Android-Emulatoren in unbegrenzten Mengen von einer AVD ausf√ºhren k√∂nnen</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basierend auf den Ergebnissen der Zusammenarbeit mit AVD haben wir mehrere interne Empfehlungen entwickelt:</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was die Docker-Images zum Testen auf Android betrifft, m√∂chte ich Agoda und Selenoid hervorheben, sie nutzen die F√§higkeiten von Android-Emulatoren maximal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Unterschied zwischen ihnen ist, dass in der Standardeinstellung Selenoid </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Agoda und den verwendeten "sauberen" Emulator haben. Dar√ºber hinaus hat Selenoid mehr Community-Unterst√ºtzung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ende 2018 wurde CloudNode-Manager erstellt, der den Koordinator kontaktiert, Aufgaben empf√§ngt und √ºber Befehle in der Cloud gestartet wird. Anstelle von Eisenmaschinen nutzt dieser Service die Ressourcen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Odnoklassnikis eigene private Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben es geschafft, eine Skalierung zu erreichen, indem wir DeviceManager beigebracht haben, wie man mit dem Koordinator arbeitet. Dazu musste ich die Ger√§te-Manager-API √§ndern, um die M√∂glichkeit hinzuzuf√ºgen, einen Ger√§tetyp (virtuell / real) anzufordern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies passiert, wenn Sie versuchen, ADB Install auf 250 Emulatoren von einem einzelnen Computer aus auszuf√ºhren. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Mitarbeiter reagierten sofort darauf und starteten einen Vorfall - der Computer lud die Gigabit-Netzwerkschnittstelle mit ausgehendem Datenverkehr. Diese Komplexit√§t wurde durch Erh√∂hen des Durchsatzes auf dem Server behoben. Ich kann nicht sagen, dass dieses Problem uns viel √Ñrger bereitet hat, aber Sie sollten es nicht vergessen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass Erfolg der Devicemanager, Koordinator, Skalierung ist. Wir k√∂nnen Tests auf der gesamten Farm durchf√ºhren. Im Prinzip k√∂nnen wir sie bei jeder Pull-Anfrage ausf√ºhren, und der Entwickler erh√§lt schnell Feedback.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber nicht alles ist so rosig. M√∂glicherweise haben Sie bemerkt, dass bisher nichts √ºber die Qualit√§t der Tests gesagt wurde. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sahen unsere Starts aus. Und das Interessanteste ist, dass zwischen den Starts v√∂llig unterschiedliche Tests fallen k√∂nnten. Dies waren instabile St√ºrze. Und weder ich noch die Entwickler noch die Tester vertrauten diesen Ergebnissen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sind wir mit diesem Problem umgegangen? Sie haben einfach alles von Robotium bis Espresso kopiert und es wurde gut ... Eigentlich nein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dieses Problem zu l√∂sen, haben wir nicht nur alles auf Espresso neu geschrieben, sondern auch die API f√ºr alle Arten von Aktionen wie das Hochladen von Fotos, das Erstellen von Posts, das Hinzuf√ºgen zu Freunden usw. verwendet. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uns </font><font style="vertical-align: inherit;">schnell </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">angemeldet</font></a><font style="vertical-align: inherit;"> und </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Diplinks verwendet</font></a><font style="vertical-align: inherit;"> , mit denen Sie direkt zum gew√ºnschten Bildschirm gelangen k√∂nnen und nat√ºrlich haben wir alle Testf√§lle analysiert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt sehen die Testl√§ufe folgenderma√üen aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√∂glicherweise stellen Sie fest, dass die roten Tests erhalten bleiben. Beachten Sie jedoch, dass es sich um End-to-End-Tests handelt, die in der Produktion ausgef√ºhrt werden. Wir haben eine Begrenzung f√ºr die Anzahl der Tests, die in den Hauptzweig der Anwendung fallen k√∂nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir stabile Tests und Skalierungen. Die Testinfrastruktur ist jedoch immer noch stark an die Tests gebunden. Gleichzeitig ist CI aufgrund der Erwartung von End-to-End-Tests besch√§ftigt, und andere Assemblys k√∂nnen anstehen und auf freie Agenten warten. Dar√ºber hinaus gibt es kein klares Schema f√ºr die Arbeit mit parallelen Starts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die oben genannten Gr√ºnde wurden zum Ansto√ü f√ºr die Entwicklung von QueueRunner - einem Dienst, mit dem Sie Tests asynchron ausf√ºhren k√∂nnen, ohne das CI zu blockieren. </font><font style="vertical-align: inherit;">Um zu arbeiten, ben√∂tigt er einen Test und Test APK sowie eine Reihe von Tests. </font><font style="vertical-align: inherit;">Nachdem er die erforderlichen Daten erhalten hat, kann er Laufl√§ufe in der Warteschlange organisieren und die erforderlichen Ressourcen zuweisen und freigeben. </font><font style="vertical-align: inherit;">QueueRunner l√§dt die Ergebnisse des Laufs zu Jira und Stash herunter und sendet sie auch per Post und im Messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner verf√ºgt √ºber einen Testablauf - es √ºberwacht den Lebenszyklus des Tests. </font><font style="vertical-align: inherit;">Der Standardablauf, den wir jetzt verwenden, besteht aus f√ºnf Schritten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfangsger√§t. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt fordert der Ger√§teverwalter √ºber den Koordinator ein reales oder virtuelles Ger√§t an.</font></font></li>
<li> .        APK  ,    ‚Äì  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen bilden f√ºnf einfache Schritte den gesamten Testlebenszyklus in unserem Service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche Vorteile hat uns QueueRunner gebracht? Erstens werden alle m√∂glichen Ressourcen maximal genutzt - es kann auf die gesamte Farm skaliert werden und schnell Ergebnisse erzielen. Zweitens hatten wir mit dem Bonus die M√∂glichkeit, die Reihenfolge der Tests zu steuern. Zum Beispiel k√∂nnen wir die l√§ngsten oder problematischsten Tests zu Beginn ausf√ºhren und so die Wartezeit auf ihre Ausf√ºhrung verk√ºrzen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit QueueRunner k√∂nnen Sie auch intelligente Retrays erstellen. Wir speichern alle Daten in der Datenbank, sodass wir jederzeit den Verlauf des Tests sehen k√∂nnen. Zum Beispiel ist es m√∂glich, das Verh√§ltnis von erfolgreichen und nicht erfolgreichen Testdurchl√§ufen zu betrachten und zu entscheiden, ob es sich im Prinzip lohnt, den Test neu zu starten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner und Devicemanager haben uns die M√∂glichkeit gegeben, uns an die Menge der Ressourcen anzupassen. Dank der Verwendung von Emulatoren k√∂nnen wir jetzt auf die gesamte Farm skalieren, dh eine nahezu unbegrenzte Anzahl virtueller Ger√§te gab uns die M√∂glichkeit, viel mehr Tests durchzuf√ºhren. Wenn die Ressourcen jedoch aus irgendeinem Grund nicht verf√ºgbar sind, wartet der Dienst auf ihre R√ºckkehr und es kommt zu keinem Verlust von Starts. Dementsprechend verwenden wir nur die uns zur Verf√ºgung stehenden Ressourcen. Nach einiger Zeit werden die Ergebnisse immer noch erhalten und gleichzeitig wird das CI nicht blockiert. Und am wichtigsten ist, dass die Testinfrastruktur und die Tests jetzt getrennt sind. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Tests auf Android ausf√ºhren zu k√∂nnen, m√ºssen Sie uns nur noch eine Test-APK und eine Liste mit Tests geben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben einen langen Weg von der Selenium-Farm auf virtuellen Maschinen bis zum Start von Android-Tests in der Cloud zur√ºckgelegt. </font><font style="vertical-align: inherit;">Dieser Pfad wurde jedoch noch nicht abgeschlossen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklungsprozess</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, wie die Testinfrastruktur mit dem Entwicklungsprozess zusammenh√§ngt und wie Tester und Entwickler dies sehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Android-Team verwendet den Standard-GitFlow: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Funktion hat einen eigenen Zweig. Die Hauptentwicklung findet in der Entwicklungsbranche statt. Ein Entwickler, der sich entscheidet, ein neues Super-Feature zu erstellen, beginnt seine Entwicklung in einem eigenen Zweig, w√§hrend andere Entwickler parallel in anderen Zweigen arbeiten k√∂nnen. Wenn ein Entwickler der Meinung ist, dass der ideal sch√∂ne, beste Code der Welt fertig ist und so schnell wie m√∂glich f√ºr die Benutzer bereitgestellt werden muss, stellt er bei der Entwicklung eine Pull-Anfrage, das Ger√§t wird automatisch zusammengebaut, Komponententests und Komponententests werden ausgef√ºhrt. Gleichzeitig werden die APKs zusammengestellt, an QueueRunner gesendet und End-to-End-Tests ausgef√ºhrt. Danach kommen die Ergebnisse der Ausf√ºhrung der Tests zum Entwickler.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es besteht jedoch eine hohe Wahrscheinlichkeit, dass nach der Erstellung des in Entwicklung befindlichen Feature-Zweigs viele Commits aufgetreten sind. </font><font style="vertical-align: inherit;">Dies bedeutet, dass die Entwicklung m√∂glicherweise nicht mehr so ‚Äã‚Äãist, wie sie fr√ºher war. </font><font style="vertical-align: inherit;">Daher erfolgt die Vorzusammenf√ºhrung zuerst - wir f√ºhren die Entwicklung zum aktuellen Feature-Zweig zusammen, und in diesem vorzeitigen Zustand erstellen wir Unit-Tests, Komponententests, End-to-End, und basierend auf diesen Ergebnissen erstellen wir einen Bericht. </font><font style="vertical-align: inherit;">Daher verstehen wir, wie funktional die Funktion in der aktuellen Version von Develop ist, und wenn alles in Ordnung ist, wird sie an Benutzer gesendet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berichterstattung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht die Stash-Berichterstellung aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Bot schreibt zuerst, dass die Tests gestartet wurden, und wenn sie bestanden werden, aktualisiert er die Nachricht und f√ºgt hinzu, wie viele bestanden haben, wie viele gefallen sind, wie viele bekannte Fehler und wie viele Flaky-Tests. Er schreibt dasselbe in Jira und f√ºgt einen Link zu einem Vergleich der Starts hinzu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht der Vergleich der beiden Starts aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier wird der aktuelle Lauf im Feature-Zweig mit dem letzten Lauf in der Entwicklung verglichen. Es enth√§lt Informationen √ºber die Anzahl der ausgef√ºhrten Tests, √úbereinstimmungsprobleme, abgebrochene Tests und instabile Flaky-Tests, die sich in einem Zustand befanden und in einen anderen gewechselt wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn mindestens ein Komponententest oder mehr als ein Schwellenwert f√ºr End-to-End-Tests abf√§llt, wird die Zusammenf√ºhrung blockiert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, ob die Tests stabil fallen, vergleichen wir die Hashes der Spuren der St√ºrze, bevor sie vorab von den Ziffern befreit werden, bleiben nur die Zeilennummern √ºbrig. </font><font style="vertical-align: inherit;">Wenn die Hashes √ºbereinstimmen, ist dies der gleiche Fall. Wenn sie unterschiedlich sind, sind die St√ºrze h√∂chstwahrscheinlich unterschiedlich.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir eine stabile, fehlertolerante L√∂sung implementiert, die sich gut an unsere Infrastruktur anpassen l√§sst. </font><font style="vertical-align: inherit;">Dann wurde die resultierende Infrastruktur f√ºr Android-Tests angepasst. </font><font style="vertical-align: inherit;">Dabei haben uns der Ger√§te-Manager unterst√ºtzt, der uns hilft, sowohl mit realen als auch mit virtuellen Ger√§ten zu arbeiten, sowie QueueRunner, der uns dabei half, die Infrastruktur und die Tests zu trennen und CI f√ºr die Dauer der Tests nicht zu blockieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sah aus wie die Testlaufzeit f√ºr eine Woche im Jahr 2016 - von f√ºnfzig Minuten oder l√§nger. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht es jetzt aus: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Grafik zeigt die L√§ufe, die √ºber 2 Stunden eines durchschnittlichen Gesch√§ftstages stattgefunden haben. </font><font style="vertical-align: inherit;">Die Laufzeit wurde auf maximal 15 Minuten reduziert, die Anzahl der L√§ufe deutlich erh√∂ht.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de497700/index.html">W√∂chentliche Online-Mitaps zu Backing und DevOps, Sicherheit und Robotern ab dem 17. April</a></li>
<li><a href="../de497702/index.html">F√ºnf Trends in der Datenspeicherung, auf die Sie 2020 achten sollten</a></li>
<li><a href="../de497708/index.html">Wir laden Sie zu einer Reihe von Fujitsu-Webinaren im April und Mai ein</a></li>
<li><a href="../de497714/index.html">So sch√ºtzen Sie Prozesse und Kernel-Erweiterungen unter macOS</a></li>
<li><a href="../de497724/index.html">Vorbereiten eines Servers f√ºr die Ver√∂ffentlichung einer Web-App in Python</a></li>
<li><a href="../de497728/index.html">Die Gefahren des "Verbrennens" von Chips</a></li>
<li><a href="../de497730/index.html">Praktische BDD: SpecFlow + TFS</a></li>
<li><a href="../de497736/index.html">√úberpr√ºfung von 10 neuen Verbrennungsmotoren</a></li>
<li><a href="../de497738/index.html">Testen Sie sich in Swift: ein Puzzle f√ºr Puzzle-Liebhaber</a></li>
<li><a href="../de497740/index.html">Autohersteller geben zu, dass es sehr lange dauert, bis unbemannte Fahrzeuge vollst√§ndig unbemannt sind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>