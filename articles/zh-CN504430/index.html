<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👶🏾 🚴🏾 🚆 日常生活Tinkoff安全运营中心：单个Bootloader分析 👨‍❤️‍💋‍👨 🙋🏽 👨🏼‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！
 
 在我们的Tinkoff安全运营中心，我们定期分析恶意软件和攻击中使用的技术，最近我们遇到了一个有趣的文件，我们想谈一谈。
 
 
  
 用于创建该杰作的技术已经有20多年的历史了，但是即使在几十年后，它仍然具有现实意义，因为宏中某些检查的调用并不可疑，可以在合法文档中使用。这是用E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>日常生活Tinkoff安全运营中心：单个Bootloader分析</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">哈Ha！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的Tinkoff安全运营中心，我们定期分析恶意软件和攻击中使用的技术，最近我们遇到了一个有趣的文件，我们想谈一谈。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="图片"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用于创建该杰作的技术已经有20多年的历史了，但是即使在几十年后，它仍然具有现实意义，因为宏中某些检查的调用并不可疑，可以在合法文档中使用。</font><font style="vertical-align: inherit;">这是用Excel 4.0宏编写的恶意软件下载程序。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工具类</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为分析的一部分，我们将最少使用第三方工具，并使用一组标准程序：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Office套件</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存档器；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文本编辑器;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为分析软件行为的工具，我们将使用Sysmon；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为分析环境，我们将使用带有Windows 7的VM</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">诺加布卡夫</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将要分析的文档是xls格式的Excel工作簿。</font><font style="vertical-align: inherit;">该恶意软件通过网络钓鱼电子邮件传递，当文档开始运行时，宏卸载注册表分支，从Microsoft网站下载有关Office更新的信息，还下载并启动恶意.dll。</font><font style="vertical-align: inherit;">这些步骤之后，该书不保存更改就关闭。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与这种类型的其他加载器的主要区别在于，它不使用VBA宏。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静态分析</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是包含恶意文档的电子邮件的示例。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的虚拟机中打开附件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您应该立即注意：图片警告该文档是“受保护的”，值得在本地打开该文档并单击“启用内容”：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
安全警告提示您需要在Visual Basic编辑器中查看项目。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们转向开发人员-宏管理（vbs），但看不到任何vbs或vba宏：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在是时候记住什么Office文档了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个Microsoft Office文档都是一个存档，可以使用任何存档器解压缩该存档，以提取文档的内容：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解压缩后，我们发现文档中没有用来查看的xml文件，而是旧的文档格式-xls。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在xls扩展名中，内容不是以Office Open XML格式存储，而是以BIFF8二进制格式存储。该文档使用Excel 4.0宏，可以在文档单元格中执行宏。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值得注意的是，带有宏的工作表不是隐藏的，但是工作表中有大量的空单元格，这使分析变得困难。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有一些用于分析BIFF8文件的工具，例如BiffViewer，而用于分析内容的工具是oletools。但是，我们将尝试不使用第三方实用程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excel中也有一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基础格式</font><font style="vertical-align: inherit;">- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XLSM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您可以在其中保存VBA宏代码和Excel 4.0宏表。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可用于Excel的格式的完整列表是</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excel格式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们保存我们的文档，将其解压缩：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看一下文件中的内容，从xl文件夹中的macrosheets目录开始，然后在宏表中找到包含所有数据的文件：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样，我们就在宏表中的单元格中获得了所有值。</font><font style="vertical-align: inherit;">宏本身被混淆，单元格仅包含数值和公式，这些公式将这些值转换并将结果写入新的单元格中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，在此公式中，将数值转换为字符，并串起来并将其写入单元格FK17653。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel中的公式</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为式的结果，我们得到以下线：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个后续的宏命令由类似的公式“收集”，写入到单元，然后被执行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使宏在打开文档时自动运行，必须从中启动脚本的单元格称为Auto_Open。</font><font style="vertical-align: inherit;">考虑workbook.xml文件：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=«1.0» encoding=«UTF-8» standalone=«yes»?&gt;<br>
&lt;workbook xmlns=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>» xmlns:r=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>» xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>» mc:Ignorable=«x15» xmlns:x15=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>»&gt; appName=«xl» lastEdited=«6» lowestEdited=«6» rupBuild=«14420»/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>»&gt; Requires=«x15»&gt;&lt;x15ac:absPath url=«C:\Users\User\Desktop\malware\» xmlns:x15ac=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>»/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=«Sheet1» sheetId=«1» r:id=«rId1»/&gt;&lt;sheet name=«Sheet2» sheetId=«2» r:id=«rId2»/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在文件内，我们找到行名=“ _ xlnm.Auto_OpenT8nee” hidden =“ 1”&gt; Sheet2！$ IE $ 65406 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这意味着运行宏的单元格IE65406被隐藏了。</font><font style="vertical-align: inherit;">现在我们知道了宏的入口点。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">动态分析</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
切勿在计算机上运行可疑文件。</font><font style="vertical-align: inherit;">要研究可疑软件的行为，有必要使用专门准备的环境：各种沙箱或专门准备的隔离机器-虚拟机或熨斗。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
打开文档并运行内容。</font><font style="vertical-align: inherit;">命令提示符窗口闪烁，并且书关闭。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看Sysmon日志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon有一个进程创建事件（标识1），有关Sysmon的更多信息可以在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过日志，我们看到该宏在目录c中创建文件：\ users \ public </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是sysmon消息，该消息显示已卸载注册表分支并将结果写入文件：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sysmon事件事件ID 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: «C:\Windows\system32\reg.exe» EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: «C:\Program Files\Microsoft Office\Office16\EXCEL.EXE»</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成后，宏将删除创建的文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要禁止删除文件，请更改文件夹的权限，保留读写权限并禁止删除：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再次运行文档，在执行宏过程中将收到错误消息，这使我们可以对其进行调试。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是可能的，因为在某些调用中没有异常处理。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们逐步运行宏；在调试过程中，我们遇到来自dll库的函数调用，例如</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。宏完成后，以下文件将位于共享用户文件夹中：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我们知道从其开始执行的单元格，因此我们可以填写宏表中的所有单元格。</font><font style="vertical-align: inherit;">让我们将宏移至关闭（false）函数，在该函数中，我们将通过单击“暂停”按钮来中断执行。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环境检查单元</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过宏填充的单元格，我们遇到了几个函数get.window（）和get.workspace（）</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.window（）函数返回有关当前窗口的信息：状态，窗口状态，其名称，显示选项等。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用get.workspace（）函数可以找到有关文档在其中运行的环境的信息。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在链接中可以找到Excel 4.0可用的呼叫的完整列表。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，我们需要更详细地介绍：我和我的同事建议，这些调用中的大多数与绕过沙箱的尝试有关：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow（7）-检查当前窗口是否被隐藏。</font><font style="vertical-align: inherit;">返回true或false。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows（20）-如果窗口最大化，则返回true。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows（23）-可以返回值1、2和3。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/d54/afe/028/d54afe0281d24b5e34040af0122cd3d7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1-恢复</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2-最小化</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3-最大化</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此检查当前窗口是否打开：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（31）-检查是否已调试宏步进。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（13）-检查工作区的宽度（以像素为单位）：如果小于770，则书籍将关闭</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（14）-检查工作区的高度（以像素为单位）：如果小于390，则书籍将关闭</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（19）-检查鼠标的存在。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（1）-返回文档在哪个操作系统中运行。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在错误的情况下，在每张支票中都有一个过渡到结账单元而不保存结果。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部图书馆电话</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
检查环境后，我们继续进行主要功能。让我们看看如何从宏调用WinAPI函数：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.在Sysmon日志中看到的reg.exe调用。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了调用该实用程序，使用了shell32.dll库中的ShellExecute函数，该函数的参数分散在其他单元格中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
单元格BN16631：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
单元格A46097：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在单元格GN47559中，发送了导出必需的注册表分支的命令，Get.workspace（2）返回Excel的版本。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
单元格DX48821包含写入结果的路径。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进一步在宏中，检查是否存在创建的IcltdXw.reg文件及其删除。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.调用URLDownloadToFile函数。此功能将获取请求的结果保存到文件中。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用如下：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过此电话，我们可以访问Microsoft网站，以及有关Office更新信息的页面。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
功能参数：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell BR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell IN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行指令后，将检查是否已创建文件，并通过文件中的偏移量读取字符：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
很可能，这些操作旨在检查文档运行所在的环境是否可以访问Internet。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在公式中，FILES函数传递给iserror，参数是应将URLDownloadToFile函数的结果写入其中的文件的名称：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
单元FM27223将控制书关闭功能：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功从Microsoft接收文件后，单元将被填充以准备第二次调用urlmon dll。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有效负载加载</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是第二个调用，但是是dehabadi [。] Ir域，应该从中加载恶意负载：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果被写入具有html扩展名的同一文件夹中的文件：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，如果是第一次尝试下载有效负载，则我们遇到了宏代码中的一个分支，失败，将尝试第二次尝试，但是尝试使用其他地址。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果下载成功，将弹出警告弹出窗口，并调用已加载的库。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完整呼叫如下：</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完整调用中，从Shell32库中调用ShellExecuteA函数，并带有用于启动rundll32的参数，并通过该参数调用下载的恶意库的导出函数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样就完成了宏功能，有效负载已启动并正在运行。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如前所述，该技术已经相当古老（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">适用于Windows 3.0和3.1的Excel 4.0</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），但是它完全提供了恶意软件实现其目标所需的功能。该文件的目的是悄悄地在系统中放置可能造成严重破坏的危险软件，从个人数据被盗，系统的授权数据开始，到计算机上的数据损坏/加密以及远程执行代码的能力开始。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于此类文档的分析，根本不需要使用任何特殊的实用程序和软件，但是，值得一提的是一组</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oletools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">-可以在此处找到更多详细信息</font></a><font style="vertical-align: inherit;">。我们将在这里结束，下面是分析结果确定的危害指标。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收到的国际奥委会：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [。] williamdmon [@] wp [。] pl </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [。] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [。] ir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps：//eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps：//dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">危害指标的完整列表。</font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献：</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 宏参考4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从事分析工作：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN504402/index.html">5月29日Java摘要</a></li>
<li><a href="../zh-CN504408/index.html">用于UI自动测试的selenide上的简单便捷的测试框架模板</a></li>
<li><a href="../zh-CN504412/index.html">在线编程冠军“莫斯科公开赛决赛”</a></li>
<li><a href="../zh-CN504414/index.html">微软如何杀死AppGet</a></li>
<li><a href="../zh-CN504420/index.html">编写同时进行移动的基于回合的PvP竞技场</a></li>
<li><a href="../zh-CN504434/index.html">家长教育计划：如何保护孩子免受互联网威胁</a></li>
<li><a href="../zh-CN504438/index.html">每周30次。我们打开2020年夏季</a></li>
<li><a href="../zh-CN504442/index.html">关于Linux内核中的重定位的一些知识</a></li>
<li><a href="../zh-CN504444/index.html">使用Docker多阶段构建Windows映像</a></li>
<li><a href="../zh-CN504448/index.html">第二代玩家</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>