<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèª üî¥ üë®üèº‚ÄçüöÄ Why may you need semi-synchronous replication? üë™ üëÖ üßîüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In touch Vladislav Rodin. I am currently teaching courses on software architecture and high load software architecture on the OTUS por...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Why may you need semi-synchronous replication?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/491106/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">In touch Vladislav Rodin. </font><font style="vertical-align: inherit;">I am currently teaching courses on software architecture and high load software architecture on the OTUS portal. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In anticipation of the start of a new stream of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúArchitect of high loads‚Äù,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I decided to write a small authorial material, which I want to share with you.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/pi/ad/dp/piaddproyjjd7sel38p94k6p_qe.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the fact that only about 400-700 operations per second can be performed on the HDD (which is incomparable with typical rps falling on a heavily loaded system), the classical disk database is a narrow neck of architecture. </font><font style="vertical-align: inherit;">Therefore, special attention should be paid to the scaling patterns of this repository. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment there are 2 patterns of base scaling: replication and sharding. </font><font style="vertical-align: inherit;">Sharding allows you to scale the write operation, and, as a result, reduce the rps for recording per one server in your cluster. </font><font style="vertical-align: inherit;">Replication allows you to do the same, but with read operations. </font><font style="vertical-align: inherit;">This article is devoted to this very pattern.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look at replication at a very high level, this is a simple thing: you had one server, the data was on it, and then this server stopped cope with the load of reading this data. </font><font style="vertical-align: inherit;">You add a couple more servers, synchronize data on all servers, and the user can read from any server in your cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the apparent simplicity, there are several classification options for various implementations of this scheme:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By roles in the cluster (master-master or master-slave)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By forwarded objects (row-based, statement-based or mixed)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the node synchronization mechanism</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we will deal with the 3rd point. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is transaction committed</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This topic is not directly related to replication, a separate article can be written on it, however, since without further understanding of the transaction commit mechanism, further reading is useless, let me remind you of the most basic things. </font><font style="vertical-align: inherit;">A transaction is committed in 3 stages:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a transaction to the database log.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application of a transaction in a database engine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return confirmation to the client about the successful application of the transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuances may arise in various databases in this algorithm: for example, in the InnoDB engine of the MySQL database there are 2 logs: one for replication (binary log) and the other for maintaining ACID (undo / redo log), while PostgreSQL has one log executing both functions (write ahead log = WAL). </font><font style="vertical-align: inherit;">But above it is precisely the general concept that allows such nuances to be ignored.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronous (sync) replication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's add the logic for replicating the received changes to the transaction commit algorithm:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a transaction to the database log.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application of a transaction in a database engine.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data to all replicas.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive confirmation from all replicas about the transaction on them.</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return confirmation to the client about the successful application of the transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this approach, we get a number of disadvantages: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the client is waiting for changes to be applied to all replicas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as the number of nodes in the cluster increases, we reduce the likelihood that the write operation will succeed.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is more or less clear with the 1st paragraph, then the reasons for the 2nd paragraph should be clarified. </font><font style="vertical-align: inherit;">If during synchronous replication we don‚Äôt get a response from at least one node, we roll back the transaction. </font><font style="vertical-align: inherit;">Thus, increasing the number of nodes in the cluster, you increase the likelihood that the write operation will fail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Can we wait for confirmation only from a certain fraction of nodes, for example, from 51% (quorum)? </font><font style="vertical-align: inherit;">Yes, we can, but in the classical version, confirmation from all nodes is required, because this is how we can ensure the complete consistency of data in the cluster, which is an undoubted advantage of this type of replication.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async replication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's modify the previous algorithm. </font><font style="vertical-align: inherit;">We will send data to the replicas ‚Äúsometime later‚Äù, and ‚Äúsometime later‚Äù the changes will be applied on the replicas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a transaction to the database log.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application of a transaction in a database engine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return confirmation to the client about the successful application of the transaction.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data to replicas and applying changes to them.</font></font></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach leads to the fact that the cluster is fast, because we do not keep the client waiting for the data to reach the replicas and even be communicated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the condition of dropping data to replicas ‚Äúsometime later‚Äù can lead to the loss of the transaction, and to the loss of the transaction confirmed to the user, because if the data did not have time to replicate, a confirmation was sent to the client about the success of the operation, and the node to which the changes came flew HDD, we are losing the transaction, which can lead to very unpleasant consequences.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semisync replication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we got to semi-synchronous replication. </font><font style="vertical-align: inherit;">This type of replication is not very known and not very common, but it is of considerable interest, since it can combine the advantages of both synchronous and asynchronous replication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to combine the 2 previous approaches. </font><font style="vertical-align: inherit;">We will not keep the client for long, but we require that the data be replicated:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a transaction to the database log.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application of a transaction in a database engine.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data to replicas.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receiving confirmation from the replica about receiving changes (they will be applied ‚Äúsometime later‚Äù).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return confirmation to the client about the successful application of the transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that with this algorithm, transaction loss occurs only in the event of a fall of the node accepting the changes and the replica nodes. </font><font style="vertical-align: inherit;">The probability of such a malfunction is considered small, and these risks are accepted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But with this approach, the risk of phantom readings is possible. </font><font style="vertical-align: inherit;">Imagine the following scenario: in step 4, we did not receive confirmation from any replica. </font><font style="vertical-align: inherit;">We must roll back this transaction, and do not return the confirmation to the client. </font><font style="vertical-align: inherit;">Since the data was applied in step 2, there is a time gap between the end of step 2 and the transaction rollback, during which parallel transactions can see those changes that should not be in the database.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lose-less semisync replication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you think a little, you can only change the steps of the algorithm in places to fix the problem of phantom readings in this scenario:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a transaction to the database log.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending replica data.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receiving confirmation from the replica about receiving changes (they will be applied ‚Äúsometime later‚Äù).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application of a transaction in a database engine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return confirmation to the client about the successful application of the transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we commit changes only if they are replicated. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As always, there are no perfect solutions, there is a set of solutions, each of which has its own advantages and disadvantages and is suitable for solving various classes of problems. </font><font style="vertical-align: inherit;">This is also true for choosing a mechanism for synchronizing the data of a replicated database. </font><font style="vertical-align: inherit;">The set of benefits that semi-synchronous replication has is solid and interesting enough to be considered deserving of attention, despite its low prevalence. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all. </font><font style="vertical-align: inherit;">See you on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">course</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491092/index.html">How Crash Bandicoot Hacked Playstation</a></li>
<li><a href="../en491094/index.html">Installing Firebird 3 on Modern Linux Versions: CentOS8 and Ubuntu 19</a></li>
<li><a href="../en491100/index.html">On Wanhao 5S, they printed a doll with a height of a person</a></li>
<li><a href="../en491102/index.html">How to develop a service when there are tough competitors around</a></li>
<li><a href="../en491104/index.html">How I found a hardware glitch on my Lenovo MiiX 2 10 tablet</a></li>
<li><a href="../en491108/index.html">Organizing deployments to many k8s environments using helmfile</a></li>
<li><a href="../en491110/index.html">Convert rtf to xml in C #</a></li>
<li><a href="../en491112/index.html">The Path to Network Innocence - Cisco DNA</a></li>
<li><a href="../en491114/index.html">Smart relocation or how to choose a company for work and not regret it</a></li>
<li><a href="../en491116/index.html">Modern Identification Standards: OAuth 2.0, OpenID Connect, WebAuthn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>