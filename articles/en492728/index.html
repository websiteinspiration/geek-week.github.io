<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîç ü•û üê∞ Asterisk and sending missed in Telegram / Slack / E-mail ‚≠êÔ∏è üçü ü§òüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a call center. There is Asterisk / FreePBX with configured queues. There are agents who should service calls. But there are so many potential...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Asterisk and sending missed in Telegram / Slack / E-mail</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492728/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a call center. </font><font style="vertical-align: inherit;">There is Asterisk / FreePBX with configured queues. </font><font style="vertical-align: inherit;">There are agents who should service calls. </font><font style="vertical-align: inherit;">But there are so many potential customers, and there are so few agents that the first can not get through to the second in any way - hang-hang in line for a minute, and even turn off. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But for some reason they called! </font><font style="vertical-align: inherit;">Maybe they want to bring money to the company? </font><font style="vertical-align: inherit;">Let's try to return both customers and their money using the FreePBX example.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the queue settings, you can specify Fail Over Destination - where to send the call when the queue is full, the timeout period has elapsed, etc. But it often happens that the caller disconnects before he can be redirected to Fail Over Destination - you never know, the connection is disconnected. There is no ready-made solution for such cases. Therefore, we go under the cut and write our own - with sending an alert to Telegram / Slack / E-mail / somewhere else there.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the first thing we need to understand is how FreePBX writes queue logs. </font><font style="vertical-align: inherit;">In the simplest case, this is the text file / var / log / asterisk / queue_log. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, a regular call is written to the log from the subscriber 8964467XXXXX, who called 302221XXXX, who is in line No. 603 to the first position, which Agent Girl answered 8 seconds later. </font><font style="vertical-align: inherit;">They talked 133 seconds and the subscriber was the first to hang up - everyone would have such polite managers!</font></font><br>
<br>
<pre><code class="bash hljs">1584318765|1584318747.89449|603|NONE|DID|302221<font></font>
1584318765|1584318747.89449|603|NONE|ENTERQUEUE||8964467|1<font></font>
1584318774|1584318747.89449|603|Agent Girl|CONNECT|9|1584318765.89450|8<font></font>
1584318907|1584318747.89449|603|Agent Girl|COMPLETECALLER|9|133|1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is a slightly different story when a subscriber 8996453XXXXX phoned 302257XXXXX, hung 10 seconds in line No. 210 in the first position and disconnected. </font><font style="vertical-align: inherit;">I didn‚Äôt even listen to the voice menu!</font></font><br>
<br>
<pre><code class="bash hljs">1581728710|1581728690.59367|210|NONE|DID|302257<font></font>
1581728710|1581728690.59367|210|NONE|ENTERQUEUE||8996453|1<font></font>
1581728720|1581728690.59367|210|NONE|ABANDON|1|1|10</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's about him, we will write in the messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we need to catch the occurrence of the ABANDON event in the log file. </font><font style="vertical-align: inherit;">I puzzled for a long time how this can be done, but then quite by chance I came across a wonderful tool - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MONIT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In our case, it will monitor the queue log, and as soon as the line ‚ÄúABANDON‚Äù appears in it, it will call the script for processing this event. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, after installing the package:</font></font><br>
<br>
<pre><code class="bash hljs">yum install monit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set it up - create the file /etc/monit.d/queue_log and write just three lines into it:</font></font><br>
<br>
<pre><code class="bash hljs">check file queue_log with path /var/<span class="hljs-built_in">log</span>/asterisk/queue_log
    <span class="hljs-keyword">if</span> content = <span class="hljs-string">"ABANDON"</span> <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">exec</span> <span class="hljs-string">"/var/lib/asterisk/agi-bin/qlogevent.sh <span class="hljs-variable">$EVENT</span>"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, when the word ‚ÄúABANDON‚Äù appears in the queue log, which tells us to prematurely disconnect the subscriber, the /var/lib/asterisk/agi-bin/qlogevent.sh script with the $ EVENT parameter will be called, which is nothing other than completely the line in which this word appeared. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now it‚Äôs not chess that starts - you need to think about it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The line passed to the script does not contain information about the number of the caller:</font></font><br>
<br>
<pre><code class="bash hljs">1581728720|1581728690.59367|210|NONE|ABANDON|1|1|10</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It has only Timestamp (1581728720), a unique call ID (1581728690.59367), a queue number (210), the event itself and a few other non-essential parameters. </font><font style="vertical-align: inherit;">Those. </font><font style="vertical-align: inherit;">We will have to search for the subscriber number ourselves. </font><font style="vertical-align: inherit;">And in what way? </font><font style="vertical-align: inherit;">And it‚Äôs very simple, because we have a UID of a call! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us again turn to the log of this call, specifically, to the line in which the subscriber falls into the queue:</font></font><br>
<br>
<pre><code class="bash hljs">1581728710|1581728690.59367|210|NONE|ENTERQUEUE||8996453|1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the ‚ÄúENTERQUEUE‚Äù event occurs, one of the parameters is the subscriber number we need. </font><font style="vertical-align: inherit;">We can only find this line in the queue_log file. </font><font style="vertical-align: inherit;">This is exactly what the bash script is doing, which MONIT carefully called for us:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#MONIT_DESCRITION - ,      .</span>
<span class="hljs-comment"># timestamp    - ( ‚Ññ1).</span>
timedate=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f1 | cut -d\: -f2 | gawk <span class="hljs-string">'{print strftime("%d.%m.%Y %H:%M:%S",$0);}'</span>)
<span class="hljs-comment"># UID ( ‚Ññ2)</span>
call_id=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f2)
<span class="hljs-comment">#   ( ‚Ññ3)</span>
qnum=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f3)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
<span class="hljs-keyword">case</span> <span class="hljs-variable">$qnum</span> <span class="hljs-keyword">in</span><font></font>
    210)<font></font>
        qname=<span class="hljs-string">" 1"</span><font></font>
        ;;<font></font>
    220)<font></font>
        qname=<span class="hljs-string">" 2"</span><font></font>
        ;;<font></font>
<span class="hljs-keyword">esac</span><font></font>
<font></font>
<span class="hljs-comment">#      UID,     ENTERQUEUE</span>
str=$(grep <span class="hljs-string">"|<span class="hljs-variable">$call_id</span>|<span class="hljs-variable">$qnum</span>|.*|ENTERQUEUE"</span> /var/<span class="hljs-built_in">log</span>/asterisk/queue_log)
<span class="hljs-comment">#      ( ‚Ññ7)</span>
caller_id=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$str</span> | cut -d\| -f7)
<span class="hljs-comment">#     ( ‚Ññ1)</span>
time_enter=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$str</span> | cut -d\| -f1)
<span class="hljs-comment">#     ( ‚Ññ1   ABANDON)</span>
time_abandon=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$MONIT_DESCRIPTION</span> | cut -d\| -f1 | cut -d\: -f2)
<span class="hljs-comment"># </span>
data=<span class="hljs-string">" <span class="hljs-variable">$caller_id</span> <span class="hljs-variable">$timedate</span>   <span class="hljs-variable">$qname</span>,       <span class="hljs-subst">$(($time_abandon-$time_enter)</span>) ."</span>
<span class="hljs-comment">#    /.     Slack.</span>
/usr/bin/curl -X POST -H <span class="hljs-string">'Content-type: application/json'</span> --data <span class="hljs-string">'{"text":"'</span><span class="hljs-string">"<span class="hljs-variable">$data</span>"</span><span class="hljs-string">'"}'</span> <span class="hljs-string">"https://hooks.slack.com/services/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, that's all! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
True, there is one incident - MONIT, designed to monitor everything and everything; it itself needs monitoring, because </font><font style="vertical-align: inherit;">periodically falls.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492714/index.html">Effective work from home: general and personal</a></li>
<li><a href="../en492718/index.html">Security through user restriction or how to create a vulnerability</a></li>
<li><a href="../en492720/index.html">diskussion: project file service</a></li>
<li><a href="../en492724/index.html">Bj√∂rn Straustrup Answers Top 5 C ++ Questions with Stack Overflow</a></li>
<li><a href="../en492726/index.html">OS Sivelkiriya: software development process</a></li>
<li><a href="../en492730/index.html">US Department of Defense: Ethics for AI and Unmanned Vehicles</a></li>
<li><a href="../en492742/index.html">Visualize Node JS application data with Prometheus + Grafana</a></li>
<li><a href="../en492744/index.html">Which system will be the loudest, and which will give ‚Äúabsolute‚Äù silence: two interesting scientific projects</a></li>
<li><a href="../en492746/index.html">How to avoid programming outrage? Integrator Tips</a></li>
<li><a href="../en492748/index.html">Profession DevOps-engineer: a view of the system administrator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>