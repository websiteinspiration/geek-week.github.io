<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🎨 🙆🏿 🔱 ICQ New: bot breeding guide 📑 🛌🏼 🐁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Each time, entering the messenger, we meet bots in their most diverse manifestations. Some talk about the weather, others play burgers, and still othe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ICQ New: bot breeding guide</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/506206/"><img src="https://habrastorage.org/webt/hz/yl/ac/hzylac6lisykfejesv6dmsxquok.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each time, entering the messenger, we meet bots in their most diverse manifestations. Some talk about the weather, others play burgers, and still others just throw memes in the mood. Surely, a thought popped up among many of you: “But can I make my own bot?” Unfortunately, often such thoughts are broken about a misunderstanding of how to make a bot at all. Probably, for this you need to be a cool IT specialist and understand millions of technologies? Not really. And today we will try to show that the creation of our bot is a simple and understandable process. Let's analyze the full cycle of creating a bot, from obtaining the necessary data from the messenger to writing code and launching it on the server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some time ago, the bot platform was heavily updated in ICQ. </font><font style="vertical-align: inherit;">She became more friendly, understandable and comfortable. </font><font style="vertical-align: inherit;">Using the Python library from the developers, we will create our first bot.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First thing</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, you need to be registered in ICQ. </font><font style="vertical-align: inherit;">This can be done through the application for a mobile phone, computer or directly from a browser in the web version. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After registration, you can begin to establish your own bot in the system:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To find </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metabot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on ICQ.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write him a team </font></font><code>/newbot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Send a name for your new bot (should end in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this metabot will send the data of your bot:</font></font><br>
<br>
<ul>
<li><code>botId</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: unique bot number;</font></font></li>
<li><code>nick</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: name of the bot to search;</font></font></li>
<li><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: the token that is used for network requests to the server.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's it, the bot is created. He can be found in the search, write a message to him. Now we need to make the bot active and respond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the page </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.com/botapi/#/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there is a full description of the API methods. They are used to interact with the server. Let us examine some of them in more detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The basic method is </font></font><code>/events/get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is used to receive new bot events. For example, if someone wrote a bot, then this event will be given when prompted </font></font><code>/events/get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Let's write a message to the bot and check the appearance of the corresponding event. This can be done, for example, in a browser. To do this, go to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://api.icq.net/bot/v1/events/get?token=Your token &amp; pollTime = 1 &amp; lastEventId = 0</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Parameter</font></font><code>pollTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">responsible for the length of time the request is held by the server. </font><font style="vertical-align: inherit;">For example, if you enter the value 60, then the server will wait for events for the bot for 60 seconds, and if there are none during this time, the server will return an empty array of events. </font></font><code>lastEventId</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">responsible for the last processed event. </font><font style="vertical-align: inherit;">In other words, events with values ​​less than the transmitted will be clipped. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After going to this address, something like this will appear on the screen:</font></font><br>
<br>
<pre><code class="json hljs">{
 <span class="hljs-attr">"events"</span>: [<font></font>
  {<font></font>
    <span class="hljs-attr">"eventId"</span>: <span class="hljs-number">41</span>,
     <span class="hljs-attr">"payload"</span>: {
         <span class="hljs-attr">"chat"</span>: {
           <span class="hljs-attr">"chatId"</span>: <span class="hljs-string">"745294945"</span>,
            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"private"</span><font></font>
         },<font></font>
         <span class="hljs-attr">"from"</span>: {
                <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"Andrey"</span>,
                <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Shvedov"</span>,
                <span class="hljs-attr">"nick"</span>: <span class="hljs-string">"shvedoff"</span>,
                <span class="hljs-attr">"userId"</span>: <span class="hljs-string">"745294945"</span><font></font>
         },<font></font>
         <span class="hljs-attr">"msgId"</span>: <span class="hljs-string">"6831171945581511151"</span>,
         <span class="hljs-attr">"text"</span>: <span class="hljs-string">""</span>,
         <span class="hljs-attr">"timestamp"</span>: <span class="hljs-number">1590506161</span><font></font>
     },<font></font>
     <span class="hljs-attr">"type"</span>: <span class="hljs-string">"newMessage"</span><font></font>
  }<font></font>
 ],<font></font>
 <span class="hljs-attr">"ok"</span>: <span class="hljs-literal">true</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same way, you can send a message on behalf of the bot using the method </font></font><code>/messages/sendText</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We don’t need to study these methods in more detail, we have a ready-made Python library that allows us to write our bot without going into details.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a code?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, but first we need to prepare our own computer for this. </font><font style="vertical-align: inherit;">We will use Python in the third version (download the version for your OS here: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.python.org/downloads/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the pip package manager here: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://pip.pypa.io/en/stable/installing/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) Also, you need to install the library to work with bots:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip3 install --upgrade mailru-im-bot
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can proceed.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are writing!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, we will write a game bot that will test the knowledge of simple mathematics. He will work like this: a person writes a message to a bot, he introduces himself and offers to play. After the user agrees, the bot generates a simple mathematical example and 4 options to choose from. When the user clicks the button with the selected answer, the bot answers, right or wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the bot must first receive events from the server. To do this, in addition to importing all the libraries, we need to create a class object </font></font><code>Bot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and start receiving updates:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot<font></font>
<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
                    datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = <span class="hljs-string">""</span> <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.start_polling()<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we import the logging library and run it. </font><font style="vertical-align: inherit;">We also import the library for ICQ bots, set the necessary parameter </font></font><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, create a class object </font></font><code>Bot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and start receiving updates from the server ( </font></font><code>bot.start_polling()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now our bot can receive events, but cannot process them. </font><font style="vertical-align: inherit;">We supplement the bot so that it can respond to messages. </font><font style="vertical-align: inherit;">To do this, add the necessary imports:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler
</code></pre><br>
<code>json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needed to format the part of the message responsible for the buttons. </font></font><code>MessageHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needed to add new messages to the handler code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we need a function that will compose a message for the response:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"!"</span>, <span class="hljs-string">"callbackData"</span>: <span class="hljs-string">"start"</span>}]<font></font>
        ]<font></font>
<font></font>
    first_message_text = <span class="hljs-string">"!  -  . ?"</span><font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
         text=first_message_text,<font></font>
         inline_keyboard_markup=json.dumps(default_markup))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It receives the input of the created bot and the event of a new message. </font></font><code>default_markup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a matrix of buttons (a “list” object, consisting of an array of button strings. In our case, this is the only </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><i><font style="vertical-align: inherit;">!</font></i><font style="vertical-align: inherit;"> ). </font></font><code>first_message_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a string, the text of which will be sent to the user. </font><font style="vertical-align: inherit;">The method </font></font><code>send_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accepts:</font></font><br>
<br>
<ul>
<li><code>chat_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (field from the event being processed) - identifier of the chat from which the message was received, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text of the message to send </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>inline_keyboard_markup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- our buttons.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it remains to describe the call to this function when a message is received. </font><font style="vertical-align: inherit;">For this, the library has a special design:</font></font><br>
<br>
<pre><code class="python hljs">bot.dispatcher.add_handler(MessageHandler(callback=startup))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It allows you to automatically call a function </font></font><code>startup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the necessary parameters </font><font style="vertical-align: inherit;">when you receive a new message </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This handler must be placed in the function </font></font><code>main()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We got such a code that allows you to send a start message when the bot receives any message:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
                    datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = «» <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{«text»: «!», «callbackData»: «start»}]<font></font>
        ]<font></font>
    first_message_text = «!  —  . ?»<font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
        text=first_message_text,<font></font>
        inline_keyboard_markup=json.dumps(default_markup))<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.dispatcher.add_handler(MessageHandler(callback=startup))<font></font>
    bot.start_polling()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the user, it will look like this:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a4/a51/4b4/6a4a514b4e5629c69a6cb9a1f187de4b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider in more detail the button that we sent in the message:</font></font><br>
<br>
<pre><code class="python hljs">[ [{«text»: «!», «callbackData»: «start»}]]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the text that is written on the button, the message has a field </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When a button is clicked, the server generates a button click event. </font><font style="vertical-align: inherit;">In it, he passes this field as the identifier of the pressed button. </font><font style="vertical-align: inherit;">That is, by this line received from the server, we can judge which button the user clicked. </font><font style="vertical-align: inherit;">Thus, further we need to add the button click processing logic to the bot. </font><font style="vertical-align: inherit;">To do this, we will again need to import the necessary methods:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> BotButtonCommandHandler
<span class="hljs-keyword">from</span> bot.filter <span class="hljs-keyword">import</span> Filter
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first line is the event handler for clicking a button, the second is a filter to help you understand which button is pressed. </font><font style="vertical-align: inherit;">We also need to describe the logic of the response to button clicks:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">bot, event</span>):</span>
    question = <span class="hljs-string">''</span>
    operands = [<span class="hljs-string">"+"</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"*"</span>]<font></font>
    operations_count = randrange(<span class="hljs-number">3</span>)+<span class="hljs-number">2</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(operations_count):<font></font>
        question += str(randrange(<span class="hljs-number">9</span>))<font></font>
        question += choice(operands)<font></font>
    question = question[:<span class="hljs-number">-1</span>]<font></font>
    answer = eval(question)<font></font>
    buttons = [<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"right"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}],<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer<span class="hljs-number">-1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">2</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}]]<font></font>
    shuffle(buttons[<span class="hljs-number">0</span>])<font></font>
    shuffle(buttons[<span class="hljs-number">1</span>])<font></font>
    shuffle(buttons)<font></font>
    bot.answer_callback_query(<font></font>
        query_id=event.data[<span class="hljs-string">'queryId'</span>],<font></font>
        text=<span class="hljs-string">' '</span>)<font></font>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=question,<font></font>
        inline_keyboard_markup=json.dumps(buttons))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By analogy with messages, a function accepts the same arguments as input. </font><font style="vertical-align: inherit;">Then an example and an array of buttons with answers are generated. </font><font style="vertical-align: inherit;">One of the answers will be correct. </font><font style="vertical-align: inherit;">On this basis, the answers will be different </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the end, you must definitely call the method </font></font><code>answer_callback_query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with parameters:</font></font><br>
<br>
<ul>
<li><code>query_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - unique number of the event of pressing the button,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the text that will be shown in the tooltip when you click on the button.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By calling this method, we will show the user that the bot has accepted the click of a button. </font><font style="vertical-align: inherit;">Otherwise, the download indicator will appear on the button for a while. </font><font style="vertical-align: inherit;">Using the method, </font></font><code>send_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you need to send the message itself with a question and answer buttons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's immediately add functions for processing the correct and incorrect answers:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">right</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">'!'</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrong</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">':('</span>)<font></font>
    start(bot, event)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These functions will be called when you click on the correct and incorrect answers. </font><font style="vertical-align: inherit;">And after the message with the correct answer, the user will receive a new question. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All that remains is to add button click handlers:</font></font><br>
<br>
<pre><code class="python hljs">    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=start, filters=Filter.callback_data(«start»)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=wrong, filters=Filter.callback_data(«wrong»)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=right, filters=Filter.callback_data(«right»)))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each of these three handlers contains a filter by </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for example, </font></font><code>filters=Filter.callback_data(«start»)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and a function to call. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This completes the bot programming. </font><font style="vertical-align: inherit;">The resulting code looks like this:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> BotButtonCommandHandler
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler
<span class="hljs-keyword">from</span> bot.filter <span class="hljs-keyword">import</span> Filter
<span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randrange, choice, random, shuffle<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
        datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = <span class="hljs-string">""</span> <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"!"</span>, <span class="hljs-string">"callbackData"</span>: <span class="hljs-string">"start"</span>}]<font></font>
        ]<font></font>
<font></font>
    first_message_text = <span class="hljs-string">"!  -  . ?"</span><font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
        text=first_message_text,<font></font>
        inline_keyboard_markup=json.dumps(default_markup))<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">bot, event</span>):</span>
    question = <span class="hljs-string">''</span>
    operands = [<span class="hljs-string">"+"</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"*"</span>]<font></font>
    operations_count = randrange(<span class="hljs-number">3</span>)+<span class="hljs-number">2</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(operations_count):<font></font>
        question += str(randrange(<span class="hljs-number">9</span>))<font></font>
        question += choice(operands)<font></font>
    question = question[:<span class="hljs-number">-1</span>]<font></font>
    answer = eval(question)<font></font>
    buttons = [<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"right"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}],<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer<span class="hljs-number">-1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">2</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}]]<font></font>
    shuffle(buttons[<span class="hljs-number">0</span>])<font></font>
    shuffle(buttons[<span class="hljs-number">1</span>])<font></font>
    shuffle(buttons)<font></font>
    bot.answer_callback_query(<font></font>
        query_id=event.data[<span class="hljs-string">'queryId'</span>],<font></font>
        text=<span class="hljs-string">' '</span>)<font></font>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=question,<font></font>
        inline_keyboard_markup=json.dumps(buttons))<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">right</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">'!'</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrong</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">':('</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.dispatcher.add_handler(MessageHandler(callback=startup))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=start, filters=Filter.callback_data(<span class="hljs-string">"start"</span>)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=wrong, filters=Filter.callback_data(<span class="hljs-string">"wrong"</span>)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=right, filters=Filter.callback_data(<span class="hljs-string">"right"</span>)))<font></font>
    bot.start_polling()<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I note that it contains the imports necessary for the function to generate the question. </font><font style="vertical-align: inherit;">Instead of this and other functions, you can write some kind of your own logic :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where and how to run?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is most convenient to launch a bot on a remote server. </font><font style="vertical-align: inherit;">There are many services that offer virtual servers with sufficient access to install programs. </font><font style="vertical-align: inherit;">Some services provide a free trial period. </font><font style="vertical-align: inherit;">Since we are Mail.ru, we will analyze it using the example of Mail.ru Cloud Solutions. </font><font style="vertical-align: inherit;">There is a simple registration process, quick access to your server, as well as a free trial period without a bank card or other difficulties.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We register an account at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://mcs.mail.ru/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create an instance of a virtual machine. </font><font style="vertical-align: inherit;">All settings are left unchanged, they are enough.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The service will offer to download the access key. </font><font style="vertical-align: inherit;">Download.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we go to our virtual machine: </font></font><code>ssh -i ./xxx.pem user@ip</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where </font></font><code>./xxx.pem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the path to the downloaded key.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, we need to install the necessary programs and packages:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo curl https://raw.githubusercontent.com/dvershinin/apt-get-centos/master/apt-get.sh -o /usr/<span class="hljs-built_in">local</span>/bin/apt-get<font></font>
$ chmod 0755 /usr/<span class="hljs-built_in">local</span>/bin/apt-get<font></font>
$ sudo apt-get install python3<font></font>
$ curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py<font></font>
$ python3 get-pip.py<font></font>
$ pip3 install --upgrade mailru-im-bot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we installed Python and all the necessary libraries for our bot to work. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains to copy the bot to the server and run it. </font><font style="vertical-align: inherit;">From the folder with the script, execute:</font></font><code>scp -i ./xxx.pem ./path/to_bot.py user@ip:~</code><br>
<br>
<ul>
<li><code>./xxx.pem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - path to the key;</font></font></li>
<li><code>./path/to_bot.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - path to the file with the bot;</font></font></li>
<li><code>user@ip:~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - login, address and path where to copy the bot.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the file with the bot will be in the home directory on the remote server. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We go back to the server and run:, </font></font><code>python3 ~/file_name.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where </font></font><code>file_name.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the name of our file with the bot.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What's next?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we got a self-working bot lying on our personal server. </font><font style="vertical-align: inherit;">If you want to further develop the creation of bots for ICQ, then study the documentation on the API bots in more detail and complicate the internal logic of your bot. </font><font style="vertical-align: inherit;">And ICQ also has a chat in which you can ask questions about bots: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/botapi_faq</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">useful links</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.com/botapi/#/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ICQ bot API. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/mail-ru-im/bot-python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Python library for ICQ bots. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/metabot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - get the token and edit the bot. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/shvedoff/Icq_buttons</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a bot that performs all possible actions with buttons. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/AoLE1J5Ecm5DIjZh1gg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - chat for questions on bots.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506180/index.html">How to choose the right power for your UPS. We analyze the example of Eaton</a></li>
<li><a href="../en506188/index.html">400-line custom grammar parser</a></li>
<li><a href="../en506190/index.html">How to subtract a series of time intervals and try the Bentley-Ottmann algorithm</a></li>
<li><a href="../en506196/index.html">How We Hacked a Smart Factory</a></li>
<li><a href="../en506204/index.html">Abstract data type. Part 2: Data Management</a></li>
<li><a href="../en506208/index.html">Russian scientists have created the most heat-resistant material in the world</a></li>
<li><a href="../en506218/index.html">Мегафон продолжает вмешиваться в мой HTTP трафик в 2020 году, отправлять рекламу, даже после получения запретов на это</a></li>
<li><a href="../en506222/index.html">Checklists: try not to miss the details</a></li>
<li><a href="../en506228/index.html">AdonisJS 5 - Laravel-like framework on nodeJS and with Typescript worthy of your attention</a></li>
<li><a href="../en506230/index.html">Spotlights that surprised me. Test and review of Gauss QPlus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>