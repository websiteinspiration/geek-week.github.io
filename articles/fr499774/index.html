<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏔️ 🛸 👨🏽‍💼 Pas un jour sans sport - 2: reprogrammer un bracelet chinois 🐪 🎈 🤶🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour les personnes impliquées dans le sport, un compagnon fréquent pour le jogging ou l'équitation est un smartphone avec diverses applications. Avec ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pas un jour sans sport - 2: reprogrammer un bracelet chinois</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499774/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les personnes impliquées dans le sport, un compagnon fréquent pour le jogging ou l'équitation est un smartphone avec diverses applications. </font><font style="vertical-align: inherit;">Avec un vélo, c'est plus facile, vous pouvez fixer un smartphone, par exemple, sur le volant et regarder les données des capteurs. </font><font style="vertical-align: inherit;">Mais que faire si vous courez ou skiez? </font><font style="vertical-align: inherit;">Vous pouvez fixer l'intelligent sur votre main, pour cela, il existe des housses spéciales (y compris celles pivotantes). </font><font style="vertical-align: inherit;">Mais cela est gênant et parfois lourd. </font><font style="vertical-align: inherit;">De plus, le héros russe ne va pas directement.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/j1/q_/fz/j1q_fzwtiw73syp5etvzvj7rtz0.png"></div><br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe divers articles sur Internet dans lesquels les passionnés fabriquent leurs montres intelligentes. </font><font style="vertical-align: inherit;">Boîtier fabriqué ou imprimé. </font><font style="vertical-align: inherit;">Faites la garniture. </font><font style="vertical-align: inherit;">Mais il existe de nombreux appareils prêts à l'emploi sur aliexpress. </font><font style="vertical-align: inherit;">Par exemple, comme sur la photo ci-dessous. </font><font style="vertical-align: inherit;">Si vous croyez à la description, alors c'est un super appareil direct: il mesure la fréquence cardiaque, la pression, les calories et autre chose.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/1e/lx/_m/1elx_m11liwbpplrvgyeuv6ysre.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrons et voyons ce qu'il y a dedans.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zh/nh/a7/zhnha7n6p12xuxjq7orp3viizem.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ig/yt/c2/igytc2hz31xj2jcedbdn2wjxuso.jpeg"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et en fait</font></font></b>
                        <div class="spoiler_text">        .           .       Random()  . ,  ,    ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oa/hw/qq/oahwqqwuxmukbxri_l8ripqzsha.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cerveau de ce bracelet est une puce PHY6202 d'un fabricant du Middle Kingdom Fengjia Microelectronics. À l'intérieur, il a un Cortex-M0 et un ensemble standard de périphériques. Mémoire: 512 Ko de Flash, 138 Ko de SRAM et 128 Ko de ROM. La ROM contient une pile BLE et un chargeur de démarrage UART, comme puce programmable via UART. Les camarades chinois ont soigneusement fait ressortir les contacts de l'UART. Pour passer en mode UART, le chargeur de démarrage doit tirer la sortie TM à un niveau élevé et réinitialiser la puce. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les utilitaires et les SDK pour le PHY6202 (ainsi que pour son frère aîné PHY6212) peuvent être trouvés </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilitaire de programmation de puces PhyPlusKit est fourni directement. </font><font style="vertical-align: inherit;">La documentation contient une liste de commandes: effacer, écrire, etc. Détails dans le document PHY62XX_UART_FlashWrite_Protocol sur le lien ci-dessus (en chinois). </font><font style="vertical-align: inherit;">Honnêtement, la liste des commandes n'est pas complète. </font><font style="vertical-align: inherit;">PhyPlusKit utilise une autre commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdreg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (lire n'importe quel registre). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons. </font><font style="vertical-align: inherit;">Nous démontons, soudons les contacts nécessaires à l'adaptateur UART-USB et c'est </font></font><abbr title="Sauvegardez tout ce qui est possible.  &quot;Relire?  Non, pas entendu. &quot;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parti</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le SDK contient de nombreux exemples. </font><font style="vertical-align: inherit;">En soi, à mon avis, il est tordu et humide. </font><font style="vertical-align: inherit;">Parfois, vous devez modifier la source, car </font><font style="vertical-align: inherit;">ils ne sont pas conçus pour un usage «externe» uniquement. </font><font style="vertical-align: inherit;">Voici la fonction de mesure du niveau de batterie de Battery Service. </font><font style="vertical-align: inherit;">Pourquoi est-elle là du tout incompréhensible.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> uint8 <span class="hljs-title">battMeasure</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{<font></font>
  uint8 percent;<font></font>
  percent = <span class="hljs-number">95</span>;
  <span class="hljs-keyword">return</span> percent;<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pas un SDK, mais un exemple solide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le brochage du bracelet est:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) accéléromètre</font></font></td>
<td>SDA P32<br>
SCL P33</td>
</tr>
<tr>
<td>2) LCD</td>
<td>SDA P25<br>
SCL P31<br>
RS P00<br>
Reset P01<br>
CS P02<br>
LED P34</td>
</tr>
<tr>
<td>3)  </td>
<td>P03</td>
</tr>
<tr>
<td>4) </td>
<td>P20</td>
</tr>
<tr>
<td>5) USB Vin (   USB)</td>
<td>P15</td>
</tr>
<tr>
<td>6) Vbat</td>
<td>P14/AIO3</td>
</tr>
<tr>
<td>7) Green LED (  )</td>
<td>P23</td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'écran est standard (plein sur aliexpress) sur le ST7735 avec une résolution de 80 * 160. Propulsé par SPI. Il existe des bibliothèques prêtes à l'emploi, mais il est préférable de créer votre propre version allégée, pour votre taille de police et vos propres caractères. L'affichage est en couleur, mais ce n'est pas très pertinent dans la rue, car faible contraste (se souvient tristement des écrans transflectifs des téléphones Siemens). Oui, et du verre teinté. Nous utiliserons la couleur blanche pour afficher le texte, c'est mieux vu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bouton tactile est réalisé sur une puce Tontec TTP233D-HA6. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'accéléromètre est inconnu, mais le balayage du bus I2C a montré qu'il utilise des registres comme tous les accéléromètres ST. Surtout, il est similaire à LIS2DH12. Il semble que tous les registres de contrôle correspondent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour afficher nos informations sur le bracelet, nous avons besoin de notre propre service BLE pour le transfert de données. </font><font style="vertical-align: inherit;">Quelque chose comme </font></font><abbr title="Profil du port série"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPP</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">De plus, vous pouvez ajouter le service de batterie et la mise à jour du firmware via BLE. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme base du projet, nous prenons un exemple de firmware pour la mise à jour d' </font></font><abbr title="Over-the-air"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OTA</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le refaisons à nos besoins. </font><font style="vertical-align: inherit;">Ajoutez un service pour la batterie. </font><font style="vertical-align: inherit;">Pour transférer des données, vous pouvez utiliser un exemple d'implémentation d'un service personnalisé à partir du SDK. </font><font style="vertical-align: inherit;">Il utilise un service FF01 et en lui une caractéristique FF02.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divulgacher</font></font></b>
                        <div class="spoiler_text">   SDK     GPIO     0,   .    .       ,      .         ,     pull-up   pull-down (   100 )        .     .           40 ,    «» pull-down,    15  (     ).<br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous attachons les services de travail:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrompre la manipulation par bouton tactile. </font><font style="vertical-align: inherit;">En plus d'allumer l'écran et d'allumer / éteindre le bracelet lui-même, nous effectuerons une reconnaissance par simple et double pression avec la transmission d'une commande via notre caractéristique FF02.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sortie des données reçues d'un smartphone via la même caractéristique à l'écran.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">courte inclusion d'un vibromoteur pour attirer l'attention.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en utilisant l'accéléromètre, en allumant l'écran avec une vague aiguë de la main (c'est difficile à configurer, car lorsque vous courez, vous agitez les mains).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, le bracelet est prêt. </font><font style="vertical-align: inherit;">Nous vérifions via nRFConnect, il vous permet de lire et d'écrire les valeurs des caractéristiques. </font><font style="vertical-align: inherit;">Sur l'écran, l'impulsion, le temps, la distance et une autre minuterie (par exemple, pour afficher le décalage temporel ou diriger le graphique, c'est-à-dire une sorte de stimulateur cardiaque, mais cela ne peut être obtenu qu'à partir de votre application).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yw/15/c8/yw15c888j_n2kg56fpeuxwi0lim.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous devons emmener les données quelque part pour les transmettre. J'utilise actuellement l'application Strava, même si je l'aime de moins en moins. Peut-être le moyen le plus simple d'obtenir son temps de course et la distance (bien qu'avec l'arrondi à 100 m) des notifications dans la barre d'état. Pour ce faire, vous devez écrire une application avec un service d'écoute des notifications. Ce n'est pas difficile. Mais nous lirons l'impulsion directement à partir de la ceinture BLE ou ANT +. Eh bien, puisque nous avons des notifications du bracelet sur la pression des boutons, nous devons les utiliser quelque part. Par exemple, vous pouvez, en envoyant des messages via BroadCastReceiver, suspendre Strava et le redémarrer. Et il vaut mieux un jour faire votre Strava avec des cloches et des sifflets. L'application nécessite des droits d'accès à l'emplacement (cela est nécessaire pour travailler avec BLE) et des droits d'accès aux notifications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reste à vérifier le cas. Malheureusement, l'hiver s'est terminé en février, donc le cycle de l'image du début de l'article est déjà terminé. Mais vous pouvez aller courir. L'accéléromètre allume souvent l'écran inutilement, il devrait peut-être être complètement éteint. Un bouton tactile peut réagir à une goutte tombée du front.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vc/7c/go/vc7cgorhq8yuzwjdl2ju4oqhrpa.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ad/za/tt/adzattbhn-7hvqcxu0e55o55f88.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lu/er/lt/luerltdtedmppo1bwkiy4skyrhk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, la bonne nouvelle. </font><font style="vertical-align: inherit;">Le bracelet déjà de l'usine prend en charge la mise à jour OTA via l'application PhyApp (il se trouve au même endroit que le SDK, à l'origine en chinois). </font><font style="vertical-align: inherit;">Par conséquent, il n'est pas nécessaire d'avoir un micrologiciel prêt à l'emploi, même de démonter le bracelet. </font><font style="vertical-align: inherit;">Flash et utilisation. </font><font style="vertical-align: inherit;">Pour ce faire, vous devez installer l'application, mettre le firmware à la «racine» du téléphone (HEX, pas HEXF, car ce dernier contient le chargeur de démarrage que nous avons déjà de l'usine), vous connecter au bracelet et utiliser le bouton OTA pour télécharger le firmware sur le bracelet. </font><font style="vertical-align: inherit;">Après avoir clignoté, le bracelet sera éteint, pour l'allumer, vous devez maintenir le bouton enfoncé pendant 2 secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, les montres et bracelets du PHY62 peuvent être facilement convertis en n'importe quoi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Références:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les codes source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l'APK d'une application Android (il a été écrit sous Android 8.1, il semble fonctionner sous 9, il n'a pas été vérifié sous d'autres);</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> firmware </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HEX</font></a><font style="vertical-align: inherit;"> via BLE et HEXF - pour le firmware via UART (la source ne me dérange pas, mais je dois comprendre que je peux le télécharger par contrat de licence et qui n'est pas dans cette offre spéciale) + Application de firmware PhyApp pour le firmware OTA.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai acheté un bracelet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais je ne peux pas garantir que le remplissage sera le même, car </font><font style="vertical-align: inherit;">beaucoup de la même apparence, mais avec une puce différente. </font><font style="vertical-align: inherit;">Il existe une sorte d'options avec un écran plus grand, qui ont également PHY6202. </font><font style="vertical-align: inherit;">En général, il existe des montres / bracelets avec différentes puces (Phy +, Telink et même nRF).</font></font><br>
</li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS En général, il semble que le SDK pour PHY62 ait été créé sur la base du SDK Texas Instruments pour leurs puces BLE.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499758/index.html">Modèles architecturaux pratiques</a></li>
<li><a href="../fr499762/index.html">Améliorez vos compétences dans DevSecOps: 5 webinaires avec théorie et pratique</a></li>
<li><a href="../fr499764/index.html">Examen du scanner 3D XYZPrinting 3D Hand Scanner 2.0</a></li>
<li><a href="../fr499770/index.html">Apprendre tout en s'isolant</a></li>
<li><a href="../fr499772/index.html">Ce sera très, beaucoup: comment la technologie 5G va changer le marché de la publicité</a></li>
<li><a href="../fr499776/index.html">Caractéristiques de l'implémentation du langage MSH</a></li>
<li><a href="../fr499784/index.html">Qu'est-ce qui touche les murs virtuels?</a></li>
<li><a href="../fr499786/index.html">Tri des tas faibles</a></li>
<li><a href="../fr499788/index.html">Cours en ligne gratuit "Documentation technique dans les projets informatiques"</a></li>
<li><a href="../fr499792/index.html">Test de charge Atlassian Jira, Confluence, Bitbucket Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>