<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍿 🐠 😣 ファンシーLinuxシステムコール 📚 🙇🏻 ⏸️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C言語での作業を開始するとき、プログラマーは何を見ますか？彼が見てfopen、printf、scanfと、より多くの他の機能。彼はあらゆる種類のものを見ているopenとmmap-それが思われる、なぜそれらを割り当てますか？ただし、最初のグループとは異なり、これらの2つの関数は、Linuxカーネルで実...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ファンシーLinuxシステムコール</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475184/"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> <img alt="ls / usr / share / man / man2 /" src="https://habrastorage.org/webt/ej/cn/w4/ejcnw4zqrqo_wee6kw-evxqziui.png"> </a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C言語での作業を開始するとき、プログラマーは何を見ますか？彼が見て</font></font><code>fopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>scanf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、より多くの他の機能。彼はあらゆる種類のものを見ている</font></font><code>open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>mmap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-それが思われる、なぜそれらを割り当てますか？ただし、最初のグループとは異なり、これらの2つの関数は、Linuxカーネルで実行されると、システムコールです（</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際に</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、システムコールは単純に関数として呼び出すことができないため、</font></font><code>libc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数を再パックするラッパーが含まれ、場合によっては、同じ</font></font><code>open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古いシステムコールをより一般的な新しいシステムコールに置き換える）。</font><font style="vertical-align: inherit;">一般に、典型的なGNU / Linuxシステムで利用できる何千ものライブラリ関数とは異なり、カーネルインターフェイスにはエントリポイントの数がかなり制限されています-数百程度ですが、ユーザースペースの場合、カーネルのクラッシュ（たとえば、見つからないページへのアクセス）です。 -デフォルトの操作モード。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、私の考えで興味深い事実をいくつかお話しします。</font></font><code>futex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sやその他の退屈な（おそらく）実装の詳細</font><font style="vertical-align: inherit;">はありません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それは主に私に「そして何がそうなのか？！？」という反応を引き起こしたものです。</font></font></p><a name="habracut"></a><br>
<p> ,      :           shared object   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">vDSO</a>,    .    (-  ,   , ,       ) —   <code>time</code>  <code>gettimeofday</code>, ,   ,  ,    —        .</p><br>
<p>-,   SIGSEGV   ,      ,     <code>userfaultfd</code>.</p><br>
<p><strong>DISCLAIMER:</strong> ,       ,      Linux.  ,              ,      .        ,   - fallback.</p><br>
<h2 id="obschie-voprosy"> </h2><br>
<p> ,     ?  ,   <code>strace</code>!     ,   <code>strace</code>  « »,      «  0x12345678»,  ,          .  <code>strace</code>  ,     <code>-k</code>      .</p><br>
<div class="spoiler"><b class="spoiler_title">  - </b><div class="spoiler_text"><pre><code class="plaintext hljs">$ strace -k sleep 1<font></font>
execve("/bin/sleep", ["sleep", "1"], 0x7ffe9f9cce30 /* 60 vars */) = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(execve+0xb) [0xe601b]<font></font>
 &gt; /usr/bin/strace(+0x0) [0xa279c]<font></font>
 &gt; /usr/bin/strace(+0x0) [0xa41d2]<font></font>
 &gt; /usr/bin/strace(+0x0) [0x7090b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /usr/bin/strace(+0x0) [0x7112a]<font></font>
brk(NULL)                               = 0x558936ded000<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x20b) [0x1ccdb]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1cd2) [0x1b872]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
arch_prctl(0x3001 /* ARCH_??? */, 0x7fff593c0070) = -1 EINVAL ( )<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e25) [0x1b9c5]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (    )<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10cb) [0x1db9b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c12]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x73a) [0x11d4a]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
fstat(3, {st_mode=S_IFREG|0644, st_size=254851, ...}) = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1009) [0x1dad9]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x761) [0x11d71]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
mmap(NULL, 254851, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc49621c000<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1426) [0x1def6]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x79d) [0x11dad]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
close(3)                                = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10fb) [0x1dbcb]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x780) [0x11d90]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d40]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360r\2\0\0\0\0\0"..., 832) = 832<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x12f8) [0x1ddc8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d79]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c]<font></font>
 &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108]<font></font>
<font></font>
...<font></font>
  <font></font>
...<font></font>
<font></font>
brk(NULL)                               = 0x558936ded000<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x67) [0x117617]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
brk(0x558936e0e000)                     = 0x558936e0e000<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x91) [0x117641]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__open64_nocancel+0x4c) [0x11679c]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1ce9) [0x354c9]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
fstat(3, {st_mode=S_IFREG|0644, st_size=8994080, ...}) = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__fxstat64+0x19) [0x1107b9]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e33) [0x35613]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
mmap(NULL, 8994080, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc495795000<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(mmap64+0x26) [0x11baf6]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e5d) [0x3563d]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
close(3)                                = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1eab) [0x3568b]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5]<font></font>
 &gt; /bin/sleep() [0x25f0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
nanosleep({tv_sec=1, tv_nsec=0}, NULL)  = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(nanosleep+0x17) [0xe5d17]<font></font>
 &gt; /bin/sleep() [0x5827]<font></font>
 &gt; /bin/sleep() [0x5600]<font></font>
 &gt; /bin/sleep() [0x27b0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
close(1)                                = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006]<font></font>
 &gt; /bin/sleep() [0x5881]<font></font>
 &gt; /bin/sleep() [0x2d27]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
close(2)                                = 0<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006]<font></font>
 &gt; /bin/sleep() [0x5881]<font></font>
 &gt; /bin/sleep() [0x2d4d]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea]<font></font>
 &gt; /bin/sleep() [0x287e]<font></font>
exit_group(0)                           = ?<font></font>
+++ exited with 0 +++<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_exit+0x36) [0xe5fe6]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x242) [0x49cc2]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60]<font></font>
 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea]<font></font>
 &gt; /bin/sleep(+0x0) [0x287e]</code></pre></div></div><br>
<p>,           .   <code>addr2line</code> (     , ).</p><br>
<p>   :        <code>libc</code>.        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>syscall</code></a>:</p><br>
<pre><code class="cpp hljs">  syscall(SYS_kcmp, getpid(), getpid(), KCMP_FILE, <span class="hljs-number">1</span>, fd)</code></pre><br>
<h2 id="fayl-----eto-ochen-uzh-strannyy-predmet"> —     ...</h2><br>
<p>  —            .     API,     . ,        , ,   ,    .   ,  «»    <code>execve</code>,         ,        (-  «   <code>stderr</code>  ,         FD #2   »).</p><br>
<p>-         .  -       ,   ,    <code>libpcap</code>  ,  ,   ,   ,  ,        . ,   <code>libpcap</code>       ,   <code>fopen</code>   :       <code>pcap_(f)open_offline</code>     <code>pcap_next_ex</code>. ! ,       ...</p><br>
<p>  : , <code>libpcap</code>     . ,   ,  ,    «» ,   .</p><br>
<p>,  :    <code>stdin</code>   ,      4  .  ,       - <code>ungetc</code> ( <code>libpcap</code>    <code>FILE *</code>),     , ,   , ,       <code>read</code> / <code>write</code>.</p><br>
<h3 id="reshenie-1-memfd_create"> 1: memfd_create</h3><br>
<p>  <code>memfd_create</code>   « »  .      ,       .   ,     ,      <code>write</code>,  <code>lseek</code>,    <code>fdopen</code>     <code>libc</code>:</p><br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">int</span> fd = memfd_create(<span class="hljs-string">"pcap-dump-contents"</span>, <span class="hljs-number">0</span>);<font></font>
  write(fd, buf, length);<font></font>
  lseek(fd, <span class="hljs-number">0</span>, SEEK_SET);<font></font>
  FILE *file = fdopen(fd, <span class="hljs-string">"r"</span>);</code></pre><br>
<p> ,   ,       <code>/proc/&lt;PID&gt;/fd</code>:</p><br>
<pre><code class="plaintext hljs">$ ls -l /proc/31747/fd<font></font>
 0<font></font>
lr-x------ 1 trosinenko trosinenko 64  10 13:12 0 -&gt; /path/to/128test.pcap<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 13:12 1 -&gt; /dev/pts/17<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 13:12 2 -&gt; /dev/pts/17<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 13:12 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)'<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 13:12 3 -&gt; '/memfd:pcap-dump-contents (deleted)'<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 13:12 57 -&gt; 'socket:[41036]'</code></pre><br>
<h3 id="reshenie-2-open-s-flagom-o_tmpfile"> 2: open   O_TMPFILE</h3><br>
<p> Linux,   - ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>  O_TMPFILE</code></a>      .   ,  ()    , <em>  ,     </em>…      —  ,  ,       (,     ).         ,          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>linkat</code></a>:</p><br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">"."</span>, O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR);<font></font>
  assert(fd != <span class="hljs-number">-1</span>);<font></font>
  assert(write(fd, buffer + offset, len - offset) == len - offset);<font></font>
  assert(lseek(fd, <span class="hljs-number">0</span>, SEEK_SET) == <span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *link_to = getenv(<span class="hljs-string">"LINK_TO"</span>);
  <span class="hljs-keyword">if</span> (link_to != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-keyword">char</span> path[<span class="hljs-number">128</span>];
    <span class="hljs-built_in">snprintf</span>(path, <span class="hljs-keyword">sizeof</span>(path),  <span class="hljs-string">"/proc/self/fd/%d"</span>, fd);<font></font>
    linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW);<font></font>
  }</code></pre><br>
<p>      ,     ,    . .,       .</p><br>
<div class="spoiler"><b class="spoiler_title"> (  )</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> NDEBUG</span>
<span class="hljs-comment">//    assert  -  </span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">undef</span> NDEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pcap.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">//     PCAP (   -- . )</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> pcap_mgc = <span class="hljs-number">0xA1B2C3D4</span>;<font></font>
<font></font>
<span class="hljs-keyword">char</span> buffer[<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">20</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> len = read(<span class="hljs-number">0</span>, buffer, <span class="hljs-keyword">sizeof</span>(buffer));<font></font>
<font></font>
  <span class="hljs-comment">//  -      "",</span>
  <span class="hljs-comment">//     pcap_mgc,  </span>
  <span class="hljs-comment">//   4  .   ...</span>
  <span class="hljs-keyword">int</span> offset = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {
    <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">uint32_t</span> *)(buffer + i) == pcap_mgc) {<font></font>
      offset = i;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Found PCAP dump at offset %d\n"</span>, offset);<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"No PCAP dump found.\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//   ,  libpcap ,  </span>
  <span class="hljs-comment">//   .</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 0</span>
  <span class="hljs-keyword">int</span> fd = memfd_create(<span class="hljs-string">"pcap-dump-contents"</span>, <span class="hljs-number">0</span>);<font></font>
  assert(fd != <span class="hljs-number">-1</span>);<font></font>
  assert(write(fd, buffer + offset, len - offset) == len - offset);<font></font>
  assert(lseek(fd, <span class="hljs-number">0</span>, SEEK_SET) == <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">"."</span>, O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR);<font></font>
  assert(fd != <span class="hljs-number">-1</span>);<font></font>
  assert(write(fd, buffer + offset, len - offset) == len - offset);<font></font>
  assert(lseek(fd, <span class="hljs-number">0</span>, SEEK_SET) == <span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *link_to = getenv(<span class="hljs-string">"LINK_TO"</span>);
  <span class="hljs-keyword">if</span> (link_to != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-keyword">char</span> path[<span class="hljs-number">128</span>];
    <span class="hljs-built_in">snprintf</span>(path, <span class="hljs-keyword">sizeof</span>(path),  <span class="hljs-string">"/proc/self/fd/%d"</span>, fd);<font></font>
    linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW);<font></font>
  }<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  raise(SIGSTOP); <span class="hljs-comment">//    /proc/PID/fd/</span><font></font>
<font></font>
  <span class="hljs-comment">//      - ...</span>
  FILE *file = fdopen(fd, <span class="hljs-string">"r"</span>);
  <span class="hljs-keyword">char</span> errbuf[PCAP_ERRBUF_SIZE];
  <span class="hljs-keyword">pcap_t</span> * dump = pcap_fopen_offline(file, errbuf);<font></font>
  assert(dump != <span class="hljs-literal">NULL</span>);
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pcap_pkthdr</span> *<span class="hljs-title">hdr</span>;</span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> *data;
  <span class="hljs-keyword">while</span> (pcap_next_ex(dump, &amp;hdr, &amp;data) == <span class="hljs-number">1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Read packet: full length = %d bytes, available %d bytes.\n"</span>, hdr-&gt;len, hdr-&gt;caplen);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<pre><code class="plaintext hljs">$ fallocate -l 128 zero128<font></font>
$ cat zero128 test.pcap &gt; 128test.pcap<font></font>
$ ./memfd &lt; 128test.pcap<font></font>
Found PCAP dump at offset 128<font></font>
Read packet: full length = 105 bytes, available 105 bytes.<font></font>
Read packet: full length = 105 bytes, available 105 bytes.<font></font>
Read packet: full length = 66 bytes, available 66 bytes.<font></font>
Read packet: full length = 385 bytes, available 385 bytes.<font></font>
Read packet: full length = 66 bytes, available 66 bytes.<font></font>
...</code></pre></div></div><br>
<h2 id="userfaultfd-obrabotka-oshibok-pamyati-v-userspace">userfaultfd:     userspace</h2><br>
<p>,   -    ,  ,   UNIX-like        . ,  Linux    , pipe, eventfd     ebpf-. , ,    - .       ,    page faults —  : , copy-on-write,   …     «»,   SIGSEGV.   ,     SIGSEGV,  ,  undefined behavior,    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GNU libsigsegv</a>,          ,  Windows <strong>(:  GPL,         ,    libsigsegv)</strong>.     Linux    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>userfaultfd</code></a>:         ,         .</p><br>
<p>   ,         .          ,   ,         .          ,      «» ,       .      ,           . <em> ,  <code>userfaultfd</code>     , ,        .</em></p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> NDEBUG</span>
<span class="hljs-comment">//    assert  -  </span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">undef</span> NDEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// -,   sysconf...</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGE_SIZE 4096</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGE_MASK (PAGE_SIZE - 1)</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">thread_fn</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * arg)</span>
</span>{
  <span class="hljs-keyword">int</span> uffd = (<span class="hljs-keyword">intptr_t</span>)arg;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>
  <span class="hljs-comment">// ,    hugepages...</span>
  <span class="hljs-keyword">uint8_t</span> *replacement_page = mmap(<span class="hljs-literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span> ,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<font></font>
  {<font></font>
    assert(read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span> msg) &gt; <span class="hljs-number">0</span>);
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">if</span> (msg.event == UFFD_EVENT_PAGEFAULT) {
      <span class="hljs-keyword">uintptr_t</span> addr = msg.arg.pagefault.address;
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Fault: addr = 0x%zx\n"</span>, addr);<font></font>
<font></font>
      <span class="hljs-comment">//      </span>
      <span class="hljs-keyword">uint8_t</span> *page_addr = (<span class="hljs-keyword">uint8_t</span> *)((<span class="hljs-keyword">uintptr_t</span>)addr &amp; ~PAGE_MASK);<font></font>
<font></font>
      <span class="hljs-comment">//  "" ,  ""!</span>
      <span class="hljs-built_in">memset</span>(replacement_page, <span class="hljs-number">0xAB</span>, PAGE_SIZE);<font></font>
<font></font>
      <span class="hljs-comment">//    </span>
      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">copy</span>;</span>
      copy.src = (<span class="hljs-keyword">uintptr_t</span>)replacement_page;<font></font>
      copy.dst = (<span class="hljs-keyword">uintptr_t</span>)page_addr;<font></font>
      copy.mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// ,  --  </span>
      copy.copy = <span class="hljs-number">0</span>; <span class="hljs-comment">//   --     </span><font></font>
      copy.len = PAGE_SIZE;<font></font>
      assert(ioctl(uffd, UFFDIO_COPY, &amp;copy) != <span class="hljs-number">-1</span>);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">init_userfaultfd</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">int</span> uffd = syscall(__NR_userfaultfd, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">// ,      </span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">api</span>;</span><font></font>
  api.api = UFFD_API;<font></font>
  api.features = <span class="hljs-number">0</span>;<font></font>
  assert(ioctl(uffd, UFFDIO_API, &amp;api) != <span class="hljs-number">-1</span>);<font></font>
<font></font>
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"UFFD open\n"</span>);<font></font>
<font></font>
  <span class="hljs-comment">//  -</span>
  <span class="hljs-keyword">pthread_t</span> thread;
  <span class="hljs-built_in">memset</span>(&amp;thread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(thread));
  <span class="hljs-comment">// ...    int  void *?</span>
  pthread_create(&amp;thread, <span class="hljs-number">0</span>, thread_fn, (<span class="hljs-keyword">void</span> *)(<span class="hljs-keyword">intptr_t</span>)uffd);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> uffd;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register_region</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uffd, <span class="hljs-keyword">void</span> * aligned_addr, <span class="hljs-keyword">size_t</span> size)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">reg</span>;</span>
  <span class="hljs-built_in">memset</span>(&amp;reg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> reg);<font></font>
  reg.range.start = (<span class="hljs-keyword">uintptr_t</span>)aligned_addr;<font></font>
  reg.range.len = size;<font></font>
  reg.mode = UFFDIO_REGISTER_MODE_MISSING;<font></font>
<font></font>
  assert (ioctl(uffd, UFFDIO_REGISTER, &amp;reg) != <span class="hljs-number">-1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">void</span> *addr = mmap(<span class="hljs-literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-keyword">int</span> uffd = init_userfaultfd();<font></font>
  register_region(uffd, addr, PAGE_SIZE);<font></font>
<font></font>
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Before reading\n"</span>);
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Data at %p: %x\n"</span>, addr, *(<span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> *)addr);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<pre><code class="plaintext hljs">$ ./userfaultfd<font></font>
UFFD open<font></font>
Before reading<font></font>
Fault: addr = 0x7f46f40d5000<font></font>
Data at 0x7f46f40d5000: abababab</code></pre></div></div><br>
<h2 id="laquoklyuchevoy-vopros-matematiki-ne-vsyo-li-ravnoraquo-c">«  :    » ©</h2><br>
<p>,    ,       <code>stdin</code>?  , <code>if (fd == 0) ...</code> —   . , ...</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> fd = dup(<span class="hljs-number">0</span>);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"stdin is fd %d, too\n"</span>, fd);
  <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">0</span>)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"stdin"</span>);
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"not stdin"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<pre><code class="plaintext hljs">$ gcc kcmp.c -o kcmp<font></font>
$ ./kcmp<font></font>
stdin is fd 3, too<font></font>
not stdin</code></pre><br>
<p>… -   ,   .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">CRIU</a> — Checkpoint/Restore In Userspace.  ,     ,      .     userspace-,    ,   ,      <code>kcmp</code>:    PID,   , ,  ,   ,          :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/kcmp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> fd = dup(<span class="hljs-number">0</span>);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"stdin is fd %d, too\n"</span>, fd);
  <span class="hljs-keyword">int</span> pid = getpid();
  <span class="hljs-keyword">if</span> (syscall(SYS_kcmp,<font></font>
              pid, pid, KCMP_FILE <span class="hljs-comment">/*    _FILES! */</span>,
              <span class="hljs-number">0</span> <span class="hljs-comment">/* stdin fd */</span>, fd) == <span class="hljs-number">0</span>)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"stdin\n"</span>);
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"not stdin\n"</span>);
  <span class="hljs-keyword">if</span> (syscall(SYS_kcmp,<font></font>
              pid, pid, KCMP_FILE,<font></font>
              <span class="hljs-number">1</span> <span class="hljs-comment">/* stdout fd */</span>, fd) == <span class="hljs-number">0</span>)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"stdout\n"</span>);
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"not stdout\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<pre><code class="plaintext hljs">$ ./kcmp<font></font>
stdin is fd 3, too<font></font>
stdin<font></font>
stdout</code></pre><br>
<p>  !  ,   ...</p><br>
<pre><code class="plaintext hljs">$ ls -l /proc/self/fd<font></font>
 0<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 14:45 0 -&gt; /dev/pts/17<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 14:45 1 -&gt; /dev/pts/17<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 14:45 2 -&gt; /dev/pts/17<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 14:45 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)'<font></font>
lr-x------ 1 trosinenko trosinenko 64  10 14:45 3 -&gt; /proc/17265/fd<font></font>
lrwx------ 1 trosinenko trosinenko 64  10 14:45 57 -&gt; 'socket:[41036]'</code></pre><br>
<p>,   ,   ,  ,       .  ,  bash        ,    <code>ls</code>!</p><br>
<pre><code class="plaintext hljs">$ ./kcmp &lt; kcmp.c<font></font>
stdin is fd 3, too<font></font>
stdin<font></font>
not stdout</code></pre><br>
<p>  ,       —         -,   best effort   -    .</p><br>
<h2 id="obo-vsyom-i-ponemnozhku">   </h2><br>
<p>  , ...</p><br>
<ul>
<li>…      JIT-    userspace?  ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> eBPF-</a>.       ,  ( ,   ,      -)  . .,    JIT-,  . ,      , BPF.</li>
<li>…        ?  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>sigaltstack</code></a>.</li>
<li>…       ,     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>readahead</code></a></li>
</ul><br>
<p>          <code>oldolduname</code>...</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja475172/index.html">Raspberry Piを有益に使用する5つの方法 パート3</a></li>
<li><a href="../ja475174/index.html">バッテリーの離陸方法または電気パラモーターの小さな理論。パート1</a></li>
<li><a href="../ja475178/index.html">PostgreSQLでのEAVのJSONBへの置き換え</a></li>
<li><a href="../ja475180/index.html">バッテリーの離陸方法、またはSkyMax電気パラモーターの操作方法。パート2</a></li>
<li><a href="../ja475182/index.html">データのような機械学習の競争をどのように決定したか</a></li>
<li><a href="../ja475188/index.html">制約ベースのタイル配置アルゴリズム</a></li>
<li><a href="../ja475192/index.html">地球温暖化防止に役立つ会社での仕事を見つけるには？</a></li>
<li><a href="../ja475194/index.html">SOLIDによるreduxの記述</a></li>
<li><a href="../ja475196/index.html">モバイル＃321開発者向けの興味深い資料のダイジェスト（11月4〜10日）</a></li>
<li><a href="../ja475200/index.html">OpenStreetMap No. 484の世界からのニュース（10/10/2019-28/10/2019）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>