<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💭 🥘 👨🏾‍🍳 Wie kann man gefährliches Refactoring einführen, um mit einer Million Benutzern zu arbeiten? 🙇🏽 👩🏼 🐬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Film "Flugzeug", 1980. 
 
 So fühlte ich mich, als ich ein weiteres Refactoring auf das Produkt goss. Selbst wenn Sie den gesamten Code mit Metrik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wie kann man gefährliches Refactoring einführen, um mit einer Million Benutzern zu arbeiten?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Film "Flugzeug", 1980. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So fühlte ich mich, als ich ein weiteres Refactoring auf das Produkt goss. </font><font style="vertical-align: inherit;">Selbst wenn Sie den gesamten Code mit Metriken und Protokollen abdecken, testen Sie die Funktionalität in allen Umgebungen - dies spart nach der Bereitstellung nicht 100% der Fakaps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Fakap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Irgendwie haben wir unsere Verarbeitung der Integration mit Google Sheets überarbeitet. Für Benutzer ist dies eine sehr wertvolle Funktion, weil Sie verwenden viele Tools gleichzeitig, die miteinander verknüpft werden müssen - Kontakte an eine Tabelle senden, Antworten auf Fragen hochladen, Benutzer exportieren usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Integrationscode wurde von der ersten Version an nicht überarbeitet und es wurde immer schwieriger, ihn zu warten. Dies wirkte sich auf unsere Benutzer aus - alte Fehler wurden aufgedeckt, die wir aufgrund der Komplexität des Codes nicht bearbeiten konnten. Es ist Zeit, etwas dagegen zu unternehmen. Es wurden keine logischen Änderungen angenommen - schreiben Sie einfach Tests, verschieben Sie Klassen und Kammnamen. Natürlich haben wir die Funktionalität in der Entwicklungsumgebung getestet und sind zur Bereitstellung gegangen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach 20 Minuten schrieben die Benutzer, dass die Integration nicht funktioniert habe. </font><font style="vertical-align: inherit;">Die Funktionalität zum Senden von Daten an Google Sheet hat sich verschlechtert. Es stellte sich heraus, dass wir zum Debuggen Daten in verschiedenen Formaten für den Vertrieb und lokale Umgebungen senden. </font><font style="vertical-align: inherit;">Beim Refactoring treffen wir das Verkaufsformat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben die Integration behoben, aber das Sediment vom fröhlichen Freitagabend (und Sie dachten!) Blieb trotzdem. </font><font style="vertical-align: inherit;">Rückblickend (Treffen mit dem Team, um den Sprint abzuschließen) begannen wir darüber nachzudenken, wie solche Situationen in Zukunft verhindert werden können. Wir müssen die Praxis des manuellen Testens, des automatischen Testens, der Arbeit mit Metriken und Alarmen verbessern, und außerdem kamen wir auf die Idee, Feature-Flags zum Testen des Refactorings zu verwenden In der Tat wird dies diskutiert.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Schema ist einfach: Wenn der Benutzer das Flag aktiviert hat, wechseln Sie zum Code mit der neuen Version, wenn nicht, zum Code mit der alten Version:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Ansatz haben wir die Möglichkeit, das Refactoring auf Prod zuerst an uns selbst und dann an den Benutzern zu testen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast von Beginn des Projekts an hatten wir eine primitive Implementierung der Flags-Funktion. </font><font style="vertical-align: inherit;">In der Datenbank für zwei grundlegende Entitäten, Benutzer und Konto, wurden Feature-Felder hinzugefügt, die eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitmaske waren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Im Code haben wir neue Konstanten für Features registriert, die wir dann zur Maske hinzugefügt haben, wenn dem Benutzer ein bestimmtes Feature zur Verfügung steht.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Verwendung im Code sah folgendermaßen aus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Refactoring öffnen wir normalerweise zuerst das Flag für das Team zum Testen, dann für mehrere Benutzer, die die Funktion aktiv nutzen, und öffnen sie schließlich für alle, aber manchmal komplexeren Schemata, mehr dazu weiter unten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Überladenes Place Refactoring</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines unserer Systeme akzeptiert Facebook-Webhooks und verarbeitet sie über die Warteschlange. Die Warteschlangenverarbeitung wurde nicht mehr ausgeführt, und Benutzer erhielten bestimmte Nachrichten mit einer Verzögerung, was die Erfahrung von Bot-Abonnenten erheblich beeinträchtigen könnte. Wir haben begonnen, diesen Ort umzugestalten, indem wir die Verarbeitung in ein komplexeres Warteschlangenschema übertragen haben. Der Ort ist kritisch - es ist gefährlich, neue Logik auf alle Server zu übertragen, daher haben wir die neue Logik unter dem Flag geschlossen und konnten sie auf dem Produkt testen. Aber was passiert, wenn wir diese Flagge überhaupt öffnen? Wie wird sich unsere Infrastruktur verhalten? Dieses Mal haben wir das Öffnen des Flags auf den Servern bereitgestellt und die Metriken befolgt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle kritischen Datenverarbeitungen haben wir in Cluster unterteilt. </font><font style="vertical-align: inherit;">Jeder Cluster hat eine ID. </font><font style="vertical-align: inherit;">Wir haben beschlossen, das Testen eines derart komplexen Refactorings zu vereinfachen, indem wir die Flag-Funktion nur auf bestimmten Servern öffnen. Die Überprüfung des Codes sieht folgendermaßen aus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst gossen wir Refactoring ein und öffneten dem Team die Flaggen. </font><font style="vertical-align: inherit;">Dann fanden wir mehrere Benutzer, die die cgt-Funktion aktiv nutzten, Flags für sie öffneten und nachschauten, ob alles für sie funktionierte. </font><font style="vertical-align: inherit;">Und schließlich begannen sie, Flags auf den Servern zu öffnen und den Metriken zu folgen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Flag cgt_refactoring_cluster_ids kann über das Admin-Panel geändert werden. </font><font style="vertical-align: inherit;">Zunächst weisen wir einem leeren Array den Wert cgt_refactoring_cluster_ids zu, fügen dann jeweils einen Cluster hinzu - [1], sehen uns die Metriken eine Weile an und fügen einen weiteren Cluster hinzu - [1, 2], bis wir das gesamte System testen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfiguration des Konfigurators</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde ein wenig darüber sprechen, was Configurator ist und wie es implementiert wird. </font><font style="vertical-align: inherit;">Es wurde geschrieben, um die Logik ohne Bereitstellung ändern zu können, beispielsweise wie im obigen Fall, wenn die Logik scharf zurückgesetzt werden muss. </font><font style="vertical-align: inherit;">Wir verwenden es auch für dynamische Konfigurationen. Wenn Sie beispielsweise verschiedene Caching-Zeiten testen müssen, können Sie es für schnelle Tests herausnehmen. </font><font style="vertical-align: inherit;">Für den Entwickler sieht dies wie eine Liste von Feldern mit Administratorwerten aus, die geändert werden können. </font><font style="vertical-align: inherit;">Wir speichern dies alles in einer Datenbank, zwischenspeichern in Redis und in einer Statistik für unsere Mitarbeiter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring veralteter Standorte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im nächsten Quartal haben wir die Registrierungslogik überarbeitet und sie auf den Übergang zur Möglichkeit der Registrierung über mehrere Dienste vorbereitet. </font><font style="vertical-align: inherit;">Unter unseren Bedingungen ist es unmöglich, die Registrierungslogik so zu gruppieren, dass ein bestimmter Benutzer an eine bestimmte Logik gebunden ist, und wir haben nichts Besseres gefunden, als die Logik zu testen und einen Prozentsatz aller Registrierungsanforderungen bereitzustellen. </font><font style="vertical-align: inherit;">Dies ist auf ähnliche Weise mit Flags einfach möglich:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend haben wir den Wert von auth_refactoring_percentage im Admin-Bereich von 0 auf 100 festgelegt. Natürlich haben wir die gesamte Autorisierungslogik mit Metriken "verschmiert", um zu verstehen, dass wir die Konvertierung am Ende nicht reduziert haben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metriken</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu erklären, wie wir beim Öffnen von Flags Metriken folgen, werden wir einen anderen Fall genauer betrachten. </font><font style="vertical-align: inherit;">ManyChat akzeptiert Facebook-Hooks von Facebook, wenn ein Abonnent eine Nachricht an Facebook Messenger sendet. </font><font style="vertical-align: inherit;">Wir müssen jede Nachricht gemäß der Geschäftslogik verarbeiten. </font><font style="vertical-align: inherit;">Für die cgt-Funktion müssen wir bestimmen, ob der Abonnent die Konversation durch einen Kommentar auf Facebook gestartet hat, um ihm als Antwort eine relevante Nachricht zu senden. </font><font style="vertical-align: inherit;">Im Code sieht es so aus, als würde der Kontext des aktuellen Abonnenten bestimmt. Wenn wir die Widget-ID ermitteln können, ermitteln wir die Antwortnachricht daraus.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mehr zur Funktion</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      —    .        Widget,   :<br>
<br>
  —&gt;     —&gt;     —&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  —&gt;    —&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     “ , !”   ,        .   ,     “  !”   id       ,     —   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuvor haben wir den Kontext auf drei Arten definiert. Er sah ungefähr so ​​aus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Watcher-Service sendet zum Zeitpunkt des Spiels Analysen. Wir hatten Metriken für alle drei Fälle: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Häufigkeit, mit der</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der </font><i><font style="vertical-align: inherit;">Kontext durch verschiedene zeitliche Verknüpfungsmethoden gefunden wurde.</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Als Nächstes haben wir eine andere Übereinstimmungsmethode gefunden, die alle alten Optionen ersetzen sollte. </font><font style="vertical-align: inherit;">Um dies zu testen, haben wir eine andere Metrik erhalten:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Stadium möchten wir sicherstellen, dass die Anzahl der neuen Treffer der Summe der alten Treffer entspricht. Schreiben Sie also einfach die Metrik, ohne $ widgetId zurückzugeben: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzahl der von der neuen Methode gefundenen Kontexte deckt die Summe der Bindungen der alten Methoden vollständig ab.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dies garantiert uns jedoch nicht in allen Fällen die richtige Übereinstimmungslogik. </font><font style="vertical-align: inherit;">Der nächste Schritt ist das schrittweise Testen durch Öffnen von Flaggen:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann begann der Testprozess: Zuerst testeten wir die neue Funktionalität selbst in allen Umgebungen und an zufälligen Benutzern, die häufig Matching verwenden, indem wir das Flag UserFeatures :: ALLOW_CGT_MATCHING_BY_ECHO öffnen. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt haben wir einige Fälle festgestellt, in denen das Match nicht ordnungsgemäß funktioniert hat, und sie repariert. </font><font style="vertical-align: inherit;">Dann wurde mit der Einführung auf Servern begonnen: Im Durchschnitt haben wir einen Server an einem Tag in der Woche eingeführt. </font><font style="vertical-align: inherit;">Vor dem Testen warnen wir den Support, dass er sich die Tickets im Zusammenhang mit der Funktionalität genau ansieht und uns über eventuelle Kuriositäten schreibt. </font><font style="vertical-align: inherit;">Dank Support und Benutzern konnten mehrere Eckfälle behoben werden. </font><font style="vertical-align: inherit;">Und schließlich ist der letzte Schritt die Entdeckung aller bedingungslos:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neue Implementierung der Flaggenfunktion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Implementierung der Flaggenfunktion, die zu Beginn des Artikels beschrieben wurde, hat uns ungefähr 3 Jahre lang gedient, aber mit dem Wachstum der Teams wurde es unangenehm - wir mussten sie beim Erstellen jeder Flagge bereitstellen und vergessen nicht, den Wert der Flaggen zu löschen (wir haben konstante Werte für verschiedene Funktionen wiederverwendet). </font><font style="vertical-align: inherit;">Vor kurzem wurde die Komponente neu geschrieben und jetzt können wir Flags über das Admin-Panel flexibel verwalten. </font><font style="vertical-align: inherit;">Flags wurden von der Bitmaske gelöst und in einer separaten Tabelle gespeichert - dies erleichtert das Erstellen neuer Flags. </font><font style="vertical-align: inherit;">Jeder Eintrag hat auch eine Beschreibung und einen Eigentümer. Das Flaggenmanagement ist transparenter geworden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachteile solcher Ansätze</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Ansatz hat ein großes Minus: Es gibt zwei Versionen des Codes, die gleichzeitig unterstützt werden müssen. </font><font style="vertical-align: inherit;">Beim Testen müssen Sie berücksichtigen, dass es zwei Zweige der Logik gibt, und Sie müssen alle überprüfen, und dies ist sehr schmerzhaft. </font><font style="vertical-align: inherit;">Während der Entwicklung gab es Situationen, in denen wir einen Fix in eine Logik einführten, aber einen anderen vergaßen und irgendwann schossen. </font><font style="vertical-align: inherit;">Daher wenden wir diesen Ansatz nur an kritischen Stellen an und versuchen, die alte Version des Codes so schnell wie möglich zu entfernen. </font><font style="vertical-align: inherit;">Wir versuchen, den Rest des Refactorings in kleinen Iterationen durchzuführen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der aktuelle Prozess sieht folgendermaßen aus: Zuerst schließen wir die Logik unter den Bedingungen der Flags, stellen sie dann bereit und beginnen, die Flags schrittweise zu öffnen. Beim Erweitern von Flags überwachen wir Fehler und Metriken genau, sobald etwas schief geht. Setzen Sie das Flag sofort zurück und beheben Sie das Problem. Das Plus ist, dass das Öffnen / Schließen des Flags sehr schnell geht - es ist nur eine Änderung des Werts im Admin-Bereich. Nach einiger Zeit haben wir die alte Version des Codes herausgeschnitten. Dies sollte die Mindestzeit sein, um Änderungen in beiden Versionen des Codes zu verhindern. Es ist wichtig, Kollegen vor einem solchen Refactoring zu warnen. Wir haben eine Überprüfung durch Github und Verwendung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code Besitzer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> während einer </font><font style="vertical-align: inherit;">solchen Refactoring , </font><font style="vertical-align: inherit;">so dass Änderungen ohne das Wissen des Autors des Refactoring nicht in den Code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuletzt habe ich eine neue Version der Facebook Graph API eingeführt. </font><font style="vertical-align: inherit;">In einer Sekunde stellen wir mehr als 3000 Anfragen an die API und jeder Fehler ist für uns teuer. </font><font style="vertical-align: inherit;">Daher habe ich die Änderung mit minimaler Auswirkung unter der Flagge eingeführt - es stellte sich heraus, dass ein unangenehmer Fehler aufgetreten ist, die neue Version getestet und schließlich ohne Sorgen vollständig darauf umgestellt wurde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499016/index.html">Integration mit ESIA für .Net: einfacher als es sich anhört</a></li>
<li><a href="../de499018/index.html">6 Heimsport-Apps</a></li>
<li><a href="../de499020/index.html">Eine Studie über ein vages Verhalten</a></li>
<li><a href="../de499030/index.html">Überwachung der MySQL-Leistung für Grafana auf isic in 20 Minuten</a></li>
<li><a href="../de499032/index.html">Verwendung von Prometheus zum Erkennen von Anomalien in GitLab</a></li>
<li><a href="../de499036/index.html">Arbeit des Anbieters: eine Auswahl von Materialien zu Protokollen, IT und Netzwerkinfrastruktur</a></li>
<li><a href="../de499038/index.html">Meine Erfahrung mit einem vertikalen Monitor</a></li>
<li><a href="../de499040/index.html">Lesen Sie am Wochenende: Eine Auswahl von Materialien zur Geschichte von DNS, IT-Regulierung und Hardware 1cloud.ru</a></li>
<li><a href="../de499044/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 508 (04/07/2020/13/04/2020)</a></li>
<li><a href="../de499046/index.html">Cybercalmar Neuroevolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>