<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí≠ ü•ò üë®üèæ‚Äçüç≥ Wie kann man gef√§hrliches Refactoring einf√ºhren, um mit einer Million Benutzern zu arbeiten? üôáüèΩ üë©üèº üê¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Film "Flugzeug", 1980. 
 
 So f√ºhlte ich mich, als ich ein weiteres Refactoring auf das Produkt goss. Selbst wenn Sie den gesamten Code mit Metrik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wie kann man gef√§hrliches Refactoring einf√ºhren, um mit einer Million Benutzern zu arbeiten?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Film "Flugzeug", 1980. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So f√ºhlte ich mich, als ich ein weiteres Refactoring auf das Produkt goss. </font><font style="vertical-align: inherit;">Selbst wenn Sie den gesamten Code mit Metriken und Protokollen abdecken, testen Sie die Funktionalit√§t in allen Umgebungen - dies spart nach der Bereitstellung nicht 100% der Fakaps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Fakap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Irgendwie haben wir unsere Verarbeitung der Integration mit Google Sheets √ºberarbeitet. F√ºr Benutzer ist dies eine sehr wertvolle Funktion, weil Sie verwenden viele Tools gleichzeitig, die miteinander verkn√ºpft werden m√ºssen - Kontakte an eine Tabelle senden, Antworten auf Fragen hochladen, Benutzer exportieren usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Integrationscode wurde von der ersten Version an nicht √ºberarbeitet und es wurde immer schwieriger, ihn zu warten. Dies wirkte sich auf unsere Benutzer aus - alte Fehler wurden aufgedeckt, die wir aufgrund der Komplexit√§t des Codes nicht bearbeiten konnten. Es ist Zeit, etwas dagegen zu unternehmen. Es wurden keine logischen √Ñnderungen angenommen - schreiben Sie einfach Tests, verschieben Sie Klassen und Kammnamen. Nat√ºrlich haben wir die Funktionalit√§t in der Entwicklungsumgebung getestet und sind zur Bereitstellung gegangen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach 20 Minuten schrieben die Benutzer, dass die Integration nicht funktioniert habe. </font><font style="vertical-align: inherit;">Die Funktionalit√§t zum Senden von Daten an Google Sheet hat sich verschlechtert. Es stellte sich heraus, dass wir zum Debuggen Daten in verschiedenen Formaten f√ºr den Vertrieb und lokale Umgebungen senden. </font><font style="vertical-align: inherit;">Beim Refactoring treffen wir das Verkaufsformat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben die Integration behoben, aber das Sediment vom fr√∂hlichen Freitagabend (und Sie dachten!) Blieb trotzdem. </font><font style="vertical-align: inherit;">R√ºckblickend (Treffen mit dem Team, um den Sprint abzuschlie√üen) begannen wir dar√ºber nachzudenken, wie solche Situationen in Zukunft verhindert werden k√∂nnen. Wir m√ºssen die Praxis des manuellen Testens, des automatischen Testens, der Arbeit mit Metriken und Alarmen verbessern, und au√üerdem kamen wir auf die Idee, Feature-Flags zum Testen des Refactorings zu verwenden In der Tat wird dies diskutiert.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Schema ist einfach: Wenn der Benutzer das Flag aktiviert hat, wechseln Sie zum Code mit der neuen Version, wenn nicht, zum Code mit der alten Version:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Ansatz haben wir die M√∂glichkeit, das Refactoring auf Prod zuerst an uns selbst und dann an den Benutzern zu testen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast von Beginn des Projekts an hatten wir eine primitive Implementierung der Flags-Funktion. </font><font style="vertical-align: inherit;">In der Datenbank f√ºr zwei grundlegende Entit√§ten, Benutzer und Konto, wurden Feature-Felder hinzugef√ºgt, die eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitmaske waren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Im Code haben wir neue Konstanten f√ºr Features registriert, die wir dann zur Maske hinzugef√ºgt haben, wenn dem Benutzer ein bestimmtes Feature zur Verf√ºgung steht.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Verwendung im Code sah folgenderma√üen aus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Refactoring √∂ffnen wir normalerweise zuerst das Flag f√ºr das Team zum Testen, dann f√ºr mehrere Benutzer, die die Funktion aktiv nutzen, und √∂ffnen sie schlie√ülich f√ºr alle, aber manchmal komplexeren Schemata, mehr dazu weiter unten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberladenes Place Refactoring</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines unserer Systeme akzeptiert Facebook-Webhooks und verarbeitet sie √ºber die Warteschlange. Die Warteschlangenverarbeitung wurde nicht mehr ausgef√ºhrt, und Benutzer erhielten bestimmte Nachrichten mit einer Verz√∂gerung, was die Erfahrung von Bot-Abonnenten erheblich beeintr√§chtigen k√∂nnte. Wir haben begonnen, diesen Ort umzugestalten, indem wir die Verarbeitung in ein komplexeres Warteschlangenschema √ºbertragen haben. Der Ort ist kritisch - es ist gef√§hrlich, neue Logik auf alle Server zu √ºbertragen, daher haben wir die neue Logik unter dem Flag geschlossen und konnten sie auf dem Produkt testen. Aber was passiert, wenn wir diese Flagge √ºberhaupt √∂ffnen? Wie wird sich unsere Infrastruktur verhalten? Dieses Mal haben wir das √ñffnen des Flags auf den Servern bereitgestellt und die Metriken befolgt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle kritischen Datenverarbeitungen haben wir in Cluster unterteilt. </font><font style="vertical-align: inherit;">Jeder Cluster hat eine ID. </font><font style="vertical-align: inherit;">Wir haben beschlossen, das Testen eines derart komplexen Refactorings zu vereinfachen, indem wir die Flag-Funktion nur auf bestimmten Servern √∂ffnen. Die √úberpr√ºfung des Codes sieht folgenderma√üen aus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst gossen wir Refactoring ein und √∂ffneten dem Team die Flaggen. </font><font style="vertical-align: inherit;">Dann fanden wir mehrere Benutzer, die die cgt-Funktion aktiv nutzten, Flags f√ºr sie √∂ffneten und nachschauten, ob alles f√ºr sie funktionierte. </font><font style="vertical-align: inherit;">Und schlie√ülich begannen sie, Flags auf den Servern zu √∂ffnen und den Metriken zu folgen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Flag cgt_refactoring_cluster_ids kann √ºber das Admin-Panel ge√§ndert werden. </font><font style="vertical-align: inherit;">Zun√§chst weisen wir einem leeren Array den Wert cgt_refactoring_cluster_ids zu, f√ºgen dann jeweils einen Cluster hinzu - [1], sehen uns die Metriken eine Weile an und f√ºgen einen weiteren Cluster hinzu - [1, 2], bis wir das gesamte System testen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfiguration des Konfigurators</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde ein wenig dar√ºber sprechen, was Configurator ist und wie es implementiert wird. </font><font style="vertical-align: inherit;">Es wurde geschrieben, um die Logik ohne Bereitstellung √§ndern zu k√∂nnen, beispielsweise wie im obigen Fall, wenn die Logik scharf zur√ºckgesetzt werden muss. </font><font style="vertical-align: inherit;">Wir verwenden es auch f√ºr dynamische Konfigurationen. Wenn Sie beispielsweise verschiedene Caching-Zeiten testen m√ºssen, k√∂nnen Sie es f√ºr schnelle Tests herausnehmen. </font><font style="vertical-align: inherit;">F√ºr den Entwickler sieht dies wie eine Liste von Feldern mit Administratorwerten aus, die ge√§ndert werden k√∂nnen. </font><font style="vertical-align: inherit;">Wir speichern dies alles in einer Datenbank, zwischenspeichern in Redis und in einer Statistik f√ºr unsere Mitarbeiter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring veralteter Standorte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im n√§chsten Quartal haben wir die Registrierungslogik √ºberarbeitet und sie auf den √úbergang zur M√∂glichkeit der Registrierung √ºber mehrere Dienste vorbereitet. </font><font style="vertical-align: inherit;">Unter unseren Bedingungen ist es unm√∂glich, die Registrierungslogik so zu gruppieren, dass ein bestimmter Benutzer an eine bestimmte Logik gebunden ist, und wir haben nichts Besseres gefunden, als die Logik zu testen und einen Prozentsatz aller Registrierungsanforderungen bereitzustellen. </font><font style="vertical-align: inherit;">Dies ist auf √§hnliche Weise mit Flags einfach m√∂glich:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend haben wir den Wert von auth_refactoring_percentage im Admin-Bereich von 0 auf 100 festgelegt. Nat√ºrlich haben wir die gesamte Autorisierungslogik mit Metriken "verschmiert", um zu verstehen, dass wir die Konvertierung am Ende nicht reduziert haben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metriken</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu erkl√§ren, wie wir beim √ñffnen von Flags Metriken folgen, werden wir einen anderen Fall genauer betrachten. </font><font style="vertical-align: inherit;">ManyChat akzeptiert Facebook-Hooks von Facebook, wenn ein Abonnent eine Nachricht an Facebook Messenger sendet. </font><font style="vertical-align: inherit;">Wir m√ºssen jede Nachricht gem√§√ü der Gesch√§ftslogik verarbeiten. </font><font style="vertical-align: inherit;">F√ºr die cgt-Funktion m√ºssen wir bestimmen, ob der Abonnent die Konversation durch einen Kommentar auf Facebook gestartet hat, um ihm als Antwort eine relevante Nachricht zu senden. </font><font style="vertical-align: inherit;">Im Code sieht es so aus, als w√ºrde der Kontext des aktuellen Abonnenten bestimmt. Wenn wir die Widget-ID ermitteln k√∂nnen, ermitteln wir die Antwortnachricht daraus.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mehr zur Funktion</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      ‚Äî    .        Widget,   :<br>
<br>
  ‚Äî&gt;     ‚Äî&gt;     ‚Äî&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  ‚Äî&gt;    ‚Äî&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     ‚Äú , !‚Äù   ,        .   ,     ‚Äú  !‚Äù   id       ,     ‚Äî   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuvor haben wir den Kontext auf drei Arten definiert. Er sah ungef√§hr so ‚Äã‚Äãaus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Watcher-Service sendet zum Zeitpunkt des Spiels Analysen. Wir hatten Metriken f√ºr alle drei F√§lle: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√§ufigkeit, mit der</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der </font><i><font style="vertical-align: inherit;">Kontext durch verschiedene zeitliche Verkn√ºpfungsmethoden gefunden wurde.</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Als N√§chstes haben wir eine andere √úbereinstimmungsmethode gefunden, die alle alten Optionen ersetzen sollte. </font><font style="vertical-align: inherit;">Um dies zu testen, haben wir eine andere Metrik erhalten:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Stadium m√∂chten wir sicherstellen, dass die Anzahl der neuen Treffer der Summe der alten Treffer entspricht. Schreiben Sie also einfach die Metrik, ohne $ widgetId zur√ºckzugeben: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzahl der von der neuen Methode gefundenen Kontexte deckt die Summe der Bindungen der alten Methoden vollst√§ndig ab.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dies garantiert uns jedoch nicht in allen F√§llen die richtige √úbereinstimmungslogik. </font><font style="vertical-align: inherit;">Der n√§chste Schritt ist das schrittweise Testen durch √ñffnen von Flaggen:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann begann der Testprozess: Zuerst testeten wir die neue Funktionalit√§t selbst in allen Umgebungen und an zuf√§lligen Benutzern, die h√§ufig Matching verwenden, indem wir das Flag UserFeatures :: ALLOW_CGT_MATCHING_BY_ECHO √∂ffnen. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt haben wir einige F√§lle festgestellt, in denen das Match nicht ordnungsgem√§√ü funktioniert hat, und sie repariert. </font><font style="vertical-align: inherit;">Dann wurde mit der Einf√ºhrung auf Servern begonnen: Im Durchschnitt haben wir einen Server an einem Tag in der Woche eingef√ºhrt. </font><font style="vertical-align: inherit;">Vor dem Testen warnen wir den Support, dass er sich die Tickets im Zusammenhang mit der Funktionalit√§t genau ansieht und uns √ºber eventuelle Kuriosit√§ten schreibt. </font><font style="vertical-align: inherit;">Dank Support und Benutzern konnten mehrere Eckf√§lle behoben werden. </font><font style="vertical-align: inherit;">Und schlie√ülich ist der letzte Schritt die Entdeckung aller bedingungslos:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neue Implementierung der Flaggenfunktion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Implementierung der Flaggenfunktion, die zu Beginn des Artikels beschrieben wurde, hat uns ungef√§hr 3 Jahre lang gedient, aber mit dem Wachstum der Teams wurde es unangenehm - wir mussten sie beim Erstellen jeder Flagge bereitstellen und vergessen nicht, den Wert der Flaggen zu l√∂schen (wir haben konstante Werte f√ºr verschiedene Funktionen wiederverwendet). </font><font style="vertical-align: inherit;">Vor kurzem wurde die Komponente neu geschrieben und jetzt k√∂nnen wir Flags √ºber das Admin-Panel flexibel verwalten. </font><font style="vertical-align: inherit;">Flags wurden von der Bitmaske gel√∂st und in einer separaten Tabelle gespeichert - dies erleichtert das Erstellen neuer Flags. </font><font style="vertical-align: inherit;">Jeder Eintrag hat auch eine Beschreibung und einen Eigent√ºmer. Das Flaggenmanagement ist transparenter geworden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachteile solcher Ans√§tze</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Ansatz hat ein gro√ües Minus: Es gibt zwei Versionen des Codes, die gleichzeitig unterst√ºtzt werden m√ºssen. </font><font style="vertical-align: inherit;">Beim Testen m√ºssen Sie ber√ºcksichtigen, dass es zwei Zweige der Logik gibt, und Sie m√ºssen alle √ºberpr√ºfen, und dies ist sehr schmerzhaft. </font><font style="vertical-align: inherit;">W√§hrend der Entwicklung gab es Situationen, in denen wir einen Fix in eine Logik einf√ºhrten, aber einen anderen verga√üen und irgendwann schossen. </font><font style="vertical-align: inherit;">Daher wenden wir diesen Ansatz nur an kritischen Stellen an und versuchen, die alte Version des Codes so schnell wie m√∂glich zu entfernen. </font><font style="vertical-align: inherit;">Wir versuchen, den Rest des Refactorings in kleinen Iterationen durchzuf√ºhren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der aktuelle Prozess sieht folgenderma√üen aus: Zuerst schlie√üen wir die Logik unter den Bedingungen der Flags, stellen sie dann bereit und beginnen, die Flags schrittweise zu √∂ffnen. Beim Erweitern von Flags √ºberwachen wir Fehler und Metriken genau, sobald etwas schief geht. Setzen Sie das Flag sofort zur√ºck und beheben Sie das Problem. Das Plus ist, dass das √ñffnen / Schlie√üen des Flags sehr schnell geht - es ist nur eine √Ñnderung des Werts im Admin-Bereich. Nach einiger Zeit haben wir die alte Version des Codes herausgeschnitten. Dies sollte die Mindestzeit sein, um √Ñnderungen in beiden Versionen des Codes zu verhindern. Es ist wichtig, Kollegen vor einem solchen Refactoring zu warnen. Wir haben eine √úberpr√ºfung durch Github und Verwendung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code Besitzer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> w√§hrend einer </font><font style="vertical-align: inherit;">solchen Refactoring , </font><font style="vertical-align: inherit;">so dass √Ñnderungen ohne das Wissen des Autors des Refactoring nicht in den Code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuletzt habe ich eine neue Version der Facebook Graph API eingef√ºhrt. </font><font style="vertical-align: inherit;">In einer Sekunde stellen wir mehr als 3000 Anfragen an die API und jeder Fehler ist f√ºr uns teuer. </font><font style="vertical-align: inherit;">Daher habe ich die √Ñnderung mit minimaler Auswirkung unter der Flagge eingef√ºhrt - es stellte sich heraus, dass ein unangenehmer Fehler aufgetreten ist, die neue Version getestet und schlie√ülich ohne Sorgen vollst√§ndig darauf umgestellt wurde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499016/index.html">Integration mit ESIA f√ºr .Net: einfacher als es sich anh√∂rt</a></li>
<li><a href="../de499018/index.html">6 Heimsport-Apps</a></li>
<li><a href="../de499020/index.html">Eine Studie √ºber ein vages Verhalten</a></li>
<li><a href="../de499030/index.html">√úberwachung der MySQL-Leistung f√ºr Grafana auf isic in 20 Minuten</a></li>
<li><a href="../de499032/index.html">Verwendung von Prometheus zum Erkennen von Anomalien in GitLab</a></li>
<li><a href="../de499036/index.html">Arbeit des Anbieters: eine Auswahl von Materialien zu Protokollen, IT und Netzwerkinfrastruktur</a></li>
<li><a href="../de499038/index.html">Meine Erfahrung mit einem vertikalen Monitor</a></li>
<li><a href="../de499040/index.html">Lesen Sie am Wochenende: Eine Auswahl von Materialien zur Geschichte von DNS, IT-Regulierung und Hardware 1cloud.ru</a></li>
<li><a href="../de499044/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 508 (04/07/2020/13/04/2020)</a></li>
<li><a href="../de499046/index.html">Cybercalmar Neuroevolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>