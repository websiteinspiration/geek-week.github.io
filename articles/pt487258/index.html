<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∑ üé¥ üêû PHP ass√≠ncrono ü§´ üéß ü§∑üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° dez anos, t√≠nhamos uma pilha LAMP cl√°ssica: Linux, Apache, MySQL e PHP, que funcionavam no modo lento do mod_php. O mundo mudou, e com ele a import...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHP ass√≠ncrono</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/487258/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° dez anos, t√≠nhamos uma pilha LAMP cl√°ssica: Linux, Apache, MySQL e PHP, que funcionavam no modo lento do mod_php. O mundo mudou, e com ele a import√¢ncia da velocidade. Apareceu o PHP-FPM, que permitiu aumentar significativamente o desempenho das solu√ß√µes em PHP e n√£o reescrever urgentemente para algo mais r√°pido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paralelamente, a biblioteca ReactPHP estava sendo desenvolvida usando o conceito Loop de Eventos para processar sinais do SO e apresentar resultados para opera√ß√µes ass√≠ncronas. O desenvolvimento da id√©ia do ReactPHP - AMPHP. Esta biblioteca usa o mesmo loop de eventos, mas suporta corotinas, ao contr√°rio do ReactPHP. Eles permitem que voc√™ escreva c√≥digo ass√≠ncrono que pare√ßa s√≠ncrono. Talvez esta seja a estrutura mais atual para o desenvolvimento de aplicativos ass√≠ncronos em PHP.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/03/e6/tf03e6u08mt8gake9o4lbbfbdca.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a velocidade √© cada vez mais necess√°ria, as ferramentas j√° n√£o s√£o suficientes, portanto a id√©ia de programa√ß√£o ass√≠ncrona no PHP √© uma das maneiras de acelerar o processamento de consultas e utilizar melhor os recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â disso que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Shabovta vai</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> falar </font><font style="vertical-align: inherit;">(</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zloyusr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √â desenvolvedor da Onliner. </font><font style="vertical-align: inherit;">Experi√™ncia h√° mais de 10 anos: comecei com aplicativos de desktop em C / C ++ e depois mudei para o desenvolvimento web em PHP. </font><font style="vertical-align: inherit;">Ele escreve projetos "Home" em C # e Python 3 e, em PHP, est√° experimentando DDD, CQRS, Event Sourcing, Async Multitarefa.</font></font><br>
<a name="habracut"></a><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este artigo √© baseado em uma transcri√ß√£o do relat√≥rio de Anton no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nele entenderemos as opera√ß√µes de bloqueio e n√£o-bloqueio no PHP, estudaremos a estrutura do Loop de eventos e primitivas ass√≠ncronas, como Promise e coroutines, a partir de dentro. </font><font style="vertical-align: inherit;">Por fim, descobriremos o que nos espera no ext-async, AMPHP 3 e PHP 8.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/w75P9RrVgKg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduzimos algumas defini√ß√µes. </font><font style="vertical-align: inherit;">Durante muito tempo, tentei encontrar uma defini√ß√£o exata de assincronia e opera√ß√µes ass√≠ncronas, mas n√£o encontrei e escrevi as minhas.</font></font><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assincronia</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© a capacidade de um sistema de software de n√£o bloquear o thread principal de execu√ß√£o. </font></font><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma opera√ß√£o ass√≠ncrona</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma opera√ß√£o que n√£o bloqueia o fluxo de execu√ß√£o de um programa at√© sua conclus√£o.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece ser simples, mas primeiro voc√™ precisa entender quais opera√ß√µes bloqueiam o fluxo de execu√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opera√ß√µes de bloqueio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP √© uma linguagem de int√©rprete. </font><font style="vertical-align: inherit;">Ele l√™ o c√≥digo linha por linha, traduz em suas instru√ß√µes e executa. </font><font style="vertical-align: inherit;">Em qual linha do exemplo abaixo o c√≥digo ser√° bloqueado?</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params">User $user</span>)
</span>{
    <span class="hljs-keyword">try</span> {<font></font>
        $sql = <span class="hljs-string">'UPDATE users SET ...'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;connection-&gt;execute($sql, $user-&gt;data());<font></font>
    } <span class="hljs-keyword">catch</span> (\PDOException $error) {<font></font>
        log($error-&gt;getMessage());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se conectar ao banco de dados via PDO, o segmento de execu√ß√£o ser√° bloqueado na cadeia de consulta para SQL-servidor: </font></font><code>return $this-&gt;connection-&gt;execute($sql, $user-&gt;data());</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso ocorre porque o PHP n√£o sabe por quanto tempo o servidor SQL processar√° essa consulta e se ser√° executada. </font><font style="vertical-align: inherit;">Aguarda uma resposta do servidor e todo esse tempo o programa n√£o est√° sendo executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O PHP tamb√©m bloqueia o fluxo de execu√ß√£o em todas as opera√ß√µes de E / S.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistema de arquivos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>fwrite</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>file_get_contents</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Quase todas as extens√µes para conectar um banco de dados funcionam no modo de bloqueio por padr√£o.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>exec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>proc_open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Essas s√£o opera√ß√µes de bloqueio, pois todo o trabalho com processos √© criado por meio de chamadas do sistema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalhando com stdin / stdout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>readline</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>echo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, a execu√ß√£o √© bloqueada nos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporizadores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>usleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Essas s√£o opera√ß√µes nas quais explicitamente dizemos ao thread para adormecer por um tempo. </font><font style="vertical-align: inherit;">O PHP ficar√° ocioso esse tempo todo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente SQL ass√≠ncrono</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o PHP moderno √© uma linguagem de uso geral, e n√£o apenas para a web como PHP / FI em 1997. </font><font style="vertical-align: inherit;">Portanto, podemos escrever um cliente SQL ass√≠ncrono do zero. </font><font style="vertical-align: inherit;">A tarefa n√£o √© a mais trivial, mas solucion√°vel.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    <font></font>
    socket_write($socket, $data, strlen($data));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que esse cliente faz? </font><font style="vertical-align: inherit;">Ele se conecta ao nosso servidor SQL, coloca o soquete no modo sem bloqueio, empacota a solicita√ß√£o em um formato bin√°rio que o servidor SQL entende, grava dados no soquete. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o soquete est√° no modo sem bloqueio, a opera√ß√£o de grava√ß√£o do PHP √© r√°pida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o que retornar√° como resultado dessa opera√ß√£o? </font><font style="vertical-align: inherit;">N√£o sabemos o que o servidor SQL responder√°. </font><font style="vertical-align: inherit;">Pode levar muito tempo para concluir a solicita√ß√£o ou n√£o. </font><font style="vertical-align: inherit;">Mas algo precisa ser devolvido? </font><font style="vertical-align: inherit;">Se usarmos o PDO e chamarmos a </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulta no servidor SQL, retornaremos </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de linhas alteradas por essa consulta. </font><font style="vertical-align: inherit;">Ainda n√£o podemos devolv√™-lo, portanto, apenas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prometemos um</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retorno.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promessa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um conceito do mundo da programa√ß√£o ass√≠ncrona.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promise √© um objeto wrapper sobre o resultado de uma opera√ß√£o ass√≠ncrona. </font><font style="vertical-align: inherit;">Al√©m disso, o resultado da opera√ß√£o ainda √© desconhecido para n√≥s.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, n√£o existe um padr√£o √∫nico da Promise e n√£o √© poss√≠vel transferir padr√µes diretamente do mundo JavaScript para o PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a promessa funciona</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ainda n√£o h√° resultado, s√≥ podemos estabelecer alguns </font></font><code>callbacks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/n1/qq/ian1qqvr_xs0faonifptkfrd2jc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando os dados est√£o dispon√≠veis, √© necess√°rio executar um retorno de chamada </font></font><code>onResolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/bk/sf/8vbksfxvsfxskeozp3jckft5rmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ocorrer um erro, um retorno de chamada ser√° executado </font></font><code>onReject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para lidar com o erro. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8x/hw/0v/8xhw0vsdhfryxyxalvsydiydfsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A interface do Promise se parece com isso.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">const</span>
        STATUS_PENDING = <span class="hljs-number">0</span>,<font></font>
        STATUS_RESOLVED = <span class="hljs-number">1</span>,<font></font>
        STATUS_REJECTED = <span class="hljs-number">2</span><font></font>
    ;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResolve</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReject</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promise possui status e m√©todos para definir retornos de chamada e preencher ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Promise com dados ou erro ( </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Mas existem diferen√ßas e varia√ß√µes. </font><font style="vertical-align: inherit;">Os m√©todos podem ser chamados de maneira diferente, ou em vez de m√©todos separados para estabelecer retornos de chamada, </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode haver algum, como no AMPHP, por exemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitas vezes, t√©cnicas para preencher o Promise </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remover em um objeto separado </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fun√ß√£o ass√≠ncrona de estado de armazenamento adiado. </font><font style="vertical-align: inherit;">Pode ser considerado como uma esp√©cie de f√°brica da Promise. </font><font style="vertical-align: inherit;">√â √∫nico: um adiado faz uma promessa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bq/on/aq/bqonaqi04ql4kdhakfezn9nu25g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como aplicar isso no cliente SQL se decidirmos escrev√™-lo n√≥s mesmos?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente SQL ass√≠ncrono</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, criamos o adiado, fizemos todo o trabalho com soquetes, anotamos os dados e retornamos o Promise - tudo √© simples.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    socket_write($socket, $data, strlen($data));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando temos o Promise, podemos, por exemplo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">defina o retorno de chamada e obtenha os </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que retornam para n√≥s </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lidar com o erro, adicione ao log;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repita a consulta se o servidor SQL responder com um erro.</font></font></li>
</ul><br>
<pre><code class="php hljs">$promise = <span class="hljs-keyword">$this</span>-&gt;execAsync($sql, $user-&gt;data());<font></font>
<font></font>
$promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">int</span> $rows</span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Affected rows: {$rows}"</span>;<font></font>
});<font></font>
<font></font>
$promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>) </span>{<font></font>
    log($error-&gt;getMessage());<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quest√£o permanece: definimos o retorno de chamada, e quem ligar√° </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loop de eventos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe o conceito de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">eventos - um loop de eventos</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele √© capaz de processar mensagens em um ambiente ass√≠ncrono. </font><font style="vertical-align: inherit;">Para E / S ass√≠ncrona, essas ser√£o mensagens do sistema operacional que o soquete est√° pronto para ler ou gravar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como funciona.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cliente diz ao Event Loop que est√° interessado em algum tipo de soquete.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Loop de Eventos pesquisa o SO por meio de uma chamada do sistema </font></font><code>stream_select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: o soquete est√° pronto, todos os dados gravados, s√£o os dados provenientes do outro lado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o SO reportar que o soquete n√£o est√° pronto, bloqueado, o Event Loop repetir√° o loop.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o sistema operacional notifica que o soquete est√° pronto, o Event Loop retorna o controle ao cliente e ativa ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Promise.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ln/ey/bb/lneybbz-tylmfanfoizqm2hscik.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expressamos esse conceito no c√≥digo: pegue o caso mais simples, remova o tratamento de erros e outras nuances, para que um loop infinito permane√ßa. </font><font style="vertical-align: inherit;">Em cada itera√ß√£o, ele pesquisar√° o SO sobre soquetes prontos para leitura ou grava√ß√£o e chamar√° um retorno de chamada para um soquete espec√≠fico.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<font></font>
        stream_select($readSockets, $writeSockets, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">foreach</span> ($readSockets <span class="hljs-keyword">as</span> $i =&gt; $socket) {<font></font>
            call_user_func(<span class="hljs-built_in">self</span>::readCallbacks[$i], $socket);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">// Do same for write sockets</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Complementamos nosso cliente SQL. </font><font style="vertical-align: inherit;">Informamos ao Event Loop que, assim que os dados do servidor SQL chegarem ao soquete com o qual estamos trabalhando, precisamos trazer o adiado para o estado "conclu√≠do" e transferir os dados do soquete para o Promise.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
    ...<font></font>
    Loop::onReadable($socket, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$socket</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$deferred</span>) </span>{<font></font>
        $deferred-&gt;resolve(socket_read($socket));<font></font>
    });<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Event Loop </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode manipular nossa E / S</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona com soquetes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O que mais ele pode fazer?</font></font><br>
<br>
<ul>
<li> JavaScript   <code>setTimeout</code>  <code>setInterval</code> ‚Äî .             N . <strong>Event Loop      </strong>.</li>
<li>Event Loop  <strong>   </strong>.    <code>process control</code>,       .</li>
</ul><br>
<h3> Event Loop</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrever seu loop de eventos n√£o √© apenas poss√≠vel, mas tamb√©m necess√°rio. Se voc√™ deseja trabalhar com PHP ass√≠ncrono, √© importante escrever sua pr√≥pria implementa√ß√£o simples para entender como isso funciona. Mas na produ√ß√£o, √© claro, n√£o o usaremos, mas tomaremos implementa√ß√µes prontas: est√°veis, sem erros e comprovadas no trabalho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem tr√™s implementa√ß√µes principais. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O projeto mais antigo, iniciado no PHP 5.3. Agora a vers√£o m√≠nima exigida do PHP √© 5.3.8. O projeto implementa o padr√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promises / A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do mundo JavaScript. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √â essa implementa√ß√£o que eu prefiro usar. O requisito m√≠nimo √© o PHP 7.0, e desde a pr√≥xima vers√£o j√° √© 7.3. Ele usa corotinas em cima do Promise. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Essa √© uma estrutura chinesa interessante, na qual os desenvolvedores tentam portar alguns conceitos do mundo Go para PHP. </font><font style="vertical-align: inherit;">A documenta√ß√£o em ingl√™s est√° incompleta, a maior parte no GitHub em chin√™s. </font><font style="vertical-align: inherit;">Se voc√™ conhece o idioma, v√° em frente, mas at√© agora estou com medo de trabalhar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/n3/cq/zon3cqtbmsf-vnd0uliqqupphoo.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como ser√° o cliente usando o ReactPHP for MySQL.</font></font><br>
<br>
<pre><code class="php hljs">$connection = (<span class="hljs-keyword">new</span> ConnectionFactory)-&gt;createLazyConnection();<font></font>
<font></font>
$promise = $connection-&gt;query(<span class="hljs-string">'UPDATE users SET ...'</span>);<font></font>
$promise-&gt;then(<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© quase o mesmo que escrevemos: criamos </font></font><code>onnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e executamos a solicita√ß√£o. </font><font style="vertical-align: inherit;">Podemos definir o retorno de chamada para processar os resultados (retorno </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e retorno de chamada para tratamento de erros:</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir desses retornos de chamada, voc√™ pode construir cadeias longas, porque cada resultado </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no ReactPHP tamb√©m retorna Promise.</font></font><br>
<br>
<pre><code class="php hljs">$promise<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise(...);<font></font>
    })<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{<font></font>
        ...<font></font>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) </span>{<font></font>
        log($error);<font></font>
    })<font></font>
    ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma solu√ß√£o para um problema chamado inferno de retorno de chamada. </font><font style="vertical-align: inherit;">Infelizmente, na implementa√ß√£o do ReactPHP, isso leva ao problema "Inferno da promessa", quando </font><strong><font style="vertical-align: inherit;">s√£o </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rios </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 a 11 retornos de chamada </font></font></strong><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">para conectar corretamente o RabbitMQ</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Trabalhar com esse c√≥digo e corrigi-lo √© dif√≠cil. </font><font style="vertical-align: inherit;">Eu rapidamente percebi que isso n√£o era meu e mudei para o AMPHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amphp</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este projeto √© mais novo que o ReactPHP e promove um conceito diferente - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corotinas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se voc√™ olhar para trabalhar com o MySQL no AMPHP, poder√° ver que isso √© quase o mesmo que trabalhar </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no PHP.</font></font><br>
<br>
<pre><code class="php hljs">$pool = Mysql\pool(<span class="hljs-string">"host=127.0.0.1 port=3306 db=test"</span>);<font></font>
<font></font>
<span class="hljs-keyword">try</span> {<font></font>
    $result = <span class="hljs-keyword">yield</span> $pool-&gt;query(<span class="hljs-string">"UPDATE users SET ..."</span>);<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> $result-&gt;affectedRows . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
} <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $error) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, criamos um pool, conectamos e executamos a solicita√ß√£o. </font><font style="vertical-align: inherit;">Podemos lidar com erros atrav√©s dos habituais </font></font><code>try...catch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, n√£o precisamos de retornos de chamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas antes da chamada ass√≠ncrona, a palavra-chave - aparece aqui </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geradores</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A palavra-chave </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transforma nossa fun√ß√£o em um gerador.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generator</span>(<span class="hljs-params">$counter = <span class="hljs-number">1</span></span>)
</span>{
    <span class="hljs-keyword">yield</span> $counter++;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"A"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $counter;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"B"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> ++$counter;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que o int√©rprete PHP encontra </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes no corpo, ele percebe que √© uma fun√ß√£o geradora. </font><font style="vertical-align: inherit;">Em vez de executar, um objeto de classe √© criado quando chamado </font></font><code>Generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geradores herdam a interface do iterador.</font></font><br>
<br>
<pre><code class="php hljs">$generator = <span class="hljs-built_in">generator</span>(<span class="hljs-number">1</span>);<font></font>
<font></font>
<span class="hljs-keyword">foreach</span> ($generator <span class="hljs-keyword">as</span> $value) {
    <span class="hljs-keyword">echo</span> $value;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span> ($generator-&gt;valid()) {
    <span class="hljs-keyword">echo</span> $generator-&gt;current();<font></font>
<font></font>
    $generator-&gt;next();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, √© poss√≠vel executar ciclos </font></font><code>foreach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>while</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entre outros. </font><font style="vertical-align: inherit;">Mas, mais interessante, o iterador possui m√©todos </font></font><code>current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>next</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vamos examin√°-los passo a passo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute nossa fun√ß√£o </font></font><code>generator($counter = 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Chamamos o m√©todo gerador </font></font><code>current()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O valor da vari√°vel ser√° retornado </font></font><code>$counter++</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que executarmos o gerador </font></font><code>next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o c√≥digo passar√° para a pr√≥xima chamada dentro do gerador </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Todo o c√≥digo entre os dois </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° executado, e isso √© legal. </font><font style="vertical-align: inherit;">Continuando a girar o gerador, obtemos o resultado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o gerador tem uma fun√ß√£o mais interessante - podemos enviar dados para o gerador de fora. </font><font style="vertical-align: inherit;">Nesse caso, isso n√£o √© exatamente um gerador, mas uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corotina</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou corotina.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{  
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {     
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;       <font></font>
    }                             <font></font>
}                                <font></font>
<font></font>
$print = printer();<font></font>
$print-&gt;send(<span class="hljs-string">'Hello'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' PHPRussia'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' 2019'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">'!'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta se√ß√£o do c√≥digo, √© interessante que ele </font></font><code>while (true)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o bloqueie o fluxo de execu√ß√£o, mas ser√° executado uma vez. </font><font style="vertical-align: inherit;">Enviamos os dados para Corutin e os recebemos </font></font><code>'Hello'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Enviado mais - recebido </font></font><code>'PHPRussia'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O princ√≠pio √© claro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m de enviar dados para o gerador, voc√™ pode enviar erros e process√°-los por dentro, o que √© conveniente.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;<font></font>
    } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $e) {
        <span class="hljs-keyword">echo</span> $e-&gt;getMessage();<font></font>
    }<font></font>
}<font></font>
<font></font>
printer()-&gt;throw(<span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Ooops...'</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir. </font><font style="vertical-align: inherit;">Corutin √© um componente de um programa que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suporta parar e continuar a execu√ß√£o enquanto mant√©m o estado atual</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Corutin se lembra de sua pilha de chamadas, dos dados contidos e pode us√°-los no futuro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geradores e Promessa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada nas interfaces do gerador e do Promise.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throw</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles t√™m a mesma apar√™ncia, exceto por nomes de m√©todos diferentes. </font><font style="vertical-align: inherit;">Podemos enviar dados e gerar um erro para o gerador e a Promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como isso pode ser usado? </font><font style="vertical-align: inherit;">Vamos escrever uma fun√ß√£o.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recoil</span>(<span class="hljs-params">\<span class="hljs-built_in">Generator</span> $generator</span>)
</span>{<font></font>
    $promise = $generator-&gt;current();<font></font>
<font></font>
    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };<font></font>
<font></font>
    $promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;throw($error);<font></font>
        recoil($generator);<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o usa o valor atual do gerador: </font></font><code> $promise = $generator-&gt;current();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu exagerei um pouco. </font><font style="vertical-align: inherit;">Sim, devemos verificar se o valor atual que nos √© devolvido √© algum tipo de </font></font><code>instanceof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promessa. </font><font style="vertical-align: inherit;">Nesse caso, podemos pedir a ele um retorno de chamada. </font><font style="vertical-align: inherit;">Ele internamente envia os dados de volta ao gerador quando o Promise √© bem-sucedido e inicia recursivamente a fun√ß√£o </font></font><code>recoil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="php hljs">    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo pode ser feito com erros. </font><font style="vertical-align: inherit;">Se o Promise falhar, por exemplo, o servidor SQL disse "Muitas conex√µes", podemos lan√ßar o erro dentro do gerador e seguir para a pr√≥xima etapa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso nos leva ao importante conceito de multitarefa cooperativa.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multitarefa cooperativa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse √© um tipo de multitarefa, no qual a pr√≥xima tarefa √© executada somente depois que a tarefa atual se declara explicitamente pronta para dar tempo ao processador para outras tarefas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu raramente encontro algo simples, como trabalhar com apenas um banco de dados. Na maioria das vezes, no processo de atualiza√ß√£o do usu√°rio, voc√™ precisa atualizar os dados no banco de dados, no √≠ndice de pesquisa, limpar ou atualizar o cache e enviar mais 15 mensagens para o RabbitMQ. No PHP, tudo se parece com isso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m6/w7/5n/m6w75nkbjrduxzynamn9qiinfwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizamos opera√ß√µes uma a uma: atualizamos o banco de dados, o √≠ndice e o cache. Mas, por padr√£o, o PHP bloqueia essas opera√ß√µes (E / S); portanto, se voc√™ observar de perto, de fato, tudo est√° correto. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wk/3d/wc/wk3dwckb_gjjfnoprw63gxnoxlm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas partes escuras n√≥s bloqueamos. Eles levam mais tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se trabalharmos no modo ass√≠ncrono, essas partes n√£o estar√£o l√°, a linha do tempo de execu√ß√£o ser√° intermitente.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/mx/xv/qjmxxv9oiwkix-_oebyl48qbio4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode colar tudo isso e fazer pe√ßas uma por uma. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t0/o0/x5/t0o0x5ddiw6pij4rlmvzst2oyaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que serve tudo isso? </font><font style="vertical-align: inherit;">Se voc√™ observar o tamanho da linha do tempo, a princ√≠pio leva muito tempo, mas assim que a colamos, o aplicativo acelera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥prio conceito de Event Loop e multitarefa cooperativa h√° muito tempo √© usado em v√°rias aplica√ß√µes: Nginx, Node.js, Memcached, Redis. </font><font style="vertical-align: inherit;">Todos eles usam dentro do Event Loop e s√£o criados com o mesmo princ√≠pio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde que come√ßamos a falar sobre os servidores web Nginx e Node.js., lembremos como o processamento de solicita√ß√µes no PHP ocorre.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processamento de solicita√ß√µes em PHP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O navegador envia uma solicita√ß√£o, chega ao servidor HTTP atr√°s do qual h√° um pool de fluxos FPM. </font><font style="vertical-align: inherit;">Um dos threads coloca esse pedido em opera√ß√£o, conecta nosso c√≥digo e come√ßa a execut√°-lo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/s1/p_/bgs1p_g8r9ytthxrst0mszi7_bw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a pr√≥xima solicita√ß√£o chegar, outro encadeamento do FPM ir√° busc√°-la, conectar o c√≥digo e ser√° executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vantagens</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nesse esquema de trabalho </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tratamento simples de erros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se algo der errado e uma das solicita√ß√µes falhar, n√£o precisamos fazer nada - a pr√≥xima vir√°, e isso n√£o afetar√° seu trabalho.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s n√£o pensamos em mem√≥ria</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">N√£o precisamos limpar ou monitorar a mem√≥ria. </font><font style="vertical-align: inherit;">Na pr√≥xima solicita√ß√£o, toda a mem√≥ria ser√° limpa.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um esquema interessante que funcionou em PHP desde o in√≠cio e ainda funciona com sucesso. </font><font style="vertical-align: inherit;">Mas tamb√©m h√° </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desvantagens</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite o n√∫mero de processos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se tivermos 50 threads de FPM no servidor, assim que a 51¬™ solicita√ß√£o chegar, ele aguardar√° at√© que um dos threads fique livre.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custos para troca de contexto</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O SO alterna solicita√ß√µes entre fluxos FPM. </font><font style="vertical-align: inherit;">Essa opera√ß√£o no n√≠vel do processador √© denominada Context Switch. </font><font style="vertical-align: inherit;">√â caro e executa um grande n√∫mero de medidas. </font><font style="vertical-align: inherit;">√â necess√°rio salvar todos os registros, a pilha de chamadas, tudo o que est√° no processador, mudar para outro processo, carregar seus registros e sua pilha de chamadas, executar algo l√° novamente, alternar novamente, salvar novamente ... Por um longo tempo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos abordar a quest√£o de maneira diferente - escreveremos um servidor HTTP no pr√≥prio PHP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor HTTP ass√≠ncrono</font></font></h2><br>
<img src="https://habrastorage.org/webt/nd/dy/yt/nddyyt6dhjy0dxnkmpokppvvcr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode ser feito. </font><font style="vertical-align: inherit;">J√° aprendemos a trabalhar com soquetes no modo sem bloqueio, e uma conex√£o HTTP √© o mesmo soquete. </font><font style="vertical-align: inherit;">Como ser√° a apar√™ncia e o funcionamento? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um exemplo de inicializa√ß√£o de servidores HTTP na estrutura AMPHP.</font></font><br>
<br>
<pre><code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<font></font>
    $app = <span class="hljs-keyword">new</span> Application();<font></font>
    $app-&gt;bootstrap();<font></font>
<font></font>
    $sockets = [Socket\listen(<span class="hljs-string">'0.0.0.0:80'</span>)];<font></font>
<font></font>
    $server = <span class="hljs-keyword">new</span> Server($sockets, <span class="hljs-keyword">new</span> CallableRequestHandler(
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Request $request</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$app</span>) </span>{<font></font>
            $response = <span class="hljs-keyword">yield</span> $app-&gt;dispatch($request);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response(Status::OK, [], $response);<font></font>
        })<font></font>
    );<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $server-&gt;start();<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© bem simples: carregue </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e crie um pool de soquetes (um ou mais). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, iniciamos nosso servidor, configuramos-o </font></font><code>Handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que ser√° executado em cada solicita√ß√£o e enviamos a solicita√ß√£o ao nosso </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para obter uma resposta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima coisa a fazer √© iniciar o servidor </font></font><code>yield $server-&gt;start();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No ReactPHP, ele ter√° a mesma apar√™ncia, mas somente haver√° 150 retornos de chamada para op√ß√µes diferentes, o que n√£o √© muito conveniente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem v√°rios problemas com a assincronia no PHP. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de padr√µes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cada estrutura: Swoole, ReactPHP ou AMPHP implementa sua pr√≥pria interface Promise e elas s√£o incompat√≠veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teoricamente, o AMPHP poderia interagir com o Promise do ReactPHP, mas h√° uma ressalva. Se o c√≥digo para o ReactPHP n√£o estiver muito bem escrito e, em algum lugar, implicitamente chamar ou criar um loop de eventos, acontece que dois Loops de Eventos girar√£o dentro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O JavaScript possui um padr√£o Promises / A + relativamente bom que implementa o Guzzle. Seria bom se as estruturas o seguissem. Mas at√© agora isso n√£o √©. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perdas de mem√≥ria</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Quando trabalhamos em PHP no modo FPM usual, podemos n√£o pensar em mem√≥ria. Mesmo que os desenvolvedores de alguma extens√£o tenham esquecido de escrever um bom c√≥digo, esquecido de executar o Valgrind e em algum lugar dentro dos fluxos de mem√≥ria, tudo bem - a pr√≥xima solicita√ß√£o ser√° limpa e ser√° iniciada novamente. Mas no modo ass√≠ncrono, voc√™ n√£o pode permitir isso, porque mais cedo ou mais tarde simplesmente cairemos </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â poss√≠vel reparar, mas √© dif√≠cil e doloroso. Em alguns casos, o Xdebug ajuda, em outros, a analisar os erros que causaram </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opera√ß√µes de bloqueio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √â vital n√£o bloquear o loop de eventos quando escrevemos c√≥digo ass√≠ncrono. O aplicativo fica mais lento assim que bloqueamos o fluxo de execu√ß√£o, cada uma das nossas rotinas come√ßa a correr mais devagar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pacote kelunik / loop-block</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajudar√° a encontrar essas opera√ß√µes para o AMPHP </font><font style="vertical-align: inherit;">. Ele ajusta o cron√¥metro para um intervalo muito pequeno. Se o cron√¥metro n√£o funcionar, estamos bloqueados em algum lugar. O pacote ajuda a encontrar locais de bloqueio, mas nem sempre: o bloqueio em algumas extens√µes pode n√£o ser percebido. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte de biblioteca: Cassandra, Influx, ClickHouse</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O principal problema de todo o PHP ass√≠ncrono √© o suporte de bibliotecas. N√≥s n√£o podemos usar os habituais </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outros drivers para </font><font style="vertical-align: inherit;">todos </font><font style="vertical-align: inherit;">- precisamos implementa√ß√µes sem bloqueio. Eles tamb√©m devem ser escritos em PHP no modo sem bloqueio, porque os drivers C raramente fornecem interfaces que podem ser integradas ao c√≥digo ass√≠ncrono. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A experi√™ncia mais estranha que tive com o driver do banco de dados Cassandra. Eles fornecem opera√ß√µes</font></font><code>ExecuteAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>GetAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e outros, mas ao mesmo tempo eles retornam um objeto </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um √∫nico m√©todo </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que bloqueia. </font><font style="vertical-align: inherit;">H√° uma oportunidade de obter algo de forma ass√≠ncrona, mas, para aguardar o resultado, ainda bloquearemos todo o nosso loop. </font><font style="vertical-align: inherit;">Para fazer isso de alguma maneira diferente, por exemplo, atrav√©s de retornos de chamada, n√£o funciona. </font><font style="vertical-align: inherit;">At√© escrevi meu cliente para Cassandra, porque o usamos em nosso trabalho. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indica√ß√£o de tipo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este √© um problema do AMPHP e corutin.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): \<span class="hljs-title">Generator</span>
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ocorrer em uma fun√ß√£o </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, torna-se um gerador. </font><font style="vertical-align: inherit;">Neste ponto, n√£o podemos mais especificar os tipos de dados de retorno corretos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP 8</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que nos espera no PHP 8? </font><font style="vertical-align: inherit;">Vou falar sobre minhas suposi√ß√µes ou, melhor dizendo, meus desejos ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nota do editor: Dmitry Stogov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sabe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o que realmente aparecer√° no PHP 8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loop de Eventos </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° uma chance de que ele apare√ßa, porque est√° em andamento o trabalho de trazer o Event Loop de alguma forma para o kernel. </font><font style="vertical-align: inherit;">Se isso acontecer, teremos uma fun√ß√£o </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, como em JavaScript ou C #, que nos permitir√° aguardar o resultado da opera√ß√£o ass√≠ncrona em um determinado local. </font><font style="vertical-align: inherit;">Nesse caso, n√£o precisaremos de extens√µes, tudo funcionar√° de forma ass√≠ncrona no n√≠vel do kernel.</font></font><br>
<br>
<pre><code class="php hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = await <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen√©ricos </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go est√° esperando por gen√©ricos, estamos esperando por gen√©ricos, todo mundo est√° esperando por gen√©ricos.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o estamos esperando gen√©ricos para cole√ß√µes, mas para indicar que o resultado do Promise ser√° exatamente o objeto Usu√°rio.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que tudo isso?</font></font></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para velocidade e desempenho.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP √© uma linguagem na qual a maioria das opera√ß√µes √© vinculada a E / S. </font><font style="vertical-align: inherit;">Raramente escrevemos um c√≥digo que est√° significativamente associado aos c√°lculos no processador. </font><font style="vertical-align: inherit;">Provavelmente, trabalhamos com soquetes: precisamos fazer uma solicita√ß√£o ao banco de dados, ler algo, retornar uma resposta, enviar um arquivo. </font><font style="vertical-align: inherit;">A assincronia permite que voc√™ acelere esse c√≥digo. </font><font style="vertical-align: inherit;">Se observarmos o tempo m√©dio de resposta para 1000 solicita√ß√µes, podemos acelerar em cerca de 8 vezes e em 10.000 solicita√ß√µes em quase 6!</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em 13 de maio de 2020, nos reuniremos pela segunda vez no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP R√∫ssia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para discutir a linguagem, bibliotecas e estruturas, maneiras de aumentar a produtividade e as armadilhas das solu√ß√µes de hype. </font><font style="vertical-align: inherit;">Aceitamos os quatro primeiros </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">relat√≥rios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas a Chamada de Trabalhos ainda est√° chegando. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inscreva-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se se desejar compartilhar sua experi√™ncia com a comunidade.</font></font></blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487246/index.html">A Autoridade de Certifica√ß√£o Tensor pode comprometer as chaves privadas do cliente</a></li>
<li><a href="../pt487248/index.html">Um pouco mais sobre testes impr√≥prios</a></li>
<li><a href="../pt487250/index.html">Mistura alfa atrasada</a></li>
<li><a href="../pt487254/index.html">Como usar c√¢meras de CFTV, n√£o apenas para monitorar intrusos</a></li>
<li><a href="../pt487256/index.html">Queime e volte das cinzas ou do povo de Phoenix</a></li>
<li><a href="../pt487260/index.html">NoVerify: um linter PHP que funciona r√°pido</a></li>
<li><a href="../pt487262/index.html">Confer√™ncia aberta PHP Russia Online</a></li>
<li><a href="../pt487266/index.html">GitLab 12.7 lan√ßado com pipelines pai-filho e vers√£o beta de manipuladores de tarefas comuns para Windows</a></li>
<li><a href="../pt487270/index.html">Os perovskitas podem prolongar a vida √∫til das telas dos gadgets</a></li>
<li><a href="../pt487272/index.html">Favoritos - a contagem est√° conclu√≠da</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>