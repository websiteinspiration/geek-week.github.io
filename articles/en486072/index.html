<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç™ ‚ö´Ô∏è üëãüèª SQL HowTo: write a while-loop directly in the query, or "Elementary three-way" üöé üóìÔ∏è üèÇüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Periodically, the task of finding related data on a set of keys arises, until we type the desired total number of records . 
 
 The most ‚Äúvital‚Äù examp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SQL HowTo: write a while-loop directly in the query, or "Elementary three-way"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/486072/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periodically, the task of finding related data on a set of keys arises, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">until we type the desired total number of records</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most ‚Äúvital‚Äù example is to derive the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20 oldest tasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> listed </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the list of employees</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (for example, within the same unit). For various managerial ‚Äúdashboards‚Äù with brief squeezes on job sites, a similar topic is often required. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wg/ym/ro/wgymroccelufplrzf4niaa5cdta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the article, we will consider the implementation on PostgreSQL of a ‚Äúnaive‚Äù version of solving such a problem, ‚Äúsmarter‚Äù and a very complex </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL ‚Äúcycle‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algorithm </font><b><font style="vertical-align: inherit;">with the condition to exit from the found data</font></b><font style="vertical-align: inherit;"> , which can be useful both for general development and for use in other similar cases .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Take the test data set from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">So that the displayed records do not ‚Äújump‚Äù from time to time when the sorted values ‚Äã‚Äãcoincide, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we expand the subject index by adding a primary key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">At the same time, this will immediately give it uniqueness, and guarantees us the uniqueness of the sort order:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> task(owner_id, task_date, <span class="hljs-keyword">id</span>);
<span class="hljs-comment">--   - </span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> task_owner_id_task_date_idx;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As it is heard, it is written</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we outline the simplest version of the request, passing the ID of the performers by the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array as an input parameter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  task<font></font>
<span class="hljs-keyword">WHERE</span>
  owner_id = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  task_date, <span class="hljs-keyword">id</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/i_/nu/pd/i_nupdxu_ngr4ngjrsex4usjpki.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It's a little sad - we ordered only 20 records, and Index Scan returned </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">960 lines</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to us </font><font style="vertical-align: inherit;">, which we had to sort later ... And let's try reading a little less.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unnest + ARRAY</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first consideration that will help us is if we need </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only 20 sorted</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> records, then it is enough to read </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no more than 20 sorted</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> records </font><i><font style="vertical-align: inherit;">in the same order for each</font></i><font style="vertical-align: inherit;"> key. </font><font style="vertical-align: inherit;">Fortunately, we have a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suitable index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (owner_id, task_date, id). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will use the same mechanism for extracting and ‚Äúreversing into columns‚Äù of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">holistic table entry</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We also apply convolution to an array using the function </font></font><code>ARRAY()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">unnest</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span><font></font>
        t<font></font>
      <span class="hljs-keyword">FROM</span><font></font>
        task t<font></font>
      <span class="hljs-keyword">WHERE</span>
        owner_id = <span class="hljs-keyword">unnest</span>
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
        task_date, <span class="hljs-keyword">id</span>
      <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span> <span class="hljs-comment">--  ...</span><font></font>
    )) r<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  (r).*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  (r).task_date, (r).id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">-- ...   - </span></code></pre><br>
<img src="https://habrastorage.org/webt/lw/gl/bd/lwglbdeknjvlkl4bmdq6z8rgo-g.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Oh, much better already! </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40% faster, and 4.5 times less data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> had to be read.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Materializing table entries through CTE</font></font></b><div class="spoiler_text"> ,  <i>  </i>           ,  ¬´¬ª  CTE    <b>¬´¬ª InitPlan</b>     :<br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ((<font></font>
    <span class="hljs-keyword">SELECT</span><font></font>
      t<font></font>
    <span class="hljs-keyword">FROM</span><font></font>
      task t<font></font>
    <span class="hljs-keyword">WHERE</span>
      owner_id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
      task_date, <span class="hljs-keyword">id</span>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
  ).*);</code></pre><br>
<pre><code class="plaintext hljs">Result  (cost=4.77..4.78 rows=1 width=16) (actual time=0.063..0.063 rows=1 loops=1)<font></font>
  Buffers: shared hit=16<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.031..0.032 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t  (cost=0.42..387.57 rows=500 width=48) (actual time=0.030..0.030 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
  InitPlan 2 (returns $1)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.008..0.009 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_1  (cost=0.42..387.57 rows=500 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
  InitPlan 3 (returns $2)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_2  (cost=0.42..387.57 rows=500 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4"<font></font>
  InitPlan 4 (returns $3)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.009..0.009 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_3  (cost=0.42..387.57 rows=500 width=48) (actual time=0.009..0.009 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
</code></pre><br>
     ¬´¬ª 4 ‚Ä¶   PostgreSQL 11    ,    ¬´¬ª  CTE,         .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursive battery</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous version, we read a total of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200 lines</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the necessary 20. Already not 960, but even less - is it possible? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to use the knowledge that we need </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only 20</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entries. </font><font style="vertical-align: inherit;">That is, we will iterate the proofreading of the data only until the quantity we need is achieved.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 1: start list</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, our ‚Äútarget‚Äù list of 20 entries should begin with the ‚Äúfirst‚Äù entries for one of our owner_id keys. </font><font style="vertical-align: inherit;">Therefore, first we find such </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"very first" for each of the keys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and put it in the list, sorting it in the order we want - (task_date, id).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fg/4v/mx/fg4vmxjnrahhsxdfhemzvn3ni94.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 2: find the ‚Äúnext‚Äù entries</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, if we take the first record from our list and begin to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äústep‚Äù further in the index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> while preserving the owner_id key, then all the records found are just the next in the resulting selection. Of course, only </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">until we cross the application key of the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> second entry in the list. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If it turned out that we ‚Äúcrossed‚Äù the second record, then the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last read record should be added to the list instead of the first</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (with the same owner_id), after which we will sort the list again. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/34/ys/8o34ys-xy6jx3xssklqneevd3-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, it always turns out that we have no more than one entry in the list for each of the keys (if the records ended, but we did not ‚Äúcross‚Äù, then the first record from the list simply disappears and nothing is added), and they are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">always sorted</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in ascending order of the application key (task_date, id).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k6/ep/l7/k6epl7igxmourdb6-gi1zzlxlvw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 3: filter and ‚Äúexpand‚Äù the records</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the part of the lines of our recursive selection, some entries are </font></font><code>rv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duplicated - first we find such as ‚Äúthe intersecting border of the 2nd entry in the list‚Äù, and then substitute it as the 1st from the list. </font><font style="vertical-align: inherit;">So the first appearance must be filtered.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scary final query</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-comment">-- #1 :    ""      </span>
  <span class="hljs-keyword">WITH</span> wrap <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- "" record',        InitPlan/SubPlan</span>
    <span class="hljs-keyword">WITH</span> T <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span><font></font>
        (<font></font>
          <span class="hljs-keyword">SELECT</span><font></font>
            r<font></font>
          <span class="hljs-keyword">FROM</span><font></font>
            task r<font></font>
          <span class="hljs-keyword">WHERE</span>
            owner_id = <span class="hljs-keyword">unnest</span>
          <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
            task_date, <span class="hljs-keyword">id</span>
          <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
        ) r<font></font>
      <span class="hljs-keyword">FROM</span>
        <span class="hljs-keyword">unnest</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])<font></font>
    )<font></font>
    <span class="hljs-keyword">SELECT</span>
      array_agg(r <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (r).task_date, (r).id) <span class="hljs-keyword">list</span> <span class="hljs-comment">--     </span>
    <span class="hljs-keyword">FROM</span><font></font>
      T<font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">list</span>
  , <span class="hljs-keyword">list</span>[<span class="hljs-number">1</span>] rv<font></font>
  , <span class="hljs-literal">FALSE</span> not_cross<font></font>
  , <span class="hljs-number">0</span> <span class="hljs-keyword">size</span>
  <span class="hljs-keyword">FROM</span><font></font>
    wrap<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-comment">-- #2 :   1-   ,      2-</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">CASE</span>
      <span class="hljs-comment">--       1- </span>
      <span class="hljs-keyword">WHEN</span> X._r <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
        T.list[<span class="hljs-number">2</span>:] <span class="hljs-comment">--    </span>
      <span class="hljs-comment">--       2- </span>
      <span class="hljs-keyword">WHEN</span> X.not_cross <span class="hljs-keyword">THEN</span>
        T.list <span class="hljs-comment">--       </span>
      <span class="hljs-comment">--      2- </span>
      <span class="hljs-keyword">WHEN</span> T.list[<span class="hljs-number">2</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-comment">--    </span>
        <span class="hljs-string">'{}'</span>
      <span class="hljs-comment">--  ,  1-      </span>
      <span class="hljs-keyword">ELSE</span> (
        <span class="hljs-keyword">SELECT</span>
          <span class="hljs-keyword">coalesce</span>(T.list[<span class="hljs-number">2</span>] || array_agg(r <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (r).task_date, (r).id), <span class="hljs-string">'{}'</span>)
        <span class="hljs-keyword">FROM</span>
          <span class="hljs-keyword">unnest</span>(T.list[<span class="hljs-number">3</span>:] || X._r) r<font></font>
      )<font></font>
    <span class="hljs-keyword">END</span><font></font>
  , X._r<font></font>
  , X.not_cross<font></font>
  , T.size + X.not_cross::<span class="hljs-built_in">integer</span>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  , <span class="hljs-keyword">LATERAL</span>(
      <span class="hljs-keyword">WITH</span> wrap <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- "" record</span>
        <span class="hljs-keyword">SELECT</span>
          <span class="hljs-keyword">CASE</span>
            <span class="hljs-comment">--  - ""  2- </span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">NOT</span> T.not_cross
              <span class="hljs-comment">--    -   </span>
              <span class="hljs-keyword">THEN</span> T.list[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">ELSE</span> ( <span class="hljs-comment">--   ,        -   </span>
              <span class="hljs-keyword">SELECT</span><font></font>
                _r<font></font>
              <span class="hljs-keyword">FROM</span><font></font>
                task _r<font></font>
              <span class="hljs-keyword">WHERE</span>
                owner_id = (rv).owner_id <span class="hljs-keyword">AND</span>
                (task_date, <span class="hljs-keyword">id</span>) &gt; ((rv).task_date, (rv).id)
              <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
                task_date, <span class="hljs-keyword">id</span>
              <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
            )<font></font>
          <span class="hljs-keyword">END</span> _r<font></font>
      )<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        _r<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-comment">--  2-     ,    - </span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> _r <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-literal">TRUE</span>
          <span class="hljs-keyword">ELSE</span> <span class="hljs-comment">--     ""</span>
            <span class="hljs-keyword">coalesce</span>(((_r).task_date, (_r).id) &lt; ((<span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>]).task_date, (<span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>]).id), <span class="hljs-literal">FALSE</span>)
        <span class="hljs-keyword">END</span> not_cross
      <span class="hljs-keyword">FROM</span><font></font>
        wrap<font></font>
    ) X<font></font>
  <span class="hljs-keyword">WHERE</span>
    T.size &lt; <span class="hljs-number">20</span> <span class="hljs-keyword">AND</span> <span class="hljs-comment">--   </span>
    T.list <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">'{}'</span> <span class="hljs-comment">--     </span><font></font>
)<font></font>
<span class="hljs-comment">-- #3 : ""  -    </span>
<span class="hljs-keyword">SELECT</span><font></font>
  (rv).*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">WHERE</span>
  not_cross; <span class="hljs-comment">--   "" </span></code></pre></div></div><br>
<img src="https://habrastorage.org/webt/qu/bf/zh/qubfzhs-uv6fk5_nhdnat2lwdb4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Thus, we </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exchanged 50% of data readings for 20% of the runtime</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">That is, if you have reasons to believe that reading can be long (for example, the data is often not in the cache, and you have to go to disk for it), then this way you can depend on reading less. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In any case, the execution time turned out better than in the "naive" first version. </font><font style="vertical-align: inherit;">But which of these 3 options to use - you choose.</font></font></i></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486060/index.html">Find Order in the Chaos of IT: Organizing Your Own Development</a></li>
<li><a href="../en486062/index.html">Simple zero-copy rendering of hardware accelerated video in QML</a></li>
<li><a href="../en486064/index.html">Create an animated slideshow in pure CSS.</a></li>
<li><a href="../en486066/index.html">In the access area. Find the distance from a point to an area and reduce reverse geocoding requests</a></li>
<li><a href="../en486070/index.html">ACL switches in detail</a></li>
<li><a href="../en486076/index.html">From Ground to FPV Quadcopter: Introduction</a></li>
<li><a href="../en486080/index.html">Let me introduce: Veeam Availability Suite v10</a></li>
<li><a href="../en486082/index.html">Dagaz: The Sum of Technology</a></li>
<li><a href="../en486084/index.html">Replacing smaller disks with larger disks in Linux</a></li>
<li><a href="../en486092/index.html">Marina Alex, CEO of University of Business Agility: ‚ÄúAgile is out of IT. Agile - More Than IT ‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>