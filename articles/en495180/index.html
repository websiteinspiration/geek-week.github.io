<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèæ üïí üßù We pump Ikea: how to turn light music into Big Brother üéß ‚ö´Ô∏è üëåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 Ikea is a curious store. Even if you came into it with the intention of buying one specific thing and not be distracted by all the rest ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We pump Ikea: how to turn light music into Big Brother</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495180/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/g-/1c/b3/g-1cb35ov13g0bc7demuvnxiqla.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ikea is a curious store. Even if you came into it with the intention of buying one specific thing and not be distracted by all the rest of the junk, then you will exit by buying three times more than necessary. For us hackers, this effect is especially evident in the Ikea department with power cables or batteries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For me, the last case of such insanity occurred in the Netherlands. I was on a planned trip, planning to spend only a few weeks in the country. However, this was at the very beginning of 2020 and the disaster with COVID-19 ... I had to stay far from my laboratory much longer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when I saw </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frekevens'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> electronic product line at Ikea </font><font style="vertical-align: inherit;">, I couldn't help it and bought it all.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who don‚Äôt know: the Ikea Frekvens line should become a modern analogue of the old-school HiFi set plus the hexagonal light music set, which seems to be in the homes of half of the 90s teenagers. In this case, the line of devices connected to each other consists of a Bluetooth speaker for sound output and an LED projector (complemented by various nozzles) that flicker to the beat of the music, as well as an LED cube display that can display animations that also move to the music. Ikea boasts that this line was developed in conjunction with Teenage Engineering, known for its Pocket Operator series of portable ‚Äútoy‚Äù synthesizers.</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4d/8b4/e60/f4d8b4e60e7812b5b979850a18d3926c.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As shown in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ikea </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">promotional video</font></a><font style="vertical-align: inherit;"> , the finished purchase of dozens of devices should look like an unbearable flickering carnival, which my inner 15-year-old teenager would not mind arranging in his room.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was particularly interested in the LED cube display: it is a high-quality integrated device that works on the mains. On the front panel is a matrix of 16 rows and 16 columns of very bright white LEDs, that is, a total of 256 LEDs. The animations built into the device were pretty simple, but they led me to the idea that iron can actually control each LED individually. However, because of this, the small box was quite expensive: my pocket was empty by about 40 euros. For this amount, you get a box with LEDs and a power cable. Since it is assumed that you must buy this product along with other Frekvens products, you also receive additional connecting elements: an extension power cable for end-to-end supply of power from the mains to other boxes,as well as a set of screws and plastic pads with which you can mechanically fasten the housing to each other.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as I got home, I connected the device and ... to be honest, I was a little disappointed with what they did with the iron. </font><font style="vertical-align: inherit;">The device had several animations that could be selected by pressing a button on the back of the case; </font><font style="vertical-align: inherit;">a small microphone is installed in the case - every time it recognizes noise, the frame of the animation changes. </font><font style="vertical-align: inherit;">Animations are not very interesting: they consist of only four to five frames, and the frames themselves are only black and white, without shades of gray. </font><font style="vertical-align: inherit;">If you're curious, I recorded a short </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with all the animations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, this did not suit me. </font><font style="vertical-align: inherit;">Let's hack the device - let's see what makes it work, and is it possible to make its behavior a little more interesting.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autopsy</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To disassemble Frekvens, a screwdriver for a cross-shaped slot and, possibly, a knife will be enough. </font><font style="vertical-align: inherit;">You will also need a solid share of perseverance, because the device is not easy to disassemble: the design is complicated and some elements are filled with silicone, probably to get rid of vibration and simplify manufacturing.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71d/6e9/925/71d6e9925d31cbce7d1da4cf492948de.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The disassembly of the Frekvens case starts from behind. </font><font style="vertical-align: inherit;">The housing has screw holes on all sides, with the exception of the front; </font><font style="vertical-align: inherit;">thanks to the set of screws and covers from the device‚Äôs kit, it can be connected to other Frekvens gadgets. </font><font style="vertical-align: inherit;">However, the rear holes for the screws are a little deeper and under them there are screws that secure the case.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebf/2c5/8e2/ebf2c58e270c942b8e360a744f0ff6ea.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having removed the back cover, we see that all the screw holes have threaded metal inserts into which the screws can be screwed. </font><font style="vertical-align: inherit;">Wow! </font><font style="vertical-align: inherit;">This should provide the holes with a sufficient margin of safety. </font><font style="vertical-align: inherit;">It is possible that this greatly complicates the production or disassembly; </font><font style="vertical-align: inherit;">the latter is complicated by the fact that we first need to cut the drops of hardened silicone compound.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ca/78c/bf2/4ca78cbf2e1f533658a361fd998a933a.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The inserts are actually fastened with other plastic inserts; </font><font style="vertical-align: inherit;">they need to be removed first. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have no other photos of the disassembly process, but after this stage you will see four screws that need to be unscrewed, and then the process continues as before. </font><font style="vertical-align: inherit;">Understand which plastic piece holds everything else together, cut the silicone compound, remove the plastic fasteners. </font><font style="vertical-align: inherit;">Continue until you can pull out the circuit board.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e40/8c0/346/e408c0346ddbea872aa6100a7c37c303.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here it is: the reverse side of the circuit board. As it turned out, it is assembled from two printed circuit boards: the white one has two sides - on the back there are all the LED drivers (and another board is attached to it), and on the front there are the LEDs themselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The white circuit board is designed pretty well: instead of a matrix of LEDs, there are 16 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">SCT2024</font></a><font style="vertical-align: inherit;"> LED drivers</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">working from a direct current. These LED drivers have 16 channels, that is, each LED is directly controlled. LED drivers can only fully turn on or off the LEDs; the drivers themselves do not have native grayscale support. In fact, they perform register shift using current-controlled outputs, and they all switch sequentially; The green PCB connection interface consists of its synchronization bus and data, a snap enable line, an output, ground, and power enable line.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On this green board is what‚Äôs the tiny brain of the device: a microcontroller, the article of which cannot be found on Google, and an operational amplifier for the microphone. </font><font style="vertical-align: inherit;">Interestingly, there are hints that the device should have more features: there is a place for, presumably, I2C EEPROM 24Cxx and a hint that in the original project there was an IR receiver on the front panel. </font><font style="vertical-align: inherit;">Perhaps it was supposed that the device would come with a remote control that allows you to create your own patterns? </font><font style="vertical-align: inherit;">This may explain that the existing animations look so dull.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/40f/a7a/1d9/40fa7a1d95a60af223eb12a5f5db7ba6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the front of the white board are all the LEDs. </font><font style="vertical-align: inherit;">A tiny flat microphone is also soldered to it. </font><font style="vertical-align: inherit;">At first I thought that it was soldered to the green board and sticks out through the hole in the white board, but in fact it is just flat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bb/613/620/2bb6136207e5ce1cf78895a6827a8dfd.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All other electronics are located on the back of the board. </font><font style="vertical-align: inherit;">It is not enough there: only a power supply under the Ikea brand, issuing 4 V. Under the power supply there is a small printed circuit board on which there are two tactile switches for buttons on the back of the case. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, if we want to ‚Äúoptimize‚Äù the design, then we have an obvious weakness: it is better to replace a small green card with a processor with something more powerful.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We modify iron</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I thought it might be possible to replace the equipment with an ESP-Cam. This is a very cheap (10 euros or so) board with an ESP32 WiFi / BT chip, several megabytes of PSRAM, and a camera module. I'm not very interested in light music, I wanted the device to respond to something visual. Since there was already a hole in the front end for the receiver, I thought I could use it under the camera. I will also need to drill a hole in the white board where the microphone is located; fortunately, besides these now useless microphone tracks, this will destroy only one track of the LED. I drilled a hole and restored the track. Temporarily putting the board back in place and turning on the cube, I made sure that all the LEDs are still working.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ed1/c45/456/ed1c454569bc1fa6734a8c16bdfed1ae.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I had a board with a drilled hole, and I could only connect and mechanically connect the ESP-Cam. The designers kindly indicated the purpose of all the pads on the silkscreen of the green board, so I almost had to guess nothing. Since the power supply supplies only 4 V, I connected it directly to the 3.3 V input of the ESP-CAM chip. I had to do this, because when I connected it to the Vin 5V pin, the chip did not want to start ... Most likely, the LDO regulator has a slightly high voltage drop. Going back, I now think that it was worth trying to connect the diode in series with a 4 V source to get 3.3-3.4 V, but my solution worked; ESP32 is quite unpretentious.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/021/93d/abe/02193dabe8880ceeea91807ec0a16d2f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soldering all the connectors, I had to deal with the mechanics anyway. </font><font style="vertical-align: inherit;">It was a ‚Äúquick and dirty‚Äù project, and I had already soldered the ESP-Cam connectors before, so to align the camera with the hole, you could do with several gaskets and a lot of epoxy.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/f14/364/e62f143645504bfd1636cab8fdb3cdf8.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this operation, the last problem remained: the LEDs next to the camera shone on its frame window, causing all kinds of strange artifacts. </font><font style="vertical-align: inherit;">First of all, to eliminate them, I cut a small bezel from an aluminum tape to protect the camera from direct light.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/1a8/1bb/fa71a81bb0a3131132885840f8186e85.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second step was the application of acrylic paint. </font><font style="vertical-align: inherit;">This is a plastic insert on which all the diffusers are located, through which the LEDs shine. </font><font style="vertical-align: inherit;">I already enlarged the hole that it had for the microphone in it to create a wider frame window for the camera, but this led to another problem - the hole was too noticeable and too much diffused light fell on the camera. </font><font style="vertical-align: inherit;">A stain of black acrylic paint did pretty well on both issues; </font><font style="vertical-align: inherit;">the camera still received quite a lot of light from the LEDs, but now it did not flood it completely. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, brain transplantation is complete and the body is ready for assembly. </font><font style="vertical-align: inherit;">You can start the software.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Software</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to the software. First of all, we need to gain control over the LED drivers. This is not difficult: the driver signals are almost directly consistent with the ESP32 chip's SPI peripheral interface: the CLK pad on the board connects to the SPI peripheral CLK interface, the DA pad on the board connects to the SPI signal's MOSI. This will allow you to synchronize 256 bits with a chain of LED drivers: each synchronized bit controls the on or off of the corresponding LED. In addition, there is an LAK entrance. If the signal on it is low, then the LED retains its previous value, regardless of what was transferred to the shift registers; if the signal is high, then all of them simultaneously switch to the values ‚Äã‚Äãthat are currently in the shift register. Finally, there is an EN input that turns on or off all the LEDs;I did not connect it to GPIO and just always turn on the LEDs programmatically.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, I can now turn on and off individual LEDs, getting a black and white display. However, I need something else. With sufficient computing power, the display should also be capable of displaying shades of gray - for this, you just need to turn on / off the LEDs faster than the eye sees. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement this with a single LED, I usually use PWM, but in the case of 256 LEDs, this will take up a significant part of the power of the ESP32 processor. So instead, I decided to use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binary Code Modulation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (also called Bit Angle Modulation). This is a technique that allows you to get shades of gray with less CPU power. I have already successfully used it in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other projects</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so I was sure that it would work.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e99/009/265/e990092656bfd3db2032718f55e7e086.jpg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And it worked. I also added a lookup table to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convert CIE lightness to PWM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because the eye essentially responds to the brightness of the LEDs non-linearly; lookup table fixes this problem. In the end, I managed to achieve a sufficient amount of shades of gray and linear scaling of the optical brightness in accordance with the pixel value set by me.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was not difficult to implement the camera project: there is an ESP-IDF component that can be added to the project; he will take care of setting up the camera and exchanging data with it, you just need to specify the parameters you need, and then request the bitmap that the camera sees. The only thing I could not use in the standard setting was that automatic alignment and automatic exposure were turned on by default, and this pretty much interfered with my way of controlling the LEDs: depending on which part of the Binary Code Modulation sequence the image was created, the camera rather randomly increased or decreased alignment and exposure. I fixed the problem by switching the camera to manual alignment and shutter speed; the code itself examines the image and determines whether these parameters need compensation.Thanks to such manual processing, I also managed to exclude pixels that looked directly at the LEDs in order to completely remove them from the equation. This also greatly helped in obtaining a stable image.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I have a camera and a 16x16 canvas in shades of gray. What should I do with them? I got an idea: at the time of the very first Macintosh computers, there was a popular extension that only added a couple of cartoon eyes to the menu bar. These eyes simply followed the cursor. (A variation of this theme for Linux / Unix called "xeyes" still exists.) What if I try to repeat it in real life?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6d1/c9e/0a1/6d1c9e0a114c84f246c051c4358cdcc7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For starters, I needed some images of the eyes. I did not think that I could draw something worthwhile, so instead I decided to use my own eyes as basic pictures; watch a short video in which I watch and blink in all directions. It is worth considering that due to the current situation I had very few professional tools: I lie on the floor to maximize the lighting falling from the ceiling fluorescent lamps and get a legible image; All the video was shot on the smartphone that I hold in my hands.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the initial data was rather sloppy, I had to work hard on post-processing. I began by cutting out a fragment that was approximately around my right eye. Then I converted each frame of the video into an image and deleted all redundant images; in the end I had a good selection of images of me looking in different directions, as well as a few frames with a blink. However, since I used a mobile phone for recording, the video turned out to be a little shaky and the images skipped. To fix this, I passed a set of images through the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Hugin</font></a><font style="vertical-align: inherit;"> image </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">glue</font></a><font style="vertical-align: inherit;"> program</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is usually used for panoramas and HDR images; at the exit, I got pictures ideally centered on this part of my face. Now I could only mark in which direction I was looking, and whether I blinked. I did this by first converting all the images to shades of gray and then uploading them to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gimp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In each image, I used a red dot to indicate the location of the center of the pupil, plus a red dot in the left or right corner to indicate if I blink, and if I blink, then my eye is half open, or closed.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb6/112/a73/bb6112a73c7b9fbdb619afaff1b971c9.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After marking each image in this way, it became very simple to write a script to get the location of the pupil, as well as the state of blinking. The script also scaled the images to 16x16 and saved them as raw binary data, ready to be written to the ESP-CAM module firmware. In the end, I got a set of images and an index of where the pupil is and in what state of blinking the eye is.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ESP-Cam has a fairly easy-to-use camera library component for the ESP-IDF, so getting images was easy. I set up grabbing 120x160 images in shades of gray, because they are the easiest to process, and I did not need a lot of resolution, because the final result should be displayed on a 16x16 screen. However, I still had a hardware problem: the camera is still too close to the LEDs.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb1/d78/621/cb1d786213e7450791968f0e7da4d6c3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, I tried to solve it by calibration: when the device starts up, it takes two pictures: one with an LED close to the camera lens, and one only with an LED located far from the camera. Subtracting one image from another, you can understand which pixels are affected by LEDs. These pixels are stored in the mask; pixels marked in the mask are subsequently ignored. The image above shows two shots and a mask.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With a cleaner image, I could move on to motion recognition. I implemented it by getting a frame from the camera and subtracting the previous frame from it. Then I was able to calculate the amount of motion by adding up all the resulting pixels. Further, it was possible to calculate the location of the concentration of motion by taking the average of the coordinates of all pixels weighted by the difference of frames in this pixel. In the end, the filtering magic is performed so that the device does not look jerked around like a jack Russell Terrier with ADHD: to attract his attention, objects must either move more uniformly or move far enough.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There was only one problem: when it was very dark, the motion recognition algorithm sometimes worked on the reflection of LEDs on shiny objects in the room: if the eye blinked, then pay attention to its own reflection. </font><font style="vertical-align: inherit;">This is not quite what I wanted, so I circumvented this problem by making the motion recognition algorithm ‚Äúblind‚Äù when changing the image on the LEDs; </font><font style="vertical-align: inherit;">so I stopped this behavior. </font><font style="vertical-align: inherit;">Moreover, it is also a little more realistic: when you blink, you cannot see. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The firmware has several debugging modes that demonstrate the whole process. </font><font style="vertical-align: inherit;">Here is a short video illustrating this:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bR-CpMdz02I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So now I have a device that is following me ... not really useful, I agree. </font><font style="vertical-align: inherit;">But it was interesting for me to create it, and if I ever find something more useful that can be implemented on a 16x16 LED screen, then I can do it, because I already have a control code. </font><font style="vertical-align: inherit;">Speaking of code: you can freely download my raw result </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hope you enjoyed it and take care.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UCPUPO21Cwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495168/index.html">An alternate form of the Python ternary operator</a></li>
<li><a href="../en495170/index.html">What sounds temporarily disappeared from our lives, and whose return is not worth waiting for - a discussion</a></li>
<li><a href="../en495174/index.html">Professional freelance</a></li>
<li><a href="../en495176/index.html">Fixing serialization of objects in Kotlin once and for all</a></li>
<li><a href="../en495178/index.html">It's time for free sites</a></li>
<li><a href="../en495184/index.html">The difficulties of import substitution: a tool for state corporations is removed from the registry of domestic software</a></li>
<li><a href="../en495188/index.html">Difficulties in teaching foreign languages ‚Äã‚Äã(I would also recommend to students)</a></li>
<li><a href="../en495192/index.html">The perfect Minecraft server launch script</a></li>
<li><a href="../en495194/index.html">STM-32 Minimum Audio Board</a></li>
<li><a href="../en495196/index.html">If the IB had a ‚ÄúDarwin Award‚Äù, or 7 stories about stupidity, trash, gullibility and their consequences</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>