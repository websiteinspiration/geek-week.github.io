<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👱 👵 💨 Recetas para consultas SQL enfermas 🧑🏾‍🤝‍🧑🏽 👩🏽‍✈️ 🌂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace unos meses, anunciamos aclarar.tensor.ru , un servicio público para analizar y visualizar planes de consulta para PostgreSQL. 
 
 En el pasado, y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Recetas para consultas SQL enfermas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hace unos meses, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anunciamos </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aclarar.tensor.ru</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servicio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> público </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">para analizar y visualizar planes de consulta</font></a><font style="vertical-align: inherit;"> para PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el pasado, ya lo ha usado más de 6,000 veces, pero una de las funciones convenientes podría pasar desapercibida: estas son </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sugerencias estructurales</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que se parecen a esto: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/66/1s/jp661svgeudxc0wvgnzqoyjffbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
escúchelas y sus solicitudes "se volverán suaves y sedosas". :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero en serio, muchas de las situaciones que hacen que la solicitud sea lenta y "glotona" en términos de recursos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">son típicas y pueden ser reconocidas por la estructura y los datos del plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, cada desarrollador individual no tendrá que buscar una opción de optimización por su cuenta, confiando únicamente en su experiencia: podemos decirle qué está sucediendo aquí, cuál podría ser el motivo y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cómo abordar la solución</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Lo cual hicimos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/br/mr/upbrmra7tcpkdnygwg0abfhbqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo más de cerca a estos casos: cómo se determinan y a qué recomendaciones conducen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para una mejor comprensión del tema, primero puede escuchar el bloque correspondiente de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mi informe sobre PGConf.Russia 2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y solo luego pasar a un análisis detallado de cada ejemplo:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jHqaLp040rY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: índice "subestimación"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mostrar la última factura para el cliente "LLC Bell".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Limit<font></font>
   -&gt; Sort<font></font>
      -&gt; Index [Only] Scan [Backward] | Bitmap Heap Scan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use el índice utilizado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para ordenar los campos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">1</span> <span class="hljs-comment">--    </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  pk <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    "" </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/nn/u1/wp/nnu1wpmpqryyy3rrpmhpofv1izk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru] Puede</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
notar de inmediato que el índice resta más de 100 entradas, que luego se ordenaron, y luego quedó la única. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arreglemos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_cli_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli, pk <span class="hljs-keyword">DESC</span>); <span class="hljs-comment">--   </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/gv/ny/ni/gvnyniyvlmcsfk-f2qk4voomvzo.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Incluso en una muestra tan primitiva: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.5 veces más rápido y 33 veces menos lecturas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El efecto será más visible cuanto más "hechos" tenga para cada valor </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observo que dicho índice funcionará como "prefijo" no peor que el anterior para otras consultas </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, donde </font></font><code>pk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hubo </font><font style="vertical-align: inherit;">clasificación </font><font style="vertical-align: inherit;">ni </font><font style="vertical-align: inherit;">clasificación </font><font style="vertical-align: inherit;">(se puede encontrar más información sobre esto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mi artículo sobre cómo encontrar índices ineficientes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">En particular, proporcionará </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soporte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> normal </font><b><font style="vertical-align: inherit;">para una clave foránea explícita</font></b><font style="vertical-align: inherit;"> en este campo.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: intersección de índice (BitmapAnd)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mostrar todos los contratos para el cliente LLC Kolokolchik celebrado en nombre de NAO Buttercup.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapAnd<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">índice compuesto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para los campos desde el origen o expanda uno de los campos existentes desde el segundo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org); <span class="hljs-comment">--   foreign key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  (fk_org, fk_cli) = (<span class="hljs-number">1</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">--    </span></code></pre><br>
<img src="https://habrastorage.org/webt/dh/y4/mz/dhy4mzknpsqyk3ejuetev5mlmiy.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correcto:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_org_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli);
</code></pre><br>
<img src="https://habrastorage.org/webt/vt/nm/2c/vtnm2csqildllccdfsffjgxu4ya.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aquí la ganancia es menor, porque Bitmap Heap Scan es bastante efectivo en sí mismo. </font><font style="vertical-align: inherit;">Pero sigue siendo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 veces más rápido y 2,5 veces menos lecturas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: agrupación de índices (BitmapOr)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muestre las primeras 20 aplicaciones "propias" o no asignadas más antiguas para el procesamiento, y su prioridad.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapOr<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION [ALL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para combinar subconsultas para cada uno de los bloques OR de condiciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--   1:16  ""</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk); <span class="hljs-comment">--   "  " </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_own = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> <span class="hljs-comment">-- </span>
  fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">-- ...  ""</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
, (fk_own = <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  ""</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/7k/n2/d1/7kn2d1ko1hrbobs44a69hasatcs.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correcto:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own = <span class="hljs-number">1</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">--   - 20,    </span></code></pre><br>
<img src="https://habrastorage.org/webt/pa/ej/2f/paej2f1lpkzhinvlz64tvf9n8ti.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aprovechamos el hecho de que los 20 registros necesarios se recibieron de inmediato en el primer bloque, por lo que el segundo, con la exploración de montón de mapas de bits más "costosa", ni siquiera se realizó, como resultado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, 22 veces más rápido, en ¡44 veces menos lecturas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se </font><font style="vertical-align: inherit;">puede encontrar </font><font style="vertical-align: inherit;">una historia más detallada sobre este método de optimización </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilizando ejemplos específicos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en los artículos de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: perjudicial JOIN y OR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: un cuento sobre el refinamiento iterativo de la búsqueda por nombre, o "Optimización de ida y vuelta"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se consideró una versión generalizada de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selección ordenada por varias teclas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y no solo por el par const / NULL) en el artículo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL HowTo: escribimos el ciclo while directamente en la consulta, o "Elemental de tres vías"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4: lee muchas cosas innecesarias</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como regla, surge si desea "fijar otro filtro" a una solicitud existente.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"¿Y no tienes lo mismo, pero </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con botones de perlas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">película "Diamond Hand"</font></font></i><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, al modificar la tarea anterior, muestre las primeras 20 aplicaciones "críticas" más antiguas para el procesamiento, independientemente de su propósito.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; 5 × rows &lt; RRbF --  &gt;80% <font></font>
   &amp;&amp; loops × RRbF &gt; 100 --     100  <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree un [más] </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">índice</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> personalizado </font><b><font style="vertical-align: inherit;">con una cláusula WHERE</font></b><font style="vertical-align: inherit;"> o incluya campos adicionales en el índice.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la condición del filtro es "estática" para sus tareas, es decir, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no implica expandir la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lista de valores en el futuro, es mejor usar el índice WHERE. </font><font style="vertical-align: inherit;">Los diferentes estados booleanos / enum encajan bien en esta categoría. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la condición del filtro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede tomar valores diferentes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , entonces es mejor expandir el índice con estos campos, como en la situación con BitmapAnd arriba.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own<font></font>
, (random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">50</span>) <span class="hljs-keyword">critical</span>; <span class="hljs-comment">-- 1:50,   ""</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk);<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">critical</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ca/lg/hn/calghnldd9_313mns2a535sjwma.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correcto:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk)
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">critical</span>; <span class="hljs-comment">--  ""  </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/op/t2/u4/opt2u4yh2mzocmdot9qovn6pzgu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Como puede ver, el filtrado ha desaparecido por completo del plan y la solicitud se ha vuelto </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 veces más rápida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5: mesa escasa</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Varios intentos de hacer su propia cola de tareas de procesamiento cuando una gran cantidad de actualizaciones / eliminaciones de registros en la tabla conducen a una situación de una gran cantidad de registros "muertos".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realice manualmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACÍO [COMPLETO]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manualmente </font><font style="vertical-align: inherit;">o logre pruebas de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacío automático</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> frecuentes adecuadas </font><font style="vertical-align: inherit;">ajustando sus parámetros, incluso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para una tabla específica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la mayoría de los casos, estos problemas son causados ​​por consultas mal estructuradas cuando se llama desde la lógica de negocios, como las discutidas en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: luchando contra hordas de "muertos"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero debe comprender que incluso VACUUM FULL no siempre ayuda. </font><font style="vertical-align: inherit;">Para tales casos, debe familiarizarse con el algoritmo del artículo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA: cuando VACUUM pasa, limpiamos la tabla manualmente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: lectura desde la mitad del índice</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que no leyeron mucho, y todo por índice, y no filtraron nada extra, pero de todos modos, se leyeron significativamente más páginas de las que quisiéramos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops × (rows + RRbF) &lt; (shared hit + shared read) × 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe detenidamente la estructura del índice utilizado y los campos clave especificados en la solicitud; lo más probable es que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parte del índice no esté especificado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Lo más probable es que tenga que crear un índice similar, pero sin campos de prefijo o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aprender a iterar sobre sus valores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli); <span class="hljs-comment">--     #2</span>
<span class="hljs-comment">--      fk_cli      </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">999</span> <span class="hljs-comment">--  fk_org  ,     </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/tl/py/lb/tlpylbllwrea5ilsf-epratclha.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru] Todo</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
parece estar bien, incluso por índice, pero de alguna manera sospechosa, para cada uno de los 20 registros leídos, tuve que restar 4 páginas de datos, 32 KB por registro, ¿no está en negrita? </font><font style="vertical-align: inherit;">Sí, y el nombre del índice es </font><font style="vertical-align: inherit;">sugerente. </font><font style="vertical-align: inherit;">
Arreglemos:</font></font><code>tbl_<b>fk_org</b>_fk_cli_idx</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli);</code></pre><br>
<img src="https://habrastorage.org/webt/n9/5x/uz/n95xuzh7tcrmlv3eqg-bq2axhk4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
De repente, ¡ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 veces más rápido y 4 veces menos leído</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se pueden ver otros ejemplos de situaciones de uso ineficiente de índices en el artículo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA: Buscar índices inútiles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 7: CTE × CTE</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la consulta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribimos CTE "gordos"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de diferentes tablas, y luego decidimos hacer entre ellos </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El caso es relevante para versiones inferiores a v12 o solicitudes de </font></font><code>WITH MATERIALIZED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; CTE Scan<font></font>
   &amp;&amp; loops &gt; 10<font></font>
   &amp;&amp; loops × (rows + RRbF) &gt; 10000<font></font>
      --     CTE<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analice cuidadosamente la solicitud: ¿ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se necesita CTE aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Si es lo mismo, entonces </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplique "rasgado" en hstore / json de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acuerdo con el modelo descrito en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: golpee el diccionario con un JOIN pesado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 8: cambiar a disco (temp escrito)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El procesamiento único (clasificación o unificación) de un gran número de registros no cabe en la memoria asignada para esto.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; temp written &gt; 0</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la cantidad de memoria utilizada por la operación no excede en gran medida el valor establecido del parámetro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_mem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vale la pena ajustarlo. </font><font style="vertical-align: inherit;">Puede inmediatamente en la configuración para todos, pero puede hacerlo </font></font><code>SET [LOCAL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para una solicitud / transacción específica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SHOW</span> work_mem;
<span class="hljs-comment">-- "16MB"</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  random()<font></font>
<span class="hljs-keyword">FROM</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/x-/mu/my/x-mumysko4noy3qy8qhdk0fecpq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correcto:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> work_mem = <span class="hljs-string">'128MB'</span>; <span class="hljs-comment">--   </span></code></pre><br>
<img src="https://habrastorage.org/webt/h0/4z/kx/h04zkxsgcscgj8yxdasba8jdi2s.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Por razones obvias, si solo se usa memoria, no un disco, la solicitud se ejecutará mucho más rápido. </font><font style="vertical-align: inherit;">Al mismo tiempo, también se elimina parte de la carga del HDD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero debe comprender que asignar una gran cantidad de memoria tampoco siempre funciona, no será suficiente para todos.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 9: estadísticas irrelevantes</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vertieron mucho de una vez en la base de datos, pero no lograron ahuyentarlos </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; ratio &gt;&gt; 10</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Haz lo mismo </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta situación se describe con más detalle en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: las estadísticas están en la cabeza</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 10: "algo salió mal"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando surge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Había una expectativa de un bloqueo impuesto por una solicitud competitiva, o no había suficientes recursos de hardware de CPU / hipervisor.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo reconocer</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; (shared hit / 8K) + (shared read / 1K) &lt; time / 1000<font></font>
      -- RAM hit = 64MB/s, HDD read = 8MB/s<font></font>
   &amp;&amp; time &gt; 100ms --  ,   <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sistema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externo </font><b><font style="vertical-align: inherit;">para monitorear el</font></b><font style="vertical-align: inherit;"> servidor en busca de bloqueos o consumo anormal de recursos. </font><font style="vertical-align: inherit;">Sobre nuestra versión de la organización de este proceso para cientos de servidores, ya hablamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/bi/9s/tsbi9svuilrqhgpgftjytkknpk4.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h7/zm/6d/h7zm6d-va_yx8g0mtxbdkyevcwq.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492676/index.html">Memoria en núcleos magnéticos en el cohete Saturno 5</a></li>
<li><a href="../es492678/index.html">Desarrollo del primer proyecto en la plataforma de Microsoft Dynamics 365 para Finanzas y Operaciones</a></li>
<li><a href="../es492682/index.html">Testosterona, ¿por qué es para los hombres y cómo mantener la fuerza en la vejez?</a></li>
<li><a href="../es492684/index.html">Servidor proxy gratuito para empresas con autenticación de dominio</a></li>
<li><a href="../es492686/index.html">Cuando Linux Conntrack ya no es tu amigo</a></li>
<li><a href="../es492696/index.html">¿Sobre qué probar algoritmos para el reconocimiento y procesamiento de documentos de identidad?</a></li>
<li><a href="../es492700/index.html">Compras declarativas por Internet con API de solicitud de pago y angular</a></li>
<li><a href="../es492702/index.html">Traducción automática De la guerra fría al presente</a></li>
<li><a href="../es492704/index.html">Para aumentar la efectividad de la supervivencia del implante en 5-7 veces, ¿cómo es esto posible?</a></li>
<li><a href="../es492706/index.html">Archivos de memoria: cómo el cerebro codifica y reproduce recuerdos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>