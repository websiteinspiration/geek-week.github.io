<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß£ üë©‚Äç‚öñÔ∏è üë®üèª‚Äçüíª Nuestra experiencia de migraci√≥n Cassandra entre cl√∫steres de Kubernetes sin p√©rdida de datos ‚õ∏Ô∏è üéé ‚òïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante los √∫ltimos seis meses, hemos utilizado el operador Rook para trabajar con Cassandra en Kubernetes . Sin embargo, cuando necesit√°bamos realiza...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nuestra experiencia de migraci√≥n Cassandra entre cl√∫steres de Kubernetes sin p√©rdida de datos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498076/"><img src="https://habrastorage.org/webt/bt/dz/eh/btdzeh5vf-wcqspevi_adr6exds.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante los √∫ltimos seis meses, hemos utilizado el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operador Rook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para trabajar con Cassandra en Kubernetes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sin embargo, cuando necesit√°bamos realizar una operaci√≥n muy trivial, parecer√≠a: cambiar los par√°metros en la configuraci√≥n de Cassandra, result√≥ que el operador no proporcionaba suficiente flexibilidad. </font><font style="vertical-align: inherit;">Para realizar cambios, era necesario clonar el repositorio, realizar cambios en las fuentes y reconstruir el operador (la configuraci√≥n est√° integrada en el operador, por lo que el conocimiento de Go sigue siendo √∫til). </font><font style="vertical-align: inherit;">Todo esto lleva mucho tiempo. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Ya hicimos una</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
revisi√≥n de los operadores existentes </font><font style="vertical-align: inherit;">, y esta vez nos detuvimos en </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">CassKop de Orange</font></a><font style="vertical-align: inherit;"> , que admite las caracter√≠sticas necesarias, en particular, configuraciones personalizadas y monitoreo </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">listo</font></a><font style="vertical-align: inherit;"> para </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">usar</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarea</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la historia real, que se discutir√° m√°s adelante, se decidi√≥ combinar el cambio de operador con la necesidad urgente de transferir toda la infraestructura del cliente al nuevo cl√∫ster. </font><font style="vertical-align: inherit;">Despu√©s de la migraci√≥n de las principales cargas de trabajo de aplicaciones importantes, solo qued√≥ Cassandra, cuya p√©rdida de datos, por supuesto, era inaceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Requisitos para su migraci√≥n:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El tiempo de inactividad m√°ximo es de 2-3 minutos para llevar a cabo esta transferencia al mismo tiempo que la aplicaci√≥n se transfiere a un nuevo cl√∫ster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transfiera todos los datos sin p√©rdida y dolor de cabeza (es decir, sin ninguna manipulaci√≥n adicional).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo llevar a cabo tal operaci√≥n? Por analog√≠a con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decidimos lanzar una nueva instalaci√≥n de Cassandra en un nuevo cl√∫ster de Kubernetes, luego fusionar las dos Cassandra en diferentes grupos y transferir los datos, finalizando todo el proceso simplemente deshabilitando la instalaci√≥n original.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, fue complicado por el hecho de que las redes dentro de Kubernetes se cruzan, por lo que no fue tan f√°cil configurar la conexi√≥n. </font><font style="vertical-align: inherit;">Se requer√≠a registrar rutas para cada pod en cada nodo, lo que lleva mucho tiempo y no es confiable en absoluto. </font><font style="vertical-align: inherit;">El hecho es que la comunicaci√≥n a trav√©s de pods IP solo funciona con maestros, y Cassandra se ejecuta en nodos dedicados. </font><font style="vertical-align: inherit;">Por lo tanto, primero debe configurar la ruta al maestro y ya en el maestro, a otro cl√∫ster. </font><font style="vertical-align: inherit;">Adem√°s de esto, reiniciar el pod implica un cambio en IP, y este es otro problema ... ¬øPor qu√©? </font><font style="vertical-align: inherit;">Lea sobre esto m√°s adelante en el art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la parte pr√°ctica posterior del art√≠culo, se utilizar√°n tres notaciones para los grupos de Cassandra:</font></font><br>
<br>
<ul>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la nueva instalaci√≥n que lanzaremos en el nuevo cl√∫ster de Kubernetes;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : una instalaci√≥n antigua con la que las aplicaciones est√°n trabajando actualmente;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una instalaci√≥n temporal que ejecutamos junto a Cassandra-current y la usamos solo para el proceso de migraci√≥n en s√≠.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo ser?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utiliza almacenamiento local, una simple migraci√≥n de sus datos a un nuevo cl√∫ster, esto podr√≠a ser, por ejemplo, en el caso de discos vSphere ... es imposible. </font><font style="vertical-align: inherit;">Para resolver este problema, crearemos un cl√∫ster temporal, utiliz√°ndolo como una especie de b√∫fer para la migraci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La secuencia general de acciones se reduce a los siguientes pasos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eleve </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new con un</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nuevo operador en un nuevo cl√∫ster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escala a 0 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-nuevo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cl√∫ster </font><font style="vertical-align: inherit;">.</font></font></li>
<li>  ,  PVC,    .</li>
<li>  <i>Cassandra-temporary</i>       <i>Cassandra-current</i> ,      <i>Cassandra-new</i>.</li>
<li>   <i>Cassandra-temporary</i>  0 (     )    <i>Cassandra-temporary</i> ,  <i>Cassandra-temporary</i>   <i>Cassandra-current</i>.      <b></b> Cassandra  <b></b> <i>-</i> (       Cassandra     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfiera datos entre los centros de datos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-actual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escale los cl√∫steres </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a 0 y ejecute </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el nuevo cl√∫ster, sin olvidar tirar los discos. </font><font style="vertical-align: inherit;">Paralelamente, trasladamos las aplicaciones a un nuevo cl√∫ster.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de tales manipulaciones, el tiempo de inactividad ser√° m√≠nimo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En detalle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No deber√≠a haber ning√∫n problema con los primeros 3 pasos: todo se hace r√°pida y f√°cilmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, el cl√∫ster </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se ver√° m√°s o menos as√≠:</font></font><br>
<br>
<pre><code class="bash hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar que todo funcione como se esperaba, cree un espacio de teclas en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esto se hace antes del lanzamiento de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">create keyspace example with replication ={'class' : 'NetworkTopologyStrategy', 'x1':2};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, cree una tabla y ll√©nela con datos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">use</span> example;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> example(<span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span> PRIMARY <span class="hljs-keyword">KEY</span>, <span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>, phone varint);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'Masha'</span>, <span class="hljs-number">983123123</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>,<span class="hljs-string">'Sergey'</span>, <span class="hljs-number">912121231</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'Andrey'</span>, <span class="hljs-number">914151617</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , recordando que antes de eso, en el nuevo cl√∫ster, ya lanzamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (paso # 1) y ahora est√° apagado (paso # 2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando comenzamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , debemos especificar el mismo nombre (con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) del cl√∫ster. </font><font style="vertical-align: inherit;">Esto se puede hacer a trav√©s de una variable </font></font><code>CASSANDRA_CLUSTER_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vea el grupo actual, debe establecer las semillas. </font><font style="vertical-align: inherit;">Esto se hace a trav√©s de una variable </font></font><code>CASSANDRA_SEEDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o de una configuraci√≥n.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Atenci√≥n! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de comenzar a mover datos, debe asegurarse de que los tipos de coherencia de lectura y escritura est√©n establecidos en </font></font><code>LOCAL_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>LOCAL_QUORUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comience </font><font style="vertical-align: inherit;">, el cl√∫ster deber√≠a verse as√≠ (observe la apariencia de un segundo centro de datos con 3 nodos):</font></font><br>
<br>
<pre><code class="plaintext hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1<font></font>
<font></font>
Datacenter: x2<font></font>
===============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address       Load       Tokens       Owns (effective)  Host ID                               Rack<font></font>
UN  10.244.16.96  267.07 KiB  256          64.4%             3619841e-64a0-417d-a497-541ec602a996  rack1<font></font>
UN  10.244.18.67  248.29 KiB  256          65.8%             07a2f571-400c-4728-b6f7-c95c26fe5b11  rack1<font></font>
UN  10.244.16.95  265.85 KiB  256          69.8%             2f4738a2-68d6-4f9e-bf8f-2e1cfc07f791  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puedes realizar la transferencia. </font><font style="vertical-align: inherit;">Para hacer esto, primero transfiera el espacio clave de prueba; aseg√∫rese de que todo est√© bien:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', x1: 2, x2: 2};</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, en cada pod </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">ejecute el comando:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool rebuild -ks example x1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vayamos a cualquier pod de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y verifiquemos que los datos hayan sido transferidos. </font><font style="vertical-align: inherit;">Tambi√©n puede agregar 1 entrada m√°s a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para verificar que los nuevos datos hayan comenzado a replicarse:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> example;<font></font>
<font></font>
 id | name   | phone<font></font>
<span class="hljs-comment">----+--------+-----------</span><font></font>
  1 |  Masha | 983123123<font></font>
  2 | Sergey | 912121231<font></font>
  3 | Andrey | 914151617<font></font>
<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, puede hacer </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los espacios de teclas en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y ejecutar </font></font><code>nodetool rebuild</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de espacio y memoria.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta etapa, es √∫til recordar que cuando se est√° ejecutando la reconstrucci√≥n, se crean archivos temporales que tienen un tama√±o equivalente al tama√±o del espacio de teclas. </font><font style="vertical-align: inherit;">Nos encontramos con un problema de que el espacio de teclas m√°s grande era de 350 GB y hab√≠a menos espacio libre en disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No fue posible expandir el disco porque se usa localstorage. </font><font style="vertical-align: inherit;">El siguiente comando vino al rescate (ejecutado en cada pod de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs">nodetool clearsnapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que se liber√≥ el lugar: en nuestro caso, se obtuvieron 500 GB de espacio libre en disco en lugar de los 200 GB disponibles anteriormente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, a pesar del hecho de que hab√≠a suficiente espacio, la operaci√≥n de reconstrucci√≥n constantemente causaba el reinicio de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">las</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√°psulas </font><i><font style="vertical-align: inherit;">temporales</font></i><font style="vertical-align: inherit;"> de </font><i><font style="vertical-align: inherit;">Cassandra</font></i><font style="vertical-align: inherit;"> con un error:</font></font><br>
<br>
<pre><code class="plaintext hljs">failed; error='Cannot allocate memory' (errno=12)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo decidimos creando DaemonSet, que se implementa solo en nodos con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y realiza:</font></font><br>
<br>
<pre><code class="bash hljs">sysctl -w vm.max_map_count=262144</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Finalmente, todos los datos han sido migrados!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambio de cl√∫ster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo quedaba cambiar la Cassandra, que se llev√≥ a cabo en 5 etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escala </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (¬°no olvides que el operador todav√≠a trabaja aqu√≠!) A 0.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambie los discos (se reduce a configurar PV para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenzamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , rastreando que los discos necesarios est√°n conectados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacemos </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas las tablas para eliminar el cl√∫ster antiguo:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', 'x2': 2};</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eliminar todos los nodos del cl√∫ster antiguo. </font><font style="vertical-align: inherit;">Para hacer esto, simplemente ejecute este comando en uno de sus pods:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool removenode 3619841e-64a0-417d-a497-541ec602a996</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tiempo de inactividad total de Cassandra fue de aproximadamente 3 minutos: este es el momento en que los contenedores se detuvieron y comenzaron, ya que los discos se prepararon de antemano.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toque final con Prometeo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, esto no termin√≥ all√≠. </font><font style="vertical-align: inherit;">Hay </font><font style="vertical-align: inherit;">un exportador incorporado </font><font style="vertical-align: inherit;">con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(consulte la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n del nuevo operador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; por supuesto, lo usamos. </font><font style="vertical-align: inherit;">Aproximadamente 1 hora despu√©s del lanzamiento, comenzaron a llegar alertas sobre la inaccesibilidad de Prometheus. </font><font style="vertical-align: inherit;">Despu√©s de verificar la carga, vimos que el consumo de memoria en los nodos con Prometheus ha aumentado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un estudio adicional del problema mostr√≥ que el n√∫mero de m√©tricas recopiladas aument√≥ en 2,5 veces (!). </font><font style="vertical-align: inherit;">La culpa fue Cassandra, con la que se recopilaron poco m√°s de 500 mil m√©tricas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizamos una auditor√≠a de las m√©tricas y deshabilitamos las que no consideramos necesarias, a trav√©s de ConfigMap (en √©l, por cierto, el exportador est√° configurado). </font><font style="vertical-align: inherit;">El resultado es 120 mil m√©tricas y una carga significativamente reducida en Prometheus (a pesar del hecho de que quedan m√©tricas importantes).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que logramos transferir Cassandra a otro cl√∫ster, pr√°cticamente sin afectar el funcionamiento de la instalaci√≥n de producci√≥n de Cassandra y sin interferir con el trabajo de las aplicaciones del cliente. </font><font style="vertical-align: inherit;">En el camino, llegamos a la conclusi√≥n de que usar la misma red de pod no es una buena idea (ahora estamos m√°s atentos a la planificaci√≥n inicial para instalar el cl√∫ster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente: ¬øpor qu√© no utilizamos la herramienta </font></font><code>nodetool snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencionada en el art√≠culo anterior? </font><font style="vertical-align: inherit;">El hecho es que este comando crea una instant√°nea de espacio de teclas en el estado en que estaba antes de que se ejecutara el comando. </font><font style="vertical-align: inherit;">Adem√°s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> toma mucho m√°s tiempo tomar una foto y transferirla;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo lo que est√° escrito en este momento en Cassandra se perder√°;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple en nuestro caso ser√≠a aproximadamente una hora, en lugar de 3 minutos, que result√≥ combinarse con √©xito con la implementaci√≥n de la aplicaci√≥n en un nuevo cl√∫ster.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea tambi√©n en nuestro blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraci√≥n de Cassandra a Kubernetes: caracter√≠sticas y soluciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una historia con el operador de Redis en K8 y una mini descripci√≥n de las utilidades para analizar datos de esta base de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraci√≥n de MongoDB sin obst√°culos a Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraci√≥n RabbitMQ sin obst√°culos a Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de datos y Kubernetes (revisi√≥n e informe de video)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498064/index.html">Emulador de mercado cl√°sico</a></li>
<li><a href="../es498066/index.html">C√≥mo SFP, SFP + y XFP hacen nuestra vida m√°s f√°cil</a></li>
<li><a href="../es498070/index.html">Colmena - base local r√°pida para Flutter, Dart</a></li>
<li><a href="../es498072/index.html">Efecto de trama para Atari 65XE</a></li>
<li><a href="../es498074/index.html">Marque este art√≠culo si es nuevo en Python (especialmente si est√° aprendiendo Python usted mismo)</a></li>
<li><a href="../es498080/index.html">Experiencia de migraci√≥n a SAP HANA 2.0 en grandes proyectos minoristas de pruebas automatizadas para Sberbank y otros casos</a></li>
<li><a href="../es498084/index.html">Las ventas est√°n muertas. ¬øQu√© hacer a continuaci√≥n?</a></li>
<li><a href="../es498086/index.html">Deja que florezcan cien misiles reutilizables</a></li>
<li><a href="../es498088/index.html">C√≥mo trabajan los investigadores de Avito</a></li>
<li><a href="../es498090/index.html">Las dunas de arena pueden "comunicarse" entre s√≠</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>