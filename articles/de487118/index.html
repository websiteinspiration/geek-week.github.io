<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏼 🕐 ◽️ Loki - Sammeln von Protokollen nach dem Prometheus-Ansatz 🍎 😵 🐄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gruß, Chabrowiten! Im Vorgriff auf den Start eines neuen Sets für den DevOps Practices and Tools- Kurs haben wir für Sie eine Übersetzung von interess...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Loki - Sammeln von Protokollen nach dem Prometheus-Ansatz</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/487118/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gruß, Chabrowiten! </font><font style="vertical-align: inherit;">Im Vorgriff auf den Start eines neuen Sets für den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DevOps Practices and Tools-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kurs </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">haben wir</font></a><font style="vertical-align: inherit;"> für Sie eine Übersetzung von interessantem Material vorbereitet.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/rb/vv/kv/rbvvkvqoi8amlv_ndkojxwj283q.png"><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel ist eine kurze Einführung in Loki. </font><font style="vertical-align: inherit;">Das Loki-Projekt wird </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von Grafana unterstützt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und zielt darauf ab, Protokolle (von Servern oder Containern) zentral zu sammeln. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hauptinspirationsquelle für Loki war </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit der Idee, seine Log-Management-Ansätze anzuwenden:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendung von Etiketten (Etiketten) zur Datenspeicherung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geringer Ressourcenverbrauch</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden auf die Prinzipien von Prometheus zurückkommen und einige Beispiele für seine Verwendung im Kontext von Kubernetes geben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein paar Worte zu Prometheus </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, wie Loki funktioniert, ist es wichtig, einen Schritt zurückzutreten und sich ein wenig an Prometheus zu erinnern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines der charakteristischen Merkmale von Prometheus ist die Extraktion von Metriken aus Sammelstellen (über Exporteure) und deren Speicherung in der TSDB (Zeitreihendatenbank, Zeitreihendatenbank) unter Hinzufügung von Metadaten in Form von Beschriftungen.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum ist es notwendig?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In letzter Zeit ist Prometheus zum De-facto-Standard in der Welt der Container und Kubernetes geworden: Die Installation ist sehr einfach, und der Kubernetes-Cluster verfügt zunächst über einen Endpunkt für Prometheus. </font><font style="vertical-align: inherit;">Prometheus kann auch Metriken aus Anwendungen abrufen, die in einem Container bereitgestellt werden, wobei bestimmte Tags beibehalten werden. </font><font style="vertical-align: inherit;">Daher ist die Überwachung von Anwendungen sehr einfach zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider gibt es immer noch keine schlüsselfertige Lösung für die Verwaltung von Protokollen, und Sie müssen eine Lösung für sich selbst finden:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verwalteter Cloud-Dienst zur Zentralisierung von Protokollen (AWS, Azure oder Google)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Überwachung als Dienstüberwachungsdienst (z. B. Datadog)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen eines eigenen Protokollsammlungsdienstes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der dritten Option habe ich traditionell Elasticsearch verwendet, obwohl ich nicht immer damit zufrieden war (insbesondere mit der Schwere und Komplexität der Einstellungen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loki wurde entwickelt, um die Implementierung gemäß den folgenden Prinzipien zu vereinfachen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seien Sie einfach, um loszulegen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verbrauchen wenige Ressourcen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeiten Sie unabhängig und ohne besondere Wartung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergänzen Sie Prometheus, um Fehler zu untersuchen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Einfachheit wird jedoch durch einige Kompromisse erreicht. </font><font style="vertical-align: inherit;">Eine davon ist, Inhalte nicht zu indizieren. </font><font style="vertical-align: inherit;">Daher ist die Textsuche nicht sehr effektiv oder umfangreich und erlaubt keine Statistiken über den Inhalt des Textes. </font><font style="vertical-align: inherit;">Aber da Loki das Äquivalent von grep sein und den Prometheus ergänzen möchte, ist dies kein Fehler.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorfalluntersuchung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um besser zu verstehen, warum Loki keine Indizierung benötigt, kehren wir zu der von den Loki-Entwicklern verwendeten Methode zur Untersuchung von Vorfällen zurück: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9x/sp/rn/9xsprnklb6bomy1xmhkegiywwpw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Warnung → 2 Dashboard → 3 Ad-hoc-Abfrage → 4 Protokollaggregation → 5 Verteilte Ablaufverfolgung → 6 Korrektur! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1 Warnung → 2 Dashboards → 3 Ad-hoc-Abfrage → 4 Protokollaggregation → 5 verteilte Ablaufverfolgung → 6 Korrektur!)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Die Idee ist, dass wir eine Warnung erhalten (Slack-Benachrichtigung, SMS usw.) und danach:</font></font><br>
<br>
<ul>
<li>  Grafana</li>
<li>   (,  Prometheus)</li>
<li>   (,  Elasticsearch)</li>
<li>,     (Jaeger, Zipkin  .)</li>
<li>, ,   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier müssen Sie im Fall des Stapels Grafana + Prometheus + Elasticsearch + Zipkin vier verschiedene Werkzeuge verwenden. </font><font style="vertical-align: inherit;">Um die Zeit zu verkürzen, wäre es schön, alle diese Schritte mit einem Werkzeug ausführen zu können: Grafana. </font><font style="vertical-align: inherit;">Es ist erwähnenswert, dass dieser Forschungsansatz seit Version 6 in Grafana implementiert ist. Auf diese Weise kann direkt von Grafana aus auf Prometheus-Daten zugegriffen werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ur/bg/r4urbgqrnkgms5wiga5jvbvw4li.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aufgeteilter Explorer-Bildschirm zwischen Prometheus und Loki</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Auf diesem Bildschirm können Sie Loki-Protokolle anzeigen, die sich auf Prometheus-Metriken beziehen, indem Sie das Split-Screen-Konzept verwenden. </font><font style="vertical-align: inherit;">Ab Version 6.5 können Sie mit Grafana die Trace-ID in den Loki-Protokolleinträgen verarbeiten, um den Links zu Ihren bevorzugten verteilten Tracking-Tools (Jaeger) zu folgen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki Lokaler Test</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der einfachste Weg, Loki lokal zu testen, ist die Verwendung von Docker-Compose. </font><font style="vertical-align: inherit;">Die Docker-Compose-Datei befindet sich im Loki-Repository. </font><font style="vertical-align: inherit;">Sie können das Repository mit dem folgenden Befehl abrufen </font></font><code>git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="go hljs">$ git clone https:<span class="hljs-comment">//github.com/grafana/loki.git</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann müssen Sie in das Produktionsverzeichnis gehen:</font></font><br>
<br>
<pre><code class="go hljs">$ cd production</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach können Sie die neueste Version der Docker-Images herunterladen:</font></font><br>
<br>
<pre><code class="go hljs">$ docker-compose pull</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schließlich wird der Loki-Stack mit dem folgenden Befehl gestartet:</font></font><br>
<br>
<pre><code class="go hljs">$ docker-compose up</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki Architektur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein kleines Diagramm mit der Loki-Architektur: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7z/-5/hd/7z-5hd6ycmdocdvzsrcmwjydsbs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prinzipien der Loki-Architektur Der</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Web-Client startet Anwendungen auf dem Server, Promtail sammelt Protokolle und sendet sie an Loki, der Web-Client sendet auch Metadaten an Loki. </font><font style="vertical-align: inherit;">Loki aggregiert alles und überträgt es an Grafana. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loki ist am Laufen. </font><font style="vertical-align: inherit;">Führen Sie den folgenden Befehl aus, um die verfügbaren Komponenten anzuzeigen:</font></font><br>
<br>
<pre><code class="go hljs">$ docker ps</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei einem frisch installierten Docker sollte der Befehl das folgende Ergebnis zurückgeben:</font></font><br>
<br>
<pre><code class="go hljs">IMAGE               PORTS                  NAMES<font></font>
grafana/promtail:                          production_promtail_1<font></font>
grafana/grafana: m  <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">3000</span>-&gt;<span class="hljs-number">3000</span>/tcp production_grafana_1<font></font>
grafana/loki: late  <span class="hljs-number">80</span>/tcp,<span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">3100.</span>.. production_loki_1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen die folgenden Komponenten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promtail: Agent zum Zentralisieren von Protokollen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana: Ein berühmtes Dashboard-Tool </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki: ein Datenzentralisierungs-Daemon</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Rahmen einer klassischen Infrastruktur (z. B. basierend auf virtuellen Maschinen) muss auf jeder Maschine ein Promtail-Agent bereitgestellt werden. </font><font style="vertical-align: inherit;">Grafana und Loki können auf demselben Computer installiert werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes-Bereitstellung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Installation von Loki-Komponenten auf Kubernetes erfolgt wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daemonSet zum Bereitstellen des Promtail-Agenten auf jedem Computer in einem Servercluster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitstellung Loki</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und schließlich der Einsatz von Grafana.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Glücklicherweise ist Loki als Helm-Paket erhältlich, was die Bereitstellung vereinfacht.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation über Helm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Helm sollte bereits installiert sein. </font><font style="vertical-align: inherit;">Es kann aus dem GitHub-Repository des Projekts heruntergeladen werden. </font><font style="vertical-align: inherit;">Die Installation erfolgt durch Entpacken des Archivs, das Ihrer Architektur entspricht, und Hinzufügen eines Helms </font></font><code>$PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<blockquote><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Helm Version 3.0.0 wurde kürzlich veröffentlicht. </font><font style="vertical-align: inherit;">Da es viele Änderungen gab, wird dem Leser empfohlen, ein wenig zu warten, bevor er es zuerst verwendet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzufügen einer Quelle für Helm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Schritt besteht darin, das "loki" -Repository mit dem folgenden Befehl hinzuzufügen:</font></font><br>
<br>
<pre><code class="go hljs">$ helm add loki https:<span class="hljs-comment">//grafana.github.io/loki/charts</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach können Sie nach Paketen mit dem Namen "loki" suchen:</font></font><br>
<br>
<pre><code class="go hljs">$ helm search loki</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ergebnis:</font></font><br>
<br>
<pre><code class="go hljs">loki/loki       <span class="hljs-number">0.17</span><span class="hljs-number">.2</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Loki: like Prometheus, but <span class="hljs-keyword">for</span> logs.<font></font>
loki/loki-stack <span class="hljs-number">0.19</span><span class="hljs-number">.1</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Loki: like Prometheus, but <span class="hljs-keyword">for</span> logs.<font></font>
loki/fluent-bit <span class="hljs-number">0.0</span><span class="hljs-number">.2</span>  v0<span class="hljs-number">.0</span><span class="hljs-number">.1</span> Uses fluent-bit Loki <span class="hljs-keyword">go</span> plugin <span class="hljs-keyword">for</span>...<font></font>
loki/promtail   <span class="hljs-number">0.13</span><span class="hljs-number">.1</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Responsible <span class="hljs-keyword">for</span> gathering logs and...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Pakete haben die folgenden Funktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das loki / loki-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket entspricht </font><font style="vertical-align: inherit;">nur dem Loki-Server</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit dem loki /</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fluent </font><b><font style="vertical-align: inherit;">-bit-</font></b><font style="vertical-align: inherit;"> Paket </font><font style="vertical-align: inherit;">können Sie DaemonSet mithilfe von fluent-bin bereitstellen, um Protokolle anstelle von Promtail zu sammeln</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Paket </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / promtail</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enthält eine Protokolldatei für den Sammlungsagenten</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / loki-stack-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket </font><font style="vertical-align: inherit;">können Sie Loki sofort zusammen mit Promtail bereitstellen.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki Installation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie den folgenden Befehl im Namespace "Überwachung" aus, um Loki für Kubernetes bereitzustellen:</font></font><br>
<br>
<pre><code class="go hljs">$ helm upgrade --install loki loki/loki-stack --namespace monitoring</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie die Option hinzu, um auf der Festplatte zu speichern </font></font><code>--set loki.persistence.enabled = true:</code><br>
<br>
<pre><code class="go hljs">$ helm upgrade --install loki loki/loki-stack \<font></font>
              --namespace monitoring \<font></font>
              --set loki.persistence.enabled=<span class="hljs-literal">true</span></code></pre><br>
<blockquote><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinweis:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wenn Sie Grafana gleichzeitig bereitstellen möchten, fügen Sie den Parameter hinzu</font></font><code>--set grafana.enabled = true</code></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie diesen Befehl ausführen, sollten Sie die folgende Ausgabe erhalten:</font></font><br>
<br>
<pre><code class="go hljs">LAST DEPLOYED: Tue Nov <span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">54</span> <span class="hljs-number">2019</span><font></font>
NAMESPACE: monitoring<font></font>
STATUS: DEPLOYED<font></font>
RESOURCES:<font></font>
==&gt; v1/ClusterRole<font></font>
NAME AGE<font></font>
loki-promtail-clusterrole <span class="hljs-number">189</span>d<font></font>
…<font></font>
NOTES:<font></font>
The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana.<font></font>
See &lt;a href=<span class="hljs-string">"http://docs.grafana.org/features/datasources/loki/"</span>&gt;http:<span class="hljs-comment">//docs.grafana.org/features/datasources/loki/&lt;/a&gt; for more details.</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir uns den Status der Herde im Namespace "Überwachung" ansehen, werden wir feststellen, dass alles erweitert ist:</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n monitoring get pods -l release=loki</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ergebnis:</font></font><br>
<br>
<pre><code class="go hljs">NAME                 READY  STATUS   RESTARTS  AGE<font></font>
loki<span class="hljs-number">-0</span>               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">147</span>m<font></font>
loki-promtail<span class="hljs-number">-9</span>zjvc  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">3</span>h25m<font></font>
loki-promtail-f6brf  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">11</span>h<font></font>
loki-promtail-hdcj7  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">3</span>h23m<font></font>
loki-promtail-jbqhc  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">11</span>h<font></font>
loki-promtail-mj642  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">62</span>m<font></font>
loki-promtail-nm64g  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">24</span>m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Pods laufen. </font><font style="vertical-align: inherit;">Jetzt ist es Zeit, einige Tests durchzuführen!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie eine Verbindung zu Grafana her </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um unter Kubernetes eine Verbindung zu Grafana herzustellen, müssen Sie einen Tunnel nach unten öffnen. </font><font style="vertical-align: inherit;">Das Folgende ist der Befehl zum Öffnen von Port 3000 für den Grafana-Herd:</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n port-forward monitoring svc/loki-grafana <span class="hljs-number">3000</span>:<span class="hljs-number">80</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer wichtiger Punkt ist die Notwendigkeit, das Grafana-Administratorkennwort wiederherzustellen. </font><font style="vertical-align: inherit;">Das Passwort wird </font></font><code>loki-grafana</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem Feld </font></font><code>.data.admin-user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Base64-Format </font><font style="vertical-align: inherit;">geheim gehalten </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um es wiederherzustellen, müssen Sie den folgenden Befehl ausführen:</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n monitoring get secret loki-grafana \<font></font>
 --template <span class="hljs-string">'{{index .data "admin-password" | base64decode}}'</span>; echo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie dieses Kennwort mit dem Standardadministratorkonto (admin).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definieren einer Loki-Datenquelle in Grafana </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie zunächst sicher, dass die Loki-Datenquelle (Konfiguration / Datenquelle) erstellt wurde. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ein Beispiel: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zu/0r/e6/zu0re6d6tzo5izslpttqpeaglz4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel für das Einrichten einer Datenquelle für Loki</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Durch Klicken auf „Test“ können Sie die Verbindung mit Loki überprüfen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anfragen an Loki</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie nun zu Grafanas Abschnitt "Erkunden". </font><font style="vertical-align: inherit;">Beim Empfang von Protokollen aus Containern fügt Loki Metadaten von Kubernetes hinzu. </font><font style="vertical-align: inherit;">Auf diese Weise können die Protokolle eines bestimmten Containers angezeigt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
: Zum Beispiel wird das folgende Abfrage-Promtail verwendet, um die Containerprotokolle auszuwählen </font></font><code>{container_name = "promtail"}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie außerdem sicher, dass Sie hier Ihre Loki-Datenquelle auswählen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Anforderung gibt die Aktivität der Container wie folgt zurück: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hc/jh/0h/hcjh0htns_lqzhmwmtd01wa4-5k.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Ergebnis der Anforderung in Grafana</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hinzufügen zum Dashboard</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ab Grafana 6.4 können Sie Informationen zu den Protokollen direkt in das Dashboard einfügen. </font><font style="vertical-align: inherit;">Danach kann der Benutzer schnell zwischen der Anzahl der Anforderungen auf seiner Site und den Anwendungsspuren wechseln. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das folgende Beispiel zeigt ein Dashboard, das diese Interaktion implementiert: Ein </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/xo/0w/acxo0wom7hyf0bfne2xtc2lyt6a.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel für ein Dashboard mit Prometheus-Metriken und Loki-Protokollen</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zukünftige Loki</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe im Mai / Juni mit Version 0.1 angefangen, Loki zu verwenden. Heute ist bereits Version 1 veröffentlicht, sogar 1.1 und 1.2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zugegebenermaßen war Version 0.1 nicht stabil genug. Aber 0,3 zeigte bereits echte Anzeichen von Reife, und die nächsten Versionen (0,4, dann 1,0) verstärkten diesen Eindruck nur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach 1.0.0 kann niemand mehr Ausreden haben, dieses wunderbare Tool nicht zu benutzen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere Verbesserungen sollten nicht Loki betreffen, sondern dessen Integration mit dem hervorragenden Grafana. Grafana 6.4 lässt sich bereits gut in Dashboards integrieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grafana 6.5, das kürzlich veröffentlicht wurde, verbessert diese Integration weiter, indem der Inhalt von Protokollen im JSON-Format automatisch erkannt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das folgende Video zeigt ein kleines Beispiel für diesen Mechanismus:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/de/hk/vi/dehkvinzf3xh6ed6yud7ptt4aye.gif"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden von in Grafana angezeigten Loki-Zeichenfolgen</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Es wird möglich, eines der JSON-Felder zu verwenden, z.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">externe Tool-Links</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filtern von Protokollinhalten</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können beispielsweise auf traceId klicken, um zu Zipkin oder Jaeger zu gelangen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Traditionell warten wir auf Ihre Kommentare und laden Sie zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einem offenen Webinar ein</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in dem wir über die Entwicklung der DevOps-Branche im Jahr 2019 sprechen und mögliche Entwicklungspfade für 2020 erörtern.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487118/">https://habr.com/ru/post/de487118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487106/index.html">RunUO-Prüfung des PVS-Studio-Analysators</a></li>
<li><a href="../de487108/index.html">Mobiles Spielerprofil: MyTracker Research</a></li>
<li><a href="../de487110/index.html">Slurm SRE. Ein komplettes Experiment mit Experten von Booking.com und Google.com</a></li>
<li><a href="../de487112/index.html">Rand des Wahnsinns: Der Grundkreis</a></li>
<li><a href="../de487116/index.html">Warum Discord von Go nach Rust migriert</a></li>
<li><a href="../de487120/index.html">Wie man Kätzchen verteilt</a></li>
<li><a href="../de487122/index.html">Google JavaScript Style Guide Übersetzung</a></li>
<li><a href="../de487124/index.html">Interview mit Borey Yangel über Yandex Selbstfahrer und Alices Schöpfungsgeschichte</a></li>
<li><a href="../de487126/index.html">Wie Unternehmensentwicklungsteams GitLab und Mattermost ChatOps verwenden, um die Entwicklung zu beschleunigen</a></li>
<li><a href="../de487132/index.html">Wie wir ein verteiltes Team von mehreren hundert Mitarbeitern zu SAAS transferierten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>