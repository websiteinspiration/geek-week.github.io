<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöñ üë®‚Äçüëß‚Äçüë¶ üôèüèΩ Analisis operasional dalam arsitektur layanan mikro: membantu dan menyarankan Postgres FDW üèÅ üë©‚ÄçüöÄ üë©üèæ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Arsitektur microservice, seperti semua yang ada di dunia ini, memiliki pro dan kontra. Beberapa proses dengannya menjadi lebih mudah, yang lain lebih ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Analisis operasional dalam arsitektur layanan mikro: membantu dan menyarankan Postgres FDW</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arsitektur microservice, seperti semua yang ada di dunia ini, memiliki pro dan kontra. Beberapa proses dengannya menjadi lebih mudah, yang lain lebih rumit. Dan demi kecepatan perubahan dan skalabilitas yang lebih baik, pengorbanan harus dilakukan. Salah satunya adalah komplikasi analitik. Jika dalam monolit semua analitik operasional dapat direduksi menjadi SQL queries untuk replika analitik, maka dalam arsitektur multiservice, setiap layanan memiliki basisnya sendiri dan tampaknya satu query tidak dapat ditiadakan (atau dapatkah dihilangkan?). Bagi mereka yang tertarik pada bagaimana kami memecahkan masalah analitik operasional di perusahaan kami dan bagaimana kami belajar untuk hidup dengan solusi ini - selamat datang.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nama saya Pavel Sivash, di DomKlik saya bekerja di sebuah tim yang bertanggung jawab untuk menjaga gudang data analitis. Secara konvensional, kegiatan kami dapat dikaitkan dengan tanggal rekayasa, tetapi, pada kenyataannya, berbagai tugas jauh lebih luas. Ada standar ETL / ELT untuk rekayasa tanggal, dukungan dan adaptasi alat untuk analisis data dan pengembangan alat mereka sendiri. Khususnya, untuk pelaporan operasional, kami memutuskan untuk "berpura-pura" bahwa kami memiliki monolit dan memberikan analis satu basis di mana mereka akan memiliki semua data yang mereka butuhkan.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, kami mempertimbangkan opsi yang berbeda. Dimungkinkan untuk membangun repositori lengkap - kami bahkan mencoba, tetapi jujur ‚Äã‚Äãsaja, kami gagal menjalin pertemanan yang cukup sering dalam logika dengan proses yang agak lambat dalam membangun repositori dan membuat perubahan padanya (jika seseorang berhasil, tuliskan di komentar caranya). Orang bisa mengatakan kepada analis: "Guys, pelajari python, dan ikuti petunjuk analitik", tetapi ini adalah persyaratan tambahan untuk perekrutan staf, dan tampaknya ini harus dihindari jika mungkin. Kami memutuskan untuk mencoba menggunakan teknologi FDW (Foreign Data Wrapper): pada kenyataannya, ini adalah standar dblink, yang ada dalam standar SQL, tetapi dengan antarmuka yang jauh lebih nyaman. Atas dasar itu, kami membuat keputusan, yang akhirnya diselesaikan, kami berhenti di atasnya. Detailnya adalah subjek dari artikel terpisah, atau mungkin bukan satu,karena saya ingin berbicara tentang banyak hal: mulai dari sinkronisasi skema basis data hingga kontrol akses dan penganoniman data pribadi. Anda juga perlu membuat reservasi bahwa solusi ini bukan pengganti untuk database dan repositori analitis nyata, itu hanya memecahkan masalah tertentu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tingkat atas terlihat seperti ini:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada database PostgreSQL, di mana pengguna dapat menyimpan data kerja mereka, dan yang paling penting, replika analitis semua layanan terhubung ke database ini melalui FDW. </font><font style="vertical-align: inherit;">Ini memungkinkan untuk menulis kueri ke beberapa basis data, tidak peduli apa itu: PostgreSQL, MySQL, MongoDB atau yang lainnya (file, API, jika tiba-tiba tidak ada pembungkus yang cocok, Anda dapat menulis sendiri). </font><font style="vertical-align: inherit;">Yah, semuanya tampak super! </font><font style="vertical-align: inherit;">Apakah kita terpecah? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika semuanya berakhir begitu cepat dan sederhana, maka, mungkin, tidak akan ada artikel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting untuk memahami dengan jelas bagaimana postgres menangani permintaan ke server jarak jauh. </font><font style="vertical-align: inherit;">Ini tampaknya logis, tetapi seringkali mereka tidak memperhatikannya: postgres membagi permintaan menjadi bagian-bagian yang dilakukan pada server jarak jauh secara independen, mengumpulkan data ini, dan perhitungan akhir dilakukan dengan sendirinya, sehingga kecepatan permintaan akan sangat tergantung pada bagaimana ditulisnya. </font><font style="vertical-align: inherit;">Perlu juga dicatat: ketika data berasal dari server jauh, mereka tidak lagi memiliki indeks, tidak ada yang dapat membantu penjadwal, oleh karena itu, hanya kami yang bisa membantu dan menyarankannya. </font><font style="vertical-align: inherit;">Dan saya ingin memberi tahu Anda lebih banyak tentang itu.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan dan rencana sederhana dengan itu</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memperlihatkan bagaimana postgres mengeksekusi kueri pada tabel 6 juta baris pada server jarak jauh, mari kita lihat rencana sederhana.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menggunakan instruksi VERBOSE memungkinkan Anda untuk melihat permintaan yang akan dikirim ke server jarak jauh dan hasil yang akan kami terima untuk diproses lebih lanjut (baris RemoteSQL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita melangkah lebih jauh dan menambahkan beberapa filter ke kueri kami: satu dengan </font><font style="vertical-align: inherit;">bidang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boolean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , satu oleh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam interval, dan satu oleh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sinilah saat terletak bahwa Anda perlu memperhatikan saat menulis pertanyaan. </font><font style="vertical-align: inherit;">Filter tidak ditransfer ke server jarak jauh, yang berarti untuk menjalankannya, postgres memperluas semua 6 juta baris, hanya untuk memfilternya secara lokal nanti (Filter line) dan melakukan agregasi. </font><font style="vertical-align: inherit;">Kunci kesuksesan adalah menulis permintaan sehingga filter ditransfer ke mesin jarak jauh, dan kami hanya menerima dan mengagregasi baris yang diperlukan.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu booleanshit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan bidang boolean, semuanya sederhana. </font><font style="vertical-align: inherit;">Dalam permintaan awal, masalahnya adalah karena pernyataan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika kita menggantinya dengan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , maka kita mendapatkan hasil berikut:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda lihat, filter terbang ke server jauh, dan runtime dikurangi dari 27 menjadi 19 detik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlu dicatat bahwa operator </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> berbeda dari operator </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di mana ia dapat bekerja dengan nilai Null. </font><font style="vertical-align: inherit;">Ini berarti bahwa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak Benar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam filter akan meninggalkan False dan Null, sementara </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = Benar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hanya akan meninggalkan False. </font><font style="vertical-align: inherit;">Oleh karena itu, ketika mengganti </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bukan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator, dua kondisi dengan operator ATAU harus diteruskan ke filter, misalnya, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE (col! = True) ATAU (col adalah nol)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan boolean disortir, lanjutkan. </font><font style="vertical-align: inherit;">Sementara itu, kembalikan filter dengan nilai Boolean ke bentuk aslinya, untuk secara independen mempertimbangkan efek perubahan lainnya.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamptz? </font><font style="vertical-align: inherit;">hz</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, kita sering harus bereksperimen dengan cara menulis kueri yang melibatkan server jauh, dan hanya kemudian mencari penjelasan mengapa ini terjadi. Sangat sedikit informasi tentang ini yang dapat ditemukan di Internet. Jadi, dalam percobaan, kami menemukan bahwa filter berdasarkan tanggal tetap terbang ke server jauh dengan bang, tetapi ketika kami ingin mengatur tanggal secara dinamis, misalnya sekarang () atau CURRENT_DATE, ini tidak terjadi. Dalam contoh kami, kami menambahkan filter sehingga kolom Created_at berisi data tepat untuk 1 bulan yang lalu (BETWEEN CURRENT_DATE - INTERVAL '7 bulan' DAN CURRENT_DATE - INTERVAL '6 bulan'). Apa yang telah kami lakukan dalam kasus ini?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mendorong penjadwal untuk menghitung tanggal di subquery di muka dan meneruskan variabel yang sudah jadi ke filter. </font><font style="vertical-align: inherit;">Dan petunjuk ini memberi kami hasil yang sangat baik, permintaan menjadi hampir 6 kali lebih cepat! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekali lagi, penting untuk berhati-hati di sini: tipe data dalam subquery harus sama dengan bidang yang kita filter, jika tidak, penjadwal akan memutuskan bahwa karena tipe berbeda dan Anda harus terlebih dahulu mendapatkan semua data dan memfilternya secara lokal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kembalikan filter berdasarkan tanggal ke nilai aslinya.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Freddy vs. </font><font style="vertical-align: inherit;">Jsonb</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, bidang dan tanggal Boolean telah mempercepat kueri kami, tetapi ada satu tipe data lagi. </font><font style="vertical-align: inherit;">Pertempuran dengan penyaringan di atasnya, terus terang, masih belum berakhir, meskipun ada keberhasilan. </font><font style="vertical-align: inherit;">Jadi, di sini adalah bagaimana kami berhasil melewati bidang filter dengan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke server jarak jauh.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alih-alih memfilter operator, Anda harus menggunakan operator yang memiliki satu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di yang lain. </font><font style="vertical-align: inherit;">7 detik alih-alih 29 awal. Sejauh ini, ini adalah satu-satunya opsi yang berhasil mentransfer filter melalui </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke server jarak jauh, tetapi penting untuk mempertimbangkan satu batasan: kami menggunakan versi database 9.6, namun kami berencana untuk menyelesaikan tes terbaru dan pindah ke versi 12 pada akhir April. </font><font style="vertical-align: inherit;">Saat kami memperbarui, kami akan menulis bagaimana pengaruhnya, karena ada banyak perubahan yang ada banyak harapan: json_path, perilaku CTE baru, tekan ke bawah (ada dari versi 10). </font><font style="vertical-align: inherit;">Saya ingin segera mencobanya.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habisi dia</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memeriksa bagaimana setiap perubahan memengaruhi kecepatan permintaan secara individual. </font><font style="vertical-align: inherit;">Sekarang mari kita lihat apa yang terjadi ketika ketiga filter ditulis dengan benar.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya, permintaan terlihat lebih rumit, ini adalah papan yang dipaksakan, tetapi kecepatan eksekusi adalah 2 detik, yang lebih dari 10 kali lebih cepat! </font><font style="vertical-align: inherit;">Dan kita berbicara tentang permintaan sederhana pada kumpulan data yang relatif kecil. </font><font style="vertical-align: inherit;">Atas permintaan nyata, kami menerima pertumbuhan hingga beberapa ratus kali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk meringkas: jika Anda menggunakan PostgreSQL dengan FDW, selalu periksa bahwa semua filter dikirim ke server jarak jauh, dan Anda akan senang ... Setidaknya sampai Anda masuk ke gabungan antara tabel dari server yang berbeda. </font><font style="vertical-align: inherit;">Tapi ini adalah cerita untuk artikel lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terimakasih atas perhatiannya! </font><font style="vertical-align: inherit;">Saya akan senang mendengar pertanyaan, komentar, serta cerita tentang pengalaman Anda dalam komentar.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498002/index.html">Panduan Saku ke Z3</a></li>
<li><a href="../id498004/index.html">Workstation dalam wadah buruh pelabuhan</a></li>
<li><a href="../id498006/index.html">Memilih Jaksa Paten</a></li>
<li><a href="../id498012/index.html">Mikrotik RouterOS di Docker dengan Qemu</a></li>
<li><a href="../id498014/index.html">PyDERASN: ketika saya menambahkan dukungan big-data</a></li>
<li><a href="../id498020/index.html">Tentang satu indikator yang berlaku untuk penilaian visual fungsi yang berkembang pesat</a></li>
<li><a href="../id498022/index.html">Intisari materi menarik untuk pengembang seluler # 341 (pada 13-19 April)</a></li>
<li><a href="../id498024/index.html">Membangun kota dengan mengklik mouse dengan Houdini dan Python</a></li>
<li><a href="../id498026/index.html">FOSS News No. 12 - ulasan berita gratis dan sumber terbuka untuk 13-19 April 2020</a></li>
<li><a href="../id498028/index.html">Simulasi pandemi Python COVID-19</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>