<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèª ‚ÑπÔ∏è üë®üèº‚Äçüî¨ Lokalisasi sementara pada Symfony 4 + Twig ‚úã üí± ü§õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kebutuhan untuk pelokalan sementara produk muncul ketika produk tumbuh ke skala yang membutuhkan pekerjaan di zona waktu yang berbeda (bukti). Saya in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lokalisasi sementara pada Symfony 4 + Twig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495604/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kebutuhan untuk pelokalan sementara produk muncul ketika produk tumbuh ke skala yang membutuhkan pekerjaan di zona waktu yang berbeda (bukti). </font><font style="vertical-align: inherit;">Saya ingin menjelaskan varian ide sederhana untuk menyelesaikan kasus ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Latar belakangnya adalah ini: kami mengembangkan sistem CRM / ERP ceruk, dan kemudian kami diberitahu bahwa besok mereka akan bekerja dengan sistem ini pada waralaba dari Vladivostok ke Kaliningrad. </font><font style="vertical-align: inherit;">Sayangnya, skenario seperti itu pada awalnya tidak dipikirkan, dan kami mulai belajar bagaimana melakukan ini dengan biaya minimal dan kenyamanan maksimal.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara total, tiga tugas ternyata diperbesar: bagaimana kami menampilkan data dan bagaimana kami masuk, dan di antara mereka tugas bagaimana kami menyimpan semuanya. Karena waktu, seperti yang Anda tahu, secara relatif harfiah dan kiasan, diputuskan untuk menyimpan waktu seperti sebelumnya di UTC + 3 Moskow, tetapi memprosesnya di input dan output (dan perlu diingat bahwa titik referensi adalah UTC + 3). Tentu saja, kami memahami bahwa ada solusi lain dalam hal ini dan arah lainnya. Anda dapat mengonversi semua entri yang ada ke UTC + -0, serta menggunakan tipe khusus dalam DBMS yang menyimpan zona waktu, Anda dapat menulis sendiri tipe kustom ini, jika tiba-tiba database tidak sepenuhnya mendukung fitur-fitur tersebut. Tetapi dibimbing oleh prinsip kesederhanaan, kami mengikuti jalan yang diusulkan, terlebih lagi, pada pandangan pertama, ia tidak kehilangan banyak hal bagi yang lain,dan logika untuk menentukan zona waktu yang diinginkan cukup sederhana.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah Moskow menjadi titik referensi, kami menambahkan parameter zona waktu khusus untuk setiap pengguna, serta sejumlah entitas terkait (organisasi, kota, aplikasi, transaksi, dll.). </font><font style="vertical-align: inherit;">Kemudian dimungkinkan untuk secara jelas menentukan di mana zona waktu pengguna atau entitas tempat ia bekerja. </font><font style="vertical-align: inherit;">Logikanya ada standar dan justru sering spesifik untuk proyek. </font><font style="vertical-align: inherit;">Kami membungkus logika ini dalam layanan dan mendapatkan zona waktu di mana Anda perlu</font></font><br>
<br>
<pre><code class="php hljs">$localizationService-&gt;getTimezone();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keputusan untuk melokalkan tanggal di templat adalah sebagai berikut: saat menginisialisasi ekstensi Twig, zona waktu diubah ke yang diinginkan:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Environment $twig, LocalizationService $localizationService</span>) </span>{<font></font>
    $twig-&gt;getExtension(<span class="hljs-string">'Twig_Extension_Core'</span>)-&gt;setTimezone($localizationService-&gt;getTimezone());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situasi kami semakin diperumit oleh fakta bahwa setelah tanggal-waktu ditampilkan, perlu membuat subskrip ‚Äú01.01.2020 12:30 (Moskow)‚Äù, sehingga, misalnya, dalam urutan bersyarat / tugas / transaksi yang terkait dengan zona waktu, informasi tentang waktu sabuk. </font><font style="vertical-align: inherit;">Untuk alasan praktis, ini diperlukan agar call center tunggal dapat bekerja dengan nyaman dengan zona waktu yang berbeda dalam kerangka tugas / aplikasi / transaksi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua logika untuk menentukan prioritas zona waktu disambungkan ke getTimezone yang disebutkan di atas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih lanjut, kami dihadapkan dengan fakta bahwa jika Anda membuat filter atau fungsi ranting Anda, Anda perlu mengubah banyak templat, tetapi Anda ingin menghindarinya. </font><font style="vertical-align: inherit;">Karena itu, setelah sedikit bertanya, kami memutuskan untuk mendefinisikan kembali tanggal standar ranting-filter</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'date'</span>], [<span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">date</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{<font></font>
    $appendix = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (format &amp;&amp; strpos($format, <span class="hljs-string">'H:i'</span>) !== <span class="hljs-literal">false</span>)<font></font>
        $appendix = <span class="hljs-string">' ('</span>.DateTimeFunctions::getRussianAbbrev(<span class="hljs-keyword">$this</span>-&gt;localizationService-&gt;getTimezone()).<span class="hljs-string">')'</span>;   <font></font>
...<font></font>
    <span class="hljs-comment">//    date   $result</span><font></font>
...<font></font>
   <span class="hljs-keyword">return</span> $result.$appendix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga, karena kami mengambil filter standar, versi yang lama telah didefinisikan ulang:</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'native_date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'nativeDate'</span>], [ <span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeDate</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{
    <span class="hljs-comment">//    date </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode filter tanggal standar dapat ditemukan di / ranting / ranting / lib / Ranting / Ekstensi / Inti :: twig_date_format_filter. </font><font style="vertical-align: inherit;">Meskipun pada kenyataannya dalam banyak kasus pilihan sederhana, tidak jauh berbeda akan dilakukan:</font></font><br>
<br>
<pre><code class="php hljs">$date-&gt;setTimeZone($timezone)<font></font>
$result = $date-&gt;format($format);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentu saja, Anda juga dapat memotong atau mendefinisikan kembali bagian Twig yang lebih substansial, tetapi jika fungsionalitas dari filter standar cocok untuk Anda, Anda dapat mengeluarkannya secara terpisah dan tidak kehilangan apa pun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetap untuk menyelesaikan masalah memasukkan tanggal-waktu. </font><font style="vertical-align: inherit;">Satu solusi:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOffsetHours</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $local = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>, <span class="hljs-keyword">new</span> \DateTimeZone(<span class="hljs-keyword">$this</span>-&gt;getTimezone()));<font></font>
    $user = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>);<font></font>
<font></font>
    $localOffset = $local-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
    $globalOffset = $user-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
<font></font>
    $diff = $globalOffset - $localOffset;<font></font>
    <span class="hljs-keyword">return</span> $diff;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toGlobalTime</span>(<span class="hljs-params">\DateTimeInterface $dateTime</span>): \<span class="hljs-title">DateTimeInterface</span> 
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $offsetHours = <span class="hljs-keyword">$this</span>-&gt;getOffsetHours();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ($offsetHours &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify(<span class="hljs-string">'+ '</span>.$offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    } <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>($offsetHours &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify($offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $dateTime;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian panggil sebelum menyimpan tanggal-waktu, misalnya, dalam pendengar. Opsi ini datang kepada kami, karena pada dasarnya waktu dan tanggal dalam proyek diperbaiki untuk acara tertentu, dan tidak dimasukkan secara manual. Untuk kasus ekstrim lain, di mana waktu secara konstan diperkenalkan melalui formulir, solusinya mungkin tidak optimal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai bonus. Proyek ini menggunakan bundel Omines datatables ke tabel output. Di sana solusinya bahkan lebih mudah. Alih-alih DateTimeColumn untuk pelokalan, yang berikut ini digunakan:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomDateTimeColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateTimeColumn</span>
</span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> $localizationService;
    <span class="hljs-keyword">private</span> $timeZone;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">LocalizationService $localizationService</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;localizationService = $localizationService;
        <span class="hljs-keyword">$this</span>-&gt;timeZone = $localizationService-&gt;getTimezoneObject();<font></font>
    }<font></font>
    <font></font>
   <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">$value</span>)
    </span>{<font></font>
        $value-&gt;setTimeZone(<span class="hljs-keyword">$this</span>-&gt;timeZone);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::normalize($value);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih atas waktu Anda. </font><font style="vertical-align: inherit;">Jika seseorang membantu meningkatkan hal-hal dasar dari solusi, saya akan sangat berterima kasih. </font><font style="vertical-align: inherit;">Kita berbicara tentang yang dasar, karena jelas bahwa kodenya vakum dan dalam kenyataannya memiliki DI yang jauh lebih besar dan segala macam barang untuk penggunaan internal dalam proyek. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Singkatnya. </font><font style="vertical-align: inherit;">Ide solusi sederhana untuk pelokalan sementara cepat proyek disajikan. </font><font style="vertical-align: inherit;">Itu tidak tergantung pada versi, atau jika itu, itu lemah. </font><font style="vertical-align: inherit;">Solusi ini berhasil dimigrasi dari Symfony 4.2 ke 5.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id495588/index.html">Membuat roguelike di Unity dari awal: generator penjara bawah tanah</a></li>
<li><a href="../id495592/index.html">Cara menggunakan kamus (dan tidak hanya)</a></li>
<li><a href="../id495594/index.html">Mulailah menghasilkan uang dari perangkat lunak: menciptakan bisnis mini-digital</a></li>
<li><a href="../id495596/index.html">Pekerjaan jauh di kantor. RDP, Port Knocking, Mikrotik: sederhana dan aman</a></li>
<li><a href="../id495602/index.html">Dimulai dengan Data Inti! Sulit dalam kata-kata sederhana [Bagian 2]</a></li>
<li><a href="../id495606/index.html">"Pemantauan sosial." Skor 1: 0 menguntungkan kita</a></li>
<li><a href="../id495608/index.html">[Infografis] Visualisasi pandemi dalam sejarah umat manusia</a></li>
<li><a href="../id495610/index.html">Mengapa masa depan bukan untuk Python</a></li>
<li><a href="../id495612/index.html">Akankah Airbnb selamat dari coronavirus? [spoiler: ya]</a></li>
<li><a href="../id495614/index.html">Manual libav FFmpeg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>