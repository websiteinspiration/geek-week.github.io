<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶ üçü üñáÔ∏è Implementando o algoritmo de consenso RAFT para armazenamento KV distribu√≠do em Java üîè üõèÔ∏è üë©üèæ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° de novo. H√° alguns dias, o treinamento come√ßou em um novo grupo no curso "Arquiteto de Software" e hoje gostar√≠amos de compartilhar um artigo escr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementando o algoritmo de consenso RAFT para armazenamento KV distribu√≠do em Java</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/495356/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° de novo. H√° alguns dias, o treinamento come√ßou em um novo grupo no curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Arquiteto de Software"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e hoje gostar√≠amos de compartilhar um artigo escrito por um dos alunos do curso, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Pleshakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (chefe de desenvolvimento da Program Logistics e cofundador da Clusterra).</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/pb/5h/qq/pb5hqqeunfv8gkvyvspmegwuj4w.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atualmente, os sistemas distribu√≠dos de microsservi√ßos tornaram-se praticamente o padr√£o do setor, e n√£o apenas no mundo corporativo. Os benef√≠cios do uso de sistemas distribu√≠dos foram descritos e discutidos mais de uma vez. As vantagens dos microsservi√ßos s√£o conhecidas por todos: tecnologias para a tarefa, composi√ß√£o, escalabilidade, escala de desenvolvimento, redu√ß√£o de TTM e assim por diante. √â √≥bvio que o desenvolvimento de aplicativos distribu√≠dos oferece mais op√ß√µes para resposta oportuna √†s crescentes demandas de neg√≥cios e digitaliza√ß√£o de tudo o que est√° ao redor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m √© importante observar que, no momento, um fator muito importante que afeta a escolha de uma estrat√©gia de desenvolvimento em favor dos microsservi√ßos √© a disponibilidade de todos os tipos de solu√ß√µes de infraestrutura prontas que resolvem os problemas associados aos custos adicionais da opera√ß√£o de um sistema distribu√≠do. Estamos falando de sistemas de orquestra√ß√£o de cont√™iner, mash de servi√ßo, meios de rastreamento distribu√≠do, monitoramento, registro e assim por diante. Pode-se afirmar com seguran√ßa que a maioria dos fatores mencionados anteriormente como desvantagens da abordagem de microsservi√ßo hoje n√£o tem tanta influ√™ncia quanto alguns anos atr√°s.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nas realidades modernas, a maioria dos desenvolvedores procura, na primeira oportunidade, mudar de uma estrutura monol√≠tica para uma de microsservi√ßo. Um dos primeiros passos que podem ser tomados sem recorrer √† refatora√ß√£o total e √† decomposi√ß√£o s√©ria √© conseguir um sistema de escalabilidade horizontal. Ou seja, para transformar seu aplicativo monol√≠tico em um cluster, possivelmente at√© constitu√≠do pelos mesmos mon√≥litos, mas permitindo variar dinamicamente o n√∫mero deles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao tentar alcan√ßar a escalabilidade horizontal, surge a quest√£o da sincroniza√ß√£o de dados dentro de um cluster, com muita rapidez e agilidade. Felizmente, todos os DBMSs modernos oferecem suporte √† replica√ß√£o de dados entre n√≥s de uma maneira ou de outra. O desenvolvedor s√≥ precisa selecionar o DBMS para a tarefa e decidir quais propriedades do sistema (de acordo com o teorema da CAP) ele precisa, CP ou AP, e o problema foi resolvido. No caso em que o CP √© necess√°rio e os requisitos de consist√™ncia s√£o altos, um dos m√©todos para resolver o problema de sincroniza√ß√£o de dados √© usar um cluster que suporte o algoritmo de consenso RAFT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse algoritmo bastante novo (desenvolvido em 2012) oferece uma alta garantia de consist√™ncia e √© muito popular. Decidi descobrir como ele funciona e escrevi minha implementa√ß√£o de um reposit√≥rio consistente de valores-chave em Java (Spring Boot).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faz sentido implementar algum algoritmo distribu√≠do voc√™ mesmo? √â claro que voc√™ pode ter uma implementa√ß√£o pronta de um algoritmo distribu√≠do e, com o maior grau de probabilidade, essa implementa√ß√£o ser√° melhor do que uma "bicicleta" caseira. Por exemplo, voc√™ pode usar um DBMS que mantenha o n√≠vel de consist√™ncia necess√°rio. Ou voc√™ pode implantar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou voc√™ pode encontrar uma estrutura adequada para o seu idioma. Para java, existe o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que resolve perfeitamente os problemas de sincroniza√ß√£o de dados distribu√≠dos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas do outro lado. Se voc√™ optar por uma solu√ß√£o pronta para usar, o uso de um aplicativo externo geralmente adiciona um ponto adicional de falha ao seu sistema. E as estruturas podem ser redundantes ou dif√≠ceis de operar e aprender, ou podem n√£o existir para a sua linguagem de programa√ß√£o. Al√©m disso, a implementa√ß√£o independente do algoritmo de consenso √© uma tarefa de engenharia extremamente interessante que amplia seus horizontes e fornece uma compreens√£o de como resolver os problemas que surgem quando os servi√ßos interagem em um cluster usando o m√©todo mais ideal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a especifica√ß√£o do algoritmo cont√©m um conjunto de medidas para manter a integridade dos dados, voc√™ pode usar o conhecimento adquirido e at√© usar o algoritmo na sua totalidade. Qualquer parte do algoritmo pode ser √∫til na vida real. Suponha que voc√™ tenha um conjunto de trabalhadores para analisar arquivos em paralelo. Os trabalhadores s√£o equivalentes, mas voc√™ deseja designar um dos trabalhadores como coordenador e, quando o trabalhador de coordena√ß√£o cair, atribua qualquer outro trabalhador livre como coordenador. A primeira metade do algoritmo RAFT, que descreve como escolher um l√≠der entre n√≥s equivalentes, o ajudar√° com isso. Ou, por exemplo, se voc√™ tiver apenas dois n√≥s em rela√ß√£o ao mestre-escravo, poder√° usar muito bem as regras de replica√ß√£o descritas na especifica√ß√£o RAFT para organizar a troca de dados no seu caso mais simples.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artigo √© essencialmente um guia pr√°tico sobre como implementar o RAFT. </font><font style="vertical-align: inherit;">O pr√≥prio algoritmo e os aspectos te√≥ricos de seu trabalho n√£o ser√£o compreendidos. </font><font style="vertical-align: inherit;">Voc√™ pode ler uma breve descri√ß√£o aqui neste </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excelente artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou estudar a especifica√ß√£o completa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L√° voc√™ pode encontrar uma visualiza√ß√£o muito clara do algoritmo.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o geral da solu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A parte do c√≥digo diretamente relacionada √† implementa√ß√£o do algoritmo √© analisada no artigo. </font><font style="vertical-align: inherit;">No final do artigo, h√° um link para o reposit√≥rio, onde voc√™ pode ver o c√≥digo inteiro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa foi a seguinte. </font><font style="vertical-align: inherit;">Desenvolva um sistema distribu√≠do que permita armazenar dados em um banco de dados de valores-chave. </font><font style="vertical-align: inherit;">Os dados de cada n√≥ devem ser consistentes, a saber, se os dados entraram no banco de dados de um n√≥ e a maioria dos n√≥s confirmou que eles tamb√©m receberam esses dados, mais cedo ou mais tarde esses dados estar√£o no banco de dados de cada n√≥. </font><font style="vertical-align: inherit;">Quando uma parte do cluster √© desconectada e quando √© conectada novamente, os n√≥s que estavam fora do cluster devem alcan√ßar o cluster principal e sincronizar. </font><font style="vertical-align: inherit;">Cada n√≥ fornece uma API REST para gravar e ler dados do banco de dados. </font><font style="vertical-align: inherit;">O sistema consiste em dois m√≥dulos para dois tipos de n√≥s: cliente e servidor. </font><font style="vertical-align: inherit;">Abaixo, consideramos os recursos da implementa√ß√£o do pr√≥prio servidor. </font><font style="vertical-align: inherit;">O c√≥digo do cliente est√° no reposit√≥rio. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um n√≥ do servidor pode operar em tr√™s estados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguidor (seguidor). </font><font style="vertical-align: inherit;">Aceita solicita√ß√µes de leitura do cliente. </font><font style="vertical-align: inherit;">Leva um batimento card√≠aco do l√≠der</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Candidato (candidato). </font><font style="vertical-align: inherit;">Aceita solicita√ß√µes de leitura do cliente. </font><font style="vertical-align: inherit;">Envia solicita√ß√µes de voto para outros n√≥s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≠der </font><font style="vertical-align: inherit;">Aceita pedidos de leitura e grava√ß√£o. </font><font style="vertical-align: inherit;">Envia solicita√ß√µes de pulsa√ß√£o para outros n√≥s. </font><font style="vertical-align: inherit;">Envia anexar dados de solicita√ß√µes para outros n√≥s.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O per√≠odo de "lideran√ßa" de um dos n√≥s √© chamado de rodada (termo). </font><font style="vertical-align: inherit;">Um novo candidato abre uma nova rodada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Armazenamento de dados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada n√≥ fornece acesso ao reposit√≥rio do log de opera√ß√µes, no qual as opera√ß√µes para alterar dados s√£o gravadas seq√ºencialmente.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/operations/OperationsLog.java<br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OperationsLog</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(Operation operation)</span></span>;
   <span class="hljs-function">Operation <span class="hljs-title">get</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">List&lt;Operation&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function">Long <span class="hljs-title">getTerm</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">Integer <span class="hljs-title">getLastIndex</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">Long <span class="hljs-title">getLastTerm</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">removeAllFromIndex</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newOperationIndex)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada opera√ß√£o, al√©m de dados e tipo (inserir, alterar, excluir), cont√©m o n√∫mero da rodada em que foi criada. Al√©m disso, cada opera√ß√£o possui um √≠ndice que aumenta sequencialmente. √â importante que todas as opera√ß√µes sejam inseridas nos logs de seguidores na mesma ordem em que s√£o inseridas no log do l√≠der. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada n√≥ tem acesso a um banco de dados no qual os dados s√£o armazenados diretamente.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/storage/Storage.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Storage</span> </span>{
   <span class="hljs-function">List&lt;Entry&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(Long key)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Long key)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na implementa√ß√£o atual, solu√ß√µes incorporadas na mem√≥ria s√£o usadas tanto para o log quanto para o banco de dados (Lista e Mapa competitivos comuns). Se necess√°rio, voc√™ pode simplesmente implementar a interface apropriada para suportar outros tipos de armazenamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A aplica√ß√£o das opera√ß√µes do log ao banco de dados √© realizada por uma m√°quina de estado distribu√≠da. Uma m√°quina de estado √© um mecanismo respons√°vel por alterar o estado de um cluster, restringindo o uso de altera√ß√µes incorretas (opera√ß√µes fora de ordem ou um n√≥ desconectado que se considera um l√≠der). Para que as altera√ß√µes sejam consideradas v√°lidas e para serem aplicadas ao banco de dados, elas devem passar por uma s√©rie de verifica√ß√µes e atender a certos crit√©rios, que √© precisamente o que a m√°quina de estado fornece.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para um l√≠der, uma opera√ß√£o √© aplicada ao banco de dados se a maioria dos n√≥s confirmou o fato de que a opera√ß√£o tamb√©m √© replicada em seu log. </font><font style="vertical-align: inherit;">Para um seguidor, a opera√ß√£o √© aplicada ao banco de dados se um sinal for recebido do l√≠der que ela entrou no banco de dados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temporizadores </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada n√≥ fornece troca de dados com outros n√≥s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dois tipos de consultas s√£o suportados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">votar ao conduzir uma rodada de vota√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anexar, tamb√©m conhecido como pulsa√ß√£o (se n√£o houver dados), para replicar dados de log para seguidores e impedir o in√≠cio de uma nova rodada de vota√ß√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato do in√≠cio de um evento √© determinado pelo cron√¥metro. </font><font style="vertical-align: inherit;">Dois tipos de cron√¥metros s√£o ativados no n√≥:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voto. </font><font style="vertical-align: inherit;">Para iniciar uma rodada de vota√ß√£o. </font><font style="vertical-align: inherit;">Cada n√≥ tem seu pr√≥prio intervalo, ap√≥s o qual tentar√° iniciar uma nova vota√ß√£o. </font><font style="vertical-align: inherit;">A contagem regressiva come√ßa novamente ao receber um batimento card√≠aco do l√≠der.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batimento cardiaco. </font><font style="vertical-align: inherit;">Para enviar uma solicita√ß√£o aos seguidores pelo l√≠der do anexo. </font><font style="vertical-align: inherit;">Se o n√≥ n√£o recebe uma pulsa√ß√£o e o cron√¥metro de vota√ß√£o expirou, ele se torna um candidato e inicia as elei√ß√µes, aumenta o n√∫mero da rodada de vota√ß√£o e envia solicita√ß√µes de vota√ß√£o para outros n√≥s. </font><font style="vertical-align: inherit;">Se o n√≥ coletar a maioria dos votos, ele se tornar√° o l√≠der e come√ßar√° a enviar batimentos card√≠acos.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O estado atual do n√≥</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada n√≥ armazena dados sobre o estado atual.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/context/Context.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Context</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">State <span class="hljs-title">getState</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//: , ,  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getVotedFor</span><span class="hljs-params">()</span></span>; 
               <span class="hljs-comment">//          </span>
   <span class="hljs-function">Long <span class="hljs-title">getCurrentTerm</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getCommitIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">List&lt;Peer&gt; <span class="hljs-title">getPeers</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//      </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um n√≥ l√≠der tamb√©m armazena metadados para os n√≥s nos quais ele replica dados.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/node/peers/Peer.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Peer</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getNextIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  ,    </span>
   <span class="hljs-function">Integer <span class="hljs-title">getMatchIndex</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//   </span>
   <span class="hljs-function">Boolean <span class="hljs-title">getVoteGranted</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//     </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os metadados do n√≥ s√£o atualizados pelo l√≠der ao receber respostas de seguidores. </font><font style="vertical-align: inherit;">Eles s√£o usados ‚Äã‚Äãpara determinar pelo l√≠der qual opera√ß√£o do √≠ndice seguinte o seguidor est√° pronto para aceitar e quais opera√ß√µes j√° foram adicionadas ao log do seguidor.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vota√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classe </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">ElectionService</font></a><font style="vertical-align: inherit;"> √© respons√°vel pela vota√ß√£o</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ElectionService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processElection</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO requestVoteDTO)</span></span>;<font></font>
} </code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviando um pedido de vota√ß√£o </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o n√≥ for um seguidor e n√£o receber uma pulsa√ß√£o durante o per√≠odo definido para a espera, ele aumentar√° sua rodada atual, se declarar√° candidato e come√ßar√° a enviar solicita√ß√µes de voto para outros n√≥s. </font><font style="vertical-align: inherit;">Se ele conseguir reunir um quorum e a maioria dos n√≥s votar, ele se tornar√° o novo l√≠der. </font><font style="vertical-align: inherit;">Em termos de RAFT, o quorum √© mais da metade de todos os n√≥s (51%). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos analisar o m√©todo de </font></font><code>processElection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que √© chamado pelo cron√¥metro de vota√ß√£o quando a vota√ß√£o expira e envia aos n√≥s uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicita√ß√£o de vota√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-comment">//1</span><font></font>
context.setState(CANDIDATE); <font></font>
Long term = context.incCurrentTerm(); <font></font>
context.setVotedFor(context.getId()); <font></font>
<font></font>
List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<span class="hljs-keyword">long</span> voteGrantedCount = <span class="hljs-number">1L</span>;
<span class="hljs-keyword">long</span> voteRevokedCount = <span class="hljs-number">0L</span>;<font></font>
<font></font>
<span class="hljs-comment">//2</span>
<span class="hljs-keyword">while</span> (checkCurrentElectionStatus(term)) {<font></font>
   List&lt;AnswerVoteDTO&gt; answers = getVoteFromAllPeers(term, peersIds);<font></font>
   peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   <span class="hljs-keyword">for</span> (AnswerVoteDTO answer : answers) {
       <span class="hljs-comment">//3</span>
       <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
           <span class="hljs-comment">//4</span>
           <span class="hljs-keyword">if</span> (answer.getTerm()&gt;context.getCurrentTerm()) {<font></font>
               context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
               <span class="hljs-keyword">return</span>;<font></font>
           }<font></font>
           <span class="hljs-keyword">if</span> (answer.isVoteGranted()) {
               <span class="hljs-comment">//5 </span>
               context.getPeer(answer.getId()).setVoteGranted(<span class="hljs-keyword">true</span>);<font></font>
               voteGrantedCount++;<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-comment">//6 </span><font></font>
               voteRevokedCount++;<font></font>
       } <span class="hljs-keyword">else</span> {<font></font>
          peersIds.add(answer.getId());<font></font>
       }<font></font>
   }<font></font>
  <span class="hljs-comment">//7</span>
  <span class="hljs-keyword">if</span> (voteGrantedCount &gt;= context.getQuorum()) {<font></font>
       winElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (voteRevokedCount &gt;= context.getQuorum()) {<font></font>
       loseElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } </code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina o status de "Candidato". </font><font style="vertical-align: inherit;">Aumente o n√∫mero da rodada e vote em n√≥s mesmos.</font></font></li>
<li>  ,       (    ).  -  ,        ,           heartbeat                 .</li>
<li> -  ,    .    ,      ,     -. </li>
<li>       ,                            .     ,      heartbeat     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√≥ votou em n√≥s! </font><font style="vertical-align: inherit;">Aumentamos o n√∫mero de n√≥s que votam em n√≥s e corrigimos que esse n√≥ votou em n√≥s.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votou n√£o para n√≥s, tamb√©m acreditamos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o quorum for coletado e o n√≥ vencer a elei√ß√£o, estabelecemos o status de "L√≠der". </font><font style="vertical-align: inherit;">Caso contr√°rio, nos tornamos seguidores e esperamos.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m deve ser observado que, quando um n√≥ se torna um l√≠der, o Pr√≥ximo √çndice √© definido para cada n√≥ na lista de n√≥s armazenados pelo l√≠der, que √© igual ao √∫ltimo √≠ndice no log do l√≠der mais 1. A partir desse √≠ndice, o l√≠der tentar√° atualizar os logs do seguidor. </font><font style="vertical-align: inherit;">De fato, esse √≠ndice armazenado pelo l√≠der pode n√£o corresponder ao √≠ndice real do registro do seguidor e o valor real ser√° obtido apenas ao trocar dados com o seguidor e ser√° ajustado. </font><font style="vertical-align: inherit;">Mas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necess√°rio algum </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">ponto de partida</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">winElection</span><span class="hljs-params">(Long term)</span> </span>{<font></font>
       context.setState(LEADER);<font></font>
       context.getPeers().forEach(peer -&gt;<font></font>
               peer.setNextIndex(operationsLog.getLastIndex()+<span class="hljs-number">1</span>)<font></font>
<font></font>
       );<font></font>
   }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processamento de solicita√ß√£o de vota√ß√£o </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao votar, cada n√≥ recebe uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicita√ß√£o do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seguinte </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">formul√°rio</font></a><font style="vertical-align: inherit;"> do candidato </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestVoteDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer candidateId; <span class="hljs-comment">//  </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer lastLogIndex; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long lastLogTerm; <span class="hljs-comment">//       </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, vejamos o procedimento de </font></font><code>vote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ele processa a solicita√ß√£o de voto do candidato e retorna uma decis√£o sobre sua candidatura ao papel de l√≠der.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/election/ElectionServiceImpl.java#L178 <br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO dto)</span> </span>{<font></font>
   <font></font>
       <span class="hljs-keyword">boolean</span> termCheck;
       <span class="hljs-comment">//1</span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm())
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>);
       <span class="hljs-keyword">else</span> <span class="hljs-comment">//2</span>
       <span class="hljs-keyword">if</span> (dto.getTerm().equals(context.getCurrentTerm())) {<font></font>
           termCheck = (context.getVotedFor() == <span class="hljs-keyword">null</span>||<font></font>
                          context.getVotedFor().equals(dto.getCandidateId()));<font></font>
       }<font></font>
       <span class="hljs-keyword">else</span>
       {   <span class="hljs-comment">//3</span>
           termCheck = <span class="hljs-keyword">true</span>;<font></font>
             context.setTermGreaterThenCurrent(dto.getTerm());<font></font>
       }<font></font>
<font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">boolean</span> logCheck = !((operationsLog.getLastTerm() &gt; dto.getLastLogTerm()) ||<font></font>
               ((operationsLog.getLastTerm().equals(dto.getLastLogTerm())) &amp;&amp;<font></font>
                       (operationsLog.getLastIndex() &gt; dto.getLastLogIndex())));<font></font>
<font></font>
<font></font>
       <span class="hljs-keyword">boolean</span> voteGranted = termCheck&amp;&amp;logCheck;<font></font>
<font></font>
       <span class="hljs-comment">//5</span>
       <span class="hljs-keyword">if</span> (voteGranted) {<font></font>
           context.setVotedFor(dto.getCandidateId());<font></font>
       }<font></font>
       <span class="hljs-comment">//6   </span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),voteGranted);<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao receber uma solicita√ß√£o de um candidato, o n√≥ faz duas verifica√ß√µes: verifica a ronda do candidato e o comprimento do seu log. </font><font style="vertical-align: inherit;">Se a rodada do candidato for maior e seu log for maior ou igual, ent√£o o n√≥ votar√° no candidato.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a atual rodada do n√≥ for maior que a do candidato, recusamos, porque este √© um pedido de um n√≥ atrasado, que, aparentemente, ficou fora do cluster por algum tempo e iniciou o processo de elei√ß√£o porque n√£o viu o l√≠der atual. </font></font></li>
<li>   ,   , ,           ,        ,     ,       ;       .              ‚Äî    .</li>
<li>     ,     </li>
<li> .                   ,            ,  ,        ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com um resultado positivo, corrigimos o fato de que o n√≥ participou das elei√ß√µes e votamos no candidato.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envie o resultado de volta ao candidato</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certamente, as condi√ß√µes poderiam ter sido escritas um pouco mais curtas e mais elegantes, mas deixei uma op√ß√£o t√£o "ing√™nua" para n√£o me confundir e n√£o confundir ningu√©m. </font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replica√ß√£o </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O l√≠der do cron√¥metro envia seguidores de pulsa√ß√£o para todos os n√≥s para redefinir seus cron√¥metros de vota√ß√£o. Como o l√≠der armazena em seus √≠ndices de metadados as √∫ltimas opera√ß√µes de todos os seguidores, ele pode avaliar se √© necess√°rio enviar a opera√ß√£o para os n√≥s. Se o registro de opera√ß√µes do l√≠der se tornar maior que o registro de qualquer seguidor, ele, juntamente com os batimentos card√≠acos, enviar√° sequencialmente as opera√ß√µes ausentes. Chame-o de anexar solicita√ß√£o. Se a maioria dos n√≥s confirmar o recebimento de novas opera√ß√µes, o l√≠der aplicar√° essas opera√ß√µes ao banco de dados e aumentar√° o √≠ndice da √∫ltima opera√ß√£o aplicada. Esse √≠ndice tamb√©m √© enviado aos seguidores junto com uma solicita√ß√£o de pulsa√ß√£o. E se o √≠ndice l√≠der for maior que o √≠ndice seguidor, o seguidor tamb√©m aplicar√° opera√ß√µes ao seu banco de dados para equalizar os √≠ndices. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse tipo de solicita√ß√£o anexa que o l√≠der envia ao seguidor</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestAppendDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderId; <span class="hljs-comment">//   </span><font></font>
<font></font>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer prevLogIndex;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long prevLogTerm;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderCommit;<span class="hljs-comment">//      </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Operation operation; <span class="hljs-comment">//</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem implementa√ß√µes nas quais as opera√ß√µes s√£o transferidas em lotes de v√°rias por solicita√ß√£o. </font><font style="vertical-align: inherit;">Na implementa√ß√£o atual, apenas uma opera√ß√£o pode ser transmitida por </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
solicita√ß√£o.A classe responde ao envio e processamento da solicita√ß√£o de anexa√ß√£o de pulsa√ß√£o:</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationService.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReplicationService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO requestAppendDTO)</span></span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar uma solicita√ß√£o de altera√ß√£o de dados </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere um fragmento de um </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">m√©todo de</font></a></font><code>sendAppendForOnePeer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classe </font></font><code>ReplicationServiceImpl</code><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o qual √© respons√°vel por gerar uma solicita√ß√£o ao seguidor e envi√°-la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> CompletableFuture&lt;AnswerAppendDTO&gt; <span class="hljs-title">sendAppendForOnePeer</span><span class="hljs-params">(Integer id)</span> </span>{
   <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
       <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">//1</span><font></font>
           Peer peer = context.getPeer(id);<font></font>
<font></font>
           Operation operation;<font></font>
           Integer prevIndex;<font></font>
           <span class="hljs-comment">//2    </span>
           <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex()) {<font></font>
               operation = operationsLog.get(peer.getNextIndex());<font></font>
               prevIndex = peer.getNextIndex() - <span class="hljs-number">1</span>;<font></font>
           } <span class="hljs-keyword">else</span> 
           <span class="hljs-comment">//3  </span><font></font>
           {<font></font>
               operation = <span class="hljs-keyword">null</span>;<font></font>
               prevIndex = operationsLog.getLastIndex();<font></font>
           }<font></font>
<font></font>
<font></font>
           RequestAppendDTO requestAppendDTO = <span class="hljs-keyword">new</span> RequestAppendDTO(<font></font>
                   context.getCurrentTerm(), <span class="hljs-comment">//   </span>
                   context.getId(), <span class="hljs-comment">//  </span>
                   prevIndex,<span class="hljs-comment">//      </span>
                   operationsLog.getTerm(prevIndex),<span class="hljs-comment">//  </span><font></font>
                   context.getCommitIndex(),<font></font>
                               <span class="hljs-comment">//      </span>
                   Operation <span class="hljs-comment">//</span><font></font>
           );<font></font>
<font></font>
...<font></font>
<span class="hljs-comment">/*   http     */</span>
}</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metadados do seguidor</font></font></li>
<li>   ,   .             (      ),          ,      ,  ,   .    ,       ,    ,   ,     </li>
<li>   ,    ,       ;        ,     ,       ,  </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, considere o m√©todo de </font></font><code>appendRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe </font></font><code>ReplicationServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, respons√°vel por enviar a solicita√ß√£o de acr√©scimo e processar o resultado para todos os seguidores.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationServiceImpl.java#L109</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span> </span>{<font></font>
       List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<font></font>
       <span class="hljs-comment">//1 </span>
       <span class="hljs-keyword">while</span> (peersIds.size() &gt; <span class="hljs-number">0</span>) {
           <span class="hljs-comment">//2 </span><font></font>
           List&lt;AnswerAppendDTO&gt; answers = sendAppendToAllPeers(peersIds);<font></font>
           peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
           <span class="hljs-keyword">for</span> (AnswerAppendDTO answer : answers) {
               <span class="hljs-comment">//3</span>
               <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
                   <span class="hljs-comment">//4</span>
                   <span class="hljs-keyword">if</span> (answer.getTerm() &gt; context.getCurrentTerm()) {<font></font>
                        context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
                       <span class="hljs-keyword">return</span>;<font></font>
                   }<font></font>
                   Peer peer = context.getPeer(answer.getId());<font></font>
                   <span class="hljs-comment">//5     </span>
                   <span class="hljs-keyword">if</span> (answer.getSuccess()) {                      <font></font>
                       peer.setNextIndex(answer.getMatchIndex() + <span class="hljs-number">1</span>);<font></font>
                       peer.setMatchIndex(answer.getMatchIndex());<font></font>
                       <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex())<font></font>
                           peersIds.add(answer.getId());<font></font>
                   <span class="hljs-comment">//6      </span>
                   } <span class="hljs-keyword">else</span> {<font></font>
                       peer.decNextIndex();<font></font>
                       peersIds.add(answer.getId());<font></font>
                   }<font></font>
               }<font></font>
           }<font></font>
           <span class="hljs-comment">//7</span><font></font>
           tryToCommit();<font></font>
       }<font></font>
}<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repetimos a solicita√ß√£o at√© recebermos uma resposta de todos os seguidores de que a replica√ß√£o foi bem-sucedida. </font><font style="vertical-align: inherit;">Como uma opera√ß√£o √© enviada por solicita√ß√£o, pode levar v√°rias itera√ß√µes para sincronizar os logs dos seguidores</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envie solicita√ß√µes para todos os seguidores e obtenha uma lista com respostas </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consideramos respostas apenas de seguidores dispon√≠veis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a rodada de um dos seguidores for maior que a do l√≠der, paramos tudo e nos tornamos seguidores </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o seguidor responder que tudo foi bem-sucedido, atualizamos os metadados do seguidor: salvamos o √∫ltimo √≠ndice do log do seguidor e o √≠ndice da pr√≥xima opera√ß√£o esperada pelo seguidor. </font></font></li>
<li>  ,    ,  ,           ,           .  ,                  ,      .     ,         .    ,          .</li>
<li>        ,      .     . </li>
</ol><br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos ver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como exatamente o seguidor processa a solicita√ß√£o de acr√©scimo do l√≠der. </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√©todo de </font></font><code>append</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO dto)</span> </span>{<font></font>
     <font></font>
       <span class="hljs-comment">//1     </span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm()) {
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dto.getTerm() &gt; context.getCurrentTerm()) {
           <span class="hljs-comment">//2 </span><font></font>
           context.setCurrentTerm(dto.getTerm());<font></font>
           context.setVotedFor(<span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
       <span class="hljs-comment">//3  </span>
       applicationEventPublisher.publishEvent(<span class="hljs-keyword">new</span> ResetElectionTimerEvent(<span class="hljs-keyword">this</span>));<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (!context.getState().equals(FOLLOWER)) {<font></font>
           context.setState(FOLLOWER);<font></font>
       }<font></font>
        <font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">if</span> ((dto.getPrevLogIndex() &gt; operationsLog.getLastIndex()) ||                                                                                        !dto.getPrevLogTerm().equals(operationsLog.getTerm(dto.getPrevLogIndex()))) {
                      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
<font></font>
<font></font>
       Operation newOperation = dto.getOperation();<font></font>
       <span class="hljs-keyword">if</span> (newOperation != <span class="hljs-keyword">null</span>) {
           <span class="hljs-keyword">int</span> newOperationIndex = dto.getPrevLogIndex() + <span class="hljs-number">1</span>;<font></font>
           <font></font>
         <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {
               <span class="hljs-comment">//5</span>
               <span class="hljs-keyword">if</span> ((newOperationIndex &lt;= operationsLog.getLastIndex()) &amp;&amp;<font></font>
                      (!newOperation.getTerm().equals(operationsLog.getTerm(newOperationIndex)))){<font></font>
                   operationsLog.removeAllFromIndex(newOperationIndex);<font></font>
               }<font></font>
               <span class="hljs-comment">//6</span>
               <span class="hljs-keyword">if</span> (newOperationIndex &lt;= operationsLog.getLastIndex())<font></font>
               {<font></font>
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>,      operationsLog.getLastIndex());<font></font>
               }<font></font>
               <span class="hljs-comment">//7</span><font></font>
               operationsLog.append(newOperation);<font></font>
           }<font></font>
        }<font></font>
        <span class="hljs-comment">//8 </span>
        <span class="hljs-keyword">if</span> (dto.getLeaderCommit() &gt; context.getCommitIndex()) {<font></font>
           context.setCommitIndex(Math.min(dto.getLeaderCommit(), operationsLog.getLastIndex()));<font></font>
       }<font></font>
<font></font>
                 <font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>, operationsLog.getLastIndex());<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a rodada do l√≠der for menor que a do seguidor, enviaremos uma rodada ao l√≠der e um sinal de que sua solicita√ß√£o foi rejeitada. </font><font style="vertical-align: inherit;">Assim que o l√≠der receber uma rodada maior que a dele em resposta, ele se tornar√° um seguidor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a rodada do l√≠der for maior que a do seguidor, defina-a para o seguidor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a solicita√ß√£o foi recebida do l√≠der, independentemente de haver ou n√£o dados, redefinimos o cron√¥metro de vota√ß√£o e, se n√£o fossemos um seguidor, o tornamos </font></font></li>
<li>   ,   ,            ,  ,   ,    ,   .        ,    ,      </li>
<li>              ,   .            .   ,     , - ,   ,      ,      ,      .             ,    .</li>
<li>  ,   .  ,    </li>
<li>  ,     </li>
<li>        ,   ,       ,    . </li>
</ol><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta apenas descobrir como o l√≠der aplica opera√ß√µes do log ao banco de dados. No processo de enviar opera√ß√µes aos seguidores e processar respostas deles, o l√≠der atualiza os metadados dos n√≥s. Assim que o n√∫mero de n√≥s cujo √≠ndice da √∫ltima opera√ß√£o no log for maior que o √≠ndice da √∫ltima opera√ß√£o aplicada ao banco de dados pelo l√≠der se tornar igual ao quorum, podemos afirmar que a maioria dos n√≥s recebeu a opera√ß√£o e podemos aplic√°-lo ao banco de dados do l√≠der. Em outras palavras, se um l√≠der enviou uma opera√ß√£o aos seguidores e a maioria a inseriu em seu log e respondeu ao l√≠der, podemos aplicar essa opera√ß√£o ao banco de dados do l√≠der e aumentar o √≠ndice da √∫ltima opera√ß√£o aplicada. Esse √≠ndice com a pr√≥xima solicita√ß√£o de acr√©scimo de pulsa√ß√£o voar√° para o seguidor e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplicar√° a opera√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o mesmo √≠ndice do log para o banco de dados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos analisar o m√©todo de </font></font><code>tryToCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classe</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryToCommit</span><span class="hljs-params">()</span> </span>{
       <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
           <span class="hljs-comment">//1</span>
           <span class="hljs-keyword">int</span> N = context.getCommitIndex() + <span class="hljs-number">1</span>;
           <span class="hljs-comment">//2</span><font></font>
           Supplier&lt;Long&gt; count = () -&gt;<font></font>
               context.getPeers().stream().map(Peer::getMatchIndex).<font></font>
                       filter(matchIndex -&gt; matchIndex &gt;= N).count() + <span class="hljs-number">1</span>;<font></font>
<font></font>
           <span class="hljs-comment">//3 </span>
           <span class="hljs-keyword">if</span> (operationsLog.getLastIndex() &gt;= N &amp;&amp;<font></font>
                   operationsLog.getTerm(N).equals(context.getCurrentTerm())&amp;&amp;<font></font>
                      count.get()&gt;=context.getQuorum()<font></font>
           )<font></font>
           {<font></font>
               context.setCommitIndex(N);<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-keyword">return</span>;<font></font>
       }<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtemos o seguinte √≠ndice da opera√ß√£o aplicada ao banco de dados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contamos quantos seguidores t√™m uma opera√ß√£o com esse √≠ndice em seus logs e n√£o esquecemos de adicionar um l√≠der </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o n√∫mero de seguidores √© quorum e a opera√ß√£o com esse √≠ndice est√° no log do l√≠der, e a rodada dessa opera√ß√£o √© equivalente √† atual, o l√≠der aplica a opera√ß√£o ao banco de dados e aumenta o √≠ndice da √∫ltima opera√ß√£o aplicada. </font><font style="vertical-align: inherit;">As opera√ß√µes da rodada anterior n√£o podem ser aplicadas, porque outro l√≠der foi respons√°vel por elas e um conflito pode surgir. </font><font style="vertical-align: inherit;">Cada l√≠der aplica opera√ß√µes apenas de sua rodada atual.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qualquer algoritmo distribu√≠do, cujo representante da fam√≠lia √© RAFT, √© uma poderosa solu√ß√£o integrada que garante a obten√ß√£o do resultado, sujeita a todas as regras descritas na especifica√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos algoritmos distribu√≠dos e eles s√£o diferentes. H√° o ZAB, que √© implementado no Zookeeper e √© usado, por exemplo, para sincronizar dados no Kafka. Existem algoritmos com requisitos menos rigorosos de consist√™ncia, por exemplo, a massa de implementa√ß√µes do protocolo Gossip que s√£o usadas em sistemas AP. Existem algoritmos que seguem os princ√≠pios do RAFT e, ao mesmo tempo, usam o protocolo de fofocas para trocar logs como o MOKKA, que tamb√©m usa criptografia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acredito que tentar descobrir qualquer um desses algoritmos √© extremamente √∫til para qualquer desenvolvedor e, como mencionei acima, as solu√ß√µes podem ser interessantes de maneira abrangente e em partes separadas. </font><font style="vertical-align: inherit;">E, obviamente, voc√™ definitivamente precisa olhar nessa dire√ß√£o para aquelas cujas atividades est√£o relacionadas ao desenvolvimento de sistemas distribu√≠dos e a problemas de sincroniza√ß√£o de dados, mesmo que eles usem solu√ß√µes industriais padr√£o.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reposit√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especifica√ß√£o</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pequena descri√ß√£o</font></font></a></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperamos que o material tenha sido √∫til para voc√™. </font><font style="vertical-align: inherit;">E se voc√™ quiser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fazer um curso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pode faz√™-lo agora.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495342/index.html">Liquida√ß√£o de cart√µes banc√°rios no com√©rcio - criando um conjunto de dados e um infogr√°fico abertos no Google Data Studio</a></li>
<li><a href="../pt495344/index.html">Unifique-o: como a Lamoda torna seus servi√ßos Go consistentes</a></li>
<li><a href="../pt495346/index.html">Do erro ao alerta com a√ß√µes</a></li>
<li><a href="../pt495350/index.html">Servidor Web dom√©stico ou seu pr√≥prio provedor de hospedagem</a></li>
<li><a href="../pt495354/index.html">Como liberar produtos continuamente em 20 idiomas e n√£o morrer?</a></li>
<li><a href="../pt495360/index.html">Como automatizamos a migra√ß√£o de produtos de C # para C ++</a></li>
<li><a href="../pt495362/index.html">Auto-isolamento e programa: como n√£o enlouquecer em casa e passar um tempo √∫til</a></li>
<li><a href="../pt495364/index.html">Guia de Estilo da API ou n√£o fa√ßa os usu√°rios pensarem</a></li>
<li><a href="../pt495366/index.html">16 tipos de programadores ou desenvolvedores n√£o s√£o os mesmos rob√¥s</a></li>
<li><a href="../pt495368/index.html">N√≥s nos auto-registramos em auto-c√£es que andam em condi√ß√µes de auto-isolamento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>