<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüîß üëêüèª ü•Ñ Improving Google Duo Audio Quality with WaveNetEQ üë©üèº‚Äçüöí üò∑ üíáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Internet calls have become an integral part of the lives of millions of people - so they simplify their workflow and connect with their loved ones. To...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Improving Google Duo Audio Quality with WaveNetEQ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499632/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet calls have become an integral part of the lives of millions of people - so they simplify their workflow and connect with their loved ones. To transfer a call over the Internet, call data is broken up into small pieces called ‚Äúpackages‚Äù. Packets go through the network from the sender to the recipient, where they are collected back to receive continuous video and audio stream. However, often packets arrive at the recipient in the wrong order and at the wrong time - this is usually called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jitter.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(trembling) - or completely lost. Such problems reduce the quality of calls, because the recipient has to try to fill in the gaps, and this seriously affects both audio and video. For example, 99% of calls through Google Duo experience packet loss, excessive jitter, or network latency. Of these, 20% of calls lose more than 3% of audio data due to network problems, and 10% of calls lose more than 8% of data. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0d0/621/948/0d0621948e21c2ccc9c5dfd530cbeb53.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplified network problem diagram</font></font></i><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to make communication in real time more reliable, you have to somehow deal with the necessary packages that have not reached the addressee. For example, if you do not give a continuous audio signal, you will hear interruptions and stuttering, but you can‚Äôt call it an ideal solution to try to repeat the same signal again and again - this will lead to artifacts and reduce the overall call quality. The technology for handling the situation with the absence of packets is called ‚Äúpacket loss concealment‚Äù (PLC). The receiver's PLC module is responsible for creating audio (or video) that fills the interruptions caused by packet loss, strong jitter, or network problems - problems that in any case lead to a lack of necessary data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To deal with these audio issues, we introduced a new PLC system called WaveNetEQ in Duo. </font><font style="vertical-align: inherit;">This is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generative model</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> based on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WaveRNN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> technology </font><font style="vertical-align: inherit;">from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeepMind</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , trained on a large body of speech data to realistically complement speech segments. </font><font style="vertical-align: inherit;">She is able to fully synthesize the sound signal of the missing fragments of speech. </font><font style="vertical-align: inherit;">Since calls to Duo undergo end-to-end encryption, all processing has to be done on the device itself. </font><font style="vertical-align: inherit;">The WaveNetEQ model is fast enough for a telephone, while still providing excellent audio quality and a more natural-sounding PLC compared to other existing systems.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New PLC system for Duo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like many other web-based communications programs, Duo is based on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the open source WebRTC project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . To conceal the consequences of packet loss, the NetEQ system component uses signal processing methods that analyze speech and produce continuous continuity - this works well for small losses (up to 20 ms), but it starts to sound bad when packet loss leads to communication breaks of 60 ms or longer. In such cases, speech becomes similar to the repetitive speech of a robot - this characteristic sound, unfortunately, is well known to many fans of making calls over the Internet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To improve the quality of packet loss processing, we replaced NetEQ PLC with a modified version of WaveRNN. This is a recurrent neural network designed for speech synthesis, consisting of two parts - autoregressive and conditioned neural networks. The autoregressive neural network is responsible for the continuity of the signal and produces a short-term and medium-term speech structure. In the process of its operation, each generated fragment depends on the previous results of the network. A conditioned neural network affects autoregressive so that it produces an audio signal corresponding to a slower incoming data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, WaveRNN, like its predecessor, WaveNet, was created with the goal of converting text to speech (text-to-speech, TTS). Since WaveRNN is a TTS model, it is given information about what needs to be said and how. An air-conditioning network directly receives this information at the input in the form of phonemes making up the word and features of prosody (such non-textual information as pitch or intonation). In a sense, an air-conditioned network is capable of "looking into the future", and then redirecting the autoregressive network towards its corresponding sounds. In the case of the PLC system and real-time communication, we will not have such a context.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create a functional PLC-system, you need to both extract the context from the current speech (i.e., from the past), and generate an acceptable sound for its continuation. Our solution, WaveNetEQ, does both. It uses an autoregressive network, which continues to sound in the event of packet loss, and a conditioned neural network that simulates long-term symptoms, such as voice characteristics. The spectrogram of the previous audio signal is fed to the input of the conditioned neural network, from which a limited amount of information is extracted that describes prosody and text content. This concentrated information is fed into an autoregressive neural network, combining it with recent audio to predict the next sound fragment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is slightly different from the procedure we followed during WaveNetEQ training. Then the autoregressive neural network received a real sound sample as input for the next step, instead of using the previous sample. In such a process, known as teacher forcing, it is guaranteed that the model learns valuable information even in the early stages of training, when its predictions are of poor quality. When the model is fully trained and used in audio or video calls, imposed training is used only to ‚Äúwarm up‚Äù the model on the first sample, and after that it already receives its own output.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2bd/3c5/03c/2bd3c503c986c9486a7a0053827ee7d9.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WaveNetEQ architecture. During the operation of an autoregressive neural network, we ‚Äúwarm up‚Äù it through training with imposition. After that, she already gets her own exit to the entrance. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A small-frequency spectrogram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from long sections of audio is used as input for an air-conditioned neural network.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This model is applied to audio data in a Duo jitter buffer. When, after packet loss, communication resumes and the real audio signal continues to arrive, we carefully combine the synthetic and real audio streams. To best compose these two signals, the model generates a little more output than necessary, and then makes a smooth transition from one to the other. This makes the transition smooth and virtually silent.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/140/fab/1bf/140fab1bfef6197a27fea65400627c07.gif"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation of PLC events in an audio stream on a 60 ms sliding window. </font><font style="vertical-align: inherit;">The blue line is real audio, including past and future parts of the PLC. </font><font style="vertical-align: inherit;">At each measure, the orange line represents the synthetic audio that the WaveNetEQ system would predict if the sound were cut along the vertical gray line. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">60 ms packet loss</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note </font><font style="vertical-align: inherit;">perev .: examples of audio are so clumsy in appearance, since the Habr editor does not provide the ability to embed audio files. </font><font style="vertical-align: inherit;">This is how mp4 looks with one audio, without a picture. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/neteq_60_ms_1_f1dfe8dd0c6af457976d6ceffb9cc3d8.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WaveNetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/waveneteq_60_ms_1_f9d02625c71b668a6234767075cb196f.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/neteq_60_ms_2_36d0519b296a64dc538a55aa799697c7.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WaveNetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/waveneteq_60_ms_2_b2a01d6b1ba35405203bbf430a5675f3.mp4" type="video/mp4"></video></div></div></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">120 ms</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
NetEQ packet loss</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/neteq_120_ms_1_f0effd0234b6f9778aab0ff445afc948.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WaveNetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/waveneteq_120_ms_1_7532342f5800ce52d0a450581816e035.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/neteq_120_ms_2_8e86d7b2061dfb964b845ebefc1aebd9.mp4" type="video/mp4"></video></div></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WaveNetEQ</font></font><br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://golovanov.net/habr/waveneteq_120_ms_2_63b829581a3291c144a030639139c199.mp4" type="video/mp4"></video></div></div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We guarantee reliability</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the important factors to consider in the PLC is the ability of the neural network to adapt to variable incoming signals, for example, when there are several talking people or when the background noise changes. To guarantee the reliability of the model for a wide range of users, we trained WaveNetEQ on a set of voice data taken from more than 100 different people who speak 48 different languages. This allowed the model to learn the general characteristics of human speech, and not the features of a particular language. To ensure the operation of WaveNetEQ in the event of noise in the background, when you, for example, answer a call while in a train or in a cafe, we supplement the data by mixing them with background noise from an extensive database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And although our model is able to learn how to plausibly continue your speech, it only works for short periods of time - it can end syllables, but cannot predict words. In the case of packet loss over long periods of time, we gradually decrease the volume, and after 120 ms the model produces only silence. Also, to ensure that the model does not produce false syllables, we examined the sound samples from WaveNetEQ and NetEQ using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Cloud Speech-to-Text API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and found that the model practically does not change the percentage of errors in the resulting text, that is, the number of errors that occur during speech recognition. </font><font style="vertical-align: inherit;">We experimented with WaveNetEQ at Duo, and its use positively impacted call quality and user experience. </font><font style="vertical-align: inherit;">WaveNetEQ already works on all Duo calls on Pixel 4 phones, and now we are deploying it on other phones.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499622/index.html">Antipatterns of retrospective in the Agile team. Part 1</a></li>
<li><a href="../en499624/index.html">Ansible Tools Overview</a></li>
<li><a href="../en499626/index.html">SOA on Laravel and JSON-RPC 2.0</a></li>
<li><a href="../en499628/index.html">Development interviews: choose friends</a></li>
<li><a href="../en499630/index.html">Flutter. Spring Update 2020</a></li>
<li><a href="../en499634/index.html">Advanced TypeScript</a></li>
<li><a href="../en499636/index.html">React Native for the little ones. Mobile Development Experience</a></li>
<li><a href="../en499642/index.html">Pixockets: how we wrote our own network library for the game server</a></li>
<li><a href="../en499644/index.html">Robot Creation (RPA) with AutoTest Tools</a></li>
<li><a href="../en499646/index.html">5 rules for integrating UX in Agile and Scrum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>