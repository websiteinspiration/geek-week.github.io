<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏇🏿 🔬 🤰🏽 MS SQL Server用にC＃.NETでLINQクエリを最適化するいくつかの側面 🕒 🎸 😬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="LINQは、強力な新しいデータ操作言語として.NETに入りました。その一部としてのLINQ to SQLでは、Entity Frameworkなどを使用してDBMSと簡単に通信できます。ただし、これを頻繁に使用する場合、開発者は、クエリ可能なプロバイダーがエンティティフレームワークを生成する特定のS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MS SQL Server用にC＃.NETでLINQクエリを最適化するいくつかの側面</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459716/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQは、強力な新しいデータ操作言語として.NETに入りました。</font><font style="vertical-align: inherit;">その一部としてのLINQ to SQLでは、Entity Frameworkなどを使用してDBMSと簡単に通信できます。</font><font style="vertical-align: inherit;">ただし、これを頻繁に使用する場合、開発者は、クエリ可能なプロバイダーがエンティティフレームワークを生成する特定のSQLクエリを確認するのを忘れます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を使用して2つの主要なポイントを分析しましょう。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、SQL ServerでTestデータベースを作成し、次のクエリを使用してその中に2つのテーブルを作成します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル作成</font></font></b><div class="spoiler_text"><pre><code class="sql">USE [TEST]<font></font>
GO<font></font>
<font></font>
SET ANSI_NULLS ON<font></font>
GO<font></font>
<font></font>
SET QUOTED_IDENTIFIER ON<font></font>
GO<font></font>
<font></font>
CREATE TABLE [dbo].[Ref](<font></font>
	[ID] [int] NOT NULL,<font></font>
	[ID2] [int] NOT NULL,<font></font>
	[Name] [nvarchar](255) NOT NULL,<font></font>
	[InsertUTCDate] [datetime] NOT NULL,<font></font>
 CONSTRAINT [PK_Ref] PRIMARY KEY CLUSTERED <font></font>
(<font></font>
	[ID] ASC<font></font>
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]<font></font>
) ON [PRIMARY]<font></font>
GO<font></font>
<font></font>
ALTER TABLE [dbo].[Ref] ADD  CONSTRAINT [DF_Ref_InsertUTCDate]  DEFAULT (getutcdate()) FOR [InsertUTCDate]<font></font>
GO<font></font>
<font></font>
USE [TEST]<font></font>
GO<font></font>
<font></font>
SET ANSI_NULLS ON<font></font>
GO<font></font>
<font></font>
SET QUOTED_IDENTIFIER ON<font></font>
GO<font></font>
<font></font>
CREATE TABLE [dbo].[Customer](<font></font>
	[ID] [int] NOT NULL,<font></font>
	[Name] [nvarchar](255) NOT NULL,<font></font>
	[Ref_ID] [int] NOT NULL,<font></font>
	[InsertUTCDate] [datetime] NOT NULL,<font></font>
	[Ref_ID2] [int] NOT NULL,<font></font>
 CONSTRAINT [PK_Customer] PRIMARY KEY CLUSTERED <font></font>
(<font></font>
	[ID] ASC<font></font>
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]<font></font>
) ON [PRIMARY]<font></font>
GO<font></font>
<font></font>
ALTER TABLE [dbo].[Customer] ADD  CONSTRAINT [DF_Customer_Ref_ID]  DEFAULT ((0)) FOR [Ref_ID]<font></font>
GO<font></font>
<font></font>
ALTER TABLE [dbo].[Customer] ADD  CONSTRAINT [DF_Customer_InsertUTCDate]  DEFAULT (getutcdate()) FOR [InsertUTCDate]<font></font>
GO<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のスクリプトを実行して、Refテーブルに入力します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照テーブルの塗りつぶし</font></font></b><div class="spoiler_text"><pre><code class="sql">USE [TEST]<font></font>
GO<font></font>
<font></font>
DECLARE @ind INT=1;<font></font>
<font></font>
WHILE(@ind&lt;1200000)<font></font>
BEGIN<font></font>
	INSERT INTO [dbo].[Ref]<font></font>
           ([ID]<font></font>
           ,[ID2]<font></font>
           ,[Name])<font></font>
    SELECT<font></font>
           @ind<font></font>
           ,@ind<font></font>
           ,CAST(@ind AS NVARCHAR(255));<font></font>
<font></font>
	SET @ind=@ind+1;<font></font>
END <font></font>
GO<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、次のスクリプトを使用してCustomerテーブルに入力します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customerテーブルへの入力</font></font></b><div class="spoiler_text"><pre><code class="sql">USE [TEST]<font></font>
GO<font></font>
<font></font>
DECLARE @ind INT=1;<font></font>
DECLARE @ind_ref INT=1;<font></font>
<font></font>
WHILE(@ind&lt;=12000000)<font></font>
BEGIN<font></font>
	IF(@ind%3=0) SET @ind_ref=1;<font></font>
	ELSE IF (@ind%5=0) SET @ind_ref=2;<font></font>
	ELSE IF (@ind%7=0) SET @ind_ref=3;<font></font>
	ELSE IF (@ind%11=0) SET @ind_ref=4;<font></font>
	ELSE IF (@ind%13=0) SET @ind_ref=5;<font></font>
	ELSE IF (@ind%17=0) SET @ind_ref=6;<font></font>
	ELSE IF (@ind%19=0) SET @ind_ref=7;<font></font>
	ELSE IF (@ind%23=0) SET @ind_ref=8;<font></font>
	ELSE IF (@ind%29=0) SET @ind_ref=9;<font></font>
	ELSE IF (@ind%31=0) SET @ind_ref=10;<font></font>
	ELSE IF (@ind%37=0) SET @ind_ref=11;<font></font>
	ELSE SET @ind_ref=@ind%1190000;<font></font>
	<font></font>
	INSERT INTO [dbo].[Customer]<font></font>
	           ([ID]<font></font>
	           ,[Name]<font></font>
	           ,[Ref_ID]<font></font>
	           ,[Ref_ID2])<font></font>
	     SELECT<font></font>
	           @ind,<font></font>
	           CAST(@ind AS NVARCHAR(255)),<font></font>
	           @ind_ref,<font></font>
	           @ind_ref;<font></font>
<font></font>
<font></font>
	SET @ind=@ind+1;<font></font>
END<font></font>
GO<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、2つのテーブルがあり、1つは100万行を超えるデータ行、もう1つは1000万行を超えるデータ行です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Visual StudioでテストプロジェクトVisual C＃コンソールアプリ（.NET Framework）を作成する必要があります。</font><font style="vertical-align: inherit;">
次に、Entity Frameworkがデータベースと対話するためのライブラリーを追加する必要があります。</font><font style="vertical-align: inherit;">
追加するには、プロジェクトを右クリックして、コンテキストメニューから[NuGetパッケージの管理]を選択します。</font><font style="vertical-align: inherit;">
次に、検索ウィンドウでNuGetパッケージを管理するためのウィンドウに「Entity Framework」という単語を入力し、Entity Frameworkパッケージを選択してインストールし</font><font style="vertical-align: inherit;">
ます。次に、Appファイルで。 configSections要素を閉じた後、次のブロックを追加します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/_8/on/cg/_8oncgmu5_8_pztudwbuvb_sno4.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/nx/7h/ro/nx7hromcmjrxgcmucgyrsqoal3g.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/tc/jw/yp/tcjwypggqb64ah4bmf7xjosbgz4.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="xml">&lt;connectionStrings&gt;<font></font>
    &lt;add name="DBConnection" connectionString="data source=__MSSQL;Initial Catalog=TEST;Integrated Security=True;" providerName="System.Data.SqlClient" /&gt;<font></font>
&lt;/connectionStrings&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
connectionStringには、接続文字列を入力する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、3つのインターフェースを別々のファイルに作成します。</font></font><br>
<br>
<ol>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IBaseEntityIDインターフェイスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">namespace TestLINQ<font></font>
{<font></font>
    public interface IBaseEntityID<font></font>
    {<font></font>
        int ID { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div></li>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IBaseEntityNameインターフェイスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">namespace TestLINQ<font></font>
{<font></font>
    public interface IBaseEntityName<font></font>
    {<font></font>
        string Name { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div></li>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IBaseNameInsertUTCDateインターフェイスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">namespace TestLINQ<font></font>
{<font></font>
    public interface IBaseNameInsertUTCDate<font></font>
    {<font></font>
        DateTime InsertUTCDate { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、別のファイルで、2つのエンティティのBaseEntity基本クラスを作成します。これには、共通フィールドが含まれます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseEntity基本クラスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">namespace TestLINQ<font></font>
{<font></font>
    public class BaseEntity : IBaseEntityID, IBaseEntityName, IBaseNameInsertUTCDate<font></font>
    {<font></font>
        public int ID { get; set; }<font></font>
        public string Name { get; set; }<font></font>
        public DateTime InsertUTCDate { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、別のファイルで、2つのエンティティを作成します。</font></font><br>
<br>
<ol>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refクラスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">using System.ComponentModel.DataAnnotations.Schema;<font></font>
<font></font>
namespace TestLINQ<font></font>
{<font></font>
    [Table("Ref")]<font></font>
    public class Ref : BaseEntity<font></font>
    {<font></font>
        public int ID2 { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div></li>
<li><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顧客クラスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">using System.ComponentModel.DataAnnotations.Schema;<font></font>
<font></font>
namespace TestLINQ<font></font>
{<font></font>
    [Table("Customer")]<font></font>
    public class Customer: BaseEntity<font></font>
    {<font></font>
        public int Ref_ID { get; set; }<font></font>
        public int Ref_ID2 { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、別のファイルにUserContextコンテキストを作成します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserContexクラスの実装</font></font></b><div class="spoiler_text"><pre><code class="cs">using System.Data.Entity;<font></font>
<font></font>
namespace TestLINQ<font></font>
{<font></font>
    public class UserContext : DbContext<font></font>
    {<font></font>
        public UserContext()<font></font>
            : base("DbConnection")<font></font>
        {<font></font>
            Database.SetInitializer&lt;UserContext&gt;(null);<font></font>
        }<font></font>
<font></font>
        public DbSet&lt;Customer&gt; Customer { get; set; }<font></font>
        public DbSet&lt;Ref&gt; Ref { get; set; }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS SQL ServerのEFを介したLINQ to SQLを使用した最適化テスト用の既製のソリューションを入手しました。</font><font style="vertical-align: inherit;">
次に、Program.csファイルに次のコードを入力します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/d5/ub/me/d5ubmeu5flbvj0c7zjqlongrm1c.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Program.csファイル</font></font></b><div class="spoiler_text"><pre><code class="cs">using System;<font></font>
using System.Collections.Generic;<font></font>
using System.Linq;<font></font>
<font></font>
namespace TestLINQ<font></font>
{<font></font>
    class Program<font></font>
    {<font></font>
        static void Main(string[] args)<font></font>
        {<font></font>
            using (UserContext db = new UserContext())<font></font>
            {<font></font>
                var dblog = new List&lt;string&gt;();<font></font>
                db.Database.Log = dblog.Add;<font></font>
<font></font>
                var query = from e1 in db.Customer<font></font>
                            from e2 in db.Ref<font></font>
                            where (e1.Ref_ID == e2.ID)<font></font>
                                 &amp;&amp; (e1.Ref_ID2 == e2.ID2)<font></font>
                            select new { Data1 = e1.Name, Data2 = e2.Name };<font></font>
<font></font>
                var result = query.Take(1000).ToList();<font></font>
<font></font>
                Console.WriteLine(dblog[1]);<font></font>
<font></font>
                Console.ReadKey();<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プロジェクトを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業が完了すると、コンソールに次のように表示されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成されたSQLクエリ</font></font></b><div class="spoiler_text"><pre><code class="sql">SELECT TOP (1000) <font></font>
    [Extent1].[Ref_ID] AS [Ref_ID], <font></font>
    [Extent1].[Name] AS [Name], <font></font>
    [Extent2].[Name] AS [Name1]<font></font>
    FROM  [dbo].[Customer] AS [Extent1]<font></font>
    INNER JOIN [dbo].[Ref] AS [Extent2] ON ([Extent1].[Ref_ID] = [Extent2].[ID]) AND ([Extent1].[Ref_ID2] = [Extent2].[ID2])<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、一般的に、非常に優れたLINQクエリは、MS SQL Server DBMSへのSQLクエリを生成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、LINQクエリでAND条件をORに変更します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQクエリ</font></font></b><div class="spoiler_text"><pre><code class="cs">var query = from e1 in db.Customer<font></font>
                            from e2 in db.Ref<font></font>
                            where (e1.Ref_ID == e2.ID)<font></font>
                                || (e1.Ref_ID2 == e2.ID2)<font></font>
                            select new { Data1 = e1.Name, Data2 = e2.Name };<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、再びアプリケーションを起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンド実行時間が30秒を超えることに関連するエラーで実行がクラッシュし</font><font style="vertical-align: inherit;">
ます。この場合に生成されたクエリLINQ：</font><font style="vertical-align: inherit;">
を確認すると、2つのセット（テーブル）のデカルト積で選択が行われていることを確認できます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/nm/2q/zb/nm2qzbaazpt5nemnisu4ubatvfy.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/hp/jf/if/hpjfif-gzr9ncr7dxdspvrxxmuw.jpeg"></a><br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成されたSQLクエリ</font></font></b><div class="spoiler_text"><pre><code class="sql">SELECT TOP (1000) <font></font>
    [Extent1].[Ref_ID] AS [Ref_ID], <font></font>
    [Extent1].[Name] AS [Name], <font></font>
    [Extent2].[Name] AS [Name1]<font></font>
    FROM  [dbo].[Customer] AS [Extent1]<font></font>
    CROSS JOIN [dbo].[Ref] AS [Extent2]<font></font>
    WHERE [Extent1].[Ref_ID] = [Extent2].[ID] OR [Extent1].[Ref_ID2] = [Extent2].[ID2]<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LINQクエリを次のように書き換えましょう。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化されたLINQクエリ</font></font></b><div class="spoiler_text"><pre><code class="cs">var query = (from e1 in db.Customer<font></font>
                   join e2 in db.Ref<font></font>
                   on e1.Ref_ID equals e2.ID<font></font>
                   select new { Data1 = e1.Name, Data2 = e2.Name }).Union(<font></font>
                        from e1 in db.Customer<font></font>
                        join e2 in db.Ref<font></font>
                        on e1.Ref_ID2 equals e2.ID2<font></font>
                        select new { Data1 = e1.Name, Data2 = e2.Name });<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、次のSQLクエリを取得します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLクエリ</font></font></b><div class="spoiler_text"><pre><code class="sql">SELECT <font></font>
    [Limit1].[C1] AS [C1], <font></font>
    [Limit1].[C2] AS [C2], <font></font>
    [Limit1].[C3] AS [C3]<font></font>
    FROM ( SELECT DISTINCT TOP (1000) <font></font>
        [UnionAll1].[C1] AS [C1], <font></font>
        [UnionAll1].[Name] AS [C2], <font></font>
        [UnionAll1].[Name1] AS [C3]<font></font>
        FROM  (SELECT <font></font>
            1 AS [C1], <font></font>
            [Extent1].[Name] AS [Name], <font></font>
            [Extent2].[Name] AS [Name1]<font></font>
            FROM  [dbo].[Customer] AS [Extent1]<font></font>
            INNER JOIN [dbo].[Ref] AS [Extent2] ON [Extent1].[Ref_ID] = [Extent2].[ID]<font></font>
        UNION ALL<font></font>
            SELECT <font></font>
            1 AS [C1], <font></font>
            [Extent3].[Name] AS [Name], <font></font>
            [Extent4].[Name] AS [Name1]<font></font>
            FROM  [dbo].[Customer] AS [Extent3]<font></font>
            INNER JOIN [dbo].[Ref] AS [Extent4] ON [Extent3].[Ref_ID2] = [Extent4].[ID2]) AS [UnionAll1]<font></font>
    )  AS [Limit1]<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悲しいかな、LINQクエリには接続条件が1つしかないため、条件ごとに2つのクエリで同等のクエリを作成し、Unionでそれらを組み合わせて行間の重複を削除することができます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、完全な重複行が返される可能性があるため、クエリは一般に同等ではありません。</font><font style="vertical-align: inherit;">ただし、実際には、完全な重複行は不要であり、それらを削除しようとしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、これら2つのクエリの実行プランを比較します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CROSS JOINの場合、平均実行時間は195秒です。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/oi/mu/a9/oimua9m82rdxniskq4foxwrvkwc.jpeg"></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INNER JOIN-UNIONの場合、平均実行時間は24秒未満です。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/mh/hf/cz/mhhfczpf2esap2nlk4njcdtvzss.jpeg"></a><br>
</li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、Plansフォルダーのこのリポジトリには、OR条件で要求を満たすための計画があります。</font></font></ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459706/index.html">ReactアプリケーションでReduxを忘れるべき5つの理由</a></li>
<li><a href="../ja459708/index.html">ゲームインターフェイスデザイン。ブレントフォックス この本は何についてですか？</a></li>
<li><a href="../ja459710/index.html">正面衝突を乗り越えて、なぜ健忘症があなたが考えているものではないのか</a></li>
<li><a href="../ja459712/index.html">公式の仕事での「ママのハッカー」：ペンテスターは何をしますか</a></li>
<li><a href="../ja459714/index.html">ゲームを実行するESP8266上の仮想マシン</a></li>
<li><a href="../ja459718/index.html">気に入らないコードを修正するための10のヒント</a></li>
<li><a href="../ja459722/index.html">チーム開発と登山の共通点は何ですか</a></li>
<li><a href="../ja459726/index.html">ロボット工学のクラブを開くときに絶対に行う必要のない7つのアイテム。ここでは絶対に行う必要はありません</a></li>
<li><a href="../ja459728/index.html">そよ風のスマートフォン：ZTE Red Magic 3レビュー</a></li>
<li><a href="../ja459730/index.html">QtをSTM32に移植する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>