<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèæ üßëüèø‚Äçü§ù‚Äçüßëüèø üéÖüèø Scrollbar that failed üíÖüèº ‚òØÔ∏è ü•ï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently released a new version of Windows Terminal. Everything would be fine, but the performance of her scrollbar left much to be desired. Therefore...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Scrollbar that failed</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently released a new version of Windows Terminal. </font><font style="vertical-align: inherit;">Everything would be fine, but the performance of her scrollbar left much to be desired. </font><font style="vertical-align: inherit;">Therefore, it is time to stick a little stick at him and play the tambourine.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do users usually do with the new version of any application? </font><font style="vertical-align: inherit;">That's right, exactly what testers did not do. </font><font style="vertical-align: inherit;">Therefore, after a brief use of the terminal for its intended purpose, I began to do terrible things with it. </font><font style="vertical-align: inherit;">Alright, alright, I just spilled coffee on the keyboard and accidentally clamped &lt;Enter&gt; when I wiped it. </font><font style="vertical-align: inherit;">What happened in the end?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, it does not look very impressive, but do not rush to throw stones at me. </font><font style="vertical-align: inherit;">Pay attention to the right side. </font><font style="vertical-align: inherit;">First try to figure out what is wrong with her. </font><font style="vertical-align: inherit;">Here's a screenshot for a hint:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the title of the article was a serious spoiler. :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, there is a problem with the scrollbar. Moving to a new line many times, after crossing the lower border, you usually expect a scrollbar to appear, and you can scroll up. However, this does not happen until we write a command with the output of something. Let's just say the behavior is strange. However, this might not have been so critical if the scrollbar worked ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having tested a little, I found that switching to a new line does not increase the buffer. This only makes the output of commands. So the above </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will increase the buffer by only one line. Because of this, over time we will lose a lot of history, especially after </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing that came to my mind was to use our analyzer and see what it says:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conclusion, of course, is of impressive size, so I will take advantage of the power of filtering and crop everything except the one containing the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I can‚Äôt say that there are a lot of messages ... Well, maybe then there is something related to the buffer?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer did not fail and found something interesting. </font><font style="vertical-align: inherit;">I highlighted this warning above. </font><font style="vertical-align: inherit;">Let's see what is wrong there: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There are identical sub-expressions to the left and to the right of the '-' operator: bufferHeight - bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code is accompanied by a comment: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Set up the height of the ScrollViewer and the grid we're using to fake our scrolling height." </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simulating the scroll height is, of course, good, but why are we putting 0 at the maximum? </font><font style="vertical-align: inherit;">Turning to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it became clear that the code is not very suspicious. </font><font style="vertical-align: inherit;">Do not get me wrong: subtracting a variable from itself is, of course, suspicious, but we get a zero at the output, which does not harm us. </font><font style="vertical-align: inherit;">In any case, I tried to specify the </font><font style="vertical-align: inherit;">default value (1) </font><font style="vertical-align: inherit;">in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maximum</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The scrollbar appeared, but it also does not work:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If anything, then I clamped &lt;Enter&gt; for 30 seconds. Apparently this is not the problem, so let‚Äôs leave it as it was, except by replacing </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with 0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we are not particularly close to solving the problem. In the absence of a better offer to go into debag. At first we could put a breakpoint on the changed line, but I doubt that it will help us somehow. Therefore, we first need to find the fragment that is responsible for the offset of the Viewport relative to the buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A little about how the local (and most likely any other) scrollbar works. We have one big buffer that stores all the output. To interact with it, some kind of abstraction is used to draw on the screen, in this case, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using these two primitives, we can understand what our problem is. Going to a new line does not increase the buffer, and because of this, we simply have nowhere to go. Therefore, the problem is in it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armed with this commonplace knowledge, we continue our heroic debag. </font><font style="vertical-align: inherit;">After a little walk around the function, I drew attention to this fragment:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we have configured the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> above </font><font style="vertical-align: inherit;">, we configure various callback functions and execute </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for our newly minted window. </font><font style="vertical-align: inherit;">After which the above lambda is called. </font><font style="vertical-align: inherit;">Since this is the first time we are writing something to the buffer, I suggest starting our debug from there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We set a breakpoint inside the lambda and look in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have two variables that are extremely important to us - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Put breakpoints on them and find where they change. True, with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I‚Äôll </font><i><font style="vertical-align: inherit;">cheat a</font></i><font style="vertical-align: inherit;"> little and put a breakpoint not on the variable itself, but on its </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field </font><font style="vertical-align: inherit;">(we just need it). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now click on &lt;F5&gt;, and nothing happens ... Well, then let's hit a couple of dozen times &lt;Enter&gt;. Nothing happened. Apparently, on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we set a breakpoint too recklessly, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as expected, remained at the top of the buffer, which did not increase in size. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, it makes sense to enter a command to cause a vertex update.</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After that, we got up on a very interesting piece of code:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I pointed out a comment where we left off. </font><font style="vertical-align: inherit;">If you look at the commentary on the fragment, it becomes clear that we are closer to the solution than ever. </font><font style="vertical-align: inherit;">It is in this place that the visible part is shifted relative to the buffer, and we get the opportunity to scroll. </font><font style="vertical-align: inherit;">Having observed the behavior a bit, I noticed one interesting point: when moving to a new line, the value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">is equal to the value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so we don‚Äôt omit it and nothing works. </font><font style="vertical-align: inherit;">In addition, there is a similar problem with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, let's increase the value of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by one and see what happened:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the launch result:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wonders! </font><font style="vertical-align: inherit;">I entered ne quantity and the scrollbar works. </font><font style="vertical-align: inherit;">True, until the moment we introduce something ... To demonstrate the file, I will attach a gif:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparently, we are doing a few extra jumps to a new line. </font><font style="vertical-align: inherit;">Let's then try to limit our transitions using the X coordinate. We will only shift the line when </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is 0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fragment written above will shift the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coordinate </font><font style="vertical-align: inherit;">for the cursor. </font><font style="vertical-align: inherit;">Then we update the cursor position. </font><font style="vertical-align: inherit;">In theory, this should work ... What happened?</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, of course, better. </font><font style="vertical-align: inherit;">However, there is a problem in that we shift the output point, but do not shift the buffer. </font><font style="vertical-align: inherit;">Therefore, we see two calls of the same command. </font><font style="vertical-align: inherit;">It may, of course, seem that I know what I am doing, but this is not so. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, I decided to check the contents of the buffer, so I returned to the point at which I started the debug:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I set a breakpoint in the same place as last time, and started looking at the contents of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Let's start with what I saw on my screen:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do you think will be in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> string </font><font style="vertical-align: inherit;">when I press &lt;Enter&gt;?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LONG DESCRIPTION"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The entire buffer that we now see.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The entire buffer, but without the first line.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not languish - the entire buffer, but without the first line. </font><font style="vertical-align: inherit;">And this is a considerable problem, because it is precisely because of this that we are losing history, moreover, pointwise. </font><font style="vertical-align: inherit;">This is how our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">help</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> output fragment will look </font><font style="vertical-align: inherit;">after going to a new line:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With an arrow I marked the place where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúLONG DESCRIPTOIN‚Äù was</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Maybe then overwrite the buffer with an offset of one line? </font><font style="vertical-align: inherit;">This would work if this callback was not called for every sneeze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have discovered at least three situations when it is called,</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we enter any character;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we move through history;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When we execute the command.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is that you need to move the buffer only when we execute the command, or enter &lt;Enter&gt;. </font><font style="vertical-align: inherit;">In other cases, doing this is a bad idea. </font><font style="vertical-align: inherit;">So we need to somehow determine inside what needs to be shifted.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="Picture 18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article was an attempt to show how skillfully PVS-Studio was able to find defective code leading to the error I noticed. </font><font style="vertical-align: inherit;">The message on the topic of subtracting a variable from itself strongly motivated me, and I vigorously proceeded to write the text. </font><font style="vertical-align: inherit;">But as you can see, my joy was premature and everything turned out to be much more complicated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So I decided to stop. </font><font style="vertical-align: inherit;">One could still spend a couple of evenings, but the longer I did this, the more and more problems arose. </font><font style="vertical-align: inherit;">All I can do is wish the Windows Terminal developers good luck in fixing this bug. </font><font style="vertical-align: inherit;">:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope I didn‚Äôt disappoint the reader that I didn‚Äôt finish the research and it was interesting for me to take a walk along the inside of the project. As a compensation, I suggest using the #WindowsTerminal promo code, thanks to which you will receive a demo version of PVS-Studio not for a week, but immediately for a month. If you have not tried the PVS-Studio static analyzer in practice, this is a good reason to do just that. Just enter "#WindowsTerminal" in the "Message" field on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the download page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And also, taking this opportunity, I want to remind you that soon there will be a version of C # analyzer working under Linux and macOS. And now you can sign up for preliminary testing.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to share this article with an English-speaking audience, then please use the link to the translation: Maxim Zvyagintsev. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Little Scrollbar That Could Not</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493026/index.html">Testing on prod: Canary Deployment</a></li>
<li><a href="../en493032/index.html">5. Check Point Maestro Frequently Asked Questions (FAQ)</a></li>
<li><a href="../en493034/index.html">COVID-19: predicting the number of patients with coronavirus</a></li>
<li><a href="../en493036/index.html">I twist and twist, I want to confuse: manipulations with two-layer graphene</a></li>
<li><a href="../en493038/index.html">About corporate culture for distributed teams and not only</a></li>
<li><a href="../en493042/index.html">Market audience data segment of online advertising and marketing. Part. 1. Changes in legislation</a></li>
<li><a href="../en493046/index.html">How to plan the opening of a cafe, or write your own planner for opening establishments</a></li>
<li><a href="../en493050/index.html">Search is not what to find</a></li>
<li><a href="../en493052/index.html">Problem</a></li>
<li><a href="../en493056/index.html">Checklist: how not to lose employees by sending them to an udalenka</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>