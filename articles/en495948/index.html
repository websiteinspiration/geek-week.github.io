<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚ÄçüöÄ üíáüèø üå∏ Rust Embedded. Development for Cortex-M3 processors using the STM32F103C8T6 (Black Pill) debug board üë©üèª‚Äçü§ù‚Äçüë®üèæ üè™ üë©üèº‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I want to introduce you to the Rust Embedded project . It allows us to use the Rust programming language for development for embedded platforms...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rust Embedded. Development for Cortex-M3 processors using the STM32F103C8T6 (Black Pill) debug board</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495948/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font><font style="vertical-align: inherit;">I want to introduce you to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust Embedded</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It allows us to use the Rust programming language for development for embedded platforms (Embedded Linux / RTOS / Bare Metal). </font></font><br>
<img src="https://habrastorage.org/webt/sh/5h/se/sh5hsergasrx_filqfoqh-yrbyu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we will consider the components that are necessary to begin development for Cortex-M3 microprocessors. </font><font style="vertical-align: inherit;">After that, we will write a simple example - blinking of the built-in LED.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we need an affordable and cheap Chinese debug board STM32F103C8T6 or Black Pill (due to the black color and small size). </font><font style="vertical-align: inherit;">There is also a version of the board in blue - Blue Pill. </font><font style="vertical-align: inherit;">I do not recommend it, since I heard that it has the wrong resistor, which causes problems when using the USB port. </font><font style="vertical-align: inherit;">Its second difference from Black Pill in the arrangement of pins (conclusions). </font><font style="vertical-align: inherit;">But more on that later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will also need a programmer for STM32 debug boards. </font><font style="vertical-align: inherit;">In this article, we will use the cheap and affordable Chinese ST-Link V2 programmer.</font></font><br>
<img src="https://habrastorage.org/webt/cb/rg/eu/cbrgeuyxins21rilbd3ayspihrg.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust Compiler Version</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get started, you need to make sure your compiler version is 1.31 or more recent. </font><font style="vertical-align: inherit;">You can check your compiler version by entering the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; rustc --version</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Component Installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can begin to install the necessary components.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNU Arm Embedded Toolchain</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will need a debugger for ARM chips - arm-none-eabi-gdb. </font><font style="vertical-align: inherit;">Launch the installer and follow the instructions. </font><font style="vertical-align: inherit;">At the end of the installation, be sure to check the " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add path to environment variable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">option </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download link</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After installation, you can check if everything is in order by entering the following at the command line:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; arm-none-eabi-gdb -v</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is in order, then you will see the version of the installed component.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ST-Link Driver</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to installing the driver for the ST-Link programmer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Follow the instructions of the installer and make sure that you install the correct ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sixty-four bit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thirty-two bit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) version of the driver depending on the bit depth of your operating system. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link to download</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ST-Link Tools</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to install the tools necessary for the firmware - ST-Link Tools. </font><font style="vertical-align: inherit;">Download the archive and unzip it to any convenient place, you also need to specify the path to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> subfolder </font><font style="vertical-align: inherit;">( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stlink-1.3.0 \ bin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) in the environment variable " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATH</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link to download</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cargo-binutils</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, install the package cargo-binutils, this is done by two commands in the console.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo install cargo-binutils<font></font>
&gt; rustup component add llvm-tools-preview</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This completes the installation of components.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating and setting up a project</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To continue, we need to create a new project with the name " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f103c8t6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font><font style="vertical-align: inherit;">Let me remind you, this is done by the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo new stm32f103c8t6</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project Dependencies and Optimization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect the necessary libraries in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cargo.toml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="json hljs">[package]<font></font>
name = <span class="hljs-string">"stm32f103c8t6"</span>
version = <span class="hljs-string">"0.1.0"</span>
authors = [<span class="hljs-string">"Nick"</span>]<font></font>
edition = <span class="hljs-string">"2018"</span><font></font>
<font></font>
#      Cortex-M3<font></font>
[dependencies]<font></font>
cortex-m = <span class="hljs-string">"*"</span>
cortex-m-rt = <span class="hljs-string">"*"</span>
cortex-m-semihosting = <span class="hljs-string">"*"</span>
panic-halt = <span class="hljs-string">"*"</span>
nb = <span class="hljs-string">"0.1.2"</span>
embedded-hal = <span class="hljs-string">"0.2.3"</span><font></font>
<font></font>
#       stm32f1<font></font>
[dependencies.stm32f1xx-hal]<font></font>
version = <span class="hljs-string">"0.5.2"</span>
features = [<span class="hljs-string">"stm32f100"</span>, <span class="hljs-string">"rt"</span>]<font></font>
<font></font>
#   `cargo fix`!<font></font>
[[bin]]<font></font>
name = <span class="hljs-string">"stm32f103c8t6"</span>
test = <span class="hljs-literal">false</span>
bench = <span class="hljs-literal">false</span><font></font>
<font></font>
#   <font></font>
[profile.release]<font></font>
codegen-units = <span class="hljs-number">1</span> #  <font></font>
debug = <span class="hljs-literal">true</span> #  ,     Flash <font></font>
lto = <span class="hljs-literal">true</span> #  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, you can see that, at the end of the file, code optimization has been enabled. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cortex-m-rt library requires us to create a file in the root directory of the project, it must be called " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memory.x</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font><font style="vertical-align: inherit;">It indicates how much memory our device has and its address:</font></font><br>
<br>
<pre><code class="json hljs">MEMORY<font></font>
{<font></font>
 FLASH : ORIGIN = <span class="hljs-number">0x08000000</span>, LENGTH = 64K<font></font>
 RAM : ORIGIN = <span class="hljs-number">0x20000000</span>, LENGTH = 20K<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting the target platform and default compilation goals</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary to set the target platform for the compiler, this is done by the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; rustup target add thumbv7m-none-eabi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, create the " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.cargo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">folder </font><font style="vertical-align: inherit;">in the root directory and the " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">file in it </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The contents of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="json hljs">[target.thumbv7m-none-eabi]<font></font>
<font></font>
[target.'cfg(all(target_arch = <span class="hljs-string">"arm"</span>, target_os = <span class="hljs-string">"none"</span>))']<font></font>
<font></font>
rustflags = [<span class="hljs-string">"-C"</span>, <span class="hljs-string">"link-arg=-Tlink.x"</span>]<font></font>
<font></font>
[build]<font></font>
target = <span class="hljs-string">"thumbv7m-none-eabi"</span>  # Cortex-M3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In it, we identified the default compilation goal, this allows us to compile our code into an ARM </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.elf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file with a simple and familiar command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo build --release</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that it works, consider the simplest example - blinking an LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The contents of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.rs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="rust hljs"><span class="hljs-meta">#![deny(unsafe_code)]</span>
<span class="hljs-meta">#![no_std]</span>
<span class="hljs-meta">#![no_main]</span><font></font>
<font></font>
<span class="hljs-keyword">use</span> panic_halt <span class="hljs-keyword">as</span> _;<font></font>
<font></font>
<span class="hljs-keyword">use</span> nb::block;<font></font>
<font></font>
<span class="hljs-keyword">use</span> stm32f1xx_hal::{<font></font>
    prelude::*,<font></font>
    pac,<font></font>
    timer::Timer,<font></font>
};<font></font>
<span class="hljs-keyword">use</span> cortex_m_rt::entry;
<span class="hljs-keyword">use</span> embedded_hal::digital::v2::OutputPin;<font></font>
<font></font>
<span class="hljs-comment">//   .</span>
<span class="hljs-meta">#[entry]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() -&gt; ! {<font></font>
    <font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">let</span> cp = cortex_m::Peripherals::take().unwrap();
    <span class="hljs-keyword">let</span> dp = pac::Peripherals::take().unwrap();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> flash = dp.FLASH.constrain();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> rcc = dp.RCC.constrain();<font></font>
<font></font>
    <span class="hljs-keyword">let</span> clocks = rcc.cfgr.freeze(&amp;<span class="hljs-keyword">mut</span> flash.acr);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> gpiob = dp.GPIOB.split(&amp;<span class="hljs-keyword">mut</span> rcc.apb2);<font></font>
<font></font>
    <span class="hljs-comment">//   b12   .</span>
    <span class="hljs-comment">//  "crh"      .</span>
    <span class="hljs-comment">//   0-7,    "crl".</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> led = gpiob.pb12.into_push_pull_output(&amp;<span class="hljs-keyword">mut</span> gpiob.crh);
    <span class="hljs-comment">//        .</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> timer = Timer::syst(cp.SYST, &amp;clocks)<font></font>
    .start_count_down(<span class="hljs-number">1</span>.hz());<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-comment">//    .</span>
    <span class="hljs-keyword">loop</span> {<font></font>
        block!(timer.wait()).unwrap();<font></font>
        led.set_high().unwrap();<font></font>
        block!(timer.wait()).unwrap();<font></font>
        led.set_low().unwrap();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first line, using the - attribute </font></font><code>#![deny(unsafe_code)]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we remove the possibility of using unsafe code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the second line, we placed the attribute </font></font><code>#![no_std]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it is required, because we are creating an application for bare iron, and the standard library needs an operating system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next comes an attribute </font></font><code>#![no_main]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that tells the compiler that we are not using the default default function with the argument vector and return type. This does not make sense, since we do not have an operating system or other runtime that calls the function and processes the return value. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the attributes, we plug the necessary modules into the scope. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is followed by a function, in our case, out of habit, we called it -</font></font><code>main()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is the entry point to the program, it is determined by the attribute </font></font><code>#[entry]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside the main function, we create a handle to a peripheral object that ‚Äúowns‚Äù all peripheral devices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, we can set the pin responsible for the LED built into the board to the output. Since in my case it is a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Black Pill</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> board </font><font style="vertical-align: inherit;">, the LED in it is connected to pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B12</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you have a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blue Pill</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> board </font><font style="vertical-align: inherit;">, then pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C13</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is responsible for the built-in LED </font><font style="vertical-align: inherit;">. Therefore, we set pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B12</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a push-pull output and assign it to a variable </font></font><code>led</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can set the update event trigger time for the system timer, and save it in a variable</font></font><code>timer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In our example, this time is one second. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then, in an endless loop, we can describe the logic of our program. </font><font style="vertical-align: inherit;">It is very simple, first </font></font><code>timer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocks the execution of the program until the time specified in it has passed. </font><font style="vertical-align: inherit;">The next step is to set the pin of the built-in LED to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">high</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so it lights up. </font><font style="vertical-align: inherit;">After that, the program execution is again blocked by the same timer, for one second. </font><font style="vertical-align: inherit;">And the pin of the LED is set to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">low</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , therefore it goes out. </font><font style="vertical-align: inherit;">Further, the program is cyclically repeated.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we have figured out the program code and logic, we can compile it into a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.elf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file with the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo build --release</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This format contains not only binary code, but also some headers and more. </font><font style="vertical-align: inherit;">This is useful when the file is launched by other software, such as the operating system or bootloader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, to run the program on bare metal, we need not a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.elf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">, but a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">is a software image that can be written byte into the microcontroller's memory. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.elf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">can be converted to a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">using the command:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo objcopy --bin stm32f103c8t6 --target thumbv7m-none-eabi --release -- -O binary stm32f103c8t6.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now our binary file is ready for firmware.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will flash the board using the ST-Link V2 programmer. To do this, you must first connect it to the board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the programmer case there is a pin arrangement of the connector. You need to pay attention to the cutout in the connector, it is also displayed on the diagram, which allows you to understand how to make the connection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3V</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pins of the programmer with the corresponding pins on the board. Ping </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWDIO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> connect to pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the DIO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWCLK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the CLK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After connecting the board to the programmer, we can connect the ST-Link to the computer. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attention!</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before connecting, disconnect all other power sources from the board, if any, otherwise it may damage the board or computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can check the connection:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; st-info --descr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the console, we should see the line " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F1 Medium-density device</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optionally, before flashing, you can clear the board‚Äôs memory if something is written on it:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; st-flash erase</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we can start the firmware: </font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; st-flash write stm32f1.bin 0x8000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is done correctly, you should see a blinking LED. </font><font style="vertical-align: inherit;">Congratulations!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, to flash the board, you must use this set of commands entered sequentially:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; cargo build --release<font></font>
&gt; cargo objcopy --bin stm32f103c8t6 --target thumbv7m-none-eabi --release -- -O binary stm32f103c8t6.bin<font></font>
&gt; st-flash erase<font></font>
&gt; st-flash write stm32f1.bin 0x8000000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To simplify our life, we can create a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.bat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file with these commands and run it from the console.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the author</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in these guides, welcome to my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YouTube channel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, recently, I started a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram channel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> where I publish various translations of manuals and books, news, humor and other things related to the Rust programming language. </font><font style="vertical-align: inherit;">There you can find links to several chatrooms in order to ask your questions and get help, submit your projects or just chat with like-minded people. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for the attention!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495934/index.html">DataGovernance in the home</a></li>
<li><a href="../en495938/index.html">A selection of articles on machine learning: cases, guides and studies for March 2020</a></li>
<li><a href="../en495942/index.html">Save time, nerves and man hours</a></li>
<li><a href="../en495944/index.html">Updated TOP50 (rating of CIS supercomputers): dynamics and trends</a></li>
<li><a href="../en495946/index.html">Norbert Wiener: the distracted father of cybernetics</a></li>
<li><a href="../en495954/index.html">How has Cisco been operating in remote access mode and an absent perimeter for 20 years?</a></li>
<li><a href="../en495956/index.html">Gotta go fast. Optimizing IMAP email content requests</a></li>
<li><a href="../en495960/index.html">Just AH-ny Wi-Fi. Or how we built a Wi-Fi 6 (AX) network in an educational institution</a></li>
<li><a href="../en495962/index.html">Udalenka: how in X5 they planned to switch to a remote format of work</a></li>
<li><a href="../en495966/index.html">Absurd code or "how not to write"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>