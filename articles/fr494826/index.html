<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍕 🌪️ 🐞 Être «nouveau» ou ne pas l'être ... 💜 🧜🏻 🐰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Rebonjour. En prévision du début des cours de base et avancés sur le développement Android, nous avons préparé pour vous une autre traduction intéress...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Être «nouveau» ou ne pas l'être ...</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/494826/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rebonjour. En prévision du début des cours de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avancés</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le développement Android, nous avons préparé pour vous une autre traduction intéressante.</font></font><br>
</i></b><br>
<br>
<img src="https://habrastorage.org/webt/hs/u-/yp/hsu-ypxo7-folltm3lmhdm9p91w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'injection de dépendances nous oblige</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à séparer les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveaux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opérateurs </font><font style="vertical-align: inherit;">et la logique d'application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cette séparation vous encourage à utiliser</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans votre code des usines chargées de lier votre application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cependant, plutôt que d'écrire des usines, nous préférerions utiliser</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> l'injection automatique de dépendances</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , comme GUICE, pour prendre en charge la liaison. Mais l'injection de dépendances peut-elle vraiment nous sauver de tous les</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nouveaux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opérateurs</font><font style="vertical-align: inherit;">?</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons deux extrêmes. Supposons que vous ayez une classe MusicPlayer qui devrait obtenir AudioDevice. Ici, nous voulons utiliser l'injection de dépendances et demander un AudioDevice dans le constructeur MusicPlayer. Cela nous permettra d'ajouter un AudioDevice compatible avec les tests, que nous pouvons utiliser pour affirmer que le son correct sort de notre MusicPlayer. Si nous utilisions le nouvel opérateur pour créer une instance de BuiltInSpeakerAudioDevice, nous aurions des difficultés de test. Appelons donc des objets comme AudioDevice ou MusicPlayer «Injectable». Injectable sont les objets que vous demanderez dans les constructeurs et attendez-vous à ce que le cadre d'implémentation des dépendances vous les fournisse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant à l'autre extrême. Supposons que vous ayez une primitive int int, mais que vous souhaitiez la compresser automatiquement dans Integer, le plus simple est d'appeler new Integer (5), et c'est la fin. Mais si l'injection de dépendance est le nouveau «nouveau», pourquoi appelons-nous nouveau en ligne? Est-ce que cela nuira à nos tests? Il s'avère que les cadres d’injection de dépendances ne peuvent pas vous fournir l’entier dont vous avez besoin, car ils ne comprennent pas de quel type d’entier il s’agit. Ceci est un peu un exemple de jouet, alors regardons quelque chose de plus complexe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'un utilisateur ait entré une adresse e-mail dans le champ de connexion et que vous devez appeler un nouvel e-mail (</font></font><code>«a@b.com»</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Pouvons-nous le laisser comme ça, ou devrions-nous demander un e-mail à notre constructeur? Encore une fois, le cadre d'injection de dépendances ne peut pas vous fournir d'e-mail, car vous devez d'abord obtenir la chaîne dans laquelle se trouve l'e-mail. Et il y a beaucoup de chaînes parmi lesquelles choisir. Comme vous pouvez le voir, il existe de nombreux objets que l'infrastructure d'injection de dépendances ne peut jamais fournir. Appelons-les « Newable », comme vous serez obligé d'appeler </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveau</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour eux </font><font style="vertical-align: inherit;">manuellement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, définissons quelques règles de base. Une classe Injectable peut interroger un autre Injectable dans son constructeur. (Parfois, j'appelle Injectable as a Service Object, mais ce terme est surchargé.) Injectable a tendance à avoir des interfaces, car il est possible que nous devions les remplacer par une implémentation qui est pratique pour les tests. Cependant, Injectable ne peut jamais interroger de non-Injectable (Newable) dans son constructeur. En effet, le framework d'injection de dépendances ne sait pas comment créer un Newable. Voici quelques exemples de classes que j'attendrais de mon infrastructure d'injection de dépendances: CreditCardProcessor, MusicPlayer, MailSender, OfflineQueue. De même, Newable peut être demandé par d'autres Newable dans leur constructeur, mais pas Injectable (parfois j'appelle Newable en tant qu'objet valeur, mais encore une fois,ce terme est surchargé). Quelques exemples de Newable: Email, MailMessage, User, CreditCard, Song. Si vous suivez ces distinctions, votre code sera facile à tester et à utiliser. Si vous enfreignez ces règles, votre code sera difficile à tester.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons l'exemple de MusicPlayer et Song</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device);<font></font>
  play(Song song);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que Song interroge uniquement les objets qui sont Newable. </font><font style="vertical-align: inherit;">Cela rend très facile l'instanciation d'un morceau dans un test. </font><font style="vertical-align: inherit;">MusicPlayer est complètement injectable, comme son argument AudioDevice, il peut donc être obtenu à partir du cadre pour l'injection de dépendances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant ce qui se passe si MusicPlayer enfreint la règle et demande Newable dans son constructeur.</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  String name;<font></font>
  <span class="hljs-keyword">byte</span>[] content;<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{<font></font>
  AudioDevice device;<font></font>
  Song song;<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device, Song song);<font></font>
  play();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, Song est toujours Newable, et il est facile de créer dans votre test ou dans votre code. MusicPlayer est déjà un problème. Si vous demandez à MusicPlayer de votre framework une injection de dépendance, il se bloquera car le framework ne saura pas de quel morceau il s'agit. La plupart des personnes novices dans les frameworks d'injection de dépendances font rarement cette erreur, car il est facile de le remarquer: votre code ne fonctionnera pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant ce qui se passe si Song enfreint la règle et demande Injectable dans son constructeur.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{<font></font>
  AudioDevice device;<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  String name;<font></font>
  <span class="hljs-keyword">byte</span>[] content;<font></font>
  MusicPlayer palyer;<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content, MusicPlayer player);<font></font>
  play();<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SongReader</span> </span>{<font></font>
  MusicPlayer player<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  SongReader(MusicPlayer player) {<font></font>
    <span class="hljs-keyword">this</span>.player = player;<font></font>
  }<font></font>
  <span class="hljs-function">Song <span class="hljs-title">read</span><span class="hljs-params">(File file)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Song(file.getName(),<font></font>
                    readBytes(file),<font></font>
                    player);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À première vue, tout va bien. Mais réfléchissez à la façon dont les morceaux seront créés. Vraisemblablement, les chansons sont stockées sur le disque, nous avons donc besoin de SongReader. SongReader devra demander à MusicPlayer de sorte que lors de l'appel de new pour Song, il puisse satisfaire les dépendances de Song sur MusicPlayer. Avez-vous remarqué quelque chose de mal ici? Quelle frayeur SongReader doit-il savoir sur MusicPlayer? Ceci est une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">violation de la loi de Demeter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. SongReader ne devrait pas connaître MusicPlayer. Du moins parce que SongReader n'appelle pas de méthodes avec MusicPlayer. Il ne connaît MusicPlayer que parce que Song a violé la séparation Newable / Injectable. SongReader paie l'erreur dans Song. Étant donné que le lieu où l'erreur est commise et où les conséquences se manifestent n'est pas la même chose, cette erreur est très subtile et difficile à diagnostiquer. Cela signifie également que de nombreuses personnes sont susceptibles de commettre cette erreur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En termes de tests, c'est une vraie douleur. Supposons que vous ayez SongWriter et que vous vouliez vous assurer qu'il sérialise correctement le morceau sur le disque. Vous devez créer un MockMusicPlayer afin de pouvoir le passer à Song afin de pouvoir le passer à SongWritter. Pourquoi rencontrons-nous même MusicPlayer ici? Regardons les choses dans l'autre sens. La chanson est ce que vous pourriez vouloir sérialiser, et la façon la plus simple de le faire est d'utiliser la sérialisation Java. Ainsi, nous sérialisons non seulement Song, mais aussi MusicPlayer et AudioDevice. Ni MusicPlayer ni AudioDevice ne doivent être sérialisés. Comme vous pouvez le voir, de petits changements facilitent grandement la testabilité.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, travailler avec du code est plus facile si nous séparons ces deux types d'objets. Si vous les mélangez, votre code sera difficile à tester. Les objets qui se trouvent à la fin du graphique d'objet de votre application sont nouveaux. Newable peut dépendre d'autres Newable, par exemple, comment CreditCard peut dépendre de Address, qui peut dépendre de City - ces choses sont des feuilles du graphique d'application. Puisqu'ils sont des feuilles et ne communiquent avec aucun service externe (les services externes sont injectables), ils n'ont pas besoin de faire de stubs. Rien ne ressemble plus à String que String lui-même. Pourquoi devrais-je créer un talon pour l'utilisateur, si je peux simplement appeler un nouvel utilisateur, pourquoi faire des talons pour tout cela: Email, MailMessage, Utilisateur, CreditCard, Song? Appelez simplement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveau</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et terminez.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faisons maintenant attention à quelque chose de très subtil. </font><font style="vertical-align: inherit;">Il est normal que Newable connaisse Injectable. </font><font style="vertical-align: inherit;">Ce qui n'est pas normal, c'est que Newable a une référence à Injectable en tant que champ. </font><font style="vertical-align: inherit;">En d'autres termes, Song peut connaître MusicPlayer. </font><font style="vertical-align: inherit;">Par exemple, il est normal que Injectable MusicPlayer passe à travers la pile vers Newable Song. </font><font style="vertical-align: inherit;">Parce que le passage à travers la pile est indépendant du cadre d'injection de dépendance. </font><font style="vertical-align: inherit;">Comme dans cet exemple:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);
  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isPlayable</span><span class="hljs-params">(MusicPlayer player)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème se produit lorsque Song a un champ de lien vers MusicPlayer. </font><font style="vertical-align: inherit;">Les champs de lien sont définis par le constructeur, ce qui entraînera une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">violation de la loi Demeter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour l'appelant et des difficultés pour nos tests.</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur les cours</font></font></h4><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développeur Android. </font><font style="vertical-align: inherit;">Cours de base</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développeur Android. </font><font style="vertical-align: inherit;">Cours avancé</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494810/index.html">Introduction à la 3D: principes de base de Three.js</a></li>
<li><a href="../fr494814/index.html">Slurm est-il utile?</a></li>
<li><a href="../fr494818/index.html">Comment choisir un terminal de trading pour travailler sur la bourse</a></li>
<li><a href="../fr494820/index.html">Comment les spécifications de l'alimentation ATX12VO d'Intel changeront l'avenir</a></li>
<li><a href="../fr494824/index.html">Comment le système de contenu des pages Turbo est organisé: schémas, faits et un peu d'histoire</a></li>
<li><a href="../fr494830/index.html">ViennaNET: un ensemble de bibliothèques pour le backend</a></li>
<li><a href="../fr494838/index.html">Modems GSM / 3G / 4G dans des systèmes embarqués utilisant le modem Quectel EC21 LTE et Yocto Project comme exemple</a></li>
<li><a href="../fr494848/index.html">15 femmes qui ont fait une grande contribution à l'astronomie</a></li>
<li><a href="../fr494850/index.html">Configurer Microsoft Windows Server 2016/2019 pour fournir des services DHCP pour VXLAN (DFA)</a></li>
<li><a href="../fr494854/index.html">Semaine de la sécurité 14: confidentialité en cas de pandémie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>