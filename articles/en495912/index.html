<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçµ üå∂Ô∏è ‚ùï Smart replay stickers üßëüèø‚Äçü§ù‚Äçüßëüèª üîÖ üë©üèΩ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! Today we restarted ICQ . Key features of the new messenger are based on artificial intelligence technologies: Smart Reply quick sticker a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Smart replay stickers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/495912/"><img src="https://habrastorage.org/webt/ja/zt/al/jaztal8pyit_ixzysliloz-xvt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello, Habr! </font><font style="vertical-align: inherit;">Today we </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restarted ICQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Key features of the new messenger are based on artificial intelligence technologies: Smart Reply quick sticker and text prompt system for answering an incoming message, suggesting stickers for entered phrases, voice message recognition and others. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will talk about one of them - Smart Reply. </font><font style="vertical-align: inherit;">This feature will save users time, since they will only need to click on the sticker they like from the ones offered. </font><font style="vertical-align: inherit;">At the same time, the feature will popularize the use of various stickers and increase the emotionality of communication.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data preparation </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task from the field of NLP was solved with the help of machine learning and neural networks. The training was conducted on specially prepared data from public chats. The pairs were used: a fragment of the dialogue and a sticker that was sent by one of the users in response to the last message of the interlocutor. To better take into account the context, a fragment of the dialogue consists of the last interlocutor's messages that are glued together, and from the user's messages before them. You can experiment with the number of messages, for example, the Google ML Kit uses a context of 10 messages </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[1]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the problems that I had to deal with is that the frequency of using stickers, starting from the most popular ones, drops sharply. </font><font style="vertical-align: inherit;">Moreover, the total number of stickers is more than a million. </font><font style="vertical-align: inherit;">The figure below shows the descending frequency of use of the 4000 most popular stickers. </font><font style="vertical-align: inherit;">Therefore, 4000 popular stickers with the removal of some of the most frequent ones were chosen for training in order to reduce the uneven distribution of the training set.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/140/db3/cb4/140db3cb42c67722e99084c161134423.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frequencies of use of 4000 most popular stickers in descending order. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For texts, normalization was carried out in terms of removing numbers, repeating letters, single characters, punctuation (except for question marks and exclamations, which are important for meaning), reducing the letters to lower case. </font><font style="vertical-align: inherit;">In general, the specifics are such that in chat rooms, users are poorly following the grammar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model selection</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For prediction, the Siamese DSSM model is used, by analogy with the model for Smart Reply in Mail.ru (a similar architecture is described in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[2]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but with certain differences. The advantage of the Siamese model in efficiency for inference, since the part corresponding to the stickers is calculated in advance. To answer letters, the original model uses a bag of n-gram words to represent the text, which is justified for writing: the text can be large, and we need to grasp the general specifics and give some standard short answer. In the case of chats and stickers, the text is short, and individual words are more important here. Therefore, it was decided to use individual word embeddings as features and add an LSTM layer for them. A similar idea of ‚Äã‚Äãusing the LSTM layer in the case of short texts was used, for example, for text responses in the Google Allo messenger </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[3]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and in the smiley prediction model corresponding to DeepMoji short messages </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[4]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The figure below schematically shows the model.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ac/161/ac1/1ac161ac1ec8ecc8951c1de3bf2c2d86.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture model.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the figure, the initial layers are the embeddings of incoming tokenized words (left) and stickers (right). For the tokenization of words, a dictionary was used, which included 100K of the most popular words. To separate messages from different users, a special dedicated token was used. Training is end-to-end. After calculating the embeddings for the sequence of words, we go to the LSTM layer, the state of which is then transferred to the fully connected layers with tangent activation. As a result, in the left encoder at the output we get a vector that represents the text, and in the right - the vector corresponding to the sticker. The scalar product of vectors determines how text and sticker fit together. The dimension of the embeddings, the vector of the internal state of the LSTM, and the output vector were taken to be 300.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The objective function for training looks like this:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/912/d16/17b/912d1617b8ad6b8f6bd0cb1518f50d4b.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the size of the batch, </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S (x </font></font></i><i><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></sub></i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y </font></font></i><i><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></sub></i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the scalar product of the resulting vectors for positive examples of text-sticker pairs, </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S (x </font></font></i><i><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></sub></i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y </font></font></i><i><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j</font></font></sub></i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- scalar product of vectors for negative examples of text-sticker pairs. Negative examples of text-sticker pairs were generated due to random mixing of the original correct pairs. Since, for popular universal stickers, it is likely that when mixing again it turns out to be the correct pair, at the stage of retraining, additional control was used as part of the batch so that there were no similar texts for positive and negative pairs with one sticker. During the experiments work better if negative examples to use less than </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the K</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In view of the noise of the data, training in large batches worked better. The complication of the model and the addition of the attention layer did not give a noticeable improvement in accuracy, which, rather, indicates the limitations associated with the data and their quality.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the fact that the approach with a dictionary of individual words, rather than character n-gram, is chosen, the model‚Äôs flexibility with respect to typos is lost. </font><font style="vertical-align: inherit;">An experiment was conducted with the training of fastText embedding, which is trained directly in the network, thereby reducing the impact of errors. </font><font style="vertical-align: inherit;">In this case, the training went worse, and the addition of an attention layer helped noticeably. </font><font style="vertical-align: inherit;">After weighing quality indicators and other factors, it was decided to dwell on a simpler model. </font><font style="vertical-align: inherit;">In this case, the problem of typos is solved by using a spellchecker in a situation if the word is not in the dictionary. </font><font style="vertical-align: inherit;">In normal mode, the spellchecker is not used, as some words with errors are a feature of informal chatting.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting Answers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does the model work at the inference stage? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We calculate the sticker vectors calculated by the right encoder in advance. </font><font style="vertical-align: inherit;">At the request processing stage, only the left encoder is used to obtain a vector for the incoming text. </font><font style="vertical-align: inherit;">Next, you need to get the list of stickers in descending order of the scalar product of the text and sticker vector. </font><font style="vertical-align: inherit;">This can be done directly by multiplying all the sticker vectors, or use the nearest neighbor search algorithms for this metric. </font><font style="vertical-align: inherit;">For example, in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[2] it is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proposed to use Hierarchical Quantization for Maximum Inner Product Search (MIPS). </font><font style="vertical-align: inherit;">We applied the HNSW search algorithm, and this gave a significant acceleration compared to exhaustive search.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Making answers diverse</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next stage is the diversification of the proposed stickers, as often top-end stickers can be all the same.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/jo/7d/8ujo7dfnrmz9vvu9ywnmdgtpzx0.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three suggested stickers for the phrase "Hello": without diversification and with diversification.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Several options for diversification have been tested. The easiest way is to choose the top N stickers, taking into account the limit on the score, then select the top sticker, and select the other two with the maximum distance between each other, while limiting the allowable difference in the distances to the top sticker. This approach can be combined using the results of manual marking of stickers by emotional coloring (positive, negative, neutral), and choose from the top N stickers with different colors, if any.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another option is to cluster stickers by their embeddings, and when outputting results, select no more than one sticker from the cluster. </font><font style="vertical-align: inherit;">For clustering, the UMAP + HDBSCAN bundle was used. </font><font style="vertical-align: inherit;">UMAP is a new effective dimensionality reduction algorithm that surpasses the already proven t-SNE. </font><font style="vertical-align: inherit;">Dimension reduction was applied to two, and then the HDBSCAN clustering algorithm was used. </font><font style="vertical-align: inherit;">About 100 clusters were identified. </font><font style="vertical-align: inherit;">This task is not completely automatically solved, with various settings it was possible to achieve clustering of up to 70% of stickers, but then manual revision, verification is required. </font><font style="vertical-align: inherit;">Therefore, we settled on the simpler options described above, since their result was good.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a5d/ddd/473/a5dddd4731398b5b12edc31d3ed02269.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clustering stickers on embeds.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">results</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we got a simple and effective smart replay sticker, which demonstrated a very good quality of answers. According to tests for 1000 different phrases, from simple to relatively complex, according to respondents, the top sticker was called completely suitable in more than 75% of cases. In the test of 100 simpler and more popular phrases, the result is even more impressive: the top sticker was called completely suitable in 93% of cases.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb2/102/ed1/eb2102ed1df3a0b9c0fa38a5b143bf2e.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of stickers offered by the model of answers. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What are the disadvantages? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the imbalance in the training dataset, some words have an unnecessarily large impact. </font><font style="vertical-align: inherit;">For example, the word ‚Äúlove‚Äù in some context often leads to the proposal of various ‚Äúromantic‚Äù stickers, since there is a bias in this direction in the training data. </font><font style="vertical-align: inherit;">The introduction of additional weights for frequency words and stickers, as well as the augmentation of phrases, did not completely solve the problem, but partially improved the situation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We do not rest on our laurels, and the process of improving the quality of our models continues, experiments are conducted to modify the architecture and mechanisms for preparing and using data.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Literature</font></font></h2><br>
<ol>
<li>Google updates ML Kit with Smart Reply API for third-party Android and iOS apps. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">9to5google.com/2019/04/05/ml-kit-smart-reply</a></li>
<li>Matthew Henderson, Rami Al-Rfou, Brian Strope, Yun-Hsuan Sung, Laszlo Lukacs, Ruiqi Guo, Sanjiv Kumar, Balint Miklos, and Ray Kurzweil. EfÔ¨Åcient Natural Language Response Suggestion for Smart Reply. arXiv:1705.00652v1, 2017.</li>
<li>Pranav Khaitan. Chat Smarter with Allo. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">ai.googleblog.com/2016/05/chat-smarter-with-allo.html</a></li>
<li>Bjarke Felbo, Alan Mislove, Anders S√∏gaard, Iyad Rahwan, Sune Lehmann. Using millions of emoji occurrences to learn any-domain representations for detecting sentiment, emotion and sarcasm. arXiv:1708.00524v2, 2017.</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495898/index.html">A practical guide to dealing with memory leaks in Node.js</a></li>
<li><a href="../en495902/index.html">CAPTCHA: killing conversion</a></li>
<li><a href="../en495904/index.html">Can an epidemic be predicted?</a></li>
<li><a href="../en495908/index.html">The path to the reward</a></li>
<li><a href="../en495910/index.html">Installing ROS in a Ubuntu Single-Board IMG Image</a></li>
<li><a href="../en495918/index.html">How to reproduce realistic sound in computer games and VR and why it is difficult</a></li>
<li><a href="../en495920/index.html">Implementation Details of the PTPv2 Time Synchronization Protocol</a></li>
<li><a href="../en495924/index.html">Why is it so damn difficult to build a good COVID-19 distribution model?</a></li>
<li><a href="../en495926/index.html">We are writing firmware for TI cc2530 on Z-Stack 3.0 for Zigbee Sonoff BASICZBR3 relay with ds18b20 sensor</a></li>
<li><a href="../en495932/index.html">What is the hidden meaning of the authors in the SCRUM Guide. Part 1. About the process</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>