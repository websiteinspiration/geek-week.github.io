<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¹ğŸ¼ ğŸ•¢ ğŸ¥ WAL-Gï¼šPostgreSQLæ•°æ®åº“å¤‡ä»½å’Œæ¢å¤ ğŸ‘ğŸ½ ğŸ‘¨ğŸ¿â€ğŸš’ ğŸ˜²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨SQLè½¬å‚¨ä¸­å¤‡ä»½ï¼ˆä½¿ç”¨pg_dumpæˆ–pg_dumpallï¼‰ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚è¦å¤‡ä»½PostgreSQLï¼Œæœ€å¥½ä½¿ç”¨pg_basebackupå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å¯ä»¥ç”ŸæˆWALæ—¥å¿—çš„äºŒè¿›åˆ¶å‰¯æœ¬ã€‚ä½†æ˜¯ï¼Œå½“æ‚¨å¼€å§‹ç ”ç©¶åˆ›å»ºå¤‡ä»½å’Œè¿˜åŸçš„æ•´ä¸ªè¿‡ç¨‹æ—¶ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼Œæ‚¨è‡³å°‘éœ€è¦ç¼–å†™ä¸¤ä¸ªä¸‰è½®è½¦ï¼Œä»¥ä¾¿æ‰€æœ‰è¿™äº›éƒ½èƒ½èµ·ä½œç”¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-Gï¼šPostgreSQLæ•°æ®åº“å¤‡ä»½å’Œæ¢å¤</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨SQLè½¬å‚¨ä¸­å¤‡ä»½ï¼ˆä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ–</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚è¦å¤‡ä»½PostgreSQLï¼Œæœ€å¥½ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘½ä»¤</font><font style="vertical-align: inherit;">ï¼Œè¯¥</font><font style="vertical-align: inherit;">å‘½ä»¤</font><font style="vertical-align: inherit;">å¯ä»¥ç”ŸæˆWALæ—¥å¿—çš„äºŒè¿›åˆ¶å‰¯æœ¬ã€‚ä½†æ˜¯ï¼Œå½“æ‚¨å¼€å§‹ç ”ç©¶åˆ›å»ºå¤‡ä»½å’Œè¿˜åŸçš„æ•´ä¸ªè¿‡ç¨‹æ—¶ï¼Œæ‚¨å°†äº†è§£åˆ°ï¼Œæ‚¨è‡³å°‘éœ€è¦ç¼–å†™ä¸¤ä¸ªä¸‰è½®è½¦ï¼Œä»¥ä¾¿æ‰€æœ‰è¿™äº›éƒ½èƒ½èµ·ä½œç”¨ï¼Œå¹¶ä¸”ä¸ä¼šä½¿æ‚¨ä»ä¸Šè‡³ä¸‹æ„Ÿåˆ°ç—›è‹¦ã€‚ä¸ºäº†å‡è½»ç—›è‹¦ï¼Œå¼€å‘äº†WAL-Gã€‚</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯ç”¨Goè¯­è¨€ç¼–å†™çš„å·¥å…·ï¼Œç”¨äºå¤‡ä»½å’Œè¿˜åŸPostgreSQLæ•°æ®åº“ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€è¿‘æ›´æ–°æ˜¯MySQL / MariaDBï¼ŒMongoDBå’ŒFoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">å®ƒæ”¯æŒä½¿ç”¨Amazon S3å­˜å‚¨ï¼ˆä»¥åŠç±»ä¼¼çš„äº§å“ï¼Œä¾‹å¦‚Yandex Object Storageï¼‰ä»¥åŠGoogle Cloud Storageï¼ŒAzureå­˜å‚¨ï¼ŒSwiftå¯¹è±¡å­˜å‚¨ä»¥åŠä»…ä¸æ–‡ä»¶ç³»ç»Ÿä¸€èµ·ä½¿ç”¨ã€‚</font><font style="vertical-align: inherit;">æ•´ä¸ªè®¾ç½®ç®€åŒ–ä¸ºç®€å•çš„æ­¥éª¤ï¼Œä½†æ˜¯ç”±äºæœ‰å…³å®ƒçš„æ–‡ç« åˆ†æ•£åœ¨Internetä¸Šï¼Œå› æ­¤æ²¡æœ‰å®Œæ•´çš„æ“ä½œæ–¹æ³•æ‰‹å†Œï¼Œå…¶ä¸­åŒ…æ‹¬å¾€è¿”çš„æ‰€æœ‰æ­¥éª¤ï¼ˆå“ˆå¸ƒé›·ï¼ˆHabrÃ©ï¼‰ä¸Šæœ‰å‡ ç¯‡æ–‡ç« ï¼Œä½†å¾ˆå¤šè¦ç‚¹éƒ½åœ¨é‚£é‡Œï¼‰ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="PostgreSQLå¤‡ä»½"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ’°å†™æœ¬æ–‡ä¸»è¦æ˜¯ä¸ºäº†ä½¿æ‚¨çš„çŸ¥è¯†ç³»ç»ŸåŒ–ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä¸æ˜¯DBAï¼Œå¯ä»¥åœ¨æŸä¸ªåœ°æ–¹ç”¨éåˆ©å£«å‘å±•è¯­è¨€è¡¨ç¤ºï¼Œå› æ­¤æ¬¢è¿è¿›è¡Œä»»ä½•æ›´æ­£ï¼</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦å¤–ï¼Œæˆ‘æ³¨æ„åˆ°ä»¥ä¸‹æ‰€æœ‰å†…å®¹å‡ä¸Ubuntu 18.04ä¸Šçš„PostgreSQL 12.3ç›¸å…³ä¸”å·²éªŒè¯ï¼Œæ‰€æœ‰å‘½ä»¤å¿…é¡»ä»¥ç‰¹æƒç”¨æˆ·èº«ä»½æ‰§è¡Œã€‚</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰è£…</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒWAL-Gçš„ç¨³å®šç‰ˆæœ¬ä¸º</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v0.2.15ï¼ˆ2020å¹´3æœˆï¼‰</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†ä½¿ç”¨å®ƒï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³è‡ªå·±ä»masteråˆ†æ”¯è¿›è¡Œç»„è£…ï¼Œé‚£ä¹ˆgithubå­˜å‚¨åº“å°†æä¾›æœ‰å…³æ­¤æ“ä½œçš„æ‰€æœ‰è¯´æ˜</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">è¦ä¸‹è½½å¹¶å®‰è£…ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¹‹åï¼Œæ‚¨å¿…é¡»å…ˆé…ç½®WAL-Gï¼Œç„¶åé…ç½®PostgreSQLæœ¬èº«ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-Gè®¾å®š</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½œä¸ºå¤‡ä»½å­˜å‚¨çš„ç¤ºä¾‹ï¼Œå°†ä½¿ç”¨Amazon S3ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å› ä¸ºå®ƒç¦»æˆ‘çš„æœåŠ¡å™¨æ›´è¿‘å¹¶ä¸”ä½¿ç”¨éå¸¸ä¾¿å®œ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">è¦ä½¿ç”¨å®ƒï¼Œæ‚¨éœ€è¦ä¸€ä¸ªâ€œ s3å­˜å‚¨æ¡¶â€å’Œè®¿é—®é”®ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥å‰æœ‰å…³WAL-Gçš„æ‰€æœ‰æ–‡ç« éƒ½ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼Œä½†æ˜¯ä»æ­¤å‘è¡Œç‰ˆå¼€å§‹ï¼Œè¿™äº›è®¾ç½®å¯ä»¥ä½äº</font><font style="vertical-align: inherit;">postgresç”¨æˆ·ä¸»ç›®å½•</font><font style="vertical-align: inherit;">ä¸­çš„</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.walg.jsonæ–‡ä»¶</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ã€‚</font><font style="vertical-align: inherit;">è¦åˆ›å»ºå®ƒï¼Œè¯·æ‰§è¡Œä»¥ä¸‹bashè„šæœ¬ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘å°†åœ¨æ‰€æœ‰æ–¹é¢è¿›è¡Œä¸€äº›è§£é‡Šï¼š</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†è¦å€’å…¥å¤‡ä»½çš„S3-bucketçš„è·¯å¾„ï¼ˆå¯ä»¥åœ¨æ ¹ç›®å½•ä¸­ä¹Ÿå¯ä»¥åœ¨æ–‡ä»¶å¤¹ä¸­ï¼‰ï¼›</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> â€“    S3 (<i>      â€“     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> â€“     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> â€“  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> â€“  Â«Â»     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDâ€‹â€‹ATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -è·¯å¾„ä¸æ•°æ®åº“ä¸­çš„æ•°æ®çš„ç›®å½•ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œæ‰¾å‡º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">å‘½ä»¤</font></i><font style="vertical-align: inherit;">ï¼‰;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸æ•°æ®åº“çš„è¿æ¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½ï¼Œæœ€å¥½é€šè¿‡unix-socketè¿›è¡Œè¿æ¥ï¼Œå¦‚æœ¬ä¾‹æ‰€ç¤ºã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¶ä»–å‚æ•°å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°ï¼š</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">//github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></a><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLè®¾ç½®</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†ä½¿æ•°æ®åº“å†…çš„å½’æ¡£ç¨‹åºå°†WALæ—¥å¿—ä¸Šä¼ åˆ°äº‘ä¸­å¹¶ä»ä¸­æ¢å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œæ‚¨éœ€è¦åœ¨é…ç½®æ–‡ä»¶</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.confä¸­</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®¾ç½®å‡ ä¸ªå‚æ•°</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">åˆšå¼€å§‹æ—¶ï¼Œ</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨éœ€è¦ç¡®ä¿</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥ä¸‹è®¾ç½®å‡æœªè®¾ç½®ä¸ºå…¶ä»–ä»»ä½•å€¼ï¼Œä»¥ä¾¿åœ¨é‡æ–°å¯åŠ¨é…ç½®æ—¶DBMSä¸ä¼šæ‰çº¿ã€‚</font><font style="vertical-align: inherit;">æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ è¿™äº›å‚æ•°ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> â€œarchive_timeout=60â€ &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®¾ç½®å‚æ•°è¯´æ˜ï¼š</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘WALæ‚å¿—å†™å¤šå°‘ä¿¡æ¯ï¼Œâ€œå‰¯æœ¬â€-ç¼–å†™æ‰€æœ‰å†…å®¹ï¼›</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‚æ•°ä¸­çš„å‘½ä»¤å¯ç”¨WALæ—¥å¿—çš„ä¸‹è½½</font><font style="vertical-align: inherit;">ï¼›</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”¨äºå½’æ¡£å®Œæ•´çš„WALæ—¥å¿—çš„å‘½ä»¤ï¼›</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…åœ¨æ—¥å¿—å½’æ¡£å®Œæˆåæ‰è¿›è¡Œå½’æ¡£ï¼Œä½†æ˜¯å¦‚æœæ‚¨çš„æœåŠ¡å™¨ç¨ç¨æ›´æ”¹/å‘æ•°æ®åº“ä¸­æ·»åŠ æ•°æ®ï¼Œåˆ™åœ¨æ­¤å¤„è®¾ç½®ä»¥ç§’ä¸ºå•ä½çš„é™åˆ¶æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ­¤åå°†å¼ºåˆ¶æ‰§è¡Œå½’æ¡£å‘½ä»¤ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘æ¯ç§’éƒ½è¦å¯¹æ•°æ®åº“è¿›è¡Œå¤§é‡å†™å…¥ï¼Œå› æ­¤æˆ‘æ‹’ç»åœ¨Productionä¸­è®¾ç½®æ­¤å‚æ•°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼›</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”¨äºä»å¤‡ä»½è¿˜åŸWALæ—¥å¿—çš„å‘½ä»¤ï¼Œå¦‚æœâ€œå®Œå…¨å¤‡ä»½â€ï¼ˆåŸºæœ¬å¤‡ä»½ï¼‰ä¸­ç¼ºå°‘æœ€åçš„æ•°æ®åº“æ›´æ”¹ï¼Œåˆ™å°†ä½¿ç”¨è¯¥å‘½ä»¤ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£çš„ç¿»è¯‘ä¸­é˜…è¯»æœ‰å…³æ‰€æœ‰è¿™äº›å‚æ•°çš„æ›´å¤šä¿¡æ¯ï¼š</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">//postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></a><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®¾ç½®å¤‡ä»½æ—¶é—´è¡¨</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ç®¡å–œæ¬¢ä¸å¦ï¼Œä½†æ˜¯cronæ˜¯æœ€æ–¹ä¾¿çš„å¯åŠ¨æ–¹æ³•ã€‚</font><font style="vertical-align: inherit;">è¿™å°±æ˜¯æˆ‘ä»¬å°†é…ç½®ç”¨äºåˆ›å»ºå¤‡ä»½çš„å†…å®¹ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬ä»åˆ›å»ºå®Œæ•´å¤‡ä»½çš„å‘½ä»¤å¼€å§‹ï¼šåœ¨wal-gä¸­ï¼Œè¿™æ˜¯è¿è¡Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„å‚æ•°</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯é¦–å…ˆï¼Œæœ€å¥½ç”±postgresç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼ˆå¹¶ä¸”æ²¡æœ‰è®¿é—®é”™è¯¯ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¼€å§‹å‚æ•°æŒ‡ç¤ºæ•°æ®ç›®å½•çš„è·¯å¾„-æˆ‘æé†’æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥è¯†åˆ«å®ƒ</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå¹¶ä¸”æ•°æ®å·²ä¸Šä¼ åˆ°S3å­˜å‚¨åº“ï¼Œåˆ™å¯ä»¥åœ¨crontabä¸­é…ç½®å®šæœŸå¯åŠ¨ï¼š</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå¤‡ä»½è¿‡ç¨‹æ¯å¤©æ—©ä¸Š4:15å¼€å§‹ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ é™¤æ—§å¤‡ä»½</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œæ‚¨ä¸éœ€è¦å­˜å‚¨ä¸­ç”Ÿä»£ç»å¯¹çš„æ‰€æœ‰å¤‡ä»½ï¼Œå› æ­¤å®šæœŸâ€œæ¸…ç†â€æ‚¨çš„å­˜å‚¨ï¼ˆâ€œå®Œæ•´å¤‡ä»½â€å’ŒWALæ—¥å¿—ï¼‰å°†å¾ˆæœ‰ç”¨ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬è¿˜å°†é€šè¿‡cronä»»åŠ¡å®Œæˆæ‰€æœ‰æ“ä½œï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cronæ¯å¤©æ—©ä¸Š6:30æ‰§è¡Œæ­¤ä»»åŠ¡ï¼Œåˆ é™¤é™¤è¿‡å»10å¤©çš„å‰¯æœ¬å¤–çš„æ‰€æœ‰å†…å®¹ï¼ˆå®Œæ•´å¤‡ä»½ï¼Œå¢é‡å’ŒWALï¼‰ï¼Œä½†å°†åœ¨</font><font style="vertical-align: inherit;">æŒ‡å®šæ—¥æœŸ</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹‹å‰</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è‡³å°‘ä¿ç•™ä¸€ä¸ªå¤‡ä»½</font><u><font style="vertical-align: inherit;">ï¼Œ</font></u><font style="vertical-align: inherit;">ä»¥ä¾¿</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¥</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ—¥æœŸ</font><u><font style="vertical-align: inherit;">ä¹‹åçš„</font></u><font style="vertical-align: inherit;">ä»»ä½•</font><font style="vertical-align: inherit;">æ—¶é—´è½å…¥PITR ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»å¤‡ä»½è¿˜åŸ</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¿è¯åŸºç¡€å¥åº·çš„å‰ææ˜¯å®šæœŸæ¢å¤å¹¶éªŒè¯å†…éƒ¨æ•°æ®çš„å®Œæ•´æ€§å·²ä¸æ˜¯ä»€ä¹ˆç§˜å¯†ã€‚å¦‚ä½•ä½¿ç”¨WAL-Gæ¢å¤-æˆ‘å°†åœ¨æœ¬èŠ‚ä¸­ä»‹ç»ï¼Œç¨åæˆ‘ä»¬å°†è®¨è®ºæ£€æŸ¥ã€‚</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œè¦åœ¨æµ‹è¯•ç¯å¢ƒï¼ˆä¸æ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰ä¸Šè¿›è¡Œæ¢å¤-æ‚¨éœ€è¦åœ¨S3ä¸­ä½¿ç”¨åªè¯»å¸æˆ·ï¼Œä»¥å…æ„å¤–è¦†ç›–å¤‡ä»½ã€‚å¯¹äºWAL-Gï¼Œæ‚¨éœ€è¦åœ¨ç»„ç­–ç•¥ä¸­ä¸ºS3ç”¨æˆ·è®¾ç½®ä»¥ä¸‹æƒé™ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•ˆæœï¼šå…è®¸</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼š</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3ï¼šGetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3ï¼šListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3ï¼šGetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚å¹¶ä¸”ï¼Œå½“ç„¶ï¼Œä¸è¦å¿˜è®°</font><i><font style="vertical-align: inherit;">äº‹å…ˆ</font></i><font style="vertical-align: inherit;">åœ¨</font><i><font style="vertical-align: inherit;">postgresql.conf</font></i><font style="vertical-align: inherit;">è®¾ç½®æ–‡ä»¶</font><i><font style="vertical-align: inherit;">ä¸­</font></i><font style="vertical-align: inherit;">è®¾ç½®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ ·æ‚¨çš„æµ‹è¯•åŸºç¡€å°±ä¸æƒ³å®‰é™åœ°å¤‡ä»½ã€‚</font><b><font style="vertical-align: inherit;">åˆ é™¤æ‰€æœ‰PostgreSQLæ•°æ®</font></b><font style="vertical-align: inherit;">ï¼ˆåŒ…æ‹¬ç”¨æˆ·ï¼‰åï¼Œ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åªéœ€è½»è½»ç§»åŠ¨æ‰‹æŒ‡å³å¯è¿›è¡Œæ¢å¤</font><font style="vertical-align: inherit;">ï¼Œå› æ­¤åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤æ—¶è¯·æ ¼å¤–å°å¿ƒã€‚</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºé‚£äº›æƒ³æ£€æŸ¥æ¢å¤è¿‡ç¨‹çš„ç”¨æˆ·-ä¸‹é¢å‡†å¤‡äº†ä¸€å°éƒ¨åˆ†bash-magicï¼Œä»¥ä¾¿åœ¨æ¢å¤é—®é¢˜ä¸­-è„šæœ¬å´©æºƒæ—¶è¿”å›éé›¶é€€å‡ºä»£ç ã€‚</font><font style="vertical-align: inherit;">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»¥5ç§’çš„è¶…æ—¶æ—¶é—´ï¼ˆä»…æ¢å¤10åˆ†é’Ÿï¼‰å®Œæˆäº†120æ¬¡æ£€æŸ¥ï¼Œä»¥å‘ç°ä¿¡å·æ–‡ä»¶æ˜¯å¦å·²åˆ é™¤ï¼ˆè¿™æ„å‘³ç€æ¢å¤æˆåŠŸï¼‰ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆåŠŸæ¢å¤åï¼Œè¯·ä¸è¦å¿˜è®°é‡æ–°å¯åŠ¨æ‰€æœ‰è¿›ç¨‹ï¼ˆpgbouncer / monitç­‰ï¼‰ã€‚</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¢å¤åçš„æ•°æ®éªŒè¯</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¡®ä¿åœ¨æ¢å¤åæ£€æŸ¥æ•°æ®åº“çš„å®Œæ•´æ€§ï¼Œä»¥å…å‡ºç°å¤‡ä»½æŸå/å¼¯æ›²çš„æƒ…å†µã€‚</font><font style="vertical-align: inherit;">æœ€å¥½å¯¹åˆ›å»ºçš„æ¯ä¸ªå­˜æ¡£éƒ½æ‰§è¡Œæ­¤æ“ä½œï¼Œä½†æ˜¯åœ¨ä½•å¤„ä»¥åŠå¦‚ä½•è¿›è¡Œå–å†³äºæ‚¨çš„æƒ³è±¡åŠ›ï¼ˆæ‚¨å¯ä»¥æ¯å°æ—¶å¢åŠ ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨CIä¸­è¿è¡Œæµ‹è¯•ï¼‰ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯è‡³å°‘-æ‚¨éœ€è¦æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®å’Œç´¢å¼•ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦æ£€æŸ¥æ•°æ®ï¼Œè¶³ä»¥åœ¨è½¬å‚¨ä¸­è¿è¡Œå®ƒä»¬ï¼Œä½†æ˜¯æœ€å¥½åœ¨åˆ›å»ºæ•°æ®åº“æ—¶å¯ç”¨æ ¡éªŒå’Œï¼ˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®æ ¡éªŒå’Œ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†æ£€æŸ¥ç´¢å¼•-æœ‰</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€ä¸ªamcheckæ¨¡å—</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬å°†ä»</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-Gæµ‹è¯•ä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å–sqlæŸ¥è¯¢ï¼Œ</font><font style="vertical-align: inherit;">å¹¶å›´ç»•ä»¥ä¸‹å†…å®¹æ„å»ºä¸€äº›é€»è¾‘ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       â€“ )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grepâ€™ </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€»ç»“</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘æ„Ÿè°¢Andrei Borodinåœ¨ç¼–å†™è¯¥å‡ºç‰ˆç‰©æ–¹é¢çš„å¸®åŠ©ï¼Œå¹¶ç‰¹åˆ«æ„Ÿè°¢ä»–ä¸ºWAL-Gçš„å‘å±•åšå‡ºçš„è´¡çŒ®ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™ä¸ªéŸ³ç¬¦ä¸Šç»“æŸäº†ã€‚</font><font style="vertical-align: inherit;">æˆ‘å¸Œæœ›æˆ‘èƒ½å¤Ÿä¼ è¾¾è®¾ç½®çš„ç®€æ˜“æ€§ä»¥åŠåœ¨è´µå…¬å¸ä¸­ä½¿ç”¨æ­¤å·¥å…·çš„å·¨å¤§æ½œåŠ›ã€‚</font><font style="vertical-align: inherit;">æˆ‘å¬è¯´è¿‡å¾ˆå¤šæœ‰å…³WAL-Gçš„ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´åä¸‹æ¥è§£å†³é—®é¢˜ã€‚</font><font style="vertical-align: inherit;">å½“æˆ‘åœ¨å®¶é‡Œä»‹ç»å®ƒä¹‹åï¼Œè¿™ç¯‡æ–‡ç« æµ®å‡ºæ°´é¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒWAL-Gä¹Ÿå¯ä»¥ä¸ä»¥ä¸‹DBMSä¸€èµ·ä½¿ç”¨ï¼š</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»æäº¤çš„è§’åº¦æ¥çœ‹-é¢„è®¡è¿˜ä¼šæœ‰æ›´å¤šï¼</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN506594/index.html">Redisæœ€ä½³åšæ³•ï¼Œç¬¬3éƒ¨åˆ†</a></li>
<li><a href="../zh-CN506598/index.html">å¾®è½¯ï¼šRustæ˜¯å®‰å…¨ç³»ç»Ÿç¼–ç¨‹è¡Œä¸šä¸­çš„â€œæœ€ä½³æœºä¼šâ€</a></li>
<li><a href="../zh-CN506600/index.html">åœ¨é¡¹ç›®ç®¡ç†æ–¹é¢è¿›è¡Œç«™ç‚¹å¼€å‘çš„åˆåŒï¼ˆç†è®º+æ ·æœ¬ï¼‰</a></li>
<li><a href="../zh-CN506604/index.html">å¹¶å‘å’Œæ•ˆç‡ï¼šPythonä¸FSM</a></li>
<li><a href="../zh-CN506606/index.html">PIXI.jsç­”é¢˜å™¨çš„åˆ›å»º</a></li>
<li><a href="../zh-CN506612/index.html">å¦‚ä½•æé«˜å¤§è§„æ¨¡åœ¨çº¿è¯¾ç¨‹çš„å®Œæ•´æ€§</a></li>
<li><a href="../zh-CN506620/index.html">åˆ›é€ æ€§æ€ç»´ï¼šè¿™æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•è¡¡é‡å’Œå¢åŠ æ‚¨çš„æ½œåŠ›</a></li>
<li><a href="../zh-CN506624/index.html">FOSSæ–°é—»ç¬¬20å·-2020å¹´6æœˆ8æ—¥è‡³14æ—¥å…è´¹å’Œå¼€æºæ–°é—»å›é¡¾</a></li>
<li><a href="../zh-CN506626/index.html">Kamailio SBCæˆ–ä¸æ˜¯SBCï¼Ÿ</a></li>
<li><a href="../zh-CN506628/index.html">ï¼ƒ348ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ6æœˆ8æ—¥è‡³14æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>