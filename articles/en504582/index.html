<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùÔ∏è ‚ùå ‚õ∏Ô∏è HackTheBox. Walkthrough Resolute. Password spraying. From DnsAdmin to SYSTEM üèë üë©‚Äç‚öñÔ∏è ü§úüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to publish solutions sent for further processing from the HackTheBox site . 
 
 In this article, we collect information about the machine, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox. Walkthrough Resolute. Password spraying. From DnsAdmin to SYSTEM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504582/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gn/q2/-v/gnq2-vvbv1u9l2qsjqo_xdmfins.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I continue to publish solutions sent for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">further processing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> site </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we collect information about the machine, perform password spraying to obtain the user, and also increase our rights from DnsAdmin to SYSTEM using a malicious DLL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connection to the laboratory is via VPN. </font><font style="vertical-align: inherit;">It is recommended not to connect from a work computer or from a host where the data that is important to you is available, as you end up on a private network with people who know something in the field of information security :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizational Information</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This machine has an IP address 10.10.10.169, which I add to / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.169    resolute.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we scan open ports. </font><font style="vertical-align: inherit;">Since it takes a long time to scan all the ports with nmap, I will first do this with masscan. </font><font style="vertical-align: inherit;">We scan all TCP and UDP ports from the tun0 interface at a speed of 500 packets per second.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.169  --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/k1/uk/ot/k1ukotzhyjd56cow0b0oqasqkmk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The host has many ports open. </font><font style="vertical-align: inherit;">Now scan them with nmap to filter and select the ones you need.</font></font><br>
<br>
<pre><code class="bash hljs">nmap resolute.htb -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49676,49677,49688,49915
</code></pre><br>
<img src="https://habrastorage.org/webt/bc/b5/yx/bcb5yxsifvtjhc-e203w7xyqatq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, for more detailed information about the services that operate on ports, we will run a scan with the -A option.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A resolute.htb -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49676,49677,49688,49915</code></pre><br>
<img src="https://habrastorage.org/webt/le/jg/ue/lejgue_z-x0yqnqsmzxnbdzfwok.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/cy/v5/zi/cyv5zicubk1tuyupghapzz16jyg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From nmap output we find the domain name megabank.local, which we add to / etc / hosts. </font><font style="vertical-align: inherit;">The first thing in intelligence for Windows is a basic listing. </font><font style="vertical-align: inherit;">Personally, when testing from a linux machine, I use enum4linux.</font></font><br>
<br>
<pre><code class="bash hljs">enum4linux -a megabank.local</code></pre><br>
<img src="https://habrastorage.org/webt/fo/gn/ve/fognvexkwr4dzovjhb-n59wztyu.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/mg/bx/ya/mgbxya7qhtailkwfen673xqgfxc.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/8h/pg/1m/8hpg1mlmap9unk-dsvayaylfeu4.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/9q/sj/64/9qsj64fxebsws98ae5dgk-jucci.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/lb/80/ga/lb80gabpp01s5j1cbuwwwu5qae0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And among the information about the domain, users, group, and password policy, we find an interesting comment on the user account mark. </font><font style="vertical-align: inherit;">The comment contains his password. </font><font style="vertical-align: inherit;">But after logging in with these credentials, we fail on all services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USER</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we already have a password and a list of users highlighted in the system, we can use one of the Lateral Movement techniques - Password Spraying. I wrote about all this in detail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The bottom line is that we try known passwords for all known users. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we try to sort through SMB. You can use the smb_login module for the Metasploit Framework for this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jq/0d/gw/jq0dgwaihzuybfux46cjgog5maa.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We indicate the necessary parameters. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/sk/fh/muskfhabe--hkxh4r6peyibbmz0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we successfully find the user to whom this password is suitable. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/be/eq/3cbeeqmhas_mthgr0xqltadfxya.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And check the credentials. I prefer smbmap, which specifies the user, password, domain and host.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/n7/mt/qqn7mthjuwwot1iun0tqzigbymc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we get a list of available resources. </font><font style="vertical-align: inherit;">If you return to the list of ports, then there is a running WinRM service on 5985. For convenient work with this service from under linux, you can use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evil-WinRM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ar/qs/o5/arqso553svopq61bg-bqbpeftn0.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USER2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Evil-WinRM works fine, but the metterpter is still more convenient. Fortunately, this program allows you to specify a directory with PowerShell or C # files when connecting, which will be automatically loaded into the session. We will generate a PowerShell file that will contain the Meterpreter load. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sf/cx/ao/sfcxaodejj1vo0afslfu3ez4vrw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And create a listener to listen for the connection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i9/ri/r4/i9rir4zftzvjjdrjub9gakmwdbm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are connected with Evil-WinRM and we specify a directory with a script. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e2/f_/xh/e2f_xhfockxgky8a__jy1uzrvri.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But after starting the file with the load, we see that the script worked without errors, but there is no connection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wm/dc/xj/wmdcxjb_c0qwigchcwmfyvrujym.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most likely the script was blocked. Since this is PowerShell, it is most likely using AMSI. But Evil-WinRM has its own useful modules. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/yb/y8/vhyby8bp6gimrzevacifhlqmpva.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you might guess, we need the first one. We will apply this module and run our file with the load again.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/zo/jd/7nzojdvvvylhcmksvfowwzknxu8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we observe a successful connection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w_/9u/sb/w_9usb7uyyblhvalp1mnnhe-ec4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After running the scripts for Recon, bypassing the machine, we come across an interesting directory. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0f/7u/r5/0f7ur5peboaw5b-btlbkt_i-2mq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the directory that stores the text file from the recorded PowerShell sessions, after the ‚ÄúStart-Transcript‚Äù command. </font><font style="vertical-align: inherit;">We are looking for a file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/yn/tq/bjyntq4um9hqaa_nyczbaxq63mk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see the contents. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xm/ed/so/xmedsokrl0wpjezu-jlts-sntlg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, this is a Ryan user session. </font><font style="vertical-align: inherit;">And a little further we find the command with which the password was transmitted. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/e8/kr/s0e8krsihtsjrgmnghnfeaix_zm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We try credentials for the WinRM service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hp/ys/r7/hpysr7o0ttyvb84rywglvbfhiji.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the end, log in as Ryan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And first of all, checking the information about the current user, we find an interesting feature. He is a member of the DnsAdmins group. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/7x/ab/ux7xabfv8ooxpgvhcx9obvxb01e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This gives us the opportunity to upgrade our privileges to SYSTEM. We may ask you to load the DLL the next time the service starts. Let's generate the DLL containing the meterpreter load. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4r/7z/xp/4r7zxplhr6orsb3gmr8s07ffk9a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And run the listener. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uu/ef/4r/uuef4rkqmxy9_hhduqix6utuqvq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now activate the smb server. We indicate the directory, name and support for SMB version 2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vg/qc/s9/vgqcs9mkmhzjx_24kpl8ofkxbsg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now using dnscmd we will indicate which DLL to load. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d4/4c/n7/d44cn7-e3e_swbqk--zg9b74cos.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/uw/fc/vq/uwfcvqs8sruryh5guqsrhsoidwu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The command completed successfully, now restart the DNS service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sm/28/sp/sm28sprkxmrrvvutvok8dhnjkda.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And after a reboot, we see a connection via SMB. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1l/g1/xq/1lg1xqphy3ooqbjwtlldgzjsm50.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As well as an open session. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b5/cz/fi/b5czfis340lgjqh6q0hs_cy3z-m.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we get System rights. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can join us on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">There you can find interesting materials, merged courses, as well as software. </font><font style="vertical-align: inherit;">Let's put together a community in which there will be people who are versed in many areas of IT, then we can always help each other on any IT and information security issues.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504566/index.html">Table in Atlassian Confluence based on data from a REST request</a></li>
<li><a href="../en504568/index.html">Isaac Asimov: Where do people get new ideas from?</a></li>
<li><a href="../en504572/index.html">Speak like Winston Churchill: who needs to sell their soul to communicate in English SO</a></li>
<li><a href="../en504576/index.html">How home audio developed - from song nights to the first mechanical players</a></li>
<li><a href="../en504578/index.html">How Americans Become Millionaires: FIRE Principles</a></li>
<li><a href="../en504586/index.html">ES2020 innovations that I really like</a></li>
<li><a href="../en504590/index.html">Pure PHP architecture. How to measure and control it?</a></li>
<li><a href="../en504592/index.html">PuppetConf 2016. Kubernetes for system administrators. Part 3</a></li>
<li><a href="../en504598/index.html">Database of primes up to one hundred billion on the knee</a></li>
<li><a href="../en504600/index.html">What awaits the airline after the crisis: Warren Buffett's opinion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>