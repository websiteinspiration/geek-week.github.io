<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèïÔ∏è üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üìç Fix problems under Docker. It would seem, what does GIT have to do with it? üèéÔ∏è ü§© ü§∑üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker under Windows is an ongoing adventure. Then he needs to update the OS, otherwise the latest versions are not installed, then he forgets how to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fix problems under Docker. It would seem, what does GIT have to do with it?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490882/"><img src="https://habrastorage.org/webt/gg/h6/mi/ggh6mikfd0je9-8pcmxwrzgsxzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker under Windows is an ongoing adventure. Then he needs to update the OS, otherwise the latest versions are not installed, then he forgets how to connect to the network. In general, every day from him news. ‚ÄúSet and forget‚Äù is not about Docker Desktop for Windows. Especially when it is not used exactly as its developers recommend. And for some reason they do not approve of connecting external windows to network drives as local. And they do not approve of access to network folders that are also located on the host machine. They write that this is horror-horror from a security point of view, they require all sorts of keys such as: </font><font style="vertical-align: inherit;">
for the </font><b><font style="vertical-align: inherit;">mount</font></b><font style="vertical-align: inherit;"> command to work </font><font style="vertical-align: inherit;">in the container, and so on and so forth.</font></font><br>
<br>
<code> cap_add:<br>
 - SYS_ADMIN<br>
 - DAC_READ_SEARCH</code><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, when once again after the containers were uploaded to the customer‚Äôs server, the services stopped seeing network drives, I was not particularly surprised. This has already happened, and even a step-by-step instruction was written for the support group, how and what to reboot when the docker network settings break.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So I open my instructions and take action. Restarting containers does not help. I restart through docker-compose with recreation of an infrastructure - does not help. I reset the Docker settings to the factory settings, restore the settings for the virtual machine, reload the images, run through docker-compose - again, everything is as before - it does not see the network. More precisely, it does not connect to network balls, although ping from the container to the SMB server is normal. The last point is to reboot the server and reinstall Docker, while I skip, because I really do not want to restart the server. On this instruction ended. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, I‚Äôm moving to my home machine, here I also have Docker for Windows, but a slightly newer version. I check on it. The same eggs:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/wx/iz/8wwxiz22uw0uvoqxymmglbwek_g.png" alt="There is no connection, but you hold on!"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yeah. Well, really, I think Docker rolled up the update with some kind of security and now my scripts do not start because of this? The last check is to completely remove Docker from the machine, and reinstall it. This should be cooler than resetting to factory settings. I‚Äôm doing the whole list from the previous step, only in addition to this I‚Äôm also restarting my car so that it‚Äôs completely ironic. I put Docker from scratch, upload images, launch docker-compose - eprst! All services both did not see the network ball and continue to write ‚Äúmount error (22): Invalid argument‚Äù when loading. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I try to run the script line by line from the command line: connect to the container, run commands in turn and see that everything connects and works like need to:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p <span class="hljs-variable">$SMB_MOUNT_POINT</span>
mount -t cifs <span class="hljs-variable">$SMB_SHARE</span> <span class="hljs-variable">$SMB_MOUNT_POINT</span> -o user=<span class="hljs-variable">$SMB_USER</span>,password=<span class="hljs-variable">$SMB_PASSWORD</span>,vers=2.0<font></font>
ls <span class="hljs-variable">$SMB_MOUNT_POINT</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, what is this, some kind of crap with passing parameters to the script when the container starts? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are looking for more ideas. All options with a docker reboot are shallow, there are options with possible changes in the parent image. My image is built based on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openjdk: 8-jdk-alpine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no specific version is specified, so any security improvements could break my scripts. Maybe they changed something in OpenJDK or a subsidiary of Alpine? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I check the project logs, try to select the older openjdk: 8-jdk-alpine-3.8, openjdk: 8-jdk-alpine-3.7, etc. - every time I rebuild the container, check - everything is as before.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damn it! </font><font style="vertical-align: inherit;">Maybe I still changed something in my assembly? </font><font style="vertical-align: inherit;">Unloading from GIT'a version of the project a month ago, collecting - the same glitches. </font><font style="vertical-align: inherit;">Three months ago - the problem is still there. </font><font style="vertical-align: inherit;">How so? </font><font style="vertical-align: inherit;">What changed? </font><font style="vertical-align: inherit;">The docker configuration is currently guaranteed to work, the image configuration has not changed either, the project sources are the same (GIT saves everything). </font><font style="vertical-align: inherit;">There are no miracles - you need to understand where the changes nevertheless appeared. </font><font style="vertical-align: inherit;">In prod, I manually launch the connection commands to the balls - so until the restart the services will work fine and go to sleep. </font><font style="vertical-align: inherit;">The morning is wiser than the evening.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is no connection, but you hold on!</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next morning the idea comes - that it‚Äôs probably time to find out, and what exactly the script does not like when executing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The message ‚Äúmount error (22): Invalid argument‚Äù is not very informative. </font><font style="vertical-align: inherit;">I find that there is a magic key for the bash with which it displays debugging info when executing scripts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Start debugging inside sh:</font></font><br>
 <br>
<pre><code class="bash hljs">/ <span class="hljs-comment"># sh -x /entry-point.sh</span>
<span class="hljs-string">' echo '</span>Mount //&lt;private_ip&gt;/Exchange/Pipeline to /pipeline<font></font>
Mount //&lt;private_ip&gt;/Exchange/Pipeline to /pipeline<font></font>
<span class="hljs-string">' mkdir -p '</span>/pipeline
<span class="hljs-string">' mount -t cifs //&lt;private_ip&gt;/Exchange/Pipeline /pipeline -o '</span>user=&lt;private_user&gt;,password=&lt;private_password&gt;,vers=2.0<font></font>
mount error(22): Invalid argument<font></font>
Refer to the mount.cifs(8) manual page (e.g. man mount.cifs)<font></font>
mount: mounting //&lt;private_ip&gt;/Exchange/Pipeline on /pipeline failed: Invalid argument<font></font>
<span class="hljs-string">' ls '</span>/pipeline<font></font>
+ <span class="hljs-built_in">exec</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here some strange moments appear - the line starts with quotation marks, then the quotation marks at the end ... Where are the quotation marks from? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Idea - can launching using real bash be more informative? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install in the BASH container:</font></font><br>
<br>
<pre><code class="bash hljs">apk add bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I start debugging:</font></font><br>
<br>
<pre><code class="bash hljs">/ <span class="hljs-comment"># bash -x /entry-point.sh</span>
<span class="hljs-string">' echo '</span>Mount //&lt;private_ip&gt;/Exchange/Pipeline to /pipeline<font></font>
Mount //&lt;private_ip&gt;/Exchange/Pipeline to /pipeline<font></font>
+ mkdir -p $<span class="hljs-string">'/pipeline\r'</span>
+ mount -t cifs //&lt;private_ip&gt;/Exchange/Pipeline /pipeline -o $<span class="hljs-string">'user=&lt;private_user&gt;,password=&lt;private_password&gt;,vers=2.0\r'</span><font></font>
mount error(22): Invalid argument<font></font>
Refer to the mount.cifs(8) manual page (e.g. man mount.cifs)<font></font>
mount: mounting //&lt;private_ip&gt;/Exchange/Pipeline on /pipeline failed: Invalid argument<font></font>
+ ls $<span class="hljs-string">'/pipeline\r'</span>
+ <span class="hljs-built_in">exec</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damn, it seems like when the line starts with a plus - it's good, but some kind of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ '...'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> options appeared </font><b><font style="vertical-align: inherit;">.</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We set Midnight Commander to experiment with amenities </font></font><code>apk add mc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and open the script for editing, and there: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/y4/ey/m2y4eytxufjj-crsnwrijqsgiw0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oppa! </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">^ M</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the end of each line. Well, well, look at the local project - what about the line endings ???? CRLF. We work under Windows, however. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Change in this specific CRLF file to LF (long live Notepad ++!), Collect the project - bingo! It works as it should. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why was it ok before, but now everything has flown? I look at the commits - there were no changes. And then I remember that </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GIT can edit linefeeds on the fly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text files. </font><font style="vertical-align: inherit;">And the other day I connected a new repository, and possibly uploaded all the files from there with conversion to CRLF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we add the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.gitattributes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file to the project </font><font style="vertical-align: inherit;">, indicating that in separate files it is necessary to save the end of line characters as in UNIX:</font></font><br>
<br>
<pre><code class="plaintext hljs"># Set the default behavior, in case people don't have core.autocrlf set.<font></font>
* text=auto<font></font>
<font></font>
# Declare files that will always have LF line endings on checkout.<font></font>
*.sh text eol=lf<font></font>
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Morality - sometimes the culprit does not even fall into the circle of initial suspects.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P.S</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After updating to the latest version of Docker Desktop for Windows 2.2.0.3, everything stopped working back. </font><font style="vertical-align: inherit;">This time, I immediately went inside the containers, and started debugging. </font><font style="vertical-align: inherit;">It turned out that the 10.0.75.1 IP address for accessing the host machine stopped working, DockerNat is now removed from the system, and the DockerDesktopVM virtual machine does not even have an external network adapter, i.e. </font><font style="vertical-align: inherit;">communication with it does not go through a standard network, but somehow differently. </font><font style="vertical-align: inherit;">And to access the host, you must use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">host.docker.internal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Fellow developers and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DockerNAT has been removed from Docker Desktop 2.2.0.0 as using an IP address to communicate from the host to a container is not a supported feature. </font><font style="vertical-align: inherit;">To communicate from a container to the host, you must use the special DNS name host.docker.internal.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, I fixed the configs for the test environment, the database picked up, ping from the container to host.docker.internal passes, but the network drives are not connected. I try to run mount manually from the shell, and I get the familiar error ‚Äúmount error (22): Invalid argument‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I remove the arguments in turn - I just run </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúmount -t cifs //host.docker.internal/playground / pipeline‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it seems to work, but it‚Äôs knocking from the root user. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add user: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mount -t cifs //host.docker.internal/playground / pipeline -o user = smbuser</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - asks for a password and connects! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full version also works:</font></font><br>
<br>
<pre><code class="bash hljs">mount -t cifs //host.docker.internal/playground /pipeline -o user=smbuser,password=smbpassword</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
but " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mount -t cifs //host.docker.internal/playground / pipeline -o user = smbuser, password = smbpassword, vers = 2.0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " does not plow. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I change the last parameter to vers = 2.1 - cheers, it works! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that Docker in its latest version made its own implementation of the SMB server with blackjack, but without 2.0 support. </font><font style="vertical-align: inherit;">Nonsense, of course, compared to other news. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All goodness, strength and perseverance! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The illustration for the article was taken from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog.eduonix.com/software-development/learn-debug-docker-containers</font></font></a></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490856/index.html">Auto Dungeon Master</a></li>
<li><a href="../en490862/index.html">LetsEncrypt plans to revoke its certificates due to software bug</a></li>
<li><a href="../en490872/index.html">Trio - Asynchronous Programming for People</a></li>
<li><a href="../en490874/index.html">Deliberate implementation of remote work: how to double your results without hiring anyone</a></li>
<li><a href="../en490876/index.html">Why do we burn out?</a></li>
<li><a href="../en490884/index.html">DEFCON Conference 27. Your car is my car. Part 1</a></li>
<li><a href="../en490888/index.html">Choosing gifts for fantastic women</a></li>
<li><a href="../en490890/index.html">Heroku and React: Deploy Your First App</a></li>
<li><a href="../en490892/index.html">How to generate keys and ads for Yandex and Google from a YML file for free</a></li>
<li><a href="../en490894/index.html">Subtle thoughts on website architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>