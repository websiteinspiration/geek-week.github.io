<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∂ üï¥üèº üñ§ Houston, n√≥s temos um problema. Falha no projeto do sistema üöî üëêüèª ü§µüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 1970, os engenheiros americanos lan√ßaram a espa√ßonave Apollo 13 na Lua. A bordo est√£o tr√™s baterias de c√©lulas a combust√≠vel, n√£o h√° com o que se p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Houston, n√≥s temos um problema. Falha no projeto do sistema</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497332/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em 1970, os engenheiros americanos lan√ßaram a espa√ßonave Apollo 13 na Lua. A bordo est√£o tr√™s baterias de c√©lulas a combust√≠vel, n√£o h√° com o que se preocupar, tudo √© duplicado de forma confi√°vel e repetida. Mas ningu√©m poderia imaginar que a explos√£o de um cilindro de oxig√™nio desativaria duas das tr√™s baterias. Trag√©dia! Os astronautas voltaram para casa, um longa-metragem foi feito sobre o evento com Tom Hanks e a frase do astronauta Jack Swigert: "Houston, temos um problema!", Entrou na hist√≥ria. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/oj/oi/iuojoilj6ikne43fxjqm5q6bjm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A hist√≥ria da Apollo 13 √© outra prova do fato bem conhecido de que voc√™ n√£o pode se preparar para todos os problemas poss√≠veis. Essa √© uma propriedade natural do mundo: o ferro quebra periodicamente, o c√≥digo falha e as pessoas cometem erros. √â imposs√≠vel eliminar completamente isso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para grandes sistemas distribu√≠dos, esse comportamento √© normal, √© uma consequ√™ncia de economias de escala e estat√≠sticas. </font><font style="vertical-align: inherit;">√â por isso que o Design for Failure (AWS) √© o princ√≠pio b√°sico de design dos servi√ßos em nuvem da AWS. </font><font style="vertical-align: inherit;">Os sistemas s√£o inicialmente constru√≠dos de maneira a restaurar a opera√ß√£o em tempo integral o mais r√°pido poss√≠vel e minimizar os danos causados ‚Äã‚Äãpor falhas conhecidas e ainda desconhecidas. </font><font style="vertical-align: inherit;">No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vasily Pantyukhin, usando problemas da vida real com servi√ßos de combate como exemplo, mostrou padr√µes de design para sistemas distribu√≠dos que os desenvolvedores da AWS usam.</font></font><br>
<a name="habracut"></a><br>
 <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vasily Pantyukhin</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Galinha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √â o arquiteto do Amazon Web Services na Europa, Oriente M√©dio e √Åfrica. Ele come√ßou como administrador do Unix, trabalhou na Sun Microsystem por 6 anos, ministrou cursos t√©cnicos e, por 11 anos, ensinou a centraliza√ß√£o de dados do mundo na EMC. Em uma equipe internacional, ele projetou e implementou projetos da Cidade do Cabo a Oslo. Agora, ajuda grandes e pequenas empresas a trabalhar em nuvens p√∫blicas.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RxWVxr4uUpI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 1949, um acidente de avi√£o foi investigado em uma base da for√ßa a√©rea da Calif√≥rnia. </font><font style="vertical-align: inherit;">Um dos engenheiros que fez isso foi Edward Murphy. </font><font style="vertical-align: inherit;">Ele descreveu o trabalho dos t√©cnicos locais da seguinte forma: "Se houver duas maneiras de fazer algo e uma delas levar ao desastre, algu√©m escolher√° esse m√©todo". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais tarde, gra√ßas a Arthur Bloch, a declara√ß√£o entrou na hist√≥ria como uma das leis de Murphy. </font><font style="vertical-align: inherit;">Em russo - a lei da maldade. </font><font style="vertical-align: inherit;">Sua ess√™ncia √© que n√£o ser√° poss√≠vel evitar falhas e erros humanos e ter√° que conviver com isso de alguma forma. </font><font style="vertical-align: inherit;">√â por isso que, ao projetar, colocamos imediatamente falhas e falhas de componentes individuais em nossos sistemas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design de falha</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No projeto de falha, estamos tentando melhorar tr√™s caracter√≠sticas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acessibilidade (os mesmos "noves");</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confiabilidade - a propriedade do sistema para fornecer o n√≠vel de servi√ßo necess√°rio;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toler√¢ncia a falhas - uma propriedade do sistema para impedir a ocorr√™ncia de problemas e se recuperar rapidamente ap√≥s eles.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A confiabilidade tem a propriedade de " </font><font style="vertical-align: inherit;">inc√≥gnitas </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conhecidas</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font><font style="vertical-align: inherit;">N√≥s nos protegemos de problemas conhecidos, mas n√£o sabemos quando eles ocorrer√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Äú </font></font><em><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desconhecidos conhecidos‚Äù</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">adicionado √† toler√¢ncia a falhas </font><font style="vertical-align: inherit;">- estes s√£o problemas surpresa que n√£o sabem nada sobre. </font><font style="vertical-align: inherit;">Muitos desses problemas na nuvem est√£o relacionados a economias de escala: o sistema cresce de tamanho quando novos efeitos surpreendentes e inesperados aparecem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A falha geralmente n√£o √© um fen√¥meno bin√°rio. </font><font style="vertical-align: inherit;">Sua principal propriedade √© o </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"raio de explos√£o"</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou o n√≠vel de degrada√ß√£o do servi√ßo, raio de destrui√ß√£o. </font><font style="vertical-align: inherit;">Nossa tarefa √© reduzir o "raio de explos√£o" dos sistemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se reconhecermos que os problemas n√£o podem ser evitados, devemos nos preparar proativamente para eles. </font><font style="vertical-align: inherit;">Isso significa que projetamos servi√ßos de tal maneira que, em caso de problemas (certamente ser√£o), controlamos os problemas e n√£o vice-versa.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando respondemos a um problema, ele nos controla.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plano de dados e plano de controle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certamente, voc√™ tem eletr√¥nicos em casa que s√£o controlados por um controle remoto, como uma TV. </font><font style="vertical-align: inherit;">A tela da TV faz parte do plano de dados - que executa diretamente a fun√ß√£o. </font><font style="vertical-align: inherit;">O controle remoto √© a interface do usu√°rio - plano de controle. </font><font style="vertical-align: inherit;">√â usado para gerenciar e configurar o servi√ßo. </font><font style="vertical-align: inherit;">Na nuvem, tentamos separar o plano de dados e o plano de controle para teste e desenvolvimento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os usu√°rios, na maioria das vezes, n√£o veem a complexidade do plano de controle. </font><font style="vertical-align: inherit;">Mas erros em seu design e implementa√ß√£o s√£o as causas mais comuns de falhas em massa. </font><font style="vertical-align: inherit;">√â por isso que meu conselho √© focado no plano de controle - √†s vezes explicitamente, √†s vezes n√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A hist√≥ria de um problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em julho de 2012, uma forte tempestade passou no norte da Virg√≠nia. O data center possui prote√ß√£o, geradores a diesel etc., mas aconteceu que em um dos data centers de uma das zonas de disponibilidade (Zona de Disponibilidade, AZ) da regi√£o da Virg√≠nia do Norte, a energia foi perdida. A eletricidade foi rapidamente restaurada, mas a restaura√ß√£o dos servi√ßos se arrastou por horas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/ev/yd/igevydk5zuise0toukfgy9gdxsw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou falar sobre os motivos do exemplo de um dos servi√ßos b√°sicos - CLB (Classic Load Balancer). Funciona de maneira simples: quando voc√™ inicia um novo balanceador em cada zona de disponibilidade, inst√¢ncias separadas s√£o criadas, cujo IP resolver√° o DNS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/al/l0/gwall0xgawp614yocrkqtoz87dk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando uma das inst√¢ncias falha, uma mensagem sobre isso √© enviada para um banco de dados especial. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/ts/bj/sktsbjffpcebdnovro-u6dyr0pu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resposta, os procedimentos iniciam: excluindo registros do DNS, iniciando uma nova inst√¢ncia e adicionando um novo IP ao DNS.</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: √â assim que o sistema funcionava no passado, agora tudo √© fundamentalmente diferente.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tudo √© simples - n√£o h√° nada para quebrar. Por√©m, durante uma falha em massa, quando milhares de inst√¢ncias entram em colapso ao mesmo tempo, um </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enorme Backlog</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aparece </font><strong><font style="vertical-align: inherit;">no banco</font></strong><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">dados a</font></strong><font style="vertical-align: inherit;"> partir de mensagens para processamento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/--/nw/r2--nw4kqcrocoysqgptvysranu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas ficou pior. O plano de controle √© um sistema distribu√≠do. Devido a um erro, recebemos duplicatas e milhares de registros no banco de dados aumentaram para centenas de milhares. Tornou-se muito dif√≠cil trabalhar com isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando ocorre uma falha em uma das inst√¢ncias, todo o tr√°fego √© quase instantaneamente alternado para as m√°quinas sobreviventes e a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga dobra</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (no exemplo, por simplicidade, existem apenas duas zonas de acesso). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/jl/ox/uzjloxrf6wvv5hrju2-votyb-o4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° recursos suficientes, uma inst√¢ncia ao vivo come√ßa automaticamente a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O processo leva um tempo relativamente longo. Tudo acontece no pico e, ao mesmo tempo, com um grande n√∫mero de inst√¢ncias - os recursos gratuitos da zona de disponibilidade est√£o terminando. A "luta" por recursos come√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No norte da Virg√≠nia, a automa√ß√£o n√£o conseguiu lidar com a falha maci√ßa, e os engenheiros manualmente (usando scripts) restauraram os servi√ßos para funcionar. Tais problemas s√£o raros. Durante o interrogat√≥rio, surgiram perguntas sobre as causas da falha, eles decidiram que a situa√ß√£o n√£o deveria mais ser repetida e que todo o servi√ßo deveria ser alterado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os oito padr√µes que abordarei s√£o respostas a algumas das perguntas. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota. Esta √© a nossa experi√™ncia em design de servi√ßos, e n√£o a sabedoria universal para uso generalizado. Os padr√µes s√£o usados ‚Äã‚Äãem situa√ß√µes espec√≠ficas.</font></font></em><br>
<br>
<em>      ‚Äî  .   AWS           .    ‚Äî ,  .    .     ‚Äî     .     !</em><br>
<br>
<h2>  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para minimizar o impacto de falhas, muitas abordagens. Uma delas √© responder √† pergunta: "Como posso garantir que os usu√°rios que n√£o conhecem um problema n√£o saibam nada sobre ele durante uma falha e durante a recupera√ß√£o?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso enorme Backlog recebe n√£o apenas mensagens de travamento, mas tamb√©m outras, por exemplo, sobre dimensionamento ou que algu√©m est√° iniciando um novo balanceador. Essas mensagens precisam ser isoladas umas das outras, agrupando funcionalmente: um grupo separado de mensagens de recupera√ß√£o ap√≥s uma falha, iniciando separadamente um novo balanceador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que dez usu√°rios tenham notado um problema - um dos n√≥s de seus balanceadores caiu. Os servi√ßos de alguma forma funcionam com os recursos restantes, mas o problema √© sentido.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/wu/3a/3cwu3agcfwjtemyacuneqwtmrfm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos dez usu√°rios frustrados. </font><font style="vertical-align: inherit;">O d√©cimo primeiro aparece - ele n√£o sabe nada sobre o problema, mas simplesmente quer um novo balanceador. </font><font style="vertical-align: inherit;">Se o seu pedido para colocar a fila para processamento, provavelmente ele n√£o esperar√°. </font><font style="vertical-align: inherit;">Enquanto outros procedimentos de processamento estiverem conclu√≠dos, o tempo de solicita√ß√£o ser√° encerrado. </font><font style="vertical-align: inherit;">Em vez de dez usu√°rios frustrados, teremos onze. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para impedir que isso aconte√ßa, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priorizamos algumas solicita√ß√µes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - colocamos as filas no topo, por exemplo, solicita√ß√µes de novos recursos. </font><font style="vertical-align: inherit;">Com uma falha em massa, um n√∫mero relativamente pequeno dessas solicita√ß√µes n√£o afetar√° o tempo de recupera√ß√£o dos recursos de outros clientes. </font><font style="vertical-align: inherit;">Mas no processo de recupera√ß√£o, restringiremos o n√∫mero de usu√°rios envolvidos no problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho em tempo integral</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta aos relat√≥rios de problemas √© o lan√ßamento de procedimentos de recupera√ß√£o, em particular, o trabalho com o DNS. Falhas em massa s√£o enormes cargas de pico no plano de controle. O segundo padr√£o ajuda o plano de Controle a ser mais </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√°vel e previs√≠vel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em tal situa√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fg/dv/zm/fgdvzmrez2rrlgfsc4ztmxmkaxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizamos uma abordagem chamada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho constante - trabalho permanente</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/pa/ee/ripaeenvgoadihywoj90c7vvopa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, o DNS pode ser um pouco mais inteligente: ele verifica constantemente as inst√¢ncias do balanceador, estejam elas ativas ou n√£o. O resultado ser√° um bitmap de cada vez: a inst√¢ncia responde - 1, morta - 0. O </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS verifica as inst√¢ncias a cada poucos segundos, independentemente de o sistema ser restaurado ap√≥s uma falha em massa ou estar operando normalmente. Ele faz o mesmo trabalho - sem picos, tudo √© previs√≠vel e est√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro exemplo simplificado: queremos alterar a configura√ß√£o em uma grande frota. </font><font style="vertical-align: inherit;">Em nossa terminologia, uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frota √© um grupo de m√°quinas virtuais</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que, juntas, fazem algum trabalho. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nb/wq/go/nbwqgolicpqizt1bkehgk4ney9c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colocamos as altera√ß√µes de configura√ß√£o no bucket S3 e, a cada 10 segundos (por exemplo), enviamos toda essa configura√ß√£o para nossa frota de m√°quinas virtuais. </font><font style="vertical-align: inherit;">Dois pontos importantes</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazemos isso regularmente</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e nunca infringimos a regra. </font><font style="vertical-align: inherit;">Se voc√™ escolher um segmento de 10 segundos, pressione apenas dessa maneira, independentemente da situa√ß√£o.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sempre fornecemos toda a configura√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , independentemente de ela ter sido alterada ou n√£o. </font><font style="vertical-align: inherit;">O pr√≥prio plano de dados (m√°quinas virtuais) decide o que fazer com ele. </font><font style="vertical-align: inherit;">N√≥s n√£o pressionamos o delta. </font><font style="vertical-align: inherit;">Pode tornar-se muito grande com grandes interrup√ß√µes ou altera√ß√µes. </font><font style="vertical-align: inherit;">Potencialmente, isso pode contribuir para instabilidade e imprevisibilidade.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando realizamos algum tipo de trabalho permanente, pagamos mais por isso. Por exemplo, 100 m√°quinas virtuais solicitam uma configura√ß√£o a cada segundo. Custa cerca de US $ 1200 por ano. Esse valor √© essencialmente menor que o sal√°rio de um programador, a quem podemos confiar ao desenvolvimento de um plano de controle uma abordagem cl√°ssica - uma rea√ß√£o a uma falha e a distribui√ß√£o de apenas altera√ß√µes de configura√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ alterar a configura√ß√£o a cada poucos segundos, como no exemplo, isso ser√° lento. Mas, em muitos casos, uma altera√ß√£o na configura√ß√£o ou o lan√ßamento de servi√ßos leva minutos - alguns segundos n√£o resolvem nada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segundos s√£o importantes para servi√ßos nos quais a configura√ß√£o deve mudar instantaneamente, por exemplo, ao alterar as configura√ß√µes de VPC. Aqui "trabalho permanente" n√£o √© aplic√°vel. Este √© apenas um padr√£o, n√£o uma regra. Se isso n√£o funcionar no seu caso, n√£o use.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escalonamento preliminar</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nosso exemplo, quando a inst√¢ncia do balanceador falha, a segunda inst√¢ncia sobrevivente recebe a carga dobrando quase imediatamente e come√ßa a escalar. </font><font style="vertical-align: inherit;">Em uma falha maci√ßa, consome uma enorme quantidade de recursos. </font><font style="vertical-align: inherit;">O terceiro padr√£o ajuda a controlar esse processo - para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escalar antecipadamente</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso de duas zonas de disponibilidade, escalamos ao descartar menos de 50%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/wy/n4/chwyn4ffipap4mcwshur7bikoj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tudo for feito com anteced√™ncia, em caso de falha, as inst√¢ncias sobreviventes do balanceador estar√£o prontas para aceitar o tr√°fego duplicado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, escal√°vamos apenas com alta utiliza√ß√£o, por exemplo, 80% e agora em 45%. </font><font style="vertical-align: inherit;">O sistema fica ocioso na maioria das vezes e fica mais caro. </font><font style="vertical-align: inherit;">Mas estamos prontos para aturar isso e usar ativamente o padr√£o, porque isso </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© seguro</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Voc√™ tem que pagar pelo seguro, mas em caso de s√©rios problemas, a vit√≥ria cobre todas as despesas. </font><font style="vertical-align: inherit;">Se voc√™ decidir usar o padr√£o, calcule todos os riscos e o pre√ßo com anteced√™ncia.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura celular</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° duas maneiras de construir e dimensionar servi√ßos: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o mon√≥lito</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estrutura</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><strong><font style="vertical-align: inherit;">favo de mel</font></strong><font style="vertical-align: inherit;"> (com base em c√©lula). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nc/y7/ab/ncy7abk8fzjvr8lsez7wwcjuc70.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mon√≥lito se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desenvolve e cresce como um √∫nico recipiente grande. </font><font style="vertical-align: inherit;">Adicionamos recursos, o sistema aumenta, corremos para limites diferentes, as caracter√≠sticas lineares tornam-se n√£o lineares e entram em satura√ß√£o, e o "raio de explos√£o" do sistema - todo o sistema.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o mon√≥lito for mal testado, aumenta a probabilidade de surpresas - "inc√≥gnitas desconhecidas". Mas um grande mon√≥lito n√£o pode ser totalmente testado. √Äs vezes, para isso, voc√™ precisar√° criar uma zona de acesso separada, por exemplo, para um servi√ßo popular que √© criado como um mon√≥lito dentro da zona de acesso (s√£o muitos data centers). Al√©m de, de alguma forma, criar uma enorme carga de teste semelhante √† atual, isso √© imposs√≠vel do ponto de vista financeiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, na maioria dos casos, usamos uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquitetura celular</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - uma configura√ß√£o na qual um sistema √© constru√≠do a partir de c√©lulas de tamanho fixo. Ao adicionar c√©lulas, n√≥s a escalamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A arquitetura celular √© popular na nuvem da AWS. Ajuda a isolar falhas e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduzir o raio da explos√£o.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para uma ou mais c√©lulas. Podemos testar completamente c√©lulas de tamanho m√©dio, isso reduz seriamente os riscos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma abordagem semelhante √© usada na constru√ß√£o naval: o casco de um navio ou embarca√ß√£o √© dividido por parti√ß√µes em compartimentos. No caso de um buraco, um ou mais compartimentos s√£o inundados, mas o navio n√£o afunda. Sim, n√£o ajudou o Titanic, mas raramente encontramos problemas de iceberg. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ilustrarei a aplica√ß√£o da abordagem de malha usando o Simple Shapes Service como exemplo. Este n√£o √© um servi√ßo da AWS, eu mesmo o criei. Este √© um conjunto de APIs simples para trabalhar com formas geom√©tricas simples. Voc√™ pode criar uma inst√¢ncia de uma forma geom√©trica, solicitar o tipo de uma forma pelo seu ID ou contar todas as inst√¢ncias de um determinado tipo. Por exemplo, </font></font><code>put(triangle)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um objeto "tri√¢ngulo" com algum ID √© criado </font><font style="vertical-align: inherit;">em uma solicita√ß√£o </font><font style="vertical-align: inherit;">.</font></font><code>getShape(id)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorna o tipo "tri√¢ngulo", "c√≠rculo" ou "losango". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/z6/dv/7tz6dv0w3f9laswjhuwtbpedggs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para tornar um servi√ßo nublado, ele deve ser usado por usu√°rios diferentes ao mesmo tempo. </font><font style="vertical-align: inherit;">Vamos torn√°-lo multi-inquilino. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/64/hk/pq/64hkpq9niokkw8w-w9rsu7m-w04.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, voc√™ precisa criar uma maneira de particionar - para separar as figuras em c√©lulas. </font><font style="vertical-align: inherit;">Existem v√°rias op√ß√µes para escolher a chave da parti√ß√£o. </font><font style="vertical-align: inherit;">O mais simples tem </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a forma geom√©trica</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : todos os losangos na primeira c√©lula, c√≠rculos na segunda, tri√¢ngulos na terceira. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este m√©todo tem pr√≥s e contras.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se houver visivelmente menos c√≠rculos que outras figuras, a c√©lula correspondente permanecer√° subutilizada (distribui√ß√£o desigual).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas solicita√ß√µes de API s√£o f√°ceis de implementar. </font><font style="vertical-align: inherit;">Por exemplo, contando todos os objetos na segunda c√©lula, encontramos o n√∫mero de c√≠rculos no sistema.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outras consultas s√£o mais complicadas. </font><font style="vertical-align: inherit;">Por exemplo, para encontrar uma forma geom√©trica por ID, voc√™ deve passar por todas as c√©lulas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda maneira √© usar a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identifica√ß√£o dos objetos por intervalos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : os primeiros mil objetos na primeira c√©lula, o segundo na segunda. </font><font style="vertical-align: inherit;">Portanto, a distribui√ß√£o √© mais uniforme, mas h√° outras dificuldades. </font><font style="vertical-align: inherit;">Por exemplo, para contar todos os tri√¢ngulos, voc√™ precisa usar o m√©todo </font></font><code>scatter/gather</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: distribu√≠mos as solicita√ß√µes em cada c√©lula, conta os tri√¢ngulos dentro de si, depois coleta as respostas, resume e produz o resultado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A terceira via - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">divis√£o de inquilinos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(para usu√°rios). Aqui nos deparamos com um problema cl√°ssico. Geralmente, existem muitos usu√°rios "pequenos" na nuvem que tentam algo e praticamente n√£o carregam o servi√ßo. Existem usu√°rios de mastodonte. S√£o poucos, mas consomem uma enorme quantidade de recursos. Esses usu√°rios nunca se encaixam em nenhuma c√©lula. Voc√™ precisa criar maneiras complicadas de distribu√≠-las entre muitas c√©lulas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/1i/3c/wp1i3c0ac5bjnvnxividrzrq6fk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o existe uma maneira ideal, cada servi√ßo √© individual. A boa not√≠cia √© que a sabedoria mundana trabalha aqui - cortar lenha √© mais conveniente ao longo das fibras do que cort√°-las. Em muitos servi√ßos, essas "fibras" s√£o mais ou menos √≥bvias. Ent√£o voc√™ pode experimentar e encontrar a chave de parti√ß√£o ideal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As c√©lulas est√£o interconectadas (embora fracamente). Portanto, deve haver um n√≠vel de conex√£o. Muitas vezes, √© chamada de camada de roteamento ou mapeamento. √â necess√°rio entender para quais c√©lulas enviar solicita√ß√µes espec√≠ficas. Este n√≠vel deve ser o mais simples poss√≠vel. Tente n√£o colocar a l√≥gica de neg√≥cios nela. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mg/os/ox/mgosox1qloxyngz5k1fd4wwy_ws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Surge a quest√£o do tamanho das c√©lulas: pequena - ruim, grande - tamb√©m ruim. N√£o h√° conselho universal - decida de acordo com a situa√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na nuvem da AWS, usamos c√©lulas l√≥gicas e f√≠sicas de tamanhos diferentes. Existem servi√ßos regionais com um tamanho de c√©lula grande, h√° servi√ßos de zona, onde as c√©lulas s√£o menores. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z9/s8/k-/z9s8k-8v60dwwojzqv86ozp7s7k.png"><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota. Falei sobre microc√©lulas no Saint Highload ++ Online no in√≠cio de abril deste ano. L√°, discuti em detalhes um exemplo do uso espec√≠fico desse padr√£o em nosso servi√ßo principal do Amazon EBS.</font></font></em><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi inquilino</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um usu√°rio inicia um novo balanceador, ele recebe inst√¢ncias em cada zona de disponibilidade. </font><font style="vertical-align: inherit;">Independentemente de os recursos serem usados ‚Äã‚Äãou n√£o, eles s√£o alocados e pertencem exclusivamente a esse inquilino da nuvem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a AWS, essa abordagem √© ineficiente, porque a utiliza√ß√£o dos recursos do servi√ßo √©, em m√©dia, muito baixa. </font><font style="vertical-align: inherit;">Isso afeta o custo. </font><font style="vertical-align: inherit;">Para usu√°rios da nuvem, essa n√£o √© uma solu√ß√£o flex√≠vel. </font><font style="vertical-align: inherit;">Ele n√£o pode se adaptar √†s condi√ß√µes de mudan√ßa r√°pida, por exemplo, para fornecer recursos com uma carga inesperadamente aumentada no menor tempo poss√≠vel. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/52/xg/fk52xgzaaqhgq09uw_zlhbhxpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O CLB foi o primeiro balanceador na nuvem da Amazon. </font><font style="vertical-align: inherit;">Hoje, os servi√ßos usam uma abordagem de v√°rios locat√°rios, como o NLB (Network Load Balancer). </font><font style="vertical-align: inherit;">A base, o "mecanismo" desses servi√ßos de rede √© o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperPlane</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Trata-se de uma frota enorme de m√°quinas virtuais (n√≥s) internas, invis√≠veis para os usu√°rios finais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-b/65/3a/-b653as3g91ombi9itfq5wwqjxg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vantagens da </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abordagem multilocat√°rio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou do quinto padr√£o.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A toler√¢ncia a falhas √© fundamentalmente mais alta</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No HyperPlane, um grande n√∫mero de n√≥s j√° est√° em execu√ß√£o e aguarda o carregamento. </font><font style="vertical-align: inherit;">Os n√≥s conhecem o estado um do outro - quando alguns recursos falham, a carga √© instantaneamente distribu√≠da entre os demais. </font><font style="vertical-align: inherit;">Os usu√°rios nem percebem falhas em massa.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prote√ß√£o de carga de pico</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Os inquilinos vivem suas pr√≥prias vidas e suas cargas geralmente n√£o se correlacionam. </font><font style="vertical-align: inherit;">A carga m√©dia total no HyperPlane √© bastante suave.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A utiliza√ß√£o de tais servi√ßos √© fundamentalmente melhor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, proporcionando melhor desempenho, eles s√£o mais baratos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso parece legal! Mas a abordagem multitenant tem desvantagens. Na figura, a frota HyperPlane com tr√™s inquilinos (losangos, c√≠rculos e tri√¢ngulos), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">distribu√≠dos por todos os n√≥s</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kv/by/dg/kvbydgnlm6a8plns-cewltag1e8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso levanta o problema cl√°ssico dos vizinhos ruidosos: a a√ß√£o destrutiva do inquilino, que gera tr√°fego muito alto ou ruim, afetar√° potencialmente todos os usu√°rios. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3f/b9/v4/3fb9v4-hnl27k0sgihgjybo_x70.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O "raio de explos√£o" nesse sistema √© composto por todos os inquilinos. A probabilidade de um "vizinho barulhento" destrutivo na zona de disponibilidade real da AWS n√£o √© alta. Mas devemos estar sempre preparados para o pior. N√≥s nos defendemos usando uma abordagem de malha - selecionamos grupos de n√≥s como c√©lulas. Nesse contexto, chamamos de shards. C√©lulas, fragmentos, parti√ß√µes - aqui est√° a mesma coisa.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d1/7z/yy/d17zyyesjijnpsqpllrwhlthqn4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste exemplo, um losango, como um "vizinho barulhento", afetar√° apenas um inquilino - um tri√¢ngulo. </font><font style="vertical-align: inherit;">Mas o tri√¢ngulo ser√° muito doloroso. </font><font style="vertical-align: inherit;">Para suavizar o efeito, aplique o sexto padr√£o - sharding de mistura.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragmento aleat√≥rio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Distribu√≠mos aleatoriamente inquilinos para n√≥s. </font><font style="vertical-align: inherit;">Por exemplo, um losango pousa em 1, 3 e 6 n√≥s e um tri√¢ngulo em 2, 6 e 8. Temos 8 n√≥s e um fragmento de tamanho 3. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/6n/-w/ft6n-wgdpnlw1g5_t6thpanrtdm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, a combinat√≥ria simples funciona. </font><font style="vertical-align: inherit;">Com uma probabilidade de 54%, haver√° apenas uma interse√ß√£o entre os inquilinos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/uu/jq/cguujqg-8xjmp-cktarugsfdd6c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O "vizinho barulhento" afetar√° apenas um inquilino, e n√£o toda a carga, mas apenas 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere uma configura√ß√£o pr√≥xima ao real - 100 n√≥s, tamanho de fragmento 5. Com uma probabilidade de 77%, n√£o haver√° interse√ß√µes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/14/tj/dr/14tjdrziuvtturqjld0comvzycy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fragmenta√ß√£o aleat√≥ria pode reduzir significativamente o "raio de explos√£o". </font><font style="vertical-align: inherit;">Essa abordagem √© usada em muitos servi√ßos da AWS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúUma pequena frota causa uma grande frota, e n√£o vice-versa‚Äù</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao se recuperar de uma falha em massa, atualizamos a configura√ß√£o de muitos componentes. Uma pergunta t√≠pica nesse caso √© enviar ou alterar uma configura√ß√£o alterada? Quem √© o iniciador das altera√ß√µes: a fonte que cont√©m as altera√ß√µes na configura√ß√£o ou seus consumidores? Mas essas perguntas est√£o erradas. A pergunta certa √© qual frota √© maior? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere uma situa√ß√£o simples: uma grande frota de m√°quinas virtuais de front-end e um certo n√∫mero de back-end. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vg/av/er/vgaverdwdhgvag5w_pbichyvro0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizamos uma abordagem de malha - grupos de inst√¢ncias de front-end funcionar√£o com determinados back-end. Para fazer isso, determine o mapeamento de roteamento de back-end e front-end trabalhando com eles. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/_a/_a/bx_a_ayxwrvjrvh9uwmaj5ifsru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O roteamento est√°tico n√£o √© adequado. Os algoritmos de hash n√£o funcionam bem em falhas de massa, quando voc√™ precisa alterar rapidamente a maioria das rotas. Portanto, √© melhor usar</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roteamento din√¢mico</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Junto √†s grandes frotas de inst√¢ncias de front-end e back-end, colocamos um pequeno servi√ßo que lidar√° apenas com roteamento. Ele conhecer√° e atribuir√° um mapeamento de back-end e front-end a qualquer momento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/o3/kl/jio3kl9vxu3hx5p9b1uvfgxsih8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que tivemos um grande acidente, muitas inst√¢ncias de front-end ca√≠ram. Eles come√ßam a se recuperar em massa e quase simultaneamente solicitam a configura√ß√£o de mapeamento do servi√ßo de roteamento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nd/qv/fz/ndqvfzx9d_2qn6nfnu8bpmmjrqc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pequeno servi√ßo de roteamento √© bombardeado com um grande n√∫mero de solicita√ß√µes. Ele n√£o vai lidar com a carga, na melhor das hip√≥teses, ela se degradar√° e, na pior das hip√≥teses, ele morrer√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, √© correto n√£o solicitar altera√ß√µes na configura√ß√£o de um servi√ßo pequeno, mas criar seu sistema para que o "beb√™" em si</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mudan√ßas de configura√ß√£o iniciadas em dire√ß√£o a uma grande frota de inst√¢ncias</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/hf/gq/uahfgqlyxt-yn190bzu-q8on_rw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usamos o padr√£o de trabalho constante. </font><font style="vertical-align: inherit;">Um pequeno servi√ßo de roteamento enviar√° a configura√ß√£o para todas as inst√¢ncias da frota de front-end a cada poucos segundos. </font><font style="vertical-align: inherit;">Ele nunca ser√° capaz de sobrecarregar um √≥timo servi√ßo. </font><font style="vertical-align: inherit;">O s√©timo padr√£o ajuda a melhorar a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estabilidade e a resili√™ncia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os sete primeiros padr√µes aprimoram o sistema. </font><font style="vertical-align: inherit;">O √∫ltimo padr√£o funciona de maneira diferente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga caindo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° um gr√°fico cl√°ssico do atraso versus carga. </font><font style="vertical-align: inherit;">No lado direito do gr√°fico est√° o ‚Äújoelho‚Äù, quando em cargas extremamente altas, mesmo um pequeno aumento leva a um aumento significativo na lat√™ncia.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/fw/vq/sbfwvqhbni-3lzbd0gjlnorzzqi.png" width="450"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No modo normal, nunca levamos nossos servi√ßos para o lado direito da programa√ß√£o. Uma maneira f√°cil de controlar isso √© adicionar recursos no prazo. Mas estamos nos preparando para qualquer problema. Por exemplo, podemos ir para o lado direito do gr√°fico se recuperando de uma falha em massa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colocamos o tempo limite do cliente no gr√°fico. Qualquer pessoa pode ser um cliente, por exemplo, outro componente dentro de nosso servi√ßo. Para simplificar, desenhamos um gr√°fico de atraso de 50%. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g5/sj/vw/g5sjvwfpnmekcg2mu-kiynw1p6k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui estamos diante de uma situa√ß√£o chamada de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apag√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voc√™ pode estar familiarizado com o termo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apag√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quando a eletricidade √© cortada na cidade. A interrup√ß√£o ocorre quando algo funciona, mas √© t√£o ruim e lento que, conte, n√£o funciona.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos olhar para o apag√£o da zona marrom. O servi√ßo recebeu uma solicita√ß√£o do cliente, processou e retornou o resultado. No entanto, na metade dos casos, os clientes j√° atingiram o tempo limite e ningu√©m espera o resultado. Na outra metade, o resultado retorna mais r√°pido que o tempo limite, mas em um sistema lento, leva muito tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfrentamos um duplo problema: j√° estamos sobrecarregados e no lado direito do cronograma, mas, ao mesmo tempo, ainda estamos ‚Äúaquecendo o ar‚Äù, realizando muito trabalho in√∫til. Como evitar isso? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encontre o "joelho"</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o ponto de inflex√£o no gr√°fico </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Medimos ou estimamos teoricamente. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solte o tr√°fego</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que nos obriga a ir para a direita do ponto de inflex√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><br>
<br>
<img src="https://habrastorage.org/webt/nz/2e/t7/nz2et7zg-cebdkle6rzusm0f0ts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devemos simplesmente ignorar parte dos pedidos. </font><font style="vertical-align: inherit;">Nem tentamos process√°-los, mas retornamos imediatamente um erro ao cliente. </font><font style="vertical-align: inherit;">Mesmo com sobrecarga, podemos pagar por essa opera√ß√£o - √© "barata". </font><font style="vertical-align: inherit;">As solicita√ß√µes n√£o s√£o atendidas, a disponibilidade geral do servi√ßo √© reduzida. </font><font style="vertical-align: inherit;">Embora as solicita√ß√µes rejeitadas sejam processadas mais cedo ou mais tarde, ap√≥s uma ou v√°rias tentativas dos clientes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/4n/xk/bz4nxkpmofmaqg-deszxrwhra5m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, outra parte das solicita√ß√µes √© processada com uma lat√™ncia baixa garantida. </font><font style="vertical-align: inherit;">Como resultado, n√£o fazemos trabalho in√∫til, e o que fazemos, fazemos bem.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breve aperto de padr√µes de projeto de sistemas para falhas</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isolamento e regula√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √Äs vezes, faz sentido priorizar certos tipos de consultas. Por exemplo, com um volume relativamente pequeno de solicita√ß√µes para criar novos recursos, eles podem ser colocados na parte superior da fila. √â importante que isso n√£o infrinja outros usu√°rios. Em uma interrup√ß√£o maci√ßa, os usu√°rios que aguardam a recupera√ß√£o de seus recursos n√£o sentir√£o uma diferen√ßa significativa. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho em tempo integral</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Reduza ou elimine completamente a altern√¢ncia dos modos de servi√ßo. Um modo, que funciona de forma est√°vel e constante, independentemente de situa√ß√µes de emerg√™ncia ou de trabalho, melhora fundamentalmente a estabilidade e a previsibilidade do plano de Controle. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escalonamento preliminar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Escale com anteced√™ncia com valores mais baixos de descarte. Voc√™ ter√° que pagar um pouco mais por isso, mas este √© um seguro que compensa durante falhas graves do sistema. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura celular</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Muitas c√©lulas fracamente acopladas s√£o preferidas a um mon√≥lito. A abordagem de malha reduz o "raio de explos√£o" e a probabilidade de erros de surpresa. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A abordagem multitenant</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melhora significativamente a utiliza√ß√£o do servi√ßo, reduz seu custo e reduz o "raio de explos√£o". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragmento aleat√≥rio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Essa √© uma abordagem que se aplica aos servi√ßos de v√°rios locat√°rios. Al√©m disso, permite controlar o "raio de explos√£o". </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúUma pequena frota causa uma grande frota, e n√£o vice-versa‚Äù</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Tentamos criar servi√ßos para que pequenos servi√ßos iniciem altera√ß√µes em configura√ß√µes grandes. Costumamos us√°-lo em conjunto com um padr√£o de carga constante. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soltando a carga</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em situa√ß√µes de emerg√™ncia, tentamos fazer apenas um trabalho √∫til, e fazemos bem. Para fazer isso, descartamos parte da carga, a qual ainda n√£o conseguimos lidar.</font></font><br>
<br>
<blockquote>  ‚Äî    ,    Saint HighLoad++ Online.  --  , Q&amp;A-,  ,    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> -</a>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>. ,   -   . <br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  telegram- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@HighLoadChannel</a> ‚Äî         ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>.</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt497322/index.html">Teste do √çndice de Qualidade Objetivo com o Mapa da Viagem do Cliente</a></li>
<li><a href="../pt497324/index.html">‚ÄúComo a menina de um olho ...‚Äù ou criamos um sistema de seguran√ßa simples baseado em um microcontrolador (Canny ou Arduino) e Raspberry PI</a></li>
<li><a href="../pt497326/index.html">Conectividade SSH mais segura com DNSSEC</a></li>
<li><a href="../pt497328/index.html">Maneira f√°cil de aprender um idioma (qualquer)</a></li>
<li><a href="../pt497330/index.html">√Årea de trabalho remota do Chrome. Suporte remoto</a></li>
<li><a href="../pt497334/index.html">Os erros not√≥rios e como evit√°-los no exemplo do ClickHouse</a></li>
<li><a href="../pt497336/index.html">Marcas de computadores dos anos 90, parte 3, final</a></li>
<li><a href="../pt497338/index.html">O que aconteceu com o transporte na semana passada - a crise est√° se desenvolvendo</a></li>
<li><a href="../pt497340/index.html">COVID-19: como parar de ler not√≠cias e come√ßar a analisar dados</a></li>
<li><a href="../pt497342/index.html">Navegador atento √†s solicita√ß√µes de API: construindo comunica√ß√£o segura entre o front-end e o back-end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>