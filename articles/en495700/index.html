<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî´ üõ∞Ô∏è üëßüèæ Doom Boy ESP32 üìÖ üë©‚Äç‚öïÔ∏è üîÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doom prefix for ESP32 do-it-yourself on the MCP23017 driver for buttons from UncleRus
 
 
 
 In anticipation of Doom hours , the board of a long-stand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Doom Boy ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495700/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom prefix for ESP32 do-it-yourself on the MCP23017 driver for buttons from UncleRus</font></font><br>
<br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/e_/br/13/e_br13t_nva7dv5lrbr8b9-8rpo.jpeg"></div><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/it/_4/wj/it_4wjuhc9m8api63gzolghcwlq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In anticipation of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom hours</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the board of a long-standing project came. </font><font style="vertical-align: inherit;">The external MCP23017 and CS4344 and a lot of other things are divorced on the board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The buttons use the MCP23017 port expander connected via I2C. </font><font style="vertical-align: inherit;">For him there is a driver that you can get from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An attempt was made to launch an external ADC CS4344.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom by Espressif</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having downloaded the port, Doom had to tinker a bit to collect it. </font><font style="vertical-align: inherit;">In the end, everything got together and flooded into ESP32 but ... I caught a crash at the start. </font><font style="vertical-align: inherit;">On the githab Issue of the project I saw a similar discussion of the problem: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vy/cp/kj/vycpkjmc1qkwolkxdlxsvcutgqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The author of the port suggested making</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You probably need to use the malloc () option as well as reserve some memory for DMA. </font><font style="vertical-align: inherit;">I'll see if I can get this compiling on master and update the sdkconfig when I have time.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, I ‚Äúwithout thinking twice‚Äù replaced all ported memory allocation functions with malloc (). The </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
demo started. </font><font style="vertical-align: inherit;">Ahead of me was connecting buttons</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCP23017 GPIO extender</font></font></h3><br>
<img src="https://habrastorage.org/webt/a8/e0/zx/a8e0zxgbcoljjm4vgecqqft5pxm.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCP23017</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
With big plans for expanding the functionality through the controller ports, I decided to save a little on the input / output ports of the microcontroller itself by installing MCP23017. </font><font style="vertical-align: inherit;">It is a simple expander with access to input / output signals via the I2C interface. </font><font style="vertical-align: inherit;">I did not invent the driver, but simply took it from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Five buttons uses the joystick to navigate. </font><font style="vertical-align: inherit;">A couple of buttons on the shot and menu selection. </font><font style="vertical-align: inherit;">In fact, this is not enough, you still have to open the doors and move left and right without turning, that is, like a crab. </font><font style="vertical-align: inherit;">The findings are pulled inside the MCP23017 to VDD. </font><font style="vertical-align: inherit;">The contact closes to ground. </font><font style="vertical-align: inherit;">It is very cool that there are pull-up resistors inside the microcircuit. </font><font style="vertical-align: inherit;">One could still be confused with interruptions from the MCP23017. </font><font style="vertical-align: inherit;">It has two pins for each port, INTA and INTB, but somehow another time.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full list of teams</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> JsKeyMap keymap[]={<font></font>
	{<span class="hljs-number">0x10</span>, &amp;key_up},<font></font>
	{<span class="hljs-number">0x40</span>, &amp;key_down},<font></font>
	{<span class="hljs-number">0x80</span>, &amp;key_left},<font></font>
	{<span class="hljs-number">0x20</span>, &amp;key_right},<font></font>
	<font></font>
	{<span class="hljs-number">0x4000</span>, &amp;key_use},				<span class="hljs-comment">//cross</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_fire},			<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_menu_enter},		<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x8000</span>, &amp;key_pause},			<span class="hljs-comment">//square</span>
	{<span class="hljs-number">0x1000</span>, &amp;key_weapontoggle},	<span class="hljs-comment">//triangle</span><font></font>
<font></font>
	{<span class="hljs-number">0x8</span>, &amp;key_escape},				<span class="hljs-comment">//start</span>
	{<span class="hljs-number">0x1</span>, &amp;key_map},				<span class="hljs-comment">//select</span><font></font>
	<font></font>
	{<span class="hljs-number">0x400</span>, &amp;key_strafeleft},		<span class="hljs-comment">//L1</span>
	{<span class="hljs-number">0x100</span>, &amp;key_speed},			<span class="hljs-comment">//L2</span>
	{<span class="hljs-number">0x800</span>, &amp;key_straferight},		<span class="hljs-comment">//R1</span>
	{<span class="hljs-number">0x200</span>, &amp;key_strafe},			<span class="hljs-comment">//R2</span><font></font>
<font></font>
	{<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>},<font></font>
};</code></pre><br>
</div>
                    </div><br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was easier to </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">cut through the processing of buttons</font></a><font style="vertical-align: inherit;"> than I thought. </font><font style="vertical-align: inherit;">I lowered the frequency of I2C to improve stability. </font><font style="vertical-align: inherit;">In any case, the declared 1MHz did not go. </font><font style="vertical-align: inherit;">The frequency of 100kHz was quite enough for polling in a cycle with a delay of 20ms.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I killed a lot of time on adding CMakeList.txt for components. </font><font style="vertical-align: inherit;">Something did not work with make. </font><font style="vertical-align: inherit;">And I wanted to take a fresher SDK. </font><font style="vertical-align: inherit;">The original port was not going even to 3.2.x. </font><font style="vertical-align: inherit;">Took esp-idf-v3.3.1 it will probably work on esp-idf-4.0</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sound through the DAC</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually there is another </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fork</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It features a connected SD-CARD and sound through the built-in DAC. The original port from Espressif allows you to load a wad file only into the internal Flash memory of programs, and then you need to use a cut file in which there is no sound! </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The scheme here.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The idea of ‚Äã‚Äãconnecting an external DAC instead of the built-in DAC captured me. At least the penny from Cirrus Logic. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ni/wl/cw/niwlcwgsprqestpufw2qfwjousq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next I set up the DAC on CS4344 and then I was disappointed. The sound worked with interruptions. When I saw the file </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">i_sound.c</font></a><font style="vertical-align: inherit;"> in my project</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I noticed that one dma.h file is not used. As if there is a link to him, and he himself is, but everything is commented on. Maybe I watched inattentively? But I think the author also noticed that something was wrong with the sound and tried to eliminate it. Perhaps eliminated and did not post the last commit. Or maybe everything works as it should on the internal DAC. However, to output sound through the built-in DAC and to a tiny speaker, distortion-interruptions can also be neglected. I played around with bitrate and overall code change. It brought nothing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And yes, regarding the connection of SD-CARD. Initially, I hung it in parallel with the display on the SPI bus, separating separately the CS chip selection signal. The idea failed. By ventilating the question </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support SD-SPI bus sharing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">came to the conclusion that not all SD-CARD are made the same or my hands are not so straight. </font><font style="vertical-align: inherit;">I had to unsolder it through the adapter to the board instead of the microphone. </font><font style="vertical-align: inherit;">It was wound up without pull-ups by external resistors to VDD.</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internal Resistors Handled</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><font></font>
    gpio_set_pull_mode(PIN_NUM_MOSI, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_MISO, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CLK, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CS, GPIO_PULLUP_ONLY);</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On this I quit this lesson and posted the source code on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would be necessary to make another edition of the printed circuit board. </font><font style="vertical-align: inherit;">This one is no good!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/TFE2ri2Zgu4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no sound on the video. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And I also had a joystick contact for turning when I soldered. </font><font style="vertical-align: inherit;">In general, the first pancake is lumpy </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I managed to establish a sound. </font><font style="vertical-align: inherit;">Jerks are present, but not critical. </font><font style="vertical-align: inherit;">Code Changes: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spi_lcd.c </font></font><br>
<code>dmamem[x]=heap_caps_malloc(MEM_PER_TRANS*2, MALLOC_CAP_DMA);</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
i_sound.c</font></font><br>
<code>void IRAM_ATTR updateTask(void *arg)<br>
{<br>
 // size_t bytesWritten;<br>
 while(1)<br>
 {<br>
 I_UpdateSound();<br>
 i2s_write(I2S_NUM_0, mixbuffer, SAMPLECOUNT*SAMPLESIZE, &amp;bytesWritten, portMAX_DELAY);<br>
 }<br>
}</code><br>
<br>
<code>.dma_buf_count = 2,<br>
 .dma_buf_len = 512,</code><br>
<br>
<code>xTaskCreatePinnedToCore(&amp;updateTask, "updateTask", 1000, NULL, 7, NULL, 0);</code></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495690/index.html">Web Audio API Concepts</a></li>
<li><a href="../en495692/index.html">DIY and Open Source to help doctors</a></li>
<li><a href="../en495694/index.html">Mobile application reference service</a></li>
<li><a href="../en495696/index.html">How Prince of Persia Creator Overcomes Apple II's Memory Limits</a></li>
<li><a href="../en495698/index.html">Client-server architecture in pictures</a></li>
<li><a href="../en495702/index.html">We study the Mediastreamer2 VoIP engine. Part 1</a></li>
<li><a href="../en495704/index.html">Monitoring network equipment over SNMPv3 in Zabbix</a></li>
<li><a href="../en495706/index.html">News from the world of OpenStreetMap No. 505 (03.17.2020-23.03.2020)</a></li>
<li><a href="../en495708/index.html">Openconnect emergency VPN server with two-factor authorization on Centos 8</a></li>
<li><a href="../en495712/index.html">We set development goals (in a bloody enterprise and not only)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>