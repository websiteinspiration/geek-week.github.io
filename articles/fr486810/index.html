<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçù üëéüèΩ ‚û∞ Nouvelle interface Odnoklassniki: lancement de React en Java. Partie II ü§üüèæ üå≤ ‚ôçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons l'histoire de la fa√ßon dont, √† l'int√©rieur d'Odnoklassniki, avec l'aide de GraalVM, nous avons r√©ussi √† nous lier d'amiti√© avec Java e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nouvelle interface Odnoklassniki: lancement de React en Java. Partie II</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/486810/"><img src="https://habrastorage.org/webt/sz/_g/7x/sz_g7xhw5t9siczpovdjhzzsgru.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous continuons l'histoire de la fa√ßon dont, √† l'int√©rieur d'Odnoklassniki, avec l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVM,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons r√©ussi √† nous </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">lier</font></a><font style="vertical-align: inherit;"> d'amiti√© avec Java et JavaScript et √† commencer √† migrer vers un √©norme syst√®me avec beaucoup de code h√©rit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la deuxi√®me partie de l'article, nous parlerons en d√©tail du lancement, de l'assemblage et de l'int√©gration des applications sur la nouvelle pile, plongerons dans les sp√©cificit√©s de leur travail √† la fois sur le client et sur le serveur, ainsi que discuter des difficult√©s rencontr√©es sur notre chemin et d√©crire des solutions pour les aider √† surmonter . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous n'avez pas lu la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">premi√®re partie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je recommande fortement de le faire. </font><font style="vertical-align: inherit;">De l√†, vous en apprendrez plus sur l'histoire du frontend √† Odnoklassniki et vous familiariserez avec ses caract√©ristiques historiques, passerez par la voie de la recherche d'une solution aux probl√®mes qui se sont accumul√©s au cours de nos 13 ann√©es de projet, et √† la toute fin vous plongerez dans les caract√©ristiques techniques de la mise en ≈ìuvre du serveur de la d√©cision que nous avons prise.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de l'interface utilisateur</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour √©crire le code de l'interface utilisateur, nous avons choisi les outils les plus avanc√©s: React avec MobX, les modules CSS, ESLint, TypeScript, Lerna. </font><font style="vertical-align: inherit;">Tout cela est collect√© √† l'aide de Webpack.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ed/tp/gx/edtpgxyuy6rxy4nvalwn_dhhkva.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture d'application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme cela a √©t√© √©crit dans la partie pr√©c√©dente de cet article, afin d'impl√©menter une migration progressive, nous allons ins√©rer de nouveaux composants sur le site dans des √©l√©ments DOM avec des noms personnalis√©s qui fonctionneront √† l'int√©rieur de la nouvelle pile d'interface utilisateur, tandis que pour le reste du site, il ressemblera √† un √©l√©ment DOM avec son API. Le contenu de ces √©l√©ments peut √™tre rendu sur le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'Est-ce que c'est? √Ä l'int√©rieur, il y a une application MVC cool, √† la mode et moderne fonctionnant sur React et fournissant l'ext√©rieur de l'API DOM standard: attributs, m√©thodes sur cet √©l√©ment DOM et √©v√©nements.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fg/um/dw/fgumdwotb43klsvwwtlvx4x1bd4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ex√©cuter de tels composants, nous avons d√©velopp√© un m√©canisme sp√©cial. Que fait-il? Tout d'abord, il initialise l'application en fonction de sa description. Deuxi√®mement, il lie le composant au n≈ìud DOM sp√©cifique dans lequel il d√©marre. Il existe √©galement deux moteurs (pour le client et pour le serveur) qui peuvent rechercher et rendre ces composants. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/dg/wz/lndgwzg5ggcfgsnnsfdnrdmue8u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi est-ce n√©cessaire? Le fait est que lorsque l'ensemble du site est cr√©√© sur React, le composant site est g√©n√©ralement rendu dans l'√©l√©ment racine de la page, et ce composant n'a pas d'importance ce qui est √† l'ext√©rieur, mais seul ce qui est √† l'int√©rieur est int√©ressant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, tout est plus compliqu√©: un certain nombre d'applications ont besoin de pouvoir dire √† notre page sur le site "Je suis, et quelque chose change en moi". Par exemple, le calendrier doit lancer un √©v√©nement sur lequel l'utilisateur a cliqu√© sur le bouton, et la date a chang√©, ou √† l'ext√©rieur, vous avez besoin de la possibilit√© pour qu'√† l'int√©rieur du calendrier vous puissiez changer la date. Pour cela, le moteur d'application impl√©mente des fa√ßades dans les fonctionnalit√©s de base de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la livraison d'un composant √† un client, il est n√©cessaire que le moteur de l'ancien site puisse lancer ce composant. Pour ce faire, lors de la construction, les informations n√©cessaires √† son lancement sont collect√©es.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
        <span class="hljs-attr">"bundleName"</span>: <span class="hljs-string">"events-calendar"</span>,
        <span class="hljs-attr">"js"</span>: <span class="hljs-string">"events-calendar-h4h5m.js"</span>,
        <span class="hljs-attr">"css"</span>: <span class="hljs-string">"events-calendar-h4h5m.css"</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des marqueurs sp√©ciaux sont ajout√©s aux attributs de la balise du composant, qui indiquent que cette application est d'un nouveau type, son code peut √™tre extrait d'un fichier JS sp√©cifique. </font><font style="vertical-align: inherit;">En m√™me temps, il a ses propres attributs qui sont n√©cessaires pour initialiser ce composant: ils forment l'√©tat initial du composant dans le magasin.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">events-calendar</span>	<span class="hljs-attr">data-module</span>=<span class="hljs-string">"react-loader"</span>
			<span class="hljs-attr">data-bundle</span>=<span class="hljs-string">"events-calendar.js"</span>
			<span class="hljs-attr">date</span>=<span class="hljs-string">".."</span>
			<span class="hljs-attr">marks</span>=<span class="hljs-string">"[{..}]"</span>
			‚Ä¶
/&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la r√©hydratation, ce n'est pas une conversion de l'√©tat d'application qui est utilis√©e, mais des attributs, qui permet d'√©conomiser sur le trafic. </font><font style="vertical-align: inherit;">Ils se pr√©sentent sous une forme normalis√©e et, en r√®gle g√©n√©rale, sont plus petits que le magasin cr√©√© par l'application. </font><font style="vertical-align: inherit;">Dans le m√™me temps, le temps de recr√©er le magasin √† partir des attributs sur le client est court, donc ils peuvent g√©n√©ralement √™tre n√©glig√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, pour le calendrier, les attributs n'ont qu'une date en surbrillance et le magasin a d√©j√† une matrice avec des informations compl√®tes pour le mois. </font><font style="vertical-align: inherit;">√âvidemment, il est inutile de le transf√©rer depuis le serveur.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment ex√©cuter le code?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le concept a √©t√© test√© sur des fonctions simples qui donnent une ligne pour le serveur ou √©crivent innerHTML pour le client. Mais dans le vrai code, il existe des modules et TypeScript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des solutions standard pour le client, par exemple, la collecte de code √† l'aide de Webpack, qui lui-m√™me broie tout et le donne au client sous la forme d'un ensemble de lots. Et que faire pour le serveur lors de l'utilisation de GraalVM?</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/sr/f7/yn/srf7ynd8airmxgybkgu4wnpe82c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons deux options. La premi√®re consiste √† taper TypeScript en JavaScript, comme ils le font pour Node.js. Cette option, malheureusement, ne fonctionne pas dans notre configuration lorsque JavaScript est le langage invit√© dans GraalVM. Dans ce cas, JavaScript n'a pas de syst√®me modulaire, ni m√™me asynchrone. Parce que la modularit√© et le travail avec asynchronie fournissent un runtime sp√©cifique: NodeJS ou un navigateur. Et dans notre cas, le serveur dispose de JavaScript qui ne peut ex√©cuter le code que de mani√®re synchrone.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me option - vous pouvez simplement ex√©cuter le code du serveur √† partir des m√™mes fichiers qui ont √©t√© collect√©s pour le client. Et cette option fonctionne. Mais il y a un probl√®me que le serveur a besoin d'autres impl√©mentations pour un certain nombre de m√©thodes. Par exemple, la fonction renderToString () sera appel√©e sur le serveur pour rendre le composant et ReactDOM.render () sur le client. Ou un autre exemple de l'article pr√©c√©dent: pour obtenir des textes et des param√®tres sur le serveur, la fonction fournie par Java sera appel√©e, et sur le client ce sera une impl√©mentation en JS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©soudre ce probl√®me, vous pouvez utiliser des alias de Webpack. Ils vous permettent de cr√©er deux impl√©mentations de la classe dont nous avons besoin: pour le client et le serveur. Ensuite, dans les fichiers de configuration pour le client et le serveur, sp√©cifiez l'impl√©mentation appropri√©e.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/rb/0o/carb0o0rvb1q0pw8eerxnsy4ova.jpeg"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais deux fichiers de configuration sont deux assemblys. </font><font style="vertical-align: inherit;">Chaque fois, tout collecter s√©par√©ment pour le serveur et pour le client est long et difficile √† g√©rer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez proposer une telle configuration afin que tout soit collect√© en une seule fois.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de Webpack pour ex√©cuter JS sur le serveur et le client</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour trouver une solution √† ce probl√®me, voyons de quelles parties le projet se compose: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zh/mi/e9/zhmie9o6zghd5vgeyd10pjonffq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premi√®rement, le projet a un runtime tiers (fournisseurs), le m√™me pour le client et pour le serveur. </font><font style="vertical-align: inherit;">Cela ne change presque jamais. </font><font style="vertical-align: inherit;">Rantime peut √™tre donn√© √† l'utilisateur et il sera mis en cache sur le client jusqu'√† ce que nous mettions √† jour la version de la biblioth√®que tierce. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement, il y a notre runtime (core), qui assure le lancement de l'application. </font><font style="vertical-align: inherit;">Il a des m√©thodes avec diff√©rentes impl√©mentations pour le client et le serveur. </font><font style="vertical-align: inherit;">Par exemple, obtenir des textes de localisation, des param√®tres, etc. </font><font style="vertical-align: inherit;">Ce runtime change √©galement rarement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Troisi√®mement, il existe un code de composant. </font><font style="vertical-align: inherit;">C'est la m√™me chose pour le client et pour le serveur, ce qui vous permet de d√©boguer le code d'application dans le navigateur sans d√©marrer le serveur du tout. </font><font style="vertical-align: inherit;">Si quelque chose s'est mal pass√© sur le client, vous pouvez voir les erreurs dans la console du navigateur, tout garder √† l'esprit et √™tre s√ªr qu'il n'y aura pas d'erreurs lors du d√©marrage sur le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au total, trois pi√®ces sont obtenues qui doivent √™tre assembl√©es. </font><font style="vertical-align: inherit;">Nous voulons:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez s√©par√©ment l'assemblage de chaque pi√®ce.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©duisez les d√©pendances entre elles afin que chaque partie ne tombe pas dans ce qui est dans l'autre.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rassemblez tout en un seul passage.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment d√©crire s√©par√©ment les pi√®ces dont l'assemblage sera compos√©? </font><font style="vertical-align: inherit;">Il existe une multiconfiguration dans webpack: vous donnez simplement un tableau d'exportations des modules inclus dans chaque partie.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = [{
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./vendors.js'</span>,<font></font>
}, {<font></font>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./core.js'</span><font></font>
}, {<font></font>
 <span class="hljs-attr">entry</span>: <span class="hljs-string">'./app.js'</span><font></font>
}];<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout irait bien, mais dans chacune de ces parties, le code des modules dont cette partie d√©pend sera dupliqu√©: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/am/ax/utamaxl7z4op6x8iivfcmufn7ec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, dans l'ensemble de base des plugins </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webpack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">il y a </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">DllPlugin</font></a><font style="vertical-align: inherit;"> , qui vous permet d'obtenir une liste des modules inclus dans chaque partie assembl√©e. Par exemple, pour le fournisseur, vous pouvez savoir quels modules sp√©cifiques sont inclus dans cette partie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la construction d'une autre partie, par exemple des biblioth√®ques de base, nous pouvons dire qu'elles d√©pendent de la partie fournisseur. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/nv/lu/el/nvluelzxzvy_5oofujylu4wmufk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, pendant l'assemblage du webpack, DllPlugin verra le noyau en fonction d'une biblioth√®que qui est d√©j√† chez le fournisseur, et ne l'ajoutera pas au noyau, mais y mettra simplement un lien.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, trois pi√®ces sont assembl√©es √† la fois et d√©pendent les unes des autres. </font><font style="vertical-align: inherit;">Lorsque la premi√®re application est t√©l√©charg√©e sur le client, les biblioth√®ques d'ex√©cution et de base seront enregistr√©es dans le cache du navigateur. </font><font style="vertical-align: inherit;">Et comme Odnoklassniki est un site, l'onglet avec lequel l'utilisateur peut ouvrir ¬´pour toujours¬ª, l'√©viction se produira assez rarement. </font><font style="vertical-align: inherit;">Dans la plupart des cas, avec les versions des nouvelles versions du site, seul le code d'application sera mis √† jour.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Livraison des ressources</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez le probl√®me par l'exemple de l'utilisation de textes localis√©s qui sont stock√©s dans une base de donn√©es distincte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si plus t√¥t, quelque part sur le serveur, vous aviez besoin de texte dans le composant, vous pouvez appeler la fonction pour obtenir le texte.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    : { pkg.getText('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtenir du texte sur le serveur n'est pas difficile, car l'application serveur peut faire une demande rapide √† la base de donn√©es ou m√™me mettre en cache tous les textes en m√©moire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment obtenir des textes dans des composants sur une r√©action qui sont rendus sur un serveur dans GraalVM? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme indiqu√© dans la premi√®re partie de l'article, dans le contexte JS, vous pouvez ajouter des m√©thodes √† l'objet global auquel vous souhaitez acc√©der √† partir de JavaScript. </font><font style="vertical-align: inherit;">Il a √©t√© d√©cid√© de cr√©er une classe avec toutes les m√©thodes disponibles pour JavaScript.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerMethods</span> </span>{<font></font>
    ‚Ä¶<font></font>
    <font></font>
    <span class="hljs-comment">/**
     *     
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getText</span><span class="hljs-params">(String pkg, String key)</span> </span>{<font></font>
        ‚Ä¶<font></font>
    }<font></font>
    <font></font>
    ‚Ä¶<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, placez une instance de cette classe dans le contexte JavaScript global:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//     Java   </span>
js.putMember(<span class="hljs-string">"serverMethods"</span>, serverMethods);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, √† partir de JavaScript dans l'impl√©mentation du serveur, nous appelons simplement la fonction:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getText</span>(<span class="hljs-params">pkg: string, key: string</span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> global.serverMethods.getText(pkg, key);<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, ce sera un appel de fonction en Java qui renverra le texte demand√©. Interaction synchrone directe et aucun appel HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le client, malheureusement, il faut tr√®s longtemps pour parcourir HTTP et recevoir des textes pour chaque appel √† la fonction d'insertion de texte dans les composants. Vous pouvez pr√©-t√©l√©charger tous les textes sur le client, mais les textes √† eux seuls p√®sent des dizaines de m√©gaoctets, et il existe d'autres types de ressources. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lg/6e/ij/lg6eijxb_rvzshqiyih2gyuvy5a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisateur sera fatigu√© d'attendre que tout soit t√©l√©charg√© avant de d√©marrer l'application. Par cons√©quent, cette m√©thode ne convient pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je souhaite recevoir uniquement les textes n√©cessaires √† une application particuli√®re. Nos textes sont divis√©s en paquets. Par cons√©quent, vous pouvez collecter les packages n√©cessaires √† l'application et les t√©l√©charger avec l'ensemble. Lorsque l'application d√©marre, tous les textes seront d√©j√† dans le cache client.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment savoir de quels textes une application a besoin? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons conclu un accord selon lequel les packages de textes du code sont obtenus en appelant la fonction l10n (), dans laquelle le nom du package est transmis UNIQUEMENT sous la forme d'une cha√Æne litt√©rale:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    { pkg.getLMsg('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©crit un plugin webpack qui, en analysant l'arborescence AST du code des composants, trouve tous les appels √† la fonction l10n () et collecte les noms des packages √† partir des arguments. </font><font style="vertical-align: inherit;">De m√™me, le plugin collecte des informations sur d'autres types de ressources n√©cessaires √† l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En sortie apr√®s assemblage pour chaque application, nous obtenons une configuration avec ses ressources:</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
       <span class="hljs-attr">"pkg"</span>:  [
           <span class="hljs-string">"calendar"</span>,
           <span class="hljs-string">"dates"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"cfg"</span>:  [
           <span class="hljs-string">"config1"</span>,
           <span class="hljs-string">"config2"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"bundleName"</span>:  <span class="hljs-string">"events-calendar"</span>,
       <span class="hljs-attr">"js"</span>:  <span class="hljs-string">"events-calendar.js"</span>,
       <span class="hljs-attr">"css"</span>:  <span class="hljs-string">"events-calendar.css"</span>,<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien s√ªr, nous ne devons pas oublier de mettre √† jour les textes. </font><font style="vertical-align: inherit;">Parce que sur le serveur, tous les textes sont toujours √† jour et que le client a besoin d'un m√©canisme de mise √† jour du cache distinct, par exemple, watcher ou push.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ancien code dans le nouveau</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec une transition en douceur, le probl√®me se pose de r√©utiliser l'ancien code dans de nouveaux composants, car il existe des composants grands et complexes (par exemple, un lecteur vid√©o), une r√©√©criture qui prendra beaucoup de temps, et vous devez les utiliser dans la nouvelle pile maintenant. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/pg/te/jzpgtesmq75odhrqyvbg2grbw9u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels sont les probl√®mes?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'ancien site et les nouvelles applications React ont des cycles de vie compl√®tement diff√©rents. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous collez le code de l'ancien exemple dans l'application React, ce code ne d√©marrera pas, car React ne sait pas comment l'activer. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En raison de cycles de vie diff√©rents, React et l'ancien moteur peuvent simultan√©ment essayer de modifier le contenu de l'ancien code, ce qui peut provoquer des effets secondaires d√©sagr√©ables. </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©soudre ces probl√®mes, une classe de base commune a √©t√© allou√©e aux composants contenant l'ancien code. </font><font style="vertical-align: inherit;">La classe permet aux h√©ritiers de coordonner les cycles de vie des applications React et √† l'ancienne.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-attr">ref</span>: React.RefObject&lt;HTMLElement&gt; = React.createRef();<font></font>
<font></font>
    componentDidMount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.activate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    componentWillUnmount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.deactivate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    shouldComponentUpdate() {<font></font>
        <span class="hljs-comment">// React     , </span>
        <span class="hljs-comment">//   React-. </span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    render() {<font></font>
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.ref}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
        );<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe vous permet soit de cr√©er des morceaux de code qui fonctionnent √† l'ancienne, soit de les d√©truire, alors qu'il n'y aura pas d'interaction simultan√©e avec eux. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coller l'ancien code sur le serveur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la pratique, il existe un besoin de composants de wrapper (par exemple, des fen√™tres contextuelles), dont le contenu peut √™tre quelconque, y compris ceux cr√©√©s √† l'aide d'anciennes technologies. </font><font style="vertical-align: inherit;">Vous devez comprendre comment incorporer n'importe quel code sur le serveur √† l'int√©rieur de ces composants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un article pr√©c√©dent, nous avons parl√© de l'utilisation d'attributs pour transmettre des param√®tres √† de nouveaux composants sur le client et le serveur.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span> <span class="hljs-attr">users</span>=<span class="hljs-string">"[1,2,3]"</span> /&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous voulons toujours y ins√©rer un √©l√©ment de balisage, qui, dans le sens, n'est pas un attribut. </font><font style="vertical-align: inherit;">Pour cela, il a √©t√© d√©cid√© d'utiliser un syst√®me de slots.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ui:part</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>old component<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ui:part</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir dans l'exemple ci-dessus, √† l'int√©rieur du code du composant cool-app, un emplacement d'ancien code contenant d'anciens composants est d√©crit. </font><font style="vertical-align: inherit;">Ensuite, √† l'int√©rieur du composant react, l'endroit o√π vous souhaitez coller le contenu de cet emplacement est indiqu√©:</font></font><br>
<br>
<pre><code class="javascript hljs">render() {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UiPart</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le moteur de serveur rend ce composant React et encadre le contenu de l'emplacement dans la balise &lt;ui-part&gt;, en lui attribuant l'attribut data-part-id = "old-code". </font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le rendu c√¥t√© serveur de JS dans GraalVM ne rentre pas dans le d√©lai d'expiration, nous utilisons alors le rendu client. </font><font style="vertical-align: inherit;">Pour ce faire, le moteur du serveur ne donne que des emplacements, en les encadrant dans la balise de mod√®le afin que le navigateur n'interagisse pas avec leur code.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que se passe-t-il sur le client? </font><font style="vertical-align: inherit;">Le moteur client analyse simplement le code du composant, collecte les balises &lt;ui-part&gt;, re√ßoit leur contenu sous forme de cha√Ænes et les transmet √† la fonction de rendu avec le reste des param√®tres.</font></font><br>
 <br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> tagName = <span class="hljs-string">'cool-app'</span>;
<span class="hljs-keyword">var</span> reactComponent = components[tagName];<font></font>
reactComponent.render({<font></font>
       <span class="hljs-attr">tagName</span>: tagName,
       <span class="hljs-attr">attrs</span>: attrs,
       <span class="hljs-attr">parts</span>: parts,
       <span class="hljs-attr">node</span>: element<font></font>
});<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code du composant qui ins√®re les emplacements √† l'emplacement souhait√© est le suivant: </font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UiPart</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">IProps</span>&gt; </span>{<font></font>
<font></font>
	render() {<font></font>
		<span class="hljs-keyword">const</span> id = <span class="hljs-keyword">this</span>.props.id;
		<span class="hljs-keyword">const</span> parts = <span class="hljs-keyword">this</span>.props.parts;<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (!parts.hasOwnProperty(id)) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">return</span> React.createElement(<span class="hljs-string">'ui-part'</span>, {
			<span class="hljs-string">'data-part-id'</span>: id,
			<span class="hljs-attr">ref</span>: <span class="hljs-keyword">this</span>.ref,
			<span class="hljs-attr">dangerouslySetInnerHTML</span>: { <span class="hljs-attr">__html</span>: parts[id] }<font></font>
		});<font></font>
	}<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En m√™me temps, il est h√©rit√© de la classe OldCodeBase, qui r√©sout les probl√®mes d'interaction entre l'ancienne et la nouvelle pile. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ge/cc/a3/gecca3dlxac9crp48u9pvoyc4vs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant √©crire une fen√™tre contextuelle et la remplir √† l'aide de la nouvelle pile ou de la demande du serveur en utilisant l'ancienne approche. </font><font style="vertical-align: inherit;">Dans ce cas, les composants fonctionneront correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela vous permet de migrer progressivement les composants du site vers une nouvelle pile. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'√©tait juste l'une des principales exigences du nouveau frontend.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout le monde se demande √† quelle vitesse GraalVM fonctionne. </font><font style="vertical-align: inherit;">Les d√©veloppeurs d'Odnoklassniki ont effectu√© divers tests avec les applications React. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fonction simple qui renvoie une cha√Æne apr√®s l'√©chauffement prend environ 1 microseconde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Composants (√† nouveau apr√®s √©chauffement) - de 0,5 √† 6 millisecondes, selon leur taille. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GraalVM acc√©l√®re plus lentement que V8. </font><font style="vertical-align: inherit;">Mais pour le temps de son √©chauffement, la situation est liss√©e gr√¢ce au repli du rendu client. </font><font style="vertical-align: inherit;">Puisqu'il y a tellement d'utilisateurs, la machine virtuelle chauffe rapidement.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'avez-vous r√©ussi √† faire</font></font></h3><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez JavaScript sur le serveur dans le monde Java de Classmates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un code isomorphe pour l'interface utilisateur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisez une pile moderne que tous les fournisseurs frontaux connaissent.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez une plate-forme commune et une approche unique pour l'√©criture de l'interface utilisateur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencez une transition en douceur sans compliquer l'op√©ration et sans ralentir le rendu du serveur.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous esp√©rons que les exp√©riences d'Odnoklassniki et des exemples vous seront utiles et vous les trouverez √† utiliser dans votre travail.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486798/index.html">Y a-t-il un GameDev √† Sakhaline? Fin</a></li>
<li><a href="../fr486800/index.html">Cassandra. Comment ne pas mourir si vous ne connaissez qu'Oracle</a></li>
<li><a href="../fr486802/index.html">Les gens rencontrent des syst√®mes de recommandation. Factorisation</a></li>
<li><a href="../fr486804/index.html">Informatique de sant√© mondiale: technologies cloud</a></li>
<li><a href="../fr486808/index.html">Test de grossesse √©lectronique en pharmacie: comment √ßa marche</a></li>
<li><a href="../fr486814/index.html">Zabbix: la topologie du r√©seau est claire et automatique</a></li>
<li><a href="../fr486818/index.html">Portage de Quake sur iPod Classic</a></li>
<li><a href="../fr486820/index.html">Questions d'entretiens chez Javascript</a></li>
<li><a href="../fr486822/index.html">[Par les quais] Flutter. Partie 4. Pour les d√©veloppeurs Web</a></li>
<li><a href="../fr486824/index.html">Mauvais conseils lorsque vous travaillez avec ANTLR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>