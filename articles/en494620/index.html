<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèΩ üç∫ ü§© How to replace target-action and delegate with closures üíÜ üí¢ üíáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apple provides various options for processing data and events in iOS applications. UIControl event processing occurs through the target-action pattern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to replace target-action and delegate with closures</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/hh/blog/494620/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple provides various options for processing data and events in iOS applications. </font><font style="vertical-align: inherit;">UIControl event processing occurs through the target-action pattern. </font><font style="vertical-align: inherit;">The documentation for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UIControl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> says the following:</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The target-action mechanism </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simplifies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the code that you write to use controls in your app</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at an example of processing a button click:</font></font><a name="habracut"></a><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupButton</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()<font></font>
    button.addTarget(<span class="hljs-keyword">self</span>, action: #selector(buttonTapped(<span class="hljs-number">_</span>:)), <span class="hljs-keyword">for</span>: .touchUpInside)<font></font>
}<font></font>
<span class="hljs-comment">// -   </span>
<span class="hljs-meta">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buttonTapped</span><span class="hljs-params">(<span class="hljs-number">_</span> sender: UIButton)</span></span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configuration and processing of the button click are located separately from each other in the code. </font><font style="vertical-align: inherit;">Therefore, you have to write more code than you would like. </font><font style="vertical-align: inherit;">Problems arise with an increase in the number of events and controls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UITextField uses the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delegate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern to edit and validate text </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We will not dwell on the pros and cons of this pattern, read more </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Various methods of processing data in one project often lead to the fact that the code becomes more difficult to read and understand. </font><font style="vertical-align: inherit;">This article will figure out how to bring everything to a single style using the convenient closure syntax.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is it necessary</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, we went about ready-made solutions on GitHub and even used </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Closures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for some time </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But over time, we had to abandon the third-party solution, because we discovered memory leaks there. </font><font style="vertical-align: inherit;">And some of its features seemed uncomfortable to us. </font><font style="vertical-align: inherit;">Then it was decided to write your own solution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We would be quite happy with the result when, using closures, we could write this:</font></font><br>
<br>
<pre><code class="swift hljs">textField.shouldChangeCharacters { textField, range, string <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basic goals:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the closure, provide access to textField, while maintaining the original type. </font><font style="vertical-align: inherit;">This is in order to manipulate the source object in closures, for example, by clicking on a button to show an indicator on it without type casting.</font></font></li>
<li> ,  .   ,  <i>.touchUpInside</i>     <i>onTap { }</i>,  <i>shouldChangeCharacters</i>  UITextField  ,       .</li>
</ul><br>
<h3>  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main idea is that we will have an observer object that will intercept all messages and cause closures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we must decide how to keep the observer. </font><font style="vertical-align: inherit;">Swift gives us the power to choose. </font><font style="vertical-align: inherit;">For example, we can create an additional singleton object that will store a dictionary, where the key is the unique id of the observed objects, and the value is the observer himself. </font><font style="vertical-align: inherit;">In this case, we will have to manage the life cycle of objects manually, which can lead to memory leaks or loss of information. </font><font style="vertical-align: inherit;">You can avoid such problems if you store objects as associated objects. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create an ObserverHolder protocol with a default implementation so that each class that conforms to this protocol has access to the observer:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">protocol</span> <span class="hljs-title">ObserverHolder</span>: <span class="hljs-title">AnyObject</span> </span>{
    <span class="hljs-keyword">var</span> observer: <span class="hljs-type">Any?</span> { <span class="hljs-keyword">get</span> <span class="hljs-keyword">set</span> }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> observerAssociatedKey: <span class="hljs-type">UInt8</span> = <span class="hljs-number">0</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">ObserverHolder</span> </span>{
    <span class="hljs-keyword">var</span> observer: <span class="hljs-type">Any?</span> {
        <span class="hljs-keyword">get</span> {<font></font>
            objc_getAssociatedObject(<span class="hljs-keyword">self</span>, &amp;observerAssociatedKey)<font></font>
        }<font></font>
        <span class="hljs-keyword">set</span> {<font></font>
            objc_setAssociatedObject(<font></font>
                <span class="hljs-keyword">self</span>, <font></font>
                &amp;observerAssociatedKey, <font></font>
                newValue, <font></font>
                .<span class="hljs-type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><font></font>
            )<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it‚Äôs enough to declare compliance with the protocol for UIControl:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UIControl</span>: <span class="hljs-title">ObserverHolder</span> </span>{ }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UIControl (and all descendants, including UITextField) has a new property where the observer will be stored.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UITextFieldDelegate example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The observer will be the delegate for UITextField, which means that it must comply with the UITextFieldDelegate protocol. </font><font style="vertical-align: inherit;">We need a generic type T in order to save the original type of UITextField. </font><font style="vertical-align: inherit;">An example of such an object:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextFieldObserver</span>&lt;<span class="hljs-title">T</span>: <span class="hljs-title">UITextField</span>&gt;: <span class="hljs-title">NSObject</span>, <span class="hljs-title">UITextFieldDelegate</span> </span>{
    <span class="hljs-keyword">init</span>(textField: <span class="hljs-type">T</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<font></font>
        textField.delegate = <span class="hljs-keyword">self</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each delegate method will need a separate closure. </font><font style="vertical-align: inherit;">Inside such methods, we will cast the type to T and cause the corresponding closure. </font><font style="vertical-align: inherit;">We will add the TextFieldObserver code, and for the example we will add only one method:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> shouldChangeCharacters: ((<span class="hljs-type">T</span>, <span class="hljs-number">_</span> range: <span class="hljs-type">NSRange</span>, <span class="hljs-number">_</span> replacement: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Bool</span>)?<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">textField</span><span class="hljs-params">(
    <span class="hljs-number">_</span> textField: UITextField,
    shouldChangeCharactersIn range: NSRange,
    replacementString string: String
)</span></span> -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">guard</span> 
        <span class="hljs-keyword">let</span> textField = textField <span class="hljs-keyword">as</span>? <span class="hljs-type">T</span>, 
        <span class="hljs-keyword">let</span> shouldChangeCharacters = shouldChangeCharacters 
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> shouldChangeCharacters(textField, range, string)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are ready to write a new interface with closures:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UITextField</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>, NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>) { }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Something went wrong, the compiler throws an error: </font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'Self' is only available in a protocol or as the result of a method in a class; </font><font style="vertical-align: inherit;">did you mean 'UITextField'</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An empty protocol will help us, in the extension of which we will write a new interface to UITextField, while restricting Self:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">protocol</span> <span class="hljs-title">HandlersKit</span> </span>{ }<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UIControl</span>: <span class="hljs-title">HandlersKit</span> </span>{ }<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">HandlersKit</span> <span class="hljs-title">where</span> <span class="hljs-title">Self</span>: <span class="hljs-title">UITextField</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>, NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>) { }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code compiles, it remains to create a TextFieldObserver and designate it as a delegate. </font><font style="vertical-align: inherit;">Moreover, if the observer already exists, then you need to update it so as not to lose other closures:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>, NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>) {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> textFieldObserver = observer <span class="hljs-keyword">as</span>? <span class="hljs-type">TextFieldObserver</span>&lt;<span class="hljs-type">Self</span>&gt; {<font></font>
        textFieldObserver.shouldChangeCharacters = handler<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">let</span> textFieldObserver = <span class="hljs-type">TextFieldObserver</span>(textField: <span class="hljs-keyword">self</span>)<font></font>
        textFieldObserver.shouldChangeCharacters = handler<font></font>
        observer = textFieldObserver<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, now this code is functioning and ready to use, but it can be improved. </font><font style="vertical-align: inherit;">We will create and update TextFieldObserver in a separate method, only the assignment of the closure will be different, which we will pass in the form of a block. </font><font style="vertical-align: inherit;">Update existing code in extension HandlersKit:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>, NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>) {<font></font>
    updateObserver { $<span class="hljs-number">0</span>.shouldChangeCharacters = handler }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateObserver</span><span class="hljs-params">(<span class="hljs-number">_</span> update: <span class="hljs-params">(TextFieldObserver&lt;<span class="hljs-keyword">Self</span>&gt;)</span></span></span> -&gt; <span class="hljs-type">Void</span>) {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> textFieldObserver = observer <span class="hljs-keyword">as</span>? <span class="hljs-type">TextFieldObserver</span>&lt;<span class="hljs-type">Self</span>&gt; {<font></font>
        update(textFieldObserver)<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">let</span> textFieldObserver = <span class="hljs-type">TextFieldObserver</span>(textField: <span class="hljs-keyword">self</span>)<font></font>
        update(textFieldObserver)<font></font>
        observer = textFieldObserver<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additional improvements</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the ability to chain methods. </font><font style="vertical-align: inherit;">To do this, each method must return Self and have the @discardableResult attribute:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-meta">@discardableResult</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(
    handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>, NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>
) -&gt; <span class="hljs-type">Self</span><font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateObserver</span><span class="hljs-params">(<span class="hljs-number">_</span> update: <span class="hljs-params">(TextFieldObserver&lt;<span class="hljs-keyword">Self</span>&gt;)</span></span></span> -&gt; <span class="hljs-type">Void</span>) -&gt; <span class="hljs-type">Self</span> {<font></font>
    ...<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a closure, access to UITextField is not always necessary, and so that in such places you do not have to write ` </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in` each time </font><font style="vertical-align: inherit;">, we add a method with the same naming, but without the required Self:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-meta">@discardableResult</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeCharacters</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(NSRange, String)</span></span></span> -&gt; <span class="hljs-type">Void</span>) -&gt; <span class="hljs-type">Self</span> {<font></font>
    shouldChangeCharacters { handler($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>) }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to this approach, you can create more convenient methods. </font><font style="vertical-align: inherit;">For example, changing text with UITextField is sometimes more convenient when the final text is known:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-meta">@discardableResult</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">shouldChangeString</span><span class="hljs-params">(
    handler: @escaping <span class="hljs-params">(<span class="hljs-number">_</span> textField: <span class="hljs-keyword">Self</span>, <span class="hljs-number">_</span> from: String, <span class="hljs-number">_</span> to: String)</span></span></span> -&gt; <span class="hljs-type">Bool</span>
) -&gt; <span class="hljs-type">Self</span> {<font></font>
    shouldChangeCharacters { textField, range, string <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">let</span> text = textField.text ?? <span class="hljs-string">""</span>
        <span class="hljs-keyword">let</span> newText = <span class="hljs-type">NSString</span>(string: text)<font></font>
            .replacingCharacters(<span class="hljs-keyword">in</span>: range, with: string)
        <span class="hljs-keyword">return</span> handler(textField, text, newText)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done! </font><font style="vertical-align: inherit;">In the examples shown, we replaced one UITextFieldDelegate method, and to replace the remaining methods, we need to add closures to TextFieldObserver and to the extension of the HandlersKit protocol by the same principle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replacing target-action with closure</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that storing one observer for the target-action and the delegate in this form complicates it, so we recommend adding another associated object to the UIControl for events. </font><font style="vertical-align: inherit;">We will store a separate object for each event, a dictionary is perfect for such a task:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">protocol</span> <span class="hljs-title">EventsObserverHolder</span>: <span class="hljs-title">AnyObject</span> </span>{
    <span class="hljs-keyword">var</span> eventsObserver: [<span class="hljs-type">UInt</span>: <span class="hljs-type">Any</span>] { <span class="hljs-keyword">get</span> <span class="hljs-keyword">set</span> }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to add the default implementation for EventsObserverHolder, create an empty dictionary immediately in the getter:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">get</span> {<font></font>
    objc_getAssociatedObject(<span class="hljs-keyword">self</span>, &amp;observerAssociatedKey) <span class="hljs-keyword">as</span>? [<span class="hljs-type">UInt</span>: <span class="hljs-type">Any</span>] ?? [:]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The observer will be a target for one event:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventObserver</span>&lt;<span class="hljs-title">T</span>: <span class="hljs-title">UIControl</span>&gt;: <span class="hljs-title">NSObject</span> </span>{
    <span class="hljs-keyword">init</span>(control: <span class="hljs-type">T</span>, event: <span class="hljs-type">UIControl</span>.<span class="hljs-type">Event</span>, handler: @escaping (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">self</span>.handler = handler
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<font></font>
        control.addTarget(<span class="hljs-keyword">self</span>, action: #selector(eventHandled(<span class="hljs-number">_</span>:)), <span class="hljs-keyword">for</span>: event)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such an object, it is enough to store one closure. </font><font style="vertical-align: inherit;">Upon completion of the action, as in TextFieldObserver, we present the type of the object and cause a closure:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> handler: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Void</span><font></font>
<font></font>
<span class="hljs-meta">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">eventHandled</span><span class="hljs-params">(<span class="hljs-number">_</span> sender: UIControl)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> sender = sender <span class="hljs-keyword">as</span>? <span class="hljs-type">T</span> {<font></font>
        handler(sender)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Declare Protocol Compliance for UIControl:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">UIControl</span>: <span class="hljs-title">HandlersKit</span>, <span class="hljs-title">EventsObserverHolder</span> </span>{ }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have already replaced delegates with closures, then you do not need to match HandlersKit again. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to write a new interface for UIControl. </font><font style="vertical-align: inherit;">Inside the new method, create an observer and save it in the eventsObserver dictionary using the key event.rawValue:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">HandlersKit</span> <span class="hljs-title">where</span> <span class="hljs-title">Self</span>: <span class="hljs-title">UIControl</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@discardableResult</span>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">on</span><span class="hljs-params">(<span class="hljs-number">_</span> event: UIControl.Event, handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>)</span></span></span> -&gt; <span class="hljs-type">Void</span>) -&gt; <span class="hljs-type">Self</span> {
        <span class="hljs-keyword">let</span> observer = <span class="hljs-type">EventObserver</span>(control: <span class="hljs-keyword">self</span>, event: event, handler: handler)<font></font>
        eventsObserver[event.rawValue] = observer<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can supplement the interface for frequently used events:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">HandlersKit</span> <span class="hljs-title">where</span> <span class="hljs-title">Self</span>: <span class="hljs-title">UIButton</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@discardableResult</span>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">onTap</span><span class="hljs-params">(handler: @escaping <span class="hljs-params">(<span class="hljs-keyword">Self</span>)</span></span></span> -&gt; <span class="hljs-type">Void</span>) -&gt; <span class="hljs-type">Self</span> {<font></font>
        on(.touchUpInside, handler: handler)<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hurray, we managed to replace target-action and delegates with closures and get a single interface for controls. </font><font style="vertical-align: inherit;">There is no need to think about memory leaks and capture the controls themselves in closures, since we have direct access to them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Full code here: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HandlersKit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There are more examples in this repository for: UIControl, UIBarButtonItem, UIGestureRecognizer, UITextField and UITextView. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a deeper insight into the topic, I also propose to read the article about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EasyClosure</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and look at the solution to the problem from the other side. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We welcome feedback in the comments. </font><font style="vertical-align: inherit;">Till!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494610/index.html">Books for beginner podcasters: what to read about earning and monetizing conversational programs</a></li>
<li><a href="../en494612/index.html">Blazor Client Side Online Store: Part 3 - Product Showcase</a></li>
<li><a href="../en494614/index.html">Another look at the question "Do I need defragmentation for SSD"</a></li>
<li><a href="../en494616/index.html">Hack The Box. Walkthrough Sniper. RFI and malicious CHM document</a></li>
<li><a href="../en494618/index.html">Automatic bar with voice control on arduino</a></li>
<li><a href="../en494622/index.html">No masks, but you hold 2/2</a></li>
<li><a href="../en494630/index.html">Install micropython on ESP8266 and work with it under Linux (for beginners)</a></li>
<li><a href="../en494632/index.html">Quartet 9: Allegro | Performance</a></li>
<li><a href="../en494636/index.html">General Financial Analysis in Python (Part 2)</a></li>
<li><a href="../en494638/index.html">Clean architecture for the front-end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>