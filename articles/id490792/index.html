<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏽 👩🏼‍🔧 😑 VXLAN dalam NSX-V - Underlay Bermasalah 🚇 🥙 🤹🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salam, dan pertama sedikit lirik. Saya terkadang iri dengan kolega yang bekerja dari jarak jauh - senang bisa bekerja dari mana saja di dunia yang ter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>VXLAN dalam NSX-V - Underlay Bermasalah</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490792/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salam, dan pertama sedikit lirik. Saya terkadang iri dengan kolega yang bekerja dari jarak jauh - senang bisa bekerja dari mana saja di dunia yang terhubung ke Internet, liburan kapan saja, bertanggung jawab atas proyek dan tenggat waktu, dan tidak berada di kantor mulai 8 hingga 17. Posisi dan tanggung jawab kerja saya praktis tidak termasuk kemungkinan ketidakhadiran lama di pusat data. Namun - kasus-kasus menarik seperti yang dijelaskan di bawah ini kadang-kadang terjadi, dan saya mengerti bahwa ada beberapa posisi di mana ada ruang untuk ekspresi kreatif dari pemecah masalah internal.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penafian kecil - pada saat penulisan, kasus ini belum sepenuhnya diselesaikan, tetapi mengingat kecepatan respons vendor, solusi lengkap mungkin memakan waktu berbulan-bulan, dan saya ingin membagikan temuan saya sekarang. Saya harap, para pembaca yang budiman, Anda akan memaafkan saya dengan tergesa-gesa. Tapi cukup air - bagaimana dengan kasingnya?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendahuluan pertama: ada perusahaan (tempat saya bekerja sebagai insinyur jaringan) yang menampung solusi klien di cloud pribadi VMWare. Sebagian besar solusi baru terhubung ke segmen VXLAN yang dikendalikan oleh NSX-V - saya tidak akan mengevaluasi berapa banyak waktu yang diberikan solusi ini kepada saya, singkatnya - banyak. Saya bahkan berhasil melatih kolega saya untuk mengkonfigurasi NSX ESG dan solusi klien kecil digunakan tanpa partisipasi saya. Catatan penting adalah bidang kontrol dengan replikasi unicast. Hypervisor dihubungkan secara berlebihan oleh dua antarmuka ke switch Juniper QFX5100 fisik yang berbeda (dirakit dalam Virtual Chassis) dan rute kebijakan waktu berdasarkan port virtual asal adalah untuk kelengkapan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi klien sangat heterogen: dari Windows IIS, di mana semua komponen server web diinstal pada satu mesin ke yang cukup besar - misalnya, front web Apache yang seimbang + LB MariaDB di Galera + server-balon yang disinkronkan menggunakan GlusterFS. Hampir setiap server perlu dimonitor secara terpisah, dan tidak semua komponen memiliki alamat publik - jika Anda mengalami masalah ini dan memiliki solusi yang lebih elegan, saya akan dengan senang hati memberi saran. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi pemantauan saya terdiri dari "menghubungkan" firewall (Fortigate) ke setiap jaringan klien internal (+ SNAT dan, tentu saja, pembatasan ketat pada jenis lalu lintas yang diizinkan) dan pemantauan alamat internal - dengan cara ini penyatuan tertentu dan penyederhanaan pemantauan dicapai. Pemantauan itu sendiri berasal dari sekelompok server PRTG. Skema pemantauannya kira-kira seperti ini:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_m/tf/gb/_mtfgbp-yj4608pxce0zj9ktzrw.jpeg" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sementara kami hanya beroperasi dengan VLAN, semuanya sangat biasa dan dapat diprediksi berfungsi seperti jam. Setelah implementasi, NSX-V dan VXLAN menghadapi pertanyaan - apakah mungkin untuk melanjutkan pemantauan dengan cara lama? Pada saat pertanyaan ini, solusi tercepat adalah menggunakan NSX ESG dan menghubungkan antarmuka trunk VXLAN ke jaringan VTEP. Kutipan cepat - karena menggunakan GUI untuk mengonfigurasi jaringan klien, SNAT dan aturan firewall dapat dan menyatukan manajemen dalam antarmuka vSphere tunggal, tetapi menurut saya ini agak rumit dan, di antara hal lain, membatasi rangkaian alat untuk pemecahan masalah. Mereka yang menggunakan ESX NSX sebagai pengganti firewall "nyata", saya pikir, akan setuju. Meskipun, mungkin, solusi seperti itu akan lebih stabil - setelah semua, semua terjadi dalam kerangka kerja satu vendor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi lain adalah dengan menggunakan NSX DLR dalam mode bridge antara VLAN dan VXLAN. Di sini, saya pikir semuanya jelas - manfaat menggunakan VXLAN adalah klise - karena dalam hal ini, Anda masih harus menarik VLAN ke instalasi pemantauan. By the way, dalam proses mengerjakan solusi ini, saya mengalami masalah ketika jembatan DLR tidak mengirim paket ke mesin virtual yang dengannya berada di host yang sama. Saya tahu, saya tahu - dalam buku-buku dan panduan tentang NSX-V secara eksplisit dinyatakan bahwa cluster terpisah harus dialokasikan untuk NSX Edge, tetapi ini ada di buku-buku ... Pokoknya, setelah beberapa bulan dengan dukungan kami tidak menyelesaikan masalah. Pada prinsipnya, saya memahami logika tindakan - modul inti hypervisor yang bertanggung jawab untuk enkapsulasi VXLAN tidak diaktifkan jika DLR dan server yang dipantau berada di host yang sama, karena lalu lintas tidak meninggalkan host dan, secara logis, itu harus dihubungkan ke segmen VXLAN - enkapsulasi tidak diperlukan.Dengan dukungan, kami memutuskan pada vdrPort antarmuka virtual, yang secara logis menggabungkan uplink dan juga melakukan bridging / enkapsulasi - di sana terlihat ketidakcocokan dalam lalu lintas masuk, yang saya ambil untuk bekerja dalam kasus saat ini. Tetapi seperti yang dikatakan, saya tidak menyelesaikan kasus ini sampai akhir, karena dipindahkan ke proyek lain dan cabang awalnya buntu dan tidak ada keinginan khusus untuk mengembangkannya. Jika saya tidak salah, masalahnya diamati dalam versi NSX dan 6.1.4 dan 6.2.karena dipindahkan ke proyek lain dan cabang itu awalnya buntu dan tidak ada keinginan khusus untuk mengembangkannya. Jika saya tidak salah, masalahnya diamati dalam versi NSX dan 6.1.4 dan 6.2.karena dipindahkan ke proyek lain dan cabang itu awalnya buntu dan tidak ada keinginan khusus untuk mengembangkannya. Jika saya tidak salah, masalahnya diamati dalam versi NSX dan 6.1.4 dan 6.2.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di sini - bingo! Fortinet annonsiruet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendukung VXLAN asli</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dan bukan hanya point-to-point atau VXLAN-over-IPSec, bukan bridging VLAN-VXLAN berbasis perangkat lunak - mereka mulai mengimplementasikan semua ini sejak versi 5.4 (dan disajikan oleh </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">vendor</font></a><font style="vertical-align: inherit;"> lain</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tetapi dukungan nyata untuk pesawat kontrol unicast. Ketika menerapkan solusi, saya mengalami masalah lain - server yang diperiksa secara berkala "menghilang" dan kadang-kadang muncul dalam pemantauan, meskipun mesin virtual itu sendiri masih hidup. Alasannya adalah saya lupa mengaktifkan Ping pada antarmuka VXLAN. Dalam proses penyeimbangan kembali kluster, mesin virtual bergerak, dan vMotion berakhir dengan Ping untuk menunjukkan host ESXI baru tempat mesin dipindahkan. Kebodohan saya, tetapi masalah ini sekali lagi merusak kredibilitas dukungan yang dihasilkan - dalam hal ini Fortinet. Saya tidak mengatakan bahwa setiap kasus yang terkait dengan VXLAN dimulai dengan pertanyaan "di mana softswitch VLAN-VXLAN dalam pengaturan Anda?" Kali ini saya disarankan untuk mengubah MTU - ini untuk Ping, yaitu 32 byte. Kemudian "bermain-main" dengan tcp-send-mss dan tcp-accept-mss dalam kebijakan - untuk VXLAN,yang dirangkum dalam UDP. Fuf, maafkan saya - ini mendidih. Secara umum, saya memecahkan masalah ini sendiri.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah berhasil memutar kembali lalu lintas pengujian, diputuskan untuk mengimplementasikan solusi ini. </font><font style="vertical-align: inherit;">Dan dalam produksi ternyata setelah satu atau dua hari, semua yang dipantau melalui VXLAN secara bertahap jatuh. </font><font style="vertical-align: inherit;">Menonaktifkan / mengaktifkan antarmuka membantu, tetapi hanya sementara. </font><font style="vertical-align: inherit;">Sadar akan dukungan yang bergerak lambat, saya masuk untuk pemecahan masalah untuk bagian saya - pada akhirnya, perusahaan saya, jaringan saya adalah tanggung jawab saya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di bawah spoiler adalah jalannya pemecahan masalah. </font><font style="vertical-align: inherit;">Siapa yang bosan dengan surat dan menyombongkan diri - lewati dan pergi ke postanalysis</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penyelesaian masalah</font></font></b><div class="spoiler_text">,    — !<br>
<br>
,    ,    .        . ,           Fortigate  5.6+,    «diagnose debug flow» —              .     . ,  ,      RFC1918,        .   VXLAN   ...15,   ...254,       VTEP.<br>
<br>
   VXLAN-        .  overlay  ARP  OVSDB,  underlay  ARP  CAM.   Fortigate VXLAN FDB   OVSDB.   :<br>
<br>
<pre><code class="plaintext hljs"> fortigate (root) #diag sys vxlan fdb list vxlan-LS<font></font>
mac=00:50:56:8f:3f:5a state=0x0002 flags=0x00 remote_ip=...47 port=4789 vni=5008 ifindex=7<font></font>
</code></pre><br>
    — MAC      VTEP   ...47.     ESXI ,  ,  MAC  ,  VTEP .  CAM/ARP    —      ESXI :<br>
<br>
<pre><code class="plaintext hljs">fortigate (root) #get sys arp | grep ...47<font></font>
...47 0 00:50:56:65:f6:2c dmz<font></font>
</code></pre><br>
     —     ?        Juniper' —          ,      —   VLAN  VTEP     .     DLR-, VDR    —    ESXI ,      VMWare.  MAC «97:6e»  , vmnic1 —  ,   VTEP   ...47     "--dir 2":<br>
<br>
<pre><code class="plaintext hljs">pktcap-uw --uplink vmnic1 --vni 5008  --mac 90:6c:ac:a9:97:6e --dir 2 -o /tmp/monitor.pcap
</code></pre><br>
<img src="https://habrastorage.org/webt/cb/km/gq/cbkmgqv0xd3fidrang8xwmhzzwi.png" alt="image"><br>
<br>
 —    ARP    .   ARP     .   ,         ...15 —   ICMP ? ,     .     ,         ( teaming policy),        vNIC       ,      ,     :<br>
<br>
<pre><code class="plaintext hljs">pktcap-uw --uplink vmnic4 --vni 5008  --mac 90:6c:ac:a9:97:6e --dir 2 -o /tmp/monitor.pcap
</code></pre><br>
<img src="https://habrastorage.org/webt/yi/w2/ei/yiw2eiaz43lr7-zfnybmxbsk4rk.png" alt="image"><br>
<br>
   ,   .      .   —   —         VDR,        .    ,      ,      ,   .   «»     Ethernet  underlay. -    MAC  VTEP     IP.   , ,  — ,   .  ARP  ,    .     Ethernet    :<br>
<br>
<pre><code class="plaintext hljs">fortigate (root) #get sys arp | grep ...47<font></font>
...47 0 00:50:56:65:f6:2c dmz<font></font>
fortigate (root) #get sys arp | grep ...42<font></font>
...42 0 00:50:56:6a:78:86 dmz<font></font>
</code></pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, apa yang kita miliki pada akhirnya - setelah migrasi mesin virtual, fortigate mencoba mengirim lalu lintas ke VTEP dari VXLAN FDB (yang benar), tetapi menggunakan MAC DST yang salah dan lalu lintas diharapkan akan dibuang oleh antarmuka hypervisor penerima. Selain itu, dalam satu dari empat kasus, MAC ini milik hypervisor asli, darimana migrasi mesin dimulai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemarin saya menerima surat dari Fortinet tech support - mereka membuka bug 615586 dalam kasus saya. Saya tidak tahu bagaimana harus bersukacita atau bersedih: di satu sisi, masalahnya bukan pada pengaturan, di sisi lain, perbaikannya hanya akan datang dengan pembaruan firmware, berikut ini, yang terbaik. FAQ juga menghangatkan bug lain yang saya temukan bulan lalu, meskipun pada saat itu di HTML5 GUI vSphere. Nah, departemen QA lokal vendor langsung ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya berani menyarankan yang berikut:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - bidang kendali multicast yang kemungkinan besar tidak akan mengalami masalah yang dijelaskan - lagipula, alamat MAC VTEP diperoleh dari alamat IP grup tempat antarmuka berlangganan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - kemungkinan besar masalah fortics di sesi offload di Network Processor (kira-kira analog dengan CEF) - jika setiap paket dilewatkan melalui CPU, tabel yang berisi informasi yang benar - setidaknya secara visual - akan digunakan. Yang mendukung asumsi ini adalah apa yang membantu untuk menutup / membuka antarmuka atau menunggu beberapa saat - lebih dari 5 menit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - mengubah kebijakan tim, misalnya, menjadi failover eksplisit, atau pengenalan LAG tidak akan menyelesaikan masalah, karena MAC terjebak pada hypervisor asli dalam paket enkapsulasi diamati. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sehubungan dengan ini, saya dapat membagikan apa yang baru saya temukan di sebuah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, di mana dalam salah satu artikel dinyatakan bahwa firewall dan metode transfer data yang tersimpan adalah kruk. </font><font style="vertical-align: inherit;">Ya, saya tidak terlalu berpengalaman di bidang IT untuk mengatakan itu, dan saya tidak setuju dengan semua pernyataan di artikel blog. </font><font style="vertical-align: inherit;">Namun, ada sesuatu yang memberitahuku bahwa ada beberapa kebenaran dalam kata-kata Ivan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih atas perhatian Anda! </font><font style="vertical-align: inherit;">Saya akan dengan senang hati menjawab pertanyaan dan mendengar kritik membangun.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id490782/index.html">AnalogBytes Conference: Roskomnadzor, media, highload, dan semuanya</a></li>
<li><a href="../id490784/index.html">Saya seorang pengembang Android dan saya tidak ingin melakukan pekerjaan manual.</a></li>
<li><a href="../id490786/index.html">Analisis kebocoran urutan kedua: ketika bocor dari mereka yang mencuri data dari bank</a></li>
<li><a href="../id490788/index.html">REPL tidak berguna. Laporan Yandex</a></li>
<li><a href="../id490790/index.html">File Zip: Sejarah, Penjelasan, dan Implementasi</a></li>
<li><a href="../id490796/index.html">Cara mengotomatiskan keamanan wadah dengan gaya Kebijakan sebagai Kode menggunakan CRD</a></li>
<li><a href="../id490804/index.html">Bagaimana ibu seorang peretas masuk penjara dan menginfeksi komputer bos</a></li>
<li><a href="../id490808/index.html">Matematika dalam astronotika: mesin peledakan rotasi</a></li>
<li><a href="../id490812/index.html">Pengalaman Pengajuan Sertifikasi Spring Professional 5</a></li>
<li><a href="../id490816/index.html">Bagaimana situs E-commerce menolak botnet AuthBots?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>