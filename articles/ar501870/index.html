<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>❓ 👋🏻 🎃 العدد الأقصى للقيم في تعداد الجزء الثاني 🧑🏽 🖱️ 👩🏾‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="الجزء الأول النظري  | الجزء الثاني عملي
 
 
 نواصل البحث عن أكبر عدد ممكن من القيم في التعداد. 
 هذه المرة سوف نركز على الجانب العملي للقضية ونرى كيف ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>العدد الأقصى للقيم في تعداد الجزء الثاني</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501870/"><nobr><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الجزء الأول النظري</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;|&nbsp;</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الجزء الثاني عملي</font></font></b></nobr><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نواصل البحث عن أكبر عدد ممكن من القيم في التعداد. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هذه المرة سوف نركز على الجانب العملي للقضية ونرى كيف ستستجيب IDE والمجمع و JVM لإنجازاتنا.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">المحتوى</font></font></h1><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أدوات </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">طريقة الاستخراج </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ديناميكي ملف الطبقة الثوابت </font></font></a><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">صعوبات مفاجئة </font></font></a><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مستقبل مشرق </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">غير آمن </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">اختبار </font></font></a><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac والتبديل </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;">أداء </font></a></font><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الاستنتاج </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">موارد إضافية</font></font></a><br>
<br>
<a name="Tools"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أدوات</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تعتني بنا Javac: فهي </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تقطع الشخصيات التي لا تحبها من المعرفات</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> وتحظر الموروث منها </font></font><code>java.lang.Enum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، لذلك بالنسبة للتجارب ، نحتاج إلى أدوات أخرى. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سنقوم </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">باختبار</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الفرضيات باستخدام </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">asmtools</font></a><font style="vertical-align: inherit;"> - المجمع </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">والفك</font></a><font style="vertical-align: inherit;"> لـ JVM ، </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">وننشئ</font></a><font style="vertical-align: inherit;"> ملفات فئة على نطاق صناعي - باستخدام مكتبة </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
من أجل بساطة الفهم ، سيتم تكرار جوهر ما يحدث في كود زائف يشبه جافا.</font></font><br>
<br>
<a name="Javac"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">جافاك</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كنقطة انطلاق ، من المنطقي أن تأخذ أفضل نتيجة ، يمكن تحقيقها بدون حيل ، بمساعدة واحدة فقط </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">كل شيء بسيط هنا - ونحن إنشاء ملف مصدر التعداد وإضافة عناصر إلى أنه حتى يرفض javac لتجميع </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ذلك</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> مع لعنة "رمز كبير جدا". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
منذ وقت طويل جدًا ، منذ Java 1.7 ، تم الاحتفاظ بهذا الرقم عند مستوى 2_746 عنصرًا. </font><font style="vertical-align: inherit;">ولكن في مكان ما بعد Java 11 ، كانت هناك تغييرات في الخوارزمية لتخزين القيم في التجمع الثابت وانخفض العدد الأقصى إلى 2_743. </font><font style="vertical-align: inherit;">نعم ، نعم ، فقط بسبب تغيير ترتيب العناصر في مجموعة الثوابت! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سنركز على أفضل القيم.</font></font><br>
<br>
<a name="ExtractMethod"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">طريقة الاستخراج</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نظرًا لأن أحد العوامل المقيدة يرتبط بحجم الرمز الثانوي في كتلة التهيئة الثابتة ، فسنحاول جعل الأخير أسهل ما يمكن. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تذكر كيف تبدو على مثال العد </font></font><code>FizzBuzz</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">من الجزء الأول. </font><font style="vertical-align: inherit;">توفر التعليقات تعليمات التجميع المناسبة.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ثابتة {}</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Fizz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-comment">//  0: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">//  3: dup</span>
    <span class="hljs-comment">//  4: ldc           #22                 // String Fizz</span>
    <span class="hljs-comment">//  6: iconst_0</span>
    <span class="hljs-comment">//  7: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 10: putstatic     #25                 // Field Fizz:LFizzBuzz;</span>
    Buzz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 13: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">// 16: dup</span>
    <span class="hljs-comment">// 17: ldc           #28                 // String Buzz</span>
    <span class="hljs-comment">// 19: iconst_1</span>
    <span class="hljs-comment">// 20: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 23: putstatic     #30                 // Field Buzz:LFizzBuzz;</span>
    FizzBuzz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>);
    <span class="hljs-comment">// 26: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">// 29: dup</span>
    <span class="hljs-comment">// 30: ldc           #32                 // String FizzBuzz</span>
    <span class="hljs-comment">// 32: iconst_2</span>
    <span class="hljs-comment">// 33: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 36: putstatic     #33                 // Field FizzBuzz:LFizzBuzz;</span><font></font>
<font></font>
    $VALUES = <span class="hljs-keyword">new</span> FizzBuzz[] {
    <span class="hljs-comment">// 39: iconst_3</span>
    <span class="hljs-comment">// 40: anewarray     #2                  // class FizzBuzz</span><font></font>
        Fizz, <font></font>
    <span class="hljs-comment">// 43: dup</span>
    <span class="hljs-comment">// 44: iconst_0</span>
    <span class="hljs-comment">// 45: getstatic     #25                 // Field Fizz:LFizzBuzz;</span>
    <span class="hljs-comment">// 48: aastore</span><font></font>
        Buzz, <font></font>
    <span class="hljs-comment">// 49: dup</span>
    <span class="hljs-comment">// 50: iconst_1</span>
    <span class="hljs-comment">// 51: getstatic     #30                 // Field Buzz:LFizzBuzz;</span>
    <span class="hljs-comment">// 54: aastore</span><font></font>
        FizzBuzz<font></font>
    <span class="hljs-comment">// 55: dup</span>
    <span class="hljs-comment">// 56: iconst_2</span>
    <span class="hljs-comment">// 57: getstatic     #33                 // Field FizzBuzz:LFizzBuzz;</span>
    <span class="hljs-comment">// 60: aastore</span><font></font>
    };<font></font>
    <span class="hljs-comment">// 61: putstatic     #1                  // Field $VALUES:[LFizzBuzz;</span>
    <span class="hljs-comment">// 64: return</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أول ما يتبادر إلى الذهن هو وضع إنشاء المصفوفة وملئها </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في طريقة منفصلة.</font></font><br>
<br>
<pre><code class="java hljs">$VALUES = createValues();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بتطوير هذه الفكرة ، يمكن نقل إنشاء مثيلات عناصر التعداد إلى نفس الطريقة:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    FizzBuzz[] localValues = createValues();<font></font>
<font></font>
    <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;<font></font>
    Fizz = localValues[index++];<font></font>
    Buzz = localValues[index++];<font></font>
    FizzBuzz = localValues[index++];<font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FizzBuzz[] {
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>), 
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>), 
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>)<font></font>
    };<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أفضل بالفعل ، ولكن كل التقاط لعنصر مصفوفة وزيادة الفهرس اللاحقة يكلف 6 بايت ، وهو أمر مكلف للغاية بالنسبة لنا. </font><font style="vertical-align: inherit;">ضعهم في طريقة منفصلة.</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> valueIndex;<font></font>
<font></font>
<span class="hljs-keyword">static</span>  {<font></font>
    $VALUES = createValues();<font></font>
<font></font>
    valueIndex = <span class="hljs-number">0</span>;<font></font>
    Fizz = nextValue();<font></font>
    Buzz = nextValue();<font></font>
    FizzBuzz = nextValue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz <span class="hljs-title">nextValue</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> $VALUES[valueIndex++];<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يستغرق </font><font style="vertical-align: inherit;">
تهيئة </font><font style="vertical-align: inherit;">11 بايت </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>valueIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">والعودة من كتلة التهيئة الثابتة </font><font style="vertical-align: inherit;">، </font><font style="vertical-align: inherit;">وتبقى 65_524 بايت إضافية لتهيئة الحقول. </font><font style="vertical-align: inherit;">تتطلب تهيئة كل حقل 6 بايت ، مما يمكننا من إنشاء تعداد لعناصر 10_920. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ما يقرب من أربعة أضعاف النمو مقارنة مع javac يجب بالتأكيد الاحتفال به من خلال إنشاء التعليمات البرمجية! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
رمز مصدر المولد: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExtractMethodHugeEnumGenerator.java</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
مثال للفئة التي تم </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">إنشاؤها</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExtractMethodHugeEnum.class</font></font></a><br>
<a name="ConDy"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ثوابت ديناميكية ملف الطبقة</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
حان الوقت لتذكر </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JEP 309 </font></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وثوابته الديناميكية</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الغامضة </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
جوهر الابتكار باختصار: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أضافت الأنواع الموجودة بالفعل المدعومة بمجموعة من الثوابت نوعًا آخر </font></font><code>CONSTANT_Dynamic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. عند تحميل فئة ، يُعرف نوع هذا الثابت ، ولكن قيمته غير معروفة. يؤدي التحميل الأول للثابت إلى استدعاء طريقة التمهيد المحددة في إعلانها. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تصبح نتيجة هذه الطريقة قيمة ثابتة. لا توجد طرق لتغيير القيمة المرتبطة بثابت تمت تهيئته بالفعل. وهو أمر منطقي تمامًا للثابت.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا فكرت أيضًا في Singleton ، فعليك نسيانها على الفور. </font><font style="vertical-align: inherit;">تؤكد المواصفات بشكل منفصل أنه لا يوجد ضمان لسلامة الخيط في هذه الحالة ، ويمكن استدعاء طريقة التهيئة في التعليمات البرمجية متعددة الخيوط أكثر من مرة. </font><font style="vertical-align: inherit;">من المضمون فقط أنه في حالة العديد من المكالمات إلى طريقة التمهيد لنفس الثابت ، فإن JVM سوف يرمي عملة معدنية ويحدد إحدى القيم المحسوبة لدور القيمة الثابتة ، وسيتم التضحية بالقيم الأخرى إلى جامع القمامة.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بشكل سلوكي ، يتم حل ثابت CONSTANT_Dinamic عن طريق تنفيذ أسلوب التشغيل الخاص به على المعلمات التالية: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">كائن بحث محلي ،</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">السلسلة التي تمثل مكون اسم الثابت ،</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الفئة التي تمثل النوع الثابت المتوقع ، و</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أي وسيطات التمهيد المتبقية.</font></font></li>
</ol><br>
As with invokedynamic, multiple threads can race to resolve, but a unique winner will be chosen and any other contending answers discarded.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لتحميل القيم من مجموعة الثوابت في الرمز الثانوي ، يتم توفير الأوامر </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>ldc_w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">و </font></font><code>ldc2_w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. من يهمنا هو أولهم - </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إنه ، على عكس الآخرين ، قادر على تحميل القيم فقط من أول 255 فتحة من التجمع الثابت ، ولكنه يأخذ 1 بايت أقل في البايت كود. كل هذا يعطينا توفير يصل إلى 255 بايت </font></font><code>255 + ((65_524 - (255 * 5)) / 6) = 10_963</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وعنصر في التعداد. هذه المرة ليس النمو مثيرًا للإعجاب ، ولكنه لا يزال موجودًا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مسلحين بهذه المعرفة ، لنبدأ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في كتلة التهيئة الثابتة ، بدلاً من استدعاءات الطريقة ، </font></font><code>nextValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سنقوم الآن بتحميل قيمة الثابت الديناميكي. </font></font><code>ordinal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سيتم تمرير </font><font style="vertical-align: inherit;">قيمة </font><font style="vertical-align: inherit;">المؤشر الترتيبي لعنصر التعداد بشكل صريح ، وبالتالي التخلص من الحقل </font></font><code>valueIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، طريقة المصنع</font></font><code>nextValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">والشكوك حول سلامة موضوع التنفيذ لدينا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كطريقة </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تمهيد</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، سنستخدم نوعًا فرعيًا خاصًا من </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">MethodHandle</font></a><font style="vertical-align: inherit;"> يحاكي سلوك عامل </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في Java. </font><font style="vertical-align: inherit;">توفر المكتبة القياسية طريقة </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MethodHandles.Lookup :: findConstructor ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> للحصول على مثل هذه الطريقة </font><font style="vertical-align: inherit;">، ولكن في حالتنا ، ستهتم JVM ببناء مقبض الطريقة الضروري. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لاستخدام مُنشئ تعدادنا كطريقة تمهيد ، يجب تعديله قليلاً عن طريق تغيير التوقيع. </font><font style="vertical-align: inherit;">ستتم إضافة المعلمات المطلوبة لطريقة التمهيد إلى المُنشئ التقليدي لعنصر تعداد الاسم والرقم التسلسلي:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">FizzBuzz</span><span class="hljs-params">(MethodHandles.Lookup lookup, String name, Class&lt;?&gt; enumClass, <span class="hljs-keyword">int</span> ordinal)</span> </span>{
    <span class="hljs-keyword">super</span>(name, ordinal);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في شكل كود زائف ، ستبدو التهيئة على النحو التالي:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Fizz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>);<font></font>
    Buzz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>);<font></font>
    FizzBuzz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
    $VALUES = createValues();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في المثال أعلاه ، تم </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تعيين </font><font style="vertical-align: inherit;">التعليمات </font><font style="vertical-align: inherit;">كمكالمات طرق </font></font><code>JVM_ldc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، في الرمز الثانوي في مكانها ستكون تعليمات JVM المقابلة. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نظرًا لأن لدينا الآن ثابتًا منفصلاً لكل عنصر من عناصر التعداد ، </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يمكن أيضًا تنفيذ </font><font style="vertical-align: inherit;">إنشاء الصفيف وملئه من </font><font style="vertical-align: inherit;">خلال ثابت ديناميكي. </font><font style="vertical-align: inherit;">طريقة التمهيد بسيطة للغاية:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues(MethodHandles.Lookup lookup, String name, Class&lt;?&gt; clazz, FizzBuzz... elements) {
    <span class="hljs-keyword">return</span> elements;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كل الحيلة في قائمة المعلمات الثابتة لهذا الثابت الديناميكي ، سنقوم بإدراج جميع العناصر التي نريد وضعها في </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">طرق التمهيد:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  1: # 54 REF_invokeStatic FizzBuzz.createValues: (Ljava / lang / invoke / MethodHandles $ Lookup؛ Ljava / lang / String؛ Ljava / lang / Class؛ [LFizzBuzz؛) [LFizzBuzz؛</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    الحجج الأسلوب:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 1 # 0: الفوران: LFizzBuzz ؛</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 2 # 0: الطنين: LFizzBuzz ؛</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 3 # 0: FizzBuzz: LFizzBuzz ؛</font></font><font></font>
</pre><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يفسد JVM المصفوفة من هذه المعلمات الثابتة ويمررها إلى طريقة التمهيد الخاصة بنا كمعلمة vararg </font></font><code>elements</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">الحد الأقصى لعدد المعلمات الثابتة هو 65_535 التقليدي ، لذلك فمن المضمون أن يكون كافياً لجميع عناصر العد ، بغض النظر عن عددها. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بالنسبة للتحويلات التي تحتوي على عدد كبير من العناصر ، سيقلل هذا التغيير من حجم ملف الفئة الناتج ، وفي حالة أنه ، بسبب العدد الكبير من العناصر ، </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">كان يجب تقسيم </font><font style="vertical-align: inherit;">الطريقة </font><font style="vertical-align: inherit;">إلى عدة أجزاء ، كما أنها تحفظ الفتحات في التجمع الثابت. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وفي النهاية ، إنها جميلة.</font></font><br>
<br>
<a name="Surprise"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">صعوبات مفاجئة</font></font></h1><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وهو ما نتغلب عليه بشكل بطولي من خلال إنشاء صفوف يدويًا. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
توفر المكتبات عالية المستوى واجهة مناسبة مقابل بعض القيود على حرية العمل. </font><font style="vertical-align: inherit;">مكتبة ASM التي نستخدمها لإنشاء ملفات الفئة ليست استثناءً. </font><font style="vertical-align: inherit;">لا يوفر آليات للتحكم المباشر في محتويات مجموعة الثوابت. </font><font style="vertical-align: inherit;">عادة ما لا يكون هذا مهمًا جدًا ، ولكن ليس في حالتنا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كما تتذكر ، نحتاج إلى أول 255 عنصرًا من التجمع الثابت لحفظ وحدات البايت الثمينة في كتلة التهيئة الثابتة. </font><font style="vertical-align: inherit;">عند إضافة ثوابت ديناميكية بطريقة قياسية ، سيتم وضعها في مؤشرات عشوائية ومختلطة مع عناصر أخرى ليست حاسمة بالنسبة لنا. </font><font style="vertical-align: inherit;">هذا سيمنعنا من الوصول إلى الحد الأقصى.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">جزء من مجموعة من الثوابت تتشكل بالطريقة التقليدية</font></font></b>
                        <div class="spoiler_text"><blockquote><pre>Constant pool:<font></font>
   #1 = Utf8               FizzBuzz<font></font>
   #2 = Class              #1             // FizzBuzz<font></font>
   #3 = Utf8               java/lang/Enum<font></font>
   #4 = Class              #3             // java/lang/Enum<font></font>
   #5 = Utf8               $VALUES<font></font>
   #6 = Utf8               [LFizzBuzz;<font></font>
   #7 = Utf8               valueIndex<font></font>
   #8 = Utf8               I<font></font>
   #9 = Utf8               Fizz<font></font>
  #10 = Utf8               LFizzBuzz;<font></font>
  #11 = Utf8               Buzz<font></font>
  #12 = Utf8               FizzBuzz<font></font>
  #13 = Utf8               values<font></font>
  #14 = Utf8               ()[LFizzBuzz;<font></font>
  #15 = NameAndType        #5:#6          // $VALUES:[LFizzBuzz;<font></font>
  #16 = Fieldref           #2.#15         // FizzBuzz.$VALUES:[LFizzBuzz;<font></font>
  #17 = Class              #6             // "[LFizzBuzz;"<font></font>
  #18 = Utf8               clone<font></font>
  #19 = Utf8               ()Ljava/lang/Object;<font></font>
  #20 = NameAndType        #18:#19        // clone:()Ljava/lang/Object;<font></font>
  #21 = Methodref          #17.#20        // "[LFizzBuzz;".clone:()Ljava/lang/Object;<font></font>
  ...<font></font>
  #40 = NameAndType        #9:#10         // Fizz:LFizzBuzz;<font></font>
  #41 = Dynamic            #0:#40         // #0:Fizz:LFizzBuzz;<font></font>
  #42 = Fieldref           #2.#40         // FizzBuzz.Fizz:LFizzBuzz;<font></font>
  #43 = NameAndType        #11:#10        // Buzz:LFizzBuzz;<font></font>
  #44 = Dynamic            #0:#43         // #0:Buzz:LFizzBuzz;<font></font>
  #45 = Fieldref           #2.#43         // FizzBuzz.Buzz:LFizzBuzz;<font></font>
  #46 = NameAndType        #12:#10        // FizzBuzz:LFizzBuzz;<font></font>
  #47 = Dynamic            #0:#46         // #0:FizzBuzz:LFizzBuzz;<font></font>
  #48 = Fieldref           #2.#46         // FizzBuzz.FizzBuzz:LFizzBuzz;<font></font>
</pre><br>
</blockquote><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لحسن الحظ ، يوجد حل بديل - عند إنشاء فئة ، يمكنك تحديد فئة فئة يتم من خلالها نسخ مجموعة من الثوابت وسمة مع وصف لطرق التمهيد. </font><font style="vertical-align: inherit;">الآن فقط علينا إنشاؤها يدويًا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في الواقع ، ليس الأمر صعبًا كما قد يبدو للوهلة الأولى. </font><font style="vertical-align: inherit;">تنسيق ملف الفصل بسيط للغاية ، كما أن تكوينه اليدوي عملية شاقة إلى حد ما ، ولكنها ليست معقدة على الإطلاق. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أهم شيء هنا هو خطة واضحة. </font><font style="vertical-align: inherit;">لتعداد من </font></font><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">العناصر التي نحتاجها:</font></font><br>
<br>
<ul>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">اكتب السجلات </font></font><code>CONSTANT_Dynamic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ثوابتنا الديناميكية</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سجلات الكتابة </font></font><code>CONSTANT_NameAndType</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- أزواج من الروابط إلى اسم عنصر التعداد ونوعه. </font><font style="vertical-align: inherit;">سيكون النوع هو نفسه بالنسبة للجميع ، وهذا هو نوع الفصل في تعدادنا.</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">اكتب السجلات </font></font><code>CONSTANT_Utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- أسماء عناصر التعداد مباشرة</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سجلات النوع </font></font><code>CONSTANT_Integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- الأرقام التسلسلية لعناصر التعداد التي تم تمريرها إلى المُنشئ كقيمة معلمة</font></font><code>ordinal</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أسماء الفئات الحالية والأساسية ، والسمات ، وتوقيعات الطريقة وتفاصيل التنفيذ المملة الأخرى. </font><font style="vertical-align: inherit;">يمكن للمهتمين النظر في شفرة المصدر للمولد.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هناك الكثير من العناصر المكونة في مجموعة الثوابت التي تشير إلى عناصر أخرى من التجمع حسب الفهرس ، لذلك يجب حساب جميع المؤشرات التي نحتاجها مسبقًا ، </font></font><code>elementNames</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وهي قائمة بأسماء عناصر تعدادنا:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">int</span> elementCount = elementNames.size();<font></font>
<font></font>
<span class="hljs-keyword">int</span> baseConDy = <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> baseNameAndType = baseConDy + elementCount;
<span class="hljs-keyword">int</span> baseUtf8 = baseNameAndType + elementCount;
<span class="hljs-keyword">int</span> baseInteger = baseUtf8 + elementCount;
<span class="hljs-keyword">int</span> indexThisClass = baseInteger + elementCount;
<span class="hljs-keyword">int</span> indexThisClassUtf8 = indexThisClass + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexSuperClass = indexThisClassUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexSuperClassUtf8 = indexSuperClass + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodsUtf8 = indexSuperClassUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexConDyDescriptorUtf8 = indexBootstrapMethodsUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodHandle = indexConDyDescriptorUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodRef = indexBootstrapMethodHandle + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodNameAndType = indexBootstrapMethodRef + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodName = indexBootstrapMethodNameAndType + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodDescriptor = indexBootstrapMethodName + <span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-keyword">int</span> constantPoolSize = indexBootstrapMethodDescriptor + <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد ذلك ، نبدأ في الكتابة. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في البداية - توقيع ملف الفئة ، البايتات الأربعة المعروفة للجميع </font></font><nobr><code>0xCA 0xFE 0xBA 0xBE</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وإصدار تنسيق الملف:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Class file header</span><font></font>
u4(CLASS_FILE_SIGNATURE);<font></font>
u4(version);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ثم - مجموعة من الثوابت:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تجمع الثوابت</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">// Constant pool</span><font></font>
u2(constantPoolSize);<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Dynamic</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1u2u2(CONSTANT_Dynamic, i, baseNameAndType + i);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_NameAndType</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1u2u2(CONSTANT_NameAndType, baseUtf8 + i, indexConDyDescriptorUtf8);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Utf8</span>
<span class="hljs-comment">//noinspection ForLoopReplaceableByForEach</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1(CONSTANT_Utf8);<font></font>
    utf8(elementNames.get(i));<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Integer</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1(CONSTANT_Integer);<font></font>
    u4(i);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ThisClass</span><font></font>
u1(CONSTANT_Class);<font></font>
u2(indexThisClassUtf8);<font></font>
<font></font>
<span class="hljs-comment">// ThisClassUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(enumClassName);<font></font>
<font></font>
<span class="hljs-comment">// SuperClass</span><font></font>
u1(CONSTANT_Class);<font></font>
u2(indexSuperClassUtf8);<font></font>
<font></font>
<span class="hljs-comment">// SuperClassUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(JAVA_LANG_ENUM);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodsUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(ATTRIBUTE_NAME_BOOTSTRAP_METHODS);<font></font>
<font></font>
<span class="hljs-comment">// ConDyDescriptorUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(binaryEnumClassName);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodHandle</span><font></font>
u1(CONSTANT_MethodHandle);<font></font>
u1(REF_newInvokeSpecial);<font></font>
u2(indexBootstrapMethodRef);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodRef</span><font></font>
u1u2u2(CONSTANT_Methodref, indexThisClass, indexBootstrapMethodNameAndType);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodNameAndType</span><font></font>
u1u2u2(CONSTANT_NameAndType, indexBootstrapMethodName, indexBootstrapMethodDescriptor);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodName</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(BOOTSTRAP_METHOD_NAME);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodDescriptor</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(BOOTSTRAP_METHOD_DESCRIPTOR);<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد ثابت بركة يتحدث عن معدلات الوصول والأعلام ( </font></font><code>public</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>enun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، وهلم جرا)، اسم الفئة وسلفها:</font></font><br>
<br>
<pre><code class="java hljs">u2(access);<font></font>
u2(indexThisClass);<font></font>
u2(indexSuperClass);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لن يكون للفئة الوهمية التي أنشأناها واجهات ، ولا حقول ، ولا طرق ، ولكن ستكون هناك سمة واحدة مع وصف طرق التمهيد:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Interfaces count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Fields count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Methods count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Attributes count</span>
u2(<span class="hljs-number">1</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وهنا جسم السمة نفسها:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// BootstrapMethods attribute</span><font></font>
u2(indexBootstrapMethodsUtf8);<font></font>
<span class="hljs-comment">// BootstrapMethods attribute size</span>
u4(<span class="hljs-number">2</span> <span class="hljs-comment">/* num_bootstrap_methods */</span> + <span class="hljs-number">6</span> * elementCount);
<span class="hljs-comment">// Bootstrap method count</span><font></font>
u2(elementCount);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {
    <span class="hljs-comment">// bootstrap_method_ref</span><font></font>
    u2(indexBootstrapMethodHandle);<font></font>
    <span class="hljs-comment">// num_bootstrap_arguments</span>
    u2(<span class="hljs-number">1</span>);
    <span class="hljs-comment">// bootstrap_arguments[1]</span><font></font>
    u2(baseInteger + i);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هذا كل شيء ، تتكون الطبقة. </font><font style="vertical-align: inherit;">نأخذ هذه البايتات وننشئ منها </font></font><code>ClassReader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> ClassReader <span class="hljs-title">getBootstrapClassReader</span><span class="hljs-params">(<span class="hljs-keyword">int</span> version, <span class="hljs-keyword">int</span> access, String enumClassName, List&lt;String&gt; elementNames)</span> </span>{
    <span class="hljs-keyword">byte</span>[] bootstrapClassBytes = <span class="hljs-keyword">new</span> ConDyBootstrapClassGenerator(<font></font>
        version,<font></font>
        access,<font></font>
        enumClassName,<font></font>
        elementNames<font></font>
    )<font></font>
    .generate();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (bootstrapClassBytes == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClassReader(bootstrapClassBytes);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لم يكن الأمر صعبًا. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
رمز مصدر المولد: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConDyBootstrapClassGenerator.java</font></font></a><br>
<a name="Future"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مستقبل مشرق</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نحن نتطرق لفترة وجيزة من قوائمنا:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscoverConstantValueAttribute</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String STRING = <span class="hljs-string">"Habrahabr, world!"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object OBJECT = <span class="hljs-keyword">new</span> Object();<font></font>
<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في كتلة التهيئة الثابتة لهذه الفئة ، ستحدث فجأة عملية كتابة واحدة فقط ، في الحقل </font></font><code>OBJECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">static</span> {<font></font>
    OBJECT = <span class="hljs-keyword">new</span> Object();
    <span class="hljs-comment">//  0: new           #2                  // class java/lang/Object</span>
    <span class="hljs-comment">//  3: dup</span>
    <span class="hljs-comment">//  4: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span>
    <span class="hljs-comment">//  7: putstatic     #7                  // Field OBJECT:Ljava/lang/Object;</span>
    <span class="hljs-comment">// 10: return</span><font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ولكن ماذا عن </font></font><code>STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">؟ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سيساعد الفريق في تسليط الضوء على هذا اللغز </font></font><nobr><code>javap -c -s -p -v DiscoverConstantValueAttribute.class</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، وهنا الجزء الذي يهمنا:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.String STRING;<font></font>
  descriptor: Ljava/lang/String;<font></font>
  flags: (<span class="hljs-number">0x0019</span>) ACC_PUBLIC, ACC_STATIC, ACC_FINAL<font></font>
  ConstantValue: String Habrahabr, world!<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تم نقل قيمة الحقل النهائي الثابت من كتلة التهيئة إلى سمة منفصلة </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">إليك ما يكتبون عن هذه السمة في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JVMS11 §4.7.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تمثل سمة ConstantValue قيمة تعبير ثابت (JLS §15.28) ، وتستخدم على النحو التالي:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إذا تم تعيين علامة ACC_STATIC في عنصر access_flags لبنية field_info ، فسيتم تعيين الحقل الذي يمثله هيكل field_info القيمة التي تمثلها سمة ConstantValue كجزء من تهيئة الفئة أو الواجهة التي تعلن عن الحقل (الفقرة 5.5). </font><font style="vertical-align: inherit;">يحدث هذا قبل استدعاء طريقة تهيئة الطبقة أو الواجهة لتلك الفئة أو الواجهة (الفقرة 2.9.2).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">خلاف ذلك ، يجب أن يتجاهل Java Virtual Machine السمة بصمت.</font></font></li>
</ul><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا تم العثور على هذه السمة في وقت واحد </font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">و </font></font><code>final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(على الرغم من أن هذا الأخير لم يتم ذكره صراحةً هنا) ، فسيتم تهيئة هذا الحقل بالقيمة من هذه السمة. </font><font style="vertical-align: inherit;">ويحدث هذا حتى قبل استدعاء طريقة التهيئة الثابتة. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سيكون من المغري استخدام هذه السمة لتهيئة عناصر التعداد ، في فصلنا قبل الأخير كان هناك ثوابت فقط ، وإن كانت ديناميكية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ولسنا أول من يفكر في هذا الاتجاه ، هناك ذكر في JEP 309 </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">لسوء الحظ ، هذا ذكر في فصل عمل المستقبل:</font></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">العمل</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
المستقبلي تشمل التمديدات المستقبلية المحتملة: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إرفاق الثوابت الديناميكية بسمة ConstantValue للحقول الثابتة</font></font></li>
</ul><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في هذه الأثناء ، يمكننا فقط أن نحلم بالأوقات التي ستنتقل فيها هذه الميزة من الحالة "من الجيد فعلها" إلى "جاهزة". </font><font style="vertical-align: inherit;">ثم ستفقد القيود المفروضة على حجم التعليمات البرمجية في كتلة التهيئة تأثيرها وسيحدد الحد الأقصى لعدد العناصر في التعداد حدود التجمع الثابت. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وفقًا لتقديرات تقريبية ، في هذه الحالة يمكننا أن نأمل في </font></font><code>65&nbsp;489 / 4 = 16_372</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">عنصر. </font><font style="vertical-align: inherit;">هذا </font></font><code>65_489</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هو عدد الفتحات غير المشغولة للمجمع الثابت ، 46 منها من 65_535 الممكنة نظريًا ذهبت إلى الأعلى. </font></font><code>4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- عدد الفواصل الزمنية المطلوبة للإعلان عن حقل واحد والثابت الدينامي المقابل. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بالطبع ، لا يمكن العثور على الرقم الدقيق إلا بعد إصدار نسخة JDK مع دعم هذه الميزة.</font></font><br>
<br>
<a name="Unsafe"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">غير آمن</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
عدونا هو النمو الخطي لكتلة التهيئة مع زيادة في عدد عناصر التعداد. </font><font style="vertical-align: inherit;">إذا وجدنا طريقة للحد من التهيئة في حلقة ، وبالتالي إزالة العلاقة بين عدد العناصر في العد وحجم كتلة التهيئة ، فإننا سنحقق اختراقا آخر. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لسوء الحظ ، لا تسمح أي من واجهات برمجة التطبيقات العامة القياسية بالكتابة إلى </font></font><code>static final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الحقول حتى داخل كتلة التهيئة الثابتة. </font><font style="vertical-align: inherit;">لن يساعد التأمل ولا VarHandles هنا. </font><font style="vertical-align: inherit;">أملنا الوحيد عظيم ورهيب </font></font><code>sun.misc.Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قد يبدو التنفيذ غير الآمن لـ FizzBuzz كالتالي:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FizzBuzz غير آمنة</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> sun.misc.Unsafe;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> FizzBuzz {<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz[] $VALUES;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz Fizz;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz Buzz;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz FizzBuzz;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FizzBuzz[] values() {
        <span class="hljs-keyword">return</span> (FizzBuzz[]) $VALUES.clone();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FizzBuzz <span class="hljs-title">valueOf</span><span class="hljs-params">(String name)</span> </span>{
        <span class="hljs-keyword">return</span> (FizzBuzz) Enum.valueOf(FizzBuzz.class, name);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">FizzBuzz</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> ordinal)</span> </span>{
        <span class="hljs-keyword">super</span>(name, ordinal);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FizzBuzz[] {<font></font>
            Fizz,<font></font>
            Buzz,<font></font>
            FizzBuzz<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">static</span>  {<font></font>
        Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
        unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
        Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
        String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
            String fieldName = fieldNames[i];<font></font>
            Field field = FizzBuzz.class.getDeclaredField(fieldName);<font></font>
            <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
            unsafe.putObject(FizzBuzz.class, fieldOffset, <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i));<font></font>
        }<font></font>
<font></font>
        $VALUES = createValues();<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يسمح لنا هذا النهج بإنشاء تعداد يحتوي على ما يقرب من 21 ألف عنصر ؛ ولأكثر من ذلك ، فإن سعة مجموعة الثوابت ليست كافية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتطلب التوثيق الموجود في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enum :: ordinal ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> أن تتطابق قيمته مع الرقم المتسلسل للعنصر المقابل في إعلان التعداد ، لذا يجب عليك تخزين قائمة أسماء الحقول بشكل صريح بالترتيب الصحيح ، وبالتالي مضاعفة حجم ملف الفئة تقريبًا.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الترقيم النهائي العام () </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يعيد ترتيبي ثابت التعداد هذا (موضعه في إعلان التعداد ، حيث يتم تعيين الثابت الأولي ترتيباً من الصفر).</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هنا يمكن أن تساعد واجهة برمجة التطبيقات العامة لمحتويات مجموعة الثوابت ، فنحن نعرف بالفعل كيفية ملئها بالترتيب الذي نحتاج إليه ، ولكن لا توجد واجهة برمجة تطبيقات مثل هذه ومن غير المحتمل أن تكون موجودة على الإطلاق. تم </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">التصريح عن</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> أسلوب </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Class :: getConstantPool ()</font></a><font style="vertical-align: inherit;"> المتوفر في OpenJDK </font><font style="vertical-align: inherit;">كحزمة خاصة وسيكون من الصعب الاعتماد عليها في كود المستخدم. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أصبحت كتلة التهيئة الآن مضغوطة تمامًا وتقريباً مستقلة عن عدد العناصر في التعداد ، لذا يمكنك </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">رفضها عن طريق تضمين جسمها في الحلقة:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
    unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
    Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
    String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
    FizzBuzz[] localValues = <span class="hljs-keyword">new</span> FizzBuzz[fieldNames.length];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
        String fieldName = fieldNames[i];<font></font>
        Field field = FizzBuzz.class.getDeclaredField(fieldName);<font></font>
        <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
        unsafe.putObject(<font></font>
            FizzBuzz.class,<font></font>
            fieldOffset,<font></font>
            (localValues[i] = <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i))<font></font>
        );<font></font>
    }<font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هنا تحدث عملية شبيهة بالانهيار الجليدي: إلى جانب الطريقة </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، تختفي تعليمات قراءة حقول عناصر التعداد ، وتصبح سجلات النوع </font></font><code>Fieldref</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لهذه الحقول </font><font style="vertical-align: inherit;">غير ضرورية </font><font style="vertical-align: inherit;">، وبالتالي اكتب </font></font><code>NameAndType</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">السجلات لنوع السجلات </font></font><code>Fieldref</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. في التجمع الثابت ، </font></font><code>2 * &lt;   &gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يتم </font><font style="vertical-align: inherit;">تحرير </font><font style="vertical-align: inherit;">الفتحات التي يمكن استخدامها لإعلان عناصر تعداد إضافية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لكن ليست كل شيء وردية للغاية ، تُظهر الاختبارات انخفاضًا كبيرًا في الأداء: إن تهيئة فئة التعداد التي تحتوي على 65 ألف عنصر تستغرق دقيقة واحدة ونصف لا يمكن تصوره. كما اتضح بسرعة كبيرة ، "الانعكاس يبطئ". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تطبيق </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class :: getDeclaredField ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">OpenJDK</font></a><font style="vertical-align: inherit;"> له سلوك مقارب لعدد من الحقول في الفصل ، وكتلة التهيئة لدينا تربيعية بسبب هذا.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تؤدي إضافة التخزين المؤقت إلى تحسين الحالة إلى حد ما ، على الرغم من أنها لا تحلها بالكامل:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
    unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
    Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
    String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
    Field[] fields = FizzBuzz.class.getDeclaredFields();<font></font>
    HashMap&lt;String, Field&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(fields.length);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(Field field : fields) {<font></font>
        cache.put(field.getName(), field);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
        String fieldName = fieldNames[i];<font></font>
        Field field = cache.get(fieldName);<font></font>
        <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
        unsafe.putObject(<font></font>
            FizzBuzz.class,<font></font>
            fieldOffset,<font></font>
            (localValues[i] = <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i))<font></font>
        );<font></font>
    }    <font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتيح لك النهج غير الآمن الموضح في هذا الفصل إنشاء عمليات نقل باستخدام عدد من العناصر يصل إلى 65_410 ، وهو ما يقرب من 24 مرة أكثر من النتيجة التي يمكن تحقيقها باستخدام javac وهو قريب جدًا من الحد النظري البالغ 65_505 عناصر محسوبة من قبلنا في المنشور السابق للدورة.</font></font><br>
<br>
<a name="Testing"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تحقق من الأداء</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بالنسبة للاختبارات ، نأخذ أكبر تعداد ، ننشئه باستخدام الأمر </font></font><nobr><code>java -jar HugeEnumGen.jar -a Unsafe UnsafeHugeEnum</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. ونتيجة لذلك ، نحصل على ملف فئة بحجم 2 ميغابايت و 65_410 عنصر. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قم بإنشاء مشروع Java جديد في IDEA وأضف الفئة التي تم إنشاؤها كمكتبة خارجية. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على الفور تقريبًا ، أصبح من الملاحظ أن IDEA ليست جاهزة لمثل هذا الاختبار الإجهاد: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/su/-6/m4su-6bvdkkqmf3pypqrmpzntnw.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يستغرق الإكمال التلقائي لعنصر تعداد عشرات الثواني على كل من i5 المحمول القديم وعلى i7 8700K الأكثر حداثة. وإذا حاولت استخدام الإصلاح السريع لإضافة العناصر المفقودة إلى المحول ، فستتوقف IDEA عن إعادة رسم النوافذ. أشك في ذلك مؤقتًا ، لكنه فشل في انتظار اكتماله. كما أن الاستجابة أثناء التصحيح تترك الكثير مما هو مرغوب فيه. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لنبدأ بعدد صغير من العناصر في </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestFew</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String... args)</span> </span>{
        <span class="hljs-keyword">for</span>(String arg : args) {<font></font>
            System.out.print(arg + <span class="hljs-string">" : "</span>);<font></font>
<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                UnsafeHugeEnum value = UnsafeHugeEnum.valueOf(arg);<font></font>
<font></font>
                doSwitch(value);<font></font>
            } <span class="hljs-keyword">catch</span>(Throwable e) {<font></font>
                e.printStackTrace(System.out);<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSwitch</span><span class="hljs-params">(UnsafeHugeEnum value)</span> </span>{
        <span class="hljs-keyword">switch</span>(value) {
            <span class="hljs-keyword">case</span> VALUE_00001:<font></font>
                System.out.println(<span class="hljs-string">"First"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VALUE_31415:<font></font>
                System.out.println(<span class="hljs-string">"(int) (10_000 * Math.PI)"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VALUE_65410:<font></font>
                System.out.println(<span class="hljs-string">"Last"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:<font></font>
                System.out.println(<span class="hljs-string">"Unexpected value: "</span> + value);
                <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا توجد مفاجآت هنا ، ويتم تجميعها وإطلاقها بشكل منتظم:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ java TestFew VALUE_00001 VALUE_00400 VALUE_31415 VALUE_65410<font></font>
VALUE_00001 : First<font></font>
VALUE_00400 : Unexpected value: VALUE_00400<font></font>
VALUE_31415 : (int) (10_000 * Math.PI)<font></font>
VALUE_65410 : Last<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ماذا عن المزيد من العناصر في </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">؟ </font><font style="vertical-align: inherit;">هل يمكننا ، على سبيل المثال ، معالجة </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">جميع </font><font style="vertical-align: inherit;">عناصرنا </font><font style="vertical-align: inherit;">البالغ عددها 65 ألف عنصر </font><font style="vertical-align: inherit;">في </font><font style="vertical-align: inherit;">وقت واحد؟</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">switch</span>(value) {
    <span class="hljs-keyword">case</span> VALUE_00001:
    <span class="hljs-keyword">case</span> VALUE_00002:<font></font>
        ...<font></font>
    <span class="hljs-keyword">case</span> VALUE_65410:<font></font>
        System.out.println(<span class="hljs-string">"One of known values: "</span> + value);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
        System.out.println(<span class="hljs-string">"Unexpected value: "</span> + value);
        <span class="hljs-keyword">break</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
للأسف لا. </font><font style="vertical-align: inherit;">عندما نحاول الترجمة ، نحصل على مجموعة كاملة من رسائل الخطأ:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ javac -fullversion<font></font>
javac full version "14.0.1+7"<font></font>
<font></font>
$ javac TestAll.java<font></font>
TestAll.java:18: error: code too large for try statement<font></font>
        switch(value) {<font></font>
        ^<font></font>
TestAll.java:65433: error: too many constants<font></font>
                break;<font></font>
                ^<font></font>
TestAll.java:17: error: code too large<font></font>
    private static void doSwitch(UnsafeHugeEnum value) {<font></font>
                        ^<font></font>
TestAll.java:1: error: too many constants<font></font>
public class TestAll {<font></font>
       ^<font></font>
4 errors<font></font>
</code></pre><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testfew.java</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestAll.java</font></font></a></li>
</ul><br>
<a name="JavacSwitchTranslation"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">جافاك والتبديل</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لفهم ما يحدث ، علينا أن نكتشف كيف تحدث ترجمة </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">عناصر التعداد. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تحتوي مواصفات JVM على فصل منفصل في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JVMS11 §3.10 تجميع المفاتيح</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ، والتي </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">تتلخص</font></a><font style="vertical-align: inherit;"> توصياتها </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">باستخدام واحد من اثنين من التعليمات </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">البرمجية الثانوية</font></a><font style="vertical-align: inherit;"> ، </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أو </font></font><code>lookupswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لن نجد </font><font style="vertical-align: inherit;">أي إشارات </font><font style="vertical-align: inherit;">إلى السلاسل أو عناصر التعداد في هذا الفصل. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أفضل الوثائق هي الكود ، لذلك حان الوقت للتعمق في المصدر </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الاختيار بين </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">و </font></font><code>lookupswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يحدث في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen :: visitSwitch ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ويعتمد على عدد الخيارات في </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. في معظم الحالات ، يفوز </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Determine whether to issue a tableswitch or a lookupswitch</span>
<span class="hljs-comment">// instruction.</span>
<span class="hljs-keyword">long</span> table_space_cost = <span class="hljs-number">4</span> + ((<span class="hljs-keyword">long</span>) hi - lo + <span class="hljs-number">1</span>); <span class="hljs-comment">// words</span>
<span class="hljs-keyword">long</span> table_time_cost = <span class="hljs-number">3</span>; <span class="hljs-comment">// comparisons</span>
<span class="hljs-keyword">long</span> lookup_space_cost = <span class="hljs-number">3</span> + <span class="hljs-number">2</span> * (<span class="hljs-keyword">long</span>) nlabels;
<span class="hljs-keyword">long</span> lookup_time_cost = nlabels;
<span class="hljs-keyword">int</span> opcode =<font></font>
    nlabels &gt; <span class="hljs-number">0</span> &amp;&amp;<font></font>
    table_space_cost + <span class="hljs-number">3</span> * table_time_cost &lt;=<font></font>
    lookup_space_cost + <span class="hljs-number">3</span> * lookup_time_cost<font></font>
    ?<font></font>
    tableswitch : lookupswitch;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يبلغ حجم الرأس </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 بايت تقريبًا بالإضافة إلى 4 بايت لكل قيمة. </font><font style="vertical-align: inherit;">وبالتالي ، </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">لا يمكن أن يكون هناك المزيد من </font></font><code>( 65_535 - 16 ) / 4 = 16_379</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">العناصر </font><font style="vertical-align: inherit;">تحت أي ظرف من الظروف </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في الواقع ، بعد تقليل عدد الفروع </font></font><code>case</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في الجسم </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إلى 16 ألفًا ، يبقى خطأ تجميع واحد فقط ، الأكثر غموضاً:</font></font><br>
<br>
<pre><code class="plaintext hljs">TestAll.java:18: error: code too large for try statement<font></font>
        switch(value) {<font></font>
        ^<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بحثًا عن مصدر الخطأ ، سنعود مبكرًا قليلاً ، إلى مرحلة التخلص من السكر النحوي. </font><font style="vertical-align: inherit;">و </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الأساليب هي المسؤولة عن </font><font style="vertical-align: inherit;">الترجمة </font></font><code>visitEnumSwitch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">، </font></font><code>mapForEnum()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">والطبقة </font></font><code>EnumMapping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lower.java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نجد أيضًا تعليقًا وثائقيًا صغيرًا:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EnumMapping JavaDoc</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">/** This map gives a translation table to be used for enum
 *  switches.
 *
 *  &lt;p&gt;For each enum that appears as the type of a switch
 *  expression, we maintain an EnumMapping to assist in the
 *  translation, as exemplified by the following example:
 *
 *  &lt;p&gt;we translate
 *  &lt;pre&gt;
 *          switch(colorExpression) {
 *          case red: stmt1;
 *          case green: stmt2;
 *          }
 *  &lt;/pre&gt;
 *  into
 *  &lt;pre&gt;
 *          switch(Outer$0.$EnumMap$Color[colorExpression.ordinal()]) {
 *          case 1: stmt1;
 *          case 2: stmt2
 *          }
 *  &lt;/pre&gt;
 *  with the auxiliary table initialized as follows:
 *  &lt;pre&gt;
 *          class Outer$0 {
 *              synthetic final int[] $EnumMap$Color = new int[Color.values().length];
 *              static {
 *                  try { $EnumMap$Color[red.ordinal()] = 1; } catch (NoSuchFieldError ex) {}
 *                  try { $EnumMap$Color[green.ordinal()] = 2; } catch (NoSuchFieldError ex) {}
 *              }
 *          }
 *  &lt;/pre&gt;
 *  class EnumMapping provides mapping data and support methods for this translation.
 */</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يتحول </font><font style="vertical-align: inherit;">
الغموض </font><font style="vertical-align: inherit;">إلى جزء من فئة المساعدة التي يتم إنشاؤها تلقائيًا </font></font><code>TestAll$0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. داخل - إعلان صفيف ثابت ورمز لتهيئته. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تعمل المصفوفة على إصلاح التوافق بين أسماء عناصر التعداد </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">والقيم العددية </font><font style="vertical-align: inherit;">المخصصة لها أثناء التجميع </font><font style="vertical-align: inherit;">، وبالتالي حماية الشفرة المترجمة من التأثيرات الضارة لإعادة البناء. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
عند إعادة الترتيب أو إضافة عناصر جديدة أو حذف عناصر التعداد الموجودة ، قد يغير بعضها القيمة </font></font><code>ordinal()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">وهذا ما يحميه مستوى إضافي من التباعد.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    $SwitchMap$UnsafeHugeEnum[UnsafeHugeEnum.VALUE_00001.ordinal()] = <span class="hljs-number">1</span>;
    <span class="hljs-comment">//  9: getstatic     #2                  // Field $SwitchMap$UnsafeHugeEnum:[I</span>
    <span class="hljs-comment">// 12: getstatic     #3                  // Field UnsafeHugeEnum.VALUE_00001:LUnsafeHugeEnum;</span>
    <span class="hljs-comment">// 15: invokevirtual #4                  // Method UnsafeHugeEnum.ordinal:()I</span>
    <span class="hljs-comment">// 18: iconst_1</span>
    <span class="hljs-comment">// 19: iastore</span><font></font>
}<font></font>
<span class="hljs-comment">// 20: goto          24</span>
<span class="hljs-keyword">catch</span>(NoSuchFieldError e) { }
<span class="hljs-comment">// 23: astore_0</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
رمز التهيئة بسيط ويستهلك من 15 إلى 17 بايت لكل عنصر. </font><font style="vertical-align: inherit;">ونتيجة لذلك ، تستوعب كتلة التهيئة الثابتة تهيئة ما لا يزيد عن 3_862 من العناصر. </font><font style="vertical-align: inherit;">يتضح أن هذا الرقم هو الحد الأقصى لعدد عناصر التعداد التي يمكننا استخدامها في عنصر واحد </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مع التنفيذ الحالي </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="Conclusion"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">استنتاج</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لقد رأينا أن استخدام مثل هذه التقنية البسيطة مثل تخصيص إنشاء عناصر التعداد وتهيئة صفيف </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في طريقة منفصلة يسمح لك بزيادة الحد الأقصى لعدد العناصر في التعداد من 2_746 إلى 10_920. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا تبدو النتائج الديناميكية المستمرة على خلفية الإنجازات السابقة مثيرة للإعجاب للغاية وتسمح لك بالحصول على 43 عنصرًا إضافيًا فقط ، ولكن مع هذا النهج ، يكون من الأكثر أناقة إضافة خصائص جديدة إلى التعداد - فقط قم بتعديل المنشئ وتمريره القيم الضرورية من خلال المعلمات الثابتة للثابت الديناميكي. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا تم في وقت ما تعليم السمة المستقبلية </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">فهم الثوابت الديناميكية ، يمكن أن يرتفع هذا الرقم إلى 10 آلاف إلى 16. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الاستخدام</font></font><code>sun.misc.Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يسمح لك بعمل قفزة عملاقة وزيادة الحد الأقصى لعدد العناصر إلى 65_410. ولكن لا تنس أن </font></font><code>Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">هذه واجهة برمجة تطبيقات خاصة قد تختفي بمرور الوقت وأن استخدامها يمثل خطرًا كبيرًا ، كما يحذر javac مباشرة:</font></font><br>
<br>
<pre><code class="plaintext hljs">Test.java:3: warning: Unsafe is internal proprietary API and may be removed in a future release<font></font>
import sun.misc.Unsafe;<font></font>
               ^<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ولكن ، كما اتضح ، لا يكفي لإنشاء تعداد عملاق ، تحتاج أيضًا إلى أن تكون قادرًا على استخدامه. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
توجد حاليًا مشكلات في دعم مثل هذه التعدادات من IDE وعلى مستوى مترجم Java. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يمكن أن يقلل عدد كبير من الحقول في الفصل من استجابة IDE أثناء التحرير وأثناء تصحيح الأخطاء. </font><font style="vertical-align: inherit;">في بعض الأحيان تصل إلى تعليق كامل. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
القيود التي يفرضها تنسيق ملف الفئة وتفاصيل تنفيذ javac تجعل من المستحيل استخدام </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أكثر من 3_862 عنصر </font><font style="vertical-align: inherit;">في الكود </font><font style="vertical-align: inherit;">في نفس الوقت. </font><font style="vertical-align: inherit;">من الجوانب الإيجابية ، تجدر الإشارة إلى أن هذه يمكن أن تكون عناصر تعسفية 3_862. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا يمكن زيادة تحسين النتائج إلا من خلال تحسين مترجم Java ، لكن هذه قصة مختلفة تمامًا.</font></font><br>
<br>
<a name="Appendix"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مواد إضافية</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كود مصدر GitHub: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Maccimo/HugeEnumGeneratorArticle</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ملف JAR الذي تم جمعه: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Maccimo/HugeEnumGeneratorArticle/releases/tag/v1.0</font></font></a><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تعليمات بدء التشغيل المعتمدة</font></font></b>
                        <div class="spoiler_text"><pre><font></font>
Huge enumeration generator<font></font>
<font></font>
    https://github.com/Maccimo/HugeEnumGeneratorArticle<font></font>
<font></font>
Additional information (in Russian):<font></font>
<font></font>
    https://habr.com/ru/post/483392/<font></font>
    https://habr.com/ru/post/501870/<font></font>
<font></font>
Usage:<font></font>
    java -jar HugeEnumGen.jar [ &lt;options&gt; ] &lt;enum name&gt;<font></font>
<font></font>
    &lt;enum name&gt;<font></font>
        An enumeration class name.<font></font>
        Should be a valid Java identifier. May contain package name.<font></font>
<font></font>
Options:<font></font>
<font></font>
    -d &lt;directory&gt;<font></font>
        Output directory path.<font></font>
        Current working directory by default.<font></font>
<font></font>
    -e &lt;item list file&gt;<font></font>
        Path to UTF8-encoded text file with list of enumeration item names.<font></font>
        Item names will be autogenerated if absent.<font></font>
        Mutually exclusive with the -c option.<font></font>
<font></font>
    -c &lt;count&gt;<font></font>
        Count of autogenerated enumeration item names.<font></font>
        Mutually exclusive with the -e option.<font></font>
        Default value: Algorithm-depended<font></font>
<font></font>
    -a &lt;algorithm&gt;<font></font>
        Enumeration generation algorithm.<font></font>
        Supported algorithms:<font></font>
          ConDy          - Employ Constant Dynamic (JEP 309) for enum elements initialization<font></font>
          ExtractMethod  - Extract enum elements initialization code to separate method<font></font>
          Unsafe         - Employ sun.misc.Unsafe for enum elements initialization<font></font>
<font></font>
        Default algorithm: ExtractMethod<font></font>
<font></font>
    -h / -?<font></font>
        Show this help page.<font></font>
<font></font>
Example:<font></font>
<font></font>
    java -jar HugeEnumGen.jar -d ./bin -c 2020 com.habr.maccimo.HugeEnum2020<font></font>
<font></font>
</pre><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar501860/index.html">15 مايو قد يضيف لك RU-Center خدمة مدفوعة بدون مشاركتك</a></li>
<li><a href="../ar501862/index.html">رفرفة تحت غطاء المحرك</a></li>
<li><a href="../ar501864/index.html">مساعد أو مفتش: لمن يتصل الروبوت؟</a></li>
<li><a href="../ar501866/index.html">كم عدد الوظائف الروبوتات سوف تدمر</a></li>
<li><a href="../ar501868/index.html">كيف لا تدع المحاسب يرمي نفسه أو ننقل 1C إلى السحابة. تعليمات خطوة بخطوة</a></li>
<li><a href="../ar501872/index.html">مكان الدراسة في أنظمة علم التحكم الآلي</a></li>
<li><a href="../ar501874/index.html">أبنية الواجهة الأمامية الحديثة (الجزء 2)</a></li>
<li><a href="../ar501880/index.html">حول ترجمة "البدايات" و "البدايات" بدون البداية ، البداية والأولى</a></li>
<li><a href="../ar501882/index.html">كيف نستخدم خوارزميات رؤية الكمبيوتر: معالجة الفيديو في متصفح محمول باستخدام OpenCV.js</a></li>
<li><a href="../ar501884/index.html">كيف ستساعد محفوظات المعلومات الطبية الإلكترونية في تشخيص الأمراض بشكل أكثر فعالية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>