<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚾️ 🧟 🎡 Bagaimana cara meluncurkan refactoring berbahaya ke prod dengan sejuta pengguna? 🚀 🛫 🔤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Film "Airplane", 1980. 
 
 Itulah yang saya rasakan ketika saya menuangkan refactoring lain pada prod. Bahkan jika Anda menutupi seluruh kode dengan m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bagaimana cara meluncurkan refactoring berbahaya ke prod dengan sejuta pengguna?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Film "Airplane", 1980. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itulah yang saya rasakan ketika saya menuangkan refactoring lain pada prod. </font><font style="vertical-align: inherit;">Bahkan jika Anda menutupi seluruh kode dengan metrik dan log, uji fungsionalitas di semua lingkungan - ini tidak akan menghemat 100% dari fakaps setelah penyebaran.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fakap pertama</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entah bagaimana kami refactored pemrosesan integrasi kami dengan Google Sheets. Untuk pengguna, ini adalah fitur yang sangat berharga, karena mereka menggunakan banyak alat pada saat yang bersamaan yang perlu dihubungkan bersama - mengirim kontak ke sebuah meja, mengunggah jawaban untuk pertanyaan, mengekspor pengguna, dll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode integrasi tidak memperbaiki dari versi pertama dan menjadi semakin sulit untuk dipertahankan. Ini mulai mempengaruhi pengguna kami - bug lama terungkap bahwa kami takut mengedit karena rumitnya kode. Sudah waktunya untuk melakukan sesuatu tentang itu. Seharusnya tidak ada perubahan logis - cukup tulis tes, pindahkan kelas, dan sisir nama. Tentu saja, kami menguji fungsionalitas pada lingkungan dev dan mulai digunakan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah 20 menit, pengguna menulis bahwa integrasi tidak berfungsi. </font><font style="vertical-align: inherit;">Fungsi pengiriman data ke Google Sheet gagal - ternyata untuk debug kami mengirim data dalam format yang berbeda untuk penjualan dan lingkungan lokal. </font><font style="vertical-align: inherit;">Saat refactoring, kami menekan format untuk penjualan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memperbaiki integrasi, namun demikian, endapan dari Jumat malam yang meriah (dan Anda pikir!) Tetap ada. </font><font style="vertical-align: inherit;">Dalam retrospeksi (bertemu tim untuk menyelesaikan sprint), kami mulai berpikir tentang bagaimana mencegah situasi seperti itu di masa depan - kita perlu meningkatkan praktik pengujian manual, pengujian otomatis, bekerja dengan metrik dan alarm, dan selain itu, kami mendapat ide untuk menggunakan bendera fitur untuk menguji refactoring pada Bahkan, ini akan dibahas.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penerapan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema ini sederhana: jika pengguna mengaktifkan bendera, buka kode dengan versi baru, jika tidak, ke kode dengan versi lama:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan pendekatan ini, kami memiliki kesempatan untuk menguji refactoring pada prod pertama pada diri kami dan kemudian menuangkannya pada pengguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hampir sejak awal proyek, kami memiliki implementasi fitur flag yang primitif. </font><font style="vertical-align: inherit;">Dalam database untuk dua entitas dasar, pengguna dan akun, bidang fitur ditambahkan, yang merupakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit mask</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dalam kode tersebut, kami mendaftarkan konstanta baru untuk fitur, yang kemudian kami tambahkan ke mask jika fitur tertentu tersedia bagi pengguna.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penggunaan dalam kode tampak seperti ini:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat refactoring, kami biasanya membuka bendera untuk tim untuk pengujian, kemudian ke beberapa pengguna yang secara aktif menggunakan fitur, dan akhirnya terbuka untuk semua, tetapi kadang-kadang skema yang lebih rumit muncul, lebih banyak tentang mereka di bawah ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring tempat yang kelebihan beban</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu sistem kami menerima kait web Facebook dan memprosesnya melalui antrian. Pemrosesan antrian berhenti untuk mengatasi dan pengguna mulai menerima pesan tertentu dengan penundaan, yang secara kritis dapat mempengaruhi pengalaman pelanggan bot. Kami mulai memperbaiki tempat ini dengan mentransfer pemrosesan ke skema antrian yang lebih kompleks. Tempat ini kritis - berbahaya untuk menuangkan logika baru di semua server, jadi kami menutup logika baru di bawah bendera dan dapat mengujinya di prod. Tapi apa yang terjadi ketika kita membuka bendera ini? Bagaimana prilaku infrastruktur kita? Kali ini kami menggunakan pembukaan bendera di server dan mengikuti metrik.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua pemrosesan data penting telah kami bagi menjadi beberapa kelompok. </font><font style="vertical-align: inherit;">Setiap cluster memiliki id. </font><font style="vertical-align: inherit;">Kami memutuskan untuk menyederhanakan pengujian refactoring yang sedemikian kompleks dengan membuka fitur flag hanya pada server tertentu, cek dalam kode terlihat seperti ini:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami menuangkan refactoring dan membuka bendera ke tim. </font><font style="vertical-align: inherit;">Kemudian kami menemukan beberapa pengguna yang secara aktif menggunakan fitur cgt, membuka bendera kepada mereka dan melihat apakah semuanya bekerja untuk mereka. </font><font style="vertical-align: inherit;">Dan akhirnya, mereka mulai membuka bendera di server dan mengikuti metrik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bendera cgt_refactoring_cluster_ids dapat diubah melalui panel admin. </font><font style="vertical-align: inherit;">Awalnya, kami menetapkan nilai cgt_refactoring_cluster_ids ke array kosong, lalu tambahkan satu kluster sekaligus - [1], lihat metrik sebentar dan tambahkan kluster lain - [1, 2] hingga kami menguji seluruh sistem.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi konfigurator</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan berbicara sedikit tentang apa itu Configurator dan bagaimana penerapannya. </font><font style="vertical-align: inherit;">Itu ditulis untuk dapat mengubah logika tanpa penyebaran, misalnya, seperti dalam kasus di atas, ketika kita perlu memutar balik logika dengan tajam. </font><font style="vertical-align: inherit;">Kami juga menggunakannya untuk konfigurasi dinamis, misalnya, saat Anda perlu menguji waktu caching yang berbeda, Anda dapat menggunakannya untuk pengujian cepat. </font><font style="vertical-align: inherit;">Untuk pengembang, ini terlihat seperti daftar bidang dengan nilai admin yang dapat diubah. </font><font style="vertical-align: inherit;">Kami menyimpan semua ini dalam DB, kami cache di Redis dan statika untuk pekerja kami.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring lokasi yang sudah usang</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada kuartal berikutnya, kami refactored logika pendaftaran, mempersiapkannya untuk transisi ke kemungkinan pendaftaran melalui beberapa layanan. </font><font style="vertical-align: inherit;">Dalam kondisi kami, tidak mungkin untuk mengelompokkan logika pendaftaran sehingga pengguna tertentu terikat pada logika tertentu, dan kami tidak menghasilkan sesuatu yang lebih baik daripada menguji logika, menggelar persentase dari semua permintaan pendaftaran. </font><font style="vertical-align: inherit;">Ini mudah dilakukan dengan cara yang mirip dengan flag:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karenanya, kami menetapkan nilai auth_refactoring_percentage di panel admin dari 0 hingga 100. Tentu saja, kami "mengolesi" seluruh logika otorisasi dengan metrik untuk memahami bahwa kami tidak mengurangi konversi pada akhirnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metrik</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengetahui bagaimana kami mengikuti metrik dalam proses membuka bendera, kami akan mempertimbangkan kasus lain secara lebih rinci. </font><font style="vertical-align: inherit;">ManyChat menerima kait Facebook dari Facebook ketika pelanggan mengirim pesan ke Facebook Messenger. </font><font style="vertical-align: inherit;">Kita harus memproses setiap pesan sesuai dengan logika bisnis. </font><font style="vertical-align: inherit;">Untuk fitur cgt, kita perlu menentukan apakah pelanggan memulai percakapan melalui komentar di Facebook untuk mengiriminya pesan yang relevan sebagai tanggapan. </font><font style="vertical-align: inherit;">Dalam kode, sepertinya menentukan konteks pelanggan saat ini, jika kita dapat menentukan widgetId, maka kita menentukan pesan respons darinya.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lebih lanjut tentang fitur</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      —    .        Widget,   :<br>
<br>
  —&gt;     —&gt;     —&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  —&gt;    —&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     “ , !”   ,        .   ,     “  !”   id       ,     —   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelumnya, kami mendefinisikan konteks dalam 3 cara, itu terlihat seperti ini:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Layanan pengamat mengirimkan analitik pada saat pertandingan, masing-masing, kami memiliki metrik untuk ketiga kasus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jumlah</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kali </font><i><font style="vertical-align: inherit;">konteks ditemukan oleh berbagai metode penautan dalam waktu.</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Selanjutnya, kami menemukan metode pencocokan lain yang harus mengganti semua opsi lama. </font><font style="vertical-align: inherit;">Untuk menguji ini, kami mendapat metrik lain:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada tahap ini, kami ingin memastikan bahwa jumlah hit baru sama dengan jumlah hit lama, jadi cukup tulis metrik tanpa mengembalikan $ widgetId: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jumlah konteks yang ditemukan oleh metode baru sepenuhnya mencakup jumlah ikatan dengan metode lama</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tapi ini tidak menjamin kami logika kecocokan yang benar pada semua kasus. </font><font style="vertical-align: inherit;">Langkah selanjutnya adalah pengujian bertahap melalui pembukaan bendera:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian proses pengujian dimulai: pada awalnya kami menguji fungsionalitas baru kami sendiri di semua lingkungan dan pada pengguna acak yang sering menggunakan pencocokan dengan membuka bendera UserFeatures :: ALLOW_CGT_MATCHING_BY_ECHO. </font><font style="vertical-align: inherit;">Pada tahap ini, kami menangkap beberapa kasus ketika pertandingan bekerja dengan tidak benar dan memperbaikinya. </font><font style="vertical-align: inherit;">Kemudian mereka mulai meluncurkan ke server: rata-rata, kami meluncurkan satu server dalam 1 hari selama seminggu. </font><font style="vertical-align: inherit;">Sebelum pengujian, kami memperingatkan dukungan bahwa mereka melihat dengan seksama tiket yang terkait dengan fungsionalitas dan menulis kepada kami tentang segala keanehan. </font><font style="vertical-align: inherit;">Berkat dukungan dan pengguna, beberapa kasing telah diperbaiki. </font><font style="vertical-align: inherit;">Dan akhirnya, langkah terakhir adalah penemuan pada semua tanpa syarat:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementasi fitur bendera baru</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penerapan fitur bendera yang diuraikan di awal artikel membantu kami selama sekitar 3 tahun, tetapi dengan pertumbuhan tim, menjadi tidak nyaman - kami harus menggunakan saat membuat setiap bendera dan jangan lupa untuk menghapus nilai bendera (kami menggunakan kembali nilai konstan untuk fitur yang berbeda). </font><font style="vertical-align: inherit;">Baru-baru ini, komponen telah ditulis ulang dan sekarang kita dapat mengelola flag secara fleksibel melalui panel admin. </font><font style="vertical-align: inherit;">Bendera dilepaskan dari bitmask dan disimpan dalam tabel terpisah - ini membuatnya mudah untuk membuat bendera baru. </font><font style="vertical-align: inherit;">Setiap entri juga memiliki deskripsi dan pemilik, manajemen bendera menjadi lebih transparan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontra dari pendekatan semacam itu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan ini memiliki minus besar - ada dua versi kode dan mereka perlu didukung secara bersamaan. </font><font style="vertical-align: inherit;">Saat menguji, Anda harus mempertimbangkan bahwa ada dua cabang logika, dan Anda perlu memeriksa semuanya, dan ini sangat menyakitkan. </font><font style="vertical-align: inherit;">Selama pengembangan, ada situasi ketika kami memperkenalkan perbaikan ke satu logika, tetapi lupa tentang yang lain, dan di beberapa titik itu menembak. </font><font style="vertical-align: inherit;">Oleh karena itu, kami menerapkan pendekatan ini hanya di tempat-tempat kritis dan berusaha untuk menyingkirkan kode versi lama secepat mungkin. </font><font style="vertical-align: inherit;">Kami mencoba melakukan sisa refactoring dalam iterasi kecil.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proses saat ini terlihat seperti ini - pertama kita menutup logika di bawah kondisi bendera, kemudian menyebarkan dan mulai secara bertahap membuka bendera. Saat membentangkan bendera, kami memantau dengan cermat kesalahan dan metrik, segera setelah terjadi kesalahan - segera gulung kembali bendera dan atasi masalahnya. Nilai tambahnya adalah membuka / menutup bendera sangat cepat - itu hanya perubahan nilai pada panel admin. Setelah beberapa waktu, kami memotong kode versi lama, ini seharusnya menjadi waktu minimum untuk mencegah perubahan di kedua versi kode. Penting untuk memperingatkan kolega tentang refactoring tersebut. Kami melakukan review melalui github dan menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pemilik kode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> selama refactoring sehingga perubahan tidak masuk ke dalam kode tanpa sepengetahuan penulis refactoring.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baru-baru ini, saya meluncurkan versi baru dari Facebook Graph API. </font><font style="vertical-align: inherit;">Dalam sedetik, kami membuat lebih dari 3000 permintaan ke API dan setiap kesalahan mahal bagi kami. </font><font style="vertical-align: inherit;">Oleh karena itu, saya meluncurkan perubahan di bawah bendera dengan dampak minimal - Saya berhasil menangkap satu bug yang tidak menyenangkan, menguji versi baru dan akhirnya beralih sepenuhnya tanpa khawatir.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id499016/index.html">Integrasi dengan ESIA untuk .Net: lebih mudah daripada yang terdengar</a></li>
<li><a href="../id499018/index.html">6 aplikasi olahraga rumah</a></li>
<li><a href="../id499020/index.html">Sebuah studi tentang satu perilaku yang tidak jelas</a></li>
<li><a href="../id499030/index.html">Memantau kinerja MySQL untuk Grafana pada isic dalam 20 menit</a></li>
<li><a href="../id499032/index.html">Cara menggunakan Prometheus untuk mendeteksi anomali di GitLab</a></li>
<li><a href="../id499036/index.html">Pekerjaan penyedia: pilihan bahan pada protokol, TI dan infrastruktur jaringan</a></li>
<li><a href="../id499038/index.html">Pengalaman saya menggunakan monitor vertikal</a></li>
<li><a href="../id499040/index.html">Baca di akhir pekan: pilihan materi tentang sejarah DNS, regulasi TI, dan perangkat keras 1cloud.ru</a></li>
<li><a href="../id499044/index.html">Berita dari dunia OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
<li><a href="../id499046/index.html">Neuroevolusi Cybercalmar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>