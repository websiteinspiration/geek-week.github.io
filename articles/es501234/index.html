<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõµ üë©üèª‚Äç‚öñÔ∏è üöé Enrutamiento r√°pido y NAT en Linux ü•ö üë®‚Äçüè´ üïë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A medida que las direcciones IPv4 se agotan, muchos operadores de telecomunicaciones se enfrentan a la necesidad de organizar el acceso de sus cliente...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Enrutamiento r√°pido y NAT en Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A medida que las direcciones IPv4 se agotan, muchos operadores de telecomunicaciones se enfrentan a la necesidad de organizar el acceso de sus clientes a la red mediante la traducci√≥n de direcciones. </font><font style="vertical-align: inherit;">En este art√≠culo, le dir√© c√≥mo obtener un rendimiento de nivel NAT de Carrier Grade en servidores b√°sicos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de historia</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tema de quedarse sin espacio de direcciones IPv4 ya no es nuevo. En alg√∫n momento, aparecieron listas de espera en RIPE, luego hubo intercambios en los que intercambiaron bloques de direcciones y concluyeron transacciones por su alquiler. Gradualmente, los operadores de telecomunicaciones comenzaron a proporcionar servicios de acceso a Internet a trav√©s de la traducci√≥n de direcciones y puertos. Alguien no logr√≥ obtener suficientes direcciones para dar una direcci√≥n "blanca" a cada suscriptor, mientras que alguien comenz√≥ a ahorrar dinero al negarse a comprar direcciones en el mercado secundario. Los fabricantes de equipos de red respaldaron esta idea, ya que Esta funcionalidad generalmente requiere m√≥dulos de expansi√≥n o licencias adicionales. Por ejemplo, con Juniper en la l√≠nea de enrutadores MX (a excepci√≥n de los √∫ltimos MX104 y MX204), NAPT se puede realizar en una tarjeta de servicio MS-MIC separada, Cisco ASR1k requiere una licencia GN,en Cisco ASR9k, un m√≥dulo A9K-ISM-100 separado y una licencia A9K-CGN-LIC. En general, el placer cuesta mucho dinero.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea de realizar NAT no requiere recursos inform√°ticos especializados; los procesadores de prop√≥sito general instalados, por ejemplo, en cualquier enrutador dom√©stico, pueden resolverlo. </font><font style="vertical-align: inherit;">A escala de operador, este problema puede resolverse utilizando servidores b√°sicos que ejecutan FreeBSD (ipfw / pf) o GNU / Linux (iptables). </font><font style="vertical-align: inherit;">No consideraremos FreeBSD, porque </font><font style="vertical-align: inherit;">Me negu√© a usar este sistema operativo durante mucho tiempo, as√≠ que centr√©monos en GNU / Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Activar la traducci√≥n de direcciones no es nada dif√≠cil. </font><font style="vertical-align: inherit;">Primero debe escribir la regla en iptables en la tabla nat:</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema operativo cargar√° el m√≥dulo nf_conntrack, que supervisar√° todas las conexiones activas y realizar√° las conversiones necesarias. </font><font style="vertical-align: inherit;">Hay varias sutilezas. </font><font style="vertical-align: inherit;">En primer lugar, dado que estamos hablando de NAT en la escala del operador, es necesario ajustar los tiempos de espera, porque con los valores predeterminados, el tama√±o de la tabla de traducci√≥n crecer√° r√°pidamente a valores catastr√≥ficos. </font><font style="vertical-align: inherit;">A continuaci√≥n se muestra un ejemplo de la configuraci√≥n que utilic√© en mis servidores:</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y en segundo lugar, dado que el tama√±o predeterminado de la tabla de traducci√≥n no est√° dise√±ado para funcionar en las condiciones de un operador de telecomunicaciones, debe aumentarse:</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Tambi√©n es necesario aumentar el n√∫mero de dep√≥sitos para una tabla hash que almacena todas las traducciones (esta es una opci√≥n del m√≥dulo nf_conntrack): </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de estas manipulaciones simples, se obtiene una construcci√≥n completamente funcional, que puede traducir una gran cantidad de direcciones de clientes en un grupo externo. Sin embargo, el rendimiento de esta soluci√≥n es pobre. En mis primeros intentos de usar GNU / Linux para NAT (aproximadamente 2013), pude obtener un rendimiento de aproximadamente 7 Gbit / s a ‚Äã‚Äã0.8Mpps por servidor (Xeon E5-1650v2). Desde entonces, se han realizado muchas optimizaciones diferentes en la pila de red del kernel GNU / Linux, el rendimiento de un servidor en el mismo hardware ha crecido casi a 18-19 Gbit / s a ‚Äã‚Äã1.8-1.9 Mpps (estos fueron los valores l√≠mite), pero la necesidad de volumen de tr√°fico, procesado por un solo servidor, creci√≥ mucho m√°s r√°pido. Como resultado, se desarrollaron esquemas de equilibrio de carga para diferentes servidores, pero todo esto aument√≥ la complejidad de la configuraci√≥n,servicio y mantenimiento de la calidad de los servicios prestados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nftables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy en d√≠a, el uso de DPDK y XDP es una direcci√≥n de moda en el software de "transferencia de paquetes". </font><font style="vertical-align: inherit;">Se han escrito muchos art√≠culos sobre este tema, se han realizado muchas presentaciones diferentes, aparecen productos comerciales (por ejemplo, SKAT de VasExperts). </font><font style="vertical-align: inherit;">Pero en las condiciones de recursos limitados de los programadores de los operadores de telecomunicaciones, es bastante problem√°tico cortar alg√∫n tipo de "participaci√≥n" sobre la base de estos marcos. </font><font style="vertical-align: inherit;">Para operar una soluci√≥n de este tipo en el futuro ser√° mucho m√°s dif√≠cil, en particular, se deber√°n desarrollar herramientas de diagn√≥stico. </font><font style="vertical-align: inherit;">Por ejemplo, un tcpdump normal con DPDK simplemente no funcionar√°, y no "ver√°" los paquetes enviados de vuelta a los cables utilizando XDP. </font><font style="vertical-align: inherit;">En medio de todo lo que se habla sobre las nuevas tecnolog√≠as para enviar el reenv√≠o de paquetes al espacio de usuario, los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">art√≠culos</font></a><font style="vertical-align: inherit;"> pasaron desapercibidos</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pablo Neira Ayuso, mantenedor de iptables, sobre el desarrollo de la descarga de flujo en nftables. Veamos este mecanismo con m√°s detalle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea principal es que si el enrutador pas√≥ los paquetes de una sesi√≥n en ambos lados de la secuencia (la sesi√≥n TCP entr√≥ en el estado ESTABLECIDO), entonces no hay necesidad de pasar los paquetes posteriores de esta sesi√≥n a trav√©s de todas las reglas del firewall, porque todas estas verificaciones finalizar√°n de la misma manera transfiriendo el paquete a la ruta. S√≠, y en realidad no es necesario realizar la elecci√≥n de la ruta: ya sabemos qu√© interfaz y qu√© host deben reenviar los paquetes dentro de esta sesi√≥n. Solo queda guardar esta informaci√≥n y usarla para el enrutamiento en una etapa temprana del procesamiento de paquetes. Al realizar NAT, es necesario guardar adicionalmente informaci√≥n sobre cambios en direcciones y puertos convertidos por el m√≥dulo nf_conntrack. S√≠, por supuesto, en este caso varios polisers y otras reglas de informaci√≥n estad√≠stica en iptables dejan de funcionar,pero como parte de la tarea de un NAT permanente separado o, por ejemplo, un borde, esto no es tan importante, porque los servicios se distribuyen entre dispositivos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar esta funci√≥n necesitamos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usa un grano fresco. </font><font style="vertical-align: inherit;">A pesar del hecho de que la funcionalidad en s√≠ misma apareci√≥ en el kernel 4.16, durante bastante tiempo fue muy "en bruto" y regularmente se llamaba kernel panic. </font><font style="vertical-align: inherit;">Todo se estabiliz√≥ alrededor de diciembre de 2019, cuando se lanzaron los n√∫cleos LTS 4.19.90 y 5.4.5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescribe las reglas de iptables en formato nftables usando una versi√≥n bastante reciente de nftables. </font><font style="vertical-align: inherit;">Funciona bien en la versi√≥n 0.9.0</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todo est√° claro en principio con el primer p√°rrafo, lo principal es no olvidar incluir el m√≥dulo en la configuraci√≥n durante el ensamblaje (CONFIG_NFT_FLOW_OFFLOAD = m), entonces el segundo p√°rrafo requiere explicaci√≥n. </font><font style="vertical-align: inherit;">Las reglas de nftables se describen de manera bastante diferente que en iptables. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> revela casi todos los puntos, tambi√©n hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertidores de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reglas </font><font style="vertical-align: inherit;">especiales </font><font style="vertical-align: inherit;">de iptables a nftables. </font><font style="vertical-align: inherit;">Por lo tanto, solo dar√© un ejemplo de configuraci√≥n de NAT y descarga de flujo. </font><font style="vertical-align: inherit;">Una peque√±a leyenda para un ejemplo: &lt;i_if&gt;, &lt;o_if&gt; son las interfaces de red a trav√©s de las cuales pasa el tr√°fico, en realidad puede haber m√°s de dos. </font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt;, &lt;pool_addr_end&gt;: la direcci√≥n inicial y final del rango de direcciones "blancas". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuraci√≥n de NAT es muy simple:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La descarga de flujo es un poco m√°s complicada, pero comprensible:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso, de hecho, es toda la configuraci√≥n. </font><font style="vertical-align: inherit;">Ahora todo el tr√°fico TCP / UDP ir√° a la tabla fastnat y se procesar√° mucho m√°s r√°pido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resultados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para dejar en claro cu√°n "mucho m√°s r√°pido" es esto, adjuntar√© una captura de pantalla de la carga en dos servidores reales con el mismo hardware (Xeon E5-1650v2), igualmente configurado, usando el mismo kernel de Linux, pero ejecutando NAT en iptables (NAT4) y en nftables (NAT5). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hay un gr√°fico de paquete por segundo en la captura de pantalla, pero en el perfil de carga de estos servidores el tama√±o promedio del paquete es de alrededor de 800 bytes, por lo que los valores suben a 1.5Mpps. </font><font style="vertical-align: inherit;">Como puede ver, el margen de rendimiento del servidor con nftables es enorme. </font><font style="vertical-align: inherit;">Actualmente, este servidor procesa hasta 30 Gbit / s a ‚Äã‚Äã3Mpps y es claramente capaz de encontrarse con la limitaci√≥n f√≠sica de la red de 40Gbps, mientras tiene recursos de CPU libres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este material sea √∫til para los ingenieros de redes que intentan mejorar el rendimiento de sus servidores.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es501220/index.html">An√°lisis: ¬øpuede una empresa tener demasiado dinero?</a></li>
<li><a href="../es501222/index.html">Aplicaci√≥n de COBIT al desarrollar una estrategia de TI</a></li>
<li><a href="../es501224/index.html">¬øQu√© redes neuronales pueden "cantar" y realizar death metal</a></li>
<li><a href="../es501226/index.html">B√∫squeda r√°pida de archivos</a></li>
<li><a href="../es501232/index.html">¬øC√≥mo puede un experto en TI ganar m√°s por sus conocimientos?</a></li>
<li><a href="../es501236/index.html">Entonces, ¬øde qu√© se trata todo esto, "plegamiento de prote√≠nas"?</a></li>
<li><a href="../es501240/index.html">Auditor√≠a de seguridad del sitio</a></li>
<li><a href="../es501244/index.html">El programador no tiene que resolver problemas de negocios.</a></li>
<li><a href="../es501246/index.html">Corregir gr√°ficos Covid-19</a></li>
<li><a href="../es501248/index.html">Sal√≥n de la fama del lugar de trabajo de JavaScript, parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>